---
title: включение файла
description: включение файла
services: batch
documentationcenter: ''
author: laurenhughes
manager: gwallace
editor: ''
ms.assetid: ''
ms.service: batch
ms.devlang: na
ms.topic: include
ms.tgt_pltfrm: na
ms.workload: ''
ms.date: 07/16/2019
ms.author: lahugh
ms.custom: include file
ms.openlocfilehash: c8b25858556538835d6a84bf0d6699f9906f1438
ms.sourcegitcommit: 4b431e86e47b6feb8ac6b61487f910c17a55d121
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/18/2019
ms.locfileid: "68322656"
---
### <a name="general-requirements"></a>Общие требования

* Виртуальная сеть должна находиться в тех же подписке и регионе, что и учетная запись пакетной службы, которую вы используете для создания пула.

* Размер пула, использующий виртуальную сеть, не может превышать 4096 узлов.

* Указанная для пула подсеть должна иметь достаточное количество свободных IP-адресов для всех виртуальных машин, предназначенных для пула, то есть сумму свойств `targetDedicatedNodes` и `targetLowPriorityNodes` этого пула. Если в подсети недостаточно свободных IP-адресов, пакетная служба ограничивает выделение вычислительных узлов для пула и генерирует ошибку изменения размера. 

* Необходимо, чтобы конечная точка службы хранилища Azure могла быть разрешена на всех пользовательских DNS-серверах, используемых в виртуальной сети. В частности, должны разрешаться URL-адреса в формате `<account>.table.core.windows.net`, `<account>.queue.core.windows.net` и `<account>.blob.core.windows.net`. 

Дополнительные требования к виртуальной сети различаются в зависимости от того, где указан пул пакетной службы: в конфигурации виртуальной машины или конфигурации облачных служб. Для новых развертываний пула в виртуальной сети рекомендуется конфигурация виртуальной машины.

### <a name="pools-in-the-virtual-machine-configuration"></a>Пулы в конфигурации виртуальной машины

**Поддерживаемые виртуальные сети** — только виртуальные сети на основе Azure Resource Manager.

**Идентификатор подсети** — при указании подсети с помощью API пакетной службы используйте *идентификатор ресурса* подсети. Идентификатор подсети имеет вид:

  ```
  /subscriptions/{subscription}/resourceGroups/{group}/providers/Microsoft.Network/virtualNetworks/{network}/subnets/{subnet}
  ```

**Разрешения** — проверьте, ограничивают ли ваши политики безопасности или блокировки в подписке или группе ресурсов виртуальной сети разрешения пользователя на управление виртуальной сетью.

**Дополнительные сетевые ресурсы** — пакетная служба автоматически выделяет дополнительные сетевые ресурсы в группе ресурсов, содержащей виртуальную сеть. Для каждого выделенного 50 узла (или 20 узлов с низким приоритетом) выделяются пакетами: 1 группа безопасности сети (NSG), 1 общедоступный IP-адрес и 1 балансировщик нагрузки. Эти ресурсы ограничены [квотами ресурсов](../articles/azure-subscription-service-limits.md) в подписке. Для больших пулов вам может потребоваться увеличить квоту на один или несколько из этих ресурсов.

#### <a name="network-security-groups"></a>Группы безопасности сети

Подсеть должна разрешать входящую связь из пакетной службы, чтобы иметь возможность планировать задачи на вычислительных узлах, и исходящую связь для связи со службой хранилища Azure или другими ресурсами. Для пулов в конфигурации виртуальной машины пакетная служба добавляет группы безопасности сети на уровне сетевых интерфейсов, подключенных к виртуальным машинам. Эти группы безопасности сети автоматически настраивают правила для входящего и исходящего трафика, чтобы разрешить следующий трафик:

* Входящий трафик TCP через порты 29876 и 29877 с IP-адресов с ролью пакетной службы. 
* Входящий трафик TCP через порт 22 (узлы Linux) или 3389 (узлы Windows), чтобы разрешить удаленный доступ. Для некоторых типов задач с несколькими экземплярами в Linux (например, MPI) необходимо также разрешить трафик SSH через порт 22 для IP-адресов в подсети, содержащей вычислительные узлы пакетной службы.
* Исходящий трафик в виртуальную сеть на любом порту.
* Исходящий трафик в Интернет на любом порту.

> [!IMPORTANT]
> Соблюдайте осторожность, если вы изменяете или добавляете правила для входящего и исходящего трафика в группах безопасности сети, настроенных для пакетной службы. Если группа безопасности сети (NSG), связанная с назначенной подсетью, запрещает взаимодействие с вычислительными узлами, пакетная служба установит для вычислительных узлов состояние **Непригоден**.

Вам не нужно указывать группы безопасности сети на уровне подсети, так как пакетная служба настраивает собственные такие группы. Однако если указанной подсети уже назначены группы безопасности сети и (или) брандмауэр, настройте правила безопасности для входящего и исходящего трафика, как показано в следующих таблицах. Настройте входящий трафик через порт 3389 (Windows) или 22 (Linux) только в том случае, если необходимо предоставить удаленный доступ к виртуальным машинам пула из внешних источников. Виртуальные машины пула можно использовать и без этой настройки. Обратите внимание, что необходимо включить трафик подсети виртуальной сети через порт 22 для Linux, если вы используете определенные типы многоэкземплярных задач, например MPI.

**Правила безопасности для входящего трафика**

| Исходные IP-адреса | Тег службы источника | Исходные порты | Назначение | Конечные порты | Протокол | Action |
| --- | --- | --- | --- | --- | --- | --- |
| Н/Д | `BatchNodeManagement`[Тег службы](../articles/virtual-network/security-overview.md#service-tags) | * | Any | 29876–29877 | TCP | РАЗРЕШИТЬ |
| Исходные IP-адреса пользователей для удаленного доступа к вычислительным узлам и (или) подсети вычислительных узлов для задач с несколькими экземплярами Linux, если это необходимо. | Н/Д | * | Any | 3389 (Windows), 22 (Linux) | TCP | РАЗРЕШИТЬ |

**Правила безопасности для исходящего трафика**

| Source | Исходные порты | Назначение | Тег целевой службы | Конечные порты | Протокол | Action |
| --- | --- | --- | --- | --- | --- | --- |
| Any | * | [Тег службы](../articles/virtual-network/security-overview.md#service-tags) | `Storage`(в том же регионе, что и учетная запись пакетной службы и виртуальная сеть) | 443 | TCP | РАЗРЕШИТЬ |

### <a name="pools-in-the-cloud-services-configuration"></a>Пулы в конфигурации облачных служб

**Поддерживаемые виртуальные сети** — только классические виртуальные сети.

**Идентификатор подсети** — при указании подсети с помощью API пакетной службы используйте *идентификатор ресурса* подсети. Идентификатор подсети имеет вид:

  ```
  /subscriptions/{subscription}/resourceGroups/{group}/providers/Microsoft.ClassicNetwork /virtualNetworks/{network}/subnets/{subnet}
  ```

**Разрешения`Microsoft Azure Batch` — субъекту-службе**  должна быть назначена роль управления доступом на основе ролей `Classic Virtual Machine Contributor` для указанной виртуальной сети.

#### <a name="network-security-groups"></a>Группы безопасности сети

Подсеть должна разрешать входящую связь из пакетной службы, чтобы иметь возможность планировать задачи на вычислительных узлах, и исходящую связь для связи со службой хранилища Azure или другими ресурсами.

Вам не нужно указывать группу безопасности сети, так как пакетная служба настраивает входящий трафик только с IP-адресов пакетной службы на узлах пула. Если указанной подсети уже назначены группы безопасности сети и (или) брандмауэр, настройте правила безопасности для входящего и исходящего трафика, как показано в следующих таблицах. Если группа безопасности сети (NSG), связанная с назначенной подсетью, запрещает взаимодействие с вычислительными узлами, пакетная служба установит для вычислительных узлов состояние **Непригоден**.

Настройте входящий трафик через порт 3389 для Windows, если требуется разрешение доступа по протоколу RDP к узлам пула. Узлы пула можно использовать и без этой настройки.

**Правила безопасности для входящего трафика**

| Исходные IP-адреса | Исходные порты | Назначение | Конечные порты | Протокол | Action |
| --- | --- | --- | --- | --- | --- |
Any <br /><br />Хотя фактически это разрешает доступ со всех адресов, пакетная служба применяет правило списка управления доступом на уровне каждого узла, которое отфильтровывает все IP-адреса, не относящиеся к пакетной службе. | * | Any | 10100, 20100, 30100 | TCP | РАЗРЕШИТЬ |
| Необязательно, чтобы разрешить доступ по протоколу RDP к вычисленным узлам. | * | Any | 3389 | TCP | РАЗРЕШИТЬ |

**Правила безопасности для исходящего трафика**

| Source | Исходные порты | Назначение | Конечные порты | Протокол | Action |
| --- | --- | --- | --- | --- | --- |
| Any | * | Any | 443  | Any | РАЗРЕШИТЬ |
