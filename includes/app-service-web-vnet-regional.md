---
author: ccompy
ms.service: app-service-web
ms.topic: include
ms.date: 10/21/2020
ms.author: ccompy
ms.openlocfilehash: 1a9f468b8e2f9fff20b9b26b8890d485e426b691
ms.sourcegitcommit: 4bee52a3601b226cfc4e6eac71c1cb3b4b0eafe2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/11/2020
ms.locfileid: "94523683"
---
Использование региональной интеграции виртуальной сети позволяет приложению получить доступ к следующим данным:

* Ресурсы в виртуальной сети в том же регионе, что и ваше приложение.
* Ресурсы в виртуальных сетей, подключенные к виртуальной сети, с которой интегрировано приложение.
* Службы, защищенные конечной точкой службы.
* Ресурсы для подключений Azure ExpressRoute.
* Ресурсы в виртуальной сети, с которыми вы интегрируетесь.
* Ресурсы через одноранговые соединения, включая подключения Azure ExpressRoute.
* Частные конечные точки 

При использовании интеграции с виртуальной сетью с виртуальных сетей в том же регионе можно использовать следующие сетевые функции Azure:

* **Группы безопасности сети (группы безопасности сети)**. исходящий трафик можно блокировать с помощью NSG, размещенного в подсети интеграции. Правила для входящих подключений не применяются, так как вы не можете использовать интеграцию с виртуальной сетью для предоставления входящего доступа к приложению.
* **Таблицы маршрутов (определяемые пользователем маршруты)**. таблицу маршрутов можно поместить в подсеть интеграции для отправки исходящего трафика.

По умолчанию приложение перенаправляет только АДРЕСНЫЕ пространства RFC1918 трафик в виртуальную сеть. Если вы хотите направить весь исходящий трафик в виртуальную сеть, примените параметр приложения WEBSITE_VNET_ROUTE_ALL к приложению. Чтобы настроить параметр приложения, выполните следующие действия.

1. Перейдите в пользовательский интерфейс **настройки** на портале приложения. Выберите **Новый параметр приложения**.
1. Введите **WEBSITE_VNET_ROUTE_ALL** в поле **имя** и введите **1** в поле **значение** .

   ![Укажите параметр приложения][4]

1. Нажмите кнопку **ОК**.
1. Щелкните **Сохранить**.

> [!NOTE]
> Если вы направите весь исходящий трафик в виртуальную сеть, он подлежит группы безопасности сети и определяемые пользователем маршруты, которые применяются к подсети интеграции. При маршрутизации всего исходящего трафика в виртуальную сеть исходящие адреса по-прежнему будут исходящими в свойствах вашего приложения, если только не указаны маршруты для отправки трафика в другое место.

Существуют некоторые ограничения при использовании интеграции с виртуальной сетью с виртуальных сетей в одном регионе:

* Не удается получить доступ к ресурсам по глобальным одноранговым соединениям.
* Эта функция доступна во всех единицах масштабирования службы приложений в Premium v2 и Premium v3. Он также доступен в стандарте, но только из новых единиц масштабирования службы приложений. Если вы используете более раннюю единицу масштабирования, эту функцию можно использовать только из плана службы приложений Premium v2. Если вы хотите иметь возможность использовать эту функцию в стандартном плане службы приложений, создайте приложение в плане службы приложений уровня "Премиум V3". Эти планы поддерживаются только в самых новых единицах масштабирования. Вы можете уменьшить масштаб, если хотите.  
* Подсеть интеграции может использоваться только одним планом службы приложений.
* Эта функция не может использоваться приложениями изолированного плана, которые находятся в Среда службы приложений.
* Для этой функции требуется неиспользуемая подсеть, которая имеет значение/28 или больше в Azure Resource Manager виртуальной сети.
* Приложение и виртуальная сеть должны находиться в одном регионе.
* Невозможно удалить виртуальную сеть с интегрированным приложением. Удалите интеграцию перед удалением виртуальной сети.
* Интегрировать с виртуальных сетей можно только в той же подписке, что и приложение.
* Можно использовать только одну региональную интеграцию с виртуальной сетью на один план службы приложений. Несколько приложений в одном плане службы приложений могут использовать одну и ту же виртуальную сеть.
* Вы не можете изменить подписку приложения или плана, пока есть приложение, использующее интеграцию с региональной виртуальной сетью.
* Приложению не удается разрешить адреса в Частные зоны Azure DNS без изменений конфигурации

Интеграция виртуальной сети зависит от использования выделенной подсети.  При подготовке подсети подсеть Azure теряет 5 IP-адресов для запуска. Один адрес используется из подсети интеграции для каждого экземпляра плана. При масштабировании приложения до четырех экземпляров используются четыре адреса. Дебетовое значение 5 адресов из подсети означает, что максимальное число доступных адресов на блок CIDR:

- /28 содержит 11 адресов
- /27 имеет 27 адресов
- /26 имеет 59 адресов

В случае увеличения или уменьшения масштаба необходимо вдвое увеличить потребность в адресах в течение короткого периода времени. Ограничения размера означают, что реальные поддерживаемые экземпляры на размер подсети —, если подсеть:

- /28. Максимальная Горизонтальная шкала — 5 экземпляров
- /27, максимальная Горизонтальная шкала — 13 экземпляров
- /26, максимальная Горизонтальная шкала — 29 экземпляров

Ограничения, указанные для максимального масштаба по горизонтали, предполагают, что вам придется увеличивать или уменьшать масштаб в какой либо размер или SKU в некоторый момент. 

Так как размер подсети нельзя изменить после назначения, используйте подсеть, которая достаточно велика для размещения любого масштаба, к которому может получить доступ приложение. Чтобы избежать проблем с емкостью подсети, рекомендуемым размером является a/26 с 64 адресами.  

Если вы хотите, чтобы ваши приложения в другом плане достигли виртуальной сети, которая уже подключена к приложениям в другом плане, выберите подсеть, отличную от используемой уже существующей интеграцией виртуальной сети.

Эта функция полностью поддерживается для приложений Windows и Linux, включая [Пользовательские контейнеры](../articles/app-service/quickstart-custom-container.md). Все эти поведения действуют одинаково в приложениях Windows и приложениях Linux.

### <a name="service-endpoints"></a>Конечные точки служб

Интеграция региональной виртуальной сети позволяет использовать конечные точки службы. Чтобы использовать конечные точки службы в приложении, используйте интеграцию с региональной виртуальной сетью для подключения к выбранной виртуальной сети, а затем настройте конечные точки службы, указав целевую службу в подсети, используемой для интеграции. Если вы хотите получить доступ к службе через конечные точки службы, сделайте следующее:

1. Настройка интеграции региональной виртуальной сети с веб-приложением
1. Перейдите в целевую службу и настройте конечные точки службы для подсети, используемой для интеграции.

### <a name="network-security-groups"></a>Группы безопасности сети

Группы безопасности сети можно использовать для блокировки входящего и исходящего трафика для ресурсов в виртуальной сети. Приложение, использующее интеграцию региональной виртуальной сети, может использовать [группу безопасности сети][VNETnsg] для блокировки исходящего трафика к ресурсам в виртуальной сети или Интернете. Для блокировки трафика на общедоступные адреса необходимо, чтобы параметр приложения WEBSITE_VNET_ROUTE_ALL установлен в значение 1. Правила для входящих подключений в NSG не применяются к вашему приложению, так как интеграция с виртуальной сетью влияет только на исходящий трафик из приложения.

Чтобы управлять входящим трафиком к приложению, используйте функцию ограничения доступа. NSG, применяемый к подсети интеграции, действует независимо от всех маршрутов, примененных к подсети интеграции. Если для параметра WEBSITE_VNET_ROUTE_ALL задано значение 1, а у вас нет маршрутов, влияющих на трафик общедоступного адреса в подсети интеграции, весь исходящий трафик по-прежнему подпадает под группы безопасности сети, назначенный вашей подсети интеграции. Если WEBSITE_VNET_ROUTE_ALL не задано, группы безопасности сети применяются только к трафику АДРЕСНЫЕ пространства RFC1918.

### <a name="routes"></a>Маршруты

Таблицы маршрутов можно использовать для маршрутизации исходящего трафика из приложения в нужное место. По умолчанию таблицы маршрутов влияют только на трафик назначения АДРЕСНЫЕ пространства RFC1918. Если присвоить WEBSITE_VNET_ROUTE_ALL значение 1, будут затронуты все исходящие вызовы. Маршруты, настроенные в подсети интеграции, не влияют на ответы на входящие запросы приложений. Общие назначения могут включать устройства брандмауэра или шлюзы.

Если требуется маршрутизировать весь исходящий трафик локально, можно использовать таблицу маршрутов для отправки всего исходящего трафика на шлюз ExpressRoute. Если вы направите трафик в шлюз, не забудьте установить маршруты во внешней сети для отправки ответов обратно.

Маршруты протокол BGP (BGP) также влияют на трафик приложения. Если у вас есть маршруты BGP, например шлюз ExpressRoute, будет затронуто исходящий трафик приложения. По умолчанию маршруты BGP влияют только на трафик назначения АДРЕСНЫЕ пространства RFC1918. Если WEBSITE_VNET_ROUTE_ALL имеет значение 1, маршруты BGP могут повлиять на весь исходящий трафик.

### <a name="azure-dns-private-zones"></a>Частные зоны Azure DNS 

После интеграции приложения с виртуальной сетью используется тот же DNS-сервер, с которым настроена виртуальная сеть. Это поведение можно переопределить в приложении, настроив параметр приложения WEBSITE_DNS_SERVER с адресом нужного DNS-сервера. Если у вас есть пользовательский DNS-сервер, настроенный для виртуальной сети, но вы хотите, чтобы приложение использовало Azure DNS частные зоны, необходимо задать WEBSITE_DNS_SERVER со значением 168.63.129.16. 

### <a name="private-endpoints"></a>Частные конечные точки

Если вы хотите выполнять вызовы к [частным конечным точкам][privateendpoints], необходимо убедиться, что поиск DNS будет разрешаться в частную конечную точку. Чтобы убедиться, что уточняющие запросы DNS из приложения будут указывать на закрытые конечные точки, вы можете:

* Интегрируйтесь с Частные зоны Azure DNS. Если в вашей виртуальной сети нет настраиваемого DNS-сервера, это будет автоматически
* Управление частной конечной точкой на DNS-сервере, используемом приложением. Для этого необходимо знать адрес частной конечной точки, а затем указать конечную точку, к которой вы пытаетесь связаться, с записью A.
* Настройка собственного DNS-сервера для пересылки в Azure DNS частные зоны

<!--Image references-->
[4]: ../includes/media/web-sites-integrate-with-vnet/vnetint-appsetting.png

<!--Links-->
[VNETnsg]: https://docs.microsoft.com/azure/virtual-network/security-overview/
[privateendpoints]: https://docs.microsoft.com/azure/app-service/networking/private-endpoint
