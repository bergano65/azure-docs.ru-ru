---
title: Безопасное выполнение службы управления сертификатами хранилища OPC в Azure | Документация Майкрософт
description: В этой статье описывается, как безопасно запустить службу управления сертификатами хранилища OPC в Azure и ознакомиться с другими рекомендациями по безопасности.
author: mregen
ms.author: mregen
ms.date: 8/16/2019
ms.topic: conceptual
ms.service: industrial-iot
services: iot-industrialiot
manager: philmea
ms.openlocfilehash: 88f8188779c5fb6b3cd07c67e9f35a6b8f9ad97d
ms.sourcegitcommit: 8a717170b04df64bd1ddd521e899ac7749627350
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/23/2019
ms.locfileid: "71200080"
---
# <a name="run-the-opc-vault-certificate-management-service-securely"></a>Безопасное выполнение службы управления сертификатами хранилища OPC

В этой статье объясняется, как безопасно запустить службу управления сертификатами хранилища OPC в Azure и просмотреть другие рекомендации по обеспечению безопасности.

## <a name="roles"></a>Роли

### <a name="trusted-and-authorized-roles"></a>Доверенные и полномочные роли

Микрослужба хранилища OPC позволяет отдельным ролям обращаться к различным частям службы.

> [!IMPORTANT]
> Во время развертывания скрипт добавляет пользователя, запускающего скрипт развертывания, в качестве пользователя для всех ролей. Для рабочего развертывания следует проверить назначение ролей и соответствующим образом настроить его, следуя приведенным ниже рекомендациям. Эта задача требует ручного назначения ролей и служб на портале корпоративных приложений Azure Active Directory (Azure AD).

### <a name="certificate-management-service-roles"></a>Роли службы управления сертификатами

Микрослужба хранилища OPC определяют следующие роли:

- **Читатель**: По умолчанию любой пользователь, прошедший проверку подлинности в клиенте, имеет доступ на чтение. 
  - Доступ для чтения к приложениям и запросам сертификатов. Может выводить список приложений и запросов на сертификаты и выполнять запросы к ним. Кроме того, сведения об обнаружении устройств и общедоступные сертификаты доступны с доступом на чтение.
- **Модуль записи**: Роль модуля записи назначается пользователю для добавления разрешений на запись для определенных задач. 
  - Доступ для чтения и записи к приложениям и запросам сертификатов. Может регистрировать, обновлять и отменять регистрацию приложений. Может создавать запросы на сертификаты и получать утвержденные закрытые ключи и сертификаты. Также может удалять закрытые ключи.
- **Утверждающий**: Роль утверждающего назначается пользователю для утверждения или отклонения запросов сертификатов. Роль не включает другие роли.
  - Кроме роли утверждающего для доступа к API микрослужбы хранилища OPC, у пользователя также должно быть разрешение подписывания ключа в Azure Key Vault, чтобы иметь возможность подписывать сертификаты.
  - Роль модуля записи и утверждающего должна быть назначена разным пользователям.
  - Основной ролью утверждающего является утверждение создания и отклонение запросов сертификатов.
- **Администратор**. Роль администратора назначается пользователю для управления группами сертификатов. Роль не поддерживает роль утверждающего, но включает в себя роль модуля записи.
  - Администратор может управлять группами сертификатов, изменять конфигурацию и отзывать сертификаты приложений, выдавая новый список отзыва сертификатов (CRL).
  - В идеале роли "модуль записи", "Утверждающий" и "Администратор" назначаются разным пользователям. Для обеспечения дополнительной безопасности пользователю с ролью "Утверждающий" или "Администратор" также требуется разрешение на подписывание ключей в Key Vault, выдача сертификатов или продление сертификата ЦС поставщика.
  - В дополнение к роли администрирования микрослужб роль включает, но не ограничена:
    - Ответственность за администрирование реализации рекомендаций по безопасности ЦС.
    - Управление созданием, отзывом и приостановкой сертификатов. 
    - Управление жизненным циклом криптографического ключа (например, обновление ключей ЦС издателя).
    - Установка, Настройка и обслуживание служб, которые работают с ЦС.
    - Повседневная работа служб. 
    - ЦС и резервное копирование и восстановление базы данных.

### <a name="other-role-assignments"></a>Другие назначения ролей

При запуске службы также учитывайте следующие роли:

- Бизнес-владелец контракта на закупок сертификатов с внешним корневым центром сертификации (например, когда владелец приобретает сертификаты из внешнего ЦС или работает с центром сертификации, подчиненным внешнему ЦС).
- Разработка и проверка центра сертификации.
- Проверка записей аудита.
- Персонал, который помогает поддерживать центр сертификации или управлять физическими и облачными устройствами, но не является напрямую доверенным для выполнения операций ЦС, находится в *авторизованной* роли. Набор задач, которым разрешено выполнять задачи авторизованной роли, также должен быть документирован.

### <a name="review-memberships-of-trusted-and-authorized-roles-quarterly"></a>Узнайте о членстве доверенных и авторизованных ролей ежеквартально

Просмотрите членство доверенных и авторизованных ролей по крайней мере ежеквартально. Убедитесь, что набор пользователей (для ручных процессов) или удостоверений служб (для автоматизированных процессов) в каждой из ролей сохраняется как минимум.

### <a name="role-separation-between-certificate-requester-and-approver"></a>Разделение ролей между инициатором запроса и утверждающим сертификатом

Процесс выдачи сертификата должен обеспечивать разделение ролей между инициатором запроса сертификата и ролями утверждающего сертификата (лицами или автоматизированными системами). Выдача сертификата должна быть разрешена ролью утверждающего сертификата, которая проверяет, имеет ли запрашивающий сертификат права на получение сертификатов. Лица, которые содержат роль утверждающего сертификата, должны быть формально авторизованными лицами.

### <a name="restrict-assignment-of-privileged-roles"></a>Ограничение назначения привилегированных ролей

Назначение привилегированных ролей, таких как авторизация членства в группе Администраторы и утверждающие, следует ограничить ограниченным набором авторизованных сотрудников. Доступ к изменениям привилегированных ролей должен быть отменен в течение 24 часов. Наконец, изучите назначения привилегированных ролей ежеквартально и удалите все ненужные или просроченные назначения.

### <a name="privileged-roles-should-use-two-factor-authentication"></a>Привилегированные роли должны использовать двухфакторную проверку подлинности

Используйте многофакторную проверку подлинности (также называемую двухфакторной проверкой подлинности) для интерактивного входа в службу утверждающих лиц и администраторов.

## <a name="certificate-service-operation-guidelines"></a>Рекомендации по операциям службы сертификатов

### <a name="operational-contacts"></a>Операционные контакты

Служба сертификатов должна иметь актуальный план реагирования на безопасность в файле, который содержит подробные контактные данные для ответов на рабочие инциденты.

### <a name="security-updates"></a>Обновления для системы безопасности

Все системы должны постоянно отслеживаться и обновляться с помощью последних обновлений безопасности.

> [!IMPORTANT]
> Репозиторий GitHub службы хранилища OPC постоянно обновляется с помощью исправлений системы безопасности. Отслеживайте эти обновления и применяйте их к службе через равные промежутки времени.

### <a name="security-monitoring"></a>Мониторинг безопасности

Подпишитесь на или реализуйте соответствующий мониторинг безопасности. Например, подпишитесь на решение центра мониторинга (например, центр безопасности Azure или решение по мониторингу Office 365) и настройте его соответствующим образом, чтобы обеспечить передачу событий безопасности в решение для мониторинга.

> [!IMPORTANT]
> По умолчанию служба хранилища OPC развертывается с [Application Insights Azure](https://docs.microsoft.com/azure/azure-monitor/app/devops) в качестве решения для мониторинга. Настоятельно рекомендуется добавить решение для обеспечения безопасности, такое как [Центр безопасности Azure](https://azure.microsoft.com/services/security-center/) .

### <a name="assess-the-security-of-open-source-software-components"></a>Оценка безопасности программных компонентов с открытым исходным кодом

Все компоненты с открытым исходным кодом, используемые в продукте или службе, должны быть свободны от умеренных или более уязвимостей безопасности.

> [!IMPORTANT]
> Во время сборки непрерывной интеграции репозиторий GitHub службы хранилища OPC сканирует все компоненты на наличие уязвимостей. Отслеживайте эти обновления на GitHub и применяйте их к службе через регулярные интервалы.

### <a name="maintain-an-inventory"></a>Ведение запасов

Настройте инвентаризацию активов для всех рабочих узлов (включая постоянные виртуальные машины), устройств, всех внутренних диапазонов IP-адресов, VIP и общедоступных доменных имен DNS. Каждый раз при добавлении или удалении системы, IP-адреса устройства, виртуальной IP-сети или общедоступного домена DNS необходимо обновить инвентаризацию в течение 30 дней.

#### <a name="inventory-of-the-default-azure-opc-vault-microservice-production-deployment"></a>Инвентаризация рабочего развертывания микрослужбы хранилища Azure OPC по умолчанию 

В Azure:
- **App Service Plan** (План службы приложений). План службы приложений для узлов служб. Значение S1 по умолчанию.
- **Служба приложений** для микрослужбы: Узел службы хранилища OPC.
- **Служба приложений** для примера приложения: Узел примера приложения для хранилища OPC.
- **Key Vault Стандартный**: Для хранения секретов и ключей Azure Cosmos DB для веб-служб.
- **Key Vault Premium**: Для размещения ключей ЦС издателя, для службы подписывания, а также для настройки хранилища и хранения закрытых ключей приложения.
- **Azure Cosmos DB**. База данных для запросов приложений и сертификатов. 
- **Application Insights**: (необязательно) мониторинг решения для веб-службы и приложения.
- **Регистрация приложения Azure AD**: Регистрация для примера приложения, службы и модуля ребра.

Для облачных служб все имена узлов, группы ресурсов, названия ресурсов, идентификаторы подписки и идентификаторы клиентов, используемые для развертывания службы, должны быть документированы. 

В Azure IoT Edge или на локальном IoT Edgeном сервере:
- **Модуль IOT Edge хранилища OPC**: Для поддержки сервера глобального обнаружения в фабричном сетевом сервере OPC UA. 

Для IoT Edge устройств имена узлов и IP-адреса должны быть документированы. 

### <a name="document-the-certification-authorities-cas"></a>Документирование центров сертификации (ЦС)

Документация по иерархии ЦС должна содержать все центры сертификации. Сюда входят все связанные подчиненные ЦС, родительские ЦС и корневые центры сертификации, даже если они не управляются службой. Вместо формальной документации можно предоставить исчерпывающий набор всех неистекших сертификатов ЦС.

> [!NOTE]
> Пример приложения для хранилища OPC поддерживает загрузку всех сертификатов, используемых и созданных в службе, для документации.

### <a name="document-the-issued-certificates-by-all-certification-authorities-cas"></a>Документирование выданных сертификатов всеми центрами сертификации (ЦС)

Укажите исчерпывающий набор всех сертификатов, выпущенных за последние 12 месяцев.

> [!NOTE]
> Пример приложения для хранилища OPC поддерживает загрузку всех сертификатов, используемых и созданных в службе, для документации.

### <a name="document-the-standard-operating-procedure-for-securely-deleting-cryptographic-keys"></a>Документирование стандартной операционной процедуры для безопасного удаления криптографических ключей

В течение времени существования ЦС удаление ключа может происходить только редко. Именно поэтому у пользователя нет Key Vault назначено право на удаление сертификата и почему нет интерфейсов API для удаления сертификата ЦС поставщика. Ручная стандартная процедура безопасного удаления криптографических ключей центра сертификации доступна только путем прямого доступа к Key Vault в портал Azure. Также можно удалить группу сертификатов в Key Vault. Чтобы обеспечить немедленное удаление, отключите функцию [Key Vault обратимого удаления](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-soft-delete) .

## <a name="certificates"></a>Сертификаты

### <a name="certificates-must-comply-with-minimum-certificate-profile"></a>Сертификаты должны соответствовать минимальному профилю сертификата

Служба хранилища OPC — это сетевой ЦС, который выдает подписчикам сертификаты конечных объектов. Микрослужба хранилища OPC следует этим рекомендациям в реализации по умолчанию.

- Все сертификаты должны содержать следующие поля X. 509, как указано ниже:
  - Содержимое поля Version должно иметь значение v3. 
  - Содержимое поля serialNumber должно включать по меньшей мере 8 байт энтропии, полученное от FIPS (федеральные стандарты обработки информации) 140, утвержденный генератор случайных чисел.<br>
    > [!IMPORTANT]
    > Серийный номер хранилища OPC по умолчанию равен 20 байтам и получается от криптографического генератора случайных чисел операционной системы. Генератор случайных чисел — это FIPS 140, одобренный на устройствах Windows, но не на платформе Linux. Это следует учитывать при выборе развертывания службы, использующей виртуальные машины Linux или контейнеры DOCKER в Linux, на которых базовая технология OpenSSL не является FIPS 140 утверждена.
  - Поля Иссуеруникуеид и Субжектуникуеид не должны присутствовать.
  - Сертификаты конечных сущностей должны быть определены с помощью расширения базовых ограничений в соответствии с IETF RFC 5280.
  - Для выдающего сертификата ЦС в поле Пасленконстраинт должно быть задано значение 0. 
  - Расширение расширенного использования ключа должно присутствовать и должно содержать минимальный набор идентификаторов объектов расширенного использования ключа (OID). Не следует указывать OID Анекстендедкэйусаже (2.5.29.37.0). 
  - Расширение точки распространения списка отзыва сертификатов (CDP) должно присутствовать в сертификате ЦС издателя.<br>
    > [!IMPORTANT]
    > Расширение CDP содержится в сертификатах ЦС хранилища OPC. Тем не менее устройства OPC UA используют пользовательские методы для распространения списков отзыва сертификатов.
  - Расширение доступа к информации о центрах сертификации должно присутствовать в сертификатах подписчика.<br>
    > [!IMPORTANT]
    > Расширение доступа к информации о центрах сертификации содержится в сертификатах подписчика хранилища OPC. Тем не менее устройства OPC UA используют пользовательские методы для распространения сведений о ЦС издателя.
- Необходимо использовать утвержденные асимметричные алгоритмы, длины ключей, хэш-функции и режимы заполнения.
  - Поддерживаются только алгоритмы RSA и SHA-2.
  - RSA можно использовать для шифрования, обмена ключами и подписи.
  - Шифрование RSA должно использовать только режимы заполнения OAEP, RSA-кем или RSA-PSS.
  - Требуется длина ключей, которая больше или равна 2048 бит.
  - Используйте семейство алгоритмов хэширования SHA-2 (SHA256, SHA384 и SHA512).
  - Ключи корневого ЦС RSA с типичным временем жизни, превышающим или равным 20 годам, должны быть 4096 бит или больше.
  - Ключи ЦС RSA Issuer должны составлять не менее 2048 бит. Если срок действия сертификата ЦС истекает через 2030, ключ ЦС должен быть больше 4096 бит.
- Время существования сертификата
  - Сертификаты корневого ЦС: Максимальный срок действия сертификата для корневого ЦС не должен превышать 25 лет.
  - Сертификаты промежуточного ЦС или ЦС онлайн-поставщика: Максимальный срок действия сертификата для центров сертификации, которые находятся в сети и выдают только сертификаты подписчика, не должен превышать 6 лет. Для этих центров сертификации соответствующий закрытый ключ подписи не должен использоваться дольше 3 лет для выпуска новых сертификатов.<br>
    > [!IMPORTANT]
    > Сертификат издателя, как он создается в микрослужбе хранилища OPC по умолчанию без внешнего корневого ЦС, рассматривается как интерактивный подцентр сертификации с соответствующими требованиями и временем существования. Время жизни по умолчанию равно 5 годам, а длина ключа больше или равна 2048.
  - Все асимметричные ключи должны иметь максимальный срок действия в 5 лет и рекомендуемый срок жизни в 1 год.<br>
    > [!IMPORTANT]
    > По умолчанию время существования сертификатов приложений, выданных с помощью хранилища OPC, составляет 2 года и их следует заменять каждый год. 
  - Каждый раз при обновлении сертификата он обновляется с помощью нового ключа.
- Особые расширения OPC UA в сертификатах экземпляров приложения
  - Расширение subjectAltName включает URI приложения и имена узлов. Сюда также могут входить полные доменные имена, адреса IPv4 и IPv6.
  - Кэйусаже включает Дигиталсигнатуре, неподдельность, keyEncipherment и ДатаенЦифермент.
  - Екстендедкэйусаже включает serverAuth и Клиентаус.
  - Аусоритикэйидентифиер указывается в подписанных сертификатах.

### <a name="ca-keys-and-certificates-must-meet-minimum-requirements"></a>Ключи и сертификаты ЦС должны соответствовать минимальным требованиям

- **Закрытые ключи**: Ключи RSA должны составлять не менее 2048 бит. Если срок действия сертификата ЦС истекает через 2030, ключ ЦС должен быть больше 4096 бит.
- **Время существования**: Максимальный срок действия сертификата для центров сертификации, которые находятся в сети и выдают только сертификаты подписчика, не должен превышать 6 лет. Для этих центров сертификации соответствующий закрытый ключ подписи не должен использоваться дольше 3 лет для выпуска новых сертификатов.

### <a name="ca-keys-are-protected-using-hardware-security-modules"></a>Ключи ЦС защищаются с помощью аппаратных модулей безопасности

Опкваулт использует Azure Key Vault Premium, а ключи защищаются аппаратными модулями безопасности (HSM) FIPS 140-2 уровня 2. 

Криптографические модули, которые Key Vault использует, является ли HSM или программное обеспечение проверенным FIPS. Ключи, созданные или импортированные как АППАРАТно-защищенные, обрабатываются внутри АППАРАТного модуля безопасности, проверенного на уровне FIPS 140-2 уровня 2. Ключи, созданные или импортированные как программно-защищенные, обрабатываются в криптографических модулях с проверкой FIPS 140-2 уровня 1.

## <a name="operational-practices"></a>Рабочие методики

### <a name="document-and-maintain-standard-operational-pki-practices-for-certificate-enrollment"></a>Документирование и поддержание стандартных рабочих методов PKI для регистрации сертификатов

Документирование и обслуживание стандартных операционных процедур (SOP), определяющих выдачу сертификатов в центрах сертификации, в том числе: 
- Идентификация и проверка подлинности подписчика. 
- Как запрос сертификата обрабатывается и проверяется (если это применимо, включите также обработку запросов на обновление сертификатов и смены ключей). 
- Способ распространения выданных сертификатов подписчикам. 

СОП микрослужбы хранилища OPC описывается в статье [архитектура хранилища OPC](overview-opc-vault-architecture.md) и [Управление службой сертификатов хранилища OPC](howto-opc-vault-manage.md). Рекомендации следуют в разделе Спецификация унифицированной архитектуры OPC, часть 12. Обнаружение и глобальные службы».


### <a name="document-and-maintain-standard-operational-pki-practices-for-certificate-revocation"></a>Документирование и обслуживание стандартных рабочих методов PKI для отзыва сертификатов

Процесс отзыва сертификата описан в статье [архитектура хранилища OPC](overview-opc-vault-architecture.md) и [Управление службой сертификатов хранилища OPC](howto-opc-vault-manage.md).
    
### <a name="document-ca-key-generation-ceremony"></a>Документирование создания ключа ЦС формальностей 

Создание ключа ЦС издателя в микрослужбе хранилища OPC упрощено из-за безопасного хранения в Azure Key Vault. Дополнительные сведения см. [в разделе Управление службой сертификатов хранилища OPC](howto-opc-vault-manage.md).

Однако если вы используете внешний корневой центр сертификации, формальностей создания ключей ЦС должен соответствовать следующим требованиям.

Формальностей создания ключа ЦС необходимо выполнить для документированного скрипта, который включает по крайней мере следующие элементы: 
- Определение ролей и обязанностей участников.
- Утверждение на проведение формальностей создания ключа ЦС.
- Средства шифрования и материалы по активации, необходимые для формальностей.
- Подготовка оборудования (включая обновление и регистрацию сведений об активе и конфигурации).
- Установка операционной системы.
- Конкретные действия, выполняемые во время создания ключа ЦС формальностей, например: 
  - Установка и настройка приложения ЦС.
  - Создание ключа ЦС.
  - Резервное копирование ключа ЦС.
  - Подписывание сертификата ЦС.
  - Импортируйте подписанные ключи в защищенный АППАРАТный модуль безопасности службы.
  - Завершение работы системы центра сертификации.
  - Подготовка материалов для хранения.


## <a name="next-steps"></a>Следующие шаги

Теперь, когда вы узнали, как безопасно управлять хранилищем OPC, вы можете:

> [!div class="nextstepaction"]
> [Защита устройств OPC UA с помощью хранилища OPC](howto-opc-vault-secure.md)
