---
title: Управление службой сертификатов хранилища OPC в Azure | Документация Майкрософт
description: Управление сертификатами корневого ЦС хранилища OPC и разрешениями пользователей.
author: mregen
ms.author: mregen
ms.date: 8/16/2019
ms.topic: conceptual
ms.service: industrial-iot
services: iot-industrialiot
manager: philmea
ms.openlocfilehash: 890a25ed2cf11d657cad930815d78dbf968cc9f9
ms.sourcegitcommit: 8a717170b04df64bd1ddd521e899ac7749627350
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/23/2019
ms.locfileid: "71203648"
---
# <a name="manage-the-opc-vault-certificate-service"></a>Управление службой сертификатов хранилища OPC

В этой статье объясняются задачи администрирования для службы управления сертификатами хранилища OPC в Azure. В нем содержатся сведения об обновлении сертификатов ЦС поставщика, обновлении списка отзыва сертификатов (CRL), а также о предоставлении и отмене доступа пользователей.

## <a name="create-or-renew-the-root-ca-certificate"></a>Создание или продление сертификата корневого ЦС

После развертывания хранилища OPC необходимо создать сертификат корневого ЦС. Без действительного сертификата ЦС поставщика нельзя подписывать или выдавать сертификаты приложений. Используйте [Сертификаты](howto-opc-vault-secure-ca.md#certificates) для управления сертификатами с учетом разумных и безопасных жизненных циклов. Продлите сертификат ЦС поставщика после половины его времени существования. При обновлении также следует учесть, что настроенное время существования нового подписанного сертификата приложения не должно превышать время существования сертификата ЦС поставщика.
> [!IMPORTANT]
> Для создания или обновления сертификата ЦС поставщика требуется роль администратора.

1. Откройте службу `https://myResourceGroup-app.azurewebsites.net`сертификации и выполните вход.
2. Перейдите в раздел **группы сертификатов**.
3. Указана одна группа сертификатов по умолчанию. Выберите **Изменить**
4. В окне **изменение сведений о группе сертификатов**можно изменить имя субъекта и время существования сертификатов ЦС и приложений. Субъект и время жизни следует устанавливать только один раз перед выдаче первого сертификата ЦС. Изменения времени существования во время операций могут привести к несогласованному времени существования выданных сертификатов и списков отзыва сертификатов.
5. Введите допустимую тему (например, `CN=My CA Root, O=MyCompany, OU=MyDepartment`).<br>
   > [!IMPORTANT]
   > При изменении субъекта необходимо продлить сертификат издателя, иначе служба не сможет подписывать сертификаты приложения. Тема конфигурации проверяется по теме активного сертификата поставщика. Если субъекты не совпадают, подписывание сертификата отклоняется.
6. Щелкните **Сохранить**.
7. Если на этом этапе возникнет ошибка "запрещено", учетные данные пользователя не имеют разрешения администратора на изменение или создание нового корневого сертификата. По умолчанию пользователь, развернутый в службе, имеет роли администратора и подписи со службой. Другие пользователи должны быть добавлены в роли утверждающего, Writer или Administrator в соответствии с регистрацией приложения Azure Active Directory (Azure AD).
8. Выберите **сведения**. При этом должны отобразиться обновленные сведения.
9. Выберите **Обновить сертификат ЦС** , чтобы выдать первый сертификат ЦС поставщика, или обновить сертификат издателя. Нажмите кнопку **ОК**.
10. Через несколько секунд вы увидите **сведения о сертификате**. Чтобы скачать последний сертификат ЦС и список отзыва сертификатов для распространения в приложения OPC UA, выберите **Issuer** или **CRL**.

Теперь служба управления сертификатами OPC UA готова выдавать сертификаты для приложений OPC UA.

## <a name="renew-the-crl"></a>Обновление списка отзыва сертификатов

Продление списка отзыва сертификатов — это обновление, которое должно быть распространено в приложения через регулярные интервалы времени. Устройства OPC UA, которые поддерживают расширение X509 точки распространения списков отзыва сертификатов, могут напрямую обновлять список отзыва сертификатов из конечной точки микрослужбы. Другие устройства OPC UA могут требовать обновления вручную или могут быть обновлены с помощью GDS Server Push Extensions (*) для обновления списков доверия с сертификатами и списками отзыва сертификатов.

В следующем рабочем процессе все запросы сертификатов в удаленных состояниях отменяются в списках отзыва сертификатов, которые соответствуют сертификату ЦС поставщика, для которого они были выпущены. Номер версии списка отзыва сертификатов увеличивается на 1. <br>
> [!NOTE]
> Все выданные списки отзыва сертификатов действительны до истечения срока действия сертификата ЦС издателя. Это обусловлено тем, что Спецификация OPC UA не требует обязательной, детерминированной модели распределения для списка отзыва сертификатов.

> [!IMPORTANT]
> Для продления CRL поставщика требуется роль администратора.

1. Откройте службу `https://myResourceGroup.azurewebsites.net`сертификации и выполните вход.
2. Перейдите на страницу « **группы сертификатов** ».
3. Выберите **сведения**. Он должен отображать текущий сертификат и сведения о CRL.
4. Выберите **Обновить список ОТЗЫВА CRL (CRL)** , чтобы выдать обновленный список CRL для всех активных сертификатов поставщика в хранилище хранилища OPC.
5. Через несколько секунд вы увидите **сведения о сертификате**. Чтобы скачать последний сертификат ЦС и список отзыва сертификатов для распространения в приложения OPC UA, выберите **Issuer** или **CRL**.

## <a name="manage-user-roles"></a>Управление ролями пользователей

Вы управляете ролями пользователей для микрослужбы хранилища OPC в корпоративном приложении Azure AD. Подробное описание определений ролей см. в разделе [roles](howto-opc-vault-secure-ca.md#roles).

По умолчанию пользователь, прошедший проверку подлинности в клиенте, может войти в службу как читатель. Для более высокопривилегированных ролей требуется ручное управление в портал Azure или с помощью PowerShell.

### <a name="add-user"></a>Добавление пользователя

1. Перейдите на портал Azure.
2. Перейдите в раздел **Azure Active Directory** > **корпоративные приложения**.
3. Выберите регистрацию микрослужбы хранилища OPC (по умолчанию `resourceGroupName-service`).
4. Перейдите к разделу **Пользователи и группы**.
5. Щелкните **Add User** (Добавить пользователя).
6. Выберите или пригласите пользователя, чтобы назначить определенную роль.
7. Выберите роль для пользователей.
8. Выберите **Назначить**.
9. Для пользователей в роли "Администратор" или "Утверждающий" Продолжайте добавлять политики доступа Azure Key Vault.

### <a name="remove-user"></a>Удаление пользователя

1. Перейдите на портал Azure.
2. Перейдите в раздел **Azure Active Directory** > **корпоративные приложения**.
3. Выберите регистрацию микрослужбы хранилища OPC (по умолчанию `resourceGroupName-service`).
4. Перейдите к разделу **Пользователи и группы**.
5. Выберите пользователя с ролью для удаления, а затем щелкните **Удалить**.
6. Для удаленных пользователей в роли администратора или утверждающего также удалите их из политик Azure Key Vault.

### <a name="add-user-access-policy-to-azure-key-vault"></a>Добавление политики доступа пользователей в Azure Key Vault

Для утверждающих и администраторов требуются дополнительные политики доступа.

По умолчанию удостоверение службы имеет только ограниченные разрешения на доступ к Key Vault, чтобы предотвратить выполнение операций с повышенными правами или изменений без олицетворения пользователя. Основные разрешения службы — Get и List для секретов и сертификатов. Для секретов существует только одно исключение: служба может удалить закрытый ключ из хранилища секретов после его принятия пользователем. Для всех остальных операций требуются олицетворенные разрешения пользователя.

#### <a name="for-an-approver-role-the-following-permissions-must-be-added-to-key-vault"></a>Для роли утверждающего необходимо добавить следующие разрешения в Key Vault

1. Перейдите на портал Azure.
2. Перейдите к хранилищу `resourceGroupName`OPC, используемому во время развертывания.
3. Перейдите к Key Vault `resourceGroupName-xxxxx`.
4. Перейдите к разделу **политики доступа**.
5. Нажмите кнопку **Добавить**.
6. Пропустить шаблон. Нет шаблона, соответствующего требованиям.
7. Щелкните **выбрать субъект**и выберите пользователя, которого необходимо добавить, или пригласите нового пользователя к клиенту.
8. Выберите следующие **разрешения**: **Получение**, **перечисление**и **Подписывание**.
9. Выберите следующие **разрешения секрета**: **Get**, **List**, **Set**и **Delete**.
10. Выберите следующие **разрешения сертификата**: **Get** и **List**.
11. Нажмите кнопку **ОК**и выберите **сохранить**.

#### <a name="for-an-administrator-role-the-following-permissions-must-be-added-to-key-vault"></a>Для роли администратора в Key Vault необходимо добавить следующие разрешения.

1. Перейдите на портал Azure.
2. Перейдите к хранилищу `resourceGroupName`OPC, используемому во время развертывания.
3. Перейдите к Key Vault `resourceGroupName-xxxxx`.
4. Перейдите к разделу **политики доступа**.
5. Нажмите кнопку **Добавить**.
6. Пропустить шаблон. Нет шаблона, соответствующего требованиям.
7. Щелкните **выбрать субъект**и выберите пользователя, которого необходимо добавить, или пригласите нового пользователя к клиенту.
8. Выберите следующие **разрешения**: **Получение**, **перечисление**и **Подписывание**.
9. Выберите следующие **разрешения секрета**: **Get**, **List**, **Set**и **Delete**.
10. Выберите следующие **разрешения сертификата**: **Получение**, **перечисление**, **Обновление**, **Создание**и **Импорт**.
11. Нажмите кнопку **ОК**и выберите **сохранить**.

### <a name="remove-user-access-policy-from-azure-key-vault"></a>Удаление политики доступа пользователей из Azure Key Vault

1. Перейдите на портал Azure.
2. Перейдите к хранилищу `resourceGroupName`OPC, используемому во время развертывания.
3. Перейдите к Key Vault `resourceGroupName-xxxxx`.
4. Перейдите к разделу **политики доступа**.
5. Найдите пользователя, которого нужно удалить, и выберите **Удалить**.

## <a name="next-steps"></a>Следующие шаги

Теперь, когда вы узнали, как управлять сертификатами и пользователями хранилища OPC, вы можете:

> [!div class="nextstepaction"]
> [Безопасное взаимодействие устройств OPC](howto-opc-vault-secure.md)
