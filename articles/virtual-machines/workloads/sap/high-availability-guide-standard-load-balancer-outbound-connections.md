---
title: Подключение к общедоступной конечной точке для виртуальных машин с помощью Load Balancer (цен. категория "Стандартный") Azure в сценариях высокого уровня доступности SAP
description: Подключение к общедоступной конечной точке для виртуальных машин с помощью Load Balancer (цен. категория "Стандартный") Azure в сценариях высокого уровня доступности SAP
services: virtual-machines-windows,virtual-network,storage,
documentationcenter: saponazure
author: rdeltcheva
manager: juergent
editor: ''
tags: azure-resource-manager
keywords: ''
ms.service: virtual-machines-windows
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure-services
ms.date: 10/28/2019
ms.author: radeltch
ms.openlocfilehash: ae2fb4c13633fa2ac22510a98e193bd9f01efb12
ms.sourcegitcommit: 38251963cf3b8c9373929e071b50fd9049942b37
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/29/2019
ms.locfileid: "73045386"
---
# <a name="public-endpoint-connectivity-for-virtual-machines-using-azure-standard-load-balancer-in-sap-high-availability-scenarios"></a>Подключение к общедоступной конечной точке для виртуальных машин с помощью Load Balancer (цен. категория "Стандартный") Azure в сценариях высокого уровня доступности SAP

В этой статье описываются конфигурации, которые позволят исключать исходящие подключения к общедоступным конечным точкам. Конфигурации в основном находятся в контексте высокого уровня доступности с Pacemaker для SUSE/RHEL.  

Если вы используете Pacemaker с агентом ограждения Azure в решении высокой доступности, виртуальные машины должны иметь исходящее подключение к API управления Azure.  
В статье представлено несколько вариантов, позволяющих выбрать вариант, который лучше всего подходит для вашего сценария.  

## <a name="overview"></a>Краткое описание

При реализации высокого уровня доступности для решений SAP с помощью кластеризации один из необходимых компонентов [Azure Load Balancer](https://docs.microsoft.com/azure/load-balancer/load-balancer-overview). Azure предлагает два номера SKU балансировщика нагрузки: Standard и Basic.

Стандартная подсистема балансировки нагрузки Azure предоставляет некоторые преимущества по сравнению с базовой подсистемой балансировки нагрузки. Например, он работает в разных зонах доступности Azure, он обеспечивает улучшенные возможности мониторинга и ведения журнала для упрощения устранения неполадок и снижения задержки. Функция "порты HA" охватывает все порты, т. е. больше не нужно перечислять все индивидуальные порты.  

Существует ряд важных различий между базовым и стандартным SKU балансировщика нагрузки Azure. Одним из них является обработка исходящего трафика в общедоступную конечную точку. Полное сравнение базового и стандартного SKU для балансировщика нагрузки см. в разделе [сравнение Load Balancer SKU](https://docs.microsoft.com/azure/load-balancer/load-balancer-overview#skus).  
 
Если виртуальные машины без общедоступных IP-адресов помещаются во внутренний пул внутреннего (без общедоступного IP-адреса) стандартного балансировщика нагрузки Azure, то нет исходящего подключения к общедоступным конечным точкам, если не будет выполнена дополнительная настройка.  

Если виртуальной машине назначен общедоступный IP-адрес или виртуальная машина находится во внутреннем пуле подсистемы балансировки нагрузки с общедоступным IP-адресом, она будет иметь исходящее подключение к общедоступным конечным точкам.  

Системы SAP часто содержат конфиденциальные бизнес-данные. Виртуальным машинам, на которых размещаются системы SAP, редко подходят общедоступные IP-адреса. В то же время существуют сценарии, которые потребуют исходящего подключения от виртуальной машины к общедоступным конечным точкам.  

Примеры сценариев, требующие доступа к общедоступной конечной точке Azure:  
- Использование агента ограждения Azure в качестве механизма разграничения в кластерах Pacemaker
- Служба Azure Backup
- Восстановление сайтов Azure  
- Использование общедоступного репозитория для исправления операционной системы
- Для потока данных приложений SAP может потребоваться исходящее подключение к общедоступной конечной точке

Если развертывание SAP не требует исходящего подключения к общедоступным конечным точкам, вам не нужно реализовывать дополнительную конфигурацию. Для сценария высокой доступности достаточно создать внутренний Azure Load Balancer SKU уровня "Стандартный", предполагая, что нет необходимости в входящем подключении с общедоступных конечных точек.  

> [!Note]
> Если виртуальные машины без общедоступных IP-адресов помещаются во внутренний пул внутреннего (без общедоступного IP-адреса) стандартного балансировщика нагрузки Azure, то исходящее подключение к Интернету будет отсутствовать, если не выполнить дополнительную настройку, чтобы разрешить маршрутизацию в общедоступные конечные точки.  
>Если виртуальные машины имеют общедоступные IP-адреса или уже находятся во внутреннем пуле балансировщика нагрузки Azure с общедоступным IP-адресом, виртуальная машина уже будет иметь исходящее подключение к общедоступным конечным точкам.


Сначала прочитайте следующую документацию:

* Load Balancer (цен. категория "Стандартный") Azure
  * [Обзор Load Balancer (цен. Категория "Стандартный") Azure](https://docs.microsoft.com/azure/load-balancer/load-balancer-standard-overview) . исчерпывающие сведения о подсистеме балансировки нагрузки Azure, важных принципах, концепциях и учебниках. 
  * [Исходящие подключения в Azure](https://docs.microsoft.com/azure/load-balancer/load-balancer-outbound-connections#scenarios) — сценарии получения исходящих подключений в Azure
  * [Исходящие правила балансировщика нагрузки](https://docs.microsoft.com/azure/load-balancer/load-balancer-outbound-rules-overview)— объясняются принципы исходящих правил балансировщика нагрузки и способы создания исходящих правил.
* Брандмауэр Azure
  * [Общие сведения о брандмауэре](https://docs.microsoft.com/azure/firewall/overview)Azure. Обзор брандмауэра Azure
  * [Руководство. Развертывание и настройка брандмауэра Azure](https://docs.microsoft.com/azure/firewall/tutorial-firewall-deploy-portal) . инструкции по настройке брандмауэра Azure с помощью портал Azure
* [Виртуальные сети — определяемые пользователем правила](https://docs.microsoft.com/azure/virtual-network/virtual-networks-udr-overview#user-defined) — основные понятия и правила маршрутизации Azure  
* [Теги службы групп безопасности](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) . Упрощение групп безопасности сети и конфигурации брандмауэра с помощью тегов служб

## <a name="additional-external-azure-standard-load-balancer-for-outbound-connections-to-internet"></a>Дополнительные внешние Load Balancer (цен. категория "Стандартный") Azure для исходящих подключений к Интернету

Одним из вариантов обеспечения исходящего подключения к общедоступным конечным точкам без разрешения входящего подключения к виртуальной машине из общедоступной конечной точки является создание второго балансировщика нагрузки с общедоступным IP-адресом, Добавление виртуальных машин во внутренний пул второго балансировщика нагрузки и определение только [Исходящие правила](https://docs.microsoft.com/azure/load-balancer/load-balancer-outbound-rules-overview).  
Используйте [группы безопасности сети](https://docs.microsoft.com/azure/virtual-network/security-overview) для управления общедоступными конечными точками, которые доступны для исходящих вызовов из виртуальной машины.  
Дополнительные сведения см. в разделе Сценарий 2 в документе [Исходящие подключения](https://docs.microsoft.com/azure/load-balancer/load-balancer-outbound-connections#scenarios).  
Конфигурация будет выглядеть следующим образом:  

![Управление подключением к общедоступным конечным точкам с помощью групп безопасности сети](./media/high-availability-guide-standard-load-balancer/high-availability-guide-standard-load-balancer-public.png)

### <a name="important-considerations"></a>Важные сведения

- Вы можете использовать один дополнительный общедоступный Load Balancer для нескольких виртуальных машин в одной подсети для обеспечения исходящего подключения к общедоступной конечной точке и оптимизации затрат.  
- Используйте [группы безопасности сети](https://docs.microsoft.com/azure/virtual-network/security-overview) для управления тем, какие общедоступные конечные точки доступны из виртуальных машин. Группу безопасности сети можно назначить подсети или каждой виртуальной машине. Там, где это возможно, используйте [теги службы](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) , чтобы уменьшить сложность правил безопасности.  
- Стандартный балансировщик нагрузки Azure с общедоступным IP-адресом и правилами исходящего трафика обеспечивает прямой доступ к общедоступной конечной точке. Если у вас есть корпоративные требования к безопасности, чтобы весь исходящий трафик проходил через централизованное корпоративное решение для аудита и ведения журнала, вы не сможете выполнить эти требования в этом сценарии.  

>[!TIP]
>Там, где это возможно, используйте [теги службы](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) , чтобы уменьшить сложность группы безопасности сети. 

### <a name="deployment-steps"></a>Шаги по развертыванию

1. Создание балансировщика нагрузки  
   1. В [портал Azure](https://portal.azure.com) щелкните все ресурсы, добавить, а затем выполните поиск по запросу **Load Balancer**  
   1. Нажмите кнопку **Создать**. 
   1. Имя Load Balancer **мипублиЦилб**  
   1. Выберите **общедоступный** как тип, " **стандартный** " как SKU  
   1. Выберите **создать общедоступный IP-адрес** и укажите в качестве имени **мипублиЦилбфрондендип** .  
   1. Выберите **зону избыточности** в качестве зоны доступности.  
   1. Щелкните Проверка и создать, а затем — создать.  
2. Создайте серверный пул **мибаккендпулофпублиЦилб** и добавьте виртуальные машины.  
   1. Выберите виртуальную сеть  
   1. Выберите виртуальные машины и их IP-адреса и добавьте их в внутренний пул.  
3. [Создание правил для исходящих подключений](https://docs.microsoft.com/azure/load-balancer/configure-load-balancer-outbound-cli#create-outbound-rule). Сейчас невозможно создать правила исходящего трафика из портал Azure. Правила для исходящего трафика можно создать с помощью [Azure CLI](https://docs.microsoft.com/azure/cloud-shell/overview?view=azure-cli-latest).  

   ```
    az network lb outbound-rule create --address-pool MyBackendPoolOfPublicILB --frontend-ip-configs MyPublicILBFrondEndIP --idle-timeout 30 --lb-name MyPublicILB --name MyOutBoundRules  --outbound-ports 10000 --enable-tcp-reset true --protocol All --resource-group MyResourceGroup
   ```

4. Создайте правила группы безопасности сети, чтобы ограничить доступ к конкретным общедоступным конечным точкам. Если существует группа безопасности сети, ее можно настроить. В приведенном ниже примере показано, как разрешить доступ только к API управления Azure. 
   1. Перейдите к группе безопасности сети.
   1. Щелкните правила безопасности для исходящего трафика.
   1. Добавьте правило, **запрещающее** весь исходящий доступ к **Интернету**.
   1. Добавьте правило, **разрешающее** доступ к **AzureCloud**с приоритетом ниже приоритета правила, чтобы запретить доступ к Интернету.


   Правила безопасности для исходящего трафика будут выглядеть следующим образом: 

   ![Исходящее подключение со второй Load Balancer с общедоступным IP-адресом](./media/high-availability-guide-standard-load-balancer/high-availability-guide-standard-load-balancer-network-security-groups.png)

   Дополнительные сведения о группах безопасности сети Azure см. в разделе [группы безопасности ](https://docs.microsoft.com/azure/virtual-network/security-overview). 

## <a name="azure-firewall-for-outbound-connections-to-internet"></a>Брандмауэр Azure для исходящих подключений к Интернету

Другой вариант для обеспечения исходящего подключения к общедоступным конечным точкам без разрешения входящего подключения к виртуальной машине из общедоступных конечных точек — это брандмауэр Azure. Брандмауэр Azure — это управляемая служба со встроенной высокой доступностью, которая может охватывать несколько Зоны доступности.  
Кроме того, вам потребуется развернуть [определяемый пользователем маршрут](https://docs.microsoft.com/azure/virtual-network/virtual-networks-udr-overview#custom-routes), связанный с подсетью, в которой развернуты виртуальные машины и балансировщик нагрузки Azure, указав брандмауэр Azure для маршрутизации трафика через брандмауэр Azure.  
Дополнительные сведения о развертывании брандмауэра Azure см. в статье [развертывание и настройка брандмауэра Azure](https://docs.microsoft.com/azure/firewall/tutorial-firewall-deploy-portal).  

Архитектура выглядит следующим образом:

![Исходящее подключение с помощью брандмауэра Azure](./media/high-availability-guide-standard-load-balancer/high-availability-guide-standard-load-balancer-firewall.png)

### <a name="important-considerations"></a>Важные сведения

- Брандмауэр Azure — это облачная собственная служба со встроенной высокой доступностью, которая поддерживает развертывание зональные.
- Требуется дополнительная подсеть, которая должна называться Азурефиреваллсубнет. 
- При передаче больших наборов данных, исходящих из виртуальной сети, в которой находятся виртуальные машины SAP, на виртуальную машину в другой виртуальной сети или в общедоступную конечную точку, это может не быть экономичным решением. Одним из таких примеров является копирование больших резервных копий в виртуальные сети. Дополнительные сведения см. в разделе цены на брандмауэр Azure.  
- Если корпоративное решение брандмауэра не является брандмауэром Azure и у вас есть требования к безопасности, позволяющие пройти весь исходящий трафик, хотя это централизованное корпоративное решение, это решение может оказаться непрактичным.  

>[!TIP]
>Там, где это возможно, используйте [теги службы](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) , чтобы уменьшить сложность правил брандмауэра Azure.  

### <a name="deployment-steps"></a>Шаги по развертыванию

1. В шагах развертывания предполагается, что у вас уже есть виртуальная сеть и подсеть, определенные для виртуальных машин.  
2. Создайте подсеть **азурефиреваллсубнет** в той же виртуальной сети, где развернуты виртуальные машины и Load Balancer (цен. Категория "Стандартный").  
   1. В портал Azure перейдите к виртуальной сети: щелкните все ресурсы, найдите виртуальную сеть, щелкните виртуальную сеть и выберите подсети.  
   1. Нажмите кнопку Добавить подсеть. Введите **азурефиреваллсубнет** в качестве имени. Введите соответствующий диапазон адресов. Щелкните Save (Сохранить).  
3. Создайте брандмауэр Azure.  
   1. В портал Azure выберите все ресурсы, щелкните Добавить, брандмауэр, создать. Выберите группу ресурсов (выберите ту же группу ресурсов, в которой находится виртуальная сеть).  
   1. Введите имя для ресурса брандмауэра Azure. Например, **мязурефиревалл**.  
   1. Выберите регион и выберите по крайней мере две зоны доступности, согласованные с зонами доступности, в которых развернуты виртуальные машины.  
   1. Выберите виртуальную сеть, в которой развернуты виртуальные машины SAP и стандартный балансировщик нагрузки Azure.  
   1. Общедоступный IP-адрес: щелкните Создать и введите имя. Для экземпляра **мифиреваллпублиЦип**.  
4. Создайте правило брандмауэра Azure, чтобы разрешить исходящее подключение к указанным общедоступным конечным точкам. В примере показано, как разрешить доступ к общедоступной конечной точке API управления Azure.  
   1. Выберите правила, коллекция сетевых правил, а затем щелкните Добавить коллекцию сетевых правил.  
   1. Имя: **мйоутбаундруле**, введите Priority, выберите действие **Разрешить**.  
   1. Служба: имя **тоазуреапи**.  Протокол: выберите **любой**. Исходный адрес. Введите диапазон для подсети, в которой развернуты виртуальные машины и Load Balancer (цен. категория "Стандартный") для экземпляра: **11.97.0.0/24**. Порты назначения. Введите <b>*</b>.  
   1. Сохранить
   1. По мере того, как вы по-прежнему располагаете на брандмауэре Azure, выберите Обзор. Запишите частный IP-адрес брандмауэра Azure.  
5. Создание маршрута к брандмауэру Azure  
   1. В портал Azure выберите все ресурсы, а затем щелкните Добавить, таблица маршрутов, создать.  
   1. Введите имя MyRouteTable, выберите подписку, группу ресурсов и расположение (соответствующее расположение виртуальной сети и брандмауэра).  
   1. Сохранить  

   Правило брандмауэра будет выглядеть следующим образом: ![исходящее подключение с помощью брандмауэра Azure](./media/high-availability-guide-standard-load-balancer/high-availability-guide-standard-load-balancer-firewall-rule.png)

6. Создайте определяемый пользователем маршрут из подсети виртуальных машин на частный IP-адрес **мязурефиревалл**.
   1. По мере расположения в таблице маршрутов щелкните Routes (маршруты). Выберите "Добавить". 
   1. Имя маршрута: Томязурефиревалл, префикс адреса: **0.0.0.0/0**. Тип следующего прыжка: Выберите виртуальное устройство. Адрес следующего прыжка. Введите частный IP-адрес настроенного брандмауэра: **11.97.1.4**.  
   1. Сохранить

## <a name="using-proxy-for-pacemaker-calls-to-azure-management-api"></a>Использование прокси-сервера для вызовов Pacemaker к API управления Azure

Вы можете использовать прокси-сервер, чтобы разрешить вызовы Pacemaker в общедоступной конечной точке API управления Azure.  

### <a name="important-considerations"></a>Важные сведения

  - Если на месте уже имеется корпоративный прокси-сервер, можно направить исходящие вызовы в общедоступные конечные точки. Исходящие вызовы к общедоступным конечным точкам будут проходить через корпоративную точку управления.  
  - Убедитесь, что конфигурация прокси-сервера разрешает исходящее подключение к API управления Azure: https://management.azure.com  
  - Убедитесь в наличии маршрута от виртуальных машин к прокси-серверу.  
  - Прокси-сервер будет обслуживать только вызовы HTTP/HTTPS. Если есть необходимость делать исходящие вызовы к общедоступной конечной точке по различным протоколам (например, RFC), потребуется альтернативное решение.  
  - Чтобы избежать нестабильности в кластере Pacemaker, необходимо обеспечить высокий уровень доступности для решения прокси-сервера.  
  - В зависимости от расположения прокси-сервера это может привести к дополнительной задержке в вызовах от агента ограждения Azure к API управления Azure. Если корпоративный прокси-сервер по-прежнему находится в локальной среде, а кластер Pacemaker находится в Azure, измерьте задержку и подумайте, если это решение подходит для вас.  
  - Если у вас нет высокодоступного корпоративного прокси, мы не рекомендуем использовать этот вариант, так как клиент будет иметь дополнительную стоимость и сложность. Тем не менее, если вы решили развернуть дополнительное прокси-решение, чтобы разрешить исходящее подключение из Pacemaker к общедоступному API управления Azure, убедитесь, что прокси-сервер имеет высокий уровень доступности, а задержка от виртуальных машин до прокси-сервера мала.  

### <a name="pacemaker-configuration-with-proxy"></a>Конфигурация Pacemaker с прокси-сервером 

В отрасли доступно множество различных вариантов прокси-сервера. Пошаговые инструкции по развертыванию прокси-сервера выходят за рамки этого документа. В приведенном ниже примере предполагается, что прокси-сервер отвечает на **мипроксисервице** и ожидает передачи данных через порт **MyProxyPort**.  
Чтобы разрешить Pacemaker взаимодействовать с API управления Azure, выполните следующие действия на всех узлах кластера:  

1. Измените файл конфигурации Pacemaker/ЕТК/сисконфиг/пацемакер и добавьте следующие строки (все узлы кластера):  
   ```
   sudo vi /etc/sysconfig/pacemaker
   # Add the following lines
   http_proxy=http://MyProxyService:MyProxyPort
   https_proxy=http://MyProxyService:MyProxyPort
   ```

2. Перезапустите службу Pacemaker на **всех** узлах кластера.  
  - SUSE  
     ```
     # Place the cluster in maintenance mode
     sudo pcs property set maintenance-mode=true
     #Restart on all nodes
     sudo systemctl restart pacemaker
     # Take the cluster out of maintenance mode
     sudo pcs property set maintenance-mode=false
     ```

  - Red Hat  
     ```
     # Place the cluster in maintenance mode
     sudo pcs property set maintenance-mode=true
     #Restart on all nodes
     sudo systemctl restart pacemaker
     # Take the cluster out of maintenance mode
     sudo pcs property set maintenance-mode=false
     ```

## <a name="next-steps"></a>Дальнейшие действия

* [Узнайте, как настроить Pacemaker в SUSE в Azure.](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/high-availability-guide-suse-pacemaker)
* [Узнайте, как настроить Pacemaker на Red Hat в Azure.](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/high-availability-guide-rhel-pacemaker)
