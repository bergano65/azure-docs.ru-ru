---
title: Принципы и подготовка аварийного восстановления для решения "SAP HANA на крупных экземплярах Azure" | Документация Майкрософт
description: Принципы и подготовка аварийного восстановления для решения "SAP HANA на крупных экземплярах Azure"
services: virtual-machines-linux
documentationcenter: ''
author: saghorpa
manager: jeconnoc
editor: ''
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 09/10/2018
ms.author: saghorpa
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: ff214460d919eff5c3c1a2e608958673867ddc55
ms.sourcegitcommit: 794bfae2ae34263772d1f214a5a62ac29dcec3d2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/11/2018
ms.locfileid: "44492863"
---
# <a name="disaster-recovery-principles"></a>Принципы аварийного восстановления

Решение "HANA (крупные экземпляры)" предлагает функции аварийного восстановления между стеками крупных экземпляров HANA в разных регионах Azure. Например, если вы развернете единицы крупного экземпляра HANA в регионе Azure "Западная часть США", то сможете использовать единицы крупного экземпляра HANA в регионе "Восточная часть США" как единицы аварийного восстановления. Как упоминалось ранее, аварийное восстановление не настраивается автоматически, так как требует платы за еще одну единицу крупного экземпляра HANA в регионе аварийного восстановления. Конфигурация аварийного восстановления работает с конфигурациями увеличения масштаба и развертывания. 

В развернутых на текущий момент сценариях клиенты использовали единицу в регионе аварийного восстановления для запуска непроизводственных систем, использующих установленный экземпляр HANA. Единица крупного экземпляра HANA должна использовать номер SKU, используемый в производственных целях. Конфигурация диска между экземпляром сервера в рабочем регионе Azure и регионе аварийного восстановления выглядит следующим образом:

![Конфигурация установки аварийного восстановления с точки зрения диска](./media/hana-overview-high-availability-disaster-recovery/disaster_recovery_setup.PNG)

Как показано на этом рисунке, вам затем нужно упорядочить второй набор томов диска. У целевых томов диска тот же размер, что и у рабочих томов для рабочего экземпляра в единицах аварийного восстановления. Эти тома диска связаны с экземпляром сервера крупных экземпляров HANA на сайте аварийного восстановления. Следующие тома реплицируются из рабочего региона на сайт аварийного восстановления:

- hana/data;
- /hana/logbackups; 
- /hana/shared (включая /usr/sap).

Том /hana/log не реплицируется, так как журнал транзакций SAP HANA не требуется в случае восстановления из этих томов. 

В основе предлагаемых возможностей аварийного восстановления лежат функции репликации хранилища, предоставляемые инфраструктурой крупного экземпляра HANA. Функциональные возможности, используемые на стороне хранилища, — непостоянный поток изменений, реплицируемых в асинхронном режиме по мере внесения изменений на томе хранилища. Это механизм, в котором используется тот факт, что для этих томов регулярно создаются моментальные снимки. Разница между уже реплицированным моментальным снимком и новым моментальным снимком, который еще не реплицирован, передается на сайт аварийного восстановления и записывается на целевые тома дисков.  Эти снимки хранятся на томах, а в случае отработки отказа аварийного восстановления их потребуется восстановить на этих томах.  

Первая передача полного набора данных тома должна быть выполнена, прежде чем объем данных станет меньше объема разностных данных между моментальными снимками. В результате тома на сайте аварийного восстановления содержат все моментальные снимки томов, созданные на рабочем сайте. Вы можете получить более раннее состояние с помощью системы аварийного восстановления, чтобы восстановить потерянные данные без отката рабочей системы.

В случае развертывания MCOD с несколькими независимыми экземплярами SAP HANA в одной единице крупного экземпляра HANA ожидается, что все экземпляры SAP HANA будут реплицированы в хранилище на стороне аварийного восстановления.

В случаях, когда репликация системы HANA используется для обеспечения высокого уровня доступности на рабочем сайте, а на сайте аварийного восстановления используется репликация на основе хранилища, тома обоих узлов реплицируются с основного сайта на экземпляр аварийного восстановления. На сайте аварийного восстановления необходимо приобрести дополнительную емкость хранилища (того же объема, что и на основном сайте), чтобы вместить реплицируемые данные с основных и дополнительных узлов. 



>[!NOTE]
>Функциональные возможности репликации хранилища крупного экземпляра HANA — это зеркальное отображение и репликация моментальных снимков хранилища. Таким образом, если вы не создаете моментальные снимки хранилища, как описывается в разделе о [резервном копировании и восстановлении](#backup-and-restore) в этой статье, какая-либо репликация на сайт аварийного восстановления будет невозможна. Создание моментальных снимков хранилища является предварительным условием для репликации хранилища на сайт аварийного восстановления.



## <a name="preparation-of-the-disaster-recovery-scenario"></a>Подготовка сценария аварийного восстановления
В этом сценарии требуется рабочая система, работающая на HANA (крупные экземпляры) в рабочем регионе Azure. Чтобы применить сведения ниже, предположим, что идентификатор безопасности этой системы HANA — PRD, и вы имеете нерабочую систему, выполняющуюся на HANA (крупные экземпляры) в регионе аварийного восстановления Azure. Кроме того, предположим, что идентификатор безопасности — TST. Конфигурация будет выглядеть следующим образом:

![Запуск настройки аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/disaster_recovery_start1.PNG)

Если экземпляр сервера еще не был упорядочен с помощью дополнительного набора томов хранилища, решение SAP HANA для управления службами Azure присоединит дополнительный набор томов в качестве целевого для рабочей реплики к единице крупного экземпляра HANA, на которой запущен экземпляр HANA TST. Для этого необходимо предоставить идентификатор безопасности рабочего экземпляра HANA. После того как SAP HANA для управления службами Azure подтвердит присоединение томов, их необходимо добавить к единице крупного экземпляра HANA.

![Следующий шаг по настройке аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/disaster_recovery_start2.PNG)

Далее необходимо установить второй экземпляр SAP HANA на единице крупного экземпляра HANA в регионе аварийного восстановления Azure, где запущен экземпляр HANA TST. Новый установленный экземпляр SAP HANA должен содержать один идентификатор безопасности. У созданных пользователей должен быть тот же идентификатор пользователя и группы, что и у рабочего экземпляра. Дополнительные сведения о резервном копировании и восстановлении см. [здесь](hana-backup-restore.md). Если установка завершилась успешно, необходимо:

- Выполнить шаг 2 из процесса подготовки моментального снимка хранилища, как описано в статье [Архивация и восстановление](hana-backup-restore.md).
- Создать открытый ключ экземпляра HANA (крупные экземпляры) с аварийным восстановлением, если вы еще не сделали это. См. шаг 3 процесса подготовки моментального снимка хранилища в статье [Архивация и восстановление](hana-backup-restore.md).
- Использовать *HANABackupCustomerDetails.txt* с новым экземпляром HANA и проверить правильность подключения к хранилищу.  
- Остановить работу только что установленного экземпляра SAP HANA на единице крупного экземпляра HANA в регионе аварийного восстановления Azure.
- Отключить эти тома PRD и обратиться в службу поддержки решения SAP HANA для управления службами Azure. Тома не могут оставаться подключенными к единице, так как являются недоступными при использовании в качестве целевого объекта репликации хранилища.  

![Шаг по настройке аварийного восстановления перед установкой репликации](./media/hana-overview-high-availability-disaster-recovery/disaster_recovery_start3.PNG)

Рабочая группа установит отношение репликации между томами PRD в рабочем регионе Azure и этими томами в регионе аварийного восстановления Azure.

>[!IMPORTANT]
>Том /hana/log не будет реплицироваться, так как нет необходимости восстанавливать реплицированную базу данных SAP HANA до согласованного состояния на сайте аварийного восстановления.

Далее необходимо настроить или скорректировать расписание резервного копирования моментального снимка хранилища для достижения нужных показателей RTO и RPO в случае аварии. Чтобы свести к минимуму целевую точку восстановления, в службе крупного экземпляра HANA задайте приведенные ниже интервалы репликации.
- Тома, охватываемые объединенным моментальным снимком (типа **hana**), реплицируются каждые 15 минут на эквивалентные целевые тома хранилища на сайте аварийного восстановления.
- Тома резервных копий журналов транзакций (типа **logs**) реплицируются каждые 3 минуты на эквивалентные целевые тома хранилища на сайте аварийного восстановления.

Чтобы свести к минимуму целевую точку восстановления, необходимо спланировать:
- Создание моментального снимка хранилища типа **hana** (см. "Шаг 7. Создание моментальных снимков") каждые 30–60 минут.
- Создание резервных копий журналов транзакций SAP HANA каждые 5 минут.
- Создание моментального снимка хранилища типа **logs** каждые 5–15 минут. Этот период позволяет достичь целевой точки восстановления в 15–25 минут.

При такой конфигурации последовательность создания резервных копий журналов транзакций, моментальных снимков хранилища, а также репликации тома резервных копий журналов транзакций HANA и томов hana/data и /hana/shared (в том числе /usr/sap) может выглядеть, как показано на рисунке.

 ![Связь между созданием и зеркальным отображением моментального снимка резервной копии журналов транзакций по оси времени](./media/hana-overview-high-availability-disaster-recovery/snapmirror.PNG)

Чтобы еще больше улучшить значение целевой точки восстановления в случае аварийного восстановления, можно скопировать резервные копии журналов транзакций HANA из SAP HANA в Azure (крупные экземпляры) в другой регион Azure. Чтобы таким образом дополнительно сократить значение целевой точки восстановления, выполните следующие действия:

1. Выполняйте резервное копирование журналов транзакций HANA на том /hana/logbackups с максимально возможной частотой.
1. С помощью команды rsync скопируйте резервные копии журнала транзакций в общий ресурс NFS, размещенный на виртуальных машинах Azure. Виртуальные машины находятся в виртуальных сетях Azure в рабочем регионе Azure и регионах аварийного восстановления. Необходимо подключить обе виртуальные сети Azure к каналу, соединяющему рабочие крупные экземпляры HANA в Azure. Рисунки можно найти в разделе [рекомендаций по сети для аварийного восстановления с помощью крупных экземпляров HANA](#Network-considerations-for-disaster recovery-with-HANA-Large-Instances). 
1. Храните резервные копии журналов транзакций в этом регионе на виртуальной машине, подключенной к экспортированному хранилищу NFS.
1. В случае аварийной отработки отказа дополните резервные копии журналов транзакций, хранящиеся на томе /hana/logbackups, более новыми резервными копиями журналов транзакций из общедоступного ресурса NFS на сайте аварийного восстановления. 
1. Теперь можно начать восстановление резервной копии журналов транзакций до последней резервной копии, которую удалось сохранить в регионе аварийного восстановления.

Когда операции крупных экземпляров HANA подтвердят установку отношений репликации и вы запустите создание резервных копий моментальных снимков хранилища, начнется репликация данных.

![Шаг по настройке аварийного восстановления перед установкой репликации](./media/hana-overview-high-availability-disaster-recovery/disaster_recovery_start4.PNG)

В ходе репликации моментальные снимки томов PRD в регионах аварийного восстановления Azure только сохраняются, а не восстанавливаются. При таком подключении томов их состояние подобно состоянию при отключении после установки экземпляра SAP HANA PRD на единице сервера в регионе аварийного восстановления Azure. Они также представляют еще не восстановленные резервные копии хранилища.

В случае отработки отказа вместо последнего моментального снимка хранилища вы также можете восстановить более старый моментальный снимок.

## <a name="next-steps"></a>Дополнительная информация

- См. статью о [процедуре отработки отказа при аварийном восстановлении](hana-failover-procedure.md).