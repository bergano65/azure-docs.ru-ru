---
title: Подключение диска данных к виртуальной машине Linux
description: Подключение нового или имеющегося диска данных к виртуальной машине Linux с помощью портала.
author: cynthn
ms.service: virtual-machines-linux
ms.topic: how-to
ms.date: 08/28/2020
ms.author: cynthn
ms.subservice: disks
ms.openlocfilehash: 8f60c83417e9c614ca30f140e6acbbf08e5643cf
ms.sourcegitcommit: d60976768dec91724d94430fb6fc9498fdc1db37
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/02/2020
ms.locfileid: "96500654"
---
# <a name="use-the-portal-to-attach-a-data-disk-to-a-linux-vm"></a>Подключение диска данных к виртуальной машине Linux с помощью портала 
В этой статье показано, как подключить новый и существующий диски к виртуальной машине Linux на портале Azure. Вы также можете [подключить диск данных к виртуальной машине Windows на портале Azure](../windows/attach-managed-disk-portal.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json). 

Прежде чем подключить диски к виртуальной машине, ознакомьтесь со следующими советами:

* Размер виртуальной машины определяет, сколько дисков данных к ней можно подключить. Дополнительную информацию см. в статье [Размеры виртуальных машин](../sizes.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).
* На самом деле диски, подключенные к виртуальным машинам, — это VHD-файлы, хранящиеся в Azure. Дополнительные сведения см. в статье [Обзор компонента "Управляемые диски" Azure](../managed-disks-overview.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).
* Подключив диск, необходимо [подключиться к виртуальной машине Linux для подключения нового диска](#connect-to-the-linux-vm-to-mount-the-new-disk).


## <a name="find-the-virtual-machine"></a>Поиск виртуальной машины
1. Используйте [портал Azure](https://portal.azure.com/) для поиска виртуальной машины. Найдите и щелкните **Виртуальные машины**.
2. Выберите виртуальную машину из списка.
3. На странице **виртуальные машины** в разделе **Параметры** выберите **диски**.


## <a name="attach-a-new-disk"></a>Подключение нового диска

1. В области **диски** в разделе **диски данных** выберите **создать и присоедините новый диск**.

1. Введите имя управляемого диска. Проверьте параметры по умолчанию и при необходимости обновите **тип хранилища**, **Размер (гиб)**, **Шифрование** и **кэширование узла** .
   
   :::image type="content" source="./media/attach-disk-portal/create-new-md.png" alt-text="Проверьте параметры диска.":::


1. По завершении нажмите кнопку **сохранить** в верхней части страницы, чтобы создать управляемый диск и обновить конфигурацию виртуальной машины.


## <a name="attach-an-existing-disk"></a>Подключение существующего диска
1. В области **диски** в разделе **диски данных** выберите  **подключить существующие диски**.
1. Щелкните раскрывающееся меню для **имени диска** и выберите диск из списка доступных управляемых дисков. 

1. Щелкните **Сохранить**, чтобы подключить имеющийся управляемый диск и обновить конфигурацию виртуальной машины:
   

## <a name="connect-to-the-linux-vm-to-mount-the-new-disk"></a>Подключение к виртуальной машине Linux для подключения нового диска
Чтобы разбить диск на разделы, отформатировать и подключить новый диск к виртуальной машине Linux, подключитесь к своей виртуальной машине по протоколу SSH. Дополнительные сведения см. в статье [Как использовать SSH с Linux в Azure](mac-create-ssh-keys.md). В следующем примере подключается к виртуальной машине с общедоступным IP-адресом *10.123.123.25* с именем пользователя *azureuser*: 

```bash
ssh azureuser@10.123.123.25
```

## <a name="find-the-disk"></a>Поиск диска

После подключения к виртуальной машине необходимо найти диск. В этом примере мы используем `lsblk` для перечисления дисков. 

```bash
lsblk -o NAME,HCTL,SIZE,MOUNTPOINT | grep -i "sd"
```

Вы должны увидеть результат, аналогичный приведенному ниже.

```bash
sda     0:0:0:0      30G
├─sda1             29.9G /
├─sda14               4M
└─sda15             106M /boot/efi
sdb     1:0:1:0      14G
└─sdb1               14G /mnt
sdc     3:0:0:0       4G
```

В этом примере добавленный диск — `sdc` . Это LUN 0 и 4 ГБ.

Для более сложного примера ниже показано, как на портале выглядят несколько дисков данных:

:::image type="content" source="./media/attach-disk-portal/create-new-md.png" alt-text="Проверьте параметры диска.":::

На рисунке видно, что имеется 3 диска данных: 4 ГБ на LUN 0, 16 ГБ в LUN 1 и 32G в LUN 2.

Вот как это может выглядеть с помощью `lsblk` :

```bash
sda     0:0:0:0      30G
├─sda1             29.9G /
├─sda14               4M
└─sda15             106M /boot/efi
sdb     1:0:1:0      14G
└─sdb1               14G /mnt
sdc     3:0:0:0       4G
sdd     3:0:0:1      16G
sde     3:0:0:2      32G
```

Из выходных данных `lsblk` можно увидеть, что диск 4 ГБ в LUN 0 — `sdc` , диск 16 ГБ в LUN 1 `sdd` , а диск 32G в LUN 2 — `sde` .

### <a name="partition-a-new-disk"></a>Разбиение нового диска на разделы

Если вы используете существующий диск, содержащий данные, перейдите к подключению диска. Если вы подключаете новый диск, разбейте его на разделы.

`parted`Служебную программу можно использовать для разбиения на разделы и форматирования диска данных.

> [!NOTE]
> Рекомендуется использовать последнюю версию `parted` , доступную для дистрибутив.
> Если размер диска равен 2 тебибитес (тиб) или больше, необходимо использовать секционирование GPT. Если размер диска составляет 2 Тиб, можно использовать секционирование MBR или GPT.  


В следующем примере используется `parted` On `/dev/sdc` , где первый диск данных обычно находится на большинстве виртуальных машин. Замените на `sdc` правильный параметр для диска. Мы также используем форматирование в файловой системе [XFS](https://xfs.wiki.kernel.org/) .

```bash
sudo parted /dev/sdc --script mklabel gpt mkpart xfspart xfs 0% 100%
sudo mkfs.xfs /dev/sdc1
sudo partprobe /dev/sdc1
```

Используйте [`partprobe`](https://linux.die.net/man/8/partprobe) программу, чтобы убедиться в том, что ядро осведомлено о новом разделе и файловой системе. Невозможность использования `partprobe` может привести к тому, что команды blkid или лслбк не возвращали UUID для новой файловой системы немедленно.

### <a name="mount-the-disk"></a>Подключение диска

Создайте каталог для подключения файловой системы, используя `mkdir`. В следующем примере создается каталог в `/datadrive` :

```bash
sudo mkdir /datadrive
```

Используйте `mount`, чтобы затем подключить файловую систему. В следующем примере раздел */dev/sdc1* подключается к `/datadrive` точке подключения:

```bash
sudo mount /dev/sdc1 /datadrive
```

Чтобы обеспечить автоматическое повторное подключение диска после перезагрузки, его необходимо добавить в файл */etc/fstab*. Также настоятельно рекомендуется использовать UUID (универсальный уникальный идентификатор) в */etc/fstab* для ссылки на диск, а не только на имя устройства (например, */dev/sdc1*). Если операционная система обнаруживает ошибку диска во время загрузки, использование UUID позволяет избежать подключения ошибочного диска в это расположение. Остальные диски с данными затем получают те же идентификаторы устройств. Чтобы найти UUID нового диска, используйте служебную программу `blkid`:

```bash
sudo blkid
```

Результат должен быть аналогичным приведенному ниже:

```bash
/dev/sda1: LABEL="cloudimg-rootfs" UUID="11111111-1b1b-1c1c-1d1d-1e1e1e1e1e1e" TYPE="ext4" PARTUUID="1a1b1c1d-11aa-1234-1a1a1a1a1a1a"
/dev/sda15: LABEL="UEFI" UUID="BCD7-96A6" TYPE="vfat" PARTUUID="1e1g1cg1h-11aa-1234-1u1u1a1a1u1u"
/dev/sdb1: UUID="22222222-2b2b-2c2c-2d2d-2e2e2e2e2e2e" TYPE="ext4" TYPE="ext4" PARTUUID="1a2b3c4d-01"
/dev/sda14: PARTUUID="2e2g2cg2h-11aa-1234-1u1u1a1a1u1u"
/dev/sdc1: UUID="33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e" TYPE="xfs" PARTLABEL="xfspart" PARTUUID="c1c2c3c4-1234-cdef-asdf3456ghjk"
```

> [!NOTE]
> Некорректное изменение файла **/etc/fstab** может привести к невозможности загрузить систему. Если у вас есть сомнения, см. инструкции по правильному изменению этого файла в документации дистрибутива. Также рекомендуется перед внесением изменений создать резервную копию файла /etc/fstab.

Затем откройте файл */etc/fstab* в текстовом редакторе, как показано ниже:

```bash
sudo nano /etc/fstab
```

В этом примере используйте значение UUID для `/dev/sdc1` устройства, созданного на предыдущих шагах, и точку подключения `/datadrive` . Добавьте следующую строку в конец `/etc/fstab` файла:

```bash
UUID=33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e   /datadrive   xfs   defaults,nofail   1   2
```

Мы использовали редактор Nano, поэтому по завершении редактирования файла используйте `Ctrl+O` для записи файла и `Ctrl+X` выхода из редактора.

> [!NOTE]
> Если вы позднее удалите диск данных без редактирования файла fstab, виртуальная машина может не загрузиться. Большинство дистрибутивов поддерживает параметры fstab *nofail* и (или) *nobootwait*. Эти параметры позволяют системе загружаться, даже если диск не подключится во время загрузки. Дополнительные сведения об этих параметрах см. в документации дистрибутива.
> 
> Параметр *nofail* обеспечивает запуск виртуальной машины даже в том случае, если файловая система повреждена или отсутствует диск во время загрузки. Без этого параметра может возникнуть ситуация, описанная в записи блога [Cannot SSH to Linux VM due to FSTAB errors](/archive/blogs/linuxonazure/cannot-ssh-to-linux-vm-after-adding-data-disk-to-etcfstab-and-rebooting) (Не удается подключиться к виртуальной машине Linux по протоколу SSH из-за ошибок FSTAB).


## <a name="verify-the-disk"></a>Проверка диска

Теперь вы можете использовать его `lsblk` снова, чтобы увидеть диск и точку подключения.

```bash
lsblk -o NAME,HCTL,SIZE,MOUNTPOINT | grep -i "sd"
```

Результат должен выглядеть следующим образом.

```bash
sda     0:0:0:0      30G
├─sda1             29.9G /
├─sda14               4M
└─sda15             106M /boot/efi
sdb     1:0:1:0      14G
└─sdb1               14G /mnt
sdc     3:0:0:0       4G
└─sdc1                4G /datadrive
```

Вы видите, что `sdc` теперь подключено по адресу `/datadrive` .

### <a name="trimunmap-support-for-linux-in-azure"></a>Поддержка операций TRIM и UNMAP для Linux в Azure

Некоторые ядра Linux поддерживают операции TRIM и UNMAP для отмены неиспользуемых блоков на диске. Эту функцию особенно удобно использовать в хранилище уровня "Стандартный", чтобы сообщать Azure о том, что удаленные страницы больше не действительны и могут быть удалены. Это позволяет сократить затраты, если вы создаете большие файлы, а затем удаляете их.

Существует два способа включить поддержку операций TRIM в виртуальной машине Linux. Как обычно, обратитесь к документации дистрибутива, чтобы выбрать рекомендуемый метод.

* Используйте параметр подключения `discard` в */etc/fstab*. Ниже приведен пример.

    ```bash
    UUID=33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e   /datadrive   xfs   defaults,discard   1   2
    ```
* В некоторых случаях параметр `discard` может негативно влиять на производительность. Кроме того, вы можете вручную выполнить команду `fstrim` из командной строки или добавить ее в crontab для регулярного выполнения.
  
    **Ubuntu**
  
    ```bash
    sudo apt-get install util-linux
    sudo fstrim /datadrive
    ```
  
    **RHEL или CentOS**

    ```bash
    sudo yum install util-linux
    sudo fstrim /datadrive
    ```

## <a name="next-steps"></a>Дальнейшие действия
Вы можете также [подключить диск данных](add-disk.md) с помощью Azure CLI.