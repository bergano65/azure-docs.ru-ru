---
title: Параметры сети службы "Azure Image Builder"
description: Общие сведения о параметрах сети при развертывании службы "Построитель образов виртуальных машин Azure"
author: danielsollondon
ms.author: danis
ms.date: 08/10/2020
ms.topic: article
ms.service: virtual-machines
ms.subservice: imaging
ms.openlocfilehash: dfd0929ea03cd99033482f71579e91aaf6fc131c
ms.sourcegitcommit: d8b8768d62672e9c287a04f2578383d0eb857950
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2020
ms.locfileid: "88068344"
---
# <a name="azure-image-builder-service-networking-options"></a>Параметры сети службы "Azure Image Builder"

Необходимо выбрать развертывание построителя образов Azure с существующей ВИРТУАЛЬНОЙ сетью или без нее.

## <a name="deploy-without-specifying-an-existing-vnet"></a>Развертывание без указания существующей виртуальной сети

Если вы не укажете существующую виртуальную сеть, построитель образов Azure создаст ВИРТУАЛЬную сеть и подсети в промежуточной группе ресурсов. Ресурс общедоступного IP-адреса используется с группой безопасности сети для ограничения входящего трафика в службу Azure Image Builder. Общедоступный IP-адрес упрощает канал для команд Azure Image Builder во время сборки образа. После завершения сборки виртуальная машина, общедоступный IP-адрес, диски и виртуальная сеть удаляются. Чтобы использовать этот параметр, не указывайте свойства виртуальной сети.

## <a name="deploy-using-an-existing-vnet"></a>Развертывание с использованием существующей виртуальной сети

Если вы указали ВИРТУАЛЬную сеть и подсети, Azure Image Builder развертывает виртуальную машину сборки в выбранной виртуальной сети. Вы можете получить доступ к ресурсам, доступным в виртуальной сети. Кроме того, можно создать виртуальную сеть с назначением, которая не подключена к какой-либо другой виртуальной сети. При указании виртуальной сети в построителе образов Azure не используется общедоступный IP-адрес. Связь из службы Azure Image Builder с виртуальной машиной сборки использует технологию частной связи Azure.

Дополнительные сведения см. в одном из следующих примеров.

* [Использование Azure Image Builder для виртуальных машин Windows, разрешающих доступ к существующей виртуальной сети Azure](../windows/image-builder-vnet.md)
* [Использование Azure Image Builder для виртуальных машин Linux, разрешающих доступ к существующей виртуальной сети Azure](image-builder-vnet.md)

### <a name="what-is-azure-private-link"></a>Что собой представляет Приватный канал Azure?

Частная связь Azure обеспечивает частное подключение из виртуальной сети к службе "платформа как услуга" (PaaS), принадлежащему заказчику или партнерским службам Майкрософт. Она упрощает сетевую архитектуру и защищает подключение между конечными точками в Azure, устраняя доступность данных в общедоступном Интернете. Дополнительные сведения см. в [документации по частному каналу](https://docs.microsoft.com/azure/private-link).

### <a name="required-permissions-for-an-existing-vnet"></a>Необходимые разрешения для существующей виртуальной сети

Для использования существующей виртуальной сети построителю образов Azure требуются определенные разрешения. Дополнительные сведения см. в статье [Настройка разрешений службы Azure Image Builder с помощью Azure CLI](image-builder-permissions-cli.md) или [Настройка разрешений службы Azure Image Builder с помощью PowerShell](image-builder-permissions-powershell.md).

### <a name="what-is-deployed-during-an-image-build"></a>Что развертывается во время сборки образа?

Использование существующей виртуальной сети означает, что Azure Image Builder развертывает дополнительную ВИРТУАЛЬную машину (виртуальную машину прокси) и Azure Load Balancer (ALB), подключенную к частной ссылке. Трафик из службы AIB переключается по закрытой ссылке на ALB. ALB взаимодействует с виртуальной машиной прокси-сервера, используя порт 60001 для ОС Linux или 60000 для ОС Windows. Прокси пересылает команды на виртуальную машину сборки с помощью порта 22 для Linux OS или 5986 для ОС Windows.

> [!NOTE]
> Виртуальная сеть должна находиться в том же регионе, что и область службы Azure Image Builder.
> 

### <a name="why-deploy-a-proxy-vm"></a>Зачем развертывать виртуальную машину прокси-сервера?

Если виртуальная машина без общедоступного IP-адреса находится за внутренним Load Balancer, у нее нет доступа к Интернету. Azure Load Balancer, используемый для виртуальной сети, является внутренним. Прокси-сервер виртуальной машины разрешает доступ к Интернету для виртуальной машины сборки во время сборок. Связанные группы безопасности сети можно использовать для ограничения доступа к виртуальной машине сборки.

Размер развернутой виртуальной машины-посредника — это стандартный A1_v2 в дополнение к виртуальной машине сборки. Виртуальная машина прокси-сервера используется для отправки команд между службой Azure Image Builder и виртуальной машиной сборки. Невозможно изменить свойства виртуальной машины прокси-сервера, включая размер или ОС. Невозможно изменить свойства виртуальной машины-посредника для сборок образа Windows и Linux.

### <a name="image-template-parameters-to-support-vnet"></a>Параметры шаблона образа для поддержки виртуальной сети
```json
"VirtualNetworkConfig": {
        "name": "",
        "subnetName": "",
        "resourceGroupName": ""
        },
```

| Параметр | Описание |
|---------|---------|
| name | Используемых Имя уже существующей виртуальной сети. |
| subnetName | Имя подсети в указанной виртуальной сети. Должен быть указан только в том случае, если указано *имя* . |
| имя_группы_ресурсов | Имя группы ресурсов, содержащей указанную виртуальную сеть. Должен быть указан только в том случае, если указано *имя* . |

Службе частной связи требуется IP-адрес из заданной ВИРТУАЛЬНОЙ сети и подсеть. В настоящее время Azure не поддерживает политики сети для этих IP-адресов. Поэтому политики сети необходимо отключить в подсети. Дополнительные сведения см. в [документации по частному каналу](https://docs.microsoft.com/azure/private-link).

### <a name="checklist-for-using-your-vnet"></a>Контрольный список для использования виртуальной сети

1. Разрешить Azure Load Balancer (ALB) взаимодействовать с виртуальной машиной прокси-сервера в NSG
    * [Пример AZ CLI](image-builder-vnet.md#add-network-security-group-rule)
    * [Пример PowerShell](../windows/image-builder-vnet.md#add-network-security-group-rule)
2. Отключить политику частной службы в подсети
    * [Пример AZ CLI](image-builder-vnet.md#disable-private-service-policy-on-subnet)
    * [Пример PowerShell](../windows/image-builder-vnet.md#disable-private-service-policy-on-subnet)
3. Разрешите Azure Image Builder создать ALB и добавить виртуальные машины в виртуальную сеть.
    * [Пример AZ CLI](image-builder-permissions-cli.md#existing-vnet-azure-role-example)
    * [Пример PowerShell](image-builder-permissions-powershell.md#permission-to-customize-images-on-your-vnets)
4. Разрешить Azure Image Builder читать и записывать образы источника и создавать образы
    * [Пример AZ CLI](image-builder-permissions-cli.md#custom-image-azure-role-example)
    * [Пример PowerShell](image-builder-permissions-powershell.md#custom-image-azure-role-example)
5. Убедитесь, что вы используете виртуальную сеть в том же регионе, что и регион службы Azure Image Builder.


## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в разделе [Общие сведения о построителе образов Azure](image-builder-overview.md).