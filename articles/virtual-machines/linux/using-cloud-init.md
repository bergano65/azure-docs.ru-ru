---
title: Общие сведения о поддержке cloud-init для виртуальных машин Linux в Azure
description: Общие сведения о возможностях cloud-init для настройки виртуальной машины при подготовке в Azure.
author: danielsollondon
ms.service: virtual-machines-linux
ms.subservice: extensions
ms.workload: infrastructure-services
ms.topic: how-to
ms.date: 06/15/2020
ms.author: danis
ms.openlocfilehash: bebf4967d96177038aba64be59d43f49458b82be
ms.sourcegitcommit: dee7b84104741ddf74b660c3c0a291adf11ed349
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85920188"
---
# <a name="cloud-init-support-for-virtual-machines-in-azure"></a>Поддержка cloud-init для виртуальных машин в Azure
Из этой статьи можно узнать об имеющейся поддержке [cloud-init](https://cloudinit.readthedocs.io) для настройки виртуальной машины или масштабируемых наборов виртуальных машин во время подготовки в Azure. Эти настройки конфигурации cloud-init выполняются при первой загрузке, если в Azure подготовлены все нужные ресурсы.  

Подготовка виртуальной машины — это процесс, при котором Azure передает значения параметров создания виртуальной машины, такие как имя узла, имя пользователя, пароль и т. д., и делает их доступными для виртуальной машины при загрузке. "Агент подготовки" принимает эти значения, настраивает виртуальную машину, а, закончив, передает отчет. 

Azure поддерживает два агента подготовки — [cloud-init](https://cloudinit.readthedocs.io) и [агент Linux для Azure (WALA)](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux).

## <a name="cloud-init-overview"></a>Общие сведения о cloud-Init
[Cloud-init](https://cloudinit.readthedocs.io) — широко используемое средство для настройки виртуальной машины Linux при ее первой загрузке. Вы можете использовать cloud-init для установки пакетов, записи файлов или настройки пользователей и параметров безопасности. Так как cloud-init вызывается при начальной загрузке, к вашей конфигурации не нужно применять какие-либо дополнительные действия или агентов.  Дополнительные сведения о том, как правильно отформатировать файлы, `#cloud-config` или другие входные данные, см. на [сайте документации по cloud-init](https://cloudinit.readthedocs.io/en/latest/topics/format.html#cloud-config-data).  Файлы `#cloud-config` — это текстовые файлы, закодированные в формате base64.

Кроме того, cloud-init работает с разными дистрибутивами. Например, для установки пакета не используется **apt-get install** или **yum install**. Вместо этого можно определить список пакетов для установки. Cloud-init автоматически использует собственный инструмент управления пакетами из выбранного дистрибутива.

Мы активно работаем с нашими партнерами по Linux дистрибутив, чтобы иметь доступ к изображениям с поддержкой Cloud-init в Azure Marketplace. Эти образы обеспечивают бесперебойную работу развертываний и конфигураций cloud-init с виртуальными машинами и масштабируемыми наборами виртуальных машин. Сначала мы активно сотрудничаем с нашими утвержденными партнерами, работающими над дистрибутивами Linux, и вышестоящими источниками, чтобы обеспечить работу функций cloud-init с ОС в Azure, а затем пакеты обновляются и переводятся в открытый доступ через репозитории пакетов дистрибутивов. 

Доступ к cloud-init доверенной ОС с дистрибутивом Linux в Azure предоставляется в два этапа — поддержка пакета и поддержка образа:
* документы "Поддержка пакетов cloud-init в Azure" указывают, какие пакеты cloud-init поддерживаются или доступны в предварительной версии. Эти пакеты можно использовать с ОС в пользовательском образе;
* документы "Образ готов для cloud-init", если образ уже настроен для использования cloud-init.


### <a name="canonical"></a>Canonical
| Издатель/версия| ПРЕДЛОЖЕНИЕ | номер SKU | Версия | Образ готов для cloud-init | Поддержка пакетов cloud-init в Azure|
|:--- |:--- |:--- |:--- |:--- |:--- |
|Canonical 20.04 |UbuntuServer |18.04-LTS |последняя |да | да |
|Canonical 18.04 |UbuntuServer |18.04-LTS |последняя |да | да |
|Canonical 16.04|UbuntuServer |16.04-LTS |последняя |да | да |
|Canonical 14.04|UbuntuServer |14.04.5-LTS |последняя |да | да |

### <a name="rhel"></a>RHEL
| Издатель/версия | ПРЕДЛОЖЕНИЕ | номер SKU | Версия | Образ готов для cloud-init | Поддержка пакетов cloud-init в Azure|
|:--- |:--- |:--- |:--- |:--- |:--- |
|RedHat 7.6 |RHEL |7-RAW-CI |7.6.2019072418 |да | да — поддержка из пакета версии: *18.2-1.el7_6.2*|
|RedHat 7.7 |RHEL |7-RAW-CI |7.7.2019081601 | Да (Примечание. это изображение предварительного просмотра, которое больше не **должно** использоваться, оно будет удалено 1 сентября 2020) | Н/Д |
|RedHat 7.7 (Gen1)|RHEL |7.7 | 7.7.2020051912 | да | да — поддержка из пакета версии: *18.5-6.el7*|
|RedHat 7.7 (Gen2)|RHEL | 77-gen2 | 7.7.2020051913 | да | да — поддержка из пакета версии: *18.5-6.el7*|
|RedHat 7.7 (Gen1)|RHEL |7-LVM | 7.7.2020051921 | да | да — поддержка из пакета версии: *18.5-6.el7*|
|RedHat 7.7 (Gen2)|RHEL | 7lvm-gen2 | 7.7.2020051922  | да | да — поддержка из пакета версии: *18.5-6.el7*|
|RedHat 7.7 (Gen1) |rhel-byos | rhel-lvm77 | 7.7.20200416 | да  | да — поддержка из пакета версии: *18.5-6.el7*|
|RedHat 8.1 (Gen1) |RHEL |8.1-ci |8.1.2020042511 | Да (Примечание. это изображение предварительного просмотра, и, как только все образы RHEL 8,1 поддерживают Cloud-init, это будет удалено 1 августа 2020). | Нет, полная поддержка ожидается в июне 2020 года|
|RedHat 8.1 (Gen2) |RHEL |81-ci-gen2 |8.1.2020042524 | Да (Примечание. это изображение предварительного просмотра, и, как только все образы RHEL 8,1 поддерживают Cloud-init, это будет удалено 1 августа 2020). | Нет, полная поддержка ожидается в июне 2020 года |

* Все образы RedHat: RHEL 7,8 и 8,2 (GEN1 и Gen2) подготавливаются с помощью Cloud-init.

### <a name="centos"></a>CentOS

| Издатель/версия | ПРЕДЛОЖЕНИЕ | номер SKU | Версия | Образ готов для cloud-init | Поддержка пакетов cloud-init в Azure|
|:--- |:--- |:--- |:--- |:--- |:--- |
|OpenLogic 7.7 |CentOS |7-CI |7.7.20190920 |Да (Примечание. это изображение предварительного просмотра, которое больше не **должно** использоваться, оно будет удалено 1 сентября 2020) | Н/Д |
|OpenLogic 7.7 |CentOS | 7.7 |7.7.2020062400 |да | Да — поддержка из версии пакета:`18.5-6.el7.centos.5`|
|OpenLogic 7,7 (Gen2) |CentOS | 7_7 — Gen2 |7.7.2020062401 |да | Да — поддержка из версии пакета:`18.5-6.el7.centos.5`|
|OpenLogic 7.7 |CentOS-HPC | 7.7 |7.6.2020062600 |да | Да — поддержка из версии пакета:`18.5-6.el7.centos.5`|
|OpenLogic 7,7 (Gen2) |CentOS-HPC | 7_7 — Gen2 |7.6.2020062601 |да | Да — поддержка из версии пакета:`18.5-6.el7.centos.5`|
|OpenLogic 8,1 |CentOS | 8_1 |8.1.2020062400 |да | Да — поддержка из версии пакета:`18.5-7.el8_1.1`|
|OpenLogic 8,1 (Gen2) |CentOS | 8_1 — Gen2 |8.1.2020062401 |да | Да — поддержка из версии пакета:`18.5-7.el8_1.1`|
|OpenLogic 8,1 |CentOS-HPC | 8_1 |8.1.2020062400 |да | Да — поддержка из версии пакета:`18.5-7.el8_1.1`|
|OpenLogic 8,1 (Gen2) |CentOS-HPC: 8_1-Gen2 | 8_1 — Gen2 |8.1.2020062401 |да | Да — поддержка из версии пакета:`18.5-7.el8_1.1`|

* Все образы OpenLogic: CentOS 7,8 и 8,2 (GEN1 и Gen2) подготавливаются с помощью Cloud-init.

### <a name="oracle"></a>Oracle;

| Издатель/версия | ПРЕДЛОЖЕНИЕ | номер SKU | Версия | Образ готов для cloud-init | Поддержка пакетов cloud-init в Azure|
|:--- |:--- |:--- |:--- |:--- |:--- |
|Oracle 7.7 |Oracle-Linux |77-ci |7.7.01| изображение предварительного просмотра (Примечание. это изображение в режиме предварительного просмотра, и, как только все образы Oracle 7,7 поддерживают Cloud-init, оно будет удалено с посредним 2020, будет указано уведомление). | нет, в предварительной версии, пакет: *18.5-3.0.1.el7*

### <a name="suse-sles"></a>SUSE SLES
Эти образы SLES были обновлены для инициализации с помощью Cloud-init. также были обновлены варианты образа Gen2.
* SUSE: SLES-15-SP1-{Basic/BYOS/HPC/HPC-BYOS/чост-BYOS}: Gen1:2020.06.10
* SUSE: SLES-SAP-15-SP1: Gen1:2020.06.10
* SUSE: SLES-SAP-15-SP1-BYOS: Gen1:2020.06.10
* SUSE: Manager-proxy-4-BYOS: Gen1:2020.06.10
* SUSE: Manager-Server-4-BYOS: Gen1:2020.06.10
* SUSE: SLES-{BYOS/SAP/SAP-BYOS}: 15:2020.06.10
* SUSE: SLES-12-SP5: Gen1:2020.06.10
* SUSE: SLES-12-SP5 {-BYOS/Basic/HPC-BYOS/HPC}: Gen1:2020.06.10
* SUSE: SLES-{BYOS/SAP/SAP-BYOS}: 12-SP4:2020.06.10
* SUSE: SLES-{BYOS/SAP/SAP-BYOS}: 12-SP3:2020.06.10
* SUSE: SLES-{BYOS/SAP/SAP-BYOS}: 12-SP2:2020.06.10


### <a name="debian"></a>Debian
| Издатель/версия | ПРЕДЛОЖЕНИЕ | номер SKU | Версия | Образ готов для cloud-init | Поддержка пакетов cloud-init в Azure|
|:--- |:--- |:--- |:--- |:--- |:--- |
| Debian (GEN1) |Debian-10 | 10 — поддержкой |cloud-init-preview| Да (только для просмотра) | Нет, в предварительной версии. |
| Debian (Gen2) |Debian-10 | 10-поддержкой-Gen2 |cloud-init-preview| Да (только для просмотра) | Нет, в предварительной версии. |




В настоящее время Azure Stack поддерживает подготовку образов с поддержкой cloud-init.

## <a name="what-is-the-difference-between-cloud-init-and-the-linux-agent-wala"></a>Разница между cloud-init и агентом Linux (WALA)
WALA — это уникальный агент платформы Azure, использующийся для подготовки и настройки виртуальных машин и обработки [расширений Azure](https://docs.microsoft.com/azure/virtual-machines/extensions/features-linux). 

Мы улучшили задачу настройки виртуальных машин для использования cloud-init вместо агента Linux таким образом, чтобы имеющиеся пользователи cloud-init смогли применять свои текущие скрипты cloud-init, а новые клиенты могли использовать преимущества функциональных возможностей cloud-init. Если у вас уже есть скрипты cloud-init для настройки систем Linux, то для включения их обработки с использованием cloud-init **дополнительные параметры не требуются**. 

Cloud-init не может обрабатывать расширения Azure, поэтому для обработки расширений в образе должен присутствовать WALA, однако его код подготовки необходимо отключить, чтобы конвертируемые поддерживаемые дистрибутивы Linux могли подготовить cloud-init, а затем установить и правильно настроить WALA.

Если при подготовке виртуальной машины вы не укажете параметр Azure CLI `--custom-data`, cloud-init или WALA примет минимальные необходимые параметры для подготовки виртуальной машины и выполнит развертывание с параметрами по умолчанию.  Если вы ссылаетесь на конфигурацию cloud-init с параметром `--custom-data`, все содержимое ваших пользовательских данных будет доступно для cloud-init при загрузке виртуальной машины.

Конфигурация cloud-init применяется к виртуальным машинам без временных ограничений, которые не приведут к сбою развертывания по времени. К WALA это не относится. Если изменить значения WALA по умолчанию на пользовательские данные обработки, он не сможет превысить общую квоту времени подготовки виртуальной машины в 40 минут, и тогда операция создания виртуальной машины завершится ошибкой.

## <a name="deploying-a-cloud-init-enabled-virtual-machine"></a>Развертывание виртуальной машины с поддержкой cloud-init
Развертывать виртуальную машину с включенным cloud-init так же просто, как и ссылаться на распределение с включенным cloud-init во время развертывания.  Распространители дистрибутивов Linux должны включать и интегрировать cloud-init в свои базовые опубликование образы Azure. Убедившись, что в образе, который нужно развернуть, включен cloud-init, вы можете использовать Azure CLI для его развертывания. 

Первым шагом при развертывании образа является создание группы ресурсов с использованием команды [az group create](/cli/azure/group). Группа ресурсов Azure является логическим контейнером, в котором происходит развертывание ресурсов Azure и управление ими. 

В следующем примере создается группа ресурсов с именем *myResourceGroup* в расположении *eastus*.

```azurecli-interactive 
az group create --name myResourceGroup --location eastus
```

Следующим действием является создание файла *cloud-init.txt* в текущей оболочке и вставка следующей конфигурации. Для этого примера создайте файл в Cloud Shell (не на локальном компьютере). Вы можете использовать любой редактор. Введите `sensible-editor cloud-init.txt`, чтобы создать файл и просмотреть список доступных редакторов. Выберите первый пункт, чтобы использовать редактор **nano**. Убедитесь, что весь файл cloud-init скопирован правильно, особенно первая строка:

```yaml
#cloud-config
package_upgrade: true
packages:
  - httpd
```
Нажмите клавиши `ctrl-X`, чтобы выйти из файла, введите `y`, чтобы сохранить изменения в файле, а затем нажмите клавишу `enter`, чтобы подтвердить имя файла при выходе.

Последним шагом является создание виртуальной машины с использованием команды [az vm create](/cli/azure/vm). 

В следующем примере создаются виртуальная машина *centos74* и ключи SSH, если они не существуют в расположении ключей по умолчанию. Чтобы использовать определенный набор ключей, используйте параметр `--ssh-key-value`.  Используйте параметр `--custom-data`, чтобы передать файл конфигурации cloud-init. Укажите полный путь к конфигурации *cloud-init.txt*, если этот файл сохранен вне текущего рабочего каталога. 

```azurecli-interactive 
az vm create \
  --resource-group myResourceGroup \
  --name centos74 \
  --image OpenLogic:CentOS-CI:7-CI:latest \
  --custom-data cloud-init.txt \
  --generate-ssh-keys 
```

После создания виртуальной машины в Azure CLI появятся сведения о вашем развертывании. Запишите значение `publicIpAddress`. Этот адрес используется для доступа к виртуальной машине.  На создание виртуальной машины, установку пакетов и запуск приложения может потребоваться некоторое время. Некоторые фоновые задачи продолжают работу после возврата к командной строке в Azure CLI. Вы можете подключиться к виртуальной машине по протоколу SSH и выполнить шаги, описанные в разделе "Устранение неполадок", чтобы просмотреть журналы cloud-init. 

## <a name="troubleshooting-cloud-init"></a>Устранение неполадок cloud-init
После подготовки виртуальной машины cloud-init запустит все модули и скрипты, заданные в параметре `--custom-data`, для ее настройки.  Если вам необходимо устранить ошибки или пропуски в конфигурации, найдите имя модуля (`disk_setup` или `runcmd`, к примеру) в журнале cloud-init, который находится в файле **/var/log/cloud-init.log**.

> [!NOTE]
> Не каждый сбой модуля приводит к неустранимому сбою всей конфигурации cloud-init. Например, если используется модуль `runcmd`, при сбое скрипта cloud-init все еще будет отображать сообщение об успешной подготовке, так как выполнен модуль runcmd.

Дополнительные сведения о журнале cloud-init см. в [документации по cloud-init](https://cloudinit.readthedocs.io/en/latest/topics/logging.html) 

## <a name="next-steps"></a>Дальнейшие действия

[Устранение неполадок с Cloud-init](cloud-init-troubleshooting.md).


Примеры изменения конфигураций с помощью cloud-init см. в следующих документах:
 
- [Добавление пользователя Linux к виртуальной машине](cloudinit-add-user.md)
- [Запуск диспетчера пакетов для обновления существующих пакетов при первой загрузке](cloudinit-update-vm.md)
- [Изменение имени локального узла виртуальной машины](cloudinit-update-vm-hostname.md) 
- [Установка пакета приложения, обновление файлов конфигурации и внедрение ключей](tutorial-automate-vm-deployment.md)
 
