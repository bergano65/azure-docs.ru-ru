---
title: Синхронизация времени для виртуальных машин Linux в Azure
description: Синхронизация времени для виртуальных машин Linux.
services: virtual-machines-linux
documentationcenter: ''
author: cynthn
manager: gwallace
tags: azure-resource-manager
ms.service: virtual-machines-linux
ms.topic: how-to
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure-services
ms.date: 08/20/2020
ms.author: cynthn
ms.openlocfilehash: 8a122a36b14bd3c5f4912387dc98585cb89ab53b
ms.sourcegitcommit: e0785ea4f2926f944ff4d65a96cee05b6dcdb792
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2020
ms.locfileid: "88705646"
---
# <a name="time-sync-for-linux-vms-in-azure"></a>Синхронизация времени для виртуальных машин Linux в Azure

Синхронизация времени важна для безопасности и корреляции событий. Иногда она применяется для реализации распределенных транзакций. Точность времени в нескольких компьютерных системах достигается за счет синхронизации. На синхронизацию может влиять ряд факторов, включая перезагрузки и сетевой трафик между источником времени и получающим сведения о времени компьютером. 

Платформа Azure основана на инфраструктуре, работающей под управлением Windows Server 2016. В Windows Server 2016 реализованы улучшенные алгоритмы коррекции времени и синхронизации локальных часов с временем в формате UTC.  Функция "Точное время" в Windows Server 2016 значительно улучшила работу службы VMICTimeSync, которая регулирует точность времени в виртуальных машинах и на сервере. К числу улучшений относится более точное исходное время при запуске или восстановлении виртуальной машины, а также коррекция задержки при прерывании. 

> [!NOTE]
> Краткий обзор службы времени Windows см. в этом [видео](https://aka.ms/WS2016TimeVideo).
>
> Дополнительные сведения см. в статье [Точное время в Windows Server 2016](/windows-server/networking/windows-time-service/accurate-time). 

## <a name="overview"></a>Обзор

Точность часов компьютера оценивается по тому, насколько близки их показания к стандартному времени в формате UTC. Время UTC устанавливается по точным атомным часам, отклонение которых не превышает одной секунды за 300 лет. Однако для считывания времени UTC напрямую требуется специальное оборудование. Вместо этого со временем UTC синхронизируются серверы времени, к которым затем обращаются другие компьютеры. Таким образом достигается масштабируемость и надежность. На каждом компьютере выполняется служба синхронизации времени, которая знает, какие серверы времени следует использовать, и регулярно проверяет необходимость коррекции часов компьютера, при необходимости корректируя время. 

Узлы Azure синхронизированы с внутренними серверами времени Майкрософт, которые получают время от принадлежащих Майкрософт устройств Stratum 1 с антеннами GPS. Виртуальные машины Azure могут получать точное время от узла (*время узла*) непосредственно с сервера времени или использовать эти способы в сочетании. 

На автономном оборудовании операционная система Linux считывает показания аппаратных часов узла только при загрузке. После этого время отсчитывается с помощью таймера прерываний в ядре Linux. В такой конфигурации в показаниях часов со временем будут возникать отклонения. В более новых дистрибутивах Linux в Azure виртуальные машины могут использовать поставщик VMICTimeSync, входящий в состав служб интеграции Linux (LIS), чтобы чаще запрашивать актуальное время от узла.

Взаимодействие виртуальной машины с узлом также может влиять на показания часов. Во время [обслуживания с сохранением памяти](../maintenance-and-updates.md#maintenance-that-doesnt-require-a-reboot) виртуальные машины приостанавливаются на срок до 30 секунд. Например, до начала обслуживания часы виртуальной машины показывают 10:00:00, и приостановка длится 28 секунд. Когда виртуальная машина возобновляет работу, ее часы по-прежнему показывают 10:00:00, то есть отстают на 28 секунд. Чтобы скорректировать это отклонение, служба VMICTimeSync отслеживает происходящее в узле и запрашивает внесение изменений в виртуальные машины.

При отсутствии синхронизации времени на часах виртуальной машины накапливались бы ошибки. При наличии только одной виртуальной машины последствия могут быть незначительными, если только рабочая нагрузка не требует очень точного отсчета времени. Но в большинстве случаев имеется несколько взаимосвязанных виртуальных машин, которые используют время для отслеживания транзакций, поэтому оно должно быть согласовано в масштабе всего развертывания. Если время в виртуальных машинах различается, могут иметь место указанные ниже последствия.

- Проверка подлинности будет завершаться сбоем. Протоколы безопасности, такие как Kerberos, или технологии, зависящие от сертификатов, требуют согласования времени в системах.
- Очень трудно понять, что случилось в системе, если журналы (или другие данные) рассогласованы по времени. Одно и то же событие будет представляться как произошедшее в разное время, что усложняет корреляцию.
- Если часы идут неверно, могут происходить ошибки при выставлении счетов.



## <a name="configuration-options"></a>Варианты настройки

В целом есть три способа настроить синхронизацию времени для виртуальных машин Linux, размещенных в Azure:

- конфигурация по умолчанию для образов из Azure Marketplace, в которой используется как время NTP, так и время узла VMICTimeSync; 
- получение времени только от узла с помощью VMICTimeSync;
- использование другого внешнего сервера времени с применением или без применения времени узла VMICTimeSync.


### <a name="use-the-default"></a>Конфигурация по умолчанию

По умолчанию большинство образов Linux из Azure Marketplace настроено для синхронизации из двух источников: 

- Основным источником является NTP; время получается с NTP-сервера. Например, образы Ubuntu 16.04 LTS из Marketplace используют сервер **ntp.ubuntu.com**.
- Дополнительным источником является служба VMICTimeSync, которая служит для передачи времени узла виртуальным машинам и корректировки после приостановки виртуальных машин для обслуживания. Для поддержания точного времени узлы Azure используют принадлежащие Майкрософт устройства Stratum 1.

В более новых дистрибутивах Linux служба Вмиктимесинк предоставляет источник часов аппаратного таймера (PTP), но более ранние дистрибутивы могут не предоставлять этот источник часов и возвращаться на NTP для получения времени от узла.

Чтобы проверить правильность синхронизации NTP, выполните команду `ntpq -p`.

### <a name="host-only"></a>Только от узла 

Так как NTP-серверы, такие как time.windows.com и ntp.ubuntu.com, являются общедоступными, синхронизация времени с ними требует передачи трафика через Интернет. Различные задержки пакетов могут негативно повлиять на качество синхронизации времени. Удаление NTP путем переключения на синхронизацию только между узлами иногда может улучшить результаты синхронизации времени.

Переход на синхронизацию времени только с узлом имеет смысл, если возникают проблемы при использовании конфигурации синхронизации по умолчанию. Попробуйте использовать синхронизацию только с узлом и посмотрите, улучшится ли синхронизация времени в виртуальной машине. 

### <a name="external-time-server"></a>Внешний сервер времени

Если предъявляются особые требования к синхронизации времени, можно также воспользоваться внешними серверами времени. Внешние серверы времени могут предоставлять определенное время, что может быть полезно для тестирования, обеспечения одинаковости времени в машинах, размещенных в центрах обработки данных, не принадлежащих Майкрософт, или обработки корректировочных секунд особым образом.

Внешний сервер времени можно использовать в сочетании со службой VMICTimeSync, что позволяет получить результаты, сходные с конфигурацией по умолчанию. Сочетание внешнего сервера времени и службы VMICTimeSync — оптимальный способ решения проблем, которые могут возникать при приостановке виртуальных машин для обслуживания. 

## <a name="tools-and-resources"></a>Средства и ресурсы

Есть ряд основных команд, позволяющих проверить конфигурацию синхронизации времени. Подробные сведения об оптимальных способах настройки синхронизации времени для определенного дистрибутива Linux можно найти в документации к нему.

### <a name="integration-services"></a>Службы интеграции

Проверьте, загружена ли служба интеграции (hv_utils).

```bash
lsmod | grep hv_utils
```
Должно отображаться примерно следующее:

```
hv_utils               24418  0
hv_vmbus              397185  7 hv_balloon,hyperv_keyboard,hv_netvsc,hid_hyperv,hv_utils,hyperv_fb,hv_storvsc
```

Проверьте, запущена ли управляющая программа служб интеграции Hyper-V.

```bash
ps -ef | grep hv
```

Должно отображаться примерно следующее:

```
root        229      2  0 17:52 ?        00:00:00 [hv_vmbus_con]
root        391      2  0 17:52 ?        00:00:00 [hv_balloon]
```


### <a name="check-for-ptp-clock-source"></a>Проверка источника таймера PTP

В более новых версиях Linux в рамках поставщика VMICTimeSync доступен источник времени PTP. В более ранних версиях Red Hat Enterprise Linux или CentOS 7.x можно скачать [службы интеграции Linux](https://github.com/LIS/lis-next) и использовать их для установки обновленного драйвера. Когда источник таймера PTP доступен, устройство Linux будет иметь вид/Дев/ПТП*x*. 

Проверьте доступные источники времени PTP.

```bash
ls /sys/class/ptp
```

В этом примере возвращается значение *ptp0*. Мы используем его для проверки имени часов. Чтобы проверить устройство, определите имя часов.

```bash
cat /sys/class/ptp/ptp0/clock_name
```

Вернутся выходные данные: `hyperv`.

### <a name="chrony"></a>chrony

В Ubuntu 19,10 и более поздних версиях, Red Hat Enterprise Linux и CentOS 8. x, [чрони](https://chrony.tuxfamily.org/) настроен для использования источника PTP. Вместо чрони в старых выпусках Linux используется управляющая программа сетевого времени (НТПД), которая не поддерживает источники PTP. Чтобы включить PTP в этих выпусках, чрони необходимо установить и настроить вручную (в чрони. conf) с помощью следующего кода:

```bash
refclock PHC /dev/ptp0 poll 3 dpoll -2 offset 0
```

Дополнительные сведения об Ubuntu и NTP см. в статье [Синхронизация времени](https://help.ubuntu.com/lts/serverguide/NTP.html).

Дополнительные сведения о Red Hat и NTP см. в статье [Настройка NTP](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/ch-configuring_ntp_using_ntpd#s1-Configure_NTP). 

Дополнительные сведения о чрони см. [в разделе Использование чрони](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/ch-configuring_ntp_using_the_chrony_suite#sect-Using_chrony).

Если источники чрони и Вмиктимесинк включены одновременно, можно пометить один из них как **предпочтительный**, который задает другой источник в качестве резервной копии. Так как службы NTP корректируют часы через большие периоды времени, служба VMICTimeSync восстанавливает показания часов после приостановки виртуальных машин гораздо быстрее, чем средства на основе NTP, используемые отдельно.

По умолчанию чронид ускоряет или снижает производительность системных часов для устранения любого смещения времени. Если смещение станет слишком большим, чрони не сможет исправить смещение. Чтобы преодолеть это, `makestep` параметр в **/ЕТК/чрони.конф** можно изменить, чтобы принудительно выполнить синхронизацию времени, если смещение превышает заданное пороговое значение.

 ```bash
makestep 1.0 -1
```

Здесь чрони будет принудительно обновлять время, если смещение больше 1 секунды. Чтобы применить изменения, перезапустите службу чронид:

```bash
systemctl restart chronyd
```

### <a name="systemd"></a>systemd 

В версиях SUSE и Ubuntu до 19,10, синхронизация времени настраивается с использованием [системы](https://www.freedesktop.org/wiki/Software/systemd/). Дополнительные сведения о Ubuntu см. в статье [Синхронизация времени](https://help.ubuntu.com/lts/serverguide/NTP.html). Дополнительные сведения о SUSE см. в разделе 4.5.8 статьи [заметки о Выпуске SUSE Linux Enterprise Server 12 SP3](https://www.suse.com/releasenotes/x86_64/SUSE-SLES/12-SP3/#InfraPackArch.ArchIndependent.SystemsManagement).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в статье [Точное время в Windows Server 2016](/windows-server/networking/windows-time-service/accurate-time).


