---
title: Запись образа виртуальной машины Linux в Azure с помощью Azure CLI | Документы Майкрософт
description: Запись образа виртуальной машины Azure для использования при массовом развертывании с помощью Azure CLI.
services: virtual-machines-linux
documentationcenter: ''
author: cynthn
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.assetid: e608116f-f478-41be-b787-c2ad91b5a802
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: azurecli
ms.topic: article
ms.date: 10/08/2018
ms.author: cynthn
ms.openlocfilehash: 32cd3b9eb60a6d12c71be047740fa96ffdd56310
ms.sourcegitcommit: 4047b262cf2a1441a7ae82f8ac7a80ec148c40c4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2018
ms.locfileid: "49094162"
---
# <a name="how-to-create-an-image-of-a-virtual-machine-or-vhd"></a>Создание образа виртуальной машины или виртуального жесткого диска

<!-- generalize, image - extended version of the tutorial-->

Чтобы создать несколько копий виртуальной машины для использования в Azure, запишите образ виртуальной машины или виртуальный жесткий диск (VHD) операционной системы. Чтобы создать образ для развертывания, необходимо удалить сведения о личной учетной записи. На следующих шагах мы отзовем имеющуюся виртуальную машину, отменим ее выделение и создадим образ. Этот образ затем можно использовать для создания виртуальных машин в любой группе ресурсов в рамках вашей подписки.

Чтобы создать копию имеющейся виртуальной машины Linux для резервного копирования, отладки или передачи специализированного VHD Linux с локальной виртуальной машины, ознакомьтесь со статьей [Создание виртуальной машины Linux на основе пользовательского диска с помощью Azure CLI](upload-vhd.md).  

Для создания пользовательской конфигурации также можно использовать **Packer**. Дополнительные сведения см. в статье [Создание образов виртуальных машин Linux в Azure с помощью Packer](build-image-with-packer.md).

Для создания образа вам понадобятся следующие элементы.

* Виртуальная машина Azure, созданная в модели развертывания с помощью Resource Manager с использованием управляемых дисков. Если вы еще не создали виртуальную машину Linux, то для этого можно использовать [портал](quick-create-portal.md), [Azure CLI](quick-create-cli.md) или [шаблоны Resource Manager](create-ssh-secured-vm-from-template.md). Настройте виртуальную машину согласно своим требованиям. Например, [добавьте диски данных](add-disk.md), примените обновления и установите приложения. 

* Установленная последняя версия [ Azure CLI](/cli/azure/install-az-cli2), на которой выполнен вход в учетную запись Azure с помощью команды [az login](/cli/azure/reference-index#az-login).

## <a name="quick-commands"></a>Быстрые команды

Для тестирования, оценки или изучения виртуальных машин в Azure можно использовать упрощенную версию этой статьи: [Руководство. Создание пользовательского образа виртуальной машины Azure с помощью Azure CLI](tutorial-custom-images.md).


## <a name="step-1-deprovision-the-vm"></a>Шаг 1. Отзыв виртуальной машины
Сначала отзовите виртуальную машину с помощью агента виртуальной машины Azure, чтобы удалить файлы и данные конкретной машины. На исходной виртуальной машине Linux выполните команду `waagent` с параметром `-deprovision+user`. Дополнительные сведения см. в [руководстве пользователя агента Linux Azure](../extensions/agent-linux.md).

1. Подключитесь к виртуальной машине Linux c помощью клиента SSH.
2. В окне сеанса SSH введите следующую команду.
   
    ```bash
    sudo waagent -deprovision+user
    ```
   > [!NOTE]
   > Эту команду следует выполнять только на той виртуальной машине, образ которой требуется записать. Выполнение этой команды не гарантирует, что из образа будет удалена вся конфиденциальная информация и что он будет готов к повторному распространению. Параметр `+user` также удаляет последнюю подготовленную учетную запись пользователя. Чтобы сохранить учетные данные пользователя на виртуальной машине, используйте только параметр `-deprovision`.
 
3. Для продолжения введите **y**. Чтобы предотвратить появление запроса на подтверждение, добавьте параметр `-force` .
4. После выполнения команды введите **выйти**, чтобы закрыть SSH-клиент.

## <a name="step-2-create-vm-image"></a>Шаг 2. Создайте образ виртуальной машины
Используйте Azure CLI, чтобы пометить виртуальную машину как универсальную и записать образ. В следующих примерах замените имена параметров собственными значениями. Примеры имен параметров: *myResourceGroup*, *myVnet* и *myVM*.

1. Отмените подготовку виртуальной машины, распределение которой вы отменили ранее с помощью команды [az vm deallocate](/cli/azure/vm#deallocate). В следующем примере отменяется распределение виртуальной машины *myVM*, входящей в группу ресурсов с именем *myResourceGroup*.
   
    ```azurecli
    az vm deallocate \
      --resource-group myResourceGroup \
      --name myVM
    ```

2. Пометьте виртуальную машину как универсальную с помощью команды [az vm generalize](/cli/azure/vm#generalize). В следующем примере виртуальная машина с именем *myVM*, входящая в группу ресурсов *myResourceGroup*, помечается как универсальная.
   
    ```azurecli
    az vm generalize \
      --resource-group myResourceGroup \
      --name myVM
    ```

3. Создайте образ из ресурса виртуальной машины с помощью команды [az image create](/cli/azure/image#az-image-create). В следующем примере создается образ с именем *myImage* в группе ресурсов с именем *myResourceGroup* на основе ресурса виртуальной машины с именем *myVM*.
   
    ```azurecli
    az image create \
      --resource-group myResourceGroup \
      --name myImage --source myVM
    ```
   
   > [!NOTE]
   > Образ создается в той же группе ресурсов, в которой находится исходная виртуальная машина. Виртуальную машину из этого образа можно создать в любой группе ресурсов в рамках вашей подписки. При управлении вам может потребоваться определенная группа ресурсов для ресурсов виртуальной машины и образов.
   >
   > Перед сохранением образа в хранилище, избыточном в пределах зоны, его необходимо создать в регионе, который поддерживает [зоны доступности](../../availability-zones/az-overview.md) и в котором включен параметр `--zone-resilient true`.

## <a name="step-3-create-a-vm-from-the-captured-image"></a>Шаг 3. Создание виртуальной машины из записанного образа
Создайте виртуальную машину с помощью образа, который создали ранее, использовав команду [az vm create](/cli/azure/vm#az_vm_create). В следующем примере создается виртуальная машина *myVMDeployed* из образа *myImage*.

```azurecli
az vm create \
   --resource-group myResourceGroup \
   --name myVMDeployed \
   --image myImage\
   --admin-username azureuser \
   --ssh-key-value ~/.ssh/id_rsa.pub
```

### <a name="creating-the-vm-in-another-resource-group"></a>Создание виртуальной машины в другой группе ресурсов 

Вы можете создавать виртуальные машины из образа в любой группе ресурсов в рамках своей подписки. Чтобы создать виртуальную машину в другой группе ресурсов, укажите полный идентификатор ресурса для нужного образа. Список образов можно просмотреть с помощью команды [az image list](/cli/azure/image#az-image-list). Результат будет похож на следующий пример.

```json
"id": "/subscriptions/guid/resourceGroups/MYRESOURCEGROUP/providers/Microsoft.Compute/images/myImage",
   "location": "westus",
   "name": "myImage",
```

В следующем примере используется команда [az vm create](/cli/azure/vm#az-vm-create) для создания виртуальной машины в группе ресурсов, отличной от той, в которой размещается исходный образ, путем указания идентификатора ресурса образа.

```azurecli
az vm create \
   --resource-group myOtherResourceGroup \
   --name myOtherVMDeployed \
   --image "/subscriptions/guid/resourceGroups/MYRESOURCEGROUP/providers/Microsoft.Compute/images/myImage" \
   --admin-username azureuser \
   --ssh-key-value ~/.ssh/id_rsa.pub
```


## <a name="step-4-verify-the-deployment"></a>Шаг 4. Проверка развертывания

Чтобы проверить развертывание и начать использовать новую виртуальную машину, подключитесь к ней с помощью SSH. Чтобы подключиться через SSH, найдите IP-адрес или полное доменное имя виртуальной машины с помощью команды [az vm show](/cli/azure/vm#az-vm-show).

```azurecli
az vm show \
   --resource-group myResourceGroup \
   --name myVMDeployed \
   --show-details
```

## <a name="next-steps"></a>Дополнительная информация
Вы можете создать несколько виртуальных машин из исходного образа виртуальной машины. Внесите изменения в образ. 

- Создайте виртуальную машину из образа.
- Выполните желаемые обновления или изменения конфигурации.
- Повторите весь процесс: отзовите виртуальную машину, освободите ее, подготовьте к работе и запишите образ.
- Используйте этот новый образ для будущих развертываний. Вы можете удалить исходный образ.

Чтобы узнать больше об управлении виртуальными машинами с помощью интерфейса командной строки, ознакомьтесь с [Azure CLI](/cli/azure).
