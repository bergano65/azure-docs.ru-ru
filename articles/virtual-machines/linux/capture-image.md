---
title: Запись управляемого образа виртуальной машины Linux с помощью Azure CLI
description: Запись управляемого образа виртуальной машины Azure для использования при массовом развертывании с помощью Azure CLI.
author: cynthn
ms.service: virtual-machines
ms.subservice: imaging
ms.topic: how-to
ms.date: 10/08/2018
ms.author: cynthn
ms.custom: legacy, devx-track-azurecli
ms.openlocfilehash: 376d9d76633060f504454f85841b9c15bafc6685
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "87503044"
---
# <a name="how-to-create-a-managed-image-of-a-virtual-machine-or-vhd"></a>Создание управляемого образа виртуальной машины или виртуального жесткого диска

Чтобы создать несколько копий виртуальной машины для использования в Azure для разработки и тестирования, запишите управляемый образ виртуальной машины или виртуальный жесткий диск (VHD) операционной системы. Сведения о создании, хранении и совместном использовании образов в большом масштабе см. в статье [Общая коллекция образов](../shared-images-cli.md).

Один управляемый образ поддерживает до 20 одновременных развертываний. Попытка одновременного создания более 20 виртуальных машин из одного управляемого образа может привести к истечению времени ожидания подготовки из-за ограничений производительности хранилища для одного виртуального жесткого диска. Для одновременного создания более 20 виртуальных машин используйте образ из [общей коллекции образов](shared-image-galleries.md), настроенный с 1 репликой, для каждых 20 одновременно выполняемых развертываний виртуальных машин.

Чтобы создать управляемый образ, необходимо удалить сведения о личной учетной записи. На следующих шагах мы отзовем имеющуюся виртуальную машину, отменим ее выделение и создадим образ. Этот образ затем можно использовать для создания виртуальных машин в любой группе ресурсов в рамках вашей подписки.

Чтобы создать копию имеющейся виртуальной машины Linux для резервного копирования, отладки или передачи специализированного VHD Linux с локальной виртуальной машины, ознакомьтесь со статьей [Создание виртуальной машины Linux на основе пользовательского диска с помощью Azure CLI](upload-vhd.md).  

Вы можете использовать службу **Конструктор образов виртуальных машин Azure (предварительная версия)** , чтобы создать настраиваемый образ. При этом вам не нужно изучать какие-либо средства или настраивать конвейеры сборки — достаточно указать конфигурацию образа, после чего конструктор образов создаст образ. Дополнительные сведения см. в статье [Приступая к работе с конструктором образов виртуальных машин Azure](./image-builder-overview.md).

Для создания образа вам понадобятся следующие элементы.

* Виртуальная машина Azure, созданная в модели развертывания с помощью Resource Manager с использованием управляемых дисков. Если вы еще не создали виртуальную машину Linux, то для этого можно использовать [портал](quick-create-portal.md), [Azure CLI](quick-create-cli.md) или [шаблоны Resource Manager](create-ssh-secured-vm-from-template.md). Настройте виртуальную машину согласно своим требованиям. Например, [добавьте диски данных](add-disk.md), примените обновления и установите приложения. 

* Установленная последняя версия [ Azure CLI](/cli/azure/install-az-cli2), на которой выполнен вход в учетную запись Azure с помощью команды [az login](/cli/azure/reference-index#az-login).

## <a name="prefer-a-tutorial-instead"></a>Предпочитаете учебник?

Для тестирования, оценки или изучения виртуальных машин в Azure можно использовать упрощенную версию этой статьи: [Руководство. Создание пользовательского образа виртуальной машины Azure с помощью Azure CLI](tutorial-custom-images.md).  В противном случае продолжите чтение, чтобы получить полную картину.


## <a name="step-1-deprovision-the-vm"></a>Шаг 1. Отзыв виртуальной машины
Сначала отзовите виртуальную машину с помощью агента виртуальной машины Azure, чтобы удалить файлы и данные конкретной машины. На исходной виртуальной машине Linux выполните команду `waagent` с параметром `-deprovision+user`. Дополнительные сведения см. в [руководстве пользователя агента Linux Azure](../extensions/agent-linux.md).

1. Подключитесь к виртуальной машине Linux c помощью клиента SSH.
2. В окне сеанса SSH введите следующую команду.
   
    ```bash
    sudo waagent -deprovision+user
    ```
   > [!NOTE]
   > Эту команду следует выполнять только на той виртуальной машине, образ которой требуется записать. Выполнение этой команды не гарантирует, что из образа будет удалена вся конфиденциальная информация и что он будет готов к повторному распространению. Параметр `+user` также удаляет последнюю подготовленную учетную запись пользователя. Чтобы сохранить учетные данные пользователя на виртуальной машине, используйте только параметр `-deprovision`.
 
3. Для продолжения введите **y**. Чтобы предотвратить появление запроса на подтверждение, добавьте параметр `-force` .
4. После выполнения команды введите **выйти**, чтобы закрыть SSH-клиент.  На этом этапе виртуальная машина будет по-прежнему работать.

## <a name="step-2-create-vm-image"></a>Шаг 2. Создание образа виртуальной машины
Используйте Azure CLI, чтобы пометить виртуальную машину как универсальную и записать образ. В следующих примерах замените имена параметров собственными значениями. Примеры имен параметров: *myResourceGroup*, *myVnet* и *myVM*.

1. Отмените подготовку виртуальной машины, распределение которой вы отменили ранее с помощью команды [az vm deallocate](/cli/azure/vm). В следующем примере отменяется распределение виртуальной машины *myVM*, входящей в группу ресурсов с именем *myResourceGroup*.  
   
    ```azurecli
    az vm deallocate \
      --resource-group myResourceGroup \
      --name myVM
    ```
    
    Дождитесь, пока виртуальная машина полностью освободит память, прежде чем переходить дальше. Этот процесс может занять несколько минут.  Виртуальная машина завершает работу во время освобождения памяти.

2. Пометьте виртуальную машину как универсальную с помощью команды [az vm generalize](/cli/azure/vm). В следующем примере виртуальная машина с именем *myVM*, входящая в группу ресурсов *myResourceGroup*, помечается как универсальная.
   
    ```azurecli
    az vm generalize \
      --resource-group myResourceGroup \
      --name myVM
    ```

    Виртуальную машину, которая полностью освободила память, больше не удастся перезапустить.

3. Создайте образ из ресурса виртуальной машины с помощью команды [az image create](/cli/azure/image#az-image-create). В следующем примере создается образ с именем *myImage* в группе ресурсов с именем *myResourceGroup* на основе ресурса виртуальной машины с именем *myVM*.
   
    ```azurecli
    az image create \
      --resource-group myResourceGroup \
      --name myImage --source myVM
    ```
   
   > [!NOTE]
   > Образ создается в той же группе ресурсов, в которой находится исходная виртуальная машина. Виртуальную машину из этого образа можно создать в любой группе ресурсов в рамках вашей подписки. При управлении вам может потребоваться определенная группа ресурсов для ресурсов виртуальной машины и образов.
   >
   > Перед сохранением образа в хранилище, избыточном в пределах зоны, его необходимо создать в регионе, который поддерживает [зоны доступности](../../availability-zones/az-overview.md) и в котором включен параметр `--zone-resilient true`.
   
Эта команда возвращает JSON, описывающий образ виртуальной машины. Сохраните эти выходные данные для использования в дальнейшем.

## <a name="step-3-create-a-vm-from-the-captured-image"></a>Шаг 3. Создание виртуальной машины из записанного образа
Создайте виртуальную машину с помощью образа, который создали ранее, использовав команду [az vm create](/cli/azure/vm). В следующем примере создается виртуальная машина *myVMDeployed* из образа *myImage*.

```azurecli
az vm create \
   --resource-group myResourceGroup \
   --name myVMDeployed \
   --image myImage\
   --admin-username azureuser \
   --ssh-key-value ~/.ssh/id_rsa.pub
```

### <a name="creating-the-vm-in-another-resource-group"></a>Создание виртуальной машины в другой группе ресурсов 

Вы можете создавать виртуальные машины из образа в любой группе ресурсов в рамках своей подписки. Чтобы создать виртуальную машину в другой группе ресурсов, укажите полный идентификатор ресурса для нужного образа. Список образов можно просмотреть с помощью команды [az image list](/cli/azure/image#az-image-list). Результат будет похож на следующий пример.

```json
"id": "/subscriptions/guid/resourceGroups/MYRESOURCEGROUP/providers/Microsoft.Compute/images/myImage",
   "location": "westus",
   "name": "myImage",
```

В следующем примере используется команда [az vm create](/cli/azure/vm#az-vm-create) для создания виртуальной машины в группе ресурсов, отличной от той, в которой размещается исходный образ, путем указания идентификатора ресурса образа.

```azurecli
az vm create \
   --resource-group myOtherResourceGroup \
   --name myOtherVMDeployed \
   --image "/subscriptions/guid/resourceGroups/MYRESOURCEGROUP/providers/Microsoft.Compute/images/myImage" \
   --admin-username azureuser \
   --ssh-key-value ~/.ssh/id_rsa.pub
```


## <a name="step-4-verify-the-deployment"></a>Шаг 4. Проверка развертывания

Чтобы проверить развертывание и начать использовать новую виртуальную машину, подключитесь к ней с помощью SSH. Чтобы подключиться через SSH, найдите IP-адрес или полное доменное имя виртуальной машины с помощью команды [az vm show](/cli/azure/vm#az-vm-show).

```azurecli
az vm show \
   --resource-group myResourceGroup \
   --name myVMDeployed \
   --show-details
```

## <a name="next-steps"></a>Дальнейшие действия
Сведения о создании, хранении и совместном использовании образов в большом масштабе см. в статье [Общая коллекция образов](../shared-images-cli.md).
