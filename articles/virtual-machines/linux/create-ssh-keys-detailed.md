---
title: Подробные инструкции по созданию пары ключей SSH
description: Узнайте, как создать пару из открытого и закрытого ключей SSH для виртуальных машин Linux в Azure и как управлять этими ключами.
author: cynthn
ms.service: virtual-machines-linux
ms.topic: how-to
ms.date: 07/31/2020
ms.author: cynthn
ms.openlocfilehash: 34a84ed333172ea0931c529d2dbeee1b774ae8c5
ms.sourcegitcommit: a43a59e44c14d349d597c3d2fd2bc779989c71d7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/25/2020
ms.locfileid: "96016392"
---
# <a name="detailed-steps-create-and-manage-ssh-keys-for-authentication-to-a-linux-vm-in-azure"></a>Подробные инструкции. Создание ключей SSH для аутентификации на виртуальной машине Linux в Azure и управление этими ключами

С помощью пары ключей Secure Shell (SSH) можно создать виртуальную машину Linux, которая использует ключи SSH для проверки подлинности. В этой статье показано, как создать и использовать пару файлов открытого и закрытого ключей SSH RSA для клиентских подключений SSH.

Краткое описание команд приведено в разделе [Как создать и использовать пару из открытого и закрытого ключей SSH для виртуальных машин Linux в Azure](mac-create-ssh-keys.md).

Сведения о создании ключей SSH и их использовании для подключения к компоненту с компьютера **Windows** см. в статье [Использование ключей SSH с Windows в Azure](ssh-from-windows.md). Вы также можете использовать [портал Azure](../ssh-keys-portal.md) для создания ключей SSH и управления ими для создания виртуальных машин на портале.

[!INCLUDE [virtual-machines-common-ssh-overview](../../../includes/virtual-machines-common-ssh-overview.md)]

[!INCLUDE [virtual-machines-common-ssh-support](../../../includes/virtual-machines-common-ssh-support.md)]

## <a name="ssh-keys-use-and-benefits"></a>Использование ключей SSH и их преимущества

При создании виртуальной машины Azure с открытым ключом платформа Azure копирует его (в формате `.pub`) в папку `~/.ssh/authorized_keys` на виртуальной машине. Ключи SSH в `~/.ssh/authorized_keys` используются для запросов к клиенту, который должен подобрать соответствующий закрытый ключ при SSH-подключении. На виртуальной машине Linux в Azure, использующей ключи SSH для аутентификации, платформа Azure настраивает сервер SSHD таким образом, чтобы для входа можно было использовать только ключи SSH. Создав виртуальную машину Linux в Azure с ключами SSH, вы можете защитить развертывание виртуальной машины и сохранить на типичном этапе настройки, выполняемом после развертывания, отключение паролей в `sshd_config` файле.

Если вы не хотите использовать ключи SSH, можно настроить на виртуальной машине Linux проверку пароля. Этого достаточно для виртуальных машин без интернет-доступа. Но пользователь по-прежнему должен управлять паролями каждой своей виртуальной машины, а также обеспечивать соответствующие политики паролей и предоставлять рекомендации, к примеру, в отношении минимальной длины паролей и частоты их обновления. 

## <a name="generate-keys-with-ssh-keygen"></a>Создание ключей с помощью ssh-keygen

Для создания ключей предпочтительно использовать команду `ssh-keygen`, которая доступна в служебных программах OpenSSH в Azure Cloud Shell, на узле macOS или Linux и в Windows 10. Команд `ssh-keygen` задает несколько вопросов, а затем записывает закрытый ключ и соответствующий открытый ключ. 

Ключи SSH по умолчанию хранятся в каталоге `~/.ssh`.  Если у вас нет каталога `~/.ssh`, создайте его с правильными разрешениями с помощью команды `ssh-keygen`.

### <a name="basic-example"></a>Простой пример

Следующая `ssh-keygen` команда создает в каталоге 4096-разрядные файлы открытого и закрытого ключей SSH RSA по умолчанию `~/.ssh` . Если в текущем каталоге существует пара ключей SSH, они будут перезаписаны.

```bash
ssh-keygen -m PEM -t rsa -b 4096
```

### <a name="detailed-example"></a>Подробный пример
В следующем примере показаны дополнительные параметры команды для создания пары ключей SSH RSA. Если в текущем каталоге существует пара ключей SSH, они будут перезаписаны. 

```bash
ssh-keygen \
    -m PEM \
    -t rsa \
    -b 4096 \
    -C "azureuser@myserver" \
    -f ~/.ssh/mykeys/myprivatekey \
    -N mypassphrase
```

**Описание команды**

`ssh-keygen` — программа, с помощью которой создаются ключи.

`-m PEM` — преобразование ключа в формат PEM.

`-t rsa` — тип создаваемого ключа; в данном случае создается ключ в формате RSA.

`-b 4096` — количество битов в ключе; в данном случае ключ содержит 4096 битов.

`-C "azureuser@myserver"` — комментарий, который будет добавлен в конец файла открытого ключа для идентификации. Обычно в качестве комментария используется адрес электронной почты, но вы можете выбрать для своей инфраструктуры любой удобный метод идентификации.

`-f ~/.ssh/mykeys/myprivatekey` — имя файла закрытого ключа, если вы решили не использовать имя по умолчанию. В том же каталоге будет создан соответствующий файла открытого ключа с `.pub` в имени. Этот каталог должен существовать.

`-N mypassphrase` — дополнительная парольная фраза, используемая для доступа к файлу закрытого ключа. 

### <a name="example-of-ssh-keygen"></a>Пример с ssh-keygen

```bash
ssh-keygen -t -m PEM rsa -b 4096 -C "azureuser@myserver"
Generating public/private rsa key pair.
Enter file in which to save the key (/home/azureuser/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/azureuser/.ssh/id_rsa.
Your public key has been saved in /home/azureuser/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:vFfHHrpSGQBd/oNdvNiX0sG9Vh+wROlZBktNZw9AUjA azureuser@myserver
The key's randomart image is:
+---[RSA 4096]----+
|        .oE=*B*+ |
|          o+o.*++|
|           .oo++*|
|       .    .B+.O|
|        S   o=BO.|
|         . .o++o |
|        . ... .  |
|         ..  .   |
|           ..    |
+----[SHA256]-----+
```

#### <a name="saved-key-files"></a>Сохраненные файлы ключей

`Enter file in which to save the key (/home/azureuser/.ssh/id_rsa): ~/.ssh/id_rsa`

Имя пары ключей, используемое в этой статье. По умолчанию пара ключей называется `id_rsa`. Так как некоторые инструменты ищут закрытый ключ в файле `id_rsa`, имеет смысл создать такой файл. Пары ключей SSH и файл конфигурации SSH по умолчанию располагаются в каталоге `~/.ssh/`. Если не указать полный путь, `ssh-keygen` создаст ключи в текущем рабочем каталоге, а не в стандартном каталоге `~/.ssh`.

#### <a name="list-of-the-ssh-directory"></a>Список содержимого каталога `~/.ssh`

```bash
ls -al ~/.ssh
-rw------- 1 azureuser staff  1675 Aug 25 18:04 id_rsa
-rw-r--r-- 1 azureuser staff   410 Aug 25 18:04 id_rsa.pub
```

#### <a name="key-passphrase"></a>Парольная фраза ключа

`Enter passphrase (empty for no passphrase):`

Мы *настоятельно* рекомендуем добавить парольную фразу в закрытый ключ. Если не защитить файл ключа парольной фразой, любой пользователь, у которого есть этот файл, сможет использовать его, чтобы войти на любой из серверов, на котором используется соответствующий открытый ключ. Добавив парольную фразу, вы усилите защиту на случай, если другой пользователь получит доступ к файлу закрытого ключа. Это даст вам время, чтобы изменить ключи.

## <a name="generate-keys-automatically-during-deployment"></a>Автоматическое создание ключей во время развертывания

При использовании [Azure CLI](/cli/azure) для создания виртуальных машин можно дополнительно создать файлы открытого и закрытого ключей SSH, выполнив команду [az vm create](/cli/azure/vm) с параметром `--generate-ssh-keys`. Эти ключи хранятся в каталоге ~/.ssh. Обратите внимание на то, что этот параметр команды не перезаписывает ключи, если они уже существуют в данном расположении.

## <a name="provide-ssh-public-key-when-deploying-a-vm"></a>Предоставление открытого ключа SSH при развертывании виртуальной машины

Чтобы создать виртуальную машину Linux, которая использует ключи SSH для аутентификации, укажите свой открытый ключ SSH при создании виртуальной машины с помощью портала Azure, интерфейса командной строки, шаблонов Resource Manager или других методов. При использовании портала вводится значение открытого ключа. При использовании [Azure CLI](/cli/azure) создания виртуальной машины с использованием существующего открытого ключа укажите значение или расположение этого ключа, выполнив команду [az vm create](/cli/azure/vm) с параметром `--ssh-key-value`. 

Если вам не знаком формат открытого ключа SSH, чтобы просмотреть его, выполните команду `cat`, заменив параметр `~/.ssh/id_rsa.pub` расположением файла собственного открытого ключа.

```bash
cat ~/.ssh/id_rsa.pub
```

Выходные данные должны быть следующего вида (здесь показана исправленная версия).

```
ssh-rsa XXXXXXXXXXc2EAAAADAXABAAABAXC5Am7+fGZ+5zXBGgXS6GUvmsXCLGc7tX7/rViXk3+eShZzaXnt75gUmT1I2f75zFn2hlAIDGKWf4g12KWcZxy81TniUOTjUsVlwPymXUXxESL/UfJKfbdstBhTOdy5EG9rYWA0K43SJmwPhH28BpoLfXXXXXG+/ilsXXXXXKgRLiJ2W19MzXHp8z3Lxw7r9wx3HaVlP4XiFv9U4hGcp8RMI1MP1nNesFlOBpG4pV2bJRBTXNXeY4l6F8WZ3C4kuf8XxOo08mXaTpvZ3T1841altmNTZCcPkXuMrBjYSJbA8npoXAXNwiivyoe3X2KMXXXXXdXXXXXXXXXXCXXXXX/ azureuser@myserver
```

Если вы копируете содержимое файла открытого ключа и вставляете его на портале Azure или в шаблон Resource Manager, в этом содержимом не должно быть дополнительных пробелов или символов разрыва строки. Например, при использовании macOS, чтобы скопировать содержимое файла открытого ключа (по умолчанию это `~/.ssh/id_rsa.pub`), вы можете передать его в **pbcopy** (или другие аналогичные программы Linux, например `xclip`).

Если вы предпочитаете использовать открытый ключ в многострочном формате, можно создать ключ в формате RFC4716 в контейнере pem открытого ключа, созданного ранее.

Чтобы создать ключ в формате RFC4716 из существующего открытого ключа SSH, выполните следующую команду:

```bash
ssh-keygen \
-f ~/.ssh/id_rsa.pub \
-e \
-m RFC4716 > ~/.ssh/id_ssh2.pem
```

## <a name="ssh-to-your-vm-with-an-ssh-client"></a>Установление SSH-подключения к виртуальной машине с помощью клиента SSH
С помощью открытого ключа, развернутого на виртуальной машине Azure, и закрытого ключа в локальной системе установите SSH-подключение к виртуальной машине, используя ее IP-адрес или DNS-имя. Замените *azureuser* и *myvm.westus.cloudapp.azure.com* в приведенной команде, указав имя пользователя администратора и полное доменное имя (или IP-адрес).

```bash
ssh azureuser@myvm.westus.cloudapp.azure.com
```

Если при создании пары ключей вы указали парольную фразу, введите ее при появлении запроса во время входа в систему. (Сервер добавляется в папку `~/.ssh/known_hosts`. Если не изменять открытый ключ на виртуальной машине Azure или не удалять имя сервера из файла `~/.ssh/known_hosts`, запрос на подключение повторно не отображается.)

Если виртуальная машина использует политику доступа JIT, запросите доступ, прежде чем подключиться к виртуальной машине. Дополнительные сведения о политике JIT см. в статье [Управление доступом к виртуальным машинам с помощью JIT-доступа](../../security-center/security-center-just-in-time.md).

## <a name="use-ssh-agent-to-store-your-private-key-passphrase"></a>Использование ssh-agent для хранения парольной фразы закрытого ключа

Чтобы не вводить парольную фразу файла закрытого ключа при каждом входе с использованием SSH, вы можете сохранить ее в кэш с помощью команды `ssh-agent`. Если вы используете компьютер Mac, при вызове `ssh-agent` парольная фраза закрытого ключа будет надежно сохранена в цепочке ключей macOS.

С помощью `ssh-agent` и `ssh-add` сообщите системе SSH о файлах ключей, чтобы вам не нужно было использовать парольную фразу в интерактивном режиме.

```bash
eval "$(ssh-agent -s)"
```

Затем добавьте закрытый ключ к `ssh-agent` с помощью команды `ssh-add`.

```bash
ssh-add ~/.ssh/id_rsa
```

Теперь парольная фраза закрытого ключа хранится в `ssh-agent`.

## <a name="use-ssh-copy-id-to-copy-the-key-to-an-existing-vm"></a>Копирование ключа на имеющуюся виртуальную машину с помощью ssh-copy-id

Если виртуальная машина уже создана, можно добавить новый открытый ключ SSH на виртуальную машину Linux с помощью `ssh-copy-id` .

```bash
ssh-copy-id -i ~/.ssh/id_rsa.pub azureuser@myserver
```

## <a name="create-and-configure-an-ssh-config-file"></a>Создание и настройка файла конфигурации SSH

Чтобы ускорить процесс входа и оптимизировать поведение клиента SSH, можно создать и настроить файл конфигурации SSH `~/.ssh/config`. 

В следующем примере показана простая конфигурация, которую можно использовать для быстрого входа на определенную виртуальную машину в качестве пользователя с помощью закрытого ключа SSH по умолчанию. 

Создайте файл.

```bash
touch ~/.ssh/config
```

Изменение файла для добавления новой конфигурации SSH

```bash
vim ~/.ssh/config
```

Добавьте параметры конфигурации для виртуальной машины узла. В этом примере имя виртуальной машины — *myvm* , а имя учетной записи — *azureuser*.

```bash
# Azure Keys
Host myvm
  Hostname 102.160.203.241
  User azureuser
# ./Azure Keys
```

Можно добавить конфигурации для дополнительных узлов, чтобы каждый из них мог использовать собственную пару ключей. Дополнительные параметры конфигурации приведены в описании [файла конфигурации SSH](https://www.ssh.com/ssh/config/).

Теперь, когда у вас есть пара ключей SSH и настроенный файл конфигурации SSH, вы можете быстро и безопасно входить на виртуальную машину Linux. При выполнении следующей команды служба SSH находит и загружает все параметры из блока `Host myvm` в файле конфигурации SSH.

```bash
ssh myvm
```

При первом входе на сервер с использованием ключа SSH команда запрашивает парольную фразу для этого файла ключа.

## <a name="next-steps"></a>Дальнейшие действия

Следующий шаг — создание виртуальных машин Linux Azure с помощью нового открытого ключа SSH. Виртуальные машины Azure, созданные с использованием открытого ключа SSH в качестве данных для входа, защищены лучше, чем виртуальные машины, созданные с помощью метода по умолчанию, предусматривающего использование паролей.

* [Создание виртуальной машины Linux с помощью портала Azure](quick-create-portal.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)
* [Создание виртуальной машины Linux с помощью Azure CLI](quick-create-cli.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)
* [Создание виртуальной машины Linux с помощью шаблона Azure](create-ssh-secured-vm-from-template.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)
