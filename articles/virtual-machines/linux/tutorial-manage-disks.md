---
title: Руководство по управлению дисками Azure с помощью Azure CLI.
description: В этом руководстве описано, как с помощью Azure CLI создать и администрировать диски Azure для виртуальных машин
author: cynthn
ms.service: virtual-machines-linux
ms.topic: tutorial
ms.workload: infrastructure
ms.date: 08/20/2020
ms.author: cynthn
ms.custom: mvc, devx-track-azurecli
ms.subservice: disks
ms.openlocfilehash: 948a4ae8c329d69e404ef8d0f609748b955b0ecc
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "89078855"
---
# <a name="tutorial---manage-azure-disks-with-the-azure-cli"></a>Руководство по управлению дисками Azure с помощью Azure CLI.

Виртуальные машины (ВМ) Azure хранят операционную систему, приложения и данные на дисках. При создании виртуальной машины важно выбрать размер диска и конфигурацию в соответствии с ожидаемой рабочей нагрузкой. В этом руководстве показано, как развернуть диски виртуальной машины и управлять ими. Здесь содержатся сведения о:

> [!div class="checklist"]
> * дисках ОС и временных дисках;
> * Диски данных
> * дисками уровня "Стандартный" и "Премиум";
> * производительностью дисков;
> * присоединением и подготовкой дисков данных;
> * моментальными снимками дисков.


## <a name="default-azure-disks"></a>Диски Azure по умолчанию

При создании виртуальной машины Azure к ней автоматически подключаются два диска.

**Диск операционной системы**. Размер дисков операционной системы может составлять до 2 ТБ. Это диски, содержащие операционную систему ВМ. По умолчанию диск ОС помечается как */dev/sda*. Конфигурация кэширования диска ОС оптимизирована для производительности операционной системы. Ввиду этой конфигурации диски ОС **не должны** использоваться для хранения приложений или данных. Для приложений и данных используйте диски данных, которые описаны далее в этом руководстве.

**Временный диск**. Временные диски используют твердотельные накопители, расположенные на том же узле Azure, что и виртуальная машина. Временные диски обладают высокой производительностью и могут быть использованы для таких операций, как обработка временных данных. Тем не менее, если виртуальная машина перемещается на новый узел, удаляются все данные, хранящиеся на временном диске. Размер временного диска определяется размером виртуальной машины. Временные диски помечаются как */dev/sdb* и используют точку подключения */mnt*.

## <a name="azure-data-disks"></a>Диски данных Azure

Чтобы установить приложения и хранить данные, можно добавить дополнительные диски данных. Диски данных следует использовать в любой ситуации, где требуется надежное хранилище данных, обеспечивающее высокую скорость реагирования. Размер виртуальной машины определяет, сколько дисков данных можно к ней подключить.

## <a name="vm-disk-types"></a>Типы дисков виртуальной машины

В Azure предоставляются диски двух типов.

**Диски ценовой категории "Стандартный"** . Это жесткие диски, которые обеспечивают экономичность хранения данных и достаточную производительность. Эти диски идеально подходят для экономных рабочих нагрузок разработки и тестирования.

**Диски ценовой категории "Премиум".** Это высокопроизводительные твердотельные накопители с низкой задержкой. Они идеально подходят для виртуальных машин, выполняющих производственную рабочую нагрузку. Размеры виртуальных машин с литерой **S** в [названии](../vm-naming-conventions.md) обычно поддерживают хранилище класса Premium. Например, виртуальные машины Azure серий DS, DSv2, GS и FS его поддерживают. При выборе размер диска округляется в большую сторону до следующего типа. Например, если размер диска превышает 64 ГБ, но меньше 128 ГБ, то он имеет тип P10. 

<br>


[!INCLUDE [disk-storage-premium-ssd-sizes](../../../includes/disk-storage-premium-ssd-sizes.md)]

При подготовке диска хранилища класса Premium, в отличие от хранилища класса Standard, гарантируются определенные показатели емкости, числа операций ввода-вывода в секунду и пропускной способности. Например, при создании диска P50 Azure подготавливает для него 4095 ГБ емкости хранилища, а также пропускную способность 250 МБ в секунду и 7500 операций ввода-вывода в секунду. Приложение может использовать ресурсы емкости и производительности как полностью, так и частично. Диски SSD (цен. категория "Премиум") демонстрируют задержку, выражаемую в миллисекундах одной цифрой, и гарантируют выполнение операций ввода-вывода и пропускную способность в течение 99,9 % рабочего времени, как описано в предыдущей таблице.

Хотя в таблице выше указано максимальное число операций ввода-вывода в секунду на диск, можно обеспечить более высокий уровень производительности, применив чередование нескольких дисков данных. Например, к виртуальной машине Standard_GS5 можно подключить 64 диска данных. Если каждый из этих дисков относится к размеру P30, можно добиться производительности, достигающей 80 000 операций ввода-вывода в секунду. Дополнительные сведения о максимальных количествах операций ввода-вывода в секунду для виртуальных машин см. в статье [Размеры виртуальных машин Windows в Azure](../sizes.md).

## <a name="launch-azure-cloud-shell"></a>Запуск Azure Cloud Shell

Azure Cloud Shell — это бесплатная интерактивная оболочка, с помощью которой можно выполнять действия, описанные в этой статье. Она включает предварительно установленные общие инструменты Azure и настроена для использования с вашей учетной записью.

Чтобы открыть Cloud Shell, выберите **Попробовать** в правом верхнем углу блока кода. Cloud Shell можно также запустить в отдельной вкладке браузера, перейдя на страницу [https://shell.azure.com/powershell](https://shell.azure.com/bash). Нажмите кнопку **Копировать**, чтобы скопировать блоки кода. Вставьте код в Cloud Shell и нажмите клавишу "ВВОД", чтобы выполнить его.

## <a name="create-and-attach-disks"></a>Создание и подключение дисков

Диски данных можно создать и подключить к существующей виртуальной машины или же сделать это во время создания виртуальной машины.

### <a name="attach-disk-at-vm-creation"></a>Подключение диска при создании виртуальной машины

Создайте группу ресурсов с помощью команды [az group create](/cli/azure/group#az-group-create).

```azurecli-interactive
az group create --name myResourceGroupDisk --location eastus
```

Создайте виртуальную машину с помощью команды [az vm create](/cli/azure/vm#az-vm-create). В следующем примере создаются виртуальная машина с именем *myVM*, добавляется учетная запись пользователя с именем *azureuser* и создаются ключи SSH, если они еще не существуют. Аргумент `--datadisk-sizes-gb` указывает, что должен быть создан дополнительный диск, подключаемый к виртуальной машине. Чтобы создать и подключить несколько дисков, используйте список значений размеров дисков, разделенный пробелами. В следующем примере создается виртуальная машина с двумя дисками емкостью по 128 ГБ. Так как размеры дисков составляют 128 ГБ, они настроены как диски типа P10, которые обеспечивают до 500 операций ввода-вывода на диск.

```azurecli-interactive
az vm create \
  --resource-group myResourceGroupDisk \
  --name myVM \
  --image UbuntuLTS \
  --size Standard_DS2_v2 \
  --generate-ssh-keys \
  --data-disk-sizes-gb 128 128
```

### <a name="attach-disk-to-existing-vm"></a>Подключение диска к существующей виртуальной машине

Чтобы создать диск и подключить его к существующей виртуальной машине, выполните команду [az vm disk attach](/cli/azure/vm/disk#az-vm-disk-attach). Приведенный ниже пример создает диск уровня "Премиум" размера в 128 ГБ и подключает его к виртуальной машине, созданной на предыдущем шаге.

```azurecli-interactive
az vm disk attach \
    --resource-group myResourceGroupDisk \
    --vm-name myVM \
    --name myDataDisk \
    --size-gb 128 \
    --sku Premium_LRS \
    --new
```

## <a name="prepare-data-disks"></a>Подготовка дисков данных

После подключения диска к виртуальной машине необходимо настроить операционную систему для его использования. В примере ниже показано, как настроить диск вручную. Этот процесс можно автоматизировать с помощью cloud-init, как описывается в [этом руководстве](./tutorial-automate-vm-deployment.md).


Создайте SSH-подключение к виртуальной машине. Замените IP-адреса в примере общедоступным IP-адресом виртуальной машины.

```console
ssh 10.101.10.10
```

Создание разделы на диске с помощью `parted`.

```bash
sudo parted /dev/sdc --script mklabel gpt mkpart xfspart xfs 0% 100%
```

Запишите файловую систему на раздел, выполнив команду `mkfs`. Используйте `partprobe`, чтобы предоставить ОС сведения об изменении.

```bash
sudo mkfs.xfs /dev/sdc1
sudo partprobe /dev/sdc1
```

Подключите новый диск, чтобы он был доступен в операционной системе.

```bash
sudo mkdir /datadrive && sudo mount /dev/sdc1 /datadrive
```

Теперь этот диск доступен через точку подключения `/datadrive`, которую можно проверить с помощью команды `df -h`.

```bash
df -h | grep -i "sd"
```

Ее результат показывает, что новый диск подключен к `/datadrive`.

```bash
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1        29G  2.0G   27G   7% /
/dev/sda15      105M  3.6M  101M   4% /boot/efi
/dev/sdb1        14G   41M   13G   1% /mnt
/dev/sdc1        50G   52M   47G   1% /datadrive
```

Чтобы обеспечить повторное подключение диска после перезагрузки, его необходимо добавить в файл */etc/fstab*. Для этого получите UUID диска с помощью служебной программы `blkid`.

```bash
sudo -i blkid
```

На экране отображается UUID диска, в данном случае это `/dev/sdc1`.

```bash
/dev/sdc1: UUID="33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e" TYPE="xfs"
```

> [!NOTE]
> Некорректное изменение файла **/etc/fstab** может привести к невозможности загрузить систему. Если у вас есть сомнения, см. инструкции по правильному изменению этого файла в документации дистрибутива. Также рекомендуется перед внесением изменений создать резервную копию файла /etc/fstab.

Откройте файл `/etc/fstab` в текстовом редакторе, как показано ниже:

```bash
sudo nano /etc/fstab
```

Добавьте в файл */etc/fstab* строку следующего вида, заменив значение UUID собственным.

```bash
UUID=33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e   /datadrive  xfs    defaults,nofail   1  2
```

Выполнив редактирование файла, запишите его с помощью сочетания клавиш `Ctrl+O`, а затем щелкните `Ctrl+X`, чтобы выйти из редактора.

Теперь, когда диск настроен, закройте сеанс SSH.

```bash
exit
```

## <a name="take-a-disk-snapshot"></a>Создание моментального снимка диска

При создании моментального снимка диска Azure создает копию диска на определенный момент времени, предназначенную только для чтения. Моментальные снимки виртуальной машины Azure можно использовать для быстрого сохранения ее состояния перед изменением конфигурации. В случае возникновения проблем или ошибок виртуальную машину можно восстановить с помощью моментального снимка. Если виртуальная машина содержит более одного диска, создается отдельный моментальный снимок каждого диска. Для создания резервных копий с сохранением целостности приложений рекомендуем остановить виртуальную машину перед созданием моментальных снимков дисков. В качестве альтернативы можно использовать [службу архивации Azure](../../backup/index.yml), которая обеспечивает автоматическую архивацию при запущенной виртуальной машине.

### <a name="create-snapshot"></a>Create snapshot

Перед созданием моментального снимка потребуется идентификатор или имя диска. Используйте команду [az vm show](/cli/azure/vm#az-vm-show), чтобы получить идентификатор диска. В этом примере идентификатор диска сохраняется в переменной и может использоваться в дальнейшем.

```azurecli-interactive
osdiskid=$(az vm show \
   -g myResourceGroupDisk \
   -n myVM \
   --query "storageProfile.osDisk.managedDisk.id" \
   -o tsv)
```

Получив идентификатор, создайте моментальный снимок диска с помощью команды [az snapshot create](/cli/azure/snapshot#az-snapshot-create).

```azurecli-interactive
az snapshot create \
    --resource-group myResourceGroupDisk \
    --source "$osdiskid" \
    --name osDisk-backup
```

### <a name="create-disk-from-snapshot"></a>Создание диска на основе моментального снимка

Этот моментальный снимок можно преобразовать в диск (используя команду [az disk create](/cli/azure/disk#az-disk-create)), с помощью которого можно повторно создать виртуальную машину.

```azurecli-interactive
az disk create \
   --resource-group myResourceGroupDisk \
   --name mySnapshotDisk \
   --source osDisk-backup
```

### <a name="restore-virtual-machine-from-snapshot"></a>Восстановление виртуальной машины на основе моментального снимка

Чтобы продемонстрировать восстановление виртуальной машины, удалите имеющуюся виртуальную машину с помощью команды [az vm delete](/cli/azure/vm#az-vm-delete).

```azurecli-interactive
az vm delete \
--resource-group myResourceGroupDisk \
--name myVM
```

Создайте виртуальную машину на основе диска моментального снимка.

```azurecli-interactive
az vm create \
    --resource-group myResourceGroupDisk \
    --name myVM \
    --attach-os-disk mySnapshotDisk \
    --os-type linux
```

### <a name="reattach-data-disk"></a>Повторное подключение диска данных

Все диски данных нужно повторно подключить к виртуальной машине.

Найдите имя диска данных, выполнив команду [az disk list](/cli/azure/disk#az-disk-list). В этом примере имя диска помещается в переменную `datadisk`, которая будет использоваться в следующем шаге.

```azurecli-interactive
datadisk=$(az disk list \
   -g myResourceGroupDisk \
   --query "[?contains(name,'myVM')].[id]" \
   -o tsv)
```

Подключите диск, выполнив команду [az vm disk attach](/cli/azure/vm/disk#az-vm-disk-attach).

```azurecli-interactive
az vm disk attach \
   –g myResourceGroupDisk \
   --vm-name myVM \
   --name $datadisk
```

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы ознакомились с дисками виртуальных машин, а именно с:

> [!div class="checklist"]
> * дисках ОС и временных дисках;
> * Диски данных
> * дисками уровня "Стандартный" и "Премиум";
> * производительностью дисков;
> * присоединением и подготовкой дисков данных;
> * моментальными снимками дисков.

Перейдите к следующему руководству, чтобы узнать об автоматической настройке виртуальных машин.

> [!div class="nextstepaction"]
> [Автоматизация настройки виртуальной машины](./tutorial-automate-vm-deployment.md)
