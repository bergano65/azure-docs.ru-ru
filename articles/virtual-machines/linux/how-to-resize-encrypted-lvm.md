---
title: Изменение размера зашифрованных дисков управления логическими томами с помощью шифрования дисков Azure
description: В этой статье приводятся инструкции по изменению размера зашифрованных дисков ADE с помощью управления логическими томами.
author: jofrance
ms.service: security
ms.topic: article
ms.author: jofrance
ms.date: 09/21/2020
ms.openlocfilehash: 3a3e9b7406e11261aff12d77d9fbeed5debbe938
ms.sourcegitcommit: a07a01afc9bffa0582519b57aa4967d27adcf91a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/05/2020
ms.locfileid: "91744276"
---
# <a name="how-to-resize-logical-volume-management-devices-that-use-azure-disk-encryption"></a>Изменение размера устройств управления логическими томами, использующих шифрование дисков Azure

В этой статье вы узнаете, как изменить размер дисков данных, использующих шифрование дисков Azure. Чтобы изменить размер дисков, вы будете использовать управление логическим томом (LVM) в Linux. Действия применяются к нескольким сценариям.

Этот процесс изменения размера можно использовать в следующих средах:

- Дистрибутивы Linux:
    - Red Hat Enterprise Linux (RHEL) 7 или более поздней версии
    - Ubuntu 16 или более поздняя версия
    - SUSE 12 или более поздняя версия
- Версии шифрования дисков Azure: 
    - Расширение с одним проходом
    - Расширение с двойным проходом

## <a name="prerequisites"></a>Предварительные требования

В этой статье предполагается, что вы:

- Существующая конфигурация LVM. Дополнительные сведения см. [в статье Настройка LVM на виртуальной машине Linux](configure-lvm.md).

- Диски, которые уже зашифрованы с помощью шифрования дисков Azure. Дополнительные сведения см. [в статье configure LVM and RAID On encrypted Devices](how-to-configure-lvm-raid-on-crypt.md).

- Опыт работы с Linux и LVM.

- Возможности использования */dev/disk/SCSI1/* путей для дисков данных в Azure. Дополнительные сведения см. в статье [Устранение неполадок с именами устройств виртуальных машин Linux](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/troubleshoot-device-names-problems). 

## <a name="scenarios"></a>Сценарии

Процедуры, описанные в этой статье, относятся к следующим сценариям.

- Традиционные конфигурации LVM и LVM
- Традиционное шифрование LVM 
- LVM-on-шифрования 

### <a name="traditional-lvm-and-lvm-on-crypt-configurations"></a>Традиционные конфигурации LVM и LVM

Традиционные конфигурации LVM и LVM — это расширение логического тома (LV), если группа томов (VG) имеет доступное пространство.

### <a name="traditional-lvm-encryption"></a>Традиционное шифрование LVM 

В традиционном шифровании LVM LVs шифруются. Весь диск не шифруется.

С помощью традиционного шифрования LVM можно:

- Расширение LV при добавлении нового физического тома (ПС).
- Расширение LV при изменении размера существующего PV.

### <a name="lvm-on-crypt"></a>LVM-on-шифрования 

Рекомендуемый способ шифрования дисков — LVM-on-Encrypt. Этот метод шифрует весь диск, а не только LV.

С помощью LVM-on-шифрования можно: 

- Расширение LV при добавлении новой ПС.
- Расширение LV при изменении размера существующего PV.

> [!NOTE]
> Мы не рекомендуем смешивать традиционные LVM-шифрование и LVM на одной виртуальной машине.

В следующих разделах приведены примеры использования LVM и LVM-on-шифрования. В примерах используются существующие значения для дисков, постоянного хранилища версий, VGs, LVs, файловых систем, универсальные уникальные идентификаторы (UUID) и точки подключения. Замените эти значения собственными значениями в соответствии с вашей средой.

#### <a name="extend-an-lv-when-the-vg-has-available-space"></a>Расширение LV, если VG имеет доступное пространство

Традиционным способом изменения размера LVs является расширение LV, если VG имеет доступное пространство. Этот метод можно использовать для незашифрованных дисков, традиционных защищенных LVM томов и конфигураций LVM-on-encrypted.

1. Проверьте текущий размер файловой системы, которую необходимо увеличить:

    ``` bash
    df -h /mountpoint
    ```

    ![Снимок экрана, показывающий код, который проверяет размер файловой системы. Команда и результат выделяются.](./media/disk-encryption/resize-lvm/001-resize-lvm-scenarioa-check-fs.png)

2. Убедитесь, что в VG достаточно места для увеличения LV:

    ``` bash
    vgs
    ```

    ![Снимок экрана, показывающий код, который проверяет место на VG. Команда и результат выделяются.](./media/disk-encryption/resize-lvm/002-resize-lvm-scenarioa-check-vgs.png)

    Также можно использовать `vgdisplay` :

    ``` bash
    vgdisplay vgname
    ```

    ![Снимок экрана с отображаемым кодом V G, который проверяет место на VG. Команда и результат выделяются.](./media/disk-encryption/resize-lvm/002-resize-lvm-scenarioa-check-vgdisplay.png)

3. Определяет, в какой из них необходимо изменить размер:

    ``` bash
    lsblk
    ```

    ![Снимок экрана, показывающий результат команды l s b l k. Команда и результат выделяются.](./media/disk-encryption/resize-lvm/002-resize-lvm-scenarioa-check-lsblk1.png)

    Для LVM-on-encrypted это различие заключается в том, что этот вывод показывает, что зашифрованный слой находится на уровне диска.

    ![Снимок экрана, показывающий результат команды l s b l k. Выходные данные выделены. Он показывает зашифрованный слой.](./media/disk-encryption/resize-lvm/002-resize-lvm-scenarioa-check-lsblk2.png)

4. Проверьте размер LV:

    ``` bash
    lvdisplay lvname
    ```

    ![Снимок экрана, показывающий код, который проверяет размер логического тома. Команда и результат выделяются.](./media/disk-encryption/resize-lvm/002-resize-lvm-scenarioa-check-lvdisplay01.png)

5. Увеличьте размер в формате LV, используя `-r` для изменения размера файловой системы в Интернете:

    ``` bash
    lvextend -r -L +2G /dev/vgname/lvname
    ```

    ![Снимок экрана, показывающий код, увеличивающий размер логического тома. Команда и результаты выделяются.](./media/disk-encryption/resize-lvm/003-resize-lvm-scenarioa-resize-lv.png)

6. Проверьте новые размеры для LV и файловой системы:

    ``` bash
    df -h /mountpoint
    ```

    ![Снимок экрана, показывающий код, проверяющий размер LV и файловую систему. Команда и результат выделяются.](./media/disk-encryption/resize-lvm/004-resize-lvm-scenarioa-check-fs.png)

    Выходные данные размера обозначают успешное изменение размера файла LV и файловой системы.

Вы можете снова проверить сведения о LV, чтобы подтвердить изменения на уровне LV:

``` bash
lvdisplay lvname
```

![Снимок экрана, показывающий код, который подтверждает новые размеры. Размеры выделены.](./media/disk-encryption/resize-lvm/004-resize-lvm-scenarioa-check-lvdisplay2.png)

#### <a name="extend-a-traditional-lvm-volume-by-adding-a-new-pv"></a>Расширьте традиционный том LVM, добавив новый ПС

Если необходимо добавить новый диск для увеличения размера VG, расширьте традиционный том LVM, добавив новый ПС.

1. Проверьте текущий размер файловой системы, которую необходимо увеличить:

    ``` bash
    df -h /mountpoint
    ```

    ![Снимок экрана, показывающий код, который проверяет текущий размер файловой системы. Команда и результат выделяются.](./media/disk-encryption/resize-lvm/005-resize-lvm-scenariob-check-fs.png)

2. Проверьте текущую конфигурацию PV:

    ``` bash
    pvs
    ```

    ![Снимок экрана, показывающий код, который проверяет текущую конфигурацию PV. Команда и результат выделяются.](./media/disk-encryption/resize-lvm/006-resize-lvm-scenariob-check-pvs.png)

3. Проверьте текущие сведения о VG:

    ``` bash
    vgs
    ```

    ![Снимок экрана, показывающий код, который проверяет сведения о текущей группе томов. Команда и результат выделяются.](./media/disk-encryption/resize-lvm/007-resize-lvm-scenariob-check-vgs.png)

4. Проверьте текущий список дисков. Выявление дисков данных путем проверки устройств в */dev/disk/Azure/SCSI1/*.

    ``` bash
    ls -l /dev/disk/azure/scsi1/
    ```

    ![Снимок экрана, показывающий код, который проверяет текущий список дисков. Команда и результаты выделяются.](./media/disk-encryption/resize-lvm/008-resize-lvm-scenariob-check-scs1.png)

5. Проверьте выходные данные `lsblk` : 

    ``` bash
    lsbk
    ```

    ![Снимок экрана, показывающий код, который проверяет выходные данные l s b l k. Команда и результаты выделяются.](./media/disk-encryption/resize-lvm/008-resize-lvm-scenariob-check-lsblk.png)

6. Подключите новый диск к виртуальной машине, следуя инструкциям в разделе [Подключение диска данных к виртуальной машине Linux](attach-disk-portal.md).

7. Проверьте список дисков и обратите внимание на новый диск.

    ``` bash
    ls -l /dev/disk/azure/scsi1/
    ```

    ![Снимок экрана, показывающий код, который проверяет список дисков. Результаты выделяются.](./media/disk-encryption/resize-lvm/009-resize-lvm-scenariob-check-scsi12.png)

    ``` bash
    lsbk
    ```

    ![Снимок экрана, показывающий код, который проверяет список дисков с помощью l s b l k. Команда и результат выделяются.](./media/disk-encryption/resize-lvm/009-resize-lvm-scenariob-check-lsblk1.png)

8. Создайте новый параметр ПС поверх нового диска данных:

    ``` bash
    pvcreate /dev/newdisk
    ```

    ![Снимок экрана, показывающий код, создающий новый ПС. Результат выделен.](./media/disk-encryption/resize-lvm/010-resize-lvm-scenariob-pvcreate.png)

    Этот метод использует весь диск как ПС без секции. Кроме того, можно использовать `fdisk` для создания секции, а затем использовать эту секцию для `pvcreate` .

9. Убедитесь, что НЗ был добавлен в список PV:

    ``` bash
    pvs
    ```

    ![Снимок экрана с кодом, отображающим список физических томов. Результат выделен.](./media/disk-encryption/resize-lvm/011-resize-lvm-scenariob-check-pvs1.png)

10. Расширьте VG, добавив в него новую ПС:

    ``` bash
    vgextend vgname /dev/newdisk
    ```

    ![Снимок экрана, показывающий код, расширяющий группу томов. Результат выделен.](./media/disk-encryption/resize-lvm/012-resize-lvm-scenariob-vgextend.png)

11. Проверьте новый размер VG:

    ``` bash
    vgs
    ```

    ![Снимок экрана, показывающий код, который проверяет размер группы томов. Результаты выделяются.](./media/disk-encryption/resize-lvm/013-resize-lvm-scenariob-check-vgs1.png)

12. Используйте `lsblk` , чтобы указать значение lv, для которого необходимо изменить размер:

    ``` bash
    lsblk
    ```

    ![Снимок экрана, показывающий код, определяющий локальный том, для которого необходимо изменить размер. Результаты выделяются.](./media/disk-encryption/resize-lvm/013-resize-lvm-scenariob-check-lsblk1.png)

13. Расширьте размер LV, используя `-r` для увеличения файловой системы в Интернете:

    ``` bash
    lvextend -r -L +2G /dev/vgname/lvname
    ```

    ![Снимок экрана, показывающий код, увеличивающий размер файловой системы в сети. Результаты выделяются.](./media/disk-encryption/resize-lvm/013-resize-lvm-scenariob-lvextend.png) 

14. Проверьте новые размеры для LV и файловой системы:

    ``` bash
    df -h /mountpoint
    ```

    ![Снимок экрана, показывающий код, который проверяет размеры локального тома и файловой системы. Команда и результат выделяются.](./media/disk-encryption/resize-lvm/014-resize-lvm-scenariob-check-fs1.png)

    >[!IMPORTANT]
    >Когда шифрование данных Azure используется в традиционных конфигурациях LVM, зашифрованный слой создается на уровне LV, а не на уровне диска.
    >
    >На этом этапе зашифрованный слой расширяется до нового диска. Фактический диск данных не имеет параметров шифрования на уровне платформы, поэтому состояние шифрования не обновляется.
    >
    >Ниже приведены некоторые причины, по которым LVM-on-шифрования является рекомендуемым подходом. 

15. Проверьте сведения о шифровании на портале:

    ![Снимок экрана, показывающий сведения о шифровании на портале. Имя диска и шифрование выделены.](./media/disk-encryption/resize-lvm/014-resize-lvm-scenariob-check-portal1.png)

    Чтобы обновить параметры шифрования на диске, добавьте новый объект LV и включите расширение на виртуальной машине.
    
16. Добавьте новый объект LV, создайте на нем файловую систему и добавьте его в `/etc/fstab` .

17. Снова задайте расширение шифрования. На этот раз вы пометите параметры шифрования на новом диске данных на уровне платформы. Вот пример интерфейса командной строки:

    ``` bash
    az vm encryption enable -g ${RGNAME} --name ${VMNAME} --disk-encryption-keyvault "<your-unique-keyvault-name>"
    ```

18. Проверьте сведения о шифровании на портале:

    ![Снимок экрана, показывающий сведения о шифровании на портале. Имя диска и сведения о шифровании выделены.](./media/disk-encryption/resize-lvm/014-resize-lvm-scenariob-check-portal2.png)

После обновления параметров шифрования можно удалить новый объект LV. Также удалите запись из `/etc/fstab` `/etc/crypttab` созданного и.

![Снимок экрана, показывающий код, который удаляет новый логический том. Вкладка Удаленные на языке F S и вкладка шифрования выделены.](./media/disk-encryption/resize-lvm/014-resize-lvm-scenariob-delete-fstab-crypttab.png)

Чтобы завершить очистку, выполните следующие действия.

1. Отключите LV:

    ``` bash
    umount /mountpoint
    ```

1. Закройте зашифрованный слой тома:

    ``` bash
    cryptsetup luksClose /dev/vgname/lvname
    ```

1. Удалите LV:

    ``` bash
    lvremove /dev/vgname/lvname
    ```

#### <a name="extend-a-traditional-lvm-volume-by-resizing-an-existing-pv"></a>Расширьте традиционный том LVM, изменив размер существующего PV

Обмен мгновенными сообщениями. в некоторых сценариях ограничения могут потребовать изменения размера существующего диска. Вот как это сделать.

1. Найдите зашифрованные диски:

    ``` bash
    ls -l /dev/disk/azure/scsi1/
    ```

    ![Снимок экрана, показывающий код, идентифицирующий зашифрованные диски. Результаты выделяются.](./media/disk-encryption/resize-lvm/015-resize-lvm-scenarioc-check-scsi1.png)

    ``` bash
    lsblk -fs
    ```

    ![Снимок экрана, показывающий альтернативный код, идентифицирующий зашифрованные диски. Результаты выделяются.](./media/disk-encryption/resize-lvm/015-resize-lvm-scenarioc-check-lsblk.png)

2. Проверьте сведения о PV:

    ``` bash
    pvs
    ```

    ![Снимок экрана, показывающий код, который проверяет сведения о физическом томе. Результаты выделяются.](./media/disk-encryption/resize-lvm/016-resize-lvm-scenarioc-check-pvs.png)

    Результаты на изображении показывают, что все пространство на всех постоянного хранилища версий в настоящее время используется.

3. Проверьте сведения о VG:

    ``` bash
    vgs
    vgdisplay -v vgname
    ```

    ![Снимок экрана, показывающий код, который проверяет сведения о группе томов. Результаты выделяются.](./media/disk-encryption/resize-lvm/017-resize-lvm-scenarioc-check-vgs.png)

4. Проверьте размеры дисков. Можно использовать `fdisk` или `lsblk` для перечисления размеров дисков.

    ``` bash
    for disk in `ls -l /dev/disk/azure/scsi1/* | awk -F/ '{print $NF}'` ; do echo "fdisk -l /dev/${disk} | grep ^Disk "; done | bash

    lsblk -o "NAME,SIZE"
    ```

    ![Снимок экрана, показывающий код, который проверяет размеры дисков. Результаты выделяются.](./media/disk-encryption/resize-lvm/018-resize-lvm-scenarioc-check-fdisk.png)

    Здесь мы определили, какие постоянного хранилища версий связаны с тем, что LVs с помощью `lsblk -fs` . Сопоставления можно найти, выполнив `lvdisplay` .

    ``` bash
    lvdisplay --maps VG/LV
    lvdisplay --maps datavg/datalv1
    ```

    ![Снимок экрана, показывающий альтернативный способ обнаружения сопоставлений физических томов с локальными томами. Результаты выделяются.](./media/disk-encryption/resize-lvm/019-resize-lvm-scenarioc-check-lvdisplay.png)

    В этом случае все четыре диска данных являются частью одного и того же VG и одного типа LV. Конфигурация может отличаться.

5. Проверьте текущее использование файловой системы.

    ``` bash
    df -h /datalvm*
    ```

    ![Снимок экрана, показывающий код, который проверяет использование файловой системы. Команда и результаты выделяются.](./media/disk-encryption/resize-lvm/020-resize-lvm-scenarioc-check-df.png)

6. Измените размер дисков данных, следуя инструкциям в разделе [расширение управляемого диска Azure](expand-disks.md#expand-an-azure-managed-disk). Вы можете использовать портал, интерфейс командной строки или PowerShell.

    >[!IMPORTANT]
    >Невозможно изменить размер виртуальных дисков во время работы виртуальной машины. Отменить выделение виртуальной машины для этого шага.

7. Запустите виртуальную машину и проверьте новые размеры с помощью `fdisk` .

    ``` bash
    for disk in `ls -l /dev/disk/azure/scsi1/* | awk -F/ '{print $NF}'` ; do echo "fdisk -l /dev/${disk} | grep ^Disk "; done | bash

    lsblk -o "NAME,SIZE"
    ```

    ![Снимок экрана, показывающий код, который проверяет размер диска. Результат выделен.](./media/disk-encryption/resize-lvm/021-resize-lvm-scenarioc-check-fdisk1.png)

    В этом случае `/dev/sdd` был изменен размер от 5 до 20 g.

8. Проверьте текущий размер PV:

    ``` bash
    pvdisplay /dev/resizeddisk
    ```

    ![Снимок экрана, показывающий код, который проверяет размер P V. Результат выделен.](./media/disk-encryption/resize-lvm/022-resize-lvm-scenarioc-check-pvdisplay.png)
    
    Несмотря на то, что размер диска был изменен, ПС по-прежнему имеет предыдущий размер.

9. Измените размер PV:

    ``` bash
    pvresize /dev/resizeddisk
    ```

    ![Снимок экрана, показывающий код, который изменяет размер физического тома. Результат выделен.](./media/disk-encryption/resize-lvm/023-resize-lvm-scenarioc-check-pvresize.png)


10. Проверьте размер PV:

    ``` bash
    pvdisplay /dev/resizeddisk
    ```

    ![Снимок экрана, показывающий код, который проверяет размер физического тома. Результат выделен.](./media/disk-encryption/resize-lvm/024-resize-lvm-scenarioc-check-pvdisplay1.png)

    Примените ту же процедуру ко всем дискам, размер которых нужно изменить.

11. Проверьте сведения о VG.

    ``` bash
    vgdisplay vgname
    ```

    ![Снимок экрана, показывающий код, который проверяет сведения для группы томов. Результат выделен.](./media/disk-encryption/resize-lvm/025-resize-lvm-scenarioc-check-vgdisplay1.png)

    Теперь в VG достаточно места для выделения LVs.

12. Измените размер для LV:

    ``` bash
    lvresize -r -L +5G vgname/lvname
    lvresize -r -l +100%FREE /dev/datavg/datalv01
    ```

    ![Снимок экрана, показывающий код, который изменяет размер L V. Результаты выделяются.](./media/disk-encryption/resize-lvm/031-resize-lvm-scenarioc-check-lvresize1.png)

13. Проверьте размер файловой системы:

    ``` bash
    df -h /datalvm2
    ```

    ![Снимок экрана, показывающий код, который проверяет размер файловой системы. Результат выделен.](./media/disk-encryption/resize-lvm/032-resize-lvm-scenarioc-check-df3.png)

#### <a name="extend-an-lvm-on-crypt-volume-by-adding-a-new-pv"></a>Расширьте LVM том, добавив новый ПС.

Кроме того, вы можете расширить том LVM-on-на основе шифрования, добавив новый ПС. Этот метод тщательно соответствует действиям, описанным в разделе [Настройка LVM и RAID на зашифрованных устройствах](how-to-configure-lvm-raid-on-crypt.md#general-steps). См. разделы, в которых объясняется, как добавить новый диск и настроить его в конфигурации LVM-on-шифрования.

Этот метод можно использовать для добавления пространства к существующему параметру LV. Или можно создать новый VGs или LVs.

1. Проверьте текущий размер VG:

    ``` bash
    vgdisplay vgname
    ```

    ![Снимок экрана, показывающий код, который проверяет размер группы томов. Результаты выделены.](./media/disk-encryption/resize-lvm/033-resize-lvm-scenarioe-check-vg01.png)

2. Проверьте размер файловой системы и LV, которую необходимо расширить:

    ``` bash
    lvdisplay /dev/vgname/lvname
    ```

    ![Снимок экрана, показывающий код, который проверяет размер локального тома. Результаты выделены.](./media/disk-encryption/resize-lvm/034-resize-lvm-scenarioe-check-lv01.png)

    ``` bash
    df -h mountpoint
    ```

    ![Снимок экрана, показывающий код, который проверяет размер файловой системы. Результат выделен.](./media/disk-encryption/resize-lvm/034-resize-lvm-scenarioe-check-fs01.png)

3. Добавьте новый диск данных в виртуальную машину и найдите его.

    Перед добавлением нового диска проверьте диски:

    ``` bash
    fdisk -l | egrep ^"Disk /"
    ```

    ![Снимок экрана, показывающий код, который проверяет размер дисков. Результат выделен.](./media/disk-encryption/resize-lvm/035-resize-lvm-scenarioe-check-newdisk01.png)

    Вот другой способ проверить диски перед добавлением нового диска:

    ``` bash
    lsblk
    ```

    ![Снимок экрана, показывающий альтернативный код, который проверяет размер дисков. Результаты выделяются.](./media/disk-encryption/resize-lvm/035-resize-lvm-scenarioe-check-newdisk02.png)

    Чтобы добавить новый диск, можно использовать PowerShell, Azure CLI или портал Azure. Дополнительные сведения см. в статье [Подключение диска данных к виртуальной машине Linux](attach-disk-portal.md).

    Схема имен ядра применяется к вновь добавленному устройству. Обычно новому диску назначается следующая доступная буква. В этом случае добавленный диск — `sdd` .

4. Проверьте диски, чтобы убедиться, что добавлен новый диск:

    ``` bash
    fdisk -l | egrep ^"Disk /"
    ```

    ![Снимок экрана с кодом, содержащим список дисков. Результаты выделяются.](./media/disk-encryption/resize-lvm/036-resize-lvm-scenarioe-check-newdisk02.png)

    ``` bash
    lsblk
    ```

    ![Снимок экрана, показывающий вновь добавленный диск в выходных данных.](./media/disk-encryption/resize-lvm/036-resize-lvm-scenarioe-check-newdisk03.png)

5. Создайте файловую систему поверх недавно добавленного диска. Сопоставьте диск с связанными устройствами в `/dev/disk/azure/scsi1/` .

    ``` bash
    ls -la /dev/disk/azure/scsi1/
    ```

    ![Снимок экрана, показывающий код, создающий файловую систему. Результаты выделяются.](./media/disk-encryption/resize-lvm/037-resize-lvm-scenarioe-check-newdisk03.png)

    ``` bash
    mkfs.ext4 /dev/disk/azure/scsi1/${disk}
    ```

    ![Снимок экрана, показывающий дополнительный код, который создает файловую систему и сопоставляет диск с связанными устройствами. Результаты выделяются.](./media/disk-encryption/resize-lvm/038-resize-lvm-scenarioe-mkfs01.png)

6. Создайте временную точку подключения для нового добавленного диска:

    ``` bash
    newmount=/data4
    mkdir ${newmount}
    ```

7. Добавьте недавно созданную файловую систему в `/etc/fstab` .

    ``` bash
    blkid /dev/disk/azure/scsi1/lun4| awk -F\" '{print "UUID="$2" '${newmount}' "$4" defaults,nofail 0 0"}' >> /etc/fstab
    ```

8. Подключите только что созданную файловую систему:

    ``` bash
    mount -a
    ```

9. Убедитесь, что новая файловая система подключена:

    ``` bash
    df -h
    ```

    ![Снимок экрана, показывающий код, который проверяет, подключена ли файловая система. Результат выделен.](./media/disk-encryption/resize-lvm/038-resize-lvm-scenarioe-df.png)

    ``` bash
    lsblk
    ```

    ![Снимок экрана, показывающий дополнительный код, который проверяет, подключена ли файловая система. Результат выделен.](./media/disk-encryption/resize-lvm/038-resize-lvm-scenarioe-lsblk.png)

10. Перезапустите шифрование, запущенное ранее для дисков данных.

    >[!TIP]
    >Для LVM-on-шифрования рекомендуется использовать `EncryptFormatAll` . В противном случае при настройке дополнительных дисков может появиться двойное шифрование.
    >
    >Дополнительные сведения см. [в статье configure LVM and RAID On encrypted Devices](how-to-configure-lvm-raid-on-crypt.md).

    Пример:

    ``` bash
    az vm encryption enable \
    --resource-group ${RGNAME} \
    --name ${VMNAME} \
    --disk-encryption-keyvault ${KEYVAULTNAME} \
    --key-encryption-key ${KEYNAME} \
    --key-encryption-keyvault ${KEYVAULTNAME} \
    --volume-type "DATA" \
    --encrypt-format-all \
    -o table
    ```

    После завершения шифрования вы увидите слой шифрования на вновь добавленном диске:

    ``` bash
    lsblk
    ```

    ![Снимок экрана, показывающий код, который проверяет уровень шифрования. Результат выделен.](./media/disk-encryption/resize-lvm/038-resize-lvm-scenarioe-lsblk2.png)

11. Отключите зашифрованный слой нового диска:

    ``` bash
    umount ${newmount}
    ```

12. Проверьте текущие сведения о PV:

    ``` bash
    pvs
    ```

    ![Снимок экрана, показывающий код, который проверяет сведения о физическом томе. Результат выделен.](./media/disk-encryption/resize-lvm/038-resize-lvm-scenarioe-currentpvs.png)

13. Создайте на основе зашифрованного уровня диска ПС. Возьмите имя устройства из предыдущей `lsblk` команды. Добавьте модуль `/dev/` сопоставления перед именем устройства, чтобы создать ПС:

    ``` bash
    pvcreate /dev/mapper/mapperdevicename
    ```

    ![Снимок экрана, показывающий код, который создает физический том на зашифрованном слое. Результаты выделяются.](./media/disk-encryption/resize-lvm/038-resize-lvm-scenarioe-pvcreate.png)

    Появится предупреждение об очистке текущей `ext4 fs` сигнатуры. Это предупреждение ожидаемо. Ответьте на этот вопрос `y` .

14. Убедитесь, что новый ПС добавлен в конфигурацию LVM:

    ``` bash
    pvs
    ```

    ![Снимок экрана, показывающий код, который проверяет, добавлен ли физический том в конфигурацию LVM. Результат выделен.](./media/disk-encryption/resize-lvm/038-resize-lvm-scenarioe-newpv.png)

15. Добавьте новый ПС в VG, который необходимо увеличить.

    ``` bash
    vgextend vgname /dev/mapper/nameofhenewpv
    ```

    ![Снимок экрана, показывающий код, который добавляет физический том в группу томов. Результаты выделяются.](./media/disk-encryption/resize-lvm/038-resize-lvm-scenarioe-vgextent.png)

16. Проверьте новый размер и свободное пространство VG:

    ``` bash
    vgdisplay vgname
    ```

    ![Снимок экрана, показывающий код, который проверяет размер и свободное пространство группы томов. Результаты выделяются.](./media/disk-encryption/resize-lvm/038-resize-lvm-scenarioe-vgdisplay.png)

    Обратите внимание на увеличение `Total PE` числа и `Free PE / Size` .

17. Увеличьте размер файла LV и файловой системы. Используйте `-r` параметр ON `lvextend` . В этом примере мы добавляем общее доступное пространство в VG к заданному LV.

    ``` bash
    lvextend -r -l +100%FREE /dev/vgname/lvname
    ```

    ![Снимок экрана, показывающий код, увеличивающий размер локального тома и файловой системы. Результаты выделяются.](./media/disk-encryption/resize-lvm/038-resize-lvm-scenarioe-lvextend.png)

Выполните следующие действия, чтобы проверить изменения.

1. Проверьте размер файла LV:

    ``` bash
    lvdisplay /dev/vgname/lvname
    ```

    ![Снимок экрана, показывающий код, который проверяет новый размер локального тома. Результаты выделяются.](./media/disk-encryption/resize-lvm/038-resize-lvm-scenarioe-lvdisplay.png)

1. Проверьте новый размер файловой системы:

    ``` bash
    df -h mountpoint
    ```

    ![Снимок экрана, показывающий код, который проверяет новый размер файловой системы. Результат выделен.](./media/disk-encryption/resize-lvm/038-resize-lvm-scenarioe-df1.png)

1. Убедитесь, что слой LVM находится поверх зашифрованного слоя:

    ``` bash
    lsblk
    ```

    ![Снимок экрана, показывающий код, который проверяет, что слой LVM находится поверх зашифрованного слоя. Результат выделен.](./media/disk-encryption/resize-lvm/038-resize-lvm-scenarioe-lsblk3.png)

    Если вы используете `lsblk` без параметров, точки подключения будут отображаться несколько раз. Команда сортирует по устройствам и LVs. 

    Возможно, вы захотите использовать `lsblk -fs` . В этой команде `-fs` изменяет порядок сортировки таким образом, чтобы точки подключения отображались один раз. Диски отображаются несколько раз.

    ``` bash
    lsblk -fs
    ```

    ![Снимок экрана, показывающий альтернативный код, проверяющий, что слой LVM находится поверх зашифрованного слоя. Результат выделен.](./media/disk-encryption/resize-lvm/038-resize-lvm-scenarioe-lsblk4.png)

#### <a name="extend-an-lvm-on-a-crypt-volume-by-resizing-an-existing-pv"></a>Расширение LVM на сошифрованном томе путем изменения размера существующей

1. Найдите зашифрованные диски:

    ``` bash
    lsblk
    ```

    ![Снимок экрана, показывающий код, идентифицирующий зашифрованные диски. Результаты выделяются.](./media/disk-encryption/resize-lvm/039-resize-lvm-scenariof-lsblk01.png)

    ``` bash
    lsblk -s
    ```

    ![Снимок экрана, показывающий альтернативный код, идентифицирующий зашифрованные диски. Результаты выделяются.](./media/disk-encryption/resize-lvm/040-resize-lvm-scenariof-lsblk012.png)

2. Проверьте сведения о своей ПС:

    ``` bash
    pvs
    ```

    ![Снимок экрана, показывающий код, который проверяет данные для физических томов. Результаты выделяются.](./media/disk-encryption/resize-lvm/041-resize-lvm-scenariof-pvs.png)

3. Проверьте сведения о VG:

    ``` bash
    vgs
    ```

    ![Снимок экрана, показывающий код, который проверяет сведения для групп томов. Результаты выделяются.](./media/disk-encryption/resize-lvm/042-resize-lvm-scenariof-vgs.png)

4. Проверьте сведения о LV:

    ``` bash
    lvs
    ```

    ![Снимок экрана, показывающий код, который проверяет сведения для локального тома. Результат выделен.](./media/disk-encryption/resize-lvm/043-resize-lvm-scenariof-lvs.png)

5. Проверьте использование файловой системы.

    ``` bash
    df -h /mountpoint(s)
    ```

    ![Снимок экрана, показывающий код, который проверяет, какая часть файловой системы используется. Результаты выделяются.](./media/disk-encryption/resize-lvm/044-resize-lvm-scenariof-fs.png)

6. Проверьте размеры дисков:

    ``` bash
    fdisk
    fdisk -l | egrep ^"Disk /"
    lsblk
    ```

    ![Снимок экрана, показывающий код, который проверяет размер дисков. Результаты выделяются.](./media/disk-encryption/resize-lvm/045-resize-lvm-scenariof-fdisk01.png)

7. Измените размер диска данных. Можно использовать портал, интерфейс командной строки или PowerShell. Дополнительные сведения см. в разделе "изменение размера диска" раздела [Расширение виртуальных жестких дисков на виртуальной машине Linux](expand-disks.md#expand-an-azure-managed-disk). 

    >[!IMPORTANT]
    >Невозможно изменить размер виртуальных дисков во время работы виртуальной машины. Отменить выделение виртуальной машины для этого шага.

8. Проверьте размеры дисков:

    ``` bash
    fdisk
    fdisk -l | egrep ^"Disk /"
    lsblk
    ```

    ![Снимок экрана с кодом, который проверяет размеры дисков. Результаты выделяются.](./media/disk-encryption/resize-lvm/046-resize-lvm-scenariof-fdisk02.png)

    В этом случае размер обоих дисков изменится с 2 ГБ до 4 ГБ. Но размер файловой системы, LV и ПС остается прежним.

9. Проверьте текущий размер PV. Помните, что в LVM-on-шифрования ПС — это `/dev/mapper/` устройство, а не `/dev/sd*` устройство.

    ``` bash
    pvdisplay /dev/mapper/devicemappername
    ```

    ![Снимок экрана, показывающий код, который проверяет размер текущего физического тома. Результаты выделяются.](./media/disk-encryption/resize-lvm/047-resize-lvm-scenariof-pvs.png)

10. Измените размер PV:

    ``` bash
    pvresize /dev/mapper/devicemappername
    ```

    ![Снимок экрана, показывающий код, который изменяет размер физического тома. Результаты выделяются.](./media/disk-encryption/resize-lvm/048-resize-lvm-scenariof-resize-pv.png)

11. Проверьте новый размер ПС:

    ``` bash
    pvdisplay /dev/mapper/devicemappername
    ```

    ![Снимок экрана, показывающий код, который проверяет размер физического тома. Результаты выделяются.](./media/disk-encryption/resize-lvm/049-resize-lvm-scenariof-pv.png)

12. Измените размер зашифрованного слоя в PV:

    ``` bash
    cryptsetup resize /dev/mapper/devicemappername
    ```

    Примените ту же процедуру ко всем дискам, размер которых нужно изменить.

13. Проверьте сведения о VG:

    ``` bash
    vgdisplay vgname
    ```

    ![Снимок экрана, показывающий код, который проверяет сведения для группы томов. Результаты выделяются.](./media/disk-encryption/resize-lvm/050-resize-lvm-scenariof-vg.png)

    Теперь в VG достаточно места для выделения LVs.

14. Проверьте сведения о LV:

    ``` bash
    lvdisplay vgname/lvname
    ```

    ![Снимок экрана, показывающий код, который проверяет сведения для локального тома. Результаты выделяются.](./media/disk-encryption/resize-lvm/051-resize-lvm-scenariof-lv.png)

15. Проверьте использование файловой системы.

    ``` bash
    df -h /mountpoint
    ```

    ![Снимок экрана, показывающий код, который проверяет использование файловой системы. Результаты выделяются.](./media/disk-encryption/resize-lvm/052-resize-lvm-scenariof-fs.png)

16. Измените размер для LV:

    ``` bash
    lvresize -r -L +2G /dev/vgname/lvname
    ```

    ![Снимок экрана, показывающий код, который изменяет размер локального тома. Результаты выделяются.](./media/disk-encryption/resize-lvm/053-resize-lvm-scenariof-lvresize.png)

    Здесь мы используем `-r` параметр, чтобы также изменить размер файловой системы.

17. Проверьте сведения о LV:

    ``` bash
    lvdisplay vgname/lvname
    ```

    ![Снимок экрана, показывающий код, который получает сведения о локальном томе. Результаты выделяются.](./media/disk-encryption/resize-lvm/054-resize-lvm-scenariof-lvsize.png)

18. Проверьте использование файловой системы.

    ``` bash
    df -h /mountpoint
    ```

    ![Снимок экрана, показывающий код, который проверяет использование файловой системы. Результаты выделяются.](./media/disk-encryption/resize-lvm/055-resize-lvm-scenariof-fs.png)

Примените ту же процедуру изменения размера к любому другому параметру LV, который его требует.

## <a name="next-steps"></a>Дальнейшие действия

[Устранение неполадок шифрования дисков Azure](disk-encryption-troubleshooting.md)
