---
title: Устранение неполадок с помощью Cloud-init
description: Устранение неполадок при подготовке виртуальной машины Azure с помощью Cloud-init.
author: danielsollondon
ms.service: virtual-machines-linux
ms.subservice: imaging
ms.topic: troubleshooting
ms.date: 07/06/2020
ms.author: danis
ms.reviewer: cynthn
ms.openlocfilehash: 81e138e7149327c7b792df58180419b93417d263
ms.sourcegitcommit: 3543d3b4f6c6f496d22ea5f97d8cd2700ac9a481
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/20/2020
ms.locfileid: "86510979"
---
# <a name="troubleshooting-vm-provisioning-with-cloud-init"></a>Устранение неполадок при подготовке виртуальной машины с помощью Cloud-init

Если вы создали обобщенные пользовательские образы, используя подготовку Cloud-init для подготовки, но обнаружили, что виртуальная машина создана неправильно, вам потребуется устранить неполадки в пользовательских образах.

Некоторые примеры проблем с подготовкой:
- Виртуальная машина зависает при создании в течение 40 минут, а создание виртуальной машины помечается как сбой.
- `CustomData`не обрабатывается
- Не удается подключить временный диск
- Пользователи не создаются или возникают проблемы с доступом пользователей
- Сетевые подключения настроены неправильно
- Ошибки при переключении на файл или раздел

В этой статье описывается устранение неполадок Cloud-init. Более подробные сведения см. в разделе [Cloud-init глубокое](./cloud-init-deep-dive.md)углубление.

## <a name="step-1-test-the-deployment-without-customdata"></a>Шаг 1. Тестирование развертывания без`customData`

Cloud-init может принять `customData` , если виртуальная машина будет передаваться в нее. Во-первых, следует убедиться, что это не вызывает проблем с развертываниями. Попробуйте подготовить виртуальную машину без передачи какой бы то ни было конфигурации. Если вы обнаружите, что виртуальная машина не подготавливается, выполните описанные ниже действия, если вы обнаружите, что конфигурация, которую вы передаете, не применяется, перейдите к [шагу 4](). 

## <a name="step-2-review-image-requirements"></a>Шаг 2. Проверка требований к образу
Основная причина сбоя подготовки виртуальной машины — образ ОС не удовлетворяет предварительным требованиям для работы в Azure. Убедитесь, что образы правильно подготовлены, прежде чем пытаться подготовить их в Azure. 


В следующих статьях показаны шаги для подготовки различных дистрибутивов Linux, поддерживаемых в Azure.

- [Подготовка виртуальной машины на основе CentOS для Azure](create-upload-centos.md)
- [Подготовка виртуального жесткого диска Debian для Azure](debian-create-upload-vhd.md)
- [Flatcar Container Linux](flatcar-create-upload-vhd.md)
- [Oracle Linux](oracle-create-upload-vhd.md)
- [Red Hat Enterprise Linux](redhat-create-upload-vhd.md)
- [Подготовка виртуальной машины SLES или openSUSE для Azure](suse-create-upload-vhd.md)
- [Ubuntu](create-upload-ubuntu.md)
- [Информация о нерекомендованных дистрибутивах](create-upload-generic.md)

Для [поддерживаемых образов Azure Cloud-init](./using-cloud-init.md)дистрибутивы Linux уже имеют все необходимые пакеты и конфигурации, чтобы правильно подготавливать образ в Azure. Если вы обнаружите, что виртуальная машина не может создать данные из собственного проверенного образа, попробуйте использовать поддерживаемый образ Azure Marketplace, который уже настроен для Cloud-init, с необязательным `customData` . Если приложение `customData` правильно работает с образом Azure Marketplace, возможно, у вас есть проблемы с проверенным образом.

## <a name="step-3-collect--review-vm-logs"></a>Шаг 3. получение & проверки журналов виртуальных машин

Если виртуальная машина не подготавливается к работе, в Azure отобразится состояние "создание", в течение 20 минут, а затем перезагрузите виртуальную машину и подождите еще 20 минут, прежде чем пометить развертывание виртуальной машины как неудачное, прежде чем помечать ее как невыполненную `OSProvisioningTimedOut` .

Пока виртуальная машина запущена, вам понадобятся журналы с виртуальной машины, чтобы понять, почему подготовка не удалась.  Чтобы понять, почему не удалось подготовить виртуальную машину, не останавливайте ее. Обеспечьте работоспособность виртуальной машины. Для получения журналов необходимо сохранить работоспособность виртуальной машины в состоянии выполнения. Чтобы получить журналы, используйте один из следующих методов.

- [Серийная консоль](./serial-console-grub-single-user-mode.md)

- [Включите диагностику загрузки](./tutorial-monitor.md#enable-boot-diagnostics) перед созданием виртуальной машины и [Просмотрите](./tutorial-monitor.md#view-boot-diagnostics) их во время загрузки.

- [Выполните команду AZ VM Repair](../troubleshooting/repair-linux-vm-using-azure-virtual-machine-repair-commands.md) , чтобы подключить и ПОДКЛЮЧИТЬ диск ОС, который позволит вам получать следующие журналы:
```bash
/var/log/cloud-init*
/var/log/waagent*
/var/log/syslog*
/var/log/rsyslog*
/var/log/messages*
/var/log/kern*
/var/log/dmesg*
/var/log/boot*
```
Чтобы начать первоначальное устранение неполадок, начните с журналов Cloud-init и Узнайте, где произошел сбой, а затем используйте другие журналы для углубленного изучения и получения дополнительных сведений. 
* /вар/лог/клауд-инит.лог
* /вар/лог/клауд-инит-аутпут.лог
* Журналы последовательного и загрузочного

Во всех журналах Начните поиск по слову "Failed", "WARNING", "WARN", "Err", "Error", "ERROR". Рекомендуется задавать параметр конфигурации игнорировать Поиск с учетом регистра. 

> [!TIP]
> При устранении неполадок с пользовательским образом рекомендуется добавить пользователя во время создания образа. Если при подготовке не удается установить пользователя с правами администратора, вы по-прежнему можете войти в ОС.

## <a name="analyzing-the-logs"></a>Анализ журналов

Ниже приведены дополнительные сведения о том, что следует искать в каждом журнале Cloud-init.

### <a name="varlogcloud-initlog"></a>/вар/лог/клауд-инит.лог

По умолчанию все события Cloud-init с приоритетом Debug или выше записываются в `/var/log/cloud-init.log` . Это предоставляет подробные журналы всех событий, произошедших во время инициализации Cloud-init. 

Вот несколько примеров:

```console
2019-10-10 04:51:25,321 - util.py[DEBUG]: Failed mount of '/dev/sr0' as 'auto': Unexpected error while running command.
Command: ['mount', '-o', 'ro,sync', '-t', 'auto', u'/dev/sr0', '/run/cloud-init/tmp/tmpLIrklc']
Exit code: 32
Reason: -
Stdout:
Stderr: mount: unknown filesystem type 'udf'
2020-01-31 00:21:53,352 - DataSourceAzure.py[WARNING]: /dev/sr0 was not mountable
```


Когда вы обнаружите ошибку или предупреждение, прочтите в журнале Cloud-init в обратном порядке, чтобы понять, какая попытка Cloud-init выполнялась до того, как она достигнет ошибки или предупреждения. Во многих случаях Cloud-init будет выполнять команды операционной системы или выполнять операции подготовки до возникновения ошибки, что позволяет получить подробные сведения о том, почему ошибки появляются в журналах. В следующем примере показано, что Cloud-init попыталось подключить устройство непосредственно, прежде чем оно достигнет ошибки.

```output
2019-10-10 04:51:24,010 - util.py[DEBUG]: Running command ['mount', '-o', 'ro,sync', '-t', 'auto', u'/dev/sr0', '/run/cloud-init/tmp/tmpXXXXX'] with allowed return codes [0] (shell=False, capture=True)
```

Если у вас есть доступ к [последовательной консоли](./serial-console-grub-single-user-mode.md), можно попробовать повторно выполнить команду, которую пытался запустить Cloud-init.

Ведение журнала для `/var/log/cloud-init.log` можно также перенастроить в/етк/клауд/клауд.кфг.д/05_logging. cfg. Дополнительные сведения о ведении журнала Cloud-init см. в [документации по Cloud-init](https://cloudinit.readthedocs.io/en/latest/topics/logging.html). 

### <a name="varlogcloud-init-outputlog"></a>/вар/лог/клауд-инит-аутпут.лог

Вы можете получить сведения из `stdout` и на `stderr` [этапах Cloud-init](cloud-init-deep-dive.md). Обычно это включает сведения о таблице маршрутизации, сведения о сети, сведения о проверке ключа узла SSH `stdout` и `stderr` для каждого этапа Cloud-init, а также отметку времени для каждого этапа. При необходимости `stderr` `stdout` можно перенастроить ведение журнала с `/etc/cloud/cloud.cfg.d/05_logging.cfg` .

### <a name="serialboot-logs"></a>Журналы последовательного и загрузочного 

Cloud-init имеет несколько зависимостей, они описаны в статье необходимые условия для образов в Azure, такие как сеть, хранилище, возможность подключения ISO, а также подключение и форматирование временного диска. Любой из них может вызвать ошибки и вызвать сбой Cloud-init. Например, если виртуальная машина не может получить аренду DHCP, то Cloud-init завершится ошибкой.

Если вы по-прежнему не можете изолировать, почему не удалось выполнить инициализацию Cloud-init, необходимо понять, какие этапы Cloud-init и когда работают модули. Дополнительные сведения см. в статье Подробнее о [Cloud-init](cloud-init-deep-dive.md) .


## <a name="step-4-investigate-why-the-configuration-isnt-being-applied"></a>Шаг 4. Выясните, почему конфигурация не применяется
Не все сбои в Cloud-init приводят к неустранимой ошибке подготовки. Например, если вы используете `runcmd` модуль в конфигурации Cloud-init, ненулевой код выхода из выполняемой команды приведет к сбою подготовки виртуальной машины. Это обусловлено тем, что он выполняется после основных функций подготовки, которые выполняются на первых трех стадиях Cloud-init. Чтобы устранить неполадки, связанные с тем, почему конфигурация не была применена, изучите журналы в шаге 3 и модули Cloud-init вручную. Вот несколько примеров:

- `runcmd`-выполнять сценарии без ошибок? Запустите конфигурацию вручную из терминала, чтобы убедиться, что они выполняются должным образом.
- Установка пакетов. у виртуальной машины есть доступ к репозиториям пакетов?
- Кроме того `customData` , проверьте конфигурацию данных, предоставленную виртуальной машине, которая находится в папке `/var/lib/cloud/instances/<unique-instance-identifier>/user-data.txt` .


## <a name="next-steps"></a>Дальнейшие действия

Если вы по-прежнему не можете изолировать, почему Cloud-init не выполнял конфигурацию, необходимо более внимательно ознакомиться с тем, что происходит на каждом этапе Cloud-init, а также при запуске модулей. Дополнительные сведения см. в статье Подробнее о [настройке Cloud-init](./cloud-init-deep-dive.md) . 
