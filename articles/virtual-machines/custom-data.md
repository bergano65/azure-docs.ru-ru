---
title: Пользовательские данные и виртуальные машины Azure
description: Сведения об использовании пользовательских данных и Cloud-Init на виртуальных машинах Azure
services: virtual-machines
author: mimckitt
ms.service: virtual-machines
ms.topic: how-to
ms.date: 03/06/2020
ms.author: mimckitt
ms.openlocfilehash: 2924caaac5fb8c512100d9e897f7f153af9a3b3e
ms.sourcegitcommit: dccb85aed33d9251048024faf7ef23c94d695145
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/28/2020
ms.locfileid: "87284920"
---
# <a name="custom-data-and-cloud-init-on-azure-virtual-machines"></a>Пользовательские данные и Cloud-Init на виртуальных машинах Azure

Может потребоваться внедрить скрипт или другие метаданные в Microsoft Azure виртуальную машину во время подготовки.  В других облаках эти данные часто называются пользовательскими данными.  В Microsoft Azure существует аналогичная функция, которая называется пользовательскими данными. 

Пользовательские данные становятся доступными для виртуальной машины только во время первой или начальной настройки, поэтому мы называем этот процесс "подготовкой". Подготовка — это процесс, в ходе которого доступны параметры создания виртуальной машины (например, имя узла, имя пользователя, пароль, сертификаты, пользовательские данные, ключи и т. д.), а агент подготовки их обрабатывает, например [агент Linux](./extensions/agent-linux.md) и [Cloud-Init](./linux/using-cloud-init.md#troubleshooting-cloud-init). 


## <a name="passing-custom-data-to-the-vm"></a>Передача пользовательских данных в виртуальную машину
Чтобы использовать пользовательские данные, перед передачей данных в API сначала их необходимо закодировать в формате Base64, если только вы не используете средство CLI, например AZ CLI, которое выполняет такое преобразование. Размер файла не может превышать 64 КБ.

С помощью интерфейса командной строки можно передать пользовательские данные в виде файла, они будут преобразованы в Base64.
```bash
az vm create \
  --resource-group myResourceGroup \
  --name centos74 \
  --image OpenLogic:CentOS-CI:7-CI:latest \
  --custom-data cloud-init.txt \
  --generate-ssh-keys
```

В Azure Resource Manager (ARM) существует [функция Base64](../azure-resource-manager/templates/template-functions-string.md#base64).

```json
"name": "[parameters('virtualMachineName')]",
"type": "Microsoft.Compute/virtualMachines",
"apiVersion": "2019-07-01",
"location": "[parameters('location')]",
"dependsOn": [
..],
"variables": {
        "customDataBase64": "[base64(parameters('stringData'))]"
    },
"properties": {
..
    "osProfile": {
        "computerName": "[parameters('virtualMachineName')]",
        "adminUsername": "[parameters('adminUsername')]",
        "adminPassword": "[parameters('adminPassword')]",
        "customData": "[variables('customDataBase64')]"
        },
```

## <a name="processing-custom-data"></a>Обработка пользовательских данных
Агенты подготовки, установленные на виртуальных машинах, взаимодействуют с платформой и помещают данные в файловую систему. 

### <a name="windows"></a>Windows
Пользовательские данные помещаются в *%SYSTEMDRIVE%\AzureData\CustomData.bin* как двоичный файл, но не обрабатываются. Если вы хотите обработать этот файл, вам потребуется создать пользовательский образ и написать код для обработки CustomData.bin.

### <a name="linux"></a>Linux  
В ОС Linux пользовательские данные передаются в виртуальную машину через файл ovf-env.xml, который копируется в каталог */var/lib/waagent* во время подготовки.  Более новые версии агента Linux для Microsoft Azure также копируют данные в кодировке Base64 в каталог */var/lib/waagent/CustomData* для удобства.

На данный момент Azure поддерживает два агента подготовки:
* Агент Linux — по умолчанию агент не будет обрабатывать пользовательские данные, вам необходимо создать с пользовательский образ с включенными данными. Актуальными параметрами согласно [документации](https://github.com/Azure/WALinuxAgent#configuration) являются:
    * Provisioning.DecodeCustomData;
    * Provisioning.ExecuteCustomData.

Когда вы включаете пользовательские данные и выполняете скрипт, сообщение о готовности виртуальной машины или об успешной подготовке будет задерживаться, пока скрипт не будет завершен. Если выполнение скрипта превышает общую квоту на время подготовки виртуальной машины на 40 минут, то создание виртуальной машины завершится ошибкой. Обратите внимание, если скрипт не удается выполнить или во время выполнения произошли ошибки, это не повлечет неустранимый сбой подготовки. Вам необходимо будет создать путь для уведомления о состоянии завершения скрипта.

Чтобы устранить неполадки с выполнением пользовательских данных, ознакомьтесь с файлом журнала */var/log/waagent.log*.

* Cloud-init будет обрабатывать пользовательские данные по умолчанию, так как он принимает [несколько форматов](https://cloudinit.readthedocs.io/en/latest/topics/format.html) пользовательских данных (например, конфигурацию Cloud-init, скрипты и т. д.). Cloud-init обрабатывает пользовательские данные аналогично агенту Linux. Если во время выполнения обработки конфигурации или скрипта произошли ошибки, это не повлечет неустранимый сбой подготовки. Вам необходимо создать путь для уведомления о состоянии завершения скрипта. Однако в отличие от агента Linux, Cloud-init не ждет завершения конфигураций пользовательских данных, прежде чем сообщить платформе о готовности виртуальной машины. Дополнительные сведения о Cloud-init в Azure см. в [этой документации](./linux/using-cloud-init.md).


Для устранения неполадок при выполнении пользовательских данных см. [эту документацию](./linux/using-cloud-init.md#troubleshooting-cloud-init).


## <a name="faq"></a>ВОПРОСЫ И ОТВЕТЫ
### <a name="can-i-update-custom-data-after-the-vm-has-been-created"></a>Можно ли обновить пользовательские данные после создания виртуальной машины?
Для отдельных виртуальных машин пользовательские данные в модели виртуальной машины не могут быть обновлены, но вы можете обновить пользовательские данные Масштабируемых наборов виртуальных машин (VMSS) с помощью [REST API](/rest/api/compute/virtualmachinescalesets/update) (неприменимо для клиентов PS или AZ CLI). При обновлении пользовательских данных в модели VMSS:
* Существующие экземпляры в VMSS не получат обновленные пользовательские данные до тех пор, пока для них не будет повторно создан образ.
* Существующие экземпляры в обновляемых VMSS не будут получать обновленные пользовательские данные.
* Новые экземпляры получат новые пользовательские данные.

### <a name="can-i-place-sensitive-values-in-custom-data"></a>Можно ли поместить конфиденциальные значения в пользовательские данные?
Мы советуем **не** хранить конфиденциальные данные в пользовательских. Дополнительные сведения см. в статье [Рекомендации по защите и шифрованию данных в Azure](../security/fundamentals/data-encryption-best-practices.md).


### <a name="is-custom-data-made-available-in-imds"></a>Доступны ли пользовательские данные в IMDS?
Нет, сейчас такая возможность недоступна.
