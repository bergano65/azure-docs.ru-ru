---
title: 'STOP-ошибка Windows "Status No Memory" (Состояние: недостаточно памяти)'
description: В этой статье приведены инструкции по устранению проблем, при которых Windows не запускается, и отображается состояние "состояние без памяти".
services: virtual-machines-windows, azure-resource-manager
documentationcenter: ''
author: v-miegge
manager: dcscontentpm
editor: ''
tags: azure-resource-manager
ms.assetid: d29c7e49-4578-43c8-b829-831da4e48932
ms.service: virtual-machines-windows
ms.workload: na
ms.tgt_pltfrm: vm-windows
ms.topic: troubleshooting
ms.date: 06/26/2020
ms.author: v-mibufo
ms.openlocfilehash: 67064cf694445acf8472b958660133c2f2d31db9
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85660953"
---
# <a name="windows-stop-error---status-no-memory"></a>STOP-ошибка Windows "Status No Memory" (Состояние: недостаточно памяти)

В этой статье приведены инструкции по устранению проблем, при которых Windows не запускается, и отображается состояние или код ошибки #0xC0000017, также называемый "состояние без памяти".

## <a name="symptom"></a>Симптом

При использовании [диагностики загрузки](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/boot-diagnostics) для просмотра снимка экрана виртуальной машины вы увидите, что на снимке экрана отображается код ошибки: `0xC0000017` . В зависимости от используемой версии Windows этот код может отображаться как в **диспетчере загрузки Windows** , так и на **экране восстановления**.

   **диспетчер загрузки Windows;**

   ![Диспетчер загрузки Windows, сообщающий, что Windows не удалось запуститься. Причиной может быть Последнее изменение оборудования или программного обеспечения. Прокрутка вниз отображается код состояния "0xC0000017", а также сведения о том, что не удалось загрузить приложение или операционную систему, поскольку необходимый файл отсутствует или содержит ошибки.](./media/troubleshoot-windows-stop-error/1.png)

   **Экран восстановления**
 
   ![На экране восстановления говорится о том, что необходимо восстановить компьютер или устройство. Недостаточно памяти для создания устройства Ramdisk. Также должен отобразиться код ошибки «0xC0000017».](./media/troubleshoot-windows-stop-error/2.png)

## <a name="cause"></a>Причина:

Диск операционной системы либо полон, либо фрагментирован, либо операционная система не может получить доступ к памяти, файлу подкачки или обоим файлам.

## <a name="solution"></a>Решение

### <a name="process-overview"></a>Общие сведения о процессе.

1. Создание виртуальной машины для восстановления и получение доступа к ней
1. Освободите место на диске
1. Очистка поврежденной памяти из хранилища BCD
1. Восстановление файла подкачки в расположение по умолчанию
1. Включение сбора последовательной консоли и дампа памяти
1. Перестроение виртуальной машины

> [!NOTE]
> При возникновении этой ошибки гостевая ОС не работает. Для устранения неполадок потребуется применить автономный режим.

### <a name="create-and-access-a-repair-vm"></a>Создание виртуальной машины для восстановления и вход на нее

1. Выполните [шаги 1–3 списка команд для восстановления виртуальной машины](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/repair-windows-vm-using-azure-virtual-machine-repair-commands), чтобы подготовить виртуальную машину для восстановления.
1. Используйте подключение к удаленному рабочему столу, чтобы подключиться к виртуальной машине для восстановления.

### <a name="for-generation-2-vms-assign-a-letter-to-the-extensible-firmware-interface-efi-partition"></a>Для виртуальных машин поколения 2 назначьте букву для секции EFI:

Если вы используете виртуальную машину поколения 2, к разделу EFI подключенного диска может быть назначена буква. Чтобы приступить к работе с этим руководством по устранению неполадок, необходимо выполнить приведенные ниже действия, чтобы назначить букву разделу.

1. В окне поиска Windows введите `diskmgmt` и откройте **консоль управления дисками**.
1. Найдите поврежденный диск, подключенный к виртуальной машине восстановления. Как правило, этот диск указывается последним в консоли и имеет наибольшее числовое значение.
1. Обратите внимание, что на этом диске есть раздел, содержащий **системный раздел EFI**, которому также не назначено значение буквы (например, диск *F:*). Если назначены все секции, вы можете пропустить, чтобы освободить место на диске. В противном случае продолжайте назначать букву этому диску.

   ![Консоль управления дисками с подключенным диском "диск 2", а также неназначенный раздел размером 100 МБ и является "системным разделом EFI".](./media/troubleshoot-windows-stop-error/3.png)

1. Откройте командную строку с повышенными привилегиями с правами администратора и введите, `diskpart` чтобы запустить средство **DiskPart** .
1. Введите следующие команды:

   ```
   list disk
   sel disk <NUMBER OF THE ATTACHED DISK>
   list partition
   sel partition <NUMBER OF THE SYSTEM (EFI) PARTION>
   assign
   ```
   
   - В команде замените `<NUMBER OF THE ATTACHED DISK>` номером диска, указанным на шаге 2.
   - В команде замените `<NUMBER OF THE SYSTEM PARTION>` номером секции системного раздела EFI. Этой секции еще не назначена буква, но она должна иметь тип **System** и иметь размер около 100 МБ.

   > [!NOTE]
   > Сравнение секций в консоли управления дисками со списками, перечисленными в средстве DISKPART, может оказаться полезным при определении номера раздела, соответствующего системному разделу EFI на подключенном диске.

1. Закройте окно командной строки.

### <a name="free-up-space-on-the-disk"></a>Освободите место на диске

Теперь, когда поврежденный диск подключен к виртуальной машине восстановления, необходимо убедиться, что операционная система на этом диске имеет достаточно места для правильной работы. 

1. Проверьте, заполнен ли диск, щелкнув правой кнопкой мыши диск подключенного диска и выбрав пункт **Свойства**.
1. Если на диске **менее 300 МБ свободного места**, [увеличьте его до 1 ТБ с помощью PowerShell](https://docs.microsoft.com/azure/virtual-machines/windows/expand-os-disk).
1. Когда размер диска составляет **1 ТБ**, необходимо выполнить очистку диска. Для освобождения места можно использовать [средство очистки диска](https://support.microsoft.com/help/4026616/windows-10-disk-cleanup) .
1. Откройте окно командной строки с повышенными привилегиями (Запуск от имени администратора) и выполните дефрагментацию диска:

   ``
   defrag <LETTER ASSIGNED TO THE OS DISK>: /u /x /g
   ``
   
   - В зависимости от уровня фрагментации для отмены фрагментации может потребоваться несколько часов.
   - В команде замените `<LETTER ASSIGNED TO THE OS DISK>` буквой диска ОС (например, буквой *F:*).

### <a name="clean-out-bad-memory-from-the-boot-configuration-data-bcd-store"></a>Очистка поврежденной памяти из хранилища данные конфигурации загрузки (BCD)

1. Откройте командную строку с повышенными привилегиями (Запуск от имени администратора).
1. Запросите файл конфигурации загрузки для недопустимых флагов памяти с помощью следующей команды:

   ``
   bcdedit /store <LETTER ASSIGNED TO THE OS DISK>:\boot\bcd /enum {badmemory}
   ``
   
   - В команде замените `<LETTER ASSIGNED TO THE OS DISK>` буквой диска ОС (например, буквой *F:*).

1. Если в запросе не отображаются поврежденные блоки памяти, переходите к следующей задаче. В противном случае перейдите к шагу 4.
1. Если обнаружены поврежденные блоки памяти, эти блоки препятствуют созданию диска RAMDisk и должны быть удалены с помощью следующей команды:

   ``
   bcdedit /store <LETTER ASSIGNED TO THE OS DISK>:\boot\bcd /deletevalue {badmemory} badmemorylist
   ``
   
   - В команде замените `<LETTER ASSIGNED TO THE OS DISK>` буквой диска ОС (например, буквой *F:*).

### <a name="restore-the-page-file-to-its-default-location"></a>Восстановление файла подкачки в расположение по умолчанию

В файле подкачки хранятся данные, которые не могут храниться в оперативной памяти компьютера (ОЗУ) в виде переполнения или резервного копирования. Возможно, файл размещается в VHD, а не на временном диске, который является расположением Azure по умолчанию. Если значение — true, файл может быть недоступен и должен быть восстановлен в расположение по умолчанию.

Перед выполнением каких-либо действий следует создать копию папки **\WINDOWS\System32\Config** на работоспособном диске. Этот шаг позволяет отменить любые нежелательные изменения. Вы будете работать с важными системными файлами, поэтому настоятельно рекомендуется использовать эту предосторожность.

1. В окне поиска Windows введите **regedit** и откройте приложение редактора реестра.
1. В редакторе реестра выделите ключ **HKEY_LOCAL_MACHINE** и выберите **файл > загрузить Hive...** в меню.

   ![Меню Загрузка Hive в редакторе реестра.](./media/troubleshoot-windows-stop-error/4.png)

1. В диалоговом окне Загрузка Hive выберите **\windows\system32\config\SYSTEM** и нажмите кнопку Открыть.
   1. Появится запрос на ввод имени, которое следует ввести **BROKENSYSTEM**. Это имя поможет отличить затронутые кусты при устранении неполадок.
   1. Разверните **HKEY_LOCAL_MACHINE** , чтобы увидеть новый добавленный ключ BROKENSYSTEM.
1. С помощью редактора реестра определите, из какого элемента управления загружается компьютер.
   1. Перейдите к **HKEY_LOCAL_MACHINE >> BROKENSYSTEM >> выберите**.
   1. В перечисленных ключах Обратите внимание на текущее значение данных. Например, если это значение равно **1** или **0x00000001 (1)**, то набор элементов управления будет ControlSet001.
1. Проверьте расположение, в котором настроено создание файла подкачки.
   1. В HKEY_LOCAL_MACHINE \БРОКЕНСИСТЕМ разверните каталог, соответствующий номеру элемента управления, который вы определили на шаге 4, например **ControlSet001**.
   1. Перейдите к **элементу управление >> диспетчер сеансов >> управление памятью** и обратите внимание на расположение ключа **ексистингпажефилес** .
   1. Этот ключ должен находиться в расположении Azure по умолчанию для временного диска. Если он отсутствует и находится в другом расположении, например на диске данных или диске операционной системы, его необходимо удалить.
   1. Перейдите к этому расположению в проводнике и удалите файл **pagefile.sys** .

### <a name="enable-the-serial-console-and-memory-dump-collection"></a>Включение последовательной консоли и сбор дампов памяти

**Рекомендуется**. Прежде чем перестраивать виртуальную машину, включите последовательную консоль и сбор дампов памяти. Для этого выполните следующий скрипт:

Чтобы включить сбор дампов памяти и последовательную консоль, выполните следующий скрипт:

1. Откройте сеанс командной строки с повышенными привилегиями от имени администратора.
1. Перечислите данные из хранилища BCD и определите идентификатор загрузчика, который будет использоваться на следующем шаге.

   1. Для виртуальной машины поколения 1 введите следующую команду и запишите идентификатор в списке:
   
      ``
      bcdedit /store <BOOT PARTITON>:\boot\bcd /enum
      ``
   
   - В команде замените на `<BOOT PARTITON>` букву раздела на подключенном диске, который содержит папку Boot.

      ![Выходные данные для перечисления данных BCD в виртуальной машине поколения 1, которые перечислены под загрузкой Windows, являются идентификатором.](./media/troubleshoot-windows-stop-error/5.png)

   1. Для виртуальной машины поколения 2 введите следующую команду и запишите идентификатор в списке:
   
      ``
      bcdedit /store <LETTER OF THE EFI SYSTEM PARTITION>:EFI\Microsoft\boot\bcd /enum
      ``
   
   - В команде замените на `<LETTER OF THE EFI SYSTEM PARTITION>` букву системного раздела EFI.
   - Может быть полезно запустить консоль управления дисками, чтобы указать соответствующий системный раздел, помеченный как **системный раздел EFI**.
   - Идентификатор может быть уникальным GUID или **диспетчером загрузки**по умолчанию.

1. Чтобы включить последовательную консоль, выполните следующие команды:

   ```
   bcdedit /store <VOLUME LETTER WHERE THE BCD FOLDER IS>:\boot\bcd /ems {<BOOT LOADER IDENTIFIER>} ON 
   bcdedit /store <VOLUME LETTER WHERE THE BCD FOLDER IS>:\boot\bcd /emssettings EMSPORT:1 EMSBAUDRATE:115200
   ```
   
   - В команде замените на `<VOLUME LETTER WHERE THE BCD FOLDER IS>` букву папки BCD.
   - В команде замените `<BOOT LOADER IDENTIFIER>` идентификатором, найденным на предыдущем шаге.

1. Убедитесь, что размер свободного места на диске ОС превышает объем памяти (ОЗУ) этой виртуальной машины.

   Если места на диске ОС недостаточно, измените расположение для создания файла дампа памяти, указав подключенный к виртуальной машине диск данных, на котором достаточно свободного места. Чтобы изменить расположение, замените **% systemroot%** буквой диска данных, например диском **F:**, в следующих командах.

   Рекомендуемая конфигурация для включения дампа ОС.

   **Загрузите куст реестра с поврежденного диска ОС.**

   ```
   REG LOAD HKLM\BROKENSYSTEM <VOLUME LETTER OF BROKEN OS DISK>:\windows\system32\config\SYSTEM
   ```

   **Включите сбор для ControlSet001.**

   ```
   REG ADD "HKLM\BROKENSYSTEM\ControlSet001\Control\CrashControl" /v CrashDumpEnabled /t REG_DWORD /d 1 /f 
   REG ADD "HKLM\BROKENSYSTEM\ControlSet001\Control\CrashControl" /v DumpFile /t REG_EXPAND_SZ /d "%SystemRoot%\MEMORY.DMP" /f 
   REG ADD "HKLM\BROKENSYSTEM\ControlSet001\Control\CrashControl" /v NMICrashDump /t REG_DWORD /d 1 /f 
   ```

   **Включите сбор для ControlSet002.**

   ```
   REG ADD "HKLM\BROKENSYSTEM\ControlSet002\Control\CrashControl" /v CrashDumpEnabled /t REG_DWORD /d 1 /f 
   REG ADD "HKLM\BROKENSYSTEM\ControlSet002\Control\CrashControl" /v DumpFile /t REG_EXPAND_SZ /d "%SystemRoot%\MEMORY.DMP" /f 
   REG ADD "HKLM\BROKENSYSTEM\ControlSet002\Control\CrashControl" /v NMICrashDump /t REG_DWORD /d 1 /f 
   ```

   **Выгрузите поврежденный диск ОС.**

   ```
   REG UNLOAD HKLM\BROKENSYSTEM
   ```
   
### <a name="rebuild-the-vm"></a>Перестроение виртуальной машины

Чтобы перестроить виртуальную машину, [выполните шаг 5 из списка команд для восстановления виртуальной машины](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/repair-windows-vm-using-azure-virtual-machine-repair-commands#repair-process-example).
