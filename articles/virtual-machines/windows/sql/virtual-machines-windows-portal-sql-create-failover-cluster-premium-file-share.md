---
title: SQL Server FCI с файловым ресурсом уровня "Премиум" — виртуальные машины Azure
description: В этой статье объясняется, как создать экземпляр отказоустойчивого кластера SQL Server с помощью файлового ресурса уровня "Премиум" на виртуальных машинах Azure.
services: virtual-machines
documentationCenter: na
author: MashaMSFT
editor: monicar
tags: azure-service-management
ms.assetid: 9fc761b1-21ad-4d79-bebc-a2f094ec214d
ms.service: virtual-machines-sql
ms.custom: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 10/09/2019
ms.author: mathoma
ms.openlocfilehash: 7676077f0122cb731d2d5d2c7acf78acbd8aa1a7
ms.sourcegitcommit: 76b48a22257a2244024f05eb9fe8aa6182daf7e2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/03/2019
ms.locfileid: "74792194"
---
# <a name="configure-a-sql-server-failover-cluster-instance-with-premium-file-share-on-azure-virtual-machines"></a>Настройка SQL Server экземпляра отказоустойчивого кластера с общей папкой Premium на виртуальных машинах Azure

В этой статье объясняется, как создать SQL Server экземпляр отказоустойчивого кластера (FCI) на виртуальных машинах Azure с помощью [общего файлового ресурса](../../../storage/files/storage-how-to-create-premium-fileshare.md)уровня "Премиум".

Общие файловые ресурсы уровня "Премиум" — это отказоустойчивые файловые ресурсы с низкой задержкой, которые полностью поддерживаются для использования с экземплярами отказоустойчивого кластера для SQL Server 2012 или более поздней версии на Windows Server 2012 или более поздней версии. Файловые ресурсы уровня "Премиум" обеспечивают большую гибкость, позволяя изменять размер и масштабировать общую папку без простоев.


## <a name="before-you-begin"></a>Перед началом работы

Прежде чем начать, необходимо знать несколько моментов.

Вы должны иметь представление об этих технологиях.

- [технологии кластера под управлением Windows](/windows-server/failover-clustering/failover-clustering-overview);
- [Экземпляры отказоустойчивого кластера SQL Server](/sql/sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server)

Следует учитывать, что в отказоустойчивом кластере виртуальной машины Azure IaaS мы рекомендуем использовать по одной сетевой карте на сервер (узел кластера) и одну подсеть. Сеть Azure имеет физическую избыточность, которая делает дополнительные сетевые карты и подсети ненужными в гостевом кластере виртуальной машины Azure IaaS. Отчет о проверке кластера выдаст предупреждение о том, что узлы доступны только в одной сети. Это предупреждение можно игнорировать в отказоустойчивых кластерах виртуальных машин Azure IaaS.

Вы также должны иметь общее представление об этих технологиях:

- [Общая папка Azure Premium](../../../storage/files/storage-how-to-create-premium-fileshare.md)
- [группы ресурсов Azure](../../../azure-resource-manager/manage-resource-groups-portal.md).

> [!IMPORTANT]
> На данный момент SQL Server экземпляры отказоустойчивого кластера на виртуальных машинах Azure поддерживаются только в [режиме упрощенного управления](virtual-machines-windows-sql-register-with-resource-provider.md#management-modes) [расширением агента IaaS SQL Server](virtual-machines-windows-sql-server-agent-extension.md). Чтобы перейти с полного режима расширения на облегченный, удалите ресурс **виртуальной машины SQL** для соответствующих виртуальных машин, а затем зарегистрируйте их с помощью поставщика ресурсов ВИРТУАЛЬНОЙ машины SQL в упрощенном режиме. При удалении ресурса **виртуальной машины SQL** с помощью портал Azure **снимите флажок рядом с соответствующей виртуальной машиной**. Полное расширение поддерживает такие функции, как автоматическое резервное копирование, установка исправлений и Управление порталом. Эти функции не будут работать для виртуальных машин SQL после переустановки агента в режиме упрощенного управления.

Общие файловые ресурсы уровня "Премиум" обеспечивают операции ввода-вывода в секунду и объемы в соответствии с потребностями многих рабочих нагрузок. Для рабочих нагрузок, интенсивно использующих ввод-вывод, рассмотрите возможность [SQL Server экземпляров отказоустойчивого кластера с Локальные дисковые пространства](virtual-machines-windows-portal-sql-create-failover-cluster.md)на основе управляемых дисков уровня "Премиум" или "Ultra".  

Проверьте активность операций ввода-вывода в среде и убедитесь, что файловые ресурсы Premium предоставляют необходимые операции ввода-вывода перед началом развертывания или миграции. Используйте счетчики дисков системного монитора Windows, чтобы отслеживать общее количество операций ввода-вывода (передач на диск в секунду) и пропускную способность (байт в секунду), требуемые для SQL Server файлов данных, журналов и временных БД.

Многие рабочие нагрузки имеют пакетные операции ввода-вывода, поэтому рекомендуется проверять длительные периоды использования и учитывать максимум операций ввода-вывода в секунду и среднее число операций ввода-вывода в секунду. Файловые ресурсы уровня "Премиум" обеспечивают операции ввода-вывода в зависимости от размера общей папки. Общие файловые ресурсы уровня "Премиум" также обеспечивают дополнительный уровень нагрузки, который позволяет ускорить выполнение операций ввода-вывода, чтобы увеличить базовую сумму до одного часа.

Дополнительные сведения о производительности файлового ресурса уровня "Премиум" см. в разделе [уровни производительности](https://docs.microsoft.com/azure/storage/files/storage-files-planning#file-share-performance-tiers)файлового ресурса.

### <a name="licensing-and-pricing"></a>Лицензирование и цены

На виртуальных машинах Azure можно лицензировать SQL Server с помощью образов виртуальных машин с оплатой по мере использования (PAYG) или собственными лицензиями (BYOL). Тип выбранного образа влияет на то, как вы намерены оплатить.

При использовании лицензирования с оплатой по мере использования в экземпляре отказоустойчивого кластера (FCI) SQL Server на виртуальных машинах Azure взимается плата за все узлы FCI, включая пассивные узлы. Дополнительные сведения см. на странице [Цены на виртуальные машины SQL Server Enterprise](https://azure.microsoft.com/pricing/details/virtual-machines/sql-server-enterprise/).

Если у вас Соглашение Enterprise с Software Assurance, для каждого активного узла можно использовать один свободный пассивный узел FCI. Чтобы воспользоваться преимуществами этого преимущества в Azure, используйте образы виртуальных машин BYOL и используйте одну и ту же лицензию как на активном, так и на пассивном узлах FCI. Дополнительные сведения см. в статье о [Соглашении Enterprise](https://www.microsoft.com/Licensing/licensing-programs/enterprise.aspx).

Чтобы сравнить лицензирование с оплатой по мере использования и BYOL для SQL Server на виртуальных машинах Azure, см. статью Приступая к [работе с](virtual-machines-windows-sql-server-iaas-overview.md#get-started-with-sql-vms)виртуальными машинами SQL.

Полные сведения о лицензировании SQL Server см. [на странице с ценами](https://www.microsoft.com/sql-server/sql-server-2017-pricing).

### <a name="filestream"></a>Файловый поток

FILESTREAM не поддерживается для отказоустойчивого кластера с файловым ресурсом уровня "Премиум". Чтобы использовать FILESTREAM, разверните кластер с помощью [Локальные дисковые пространства](virtual-machines-windows-portal-sql-create-failover-cluster.md).

## <a name="prerequisites"></a>Технические условия

Перед выполнением действий, описанных в этой статье, у вас уже должны быть:

- подписка Microsoft Azure;
- домен Windows на виртуальных машинах Azure;
- Учетная запись с разрешениями на создание объектов как на виртуальных машинах Azure, так и в Active Directory.
- Виртуальная сеть и подсеть Azure с достаточным пространством IP-адресов для этих компонентов:
   - Две виртуальные машины.
   - IP-адрес отказоустойчивого кластера;
   - IP-адрес для каждого экземпляра отказоустойчивого кластера;
- DNS, настроенная в сети Azure, указывающая на контроллеры домена.
- [Общая папка](../../../storage/files/storage-how-to-create-premium-fileshare.md) уровня "Премиум" на основе квоты хранилища базы данных для файлов данных.
- Файловый ресурс для резервных копий, который отличается от общего файлового ресурса уровня "Премиум", используемого для файлов данных. Этот файловый ресурс может иметь значение "Стандартный" или "Премиум".

После установки необходимых компонентов можно приступить к созданию отказоустойчивого кластера. Сначала нужно создать виртуальные машины.

## <a name="step-1-create-the-virtual-machines"></a>Шаг 1. Создание виртуальных машин

1. Войдите в [портал Azure](https://portal.azure.com) с помощью своей подписки.

1. [Создайте группу доступности Azure](../tutorial-availability-sets.md).

   Группа доступности группирует виртуальные машины в доменах сбоя и доменах обновления. Это гарантирует, что на ваше приложение не влияют отдельные точки отказа, например сетевой коммутатор или блок питания стойки серверов.

   Если вы еще не создали группу ресурсов для виртуальных машин, сделайте это при создании группы доступности Azure. Если вы используете портал Azure для создания группы доступности, выполните следующие действия.

   1. В портал Azure выберите **создать ресурс** , чтобы открыть Azure Marketplace. Найдите **Группа доступности**.
   1. Выберите группу **доступности**.
   1. Нажмите кнопку **Создать**.
   1. В разделе **Создание группы доступности**укажите следующие значения:
      - **Имя.** Имя группы доступности.
      - **Подписка.** Ваша подписка Azure.
      - **Группа ресурсов**. Если вы хотите использовать существующую группу, щелкните **выбрать существующую** и выберите группу из списка. В противном случае выберите **создать** и введите имя группы.
      - **Расположение.** Задайте расположение, в котором вы планируете создать виртуальные машины.
      - **Домены сбоя**. Используйте значение по умолчанию (**3**).
      - **Домены обновления**: используйте значение по умолчанию (**5**).
   1. Выберите **создать** , чтобы создать группу доступности.

1. Создайте виртуальные машины в группе доступности.

   Подготовьте две виртуальные машины SQL Server в группе доступности Azure. Инструкции см. в статье [Подготовка виртуальной машины SQL Server на портале Azure](virtual-machines-windows-portal-sql-server-provision.md).

   Разместите обе виртуальные машины:

   - В той же группе ресурсов Azure, что и группа доступности.
   - в той же сети, что и контроллер домена;
   - В подсети с достаточным пространством IP-адресов как для виртуальных машин, так и для всех FCI, которые в конечном итоге можно использовать в кластере.
   - в группе доступности Azure.

      >[!IMPORTANT]
      >Вы не можете задать или изменить группу доступности после создания виртуальной машины.

   Выберите образ из Azure Marketplace. Вы можете использовать образ Azure Marketplace, который включает Windows Server и SQL Server, либо использовать один из них, который только содержит Windows Server. Дополнительные сведения см. [в статье Общие сведения о SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-server-iaas-overview.md).

   Официальные SQL Server образы в коллекции Azure включают установленный экземпляр SQL Server, программное обеспечение установки SQL Server и необходимый ключ.

   >[!IMPORTANT]
   > После создания виртуальной машины удалите предварительно установленный автономный экземпляр SQL Server. Вы будете использовать предварительно установленный SQL Server носитель для создания SQL Server FCI после настройки отказоустойчивого кластера и общей папки Premium в качестве хранилища.

   Кроме того, можно использовать образы Azure Marketplace, содержащие только операционную систему. Выберите образ **Windows Server 2016 Datacenter** и установите SQL Server FCI после настройки отказоустойчивого кластера и общей папки Premium в качестве хранилища. Этот образ не содержит SQL Server установочный носитель. Поместите SQL Server установочный носитель в место, где его можно запустить для каждого сервера.

1. После того как Azure создаст виртуальные машины, подключитесь к каждому из них с помощью протокола удаленного рабочего стола.

   При первом подключении к виртуальной машине с помощью протокола удаленного рабочего стола выводится запрос на разрешение обнаружения компьютера в сети. Выберите **Да**.

1. Если вы используете один из образов виртуальных машин на основе SQL Server, удалите экземпляр SQL Server.

   1. В окне **программы и компоненты**щелкните правой кнопкой мыши **Microsoft SQL Server 201_ (64-bit)** и выберите **Удалить/изменить**.
   1. Щелкните **Удалить**.
   1. Выберите экземпляр по умолчанию.
   1. Удалите все компоненты в разделе **Службы ядра СУБД**. Не удаляйте **Общие компоненты**. Вы увидите нечто вроде следующего снимка экрана:

        ![Выбор компонентов](./media/virtual-machines-windows-portal-sql-create-failover-cluster/03-remove-features.png)

   1. Нажмите кнопку **Далее**и выберите **Удалить**.

1. <a name="ports"></a>Откройте порты брандмауэра.

   На каждой виртуальной машине откройте следующие порты в брандмауэре Windows:

   | Цель | TCP-порт | Заметки
   | ------ | ------ | ------
   | SQL Server | 1433 | Обычный порт для экземпляров SQL Server по умолчанию. Если используется образ из коллекции, этот порт будет автоматически открыт.
   | Проверка работоспособности | 59999 | Любой открытый TCP-порт. Позже настройте [проверку работоспособности](#probe) балансировщика нагрузки и кластер для использования этого порта.
   | Файловый ресурс | 445 | Порт, используемый службой файлового ресурса.

1. [Добавьте виртуальные машины в имеющийся домен](virtual-machines-windows-portal-sql-availability-group-prereq.md#joinDomain).

После создания и настройки виртуальных машин можно настроить общую папку Premium.

## <a name="step-2-mount-the-premium-file-share"></a>Шаг 2. Подключение общей папки Premium

1. Войдите в [портал Azure](https://portal.azure.com) и перейдите в свою учетную запись хранения.
1. Перейдите в **файловые ресурсы** в разделе **Файловая служба** и выберите файловый ресурс уровня "Премиум", который вы хотите использовать для хранилища SQL.
1. Выберите **подключить** , чтобы открыть строку подключения для общей папки.
1. Выберите нужную букву диска в раскрывающемся списке, а затем скопируйте оба блока кода в Блокнот.


   :::image type="content" source="media/virtual-machines-windows-portal-sql-create-failover-cluster-premium-file-share/premium-file-storage-commands.png" alt-text="Скопируйте обе команды PowerShell с портала общей папки для подключения":::

1. Используйте RDP для подключения к SQL Server виртуальной машине с учетной записью, которую SQL Server FCI будет использовать для учетной записи службы.
1. Откройте административную консоль командной строки PowerShell.
1. Выполните команды, сохраненные ранее при работе на портале.
1. Перейдите в файловый ресурс с помощью проводника или диалогового окна " **выполнить** " (клавиша Windows + r). Используйте сетевой путь `\\storageaccountname.file.core.windows.net\filesharename`. Например `\\sqlvmstorageaccount.file.core.windows.net\sqlpremiumfileshare`.

1. Создайте по крайней мере одну папку во вновь подключенной общей папке, чтобы поместить файлы данных SQL в.
1. Повторите эти действия на каждой виртуальной машине SQL Server, которая будет участвовать в кластере.

  > [!IMPORTANT]
  > Рассмотрите возможность использования отдельной общей папки для файлов резервных копий, чтобы сохранить операции ввода-вывода в секунду и место, занимаемое этой общей папкой, для файлов данных и журналов. Для файлов резервных копий можно использовать файловый ресурс уровня "Премиум" или "Стандартный".

## <a name="step-3-configure-the-failover-cluster-with-the-file-share"></a>Шаг 3. Настройка отказоустойчивого кластера с общей папкой

Следующим шагом является настройка отказоустойчивого кластера. На этом шаге вы выполните следующие шаги:

1. Добавьте компонент отказоустойчивой кластеризации Windows Server.
1. Проверьте кластер.
1. Создайте отказоустойчивый кластер.
1. Создайте облако-свидетель.


### <a name="add-windows-server-failover-clustering"></a>Добавление отказоустойчивой кластеризации Windows Server

1. Подключитесь к первой виртуальной машине по протоколу RDP, используя учетную запись домена, которая является членом локальных администраторов и имеет разрешение на создание объектов в Active Directory. Используйте эту учетную запись для остальной части конфигурации.

1. [Добавьте отказоустойчивую кластеризацию на каждую виртуальную машину](virtual-machines-windows-portal-sql-availability-group-prereq.md#add-failover-clustering-features-to-both-sql-server-vms).

   Чтобы установить отказоустойчивую кластеризацию из пользовательского интерфейса, выполните следующие действия на обеих виртуальных машинах:
   1. В **Диспетчер сервера**выберите **Управление**, а затем выберите **Добавить роли и компоненты**.
   1. В **мастере добавления ролей и компонентов**выберите **Далее** , пока не появится возможность **выбрать компоненты**.
   1. В окне **Выбор компонентов**выберите **отказоустойчивая кластеризация**. Включите все необходимые компоненты и средства управления. Выберите **Добавить компоненты**.
   1. Нажмите кнопку **Далее**, а затем кнопку **Готово** , чтобы установить компоненты.

   Чтобы установить отказоустойчивую кластеризацию с помощью PowerShell, выполните следующий скрипт из сеанса PowerShell администратора на одной из виртуальных машин:

   ```powershell
   $nodes = ("<node1>","<node2>")
   Invoke-Command  $nodes {Install-WindowsFeature Failover-Clustering -IncludeAllSubFeature -IncludeManagementTools}
   ```

### <a name="validate-the-cluster"></a>Проверка кластера

Проверьте кластер в пользовательском интерфейсе или с помощью PowerShell.

Чтобы проверить кластер с помощью пользовательского интерфейса, выполните следующие действия на одной из виртуальных машин:

1. В разделе **Диспетчер сервера**выберите **Сервис**, а затем выберите **Диспетчер отказоустойчивости кластеров**.
1. В разделе **Диспетчер отказоустойчивости кластеров**выберите **действие**и щелкните **проверить конфигурацию**.
1. Щелкните **Далее**.
1. В разделе **Выбор серверов или кластера**введите имена обеих виртуальных машин.
1. В разделе **Параметры тестирования**выберите **выполнять только выбранные тесты**. Щелкните **Далее**.
1. В разделе **Выбор теста**выберите все тесты, кроме **хранилища** и **Локальные дисковые пространства**, как показано ниже:

   :::image type="content" source="media/virtual-machines-windows-portal-sql-create-failover-cluster-premium-file-share/cluster-validation.png" alt-text="Выберите тесты проверки кластера":::

1. Щелкните **Далее**.
1. В разделе **Подтверждение**нажмите кнопку **Далее**.

**Мастер проверки конфигурации** выполняет проверочные тесты.

Чтобы проверить кластер с помощью PowerShell, выполните следующий скрипт из сеанса PowerShell администратора на одной из виртуальных машин:

   ```powershell
   Test-Cluster –Node ("<node1>","<node2>") –Include "Inventory", "Network", "System Configuration"
   ```

После проверки кластера создайте отказоустойчивый кластер.

### <a name="create-the-failover-cluster"></a>Создание отказоустойчивого кластера

Для создания отказоустойчивого кластера требуется следующее.
- Имена виртуальных машин, которые станут узлами кластера.
- Имя отказоустойчивого кластера.
- IP-адрес отказоустойчивого кластера. Вы можете использовать IP-адрес, который не используется в той же виртуальной сети и подсети Azure, что и узлы кластера.

#### <a name="windows-server-2012-through-windows-server-2016"></a>Windows Server 2012 до Windows Server 2016

Следующий сценарий PowerShell создает отказоустойчивый кластер для Windows Server 2012 с помощью Windows Server 2016. Обновите скрипт, указав имена узлов (имена виртуальных машин) и доступный IP-адрес из виртуальной сети Azure.

```powershell
New-Cluster -Name <FailoverCluster-Name> -Node ("<node1>","<node2>") –StaticAddress <n.n.n.n> -NoStorage
```   

#### <a name="windows-server-2019"></a>Windows Server 2019

Следующий сценарий PowerShell создает отказоустойчивый кластер для Windows Server 2019. Дополнительные сведения см. в разделе [отказоустойчивый кластер: объект сети кластера](https://blogs.windows.com/windowsexperience/2018/08/14/announcing-windows-server-2019-insider-preview-build-17733/#W0YAxO8BfwBRbkzG.97). Обновите скрипт, указав имена узлов (имена виртуальных машин) и доступный IP-адрес из виртуальной сети Azure.

```powershell
New-Cluster -Name <FailoverCluster-Name> -Node ("<node1>","<node2>") –StaticAddress <n.n.n.n> -NoStorage -ManagementPointNetworkType Singleton 
```


### <a name="create-a-cloud-witness"></a>Создание облака-свидетеля

Облачный следящий сервер — это новый тип следящего сервера кворума кластера, который хранится в хранилище BLOB-объектов Azure. Это избавляет от необходимости использовать отдельную виртуальную машину, на которой размещен общий ресурс-свидетель.

1. [Создайте облако-свидетель для отказоустойчивого кластера](https://technet.microsoft.com/windows-server-docs/failover-clustering/deploy-cloud-witness).

1. Создайте контейнер больших двоичных объектов.

1. Сохраните ключи доступа и URL-адрес контейнера.

1. Настройте свидетель кворума отказоустойчивого кластера. См. раздел [Настройка следящего сервера кворума в пользовательском интерфейсе](https://technet.microsoft.com/windows-server-docs/failover-clustering/deploy-cloud-witness#to-configure-cloud-witness-as-a-quorum-witness).


## <a name="step-4-test-cluster-failover"></a>Шаг 4. Тестирование отработки отказа кластера

Тестовая отработка отказа кластера. В **Диспетчер отказоустойчивости кластеров**щелкните правой кнопкой мыши кластер и выберите **Дополнительные действия** > **переместить основной ресурс кластера** > **выберите узел**, а затем выберите другой узел кластера. Переместите основной ресурс кластера на каждый узел кластера, а затем переместите его обратно на основной узел. Если можно успешно переместить кластер на каждый узел, можно приступать к установке SQL Server.  

:::image type="content" source="media/virtual-machines-windows-portal-sql-create-failover-cluster-premium-file-share/test-cluster-failover.png" alt-text="Протестируйте отработку отказа кластера, переместив основной ресурс на другие узлы.":::

## <a name="step-5-create-the-sql-server-fci"></a>Шаг 5. Создание SQL Server FCI

После настройки отказоустойчивого кластера можно создать SQL Server FCI.

1. Подключитесь к первой виртуальной машине по протоколу RDP.

1. В **Диспетчер отказоустойчивости кластеров**убедитесь, что все основные ресурсы кластера находятся на первой виртуальной машине. При необходимости переместите все ресурсы на эту виртуальную машину.

1. Найдите установочный носитель. Если на виртуальной машине используется один из образов Azure Marketplace, носитель находится в папке `C:\SQLServer_<version number>_Full`. Выберите **Установить**.

1. В **центре установки SQL Server**выберите пункт **Установка**.

1. Выберите **новый SQL Server установка отказоустойчивого кластера**. Следуйте указаниям мастера, чтобы установить экземпляр отказоустойчивого кластера SQL Server.

   Каталоги данных FCI должны находиться в общей папке уровня "Премиум". Введите полный путь к общей папке в следующем формате: `\\storageaccountname.file.core.windows.net\filesharename\foldername`. Появится предупреждение о том, что файловый сервер указан в качестве каталога данных. Это предупреждение является ожидаемым. Убедитесь, что учетная запись, в которой хранится файловый ресурс, является той же учетной записью, которую использует служба SQL Server, чтобы избежать возможных сбоев.

   :::image type="content" source="media/virtual-machines-windows-portal-sql-create-failover-cluster-premium-file-share/use-file-share-as-data-directories.png" alt-text="Использование общей папки в качестве каталогов данных SQL":::

1. После выполнения действий, описанных в мастере, программа установки установит SQL Server FCI на первом узле.

1. После того как программа установки установит FCI на первый узел, подключитесь к второму узлу по протоколу RDP.

1. Откройте диалоговое окно **Центр установки SQL Server**. Выберите **Установка**.

1. Выберите **Добавить узел в отказоустойчивый кластер SQL Server**. Следуйте инструкциям мастера, чтобы установить SQL Server и добавить сервер в FCI.

   >[!NOTE]
   >При использовании образа коллекции Azure Marketplace с SQL Server средства SQL Server включаются в образ. Если вы не использовали один из этих образов, установите средства SQL Server отдельно. См. сведения в статье [Скачивание SQL Server Management Studio (SSMS)](https://msdn.microsoft.com/library/mt238290.aspx).

## <a name="step-6-create-the-azure-load-balancer"></a>Шаг 6. Создание балансировщика нагрузки Azure

На виртуальных машинах Azure кластеры используют балансировщик нагрузки для хранения IP-адреса, который должен находиться на одном узле кластера в определенный момент времени. В этом решении балансировщик нагрузки используется для хранения IP-адреса для экземпляра отказоустойчивого кластера SQL Server.

Дополнительные сведения см. в статье [Создание и настройка балансировщика нагрузки Azure](virtual-machines-windows-portal-sql-availability-group-tutorial.md#configure-internal-load-balancer).

### <a name="create-the-load-balancer-in-the-azure-portal"></a>Создание балансировщика нагрузки на портале Azure

Создание балансировщика нагрузки

1. В портал Azure перейдите к группе ресурсов, содержащей виртуальные машины.

1. Выберите **Добавить**. Выполните поиск **Load Balancer**в Azure Marketplace. Выберите **Load Balancer**.

1. Нажмите кнопку **Создать**.

1. Настройте подсистему балансировки нагрузки, используя следующие значения:

   - **Подписка.** Ваша подписка Azure.
   - **Группа ресурсов**. Группа ресурсов, которая содержит виртуальные машины.
   - **Имя.** Имя, определяющее балансировщик нагрузки.
   - **Регион**: расположение Azure, которое содержит ваши виртуальные машины.
   - **Введите**: либо Public, либо Private. Доступ к частной подсистеме балансировки нагрузки можно получить из виртуальной сети. Большинство приложений Azure могут использовать закрытый балансировщик нагрузки. Если приложению требуется доступ к SQL Server напрямую через Интернет, используйте общедоступную подсистему балансировки нагрузки.
   - **SKU**: Стандартный.
   - **Виртуальная сеть**— это та же сеть, что и виртуальные машины.
   - **Назначение IP-адресов**: статическое. 
   - **Частный IP-адрес**: IP-адрес, назначенный сетевому ресурсу кластера SQL Server FCI.

   На следующем рисунке показан пользовательский интерфейс **подсистемы балансировки нагрузки** .

   ![Настройка балансировщика нагрузки](./media/virtual-machines-windows-portal-sql-create-failover-cluster/30-load-balancer-create.png)
   

### <a name="configure-the-load-balancer-backend-pool"></a>Настройка серверного пула балансировщика нагрузки

1. Вернитесь в группу ресурсов Azure, содержащую виртуальные машины, и нахождение новой подсистемы балансировки нагрузки. Возможно, потребуется обновить представление в группе ресурсов. Выберите подсистему балансировки нагрузки.

1. Выберите **серверные пулы**и нажмите кнопку **Добавить**.

1. Свяжите серверный пул с группой доступности, в которую входят виртуальные машины.

1. В разделе **целевые IP-конфигурации сети**выберите **Виртуальная машина** и выберите виртуальные машины, которые будут использоваться в качестве узлов кластера. Не забудьте включить все виртуальные машины, на которых будут размещаться FCI.

1. Нажмите кнопку **ОК** , чтобы создать внутренний пул.

### <a name="configure-a-load-balancer-health-probe"></a>Настройка пробы работоспособности балансировщика нагрузки

1. В колонке балансировщика нагрузки выберите **зонды работоспособности**.

1. Выберите **Добавить**.

1. В колонке **Добавление проверки работоспособности** <a name="probe"> </a>задайте следующие параметры проверки работоспособности.

   - **Имя.** Имя для проверки работоспособности.
   - **Протокол.** TCP.
   - **Порт**. порт, созданный в брандмауэре для проверки работоспособности на [этом шаге](#ports). В этой статье в примере используется TCP-порт `59999`.
   - **Интервал.** 5 секунд.
   - **Порог состояния неработоспособности.** 2 последовательных сбоя.

1. Нажмите кнопку **ОК**.

### <a name="set-load-balancing-rules"></a>Задание правил балансировки нагрузки

1. В колонке балансировщика нагрузки выберите **правила балансировки нагрузки**.

1. Выберите **Добавить**.

1. Задайте параметры правила балансировки нагрузки.

   - **Имя.** Имя для правил балансировки нагрузки.
   - **Интерфейсный IP-адрес**: IP-адрес для сетевого ресурса кластера SQL Server FCI.
   - **Порт**: SQL SERVERный TCP-порт FCI. Порт экземпляра по умолчанию — 1433.
   - **Внутренний порт**: использует тот же порт, что и значение **порта** , при включении **плавающего IP-адреса (прямой возврат сервера)** .
   - **Внутренний пул**. имя серверного пула, настроенного ранее.
   - **Зонд работоспособности**: Проверка работоспособности, настроенная ранее.
   - **Сохранение сеанса.** Нет.
   - **Время ожидания простоя (в минутах)** : 4.
   - **Плавающий IP-адрес (прямой возврат к серверу)** : включен.

1. Нажмите кнопку **ОК**.

## <a name="step-7-configure-the-cluster-for-the-probe"></a>Шаг 7. Настройка кластера для проверки

Задайте параметр порта проверки кластера в PowerShell.

Чтобы задать параметр порта пробы кластера, обновите переменные в следующем скрипте, указав значения из своей среды. Удалите угловые скобки (`<` и `>`) из скрипта.

   ```powershell
   $ClusterNetworkName = "<Cluster Network Name>"
   $IPResourceName = "<SQL Server FCI IP Address Resource Name>" 
   $ILBIP = "<n.n.n.n>" 
   [int]$ProbePort = <nnnnn>

   Import-Module FailoverClusters

   Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ILBIP";"ProbePort"=$ProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}
   ```

В следующем списке описаны значения, которые необходимо обновить.

   - `<Cluster Network Name>`: имя отказоустойчивого кластера Windows Server для сети. В **диспетчер отказоустойчивости кластеров** > **сети**щелкните правой кнопкой мыши сеть и выберите пункт **Свойства**. Правильное значение указано в поле **Имя** на вкладке **Общие**.

   - `<SQL Server FCI IP Address Resource Name>`: имя ресурса IP-адреса SQL Server FCI. В **Диспетчер отказоустойчивости кластеров** роли ** > в**разделе роль SQL Server FCI в разделе **имя сервера**щелкните правой кнопкой мыши ресурс IP-адреса и выберите пункт **Свойства**. Правильное значение указано в поле **Имя** на вкладке **Общие**.

   - `<ILBIP>`: IP-адрес внутренней подсистемы балансировки нагрузки. Этот адрес настраивается на портале Azure в качестве интерфейсного адреса внутренней подсистемы балансировки нагрузки. Это также IP-адрес экземпляра отказоустойчивого кластера SQL Server. Его можно найти в окне **Диспетчер отказоустойчивости кластеров** на той же странице свойств, где указано значение `<SQL Server FCI IP Address Resource Name>`.  

   - `<nnnnn>`: порт пробы, настроенный в зонде работоспособности балансировщика нагрузки. Допускается любой неиспользуемый TCP-порт.

>[!IMPORTANT]
>Маска подсети для параметра кластера должна быть широковещательным адресом TCP IP: `255.255.255.255`.

После настройки проверки кластера можно просмотреть все параметры кластера в PowerShell. Выполните следующий сценарий:

   ```powershell
   Get-ClusterResource $IPResourceName | Get-ClusterParameter
  ```

## <a name="step-8-test-fci-failover"></a>Шаг 8. Проверка отработки отказа FCI

Проверьте отработку отказа экземпляра отказоустойчивого кластера, чтобы проверить функциональные возможности кластера. Сделайте следующее:

1. Подключитесь к одному из узлов кластера SQL Server FCI с помощью RDP.

1. Откройте **диспетчер отказоустойчивости кластеров**. Выберите **Роли**. Обратите внимание, какой узел является владельцем роли SQL Server FCI.

1. Щелкните правой кнопкой мыши роль SQL Server FCI.

1. Щелкните **переместить**, а затем выберите **лучший из возможных узлов**.

**Диспетчер отказоустойчивости кластеров** показывает роль, а ее ресурсы переходят в режим «вне сети». Затем ресурсы перемещаются и возвращаются в оперативный режим в другом узле.

### <a name="test-connectivity"></a>Проверка подключения

Чтобы проверить возможность подключения, войдите на другую виртуальную машину в той же виртуальной сети. Откройте **SQL Server Management Studio** и подключитесь к экземпляру отказоустойчивого кластера SQL Server.

>[!NOTE]
>При необходимости можно [скачать SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).

## <a name="limitations"></a>Ограничения

Виртуальные машины Azure поддерживают Microsoft координатор распределенных транзакций (MSDTC) в Windows Server 2019 с хранилищем на кластеризованных общих томах (CSV) и [стандартном подсистеме балансировки нагрузки](../../../load-balancer/load-balancer-standard-overview.md).

На виртуальных машинах Azure MSDTC не поддерживается в Windows Server 2016 или более ранних версиях, так как:

- Кластеризованный ресурс MSDTC не может быть настроен для использования общего хранилища. В Windows Server 2016 при создании ресурса MSDTC он не будет отображать доступное для использования общее хранилище, даже если хранилище доступно. Эта проблема устранена в Windows Server 2019.
- Базовая подсистема балансировки нагрузки не обрабатывает порты RPC.

## <a name="see-also"></a>Дополнительные материалы

- [технологии кластера под управлением Windows](/windows-server/failover-clustering/failover-clustering-overview);
- [Экземпляры отказоустойчивого кластера SQL Server](/sql/sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server)
