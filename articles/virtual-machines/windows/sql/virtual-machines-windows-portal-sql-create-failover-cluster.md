---
title: Экземпляр отказоустойчивого кластера SQL Server на виртуальных машинах Azure | Документация Майкрософт
description: В этой статье объясняется, как создать экземпляр отказоустойчивого кластера SQL Server на виртуальных машинах Azure.
services: virtual-machines
documentationCenter: na
author: MikeRayMSFT
manager: craigg
editor: monicar
tags: azure-service-management
ms.assetid: 9fc761b1-21ad-4d79-bebc-a2f094ec214d
ms.service: virtual-machines-sql
ms.custom: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 06/11/2018
ms.author: mikeray
ms.openlocfilehash: 1a69741ba3ced91b6b0d1fc4bcd4aea887452151
ms.sourcegitcommit: 76b48a22257a2244024f05eb9fe8aa6182daf7e2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/03/2019
ms.locfileid: "74792180"
---
# <a name="configure-a-sql-server-failover-cluster-instance-on-azure-virtual-machines"></a>Настройка SQL Server экземпляра отказоустойчивого кластера на виртуальных машинах Azure

В этой статье объясняется, как создать SQL Server экземпляр отказоустойчивого кластера (FCI) на виртуальных машинах Azure в модели Azure Resource Manager. Это решение использует [Windows Server 2016 Datacenter edition Локальные дисковые пространства](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/storage-spaces-direct-overview) как ВИРТУАЛЬНУЮ сеть SAN на основе программного обеспечения, которая синхронизирует хранилище (диски данных) между узлами (ВМ Azure) в кластере Windows. Новые Локальные дисковые пространства в Windows Server 2016.

На следующей схеме показано полное решение на виртуальных машинах Azure.

![Полное решение](./media/virtual-machines-windows-portal-sql-create-failover-cluster/00-sql-fci-s2d-complete-solution.png)

На этой схеме показано следующее:

- Две виртуальные машины Azure в отказоустойчивом кластере Windows Server. Если виртуальная машина находится в отказоустойчивом кластере, она также называется узлом или *узлом* *кластера* .
- В каждой виртуальной машине есть два или больше дисков данных.
- Локальные дисковые пространства синхронизирует данные на дисках данных и представляет синхронизированное хранилище в качестве пула носителей.
- Пул носителей представляет общий том кластера (CSV) в отказоустойчивый кластер.
- Роль экземпляра кластера SQL Server FCI использует CSV для дисков данных.
- Azure Load Balancer для хранения IP-адреса для экземпляра отказоустойчивого кластера SQL Server.
- В группе доступности Azure хранятся все ресурсы.

>[!NOTE]
>Все ресурсы Azure на схеме находятся в одной группе ресурсов.

Дополнительные сведения о Локальные дисковые пространства см. в статье [Windows Server 2016 Datacenter edition Локальные дисковые пространства](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/storage-spaces-direct-overview).

Локальные дисковые пространства поддерживает архитектуры двух типов: конвергенции и технологии Hyper-in. В этом документе используется гиперконвергентная архитектура. Гиперконвергентная инфраструктура размещает хранилище на тех же серверах, на которых размещено кластеризованное приложение. В этой архитектуре хранилище находится на каждом узле экземпляра отказоустойчивого кластера SQL Server.

## <a name="licensing-and-pricing"></a>Лицензирование и цены

На виртуальных машинах Azure можно лицензировать SQL Server с помощью образов виртуальных машин с оплатой по мере использования (PAYG) или собственными лицензиями (BYOL). Тип выбранного образа влияет на то, как вы намерены оплатить.

При использовании лицензирования с оплатой по мере использования в экземпляре отказоустойчивого кластера (FCI) SQL Server на виртуальных машинах Azure взимается плата за все узлы FCI, включая пассивные узлы. Дополнительные сведения см. на странице [Цены на виртуальные машины SQL Server Enterprise](https://azure.microsoft.com/pricing/details/virtual-machines/sql-server-enterprise/).

Если у вас Соглашение Enterprise с Software Assurance, для каждого активного узла можно использовать один свободный пассивный узел FCI. Чтобы воспользоваться преимуществами этого преимущества в Azure, используйте образы виртуальных машин BYOL и используйте одну и ту же лицензию как на активном, так и на пассивном узлах FCI. Дополнительные сведения см. в статье о [Соглашении Enterprise](https://www.microsoft.com/Licensing/licensing-programs/enterprise.aspx).

Чтобы сравнить лицензирование с оплатой по мере использования и BYOL для SQL Server на виртуальных машинах Azure, см. статью Приступая к [работе с](virtual-machines-windows-sql-server-iaas-overview.md#get-started-with-sql-vms)виртуальными машинами SQL.

Полные сведения о лицензировании SQL Server см. [на странице с ценами](https://www.microsoft.com/sql-server/sql-server-2017-pricing).

### <a name="example-azure-template"></a>Пример шаблона Azure

Вы можете создать все это решение в Azure на основе шаблона. Пример шаблона доступен в [шаблонах быстрого запуска Azure](https://github.com/MSBrett/azure-quickstart-templates/tree/master/sql-server-2016-fci-existing-vnet-and-ad) на GitHub. Этот пример не предназначен для определенной рабочей нагрузки или протестирован. Вы можете запустить шаблон, чтобы создать SQL Server FCI с Локальные дисковые пространстваным хранилищем, подключенным к домену. Вы можете оценить шаблон и изменить его в целях.

## <a name="before-you-begin"></a>Перед началом работы

Прежде чем начать, необходимо знать несколько моментов.

### <a name="what-to-know"></a>Необходимые знания
Вы должны иметь представление об этих технологиях.

- [технологии кластера под управлением Windows](https://docs.microsoft.com/windows-server/failover-clustering/failover-clustering-overview);
- [Экземпляры отказоустойчивого кластера SQL Server](https://docs.microsoft.com/sql/sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server)

Следует учитывать, что в гостевом отказоустойчивом кластере виртуальной машины Azure IaaS мы рекомендуем использовать по одной сетевой карте на сервер (узел кластера) и одну подсеть. Сеть Azure имеет физическую избыточность, что делает дополнительные сетевые карты и подсети ненужными в гостевом кластере виртуальной машины Azure IaaS. Отчет о проверке кластера выдаст предупреждение о том, что узлы доступны только в одной сети. Это предупреждение можно игнорировать в гостевых отказоустойчивых кластерах виртуальных машин Azure IaaS.

Вы также должны иметь общее представление об этих технологиях:

- [Решения с технологией Hyper-Solutions, использующие Локальные дисковые пространства в Windows Server 2016](https://docs.microsoft.com/windows-server/storage/storage-spaces/storage-spaces-direct-overview)
- [группы ресурсов Azure](../../../azure-resource-manager/manage-resource-groups-portal.md).

> [!IMPORTANT]
> На данный момент SQL Server экземпляры отказоустойчивого кластера на виртуальных машинах Azure поддерживаются только в [режиме упрощенного управления](virtual-machines-windows-sql-register-with-resource-provider.md#management-modes) [расширением агента IaaS SQL Server](virtual-machines-windows-sql-server-agent-extension.md). Чтобы перейти с полного режима расширения на облегченный, удалите ресурс **виртуальной машины SQL** для соответствующих виртуальных машин, а затем зарегистрируйте их с помощью поставщика ресурсов ВИРТУАЛЬНОЙ машины SQL в упрощенном режиме. При удалении ресурса **виртуальной машины SQL** с помощью портал Azure **снимите флажок рядом с соответствующей виртуальной машиной**. Полное расширение поддерживает такие функции, как автоматическое резервное копирование, установка исправлений и Управление порталом. Эти функции не будут работать для виртуальных машин SQL после переустановки агента в режиме упрощенного управления.

### <a name="what-to-have"></a>Необходимые компоненты

Перед выполнением действий, описанных в этой статье, у вас уже должны быть:

- подписка Microsoft Azure;
- домен Windows на виртуальных машинах Azure;
- Учетная запись с разрешениями на создание объектов как на виртуальных машинах Azure, так и в Active Directory.
- Виртуальная сеть и подсеть Azure с достаточным пространством IP-адресов для этих компонентов:
   - обе виртуальные машины;
   - IP-адрес отказоустойчивого кластера;
   - IP-адрес для каждого экземпляра отказоустойчивого кластера;
- DNS, настроенная в сети Azure, указывающая на контроллеры домена.

После установки необходимых компонентов можно приступить к созданию отказоустойчивого кластера. Сначала нужно создать виртуальные машины.

## <a name="step-1-create-the-virtual-machines"></a>Шаг 1. Создание виртуальных машин

1. Войдите в [портал Azure](https://portal.azure.com) с помощью своей подписки.

1. [Создайте группу доступности Azure](../tutorial-availability-sets.md).

   Группа доступности группирует виртуальные машины в доменах сбоя и доменах обновления. Это гарантирует, что на ваше приложение не влияют отдельные точки отказа, например сетевой коммутатор или блок питания стойки серверов.

   Если вы еще не создали группу ресурсов для виртуальных машин, сделайте это при создании группы доступности Azure. Если вы используете портал Azure для создания группы доступности, выполните следующие действия.

   1. В портал Azure выберите **создать ресурс** , чтобы открыть Azure Marketplace. Найдите **Группа доступности**.
   1. Выберите группу **доступности**.
   1. Нажмите кнопку **Создать**.
   1. В разделе **Создание группы доступности**укажите следующие значения:
      - **Имя.** Имя группы доступности.
      - **Подписка.** Ваша подписка Azure.
      - **Группа ресурсов**. Если вы хотите использовать существующую группу, щелкните **выбрать существующую** и выберите группу из списка. В противном случае выберите **создать** и введите имя группы.
      - **Расположение.** Задайте расположение, в котором вы планируете создать виртуальные машины.
      - **Домены сбоя**. Используйте значение по умолчанию (**3**).
      - **Домены обновления**: используйте значение по умолчанию (**5**).
   1. Выберите **создать** , чтобы создать группу доступности.

1. Создайте виртуальные машины в группе доступности.

   Подготовьте две виртуальные машины SQL Server в группе доступности Azure. Инструкции см. в статье [Подготовка виртуальной машины SQL Server на портале Azure](virtual-machines-windows-portal-sql-server-provision.md).

   Разместите обе виртуальные машины:

   - В той же группе ресурсов Azure, что и группа доступности.
   - в той же сети, что и контроллер домена;
   - В подсети с достаточным пространством IP-адресов для виртуальных машин и всех FCI, которые в конечном итоге можно использовать в кластере.
   - в группе доступности Azure.

      >[!IMPORTANT]
      >Вы не можете задать или изменить группу доступности после создания виртуальной машины.

   Выберите образ из Azure Marketplace. Вы можете использовать образ Azure Marketplace, который включает Windows Server и SQL Server, либо использовать один из них, который только содержит Windows Server. Дополнительные сведения см. [в статье Общие сведения о SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-server-iaas-overview.md).

   Официальные SQL Server образы в коллекции Azure включают установленный экземпляр SQL Server, программное обеспечение установки SQL Server и необходимый ключ.

   Выберите правильное изображение в зависимости от того, как вы хотите платить за лицензию на SQL Server:

   - **Лицензирование по оплате за использование**. Посекундная оплата этих образов доступна в таких лицензиях SQL Server:
      - **SQL Server 2016 Enterprise в Windows Server 2016 Datacenter**
      - **SQL Server 2016 Standard в Windows Server 2016 Datacenter**
      - **SQL Server 2016 Developer в Windows Server 2016 Datacenter**

   - **BYOL (с использованием собственной лицензии)** :

      - **BYOL SQL Server 2016 Enterprise в Windows Server 2016 Datacenter**
      - **BYOL SQL Server 2016 Standard в Windows Server 2016 Datacenter**

   >[!IMPORTANT]
   >После создания виртуальной машины удалите предварительно установленный автономный экземпляр SQL Server. Вы будете использовать предварительно установленный SQL Server носитель для создания SQL Server FCI после настройки отказоустойчивого кластера и Локальные дисковые пространства.

   Кроме того, можно использовать образы Azure Marketplace, содержащие только операционную систему. Выберите образ **Windows Server 2016 Datacenter** и установите SQL Server FCI после настройки отказоустойчивого кластера и Локальные дисковые пространства. Этот образ не содержит SQL Server установочный носитель. Поместите SQL Server установочный носитель в место, где его можно запустить для каждого сервера.

1. После того как Azure создаст виртуальные машины, подключитесь к каждому из них с помощью протокола удаленного рабочего стола.

   При первом подключении к виртуальной машине с помощью протокола удаленного рабочего стола выводится запрос на разрешение обнаружения компьютера в сети. Выберите **Да**.

1. Если вы используете один из образов виртуальных машин на основе SQL Server, удалите экземпляр SQL Server.

   1. В окне **программы и компоненты**щелкните правой кнопкой мыши **Microsoft SQL Server 2016 (64-бит)** и выберите **Удалить/изменить**.
   1. Щелкните **Удалить**.
   1. Выберите экземпляр по умолчанию.
   1. Удалите все компоненты в разделе **Службы ядра СУБД**. Не удаляйте **Общие компоненты**. Вы увидите нечто вроде следующего снимка экрана:

      ![Выбор компонентов](./media/virtual-machines-windows-portal-sql-create-failover-cluster/03-remove-features.png)

   1. Нажмите кнопку **Далее**и выберите **Удалить**.

1. <a name="ports"></a>Откройте порты брандмауэра.

   На каждой виртуальной машине откройте следующие порты в брандмауэре Windows:

   | Цель | TCP-порт | Заметки
   | ------ | ------ | ------
   | SQL Server | 1433 | Обычный порт для экземпляров SQL Server по умолчанию. Если используется образ из коллекции, этот порт будет автоматически открыт.
   | Проверка работоспособности | 59999 | Любой открытый TCP-порт. Позже настройте [проверку работоспособности](#probe) балансировщика нагрузки и кластер для использования этого порта.  

1. Добавьте хранилище в виртуальную машину. Дополнительные сведения см. в статье [Хранилище класса "Премиум": высокопроизводительная служба хранилища для рабочих нагрузок виртуальных машин Azure](../disks-types.md).

   Для обеих виртуальных машин необходимо по крайней мере два диска данных.

   Присоедините необработанные диски, а не диски в формате NTFS.
      >[!NOTE]
      >При подключении дисков в формате NTFS можно включить Локальные дисковые пространства только без проверки допустимости диска.  

   Подключите как минимум два SSD (цен. категория "Премиум") к каждой виртуальной машине. Рекомендуется по крайней мере P30 дисков (1 ТБ).

   Для кэширования узла задайте значение **Только для чтения**.

   Емкость хранилища, используемого в рабочих средах, зависит от рабочей нагрузки. Значения, описанные в этой статье, предназначены для демонстрации и тестирования.

1. [Добавьте виртуальные машины в имеющийся домен](virtual-machines-windows-portal-sql-availability-group-prereq.md#joinDomain).

После создания и настройки виртуальных машин можно настроить отказоустойчивый кластер.

## <a name="step-2-configure-the-windows-server-failover-cluster-with-storage-spaces-direct"></a>Шаг 2. Настройка отказоустойчивого кластера Windows Server с Локальные дисковые пространства

Следующим шагом является настройка отказоустойчивого кластера с Локальные дисковые пространства. На этом шаге вы выполните следующие шаги:

1. Добавьте компонент отказоустойчивой кластеризации Windows Server.
1. Проверьте кластер.
1. Создайте отказоустойчивый кластер.
1. Создайте облако-свидетель.
1. Добавить хранилище.

### <a name="add-windows-server-failover-clustering"></a>Добавление отказоустойчивой кластеризации Windows Server

1. Подключитесь к первой виртуальной машине по протоколу RDP, используя учетную запись домена, которая является членом локальных администраторов и имеет разрешение на создание объектов в Active Directory. Используйте эту учетную запись для остальной части конфигурации.

1. [Добавьте отказоустойчивую кластеризацию на каждую виртуальную машину](virtual-machines-windows-portal-sql-availability-group-prereq.md#add-failover-clustering-features-to-both-sql-server-vms).

   Чтобы установить отказоустойчивую кластеризацию из пользовательского интерфейса, выполните следующие действия на обеих виртуальных машинах:
   1. В **Диспетчер сервера**выберите **Управление**, а затем выберите **Добавить роли и компоненты**.
   1. В **мастере добавления ролей и компонентов**выберите **Далее** , пока не появится возможность **выбрать компоненты**.
   1. В окне **Выбор компонентов**выберите **отказоустойчивая кластеризация**. Включите все необходимые компоненты и средства управления. Выберите **Добавить компоненты**.
   1. Нажмите кнопку **Далее**, а затем кнопку **Готово** , чтобы установить компоненты.

   Чтобы установить отказоустойчивую кластеризацию с помощью PowerShell, выполните следующий скрипт из сеанса PowerShell администратора на одной из виртуальных машин:

   ```powershell
   $nodes = ("<node1>","<node2>")
   Invoke-Command  $nodes {Install-WindowsFeature Failover-Clustering -IncludeAllSubFeature -IncludeManagementTools}
   ```

Дополнительные справочные сведения о дальнейших действиях см. в разделе Шаг 3 [решения Hyper-схождения с использованием Локальные дисковые пространства в Windows Server 2016](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/hyper-converged-solution-using-storage-spaces-direct#step-3-configure-storage-spaces-direct).

### <a name="validate-the-cluster"></a>Проверка кластера

Проверьте кластер в пользовательском интерфейсе или с помощью PowerShell.

Чтобы проверить кластер с помощью пользовательского интерфейса, выполните следующие действия на одной из виртуальных машин:

1. В разделе **Диспетчер сервера**выберите **Сервис**, а затем выберите **Диспетчер отказоустойчивости кластеров**.
1. В разделе **Диспетчер отказоустойчивости кластеров**выберите **действие**и щелкните **проверить конфигурацию**.
1. Щелкните **Далее**.
1. В разделе **Выбор серверов или кластера**введите имена обеих виртуальных машин.
1. В разделе **Параметры тестирования**выберите **выполнять только выбранные тесты**. Щелкните **Далее**.
1. В разделе **Выбор теста**выберите все тесты, кроме **хранилища**, как показано ниже:

   ![Выберите тесты проверки кластера](./media/virtual-machines-windows-portal-sql-create-failover-cluster/10-validate-cluster-test.png)

1. Щелкните **Далее**.
1. В разделе **Подтверждение**нажмите кнопку **Далее**.

Мастер проверки конфигурации выполняет проверочные тесты.

Чтобы проверить кластер с помощью PowerShell, выполните следующий скрипт из сеанса PowerShell администратора на одной из виртуальных машин:

   ```powershell
   Test-Cluster –Node ("<node1>","<node2>") –Include "Storage Spaces Direct", "Inventory", "Network", "System Configuration"
   ```

После проверки кластера создайте отказоустойчивый кластер.

### <a name="create-the-failover-cluster"></a>Создание отказоустойчивого кластера

Для создания отказоустойчивого кластера требуется следующее.
- Имена виртуальных машин, которые станут узлами кластера.
- Имя отказоустойчивого кластера.
- IP-адрес отказоустойчивого кластера. Вы можете использовать IP-адрес, который не используется в той же виртуальной сети и подсети Azure, что и узлы кластера.

#### <a name="windows-server-2008-through-windows-server-2016"></a>Windows Server 2008 до Windows Server 2016

Следующий сценарий PowerShell создает отказоустойчивый кластер для Windows Server 2008 с помощью Windows Server 2016. Обновите скрипт, указав имена узлов (имена виртуальных машин) и доступный IP-адрес из виртуальной сети Azure.

```powershell
New-Cluster -Name <FailoverCluster-Name> -Node ("<node1>","<node2>") –StaticAddress <n.n.n.n> -NoStorage
```   

#### <a name="windows-server-2019"></a>Windows Server 2019

Следующий сценарий PowerShell создает отказоустойчивый кластер для Windows Server 2019. Дополнительные сведения см. в разделе [отказоустойчивый кластер: объект сети кластера](https://blogs.windows.com/windowsexperience/2018/08/14/announcing-windows-server-2019-insider-preview-build-17733/#W0YAxO8BfwBRbkzG.97). Обновите скрипт, указав имена узлов (имена виртуальных машин) и доступный IP-адрес из виртуальной сети Azure.

```powershell
New-Cluster -Name <FailoverCluster-Name> -Node ("<node1>","<node2>") –StaticAddress <n.n.n.n> -NoStorage -ManagementPointNetworkType Singleton 
```


### <a name="create-a-cloud-witness"></a>Создание облака-свидетеля

Облачный следящий сервер — это новый тип следящего сервера кворума кластера, который хранится в хранилище BLOB-объектов Azure. Это избавляет от необходимости использовать отдельную виртуальную машину, на которой размещен общий ресурс-свидетель.

1. [Создайте облако-свидетель для отказоустойчивого кластера](https://technet.microsoft.com/windows-server-docs/failover-clustering/deploy-cloud-witness).

1. Создайте контейнер больших двоичных объектов.

1. Сохраните ключи доступа и URL-адрес контейнера.

1. Настройте свидетель кворума отказоустойчивого кластера. См. раздел [Настройка следящего сервера кворума в пользовательском интерфейсе](https://technet.microsoft.com/windows-server-docs/failover-clustering/deploy-cloud-witness#to-configure-cloud-witness-as-a-quorum-witness).

### <a name="add-storage"></a>Добавление хранилища.

Диски для Локальные дисковые пространства должны быть пустыми. Они не могут содержать разделы или другие данные. Чтобы очистить диски, выполните [действия, описанные в этом руководстве](https://docs.microsoft.com/windows-server/storage/storage-spaces/deploy-storage-spaces-direct?redirectedfrom=MSDN#step-31-clean-drives).

1. [Включение локальных дисковых пространств](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/hyper-converged-solution-using-storage-spaces-direct#step-35-enable-storage-spaces-direct).

   Следующий скрипт PowerShell включает Локальные дисковые пространства:  

   ```powershell
   Enable-ClusterS2D
   ```

   В **диспетчере отказоустойчивости кластеров** теперь отображается пул носителей.

1. [Создайте том](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/hyper-converged-solution-using-storage-spaces-direct#step-36-create-volumes).

   Локальные дисковые пространства автоматически создает пул носителей при его включении. Теперь все готово для создания тома. Командлет PowerShell `New-Volume` автоматизирует процесс создания тома. Этот процесс включает форматирование, добавление тома в кластер и создание общий том кластера (CSV). В этом примере создается CSV-файл размером 800 ГБ.

   ```powershell
   New-Volume -StoragePoolFriendlyName S2D* -FriendlyName VDisk01 -FileSystem CSVFS_REFS -Size 800GB
   ```   

   После выполнения этой команды том 800 ГБ монтируется в качестве ресурса кластера. Том находится в папке `C:\ClusterStorage\Volume1\`.

   На этом снимке экрана показан общий том кластера с Локальные дисковые пространства:

   ![общий том кластера](./media/virtual-machines-windows-portal-sql-create-failover-cluster/15-cluster-shared-volume.png)

## <a name="step-3-test-failover-cluster-failover"></a>Шаг 3. Тестирование отработки отказа отказоустойчивого кластера

В **Диспетчер отказоустойчивости кластеров**убедитесь, что ресурс хранилища можно переместить на другой узел кластера. Если вы можете подключиться к отказоустойчивому кластеру с помощью **Диспетчер отказоустойчивости кластеров** и переместить хранилище с одного узла на другой, можно приступить к настройке FCI.

## <a name="step-4-create-the-sql-server-fci"></a>Шаг 4. Создание SQL Server FCI

После настройки отказоустойчивого кластера и всех компонентов кластера, включая хранилище, можно создать SQL Server FCI.

1. Подключитесь к первой виртуальной машине по протоколу RDP.

1. В **Диспетчер отказоустойчивости кластеров**убедитесь, что все основные ресурсы кластера находятся на первой виртуальной машине. При необходимости переместите все ресурсы на эту виртуальную машину.

1. Найдите установочный носитель. Если на виртуальной машине используется один из образов Azure Marketplace, носитель находится в папке `C:\SQLServer_<version number>_Full`. Выберите **Установить**.

1. В **центре установки SQL Server**выберите пункт **Установка**.

1. Выберите **новый SQL Server установка отказоустойчивого кластера**. Следуйте указаниям мастера, чтобы установить экземпляр отказоустойчивого кластера SQL Server.

   Каталоги данных экземпляра отказоустойчивого кластера должны находиться в кластеризованном хранилище. В Локальные дисковые пространства это не общий диск, а точка подключения к тому на каждом сервере. Локальные дисковые пространства синхронизирует том между обоими узлами. Том будет представлен кластеру в качестве общий том кластера. Используйте точки подключения CSV для каталогов данных.

   ![Каталоги данных](./media/virtual-machines-windows-portal-sql-create-failover-cluster/20-data-dicrectories.png)

1. После выполнения инструкций в мастере программа установки установит SQL Server FCI на первом узле.

1. После того как программа установки установит FCI на первый узел, подключитесь к второму узлу по протоколу RDP.

1. Откройте диалоговое окно **Центр установки SQL Server**. Выберите **Установка**.

1. Выберите **Добавить узел в отказоустойчивый кластер SQL Server**. Следуйте инструкциям мастера, чтобы установить SQL Server и добавить сервер в FCI.

   >[!NOTE]
   >Если вы использовали образ коллекции Azure Marketplace, содержащий SQL Server, SQL Server средства были включены в образ. Если вы не использовали один из этих образов, установите средства SQL Server отдельно. См. сведения в статье [Скачивание SQL Server Management Studio (SSMS)](https://msdn.microsoft.com/library/mt238290.aspx).

## <a name="step-5-create-the-azure-load-balancer"></a>Шаг 5. Создание балансировщика нагрузки Azure

На виртуальных машинах Azure кластеры используют балансировщик нагрузки для хранения IP-адреса, который должен находиться на одном узле кластера в определенный момент времени. В этом решении балансировщик нагрузки используется для хранения IP-адреса для экземпляра отказоустойчивого кластера SQL Server.

Дополнительные сведения см. в статье [Создание и настройка балансировщика нагрузки Azure](virtual-machines-windows-portal-sql-availability-group-tutorial.md#configure-internal-load-balancer).

### <a name="create-the-load-balancer-in-the-azure-portal"></a>Создание балансировщика нагрузки на портале Azure

Создание балансировщика нагрузки

1. В портал Azure перейдите к группе ресурсов, содержащей виртуальные машины.

1. Выберите **Добавить**. Выполните поиск **Load Balancer**в Azure Marketplace. Выберите **Load Balancer**.

1. Нажмите кнопку **Создать**.

1. Настройте для балансировщика нагрузки следующие параметры.

   - **Подписка.** Ваша подписка Azure.
   - **Группа ресурсов**. Группа ресурсов, которая содержит виртуальные машины.
   - **Имя.** Имя, определяющее балансировщик нагрузки.
   - **Регион**: расположение Azure, которое содержит ваши виртуальные машины.
   - **Введите**: либо Public, либо Private. Доступ к частной подсистеме балансировки нагрузки можно получить из виртуальной сети. Большинство приложений Azure могут использовать закрытый балансировщик нагрузки. Если приложению требуется доступ к SQL Server напрямую через Интернет, используйте общедоступную подсистему балансировки нагрузки.
   - **SKU**: Стандартный.
   - **Виртуальная сеть**— это та же сеть, что и виртуальные машины.
   - **Назначение IP-адресов**: статическое. 
   - **Частный IP-адрес**: IP-адрес, назначенный сетевому ресурсу кластера SQL Server FCI.

 На следующем снимке экрана показан пользовательский интерфейс **подсистемы балансировки нагрузки** .

   ![Настройка балансировщика нагрузки](./media/virtual-machines-windows-portal-sql-create-failover-cluster/30-load-balancer-create.png)

### <a name="configure-the-load-balancer-backend-pool"></a>Настройка серверного пула балансировщика нагрузки

1. Вернитесь в группу ресурсов Azure, содержащую виртуальные машины, и нахождение новой подсистемы балансировки нагрузки. Возможно, потребуется обновить представление в группе ресурсов. Выберите подсистему балансировки нагрузки.

1. Выберите **серверные пулы**и нажмите кнопку **Добавить**.

1. Свяжите серверный пул с группой доступности, в которую входят виртуальные машины.

1. В разделе **целевые IP-конфигурации сети**выберите **Виртуальная машина** и выберите виртуальные машины, которые будут использоваться в качестве узлов кластера. Не забудьте включить все виртуальные машины, на которых будут размещаться FCI.

1. Нажмите кнопку **ОК** , чтобы создать внутренний пул.

### <a name="configure-a-load-balancer-health-probe"></a>Настройка пробы работоспособности балансировщика нагрузки

1. В колонке балансировщика нагрузки выберите **зонды работоспособности**.

1. Выберите **Добавить**.

1. В колонке **Добавление проверки работоспособности** <a name="probe"> </a>задайте параметры проверки работоспособности.

   - **Имя.** Имя для проверки работоспособности.
   - **Протокол.** TCP.
   - **Порт**: укажите порт, созданный в брандмауэре для проверки работоспособности на [этом шаге](#ports). В этой статье в примере используется TCP-порт `59999`.
   - **Интервал.** 5 секунд.
   - **Порог состояния неработоспособности.** 2 последовательных сбоя.

1. Нажмите кнопку **ОК**.

### <a name="set-load-balancing-rules"></a>Задание правил балансировки нагрузки

1. В колонке балансировщика нагрузки выберите **правила балансировки нагрузки**.

1. Выберите **Добавить**.

1. Задайте параметры правила балансировки нагрузки.

   - **Имя.** Имя для правил балансировки нагрузки.
   - **Интерфейсный IP-адрес**: IP-адрес для сетевого ресурса кластера SQL Server FCI.
   - **Порт**: SQL SERVERный TCP-порт FCI. Порт экземпляра по умолчанию — 1433.
   - **Внутренний порт**: использует тот же порт, что и значение **порта** , при включении **плавающего IP-адреса (прямой возврат сервера)** .
   - **Внутренний пул**. имя серверного пула, настроенного ранее.
   - **Зонд работоспособности**: Проверка работоспособности, настроенная ранее.
   - **Сохранение сеанса.** Нет.
   - **Время ожидания простоя (в минутах)** : 4.
   - **Плавающий IP-адрес (прямой возврат к серверу)** : включен.

1. Нажмите кнопку **ОК**.

## <a name="step-6-configure-the-cluster-for-the-probe"></a>Шаг 6. Настройка кластера для проверки

Задайте параметр порта проверки кластера в PowerShell.

Чтобы задать параметр порта пробы кластера, обновите переменные в следующем скрипте, указав значения из своей среды. Удалите угловые скобки (`<` и `>`) из скрипта.

   ```powershell
   $ClusterNetworkName = "<Cluster Network Name>"
   $IPResourceName = "<SQL Server FCI IP Address Resource Name>" 
   $ILBIP = "<n.n.n.n>" 
   [int]$ProbePort = <nnnnn>

   Import-Module FailoverClusters

   Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ILBIP";"ProbePort"=$ProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}
   ```

В следующем списке описаны значения, которые необходимо обновить.

   - `<Cluster Network Name>`: имя отказоустойчивого кластера Windows Server для сети. В **диспетчер отказоустойчивости кластеров** > **сети**щелкните правой кнопкой мыши сеть и выберите пункт **Свойства**. Правильное значение указано в поле **Имя** на вкладке **Общие**.

   - `<SQL Server FCI IP Address Resource Name>`: имя ресурса IP-адреса SQL Server FCI. В **Диспетчер отказоустойчивости кластеров** роли ** > в**разделе роль SQL Server FCI в разделе **имя сервера**щелкните правой кнопкой мыши ресурс IP-адреса и выберите пункт **Свойства**. Правильное значение указано в поле **Имя** на вкладке **Общие**. 

   - `<ILBIP>`: IP-адрес внутренней подсистемы балансировки нагрузки. Этот адрес настраивается на портале Azure в качестве интерфейсного адреса внутренней подсистемы балансировки нагрузки. Это также IP-адрес экземпляра отказоустойчивого кластера SQL Server. Его можно найти в окне **Диспетчер отказоустойчивости кластеров** на той же странице свойств, где указано значение `<SQL Server FCI IP Address Resource Name>`.  

   - `<nnnnn>`: порт пробы, настроенный в зонде работоспособности балансировщика нагрузки. Допускается любой неиспользуемый TCP-порт.

>[!IMPORTANT]
>Маска подсети для параметра кластера должна быть широковещательным адресом TCP IP: `255.255.255.255`.

После настройки проверки кластера можно просмотреть все параметры кластера в PowerShell. Выполните следующий сценарий:

   ```powershell
   Get-ClusterResource $IPResourceName | Get-ClusterParameter 
  ```

## <a name="step-7-test-fci-failover"></a>Шаг 7. Проверка отработки отказа экземпляра отказоустойчивого кластера

Проверьте отработку отказа экземпляра отказоустойчивого кластера, чтобы проверить функциональные возможности кластера. Сделайте следующее:

1. Подключитесь к одному из узлов кластера SQL Server FCI с помощью RDP.

1. Откройте **диспетчер отказоустойчивости кластеров**. Выберите **Роли**. Обратите внимание, какой узел является владельцем роли SQL Server FCI.

1. Щелкните правой кнопкой мыши роль SQL Server FCI.

1. Щелкните **переместить**, а затем выберите **лучший из возможных узлов**.

**Диспетчер отказоустойчивости кластеров** показывает роль, а ее ресурсы переходят в режим «вне сети». Затем ресурсы переместятся и станут доступными на другом узле.

### <a name="test-connectivity"></a>Проверка подключения

Чтобы проверить возможность подключения, войдите на другую виртуальную машину в той же виртуальной сети. Откройте **SQL Server Management Studio** и подключитесь к экземпляру отказоустойчивого кластера SQL Server.

>[!NOTE]
>При необходимости можно [скачать SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).

## <a name="limitations"></a>Ограничения

Виртуальные машины Azure поддерживают Microsoft координатор распределенных транзакций (MSDTC) в Windows Server 2019 с хранилищем на кластеризованных общих томах (CSV) и [стандартном подсистеме балансировки нагрузки](../../../load-balancer/load-balancer-standard-overview.md).

На виртуальных машинах Azure MSDTC не поддерживается в Windows Server 2016 или более ранних версиях, так как:

- Кластеризованный ресурс MSDTC не может быть настроен для использования общего хранилища. В Windows Server 2016 при создании ресурса MSDTC он не будет отображать доступное для использования общее хранилище, даже если хранилище доступно. Эта проблема устранена в Windows Server 2019.
- Базовая подсистема балансировки нагрузки не обрабатывает порты RPC.

## <a name="see-also"></a>Дополнительные материалы

[Настройка Локальные дисковые пространства с помощью удаленного рабочего стола (Azure)](https://technet.microsoft.com/windows-server-docs/compute/remote-desktop-services/rds-storage-spaces-direct-deployment)

[Решение с технологией Hyper-схождения с Локальные дисковые пространства](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/hyper-converged-solution-using-storage-spaces-direct)

[Обзор Локальные дисковые пространства](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/storage-spaces-direct-overview)

[Поддержка SQL Server для Локальные дисковые пространства](https://blogs.technet.microsoft.com/dataplatforminsider/2016/09/27/sql-server-2016-now-supports-windows-server-2016-storage-spaces-direct/)
