---
title: Автоматическая установка исправлений гостевых виртуальных машин для виртуальных машин Windows в Azure
description: Узнайте, как автоматически исправлять виртуальные машины Windows в Azure
author: mayanknayar
ms.service: virtual-machines-windows
ms.workload: infrastructure
ms.topic: how-to
ms.date: 09/09/2020
ms.author: manayar
ms.openlocfilehash: 0a777b9008864368a6d1731cae0374e55a4c585f
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91842875"
---
# <a name="preview-automatic-vm-guest-patching-for-windows-vms-in-azure"></a>Предварительный просмотр: Автоматическая установка исправлений гостевых виртуальных машин для виртуальных машин Windows в Azure

Включение автоматической установки исправлений гостевых ВИРТУАЛЬНЫХ машин для виртуальных машин Windows помогает упростить управление обновлениями с помощью безопасного и автоматического исправления виртуальных машин для обеспечения соответствия безопасности.

Автоматическая установка исправлений гостевых виртуальных машин имеет следующие характеристики.
- Исправления, классифицированные как *критические* , или *Безопасность* , автоматически загружаются и применяются к виртуальной машине.
- Исправления применяются в часы наименьшей нагрузки в часовом поясе виртуальной машины.
- Управление исправлениями осуществляется с помощью Azure, а исправления применяются после принципов доступности.
- Отслеживание работоспособности виртуальной машины, которое определяется с помощью сигналов работоспособности платформы, отслеживается для обнаружения сбоев исправления.
- Работает со всеми размерами виртуальных машин.

> [!IMPORTANT]
> Автоматическая установка исправлений гостевых виртуальных машин в настоящее время доступна в общедоступной предварительной версии. Для использования функции общедоступной предварительной версии, описанной ниже, требуется процедура согласия.
> Предварительная версия предоставляется без соглашения об уровне обслуживания. Мы не рекомендуем использовать ее в рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены.
> Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

## <a name="how-does-automatic-vm-guest-patching-work"></a>Как работает автоматическая установка исправлений гостевых виртуальных машин?

Если на виртуальной машине включено автоматическое обновление гостевых виртуальных машин, то доступные *критически важные* обновления и исправления *безопасности* будут скачаны и применены на виртуальной машине автоматически. Этот процесс начинается автоматически каждый месяц при выпуске новых исправлений с помощью Центр обновления Windows. Оценка и установка исправлений выполняются автоматически, и процесс включает перезагрузку виртуальной машины по мере необходимости.

Оценка виртуальной машины периодически оценивается для определения применимых исправлений для этой виртуальной машины. Исправления можно установить в любой день на ВИРТУАЛЬНОЙ машине в часы наименьшей нагрузки для виртуальной машины. Эта автоматическая оценка гарантирует, что все отсутствующие исправления будут обнаружены по самой ранней возможной возможности.

Исправления устанавливаются в течение 30 дней ежемесячного Центр обновления Windowsного выпуска, как описано ниже, с помощью согласования доступности. Исправления устанавливаются только в часы наименьшей нагрузки для виртуальной машины в зависимости от часового пояса виртуальной машины. Для автоматической установки исправлений виртуальная машина должна быть запущена в часы наименьшей нагрузки. Если во время периодической оценки виртуальная машина отключена, она будет автоматически оцениваться, а применимые исправления будут автоматически устанавливаться во время следующей периодической оценки, когда виртуальная машина будет включена.

Чтобы установить исправления с другими классификациями исправлений или запланировать установку исправлений в рамках собственного настраиваемого периода обслуживания, можно использовать [Управление обновлениями](tutorial-config-management.md#manage-windows-updates).

### <a name="availability-first-patching"></a>Доступность — сначала установка исправлений

Процесс установки исправлений управляется глобально Azure для всех виртуальных машин, на которых включено автоматическое исправление гостевой виртуальной машины. Это согласование соответствует принципам доступности — первыми на разных уровнях доступности, предоставляемых Azure.

Для группы виртуальных машин, которые подчиняются обновлению, Платформа Azure будет управлять обновлениями:

**Между регионами:**
- Ежемесячное обновление управляется в Azure глобально за один этап, чтобы предотвратить сбои глобальных развертываний.
- На фазе может быть один или несколько регионов, а обновление переходит к следующим этапам только в случае успешного обновления соответствующих виртуальных машин в фазе.
- Геопарные регионы не обновляются одновременно и не могут находиться на одном региональном этапе.
- Успешность обновления измеряется путем отслеживания обновления работоспособности виртуальной машины. Работоспособность виртуальной машины отбирается с помощью индикаторов работоспособности платформы для виртуальной машины.

**В пределах региона:**
- Виртуальные машины в разных Зоны доступности не обновляются одновременно.
- Виртуальные машины, не входящие в группу доступности, объединяются в пакетном режиме, чтобы избежать параллельных обновлений для всех виртуальных машин в подписке.

**В группе доступности:**
- Все виртуальные машины в общей группе доступности не обновляются одновременно.
-   Виртуальные машины в общей группе доступности обновляются в границах домена обновления, а виртуальные машины в нескольких доменах обновления не обновляются одновременно.

Дата установки исправления для данной виртуальной машины может варьироваться в месяц, так как конкретная виртуальная машина может быть выбрана в другом пакете между ежемесячными циклами обновления.

## <a name="supported-os-images"></a>Поддерживаемые образы ОС
В предварительной версии поддерживаются только виртуальные машины, созданные на основе определенных образов платформы ОС. В настоящее время предварительная версия не поддерживает пользовательские образы.

В настоящее время поддерживаются следующие SKU платформы (и периодически добавляются дополнительные):

| Издатель               | Предложение ОС      |  Sku               |
|-------------------------|---------------|--------------------|
| Корпорация Майкрософт   | WindowsServer | 2012-R2-Datacenter |
| Корпорация Майкрософт   | WindowsServer | 2016-Datacenter    |
| Корпорация Майкрософт   | WindowsServer | 2016-Datacenter-Server-Core |
| Корпорация Майкрософт   | WindowsServer | 2019-Datacenter |
| Корпорация Майкрософт   | WindowsServer | 2019-Datacenter-Server-Core |

## <a name="patch-orchestration-modes"></a>Режимы оркестрации исправлений
Виртуальные машины Windows в Azure теперь поддерживают следующие режимы оркестрации исправлений:

**Аутоматикбиплатформ:**
- Этот режим включает автоматическое исправление гостевых виртуальных машин для виртуальной машины Windows и последующий процесс установки исправлений в Azure.
- Установка этого режима также отключает автоматическое обновление машинного кода на виртуальной машине Windows во избежание дублирования.
- Этот режим поддерживается только для виртуальных машин, созданных с помощью описанных выше образов платформы операционной системы.
- Чтобы использовать этот режим, задайте свойство `osProfile.windowsConfiguration.enableAutomaticUpdates=true` и задайте свойство  `osProfile.windowsConfiguration.patchSettings.patchMode=AutomaticByPlatfom` в ШАБЛОНЕ виртуальной машины.

**Аутоматикбйос:**
- Этот режим включает автоматическое обновление на виртуальной машине Windows, а исправления устанавливаются на ВИРТУАЛЬНОЙ машине с помощью автоматическое обновление.
- Этот режим задается по умолчанию, если не указан другой режим обновления.
- Чтобы использовать этот режим, задайте свойство `osProfile.windowsConfiguration.enableAutomaticUpdates=true` и задайте свойство  `osProfile.windowsConfiguration.patchSettings.patchMode=AutomaticByOS` в ШАБЛОНЕ виртуальной машины.

**Вручную:**
- Этот режим отключает автоматическое обновление на виртуальной машине Windows.
- Этот режим следует задавать при использовании настраиваемых решений по исправлению.
- Чтобы использовать этот режим, задайте свойство `osProfile.windowsConfiguration.enableAutomaticUpdates=false` и задайте свойство  `osProfile.windowsConfiguration.patchSettings.patchMode=Manual` в ШАБЛОНЕ виртуальной машины.

> [!NOTE]
>В `osProfile.windowsConfiguration.enableAutomaticUpdates` настоящее время свойство может быть задано только при создании виртуальной машины. Переключение с ручного на автоматический режим или из любого из автоматических режимов в ручной режим сейчас не поддерживается. Переключение из режима Аутоматикбйос в режим Аутоматикбиплатфом поддерживается

## <a name="requirements-for-enabling-automatic-vm-guest-patching"></a>Требования к включению автоматической установки исправлений для гостевых виртуальных машин

- На виртуальной машине должен быть установлен [Агент виртуальной машины Azure](../extensions/agent-windows.md) .
- На виртуальной машине должна быть запущена служба Центр обновления Windows.
- Виртуальная машина должна иметь доступ к Центр обновления Windows конечным точкам. Если виртуальная машина настроена для использования Windows Server Update Services (WSUS), соответствующие конечные точки сервера WSUS должны быть доступны.
- Используйте API вычислений версии 2020-06-01 или более поздней.

Для включения функции предварительной версии требуется одноразовый явный выбор функции *ингуестаутопатчвмпревиев* на подписку, как описано ниже.

### <a name="rest-api"></a>REST API
В следующем примере показано, как включить предварительную версию для подписки.

```
POST on `/subscriptions/{subscriptionId}/providers/Microsoft.Features/providers/Microsoft.Compute/features/InGuestAutoPatchVMPreview/register?api-version=2015-12-01`
```

Регистрация компонентов может занять до 15 минут. Чтобы проверить состояние регистрации, сделайте следующее:

```
GET on `/subscriptions/{subscriptionId}/providers/Microsoft.Features/providers/Microsoft.Compute/features/InGuestAutoPatchVMPreview?api-version=2015-12-01`
```

После регистрации функции для подписки завершите процесс согласия, добавив изменения в поставщик ресурсов вычислений.

```
POST on `/subscriptions/{subscriptionId}/providers/Microsoft.Compute/register?api-version=2020-06-01`
```

### <a name="azure-powershell"></a>Azure PowerShell
Используйте командлет [Register-азпровидерфеатуре](/powershell/module/az.resources/register-azproviderfeature) , чтобы включить предварительную версию для подписки.

```azurepowershell-interactive
Register-AzProviderFeature -FeatureName InGuestAutoPatchVMPreview -ProviderNamespace Microsoft.Compute
```

Регистрация компонентов может занять до 15 минут. Чтобы проверить состояние регистрации, сделайте следующее:

```azurepowershell-interactive
Get-AzProviderFeature -FeatureName InGuestAutoPatchVMPreview -ProviderNamespace Microsoft.Compute
```

После регистрации функции для подписки завершите процесс согласия, добавив изменения в поставщик ресурсов вычислений.

```azurepowershell-interactive
Register-AzResourceProvider -ProviderNamespace Microsoft.Compute
```

### <a name="azure-cli-20"></a>Azure CLI 2.0
Чтобы включить предварительную версию подписки, используйте команду [AZ Feature Register](/cli/azure/feature#az-feature-register) .

```azurecli-interactive
az feature register --namespace Microsoft.Compute --name InGuestAutoPatchVMPreview
```

Регистрация компонентов может занять до 15 минут. Чтобы проверить состояние регистрации, сделайте следующее:

```azurecli-interactive
az feature show --namespace Microsoft.Compute --name InGuestAutoPatchVMPreview
```

После регистрации функции для подписки завершите процесс согласия, добавив изменения в поставщик ресурсов вычислений.

```azurecli-interactive
az provider register --namespace Microsoft.Compute
```
## <a name="enable-automatic-vm-guest-patching"></a>Включение автоматизации исправлений гостевой системы виртуальной машины
Чтобы включить автоматическую установку исправлений гостевых виртуальных машин, убедитесь, что для свойства *osProfile. виндовсконфигуратион. енаблеаутоматикупдатес* в определении шаблона виртуальной машины задано значение *true* . Это свойство можно задать только при создании виртуальной машины.

### <a name="rest-api"></a>REST API
В следующем примере показано, как включить автоматическое исправление гостевой виртуальной машины.

```
PUT on `/subscriptions/subscription_id/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVirtualMachine?api-version=2020-06-01`
```

```json
{
  "properties": {
    "osProfile": {
      "windowsConfiguration": {
        "provisionVMAgent": true,
        "enableAutomaticUpdates": true,
        "patchSettings": {
          "patchMode": "AutomaticByPlatform"
        }
      }
    }
  }
}
```

### <a name="azure-powershell"></a>Azure PowerShell
Используйте командлет [Set-азвмоператингсистем](/powershell/module/az.compute/set-azvmoperatingsystem) , чтобы включить автоматическое исправление ГОСТЕВЫХ виртуальных машин при создании или обновлении виртуальной машины.

```azurepowershell-interactive
Set-AzVMOperatingSystem -VM $VirtualMachine -Windows -ComputerName $ComputerName -Credential $Credential -ProvisionVMAgent -EnableAutoUpdate -PatchMode "AutomaticByPlatform"
```

### <a name="azure-cli-20"></a>Azure CLI 2.0
Используйте команду [AZ VM Create](/cli/azure/vm#az-vm-create) , чтобы включить автоматическое исправление ГОСТЕВЫХ виртуальных машин при создании новой виртуальной машины. В следующем примере выполняется настройка автоматической установки исправлений гостевых виртуальных машин для виртуальной машины с именем *myVM* в группе ресурсов с именем *myResourceGroup*:

```azurecli-interactive
az vm create --resource-group myResourceGroup --name myVM --image Win2019Datacenter --enable-agent --enable-auto-update --patch-mode AutomaticByPlatform
```

Чтобы изменить существующую виртуальную машину, используйте команду [AZ VM Update](/cli/azure/vm#az-vm-update) .

```azurecli-interactive
az vm update --resource-group myResourceGroup --name myVM --set osProfile.windowsConfiguration.enableAutomaticUpdates=true osProfile.windowsConfiguration.patchSettings.patchMode=AutomaticByPlatform
```

## <a name="enablement-and-assessment"></a>Включение и оценка

> [!NOTE]
>Включение автоматического обновления гостевых виртуальных машин на виртуальной машине может занять более трех часов, так как включение завершается в часы низкой нагрузки на виртуальную машину. Так как установка оценки и исправлений выполняется только в часы наименьшей нагрузки, для применения исправлений виртуальная машина должна быть также запущена в часы наименьшей нагрузки.

Если для виртуальной машины включено автоматическое обновление гостевых виртуальных машин, на виртуальной машине устанавливается расширение типа "ВИРТУАЛЬная машина `Microsoft.CPlat.Core.WindowsPatchExtension` ". Это расширение не требуется устанавливать или обновлять вручную, так как это расширение управляется платформой Azure в рамках автоматического процесса обновления гостевых виртуальных машин.

Включение автоматического обновления гостевых виртуальных машин на виртуальной машине может занять более трех часов, так как включение завершается в часы низкой нагрузки на виртуальную машину. Расширение также устанавливается и обновляется в часы наименьшей нагрузки для виртуальной машины. В случае завершения работы в нерабочее время в течение непикового периода перед включением можно будет продолжить процесс включения в течение следующего доступного времени. Если на виртуальной машине ранее был включен автоматический Центр обновления Windows с помощью режима исправления Аутоматикбйос, то при установке расширения автоматически Центр обновления Windows для виртуальной машины отключена.

Чтобы убедиться, что автоматическое исправление гостевой виртуальной машины завершено и на виртуальной машине установлено расширение исправлений, можно просмотреть представление экземпляров виртуальной машины. Если процесс включения завершен, то расширение будет установлено, а результаты оценки для виртуальной машины будут доступны в разделе `patchStatus` . Доступ к представлению экземпляра виртуальной машины можно получить несколькими способами, как описано ниже.

### <a name="rest-api"></a>REST API

```
GET on `/subscriptions/subscription_id/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVirtualMachine/instanceView?api-version=2020-06-01`
```
### <a name="azure-powershell"></a>Azure PowerShell
Используйте командлет [Get-AzVM](/powershell/module/az.compute/get-azvm) с `-Status` параметром, чтобы получить доступ к представлению экземпляра для виртуальной машины.

```azurepowershell-interactive
Get-AzVM -ResourceGroupName "myResourceGroup" -Name "myVM" -Status
```

В настоящее время PowerShell предоставляет сведения только о расширении исправления. `patchStatus`Кроме того, сведения о скоро будут доступны в PowerShell.

### <a name="azure-cli-20"></a>Azure CLI 2.0
Чтобы получить доступ к представлению экземпляра для виртуальной машины, используйте команду [AZ VM Get-instance-View](/cli/azure/vm#az-vm-get-instance-view) .

```azurecli-interactive
az vm get-instance-view --resource-group myResourceGroup --name myVM
```

### <a name="understanding-the-patch-status-for-your-vm"></a>Основные сведения о состоянии исправления для виртуальной машины

В `patchStatus` разделе ответ представления экземпляров содержатся сведения о последней оценке и установке последнего исправления для виртуальной машины.

Результаты оценки для виртуальной машины можно просмотреть в `availablePatchSummary` разделе. Оценка периодически выполняется для виртуальной машины, для которой включена автоматическая установка исправлений гостевых виртуальных машин. Число доступных исправлений после того, как оценка будет предоставлена в `criticalAndSecurityPatchCount` и `otherPatchCount` результатах. При автоматической установке исправлений гостевых виртуальных машин будут установлены все исправления, оцененные в соответствии с классификацией *критических* обновлений и исправлений *безопасности* . Любое другое исправление с оценкой пропускается.

Результаты установки исправления для виртуальной машины можно просмотреть в `lastPatchInstallationSummary` разделе. В этом разделе приводятся сведения о последней попытке установки исправления на виртуальной машине, включая количество установленных, ожидающих, неудачных или пропущенных исправлений. Исправления устанавливаются только в течение периода обслуживания виртуальных машин в нерабочее время. Ожидающие и неудачные исправления автоматически повторяются в течение следующего периода обслуживания в течение непиковой нагрузки.

## <a name="on-demand-patch-assessment"></a>Оценка исправлений по запросу
Если автоматическая установка исправлений гостевых виртуальных машин уже включена для виртуальной машины, на ВИРТУАЛЬНОЙ машине выполняется периодическая оценка исправления в течение непиковых часов виртуальной машины. Этот процесс выполняется автоматически, и результаты последней оценки можно просмотреть в представлении экземпляра виртуальной машины, как описано выше в этом документе. Вы также можете запустить оценку исправления по запросу для виртуальной машины в любое время. Оценка исправления может занять несколько минут, и состояние последней оценки обновляется в представлении экземпляров виртуальной машины.

Для включения функции предварительной версии требуется одноразовый явный выбор функции *ингуестпатчвмпревиев* на подписку. Предварительную версию функции оценки исправлений по запросу можно включить после [процесса включения предварительной версии](automatic-vm-guest-patching.md#requirements-for-enabling-automatic-vm-guest-patching) , описанного ранее для автоматического исправления ГОСТЕВЫХ виртуальных машин.

> [!NOTE]
>Оценка исправлений по запросу не запускает автоматическую установку исправлений автоматически. Оценка и применимые исправления для виртуальной машины устанавливаются только в часы низкой нагрузки на виртуальную машину, следуя процедуре установки исправлений, описанной выше в этом документе.

### <a name="rest-api"></a>REST API
```
POST on `/subscriptions/subscription_id/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVirtualMachine/assessPatches?api-version=2020-06-01`
```

### <a name="azure-powershell"></a>Azure PowerShell
Используйте командлет [Invoke-азвмпатчассессмент](/powershell/module/az.compute/invoke-azvmpatchassessment) для оценки доступных исправлений для виртуальной машины.

```azurepowershell-interactive
Invoke-AzVmPatchAssessment -ResourceGroupName "myResourceGroup" -VMName "myVM"
```

### <a name="azure-cli-20"></a>Azure CLI 2.0
Используйте команду [AZ VM оценкой-патчи](/cli/azure/vm#az-vm-assess-patches) для оценки доступных исправлений для виртуальной машины.

```azurecli-interactive
az vm assess-patches --resource-group myResourceGroup --name myVM
```

## <a name="next-steps"></a>Дальнейшие шаги
> [!div class="nextstepaction"]
> [Дополнительные сведения о создании виртуальных машин Windows и управлении ими](tutorial-manage-vm.md)
