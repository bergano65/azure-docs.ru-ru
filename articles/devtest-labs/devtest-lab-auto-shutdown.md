---
title: Управление политиками автоматического завершения работы на виртуальных машинах Azure DevTest Labs и COMPUTE | Документация Майкрософт
description: Узнайте, как настроить политику автоматического завершения работы для лаборатории, чтобы автоматически завершать работу виртуальных машин, если они не используются.
ms.topic: article
ms.date: 06/26/2020
ms.openlocfilehash: cd7974580ea30c9d0591c88380a4e626711bad1e
ms.sourcegitcommit: 96918333d87f4029d4d6af7ac44635c833abb3da
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2020
ms.locfileid: "93318977"
---
# <a name="configure-autoshutdown-for-lab-and-compute-virtual-machines-in-azure-devtest-labs"></a>Настройка автоматического завершения работы для лабораторий и вычисление виртуальных машин в Azure DevTest Labs

В этой статье объясняется, как настроить параметры автоматического завершения работы для виртуальных машин лаборатории в DevTest Labs и COMPUTE VM.

## <a name="configure-autoshutdown-for-lab-vms-devtest-labs"></a>Настройка автоматического завершения работы для виртуальных машин лаборатории (DevTest Labs)

Azure DevTest Labs позволяет контролировать расходы и свести к минимуму излишние траты в лабораториях с помощью управления политиками (параметрами) для каждой лаборатории. В этой статье показано, как настроить политику автоматического завершения работы для лаборатории.  Здесь также показано, как настроить параметры автоматического завершения работы для виртуальной машины лаборатории. Сведения о настройке всех политик лаборатории см. в статье [Управление всеми политиками лаборатории в Azure DevTest Labs](devtest-lab-set-lab-policy.md).  

### <a name="set-autoshutdown-policy-for-a-lab"></a>Настройка политики автоматического завершения работы для лаборатории

Владелец лаборатории может настроить расписание завершения работы всех виртуальных машин в лаборатории. Таким образом, вы сможете сэкономить на работе компьютеров, которые не используются (в режиме простоя). Вы можете принудительно применить политику завершения работы ко всем виртуальным машинам лаборатории централизованно, а также сохранить возможности пользователей лаборатории по настройке расписания для отдельных компьютеров. Эта функция позволяет настроить политику в расписании лаборатории в зависимости от того, что пользователи лаборатории могут иметь полный контроль над расписанием завершения работы виртуальной машины, чтобы не контролировать завершение работы виртуальной машины. В качестве владельца лаборатории, вы можете настроить эту политику, выполнив следующие действия:

1. На домашней странице лаборатории выберите функцию **Конфигурация и политики**.
2. Выберите **Политика автоматического завершения работы** в разделе **Расписания** меню слева.
3. Выберите один из способов. Следующие разделы содержат дополнительные сведения об этих параметрах.

    ![Параметры политики автоматического выключения](./media/devtest-lab-set-lab-policy/auto-shutdown-policy-options.png)

> [!IMPORTANT]
> Изменения политики завершения работы применяются только к новым виртуальным машинам, созданным в лаборатории, а не к уже существующим виртуальным машинам.

### <a name="configure-autoshutdown-settings"></a>Настройка параметров автоматического завершения работы

Политика автоматического завершения работы помогает снизить объем отходов лаборатории, позволяя указать время завершения работы виртуальных машин лаборатории.

Чтобы просмотреть или изменить политики лаборатории, выполните следующие действия.

1. На домашней странице лаборатории выберите функцию **Конфигурация и политики**.
2. Выберите **Автоматическое завершение работы** в разделе **расписания** в меню слева.
3. Щелкните **On** (Вкл.), чтобы включить эту политику, или **Off** (Выкл.), чтобы отключить ее.
     ![Сведения об автоматическом завершении работы](./media/devtest-lab-set-lab-policy/auto-shutdown.png)
4. Если эта политика включена, то укажите время (и часовой пояс) завершения работы всех виртуальных машин в текущей лаборатории.
5. Укажите **Да** или **нет** для отправки уведомления за 30 минут до указанного времени автоматического завершения работы. Выбрав **Да** , укажите конечную точку в виде URL-адреса веб-перехватчика, где будут публиковаться уведомления, или адрес электронной почты, на который будут отправляться такие уведомления. При получении уведомления пользователь получает возможность отложить завершение работы. Дополнительные сведения см. в разделе " [уведомления](#notifications) ".
6. Щелкните **Сохранить**.

    По умолчанию после включения эта политика применяется ко всем виртуальным машинам в текущей лаборатории. Чтобы удалить этот параметр из конкретной виртуальной машины, откройте область управления виртуальной машины и измените значение параметра **Автозавершение работы**.

> [!NOTE]
> Если вы обновите расписание автозавершения работы для лаборатории или конкретную виртуальную машину лаборатории в течение 30 минут после текущего запланированного времени, то обновленное время завершения работы будет применено к следующему расписанию.

### <a name="user-sets-a-schedule-and-can-opt-out"></a>Пользователь задает расписание и может отказаться от него

Если задать лаборатории эту политику, пользователи лаборатории могут переопределить или отказаться от расписания лаборатории. Этот параметр предоставляет пользователям лаборатории полный контроль над расписанием автоматического завершения работы своих виртуальных машин. Пользователи лаборатории не увидят изменений на своей странице расписания автоматического завершения работы виртуальной машины.

![Параметр политики автоматического выключения — 1](./media/devtest-lab-set-lab-policy/auto-shutdown-policy-option-1.png)

### <a name="user-sets-a-schedule-and-cannot-opt-out"></a>Пользователь задает расписание и не может отказаться от него

Если задать лаборатории эту политику, пользователи лаборатории могут переопределить расписание лаборатории. Однако они не могут отказаться от политики автоматического завершения работы. Этот параметр гарантирует, что каждый компьютер в лаборатории будет иметь расписание автоматического завершения работы. Пользователи лаборатории могут обновлять расписание автоматического завершения работы своих виртуальных машин и настраивать уведомления о завершении работы.

![Параметр политики автоматического выключения — 2](./media/devtest-lab-set-lab-policy/auto-shutdown-policy-option-2.png)

### <a name="user-has-no-control-over-the-schedule-set-by-lab-admin"></a>Пользователь не может изменять расписание, заданное администратором лаборатории

Если задать лаборатории эту политику, пользователи лаборатории не смогут переопределить или отказаться от расписания лаборатории. Этот параметр дает администратору лаборатории полный контроль над расписанием каждой машины в лаборатории. Пользователи лаборатории могут задать только уведомления об автоматическом завершении работы своих виртуальных машин.

![Параметр политики автоматического выключения — 3](./media/devtest-lab-set-lab-policy/auto-shutdown-policy-option-3.png)

## <a name="configure-autoshutdown-for-compute-vms"></a>Настройка автоматического завершения работы для виртуальных машин вычислений

1. На странице **Виртуальная машина** выберите **Автоматическое завершение работы** в меню слева в разделе **операции** .
2. На странице **Автоматическое завершение работы** выберите **вкл** ., чтобы включить эту политику **, и отключите** ее.
3. Если эта политика включена, укажите **время** (и часовой **пояс** ), в течение которого должна быть завершена работа виртуальной машины.
4. Выберите **Да** или **нет** , чтобы отправить уведомление через 30 минут до указанного времени автоматического завершения работы. Выбрав **Да** , укажите конечную точку в виде URL-адреса веб-перехватчика, где будут публиковаться уведомления, или адрес электронной почты, на который будут отправляться такие уведомления. При получении уведомления пользователь получает возможность отложить завершение работы. Дополнительные сведения см. в разделе " [уведомления](#notifications) ".
5. Щелкните **Сохранить**.

    ![Настройка автоматического завершения работы для вычислений виртуальной машины](./media/devtest-lab-auto-shutdown/comnpute-auto-shutdown.png)

### <a name="view-activity-logs-for-auto-shutdown-updates"></a>Просмотр журналов действий для обновлений автоматического завершения работы

При обновлении параметра автоматического завершения работы вы увидите, что действие зарегистрировано в журнале действий для виртуальной машины.

1. В [портал Azure](https://portal.azure.com)перейдите на домашнюю страницу виртуальной машины.
2. В меню слева выберите **Журнал действий** .
3. Удалить **ресурс: микомпутевм** из фильтров.
4. Убедитесь, что в журнале действий отображается операция **Добавить или изменить расписания** . Если вы не видите его, подождите некоторое время и обновите журнал действий.

    ![Запись журнала действий](./media/devtest-lab-auto-shutdown/activity-log-entry.png)
5. Выберите операцию **Добавить или изменить расписания** , чтобы просмотреть следующие сведения на странице **Сводка** .

    - Имя операции (Добавление или изменение расписаний)
    - Дата и время обновления параметра автоматического завершения работы.
    - Адрес электронной почты пользователя, который обновил параметр.

        ![Сводка записи журнала действий](./media/devtest-lab-auto-shutdown/activity-log-entry-summary.png)
6. Перейдите на вкладку **Журнал изменений** на странице **Добавление или изменение расписаний** . Вы увидите журнал изменений для параметра. В следующем примере время завершения работы было изменено с 7 до 6 апреля 2020 в 15:18:47 EST. И этот параметр был отключен в 15:25:09 EST.

    ![Журнал действий — журнал изменений](./media/devtest-lab-auto-shutdown/activity-log-entry-change-history.png)
7. Чтобы просмотреть дополнительные сведения об операции, перейдите на вкладку **JSON** на странице **Добавление или изменение расписаний** .

## <a name="notifications"></a>Уведомления

После настройки автоматического выключения уведомления будут отправляться пользователям лабораторий через 30 минут, прежде чем автоматическое завершение работы будет активировано, если на какой-либо из их виртуальных машин будет внесено влияние. Этот параметр дает пользователям лаборатории возможность сохранить свою работу перед завершением работы. Кроме того, в этом уведомлении содержатся ссылки на каждую виртуальную машину для следующих действий в том случае, если кто-то должен работать с виртуальной машиной.

- Пропустить автозавершение в течение этого времени
- Отложить автоматическое завершение работы в течение часа
- Отложить автоматическое завершение работы в течение 2 часов

Если был указан веб-перехватчик, уведомление будет отправлено на URL перехватчика.  Если адрес электронной почты указан в параметрах автоматического завершения работы, на этот адрес электронной почты будет отправлено сообщение электронной почты. Веб-Перехватчики позволяют создавать или настраивать интеграции, которые подписываются на определенные события. Когда запускается одно из этих событий, DevTest Labs отправляет полезные данные HTTP POST в настроенный URL-адрес. Дополнительные сведения о реагировании на веб-перехватчики см. в статье [Общие сведения о триггерах и привязках в функциях Azure, а](../azure-functions/functions-bindings-http-webhook.md) также о [добавлении триггера HTTP для Azure Logic Apps](../connectors/connectors-native-http.md#add-an-http-trigger).

Мы рекомендуем использовать веб-перехватчики, так как они широко поддерживаются различными приложениями, такими как Azure Logic Apps и временной резерв.  Веб-Перехватчики позволяют реализовать собственный способ отправки уведомлений. Например, в этой статье описывается настройка уведомления об автозавершении работы для отправки сообщения электронной почты владельцу виртуальной машины с помощью Azure Logic Apps. Во-первых, давайте быстро рассмотрим основные шаги для включения уведомлений об автозавершении работы в лаборатории.

### <a name="create-a-logic-app-that-receives-email-notifications"></a>Создание приложения логики, которое получает уведомления по электронной почте

[Azure Logic Apps](../logic-apps/logic-apps-overview.md) предоставляет много соединителей, которые упрощают интеграцию службы с другими клиентами, например Office 365 и Twitter. На высоком уровне шаги настройки приложения логики для уведомления по электронной почте можно разделить на четыре фазы:

- Создайте приложение логики.
- Настройте встроенный шаблон.
- Интеграция с почтовым клиентом
- Получите URL-адрес веб-перехватчика.

### <a name="create-a-logic-app"></a>Создайте приложение логики

Чтобы приступить к работе, создайте приложение логики в подписке Azure, выполнив следующие действия.

1. Выберите **+ создать ресурс** в меню слева, выберите **Интеграция** и выберите **приложение логики**.

    ![Новое меню приложения логики](./media/devtest-lab-auto-shutdown/new-logic-app.png)
2. На странице **Logic App-Create (создание приложения логики** ) выполните следующие действия.
    1. Введите **имя** приложения логики.
    2. Выберите свою **подписку Azure**.
    3. Создайте новую **группу ресурсов** или выберите имеющуюся.
    4. Выберите **Расположение** для приложения логики.

        ![Новое приложение логики — параметры](./media/devtest-lab-auto-shutdown/new-logic-app-page.png)
3. В **уведомлениях** выберите **Переход к ресурсу** в уведомлении.

    ![Переход к ресурсу](./media/devtest-lab-auto-shutdown/go-to-resource.png)
4. Выберите **Конструктор приложений логики** в разделе Категория **средств развертывания** .

    ![Выберите HTTP-запрос/ответ](./media/devtest-lab-auto-shutdown/select-http-request-response-option.png)
5. На странице **http-запрос — ответ** выберите **использовать этот шаблон**.

    ![Выберите параметр использовать этот шаблон](./media/devtest-lab-auto-shutdown/select-use-this-template.png)
6. Скопируйте следующий код JSON в раздел **схемы JSON текста запроса** :

    ```json
    {
        "$schema": "http://json-schema.org/draft-04/schema#",
        "properties": {
            "delayUrl120": {
                "type": "string"
            },
            "delayUrl60": {
                "type": "string"
            },
            "eventType": {
                "type": "string"
            },
            "guid": {
                "type": "string"
            },
            "labName": {
                "type": "string"
            },
            "owner": {
                "type": "string"
            },
            "resourceGroupName": {
                "type": "string"
            },
            "skipUrl": {
                "type": "string"
            },
            "subscriptionId": {
                "type": "string"
            },
            "text": {
                "type": "string"
            },
            "vmName": {
                "type": "string"
            },
            "vmUrl": {
                "type": "string"
            },
            "minutesUntilShutdown": {
                "type": "string"
            }
        },
        "required": [
            "skipUrl",
            "delayUrl60",
            "delayUrl120",
            "vmName",
            "guid",
            "owner",
            "eventType",
            "text",
            "subscriptionId",
            "resourceGroupName",
            "labName",
            "vmUrl",
            "minutesUntilShutdown"
        ],
        "type": "object"
    }
    ```

    ![Снимок экрана, показывающий "схема JSON тела запроса".](./media/devtest-lab-auto-shutdown/request-json.png)
7. Выберите **+ новый шаг** в конструкторе и выполните следующие действия.
    1. Поиск **Office 365 Outlook — Отправка сообщения электронной почты**.
    2. Выберите **Отправить сообщение электронной почты** по **действиям**.

        ![Параметр отправки электронной почты](./media/devtest-lab-auto-shutdown/select-send-email.png)
    3. Выберите **войти** , чтобы войти в учетную запись электронной почты.
    4. Выберите **поле и щелкните владелец** .
    5. Выберите **Тема** и введите тему уведомления по электронной почте. Например: "завершение работы Machine vmName для Lab: Лабнаме".
    6. Выберите **текст** и укажите содержимое текста для уведомления по электронной почте. Например: "vmName завершает работу через 15 минут. Пропустите это завершение, щелкнув: URL-адрес. Задержка завершения работы в течение часа: delayUrl60. Задержка завершения работы в течение 2 часов: delayUrl120.

        ![Схема JSON текста запроса](./media/devtest-lab-auto-shutdown/email-options.png)
8. На панели инструментов щелкните **Сохранить**. Теперь можно скопировать **URL-адрес HTTP POST**. Нажмите кнопку Копировать, чтобы скопировать URL-адрес в буфер обмена.

    ![URL веб-перехватчика](./media/devtest-lab-auto-shutdown/webhook-url.png)

## <a name="next-steps"></a>Дальнейшие действия

Сведения о настройке всех политик см. в разделе [Определение политик лаборатории в Azure DevTest Labs](devtest-lab-set-lab-policy.md).
