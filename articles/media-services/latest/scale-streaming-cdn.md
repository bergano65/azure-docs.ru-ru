---
title: Потоковая передача содержимого с помощью интеграции CDN
titleSuffix: Azure Media Services
description: Узнайте о потоковой передаче содержимого с помощью интеграции CDN, а также о предварительной выборке и использовании источников CDN.
services: media-services
documentationcenter: ''
author: Juliako
manager: femila
editor: ''
ms.service: media-services
ms.workload: ''
ms.topic: article
ms.date: 02/13/2020
ms.author: juliako
ms.openlocfilehash: b60a86d09e5d6f7d1108595253349bbd0784e4d3
ms.sourcegitcommit: c5021f2095e25750eb34fd0b866adf5d81d56c3a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/25/2020
ms.locfileid: "88799355"
---
# <a name="stream-content-with-cdn-integration"></a>Потоковая передача содержимого с помощью интеграции CDN

Azure CDN предлагает разработчикам глобальное решение для быстрой доставки больших объемов содержимого пользователям путем кэширования содержимого на стратегически расположенных физических узлах по всему миру.  

CDN кэширует содержимое, потоковая передача потока данных из [конечной точки потоковой передачи служб мультимедиа (исходная)](streaming-endpoint-concept.md) на кодек, каждый протокол потоковой передачи, скорость, на каждый формат контейнера и на шифрование или DRM. Для каждого сочетания протокола потоковой передачи на основе кодеков с форматом потока-скорость шифрования будет существовать отдельный кэш CDN.

Популярное содержимое будет обслуживаться непосредственно из кэша CDN при условии, что фрагмент видео кэшируется. При просмотре в режиме реального времени содержимое с большой вероятностью кэшируется, так как обычно у вас есть много людей, наблюдающих за одними данными. Содержимое по запросу может быть немного сложнее, так как у вас может быть некоторое содержимое, которое не является популярным. Если у вас есть миллионы видеоресурсов, которые не являются популярными (только один или два средства просмотра за неделю), но тысячи людей отслеживают все различные видеоролики, CDN значительно менее эффективен.

Необходимо также учитывать, как работает адаптивная потоковая передача. Каждый отдельный фрагмент видео кэшируется как собственная сущность. Например, представьте себе первый раз, когда будет отслеживаться определенное видео. Если средство просмотра пропускает лишь несколько секунд, и там есть только фрагменты видео, связанные с тем, что наблюдаемый пользователь получает кэширование в CDN. При использовании адаптивной потоковой передачи можно применять от 5 до 7 разных скоростей передачи видео. Если один человек наблюдает за одной скоростью, и другой человек смотрит другую скорость, каждый из них кэшируется отдельно в CDN. Даже если два человека проводят одну и ту же скорость, они могут выполнять потоковую передачу по различным протоколам. Все протоколы (HLS, MPEG-DASH, Smooth Streaming) кэшируются отдельно. Таким образом, каждая скорость и протокол кэшируются отдельно и кэшируются только запрашиваемые фрагменты видео.

При принятии решения о том, следует ли включить CDN в [конечной точке потоковой передачи](streaming-endpoint-concept.md)служб мультимедиа, рассмотрите число ожидаемых средств просмотра. CDN помогает, только если вы ожидаете много средств просмотра содержимого. Если максимальная степень параллелизма средств просмотра меньше 500, рекомендуется отключить CDN, так как CDN масштабируется наилучшим образом с параллелизмом.

В этом разделе обсуждается включение [интеграции CDN](#enable-azure-cdn-integration). Кроме того, здесь объясняется Предварительная выборка (активное кэширование) и концепция для предварительной [выборки CDN для источников](#origin-assist-cdn-prefetch) .

## <a name="considerations"></a>Рекомендации

* [Конечная точка потоковой передачи](streaming-endpoint-concept.md) `hostname` и URL-адрес потоковой передачи остаются неизменными независимо от того, включена ли сеть CDN.
* Если вам нужна возможность протестировать содержимое с CDN или без него, создайте другую конечную точку потоковой передачи, которая не включена в CDN.

## <a name="enable-azure-cdn-integration"></a>Включение интеграции Azure CDN

> [!IMPORTANT]
> Вы не можете включить CDN для пробной или учебной учетной записи Azure.
>
> Интеграция CDN включена во всех центрах обработки данных Azure, за исключением регионов федерального правительства и Китая.

После того как конечная точка потоковой передачи подготовлена с включенной сетью CDN, в службах мультимедиа задается определенное время ожидания, прежде чем будет выполнено обновление DNS, чтобы подключить конечную точку потоковой передачи к конечной точке CDN.

Если позже вы захотите отключить или включить CDN, конечную точку потоковой передачи нужно перевести в состояние **Остановлена**. После запуска конечной точки потоковой передачи может потребоваться до двух часов для включения интеграции Azure CDN и для того, чтобы изменения были активными во всех POP CDN. Однако вы можете запустить конечную точку потоковой передачи и поток, не прерывая работу конечной точки потоковой передачи. После завершения интеграции поток доставляется из CDN. В течение периода подготовки конечная точка потоковой передачи будет находиться в **начальном** состоянии и может наблюдаться снижение производительности.

При создании стандартной конечной точки потоковой передачи она по умолчанию настраивается со стандартным Verizon. Вы можете настроить поставщиков Akamai Premium Verizon или Standard с помощью API-интерфейсов RESTFUL.

Для конечных точек потоковой передачи уровня "Стандартный" интеграция служб мультимедиа Azure с Azure CDN реализуется на базе **Azure CDN от Verizon**. Конечные точки потоковой передачи уровня "Премиум" можно настроить, используя все **ценовые категории и поставщики Azure CDN**.

> [!NOTE]
> Дополнительные сведения о Azure CDN см. в разделе [Общие сведения о CDN](../../cdn/cdn-overview.md).

## <a name="determine-if-a-dns-change-was-made"></a>Определение, было ли выполнено изменение DNS

Можно определить, было ли изменено DNS в конечной точке потоковой передачи (трафик направляется в Azure CDN) с помощью <https://www.digwebinterface.com> . Если в результатах отображаются имена доменов azureedge.net, трафик теперь указывает на сеть CDN.

## <a name="origin-assist-cdn-prefetch"></a>Источник-помощь CDN — Предварительная выборка

Кэширование CDN является реактивным процессом. Если CDN может предсказать, что будет запрашивать следующий объект, CDN может заранее запросить и кэшировать следующий объект. С помощью этого процесса можно достигнуть попадания в кэш для всех (или большинства) объектов, что повышает производительность.

Концепция предвыборки стремится размещать объекты на «крае Интернета», в то время как они будут запрашиваться проигрывателем, тем самым уменьшая количество времени для доставки этого объекта проигрывателю.

Чтобы достичь этой цели, конечная точка потоковой передачи (исходная) и CDN должна работать с руки в несколько способов:

- Источнику служб мультимедиа должна быть назначена аналитика (служба-источник) для информирования CDN о следующем объекте для предварительной выборки.
- CDN выполняет предварительную выборку и кэширование (часть предварительной выборки CDN). CDN также должен иметь "аналитику" для информирования источника о том, является ли он предвыборкой или обычной выборки, обрабатывает ответы 404 и способ избежать бесконечного цикла предвыборки.

### <a name="benefits"></a>Преимущества

Преимущества функции предварительной *выборки в CDN-источнике* включают:

- Предварительная выборка улучшает качество воспроизведения видео за счет предварительного позиционирования ожидаемых сегментов видео на границе во время воспроизведения, уменьшения задержки в средстве просмотра и увеличения времени загрузки сегмента видео. Это приводит к ускорению запуска видео и последующему последующему повторению буферизации.
- Эта концепция применима к общему сценарию CDN-источника и не ограничивается носителями.
- Akamai добавил эту функцию в [облачную внедрению Akamai (ACE)](https://learn.akamai.com/en-us/products/media_delivery/cloud_embed.html).

> [!NOTE]
> Эта функция еще не применима к CDN сети Akamai, интегрированной с конечной точкой потоковой передачи служб мультимедиа. Однако он доступен для клиентов служб мультимедиа, имеющих уже существующий контракт Akamai и требующих пользовательской интеграции между Akamai CDN и источником служб мультимедиа.

### <a name="how-it-works"></a>Принцип работы

Поддержка CDN для `Origin-Assist CDN-Prefetch` заголовков (для потоковой передачи в реальном времени и видео по запросу) доступна клиентам, имеющим прямой контракт с сетью AKAMAI CDN. Эта функция включает следующие обмены заголовками HTTP между Akamai CDN и источником служб мультимедиа:

|Заголовок HTTP|Значения|Отправитель|Получатель|Назначение|
| ---- | ---- | ---- | ---- | ----- |
|`CDN-Origin-Assist-Prefetch-Enabled` | 1 (по умолчанию) или 0 |CDN|Исходный домен|Указывает, что для CDN включена упреждающая выборка.|
|`CDN-Origin-Assist-Prefetch-Path`| Пример <br/>Fragments(video=1400000000,format=mpd-time-cmaf)|Исходный домен|CDN|Для предоставления пути к выборке в CDN.|
|`CDN-Origin-Assist-Prefetch-Request`|1 (запрос на предварительное получение) или 0 (обычный запрос)|CDN|Исходный домен|Чтобы указать, что запрос из CDN является выборке.|

Чтобы увидеть часть процесса обмена заголовками в действии, можно попробовать выполнить следующие действия.

1. Используйте POST или подлистывание, чтобы отправить запрос к источнику служб мультимедиа для сегмента или фрагмента видео. Не забудьте добавить заголовок `CDN-Origin-Assist-Prefetch-Enabled: 1` в запрос.
2. В ответе вы должны увидеть заголовок `CDN-Origin-Assist-Prefetch-Path` с относительным путем в качестве его значения.

### <a name="supported-streaming-protocols"></a>Поддерживаемые протоколы потоковой передачи

Эта `Origin-Assist CDN-Prefetch` функция поддерживает следующие протоколы потоковой передачи для потоковой передачи в режиме реального времени и по запросу:

* HLS v3
* HLS v4
* HLS CMAF
* ТИРЕ (CSF)
* ТИРЕ (КМАФ)
* Потоковая передача Smooth Streaming

### <a name="faqs"></a>Часто задаваемые вопросы

* Что делать, если URL-адрес пути для предвыборки недопустим, поэтому при выборке CDN будет получено 404?

    CDN будет кэшировать только ответ 404 в течение 10 секунд (или другого настроенного значения).

* Предположим, что у вас есть видео по запросу. Если включена предварительная выборка CDN, эта функция подразумевает, что после того, как клиент запросит первый сегмент видео, при предварительной выборке будет запущен цикл для предварительной выборки всех последующих сегментов видео с той же скоростью?

    Нет, Предварительная выборка CDN выполняется только после инициированного клиентом запроса/ответа. С помощью предварительной выборки в CDN не запускается Предварительная выборка, чтобы избежать цикла предварительной выборки.

* Включена ли функция предварительной выборки CDN с источником? Как он может быть включен или выключен?

    Эта возможность отключена по умолчанию. Клиенты должны его включить через API Akamai.

* Что произойдет, если следующий сегмент или фрагмент еще не доступен для потоковой передачи в реальном времени?

    В этом случае источник служб мультимедиа `CDN-Origin-Assist-Prefetch-Path` не предоставит заголовок и предварительная выборка CDN не будет выполнена.

* Как `Origin-Assist CDN-Prefetch` работает с фильтрами динамических манифестов?

    Эта функция работает независимо от фильтра манифеста. Когда следующий фрагмент выходит за пределы окна фильтра, его URL-адрес по-прежнему будет находиться в необработанном клиентском манифесте, а затем возвращен как заголовок ответа на предварительную загрузку CDN. Поэтому CDN получит URL-адрес фрагмента, отфильтрованного из файла ТИРЕ/HLS/Smooth manifest. Однако проигрыватель никогда не будет выполнять запрос GET к CDN для получения этого фрагмента, поскольку этот фрагмент не включается в манифест ТИРЕ/HLS/Smooth, удерживаемый проигрывателем (проигрыватель не знает о существовании этого фрагмента).

* Могут ли быть выбраны ШТРИХовые или несглаженные манифесты MPD/HLS?

    Нет, штрих MPD, список воспроизведения основного списка HLS, список воспроизведения вариантов HLS или URL-адрес неравномерного манифеста не добавлен в заголовок предвыборки.

* URL-адреса предвыборки относительные или абсолютные?

    Хотя служба Akamai CDN допускает и то, и другое, источник служб мультимедиа предоставляет только относительные URL-адреса для пути предвыборки, поскольку нет очевидных преимуществ использования абсолютных URL-адресов.

* Работает ли эта функция с содержимым, защищенным с помощью DRM?

    Да, поскольку эта функция работает на уровне HTTP, она не расшифровывает и не анализирует какой-либо сегмент или фрагмент. Не важно, зашифровано ли содержимое.

* Работает ли эта функция с серверной вставкой AD (ССАИ)?
    
    Он предназначен для первоначального или основного содержимого (исходного видеосодержимого до вставки рекламы), так как ССАИ не изменяет метку времени исходного содержимого из источника служб мультимедиа. Работает ли эта функция со службой "содержимое AD", зависит от того, поддерживает ли источник рекламы поддержку происхождения. Например, если содержимое AD также размещается в службах мультимедиа Azure (то же или в отдельном источнике), содержимое рекламы также будет выделено.

* Работает ли эта функция с содержимым UHD/HEVC?

    Да.

## <a name="ask-questions-give-feedback-get-updates"></a>Получение справки, отправка отзывов, получение обновлений

Прочитайте статью [сообщества Служб мультимедиа Azure](media-services-community.md), чтобы узнать, как задавать вопросы, оставлять отзывы и получать новости о Службах мультимедиа.

## <a name="next-steps"></a>Дальнейшие действия

* Обязательно ознакомьтесь с [исходным документом конечной точки потоковой передачи](streaming-endpoint-concept.md) .
* [В этом репозитории](https://github.com/Azure-Samples/media-services-v3-dotnet-quickstarts/blob/master/AMSV3Quickstarts/EncodeAndStreamFiles/Program.cs) предоставлен пример запуска стандартной конечной точки потоковой передачи с помощью .NET.
