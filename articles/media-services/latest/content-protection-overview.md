---
title: Защита содержимого с помощью динамического шифрования службы мультимедиа — Azure | Документация Майкрософт
description: В этой статье представлен защиты содержимого с помощью динамического шифрования. Она также рассказывает о потоковых протоколов и типов шифрования.
services: media-services
documentationcenter: ''
author: Juliako
manager: femila
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/20/2019
ms.author: juliako
ms.custom: seodec18
ms.openlocfilehash: 984c5d6b5e6e2010489533a3889501c5b524a6bd
ms.sourcegitcommit: 90dcc3d427af1264d6ac2b9bde6cdad364ceefcc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/21/2019
ms.locfileid: "58311328"
---
# <a name="content-protection-with-dynamic-encryption"></a>Защита содержимого при использовании динамического шифрования

Службы мультимедиа Azure позволяют защитить данные мультимедиа, покидающие ваш компьютер, на этапах их хранения, обработки и доставки, а также доставлять в режиме реального времени и по требованию содержимое, зашифрованное динамически с помощью Advanced Encryption Standard (AES-128) или трех основных систем управления цифровыми правами (DRM): Microsoft PlayReady, Google Widevine и Apple FairPlay. Они также обеспечивают службу доставки ключей AES и лицензий DRM (PlayReady, Widevine и FairPlay) авторизованным клиентам. 

На следующем рисунке показан рабочий процесс защиты содержимого Служб мультимедиа: 

![Защита содержимого](./media/content-protection/content-protection.svg)

&#42; *динамическое шифрование поддерживает AES-128 "незащищенный ключ", CBCS и CENC. Для дополнительных сведений см. матрицу поддержки [здесь](#streaming-protocols-and-encryption-types).*

В этой статье объясняются основные понятия и термины, необходимые для понимания процесса защиты содержимого с помощью AMS.

## <a name="main-components-of-a-content-protection-system"></a>Основные компоненты системы защиты содержимого

Чтобы успешно завершить разработку проекта "защиты содержимого" системы или приложения, необходимо полностью представить объем трудозатрат. В следующем списке представлен обзор трех частей, которые необходимо применить. 

1. Код службы мультимедиа Azure
  
   [DRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM/Program.cs) образце показано, как реализовать систему мульти DRM с помощью Media Services v3, а также использовать службы доставки лицензий и ключей служб мультимедиа. Каждый ресурс можно зашифровать с помощью нескольких типов шифрования (AES-128, PlayReady, Widevine, FairPlay). Чтобы понять, что лучше объединять, см. раздел [Протоколы потоковой передачи и типы шифрования](#streaming-protocols-and-encryption-types).
  
   В примере показано, как выполнить следующие задачи.

   1. Создание и настройка [содержимого политики ключа](https://docs.microsoft.com/rest/api/media/contentkeypolicies).

      * Определите авторизацию доставки лицензии, определяющую логику проверки авторизации на основании утверждений в JWT.
      * Настройка шифрования DRM путем указания ключа содержимого.
      * Настройка [PlayReady](playready-license-template-overview.md), [Widevine](widevine-license-template-overview.md), и/или [FairPlay](fairplay-license-overview.md) лицензии. Шаблоны позволяют настраивать права и разрешения для каждого используемого DRM.

        ```
        ContentKeyPolicyPlayReadyConfiguration playReadyConfig = ConfigurePlayReadyLicenseTemplate();
        ContentKeyPolicyWidevineConfiguration widevineConfig = ConfigureWidevineLicenseTempate();
        ContentKeyPolicyFairPlayConfiguration fairPlayConfig = ConfigureFairPlayPolicyOptions();
        ```
   2. Создание [указатель потоковой передачи](https://docs.microsoft.com/rest/api/media/streaminglocators) , настроенный для потоковой передачи зашифрованного актива. 
  
      **Указатель потоковой передачи** должно быть связано с [потоковой передачи политики](https://docs.microsoft.com/rest/api/media/streamingpolicies). В приведенном примере задается StreamingLocator.StreamingPolicyName в политику «Predefined_MultiDrmCencStreaming». Эта политика, то будет для два ключа содержимого (конверта и CENC) для получения созданных и задания на указателя. Таким образом применяются шифрования типа конверт, PlayReady и Widevine (ключ доставляется клиенту воспроизведения на основе настроенных лицензий DRM). Если необходимо выполнить шифрование потока с помощью CBCS (FairPlay), используйте Predefined_MultiDrmStreaming.
    
      Поскольку нам требуется шифровать видео, **политики ключей содержимого** ранее мы настроили также имеет связанных с **указатель потоковой передачи**. 
    
   3. Создание тестового токена.

      Метод **GetTokenAsync** показывает, как создать тестовый токен.
   4. Создание URL-адреса потоковой передачи.

      Метод **GetDASHStreamingUrlAsync** показывает, как создать URL-адрес потоковой передачи. В этом примере URL-адрес передает содержимое **DASH**.

2. Проигрыватель с использованием клиента AES или DRM. Приложение видеопроигрывателя на основе пакета SDK проигрывателя (или собственное, или браузерное) должно отвечать следующим требованиям.
   * Пакет SDK проигрывателя поддерживает необходимые клиенты DRM
   * Пакет SDK проигрывателя поддерживает требуемые протоколы потоковой передачи: Smooth, DASH и/или HLS
   * Пакет SDK проигрывателя должен иметь возможность обрабатывать передачу маркера JWT в запросе на получение лицензии
  
     Проигрыватель можно создать с помощью [API проигрывателя мультимедиа Azure](https://amp.azure.net/libs/amp/latest/docs/). [API ProtectionInfo Проигрывателя мультимедиа Azure](https://amp.azure.net/libs/amp/latest/docs/) позволяет указать, какие технологии DRM следует использовать на разных платформах DRM.

     Для тестирования зашифрованного содержимого AES или CENC (Widevine и (или) PlayReady) можно использовать [Проигрыватель мультимедиа Azure](https://ampdemo.azureedge.net/azuremediaplayer.html). Обязательно щелкните "Дополнительные параметры" и проверьте параметры шифрования.

     Если необходимо протестировать зашифрованное содержимое FairPlay, используйте [этот тестовый проигрыватель](https://aka.ms/amtest). Проигрыватель поддерживает DRM Widevine, PlayReady и FairPlay, а также шифрование незащищенного ключа AES-128. 
    
     Необходимо выбрать правильный браузер для тестирования различных систем управления цифровыми правами: Chrome/Opera/Firefox для Widevine, Microsoft Edge и IE 11 для PlayReady, Safari в macOS для FairPlay.

3. Служба токенов безопасности (STS), которая выдает JSON Web Token (JWT) в качестве маркера доступа для доступа к серверному ресурсу. Как серверный ресурс можно использовать службу доставки лицензий AMS. Служба токенов безопасности должна определять следующие данные.

   * Издатель и аудитория (или область)
   * Утверждения, которые зависят от бизнес-требований защиты содержимого
   * Симметричные или асимметричные проверки для проверки подписи
   * Поддержка смены ключей (при необходимости)

     Вы можете использовать [это средство службы токенов безопасности](https://openidconnectweb.azurewebsites.net/DRMTool/Jwt) для тестирования службы токенов безопасности, которое поддерживает все 3 типа ключей проверки: симметричный, асимметричный и Azure AD со сменой ключей. 

> [!NOTE]
> Настоятельно рекомендуется сосредоточиться и полностью проверить каждый элемент (описанный выше), прежде чем перейти к следующей части. Чтобы протестировать систему "защиты содержимого", используйте средства, указанные в списке выше.  

## <a name="streaming-protocols-and-encryption-types"></a>Протоколы потоковой передачи и типы шифрования

Службы мультимедиа Azure доставляют содержимое, динамически зашифрованное с помощью незащищенного ключа AES или шифрования DRM путем использования PlayReady, Widevine или FairPlay. Сейчас поддерживается шифрование в форматах HTTP Live Streaming (HLS), MPEG DASH и Smooth Streaming. Каждый протокол поддерживает следующие методы шифрования.

### <a name="hls"></a>HLS

Протокола HLS поддерживает следующие форматы контейнеров и схемы шифрования.

|Формат контейнера|Схема шифрования|Пример URL-адреса|
|---|---|---|
|Все|AES|`https://amsv3account-usw22.streaming.media.azure.net/<id>/ignite.ism/manifest(format=m3u8-aapl,encryption=cbc)`|
|MPG2-TS |CBCS (FairPlay) ||
|CMAF(fmp4) |CBCS (FairPlay) |`https://amsv3account-usw22.streaming.media.azure.net/<id>/ignite.ism/manifest(format=m3u8-cmaf,encryption=cbcs-aapl)`|
|MPG2-TS |CENC (PlayReady) ||
|CMAF(fmp4) |CENC (PlayReady) ||

HLS/CMAF + FairPlay (включая HEVC / H.265) поддерживается на следующих устройствах:

* версии iOS 11 или более поздней версии 
* iPhone 8 или более поздней версии
* MacOS high Sierra на сайте Intel 7 Gen ЦП

### <a name="mpeg-dash"></a>MPEG-DASH

MPEG-DASH протокол поддерживает следующие форматы контейнеров и схемы шифрования.

|Формат контейнера|Схема шифрования|Примеры URL-адресов
|---|---|---|
|Все|AES|`https://amsv3account-usw22.streaming.media.azure.net/<id>/ignite.ism/manifest(format=mpd-time-csf,encryption=cbc)`|
|CSF(fmp4) |CENC (Widevine + PlayReady) |`https://amsv3account-usw22.streaming.media.azure.net/<id>/ignite.ism/manifest(format=mpd-time-csf,encryption=cenc)`|
|CMAF(fmp4)|CENC (Widevine + PlayReady)||

### <a name="smooth-streaming"></a>Smooth Streaming

Протокол Smooth Streaming поддерживает следующие форматы контейнеров и схемы шифрования.

|Протокол|Формат контейнера|Схема шифрования|
|---|---|---|
|fMP4|AES||
|fMP4 | CENC (PlayReady) |`https://amsv3account-usw22.streaming.media.azure.net/<id>/ignite.ism/manifest(encryption=cenc)`|

### <a name="browsers"></a>Браузеры

Распространенные браузеры поддерживают следующие клиенты DRM:

|"Обзор"|Шифрование|
|---|---|
|Chrome|Widevine|
|Edge, IE 11|PlayReady|
|Firefox|Widevine|
|Opera|Widevine|
|Safari|FairPlay|

## <a name="aes-128-clear-key-vs-drm"></a>Незащищенный ключ AES-128 и DRM

Клиенты часто интересуются, следует ли им использовать шифрование AES или систему DRM. Основное различие между двумя системами является то, что с помощью шифрования AES ключ содержимого передается клиенту через TLS, чтобы ключ шифруется при передаче, но без какого-либо дополнительных шифрования («в чистом виде»). В результате ключ, используемый для расшифровки содержимого доступен клиентским проигрывателем и можно просмотреть в сетевой трассировке на стороне клиента в виде обычного текста. Шифрование незащищенного ключа AES-128 подходит для использования в случаях, когда зритель является доверенным лицом (например, шифрование корпоративного видео, распространяемого внутри компании, для просмотра сотрудниками).

Систем DRM, например PlayReady, Widevine и FairPlay, обеспечивают дополнительный уровень шифрования на ключ, используемый для расшифровки содержимого, по сравнению с незащищенным ключом AES-128. Ключ содержимого шифруется на ключ, защищенный средой выполнения DRM в дополнительные компоненты для какого-либо шифрования уровня транспорта, предоставляемых TLS. Кроме того, расшифровка выполняется в защищенной среде на уровне операционной системы, где злоумышленнику труднее атаковать. Мы рекомендуем использовать DRM в случаях, когда зритель не может быть доверенным лицом, и вам нужен самый высокий уровень безопасности.

## <a name="dynamic-encryption-and-key-delivery-service"></a>Динамическое шифрование и службы доставки ключей

В версии 3 службы мультимедиа, ключ содержимого связан с указатель потоковой передачи (см. в разделе [в этом примере](protect-with-aes128.md)). Если с помощью службы доставки ключей служб мультимедиа, можно позволить создать ключ содержимого для вас служб мультимедиа Azure. Ключ содержимого необходимо создать самостоятельно, если вы используете собственную службу доставки ключей или если необходимо обрабатывать сценарий высокой доступности, где нужно иметь один и тот же ключ содержимого в двух центрах обработки данных.

Когда поток запрашивается проигрывателем, Службы мультимедиа используют указанный ключ для динамического шифрования содержимого с помощью незащищенного ключа AES или DRM. Чтобы расшифровать поток, проигрыватель запросит ключ у службы доставки ключей служб мультимедиа или в указанной вами службе доставки ключей. Чтобы определить, есть ли у пользователя право на получение ключа, служба оценит политику ключа содержимого, заданную для него.

Службы мультимедиа предоставляют службу доставки ключей для доставки лицензий DRM (PlayReady, Widevine и FairPlay) и ключей AES авторизованным клиентам. Чтобы настроить политики авторизации и аутентификации для лицензий и ключей, можно использовать REST API или клиентскую библиотеку мультимедиа.

### <a name="custom-key-and-license-acquisition-url"></a>Пользовательский ключ и лицензии приобретения URL-адрес

Используйте следующие шаблоны, если вы хотите указать другой ключ и лицензии доставки службе (не для служб мультимедиа). Можно заменить два поля в шаблонах существуют ли, что позволяет использовать политики потоковой передачи для многих других активов, вместо того чтобы создавать политики потоковой передачи на актив. 

* EnvelopeEncryption.CustomKeyAcquisitionUrlTemplate - шаблон для URL-адрес пользовательской службы доставки ключей проигрыватели конечных пользователей. Не требуется при использовании служб мультимедиа Azure для выдачи ключей. Шаблон поддерживает заменяемых лексем, оно будет обновляться службой во время выполнения с помощью значение, относящимся к запросу.  В настоящее время поддерживаются значения маркера, {AlternativeMediaId}, который заменяется значением StreamingLocatorId.AlternativeMediaId и {ContentKeyId}, которой заменяется значение идентификатора запрошенного ключа.
* StreamingPolicyPlayReadyConfiguration.CustomLicenseAcquisitionUrlTemplate - шаблон для URL-адрес пользовательской службы доставки лицензий для конечных пользователей игроков. Не требуется при использовании служб мультимедиа Azure для выдачей лицензий. Шаблон поддерживает заменяемых лексем, оно будет обновляться службой во время выполнения с помощью значение, относящимся к запросу. В настоящее время поддерживаются значения маркера, {AlternativeMediaId}, который заменяется значением StreamingLocatorId.AlternativeMediaId и {ContentKeyId}, которой заменяется значение идентификатора запрошенного ключа. 
* StreamingPolicyWidevineConfiguration.CustomLicenseAcquisitionUrlTemplate - аналогично описанному выше, только для Widevine. 
* StreamingPolicyFairPlayConfiguration.CustomLicenseAcquisitionUrlTemplate - аналогично описанному выше, только для FairPlay.  

Например: 

```csharp
streamingPolicy.EnvelopEncryption.customKeyAcquisitionUrlTemplate = "https://mykeyserver.hostname.com/envelopekey/{AlternativeMediaId}/{ContentKeyId}";
```

`ContentKeyId` Имеет значение запрошенного ключа и `AlternativeMediaId` можно использовать в том случае, если вы хотите сопоставить запрос сущности с вашей стороны. Например `AlternativeMediaId` можно использовать для помощи разрешений.

Примеры использования REST, использующих пользовательский раздел и URL-адреса приобретения лицензий, см. в разделе [политики потоковой передачи - Создание](https://docs.microsoft.com/rest/api/media/streamingpolicies/create)

## <a name="control-content-access"></a>Доступ к содержимому элемента управления

Вы можете контролировать пользователей, имеющих доступ к содержимому, настроив политику ключей содержимого. Службы мультимедиа поддерживают несколько способов авторизации пользователей, которые запрашивают ключи. Потребуется настроить политику ключей содержимого. Прежде чем ключ будет доставлен клиенту (проигрыватель), он должен быть приведен в соответствие с политикой. Политика ключей содержимого может иметь ограничения по **открытию** или по **маркеру**. 

При использовании политики ключей содержимого с ограничением по маркеру ключ содержимого будет отправлен только тому клиенту, который предоставит в запросе ключа или лицензии действующий токен JSON Web Token (JWT) или простой веб-токен (SWT). Этот токен должен быть выдан службой токенов безопасности (STS). Вы можете использовать Azure Active Directory в качестве STS или развернуть пользовательскую службу токенов безопасности. Чтобы создать маркер, подписанный указанным ключом, и получить утверждения, указанные в конфигурации ограничения по маркерам, должна быть настроена служба маркеров безопасности. Служба доставки ключей Служб мультимедиа возвращает клиенту запрошенный ключ (или лицензию), если маркер является допустимым, а его утверждения соответствуют утверждениям, настроенным для ключа (или лицензии).

При настройке политики ограничения по маркеру необходимо задать такие параметры, как основной ключ проверки, издатель и аудитория. Основной ключ проверки содержит ключ, которым был подписан маркер. Издателем является служба токенов безопасности, которая выдает токен. Аудитория, иногда называемая областью, описывает назначение маркера или ресурс, доступ к которому обеспечивает маркер. Служба доставки ключей служб мультимедиа проверяет, соответствуют ли эти значения в маркере значениям в шаблоне.

Клиенты часто используют пользовательскую службу STS, чтобы включить настраиваемые утверждения в маркере для выбора между разных ContentKeyPolicyOptions с разными параметрами лицензии DRM (лицензия на подписку и лицензия аренды) или для включения Заявка, представляющая ключ содержимого Идентификатор ключа, который предоставляет доступ маркер.
 
## <a name="storage-side-encryption"></a>Шифрование на стороне хранилища

Чтобы защитить неактивные ресурсы, их нужно зашифровать на стороне хранилища. В следующей таблице показано, как происходит шифрование на стороне хранилища в службах мультимедиа версии 3.

|Вариант шифрования|ОПИСАНИЕ|Службы мультимедиа версии 3|
|---|---|---|
|Шифрование хранилища Служб мультимедиа| Шифрование AES-256. Ключами управляют Службы мультимедиа|Не поддерживается<sup>(1)</sup>|
|[Шифрование службы хранилища для неактивных данных](https://docs.microsoft.com/azure/storage/common/storage-service-encryption)|Шифрование на стороне сервера, предоставляемое службой хранилища Azure. Ключами управляет Azure или клиент|Поддерживаются|
|[Шифрование хранилища на стороне клиента](https://docs.microsoft.com/azure/storage/common/storage-client-side-encryption)|Шифрование на стороне клиента, предоставляемое службой хранилища Azure. Ключами управляет клиент в Key Vault|Не поддерживается|

<sup>1</sup> В Службах мультимедиа версии 3 для обратной совместимости поддерживается шифрование хранилища (шифрование AES-256), только если ресурсы созданы с помощью Служб мультимедиа версии 2. То есть версия 3 работает с существующими зашифрованными ресурсами хранилища, но создание новых ресурсов не поддерживается.

## <a name="troubleshoot"></a>Устранение неполадок

Если вы получаете `MPE_ENC_ENCRYPTION_NOT_SET_IN_DELIVERY_POLICY` ошибку, убедитесь, что указано соответствующую политику потоковой передачи.

Если возникают ошибки, которые заканчиваются `_NOT_SPECIFIED_IN_URL`, убедитесь, что указывать формат шифрования в URL-адрес. Например, `…/manifest(format=m3u8-cmaf,encryption=cbcs-aapl)`. См. в разделе [потоковых протоколов и типов шифрования](#streaming-protocols-and-encryption-types).


## <a name="next-steps"></a>Дальнейшие действия

* [Использование динамического шифрования AES-128 и службы доставки ключей](protect-with-aes128.md)
* [Защита с помощью DRM](protect-with-drm.md)
* [Проектирование системы защиты содержимого с несколькими DRM с помощью управления доступом](design-multi-drm-system-with-access-control.md)
* [Часто задаваемые вопросы](frequently-asked-questions.md)

