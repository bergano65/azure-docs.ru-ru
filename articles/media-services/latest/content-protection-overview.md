---
title: Защита содержимого с помощью динамического шифрования служб мультимедиа в Azure | Документация Майкрософт
description: В этой статье приводятся общие сведения о защите содержимого с помощью динамического шифрования. Он также рассказывает о протоколах потоковой передачи и типах шифрования.
services: media-services
documentationcenter: ''
author: Juliako
manager: femila
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/17/2019
ms.author: juliako
ms.custom: seodec18
ms.openlocfilehash: 174184993e40b60dc89022d360f0c09fb31bc60b
ms.sourcegitcommit: a0b37e18b8823025e64427c26fae9fb7a3fe355a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/25/2019
ms.locfileid: "68501269"
---
# <a name="protect-your-content-by-using-media-services-dynamic-encryption"></a>Защита содержимого с помощью динамического шифрования служб мультимедиа

Службы мультимедиа Azure можно использовать для защиты носителей от времени, когда он оставляет компьютер за счет использования хранилища, обработки и доставки. а также доставлять в режиме реального времени и по требованию содержимое, зашифрованное динамически с помощью Advanced Encryption Standard (AES-128) или трех основных систем управления цифровыми правами (DRM): Microsoft PlayReady, Google Widevine и Apple FairPlay. Они также обеспечивают службу доставки ключей AES и лицензий DRM (PlayReady, Widevine и FairPlay) авторизованным клиентам.  

В службах мультимедиа v3 ключ содержимого связан с указателем потоковой передачи (см. [Этот пример](protect-with-aes128.md)). При использовании службы доставки ключей служб мультимедиа вы можете разрешить службам мультимедиа Azure создавать ключ содержимого. Ключ содержимого следует создавать самостоятельно, если вы используете собственную службу доставки ключей или хотите реализовать сценарий высокого уровня доступности, в котором необходимо иметь один и тот же ключ содержимого в двух центрах обработки данных.

Когда поток запрашивается проигрывателем, Службы мультимедиа используют указанный ключ для динамического шифрования содержимого с помощью незащищенного ключа AES или DRM. Чтобы расшифровать поток, проигрыватель запросит ключ у службы доставки ключей служб мультимедиа или в указанной вами службе доставки ключей. Чтобы определить, есть ли у пользователя право на получение ключа, служба оценит политику ключа содержимого, заданную для него.

Чтобы настроить политики авторизации и аутентификации для лицензий и ключей, можно использовать REST API или клиентскую библиотеку мультимедиа.

На следующем рисунке показан рабочий процесс для защиты содержимого служб мультимедиа:

![Рабочий процесс для защиты содержимого служб мультимедиа](./media/content-protection/content-protection.svg)
  
&#42;*Динамическое шифрование поддерживает алгоритмы AES-128 Clear Key, CBCS и CENC. Дополнительные сведения см. в [матрице поддержки](#streaming-protocols-and-encryption-types).*

В этой статье описываются основные понятия и терминология, помогающие понять защиту содержимого с помощью служб мультимедиа.

## <a name="main-components-of-a-content-protection-system"></a>Основные компоненты системы защиты содержимого

Чтобы успешно завершить работу системы защиты содержимого, необходимо полностью понять область усилий. В следующих разделах представлен обзор трех частей, которые необходимо реализовать. 

> [!NOTE]
> Мы настоятельно рекомендуем сосредоточиться и полностью проверить каждую часть в следующих разделах, прежде чем переходить к следующей части. Чтобы протестировать систему защиты содержимого, используйте средства, указанные в разделах.

### <a name="media-services-code"></a>Код служб мультимедиа
  
В [примере DRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM/Program.cs) показано, как реализовать систему с несколькими DRM с помощью служб мультимедиа v3 с использованием .NET. В нем также показано, как использовать службу доставки лицензий и ключей служб мультимедиа.   
  
Каждый ресурс можно зашифровать с помощью нескольких типов шифрования (AES-128, PlayReady, Widevine, FairPlay). Чтобы узнать, что имеет смысл комбинировать, см. раздел [протоколы потоковой передачи и типы шифрования](#streaming-protocols-and-encryption-types).

В примере показано, как выполнить следующие задачи.

1. Создание и настройка [политики ключа содержимого](content-key-policy-concept.md).    

   Создайте политику ключа содержимого, чтобы настроить способ доставки ключа содержимого (который обеспечивает безопасный доступ к вашим ресурсам) конечным клиентам.  
 
   * Определение авторизации доставки лицензий. Укажите логику проверки авторизации на основе утверждений в JSON Web Token (JWT).
   * Настройте лицензии [PlayReady](playready-license-template-overview.md), [Widevine](widevine-license-template-overview.md)и/или [Fairplay](fairplay-license-overview.md) . Шаблоны позволяют настраивать права и разрешения для каждого DRM.

     ```
     ContentKeyPolicyPlayReadyConfiguration playReadyConfig = ConfigurePlayReadyLicenseTemplate();
     ContentKeyPolicyWidevineConfiguration widevineConfig = ConfigureWidevineLicenseTempate();
     ContentKeyPolicyFairPlayConfiguration fairPlayConfig = ConfigureFairPlayPolicyOptions();
     ```
2. Создайте [указатель потоковой передачи](streaming-locators-concept.md) , настроенный на потоковую передачу зашифрованного ресурса. 
  
   Указатель потоковой передачи должен быть связан с [политикой потоковой передачи](streaming-policy-concept.md). В этом примере мы установили `StreamingLocator.StreamingPolicyName` политику "Predefined_MultiDrmCencStreaming". 
      
   Применяются шифрования PlayReady и Widevine, а ключ доставляется клиенту воспроизведения на основе настроенных лицензий DRM. Если вы также хотите зашифровать поток с помощью CBCS (FairPlay), используйте политику "Predefined_MultiDrmStreaming".

   Указатель потоковой передачи также связан с определенной политикой ключа содержимого.
3. Создание тестового токена.

   `GetTokenAsync` Метод показывает, как создать тестовый маркер.
4. Создание URL-адреса потоковой передачи.

   `GetDASHStreamingUrlAsync` Метод показывает, как создать URL-адрес потоковой передачи. В этом случае URL-адрес отправляет ТИРЕ содержимое.

### <a name="player-with-an-aes-or-drm-client"></a>Проигрыватель с клиентом AES или DRM 

Приложение видеопроигрывателя на основе пакета SDK проигрывателя (или собственное, или браузерное) должно отвечать следующим требованиям.

* Пакет SDK для проигрывателя поддерживает необходимые клиенты DRM.
* Пакет SDK проигрывателя поддерживает требуемые протоколы потоковой передачи: Smooth, ТИРЕ и (или) HLS.
* Пакет SDK для проигрывателя может справиться с передачей маркера JWT в запрос на приобретение лицензии.

Проигрыватель можно создать с помощью [API проигрывателя мультимедиа Azure](https://amp.azure.net/libs/amp/latest/docs/). [API ProtectionInfo Проигрывателя мультимедиа Azure](https://amp.azure.net/libs/amp/latest/docs/) позволяет указать, какие технологии DRM следует использовать на разных платформах DRM.

Для тестирования зашифрованного содержимого AES или CENC (Widevine и (или) PlayReady) можно использовать [Проигрыватель мультимедиа Azure](https://aka.ms/azuremediaplayer). Убедитесь, что выбраны **Дополнительные параметры** , и проверьте параметры шифрования.

Если необходимо протестировать зашифрованное содержимое FairPlay, используйте [этот тестовый проигрыватель](https://aka.ms/amtest). Проигрыватель поддерживает Widevine, PlayReady и FairPlay DRM, а также шифрование AES-128 с открытым ключом. 

Выберите правильный браузер, чтобы проверить различные DRM:

* Chrome, Opera или Firefox для Widevine
* Microsoft ребро или Internet Explorer 11 для PlayReady
* Safari на macOS для FairPlay

### <a name="security-token-service"></a>Служба маркеров безопасности

Служба маркеров безопасности (STS) выдает JWT в качестве маркера доступа для доступа к ресурсам серверной части. В качестве серверного ресурса можно использовать службу доставки лицензий или ключей служб мультимедиа Azure. Служба токенов безопасности должна определять следующие данные.

* Издатель и аудитория (или область)
* Утверждения, которые зависят от бизнес-требований защиты содержимого
* Симметричные или асимметричные проверки для проверки подписи
* Поддержка смены ключей (при необходимости)

[Это средство STS](https://openidconnectweb.azurewebsites.net/DRMTool/Jwt) можно использовать для проверки STS. Он поддерживает все три типа ключей проверки: симметричное, асимметричное или Azure Active Directory (Azure AD) с сменой ключей. 

## <a name="streaming-protocols-and-encryption-types"></a>Протоколы потоковой передачи и типы шифрования

Службы мультимедиа Azure доставляют содержимое, динамически зашифрованное с помощью незащищенного ключа AES или шифрования DRM путем использования PlayReady, Widevine или FairPlay. Сейчас поддерживается шифрование в форматах HTTP Live Streaming (HLS), MPEG DASH и Smooth Streaming. Каждый протокол поддерживает следующие методы шифрования.

### <a name="hls"></a>HLS

Протокол HLS поддерживает следующие форматы контейнеров и схемы шифрования.

|Формат контейнера|Схема шифрования|Пример URL-адреса|
|---|---|---|
|Все|AES|`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-aapl,encryption=cbc)`|
|MPG2-TS |CBCS (FairPlay) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-aapl,encryption=cbcs-aapl)`|
|CMAF(fmp4) |CBCS (FairPlay) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-cmaf,encryption=cbcs-aapl)`|
|MPG2-TS |CENC (PlayReady) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-aapl,encryption=cenc)`|
|CMAF(fmp4) |CENC (PlayReady) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-cmaf,encryption=cenc)`|

HLS/КМАФ + FairPlay (включая HEVC/H. 265) поддерживается на следующих устройствах:

* iOS 11 или более поздней версии 
* iPhone 8 или более поздней версии
* MacOS High Сьерра с ПРОЦЕССОРом поколения Intel 7

### <a name="mpeg-dash"></a>MPEG-DASH

Протокол MPEG-ТИРЕ поддерживает следующие форматы контейнеров и схемы шифрования.

|Формат контейнера|Схема шифрования|Примеры URL-адресов
|---|---|---|
|Все|AES|`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=mpd-time-csf,encryption=cbc)`|
|CSF(fmp4) |CENC (Widevine + PlayReady) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=mpd-time-csf,encryption=cenc)`|
|CMAF(fmp4)|CENC (Widevine + PlayReady)|`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=mpd-time-cmaf,encryption=cenc)`|

### <a name="smooth-streaming"></a>Smooth Streaming

Протокол Smooth Streaming поддерживает следующие форматы контейнеров и схемы шифрования.

|Протокол|Формат контейнера|Схема шифрования|
|---|---|---|
|fMP4|AES|`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(encryption=cbc)`|
|fMP4 | CENC (PlayReady) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(encryption=cenc)`|

### <a name="browsers"></a>Браузеры

Общие браузеры поддерживают следующие клиенты DRM:

|Browser|Шифрование|
|---|---|
|Chrome|Widevine|
|Microsoft ребро, Internet Explorer 11|PlayReady|
|Firefox|Widevine|
|Opera|Widevine|
|Safari|FairPlay|

## <a name="controlling-content-access"></a>Управление доступом к содержимому

Вы можете контролировать пользователей, имеющих доступ к содержимому, настроив политику ключей содержимого. Службы мультимедиа поддерживают несколько способов авторизации пользователей, которые запрашивают ключи. Потребуется настроить политику ключей содержимого. Прежде чем ключ будет доставлен клиенту (проигрыватель), он должен быть приведен в соответствие с политикой. Политика ключей содержимого может иметь ограничения по *открытию* или по *маркеру*. 

Если вы хотите выдать лицензию любому пользователю без авторизации, то может использоваться политика с открытым доступом к содержимому. Например, если ваш доход основан на AD и не основан на подписке.  

При использовании политики ключа содержимого с ограниченным маркером ключ содержимого отправляется только клиенту, который представляет допустимый маркер JWT или простой веб-токен в запросе лицензии или ключа. Этот маркер должен быть выдан службой STS. 

Вы можете использовать Azure AD в качестве STS или развернуть пользовательскую STS. Чтобы создать маркер, подписанный указанным ключом, и получить утверждения, указанные в конфигурации ограничения по маркерам, должна быть настроена служба маркеров безопасности. Служба доставки лицензий и ключей служб мультимедиа возвращает клиенту запрошенную лицензию или ключ, если оба эти условия существуют:

* Токен является допустимым. 
* Утверждения в маркере соответствуют параметрам, настроенным для лицензии или ключа.

При настройке политики ограничения по маркеру необходимо задать такие параметры, как основной ключ проверки, издатель и аудитория. Основной ключ проверки содержит ключ, которым был подписан маркер. Издателем является служба STS, которая выдала маркер. Аудитория, иногда называемая областью, описывает назначение маркера или ресурса, к которому этот маркер разрешает доступ. Служба доставки лицензий и ключей служб мультимедиа проверяет, совпадают эти значения в маркере со значениями в шаблоне.

### <a name="token-replay-prevention"></a>Предотвращение воспроизведения токенов

Функция *предотвращения воспроизведения маркеров* позволяет клиентам служб мультимедиа устанавливать ограничения на то, сколько раз один и тот же маркер можно использовать для запроса ключа или лицензии. Клиент может добавить утверждение типа `urn:microsoft:azure:mediaservices:maxuses` в маркер, где значение — это количество раз, когда маркер может быть использован для получения лицензии или ключа. Все последующие запросы с одинаковым токеном к доставке ключей будут возвращать несанкционированный ответ. См. статью как добавить утверждение в [Пример DRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM/Program.cs#L601).
 
#### <a name="considerations"></a>Рекомендации

* Клиенты должны иметь контроль над созданием маркеров. Утверждение необходимо поместить в сам маркер.
* При использовании этой функции запросы с маркерами, срок действия которых превышает один час с момента получения запроса, отклоняются с несанкционированным ответом.
* Маркеры уникально идентифицируются их сигнатурой. Любое изменение полезных данных (например, обновление до срока действия или утверждения) приводит к изменению подписи маркера и будет считаться новым маркером, который не был обнаружен до момента доставки ключа.
* Воспроизведение завершается ошибкой, если маркер превысил `maxuses` значение, установленное клиентом.
* Эта функция может использоваться для всего существующего защищенного содержимого (необходимо изменить только выданный маркер).
* Эта функция работает как с JWT, так и с SWT.

## <a name="using-a-custom-sts"></a>Использование пользовательской STS

Клиент может использовать пользовательскую STS для предоставления маркеров. Некоторые из причин:

* Поставщик удостоверений (IDP), используемый клиентом, не поддерживает STS. В этом случае решение — использовать пользовательскую службу STS.
* Клиенту может потребоваться более гибкий или более жесткий контроль при интеграции STS с системой выставления счетов подписчика клиента. Например, оператор MVPD может предлагать несколько пакетов подписчиков OTT, таких как Premium, Basic, Sports и т. д. Оператору может потребоваться сопоставить утверждения в маркере с пакетом подписчика, чтобы предоставлялось только содержимое в определенном пакете. В этом случае пользовательская STS предоставляет необходимую гибкость и контроль.
* Включение пользовательских утверждений в маркер для выбора между разными Контенткэйполициоптионс с различными параметрами лицензии DRM (лицензия на подписку и лицензия на аренду).
* Для включения утверждения, представляющего идентификатор ключа содержимого ключа, к которому маркер предоставляет доступ.

При применении пользовательской STS необходимо внести два изменения:

* При настройке службы доставки лицензий для ресурса необходимо указать ключ безопасности, используемый для проверки пользовательской STS вместо текущего ключа из Azure Active Directory.
* Когда создается маркер JTW, вместо закрытого ключа текущего сертификата X509 в Azure AD указан ключ безопасности.

Существует два типа ключей безопасности:

* Симметричный ключ: для создания и проверки маркера JWT используется один ключ.
* Асимметричный ключ: пара открытого и закрытого ключей в сертификате X509 используется с закрытым ключом для шифрования и создания маркера JWT и с открытым ключом для проверки маркера.

При использовании .NET Framework/C# в качестве платформы разработки сертификат X509, используемый для асимметричного ключа безопасности, должен иметь длину ключа минимум 2048 бит. Это требование класса System.IdentityModel.Tokens.X509AsymmetricSecurityKey в .NET Framework. В противном случае будет создано следующее исключение: IDX10630: The 'System.IdentityModel.Tokens.X509AsymmetricSecurityKey' for signing cannot be smaller than '2048' bits. (IDX10630: System.IdentityModel.Tokens.X509AsymmetricSecurityKey для подписи не может быть менее 2048 бит).

## <a name="custom-key-and-license-acquisition-url"></a>Пользовательский ключ и URL-адрес для получения лицензии

Используйте следующие шаблоны, если вы хотите указать другую лицензию или службу доставки ключей (не службы мультимедиа). Два заменяемых поля в шаблонах позволяют совместно использовать политику потоковой передачи во многих ресурсах вместо создания политики потоковой передачи для каждого ресурса. 

* `EnvelopeEncryption.CustomKeyAcquisitionUrlTemplate`. Шаблон для URL-адреса настраиваемой службы, которая доставляет ключи конечным пользователям. Это не требуется, если вы используете службы мультимедиа Azure для выпуска ключей. 

   Шаблон поддерживает заменяемые токены, которые служба будет обновлять во время выполнения, со значением, характерным для запроса.  В настоящее время поддерживаются следующие значения маркеров:
   * `{AlternativeMediaId}`, который заменяется значением Стреаминглокаторид. Алтернативемедиаид.
   * `{ContentKeyId}`, который заменяется значением идентификатора запрошенного ключа.
* `StreamingPolicyPlayReadyConfiguration.CustomLicenseAcquisitionUrlTemplate`. Шаблон для URL-адреса настраиваемой службы, которая доставляет лицензии для конечных пользователей. Это не обязательно, если вы используете службы мультимедиа Azure для выдачи лицензий. 

   Шаблон поддерживает заменяемые токены, которые служба будет обновлять во время выполнения, со значением, характерным для запроса. В настоящее время поддерживаются следующие значения маркеров:  
   * `{AlternativeMediaId}`, который заменяется значением Стреаминглокаторид. Алтернативемедиаид.
   * `{ContentKeyId}`, который заменяется значением идентификатора запрошенного ключа. 
* `StreamingPolicyWidevineConfiguration.CustomLicenseAcquisitionUrlTemplate`. Аналогичен предыдущему шаблону, только для Widevine. 
* `StreamingPolicyFairPlayConfiguration.CustomLicenseAcquisitionUrlTemplate`. Аналогичен предыдущему шаблону, только для FairPlay.  

Пример:

```csharp
streamingPolicy.EnvelopEncryption.customKeyAcquisitionUrlTemplate = "https://mykeyserver.hostname.com/envelopekey/{AlternativeMediaId}/{ContentKeyId}";
```

`ContentKeyId`имеет значение запрошенного ключа. Вы можете использовать `AlternativeMediaId` , если хотите сопоставлять запрос с сущностью на стороне. Например, `AlternativeMediaId` можно использовать для поиска разрешений.

 Примеры использования пользовательских лицензий и URL-адресов для получения ключей см. в разделе [политики потоковой передачи — создание](https://docs.microsoft.com/rest/api/media/streamingpolicies/create).

## <a name="troubleshoot"></a>Устранение неполадок

Если возникает `MPE_ENC_ENCRYPTION_NOT_SET_IN_DELIVERY_POLICY` ошибка, убедитесь, что указана соответствующая политика потоковой передачи.

При возникновении ошибок, которые заканчиваются `_NOT_SPECIFIED_IN_URL`на, убедитесь, что в URL-адресе указан формат шифрования. Например, `…/manifest(format=m3u8-cmaf,encryption=cbcs-aapl)`. См. раздел [протоколы потоковой передачи и типы шифрования](#streaming-protocols-and-encryption-types).

## <a name="ask-questions-give-feedback-get-updates"></a>Получение справки, отправка отзывов, получение обновлений

Прочитайте статью [сообщества Служб мультимедиа Azure](media-services-community.md), чтобы узнать, как задавать вопросы, оставлять отзывы и получать новости о Службах мультимедиа.

## <a name="next-steps"></a>Следующие шаги

* [Использование динамического шифрования AES-128 и службы доставки ключей](protect-with-aes128.md)
* [Защита с помощью DRM](protect-with-drm.md)
* [Разработка системы защиты содержимого с несколькими DRM с помощью контроля доступа](design-multi-drm-system-with-access-control.md)
* [Шифрование на стороне хранилища](storage-account-concept.md#storage-side-encryption)
* [Часто задаваемые вопросы](frequently-asked-questions.md)

