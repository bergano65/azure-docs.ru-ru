---
title: Фильтры и динамические манифесты Служб мультимедиа Azure | Документация Майкрософт
description: В этом разделе описывается создание фильтров, с помощью которых клиент может передавать определенные секции потока. Для достижения такой выборочной потоковой передачи службы мультимедиа создают динамические манифесты.
services: media-services
documentationcenter: ''
author: Juliako
manager: femila
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: ne
ms.topic: article
ms.date: 02/27/2019
ms.author: juliako
ms.openlocfilehash: 57007674e11271e6a3d5bdf660531d01b1eff82c
ms.sourcegitcommit: 5839af386c5a2ad46aaaeb90a13065ef94e61e74
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/18/2019
ms.locfileid: "57861440"
---
# <a name="dynamic-manifests"></a>Динамические манифесты

Службы мультимедиа предоставляют **динамические манифесты** на основе предварительно определенных фильтров. После определения фильтров (см. [соответствующий раздел](filters-concept.md)) клиенты могут использовать их для потоковой передачи определенного представления или субклипов видео. Фильтры указываются в URL-адресе потоковой передачи. Фильтры можно применять к протоколам потоковой передачи с переменной скоростью: Apple HTTP Live Streaming (HLS), MPEG-DASH и Smooth Streaming. 

В представленной ниже таблице приводятся некоторые примеры URL-адресов с фильтрами.

|Протокол|Пример|
|---|---|
|HLS|`https://amsv3account-usw22.streaming.media.azure.net/fecebb23-46f6-490d-8b70-203e86b0df58/bigbuckbunny.ism/manifest(format=m3u8-aapl,filter=myAccountFilter)`|
|MPEG DASH|`https://amsv3account-usw22.streaming.media.azure.net/fecebb23-46f6-490d-8b70-203e86b0df58/bigbuckbunny.ism/manifest(format=mpd-time-csf,filter=myAssetFilter)`|
|Smooth Streaming|`https://amsv3account-usw22.streaming.media.azure.net/fecebb23-46f6-490d-8b70-203e86b0df58/bigbuckbunny.ism/manifest(filter=myAssetFilter)`|

> [!NOTE]
> Динамические манифесты не меняют актив и его манифест по умолчанию. Клиент может запросить поток с фильтрами или без них. 
> 

В этом разделе объясняются понятия, связанные с **динамическими манифестами**, и приводятся примеры сценариев, в которых может потребоваться эта функция.

## <a name="manifests-overview"></a>Общие сведения о манифестах

Службы мультимедиа поддерживают протоколы Smooth Streaming, MPEG DASH, HLS. Как часть [динамической упаковки](dynamic-packaging-overview.md), потоковой передачи клиентских манифестов (списка воспроизведения HLS Master, описание презентации мультимедиа DASH (MPD) и Smooth Streaming) создаются динамически в зависимости от выбора формата в URL-адрес. См. в разделе протоколы доставки в [в этом разделе](dynamic-packaging-overview.md#delivery-protocols). 

### <a name="get-and-examine-manifest-files"></a>Получение и просмотр файлов манифестов

Вы указываете список условий для фильтрации свойств дорожек с учетом того, какие дорожки вашего потока (прямой трансляции или видео по запросу) следует включить в динамически создаваемый манифест. Чтобы получить и просмотреть свойства дорожек, необходимо сначала загрузить манифест Smooth Streaming.

В статье [Руководство. Отправка, кодирование и потоковая передача видео с помощью API](stream-files-tutorial-with-api.md) показано, как составлять URL-адреса для потоковой передачи с помощью .NET (см. раздел [Получение URL-адресов потоковой передачи](stream-files-tutorial-with-api.md#get-streaming-urls)). Если запустить приложение, один из URL-адресов будет указывать на манифест Smooth Streaming: `https://amsaccount-usw22.streaming.media.azure.net/00000000-0000-0000-0000-0000000000000/ignite.ism/manifest`.<br/>Скопируйте и вставьте URL-адрес в адресную строку браузера. Файл будет скачан. Вы можете открыть его в текстовом редакторе по своему усмотрению.

Пример для REST представлен в статье [Руководство. Отправка, кодирование и потоковая передача видео с помощью REST](stream-files-tutorial-with-rest.md#list-paths-and-build-streaming-urls).

### <a name="monitor-the-bitrate-of-a-video-stream"></a>Отслеживание скорости видеопотока

Для отслеживания скорости видеопотока можно использовать [страницу с демонстрацией Проигрывателя мультимедиа Azure](https://aka.ms/amp). Диагностические сведения отображаются на вкладке **Диагностика** демонстрационной страницы:

![Диагностика Проигрывателя мультимедиа Azure Media Player][amp_diagnostics]

## <a name="rendition-filtering"></a>Фильтрация представлений

По выбору можно закодировать актив в несколько профилей кодирования (H.264 Baseline, H.264 High, AACL, AACH, Dolby Digital Plus) и с несколькими значениями скорости потока и соответственно качества. Однако не все клиентские устройства будут поддерживать все профили и скорости потока вашего актива. Например, старые устройства Android поддерживают только профиль H.264 Baseline+AACL. Отправка высокоскоростного потока на устройство, которое не способно показать его преимущества, приводит к трате пропускной способности и вычислительных ресурсов устройства. Такое устройство должно декодировать всю заданную информацию только для того, чтобы уменьшать ее масштаб для отображения.

С помощью динамического манифеста можно создавать профили устройств, например мобильных устройств, консолей, HD/SD и т. д., включая в них дорожки и варианты качества, которые следует сделать частью каждого из профилей.

![Пример фильтрации представлений][renditions2]

В следующем примере использовался кодировщик для кодирования промежуточного актива в семь MP4-видеофайлов стандарта ISO (с разрешением от 180p до 1080p). Закодированный ресурс можно динамически упаковать в любой из следующих потоковых протоколов: HLS, MPEG DASH и Smooth.  В верхней части схемы показан манифест HLS манифеста для актива без фильтров (он содержит все семь представлений).  В левом нижнем углу показан манифест HLS, к которому был применен фильтр с именем ott. Фильтр ott предписывает удалить все варианты скорости потока ниже 1 Мбит/с, что ведет к исключению двух нижних уровней качества. В правом нижнем углу показан манифест HLS, к которому был применен фильтр с именем mobile. Фильтр mobile предписывает удалить представления, где разрешение больше 720p, что ведет к исключению двух представлений с разрешением 1080p.

![Фильтрация представлений][renditions1]

## <a name="removing-language-tracks"></a>Удаление языковых дорожек
Активы могут содержать аудиодорожки на нескольких языках, например английском, испанском, французском и т. д. Как правило, пакет SDK проигрывателя управляет выбором аудиодорожки по умолчанию и доступными на выбор пользователя аудиодорожками. Такие пакеты SDK для проигрывателей разрабатывать сложно, они требуют разных реализаций для разных платформ проигрывателей на конкретных устройствах. Кроме того, на некоторых платформах API-интерфейсы проигрывателей ограничены и не включают функции выбора звука, когда пользователи не могут выбрать или изменить установленную по умолчанию звуковую дорожку. С помощью фильтров активов можно управлять поведением проигрывателей, создавая фильтры с включением только нужных языков аудио.

![Фильтрация языковых дорожек][language_filter]

## <a name="trimming-start-of-an-asset"></a>Обрезка начала актива
При большинстве событий потоковой трансляции в реальном времени операторы проводят процедуры тестирования до фактического события. Например, перед началом события они могут включить заставку: "Программа начнется очень скоро". При архивировании программы данные проверок и заставок также будут архивированы и включены в представление. Однако эту информацию не следует отображать клиентам. С помощью динамического манифеста можно создать фильтр времени начала и удалить ненужные данные из манифеста.

![Начало обрезки][trim_filter]

## <a name="creating-subclips-views-from-a-live-archive"></a>Создание субклипов (представлений) из текущего архива
Многие текущие события являются длительными, и их текущий архив может включать в себя несколько событий. После окончания текущего события вещателям может потребоваться разбить текущий архив на логические последовательности начала и остановки программ. Затем нужно опубликовать эти виртуальные программы отдельно без последующей обработки текущего архива и без создания отдельных активов (что не позволит воспользоваться преимуществами существующих кэшированных фрагментов в CDN). Примерами таких виртуальных программ являются четверти при игре в американский футбол или баскетбол, иннинги в бейсболе или отдельные события любой программы о спорте.

С помощью динамического манифеста можно создавать фильтры с указанием времени начала и окончания, а также создавать виртуальные представления поверх текущего архива. 

![Фильтр субклипа][subclip_filter]

Фильтрованный архив:

![Лыжный спорт][skiing]

## <a name="adjusting-presentation-window-dvr"></a>Настройка окна презентации (DVR)
В настоящее время службы мультимедиа Azure поддерживают циклический архив, продолжительность которого можно настроить от 5 минут до 25 часов. Фильтрация манифеста позволяет создать скользящее окно DVR поверх архива, без удаления медиаданных. Есть множество сценариев, где вещателям требуется предоставить ограниченное окно DVR, которое перемещается вместе с текущей границей, и в то же время поддерживать более крупное окно архивации. Вещателю может понадобиться использовать данные, находящиеся за пределами окна DVR, для выделения клипов, или же предоставлять разные окна DVR для различных устройств. Например, большинство мобильных устройств не обрабатывает большие окна DVR (для мобильных устройств можно установить окно DVR продолжительностью в две минуты, а для настольных клиентов — один час).

![Окно DVR][dvr_filter]

## <a name="adjusting-livebackoff-live-position"></a>Настройка LiveBackoff (динамической позиции)
Фильтрация манифеста позволяет удалить несколько секунд с динамической границы текущей программы. Это позволяет вещателям просматривать представление в точке предварительной публикации и создавать точки вставки рекламы до того, как зрители получат потоковую передачу (резерв составляет 30 секунд). Затем вещатели могут передавать рекламу на клиентские платформы, располагая временем для получения и обработки информации до появления возможности для рекламы.

Кроме поддержки рекламы параметр LiveBackoff можно использовать для регулирования позиции представлений, благодаря чему даже если клиенты переместятся и выйдут из зоны покрытия, они все равно смогут получать фрагменты с сервера вместо ошибок HTTP 404 или 412.

![livebackoff_filter][livebackoff_filter]

## <a name="combining-multiple-rules-in-a-single-filter"></a>Объединение нескольких правил в одном фильтре
В одном фильтре можно объединить несколько правил фильтрации. В качестве примера можно определить правило диапазона для удаления заставок из текущего архива, а также для фильтрации доступных скоростей потока. При применении нескольких правил фильтрации конечным результатом является объединение по пересечению всех правил.

![multiple-rules][multiple-rules]

## <a name="combining-multiple-filters-filter-composition"></a>Объединение нескольких фильтров (сложение фильтров)

Кроме того, вы можете объединять несколько фильтров в одном URL-адресе. 

В следующем сценарии показано, для чего могут потребоваться подобные фильтры:

1. При необходимости отфильтровать качество видео для мобильных устройств, например, Android или iPAD (для ограничения качества видео). Чтобы удалить содержимое нежелательного качества, вы могли бы создать фильтр учетной записи, который подходит для профилей устройств. Фильтры учетных записей можно использовать для всех ресурсов в одной учетной записи служб мультимедиа без каких-либо дополнительных связей. 
2. При необходимости обрезать время начала и окончания ресурс-контейнера. Для этого можно создать фильтр ресурсов и задать время начала и окончания. 
3. При необходимости объедините оба этих фильтра. Без объединения вам потребуется добавить фильтрацию качества в фильтр обрезки, что может затруднить использование фильтра.

Для объединения фильтров необходимо указать их имена в URL-адресе манифеста или списка воспроизведения через точку с запятой. Допустим, у вас есть фильтр качества с именем *MyMobileDevice* и фильтр *MyStartTime* для выбора конкретного времени начала. Их можно объединить следующим образом:

Вы можете объединить до трех фильтров. 

Дополнительную информацию см. в [этом](https://azure.microsoft.com/blog/azure-media-services-release-dynamic-manifest-composition-remove-hls-audio-only-track-and-hls-i-frame-track-support/) блоге.

## <a name="considerations-and-limitations"></a>Ограничения и рекомендации

- Для фильтра VoD не следует задавать значения **forceEndTimestamp**, **presentationWindowDuration** и **liveBackoffDuration**. Они используются только для фильтрации прямых трансляций. 
- Динамический манифест работает в пределах GOP (по ключевым кадрам), поэтому обрезка производится с точностью GOP. 
- Одно и то же имя фильтра можно использовать для фильтров учетных записей и ресурсов. Фильтры ресурсов имеют более высокий приоритет и переопределяют фильтры учетных записей.
- При обновлении фильтра может понадобиться до 2 минут на обновление правил конечной точкой потоковой передачи. Если содержимое было обработано с помощью каких-либо фильтров (и кэшировано на прокси-серверах и в кэшах CDN), обновление этих фильтров может привести к сбоям проигрывателя. Рекомендуется очистить кэш после обновления фильтра. Если такой вариант невозможен, рассмотрите возможность использования другого фильтра.
- Клиентам необходимо вручную скачать манифест и получить точное значение startTimestamp и шкалу времени.
    
    - Чтобы определить свойства дорожек в ресурсе, [получите и просмотрите файл манифеста](#get-and-examine-manifest-files).
    - Формула для установки свойств меток времени в фильтрах ресурсов: <br/>startTimestamp = &lt;время начала в манифесте&gt; +  &lt;ожидаемое начальное время фильтра в секундах&gt;*шкала времени


## <a name="next-steps"></a>Дальнейшие действия

В указанных ниже статьях показано, как создавать фильтры программным способом.  

- [Create filters with REST APIs](filters-dynamic-manifest-rest-howto.md) (Создание фильтров с помощью интерфейсов REST API)
- [Создание фильтров с помощью .NET](filters-dynamic-manifest-dotnet-howto.md)
- [Create filters with CLI](filters-dynamic-manifest-cli-howto.md) (Создание фильтров с помощью .NET)

[renditions1]: ./media/filters-dynamic-manifest-overview/media-services-rendition-filter.png
[renditions2]: ./media/filters-dynamic-manifest-overview/media-services-rendition-filter2.png

[rendered_subclip]: ./media/filters-dynamic-manifests/media-services-rendered-subclip.png
[timeline_trim_event]: ./media/filters-dynamic-manifests/media-services-timeline-trim-event.png
[timeline_trim_subclip]: ./media/filters-dynamic-manifests/media-services-timeline-trim-subclip.png

[multiple-rules]:./media/filters-dynamic-manifest-overview/media-services-multiple-rules-filters.png

[subclip_filter]: ./media/filters-dynamic-manifest-overview/media-services-subclips-filter.png
[trim_event]: ./media/filters-dynamic-manifests/media-services-timeline-trim-event.png
[trim_subclip]: ./media/filters-dynamic-manifests/media-services-timeline-trim-subclip.png
[trim_filter]: ./media/filters-dynamic-manifest-overview/media-services-trim-filter.png
[redered_subclip]: ./media/filters-dynamic-manifests/media-services-rendered-subclip.png
[livebackoff_filter]: ./media/filters-dynamic-manifest-overview/media-services-livebackoff-filter.png
[language_filter]: ./media/filters-dynamic-manifest-overview/media-services-language-filter.png
[dvr_filter]: ./media/filters-dynamic-manifest-overview/media-services-dvr-filter.png
[skiing]: ./media/filters-dynamic-manifest-overview/media-services-skiing.png
[amp_diagnostics]: ./media/filters-dynamic-manifest-overview/amp_diagnostics.png
