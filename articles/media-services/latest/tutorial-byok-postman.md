---
title: Использование ключей, управляемых клиентом, или BYOK для REST API
description: В рамках этого учебника используйте ключи, управляемые клиентом, или создавайте собственные ключи (BYOK) для учетной записи хранения Служб мультимедиа.
author: IngridAtMicrosoft
ms.author: inhenkel
ms.service: media-services
ms.topic: tutorial
ms.date: 10/18/2020
ms.openlocfilehash: c8a5b682e2ac4879d2181bdb069cf554bad512d9
ms.sourcegitcommit: d60976768dec91724d94430fb6fc9498fdc1db37
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/02/2020
ms.locfileid: "96498291"
---
# <a name="tutorial-use-customer-managed-keys-or-byok-with-media-services-rest-api"></a>Руководство по Использование ключей, управляемых клиентом, или BYOK для REST API Служб мультимедиа

С помощью API версии 2020-05-01 вы можете создавать управляемые клиентами ключи RSA с учетной записью Служб мультимедиа Azure, которая использует управляемое системой удостоверение. Этот учебник также включает сведения о коллекции и среде Postman для отправки запросов REST в службы Azure. Используемые службы:

- регистрация нового приложения для Postman в Azure Active Directory (Azure AD);
- API Microsoft Graph
- Хранилище Azure
- Azure Key Vault
- Службы мультимедиа Azure

В этом руководстве показано, как выполнить следующие действия с помощью Postman:

> [!div class="checklist"]
> - получение маркеров для использования со службами Azure;
> - создание группы ресурсов и учетной записи хранения;
> - создание учетной записи Служб мультимедиа с удостоверением, управляемым системой;
> - создание Key Vault для хранения управляемого пользователем ключа RSA;
> - настройка учетной записи Служб мультимедиа для использования ключа RSA с учетной записью хранения;
> - использование переменных в Postman.

Если у вас еще нет подписки Azure, создайте [бесплатную пробную учетную запись](https://azure.microsoft.com/free/).

## <a name="prerequisites"></a>Предварительные требования

1. Зарегистрируйте субъект-службу с нужными разрешениями.
1. Установите [Postman](https://www.postman.com).
1. Скачайте коллекцию Postman для работы с этим учебником в разделе [media-services-customer-managed-keys-byok](https://github.com/Azure-Samples/media-services-customer-managed-keys-byok) из примеров Azure.

### <a name="register-a-service-principal-with-the-needed-permissions"></a>Регистрация субъекта-службы с нужными разрешениями

1. [Создайте субъект-службу](../../active-directory/develop/howto-create-service-principal-portal.md).
1. Перейдите к [варианту 2: создание секрета приложения](../../active-directory/develop/howto-create-service-principal-portal.md#authentication-two-options), чтобы получить секрет субъекта-службы.

   > [!IMPORTANT]
   >Скопируйте и сохраните секрет для последующего использования. После закрытия страницы секрета на портале доступ к нему станет невозможен.

1. Назначьте разрешения для субъекта-службы, как показано на снимке экрана ниже:

   :::image type="complex" source="./media/tutorial-byok/service-principal-permissions-1.png" alt-text="Снимок экрана с необходимыми разрешениями для субъекта-службы.":::
   Разрешения перечисляются по службе, имени разрешения, типу, а затем по описанию. Azure Key Vault: олицетворение пользователя, делегированный, полный доступ к Azure Key Vault. Управление службами Azure: олицетворение пользователя, делегированный, доступ к управлению службами Azure в качестве пользователя организации. Служба хранилища Azure: олицетворение пользователя, делегированный, доступ к службе хранилища. Службы мультимедиа: олицетворение пользователя, делегированный, доступ к Службам мультимедиа. Microsoft Graph: user.read, делегированный, вход и чтение профиля пользователя.
   :::image-end:::

### <a name="install-postman"></a>Установка Postman

Если вы еще не установили Postman для работы в Azure, получите его на сайте [postman.com](https://www.postman.com/).

### <a name="download-and-import-the-collection"></a>Скачивание и импорт коллекции

Скачайте коллекцию Postman для работы с этим учебником в разделе [media-services-customer-managed-keys-byok](https://github.com/Azure-Samples/media-services-customer-managed-keys-byok) из примеров Azure.

## <a name="install-the-postman-collection-and-environment"></a>Установка коллекции и среды Postman

1. Запустите Postman.
1. Выберите **Импортировать**.
1. Щелкните **Upload files** (Передать файлы).
1. Перейдите к расположению, в котором вы сохранили файлы коллекции и среды.
1. Выберите файлы коллекции и среды.
1. Выберите **Open** (Открыть). Появится предупреждение о том, что файлы будут импортированы не как API, а как коллекции. Это нормально. Именно это вам и нужно.

Теперь эта коллекция отображается в списке коллекций с пометкой BYOK. Переменные среды также отображаются в списке сред.

### <a name="understand-the-rest-api-requests-in-the-collection"></a>Общие сведения о запросах к REST API в коллекции

Коллекция предоставляет следующие запросы REST API.

> [!NOTE]
>
>- Запросы должны отправляться в указанной последовательности.
>- Большинство запросов содержат сценарии теста, которые динамически создают глобальные переменные для следующего запроса в этой последовательности.
>- Вам не нужно вручную создавать глобальные переменные.

В Postman эти переменные будут указываться в фигурных скобках. Например, `{{bearerToken}}`.

1. Получение маркера Azure AD: этот тест задает глобальную переменную **bearerToken**.
2. Получение маркера для Microsoft Graph: этот тест задает глобальную переменную **graphToken**.
3. Получение сведений о субъекте-службе: этот тест задает глобальную переменную **servicePrincipalObjectId**.
4. Создайте учетную запись хранения: этот тест задает глобальную переменную **storageAccountId**.
5. Создание учетной записи Служб мультимедиа с удостоверением, управляемым системой: этот тест задает глобальную переменную **principalId**.
6. Создание хранилища ключей, чтобы предоставить доступ к субъекту-службе: этот тест задает глобальную переменную **keyVaultId**.
7. Получение маркера Key Vault: этот тест задает глобальную переменную **keyVaultToken**.
8. Создание ключа RSA в хранилище ключей: этот тест задает глобальную переменную **keyId**.
9. Настройка учетной записи Служб мультимедиа для использования ключа с учетной записью хранения: нет сценария теста для этого запроса.

## <a name="define-environment-variables"></a>Определение переменных среды

1. Перейдите к среде, которую вы скачали ранее, выбрав ее в раскрывающемся списке сред.
1. Задайте переменные среды в Postman. Они также используются в качестве переменных в фигурных скобках. Например, `{{tenantId}}`.

    - **tenantID**. Идентификатор клиента.
    - **servicePrincipalId**. Идентификатор субъекта-службы, который вы можете выяснить любым привычным методом, например с помощью портала или CLI.
    - **servicePrincipalSecret**. Секрет, созданный для субъекта-службы.
    - **Подписка**. Идентификатор подписки.
    - **storageName**. Имя, которое вы хотите присвоить хранилищу.
    - **accountName**. Имя учетной записи Служб мультимедиа, которую вы хотите использовать.
    - **KeyVaultName**. Имя хранилища ключей, которое вы хотите использовать.
    - **resourceLocation**. **CentralUs** или другой регион, куда вы хотите поместить ресурсы. Эта коллекция проверялась только в **CentralUs**.
    - **resourceGroup**. Имя группы ресурсов.

    Следующие переменные являются стандартными для работы с ресурсами Azure. Поэтому их не нужно изменять.

    - **armResource**: `https://management.core.windows.net`
    - **graphResource**: `https://graph.windows.net/`
    - **keyVaultResource**: `https://vault.azure.net`
    - **armEndpoint**: `management.azure.com`
    - **graphEndpoint**: `graph.windows.net`
    - **aadEndpoint**: `login.microsoftonline.com`
    - **keyVaultDomainSuffix**: `vault.azure.net`

## <a name="send-the-requests"></a>Отправка запросов

После определения переменных среды можно выполнять запросы поочередно в предыдущей последовательности. Или можно использовать средство выполнения тестов Postman, чтобы запустить коллекцию.

## <a name="change-the-key"></a>Изменение ключа

Службы мультимедиа автоматически обнаруживают, что ключ изменен. Чтобы проверить это, создайте версию того же ключа. Службы мультимедиа должны обнаружить этот ключ не позднее, чем через 15 минут.

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы не собираетесь использовать (и *оплачивать*) созданные ресурсы, удалите их.

## <a name="next-steps"></a>Дальнейшие шаги

Дополнительные сведения см. в следующей статье:
> [!div class="nextstepaction"]
> [Кодирование удаленного файла на основе URL-адреса и потоковой передачи видео с помощью REST](stream-files-tutorial-with-rest.md)