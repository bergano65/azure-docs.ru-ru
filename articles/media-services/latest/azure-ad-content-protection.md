---
title: Комплексная защита содержимого с помощью Azure AD
description: В этой статье описано, как защитить содержимое с помощью Служб мультимедиа Azure и Azure Active Directory.
services: media-services
documentationcenter: ''
author: willzhan
manager: femila
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: tutorial
ms.date: 07/1/2020
ms.author: inhenkel
ms.custom: devx-track-javascript
ms.openlocfilehash: ad50b29dbda7c09c9312ebb4a01ebc5da568f3da
ms.sourcegitcommit: e71da24cc108efc2c194007f976f74dd596ab013
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/29/2020
ms.locfileid: "87422102"
---
# <a name="tutorial-end-to-end-content-protection-using-azure-ad"></a>Руководство по комплексной защите содержимого с помощью Azure AD

С помощью этого руководства и предоставленного примера проигрывателя вы настроите подсистему комплексной защиты содержимого мультимедиа на основе Служб мультимедиа Azure (AMS) и Azure Active Directory (AAD) для потоковой передачи содержимого мультимедиа со всеми поддерживаемыми AMS DRM/AES-128, протоколами потоковой передачи, кодеками и форматами контейнеров. Пример является достаточно универсальным для безопасного доступа к любому интерфейсу REST API, защищенному с помощью OAuth 2 посредством потока кода авторизации с ключом проверки для обмена кодом (PKCE). (Служба доставки лицензий Служб мультимедиа Azure — это всего лишь один из них.) Он также работает для API Microsoft Graph или любых пользовательских REST API, защищенных с помощью потока кода авторизации OAuth 2. Это сопровождающий документ для [этого примера кода](https://github.com/Azure-Samples/media-services-content-protection-azure-ad).

Выполняя данное руководство, вы сделаете следующее:

> [!div class="checklist"]
>
> * изучите требования к аутентификации;
> * узнаете, как работает приложение;
> * зарегистрируете приложение серверного ресурса;
> * зарегистрируете клиентское приложение;
> * настроите политики ключа содержимого и политики потоковой передачи для учетной записи Служб мультимедиа;
> * настроите приложение проигрывателя.

Если у вас нет подписки на Службы мультимедиа Azure, создайте [бесплатную пробную учетную запись](https://azure.microsoft.com/free/) Azure, а затем создайте учетную запись Служб мультимедиа.

### <a name="duration"></a>Duration
На работу с этим руководством понадобится около двух часов, если вы выполнили все предварительные требования.

## <a name="prerequisites"></a>Предварительные требования

Здесь используются последние версии технологии и концепции, описанные ниже. Перед началом работы с этим руководством рекомендуется ознакомиться с ними.

### <a name="prerequisite-knowledge"></a>Предварительно требуемый набор знаний

Это необязательно, но рекомендуется, чтобы вы были знакомы со следующими концепциями, прежде чем начинать работу с этим руководством:

* Управление цифровыми правами (DRM).
* [Службы мультимедиа Azure (AMS) версии 3.](./media-services-overview.md)
* [Политики ключей содержимого](content-key-policy-concept.md) AMS с использованием API AMS версии 3, портала Azure или [инструмента "Обозреватель Служб мультимедиа Azure" (AMSE)](https://github.com/Azure/Azure-Media-Services-Explorer).
* Конечные точки Azure AD версии 2 на [платформе удостоверений Майкрософт](../../active-directory/develop/index.yml).
* Современные решения аутентификации в облаке, например [OAuth 2.0 и OpenID Connect](../../active-directory/develop/active-directory-v2-protocols.md).
  * [Поток кода авторизации в OAuth 2.0](../../active-directory/develop/v2-oauth2-auth-code-flow.md) и причины использования PKCE.
  * [Делегированные разрешения и разрешения приложений.](../../active-directory/develop/developer-glossary.md#permissions)
* [Маркер JWT](../../active-directory/develop/access-tokens.md), его утверждения и смена ключей подписывания (включен в пример).

### <a name="prerequisite-code-and-installations"></a>Необходимый код и установленные решения

* Пример кода (скачайте его [здесь](https://github.com/Azure-Samples/media-services-content-protection-azure-ad)).
* Установленное решение Visual Studio Code (скачайте Visual Studio Code здесь: [https://code.visualstudio.com/download](https://code.visualstudio.com/download)).
* Установленная платформа Node.js (скачайте Node.js здесь: [https://nodejs.org](https://nodejs.org)). В установку также включен инструмент NPM.
* [Подписка Azure](https://azure.microsoft.com/free/).
* Учетная запись Служб мультимедиа Azure.
* @azure/msal-browser версии 2.0, один из членов семейства пакетов SDK [библиотеки аутентификации Майкрософт (MSAL)](../../active-directory/develop/msal-overview.md) для различных платформ клиентов.
* Последняя версия [Проигрывателя мультимедиа Azure](https://github.com/Azure-Samples/azure-media-player-samples) (включена в пример).
* Учетные данные FPS от Apple, если вы хотите включить FairPlay DRM, и сертификат приложения, размещенный с помощью CORS, доступ к которому можно получить через код JavaScript на стороне клиента.

> [!IMPORTANT]
> В этом руководстве для создания ограничения в политике ключей содержимого используется .NET.  Если вы не являетесь разработчиком .NET, но хотите использовать Node.js для подключения к Службам мультимедиа Azure, см. статью [Подключение к API Служб мультимедиа версии 3 — Node.js](configure-connect-nodejs-howto.md). Вам также доступен модуль Node.js для автоматической смены ключей/ Сведения см. на странице модуля Node.js [passport-ad](https://github.com/AzureAD/passport-azure-ad).

## <a name="consider-the-authentication-and-authorization-requirements"></a>Требования к аутентификации и авторизации

При проектировании подсистемы могут возникнуть некоторые трудности. Она включает несколько активных компонентов, для нее действуют ограничения клиентского приложения, а ключи Azure AD меняются каждые шесть недель.

Одностраничное приложение, используемое для примера в этом руководстве, учитывает требования к аутентификации и соответствующие ограничения. Он использует следующую информацию:

* Конечные точки Azure AD версии 2, так как платформа разработчика Azure AD (конечные точки версии 1) меняется на платформу удостоверений Майкрософт (конечные точки версии 2).
* Поток кода авторизации, так как поток неявного предоставления разрешения OAuth 2 больше не поддерживается.
* Приложение, для которого действуют следующие ограничения:
    * Общедоступный клиент не может скрывать секрет клиента.  Только поток кода авторизации требует скрытия секрета клиента, поэтому используется поток кода авторизации с PKCE.
    * Приложение на основе браузера, для которого включена песочница безопасности браузера (CORS/предварительное ограничение).
    * Приложение на основе браузера, использующее современный код JavaScript, для которого действуют ограничения безопасности JavaScript (настраиваемые специальные возможности заголовков, идентификатор корреляции).

## <a name="understand-the-subsystem-design"></a>Общие сведения о структуре подсистемы

Структура подсистемы показана на следующей схеме.  Она имеет три уровня:

* Операционный уровень (черного цвета) для настройки политики ключей содержимого и публикации содержимого для потоковой передачи.
* Общедоступные конечные точки (синего цвета), которые взаимодействуют с проигрывателем и клиентом и предоставляют возможности аутентификации, авторизации, лицензии DRM и зашифрованное содержимое.
* Приложение проигрывателя (зеленого цвета), которое интегрирует все компоненты и:
    * управляет аутентификацией пользователей через Azure AD;
    * управляет получением access_token из Azure AD;
    * получает манифест и зашифрованное содержимое из AMS или CDN;
    * получает лицензию DRM из Служб мультимедиа Azure;
    * управляет расшифровкой, декодированием и отображением содержимого.

![Экран для анализа маркеров JWT](media/aad-ams-content-protection/subsystem.svg)

Подробные сведения о подсистеме см. в статье [Проектирование системы защиты содержимого с несколькими подсистемами DRM и управлением доступом](./design-multi-drm-system-with-access-control.md).

## <a name="understand-the-single-page-app"></a>Общие сведения об одностраничных приложениях

Приложение проигрывателя — это одностраничное приложение, разработанное в Visual Studio Code с использованием:

* Node.js с ES 6 JavaScript;
* @azure/msal-browser 2.0 (бета-версия);
* пакета SDK для Проигрывателя мультимедиа Azure;
* потока OAuth 2 для конечных точек Azure AD версии 2 (платформа удостоверений Майкрософт).

Одностраничное приложение проигрывателя выполняет следующие действия:

* Аутентификация пользователей, принадлежащих к арендатору, а также гостевых пользователей из других арендаторов AAD или учетных записей MSA. Пользователи могут выбрать вход через всплывающее окно браузера или через перенаправление (для браузеров, блокирующих всплывающие окна, например Safari).
* Получение `access_token` с помощью потока кода авторизации с PKCE.
* Продление `access_token` (маркеры, выданные AAD, действительны в течение 1 часа), для которого также выполняется получение `refresh_token`.
* Анализ маркеров JWT (как `access_token`, так и `id_token`) для тестирования и проверки.
* Получение лицензий DRM для всех трех ключей содержимого DRM или AES-128.
* Потоковая передача содержимого с различными сочетаниями DRM, протоколов потоковой передачи и форматов контейнеров. Для каждого сочетания создается правильная строка формата.
* Расшифровка, декодирование и отображение.
* Вызовы API Microsoft Graph для устранения неполадок. <!--See more details in the subsection Shortest path: testing my protected asset in my subscription with your hosted player app and underlying tenant. -->

Экран для входа, получения, продления и отображения маркеров:

 ![Экран для входа, получения, продления и отображения маркеров](media/aad-ams-content-protection/token-acquisition.png)

Экран для анализа маркеров JWT (access_token или id_token):

![Экран для анализа маркеров JWT](media/aad-ams-content-protection/parsing-jwt-tokens.png)

Экран для тестирования защищенного содержимого с различными сочетаниями DRM или AES, протоколов потоковой передачи и форматов контейнеров:

![Экран анализа маркеров JWT](media/aad-ams-content-protection/testing-protected-content.png)
-->

<!-- You can see a hosted version of the sample at [https://aka.ms/ott](https://aka.ms/ott)-->

## <a name="choose-an-azure-ad-tenant"></a>Выбор арендатора Azure AD

> [!NOTE]
> Далее предполагается, что вы вошли на портал Azure и что у вас есть хотя бы один арендатор Azure AD.

Выберите арендатора Azure AD для использования с нашим комплексным примером. Имеются две возможности.

* Существующий арендатор Azure AD. Каждая подписка Azure включает по меньшей мере один арендатор Azure AD, но арендатор Azure AD может использоваться несколькими подписками Azure.
* Новый арендатор Azure AD, который *не* используется ни одной подпиской Azure. Если вы выберете вариант с новым арендатором, учетная запись службы мультимедиа и пример приложения проигрывателя должны находиться в подписке Azure, которая использует отдельный арендатор Azure AD. Это обеспечивает некоторую гибкость. Например, вы можете использовать собственный арендатор Azure AD, а также учетную запись службы мультимедиа в подписке Azure клиента.

## <a name="register-the-backend-resource-app"></a>Регистрация приложения серверного ресурса

1. Перейдите к выбранному или созданному арендатору Azure AD.
1. Выберите **Azure Active Directory** в меню.
1. Выберите в меню **Регистрация приложений**.
1. Щелкните **+ Новая регистрация**.
1. Присвойте приложению имя *LicenseDeliveryResource2* (где 2 означает конечные точки AAD версии 2).
1. Выберите **Учетные записи только в этом каталоге организации (только [*имя_вашего_арендатора*] — один клиент)** . Если вы хотите разрешить доступ нескольким арендаторам, выберите один из других параметров для нескольких арендаторов.
1. Параметр **URI перенаправления** необязателен и может быть изменен позже.
1. Щелкните **Зарегистрировать**. Откроется представление "Регистрация приложений".
1. Выберите **Манифест** в меню. Откроется представление "Манифест".
1. Измените значение `accessTokenAcceptedVersion` на *2* (без кавычек).
1. Измените значение `groupMembershipClaims` на *"SecurityGroup"* (с кавычками).
1. Выберите команду **Сохранить**.
1. Выберите в меню **Предоставление API**. Откроется представление "Добавление области". (В Azure предоставляется URI идентификатора приложения, но при необходимости вы можете изменить его в поле "URI идентификатора приложения".)
1. Щелкните **Сохранить и продолжить**. Представление изменится. Для каждого из параметров в столбце "Параметр" в таблице ниже введите значение, представленное в столбце "Значение", а затем щелкните **Добавить область**.

| Параметр | Значение | Описание |
| ------- | ----- | ----------- |
| Имя области | *DRM.License.Delivery* | Способ отображения области при запросе доступа к этому API и в маркерах доступа, если область действия была предоставлена клиентскому приложению. Значение должно быть уникальным для всех компонентов приложения. Мы рекомендуем использовать resource.operation.constraint в качестве шаблона при создании имени. |
| Кто может давать согласие? | *Администраторы и пользователи* | Позволяет определить, могут ли пользователи давать согласие на эту область в каталогах, для которых включено согласие пользователя. |
| Отображаемое имя согласия администратора | *Доставка лицензий DRM* | Как будет называться область на экране согласия, когда администраторы дают на нее согласие. |
| Описание согласия администратора** | *Область серверного ресурса для доставки лицензий DRM* | Подробное описание области, которое отображается, когда администраторы арендатора развертывают область на экране согласия. |
| Отображаемое имя согласия пользователя | *DRM.License.Delivery* | Как будет называться область на экране согласия, когда пользователи дают на нее согласие. |
| Описание согласия пользователя | *Область серверного ресурса для доставки лицензий DRM* | Это подробное описание области, которое отображается, когда пользователи развертывают область на экране согласия. |
| Состояние | *Enabled* | Определяет, могут ли клиенты запрашивать эту область. Задайте значение "Отключено" для тех областей, которые не должны быть доступны клиентам. Удалить можно только отключенные области, поэтому рекомендуется подождать минимум неделю после отключения области, прежде чем удалять ее. Это позволяет избежать случаев, когда клиенты все еще используют область на момент ее удаления. |

## <a name="register-the-client-app"></a>Регистрация клиентского приложения

1. Перейдите к выбранному или созданному арендатору Azure AD.
1. Выберите **Azure Active Directory** в меню.
1. Выберите в меню **Регистрация приложений**.
1. Щелкните **+ Новая регистрация**.
1. Присвойте имя клиентскому приложению, например *AMS AAD Content Protection*.
1. Выберите **Учетные записи только в этом каталоге организации (только [*имя_вашего_арендатора*] — один клиент)** . Если вы хотите разрешить доступ нескольким арендаторам, выберите один из других параметров для нескольких арендаторов.
1. Параметр **URI перенаправления** необязателен и может быть изменен позже.
1. Щелкните **Зарегистрировать**.
1. Выберите **Разрешения API** в меню.
1. Щелкните **+ Добавить разрешение**. Откроется представление "Запрос разрешений API".
1. Откройте вкладку **My API** (Мой API) и выберите приложение *LicenseDeliveryResource2*, которое вы создали в последнем разделе.
1. Щелкните значок стрелки рядом с DRM и установите флажок для разрешения *DRM.License.Delivery*.
1. Щелкните **Добавить разрешения**. Представление "Добавление разрешений" закроется.
1. Выберите **Манифест** в меню. Откроется представление "Манифест".
1. Найдите и добавьте следующие пары значений в атрибут `replyUrlsWithType`:

   ```json
   "replyUrlsWithType": [
        {
            "url": "https://npmwebapp.azurewebsites.net/",
            "type": "SPA"
        },
        {
            "url": "http://localhost:3000/",
            "type": "SPA"
        }
    ],
   ```

    > [!NOTE]
    > На этом этапе у нас еще нет URL-адреса для приложения проигрывателя.  Если приложение выполняется с веб-сервера localhost, вы можете использовать только пару значений localhost. После развертывания приложения проигрывателя вы можете добавить здесь запись с развернутым URL-адресом.  Если вы забудете это сделать, при входе в Azure AD отобразится сообщение об ошибке.

1. Выберите команду **Сохранить**.
1. Наконец, чтобы подтвердить правильность конфигурации, выберите **Аутентификация**.  Отобразится представление "Аутентификация". Ваше клиентское приложение будет указано как одностраничное приложение (SPA), также будет приведен URI перенаправления, а тип предоставления разрешения будет иметь значение "Поток кода авторизации с PKCE".

### <a name="set-up-the-media-services-account-content-key-policy-and-streaming-policies"></a>Настройка политики ключей содержимого и политик потоковой передачи для учетной записи Служб мультимедиа

**В этом разделе предполагается, что вы являетесь разработчиком .NET и знакомы с API AMS версии 3.**

> [!NOTE]
> На момент написания этой статьи вы не можете использовать портал Azure для настройки политики ключей для учетной записи Служб мультимедиа, так как он не поддерживает использование ключа подписания асимметричного маркера с OpenID-Config.  Настройка должна поддерживать смену ключей Azure AD, так как выданный маркер Azure AD подписывается асимметричным ключом, который меняется каждые шесть недель. Поэтому в этом руководстве используется .NET и API AMS версии 3.

Применяется конфигурация [политики ключей содержимого](content-key-policy-concept.md) и [политик потоковой передачи](streaming-policy-concept.md) для DRM и AES-128.  Измените `ContentKeyPolicyRestriction` в политике ключей содержимого.

Ниже приведен код .NET для создания ограничения в политике ключей содержимого.

```dotnetcli
ContentKeyPolicyRestriction objContentKeyPolicyRestriction;

//use Azure Active Directory OpenId discovery document, supporting key rollover
objContentKeyPolicyRestriction = new ContentKeyPolicyTokenRestriction()
    {
        OpenIdConnectDiscoveryDocument = ConfigAccessor.AppSettings["ida_AADOpenIdDiscoveryDocument"]
    };

string audience = ConfigAccessor.AppSettings["ida_audience"];
string issuer   = ConfigAccessor.AppSettings["ida_issuer"];

ContentKeyPolicyTokenRestriction objContentKeyPolicyTokenRestriction = (ContentKeyPolicyTokenRestriction)objContentKeyPolicyRestriction;
objContentKeyPolicyTokenRestriction.Audience             = audience;
objContentKeyPolicyTokenRestriction.Issuer               = issuer;
objContentKeyPolicyTokenRestriction.RestrictionTokenType = ContentKeyPolicyRestrictionTokenType.Jwt;

objContentKeyPolicyRestriction = objContentKeyPolicyTokenRestriction;

return objContentKeyPolicyRestriction;
```

Измените значения `ida_AADOpenIdDiscoveryDocument`, `ida_audience` и `ida_issuer` в приведенном выше коде. Чтобы найти значения этих элементов на портале Azure, сделайте следующее:

1. Выберите арендатор AAD, который вы использовали ранее, щелкните **Регистрация приложений** в меню и щелкните ссылку **Конечные точки**.
1. Выберите и скопируйте значение поля **OpenIdConnect metadata document** (Документ метаданных OpenIdConnect) и вставьте его в код в качестве значения `ida_AADOpenIdDiscoveryDocument`.
1. Значение `ida_audience` является идентификатором зарегистрированного приложения (клиента) *LicenseDeliveryResource2*.
1. Значение `ida_issuer` является URL-адресом `https://login.microsoftonline.com/[tenant_id]/v2.0`. Замените [*tenant_id*] своим идентификатором арендатора.

## <a name="set-up-the-sample-player-app"></a>Настройка примера приложения проигрывателя

Если вы еще этого не сделали, клонируйте или скачайте приложение из репозитория: [https://github.com/Azure-Samples/media-services-content-protection-azure-ad](https://github.com/Azure-Samples/media-services-content-protection-azure-ad).

Настроить приложение проигрывателя можно двумя способами:

* Минимальная настройка (замена только некоторых значений строк констант, например client_id, tenant_id и URL-адреса потоковой передачи), но для этого необходимо использовать Visual Studio Code и Node.js.
* Если вы предпочитаете использовать другую интегрированную среду разработки и веб-платформу, например ASP.NET Core, можете поместить файлы веб-страниц, файлы JavaScript и CSS-файл в свой проект, так как приложение проигрывателя не использует серверный код.

### <a name="option-1"></a>Вариант 1

1. Запустите Visual Studio Code.
1. Чтобы открыть проект, щелкните "Файл" -> "Открыть папку" -> перейдите к родительской папке файла *package.json* и выберите ее.
1. Откройте файл JavaScript *public/javascript/constants.js*.
1. Замените `OAUTH2_CONST.CLIENT_ID` рядом с `client_id` вашего зарегистрированного клиентского приложения в арендаторе AAD.  Вы можете найти `client_id` в разделе "Обзор" зарегистрированного приложения на портале Azure. Примечание. Это идентификатор клиента, а не объекта.
1. Замените значение `OAUTH2_CONST.TENANT_ID` рядом с `tenant_id` вашего арендатора Azure AD. Чтобы найти `tenant_id`, откройте меню Azure Active Directory. Значение tenant_id будет доступно в разделе "Обзор".
1. Замените значение `OAUTH2_CONST.SCOPE` областью, которую вы добавили в зарегистрированное клиентское приложение. Чтобы найти область, перейдите к зарегистрированному клиентскому приложению из меню **Регистрация приложения**, а затем выберите свое клиентское приложение:
    1. Выберите свое клиентское приложение, щелкните меню **Разрешения API**, выберите область *DRM.License.Delivery* под разрешением API *LicenseDeliveryResource2*. Разрешение должно иметь формат вида *api://df4ed433-dbf0-4da6-b328-e1fe05786db5/DRM.License.Delivery*. **Важно!** Не удаляйте пробел перед `offline_access` в `OAUTH2_CONST.SCOPE`.
1. Замените две строки констант для `AMS_CONST`, как показано ниже. Одна из них является URL-адресом защищенной потоковой передачи данных для вашего ресурса тестирования, а другая — URL-адресом сертификата приложения FPS, если вы хотите включить тестовый случай FairPlay. В противном случае вы можете оставить ее без изменений для `AMS_CONST.APP_CERT_URL`. Нажмите кнопку **Сохранить**.

```javascript
//defaults in ams.js
class AMS_CONST {
    static get DEFAULT_URL() {
        return "https://eventgridmediaservice-usw22.streaming.media.azure.net/9591e337-ae90-420e-be30-1da36c06665b/MicrosoftElite01.ism/manifest(format=mpd-time-csf,encryption=cenc)";
    }
    //FairPlay application cert URL
    static get APP_CERT_URL() {
     return `${window.location.href}cert/FPSAC.cer`;
    }
}
```

Чтобы выполнить тестирование локально, сделайте следующее:

1. В Visual Studio Code (VSC) выберите **Вид** в главном меню, а затем щелкните **Терминал**.
1. Если вы еще не установили npm, введите `npm install` в командной строке.
1. Введите `npm start` в командной строке. (Если npm не запускается, попробуйте изменить каталог на `npmweb`, введя `cd npmweb` в командной строке.)
1. В браузере перейдите по адресу `http://localhost:3000`.

В зависимости от используемого браузера выберите правильное сочетание DRM или AES, протокола потоковой передачи и формата контейнеров для тестирования после входа (получение `access_token`). Если вы выполняете тестирование в Safari в macOS, проверьте параметр API перенаправления, так как Safari блокирует всплывающие окна. Большинство других браузеров разрешают всплывающие окна и параметры перенаправления.

### <a name="option-2"></a>Вариант 2

Если вы планируете использовать другую интегрированную среду разработки или веб-платформу и (или) веб-сервер (например, IIS), запущенный на компьютере разработки, скопируйте следующие файлы в новый каталог на локальном веб-сервере. Ниже приведены пути, по которым вы найдете их в скачанном вами коде.

* *views/index.ejs* (измените суффикс на .html)
* *views/jwt.ejs* (измените суффикс на .html)
* *views/info.ejs* (измените суффикс на html)
* *public/* * (файлы JavaScript, CSS, изображения, как показано ниже)

1. Скопируйте файлы из папки *view* в корень нового каталога.
1. Скопируйте *папки* из папки *public* в корень нового каталога.
1. Измените расширения файлов `.ejs` на `.html`. (Серверные переменные не используются, поэтому вы можете без проблем изменить расширения.)
1. Откройте файл *index.html* в VSC (или в другом редакторе кода) и измените пути `<script>` и `<link>` в соответствии с расположениями файлов.  Если вы выполнили предыдущие шаги, вам нужно только удалить `\` в пути.  Например, `<script type="text/javascript" src="/javascript/constants.js"></script>` преобразуется в `<script type="text/javascript" src="javascript/constants.js"></script>`.
1. Настройте константы в файле *javascript/constants.js*, как описано в варианте 1.

## <a name="common-customer-scenarios"></a>Распространенные сценарии клиентов

Теперь, когда вы полностью изучили руководство и создали рабочую подсистему, вы можете адаптировать ее для следующих сценариев клиента:

### <a name="role-based-access-control-rbac-for-license-delivery-via-azure-ad-group-membership"></a>Управление доступом на основе ролей (RBAC) для доставки лицензий через членство в группе Azure AD

Пока система разрешает любому пользователю, который может выполнить вход, получить действительную лицензию и воспроизвести защищенное содержимое.

Одно из распространенных требований клиентов заключается в том, чтобы некоторая часть прошедших аутентификацию пользователей могли просматривать содержимое, а другие — нет, например в зависимости от уровня подписки (базовая или премиум) на доступ к видеосодержимому. Клиенты с базовой подпиской не должны иметь возможности просматривать содержимое, для которого требуется подписка уровня "Премиум". Ниже приведены дополнительные шаги для выполнения этого требования.

#### <a name="set-up-the-azure-ad-tenant"></a>Настройка арендатора Azure AD

1. Настройте две учетные записи в своем арендаторе. Их можно назвать *premium_user* и *basic_user*.
1. Создайте группу пользователей и назовите ее *PremiumGroup*.
1. Добавьте учетную запись *premium_user* в группу *PremiumGroup* в качестве члена, но не добавляйте в группу *basic_user*.
1. Запишите значение **Идентификатор объекта** для *PremiumGroup*.

#### <a name="set-up-the-media-services-account"></a>Настройка учетной записи Служб мультимедиа

Измените `ContentKeyPolicyRestriction` (как показано в разделе "Настройка учетной записи Служб мультимедиа"), добавив утверждение с именем *groups*, где `ida_EntitledGroupObjectId` содержит идентификатор объекта *PremiumGroup* в качестве своего значения:

```dotnetcli

var tokenClaims = new ContentKeyPolicyTokenClaim[] { new ContentKeyPolicyTokenClaim("groups", ConfigAccessor.AppSettings["ida_EntitledGroupObjectId"])
//, other claims, if any.
};

if (tokenClaims != null && tokenClaims.Length > 0)
{
     objContentKeyPolicyTokenRestriction.RequiredClaims = new List<ContentKeyPolicyTokenClaim>(tokenClaims);
}
```

Утверждение *groups* является членом [набора ограниченных утверждений](../../active-directory/develop/active-directory-claims-mapping.md#claim-sets) в Azure AD.

#### <a name="test"></a>Тест

1. Войдите с учетной записью *premium_user*. Вам должно быть доступно воспроизведение защищенного содержимого.
1. Войдите с учетной записью *basic_user*. Вам отобразится ошибка с указанием того, что видео зашифровано, но у вас нет ключа для его расшифровки. Если просмотреть события, ошибки и скачанные файлы с помощью раскрывающегося меню в нижней части наложения диагностики проигрывателя, в сообщении об ошибке будет указано, что не удалось получить лицензию из-за отсутствующего значения утверждения для утверждения groups в маркере JWT, выданном конечной точкой маркера Azure AD.

### <a name="supporting-multiple-media-service-accounts-across-multiple-subscriptions"></a>Поддержка нескольких учетных записей службы мультимедиа (для нескольких подписок)

Клиент может иметь несколько учетных записей службы мультимедиа в одной или нескольких подписках Azure. Например, клиент может иметь одну учетную запись службы мультимедиа в качестве основной рабочей учетной записи, вторую — в качестве дополнительной или резервной, а третью — для разработки и тестирования.

Вам всего лишь нужно удостовериться, что вы используете один и тот же набор параметров из раздела "Настройка учетной записи Служб мультимедиа" при создании `ContentKeyPolicyRestriction` во всех учетных записях службы мультимедиа.

### <a name="supporting-a-customer-its-vendors-andor-subsidiaries-across-multiple-aad-tenants"></a>Поддержка клиента, его поставщиков и (или) филиалов в нескольких арендаторах AAD

Пользователи решения, в число которых входят сотрудники филиалов, поставщики и партнеры клиента, могут относиться к разным арендаторам AAD, например `mycustomer.com`, `mysubsidiary.com` и `myparther.com`. Хотя в этом решении используется один отдельный арендатор AAD, например `mycustomer.com`, вы можете настроить решение для пользователей из других арендаторов.

С помощью `mycustomer.com` для этого решения добавьте пользователя из `mypartner.com` в арендатор `mycustomer.com` в качестве гостевого пользователя. Убедитесь, что пользователь `mypartner.com` активировал гостевую учетную запись. Гостевая учетная запись может принадлежать другому арендатору AAD или учетной записи `outlook.com`.

Обратите внимание, что гостевые пользователи из `mypartner.com` после активации в `mycustomer.com` по-прежнему проходят аутентификацию в собственном (исходном) арендаторе AAD (`mypartner.com`), но `access_token` выдается `mycustomer.com`.

### <a name="supporting-a-customer-tenantsubscription-with-a-setup-in-your-subscriptiontenant"></a>Поддержка арендатора или подписки клиента с помощью настройки в вашей подписке или арендаторе

Вы можете использовать свою настройку для тестирования защищенного содержимого в учетной записи или подписке службы мультимедиа клиента. Вам нужно настроить ее с использованием арендатора Azure AD и учетной записи службы мультимедиа в одной подписке. Учетная запись службы мультимедиа клиента должна располагаться в подписке Azure с собственным арендатором Azure AD клиента.

1. Добавьте учетную запись клиента в арендатор в качестве гостевой учетной записи.
1. При участии клиента подготовьте защищенное содержимое в учетной записи службы мультимедиа клиента, предоставив три параметра, которые указаны в разделе "Настройка учетной записи Служб мультимедиа".

После этого клиент сможет перейти к вашей настройке, войти с помощью гостевой учетной записи и протестировать собственное защищенное содержимое. Вы также можете войти с помощью своей учетной записи и протестировать содержимое клиента.

Пример решения можно настроить в арендаторе Майкрософт с подпиской Майкрософт или в настраиваемом арендаторе с подпиской Майкрософт. Экземпляр Служб мультимедиа Azure может принадлежать к другой подписке со своим арендатором.

## <a name="clean-up-resources"></a>Очистка ресурсов

> [!WARNING]
> Если вы не собираетесь использовать это приложение в дальнейшем, удалите ресурсы, которые вы создали при работе с этим руководством. В противном случае за них будет начислена плата.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Краткое руководство. Шифрование содержимого](encrypt-content-quickstart.md)
