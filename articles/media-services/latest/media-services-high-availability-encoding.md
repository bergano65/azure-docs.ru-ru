---
title: Высокий уровень доступности с помощью служб мультимедиа и видео по запросу (VOD)
description: В этой статье представлен обзор служб Azure, которые можно использовать для обеспечения высокой доступности приложения VOD.
services: media-services
documentationcenter: ''
author: IngridAtMicrosoft
manager: femila
editor: ''
ms.service: media-services
ms.subservice: ''
ms.workload: ''
ms.topic: conceptual
ms.custom: ''
ms.date: 08/31/2020
ms.author: inhenkel
ms.openlocfilehash: 0b6233552501fbe1578f3abe4e203d725ecddb4b
ms.sourcegitcommit: 19dce034650c654b656f44aab44de0c7a8bd7efe
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/04/2020
ms.locfileid: "91707802"
---
# <a name="high-availability-with-media-services-and-video-on-demand-vod"></a>Высокий уровень доступности с помощью служб мультимедиа и видео по запросу (VOD)

[!INCLUDE [media services api v3 logo](./includes/v3-hr.md)]

## <a name="high-availability-for-vod"></a>Высокий уровень доступности для VOD

В документации по архитектуре Azure имеется шаблон разработки высокого уровня доступности, именуемый [жеодес](/azure/architecture/patterns/geodes) . В нем описывается развертывание повторяющихся ресурсов в разных географических регионах для обеспечения масштабируемости и устойчивости.  Службы Azure можно использовать для создания такой архитектуры, которая охватывает множество различных аспектов проектирования высокого уровня доступности, таких как избыточность, мониторинг работоспособности, балансировка нагрузки, резервное копирование и восстановление данных.  Одна из таких архитектур описана ниже с подробными сведениями о каждой службе, используемой в решении, а также о том, как отдельные службы можно использовать для создания архитектуры с высоким уровнем доступности для приложения VOD.

### <a name="sample"></a>Пример

Для ознакомления с высоким уровнем доступности с помощью служб мультимедиа и видео по запросу (VOD) доступен образец. Кроме того, здесь подробно описано, как службы используются для VOD сценария.  Образец не предназначен для использования в рабочей среде в текущей форме.  Внимательно ознакомьтесь с образцом кода и файлом readme, особенно в разделе, посвященном [режимам сбоя](https://github.com/Azure-Samples/media-services-v3-dotnet/tree/master/HighAvailabilityEncodingStreaming) , перед интеграцией в рабочее приложение.  Рабочая реализация высокого уровня доступности видео по запросу (VOD) также должна тщательно проверять стратегию сети доставки содержимого (CDN).  Ознакомьтесь с [кодом на сайте GitHub](https://github.com/Azure-Samples/media-services-v3-dotnet/tree/master/HighAvailabilityEncodingStreaming).

## <a name="overview-of-services"></a>Общие сведения о службах

Ниже перечислены службы, используемые в этом примере архитектуры.

| Значок | Имя | Описание |
| :--: | ---- | ----------- |
|![Это значок учетной записи служб мультимедиа.](media/media-services-high-availability-encoding/azure-media-services.svg)| Учетная запись служб мультимедиа | **Описание.**<br>Учетная запись служб мультимедиа является отправной точкой для управления, шифрования, кодирования, анализа и потоковой передачи мультимедийного содержимого в Azure. Он связан с ресурсом учетной записи хранения Azure. Учетная запись и все связанные хранилища должны быть в одной подписке Azure.<br><br>**VOD использовать:**<br>Это службы, используемые для кодирования и доставки видео и звуковых ресурсов.  Для обеспечения высокой доступности необходимо настроить по крайней мере две учетные записи служб мультимедиа, каждый из которых находится в другом регионе. Дополнительные [сведения о службах мультимедиа Azure](media-services-overview.md). |
|![Это значок учетной записи хранения.](media/media-services-high-availability-encoding/storage-account.svg)| Учетная запись хранения | **Описание.**<br>Учетная запись хранения Azure содержит все объекты данных службы хранилища Azure: большие двоичные объекты, файлы, очереди, таблицы и диски. Данные доступны из любой точки мира по протоколу HTTP или HTTPS.<br><br>Каждая учетная запись служб мультимедиа в каждом регионе будет иметь учетную запись хранения в том же регионе.<br><br>**VOD использовать:**<br>Вы можете хранить входные и выходные данные для VOD обработки и потоковой передачи. Дополнительные [сведения о службе хранилища Azure](../../storage/common/storage-introduction.md). |
|![Это значок очереди службы хранилища Azure.](media/media-services-high-availability-encoding/storage-account-queue.svg)| Очередь службы хранилища Azure | **Описание.**<br>Хранилище очередей Azure — это служба для хранения большого количества сообщений, к которым можно получить доступ практически из любой точки мира с помощью вызовов с проверкой подлинности по протоколам HTTP или HTTPS.<br><br>**VOD использовать:**<br>Очереди можно использовать для отправки и получения сообщений для координации действий между различными модулями. В этом примере используется очередь службы хранилища Azure, но Azure предоставляет другие типы очередей, такие как служебная шина, и Service Fabric надежные очереди, которые могут лучше соответствовать вашим потребностям. Дополнительные [сведения об очереди Azure](../../storage/queues/storage-queues-introduction.md). |
|![Это значок Azure Cosmos DB.](media/media-services-high-availability-encoding/azure-cosmos-db.svg)| Azure Cosmos DB  | **Описание.**<br>Azure Cosmos DB — это глобально распределенная многомодельная служба базы данных Майкрософт, которая независимо масштабирует пропускную способность и хранилище в любом количестве регионов Azure по всему миру.<br><br>**VOD использовать:**<br>Таблицы можно использовать для хранения записей состояния выходных данных заданий и для отслеживания состояния работоспособности каждого экземпляра служб мультимедиа. Можно также отзаписывать и записывать состояние каждого вызова в API служб мультимедиа. Дополнительные [сведения о Azure Cosmos DB](../../cosmos-db/introduction.md).  |
|![Это значок управляемого удостоверения.](media/media-services-high-availability-encoding/managed-identity.svg)| Управляемое удостоверение | **Описание.**<br>Управляемое удостоверение — это функция Azure AD, которая предоставляет автоматически управляемое удостоверение в Azure AD. Его можно использовать для проверки подлинности в любой службе, поддерживающей проверку подлинности Azure AD, включая Key Vault, без сохранения учетных данных в коде.<br><br>**VOD использовать:**<br>Функции Azure могут использовать управляемое удостоверение для проверки подлинности экземпляров служб мультимедиа для подключения к Key Vault. Дополнительные [сведения об управляемом удостоверении](../../active-directory/managed-identities-azure-resources/overview.md). |
|![Это значок Key Vault.](media/media-services-high-availability-encoding/key-vault.svg)| Key Vault | **Описание.**<br>Azure Key Vault можно использовать для безопасного хранения и строгого управления доступом к маркерам, паролям, сертификатам, ключам API и другим секретам. Его также можно использовать в качестве решения для управления ключами. Эта служба позволяет легко создавать и контролировать ключи шифрования, используемые для шифрования данных. Он позволяет легко подготавливать, администрировать и развертывать общедоступные и частные сертификаты безопасности и SSL (TLS/SSL) для использования с Azure и внутренними подключенными ресурсами. Секреты и ключи могут быть защищены программным обеспечением или FIPS 140-2 уровня 2 с проверкой HSM.<br><br>**VOD использовать:**<br>Key Vault можно использовать для настройки политик доступа для субъекта-службы для приложения.  Его можно использовать для хранения строки подключения к учетным записям хранения. Мы используем Key Vault для хранения строк подключения к учетным записям хранения и Cosmos DB. Можно также использовать Key Vault для хранения общей конфигурации кластера. Для каждого экземпляра службы мультимедиа можно хранить идентификатор подписки, имя группы ресурсов и имя учетной записи. Дополнительные сведения см. в разделе Использование в образце. Дополнительные [сведения о Key Vault](../../key-vault/general/overview.md). |
|![Это значок функций Azure.](media/media-services-high-availability-encoding/function-app.svg)| Функции Azure | **Описание.**<br>Запускайте небольшие фрагменты кода ("функции"), не беспокоясь о инфраструктуре приложений с помощью функций Azure. Дополнительные [сведения о функциях Azure](../../azure-functions/functions-overview.md).<br><br>**VOD использовать:**<br>Функции Azure можно использовать для хранения размещения модулей приложения VOD.  Модули для приложения VOD могут включать:<br><br>**Модуль планирования заданий**<br>Модуль планирования заданий будет использоваться для отправки новых заданий в кластер служб мультимедиа (два или более экземпляров в разных регионах). Он будет отследить состояние работоспособности каждого экземпляра служб мультимедиа и отправить новое задание в следующий работоспособный экземпляр.<br><br>**Модуль состояния задания**<br>Модуль состояния задания будет ожидать события состояния вывода задания, поступающие от службы "Сетка событий Azure". Он хранит события в хранилище событий, чтобы максимально сокращать количество вызовов API служб мультимедиа по оставшимся модулям.<br><br>**Модуль работоспособности экземпляра**<br>Этот модуль будет учитывать отправленные задания и определять состояние работоспособности каждого экземпляра служб мультимедиа. Она будет отслеживанию завершенных заданий, невыполненных заданий и заданий, которые никогда не были завершены.<br><br>**Модуль подготовки**<br>Этот модуль будет подготавливать обработанные ресурсы. Он скопирует данные активов во все экземпляры служб мультимедиа и настроит службу "Передняя дверца Azure", чтобы обеспечить потоковую передачу ресурсов даже в случае недоступности некоторых экземпляров служб мультимедиа. Он также настроил указатели потоковой передачи.<br><br>**Модуль проверки заданий**<br>Этот модуль будет учитывать каждое отправленное задание, повторно отправить невыполненные задания и выполнить очистку данных задания после успешного завершения задания.  |
|![Это значок службы приложений.](media/media-services-high-availability-encoding/application-service.svg)| Служба приложений (и план)  | **Описание.**<br>Служба приложений Azure — это служба на базе HTTP для размещения веб-приложений, интерфейсов REST API и серверной части мобильных решений. Он поддерживает .NET, .NET Core, Java, Ruby, Node.js, PHP или Python. Приложения выполняются и масштабируются в средах под управлением Windows и Linux.<br><br>**VOD использовать:**<br>Каждый модуль будет размещен в службе приложений. Дополнительные [сведения о службе приложений](../../app-service/overview.md). |
|![Это значок передней дверцы Azure.](media/media-services-high-availability-encoding/azure-front-door.svg)| Azure Front Door | **Описание.**<br>С помощью передней дверцы Azure можно определять и отслеживать глобальную маршрутизацию веб-трафика, а также управлять ею, оптимизируя оптимальную производительность и выполнять быструю глобальную отработку отказа для обеспечения высокой доступности.<br><br>**VOD использовать:**<br>Для маршрутизации трафика в конечные точки потоковой передачи можно использовать переднюю дверцу Azure. [Дополнительные сведения о передней дверце Azure](../../frontdoor/front-door-overview.md).  |
|![Это значок службы "Сетка событий Azure".](media/media-services-high-availability-encoding/event-grid-subscription.svg)| Сетка событий Azure. | **Описание.**<br>Служба "Сетка событий", созданная для архитектур на основе событий, имеет встроенную поддержку событий, поступающих от служб Azure, таких как большие двоичные объекты и группы ресурсов хранилища. Он также поддерживает пользовательские события темы. Фильтры можно использовать для маршрутизации конкретных событий в разные конечные точки, многоадресной рассылки на несколько конечных точек и для гарантии надежной доставки событий. Она позволяет максимально повысить уровень доступности за счет распределения по нескольким доменам сбоя в каждом регионе и в разных зонах доступности.<br><br>**VOD использовать:**<br>Сетка событий может использоваться для трассировки всех событий приложения и сохранения их для сохранения состояния задания. [Дополнительные сведения о службе "Сетка событий Azure](../../event-grid/overview.md)". |
|![Это значок Application Insights.](media/media-services-high-availability-encoding/application-insights.svg)| Application Insights | **Описание.** <br>Application Insights, компонент Azure Monitor, является расширяемой службой управления производительностью приложений (APM) для разработчиков и DevOps-специалистов. Он используется для наблюдения за динамическими приложениями. Он обнаруживает аномалии производительности и включает средства анализа для диагностики проблем и понимания того, что пользователи делают с приложением. Эта служба помогает постоянно улучшать производительность и удобство использования.<br><br>**VOD использовать:**<br>Все журналы можно отправлять на Application Insights. Можно увидеть, какой экземпляр обработал каждое задание, выполнив поиск успешно созданных сообщений о заданиях. Он может содержать все отправленные метаданные задания, включая уникальные идентификаторы и сведения об имени экземпляра. Дополнительные [сведения о Application Insights](../../azure-monitor/app/app-insights-overview.md). |
## <a name="architecture"></a>Architecture

На этой высокоуровневой схеме показана архитектура примера, предоставляемого для начала работы с высокой доступностью и службами мультимедиа.

[![Схема ](media/media-services-high-availability-encoding/high-availability-architecture.svg) архитектуры на высоком уровне видео по запросу (VOD)](media/media-services-high-availability-encoding/high-availability-architecture.svg#lightbox)

## <a name="best-practices"></a>Рекомендации

### <a name="regions"></a>Регионы

* [Создайте](https://review.docs.microsoft.com/azure/media-services/latest/create-account-cli-how-to) две (или более) учетные записи служб мультимедиа Azure. Две учетные записи должны находиться в разных регионах. Дополнительные сведения см. [в разделе регионы, в которых развертывается служба служб мультимедиа Azure](https://azure.microsoft.com/global-infrastructure/services/?products=media-services).
* Отправьте носитель в тот же регион, из которого вы планируете отправить задание. Дополнительные сведения о том, как начать кодирование, см. в разделе [Создание входных данных задания с помощью URL-адреса HTTPS](https://review.docs.microsoft.com/azure/media-services/latest/job-input-from-http-how-to) или [Создание входных данных задания из локального файла](https://review.docs.microsoft.com/azure/media-services/latest/job-input-from-local-file-how-to).
* Если необходимо повторно отправить [Задание](https://review.docs.microsoft.com/azure/media-services/latest/transforms-jobs-concept) в другой регион, можно использовать `JobInputHttp` или использовать `Copy-Blob` для копирования данных из контейнера исходного ресурса в контейнер ресурса в альтернативном регионе.

### <a name="monitoring"></a>Наблюдение

* Подпишитесь на `JobStateChange` сообщения в каждой учетной записи с помощью службы "Сетка событий Azure".
    * [Регистрация событий](https://review.docs.microsoft.com/azure/media-services/latest/reacting-to-media-services-events) с помощью портал Azure или интерфейса командной строки (это также можно сделать с помощью пакета SDK для управления сеткой событий).
    * Используйте [пакет SDK Microsoft. Azure. EventGrid](https://www.nuget.org/packages/Microsoft.Azure.EventGrid/) (который поддерживает события служб мультимедиа в собственном виде).
    * Вы также можете использовать события службы "Сетка событий" с помощью функций Azure.

    Дополнительные сведения

    * См. [Пример "Audio Analytics](https://review.docs.microsoft.com/azure/media-services/latest/transforms-jobs-concept) ", в котором показано, как отслеживать задание с помощью службы "Сетка событий Azure", включая добавление резервной стратегии в случае задержки сообщений службы "Сетка событий Azure" по какой-либо причине.
    * Ознакомьтесь со [схемами службы "Сетка событий Azure" для событий служб мультимедиа](https://review.docs.microsoft.com/azure/media-services/latest/media-services-event-schemas).

* При создании [задания](https://review.docs.microsoft.com/azure/media-services/latest/transforms-jobs-concept):
    * Случайный выбор учетной записи из списка используемых в данный момент учетных записей (этот список обычно содержит обе учетные записи, но при обнаружении проблем может содержать только одну учетную запись). Если список пуст, создайте предупреждение, чтобы оператор мог исследовать его.
    * Создайте запись для наблюдения за каждым заданием порядковых и используемым регионом или учетной записью.
* Когда `JobStateChange` обработчик получает уведомление о том, что задание достигло запланированного состояния, запишите время, в которое он входит в запланированное состояние, а также используемую область или учетную запись.
* Когда `JobStateChange` обработчик получает уведомление о том, что задание достигло состояния обработки, отметьте запись для задания как обработку и запишите время, когда оно попадает в состояние обработки.
* Когда `JobStateChange` обработчик получает уведомление о том, что задание достиго окончательного состояния (завершено или ошибочно/отменено), отметьте запись для задания соответствующим образом.
* Наличие отдельного процесса, который периодически проверяет записи заданий
    * Если у вас есть задания в запланированном состоянии, которые еще не были расширены до состояния обработки в течение разумного периода времени для данного региона, удалите этот регион из списка используемых в данный момент учетных записей. В зависимости от бизнес-требований вы можете отменить эти задания прямо сейчас и отправить их в другой регион. Вы также можете предоставить им дополнительное время, чтобы перейти к следующему состоянию.
    * Если регион был удален из списка учетных записей, прежде чем добавлять его в список, отслеживайте его для восстановления. Региональную работоспособность можно отслеживать с помощью существующих заданий в регионе (если они не были отменены и не отправлены повторно), добавив учетную запись обратно в список по истечении определенного периода времени, а операторы отслеживают связи Azure о сбоях, которые могут влиять на службы мультимедиа Azure.

## <a name="next-steps"></a>Дальнейшие действия

* Ознакомьтесь с [примерами кода](/samples/browse/?products=azure-media-services)
