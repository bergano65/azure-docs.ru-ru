---
title: Использование динамического шифрования DRM и службы доставки лицензий
titleSuffix: Azure Media Services
description: Узнайте, как использовать динамическое шифрование DRM и службу доставки лицензий для доставки потоков, зашифрованных с помощью лицензий Microsoft PlayReady, Google Widevine или Apple FairPlay.
services: media-services
documentationcenter: ''
author: juliako
manager: femila
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 05/25/2019
ms.author: juliako
ms.custom: seodec18
ms.openlocfilehash: 3d2dc7793c25fb20e267332beaa683f11ddcbfbb
ms.sourcegitcommit: 5ab4f7a81d04a58f235071240718dfae3f1b370b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2019
ms.locfileid: "74974076"
---
# <a name="tutorial-use-drm-dynamic-encryption-and-license-delivery-service"></a>Учебник. Использование динамического шифрования DRM и службы доставки лицензий

> [!NOTE]
> Несмотря на то что в этом учебнике используются примеры для [пакета SDK для .NET](https://docs.microsoft.com/dotnet/api/microsoft.azure.management.media.models.liveevent?view=azure-dotnet), общие шаги одинаковы для [REST API](https://docs.microsoft.com/rest/api/media/liveevents), [CLI](https://docs.microsoft.com/cli/azure/ams/live-event?view=azure-cli-latest) или других поддерживаемых [пакетов SDK](media-services-apis-overview.md#sdks).

Службы мультимедиа Azure можно использовать для доставки потоков, которые были зашифрованы с помощью лицензий Microsoft PlayReady, Google Widevine или Apple FairPlay. Подробное описание см. в статье [Защита содержимого с помощью динамического шифрования](content-protection-overview.md).

Службы мультимедиа также предоставляют службу для доставки лицензий PlayReady, Widevine и FairPlay DRM. Когда пользователь запрашивает защищенное DRM содержимое, приложение проигрывателя запрашивает лицензию от службы лицензирования служб мультимедиа. Если приложение проигрывателя является полномочным, служба лицензий служб мультимедиа выдает лицензию проигрывателю. В лицензии содержится ключ расшифровки, который может использоваться клиентским проигрывателем для расшифровки и потоковой передачи содержимого.

В этой статье используется пример [шифрования с использованием DRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM).

Выполнение описанного здесь примера позволит получить следующий результат.

![AMS с видео, защищенным DRM, в Проигрыватель мультимедиа Azure](./media/protect-with-drm/ams_player.png)

В этом учебнике описаны следующие процедуры.

> [!div class="checklist"]
> * Создайте преобразование кодировки.
> * Установка ключа подписывания, используемого для проверки маркера безопасности.
> * Задайте требования к политике ключа содержимого.
> * Создание Стреаминглокатор с указанной политикой потоковой передачи.
> * Создайте URL-адрес, используемый для воспроизведения файла.

## <a name="prerequisites"></a>Технические условия

Ниже перечислены необходимые условия для выполнения действий, описанных в этом руководстве:

* Просмотрите статью [Обзор системы защиты содержимого](content-protection-overview.md).
* Ознакомьтесь [с разработкой системы защиты содержимого с несколькими DRM с помощью контроля доступа](design-multi-drm-system-with-access-control.md).
* Установите Visual Studio Code или Visual Studio.
* Создайте учетную запись Служб мультимедиа Azure, как описано в [этом руководстве](create-account-cli-quickstart.md).
* Получите учетные данные, необходимые для использования API служб мультимедиа. Дополнительные сведения см. в разделе [Доступ к API Служб мультимедиа Azure с помощью Azure CLI](access-api-cli-how-to.md)
* Задайте соответствующие значения в файле конфигурации приложения (appSettings. JSON).

## <a name="download-code"></a>Скачать код

Клонируйте репозиторий GitHub, содержащий полный пример .NET, который был рассмотрен в этой статье, на компьютер с помощью следующей команды.

 ```bash
 git clone https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials.git
 ```
 
Образец "Шифровать с DRM" находится в папке [EncryptWithDRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM).

> [!NOTE]
> В этом примере уникальные ресурсы создаются каждый раз при запуске приложения. Как правило, вы будете повторно использовать существующие ресурсы, такие как преобразования и политики (если у существующего ресурса есть необходимые конфигурации).

## <a name="start-using-media-services-apis-with-net-sdk"></a>Начало использования API Служб мультимедиа с пакетом SDK для .NET

Чтобы приступить к использованию API-интерфейсов служб мультимедиа в .NET, создайте объект **азуремедиасервицесклиент** . Чтобы создать объект, введите учетные данные, необходимые клиенту для подключения к Azure с помощью Azure AD. В коде, клонированном в начале статьи, функция **GetCredentialsAsync** создает объект ServiceClientCredentials с использованием учетных данных, предоставленных в локальном файле конфигурации.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#CreateMediaServicesClient)]

## <a name="create-an-output-asset"></a>создание выходного ресурса;  

Выходной [ресурс](assets-concept.md) сохраняет результаты задания кодирования.  

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#CreateOutputAsset)]

## <a name="get-or-create-an-encoding-transform"></a>Получение или создание преобразования кодировки

При создании нового экземпляра [преобразования](transforms-jobs-concept.md) необходимо указать, что требуется создать в качестве выходных данных. Обязательный параметр — это `transformOutput` объект, как показано в приведенном ниже коде. Каждый Трансформаутпут содержит **предустановку**. Предустановка описывает пошаговые инструкции по обработке видео и (или) аудио-обработки, которые будут использоваться для создания нужных Трансформаутпут. Пример, описанный в этой статье, использует встроенную предустановку, называемую **AdaptiveStreaming**. Предустановка кодирует входное видео в автоматически создаваемые пары с скоростью, основанные на разрешении и скорости ввода, и создает MP4-файлы ISO с H. 264 Video и AAC Audio, соответствующие каждой паре для разрешения скорости. 

Перед созданием нового **преобразования** сначала проверьте, существует ли оно, с помощью метода **Get**, как показано в следующем коде.  В Службах мультимедиа версии 3 методы **Get**, отправленные к сущностям, возвращают значение **NULL**, если сущность не существует (проверка по имени без учета регистра).

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#EnsureTransformExists)]

## <a name="submit-job"></a>Отправка задания

Как было указано выше, объект **преобразования** является набором инструкций, а [задание](transforms-jobs-concept.md) — фактическим запросом к Службам мультимедиа для применения этого **преобразования** к данному видео и аудио. **Задание** указывает такую информацию, как расположение входного и выходного видео.

В этом руководстве мы создадим входные данные задания на основе файла, который принимается непосредственно из [URL-адреса источника HTTPS](job-input-from-http-how-to.md).

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#SubmitJob)]

## <a name="wait-for-the-job-to-complete"></a>Ожидание завершения задания

Запуск задания занимает некоторое время. Поэтому вам пригодится уведомление. В примере кода ниже показано, как опрашивать службу о состоянии **задания**. Опрос не рекомендуется для приложений рабочей среды из-за потенциальной задержки. Его можно регулировать при чрезмерном использовании в учетной записи. Вместо этого разработчики должны использовать службу "Сетка событий". Дополнительные сведения см. в статье [Route Azure Media Services events to a custom web endpoint using CLI](job-state-events-cli-how-to.md) (Маршрутизация событий Служб мультимедиа в пользовательскую конечную точку с помощью CLI).

**Задание** обычно проходит через такие состояния: **Запланировано**, **В очереди**, **Обработка**, **Завершено** (конечное состояние). Если в задании обнаружена ошибка, вы получите состояние **Ошибка**. Если задание находится в процессе отмены, вы получите состояние **Выполнение отмены** и **Отменено** по завершении.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#WaitForJobToFinish)]

## <a name="create-a-content-key-policy"></a>Создание политики ключа содержимого

Ключ содержимого обеспечивает безопасность доступа к ресурсам. При шифровании содержимого с помощью DRM необходимо создать [политику ключа содержимого](content-key-policy-concept.md) . Политика настраивает способ доставки ключа содержимого конечным клиентам. Ключ содержимого связан с указателем потоковой передачи. Службы мультимедиа также включают в себя службу доставки ключей, которая доставляет ключи шифрования и лицензии авторизованным пользователям.

Необходимо задать требования (ограничения) для **политики ключа содержимого** , которые должны быть выполнены для доставки ключей с указанной конфигурацией. Для этого примера будут установлены следующие конфигурации и требования.

* Настройка

    Лицензии [PlayReady](playready-license-template-overview.md) и [Widevine](widevine-license-template-overview.md) являются настраиваемыми, что позволяет доставлять их с помощью службы доставки лицензий для служб мультимедиа. Несмотря на то, что этот пример приложения не настраивает лицензию [Fairplay](fairplay-license-overview.md) , он содержит метод, который можно использовать для настройки Fairplay. Можно добавить конфигурацию FairPlay в качестве другого параметра.

* Ограничение

    Приложение задает для политики ограничение типа маркера JSON Web Token (JWT).

Когда поток запрашивается проигрывателем, службы мультимедиа используют указанный ключ для динамического шифрования содержимого. Чтобы расшифровать поток, проигрыватель запросит ключ у службы доставки ключей. Чтобы определить, есть ли у пользователя право на получение ключа, служба оценит политику ключа содержимого, заданную для него.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#GetOrCreateContentKeyPolicy)]

## <a name="create-a-streaming-locator"></a>Создание указателя потоковой передачи

После выполнения кодирования и установки политики ключа содержимого следующий шаг — это сделать видео на выходном ресурсе доступным для воспроизведения клиентами. Сделать видео доступным в два этапа:

1. Создайте [указатель потоковой передачи](streaming-locators-concept.md).
2. Создайте URL-адрес потоковой передачи, который смогут использовать клиенты.

Процесс создания **указателя потоковой передачи** называется публикацией. По умолчанию **указатель потоковой передачи** действителен сразу же после выполнения вызовов API. Он продолжается до тех пор, пока не будет настроено дополнительное время начала и окончания.

При создании **указателя потоковой передачи**необходимо указать требуемый `StreamingPolicyName`. В этом руководстве мы используем одну из стандартных политик потоковой передачи, которая сообщает службам мультимедиа Azure о том, как опубликовать содержимое для потоковой передачи. В этом примере для StreamingLocator.StreamingPolicyName задается значение Predefined_MultiDrmCencStreaming. Применяются шифрования PlayReady и Widevine, а ключ доставляется клиенту воспроизведения на основе настроенных лицензий DRM. Если необходимо выполнить шифрование потока с помощью CBCS (FairPlay), используйте Predefined_MultiDrmStreaming.

> [!IMPORTANT]
> При использовании пользовательской [политики потоковой передачи](streaming-policy-concept.md) следует разработать ограниченный набор таких политик для учетной записи Служб мультимедиа и повторно использовать их для компонентов StreamingLocator каждый раз, когда требуются те же параметры шифрования и протоколы. У вашей учетной записи Служб мультимедиа есть квота на количество записей StreamingPolicy. Не следует создавать новый Стреамингполици для каждого Стреаминглокатор.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#CreateStreamingLocator)]

## <a name="get-a-test-token"></a>Получение маркера тестирования

В этом руководстве указывается, что политика ключа содержимого включает ограничение по маркеру. При ограничении с помощью маркера к политике должен прилагаться маркер, выданный службой маркеров безопасности (STS). Службы мультимедиа поддерживают маркеры в форматах [JWT](https://msdn.microsoft.com/library/gg185950.aspx#BKMK_3) , а именно мы настраиваем в примере.

ContentKeyIdentifierClaim используется в ContentKeyPolicy. Это значит, что маркер, предоставленный службе доставки ключей, должен иметь идентификатор ContentKey. В примере мы не указываем ключ содержимого при создании указателя потоковой передачи, система создает случайную единицу для нас. Чтобы создать токен теста, необходимо получить Контенткэйид, чтобы поместить его в утверждение Контенткэйидентифиерклаим.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#GetToken)]

## <a name="build-a-streaming-url"></a>Создание URL-адреса потоковой передачи

После создания [StreamingLocator](https://docs.microsoft.com/rest/api/media/streaminglocators) вы можете получить URL-адреса потоковой передачи. Чтобы создать URL-адрес, необходимо объединить имя узла [StreamingEndpoint](https://docs.microsoft.com/rest/api/media/streamingendpoints) и путь **потокового указателя** . В этом примере используется **конечная точка потоковой передачи** *по умолчанию*. При первом создании учетной записи Служб мультимедиа эта **конечная точка потоковой передачи** *по умолчанию* будет находиться в остановленном состоянии, поэтому вам необходимо вызвать функцию **Start**.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#GetMPEGStreamingUrl)]

При запуске приложения отображается следующий экран:

![Защита с помощью DRM](./media/protect-with-drm/playready_encrypted_url.png)

Чтобы запустить демонстрационную страницу проигрывателя мультимедиа Azure с URL-адресом и маркером, который уже указан, откройте браузер и вставьте полученный URL-адрес.

## <a name="clean-up-resources-in-your-media-services-account"></a>Очистка ресурсов в учетной записи Служб мультимедиа

Как правило, следует очищать все, кроме объектов, которые планируется повторно использовать (как правило, используются преобразования, Стреаминглокаторс и т. д.). Если учетную запись требуется очистить после эксперимента, удалите ресурсы, которые не планируется использовать повторно. Например, следующий код удаляет задания.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#CleanUp)]

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вам больше не нужны какие-либо ресурсы в группе ресурсов, включая Службы мультимедиа и учетные записи хранения, созданные для этого руководства, удалите группу ресурсов, созданную ранее.

Выполните следующую команду CLI:

```azurecli
az group delete --name amsResourceGroup
```

## <a name="additional-notes"></a>Дополнительные замечания

* Widevine — это служба, предоставляемая Google Inc. и подпадает под условия обслуживания и политики конфиденциальности Google, Inc.

## <a name="ask-questions-give-feedback-get-updates"></a>Получение справки, отправка отзывов, получение обновлений

Прочитайте статью [сообщества Служб мультимедиа Azure](media-services-community.md), чтобы узнать, как задавать вопросы, оставлять отзывы и получать новости о Службах мультимедиа.

## <a name="next-steps"></a>Дальнейшие действия

Ознакомьтесь

> [!div class="nextstepaction"]
> [Использование динамического шифрования AES-128 и службы доставки ключей](protect-with-aes128.md)