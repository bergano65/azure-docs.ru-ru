---
title: Определение фильтров в Службах мультимедиа Microsoft Azure
description: В этом разделе описывается создание фильтров, с помощью которых клиент может передавать определенные секции потока. Для достижения такой выборочной потоковой передачи службы мультимедиа создают динамические манифесты.
services: media-services
documentationcenter: ''
author: Juliako
manager: femila
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: ne
ms.topic: article
ms.date: 05/23/2019
ms.author: juliako
ms.openlocfilehash: fdf29924da31db0347938df89e698cb258c2336b
ms.sourcegitcommit: 7b25c9981b52c385af77feb022825c1be6ff55bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/13/2020
ms.locfileid: "79251470"
---
# <a name="filters"></a>Фильтры

При доставке содержимого клиентам (события потоковой трансляции или видео по запросу) клиенту может потребоваться больше гибкости, чем описано в файле манифеста ресурса по умолчанию. Службы мультимедиа Azure предлагают [динамические манифесты](filters-dynamic-manifest-overview.md) на основе предварительно определенных фильтров. 

Фильтры — это серверные правила, с помощью которых пользователи могут выполнять различные действия, в том числе перечисленные ниже. 

- Воспроизведение только части видео (вместо воспроизведения видео целиком). Пример:
  - Сокращение манифеста для отображения субклипа текущего события ("фильтрация субклипов") или
  - Обрезка начала видео ("обрезка видео").
- Доставка только указанных представлений и/или языковых дорожек, поддерживаемых устройством, на котором воспроизводится содержимое ("фильтрация представлений"). 
- Настройка окна представления (DVR) для предоставления ограниченной длительности окна DVR в проигрывателе ("настройка окна представления").

Службы мультимедиа позволяют создавать **фильтры учетных записей** и **фильтры активов** для содержимого. Кроме того, вы можете связать предварительно созданные фильтры с **указателем потоковой передачи**.

## <a name="defining-filters"></a>Определение фильтров

Существует два типа фильтров: 

* [Фильтры учетных записей](https://docs.microsoft.com/rest/api/media/accountfilters) (глобальные) — применимы к любому ресурсу в учетной записи Служб мультимедиа Azure и действуют в течение всего времени ее существования.
* [Фильтры ресурсов](https://docs.microsoft.com/rest/api/media/assetfilters) (локальные) — применимы только к тому ресурсу, с которым фильтр был связан при создании, и действуют в течение времени существования ресурса. 

**Фильтры учетных записей** и типы **фильтров активов** имеют точно такие же свойства для определения или описания фильтра. Во всех случаях, кроме создания **фильтра ресурса**, необходимо указать имя ресурса, с которым требуется связать фильтр.

В зависимости от сценария, вы выбираете наиболее подходящий тип фильтра (фильтр ресурса или учетной записи). Фильтры учетных записей подходят для профилей устройств (фильтрация представлений), в то время как фильтры ресурсов можно использовать для обрезки определенного ресурса.

Для описания фильтров можно использовать указанные ниже свойства. 

|Имя|Description|
|---|---|
|firstQuality|Первая качественная скорость фильтра.|
|presentationTimeRange|Диапазон времени презентации. Это свойство используется для фильтрации начальной и конечной точек манифеста, длины окна презентации и начального положения прямой трансляции. <br/>Дополнительные сведения см. в разделе [PresentationTimeRange](#presentationtimerange).|
|tracks|Условия выбора дорожек. Дополнительные сведения см. в разделе [tracks](#tracks).|

### <a name="presentationtimerange"></a>presentationTimeRange

Это свойство используется с **фильтрами ресурсов**. Не рекомендуем задавать это свойство для **фильтров учетных записей**.

|Имя|Description|
|---|---|
|**endTimestamp**|Применяется для видео по запросу (VoD).<br/>Для презентации с потоковой передачей в реальном времени она игнорируется и применяется, когда презентация завершается и поток становится VoD.<br/>Это длинное значение, представляющее абсолютную конечную точку презентации, округленное до ближайшей следующей GOP начала. Единицей является шкала времени, поэтому Ендтиместамп 1800000000 будет составлять 3 минуты.<br/>Используйте Старттиместамп и Ендтиместамп, чтобы обрезать фрагменты, которые будут находиться в списке воспроизведения (манифесте).<br/>Например, Старттиместамп = 40000000 и Ендтиместамп = 100000000 с использованием шкалы времени по умолчанию создаст список воспроизведения, содержащий фрагменты между 4 секундами и 10 секундами представления VoD. Если фрагмент выходит за границы, он будет включен в манифест целиком.|
|**forceEndTimestamp**|Применяется только к потоковой передаче в режиме реального времени.<br/>Указывает, должно ли быть задано свойство Ендтиместамп. Если значение — true, Ендтиместамп должен быть указан или возвращен недопустимый код запроса.<br/>Допустимые значения: false, true.|
|**liveBackoffDuration**|Применяется только к потоковой передаче в режиме реального времени.<br/> Это значение определяет последнюю динамическую точку, к которой может перейти клиент.<br/>С помощью этого свойства можно отложить размещение в реальном времени и создать буфер на стороне сервера для игроков.<br/>Единицей измерения для этого свойства является шкала времени (см. ниже).<br/>Максимальная длительность обратного отключения составляет 300 секунд (3000000000).<br/>Например, значение 2000000000 означает, что последнее доступное содержимое составляет 20 секунд, отложенных от реальной живой границы.|
|**presentationWindowDuration**|Применяется только к потоковой передаче в режиме реального времени.<br/>Используйте Пресентатионвиндовдуратион, чтобы применить скользящее окно фрагментов для включения в список воспроизведения.<br/>Единицей измерения для этого свойства является шкала времени (см. ниже).<br/>Например, задайте значение presentationWindowDuration = 1200000000, чтобы применить двухминутное скользящее окно. В список воспроизведения будут включены данные мультимедиа за две минуты до крайней позиции прямой трансляции. Если фрагмент выходит за границы, он будет включен в список воспроизведения целиком. Минимальная продолжительность окна презентации составляет 60 секунд.|
|**startTimestamp**|Применяется к видео по запросу (VoD) или потоковой передаче в реальном времени.<br/>Это длинное значение, представляющее абсолютную начальную точку потока. Оно округляется до начала ближайшей из следующих групп изображений. Единицей является шкала времени, поэтому Старттиместамп 150000000 будет составлять 15 секунд.<br/>Используйте Старттиместамп и Ендтиместампп, чтобы обрезать фрагменты, которые будут находиться в списке воспроизведения (манифесте).<br/>Например, Старттиместамп = 40000000 и Ендтиместамп = 100000000 с использованием шкалы времени по умолчанию создаст список воспроизведения, содержащий фрагменты между 4 секундами и 10 секундами представления VoD. Если фрагмент выходит за границы, он будет включен в манифест целиком.|
|**timescale**|Применяется ко всем меткам времени и длительности в диапазоне времени презентации, указанном как число приращений за одну секунду.<br/>Значение по умолчанию 10000000-10 000 000 увеличивается в одну секунду, где каждый шаг приращения будет иметь длину 100 наносекунд.<br/>Например, если вы хотите установить Старттиместамп в течение 30 секунд, при использовании шкалы времени по умолчанию будет использоваться значение 300000000.|

### <a name="tracks"></a>Дорожки

Вы указываете список условий фильтра отслеживания свойств (Филтертраккпропертикондитионс), на основе которых в динамически создаваемый манифест должны быть включены дорожки потока (потоковая передача или видео по запросу). Фильтры объединяются с помощью логических операций **AND** и **OR**.

Условия фильтрации свойств дорожек описывают типы дорожек, значения (приведенные в таблице ниже) и операции (Equal, NotEqual). 

|Имя|Description|
|---|---|
|**Bitrate**|Фильтрация по скорости дорожки.<br/><br/>Рекомендуемое значение — диапазон скоростей (в битах в секунду). Пример: "0-2427000".<br/><br/>Примечание: можно использовать конкретное значение скорости, например 250000 (бит в секунду), но такой подход не рекомендуется, так как точная скорость может меняться от ресурса к ресурсу.|
|**FourCC**|Фильтрация по значению FourCC дорожки.<br/><br/>Это значение является первым элементом формата кодеков согласно стандарту [RFC 6381](https://tools.ietf.org/html/rfc6381). Сейчас поддерживаются перечисленные ниже кодеки. <br/>Для видео: "avc1", "hev1", "hvc1"<br/>Для звука: "mp4a", "ec-3"<br/><br/>Чтобы определить значения FourCC для дорожек в ресурсе, получите и проверьте файл манифеста.|
|**Язык**|Фильтрация по языку дорожки.<br/><br/>Это значение представляет собой тег языка, который требуется включить, как указано в стандарте RFC 5646. Например, en.|
|**Название**|Фильтрация по имени дорожки.|
|**Тип**|Фильтрация по типу дорожки.<br/><br/>Допускаются следующие значения: "video", "audio" и "text".|

### <a name="example"></a>Пример

В следующем примере определяется фильтр динамической потоковой передачи: 

```json
{
  "properties": {
    "presentationTimeRange": {
      "startTimestamp": 0,
      "endTimestamp": 170000000,
      "presentationWindowDuration": 9223372036854776000,
      "liveBackoffDuration": 0,
      "timescale": 10000000,
      "forceEndTimestamp": false
    },
    "firstQuality": {
      "bitrate": 128000
    },
    "tracks": [
      {
        "trackSelections": [
          {
            "property": "Type",
            "operation": "Equal",
            "value": "Audio"
          },
          {
            "property": "Language",
            "operation": "NotEqual",
            "value": "en"
          },
          {
            "property": "FourCC",
            "operation": "NotEqual",
            "value": "EC-3"
          }
        ]
      },
      {
        "trackSelections": [
          {
            "property": "Type",
            "operation": "Equal",
            "value": "Video"
          },
          {
            "property": "Bitrate",
            "operation": "Equal",
            "value": "3000000-5000000"
          }
        ]
      }
    ]
  }
}
```

## <a name="associating-filters-with-streaming-locator"></a>Связывание фильтров с указателем потоковой передачи

Вы можете указать список [фильтров активов или учетных записей](filters-concept.md) для [указателя потоковой передачи](https://docs.microsoft.com/rest/api/media/streaminglocators/create#request-body). [Динамический упаковщик](dynamic-packaging-overview.md) применяет этот список фильтров вместе с тем, что ваш клиент указывает в URL-адресе. Это сочетание создает [динамический манифест](filters-dynamic-manifest-overview.md), основанный на фильтрах в URL-адресах и фильтрах, указанных в указателе потоковой передачи. 

См. следующие примеры.

* [Связывание фильтров с помощью указателя потоковой передачи — .NET](filters-dynamic-manifest-dotnet-howto.md#associate-filters-with-streaming-locator)
* [Связывание фильтров с помощью указателя потоковой передачи — CLI](filters-dynamic-manifest-cli-howto.md#associate-filters-with-streaming-locator)

## <a name="updating-filters"></a>Обновление фильтров
 
Невозможно обновить **указатели потоковой передачи** , пока фильтры могут быть обновлены. 

Не рекомендуется обновлять определения фильтров, связанных с активным указателем на публикацию **потоковой передачи**, особенно если включена сеть CDN. Серверы потоковой передачи и CDN могут иметь внутренние кэши, которые могут привести к возврату устаревших кэшированных данных. 

Если необходимо изменить определение фильтра, попробуйте создать новый фильтр и добавить его в URL-адрес **указателя потоковой передачи** или опубликовать новый **указатель потоковой передачи** , ссылающийся на фильтр напрямую.

## <a name="next-steps"></a>Дальнейшие действия

В указанных ниже статьях показано, как создавать фильтры программным способом.  

- [Create filters with REST APIs](filters-dynamic-manifest-rest-howto.md) (Создание фильтров с помощью интерфейсов REST API)
- [Создание фильтров с помощью .NET](filters-dynamic-manifest-dotnet-howto.md)
- [Create filters with CLI](filters-dynamic-manifest-cli-howto.md) (Создание фильтров с помощью .NET)

