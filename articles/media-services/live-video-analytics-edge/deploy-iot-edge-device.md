---
title: Развертывание Live Video Analytics на IoT Edge устройстве в Azure
description: В этой статье перечислены действия, которые помогут вам развернуть службу Live Video Analytics на устройстве IoT Edge. Это можно сделать, например, при наличии доступа к локальной виртуальной машине Linux и (или) ранее созданной учетной записи служб мультимедиа Azure.
ms.topic: how-to
ms.date: 04/27/2020
ms.openlocfilehash: eaaa793bb5b84ac4ae352f242215b8d3e7d56cf1
ms.sourcegitcommit: 0100d26b1cac3e55016724c30d59408ee052a9ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/07/2020
ms.locfileid: "86026973"
---
# <a name="deploy-live-video-analytics-on-an-iot-edge-device"></a>Развертывание Live Video Analytics на устройстве IoT Edge

В этой статье перечислены действия, которые помогут вам развернуть службу Live Video Analytics на устройстве IoT Edge. Это можно сделать, например, при наличии доступа к локальной виртуальной машине Linux и (или) ранее созданной учетной записи служб мультимедиа Azure.


## <a name="prerequisites"></a>Предварительные условия

* Компьютер Linux, который соответствует ограничениям HW/SW для службы Live Video Analytics
* Подписка Azure, к которой у вас есть [права владельца](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#owner)
* [Создание и настройка центра Интернета вещей](https://docs.microsoft.com/azure/iot-hub/iot-hub-create-through-portal)
* [Регистрация IoT Edge устройства](https://docs.microsoft.com/azure/iot-edge/how-to-register-device)
* [Установка среды выполнения Azure IoT Edge в системах Linux на основе Debian](https://docs.microsoft.com/azure/iot-edge/how-to-install-iot-edge-linux)
* [Создание учетной записи служб мультимедиа Azure](../latest/create-account-howto.md)
    * Используйте один из следующих регионов: Восточная часть США 2, Центральная часть США, северо-центральная часть США, Восточная Япония, Западная часть США 2, Западная Центральная часть США, Восточная Канада, южная часть Соединенного Королевства, Центральная Франция, Южная французская, Северная Швейцария, Западная Швейцария и Западная Япония.
    * Рекомендуется использовать учетные записи хранения общего назначения v2 (GPv2).

## <a name="configuring-azure-resources-for-using-live-video-analytics"></a>Настройка ресурсов Azure для использования функции Live Video Analytics

### <a name="create-custom-azure-resource-manager-role"></a>Создание пользовательской роли Azure Resource Manager

Ознакомьтесь со статьей [Создание настраиваемой роли Azure Resource Manager](create-custom-azure-resource-manager-role-how-to.md) и назначение ее субъекту-службе для использования функции Live Video Analytics.

### <a name="set-up-a-premium-streaming-endpoint"></a>Настройка конечной точки потоковой передачи Premium

Если вы планируете использовать службу Live Video Analytics для записи видео в облако, а затем воспроизводите ее снова, то вам следует обновить службы мультимедиа для использования [конечной точки потоковой передачи](../latest/streaming-endpoint-concept.md#types)уровня "Премиум".  

Этот параметр является необязательным. Для этого можно использовать следующую команду Azure CLI:

```azure-cli
az ams streaming-endpoint scale --resource-group $RESOURCE_GROUP --account-name $AMS_ACCOUNT -n default --scale-units 1
```

Эту команду можно использовать для запуска конечной точки потоковой передачи. 

> [!IMPORTANT]
> На этом этапе будет взиматься плата за подписку.

```azure-cli
az ams streaming-endpoint start --resource-group $RESOURCE_GROUP --account-name $AMS_ACCOUNT -n default --no-wait
```

Выполните действия, описанные в этой статье, чтобы получить учетные данные для доступа к API службы мультимедиа: [доступ к API-интерфейсам службы мультимедиа](../latest/access-api-howto.md#use-the-azure-portal).

## <a name="create-and-use-local-user-account-for-deployment"></a>Создание и использование учетной записи локального пользователя для развертывания
Чтобы запустить динамическую аналитику видео в модуле IoT Edge, создайте локальную учетную запись пользователя с минимально возможным числом привилегий. В качестве примера выполните следующие команды на компьютере Linux:

```
sudo groupadd -g 1010 localuser
sudo adduser --home /home/edgeuser --uid 1010 -gid 1010 edgeuser
```

## <a name="granting-permissions-to-device-storage"></a>Предоставление разрешений для хранилища устройств

Теперь, когда вы создали локальную учетную запись пользователя, 

* Для хранения данных конфигурации приложения потребуется локальная папка. Создайте папку и предоставьте разрешения учетной записи LocalUser для записи в эту папку с помощью следующих команд:

```
sudo mkdir /var/lib/azuremediaservices
sudo chown -R edgeuser /var/lib/azuremediaservices
```

* Кроме того, потребуется папка для [записи видео в локальный файл](event-based-video-recording-concept.md#video-recording-based-on-events-from-other-sources). Используйте следующие команды, чтобы создать локальную папку для одного и того же элемента.

```
sudo mkdir /var/media
sudo chown -R edgeuser /var/media
```

## <a name="deploy-live-video-analytics-edge-module"></a>Развернуть модуль Live Video Analytics ребра

<!-- (To JuliaKo: this is similar to https://docs.microsoft.com/azure/iot-edge/how-to-deploy-blob)-->
Интерактивная аналитика видео на IoT Edge предоставляет свойства двойникаа модуля, описанные в [схеме конфигурации модуля двойника](module-twin-configuration-schema.md). 

### <a name="deploy-using-the-azure-portal"></a>Развертывание с помощью портала Azure

В портал Azure описывается создание манифеста развертывания и принудительная отправка развертывания на устройство IoT Edge.
Выбор устройства

1. Войдите на [портал Azure](https://ms.portal.azure.com/) и перейдите к своему Центру Интернета вещей.
1. В меню выберите **IoT Edge**.
1. Щелкните идентификатор целевого устройства в списке устройств.
1. Выберите **задать модули**.

#### <a name="configure-a-deployment-manifest"></a>Настройка манифеста развертывания

Манифест развертывания — это документ JSON, в котором определены развертываемые модули, способ передачи данных между этими модулями и требуемые свойства для двойников модулей. В портал Azure есть мастер, который поможет вам создать манифест развертывания. Он состоит из трех шагов, упорядоченных по вкладкам: **модули**, **маршруты**и **Проверка + создать**.

#### <a name="add-modules"></a>Добавление модулей

1. В разделе **IOT Edge модули** страницы щелкните раскрывающийся список **Добавить** и выберите пункт **IOT Edge** , чтобы открыть страницу **Добавление модуля IOT Edge** .
1. На вкладке **Параметры модуля** укажите имя модуля, а затем укажите URI образа контейнера:   
    Примеры:
    
    * **Имя модуля IOT Edge**: лваедже
    * **URI изображения**: MCR.Microsoft.com/Media/Live-Video-Analytics:1.0    
    
    ![Add](./media/deploy-iot-edge-device/add.png)
    
    > [!TIP]
    > Не выбирайте **Добавить** , пока вы не зауказали значения на вкладках **Параметры модуля**, **Параметры создания контейнера**и **Параметры модуля двойника** , как описано в этой процедуре.
    
    > [!IMPORTANT]
    > Azure IoT Edge учитывает регистр при вызове модулей. Запишите точную строку, используемую в качестве имени модуля.

1. Откройте вкладку **переменные среды** .
   
   Скопируйте и вставьте следующий код JSON в поле, чтобы указать идентификатор пользователя и идентификатор группы, которые будут использоваться для сохранения данных приложения и выходов видео.
    ```   
   {
        "LOCAL_USER_ID": 
        {
            "value": "1010"
        },
        "LOCAL_GROUP_ID": {
            "value": "1010"
        }
    }
     ``` 

1. Откройте вкладку **Параметры создания контейнера** .

    ![Параметры создания контейнера](./media/deploy-iot-edge-device/container-create-options.png)
 
    Скопируйте и вставьте следующий код JSON в поле, чтобы ограничить размер файлов журнала, создаваемых модулем.
    
    ```    
    {
        "HostConfig": {
            "LogConfig": {
                "Type": "",
                "Config": {
                    "max-size": "10m",
                    "max-file": "10"
                }
            },
            "Binds": [
               "/var/lib/azuremediaservices:/var/lib/azuremediaservices",
               "/var/media:/var/media"
            ]
        }
    }
    ````
   
   Раздел "привязки" в JSON содержит 2 записи:
   1. "/Вар/либ/азуремедиасервицес:/Вар/либ/азуремедиасервицес": используется для привязки постоянных данных конфигурации приложения из контейнера и сохранения их на пограничном устройстве.
   1. "/Вар/медиа:/Вар/медиа": выполняет привязку папок мультимедиа между граничным устройством и контейнером. Используется для хранения видеозаписей при запуске топологии Media Graph, поддерживающей хранение видеороликов на пограничном устройстве.
   
1. На вкладке **двойника Settings (параметры модуля** ) Скопируйте следующий код JSON и вставьте его в поле.
 
    ![Параметры двойника](./media/deploy-iot-edge-device/twin-settings.png)

    Для выполнения функции "интерактивная аналитика видео" на IoT Edge требуется набор обязательных свойств двойника, как указано в [схеме конфигурации модуля двойника](module-twin-configuration-schema.md).  

    Формат JSON, который необходимо ввести в поле ввода параметров двойника модуля, будет выглядеть следующим образом:    
    ```
    {
        "applicationDataDirectory": "/var/lib/azuremediaservices",
        "azureMediaServicesArmId": "/subscriptions/{subscriptionID}/resourceGroups/{resourceGroupName}/providers/microsoft.media/mediaservices/{AMS-account-name}",
        "aadTenantId": "{the-ID-of-your-tenant}",
        "aadServicePrincipalAppId": "{the-ID-of-the-service-principal-app-for-ams-account}",
        "aadServicePrincipalSecret": "{secret}"
    }
    ```
    Это **обязательные** свойства и для приведенного выше JSON.  
    * {subscriptionID} — это идентификатор подписки Azure.
    * {resourceGroupName} — эта группа ресурсов, к которой принадлежит ваша учетная запись службы мультимедиа
    * {AMS-Account-Name} — это имя учетной записи служб мультимедиа.
    
    Чтобы получить другие значения, см. статью [доступ к API служб мультимедиа Azure](../latest/access-api-howto.md#use-the-azure-portal).  
    * Aadtenantid и — это идентификатор клиента, который совпадает с "Aadtenantid и" из приведенной выше ссылки.
    * АадсервицепринЦипалаппид — идентификатор приложения субъекта-службы для учетной записи службы мультимедиа, который совпадает с "Аадклиентид" из приведенной выше ссылки.
    * АадсервицепринЦипалсекрет — это пароль субъекта-службы, который совпадает с "Аадсекрет" из приведенной выше ссылки.

    Ниже приведены некоторые дополнительные **Рекомендуемые** свойства, которые можно добавить в JSON и которые помогут в наблюдении за модулем. Дополнительные сведения см. в разделе [мониторинг и ведение журнала](monitoring-logging.md).
    
    ```
    "diagnosticsEventsOutputName": "lvaEdgeDiagnostics",
    "OperationalEventsOutputName": "lvaEdgeOperational",
    "logLevel": "Information",
    "logCategories": "Application,Events"
    ```
    
    Ниже приведены некоторые **необязательные** свойства, которые можно добавить в JSON:
    
    ```
    "aadEndpoint": "https://login.microsoftonline.com",
    "aadResourceId": "https://management.core.windows.net/",
    "armEndpoint": "https://management.azure.com/",
    "allowUnsecuredEndpoints": true
    ```
   [!Note]
   Для целей учебников и кратких руководств свойство двойника **алловунсекуредендпоинтс** имеет значение true.   
   При работе в рабочей среде этому свойству следует присвоить **значение false** . Это гарантирует, что приложение будет блокировать все незащищенные конечные точки и для запуска топологий графа потребуются допустимые учетные данные подключения.  
   
    Нажмите кнопку Добавить, чтобы добавить свойства модуля двойника.
1. Нажмите кнопку **Далее: Маршруты** , чтобы перейти к разделу маршруты.
    Укажите маршруты.

Сохранить маршруты по умолчанию и нажать кнопку **Далее: Проверка + создать** , чтобы перейти к разделу "Проверка".

#### <a name="review-deployment"></a>Проверка развертывания

В разделе обзорной информации вы увидите манифест развертывания в формате JSON, который был создан на основе параметров, выбранных вами в двух предыдущих разделах. Также есть два объявленных модуля, которые не были добавлены: $edgeAgent и $edgeHub. Эти два модуля составляют среду выполнения IoT Edge и являются обязательными для каждого развертывания.

Просмотрите сведения о развертывании и нажмите кнопку Создать.

### <a name="verify-your-deployment"></a>Проверка развертывания

После создания развертывания вы вернетесь на страницу IoT Edge центра Интернета вещей.

1.  Выберите устройство IoT Edge, на которое отправили развертывание, чтобы открыть сведения о нем.
2.  В сведениях об устройстве убедитесь, что для модуля службы хранилища BLOB-объектов настроены параметры **Указано в развертывании и Данные, полученные от устройства**.

Запуск модуля на устройстве может занять несколько секунд. Затем информация о нем передается в Центр Интернета вещей. Обновите страницу, чтобы увидеть обновленное состояние.
Код состояния: 200 — ОК означает, что [Среда выполнения IOT Edge](https://docs.microsoft.com/azure/iot-edge/iot-edge-runtime) работоспособна и работает нормально.

![Состояние](./media/deploy-iot-edge-device/status.png)

#### <a name="invoke-a-direct-method"></a>Вызов прямого метода

Затем можно протестировать пример, вызвав прямой метод. Ознакомьтесь с [прямыми методами для функции Live Video Analytics на IOT Edge](direct-methods.md) , чтобы понять все прямые методы, предоставляемые нашим модулем лваедже.

1. Щелкнув созданный модуль, вы перейдете на страницу настройки.  

    ![Модули](./media/deploy-iot-edge-device/modules.png)
1. Выберите пункт меню прямой метод.

    > [!NOTE] 
    > Необходимо добавить значение в разделы строки подключения, как видно на текущей странице. Не нужно скрывать или изменять содержимое раздела **имя параметра** . Это хорошо, чтобы сделать его общедоступным.

    ![Прямой метод](./media/deploy-iot-edge-device/module-details.png)
1. Затем введите "Графтопологилист" в поле имя метода.
1. Затем скопируйте и вставьте приведенные ниже полезные данные JSON в поле полезные данные.
    
    ```
    {
        "@apiVersion" : "1.0"
    }
    ```
1. Щелкните параметр "вызвать метод" в верхней части страницы.

    ![Прямые методы](./media/deploy-iot-edge-device/direct-method.png)
1. В поле результатов должно отобразиться сообщение Status (состояние 200).

    ![Сообщение о состоянии 200](./media/deploy-iot-edge-device/connection-timeout.png) 

## <a name="next-steps"></a>Дальнейшие шаги

[Краткое руководство. Начало работы. Общие сведения об Аналитике видеотрансляции в IoT Edge](get-started-detect-motion-emit-events-quickstart.md)
