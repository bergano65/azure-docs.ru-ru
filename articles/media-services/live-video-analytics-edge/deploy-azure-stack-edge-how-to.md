---
title: Развертывание Аналитики видеотрансляций в Azure Stack Edge
description: В этой статье перечислены действия, которые помогут вам развернуть Live Video Analytics на Azure Stack пограничных устройствах.
ms.topic: how-to
ms.date: 09/09/2020
ms.openlocfilehash: f33b6fb0f0dc5c5b733a0fcb021e2792ce9c6ec6
ms.sourcegitcommit: 2c586a0fbec6968205f3dc2af20e89e01f1b74b5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/14/2020
ms.locfileid: "92019602"
---
# <a name="deploy-live-video-analytics-on-azure-stack-edge"></a>Развертывание Аналитики видеотрансляций в Azure Stack Edge

В этой статье перечислены действия, которые помогут вам развернуть Live Video Analytics на Azure Stack пограничных устройствах. После настройки и активации устройства оно будет готово к развертыванию Live Video Analytics. 

Для службы Live Video Analytics мы выполним развертывание с помощью центра Интернета вещей, но Azure Stackные ресурсы предоставляют доступ к API-интерфейсу Kubernetes, который позволяет клиенту развертывать дополнительные решения, не связанные с центром Интернета вещей, которые могут взаимодействовать с помощью функции Live Video Analytics. 

> [!TIP]
> Использование API Kubernetes (K8s) для пользовательского развертывания — это расширенный вариант. Рекомендуется создавать пограничные модули и развертывать их с помощью центра Интернета вещей для каждого Azure Stackного ресурса, а не API Kubernetes. В этой статье мы покажем вам, как развернуть модуль Live Video Analytics с помощью центра Интернета вещей.

## <a name="prerequisites"></a>Предварительные условия

* Подписка Azure, к которой у вас есть [права владельца](../../role-based-access-control/built-in-roles.md#owner).
* Ресурс [пограничной Azure Stack](../../databox-online/azure-stack-edge-gpu-deploy-prep.md)
   
* [Центр Интернета вещей](../../iot-hub/iot-hub-create-through-portal.md)
* [Субъект-служба](./create-custom-azure-resource-manager-role-how-to.md#create-service-principal) для модуля Live Video Analytics.

   Используйте один из этих регионов, где доступен центр Интернета вещей: Восточная часть США 2, Центральная часть США, Северо-центральный регион США, Восточная Япония, Западная часть США 2, Западная Центральная часть США, Восточная Канада, южная часть Соединенного Королевства, Центральная Франция, Южная французская, Северная Швейцария, Западная Швейцария и Западная Япония.
* Учетная запись хранения

    Рекомендуется использовать учетные записи хранения общего назначения v2 (GPv2).  
    Дополнительные сведения о [учетной записи хранения общего назначения версии 2](../../storage/common/storage-account-upgrade.md?tabs=azure-portal).
* [Visual Studio Code](https://code.visualstudio.com/) на компьютере для разработки. Убедитесь, что у вас есть [расширение Azure IoT Tools](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-tools).
* Убедитесь, что в сети, к которой подключен компьютер разработки, разрешен расширенный протокол управления очередью сообщений через порт 5671. Эта настройка позволяет Azure IoT Tools взаимодействовать с Центром Интернета вещей Azure.

## <a name="configuring-azure-stack-edge-for-using-live-video-analytics"></a>Настройка Azure Stackного периметра для использования функции Live Video Analytics

Azure Stack ребро — это решение "оборудование как услуга" и "пограничные вычислительные устройства с поддержкой искусственного интеллекта" с возможностями перемещения данных сети. Дополнительные сведения о [Azure Stack и подробных инструкциях по настройке см](../../databox-online/azure-stack-edge-deploy-prep.md). в этой статье. Чтобы приступить к работе, следуйте инструкциям по ссылкам ниже:

* [Azure Stack создания ресурсов ребра или Шлюз Data Box](../../databox-online/azure-stack-edge-deploy-prep.md)
* [Установка и настройка](../../databox-online/azure-stack-edge-deploy-install.md)
* [Подключение и активация](../../databox-online/azure-stack-edge-deploy-connect-setup-activate.md)

### <a name="attach-an-iot-hub-to-azure-stack-edge"></a>Подключение центра Интернета вещей к Azure Stack границе

1. В [портал Azure](https://ms.portal.azure.com)перейдите к ресурсу Azure Stackного периметра и щелкните Обзор. В области справа на плитке Вычисления щелкните Начало работы.

    > [!div class="mx-imgBorder"]
    > :::image type="content" source="./media/deploy-azure-stack-edge-how-to/azure-stack-edge.png" alt-text="Azure Stack Edge&quot;:::
1. На плитке Настройка вычислений Edge щелкните Настройка вычислений.
1. В колонке Настройка вычислений Edge введите следующие значения:
    
    | Поле|Значение|
    |---|---|
    |Центр Интернета вещей|Выберите Новый или Существующий.<br/>По умолчанию для создания ресурса Интернета вещей используется уровень служб &quot;Стандартный" (S1). Чтобы использовать ресурс Интернета вещей уровня служб "Бесплатный", создайте его и выберите существующий ресурс.<br/>В каждом случае ресурс центра Интернета вещей использует одну и ту же подписку и группу ресурсов, которые используют ресурс Azure Stackного периметра.|
    |Имя|Введите имя ресурса Центра Интернета вещей.|

    > [!div class="mx-imgBorder"]
    > :::image type="content" source="./media/deploy-azure-stack-edge-how-to/azure-stack-edge-get-started.png" alt-text="Azure Stack Edge&quot;:::
1. На плитке Настройка вычислений Edge щелкните Настройка вычислений.
1. В колонке Настройка вычислений Edge введите следующие значения:
    
    | Поле|Значение|
    |---|---|
    |Центр Интернета вещей|Выберите Новый или Существующий.<br/>По умолчанию для создания ресурса Интернета вещей используется уровень служб &quot;Стандартный":::
1. Нажмите кнопку **создания**. Для создания ресурса Центра Интернета вещей нужно несколько минут. После этого на плитке **Настройка вычислений** появляется конфигурация вычислений. Чтобы подтвердить настройку роли вычислений Edge, на плитке **Настройка вычислений** щелкните **Просмотреть вычисления**.

    > [!div class="mx-imgBorder"]
    > :::image type="content" source="./media/deploy-azure-stack-edge-how-to/edge-compute-config.png" alt-text="Azure Stack Edge&quot;:::
1. На плитке Настройка вычислений Edge щелкните Настройка вычислений.
1. В колонке Настройка вычислений Edge введите следующие значения:
    
    | Поле|Значение|
    |---|---|
    |Центр Интернета вещей|Выберите Новый или Существующий.<br/>По умолчанию для создания ресурса Интернета вещей используется уровень служб &quot;Стандартный":::

    > [!NOTE]
    > Если диалоговое окно Настройка вычислений закрыто до того, как центр Интернета вещей будет связан с ресурсом Azure Stack погранично, центр Интернета вещей будет создан, но не показан в конфигурации вычислений. Перезагрузите страницу через несколько минут и отобразите ее.
    
    При настройке роли вычислений Edge на устройстве Edge создается два устройства — устройство Интернета вещей и устройство IoT Edge. Оба устройства можно просмотреть в ресурсе Центра Интернета вещей. На устройстве IoT Edge также работает среда выполнения IoT Edge. На данный момент доступна только платформа Linux для устройства IoT Edge.
    
    Когда вся информация будет заполнена, вы увидите карту configure ребра COMPUTE Card примерно так:
    
    > [!div class="mx-imgBorder"]
    > :::image type="content" source="./media/deploy-azure-stack-edge-how-to/configure-edge-compute.png" alt-text="Azure Stack Edge&quot;:::
1. На плитке Настройка вычислений Edge щелкните Настройка вычислений.
1. В колонке Настройка вычислений Edge введите следующие значения:
    
    | Поле|Значение|
    |---|---|
    |Центр Интернета вещей|Выберите Новый или Существующий.<br/>По умолчанию для создания ресурса Интернета вещей используется уровень служб &quot;Стандартный":::
 
### <a name="enable-compute-prerequisites-on-the-azure-stack-edge-local-ui"></a>Включение необходимых компонентов для вычислений на Azure Stack пограничном локальном пользовательском интерфейсе

Прежде чем продолжить, убедитесь в том, что:

* Вы активировали ресурс Azure Stackного периметра.
* У вас есть доступ к клиентской системе Windows, на которой выполняется PowerShell 5,0 или более поздней версии, для доступа к ресурсу Azure Stack ребра.
* Чтобы развернуть кластер Kubernetes, необходимо настроить ресурс Azure Stack ребра с помощью [локального веб-интерфейса](../../databox-online/azure-stack-edge-deploy-connect-setup-activate.md#connect-to-the-local-web-ui-setup). 
    
    * Чтобы включить вычисление, в локальном веб-ИНТЕРФЕЙСе устройства перейдите на страницу вычислений.
    
        * Выберите сетевой интерфейс, который требуется включить для вычислений. Выберите "Включить". Включение вычислений приведет к созданию виртуального коммутатора на устройстве в этом сетевом интерфейсе.
        * Оставьте IP-адреса узла тестирования Kubernetes и IP-адреса внешних служб Kubernetes пустыми.
        * Выберите Apply (Применить). Эта операция займет около 2 минут.
        
        > [!div class="mx-imgBorder"]
        > :::image type="content" source="./media/deploy-azure-stack-edge-how-to/azure-stack-edge-commercial.png" alt-text="Azure Stack Edge&quot;:::
1. На плитке Настройка вычислений Edge щелкните Настройка вычислений.
1. В колонке Настройка вычислений Edge введите следующие значения:
    
    | Поле|Значение|
    |---|---|
    |Центр Интернета вещей|Выберите Новый или Существующий.<br/>По умолчанию для создания ресурса Интернета вещей используется уровень служб &quot;Стандартный"
            * Добавьте в файл имя устройства API Kubernetes и адрес узла. (Эти сведения можно найти на портале Azure Stack пограничных устройств в разделе устройства.)
            * Сохранить и закрыть

### <a name="deploy-live-video-analytics-edge-module-using-azure-portal"></a>Развертывание модуля Live Video Analytics ребра с помощью портал Azure

Для этого мы собираемся выполнить определенные действия из раздела Развертывание функции [Live Video Analytics через центр Интернета вещей](deploy-iot-edge-device.md).

1. Пропустите шаги по созданию пользователей и групп и перейдите к разделу [Развертывание модуля Live Video Analytics](deploy-iot-edge-device.md#deploy-live-video-analytics-edge-module) . Выполните действия, описанные здесь.
1. В параметрах создания контейнера не нужно задавать переменные среды. Поэтому пропустите этот шаг.
1. Откройте вкладку Параметры создания контейнера.

   * Скопируйте и вставьте следующий код JSON в поле, чтобы ограничить размер файлов журнала, создаваемых модулем.
    
      ```json
        "HostConfig": {
                    "LogConfig": {
                        "Type": "",
                        "Config": {
                        "max-size": "10m",
                        "max-file": "10"
                        }
                    },
                    "Binds": [
                        "/var/media/:/var/media/",
                        "/var/lib/azuremediaservices:/var/lib/azuremediaservices"
                    ]
                    }
      ```
    
      > [!NOTE]
      > При использовании протокола gRPC с переносом общей памяти используйте режим IPC сервера для доступа к общей памяти между решениями для интерактивной аналитики видео и вывода.
   
      ```json
          "HostConfig": {
                        "LogConfig": {
                            "Type": "",
                            "Config": {
                            "max-size": "10m",
                            "max-file": "10"`
                            }
                        },
                        "Binds": [
                            "/var/media/:/var/media/",
                            "/var/lib/azuremediaservices:/var/lib/azuremediaservices"
                        ],
                        "IpcMode": "host",
                        "ShmSize": 1536870912
                    }
      ```

      > [!NOTE]
      > Раздел "привязки" в JSON содержит 2 записи. Вы можете обновить привязки пограничных устройств, но убедитесь, что эти каталоги существуют.
    
    * "/Вар/либ/азуремедиасервицес:/Вар/либ/азуремедиасервицес": используется для привязки постоянных данных конфигурации приложения из контейнера и сохранения их на пограничном устройстве.
    * "/Вар/медиа:/Вар/медиа": выполняет привязку папок мультимедиа между граничным устройством и контейнером. Используется для хранения видеозаписей при запуске топологии Media Graph, поддерживающей хранение видеороликов на пограничном устройстве.
        
1. Продолжайте действия в документе и заполните параметры модуля двойника.
1. Нажмите кнопку **Далее**: маршруты, чтобы перейти к разделу маршруты. Укажите маршруты.

    Сохранить маршруты по умолчанию и нажать кнопку Далее: Проверка + создать, чтобы перейти к разделу "Проверка".
1. [Проверка и проверка развертывания](deploy-iot-edge-device.md#review-deployment)

#### <a name="optional-setup-docker-volume-mounts"></a>Используемых Настройка монтирования томов DOCKER

Если вы хотите просмотреть данные в рабочих каталогах, выполните следующие действия, чтобы настроить подключения томов DOCKER перед развертыванием. 

Эти действия охватывают создание пользователя шлюза и настройку общих папок для просмотра содержимого рабочего каталога Live Video Analytics и папки мультимедиа-аналитики в реальном времени.

> [!NOTE]
> Подключения BIND поддерживаются, но подключения томов позволяют просматривать данные и при необходимости удаленно копировать их. Можно использовать как BIND, так и подключения томов, но они не могут указывать на один и тот же путь к контейнеру.

1. Откройте портал Azure и перейдите к ресурсу Azure Stackного периметра.
1. Создайте **пользователя шлюза** , который имеет доступ к общим папкам.
    
    1. В левой области навигации щелкните **шлюз — >пользователей**.
    1. Щелкните **+ Добавить пользователя** , чтобы задать имя пользователя и пароль. (Рекомендуется: `lvauser` ).
    1. Щелкните **Добавить**.
    
1. Создайте **локальный общий ресурс** для сохраняемости в Live Video Analytics.

    1. Щелкните **шлюз — >общие папки**.
    1. Щелкните **+ Добавить общие ресурсы**.
    1. Задайте имя общего ресурса. (Рекомендуется: `lva` ).
    1. Используйте тип общего ресурса SMB.
    1. Убедитесь, что установлен флажок **общий доступ с помощью вычислений ребра** .
    1. Убедитесь, что установлен флажок **настроить в качестве пограничной локальной папки** .
    1. В области сведения о пользователе предоставьте доступ к общей папке пользователю, созданному недавно.
    1. Щелкните **создать**.
        
    > [!div class="mx-imgBorder"]
    > :::image type="content" source="./media/deploy-azure-stack-edge-how-to/local-share.png" alt-text="Azure Stack Edge&quot;:::
1. На плитке Настройка вычислений Edge щелкните Настройка вычислений.
1. В колонке Настройка вычислений Edge введите следующие значения:
    
    | Поле|Значение|
    |---|---|
    |Центр Интернета вещей|Выберите Новый или Существующий.<br/>По умолчанию для создания ресурса Интернета вещей используется уровень служб &quot;Стандартный":::
    
1. Создайте удаленный общий ресурс для хранилища синхронизации файлов.

    1. Сначала создайте учетную запись хранилища BLOB-объектов в том же регионе.
    1. Щелкните **шлюз — >общие папки**.
    1. Щелкните **+ Добавить общие ресурсы**.
    1. Задайте имя общего ресурса. (Рекомендуется: носитель).
    1. Используйте тип общего ресурса SMB.
    1. Убедитесь, что установлен флажок **общий доступ с помощью вычислений ребра** .
    1. Убедитесь, что **Настройка в качестве пограничной локальной папки** не выбрана.
    1. Выберите недавно созданную учетную запись хранения.
    1. Задайте имя контейнера.
    1. Задайте для типа хранилища блочный BLOB-объект.
    1. В области сведения о пользователе предоставьте доступ к общей папке пользователю, созданному недавно.
    1. Щелкните **создать**.    
    
    > [!div class="mx-imgBorder"]
    > :::image type="content" source="./media/deploy-azure-stack-edge-how-to/remote-share.png" alt-text="Azure Stack Edge&quot;:::
1. На плитке Настройка вычислений Edge щелкните Настройка вычислений.
1. В колонке Настройка вычислений Edge введите следующие значения:
    
    | Поле|Значение|
    |---|---|
    |Центр Интернета вещей|Выберите Новый или Существующий.<br/>По умолчанию для создания ресурса Интернета вещей используется уровень служб &quot;Стандартный"
            }]
        }
    }
    ```

### <a name="verify-that-the-module-is-running"></a>Убедитесь, что модуль выполняется

Последний шаг — убедиться, что модуль подключен и работает как ожидалось. Состояние выполнения модуля должно быть "Работает" для вашего устройства IoT Edge в ресурсе Центра Интернета вещей.

Чтобы убедиться, что модуль работает, выполните следующее:

1. В портал Azure вернуться к ресурсу Azure Stack ребра.
1. Выберите плитку модули. Откроется колонка Модули. В списке модулей найдите развернутый вами модуль. Для состояния среды выполнения модуля, который вы добавили, должно отображаться значение запущена.

    > [!div class="mx-imgBorder"]
    > :::image type="content" source="./media/deploy-azure-stack-edge-how-to/iot-edge-custom-module.png" alt-text="Azure Stack Edge&quot;:::
1. На плитке Настройка вычислений Edge щелкните Настройка вычислений.
1. В колонке Настройка вычислений Edge введите следующие значения:
    
    | Поле|Значение|
    |---|---|
    |Центр Интернета вещей|Выберите Новый или Существующий.<br/>По умолчанию для создания ресурса Интернета вещей используется уровень служб &quot;Стандартный":::

### <a name="configure-the-azure-iot-tools-extension"></a>Настройка расширения Azure IoT Tools

Выполните эти инструкции, чтобы подключиться к Центру Интернета вещей с помощью расширения Azure IoT Tools.

1. В Visual Studio Code выберите представление Обозреватель >. Или нажмите сочетание клавиш CTRL+SHIFT+E.
1. В левом нижнем углу вкладки Explorer выберите Центр Интернета вещей Azure.
1. Щелкните значок Дополнительные параметры, чтобы открыть контекстное меню. Затем выберите Установка строки подключения Центра Интернета вещей.
1. Когда появится поле ввода, введите строку подключения для Центра Интернета вещей. 

   * Чтобы получить строку подключения, перейдите в центр Интернета вещей в портал Azure и щелкните политики общего доступа в левой области навигации.
   * Щелкните iothubowner получить ключи общего доступа.
   * Скопируйте строку подключения — первичный ключ и вставьте ее в поле ввода в VSCode.

   Строка подключения будет выглядеть следующим образом:<br/>`HostName=xxx.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=xxx`
    
   Если подключение будет установлено, отобразится список пограничных устройств. Вы должны увидеть вашу Azure Stackную сторону. Теперь вы можете управлять устройствами IoT Edge и взаимодействовать с Центром Интернета вещей Azure с помощью контекстного меню. Чтобы просмотреть модули, развернутые на пограничном устройстве, на Azure Stack устройстве разверните узел модули.
    
## <a name="troubleshooting"></a>Диагностика

* Доступ к API Kubernetes (kubectl).

    * Следуйте инструкциям по настройке компьютера для доступа к [кластеру Kubernetes](https://review.docs.microsoft.com/azure/databox-online/azure-stack-edge-j-series-create-kubernetes-cluster?toc=%2Fazure%2Fdatabox-online%2Fazure-stack-edge-gpu%2Ftoc.json&bc=%2Fazure%2Fdatabox-online%2Fazure-stack-edge-gpu%2Fbreadcrumb%2Ftoc.json&branch=release-tzl#debug-kubernetes-issues).
    * Все развернутые модули IoT Edge используют `iotedge` пространство имен. Обязательно включите это при использовании kubectl.
* Журналы модулей

    `iotedge`Средство недоступно для получения журналов. Для просмотра журналов или канала в файл необходимо использовать [журналы kubectl](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#logs)  . Пример <br/>  `kubectl logs deployments/mediaedge -n iotedge --all-containers`
* Метрики Pod и node

    Используйте [kubectl Top](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#top)  , чтобы просмотреть метрики Pod и Node. (Эта функция будет доступна в следующем Azure Stack пограничном выпуске. >v2007)<br/>`kubectl top pods -n iotedge`
* Модульные сети для обнаружения модулей на Azure Stack погранично требуется, чтобы у модуля была Привязка порта узла в Креатеоптионс. Затем модуль будет адреснее `moduleName:hostport` .
    
    ```json
    "createOptions": {
        "HostConfig": {
            "PortBindings": {
                "8554/tcp": [ { "HostPort": "8554" } ]
            }
        }
    }
    ```
    
* Подключение тома

    Модуль не запускается, если контейнер пытается подключить том к существующему и непустому каталогу.
* Общая память

    Общая память на Azure Stack граничных ресурсах поддерживается для различных модулей Pod в любом пространстве имен с помощью узла IPC.
    Настройка общей памяти в модуле ребра для развертывания с помощью центра Интернета вещей.
    
    ```
    ...
    "createOptions": {
        "HostConfig": {
            "IpcMode": "host"
        }
    ...
        
    (Advanced) Configuring shared memory on a K8s Pod or Deployment manifest for deployment via K8s API.
    spec:
        ...
        template:
        spec:
            hostIPC: true
        ...
    ```
    
* Продвинут Совместное размещение Pod

    При использовании K8s для развертывания пользовательских решений для вывода, взаимодействующих с помощью функции Live Video Analytics через gRPC, необходимо обеспечить развертывание модулей Pod на тех же узлах, что и модули Live Video Analytics.

    * Вариант 1. Использование сходства узлов и встроенных меток узлов для совместного размещения.

    В настоящее время пользовательская конфигурация Нодеселектор не является параметром, так как пользователи не имеют доступа к установке меток на узлах. Однако в зависимости от топологии клиента и соглашений об именовании они могут использовать [встроенные Метки узлов](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#built-in-node-labels). Раздел Нодеаффинити, который ссылается на Azure Stack пограничных ресурсов с помощью функции Live Video Analytics, можно добавить в манифест модуля вывода для достижения совместного размещения.
    * Вариант 2. Использование сходства Pod для совместного размещения (рекомендуется).
Kubernetes поддерживает [сходство Pod](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity)  , что может запланировать модули питания на одном узле. Раздел Подаффинити, ссылающийся на модуль Live Video Analytics, можно добавить в манифест Pod для определения для достижения совместного размещения.

    ```json   
    // Example Live Video Analytics module deployment match labels
    selector:
      matchLabels:
        net.azure-devices.edge.deviceid: dev-ase-1-edge
        net.azure-devices.edge.module: mediaedge
    
    // Example Inference deployment manifest pod affinity
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: net.azure-devices.edge.module
                operator: In
                values:
                - mediaedge
            topologyKey: "kubernetes.io/hostname"
    ```

## <a name="next-steps"></a>Дальнейшие действия

С помощью модуля можно анализировать потоки видеотрансляции, вызывая его прямые методы. [Вызовите прямые методы](get-started-detect-motion-emit-events-quickstart.md#use-direct-method-calls) в модуле.