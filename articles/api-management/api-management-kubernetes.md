---
title: Использование службы управления API Azure с микрослужбами, развернутыми в службе Kubernetes Azure | Документация Майкрософт
description: В этой статье описываются варианты развертывания управления API с помощью AKS.
services: api-management
documentationcenter: ''
author: miaojiang
manager: cfowler
editor: ''
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.topic: article
ms.date: 12/14/2019
ms.author: apimpm
ms.openlocfilehash: f8c6fce5b22d67dd1022fbaac763ea5df3b0930f
ms.sourcegitcommit: 2ba6303e1ac24287762caea9cd1603848331dd7a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/15/2020
ms.locfileid: "97505381"
---
# <a name="use-azure-api-management-with-microservices-deployed-in-azure-kubernetes-service"></a>Использование службы управления API Azure с микрослужбами, развернутыми в службе Kubernetes Azure

Микрослужбы идеально подходят для создания API-интерфейсов. С помощью [службы Azure Kubernetes Service](https://azure.microsoft.com/services/kubernetes-service/) (AKS) можно быстро развернуть и использовать [архитектуру на основе микрослужб](/azure/architecture/guide/architecture-styles/microservices) в облаке. Затем можно использовать службу [управления API Azure](https://aka.ms/apimrocks) (API Management) для публикации микрослужб как интерфейсов API для внутреннего и внешнего потребления. В этой статье описываются варианты развертывания управления API с помощью AKS. В нем предполагается наличие базовых знаний о Kubernetes, управлении API и сети Azure. 

## <a name="background"></a>Историческая справка

При публикации микрослужб в качестве интерфейсов API для потребления может быть трудно управлять обменом данными между микрослужбами и клиентами, которые их используют. Существует множество перекрестных задач, таких как проверка подлинности, авторизация, регулирование, кэширование, преобразование и мониторинг. Эти проблемы являются допустимыми независимо от того, доступны ли микрослужбы внутренним или внешним клиентам. 

Шаблон [шлюза API](/dotnet/architecture/microservices/architect-microservice-container-applications/direct-client-to-microservice-communication-versus-the-api-gateway-pattern) предназначен для решения этих проблем. Шлюз API выступает в качестве передней дверцы микрослужб, отделяет клиентов от микрослужб, добавляет дополнительный уровень безопасности и сокращает сложность микрослужб за счет устранения проблем, связанных с обработкой перекрестных задач. 

[Управление API Azure](https://aka.ms/apimrocks) — это готовое решение для решения ваших потребностей вашего шлюза API. Вы можете быстро создать единообразный и современный шлюз для микрослужб и опубликовать их как интерфейсы API. В качестве решения для управления API в полном жизненном цикле также предоставляются дополнительные возможности, включая портал разработчика самообслуживания для обнаружения API, управления жизненным циклом API и аналитики API.

При совместном использовании AKS и управление API предоставляют платформу для развертывания, публикации, защиты, мониторинга и управления интерфейсами API на основе микрослужб. В этой статье мы рассмотрим несколько вариантов развертывания AKS в сочетании с управлением API. 

## <a name="kubernetes-services-and-apis"></a>Kubernetes Services и API

В кластере Kubernetes контейнеры развертываются в [обыкновенных](https://kubernetes.io/docs/concepts/workloads/pods/pod/), которые являются временными и имеют жизненный цикл. Когда рабочий узел выходит из строя, все модули, работающие на узле, теряются. Таким образом, IP-адрес Pod может изменяться в любое время. Мы не можем полагаться на него для взаимодействия с Pod. 

Чтобы решить эту проблему, Kubernetes представил концепцию [служб](https://kubernetes.io/docs/concepts/services-networking/service/). Служба Kubernetes — это уровень абстракции, который определяет группу логических модулей Pod и обеспечивает возможность внешнего трафика, балансировку нагрузки и обнаружение служб для этих модулей. 

Когда мы готовы опубликовать наши микрослужбы в качестве API-интерфейсов с помощью службы управления API, необходимо подумать о том, как сопоставлять наши службы в Kubernetes с API-интерфейсами в службе управления API. Правила набора отсутствуют. Это зависит от того, как вы разрабатываете и разделяете бизнес-возможности или домены на микрослужбы в начале. Например, если модули Pod за службой отвечают за все операции с заданным ресурсом (например, клиент), то служба может быть сопоставлена с одним API. Если операции с ресурсом разделены на несколько микрослужб (например, Плацеордер), то несколько служб могут быть логически объединены в один API в службе управления API (см. рисунок. 1). 

Сопоставления также могут развиваться. Так как служба управления API создает фасадной перед микрослужбами, она позволяет нам оптимизировать и изменить размер микрослужб в течение определенного времени. 

![Сопоставьте службы с API](./media/api-management-aks/service-api-mapping.png)

## <a name="deploy-api-management-in-front-of-aks"></a>Развертывание управления API перед AKS

Существует несколько вариантов развертывания управления API перед кластером AKS. 

Кластер AKS всегда развертывается в виртуальной сети, поэтому экземпляр управления API не требуется развертывать в виртуальную сеть. Если управление API не находится в виртуальной сети кластера, кластер AKS должен опубликовать общедоступные конечные точки для управления API для подключения к. В этом случае необходимо обеспечить безопасность подключения между управлением API и AKS. Другими словами, необходимо обеспечить доступ к кластеру только через Управление API. Давайте перейдем к параметрам. 

### <a name="option-1-expose-services-publicly"></a>Вариант 1. общедоступные службы

Службы в кластере AKS можно предоставлять в общедоступном виде, используя [типы служб](../aks/concepts-network.md) нодепорт, балансировщик или екстерналнаме. В этом случае доступ к службам предоставляется напрямую из Интернета. После развертывания службы управления API перед кластером необходимо убедиться, что весь входящий трафик проходит через Управление API, применяя проверку подлинности в микрослужбах. Например, управление API может включать маркер доступа в каждый запрос, сделанный в кластере. Каждая микрослужба отвечает за проверку маркера перед обработкой запроса. 


Это может быть самым простым способом развертывания службы управления API перед AKS, особенно если логика аутентификации уже реализована в микрослужбах. 

![Непосредственная публикация служб](./media/api-management-aks/direct.png)

Преимущества.
* Простота настройки на стороне управления API, так как ее не нужно внедрять в виртуальную сеть кластера.
* Отсутствие изменений на стороне AKS, если службы уже открыты в общедоступной части, а логика проверки подлинности уже существует в микрослужбах.

Недостатки.
* Потенциальная угроза безопасности из-за общедоступных конечных точек службы
* Нет точки с одним входом для входящего трафика кластера
* Усложняет микрослужбы с дублирующейся логикой проверки подлинности

### <a name="option-2-install-an-ingress-controller"></a>Вариант 2. Установка контроллера входящего трафика

Хотя вариант 1 может быть проще, он имеет значительные недостатки, как упоминалось выше. Если экземпляр управления API не находится в виртуальной сети кластера, взаимная проверка подлинности TLS (mTLS) является надежным способом обеспечения безопасности и доверенности трафика в обоих направлениях между экземпляром управления API и кластером AKS. 

Взаимная проверка подлинности TLS [поддерживается](./api-management-howto-mutual-certificates.md) службой управления API и может быть включена в Kubernetes путем [установки контроллера](../aks/ingress-own-tls.md) входящего трафика (рисунок. 3). В результате проверка подлинности будет выполняться в контроллере входящего трафика, который упрощает микрослужбы. Кроме того, можно добавить IP-адреса управления API в список разрешенных входных данных, чтобы обеспечить доступ к кластеру только для управления API.  

 
![Публикация через входной контроллер](./media/api-management-aks/ingress-controller.png)


Преимущества.
* Простота настройки на стороне управления API, так как ее не нужно внедрять в виртуальную сеть кластера, и функция mTLS изначально поддерживается.
* Централизует защиту входящего трафика кластера на уровне входного контроллера
* Уменьшение угроз безопасности за счет минимизации общедоступных конечных точек кластера

Недостатки.
* Повышает сложность конфигурации кластера из-за дополнительной работы по установке, настройке и обслуживанию входящего контроллера и управлению сертификатами, используемыми для mTLS.
* Угроза безопасности из-за общей видимости конечных точек контроллера входящих данных


При публикации API в Управлении API использование ключей подписки является самым простым способом защитить доступ к этим интерфейсам API. Разработчики, которым требуется использовать опубликованные API, должны включать действительный ключ подписки в HTTP-запросах при выполнении вызовов к этим API. Иначе все вызовы немедленно игнорируются шлюзом Управления API. Они не передаются в серверные службы.

Чтобы получить ключ подписки для доступа к API, нужна подписка. Подписка по сути является именованным контейнером для пары ключей подписки. Разработчики, которым требуется доступ к опубликованным API, могут получить подписки. Им не требуется согласие издателей API. Издатели API могут самостоятельно создавать подписки напрямую для пользователей API.

### <a name="option-3-deploy-apim-inside-the-cluster-vnet"></a>Вариант 3. Развертывание APIM в виртуальной сети кластера

В некоторых случаях клиенты с ограничениями на соблюдение нормативных требований или строгими требованиями к безопасности могут найти вариант 1 и 2 неприемлемые решения из-за общедоступных конечных точек. В других случаях кластер AKS и приложения, использующие микрослужбы, могут находиться в одной виртуальной сети, поэтому нет нужды предоставлять общедоступный кластер, так как весь трафик API останется в виртуальной сети. В этих сценариях можно развернуть управление API в виртуальной сети кластера. [Уровень управления API Premium](https://aka.ms/apimpricing) поддерживает развертывание виртуальной сети. 

Существует два режима [развертывания управления API в виртуальной сети](./api-management-using-with-vnet.md) (внешней и внутренней). 

Если потребители API не находятся в виртуальной сети кластера, следует использовать внешний режим (рисунок. 4). В этом режиме шлюз управления API внедряется в виртуальную сеть кластера, но доступен из общедоступного Интернета через внешнюю подсистему балансировки нагрузки. Это позволяет полностью скрыть кластер, не позволяя внешним клиентам использовать микрослужбы. Кроме того, можно использовать сетевые возможности Azure, такие как группы безопасности сети (NSG), чтобы ограничить сетевой трафик.

![Внешний режим виртуальной сети](./media/api-management-aks/vnet-external.png)

Если все потребители API находятся в виртуальной сети кластера, можно использовать внутренний режим (рисунок. 5). В этом режиме шлюз управления API внедряется в виртуальную сеть кластера и доступен только в пределах этой виртуальной сети с помощью внутренней подсистемы балансировки нагрузки. Нет способа подключиться к шлюзу управления API или кластеру AKS из общедоступного Интернета. 

![Внутренний режим виртуальной сети](./media/api-management-aks/vnet-internal.png)

 В обоих случаях кластер AKS не является видимым для общего доступа. По сравнению с вариантом 2, входной контроллер может не потребоваться. В зависимости от сценария и конфигурации проверка подлинности по-прежнему может потребоваться между управлением API и микрослужбами. Например, если сетка службы принята, она всегда требует взаимной проверки подлинности TLS. 

Преимущества.
* Наиболее безопасный вариант, так как у кластера AKS нет общедоступной конечной точки
* Упрощает настройку кластера, так как она не имеет общедоступной конечной точки
* Возможность скрыть управление API и AKS в виртуальной сети с помощью внутреннего режима
* Возможность управления сетевым трафиком с помощью сетевых возможностей Azure, таких как группы безопасности сети (NSG).

Недостатки.
* Повышает сложность развертывания и настройки управления API для работы в виртуальной сети.

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о [понятиях сети для приложений в AKS](../aks/concepts-network.md)
* Дополнительные сведения об [использовании управления API с виртуальными сетями](./api-management-using-with-vnet.md)
