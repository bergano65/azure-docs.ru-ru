---
title: Использование службы управления API Azure с внутренними виртуальными сетями
titleSuffix: Azure API Management
description: Узнайте, как установить и настроить управление API Azure для внутренней виртуальной сети
services: api-management
documentationcenter: ''
author: vladvino
manager: kjoshi
editor: ''
ms.assetid: dac28ccf-2550-45a5-89cf-192d87369bc3
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.topic: article
ms.date: 07/31/2019
ms.author: apimpm
ms.openlocfilehash: 0832c975ecb410b97a24c975f9fc0f4799120abd
ms.sourcegitcommit: 4b76c284eb3d2b81b103430371a10abb912a83f4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/01/2020
ms.locfileid: "93145520"
---
# <a name="using-azure-api-management-service-with-an-internal-virtual-network"></a>Использование службы управления API Azure совместно с внутренней виртуальной сетью
Служба управления API Azure в сочетании с виртуальными сетями Azure позволяет работать с интерфейсами API, которые недоступны из Интернета. Подключение можно создать с применением разных технологий VPN. Управление API можно развернуть в виртуальной сети в одном из двух основных режимов:
* Внешняя
* Внутренние

При развертывании службы управления API во внутреннем режиме виртуальной сети все конечные точки служб (прокси-шлюз, портал разработчика, прямое управление и Git) отображаются только в пределах виртуальной сети, к которой вы управляете доступом. Ни одна из конечных точек служб не регистрируется на общедоступных DNS-серверах.

> [!NOTE]
> Так как для конечных точек службы отсутствуют записи DNS, эти конечные точки будут недоступны, пока [Служба DNS не будет настроена](#apim-dns-configuration) для виртуальной сети.

Используя управление API во внутреннем режиме, вы можете реализовать следующие сценарии:

* предоставлять третьим лицам защищенный доступ к API, размещенным в частном центре обработки данных, с помощью VPN-подключений типа "сеть — сеть" или Azure ExpressRoute;
* создать гибридное облачное развертывание, предоставляя единый шлюз для облачных и локально размещенных API-интерфейсов;
* управлять API-интерфейсами, размещенными в нескольких географических расположениях, через одну общую конечную точку шлюза.

[!INCLUDE [premium-dev.md](../../includes/api-management-availability-premium-dev.md)]

## <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить действия, описанные в этой статье, необходимо следующее.

+ **Активная подписка Azure** .

    [!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

+ **Экземпляр Azure API Management.** Дополнительные сведения см. в статье о [создании экземпляра управления API Azure](get-started-create-service-instance.md).
+ При развертывании службы управления API в виртуальной сети используется [список портов](./api-management-using-with-vnet.md#required-ports) , которые необходимо открыть. 

## <a name="creating-an-api-management-in-an-internal-virtual-network"></a><a name="enable-vpn"> </a>Создание управления API во внутренней виртуальной сети
Служба управления API во внутренней виртуальной сети размещена за [внутренней подсистемой балансировки нагрузки (классическая модель)](/previous-versions/azure/load-balancer/load-balancer-get-started-ilb-classic-cloud). Это единственный доступный параметр, и его нельзя изменить.

### <a name="enable-a-virtual-network-connection-using-the-azure-portal"></a>Настройка подключения к виртуальной сети с помощью портала Azure

1. Перейдите к экземпляру управления API Azure на [портале Azure](https://portal.azure.com/).
2. Щелкните **Виртуальная сеть** .
3. Укажите, что развертывание экземпляра управления API выполняется внутри виртуальной сети.

    ![Меню для настройки управления API Azure во внутренней виртуальной сети][api-management-using-internal-vnet-menu]

4. Щелкните **Сохранить** .

После завершения развертывания вы должны увидеть **частный** виртуальный IP-адрес и **общедоступный** виртуальный IP-адрес службы управления API в колонке обзор. **Частный** виртуальный IP-адрес — это IP-адрес с балансировкой нагрузки в делегированной подсети управления API `gateway` , `portal` `management` к которой `scm` можно получить доступ конечные точки, и. **Общедоступный** виртуальный IP-адрес используется **только** для управления трафиком плоскости в `management` конечную точку через порт 3443 и может быть заблокирован в [ApiManagement][ServiceTags] сервицетаг.

![Панель мониторинга службы управления API, демонстрирующая настроенную внутреннюю виртуальную сеть][api-management-internal-vnet-dashboard]

> [!NOTE]
> Консоль тестирования, доступная на портале Azure, не будет работать для **внутренней** развернутой службы виртуальной сети, так как URL-адрес шлюза не зарегистрирован в общедоступной службе DNS. Вместо этого следует использовать консоль тестирования, доступную на **портале разработчика** .

### <a name="deploy-api-management-into-virtual-network"></a><a name="deploy-apim-internal-vnet"> </a>Развертывание управления API в виртуальной сети

[![Развертывание в Azure](../media/template-deployments/deploy-to-azure.svg)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F201-api-management-create-with-internal-vnet%2Fazuredeploy.json)

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Вы можете настроить подключение к виртуальной сети с помощью командлетов PowerShell.

* Создание службы управления API в виртуальной сети: используйте командлет [New-азапиманажемент](/powershell/module/az.apimanagement/new-azapimanagement) , чтобы создать службу управления API Azure в виртуальной сети и настроить ее для использования типа внутренней виртуальной сети.

* Обновление существующего развертывания службы управления API в виртуальной сети: используйте командлет [Update-азапиманажементрегион](/powershell/module/az.apimanagement/update-azapimanagementregion) , чтобы переместить существующую службу управления API в виртуальную сеть и настроить ее для использования типа внутренней виртуальной сети.

## <a name="dns-configuration"></a><a name="apim-dns-configuration"></a>Настройка DNS
Если управление API настроено во внешнем режиме виртуальной сети, службой DNS управляет Azure. Чтобы использовать внутренний режим виртуальной сети, управлять DNS вы должны самостоятельно.

> [!NOTE]
> Служба управления API не прослушивает запросы, поступающие на IP-адреса. Она реагирует только на запросы к имени узла, которое настроено на конечных точках службы. К ним относятся шлюз, портал Azure и портал разработчика, конечная точка прямого управления и репозиторий Git.

### <a name="access-on-default-host-names"></a>Доступ по именам узлов по умолчанию
Например, при создании службы управления API с именем "контосоинтерналвнет" следующие конечные точки службы настраиваются по умолчанию:

   * Шлюз или прокси-сервер: contosointernalvnet.azure-api.net

   * Портал разработчика: contosointernalvnet.portal.azure-api.net

   * Новый портал разработчика: contosointernalvnet.developer.azure-api.net

   * Конечная точка прямого управления: contosointernalvnet.management.azure-api.net

   * Git: contosointernalvnet.scm.azure-api.net

Чтобы получить доступ к этим конечным точкам службы управления API, можно создать виртуальную машину в подсети, подключенной к виртуальной сети, в которой развернута служба управления API. При условии, что внутренний виртуальный IP-адрес для вашей службы — 10.1.0.5, можно отобразить файл hosts,%Системдриве%\дриверс\етк\хостс следующим образом:

   * 10.1.0.5 contosointernalvnet.azure-api.net

   * 10.1.0.5 contosointernalvnet.portal.azure-api.net

   * 10.1.0.5 contosointernalvnet.developer.azure-api.net

   * 10.1.0.5 contosointernalvnet.management.azure-api.net

   * 10.1.0.5 contosointernalvnet.scm.azure-api.net

Теперь вы сможете обращаться с этой виртуальной машины к любой из конечных точек службы.
Если в вашей в виртуальной сети действует пользовательский DNS-сервер, вы можете создать на нем записи DNS типа A. Тогда доступ к конечным точкам будет возможен из любого расположения в пределах виртуальной сети.

### <a name="access-on-custom-domain-names"></a>Доступ по пользовательским доменным именам

1. Если для обращения к службе управления API вы не хотите использовать имена узлов по умолчанию, для всех конечных точек службы можно настроить пользовательские доменные имена, как указано ниже:

   ![Настройка пользовательского домена для управления API][api-management-custom-domain-name]

2. После этого создайте на DNS-сервере записи типа A для обращения к конечным точкам, которые будут доступны только в пределах виртуальной сети.

## <a name="routing"></a><a name="routing"> </a> Маршрутизация

* *Частный* виртуальный IP-адрес с балансировкой нагрузки из диапазона подсети будет зарезервирован и использоваться для доступа к конечным точкам службы управления API из виртуальной сети. Этот *частный* IP-адрес можно найти в колонке "Обзор" для службы в портал Azure. Этот адрес должен быть зарегистрирован на DNS-серверах, используемых виртуальной сетью.
* *Общедоступный* IP-адрес с балансировкой нагрузки также будет зарезервирован для предоставления доступа к конечной точке службы управления через порт 3443. Этот *общедоступный* IP-адрес можно найти в колонке "Обзор" для службы в портал Azure. *Общедоступный* IP-адрес используется только для управления трафиком плоскости в `management` конечную точку через порт 3443 и может быть заблокирован в [ApiManagement][ServiceTags] сервицетаг.
* IP-адреса из диапазона IP-адресов подсети (DIP) будут назначены каждой виртуальной машине в службе и будут использоваться для доступа к ресурсам в виртуальной сети. Для доступа к ресурсам за пределами виртуальной сети будет использоваться общедоступный IP-адрес (VIP). Если списки ограничений IP-адресов используются для защиты ресурсов в виртуальной сети, необходимо указать весь диапазон для подсети, в которой развернута служба управления API, чтобы предоставить или ограничить доступ к службе.
* Общедоступные и частные IP-адреса с балансировкой нагрузки можно найти в колонке "Обзор" в портал Azure.
* IP-адреса, назначенные для общедоступного и закрытого доступа, могут измениться, если служба удаляется из, а затем снова добавляется в виртуальную сеть. В этом случае может потребоваться обновить DNS-регистрации, правила маршрутизации и списки ограничений IP-адресов в виртуальной сети.

## <a name="related-content"></a><a name="related-content"> </a>См. также
Дополнительные сведения см. в следующих статьях:
* [Распространенные проблемы конфигурации сети][Common network configuration problems] при настройке управления API Azure с виртуальными сетями
* [Виртуальная сеть Azure: часто задаваемые вопросы](../virtual-network/virtual-networks-faq.md)
* Инструкции по [созданию записей DNS типа A](/previous-versions/windows/it-pro/windows-2000-server/bb727018(v=technet.10))

[api-management-using-internal-vnet-menu]: ./media/api-management-using-with-internal-vnet/api-management-using-with-internal-vnet.png
[api-management-internal-vnet-dashboard]: ./media/api-management-using-with-internal-vnet/api-management-internal-vnet-dashboard.png
[api-management-custom-domain-name]: ./media/api-management-using-with-internal-vnet/api-management-custom-domain-name.png

[Create API Management service]: get-started-create-service-instance.md
[Common network configuration problems]: api-management-using-with-vnet.md#network-configuration-issues

[ServiceTags]: ../virtual-network/network-security-groups-overview.md#service-tags