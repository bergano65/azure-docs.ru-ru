---
title: Создание контейнера профилей Фслогикс службы файлов Azure домен Active Directory Services — Azure
description: В этой статье описывается создание контейнера профиля Фслогикс с помощью службы файлов Azure и доменных служб Azure Active Directory.
author: Heidilohr
ms.topic: how-to
ms.date: 04/10/2020
ms.author: helohr
manager: lizross
ms.openlocfilehash: 70a56b7efc34ba2fd3c06521c6e4cac6ea28778f
ms.sourcegitcommit: ab94795f9b8443eef47abae5bc6848bb9d8d8d01
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/27/2020
ms.locfileid: "96302477"
---
# <a name="create-a-profile-container-with-azure-files-and-azure-ad-ds"></a>Создание контейнера профиля с помощью службы файлов Azure и Azure AD DS

В этой статье показано, как создать контейнер профиля Фслогикс с помощью службы файлов Azure и Azure Active Directory доменных служб (AD DS).

## <a name="prerequisites"></a>Предварительные требования

В этой статье предполагается, что вы уже настроили экземпляр AD DS Azure. Если у вас еще нет, выполните инструкции в разделе [Создание базового управляемого домена](../active-directory-domain-services/tutorial-create-instance.md) , а затем вернитесь сюда.

## <a name="add-azure-ad-ds-admins"></a>Добавление администраторов AD DS Azure

Чтобы добавить дополнительных администраторов, создайте нового пользователя и предоставьте ему разрешения.

Чтобы добавить администратора, сделайте следующее:

1. Выберите **Azure Active Directory** на боковой панели, затем выберите **все пользователи**, а затем щелкните **Новый пользователь**.

2.  Введите сведения о пользователе в поля.

3. В области Azure Active Directory в левой части экрана выберите **группы**.

4. Выберите группу **администраторов контроллера домена AAD** .

5. В левой области выберите **элементы**, а затем на главной панели выберите **Добавить элементы** . Отобразится список всех пользователей, доступных в Azure AD. Выберите имя только что созданного профиля пользователя.

## <a name="set-up-an-azure-storage-account"></a>Настройка учетной записи хранения Azure

Теперь настало время включить проверку подлинности Azure AD DS через блок сообщений сервера (SMB).

Включение проверки подлинности:

1. Если вы еще не сделали этого, настройте и разверните учетную запись хранения Azure общего назначения версии 2, следуя инструкциям в статье [Создание учетной записи хранения Azure](../storage/common/storage-account-create.md).

2. Завершив настройку учетной записи, выберите **Переход к ресурсу**.

3. Выберите **конфигурацию** на панели в левой части экрана, а затем включите **проверку подлинности Azure Active Directory для файлов Azure** в главной области. Когда все будет готово, нажмите кнопку **Сохранить**.

4. Выберите **Обзор** на панели в левой части экрана, а затем выберите **файлы** в главной области.

5. Выберите **Общая папка** и введите **имя** и **квоту** в поля, отображаемые в правой части экрана.

## <a name="assign-access-permissions-to-an-identity"></a>Назначение разрешений на доступ для удостоверения

Другим пользователям потребуются разрешения на доступ к общей папке. Для этого необходимо назначить каждому пользователю роль с соответствующими разрешениями на доступ.

Чтобы назначить пользователей разрешения доступа:

1. В портал Azure откройте общую папку, созданную в окне [Настройка учетной записи хранения Azure](#set-up-an-azure-storage-account).

2. Выберите **Управление доступом (IAM)** .

3. Выберите **добавить назначение ролей**.

4. На вкладке **Добавление назначения ролей** выберите соответствующую встроенную роль из списка роль. Чтобы учетная запись имела необходимые разрешения, необходимо по крайней мере выбрать **файл хранилища хранилище данных для ресурса SMB** .

5. Для **назначения доступа** выберите **Azure Active Directory пользователя, группы или субъекта-службы**.

6. Выберите имя или адрес электронной почты для удостоверения целевой Azure Active Directory.

7. Щелкните **Сохранить**.

## <a name="get-the-storage-account-access-key"></a>Получение ключа доступа к учетной записи хранения

Затем необходимо получить ключ доступа для вашей учетной записи хранения.

Чтобы получить ключ доступа к учетной записи хранения, сделайте следующее:

1. На боковой панели портал Azure выберите **учетные записи хранения**.

2. В списке учетных записей хранения выберите учетную запись, для которой вы включили Azure AD DS и создали пользовательские роли, как описано выше.

3. В разделе **Параметры** выберите **ключи доступа** и скопируйте ключ из **Key1**.

4. Перейдите на вкладку **виртуальные машины** и найдите любую виртуальную машину, которая станет частью пула узлов.

5. Выберите имя виртуальной машины (ВМ) в разделе **виртуальные машины (адвм)** и нажмите кнопку **подключить** .

    Будет загружен RDP-файл, который позволит войти на виртуальную машину с собственными учетными данными.

    > [!div class="mx-imgBorder"]
    > ![Снимок экрана вкладки RDP окна Подключение к виртуальной машине.](media/rdp-tab.png)

6. Войдя на виртуальную машину, запустите командную строку от имени администратора.

7. Выполните следующую команду:

     ```cmd
     net use <desired-drive-letter>: \\<storage-account-name>.file.core.windows.net\<share-name> /user:Azure\<storage-account-name> <storage-account-key>
     ```

    - Замените на `<desired-drive-letter>` нужное имя диска (например, `y:` ).
    - Замените все экземпляры `<storage-account-name>` именем учетной записи хранения, указанной ранее.
    - Замените `<share-name>` именем созданной ранее общей папки.
    - Замените `<storage-account-key>` ключом учетной записи хранения из Azure.

    Пример:

     ```cmd
     net use y: \\fsprofile.file.core.windows.net\share HDZQRoFP2BBmoYQ=(truncated)= /user:Azure\fsprofile)
     ```

8. Выполните следующие команды, чтобы разрешить пользователям виртуальных рабочих столов Windows создавать собственные контейнеры профилей, блокируя доступ к контейнерам профилей других пользователей.

     ```cmd
     icacls <mounted-drive-letter>: /grant <user-email>:(M)
     icacls <mounted-drive-letter>: /grant "Creator Owner":(OI)(CI)(IO)(M)
     icacls <mounted-drive-letter>: /remove "Authenticated Users"
     icacls <mounted-drive-letter>: /remove "Builtin\Users"
     ```

    - Замените `<mounted-drive-letter>` буквой диска, который использовался для подключения накопителя.
    - Замените `<user-email>` именем участника-пользователя или группы Active Directory, которая содержит пользователей, которым потребуется доступ к общей папке.

    Пример:

     ```cmd
     icacls <mounted-drive-letter>: /grant john.doe@contoso.com:(M)
     icacls <mounted-drive-letter>: /grant "Creator Owner":(OI)(CI)(IO)(M)
     icacls <mounted-drive-letter>: /remove "Authenticated Users"
     icacls <mounted-drive-letter>: /remove "Builtin\Users"
     ```

## <a name="create-a-profile-container"></a>Создание контейнера профилей

Теперь, когда профили готовы к работе, создадим контейнер Фслогикс Profile.

Чтобы настроить контейнер профиля Фслогикс, выполните следующие действия.

1. Войдите на виртуальную машину узла сеансов, настроенную в начале этой статьи, а затем [скачайте и установите агент фслогикс](/fslogix/install-ht/).

2. Распакуйте скачанный файл агента фслогикс и перейдите к **x64**  >  **выпускам** x64, а затем откройте **FSLogixAppsSetup.exe**.

3. После запуска программы установки установите флажок **я принимаю условия лицензии.** Если применимо, укажите новый ключ.

4. Выберите пункт **Установить**.

5. Откройте **диск C**, а затем последовательно выберите **Program Files**  >  **фслогикс**  >  **Apps** (программы), чтобы убедиться, что агент фслогикс установлен правильно.

     >[!NOTE]
     > Если в пуле узлов есть несколько виртуальных машин, необходимо повторить шаги с 1 по 5 для каждой виртуальной машины.

6. Запустите **редактор реестра** (regedit) от имени администратора.

7. Перейдите к **компьютеру**  >  **HKEY_LOCAL_MACHINE**  >  **Software**  >  **фслогикс**, щелкните правой кнопкой мыши **фслогикс**, выберите **создать**, а затем выберите **раздел**.

8. Создайте новый ключ с именем **Profiles**.

9.  Щелкните правой кнопкой мыши элемент **Профили**, выберите пункт **создать**, а затем выберите **значение DWORD (32-bit).** Присвойте этому параметру имя **Enabled** и задайте значение **данных** **1**.

    > [!div class="mx-imgBorder"]
    > ![Снимок экрана ключа профилей. Файл REG_DWORD выделяется, и его значение данных устанавливается равным 1.](media/dword-value.png)

10. Щелкните правой кнопкой мыши элемент **Профили**, выберите **создать**, а затем выберите **многострочное значение**. Назовите значение **вхдлокатионс** и задайте введите URI для общего ресурса службы файлов Azure в `\\fsprofile.file.core.windows.net\share` качестве значения данных.

    > [!div class="mx-imgBorder"]
    > ![Снимок экрана с ключом Profiles, отображающим файл Вхдлокатионс. Его значение данных показывает универсальный код ресурса (URI) для общего ресурса службы файлов Azure.](media/multi-string-value.png)

## <a name="assign-users-to-a-session-host"></a>Назначение пользователей узлу сеансов

Теперь необходимо назначить пользователей узлу сеансов.

Назначение пользователей:

1. Запустите Windows PowerShell от имени администратора, а затем выполните следующий командлет, чтобы войти в виртуальную Рабочий стол Windows с помощью PowerShell:

   ```powershell
   Import-Module Microsoft.RdInfra.RdPowershell

   #Optional
   Install-Module Microsoft.RdInfra.RdPowershell

   $brokerurl = "https://rdbroker.wvd.microsoft.com"

   Add-RdsAccount -DeploymentUrl $brokerurl
   ```

   При появлении запроса на ввод учетных данных введите того же пользователя, которому назначена роль Тенанткреатор, владелец RDS или участник RDS в клиенте виртуальных рабочих столов Windows.

2. Выполните следующие командлеты, чтобы назначить пользователя группе удаленных рабочих столов:

     ```powershell
     $tenant = "<your-wvd-tenant>"

     $pool1 = "<wvd-pool>"

     $appgroup = "Desktop Application Group"

     $user1 = "<user-principal>"

     Add-RdsAppGroupUser $tenant $pool1 $appgroup $user1
     ```

    Как и в предыдущих командлетах, обязательно замените `<your-wvd-tenant>` , `<wvd-pool>` и `<user-principal>` соответствующими значениями.

    Пример:

     ```powershell
     $pool1 = "contoso"

     $tenant = "contoso"

     $appgroup = "Desktop Application Group"

     $user1 = "jane.doe@contoso.com"

     Add-RdsAppGroupUser $tenant $pool1 $appgroup $user1
     ```

## <a name="make-sure-your-profile-works"></a>Убедитесь, что профиль работает

Теперь все, что нужно сделать, — это убедиться, что созданный профиль существует и работает должным образом.

Чтобы проверить профиль, выполните следующие действия.

1. Откройте браузер и перейдите к [веб-клиенту виртуальных рабочих столов Windows](https://rdweb.wvd.microsoft.com/arm/webclient).

2. Выполните вход, используя учетную запись пользователя, назначенную группе удаленный рабочий стол.

3. После установки пользовательского сеанса откройте портал Azure и войдите с помощью учетной записи администратора.

4. На боковой панели выберите **учетные записи хранения**.

5. Выберите учетную запись хранения, настроенную в качестве общей папки для пула узлов сеансов и включенную в Azure AD DS.

6. Выберите значок **файлы** , а затем разверните свой общий ресурс.

    Если все настроено правильно, вы увидите **Каталог** с именем, которое имеет следующий формат: `<user SID>-<username>` .

## <a name="next-steps"></a>Дальнейшие действия

Если вы ищете альтернативные способы создания контейнеров профилей Фслогикс, ознакомьтесь со следующими статьями:

- [Создайте контейнер профиля для пула узлов с помощью общей папки](create-host-pools-user-profile.md).
- [Создание контейнера профиля Фслогикс для пула узлов с помощью Azure NetApp Files](create-fslogix-profile-container.md)

Более подробные сведения о концепциях, связанных с контейнерами Фслогикс для службы файлов Azure, см. в разделе [контейнеры профилей фслогикс и файлы Azure](fslogix-containers-azure-files.md).
