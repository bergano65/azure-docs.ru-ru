---
title: Настройка плана аварийного восстановления виртуальных рабочих столов Windows в Azure
description: Как настроить план непрерывности бизнес-процессов и аварийного восстановления для развертывания виртуальных рабочих столов Windows.
services: virtual-desktop
author: Heidilohr
ms.service: virtual-desktop
ms.topic: how-to
ms.date: 10/09/2020
ms.author: helohr
manager: lizross
ms.openlocfilehash: 968f82a143872fd282222539ab71a70db488a20d
ms.sourcegitcommit: 50802bffd56155f3b01bfb4ed009b70045131750
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91935769"
---
# <a name="set-up-a-business-continuity-and-disaster-recovery-plan"></a>Настройка плана непрерывности бизнес-процессов и аварийного восстановления

Для обеспечения безопасности данных в Организации может потребоваться стратегия непрерывности бизнес-процессов и аварийного восстановления (BCDR). Стратегия BCDRа звука обеспечивает работу приложений и рабочих нагрузок во время плановых и незапланированных служб или простоев Azure.

Виртуальный рабочий стол Windows предлагает BCDR для службы виртуальных рабочих столов Windows, чтобы сохранить метаданные клиента во время простоя. При возникновении сбоя в регионе компоненты инфраструктуры службы будут отработки отказа в дополнительное расположение и продолжать работать в нормальном режиме. Вы по-прежнему можете получать доступ к связанным с службами метаданным, и пользователи по-прежнему могут подключаться к доступным узлам. Подключения пользователей будут оставаться в сети при условии, что среда клиента или узлы остаются доступными.

Чтобы пользователи по-прежнему могли подключаться во время сбоя региона, необходимо реплицировать виртуальные машины (ВМ) в другом расположении. Во время простоя первичный сайт переходит на реплицируемые виртуальные машины в дополнительном расположении. Пользователи могут продолжать получать доступ к приложениям из дополнительного расположения без перерывов. В верхней части репликации виртуальных машин необходимо будет иметь доступ к удостоверениям пользователей в дополнительном расположении. Если вы используете контейнеры профилей, их также необходимо реплицировать. Наконец, убедитесь, что бизнес-приложения, которые используют данные в основном расположении, могут выполнить отработку отказа с остальными данными.

Чтобы подвести итог, чтобы обеспечить подключение пользователей во время сбоя, необходимо выполнить следующие действия в следующем порядке:

- Репликация виртуальных машин в дополнительном расположении.
- Если вы используете контейнеры профилей, настройте репликацию данных в дополнительном расположении.
- Убедитесь, что удостоверения пользователей, настроенные в основном расположении, доступны во вторичном расположении.
- Убедитесь, что все бизнес-приложения, использующие данные в основном расположении, отправляются в дополнительное расположение.

## <a name="vm-replication"></a>Репликация виртуальной машины

Во-первых, необходимо реплицировать виртуальные машины в дополнительное расположение. Параметры для этого зависят от настройки виртуальных машин.

- Вы можете настроить все виртуальные машины как для пула, так и для личных пулов узлов с Azure Site Recovery. С помощью этого метода вам потребуется настроить только один пул узлов, а также связанные с ним группы приложений и рабочие области.
- Вы можете создать новый пул узлов в области отработки отказа, оставив все ресурсы в расположении отработки отказа отключенными. Для этого метода необходимо настроить новые группы приложений и рабочие области в регионе отработки отказа. Затем можно использовать план Azure Site Recovery для включения пулов узлов.
- Вы можете создать пул узлов, который заполняется виртуальными машинами, созданными как в основном, так и в регионах отработки отказа, сохраняя отключение виртуальных машин в регионе отработки отказа. В этом случае необходимо настроить только один пул узлов и связанные с ним группы приложений и рабочие области. Вы можете использовать план Azure Site Recovery, чтобы включить пулы узлов с помощью этого метода.

Мы рекомендуем использовать [Azure Site Recovery](../site-recovery/site-recovery-overview.md) для управления репликацией виртуальных машин в других расположениях Azure, как описано в статье [архитектура аварийного восстановления из Azure в Azure](../site-recovery/azure-to-azure-architecture.md). Особенно рекомендуется использовать Azure Site Recovery для пулов личных узлов, так как Azure Site Recovery поддерживает как [серверные, так и клиентские номера SKU](../site-recovery/azure-to-azure-support-matrix.md#replicated-machine-operating-systems).

Если вы используете Azure Site Recovery, вам не потребуется регистрировать эти виртуальные машины вручную. Агент виртуальных рабочих столов Windows на вторичной виртуальной машине автоматически будет использовать последний маркер безопасности для подключения к ближайшему к нему экземпляру службы. Виртуальная машина (узел сеанса) в дополнительном расположении будет автоматически становиться частью пула узлов. Конечному пользователю придется повторно подключаться во время процесса, но не выполнять никаких других действий вручную.

При наличии существующих пользовательских соединений во время сбоя, прежде чем администратор сможет запустить отработку отказа в дополнительный регион, необходимо завершить соединения пользователей в текущем регионе.

Чтобы отключить пользователей в виртуальном рабочем столе Windows (классическая модель), выполните следующий командлет:

```powershell
Invoke-RdsUserSessionLogoff
```

Чтобы отключить пользователей в версии виртуальных рабочих столов Windows, интегрированной с Azure, выполните следующий командлет:

```powershell
Remove-AzWvdUserSession
```

После выхода всех пользователей в основном регионе можно выполнить отработку отказа виртуальных машин в основном регионе и разрешить пользователям подключаться к виртуальным машинам в дополнительном регионе. Дополнительные сведения о работе этого процесса см. в статье [репликация виртуальных машин Azure в другой регион Azure](../site-recovery/azure-to-azure-how-to-enable-replication.md).

## <a name="virtual-network"></a>Виртуальная сеть

Затем рассмотрим сетевое подключение во время сбоя. Необходимо убедиться в том, что в дополнительном регионе настроена виртуальная сеть (VNET). Если пользователям требуется доступ к локальным ресурсам, необходимо настроить эту виртуальную сеть для доступа к ним. Вы можете устанавливать локальные подключения с помощью VPN, ExpressRoute или виртуальной глобальной сети.

Мы рекомендуем использовать Azure Site Recovery, чтобы настроить виртуальную сеть в регионе отработки отказа, так как она сохраняет параметры основной сети и не требует пиринга.

## <a name="user-identities"></a>Удостоверения пользователей

Затем убедитесь, что контроллер домена доступен в дополнительном расположении. 

Существует три способа сохранения доступа к контроллеру домена:

   - Наличие контроллера домен Active Directory в дополнительном расположении
   - Использование локального контроллера домен Active Directory
   - Репликация контроллера домен Active Directory с помощью [Azure Site Recovery](../site-recovery/site-recovery-active-directory.md)

## <a name="user-and-app-data"></a>Данные пользователя и приложения

Если вы используете контейнеры профилей, следующим шагом является настройка репликации данных в дополнительном расположении. Существует пять вариантов хранения профилей Фслогикс:

   - Локальные дисковые пространства (S2D)
   - Сетевые диски (виртуальная машина с дополнительными дисками)
   - Файлы Azure
   - Azure NetApp Files
   - Облачный кэш для репликации

Дополнительные сведения см. [в подокне параметры хранилища для контейнеров профилей фслогикс в виртуальном рабочем столе Windows](store-fslogix-profile.md).

Если вы настраиваете аварийное восстановление для профилей, вы можете настроить следующие параметры:

   - Настройте собственную репликацию Azure (например, репликация учетной записи хранения службы "Стандартный" файлов Azure, репликация Azure NetApp Files или синхронизация файлов Azure для файловых серверов).
    
     >[!NOTE]
     >Репликация NetApp выполняется автоматически после ее настройки. С помощью планов Azure Site Recovery можно добавить предварительные и посторонние скрипты для отработки отказа ресурсов, не связанных с виртуальной машиной, для репликации ресурсов службы хранилища Azure.

   - Настройка облачного кэша Фслогикс для данных приложения и пользователя.
   - Настройте аварийное восстановление только для данных приложений, чтобы обеспечить непрерывный доступ к критически важным бизнес-данным. С помощью этого метода можно получить данные пользователя после сбоя.

Давайте рассмотрим настройку Фслогикс для настройки аварийного восстановления для каждого из вариантов.

### <a name="fslogix-configuration"></a>Конфигурация Фслогикс

Агент Фслогикс может поддерживать несколько расположений профилей, если параметры реестра для Фслогикс настроены.

Чтобы настроить записи реестра, выполните следующие действия.

1. Откройте **редактор реестра**.
2. Перейдите в раздел **Computer**  >  **HKEY_LOCAL_MACHINE**  >  **Software**  >  **фслогикс**  >  **Profiles**.
   
     > [!div class="mx-imgBorder"]
     > ![Снимок экрана окна "Профили" в редакторе реестра. Выбран Вхдлокатион.](media/regedit-profiles.png)

3. Щелкните правой кнопкой мыши **вхдлокатионс** и выберите **изменить многострочный**.

     > [!div class="mx-imgBorder"]
     > ![Снимок экрана окна редактирования многострочных строк. В поле "значение" указаны расположения Центруал США и Восточная часть США.](media/multi-string-edit.png)

4. В поле **данных значения** введите расположения, которые вы хотите использовать.
5. Закончив, нажмите кнопку **OK**.

Если первое расположение недоступно, агент Фслогикс автоматически отменяет переход на второй и т. д.

Мы рекомендуем настроить агент Фслогикс с помощью пути к дополнительному расположению в основном регионе. После завершения работы основного расположения агент Флогикс будет реплицирован как часть виртуальной машины Azure Site Recovery репликации. Когда реплицированные виртуальные машины будут готовы, агент автоматически попытается выполнить путь к дополнительному региону.

Например, предположим, что виртуальные машины основного узла сеансов находятся в центральном регионе США, но контейнер профиля находится в центральном регионе США по соображениям производительности.

В этом случае вы настроите агент Фслогикс с помощью пути к хранилищу в центральной области США. Виртуальные машины узла сеансов можно настроить для репликации в западной части США. После сбоя пути к центральной части США агент попытается создать новый путь для хранилища в западной части США.

### <a name="s2d"></a>Другая

Так как S2D обрабатывает репликацию по регионам внутренне, вам не нужно вручную настраивать дополнительный путь.

### <a name="network-drives-vm-with-extra-drives"></a>Сетевые диски (виртуальная машина с дополнительными дисками)

Если вы реплицируете виртуальные машины сетевого хранилища, используя Azure Site Recovery, например виртуальные машины узла сеансов, то при восстановлении сохраняется тот же путь, что означает, что вам не нужно перенастраивать Фслогикс.

### <a name="azure-files"></a>Файлы Azure

Службы файлов Azure поддерживают асинхронную репликацию в разных регионах, которую можно указать при создании учетной записи хранения. Если асинхронная природа файлов Azure уже охватывает цели аварийного восстановления, вам не нужно выполнять дополнительную настройку.

Если требуется синхронная репликация для снижения потери данных, мы рекомендуем использовать вместо этого Фслогикс облачный кэш.

>[!NOTE]
>В этом разделе не рассматривается механизм проверки подлинности при отработке отказа для службы файлов Azure.

### <a name="azure-netapp-files"></a>Azure NetApp Files

Дополнительные сведения о Azure NetApp Files см. в статье [Создание пиринга репликации для Azure NetApp Files](../azure-netapp-files/cross-region-replication-create-peering.md).

## <a name="app-dependencies"></a>Зависимости приложения

Наконец, убедитесь, что все бизнес-приложения, использующие данные, расположенные в основном регионе, могут выполнить отработку отказа в дополнительное расположение. Кроме того, обязательно настройте параметры, необходимые приложениям для работы в новом расположении. Например, если одно из приложений зависит от серверной части SQL, обязательно выполните репликацию SQL в дополнительном расположении. Необходимо настроить приложение для использования дополнительного расположения в качестве части процесса отработки отказа или конфигурации по умолчанию. Зависимости приложений можно моделировать в планах Azure Site Recovery. Дополнительные сведения см. в статье [о планах восстановления](../site-recovery/recovery-plan-overview.md).

## <a name="disaster-recovery-testing"></a>Тестирование аварийного восстановления

После завершения настройки аварийного восстановления необходимо протестировать план, чтобы убедиться, что он работает.

Ниже приведены некоторые рекомендации по тестированию плана.

- Если тестовые виртуальные машины имеют доступ к Интернету, они будут использовать любой существующий узел сеансов для новых подключений, но все существующие подключения к исходному узлу сеансов останутся активными. Убедитесь, что администратор, выполняющий тест, выполнит выход всех активных пользователей перед тестированием плана. 
- Все тесты аварийного восстановления следует выполнять только в период обслуживания, чтобы не нарушать работу пользователей. Пул узлов можно также использовать в среде проверки для теста. 
- Убедитесь, что тест охватывает все критически важные для бизнеса приложения.
- В каждый момент времени рекомендуется выполнять отработку отказа до 100 виртуальных машин. Если у вас больше виртуальных машин, рекомендуется выполнить их отработку отказа в пакетном режиме через 10 минут.

## <a name="next-steps"></a>Дальнейшие шаги

Если у вас есть вопросы по обеспечению безопасности данных в дополнение к планированию простоев, ознакомьтесь с нашим [руководством по безопасности](security-guide.md).