---
title: Настройка GPU для Виртуального рабочего стола Windows в Azure
description: Сведения о включении отрисовки и кодирования с поддержкой ускорения за счет GPU на Виртуальном рабочем столе Windows.
author: gundarev
ms.topic: how-to
ms.date: 05/06/2019
ms.author: denisgun
ms.openlocfilehash: c3a23276ce19f6d7b4cf341bac155ec84363fe5f
ms.sourcegitcommit: 10d00006fec1f4b69289ce18fdd0452c3458eca5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/21/2020
ms.locfileid: "95018347"
---
# <a name="configure-graphics-processing-unit-gpu-acceleration-for-windows-virtual-desktop"></a>Настройка ускорения графического процессора (GPU) для Виртуального рабочего стола Windows

>[!IMPORTANT]
>Это содержимое применимо к Виртуальному рабочему столу Windows с объектами Azure Resource Manager для Виртуального рабочего стола Windows. Если вы используете Виртуальный рабочий стол Windows (классический) без объектов Azure Resource Manager, ознакомьтесь с [этой статьей](./virtual-desktop-fall-2019/configure-vm-gpu-2019.md).

Виртуальный рабочий стол Windows поддерживает отрисовку и кодирование с поддержкой ускорения за счет GPU для повышения уровня производительности и масштабируемости. Ускорение GPU особенно важно для приложений с большим объемом графики.

Выполнив инструкции, приведенные в этой статье, создайте оптимизированную для GPU виртуальную машину Azure, добавьте ее в свой пул узлов и настройте для использования ускорения GPU для отрисовки и кодирования. Предполагается, что у вас уже настроен клиент Виртуального рабочего стола Windows.

## <a name="select-an-appropriate-gpu-optimized-azure-virtual-machine-size"></a>Выберите подходящий размер виртуальной машины Azure, оптимизированный для GPU

Выберите один из размеров виртуальных машин Azure серии [NV](../virtual-machines/nv-series.md), серии [NVv3](../virtual-machines/nvv3-series.md)или [NVv4](../virtual-machines/nvv4-series.md) . Они предназначены для виртуализации приложений и настольных компьютеров и позволяют приложениям и пользовательскому интерфейсу Windows ускорить работу GPU. Правильный выбор для вашего пула узлов зависит от ряда факторов, включая рабочие нагрузки приложений, желаемое взаимодействие с пользователем и стоимость. Как правило, большие и более производительные GPU предлагают более удобный пользовательский интерфейс с заданной плотностью пользователей, а небольшие и дробные размеры GPU позволяют более точно контролировать стоимость и качество.

>[!NOTE]
>Виртуальные машины Azure NC, NCv2, NCv3, ND и NDv2, как правило, не подходят для узлов сеансов виртуальных рабочих столов Windows. Эти виртуальные машины адаптированы для специализированных, высокопроизводительных вычислений или средств машинного обучения, таких как созданные с помощью NVIDIA CUDA. Для общего ускорения приложений и рабочих столов с помощью видеопроцессоров NVIDIA требуется лицензирование NVIDIA GRID. Это обеспечивается Azure для рекомендуемых размеров виртуальных машин, но их необходимо отдельно упорядочить для виртуальных машин серии NC/ND.

## <a name="create-a-host-pool-provision-your-virtual-machine-and-configure-an-app-group"></a>Создание пула узлов, подготовка виртуальной машины и настройка группы приложений

Создайте новый пул узлов, используя виртуальную машину выбранного размера. Инструкции см. в [руководстве по созданию пула узлов на портале Azure](./create-host-pools-azure-marketplace.md).

Виртуальный рабочий стол Windows поддерживает отрисовку и кодирование с поддержкой ускорения за счет GPU в следующих операционных системах:

* Windows 10 версии 1511 или более поздней.
* Windows Server 2016 или поздней версии.

Кроме того, необходимо настроить группу приложений или использовать группу приложений рабочего стола по умолчанию (с именем Desktop Application Group), автоматически созданную во время создания нового пула узлов. Инструкции см. в [руководстве по управлению группами приложений для Виртуального рабочего стола Windows ](./manage-app-groups.md).

## <a name="install-supported-graphics-drivers-in-your-virtual-machine"></a>Установка поддерживаемых графических драйверов на виртуальной машине

Чтобы воспользоваться возможностями GPU виртуальных машин Azure серии N на Виртуальном рабочем столе Windows, необходимо установить соответствующие графические драйверы. Выполните инструкции, приведенные в [этом разделе](../virtual-machines/sizes-gpu.md#supported-operating-systems-and-drivers), чтобы установить драйверы от соответствующего поставщика графики вручную или с помощью расширения виртуальной машины Azure.

Для Виртуального рабочего стола Windows поддерживаются только драйверы, поставляемые Azure. Для виртуальных машин серии NV в Azure с графическими процессорами NVIDIA, только [драйверы сетки NVIDIA](../virtual-machines/windows/n-series-driver-setup.md#nvidia-grid-drivers), а не драйверы NVIDIA Tesla (CUDA) поддерживают ускорение GPU для приложений и настольных компьютеров общего назначения.

После установки драйвера необходимо выполнить перезагрузку виртуальной машины. Выполните инструкции по проверке, приведенные выше, чтобы убедиться в успешной установке графических драйверов.

## <a name="configure-gpu-accelerated-app-rendering"></a>Настройка отрисовки приложений с поддержкой ускорения за счет GPU

По умолчанию отрисовка приложений и рабочих столов, запущенных в многосеансовых конфигурациях, выполняется с помощью ЦП без использования доступных GPU. Настройте групповую политику для узла сеанса, чтобы включить отрисовку с поддержкой ускорения за счет GPU:

1. Подключитесь к рабочему столу виртуальной машины, используя учетную запись с правами локального администратора.
2. Откройте меню "Пуск" и введите gpedit.msc, чтобы открыть редактор групповой политики.
3. Перейдите по дереву к разделу **Конфигурация компьютера** > **Административные шаблоны** > **Компоненты Windows** > **Службы удаленных рабочих столов** > **Узел сеансов удаленных рабочих столов** > **Среда удаленных сеансов**.
4. Выберите политика **использовать аппаратные графические адаптеры для всех сеансов службы удаленных рабочих столов** и установите для этой политики значение **включено** , чтобы включить визуализацию GPU в удаленном сеансе.

## <a name="configure-gpu-accelerated-frame-encoding"></a>Настройка кодирования кадров с поддержкой ускорения за счет GPU

Удаленный рабочий стол кодирует всю графику в ходе отрисовки приложениями и рабочими столами (выполненной с помощью GPU или ЦП) для передачи клиентам удаленного рабочего стола. Когда часть экрана часто обновляется, эта часть экрана кодируется видеокодеком (H. 264/AVC). По умолчанию удаленный рабочий стол не использует доступные GPU для этого кодирования. Настройте групповую политику для узла сеанса, чтобы включить кодирование кадров с поддержкой ускорения за счет GPU. Продолжите выполнять указанные выше шаги:

>[!NOTE]
>Кодирование кадров с ускорением GPU недоступно на виртуальных машинах серии NVv4.

1. Выберите политику **Настройка кодировки оборудования H.264/AVC для подключений к удаленному рабочему столу** и задайте для нее значение **Включено**, чтобы включить кодирование оборудования для AVC/H.264 в удаленном сеансе.

    >[!NOTE]
    >В Windows Server 2016 задайте для параметра **Использовать кодировку AVC оборудования** значение **Всегда предпринимать попытки**.

2. Теперь, когда групповые политики изменены, принудительно обновите групповую политику. Откройте командную строку и введите:

    ```cmd
    gpupdate.exe /force
    ```

3. Завершите сеанс удаленного рабочего стола.

## <a name="configure-fullscreen-video-encoding"></a>Настройка кодирования видео в полноэкранном режиме

Если часто используются приложения, которые создают содержимое с высокой частотой кадров, например трехмерное моделирование, САПР, камеры и видеоприложения, можно включить полноэкранное кодирование видео для удаленного сеанса. Полноэкранный режим видеопрофиль обеспечивает более высокую частоту кадров и удобство работы пользователей для таких приложений с учетом пропускной способности сети и ресурсов узла сеанса и клиента. Рекомендуется использовать кодирование кадров с ускорением GPU для полноэкранного видео. Настройте групповая политика для узла сеансов, чтобы включить полноэкранное кодирование видео. Продолжите выполнять указанные выше шаги:

1. Выберите политику **Назначить приоритет графического режима H.264/AVC 444 для подключений к удаленному рабочему столу** и задайте для нее значение **Включено**, чтобы принудительно использовать кодек H.264/AVC 444 в удаленном сеансе.
2. Теперь, когда групповые политики изменены, принудительно обновите групповую политику. Откройте командную строку и введите:

    ```cmd
    gpupdate.exe /force
    ```

3. Завершите сеанс удаленного рабочего стола.
## <a name="verify-gpu-accelerated-app-rendering"></a>Проверка отрисовки приложений с поддержкой ускорения за счет GPU

Чтобы убедиться, что для отрисовки приложений используется GPU, попробуйте выполнить одно из следующих действий:

* Для виртуальных машин Azure с графическим процессором NVIDIA используйте `nvidia-smi` программу, как описано в разделе [Проверка установки драйвера](../virtual-machines/windows/n-series-driver-setup.md#verify-driver-installation) для проверки использования GPU при запуске приложений.
* В поддерживаемых версиях операционной системы проверить использование GPU можно с помощью диспетчера задач. Выберите GPU на вкладке "Производительность", чтобы узнать, используют ли его приложения.

## <a name="verify-gpu-accelerated-frame-encoding"></a>Проверка кодирования кадров с поддержкой ускорения за счет GPU

Чтобы убедиться, что удаленный рабочий стол использует кодирование с поддержкой ускорения за счет GPU, сделайте следующее:

1. Подключитесь к рабочему столу виртуальной машины с помощью клиента Виртуального рабочего стола Windows.
2. Запустите средство "Просмотр событий" и перейдите к следующему узлу: **Журналы приложений и служб** > **Майкрософт** > **Windows** > **RemoteDesktopServices-RdpCoreCDV** > **Работающий**
3. Чтобы определить, используется ли кодирование с поддержкой ускорения за счет GPU, найдите событие с идентификатором 170. Если отображается "Включен аппаратный кодировщик AVC: 1", значит используется кодирование GPU.

## <a name="verify-fullscreen-video-encoding"></a>Проверка кодирования видео в полноэкранном режиме

Чтобы убедиться, что удаленный рабочий стол использует видео в полноэкранном кодировке:

1. Подключитесь к рабочему столу виртуальной машины с помощью клиента Виртуального рабочего стола Windows.
2. Запустите средство "Просмотр событий" и перейдите к следующему узлу: **Журналы приложений и служб** > **Майкрософт** > **Windows** > **RemoteDesktopServices-RdpCoreCDV** > **Работающий**
3. Чтобы определить, используется ли видеокодирование в полноэкранном режиме, найдите событие с ИДЕНТИФИКАТОРом 162. Если отображается "Доступный AVC: 1. Начальный профиль: 2048", значит используется AVC 444.

## <a name="next-steps"></a>Дальнейшие действия

Выполнив приведенные в этой статье инструкции, вы настроили и запустили ускорение GPU на узле с одним сеансом (одной виртуальной машине). Дополнительные сведения о включении ускорения GPU в большем пуле узлов:

* Рекомендуется использовать [расширение виртуальной машины](../virtual-machines/extensions/overview.md) для упрощения установки и обновления драйверов на нескольких виртуальных машинах. Используйте [расширение драйвера GPU NVIDIA](../virtual-machines/extensions/hpccompute-gpu-windows.md) для виртуальных машин с GPU NVIDIA и [расширение драйвера GPU AMD](../virtual-machines/extensions/hpccompute-amd-gpu-windows.md) для виртуальных машин с GPU AMD.
* Рекомендуется использовать групповую политику Active Directory для упрощения настройки групповой политики на нескольких виртуальных машинах. Сведения о развертывании групповой политики в домене Active Directory см. на странице [Работа с объектами групповой политики](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc731212(v=ws.11)).