---
title: Настройка GPU для виртуальных рабочих столов Windows (классическая модель) — Azure
description: Как включить отрисовку и кодирование с помощью GPU с ускорением на виртуальных рабочих столах Windows (классическая модель).
author: gundarev
ms.topic: how-to
ms.date: 03/30/2020
ms.author: denisgun
ms.openlocfilehash: 32d5c280e80b2f21b30bb34a182070da51e21026
ms.sourcegitcommit: 98854e3bd1ab04ce42816cae1892ed0caeedf461
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "88008497"
---
# <a name="configure-graphics-processing-unit-gpu-acceleration-for-windows-virtual-desktop-classic"></a>Настройка ускорения графического процессора для виртуальных рабочих столов Windows (классическая модель)

>[!IMPORTANT]
>Это содержимое применимо к Виртуальному рабочему столу Windows (классическому), который не поддерживает объекты Azure Resource Manager для Виртуального рабочего стола Windows. Сведения об обеспечении управления объектами Azure Resource Manager для Виртуального рабочего стола Windows см. в [этой статье](../configure-vm-gpu.md).

Виртуальный рабочий стол Windows поддерживает отрисовку и кодирование с поддержкой ускорения за счет GPU для повышения уровня производительности и масштабируемости. Ускорение GPU особенно важно для приложений с большим объемом графики.

Выполнив инструкции, приведенные в этой статье, создайте оптимизированную для GPU виртуальную машину Azure, добавьте ее в свой пул узлов и настройте для использования ускорения GPU для отрисовки и кодирования. Предполагается, что у вас уже настроен клиент Виртуального рабочего стола Windows.

## <a name="select-a-gpu-optimized-azure-virtual-machine-size"></a>Выбор размера виртуальной машины Azure, оптимизированной для GPU

Azure предоставляет несколько [размеров виртуальных машин, оптимизированных для GPU](/azure/virtual-machines/windows/sizes-gpu). Правильный выбор для вашего пула узлов зависит от ряда факторов, включая рабочие нагрузки приложений, желаемое взаимодействие с пользователем и стоимость. В целом, более крупные и мощные GPU обеспечивают лучшее взаимодействие с пользователем при заданной плотности пользователей.

## <a name="create-a-host-pool-provision-your-virtual-machine-and-configure-an-app-group"></a>Создание пула узлов, подготовка виртуальной машины и настройка группы приложений

Создайте новый пул узлов, используя виртуальную машину выбранного размера. Инструкции см. в разделе [учебник. Создание пула узлов с помощью Azure Marketplace](/azure/virtual-desktop/create-host-pools-azure-marketplace).

Виртуальный рабочий стол Windows поддерживает отрисовку и кодирование с поддержкой ускорения за счет GPU в следующих операционных системах:

* Windows 10 версии 1511 или более поздней.
* Windows Server 2016 или поздней версии.

Кроме того, необходимо настроить группу приложений или использовать группу приложений рабочего стола по умолчанию (с именем Desktop Application Group), автоматически созданную во время создания нового пула узлов. Инструкции см. в [руководстве по управлению группами приложений для Виртуального рабочего стола Windows ](/azure/virtual-desktop/manage-app-groups).

## <a name="install-supported-graphics-drivers-in-your-virtual-machine"></a>Установка поддерживаемых графических драйверов на виртуальной машине

Чтобы воспользоваться возможностями GPU виртуальных машин Azure серии N на Виртуальном рабочем столе Windows, необходимо установить соответствующие графические драйверы. Выполните инструкции, приведенные в [этом разделе](/azure/virtual-machines/windows/sizes-gpu#supported-operating-systems-and-drivers), чтобы установить драйверы от соответствующего поставщика графики вручную или с помощью расширения виртуальной машины Azure.

Для Виртуального рабочего стола Windows поддерживаются только драйверы, поставляемые Azure. Дополнительно для виртуальных рабочих столов Windows поддерживаются только [драйверы сетки NVIDIA](/azure/virtual-machines/windows/n-series-driver-setup#nvidia-grid-drivers) для виртуальных машин Azure с графическими процессорами NVIDIA.

После установки драйвера необходимо выполнить перезагрузку виртуальной машины. Выполните инструкции по проверке, приведенные выше, чтобы убедиться в успешной установке графических драйверов.

## <a name="configure-gpu-accelerated-app-rendering"></a>Настройка отрисовки приложений с поддержкой ускорения за счет GPU

По умолчанию отрисовка приложений и рабочих столов, запущенных в многосеансовых конфигурациях, выполняется с помощью ЦП без использования доступных GPU. Настройте групповую политику для узла сеанса, чтобы включить отрисовку с поддержкой ускорения за счет GPU:

1. Подключитесь к рабочему столу виртуальной машины, используя учетную запись с правами локального администратора.
2. Откройте меню "Пуск" и введите gpedit.msc, чтобы открыть редактор групповой политики.
3. Перейдите по дереву к разделу **Конфигурация компьютера** > **Административные шаблоны** > **Компоненты Windows** > **Службы удаленных рабочих столов** > **Узел сеансов удаленных рабочих столов** > **Среда удаленных сеансов**.
4. Выберите политику **Для всех сеансов службы удаленных рабочих столов используйте аппаратный графический адаптер по умолчанию** и задайте для нее значение **Включено**, чтобы включить отрисовку с поддержкой ускорения за счет GPU в удаленном сеансе.

## <a name="configure-gpu-accelerated-frame-encoding"></a>Настройка кодирования кадров с поддержкой ускорения за счет GPU

Удаленный рабочий стол кодирует всю графику в ходе отрисовки приложениями и рабочими столами (выполненной с помощью GPU или ЦП) для передачи клиентам удаленного рабочего стола. По умолчанию удаленный рабочий стол не использует доступные GPU для этого кодирования. Настройте групповую политику для узла сеанса, чтобы включить кодирование кадров с поддержкой ускорения за счет GPU. Продолжите выполнять указанные выше шаги:

1. Выберите политику **Назначить приоритет графического режима H.264/AVC 444 для подключений к удаленному рабочему столу** и задайте для нее значение **Включено**, чтобы принудительно использовать кодек H.264/AVC 444 в удаленном сеансе.
2. Выберите политику **Настройка кодировки оборудования H.264/AVC для подключений к удаленному рабочему столу** и задайте для нее значение **Включено**, чтобы включить кодирование оборудования для AVC/H.264 в удаленном сеансе.

    >[!NOTE]
    >В Windows Server 2016 задайте для параметра **Использовать кодировку AVC оборудования** значение **Всегда предпринимать попытки**.

3. Теперь, когда групповые политики изменены, принудительно обновите групповую политику. Откройте командную строку и введите:

    ```batch
    gpupdate.exe /force
    ```

4. Завершите сеанс удаленного рабочего стола.

## <a name="verify-gpu-accelerated-app-rendering"></a>Проверка отрисовки приложений с поддержкой ускорения за счет GPU

Чтобы убедиться, что для отрисовки приложений используется GPU, попробуйте выполнить одно из следующих действий:

* Для виртуальных машин Azure с GPU NVIDIA используйте утилиту `nvidia-smi`, как описано в [этом разделе](/azure/virtual-machines/windows/n-series-driver-setup#verify-driver-installation), чтобы проверить использование GPU при запуске приложений.
* В поддерживаемых версиях операционной системы проверить использование GPU можно с помощью диспетчера задач. Выберите GPU на вкладке "Производительность", чтобы узнать, используют ли его приложения.

## <a name="verify-gpu-accelerated-frame-encoding"></a>Проверка кодирования кадров с поддержкой ускорения за счет GPU

Чтобы убедиться, что удаленный рабочий стол использует кодирование с поддержкой ускорения за счет GPU, сделайте следующее:

1. Подключитесь к рабочему столу виртуальной машины с помощью клиента Виртуального рабочего стола Windows.
2. Запустите средство "Просмотр событий" и перейдите к следующему узлу: **Журналы приложений и служб** > **Майкрософт** > **Windows** > **RemoteDesktopServices-RdpCoreCDV** > **Работающий**
3. Чтобы определить, используется ли кодирование с поддержкой ускорения за счет GPU, найдите событие с идентификатором 170. Если отображается "Включен аппаратный кодировщик AVC: 1", значит используется кодирование GPU.
4. Чтобы определить, используется ли режим AVC 444, найдите событие с идентификатором 162. Если отображается "Доступный AVC: 1. Начальный профиль: 2048", значит используется AVC 444.

## <a name="next-steps"></a>Дальнейшие действия

Выполнив приведенные в этой статье инструкции, вы настроили и запустили ускорение GPU на узле с одним сеансом (одной виртуальной машине). Дополнительные сведения о включении ускорения GPU в большем пуле узлов:

* Рекомендуется использовать [расширение виртуальной машины](/azure/virtual-machines/extensions/overview) для упрощения установки и обновления драйверов на нескольких виртуальных машинах. Используйте [расширение драйвера GPU NVIDIA](/azure/virtual-machines/extensions/hpccompute-gpu-windows) для виртуальных машин с GPU NVIDIA и расширение драйвера GPU AMD для виртуальных машин с GPU AMD.
* Рекомендуется использовать групповую политику Active Directory для упрощения настройки групповой политики на нескольких виртуальных машинах. Сведения о развертывании групповой политики в домене Active Directory см. на странице [Работа с объектами групповой политики](https://go.microsoft.com/fwlink/p/?LinkId=620889).