---
title: Диагностика проблем с помощью Виртуального рабочего стола Windows — Azure
description: Узнайте, как использовать возможности диагностики в Виртуальном рабочем столе Windows для диагностики проблем.
services: virtual-desktop
author: Heidilohr
ms.service: virtual-desktop
ms.topic: conceptual
ms.date: 05/13/2020
ms.author: helohr
manager: lizross
ms.openlocfilehash: 5d4fb87ae5edd4919923e66336760aadf23d1888
ms.sourcegitcommit: fdec8e8bdbddcce5b7a0c4ffc6842154220c8b90
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/19/2020
ms.locfileid: "83657250"
---
# <a name="identify-and-diagnose-issues"></a>Выявление и диагностика неполадок

>[!IMPORTANT]
>Это содержимое применимо к выпуску за осень 2019 года, который не поддерживает объекты Azure Resource Manager для Виртуального рабочего стола Windows. Если вы хотите обеспечить управление объектами Azure Resource Manager для Виртуального рабочего стола Windows, представленными в обновлении за весну 2020 г., см. [эту статью](../diagnostics-role-service.md).

Виртуальный рабочий стол Windows включает функцию диагностики, которая позволяет администратору выявлять разные проблемы через единый интерфейс. Роли Виртуального рабочего стола Windows записывают диагностические действия в журнал при каждом взаимодействии пользователя с системой. Каждый журнал содержит важную информацию, например об участвующих в транзакции ролях Виртуального рабочего стола Windows, ошибках, арендаторе и пользователе. Диагностические действия создаются действиями пользователей и администраторов, и разбиваются на три основных группы:

* Действия подписки на веб-канал. Такие действия создаются, когда пользователь пытается подключиться к каналу через приложения Удаленного рабочего стола (Майкрософт).
* Действия подключения. Такие действия создаются, когда пользователь пытается подключиться к рабочему столу или удаленному приложению RemoteApp через приложения Удаленного рабочего стола (Майкрософт).
* Действия управления. Такие действия создаются, когда администратор выполняет в системе операции управления, например создание пулов узлов, назначение пользователей в группы приложений или создание назначений ролей.
  
Подключения, которые не достигают Виртуального рабочего стола Windows, не отображаются в результатах диагностики, так как служба роли диагностики является частью Виртуального рабочего стола Windows. Проблемы с подключением к Виртуальному рабочему столу Windows могут возникнуть, когда пользователь испытывает проблемы с сетевым подключением.

Сначала [скачайте и импортируйте модуль PowerShell для Виртуального рабочего стола Windows](/powershell/windows-virtual-desktop/overview/), если вы еще этого не сделали, так как он потребуется для сеанса PowerShell. После этого выполните следующий командлет, чтобы войти в учетную запись:

```powershell
Add-RdsAccount -DeploymentUrl "https://rdbroker.wvd.microsoft.com"
```

## <a name="diagnose-issues-with-powershell"></a>Диагностика проблем с помощью PowerShell

Диагностика Виртуального рабочего стола Windows использует только один командлет PowerShell, но он принимает много необязательных параметров,которые позволяют ограничить область поиска и изолировать проблемы. В следующих разделах перечислены командлеты, которые можно выполнять для диагностики проблем. Большинство фильтров можно применять одновременно. Значения, перечисленные в квадратных скобках, например `<tenantName>`, следует заменить конкретными значениями для вашей среды.

>[!IMPORTANT]
>Функция диагностики используется для устранения неполадок, возникающих при работе одного пользователя. Все запросы, использующие PowerShell, должны содержать параметр *-UserName* или *-ActivityID*. Для мониторинга используйте Log Analytics. Дополнительные сведения о том, как отправить диагностические данные в рабочую область, см. в статье [Использование Log Analytics для функции диагностики](diagnostics-log-analytics-2019.md). 

### <a name="filter-diagnostic-activities-by-user"></a>Фильтрация диагностических действий по пользователю

Параметр **-UserName** возвращает список диагностических действий, инициированных указанным пользователем, как в следующем примере командлета.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -UserName <UserUPN>
```

Параметр **-UserName** можно сочетать с другими необязательными параметрами фильтрации.

### <a name="filter-diagnostic-activities-by-time"></a>Фильтрация диагностических действий по времени

Список диагностических действий можно отфильтровать с использованием параметров **-StartTime** и **-EndTime**. Параметр **-StartTime** включает в список только те диагностические действия, которые произошли после указанной даты, как показано в следующем примере.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -UserName <UserUPN> -StartTime "08/01/2018"
```

Параметр **-EndTime** можно добавить в командлет в сочетании с параметром **-StartTime**, чтобы указать период времени, за который нужно получить результаты. Следующий пример применения командлета вернет список диагностических действий за период с 1 по 10 августа.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -UserName <UserUPN> -StartTime "08/01/2018" -EndTime "08/10/2018"
```

Параметры **-StartTime** и **-EndTime** можно сочетать с другими необязательными параметрами фильтрации.

### <a name="filter-diagnostic-activities-by-activity-type"></a>Фильтрация диагностических действий по типу действия

Вы также можете фильтровать диагностические действия по типу действия с помощью параметра **-ActivityType**. Следующий командлет вернет список подключений, созданных пользователями.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -UserName <UserUPN> -ActivityType Connection
```

Следующий командлет вернет список задач управления, созданных администраторами.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -ActivityType Management
```

Командлет **Get-RdsDiagnosticActivities** в настоящее время не поддерживает значение Feed для параметра ActivityType.

### <a name="filter-diagnostic-activities-by-outcome"></a>Фильтрация диагностических действий по результату

Список диагностических действий можно отфильтровать по результату с помощью параметра **-Outcome**. Следующий пример применения командлета вернет список диагностических действий, которые завершились успешно.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -UserName <UserUPN> -Outcome Success
```

Следующий пример применения командлета вернет список диагностических действий, которые завершились сбоем.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -Outcome Failure
```

Параметр **-Outcome** можно сочетать с другими необязательными параметрами фильтрации.

### <a name="retrieve-a-specific-diagnostic-activity-by-activity-id"></a>Получение определенного диагностического действия по его идентификатору

Параметр **-ActivityId** возвращает конкретное диагностическое действие, если оно существует, как в следующем примере командлета.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -ActivityId <ActivityIdGuid>
```

### <a name="view-error-messages-for-a-failed-activity-by-activity-id"></a>Просмотр сообщений об ошибках для действия, завершившегося сбоем, по его идентификатору

Чтобы просмотреть сообщения об ошибках для действия, завершившегося сбоем, выполните командлет с параметром **-Detailed**. Список ошибок можно просмотреть, выполнив командлет **Select-Object**.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantname> -ActivityId <ActivityGuid> -Detailed | Select-Object -ExpandProperty Errors
```

### <a name="retrieve-detailed-diagnostic-activities"></a>Получение сведений о диагностических действиях

Параметр **-Detailed** предоставляет дополнительные сведения для каждого из возвращаемых диагностических действий. Формат данных для каждого действия зависит от типа этого действия. Параметр **-Detailed** можно добавить в любой запрос **Get-RdsDiagnosticActivities**, как показано в следующем примере.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -ActivityId <ActivityGuid> -Detailed
```

## <a name="common-error-scenarios"></a>Распространенные сценарии ошибок

Сценарии ошибок классифицируются как внутренние относительно службы и внешние относительно Виртуального рабочего стола Windows.

* Внутренней считается ошибка, которая не может быть устранена администратором клиента и которая требует участия специалиста службы поддержки. Оставляя отзыв в [техническом сообществе по Виртуальному рабочему столу Windows](https://techcommunity.microsoft.com/t5/Windows-Virtual-Desktop/bd-p/WindowsVirtualDesktop), укажите идентификатор действия и приблизительное время возникновения проблемы.
* Внешней считается проблема, которая может быть устранена системным администратором. Такие ошибки являются внешними относительно Виртуального рабочего стола Windows.

В следующей таблице перечислены самые распространенные ошибки, с которыми могут столкнуться администраторы.

>[!NOTE]
>Этот список регулярно обновляется. Чтобы поддерживать актуальность информации, сверяйтесь с этой статьей хотя бы раз в месяц.

### <a name="external-management-error-codes"></a>Коды внешних ошибок управления

|Числовой код|Код ошибки|Предлагаемое решение|
|---|---|---|
|1322|ConnectionFailedNoMappingOfSIDinAD|Пользователь не является членом Azure Active Directory. Чтобы добавить его, выполните [эти инструкции для Центра администрирования Active Directory](/windows-server/identity/ad-ds/get-started/adac/active-directory-administrative-center).|
|3|UnauthorizedAccess|Пользователь, который пытался запустить командлет PowerShell с правами администратора, не имеет соответствующих разрешений или неправильно указал имя пользователя.|
|1000|TenantNotFound|Введенное имя арендатора не соответствует ни одному из существующих арендаторов. Проверьте имя арендатора на наличие опечаток и повторите попытку.|
|1006|TenantCannotBeRemovedHasSessionHostPools|Невозможно удалить арендатор, пока он содержит объекты. Сначала удалите пулы узлов сеансов, затем повторите попытку.|
|2000|HostPoolNotFound|Введенное имя пула узлов не соответствует ни одному из существующих пулов узлов. Проверьте имя пула узлов на наличие опечаток и повторите попытку.|
|2005|HostPoolCannotBeRemovedHasApplicationGroups|Пул узлов невозможно удалить, пока он содержит объекты. Сначала удалите все группы приложений из этого пула узлов.|
|2004|HostPoolCannotBeRemovedHasSessionHosts|Прежде чем удалять пул узлов сеансов, удалите все узлы сеансов.|
|5001|SessionHostNotFound|Возможно, запрошенный узел сеансов отключен от сети. Проверьте состояние пула узлов.|
|5008|SessionHostUserSessionsExist |Прежде чем выполнять требуемое действие управления, необходимо выйти из всех сеансов пользователей на узле сеансов.|
|6000|AppGroupNotFound|Введенное имя группы приложений не соответствует ни одной из существующих групп приложений. Проверьте имя группы приложений на наличие опечаток и повторите попытку.|
|6022|RemoteAppNotFound|Введенное имя удаленного приложения RemoteApp не соответствует ни одному из существующих удаленных приложений RemoteApp. Проверьте имя удаленного приложения RemoteApp на наличие опечаток и повторите попытку.|
|6010|PublishedItemsExist|Имя ресурса, который вы пытаетесь опубликовать, совпадает с именем существующего ресурса. Измените имя ресурса и повторите попытку.|
|7002|NameNotValidWhiteSpace|В имени нельзя использовать пробелы.|
|8000|InvalidAuthorizationRoleScope|Введенное имя роли не соответствует ни одной из существующих ролей. Проверьте имя роли на наличие опечаток и повторите попытку. |
|8001|UserNotFound |Введенное имя пользователя не соответствует ни одному из существующих пользователей. Проверьте имя пользователя на наличие опечаток и повторите попытку.|
|8005|UserNotFoundInAAD |Введенное имя пользователя не соответствует ни одному из существующих пользователей. Проверьте имя пользователя на наличие опечаток и повторите попытку.|
|8008|TenantConsentRequired|Выполните [эти инструкции](tenant-setup-azure-active-directory.md#grant-permissions-to-windows-virtual-desktop), чтобы предоставить согласие для клиента.|

### <a name="external-connection-error-codes"></a>Коды внешних ошибок подключения

|Числовой код|Код ошибки|Предлагаемое решение|
|---|---|---|
|-2147467259|ConnectionFailedAdErrorNoSuchMember|Пользователь не является членом Azure Active Directory. Чтобы добавить его, выполните [эти инструкции для Центра администрирования Active Directory](/windows-server/identity/ad-ds/get-started/adac/active-directory-administrative-center).|
|-2147467259|ConnectionFailedAdTrustedRelationshipFailure|Узел сеансов неправильно присоединен к Active Directory.|
|-2146233088|ConnectionFailedUserHasValidSessionButRdshIsUnhealthy|Не удалось установить подключение, так как узел сеансов недоступен. Проверьте работоспособность узла сеансов.|
|-2146233088|ConnectionFailedClientDisconnect|Если эта ошибка возникает часто, убедитесь, что компьютер пользователя подключен к сети.|
|-2146233088|ConnectionFailedNoHealthyRdshAvailable|Сеанс, к которому пытался подключиться пользователь узла, неработоспособен. Выполните отладку виртуальной машины.|
|-2146233088|ConnectionFailedUserNotAuthorized|У пользователя нет разрешений на доступ к опубликованному приложению или рабочему столу. Эта ошибка может появиться после того, как администратор удалит опубликованные ресурсы. Попросите пользователя обновить веб-канал в приложении удаленного рабочего стола.|
|2|FileNotFound|Приложение, к которому пользователь пытался получить доступ, установлено неправильно либо настроено с неправильным путем.|
|3|InvalidCredentials|Имя пользователя или пароль, введенные пользователем, не совпадают с существующими именами пользователей и паролями. Проверьте учетные данные на наличие опечаток и повторите попытку.|
|8|ConnectionBroken|Подключение между клиентом и шлюзом или сервером разорвано. Никаких действий не требуется, если это не происходит неожиданно.|
|14|UnexpectedNetworkDisconnect|Подключение к сети разорвано. Попросите пользователя установить подключение.|
|24|ReverseConnectFailed|Виртуальная машина узла не имеет прямой связи с шлюзом удаленных рабочих столов. Убедитесь, что IP-адрес шлюза успешно разрешается.|

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о ролях для Виртуального рабочего стола Windows см. в статье [Среда Виртуального рабочего стола Windows](environment-setup-2019.md).

Список доступных командлетов PowerShell для Виртуального рабочего стола Windows см. в [документации по PowerShell](/powershell/windows-virtual-desktop/overview).
