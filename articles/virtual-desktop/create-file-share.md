---
title: Создание файлового ресурса службы файлов Azure с помощью контроллера домена в Azure
description: Настройте контейнер Фслогикс Profile в общем файловом ресурсе Azure в существующем пуле узлов виртуальных рабочих столов Windows с доменом Active Directory.
services: virtual-desktop
author: Heidilohr
ms.service: virtual-desktop
ms.topic: how-to
ms.date: 06/05/2020
ms.author: helohr
manager: lizross
ms.openlocfilehash: c9636a08b896cefdbec825e4979ad1ec89f8847b
ms.sourcegitcommit: 7fe8df79526a0067be4651ce6fa96fa9d4f21355
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/06/2020
ms.locfileid: "87842915"
---
# <a name="create-a-profile-container-with-azure-files-and-ad-ds"></a>Создание контейнера профиля с помощью файлов и AD DS Azure

В этой статье вы узнаете, как создать файловый ресурс Azure, прошедший проверку подлинности контроллером домена в существующем пуле узлов виртуальных рабочих столов Windows. Этот файловый ресурс можно использовать для хранения профилей хранения.

В этом процессе используются службы домен Active Directory Services (AD DS), которые являются локальными службами каталогов. Дополнительные сведения о создании контейнера Фслогикс Profile с помощью Azure AD DS см. в статье [Создание контейнера профиля фслогикс с помощью службы файлов Azure](create-profile-container-adds.md).

## <a name="prerequisites"></a>Предварительные условия

Прежде чем приступить к работе, убедитесь, что контроллер домена синхронизирован с Azure и разрешается из виртуальной сети Azure, к которой подключены узлы сеансов.

## <a name="set-up-a-storage-account"></a>Настройка учетной записи хранения

Сначала необходимо настроить учетную запись хранения файлов Azure.

Чтобы настроить учетную запись хранения, выполните следующие действия.

1. Войдите на портал Azure.

2. Выполните поиск **учетной записи хранения** в строке поиска.

3. Щелкните **+Добавить**.

4. На странице **Создание учетной записи хранения** введите следующие сведения.

    - Создание группы ресурсов
    - Введите уникальное имя учетной записи хранения.
    - Для **расположения**рекомендуется выбрать то же расположение, что и пул узлов виртуальных рабочих столов Windows.
    - В разделе **Производительность** выберите **Стандартная**. (В зависимости от требований операций ввода-вывода. Дополнительные сведения см. [в статье Параметры хранилища для контейнеров профилей фслогикс в виртуальном рабочем столе Windows](store-fslogix-profile.md).)
    - В качестве **типа учетной записи**выберите **StorageV2** или **филестораже** (доступно, только если уровень производительности — Premium).
    - Для **репликации**выберите **локально избыточное хранилище (LRS)**.

5. Когда все будет готово, выберите **проверить и создать**, а затем щелкните **создать**.

Если вам нужны более подробные инструкции по настройке, см. сведения о [региональной доступности](../storage/files/storage-files-identity-auth-active-directory-enable.md#regional-availability).

## <a name="create-an-azure-file-share"></a>Создание файлового ресурса Azure

Далее необходимо создать файловый ресурс Azure.

Чтобы создать файловый ресурс:

1. Выберите **Перейти к ресурсу**.

2. На странице Обзор выберите **файловые ресурсы**.

3. Выберите **+ Общие файловые ресурсы**, создайте новый файловый ресурс с именем **Profiles**, а затем введите соответствующую квоту или оставьте поле пустым, чтобы квоты не применялись.

4. Нажмите кнопку **создания**.

## <a name="enable-active-directory-authentication"></a>Включение проверки подлинности Active Directory

Далее необходимо включить проверку подлинности Active Directory (AD). Чтобы включить эту политику, необходимо выполнить инструкции этого раздела на компьютере, который уже присоединен к домену. Чтобы включить проверку подлинности, выполните следующие инструкции на виртуальной машине, на которой работает контроллер домена:

1. Протокол удаленного рабочего стола в присоединенную к домену виртуальную машину.

2. Следуйте инструкциям в разделе [Включение аутентификации azure AD DS для файловых ресурсов Azure](../storage/files/storage-files-identity-ad-ds-enable.md) , чтобы установить модуль азфилешибрид и включить проверку подлинности.

3.  Откройте портал Azure, откройте учетную запись хранения, выберите **Конфигурация**и убедитесь, что для параметра **Active Directory (AD)** задано значение **включено**.

     > [!div class="mx-imgBorder"]
     > ![Снимок экрана страницы конфигурации с включенным Azure Active Directory (AD).](media/active-directory-enabled.png)

## <a name="assign-azure-rbac-permissions-to-windows-virtual-desktop-users"></a>Назначение разрешений Azure RBAC пользователям виртуальных рабочих столов Windows

Все пользователи, которым необходимо иметь профили Фслогикс, хранящиеся в учетной записи хранения, должны быть назначены роли участника общего ресурса SMB для данных файлов хранилища.

Для входа пользователей на узлы сеансов Виртуального рабочего стола Windows требуются разрешения на доступ к общей папке. Как и в случае с традиционным общим ресурсом Windows, предоставление доступа к общей папке Azure предусматривает настройку разрешений как на уровне общего ресурса, так и на уровне NTFS.

Чтобы настроить разрешения уровня общего доступа, назначьте каждому пользователю роль с соответствующими разрешениями на доступ. Разрешения могут назначаться отдельным пользователям или группе Azure AD. Дополнительные сведения см. в разделе [Назначение разрешений на доступ к удостоверению](../storage/files/storage-files-identity-ad-ds-assign-permissions.md).

>[!NOTE]
>Учетные записи или группы, которым назначаются разрешения, должны быть созданы в домене и синхронизированы с Azure AD. Учетные записи, созданные в Azure AD, работать не будут.

Чтобы назначить разрешения управления доступом на основе ролей (RBAC), сделайте следующее:

1. Откройте портал Azure.

2. Откройте учетную запись хранения, созданную при [настройке учетной записи хранения](#set-up-a-storage-account).

3. Выберите **файловые ресурсы**, а затем выберите имя общей папки, которую планируется использовать.

4. Выберите **Управление доступом (IAM)** .

5. Выберите **добавить назначение ролей**.

6. На вкладке **Добавление назначения ролей** выберите **файл хранилища хранилище данных SMB с повышенными правами участника** для учетной записи администратора.

     Чтобы назначить пользователям разрешения для профилей FSLogix, следуйте тем же инструкциям. Однако при переходе к шагу 5 Выберите " **общий доступ к файлам хранилища SMB Data** ".

7. Щелкните **Сохранить**.

## <a name="assign-users-permissions-on-the-azure-file-share"></a>Назначение пользователям разрешений для файлового ресурса Azure

После назначения разрешений RBAC пользователям необходимо будет настроить разрешения NTFS.

Чтобы приступить к работе, необходимо знать две вещи из портал Azure:

- UNC-путь.
- Ключ учетной записи хранения.

### <a name="get-the-unc-path"></a>Получение UNC-пути

Вот как можно получить UNC-путь:

1. Откройте портал Azure.

2. Откройте учетную запись хранения, созданную при [настройке учетной записи хранения](#set-up-a-storage-account).

3. Выберите **Параметры**, а затем щелкните **свойства**.

4. Скопируйте **первичный код ресурса конечной точки службы файловых служб** в текстовый редактор по своему усмотрению.

5. После копирования URI выполните следующие действия, чтобы изменить его в формате UNC:

    - Удалить `https://` и заменить на`\\`
    - Замените косую черту `/` обратной косой чертой `\` .
    - Добавьте имя общего файлового ресурса, созданного при [создании файлового ресурса Azure](#create-an-azure-file-share) , в конце UNC.

        Пример: `\\customdomain.file.core.windows.net\<fileshare-name>`

### <a name="get-the-storage-account-key"></a>Получение ключа учетной записи хранения

Чтобы получить ключ учетной записи хранения, сделайте следующее:

1. Откройте портал Azure.

2. Откройте учетную запись хранения, созданную при [настройке учетной записи хранения](#set-up-a-storage-account).

3. На вкладке **учетная запись хранения** выберите **ключи доступа**.

4. Скопируйте **Key1** или **key2** в файл на локальном компьютере.

### <a name="configure-ntfs-permissions"></a>Настройка разрешений NTFS

Чтобы настроить разрешения NTFS, выполните следующие действия.

1. Откройте командную строку на виртуальной машине, присоединенной к домену.

2. Запустите следующий командлет, чтобы подключить общую папку Azure и назначить ей букву диска: 

     ```powershell
     net use <desired-drive-letter>: <UNC-pat> <SA-key> /user:Azure\<SA-name>
     ```

3. Выполните следующий командлет, чтобы проверить разрешения на доступ к общей папке Azure:

    ```powershell
    icacls <mounted-drive-letter>:
    ```

    Замените на `<mounted-drive-letter>` букву диска, с которым вы сопоставили сопоставление.

    Как *NT Аусорити\аусентикатед Users* , так и *Builtin \ пользователи* имеют определенные разрешения по умолчанию. Эти разрешения по умолчанию позволяют этим пользователям читать контейнеры профилей других пользователей. Однако разрешения, описанные в разделе [Настройка разрешений хранилища для использования с контейнерами профилей и контейнерами Office](/fslogix/fslogix-storage-config-ht) , не позволяют пользователям читать контейнеры профилей других пользователей.

4. Выполните следующие командлеты, чтобы позволить пользователям виртуальных рабочих столов Windows создавать собственные контейнеры профилей, одновременно блокируя доступ к контейнеру профиля от других пользователей.

     ```powershell
     icacls <mounted-drive-letter>: /grant <user-email>:(M)
     icacls <mounted-drive-letter>: /grant "Creator Owner":(OI)(CI)(IO)(M)
     icacls <mounted-drive-letter>: /remove "Authenticated Users"
     icacls <mounted-drive-letter>: /remove "Builtin\Users"
     ```

     - Замените <подключенного диска> буквой диска, который использовался для подключения накопителя.
     - Замените <пользовательский адрес электронной почты> именем участника-пользователя или группы Active Directory, содержащей пользователей, которым потребуется доступ к общей папке.

     Пример:

     ```powershell
     icacls <mounted-drive-letter>: /grant john.doe@contoso.com:(M)
     icacls <mounted-drive-letter>: /grant "Creator Owner":(OI)(CI)(IO)(M)
     icacls <mounted-drive-letter>: /remove "Authenticated Users"
     icacls <mounted-drive-letter>: /remove "Builtin\Users"
     ```

## <a name="configure-fslogix-on-session-host-vms"></a>Настройка Фслогикс на виртуальных машинах узла сеансов

В этом разделе показано, как настроить виртуальную машину с использованием FSLogix. Эти инструкции необходимо выполнять при каждой настройке узла сеансов. Прежде чем приступить к настройке, следуйте инструкциям в статье [Загрузка и установка фслогикс](/fslogix/install-ht). Обеспечить настройку разделов реестра на всех узлах сеансов можно несколькими способами. Возможно задать эти параметры в образе или настроить групповую политику.

Чтобы настроить FSLogix на виртуальной машине узла сеансов, выполните следующие действия.

1. Подключение RDP к виртуальной машине узла сеансов пула узлов виртуальных рабочих столов Windows.

2. [Скачайте и установите фслогикс](/fslogix/install-ht).

5. Следуйте инструкциям в разделе [Настройка параметров реестра контейнеров профилей](/fslogix/configure-profile-container-tutorial#configure-profile-container-registry-settings).

    - Перейдите в раздел **Computer**  >  **HKEY_LOCAL_MACHINE**  >  **Software**  >  **фслогикс**.

    - Создайте ключ **профилей** .

    - Создайте **параметр Enabled, DWORD** со значением 1.

    - Создайте **вхдлокатионс, MULTI_SZ**.

    - Присвойте параметру **вхдлокатионс** путь UNC, созданный в поле [Получение пути UNC](#get-the-unc-path).

6. Перезапустите виртуальную машину.

## <a name="testing"></a>Тестирование

После установки и настройки Фслогикс можно протестировать развертывание, войдя с помощью учетной записи пользователя, которой назначена группа приложений или Рабочий стол в пуле узлов. Убедитесь, что учетная запись пользователя, с которой выполняется вход, имеет разрешение на доступ к общей папке.

Если пользователь выполнил вход ранее, он будет иметь существующий локальный профиль, используемый в течение этого сеанса. Чтобы не создавать локальный профиль, создайте новую учетную запись пользователя, которая будет использоваться для тестов, или используйте методы конфигурации, описанные в [руководстве по настройке контейнера профиля для перенаправления профилей пользователей](/fslogix/configure-profile-container-tutorial/).

Чтобы проверить свои разрешения на сеанс, выполните следующие действия.

1. Запустите сеанс на виртуальном рабочем столе Windows.

2. Откройте портал Azure.

3. Откройте учетную запись хранения, созданную при [настройке учетной записи хранения](#set-up-a-storage-account).

4. Выберите **создать общую папку** на странице Создание файлового ресурса Azure.

5. Убедитесь, что в файлах уже есть папка, содержащая профиль пользователя.

Для дополнительного тестирования следуйте инструкциям в разделе Проверка [работоспособности профиля](create-profile-container-adds.md#make-sure-your-profile-works).

## <a name="next-steps"></a>Дальнейшие шаги

Сведения об устранении неполадок Фслогикс см. в [этом руководство по устранению неполадок](/fslogix/fslogix-trouble-shooting-ht).
