---
title: Подключение комплексного решения
titleSuffix: Azure Digital Twins
description: В этом учебнике показывается, как подключить готовое решение Azure Digital Twins, управляемое данными устройства.
author: baanders
ms.author: baanders
ms.date: 4/15/2020
ms.topic: tutorial
ms.service: digital-twins
ms.openlocfilehash: 9c07db575827254de833fc0b2390be823ebc4e57
ms.sourcegitcommit: 3541c9cae8a12bdf457f1383e3557eb85a9b3187
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2020
ms.locfileid: "86206554"
---
# <a name="build-out-an-end-to-end-solution"></a>Создание комплексного решения

Чтобы настроить полное готовое решение, управляемое динамическими данными из вашей среды, вы можете подключить свой экземпляр Azure Digital Twins к другим службам Azure, предназначенным для управления устройствами и данными.

В этом учебнике вам предстоит выполнить следующее.
* Настроить экземпляр Azure Digital Twins.
* Познакомиться с примером сценария сборки и узнать, как реализуются предварительно созданные компоненты.
* Использовать приложение [Функции Azure](../azure-functions/functions-overview.md) для маршрутизации имитированных данных телеметрии из устройства [Центра Интернета вещей](../iot-hub/about-iot-hub.md) в свойства цифрового двойника.
* Распространить изменения с помощью **графа двойника**, обрабатывая уведомления цифрового двойника с помощью маршрутов, конечных точек и Функций Azure.

[!INCLUDE [Azure Digital Twins tutorial: sample prerequisites](../../includes/digital-twins-tutorial-sample-prereqs.md)]

[!INCLUDE [Cloud Shell for Azure Digital Twins](../../includes/digital-twins-cloud-shell.md)]

[!INCLUDE [Azure Digital Twins tutorial: configure the sample project](../../includes/digital-twins-tutorial-sample-configure.md)]

## <a name="get-started-with-the-building-scenario"></a>Начало работы со сценарием сборки

Пример проекта, используемого в этом учебнике, представляет собой реальный **строительный план**, в котором есть этаж, комната и терморегулятор. Все эти компоненты будут иметь цифровое представление в экземпляре Azure Digital Twins, который затем будет подключен к [Центру Интернета вещей](../iot-hub/about-iot-hub.md), службе [Сетка событий](../event-grid/overview.md) и двум [функциям Azure](../azure-functions/functions-overview.md) для упрощения перемещения данных.

Ниже приведена схема, представляющая полный сценарий. 

Сначала вы создадите экземпляр Azure Digital Twins (**область A** на схеме), далее настроите поток данных телеметрии в цифровые двойники (**стрелка B**), а затем настроите распространение данных через граф двойников (**стрелка C**).

:::image type="content" source="media/tutorial-end-to-end/building-scenario.png" alt-text="Схема полного сценария сборки. Изображен поток данных с устройства в Центр Интернета вещей через функцию Azure (стрелка B) в экземпляр Azure Digital Twins (область A), а затем через Сетку событий в другую функцию Azure для обработки (стрелка C)":::

Работая с этим сценарием, вы будете взаимодействовать с компонентами предварительно написанного примера приложения, которое вы скачали ранее.

Ниже перечислены компоненты, реализованные в примере приложения *AdtSampleApp* для сценария сборки.
* Проверка подлинности устройства 
* Примеры использования [пакета SDK .NET (C#)](https://github.com/Azure/azure-sdk-for-net/tree/master/sdk/digitaltwins/Azure.DigitalTwins.Core) (находятся в *CommandLoop.cs*)
* Консольный интерфейс для вызова API Azure Digital Twins
* *SampleClientApp* — пример решения Azure Digital Twins
* *SampleFunctionsApp* — приложение Функций Azure, которое обновляет ваш граф Azure Digital Twins на основе данных телеметрии из событий Центра Интернета вещей и Azure Digital Twins

Пример проекта также содержит компонент интерактивной авторизации. При каждом запуске проекта будет открываться окно браузера, предлагающее войти в систему с учетной записью Azure.

### <a name="instantiate-the-pre-created-twin-graph"></a>Создание экземпляра предварительно созданного графа двойника

Сначала вы будете использовать решение *AdtSampleApp* из примера проекта для сборки части Azure Digital Twins готового сценария (**область A**):

:::image type="content" source="media/tutorial-end-to-end/building-scenario-a.png" alt-text="Фрагмент полной схемы сценария с выделенной областью A, представляющей экземпляр Azure Digital Twins":::

В окне Visual Studio, где открыт проект _**AdtE2ESample**_, запустите этот проект с помощью кнопки на панели инструментов, показанной на следующем рисунке:

:::image type="content" source="media/tutorial-end-to-end/start-button-sample.png" alt-text="Кнопка запуска Visual Studio (проект SampleClientApp)":::

Откроется окно консоли. Выполните проверку подлинности и дождитесь выполнения команды. Создайте экземпляр примера решения Azure Digital Twins, выполнив в этой консоли следующую команду.

> [!IMPORTANT]
> Если в вашем экземпляре Azure Digital Twins уже есть цифровые двойники и связи, при выполнении этой команды они будут удалены и заменены на двойники и связи для данного примера сценария.

```cmd/sh
SetupBuildingScenario
```

В выходных данных этой команды отображается ряд подтверждающих сообщений о том, что в вашем экземпляре Azure Digital Twins созданы и подключены три [**цифровых двойника**](concepts-twins-graph.md): этаж *floor1*, комната *room21* и датчик температуры *thermostat67*. Эти цифровые двойники представляют сущности, которые присутствуют в реальной среде.

С помощью связей они подключаются к следующему [**графу двойников**](concepts-twins-graph.md). Этот граф двойников представляет среду в целом, включая взаимодействие сущностей и их связи друг с другом.

:::image type="content" source="media/tutorial-end-to-end/building-scenario-graph.png" alt-text="Граф, показывающий, что floor1 содержит room21, а room21 содержит thermostat67" border="false":::

Вы можете проверить созданные двойники, выполнив следующую команду, которая запрашивает все цифровые двойники, содержащиеся в подключенном экземпляре Azure Digital Twins:

```cmd/sh
Query
```

После этого можно остановить выполнение проекта. Не закрывайте решение в Visual Studio, так как вы продолжите использовать его при изучении следующих разделов этого учебника.

## <a name="set-up-the-sample-function-app"></a>Настройка примера приложения-функции

Теперь вам нужно настроить [приложение Функций Azure ](../azure-functions/functions-overview.md), которое будет использоваться для обработки данных. Это приложение-функция *SampleFunctionsApp* содержит две функции:
* *ProcessHubToDTEvents*, которая обрабатывает поступающие данные Центра Интернета вещей и соответствующим образом обновляет Azure Digital Twins;
* *ProcessDTRoutedData*, которая обрабатывает данные из цифровых двойников и соответствующим образом обновляет родительские двойники в Azure Digital Twins.

В этом разделе вы опубликуете предварительно созданное приложение-функцию и назначите ему удостоверение Azure Active Directory (AAD), чтобы оно могло получить доступ к Azure Digital Twins. После выполнения этих действий вы сможете использовать функции, которые содержатся в данном приложении-функции, при изучении остальных разделов этого учебника. 

### <a name="publish-the-app"></a>Публикация приложения

Вернитесь в окно Visual Studio, где открыт проект _**AdtE2ESample**_, в области *Обозреватель решений* щелкните правой кнопкой мыши файл проекта _**SampleFunctionsApp**_ и выберите пункт **Опубликовать**.

:::image type="content" source="media/tutorial-end-to-end/publish-azure-function-1.png" alt-text="Visual Studio: публикация проекта":::

Откроется страница *Публикация*. Оставьте выбранный по умолчанию целевой объект **Azure** и нажмите кнопку *Далее*. 

В качестве конкретного целевого объекта выберите **Приложение-функция Azure (Windows)** и нажмите кнопку *Далее*.

:::image type="content" source="media/tutorial-end-to-end/publish-azure-function-2.png" alt-text="Публикация функции Azure в Visual Studio: конкретный целевой объект":::

На странице *экземпляра Функций* выберите свою подписку. При этом в соответствующем поле в вашей подписке должны появиться *группы ресурсов*.

Выберите группу ресурсов своего экземпляра и нажмите *+ Создать новую функцию Azure...* .

:::image type="content" source="media/tutorial-end-to-end/publish-azure-function-3.png" alt-text="Публикация функции Azure в Visual Studio: экземпляр Функций (до создания приложения-функции)":::

В окне *Приложение-функция (Windows) — создать* заполните поля следующим образом.
* **Имя** — имя плана потребления, который Azure будет использовать для размещения вашего приложения Функций Azure. Оно также станет именем приложения-функции, в котором будет находиться ваша фактическая функция. Можно выбрать собственное уникальное значение или оставить предоставленное по умолчанию.
* В поле **Подписка** должна быть указана подписка, которую вы хотите использовать. 
* В поле **Группа ресурсов** должна быть указана нужная вам группа ресурсов.
* В поле **Тип плана** оставьте значение *Потребление*.
* В поле **Расположение** выберите расположение вашей группы ресурсов.
* Создайте новый ресурс **службы хранилища Azure**, нажав ссылку *Создать...* . Задайте расположение, соответствующее расположению вашей группы ресурсов, оставьте остальные значения по умолчанию и нажмите кнопку "ОК".

:::image type="content" source="media/tutorial-end-to-end/publish-azure-function-4.png" alt-text="Публикация функции Azure в Visual Studio: Приложение-функция (Windows) — создать":::

Затем выберите **Создать**.

В результате вы должны вернуться на страницу *экземпляра Функций*, где в узле вашей группы ресурсов будет отображаться новое приложение-функция. Нажмите кнопку *Готово*.

:::image type="content" source="media/tutorial-end-to-end/publish-azure-function-5.png" alt-text="Публикация функции Azure в Visual Studio: экземпляр Функций (после создания приложения-функции)":::

На странице *Публикация*, которая снова открывается в главном окне Visual Studio, проверьте все сведения, и если они верны, нажмите кнопку **Опубликовать**.

:::image type="content" source="media/tutorial-end-to-end/publish-azure-function-6.png" alt-text="Публикация функции Azure в Visual Studio: публикация":::

> [!NOTE]
> Может появиться следующее всплывающее окно: :::image type="content" source="media/tutorial-end-to-end/publish-azure-function-7.png" alt-text="Публикация функции Azure в Visual Studio: учетные данные для публикации" border="false":::
> В таком случае выберите **Пытаться извлечь учетные данные из Azure** и нажмите кнопку **Сохранить**.
>
> Если вы видите предупреждение о том, что *ваша версия среды выполнения функций не соответствует версии, работающей в Azure*, следуйте инструкциям на экране, чтобы выполнить обновление до последней версии среды выполнения Функций Azure. Эта проблема может возникать, если вы используете более раннюю версию Visual Studio, чем та, которая рекомендована в разделе *Необходимые компоненты* в начале этого руководства.

### <a name="assign-permissions-to-the-function-app"></a>Назначение разрешений для приложения-функции

Чтобы разрешить приложению-функции доступ к Azure Digital Twins, необходимо настроить параметр приложения, назначить приложению управляемое системой удостоверение AAD и предоставить этому удостоверению права доступа *владельца* в экземпляре Azure Digital Twins.

В Azure Cloud Shell установите параметр приложения, который будет использоваться вашим приложением-функцией для обращения к экземпляру цифровых двойников, с помощью следующей команды.

```azurecli-interactive
az functionapp config appsettings set -g <your-resource-group> -n <your-App-Service-(function-app)-name> --settings "ADT_SERVICE_URL=<your-digital-twin-instance-URL>"
```

С помощью следующей команды создайте управляемое системой удостоверение. Запишите значение поля *principalId* в выходных данных команды.

```azurecli-interactive
az functionapp identity assign -g <your-resource-group> -n <your-App-Service-(function-app)-name>
```

Используйте это значение *principalId* в следующей команде, чтобы назначить удостоверению приложения-функции роль *владельца* для своего экземпляра Azure Digital Twins:

```azurecli
az dt role-assignment create --dt-name <your-Azure-Digital-Twins-instance> --assignee "<principal-ID>" --role "Azure Digital Twins Owner (Preview)"
```

В выходных данных этой команды содержатся сведения о созданном назначении роли. Теперь приложение-функция имеет разрешения на доступ к вашему экземпляру Azure Digital Twins.

## <a name="process-simulated-telemetry-from-an-iot-hub-device"></a>Обработка имитированных данных телеметрии с устройства Центра Интернета вещей

Граф Azure Digital Twins должен управляться данными телеметрии с реальных устройств. 

На этом шаге вы подключите имитируемый терморегулятор, зарегистрированный в [Центре Интернета вещей](../iot-hub/about-iot-hub.md), к цифровому двойнику, который представляет его в Azure Digital Twins. Как только имитированное устройство выпускает телеметрию, эти данные направляются в функцию Azure *ProcessHubToDTEvents*, которая запускает соответствующее обновление в цифровом двойнике. Таким образом, цифровой двойник будет поддерживаться в полном соответствии с данными реального устройства. В Azure Digital Twins процесс направления данных событий из одного места в другое называется [**маршрутизацией событий**](concepts-route-events.md).

Это происходит в следующей части готового сценария (**стрелка B**):

:::image type="content" source="media/tutorial-end-to-end/building-scenario-b.png" alt-text="Фрагмент схемы полного сценария сборки. Выделены стрелка B и элементы до Azure Digital Twins: устройство, Центр Интернета вещей и первая функция Azure":::

Для настройки этого подключения устройства необходимо выполнить следующие действия.
1. Создать Центр Интернета вещей, который будет управлять имитированным устройством.
2. Подключить Центр Интернета вещей к соответствующей функции Azure путем настройки подписки на события.
3. Зарегистрировать имитированное устройство в Центре Интернета вещей.
4. Запустить имитированное устройство и создать данные телеметрии.
5. Выполнить запрос в Azure Digital Twins, чтобы просмотреть результаты в реальном времени.

### <a name="create-an-iot-hub-instance"></a>Создание экземпляра Центра Интернета вещей

Служба Azure Digital Twins предназначена для работы параллельно с [Центром Интернета вещей](../iot-hub/about-iot-hub.md) — службой Azure для управления устройствами и их данными. На этом шаге вы настроите Центр Интернета вещей, который будет управлять примером устройства из этого учебника.

Чтобы создать новый Центр Интернета вещей, в Azure Cloud Shell выполните следующую команду:

```azurecli-interactive
az iot hub create --name <name-for-your-IoT-hub> -g <your-resource-group> --sku S1
```

В выходных данных этой команды содержатся сведения о созданном Центре Интернета вещей.

Сохраните имя, которое вы дали своему Центру Интернета вещей. Оно понадобится вам позже.

### <a name="connect-the-iot-hub-to-the-azure-function"></a>Подключение Центра Интернета вещей к функции Azure

Теперь подключите свой Центр Интернета вещей к функции Azure *ProcessHubToDTEvents* в приложении-функции, опубликованном ранее, чтобы данные могли передаваться с устройства в Центре Интернета вещей через эту функцию, которая обновляет Azure Digital Twins.

Для этого в вашем Центре Интернета вещей нужно создать **подписку на события** с функцией Azure в качестве конечной точки. Таким образом, функция "подписывается" на события, происходящие в Центре Интернета вещей.

На [портале Azure](https://portal.azure.com/) перейдите к только что созданному Центру Интернета вещей, выполнив поиск по его имени в верхней строке поиска. В меню центра выберите пункт *События*, а затем нажмите кнопку *+ Подписка на события*.

:::image type="content" source="media/tutorial-end-to-end/event-subscription-1.png" alt-text="Портал Azure: подписка на события Центра Интернета вещей":::

Вы вернетесь на страницу *Создание подписки на события*.

:::image type="content" source="media/tutorial-end-to-end/event-subscription-2.png" alt-text="Портал Azure: создание подписки на события":::

Заполните поля следующим образом (поля, заполненные по умолчанию, не указываются):
* *СВЕДЕНИЯ О ПОДПИСКЕ НА СОБЫТИЯ* > **Имя**: укажите имя для подписки на события.
* *СВЕДЕНИЯ О РАЗДЕЛЕ* > **Имя системного раздела**: Укажите имя для системного раздела. 
* *ТИПЫ СОБЫТИЙ* > **Фильтр по типам событий**: в раскрывающемся списке выберите *Телеметрия устройства*.
* *СВЕДЕНИЯ О КОНЕЧНОЙ ТОЧКЕ* > **Тип конечной точки**: выберите в меню пункт *Функция Azure*.
* *СВЕДЕНИЯ О КОНЕЧНОЙ ТОЧКЕ* > **Конечная точка**: нажмите ссылку *Выбор конечной точки*. Откроется окно *Выбор функции Azure*: :::image type="content" source="media/tutorial-end-to-end/event-subscription-3.png" alt-text="Подписка на события на портале Azure: выбор функции Azure" border="false":::
    - Заполните поля **Подписка**, **Группа ресурсов**, **Приложение-функция** и **Функция** (*ProcessHubToDTEvents*). После выбора подписки некоторые из этих полей могут быть заполнены автоматически.
    - Нажмите кнопку **Подтвердить выбор**.

Вернитесь на страницу *Создание подписки на события* и нажмите кнопку **Создать**.

### <a name="register-the-simulated-device-with-iot-hub"></a>Регистрация имитированного устройства в Центре Интернета вещей 

В этом разделе создается представление устройства в Центре Интернета вещей с идентификатором *thermostat67*. Имитированное устройство будет подключаться к этому представлению, и именно таким образом события телеметрии будут поступать с устройства в Центр Интернета вещей, где ожидает подписанная на эти события функция Azure из предыдущего шага, которая готова принять эти события и продолжить обработку.

В Azure Cloud Shell создайте устройство в Центре Интернета вещей с помощью следующей команды:

```azurecli-interactive
az iot hub device-identity create --device-id thermostat67 --hub-name <your-IoT-hub-name> -g <your-resource-group>
```

Выходные данные этой команды содержат сведения о созданном устройстве.

### <a name="configure-and-run-the-simulation"></a>Настройка и запуск имитации

Теперь настройте имитатор устройства для отправки данных в ваш экземпляр Центра Интернета вещей.

Сначала получите *строку подключения к Центру Интернета вещей* с помощью следующей команды:

```azurecli
az iot hub show-connection-string -n <your-IoT-hub-name>
```

Далее получите *строку подключения к устройству* с помощью следующей команды:

```azurecli
az iot hub device-identity show-connection-string --device-id thermostat67 --hub-name <your-IoT-hub-name>
```

Эти значения вы вставите в код имитатора устройства в своем локальном проекте, чтобы подключить имитатор к данному Центру Интернета вещей и устройству Центра Интернета вещей.

В новом окне Visual Studio откройте (из папки скачанного решения) файл _Device Simulator > **DeviceSimulator.sln**_.

>[!NOTE]
> Теперь у вас должны быть два окна Visual Studio: одно с файлом _**DeviceSimulator.sln**_, а другое, открытое раньше, с файлом _**AdtE2ESample.sln**_.

В *обозревателе решений* нового окна Visual Studio выберите _DeviceSimulator/**AzureIoTHub.cs**_, чтобы открыть этот файл в окне редактирования. Измените следующие значения строки подключения на значения, полученные ранее:

```csharp
connectionString = <Iot-hub-connection-string>
deviceConnectionString = <device-connection-string>
```

Сохраните файл.

Теперь, чтобы просмотреть результаты настройки имитации данных, запустите проект **DeviceSimulator** с помощью кнопки на панели инструментов, показанной на следующем рисунке.

:::image type="content" source="media/tutorial-end-to-end/start-button-simulator.png" alt-text="Кнопка запуска Visual Studio (проект DeviceSimulator)":::

Откроется окно консоли, в котором будут отображаться сымитированные сообщения телеметрии температуры. Они отправляются в Центр Интернета вещей, где функция Azure их собирает и обрабатывает.

:::image type="content" source="media/tutorial-end-to-end/console-simulator-telemetry.png" alt-text="Выходные данные в консоли, показывающие отправляемые имитатором устройства данные телеметрии температуры":::

В этой консоли больше ничего делать не нужно, но оставьте ее работающей для выполнения следующих шагов.

### <a name="see-the-results-in-azure-digital-twins"></a>Просмотр результатов в Azure Digital Twins

Функция *ProcessHubToDTEvents*, которую вы опубликовали ранее, ожидает передачи данных Центра Интернета вещей и вызывает API Azure Digital Twins для обновления свойства *Temperature* двойника *thermostat67*.

Чтобы просмотреть данные на стороне Azure Digital Twins, перейдите в окно Visual Studio, где открыт проект _**AdtE2ESample**_, и запустите его.

В открывшемся окне консоли для проекта выполните следующую команду, чтобы получить данные температуры, сообщенные цифровым двойником *thermostat67*:

```cmd
ObserveProperties thermostat67 Temperature
```

Вы должны увидеть обновления температуры в реальном времени *из своего экземпляра Azure Digital Twins*, которые регистрируются в консоли каждые 10 секунд.

:::image type="content" source="media/tutorial-end-to-end/console-digital-twins-telemetry.png" alt-text="Выходные данные консоли, показывающие журнал сообщений о температуре из цифрового двойника thermostat67":::

Убедившись, что все успешно работает, вы можете остановить выполнение обоих проектов. Не закрывайте окна Visual Studio, так как вы продолжите их использовать в оставшейся части учебника.

## <a name="propagate-azure-digital-twins-events-through-the-graph"></a>Распространение событий Azure Digital Twins с помощью графа

Пока из этого учебника вы узнали, как можно обновлять Azure Digital Twins данными из внешних устройств. Теперь будет показано, как изменения в одном цифровом двойнике могут распространяться через граф Azure Digital Twins — иными словами, как обновлять двойники из внутренних данных службы.

Чтобы выполнить это, вы будете использовать функцию Azure *ProcessDTRoutedData* для обновления двойника *комнаты* при обновлении двойника *терморегулятора*. Это происходит в следующей части готового сценария (**стрелка C**):

:::image type="content" source="media/tutorial-end-to-end/building-scenario-c.png" alt-text="Фрагмент схемы полного сценария сборки. Выделены стрелка C и элементы после Azure Digital Twins: Сетка событий, Центр Интернета вещей и вторая функция Azure":::

Для настройки этого потока данных необходимо выполнить следующие действия.
1. Создать конечную точку Azure Digital Twins, которая подключает экземпляр к Сетке событий.
2. Настроить маршрут в Azure Digital Twins для отправки событий изменения свойств двойника в конечную точку.
3. Развернуть приложение Функции Azure, которое ожидает передачи данных (через [Сетку событий](../event-grid/overview.md)) в конечной точке и соответствующим образом обновляет другие двойники.
4. Запустить имитированное устройство и запросить Azure Digital Twins, чтобы просмотреть результаты в реальном времени.

### <a name="set-up-endpoint"></a>Настройка конечной точки

[Сетка событий](../event-grid/overview.md) — это служба Azure, с помощью которой вы можете маршрутизировать и доставлять события, поступающие от служб Azure, в другие места в Azure. Вы можете создать [раздел Сетки событий](../event-grid/concepts.md), чтобы собирать в нем определенные события из источника, а затем подписчики могут прослушивать этот раздел, чтобы получать события по мере их появления.

В этой части вы создадите раздел сетки событий, а затем конечную точку в Azure Digital Twins, которая указывает на этот раздел (отправляет в него события). 

Чтобы создать раздел Сетки событий, выполните в Azure Cloud Shell следующую команду:

```azurecli-interactive
az eventgrid topic create -g <your-resource-group> --name <name-for-your-event-grid-topic> -l <region>
```

> [!TIP]
> Чтобы получить список имен регионов Azure, которые можно передать в команды в Azure CLI, выполните следующую команду:
> ```azurecli
> az account list-locations -o table
> ```

Выходные данные этой команды содержат сведения о созданном разделе Сетки событий.

Затем создайте конечную точку Azure Digital Twins, указывающую на этот раздел Сетки событий. Используйте приведенную ниже команду, вставив вместо заполнителей соответствующие значения:

```azurecli
az dt endpoint create eventgrid --dt-name <your-Azure-Digital-Twins-instance> --eventgrid-resource-group <your-resource-group> --eventgrid-topic <your-event-grid-topic> --endpoint-name <name-for-your-Azure-Digital-Twins-endpoint>
```

Выходные данные этой команды содержат сведения о созданной конечной точке.

Для проверки успешного создания конечной точки вы также можете отправить запрос этой конечной точки в свой экземпляр Azure Digital Twins с помощью следующей команды:

```azurecli
az dt endpoint show --dt-name <your-Azure-Digital-Twins-instance> --endpoint-name <your-Azure-Digital-Twins-endpoint> 
```

Найдите поле `provisioningState` в выходных данных и убедитесь, что оно имеет значение "Succeeded".

:::image type="content" source="media/tutorial-end-to-end/output-endpoints.png" alt-text="Результат запроса конечной точки, показывающий конечную точку с параметром provisioningState, имеющим значение Succeeded":::

Сохраните имена, которые вы назначили разделу Сетки событий и конечной точке Azure Digital Twins. Они понадобятся вам позже.

### <a name="set-up-route"></a>Настройка маршрута

Теперь создайте маршрут Azure Digital Twins, который отправляет события в только что созданную конечную точку Azure Digital Twins.

```azurecli
az dt route create --dt-name <your-Azure-Digital-Twins-instance> --endpoint-name <your-Azure-Digital-Twins-endpoint> --route-name <name-for-your-Azure-Digital-Twins-route>
```

Выходные данные этой команды содержат сведения о созданном маршруте.

#### <a name="connect-the-function-to-event-grid"></a>Подключение функции к Сетке событий

Подпишите функцию Azure *ProcessDTRoutedData* на раздел Сетки событий, созданный ранее, чтобы данные телеметрии могли поступать из двойника *thermostat67* через раздел Сетки событий в эту функцию, которая будет возвращаться в Azure Digital Twins и соответствующим образом обновлять двойник *room21*.

Для этого создайте **подписку на события** из раздела Сетки событий для вашей функции Azure *ProcessDTRoutedData*, которая выступает как конечная точка.

На [портале Azure](https://portal.azure.com/) перейдите к своему разделу Сетки событий, выполнив поиск по его имени в верхней строке поиска. Выберите *+ Event Subscription* (+ Подписка на события).

:::image type="content" source="media/tutorial-end-to-end/event-subscription-1b.png" alt-text="Портал Azure: подписка на события Сетки событий":::

Эта подписка на события создается подобно тому, как создавалась подписка первой функции на события Центра Интернета вещей ранее в этом учебнике. На этот раз вам не нужно указывать *телеметрию устройства* в качестве типа события для прослушивания, и вы будете подключаться к другой функции Azure.

На странице *Создание подписки на событие* заполните поля следующим образом (поля, заполненные по умолчанию, не указываются):
* *СВЕДЕНИЯ О ПОДПИСКЕ НА СОБЫТИЯ* > **Имя**: укажите имя для подписки на события.
* *СВЕДЕНИЯ О КОНЕЧНОЙ ТОЧКЕ* > **Тип конечной точки**: выберите в меню пункт *Функция Azure*.
* *СВЕДЕНИЯ О КОНЕЧНОЙ ТОЧКЕ* > **Конечная точка**: нажмите ссылку *Выбор конечной точки*. Откроется окно *Выбор функции Azure*:
    - Заполните поля **Подписка**, **Группа ресурсов**, **Приложение-функция** и **Функция** (*ProcessDTRoutedData*). После выбора подписки некоторые из этих полей могут быть заполнены автоматически.
    - Нажмите кнопку **Подтвердить выбор**.

Вернитесь на страницу *Создание подписки на события* и нажмите кнопку **Создать**.

### <a name="run-the-simulation-and-see-the-results"></a>Запуск имитации и просмотр результатов

Теперь можно запустить имитатор устройства, чтобы дать старт новому потоку событий, который вы настроили. Перейдите в окно Visual Studio, где открыт проект _**DeviceSimulator**_, и запустите этот проект.

Так же, как при предыдущем запуске имитатора устройства, откроется окно консоли, в котором будут отображаться сымитированные сообщения телеметрии температуры. Эти события проходят по потоку, который вы настроили ранее, чтобы обновить двойник *thermostat67*, а затем по потоку, который вы только что настроили, чтобы обновить двойник *room21*.

:::image type="content" source="media/tutorial-end-to-end/console-simulator-telemetry.png" alt-text="Выходные данные в консоли, показывающие отправляемые имитатором устройства данные телеметрии температуры":::

В этой консоли больше ничего делать не нужно, но оставьте ее работающей для выполнения следующих шагов.

Чтобы просмотреть данные на стороне Azure Digital Twins, перейдите в окно Visual Studio, где открыт проект _**AdtE2ESample**_, и запустите его.

В открывшемся окне консоли для проекта выполните следующую команду, чтобы получить данные температуры, сообщенные **обоими** цифровыми двойниками — *thermostat67* и *room21*.

```cmd
ObserveProperties thermostat67 Temperature room21 Temperature
```

Вы должны увидеть обновления температуры в реальном времени *из своего экземпляра Azure Digital Twins*, которые регистрируются в консоли каждые 10 секунд. Обратите внимание, что температура для *room21* обновляется в соответствии с обновлениями в *thermostat67*.

:::image type="content" source="media/tutorial-end-to-end/console-digital-twins-telemetry-b.png" alt-text="Выходные данные консоли, показывающие журнал сообщений о температуре из цифровых двойников терморегулятора и комнаты":::

Убедившись, что все успешно работает, вы можете остановить выполнение обоих проектов. Вы также можете закрыть окна Visual Studio, так как учебник завершен.

## <a name="review"></a>Просмотр

Ниже приводится обзор сценария, созданного во время изучения этого учебника.

1. Экземпляр Azure Digital Twins имеет цифровые двойники этажа, комнаты и терморегулятора (представленные **областью A** на схеме ниже).
2. Данные телеметрии имитированного устройства отправляются в Центр Интернета вещей, где функция Azure *ProcessHubToDTEvents* прослушивает события телеметрии. Функция Azure *ProcessHubToDTEvents* использует эти сведения в событиях для установки свойства *Temperature* цифрового двойника *thermostat67* (**стрелка B** на схеме).
3. События изменения свойств в Azure Digital Twins направляются в раздел Сетки событий, где функция Azure *ProcessDTRoutedData* прослушивает события. Функция Azure *ProcessDTRoutedData* использует сведения в этих событиях для установки свойства *Temperature* цифрового двойника *room21* (**стрелка C** на схеме).

:::image type="content" source="media/tutorial-end-to-end/building-scenario.png" alt-text="Схема полного сценария сборки. Изображен поток данных с устройства в Центр Интернета вещей через функцию Azure (стрелка B) в экземпляр Azure Digital Twins (область A), а затем через Сетку событий в другую функцию Azure для обработки (стрелка C)":::

## <a name="clean-up-resources"></a>Очистка ресурсов

Если ресурсы, созданные для этого учебника, вам больше не нужны, можете удалить их. 

В Azure Cloud Shell можно удалить все ресурсы Azure в группе ресурсов с помощью команды [az group delete](https://docs.microsoft.com/cli/azure/group?view=azure-cli-latest#az-group-delete). Это приведет к удалению всей группы ресурсов: экземпляра Azure Digital Twins, Центра Интернета вещей и регистрации устройства в этом центре, раздела Сетки событий и связанных с ним подписок, а также обоих приложений Функций Azure вместе со связанными с ними ресурсами, такими как хранилище.

> [!IMPORTANT]
> Удаление группы ресурсов — процесс необратимый. Группа ресурсов и все содержащиеся в ней ресурсы удаляются без возможности восстановления. Будьте внимательны, чтобы случайно не удалить не ту группу ресурсов или не те ресурсы. 

```azurecli-interactive
az group delete --name <your-resource-group>
```

Затем удалите регистрацию приложения AAD, которую вы создали для своего клиентского приложения, с помощью следующей команды:

```azurecli
az ad app delete --id <your-application-ID>
```

Наконец, удалите скачанную папку примера проекта с локального компьютера.

## <a name="next-steps"></a>Дальнейшие действия

В этом учебнике вы создали готовый сценарий, который показывает, как можно управлять данными устройства Azure Digital Twins в реальном времени.

Далее ознакомьтесь со следующей документацией по основным понятиям, чтобы больше узнать об элементах, с которыми вы работали в этом учебнике.
* [Основные понятия. Настраиваемые модели](concepts-models.md)

Кроме того, дополнительные сведения о процессах, описанных в этом руководстве, можно найти в статьях с инструкциями.
* [Практическое руководство. Использование CLI для Azure Digital Twins](how-to-use-cli.md)
