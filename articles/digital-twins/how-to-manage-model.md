---
title: Управление пользовательскими моделями
titleSuffix: Azure Digital Twins
description: См. статью создание, изменение и удаление модели в Azure Digital двойников.
author: baanders
ms.author: baanders
ms.date: 3/12/2020
ms.topic: how-to
ms.service: digital-twins
ms.openlocfilehash: a7fcd32335b5d9e04986355adeea473cf77b970e
ms.sourcegitcommit: 2e72661f4853cd42bb4f0b2ded4271b22dc10a52
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/14/2020
ms.locfileid: "92048208"
---
# <a name="manage-azure-digital-twins-models"></a>Управление моделями цифровых двойников Azure

Вы можете управлять [моделями](concepts-models.md) , известными экземпляру Azure Digital двойников, с помощью [**интерфейсов API дигиталтвинсмоделс**](how-to-use-apis-sdks.md), [пакета SDK для .NET (C#)](https://github.com/Azure/azure-sdk-for-net/tree/master/sdk/digitaltwins/Azure.DigitalTwins.Core)или [Azure Digital двойников CLI](how-to-use-cli.md). 

К операциям управления относятся передача, проверка, извлечение и удаление моделей. 

## <a name="create-models"></a>Создание моделей

Модели для Azure Digital двойников пишутся в ДТДЛ и сохраняются в виде файлов *JSON* . Существует также [расширение дтдл](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.vscode-dtdl) , доступное для [Visual Studio Code](https://code.visualstudio.com/), которое обеспечивает проверку синтаксиса и другие возможности для упрощения написания документов дтдл.

Рассмотрим пример, в котором больницы хочет цифровое представление о своих комнатах. Каждая комната содержит интеллектуальный распределитель SOAP для мониторинга вручную-Вашинг и датчиков для мониторинга трафика через комнату.

Первый шаг к решению — создание моделей для представления аспектов больницы. Комната пациента в этом сценарии можно описать следующим образом:

```json
{
  "@id": "dtmi:com:contoso:PatientRoom;1",
  "@type": "Interface",
  "@context": "dtmi:dtdl:context;2",
  "displayName": "Patient Room",
  "contents": [
    {
      "@type": "Property",
      "name": "visitorCount",
      "schema": "double"
    },
    {
      "@type": "Property",
      "name": "handWashCount",
      "schema": "double"
    },
    {
      "@type": "Property",
      "name": "handWashPercentage",
      "schema": "double"
    },
    {
      "@type": "Relationship",
      "name": "hasDevices"
    }
  ]
}
```

> [!NOTE]
> Это образец текста для JSON-файла, в котором модель определена и сохранена для отправки в составе клиентского проекта. REST API вызов, с другой стороны, принимает массив определений модели, аналогичный приведенному выше (который сопоставляется с `IEnumerable<string>` в пакете SDK для .NET). Поэтому, чтобы использовать эту модель непосредственно в REST API, заключите ее в квадратные скобки.

Эта модель определяет имя и уникальный идентификатор для комнаты пациента, а также свойства, представляющие число посетителей и состояние вручную (эти счетчики будут обновлены на основе датчиков движения и смарт-распределительов SOAP, и будут использоваться вместе для вычисления свойства *хандваш в процентах* ). Модель также определяет связь *хасдевицес*, которая будет использоваться для подключения любых [цифровых двойников](concepts-twins-graph.md) , основанных на этой модели *комнаты* , к реальным устройствам.

Следуя этому методу, можно приступать к определению моделей для наподобие больницы, зон или самой больницы.

### <a name="validate-syntax"></a>Проверить синтаксис

[!INCLUDE [Azure Digital Twins: validate models info](../../includes/digital-twins-validate.md)]

## <a name="manage-models-with-apis"></a>Управление моделями с помощью API

В следующих разделах показано, как выполнить различные операции управления моделями с помощью [API-интерфейсов и пакетов SDK для цифровых двойников Azure](how-to-use-apis-sdks.md).

> [!NOTE]
> Приведенные ниже примеры не включают в себя обработку ошибок для краткости. Однако настоятельно рекомендуется в своих проектах заключить вызовы служб в блоки try/catch.

> [!TIP] 
> Помните, что все методы пакета SDK имеют синхронные и асинхронные версии. Для вызовов подкачки асинхронные методы возвращают, `AsyncPageable<T>` когда синхронные версии возвращают `Pageable<T>` .

### <a name="upload-models"></a>Отправка моделей

После создания моделей их можно передать в экземпляр Digital двойников Azure.

> [!TIP]
> Перед отправкой в свой экземпляр Azure Digital двойников рекомендуется проверить свои модели в автономном режиме. Для проверки моделей перед их отправкой в службу можно использовать пример [библиотеки средства синтаксического анализа](https://nuget.org/packages/Microsoft.Azure.DigitalTwins.Parser/) [дтдл и проверочного элемента управления](/samples/azure-samples/dtdl-validator/dtdl-validator) дтдл, описанный в разделе [*инструкции. анализ и проверка моделей*](how-to-parse-models.md) .

Когда вы будете готовы отправить модель, можно использовать следующий фрагмент кода:

```csharp
// 'client' is an instance of DigitalTwinsClient
// Read model file into string (not part of SDK)
StreamReader r = new StreamReader("MyModelFile.json");
string dtdl = r.ReadToEnd(); r.Close();
string[] dtdls = new string[] { dtdl };
client.CreateModels(dtdls);
```

Обратите внимание, что `CreateModels` метод принимает несколько файлов в одной транзакции. Вот пример для иллюстрации:

```csharp
var dtdlFiles = Directory.EnumerateFiles(sourceDirectory, "*.json");

List<string> dtdlStrings = new List<string>();
foreach (string fileName in dtdlFiles)
{
    // Read model file into string (not part of SDK)
    StreamReader r = new StreamReader(fileName);
    string dtdl = r.ReadToEnd(); r.Close();
    dtdlStrings.Add(dtdl);
}
client.CreateModels(dtdlStrings);
```

Файлы модели могут содержать более одной модели. В этом случае модели необходимо разместить в массиве JSON. Например.

```json
[
  {
    "@id": "dtmi:com:contoso:Planet",
    "@type": "Interface",
    //...
  },
  {
    "@id": "dtmi:com:contoso:Moon",
    "@type": "Interface",
    //...
  }
]
```
 
При передаче файлы модели проверяются службой.

### <a name="retrieve-models"></a>Получение моделей

Вы можете перечислить и извлечь модели, хранящиеся в вашем экземпляре Digital двойников Azure. 

Ниже приведены возможные варианты.
* Получение всех моделей
* Получение одной модели
* Получение одной модели с зависимостями
* Получение метаданных для моделей

Ниже приведены некоторые примеры вызовов.

```csharp
// 'client' is a valid DigitalTwinsClient object

// Get a single model, metadata and data
DigitalTwinsModelData md1 = client.GetModel(id);

// Get a list of the metadata of all available models
Pageable<DigitalTwinsModelData> pmd2 = client.GetModels();

// Get a list of metadata and full model definitions
Pageable<DigitalTwinsModelData> pmd3 = client.GetModels(null, true);

// Get models and metadata for a model ID, including all dependencies (models that it inherits from, components it references)
Pageable<DigitalTwinsModelData> pmd4 = client.GetModels(new string[] { modelId }, true);
```

Вызовы API для получения моделей все возвращаемые `DigitalTwinsModelData` объекты. `DigitalTwinsModelData` содержит метаданные о модели, хранящейся в экземпляре Azure Digital двойников, например имя, ДТМИ и дату создания модели. `DigitalTwinsModelData`Объект также может включать саму модель. В зависимости от параметров можно использовать вызовы получения для получения только метаданных (что бывает полезно в сценариях, где требуется отобразить список доступных средств, например) или всю модель.

`RetrieveModelWithDependencies`Вызов возвращает не только запрошенную модель, но и все модели, от которых зависит запрошенная модель.

Модели не обязательно возвращаются точно в форме документа, в которой они были переданы. Azure Digital двойников гарантирует только то, что возвращаемая форма будет семантически эквивалентна. 

### <a name="update-models"></a>Обновление моделей

После передачи модели в экземпляр Digital двойников Azure весь интерфейс модели является неизменяемым. Это означает отсутствие традиционного «редактирования» моделей. Кроме того, Azure Digital двойников не допускает повторной отправки той же модели.

Вместо этого, если необходимо внести изменения в модель (например, обновление `displayName` или), `description` отправьте **более новую версию** модели. 

#### <a name="model-versioning"></a>управления версиями моделей;

Чтобы создать новую версию существующей модели, начните с ДТДЛ исходной модели. Обновите поля, которые вы хотите изменить.

>[!NOTE]
>Во время предварительной версии повышена версия модели, позволяющая добавлять новые поля, а не удалять существующие. Чтобы удалить поля, необходимо просто [создать новую модель](#create-models).

Затем пометьте это как более новую версию модели, обновив `id` поле модели. Последний раздел идентификатора модели, после `;` , представляет номер модели. Чтобы указать, что теперь это обновленная версия этой модели, увеличьте число в конце `id` значения до любого числа, превышающего номер текущей версии.

Например, если идентификатор предыдущей модели выглядит следующим образом:

```json
"@id": "dtmi:com:contoso:PatientRoom;1",
```

Версия 2 этой модели может выглядеть следующим образом:

```json
"@id": "dtmi:com:contoso:PatientRoom;2",
```

Затем передайте новую версию модели в экземпляр. 

Эта версия модели будет доступна в вашем экземпляре для использования в цифровом двойников. Он **не** перезаписывает более ранние версии модели, поэтому несколько версий модели будут сосуществовать в экземпляре до тех пор, пока вы не [удалите их](#remove-models).

#### <a name="impact-on-twins"></a>Влияние на двойников

При создании нового двойника, поскольку существует новая версия модели и версия старой модели, Новая двойника может использовать либо новую версию модели, либо старую версию.

Это также означает, что отправка новой версии модели не влияет на существующие двойников автоматически. Существующие двойников будут просто оставаться экземплярами старой версии модели.

Вы можете обновить существующие двойников до новой версии модели, установив исправления, как описано в разделе [*обновление модели Digital двойника*](how-to-manage-twin.md#update-a-digital-twins-model) статьи *практические руководства. Управление цифровыми двойниковми*. В одном и том же обновлении необходимо обновить **идентификатор модели** (в новой версии) и **все поля, которые должны быть изменены в двойника, чтобы обеспечить соответствие новой модели**.

### <a name="remove-models"></a>Удалить модели

Модели также можно удалить из службы одним из двух способов:
* **Списание** : после списания модели ее нельзя использовать для создания новых цифровых двойников. Существующие цифровые двойников, которые уже используют эту модель, не затрагиваются, поэтому вы по-прежнему можете обновлять их с учетом изменений свойств, а также добавлять или удалять связи.
* **Удаление** . модель будет полностью удалена из решения. Все двойников, которые использовали эту модель, больше не связаны с какой-либо допустимой моделью, поэтому они обрабатываются так, как будто они вообще не имеют модели. Вы по-прежнему можете читать эти двойников, но не сможете вносить в них обновления, пока они не будут переназначены другой модели.

Это отдельные функции, которые не влияют друг на друга, хотя они могут использоваться совместно для постепенного удаления модели. 

#### <a name="decommissioning"></a>Списание

Ниже приведен код для списания модели.

```csharp
// 'client' is a valid DigitalTwinsClient  
client.DecommissionModel(dtmiOfPlanetInterface);
// Write some code that deletes or transitions digital twins
//...
```

Состояние списания модели включается в `DigitalTwinsModelData` записи, возвращаемые API-интерфейсами извлечения модели.

#### <a name="deletion"></a>Удаление

Можно удалить все модели в экземпляре одновременно или сделать это отдельно.

Пример того, как удалить все модели, можно скачать с помощью примера приложения, используемого в [*учебнике. Изучите основные сведения с примером клиентского приложения*](tutorial-command-line-app.md). Файл *CommandLoop.CS* делает это в `CommandDeleteAllModels` функции.

Оставшаяся часть этого раздела разделяет удаление модели на более подробные сведения и показывает, как это сделать для отдельной модели.

##### <a name="before-deletion-deletion-requirements"></a>Перед удалением: требования к удалению

Как правило, модели можно удалять в любое время.

Исключением являются модели, от которых зависят другие модели: с помощью `extends` связи или компонента. Например, если модель *конференцерум* расширяет модель *комнаты* и имеет модель *акунит* в качестве компонента, то нельзя удалить *комнату* или *акунит* до тех пор, пока *конференцерум* не удалит соответствующие ссылки. 

Это можно сделать, обновив зависимую модель, удалив зависимости, или полностью удалив зависимую модель.

##### <a name="during-deletion-deletion-process"></a>Во время удаления: процесс удаления

Даже если модель соответствует требованиям для немедленного удаления, может потребоваться выполнить несколько шагов, чтобы избежать непредвиденных последствий для двойников, оставшихся перед. Ниже приведены некоторые шаги, которые могут помочь в управлении процессом.
1. Сначала списание модели
2. Подождите несколько минут, чтобы служба обработала все запросы на создание двойника за последние минуты, отправленные до списания
3. Запросите двойников по модели, чтобы увидеть все двойников, использующие модель, списанную сейчас.
4. Удалите двойников, если они больше не нужны, или при необходимости исправляет их в новую модель. Можно также оставить их только один раз, в этом случае они станут двойников без моделей после удаления модели. Последствия этого состояния см. в следующем разделе.
5. Подождите еще несколько минут, чтобы убедиться, что изменения перколатед через
6. Удаление модели 

Чтобы удалить модель, используйте следующий вызов:
```csharp
// 'client' is a valid DigitalTwinsClient
await client.DeleteModelAsync(IDToDelete);
```

##### <a name="after-deletion-twins-without-models"></a>После удаления: двойников без моделей

После удаления модели все цифровые двойников, которые использовали модель, теперь считаются без модели. Обратите внимание, что нет запроса, который может предоставить список всех двойников в этом состоянии, хотя вы по-прежнему *можете* запрашивать у двойников удаленную модель, чтобы узнать, какие двойников затронуты.

Ниже приведены общие сведения о том, что можно и не может делать с двойников, у которых нет модели.

**Возможные действия** :
* Запрос двойника
* Читать свойства
* Чтение исходящих отношений
* Добавлять и удалять входящие связи (как и другие двойников могут соформовать связи *с* этим двойника)
  - `target`В определении связи может по-прежнему отражать дтми удаленной модели. Здесь также может работать связь без определенного целевого объекта.
* Удаление связей
* Удаление двойника

Не **удается** выполнить следующие действия:
* Изменить исходящие связи (как в, связи *от* этого двойника с другими двойников)
* Изменение свойств

##### <a name="after-deletion-re-uploading-a-model"></a>После удаления: Повторная отправка модели

После удаления модели вы можете позже принять решение о передаче новой модели с тем же ИДЕНТИФИКАТОРом, что и у удаленной. Вот что происходит в этом случае.
* С точки зрения хранилища решения это то же самое, что и загрузка совершенно новой модели. Служба не запомнила, что старая из них была отправлена.   
* Если на графе, ссылающемся на удаленную модель, есть оставшиеся двойников, они больше не являются потерянными. Идентификатор модели действителен повторно с новым определением. Однако если новое определение модели отличается от удаленного определения модели, эти двойников могут иметь свойства и связи, которые соответствуют удаленному определению и не являются допустимыми с новым.

Azure Digital двойников не препятствует этому состоянию, поэтому будьте внимательны, чтобы убедиться, что они остаются действительными с помощью переключателя определения модели.

## <a name="manage-models-with-cli"></a>Управление моделями с помощью интерфейса командной строки

Для управления моделями можно также использовать интерфейс командной строки Azure Digital двойников. Команды можно найти в [*этом пошаговом окне. Используйте интерфейс командной строки Azure Digital двойников*](how-to-use-cli.md).

[!INCLUDE [digital-twins-known-issue-cloud-shell](../../includes/digital-twins-known-issue-cloud-shell.md)]

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как создавать цифровые двойников и управлять ими на основе моделей:
* [*Практические руководства. Управление цифровыми двойников*](how-to-manage-twin.md)