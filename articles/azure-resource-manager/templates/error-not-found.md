---
title: Ошибка "ресурс не найден"
description: Описывает, как устранять ошибки, когда не удается найти ресурс. Эта ошибка может возникать при развертывании шаблона Azure Resource Manager или при выполнении действий управления.
ms.topic: troubleshooting
ms.date: 06/10/2020
ms.openlocfilehash: 224af4ce0fe5053201f25d8207f4ca8cdc73e638
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "84667953"
---
# <a name="resolve-resource-not-found-errors"></a>Ошибка при устранении ненайденных ресурсов

В этой статье описывается ошибка, которую вы видите при невозможности найти ресурс во время операции. Как правило, эта ошибка возникает при развертывании ресурсов. Эта ошибка также возникает при выполнении задач управления и Azure Resource Manager не может найти необходимый ресурс. Например, если попытаться добавить теги в ресурс, который не существует, появится эта ошибка.

## <a name="symptom"></a>Симптом

Существует два кода ошибок, указывающих, что ресурс не найден. Ошибка **NotFound** возвращает результат, аналогичный следующему:

```
Code=NotFound;
Message=Cannot find ServerFarm with name exampleplan.
```

Ошибка **ResourceNotFound** возвращает результат, аналогичный следующему:

```
Code=ResourceNotFound;
Message=The Resource 'Microsoft.Storage/storageAccounts/{storage name}' under resource
group {resource group name} was not found.
```

## <a name="cause"></a>Причина

Диспетчер ресурсов необходимо получить свойства ресурса, но не удается найти ресурс в подписках.

## <a name="solution-1---check-resource-properties"></a>Решение 1. Проверка свойств ресурсов

При возникновении этой ошибки во время выполнения задачи управления проверьте значения, предоставленные для ресурса. Ниже приведены три проверяемых значения.

* Имя ресурса
* Имя группы ресурсов
* Подписка

Если вы используете PowerShell или Azure CLI, проверьте, выполняется ли команда в подписке, содержащей ресурс. Вы можете изменить подписку с помощью [Set-азконтекст](/powershell/module/Az.Accounts/Set-AzContext) или [AZ Account Set](/cli/azure/account#az-account-set). Многие команды также предоставляют параметр подписки, который позволяет указать другую подписку, отличную от текущего контекста.

Если у вас возникли проблемы с проверкой свойств, войдите на [портал](https://portal.azure.com). Найдите ресурс, который вы пытаетесь использовать, и изучите имя ресурса, группу ресурсов и подписку.

## <a name="solution-2---set-dependencies"></a>Решение 2. Настройка зависимостей

При возникновении этой ошибки при развертывании шаблона может потребоваться добавить зависимость. Resource Manager оптимизирует развертывание, создавая ресурсы параллельно, когда это возможно. Если один ресурс необходимо развернуть после другого, требуется использовать в шаблоне элемент **dependsOn**. Например, при развертывании веб-приложения вам нужно создать план службы приложений. Если вы не указали, что веб-приложение зависит от плана службы приложений, Resource Manager создаст оба ресурса одновременно. При попытке указать свойство веб-приложения появится сообщение о том, что невозможно найти ресурс плана службы приложений, так как он еще не существует. Чтобы предотвратить эту ошибку, в веб-приложении следует настроить зависимость.

```json
{
  "type": "Microsoft.Web/sites",
  "apiVersion": "2015-08-01",
  "dependsOn": [
    "[variables('hostingPlanName')]"
  ],
  ...
}
```

Но следует избегать задания ненужных зависимостей. Ненужные зависимости могут замедлить развертывание, мешая параллельному развертыванию независимых между собой ресурсов. Кроме того, возможно образование циклических зависимостей, которые блокируют развертывание. Функция [reference](template-functions-resource.md#reference) и функции [list*](template-functions-resource.md#list) создают неявную зависимость от ссылочного ресурса, когда этот ресурс развертывается в том же шаблоне и ссылается на его имя (а не на идентификатор ресурса). Таким образом можно использовать больше зависимостей, чем задано в свойстве **dependsOn**. Функция [resourceId](template-functions-resource.md#resourceid) не создает неявную зависимость и не проверяет, существует ли ресурс. Функция [reference](template-functions-resource.md#reference) и функции [list*](template-functions-resource.md#list) не создают неявную зависимость, когда ресурс ссылается на свой идентификатор ресурса. Чтобы создать неявную зависимость, передайте имя ресурса, развернутого в том же шаблоне.

При возникновении проблем с зависимостями необходимо узнать, в каком порядке развертываются ресурсы. Вот как можно просмотреть порядок операций развертывания.

1. Выберите журнал развертывания для группы ресурсов.

   ![Выбор журнала развертывания](./media/error-not-found/select-deployment.png)

2. Выберите развертывание в журнале, затем выберите **События**.

   ![Выбор событий развертывания](./media/error-not-found/select-deployment-events.png)

3. Изучите последовательность событий для каждого ресурса. Обратите внимание на состояние каждой операции. Например, на следующем рисунке показаны три учетные записи хранения, которые были развернуты параллельно. Обратите внимание, что эти три учетные записи хранения были запущены одновременно.

   ![Параллельное развертывание](./media/error-not-found/deployment-events-parallel.png)

   На следующем рисунке показаны три учетные записи хранения, которые не были развернуты параллельно. Вторая учетная запись хранения зависит от первой учетной записи хранения, а третья учетная запись хранения — от второй. Первая учетная запись хранения должна быть запущена, принята и завершена, прежде чем будет запущена следующая.

   ![Последовательное развертывание](./media/error-not-found/deployment-events-sequence.png)

## <a name="solution-3---get-external-resource"></a>Решение 3. Получение внешнего ресурса

При развертывании шаблона и необходимости получить ресурс, существующий в другой подписке или группе ресурсов, используйте [функцию resourceId](template-functions-resource.md#resourceid). Эта функция возвращает, чтобы получить полное имя ресурса.

Параметры подписки и группы ресурсов в функции resourceId являются необязательными. Если они не предоставлены, по умолчанию используется текущая подписка и группа ресурсов. При работе с ресурсом в другой группе ресурсов или подписке убедитесь, что эти значения предоставлены.

В следующем примере возвращается идентификатор ресурса для ресурса, который существует в другой группе ресурсов.

```json
"properties": {
  "name": "[parameters('siteName')]",
  "serverFarmId": "[resourceId('plangroup', 'Microsoft.Web/serverfarms', parameters('hostingPlanName'))]"
}
```

## <a name="solution-4---get-managed-identity-from-resource"></a>Решение 4. Получение управляемого удостоверения из ресурса

При развертывании ресурса, который неявно создает [управляемое удостоверение](../../active-directory/managed-identities-azure-resources/overview.md), перед получением значений управляемого удостоверения необходимо дождаться развертывания этого ресурса. Если имя управляемого удостоверения передается в функцию [Reference](template-functions-resource.md#reference) , диспетчер ресурсов пытается разрешить ссылку до развертывания ресурса и удостоверения. Вместо этого передайте имя ресурса, к которому применяется удостоверение. Такой подход гарантирует, что ресурс и управляемое удостоверение будут развернуты до того, как диспетчер ресурсов разрешит функцию Reference.

В функции Reference используйте, `Full` чтобы получить все свойства, включая управляемое удостоверение.

Шаблон:

`"[reference(resourceId(<resource-provider-namespace>, <resource-name>, <API-version>, 'Full').Identity.propertyName]"`

> [!IMPORTANT]
> Не используйте шаблон:
>
> `"[reference(concat(resourceId(<resource-provider-namespace>, <resource-name>),'/providers/Microsoft.ManagedIdentity/Identities/default'),<API-version>).principalId]"`
>
> Шаблон завершится ошибкой.

Например, чтобы получить идентификатор субъекта для управляемого удостоверения, применяемого к виртуальной машине, используйте:

```json
"[reference(resourceId('Microsoft.Compute/virtualMachines', variables('vmName')),'2019-12-01', 'Full').identity.principalId]",
```

Чтобы получить идентификатор клиента для управляемого удостоверения, применяемого к масштабируемому набору виртуальных машин, используйте:

```json
"[reference(resourceId('Microsoft.Compute/virtualMachineScaleSets',  variables('vmNodeType0Name')), 2019-12-01, 'Full').Identity.tenantId]"
```

## <a name="solution-5---check-functions"></a>Решение 5. Проверка функций

При развертывании шаблона найдите выражения, использующие функции [Reference](template-functions-resource.md#reference) или [listKeys](template-functions-resource.md#listkeys) . Заданные значения различаются в зависимости от того, входит ли ресурс в тот же шаблон, группу ресурсов и подписку. Убедитесь, что вы предоставляли необходимые значения параметров для вашего сценария. Если ресурс находится в другой группе ресурсов, укажите идентификатор ресурса. Например, для создания ссылки на учетную запись хранения в другой группе ресурсов, используйте следующую команду:

```json
"[reference(resourceId('exampleResourceGroup', 'Microsoft.Storage/storageAccounts', 'myStorage'), '2017-06-01')]"
```