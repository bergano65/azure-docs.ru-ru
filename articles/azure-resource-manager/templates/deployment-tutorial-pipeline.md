---
title: Непрерывная интеграция с Azure Pipelines
description: Сведения о том, как непрерывно создавать, тестировать и развертывать шаблоны Resource Manager.
ms.date: 08/24/2020
ms.topic: tutorial
ms.author: jgao
ms.openlocfilehash: 8e9f047497f493752947d8115084dcfe86f5e040
ms.sourcegitcommit: d2d1c90ec5218b93abb80b8f3ed49dcf4327f7f4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/16/2020
ms.locfileid: "97588137"
---
# <a name="tutorial-continuous-integration-of-arm-templates-with-azure-pipelines"></a>Руководство по Непрерывная интеграция шаблонов Resource Manager с Azure Pipelines

В [предыдущем учебнике](./deployment-tutorial-linked-template.md) развертывался связанный шаблон.  В этом учебнике описано, как использовать Azure Pipelines для непрерывного создания и развертывания проектов шаблонов Resource Manager.

Azure DevOps предоставляет сервисы для разработчиков, которые помогают рабочим группам планировать работу, совместно разрабатывать код, а также создавать и развертывать приложения. Разработчики могут работать в облаке с помощью Azure DevOps Services. Azure DevOps предоставляет интегрированный набор функций, доступ к которым можно получить через веб-браузер или клиент IDE. Azure Pipeline является одной из таких функций. Azure Pipelines — это полнофункциональная служба непрерывной интеграции (CI) и непрерывной доставки (CD). Она работает с вашим основным провайдером Git и может развертываться в большинстве крупных облачных служб. Затем вы можете автоматизировать сборку, тестирование и развертывание своего кода в Microsoft Azure, Google Cloud Platform или Amazon Web Services.

> [!NOTE]
> Выберите имя проекта. Когда вы изучите руководство, замените любой из **AzureRmPipeline** именем вашего проекта.
> Это имя проекта используется для создания имен ресурсов.  Одним из ресурсов является учетная запись хранения. Имя учетной записи хранения должно содержать от 3 до 24 символов и состоять только из цифр и букв нижнего регистра. Имя должно быть уникальным. В шаблоне имя учетной записи хранения — это имя проекта с добавлением **store**, которое должно содержать от 3 до 11 символов. Поэтому имя проекта должно соответствовать требованиям к имени учетной записи хранения и быть длиной менее 11 символов.

В рамках этого руководства рассматриваются следующие задачи:

> [!div class="checklist"]
> * Подготовка репозитория GitHub
> * Создание проекта Azure DevOps.
> * Создание конвейера Azure
> * Проверка развертывания конвейера
> * Обновление шаблона и повторное развертывание
> * Очистка ресурсов

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этой статьей необходимо иметь следующее.

* **Учетная запись GitHub** — где ее можно использовать для репозитория шаблонов. Если у вас ее нет, вы можете [создать ее бесплатно](https://github.com). Подробнее об использовании репозиториев GitHub см. в статье [Сборка репозиториев GitHub](/azure/devops/pipelines/repos/github).
* **Установка Git**. В этой инструкции руководства используется *Git Bash* или *Git Shell*. Инструкции см. в разделе [Установка Git](https://www.atlassian.com/git/tutorials/install-git).
* **Организация Azure DevOps**. Если у вас ее нет, вы можете создать ее бесплатно. См. статью [Создание организации или коллекции проектов](/azure/devops/organizations/accounts/create-organization?view=azure-devops).
* (Необязательно) **Visual Studio Code с расширением средств Resource Manager**. См. [Краткое руководство. Создание шаблонов ARM с помощью Visual Studio Code](quickstart-create-templates-use-visual-studio-code.md).

## <a name="prepare-a-github-repository"></a>Подготовка репозитория GitHub

GitHub используется для хранения исходного кода вашего проекта, включая шаблоны диспетчера ресурсов. Другие поддерживаемые репозитории доступны в [репозиториях, поддерживаемых Azure DevOps](/azure/devops/pipelines/repos/?view=azure-devops).

### <a name="create-a-github-repository"></a>Создание репозитория GitHub

Если у вас нет учетной записи GitHub, см. раздел [Предварительные требования](#prerequisites).

1. Вход в [GitHub](https://github.com).
1. Выберите в правом верхнем углу изображение своей учетной записи, а затем выберите **Ваши репозитории**.

    ![Диспетчеры ресурсов Azure Resource Manager, Azure DevOps и Azure Pipelines создают репозиторий GitHub](./media/deployment-tutorial-pipeline/azure-resource-manager-devops-pipelines-github-repository.png)

1. Нажмите зеленую кнопку **Новый**.
1. В поле **Имя репозитория** введите имя репозитория.  Например, **AzureRmPipeline-repo**. Не забудьте заменить любой из **AzureRmPipeline** именем вашего проекта. Вы можете выбрать **общедоступный** или **частный** для просмотра этого руководства. Затем выберите **Создать репозиторий**.
1. Введите URL-адрес. URL-адрес репозитория имеет следующий формат: `https://github.com/[YourAccountName]/[YourRepositoryName]` .

Этот репозиторий называется *удаленным репозиторием*. Каждый из разработчиков одного и того же проекта может клонировать свой собственный *локальный репозиторий* и применить изменения к удаленному репозиторию путем слияния.

### <a name="clone-the-remote-repository"></a>Клонирование репозитория

1. Откройте Git Shell или Git Bash. См. раздел [Предварительные требования](#prerequisites).
1. Убедитесь, что вашей текущей папкой является **GitHub**.
1. Выполните следующую команду:

    ```bash
    git clone https://github.com/[YourAccountName]/[YourGitHubRepositoryName]
    cd [YourGitHubRepositoryName]
    mkdir CreateWebApp
    cd CreateWebApp
    pwd
    ```

    Замените `[YourAccountName]` именем своей учетной записи GitHub, а `[YourGitHubRepositoryName]` замените именем своего репозитория, которое вы создали при выполнении предыдущей процедуры.

Папка _CreateWebApp_ —это папка, в которой хранится шаблон. С помощью команды `pwd` отображается путь к папке. Путь — это расположение, в котором будет сохраняться шаблон при выполнении следующей процедуры.

### <a name="download-a-quickstart-template"></a>Загрузите шаблон быстрого запуска

Вместо создания шаблонов можно загрузить их и сохранить в папке _CreateWebApp_.

* Основной шаблон: https://raw.githubusercontent.com/Azure/azure-docs-json-samples/master/get-started-deployment/linked-template/azuredeploy.json.
* Связанный шаблон: https://raw.githubusercontent.com/Azure/azure-docs-json-samples/master/get-started-deployment/linked-template/linkedStorageAccount.json.

Имя папки и имя файла используются так, как они указаны в конвейере. После изменения этих имен необходимо обновить имена, используемые в конвейере.

### <a name="push-the-template-to-the-remote-repository"></a>Отправьте шаблон в удаленный репозиторий

Файл _azuredeploy.json_ добавлен в локальный репозиторий. Затем загрузите шаблон в удаленный репозиторий.

1. Откройте *Git Shell* или *Git Bash*, если он не открыт.
1. Перейдите в папку _CreateWebApp_ в своем локальном репозитории.
1. Убедитесь, что файл _azuredeploy.json_ находится в папке.
1. Выполните следующую команду:

    ```bash
    git add .
    git commit -m "Add web app templates."
    git push origin main
    ```

    Может появиться предупреждение о LF. На него можно не обращать внимания. **Main** — это главная ветвь.  Обычно вы создаете ветвь для каждого обновления. Чтобы упростить работу с руководством, используйте главную ветвь напрямую.

1. Перейдите из браузера в свой репозиторий GitHub. Введите URL-адрес `https://github.com/[YourAccountName]/[YourGitHubRepository]`. Вы увидите папку _CreateWebApp_ с тремя файлами в ней.
1. Выберите _linkedStorageAccount.json_, чтобы открыть шаблон.
1. Нажмите кнопку **Raw**. URL-адрес начинается с `https://raw.githubusercontent.com`.
1. Скопируйте URL-адрес. Это значение необходимо указать при настройке конвейера далее в этом учебнике.

Вы создали репозиторий GitHub и загрузили в него шаблоны.

## <a name="create-a-devops-project"></a>Создание проекта DevOps

Организация DevOps необходима, прежде чем вы сможете перейти к выполнению следующей процедуры. Если у вас ее нет, см. раздел [Предварительные требования](#prerequisites).

1. Вход в [Azure DevOps](https://dev.azure.com).
1. Выберите организацию DevOps слева.

    ![Azure Resource Manager, Azure DevOps и Azure Pipelines создают проект Azure DevOps](./media/deployment-tutorial-pipeline/azure-resource-manager-devops-pipelines-create-devops-project.png)

1. Выберите **Создать проект**. Если у вас нет проектов, страница создания проекта откроется автоматически.
1. Введите следующие значения.

    * **Имя проекта**: введите имя проекта. Вы можете использовать имя проекта, которое вы выбрали в самом начале руководства.
    * **Управление версиями**: Выберите **Git**. Вам может потребоваться развернуть **Расширенный**, чтобы ознакомиться с **Управлением версиями**.

    Для других свойств используйте значения по умолчанию.
1. Нажмите кнопку **создания**.

Создайте подключение к службе, которое используется для развертывания проектов в Azure.

1. Выберите **Параметры проекта** в нижней части левого меню.
1. Выберите **Подключения к службе** в **Pipelines**.
1. Щелкните **Новое подключение к службе**, затем — **Azure Resource Manager** и нажмите кнопку **Далее**.
1. Щелкните **Субъект-служба**, а затем нажмите кнопку **Далее**.
1. Введите следующие значения.

    * **Уровень области**: выбор **Подписки**.
    * **Подписка**: выберите свою подписку.
    * **Группа ресурсов**. Оставьте пустым.
    * **Имя подключения**: ввод имени подключения. Например, **AzureRmPipeline-conn**. Запишите это имя, оно вам понадобится при создании конвейера.
    * **Предоставить разрешение на доступ для всех конвейеров** (выбрано)
1. Щелкните **Сохранить**.

## <a name="create-a-pipeline"></a>Создание конвейера

До этого момента мы выполнили следующие задачи.  Если вы пропустили предыдущие разделы, потому что уже работали с GitHub и DevOps, перед продолжением необходимо выполнить следующие задачи.

* Создайте репозиторий GitHub и сохраните шаблоны в папке _CreateWebApp_ в репозитории.
* Создайте проект DevOps и создайте подключение службы Azure Resource Manager.

Чтобы создать конвейер с шагом для развертывания шаблона:

1. Выберите **Pipelines** в меню слева.
1. Выберите **Создание конвейера**.
1. На вкладке **Подключить** выберите **GitHub**. Если потребуется, введите учетные данные GitHub, а затем следуйте инструкциям. Если вы видите следующий экран, выберите **Выбрать только репозитории** и убедитесь, что ваш репозиторий находится в списке, прежде чем выбрать **Утвердить и установить**.

    ![Azure Resource Manager, Azure DevOps, Azure Pipelines выбирают только репозитории](./media/deployment-tutorial-pipeline/azure-resource-manager-devops-pipelines-only-select-repositories.png)

1. На вкладке **Выбрать** выберите свой репозиторий. По умолчанию используется имя `[YourAccountName]/[YourGitHubRepositoryName]`.
1. На вкладке **Настроить** выберите **Простейший конвейер**. Он отобразит файл конвейера _azure-pipelines.yml_ в два этапа с помощью сценария.
1. Удалите два шага скрипта из _YML_-файла.
1. Переместите курсор в строку после **steps:** .
1. Щелкните **Показать помощника** в правой части экрана, чтобы открыть область **Задачи**.
1. Выберите **ARM template deployment** (Развертывание шаблона Resource Manager).
1. Введите следующие значения.

    * **deploymentScope**: Щелкните **Группа ресурсов**. Дополнительные сведения об областях см. в разделе [Области развертывания](deploy-rest.md#deployment-scope).
    * **Azure Resource Manager connection** (Подключение Azure Resource Manager): выберите имя подключения службы, созданного ранее.
    * **Подписка**:  укажите идентификатор целевой подписки.
    * **Action** (Действие). Выберите значение 1, но учтите, что действие **Create Or Update Resource Group** (Создание и изменение группы ресурсов) выполняет 2 действия. создает группу ресурсов, если указано новое имя группы ресурсов; 2. развертывает указанный шаблон;
    * **Группа ресурсов.** Введите имя новой группы ресурсов. Например, **AzureRmPipeline-rg**;
    * **Расположение.** Выберите расположение группы ресурсов, например **Центральная часть США**.
    * **Расположение шаблона**: выберите **связанный артефакт** — задача ищет файл шаблона напрямую в подключенном репозитории.
    * **Шаблон**: введите _CreateWebApp/azuredeploy.json_. Если вы изменили имя папки и имя файла, это значение необходимо изменить.
    * **Параметры шаблона**: оставьте это поле пустым. Вы укажете значения параметров в поле **Переопределить параметры шаблона**.
    * **Переопределить параметры шаблона**: введите `-projectName [EnterAProjectName] -linkedTemplateUri [EnterTheLinkedTemplateURL]` . Замените имя проекта и URL-адрес связанного шаблона. URL-адрес связанного шаблона вы записали в конце подраздела [Создать репозиторий GitHub](#create-a-github-repository). Он начинается с `https://raw.githubusercontent.com` .
    * **Deployment mode** (Режим развертывания): выберите значение **Добавочный**.
    * **Deployment name** (Имя развертывания): введите **DeployPipelineTemplate**. Чтобы можно было увидеть **Имя развертывания**, нажмите кнопку **Advanced** (Дополнительно).

    ![Снимок экрана: страница развертывания шаблона Resource Manager, где указаны требуемые значения](./media/deployment-tutorial-pipeline/resource-manager-template-pipeline-configure.png)

1. Выберите **Добавить**.

    Дополнительные сведения о задаче см. в статьях [Azure Resource Group Deployment task](/azure/devops/pipelines/tasks/deploy/azure-resource-group-deployment) (Задача развертывания группы ресурсов Azure) и [Azure Resource Manager template deployment task](https://github.com/microsoft/azure-pipelines-tasks/blob/master/Tasks/AzureResourceManagerTemplateDeploymentV3/README.md) (Задача развертывания шаблона Azure Resource Manager).

    _YML_-файл должен иметь следующий вид:

    ![Снимок экрана: страница проверки нового конвейера с заголовком "Просмотр YAML конвейера"](./media/deployment-tutorial-pipeline/azure-resource-manager-devops-pipelines-yml.png)

1. Выберите **Сохранить и запустить**.
1. В области **Save and run** (Сохранить и запустить) щелкните **Save and run** (Сохранить и запустить) еще раз. Копия файла YAML сохраняется в подключенном хранилище. Вы можете увидеть файл YAML, перейдя в свой репозиторий.
1. Убедитесь, что конвейер успешно выполнен.

    ![YAML Azure Resource Manager, Azure DevOps, Azure Pipelines](./media/deployment-tutorial-pipeline/azure-resource-manager-devops-pipelines-status.png)

## <a name="verify-the-deployment"></a>Проверка развертывания

1. Войдите на [портал Azure](https://portal.azure.com).
1. Откройте группу ресурсов. Имя — это то, что вы указали в файле YAML конвейера. Вы ознакомитесь с одной созданной учетной записью хранения. Имя учетной записи хранения начинается с **store**.
1. Выберите имя учетной записи хранения, чтобы открыть ее.
1. Выберите **Свойства**. В поле **Репликация** должно быть указано **Локально избыточное хранилище (LRS)** .

## <a name="update-and-redeploy"></a>Обновление и повторное развертывание

При обновлении шаблона и отправке изменений в удаленный репозиторий, конвейер автоматически обновляет ресурсы, в данном случае учетную запись хранения.

1. Откройте _linkedStorageAccount.json_ из локального репозитория в Visual Studio Code или любом текстовом редакторе.
1. Обновите **defaultValue** из **storageAccountType** до **Standard_GRS**. Экран должен выглядеть так:

    ![YAML обновление Azure Resource Manager, Azure DevOps, Azure Pipelines](./media/deployment-tutorial-pipeline/azure-resource-manager-devops-pipelines-update-yml.png)

1. Сохраните изменения.
1. Отправьте изменения в удаленный репозиторий, выполнив следующие команды из Git Bash/Shell.

    ```bash
    git pull origin main
    git add .
    git commit -m "Update the storage account type."
    git push origin main
    ```

    Первая команда (`pull`) синхронизирует локальный репозиторий с удаленным репозиторием. YAML-файл конвейера добавлен только в удаленный репозиторий. При выполнении команды `pull` в локальную ветвь загружается копия YAML-файла.

    Четвертая команда (`push`) передает измененный файл _linkedStorageAccount.json_ в удаленный репозиторий. После обновления главной ветви удаленного репозитория конвейер снова запустится.

Чтобы проверить изменения, можно проверить свойство "Репликация" учетной записи хранения. См. раздел [Проверка развертывания](#verify-the-deployment).

## <a name="clean-up-resources"></a>Очистка ресурсов

Если ресурсы Azure больше не нужны, их можно удалить. Для этого необходимо удалить группу ресурсов.

1. На портале Azure в меню слева выберите **Группа ресурсов**.
2. В поле **Фильтровать по имени** введите имя группы ресурсов.
3. Выберите имя группы ресурсов.
4. В главном меню выберите **Удалить группу ресурсов**.

Кроме того, также можно удалить репозиторий GitHub и проект DevOps Azure.

## <a name="next-steps"></a>Дальнейшие действия

Поздравляем, вы завершили работу с учебником по развертыванию шаблона Resource Manager. Оставьте комментарии и предложения для нас в разделе отзывов. Спасибо!
Вы можете перейти к более сложным понятиям шаблонов. В следующем учебнике подробно рассматривается использование справочной документации по шаблонам для определения развертываемых ресурсов.

> [!div class="nextstepaction"]
> [Руководство. Создание шаблона Azure Resource Manager для развертывания зашифрованной учетной записи хранения](./template-tutorial-use-template-reference.md)
