---
title: Cloud Shell в виртуальной сети Azure
description: Развертывание Cloud Shell в виртуальной сети Azure
services: Azure
documentationcenter: ''
author: maertendMSFT
manager: timlt
tags: azure-resource-manager
ms.assetid: ''
ms.service: azure
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: na
ms.topic: article
ms.date: 07/15/2020
ms.author: damaerte
ms.openlocfilehash: 722d935c242a51ddfc01377676f026b71a8951b8
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "89468544"
---
# <a name="deploy-cloud-shell-into-an-azure-virtual-network"></a>Развертывание Cloud Shell в виртуальной сети Azure
> [!NOTE]
> Эта функция доступна в общедоступной предварительной версии.

Обычный сеанс Cloud Shell выполняется в контейнере в сети Microsoft, отдельно от ваших ресурсов. Это означает, что команды, выполняемые в контейнере, не могут получить доступ к ресурсам, доступ к которым возможен только из определенной виртуальной сети. Например, вы не можете использовать SSH для подключения из Cloud Shell к виртуальной машине, имеющей только частный IP-адрес, или использовать kubectl для подключения к кластеру Kubernetes, который заблокировал доступ. 

Эта дополнительная функция устраняет эти ограничения и позволяет развертывать Cloud Shell в виртуальной сети Azure, которыми вы управляете. После этого контейнер может взаимодействовать с ресурсами в виртуальной сети, которую вы выбрали.  

Ниже можно увидеть архитектуру ресурсов, которая будет развернута и использована в этом сценарии.

![Иллюстрирует архитектуру Cloud Shell изолированной виртуальной сети.](media/private-vnet/data-diagram.png)

Прежде чем вы сможете использовать Cloud Shell в своей виртуальной сети Azure, вам потребуется создать несколько ресурсов для поддержки этой функции. В этой статье показано, как настроить необходимые ресурсы с помощью шаблона ARM.

> [!NOTE]
> Эти ресурсы необходимо настроить только один раз для виртуальной сети. Затем они могут совместно использоваться всеми администраторами с доступом к виртуальной сети.

## <a name="required-network-resources"></a>Необходимые сетевые ресурсы

### <a name="virtual-network"></a>Виртуальная сеть
Виртуальная сеть определяет адресное пространство, в котором создается одна или несколько подсетей.

Необходимо определить нужную виртуальную сеть, используемую для Cloud Shell. Обычно это существующая виртуальная сеть, содержащая ресурсы, которыми вы хотите управлять, или сеть, которая является одноранговыми с сетями, содержащими ваши ресурсы.

### <a name="subnet"></a>Подсеть
В выбранной виртуальной сети для контейнеров Cloud Shell необходимо использовать выделенную подсеть. Эта подсеть делегируется службе "экземпляры контейнеров Azure" (ACI).  Когда пользователь запрашивает контейнер Cloud Shell в виртуальной сети, Cloud Shell использует ACI для создания контейнера, который находится в этой делегированной подсети.  В этой подсети нельзя создавать другие ресурсы.

### <a name="network-profile"></a>сетевой профиль.
Сетевой профиль — это шаблон конфигурации сети для ресурсов Azure, указывающий определенные свойства сети для ресурса.

### <a name="azure-relay"></a>Ретранслятор Azure
[Azure Relay](../azure-relay/relay-what-is-it.md) позволяет двум конечным точкам, которые напрямую недоступны для обмена данными. В этом случае он используется, чтобы разрешить браузеру администратора взаимодействовать с контейнером в частной сети.

Azure Relay экземпляр, используемый для Cloud Shell, можно настроить для управления тем, какие сети могут получать доступ к ресурсам контейнера. 
- Доступ из общедоступной сети Интернет. в этой конфигурации Cloud Shell предоставляет способ доступа к внутренним ресурсам извне. 
- Доступен из указанных сетей. в этой конфигурации администраторам необходимо получить доступ к портал Azure с компьютера, работающего в соответствующей сети, чтобы иметь возможность использовать Cloud Shell.

## <a name="storage-requirements"></a>Требования к системе хранения данных
Как и в случае со стандартными Cloud Shell, учетная запись хранения необходима при использовании Cloud Shell в виртуальной сети. Каждому администратору требуется файловый ресурс для хранения файлов.  Учетная запись хранения должна быть доступна из виртуальной сети, используемой Cloud Shell. 

## <a name="virtual-network-deployment-limitations"></a>Ограничение развертывания в виртуальной сети
* Из-за дополнительных сетевых ресурсов запуск Cloud Shell в виртуальной сети обычно медленнее, чем стандартный сеанс Cloud Shell.

* В течение предварительной версии для Cloud Shell в виртуальной сети поддерживается меньшее количество регионов. В настоящее время это ограничено: WestUS и WestCentralUS.

* [Azure Relay](../azure-relay/relay-what-is-it.md) не является бесплатной службой, ознакомьтесь с их [ценами](https://azure.microsoft.com/pricing/details/service-bus/). В Cloud Shell сценарии для каждого администратора используется одно гибридное подключение, которое используется Cloud Shell. После завершения сеанса Cloud Shell подключение будет автоматически остановлено.

## <a name="register-the-resource-provider"></a>Регистрация поставщика ресурсов

Поставщик ресурсов Microsoft. Контаинеринстанцес должен быть зарегистрирован в подписке, которая содержит виртуальную сеть, которую вы хотите использовать. Выберите подходящую подписку с `Set-AzContext -Subscription {subscriptionName}` , а затем выполните команду:

```powershell
PS> Get-AzResourceProvider -ProviderNamespace Microsoft.ContainerInstance | select ResourceTypes,RegistrationState

ResourceTypes                             RegistrationState
-------------                             -----------------
{containerGroups}                         Registered
...
```

Если **RegistrationState** имеет значение `Registered` , никаких действий не требуется. Если это так `NotRegistered` , выполните команду `Register-AzResourceProvider -ProviderNamespace Microsoft.ContainerInstance` . 

## <a name="deploy-network-resources"></a>Развертывание сетевых ресурсов
 
### <a name="create-a-resource-group-and-virtual-network"></a>Создание группы ресурсов и виртуальной сети
Если у вас уже есть нужная виртуальная сеть, к которой вы хотите подключиться, пропустите этот раздел.

В портал Azure или с помощью Azure CLI, Azure PowerShell и т. д. Создайте группу ресурсов и виртуальную сеть в новой группе ресурсов, **Группа ресурсов и виртуальная сеть должны находиться в одном регионе**.

> [!NOTE]
> В общедоступной предварительной версии группа ресурсов и виртуальная сеть должны находиться либо в WestCentralUS, либо в WestUS.

### <a name="arm-templates"></a>Шаблоны ARM
Используйте шаблон быстрого запуска [Azure](https://aka.ms/cloudshell/docs/vnet/template) для создания ресурсов Cloud Shell в виртуальной сети, а также шаблон быстрого запуска [Azure](https://aka.ms/cloudshell/docs/vnet/template/storage) для создания необходимого хранилища. Запишите имена ресурсов, в первую очередь, имя общей папки.

### <a name="open-relay-firewall"></a>Открыть брандмауэр ретранслятора
Перейдите к ретранслятору, созданному с помощью указанного выше шаблона, выберите "сети" в параметрах, разрешите доступ из сети браузера к ретранслятору. По умолчанию ретранслятор доступен только из виртуальной сети, в которой он был создан. 

### <a name="configuring-cloud-shell-to-use-a-virtual-network"></a>Настройка Cloud Shell для использования виртуальной сети.
> [!NOTE]
> Этот шаг необходимо выполнить для каждого администратора, который будет использовать Cloud Shell.

После развертывания выполните указанные выше действия, перейдя по адресу Cloud Shell в портал Azure или в https://shell.azure.com . Один из этих функций должен использоваться каждый раз, когда необходимо подключиться к изолированной Cloud Shell.

> [!NOTE]
> Если Cloud Shell использовался в прошлом, существующие clouddrive должны быть отключены. Чтобы выполнить это действие `clouddrive unmount` из активного сеанса Cloud Shell, обновите страницу.

Подключитесь к Cloud Shell. вам будет предложено выполнить первую процедуру запуска. Выберите предпочтительный интерфейс оболочки, щелкните "отобразить дополнительные параметры" и установите флажок "Показывать параметры изоляции виртуальной сети". Заполните поля во всплывающем окне.  Большинство полей будут заполнены доступными ресурсами, которые могут быть связаны с Cloud Shell в виртуальной сети.  Имя общей папки необходимо заполнить пользователем.


![Демонстрирует параметры первого интерфейса Cloud Shell изолированной виртуальной сети.](media/private-vnet/vnet-settings.png)

## <a name="next-steps"></a>Дальнейшие шаги
[Дополнительные сведения о виртуальных сетях Azure](../virtual-network/virtual-networks-overview.md)