---
title: Защита новых ресурсов с помощью блокировок ресурсов схемы
description: Сведения о том, как использовать блокировки ресурсов Azure Blueprints "Только для чтения" и "Не удалять" для защиты только что развернутых ресурсов.
services: blueprints
author: DCtheGeek
ms.author: dacoulte
ms.date: 03/28/2019
ms.topic: tutorial
ms.service: blueprints
manager: carmonm
ms.openlocfilehash: f39d59ef7ab3f555637aef69b301a0e77c00fc24
ms.sourcegitcommit: 956749f17569a55bcafba95aef9abcbb345eb929
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2019
ms.locfileid: "58629219"
---
# <a name="protect-new-resources-with-azure-blueprints-resource-locks"></a>Защита новых ресурсов с помощью блокировок ресурсов Azure Blueprints

[Блокировки ресурсов](../concepts/resource-locking.md) Azure Blueprints позволяют защитить новые развернутые ресурсы от незаконного изменения даже под управлением учетной записи с ролью _Владелец_. Такую защиту можно добавить к ресурсам, созданным с помощью артефакта шаблона Resource Manager в определении схемы.

В этой статье рассматриваются следующие этапы:

> [!div class="checklist"]
> - создание определения схемы;
> - установка определению схемы метки **Опубликовано**;
> - назначение определения схемы в существующую подписку;
> - проверка новой группы ресурсов;
> - отмена назначения схемы для удаления блокировок.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством вам потребуется подписка Azure. Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/), прежде чем начинать работу.

## <a name="create-new-blueprint-definition"></a>Создание определения схемы

Сначала создайте определение схемы.

1. Выберите **Все службы** в левой области. Найдите и выберите пункт **Схемы**.

1. На странице **Начало работы** с левой стороны в разделе _Создание схемы_ щелкните кнопку **Создать**.

1. В верхней части страницы найдите пример схемы **пустого образца** и выберите **Начать с пустой схемы**.

1. Введите _основные данные_ образца схемы.

   - **Имя схемы**. Укажите имя для копии образца схемы. В этом руководстве мы будем использовать имя _locked-storageaccount_.
   - **Описание схемы**. Описание определения схемы. Например: "Для проверки блокировки ресурса схемы на развернутых ресурсах".
   - **Расположение определения**. Щелкните кнопку с многоточием и выберите группу управления или подписку, в которую будет сохранено определение схемы.

1. В верхней части страницы выберите вкладку _Артефакты_ или внизу страницы щелкните **Далее: Артефакты**.

1. Добавьте группу ресурсов в подписку. Выберите строку **+ Добавить артефакт...** в разделе **Подписка**.
   Выберите "Группа ресурсов" для _Типа артефакта_. Для _отображаемого имени артефакта_ задайте значение **RGtoLock**.
   Оставьте поля _Имя группы ресурсов_ и _Расположение_ пустыми, но убедитесь, что установлен флажок для каждого свойства, чтобы сделать их **динамическими параметрами**. Нажмите кнопку **Добавить**, чтобы добавить артефакт в схему.

1. Добавьте шаблон в группу ресурсов. Выберите строку **+ Добавить артефакт...** под записью **RGtoLock**. Выберите "Шаблон Azure Resource Manager" для _Типа артефакта_, задайте _Отображаемое имя артефакта_ как "Учетная запись хранения" и оставьте _Описание_ пустым. На вкладке **Шаблон** в окне редактора вставьте следующий шаблон Resource Manager. Вставив шаблон, щелкните **Добавить**, чтобы добавить этот артефакт к схеме.

   ```json
   {
       "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
       "contentVersion": "1.0.0.0",
       "parameters": {
           "storageAccountType": {
               "type": "string",
               "defaultValue": "Standard_LRS",
               "allowedValues": [
                   "Standard_LRS",
                   "Standard_GRS",
                   "Standard_ZRS",
                   "Premium_LRS"
               ],
               "metadata": {
                   "description": "Storage Account type"
               }
           }
       },
       "variables": {
           "storageAccountName": "[concat('store', uniquestring(resourceGroup().id))]"
       },
       "resources": [{
           "type": "Microsoft.Storage/storageAccounts",
           "name": "[variables('storageAccountName')]",
           "location": "[resourceGroup().location]",
           "apiVersion": "2018-07-01",
           "sku": {
               "name": "[parameters('storageAccountType')]"
           },
           "kind": "StorageV2",
           "properties": {}
       }],
       "outputs": {
           "storageAccountName": {
               "type": "string",
               "value": "[variables('storageAccountName')]"
           }
       }
   }
   ```

1. В нижней части страницы нажмите **Сохранить черновик**.

На этом шаге в выбранной группе управления или подписке создается определение схемы.

Когда появится уведомление портала **Определение схемы успешно сохранено**, перейдите к следующему шагу.

## <a name="publish-the-blueprint-definition"></a>Публикация определения схемы

Теперь в вашей среде создано определение схемы. Оно создано в режиме **Черновик**, и прежде чем назначить и развернуть это определение, его необходимо **опубликовать**.

1. Выберите **Все службы** в левой области. Найдите и выберите пункт **Схемы**.

1. В меню слева выберите страницу **Определения схем**. Используйте фильтры, чтобы найти определение схемы _locked-storageaccount_, и выберите его.

1. В верхней части страницы выберите **Опубликовать схему**. В новой панели с правой стороны задайте **версии** значение _1.0_. Это свойство позволяет вносить изменения позднее. Укажите **Сведения об изменениях**, например "Опубликована первая версия для блокировки ресурсов, развернутых в схеме". Затем щелкните **Опубликовать** в нижней части страницы.

На этом шаге можно назначить схему подписке. Вносить изменения можно и после публикации. Дополнительные изменения необходимо опубликовать с новым значением параметра **Версия**, чтобы отслеживать различия между разными версиями одного определения схемы.

Когда появится уведомление портала **Определение схемы опубликовано**, перейдите к следующему шагу.

## <a name="assign-the-blueprint-definition"></a>Назначение определения схемы

После успешной **публикации** определение схемы можно назначить подписке в группе управления, в которой его сохранили. На этом шаге указываются параметры, которые позволяют сделать каждое развертывание определения схемы уникальным.

1. Выберите **Все службы** в левой области. Найдите и выберите пункт **Схемы**.

1. В меню слева выберите страницу **Определения схем**. Используйте фильтры, чтобы найти определение схемы _locked-storageaccount_, и выберите его.

1. В верхней части страницы определения схемы выберите **Назначить схему**.

1. Укажите значения параметра для назначения схемы.

   - Основы

     - **Подписки**. Выберите одну или несколько подписок, которые находятся в группе управления, в которой вы сохранили определение схемы. Если вы выберите более одной подписки, для каждой из них будет создано назначение с использованием введенных параметров.
     - **Имя назначения.** Имя предварительно заполняется на основе имени определения схемы. Так как мы хотим, чтобы это назначение представляло блокировку новой группы ресурсов, измените его имя на _assignment-locked-storageaccount-TestingBPLocks_.
     - **Расположение.** Выберите регион, в котором будет создано управляемое удостоверение. Azure Blueprint использует это управляемое удостоверение для развертывания всех артефактов в назначенную схему. Дополнительные сведения см. в статье [Управляемые удостоверения для ресурсов Azure](../../../active-directory/managed-identities-azure-resources/overview.md).
       Для этого руководства выберите регион _Восточная часть США 2_.
     - **Версия определения схемы**. Выберите **опубликованную** версию _1.0_ определения схемы.

   - Блокировка назначения

     Выберите режим блокировки схемы _Только для чтения_. Дополнительные сведения см. в разделе [Блокировка ресурсов схем](../concepts/resource-locking.md).

   - Управляемое удостоверение

     Оставьте параметр по умолчанию _Назначено системой_. Дополнительные сведения см. в статье [Что такое управляемые удостоверения для ресурсов Azure?](../../../active-directory/managed-identities-azure-resources/overview.md)

   - Параметры артефакта

     Параметры, определенные в этом разделе, применяются к артефакту, под которым они определены. Поскольку эти параметры определяются во время назначения схемы, они являются [динамическими](../concepts/parameters.md#dynamic-parameters). Для каждого артефакта задайте значение параметра, определенное в столбце **Значение**.

     |Имя артефакта|Тип артефакта|Имя параметра|Значение|ОПИСАНИЕ|
     |-|-|-|-|-|
     |Группа ресурсов RGtoLock|Группа ресурсов|ИМЯ|TestingBPLocks|Определяет имя новой группы ресурсов, к которой необходимо применить блокировки схемы.|
     |Группа ресурсов RGtoLock|Группа ресурсов|Расположение|Западный регион США 2|Определяет расположение новой группы ресурсов, к которой необходимо применить блокировки схемы.|
     |StorageAccount|Шаблон Resource Manager|storageAccountType (StorageAccount)|Standard_GRS|Выберите номер SKU хранилища. Значение по умолчанию — _Standard_LRS_.|

1. После ввода всех параметров в нижней части страницы выберите **Назначить**.

На этом шаге происходит развертывание определенных ресурсов и настройка выбранного **назначения блокировки**. Для применения блокировок схемы понадобится до 30 минут.

Когда появится уведомление портала **Определение схемы назначено**, перейдите к следующему шагу.

## <a name="inspect-resources-deployed-by-the-assignment"></a>Просмотр ресурсов, развернутых назначением

Благодаря назначению были созданы группа ресурсов _TestingBPLocks_ и учетная запись хранения, развернутая артефактом шаблона Resource Manager. Новая группа ресурсов и выбранное состояние блокировки отображаются на странице сведений о назначении.

1. Выберите **Все службы** в левой области. Найдите и выберите пункт **Схемы**.

1. Слева выберите страницу **Назначенные схемы**. С помощью фильтров найдите назначение схемы _assignment-locked-storageaccount-TestingBPLocks_ и выберите его.

   На этой странице можно убедиться, что назначение прошло успешно, а ресурсы развернуты с новым состоянием блокировки схемы. При обновлении назначения в раскрывающемся списке **Операция назначения** отображаются сведения о развертывании каждой версии определения. Чтобы открыть непосредственно страницу свойств, щелкните группу ресурсов.

1. Выберите группу ресурсов **TestingBPLocks**.

1. В меню слева выберите страницу **Управление доступом (IAM)** и перейдите на вкладку **Назначения ролей**.

   Поскольку назначение схемы _assignment-locked-storageaccount-TestingBPLocks_ использовалось для развертывания и блокировки группы ресурсов, здесь оно имеет роль _Владелец_.

1. Выберите вкладку **Запрет назначений**.

   В развернутой группе ресурсов назначение схемы создало [запрет назначения](../../../role-based-access-control/deny-assignments.md), чтобы принудительно применить режим блокировки схемы _Только для чтения_. Запрет назначения не дает пользователю с соответствующими правами выполнять определенные действия на вкладке _Назначения ролей_. Запрет назначения влияет на _все субъекты_.

   Сведения об исключении субъекта из запрета назначения см. в статье о [блокировке ресурсов схемы](../concepts/resource-locking.md#exclude-a-principal-from-a-deny-assignment).

1. Выберите запрет назначения, а затем перейдите на страницу **Отклоненные разрешения** слева.

   Запрет назначения блокирует все операции с конфигурацией **\*** и **Действие**, но разрешает доступ на чтение, исключая **\*/read** через **NotActions**.

1. В элементе навигации портала Azure выберите **TestingBPLocks — Управление доступом (IAM)**. Затем в левом меню перейдите на страницу **Обзор** и щелкните кнопку **Удалить группу ресурсов**. Чтобы подтвердить удаление, введите имя _TestingBPLocks_ и в нижней части панели выберите **Удалить**.

   Отобразится уведомление портала **Удаление группы ресурсов TestingBPLocks завершилось сбоем**. Ошибка указывает на то, что хоть в вашей учетной записи есть разрешение на удаление группы ресурсов, назначение схемы запрещает доступ к ней. Помните, что при назначении схемы мы выбрали режим блокировки схемы _Только для чтения_. Блокировка схемы предотвращает удаление ресурсов учетной записью с разрешением (даже с ролью _Владелец_). Дополнительные сведения см. в разделе [Блокировка ресурсов схем](../concepts/resource-locking.md).

Согласно этим действиям, теперь развернутые ресурсы защищены с помощью блокировок схемы, которые не допускают нежелательное удаление, даже из учетной записи с разрешением.

## <a name="unassign-the-blueprint"></a>Отмена назначения схемы

Последнее, что нужно сделать, — это удалить назначение определения схемы. Удаление назначения не удаляет затронутые артефакты.

1. Выберите **Все службы** в левой области. Найдите и выберите пункт **Схемы**.

1. Слева выберите страницу **Назначенные схемы**. С помощью фильтров найдите назначение схемы _assignment-locked-storageaccount-TestingBPLocks_ и выберите его.

1. В верхней части страницы нажмите кнопку **Отменить назначение схемы**. Прочтите предупреждение в диалоговом окне подтверждения, а затем щелкните **ОК**.

   Блокировки схемы удаляются вместе с назначением схемы. Удаление созданных ресурсов из учетных записей с разрешениями снова возможно.

1. В меню Azure выберите **Группы ресурсов**, а затем щелкните **TestingBPLocks**.

1. В меню слева выберите страницу **Управление доступом (IAM)** и перейдите на вкладку **Назначения ролей**.

Безопасность группы ресурсов указывает, что в назначении схемы больше нет доступа уровня _Владелец_.

Когда появится уведомление портала **Назначение схемы удалено**, перейдите к следующему шагу.

## <a name="clean-up-resources"></a>Очистка ресурсов

После работы с этим руководством удалите следующие ресурсы:

- группу ресурсов _TestingBPLocks_;
- определение схемы _locked-storageaccount_.

## <a name="next-steps"></a>Дополнительная информация

- Ознакомьтесь с [жизненным циклом схемы](../concepts/lifecycle.md).
- Узнайте, как использовать [статические и динамические параметры](../concepts/parameters.md).
- Узнайте, как применять [блокировку ресурсов схемы](../concepts/resource-locking.md).
- Научитесь настраивать [последовательность схемы](../concepts/sequencing-order.md).
- Узнайте, как [обновлять существующие назначения](../how-to/update-existing-assignments.md).
- Устраняйте проблемы, возникающие во время назначения схемы, с помощью [общих инструкций по устранению неполадок](../troubleshoot/general.md).