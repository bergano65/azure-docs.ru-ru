---
title: Сведения о порядке последовательности развертывания
description: Узнайте о порядке по умолчанию, в котором развертываются артефакты схемы во время назначения схемы и настройки порядка развертывания.
ms.date: 08/27/2020
ms.topic: conceptual
ms.openlocfilehash: 8305e5d44caef0f35e5b4beb4b70be9736272fa7
ms.sourcegitcommit: a43a59e44c14d349d597c3d2fd2bc779989c71d7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/25/2020
ms.locfileid: "95996055"
---
# <a name="understand-the-deployment-sequence-in-azure-blueprints"></a>Сведения о последовательности развертывания в Azure Blueprint

В схемах Azure используется **порядок последовательности** для определения порядка создания ресурсов при обработке назначения определения схемы. В этой статье объясняются следующие концепции:

- используемый порядок последовательности по умолчанию;
- настройка порядка;
- обработка настроенного порядка.

В примерах кода JSON есть переменные, значения которых необходимо заменить на ваши собственные значения:

- `{YourMG}` — замените это значение именем своей группы управления.

## <a name="default-sequencing-order"></a>Порядок последовательности по умолчанию

Если определение схемы не содержит директивы для порядка развертывания артефактов или если директива имеет значение null, используется следующий порядок:

- Артефакты **назначения ролей** уровня подписки сортируются по имени артефакта
- Артефакты **назначения политик** уровня подписки сортируются по имени артефакта
- **Шаблон Azure Resource Manager** уровня подписки (шаблоны ARM) артефакты, отсортированные по имени артефакта
- Артефакты **группы ресурсов** (включая дочерние артефакты) сортируются по имени заполнителя

Для каждого артефакта **группы ресурсов** при создании артефактов в этой группе ресурсов используется следующий порядок последовательности:

- Дочерние артефакты **назначения ролей** группы ресурсов сортируются по имени артефакта
- Дочерние артефакты **назначения политик** группы ресурсов сортируются по имени артефакта
- Дочерний **шаблон Azure Resource Manager** группы ресурсов (шаблоны ARM), отсортированные по имени артефакта

> [!NOTE]
> Использование [артефактов ()](../reference/blueprint-functions.md#artifacts) создает неявную зависимость от артефакта, на который указывает ссылка.

## <a name="customizing-the-sequencing-order"></a>Изменение порядка последовательности

При составлении крупных определений схем может потребоваться создать ресурсы в определенном порядке. Наиболее распространенным шаблоном использования этого сценария является ситуация, когда определение схемы включает несколько шаблонов ARM. Схемы Azure обрабатывают этот шаблон, позволяя определять порядок последовательности.

Для определения порядка в коде JSON определяется свойство `dependsOn`. Это свойство поддерживается определением схемы, для групп ресурсов и объектов артефактов. `dependsOn` представляет собой массив строк имен артефактов, которые необходимо создать перед созданием указанного артефакта.

> [!NOTE]
> При создании объектов схемы каждый ресурс артефакта получает свое имя из имени файла, если используется [PowerShell](/powershell/module/az.blueprint/new-azblueprintartifact)или конечная точка URL, если используется [REST API](/rest/api/blueprints/artifacts/createorupdate). ссылки _resourceGroup_ в артефактах должны соответствовать указанным в определении схемы.

### <a name="example---ordered-resource-group"></a>Пример упорядоченной группы ресурсов

В этом примере определения схемы имеется группа ресурсов, которая определила пользовательский порядок последовательности, объявляя значение для `dependsOn` , а также группу стандартных ресурсов. В этом случае артефакт **assignPolicyTags** будет обрабатываться до группы ресурсов **ordered-rg**.
**standard-rg** будет обрабатываться в соответствии с порядком последовательности по умолчанию.

```json
{
    "properties": {
        "description": "Example blueprint with custom sequencing order",
        "resourceGroups": {
            "ordered-rg": {
                "dependsOn": [
                    "assignPolicyTags"
                ],
                "metadata": {
                    "description": "Resource Group that waits for 'assignPolicyTags' creation"
                }
            },
            "standard-rg": {
                "metadata": {
                    "description": "Resource Group that follows the standard sequence ordering"
                }
            }
        },
        "targetScope": "subscription"
    },
    "type": "Microsoft.Blueprint/blueprints"
}
```

### <a name="example---artifact-with-custom-order"></a>Пример: артефакт с пользовательским порядком последовательности

Этот пример является артефактом политики, зависящим от шаблона ARM. По умолчанию артефакт политики создается перед шаблоном ARM. Этот порядок позволяет артефакту политики ожидать создания шаблона ARM.

```json
{
    "properties": {
        "displayName": "Assigns an identifying tag",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/2a0e14a6-b0a6-4fab-991a-187a4f81c498",
        "resourceGroup": "standard-rg",
        "dependsOn": [
            "customTemplate"
        ]
    },
    "kind": "policyAssignment",
    "type": "Microsoft.Blueprint/artifacts"
}
```

### <a name="example---subscription-level-template-artifact-depending-on-a-resource-group"></a>Пример-артефакт шаблона уровня подписки в зависимости от группы ресурсов

Этот пример предназначен для шаблона ARM, развернутого на уровне подписки, в зависимости от группы ресурсов. В упорядочении по умолчанию артефакты уровня подписки создаются до любых групп ресурсов и дочерних артефактов в этих группах ресурсов. Группа ресурсов определяется в определении схемы следующим образом:

```json
"resourceGroups": {
    "wait-for-me": {
        "metadata": {
            "description": "Resource Group that is deployed prior to the subscription level template artifact"
        }
    }
}
```

Артефакт шаблона уровня подписки в зависимости от группы ресурсов, ожидающей **ожидания** , определяется следующим образом:

```json
{
    "properties": {
        "template": {
            ...
        },
        "parameters": {
            ...
        },
        "dependsOn": ["wait-for-me"],
        "displayName": "SubLevelTemplate",
        "description": ""
    },
    "kind": "template",
    "type": "Microsoft.Blueprint/blueprints/artifacts"
}
```

## <a name="processing-the-customized-sequence"></a>Обработка пользовательской последовательности

В процессе создания используется топологическая сортировка для создания графа зависимостей схемы и ее артефактов. Выполняется проверка того, что поддерживается каждый уровень зависимостей между группами ресурсов и артефактами.

Если объявляется зависимость артефактов, которая не изменяет порядок последовательности по умолчанию, никакие изменения не вносятся.
Например, это относится к группе ресурсов, которая зависит от политики уровня подписки. Другой пример — назначение дочерней политики standart-rg для группы ресурсов, которая зависит от назначения дочерней роли standard-rg для группы ресурсов. В обоих случаях `dependsOn` не изменяет порядок последовательности по умолчанию, и изменения не производятся.

## <a name="next-steps"></a>Дальнейшие действия

- Ознакомьтесь со сведениями о [жизненном цикле схем](./lifecycle.md).
- Узнайте, как использовать [статические и динамические параметры](./parameters.md).
- Узнайте, как применять [блокировку ресурсов схемы](./resource-locking.md).
- Узнайте, как [обновлять существующие назначения](../how-to/update-existing-assignments.md).
- Устраняйте проблемы, возникающие во время назначения схемы, с помощью [общих инструкций по устранению неполадок](../troubleshoot/general.md).