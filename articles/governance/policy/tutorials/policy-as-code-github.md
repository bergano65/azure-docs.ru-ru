---
title: Руководство по Реализация Политики Azure как кода с помощью GitHub
description: В этом руководстве показано, как реализовать рабочий процесс Политики Azure как кода, который включает экспорт, а также использование GitHub Actions и рабочих процессов GitHub.
ms.date: 10/20/2020
ms.topic: tutorial
ms.openlocfilehash: 76a46adc3fc8efab4f7a2d6e656e83c2537dd037
ms.sourcegitcommit: ce8eecb3e966c08ae368fafb69eaeb00e76da57e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/21/2020
ms.locfileid: "92325901"
---
# <a name="tutorial-implement-azure-policy-as-code-with-github"></a>Руководство по Реализация Политики Azure как кода с помощью GitHub

Рабочий процесс Политики Azure как кода позволяет администрировать определения и назначения политик как код, управлять жизненным циклом обновления для этих определений и автоматизировать проверку результатов соответствия. В этом руководстве показано, как использовать функции Политики Azure с GitHub для создания процесса жизненного цикла. Сюда входят следующие задачи:

> [!div class="checklist"]
> - экспорт определений и назначений политик в GitHub;
> - принудительная отправка обновленных в GitHub объектов политики в Azure;
> - активация проверки соответствия в GitHub Actions.

В этих кратких руководствах показано, как назначить политику, чтобы определить текущее состояние соответствия существующих ресурсов.

## <a name="prerequisites"></a>Предварительные требования

- Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/), прежде чем начинать работу.
- Изучите статью [Проектирование рабочего процесса Политики Azure как кода](../concepts/policy-as-code.md), чтобы получить представление о конструктивных шаблонах, используемых в этом руководстве.

### <a name="export-azure-policy-objects-from-the-azure-portal"></a>Экспорт объектов Политики Azure с помощью портала Azure

Чтобы экспортировать определение политики с помощью портала Azure, сделайте следующее:

1. Запустите службу Политика Azure на портале Azure, щелкнув **Все службы** , а затем выполнив поиск и выбрав **Политика** .

1. Выберите **Определения** на странице службы Политики Azure слева.

1. Нажмите кнопку **Экспортировать определения** или щелкните значок с многоточием в строке определения политики и выберите **Экспортировать определение** .

1. Нажмите кнопку **Войти по учетным данным GitHub** . Если вы еще не выполнили аутентификацию в GitHub для предоставления Политике Azure прав на экспорт ресурса, изучите разрешения, запрашиваемые [GitHub Actions](https://github.com/features/actions), в новом окне и выберите **Предоставить разрешения для AzureGitHubActions** , чтобы продолжить процесс экспорта. По завершении новое окно автоматически закроется.

1. На вкладке **Основные сведения** задайте следующие параметры, а затем щелкните вкладку **Политики** или нажмите кнопку **Далее: Политики** в нижней части страницы.

   - **Фильтр репозиториев.** Установите значение _Мои репозитории_ , чтобы просмотреть только свои репозитории, или _Все репозитории_ , чтобы просмотреть все репозитории, к которым вы предоставили для GitHub Actions разрешение на доступ.
   - **Репозиторий.** Укажите репозиторий, в который вы хотите экспортировать ресурсы Политики Azure.
   - **Ветвь.** Укажите ветвь репозитория. Использование ветви, отличающейся от используемой по умолчанию, считается хорошим способом проверки обновлений перед дальнейшим слиянием с исходным кодом.
   - **Каталог** . Выберите _корневую папку_ для экспорта ресурсов Политики Azure. В этой папке будут созданы вложенные папки, в зависимости от типов экспортируемых ресурсов.

1. На вкладке **Политики** настройте область поиска, щелкнув значок с многоточием и выбрав нужное сочетание групп управления, подписок и групп ресурсов.
   
1. С помощью кнопки **Добавить определения политик** найдите нужную область для экспорта объектов. В открывшемся дополнительном окне выберите все нужные объекты для экспорта. Отфильтруйте выбранные элементы по типу или полю поиска. Завершив выбор объектов для экспорта, нажмите кнопку **Добавить** в нижней части страницы.

1. Для каждого выбранного объекта укажите нужный режим экспорта, например _Только определение_ или _Определение и назначения_ . Теперь перейдите на вкладку **Просмотр и экспорт** или нажмите кнопку **Далее: Просмотр и экспорт** в нижней части страницы.

   > [!NOTE]
   > Если вы выбрали вариант _Определение и назначения_ , будут экспортированы только те назначения политики, которые входят в область действия, установленную фильтрами при добавлении этого определения политики.

1. На вкладке **Просмотр и экспорт** проверьте сведения и нажмите кнопку **Экспорт** в нижней части страницы.

1. Зайдите в репозиторий GitHub и проверьте выбранную ветвь и _корневую папку_ , чтобы убедиться, что выбранные ресурсы успешно экспортированы в систему управления версиями.

Ресурсы Политики Azure экспортируются в указанную _корневую папку_ выбранного репозитория GitHub в виде такой структуры:

```text
|
|- <root level folder>/  ________________ # Root level folder set by Directory property
|  |- policies/  ________________________ # Subfolder for policy objects
|     |- <displayName>_<name>____________ # Subfolder based on policy displayName and name properties
|        |- policy.json _________________ # Policy definition
|        |- assign.<displayName>_<name>__ # Each assignment (if selected) based on displayName and name properties
|
```

### <a name="push-policy-objects-updated-in-github-to-azure"></a>Принудительная отправка обновленных в GitHub объектов политики в Azure

1. Одновременно с объектами политики создается файл [рабочего процесса GitHub](https://docs.github.com/en/actions/configuring-and-managing-workflows/configuring-a-workflow#about-workflows) с именем `.github/workflows/manage-azure-policy-<randomLetters>.yml`, который позволяет быстро начать работу.

   > [!NOTE]
   > Файл рабочего процесса GitHub создается при каждом выполнении экспорта. Экземпляры этого файла будут отличаться в зависимости от параметров конкретного действия экспорта.

1. Этот файл рабочего процесса использует действие [Управление Политикой Azure](https://github.com/marketplace/actions/manage-azure-policy) для передачи изменений, внесенных в экспортированные объекты политики в репозитории GitHub, обратно в Политику Azure. По умолчанию это действие оценивает и синхронизирует только те файлы, которые отличаются от существующих в Azure. Также вы можете указать для этого действия параметр `assignments`, чтобы синхронизировать изменения только в файлах с определенным назначением. Этот параметр позволяет применить назначения политики только к конкретной среде. Дополнительные сведения см. в документации по [управлению репозиторием Политики Azure](https://github.com/Azure/manage-azure-policy).

1. По умолчанию рабочий процесс должен запускаться вручную. Для этого найдите в GitHub раздел **Actions** (Действия), затем выберите рабочий процесс `manage-azure-policy-<randomLetters>` и действие **Run workflow** (Выполнить рабочий процесс), а затем еще раз щелкните **Run workflow** (Выполнить рабочий процесс).

   :::image type="content" source="../media/policy-as-code-github/manually-trigger-workflow.png" alt-text="Снимок экрана: вкладка Action (Действие), рабочий процесс и кнопки Run workflow (Выполнить рабочий процесс) в веб-интерфейсе GitHub":::

   > [!NOTE]
   > Файл рабочего процесса должен размещаться в ветви по умолчанию, чтобы он обнаруживался и выполнялся вручную.

1. Этот рабочий процесс синхронизирует изменения, внесенные в объекты политики, обратно в Azure, и возвращает журналы с состоянием.

   :::image type="content" source="../media/policy-as-code-github/workflow-logging.png" alt-text="Снимок экрана: вкладка Action (Действие), рабочий процесс и кнопки Run workflow (Выполнить рабочий процесс) в веб-интерфейсе GitHub":::

1. Также этот рабочий процесс сохраняет данные в метаданных (`properties.metadata`) объектов Политики Azure для последующего отслеживания.

   :::image type="content" source="../media/policy-as-code-github/updated-definition-metadata.png" alt-text="Снимок экрана: вкладка Action (Действие), рабочий процесс и кнопки Run workflow (Выполнить рабочий процесс) в веб-интерфейсе GitHub":::

### <a name="trigger-compliance-scans-using-github-action"></a>Активация проверки соответствия с помощью GitHub Actions

[Действие проверки соответствия Политики Azure](https://github.com/marketplace/actions/azure-policy-compliance-scan) позволяет активировать проверку соответствия по запросу из [рабочего процесса GitHub](https://docs.github.com/en/actions/configuring-and-managing-workflows/configuring-a-workflow#about-workflows) для одного или нескольких ресурсов, групп ресурсов или подписок, а также изменять путь этого рабочего процесса на основе данных о состоянии соответствия требованиям этих ресурсов. Вы также можете настроить выполнение рабочего процесса в запланированное время, чтобы получать самые свежие данные о состоянии соответствия в удобное для себя время. Кроме того, компонент GitHub Actions может создавать отчет о состоянии соответствия требованиям проверенных ресурсов для дальнейшего анализа или архивации.

Следующий пример выполняет проверку соответствия для одной подписки. 

```yaml

on:
  schedule:    
    - cron:  '0 8 * * *'  # runs every morning 8am
jobs:
  assess-policy-compliance:    
    runs-on: ubuntu-latest
    steps:         
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{secrets.AZURE_CREDENTIALS}} 

    
    - name: Check for resource compliance
      uses: azure/policy-compliance-scan@v0
      with:
        scopes: |
          /subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

```

## <a name="review"></a>Просмотр

В этом руководстве вы успешно выполнили следующие действия:

> [!div class="checklist"]
> - экспорт определений и назначений политик в GitHub;
> - принудительная отправка обновленных в GitHub объектов политики в Azure;
> - активация проверки соответствия в GitHub Actions.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о структурах определения политик см. в статье:

> [!div class="nextstepaction"]
> [Структура определения политики Azure](../concepts/definition-structure.md)