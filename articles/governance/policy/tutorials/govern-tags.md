---
title: Система управления тегами
description: С помощью действия изменения в службе "Политика Azure" можно создать и применить модель управления тегами к новым и существующим ресурсам.
author: DCtheGeek
ms.author: dacoulte
ms.date: 11/04/2019
ms.topic: tutorial
ms.service: azure-policy
ms.openlocfilehash: 79219b9405f76e7044a4d403b37ba2f1545dfbea
ms.sourcegitcommit: c22327552d62f88aeaa321189f9b9a631525027c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2019
ms.locfileid: "73510008"
---
# <a name="tutorial-manage-tag-governance-with-azure-policy"></a>Руководство по системе управления тегами с помощью Политики Azure

[Теги](../../../azure-resource-manager/resource-group-using-tags.md) являются важной частью организации ресурсов Azure в таксономию. Если следовать [рекомендациям по управлению тегами](/azure/architecture/cloud-adoption/ready/considerations/name-and-tag#metadata-tags), с помощью тегов можно применять бизнес-политики с использованием службы "Политика Azure" или [отслеживать затраты с помощью службы "Управление затратами"](../../../cost-management/cost-mgt-best-practices.md#organize-and-tag-your-resources).
Независимо от метода и причины применения тегов, важно иметь возможность быстро добавлять, изменять и удалять эти теги в ресурсах Azure.

Действие [изменения](../concepts/effects.md#modify) Политики Azure призвано помочь в управлении тегами, независимо от этапа управления ресурсами. Действие **изменения** помогает в следующих случаях:

- Если вы только начинаете знакомство с облаком и у вас нет системы управления тегами.
- У вас уже есть множество ресурсов без системы управления тегами.
- У вас уже есть таксономия, которую требуется изменить.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/), прежде чем начинать работу.

## <a name="identify-requirements"></a>Определение требований

Как и в случае с любой хорошей реализацией элементов системы управления, требования должны проистекать из бизнес-потребностей. Прежде чем создавать технические элементы управления, необходимо осознать требования. В рамках этого сценария мы предлагаем следующие бизнес-требования:

- Два обязательных тега для всех ресурсов: _CostCenter_ и _Env_.
- Тег _CostCenter_ должен присутствовать во всех контейнерах и отдельных ресурсах.
  - Ресурсы наследуются от контейнера, в котором они находятся, но их можно переопределять по отдельности.
- Тег _Env_ должен присутствовать во всех контейнерах и отдельных ресурсах.
  - Ресурсы определяют среду по схеме именования контейнеров и не переопределяются.
  - Все ресурсы в контейнере являются частью одной среды.

## <a name="configure-the-costcenter-tag"></a>Настройка тега CostCenter

В терминах, относящихся к среде Azure, управляемой с помощью Политики Azure, требования к тегу _CostCenter_ следующие:

- Запрет групп ресурсов, в которых отсутствует тег _CostCenter_.
- Изменение ресурсов, чтобы добавить тег _CostCenter_ из родительской группы ресурсов при его отсутствии.

### <a name="deny-resource-groups-missing-the-costcenter-tag"></a>Запрет групп ресурсов, в которых отсутствует тег CostCenter

Так как тег _CostCenter_ для группы ресурсов нельзя определить по имени группы ресурсов, для создания группы ресурсов следует задать тег в запросе. Следующее правило политики с действием [запрета](../concepts/effects.md#deny) предотвращает создание или обновление групп ресурсов, у которых нет тега _CostCenter_:

```json
"if": {
    "allOf": [{
            "field": "type",
            "equals": "Microsoft.Resources/subscriptions/resourceGroups"
        },
        {
            "field": "tags['CostCenter']",
            "exists": false
        }
    ]
},
"then": {
    "effect": "deny"
}
```

> [!NOTE]
> Так как это правило политики предназначено для группы ресурсов, для _режима_ в определении политики следует задать значение "Все" вместо "Индексировано".

### <a name="modify-resources-to-inherit-the-costcenter-tag-when-missing"></a>Изменение ресурсов для наследования тега CostCenter при его отсутствии

Второе требование, связанное с тегом _CostCenter_, — если этот тег отсутствует, ресурсы должны наследовать его от родительской группы ресурсов. Если тег уже определен для ресурса, даже если он отличается от родительской группы ресурсов, он должен остаться без изменения. Следующее правило политики использует действие [изменения](../concepts/effects.md#modify):

```json
"policyRule": {
    "if": {
        "field": "tags['CostCenter']",
        "exists": "false"
    },
    "then": {
        "effect": "modify",
        "details": {
            "roleDefinitionIds": [
                "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
            ],
            "operations": [{
                "operation": "add",
                "field": "tags['CostCenter']",
                "value": "[resourcegroup().tags['CostCenter']]"
            }]
        }
    }
}
```

Это правило политики использует операцию **add** вместо **addOrReplace**, так как при [исправлении](../how-to/remediate-resources.md) имеющихся ресурсов не нужно изменять значение тега, если оно имеется. Кроме того, используется функция шаблона `[resourcegroup()]` для получения значения тега из родительской группы ресурсов.

> [!NOTE]
> Так как это правило политики предназначено для ресурсов, поддерживающих теги, для _режима_ в определении политики следует задать значение "Индексировано". Эта конфигурация позволяет политике пропускать группы ресурсов.

## <a name="configure-the-env-tag"></a>Настройка тега Env

В терминах, относящихся к среде Azure, управляемой с помощью Политики Azure, требования к тегу _Env_ следующие:

- Изменение тега _Env_ в группе ресурсов на основе схемы именования групп ресурсов.
- Изменение тега _Env_ для всех ресурсов в группе ресурсов, чтобы они совпадали с родительской группой ресурсов.

### <a name="modify-resource-groups-env-tag-based-on-name"></a>Изменение тега Env группы ресурсов на основе имени

Для каждой среды в среде Azure требуется политика [изменения](../concepts/effects.md#modify). Политика изменения для каждой из них выглядит примерно так:

```json
"policyRule": {
    "if": {
        "allOf": [{
            "field": "type",
            "equals": "Microsoft.Resources/subscriptions/resourceGroups"
        },
        {
            "field": "name",
            "like": "prd-*"
        }
    ]
    },
    "then": {
        "effect": "modify",
        "details": {
            "roleDefinitionIds": [
                "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
            ],
            "operations": [{
                "operation": "addOrReplace",
                "field": "tags['Env']",
                "value": "Production"
            }]
        }
    }
}
```

> [!NOTE]
> Так как это правило политики предназначено для группы ресурсов, для _режима_ в определении политики следует задать значение "Все" вместо "Индексировано".

Эта политика сопоставляет только группы ресурсов с примером схемы именования, используемой для рабочих ресурсов `prd-`. Более сложные схемы именования можно реализовать с помощью нескольких условий **соответствия** вместо одного, **как** в этом примере.

### <a name="modify-resources-to-inherit-the-env-tag"></a>Изменение ресурсов для наследования тега Env

Бизнес-требования таковы, чтобы у всех ресурсов присутствовал тег _Env_, который есть в их родительской группе ресурсов. Этот тег нельзя переопределить, поэтому мы будем использовать операцию **addOrReplace** с действием [изменения](../concepts/effects.md#modify). Пример политики изменения выглядит следующим образом:

```json
"policyRule": {
    "if": {
        "anyOf": [{
            "field": "tags['Env']",
            "notEquals": "[resourcegroup().tags['Env']]"
        },
        {
            "field": "tags['Env']",
            "exists": false
        }
    ]
    },
    "then": {
        "effect": "modify",
        "details": {
            "roleDefinitionIds": [
                "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
            ],
            "operations": [{
                "operation": "addOrReplace",
                "field": "tags['Env']",
                "value": "[resourcegroup().tags['Env']]"
            }]
        }
    }
}
```

> [!NOTE]
> Так как это правило политики предназначено для ресурсов, поддерживающих теги, для _режима_ в определении политики следует задать значение "Индексировано". Эта конфигурация позволяет политике пропускать группы ресурсов.

Это правило политики выполняет поиск любого ресурса, у которого нет значения родительских групп ресурсов для тега _Env_ или тег _Env_ отсутствует. Для соответствующих ресурсов для тега _Env_ задается значение родительской группы ресурсов, даже если тег уже существовал в ресурсе, но имеет другое значение.

## <a name="assign-the-initiative-and-remediate-resources"></a>Назначение инициативы и оптимизация ресурсов

После создания указанных выше политик тегов объедините их в единую инициативу для системы управления тегами и назначьте группе управления или подписке. Эта инициатива и включаемые политики оценивают соответствие существующих ресурсов и изменяют запросы новых или обновленных ресурсов, соответствующих свойству **if** в правиле политики. Однако политика не изменяет теги имеющихся ресурсов, которые не соответствуют требованиям.

Как и политики [deployIfNotExists](../concepts/effects.md#deployifnotexists), с помощью задач исправления политика **изменения** изменяет имеющиеся ресурсы, которые не соответствуют требованиям. Следуйте указаниям в [этой статье](../how-to/remediate-resources.md), чтобы определить несоответствующие требованиям ресурсы для **изменения** и исправить теги для определенной таксономии.

## <a name="review"></a>Проверка

При работе с этим учебником вы выполнили такие задачи:

> [!div class="checklist"]
> - определили бизнес-требования;
> - сопоставили каждое требование с определением политики;
> - сгруппировали политики тегов в инициативу.

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения о структурах определения политик см. в статье:

> [!div class="nextstepaction"]
> [Структура определения политики Azure](../concepts/definition-structure.md)
