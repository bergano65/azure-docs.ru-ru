---
title: Разработка Политики Azure как рабочих процессов кода
description: Научитесь проектировать рабочие процессы для развертывания определений политик Azure как кода и автоматически проверять ресурсы.
ms.date: 10/20/2020
ms.topic: conceptual
ms.openlocfilehash: 74d2097e4db4442e6e65f30541864fb554f7379d
ms.sourcegitcommit: 0b9fe9e23dfebf60faa9b451498951b970758103
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/07/2020
ms.locfileid: "94359686"
---
# <a name="design-azure-policy-as-code-workflows"></a>Разработка Политики Azure как рабочих процессов кода

По мере продвижения к созданию системы управления облаком вам потребуется перейти от ручного управления каждым определением политики на портале Azure или с помощью различных пакетов SDK к чему-то более управляемому и повторяемому в масштабе предприятия. Среди основных подходов к управлению системами с масштабированием в облаке можно выделить следующие два.

- Инфраструктура как код. Методика обработки содержимого, определяющего среды, все из шаблонов Azure Resource Manager (шаблоны ARM) в определениях политик Azure в качестве исходного кода.
- DevOps. Объединение людей, процессов и продуктов для обеспечения непрерывной поставки ценности конечным пользователям.

Политика Azure как код представляет собой сочетание этих идей. По сути, это хранение определения политик в системе управления версиями и тестирование и проверка их при каждом внесении изменений. Однако это не должно быть областью политик, вовлеченных в инфраструктуру как код или DevOps.

Этап проверки также должен быть компонентом других рабочих процессов непрерывной интеграции или непрерывного развертывания. Примеры включают развертывание среды приложения или виртуальной инфраструктуры. Делая проверку политики Azure ранним компонентом процесса сборки и развертывания, группы приложений и операций обнаруживают, являются ли их изменения несоответствующими, долго до того, как они будут слишком поздно и пытаются выполнить развертывание в рабочей среде.

## <a name="definitions-and-foundational-information"></a>Определения и базовые сведения

Прежде чем приступать к подробным сведениям о политике Azure в качестве рабочего процесса кода, ознакомьтесь со следующими определениями и примерами.

- [Определение политики](./definition-structure.md)
- [Определение инициативы](./initiative-definition-structure.md)

Имена файлов выявляются в соответствии с частями определения политики или инициативы:
- `policy(set).json` — Полное определение
- `policy(set).parameters.json` — `properties.parameters` Часть определения;
- `policy.rules.json` — `properties.policyRule` Часть определения;
- `policyset.definitions.json` — `properties.policyDefinitions` Часть определения;

Примеры этих форматов файлов доступны в [репозитории GitHub в политике Azure](https://github.com/Azure/azure-policy/):

- Определение политики: [Добавление тега к ресурсам](https://github.com/Azure/azure-policy/tree/master/samples/Tags/add-tag)
- Определение инициативы: [теги выставления счетов](https://github.com/Azure/azure-policy/tree/master/samples/PolicyInitiatives/multiple-billing-tags)

## <a name="workflow-overview"></a>Обзор рабочего процесса

Рекомендуемый общий рабочий процесс политики Azure как кода выглядит как эта диаграмма:

:::image type="complex" source="../media/policy-as-code/policy-as-code-workflow.png" alt-text="Схема, показывающая политику Azure в качестве рамок рабочего процесса кода, из создания в тест для развертывания." border="false":::
   На схеме показаны поля "политика Azure как рабочий процесс кода". Создание описывает создание определений политики и инициатив. Тест охватывает назначение с отключенным режимом применения. После проверки шлюза на наличие состояния соответствия ему назначаются разрешения M S I и ресурсы устранения.  Развертывание охватывает обновление назначения с включенным режимом применения.
:::image-end:::

### <a name="create-and-update-policy-definitions"></a>Создание и обновление определений политик

Определения политик создаются с помощью JSON и хранятся в системе управления версиями. У каждой политики есть свой набор файлов, таких как параметры, правила и параметры среды, которые должны храниться в одной папке. Следующая структура является рекомендуемым способом хранения определений политик в системе управления версиями.

```text
.
|
|- policies/  ________________________ # Root folder for policy resources
|  |- policy1/  ______________________ # Subfolder for a policy
|     |- policy.json _________________ # Policy definition
|     |- policy.parameters.json ______ # Policy definition of parameters
|     |- policy.rules.json ___________ # Policy rule
|     |- assign.<name1>.json _________ # Assignment 1 for this policy definition
|     |- assign.<name2>.json _________ # Assignment 2 for this policy definition
|  |- policy2/  ______________________ # Subfolder for a policy
|     |- policy.json _________________ # Policy definition
|     |- policy.parameters.json ______ # Policy definition of parameters
|     |- policy.rules.json ___________ # Policy rule
|     |- assign.<name1>.json _________ # Assignment 1 for this policy definition
|     |- assign.<name2>.json _________ # Assignment 2 for this policy definition
|
```

При добавлении новой политики или изменении существующей рабочий процесс должен автоматически обновлять определение политики в Azure. Тестирование нового или обновленного определения политики происходит позже.

Кроме того, ознакомьтесь со статьей [экспорт ресурсов политики Azure](../how-to/export-resources.md) , чтобы получить существующие определения и назначения в среде управления исходным кодом [GitHub](https://www.github.com).

### <a name="create-and-update-initiative-definitions"></a>Создание и обновление определений инициатив

Аналогичным образом, инициативы имеют собственный файл JSON и связанные файлы, которые должны храниться в одной и той же папке. Для определения инициативы необходимо наличие определения политики, поэтому его нельзя создать или изменить до тех пор, пока источник политики не будет обновлен в системе управления версиями, а затем обновлен в Azure. Следующая структура является рекомендуемым способом хранения определений инициатив в системе управления версиями.

```text
.
|
|- initiatives/ ______________________ # Root folder for initiatives
|  |- init1/ _________________________ # Subfolder for an initiative
|     |- policyset.json ______________ # Initiative definition
|     |- policyset.definitions.json __ # Initiative list of policies
|     |- policyset.parameters.json ___ # Initiative definition of parameters
|     |- assign.<name1>.json _________ # Assignment 1 for this policy initiative
|     |- assign.<name2>.json _________ # Assignment 2 for this policy initiative
|
|  |- init2/ _________________________ # Subfolder for an initiative
|     |- policyset.json ______________ # Initiative definition
|     |- policyset.definitions.json __ # Initiative list of policies
|     |- policyset.parameters.json ___ # Initiative definition of parameters
|     |- assign.<name1>.json _________ # Assignment 1 for this policy initiative
|     |- assign.<name2>.json _________ # Assignment 2 for this policy initiative
|
```

Как для определений политик, при добавлении или изменении существующей инициативы рабочий процесс должен автоматически обновлять определение инициативы в Azure. Тестирование нового или обновленного определения инициативы происходит позже.

### <a name="test-and-validate-the-updated-definition"></a>Тестирование и проверка измененного определения

После того как служба автоматизации записала созданные или измененные определения политики или инициативы и внесла обновления в объект в Azure, необходимо протестировать внесенные изменения. Как политику, так и инициативу, частью которой является политика, необходимо назначить ресурсам в среде, наиболее удаленной от рабочей среды. Обычно эта среда _Dev_ (разработка).

Назначение должно использовать для режима [enforcementMode](./assignment-structure.md#enforcement-mode) значение _Disabled_ (отключено), чтобы создание и изменение ресурсов не блокировалось, но все существующие ресурсы по-прежнему проверялись на соответствие обновленному определению политики. Даже при использовании enforcementMode рекомендуется, чтобы область назначения являлась специально выделенной для тестирования группой ресурсов или подпиской.

> [!NOTE]
> Хотя режим принудительного применения полезен, он не является заменой тщательного тестирования определения политики при различных условиях. Определение политики необходимо тестировать с помощью вызовов REST API `PUT` и `PATCH`, проверки соответствующих и несоответствующих ресурсов, а также проверяя граничные случаи, такие как свойство, отсутствующее в ресурсе.

После развертывания назначения используйте пакет SDK политики Azure, [действие "Проверка соответствия политики Azure](https://github.com/marketplace/actions/azure-policy-compliance-scan)" на GitHub или [задачу Azure pipelines "Оценка безопасности и соответствия требованиям](/azure/devops/pipelines/tasks/deploy/azure-policy) ", чтобы [получить данные о соответствии](../how-to/get-compliance-data.md) для нового назначения. Среда, используемая для проверки политик и назначений, должна иметь как соответствующие, так и не соответствующие требованиям ресурсы.
Как и в случае с хорошим модульным тестом для кода, необходимо проверить, что ресурсы соответствуют ожиданиям и что у вас также нет ложных положительных и отрицательных срабатываний. При тестировании и проверке только ожидаемых результатов может возникнуть непредвиденное и неопознанное воздействие политики. Дополнительные сведения см. в статье [Оценка влияния нового определения политики Azure](./evaluate-impact.md).

### <a name="enable-remediation-tasks"></a>Включение задач исправления

Если проверка назначения соответствует ожиданиям, следующим шагом является проверка исправления.
Политики, использующие [deployIfNotExists](./effects.md#deployifnotexists) или [modify](./effects.md#modify), могут быть включены в задачу исправления и исправлять ресурсы, не соответствующие требованиям.

Первым шагом для исправления ресурсов является предоставление назначению политики назначения роли, определенного в определении политики. Это назначение ролей дает управляемому удостоверению назначения политики достаточно прав для внесения необходимых изменений для приведения ресурса в состояние соответствия.

После назначения политике соответствующих прав используйте пакет SDK для политики, чтобы активировать задачу по исправлению для набора ресурсов, для которых известно об их несовместимости. Перед тем как продолжить, необходимо выполнить три теста выполненных задач исправления:

- проверить, что задачи исправления успешно завершили выполнение;
- выполнить оценку политики, чтобы убедиться, что результаты соответствия политике обновлены и соответствуют ожиданиям;
- выполнить модульный тест среды непосредственно для ресурсов, чтобы проверить, изменились ли их свойства.

При тестировании обновленных результатов оценки политики и непосредственном тестировании среды подтверждается, что задачи исправления изменили то, что ожидалось, и определение политики обнаружило изменение соответствия так, как ожидалось.

### <a name="update-to-enforced-assignments"></a>Обновление до принудительных назначений

После прохождения всех проверочных шлюзов переключите для назначение режим **enforcementMode** в положение _enabled_ (включено). Рекомендуется также сначала выполнить это изменение в среде, наиболее удаленной от рабочей среды. После того как среда будет проверена и начнет работать, как ожидается, необходимо изменить область для включения следующей по порядку среды и продолжать процесс дальше, пока политика не будет развернута в рабочих ресурсах.

## <a name="process-integrated-evaluations"></a>Обработка встроенных оценок

Общий рабочий процесс для политики Azure в качестве кода предназначен для разработки и развертывания политик и инициатив в масштабе среды. Однако оценка политики должна быть частью процесса развертывания для любого рабочего процесса, который развертывает или создает ресурсы в Azure, таких как развертывание приложений или запуск шаблонов ARM для создания инфраструктуры.

В таких случаях после развертывания приложения или инфраструктуры в тестовой подписке или группе ресурсов следует выполнить оценку политики для проверки всех политик и инициатив в этой области. Несмотря на то, что они могут быть настроены в этой среде с режимом **enforcementMode** в положении _disabled_ (отключено), полезно заранее определить, нарушает ли определения политик развертывание приложения или инфраструктуры. Таким образом, такая оценка политики должна быть частью этих рабочих процессов и приводить к отклонению развертываний, которые создают ресурсы, не соответствующие требованиям.

## <a name="review"></a>Просмотр

В этой статье рассматривается общий рабочий процесс для политики Azure в виде кода, а также, где оценка политики должна быть частью других рабочих процессов развертывания. Этот рабочий процесс можно использовать в любой среде, которая поддерживает действия сценариев и автоматизацию на основе триггеров. Руководство по использованию этого рабочего процесса в GitHub см. в разделе [учебник. Реализация политики Azure как кода с помощью GitHub](../tutorials/policy-as-code-github.md).

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте больше о [структуре определения политик](./definition-structure.md).
- Узнайте больше о [структуре назначения политик](./assignment-structure.md).
- Узнайте о [программном создании политик](../how-to/programmatically-create.md).
- Узнайте, как [получать сведения о соответствии](../how-to/get-compliance-data.md).
- Узнайте, как [исправлять несоответствующие ресурсы](../how-to/remediate-resources.md).
- Дополнительные сведения о группе управления см. в статье [Упорядочивание ресурсов с помощью групп управления Azure](../../management-groups/overview.md).
