---
title: 'Сценарий: маршрутизация трафика через виртуальное сетевое устройство (NVA)'
titleSuffix: Azure Virtual WAN
description: Перенаправление трафика через виртуальный сетевой модуль
services: virtual-wan
author: cherylmc
ms.service: virtual-wan
ms.topic: conceptual
ms.date: 09/22/2020
ms.author: cherylmc
ms.custom: fasttrack-edit
ms.openlocfilehash: d44964b5aed55e2ee70d18e6be5d632b652956e1
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "90976264"
---
# <a name="scenario-route-traffic-through-an-nva"></a>Сценарий: маршрутизация трафика через NVA

При работе с маршрутизацией виртуальных сетей виртуальной глобальной сети существует несколько доступных сценариев. В этом сценарии NVA цель заключается в маршрутизации трафика через NVA (сетевой виртуальный модуль) для ветвления в VNet и VNet to Branch. Дополнительные сведения о маршрутизации виртуальных концентраторов см. в статье [о маршрутизации виртуальных концентраторов](about-virtual-hub-routing.md).

> [!NOTE]
> Если у вас уже есть настроенные маршруты, прежде чем новые возможности [настройки маршрутизации виртуальных концентраторов](how-to-virtual-hub-routing.md) становятся доступными, выполните действия, описанные в следующих версиях статей:
>* [портал Azure статья](virtual-wan-route-table-nva-portal.md)
>* [Статья о PowerShell](virtual-wan-route-table-nva.md)
>

## <a name="design"></a><a name="design"></a>Конструирование

В этом сценарии мы будем использовать соглашение об именовании:

* "NVA виртуальных сетей" для виртуальных сетей, в которых пользователи развернули NVA и подключили другие виртуальные сети в качестве периферийных (VNet 2 и VNet 4 в **матрице подключения**ниже).
* "NVA спицы" для виртуальных сетей, подключенных к виртуальной сети NVA (VNet 5, VNet 6, VNet 7 и VNet 8) в **матрице подключения**ниже.
* "Non-NVA виртуальных сетей" для виртуальных сетей, подключенных к виртуальной глобальной сети, которая не имеет NVA или других виртуальных сетей, связанных с ними (VNet 1 и VNet 3 в **матрице подключения**ниже).
* Концентраторы для виртуальных глобальных сетей, управляемых корпорацией Майкрософт, где подключены NVA виртуальных сетей. NVA виртуальных сетей не нужно подключать к виртуальным концентраторам глобальной сети только в NVA виртуальных сетей.

Следующая матрица подключения содержит сводку по потокам, поддерживаемым в этом сценарии:

**Матрица подключения**

| Как получить             | на:|   *NVA спицы*|*NVA виртуальных сетей*|*Не NVA виртуальных сетей*|*Ветви*|
|---|---|---|---|---|---|
| **NVA спицы**   | &#8594; | 0/0 UDR  |  Пиринг |   0/0 UDR    |  0/0 UDR  |
| **NVA виртуальных сетей**    | &#8594; |   Статические |      X   |        X     |      X    |
| **Не NVA виртуальных сетей**| &#8594; |   Статические |      X   |        X     |      X    |
| **Ветви**     | &#8594; |   Статические |      X   |        X     |      X    |

Каждая ячейка в матрице подключения описывает, является ли подключение к виртуальной глобальной сети (на стороне потока "от", заголовки строк в таблице), чтобы узнать префикс назначения (часть "to" последовательности, заголовки столбцов, выделенные курсивом в таблице) для конкретного потока трафика. "X" означает, что подключение предоставляется в собственном режиме виртуальной глобальной сети, а "статический" означает, что подключение обеспечивает виртуальную глобальную сеть с использованием статических маршрутов. Рассмотрим следующий пример.

* NVAные периферийные серверы не управляются виртуальной глобальной сетью. В результате механизмы, с которыми они будут взаимодействовать с другими виртуальных сетей или ветви, обслуживаются пользователем. Подключение к виртуальной сети NVA обеспечивается пирингом виртуальных сетей и маршрутом по умолчанию 0.0.0.0/0, указывающим на NVA, так как следующий прыжок должен охватывать подключение к Интернету, к другим периферийным зонам и к веткам
* NVA виртуальных сетей узнает о своих собственных NVAях, но не о NVA периферийных зонах, подключенных к другим NVA виртуальных сетей. Например, в таблице 1 виртуальная сеть 2 знает о виртуальной сети 5 и виртуальной сети 6, но не о других периферийных зонах, таких как VNet 7 и VNet 8. Статический маршрут требуется для добавления префиксов других периферийных серверов в NVA виртуальных сетей
* Аналогичным образом, ветви и NVA виртуальных сетей не будут иметь знания о каких-либо периферийных NVA, так как NVA периферийные зоны не подключены к концентраторам ВВАН. В результате также потребуется использовать статические маршруты.

Учитывая, что NVA периферийные зоны не управляются виртуальной глобальной сетью, все остальные строки отображают тот же шаблон подключения. В результате одна таблица маршрутов (по умолчанию) будет выполнять следующие действия:

* Виртуальные сети (не концентраторы виртуальных сетей и User-Hub виртуальных сетей):
  * Связанная таблица маршрутов: **по умолчанию**
  * Распространение на таблицы маршрутов: **по умолчанию**
* Ветк
  * Связанная таблица маршрутов: **по умолчанию**
  * Распространение на таблицы маршрутов: **по умолчанию**

Однако в этом сценарии необходимо подумать о том, какие статические маршруты нужно настроить. Каждый статический маршрут будет содержать два компонента: одну часть в виртуальном концентраторе глобальной сети, указывающую виртуальные компоненты глобальной сети, которые будут использоваться для каждой периферийной зоны, а другую — это конкретное подключение, указывающее конкретный IP-адрес, назначенный NVA (или подсистеме балансировки нагрузки перед несколькими NVA), как показано на **рис. 1** .

**Рис. 1**

:::image type="content" source="media/routing-scenarios/nva/nva-static-concept.png" alt-text="Рис. 1":::

При этом статические маршруты, которые понадобятся в таблице по умолчанию для отправки трафика на NVA периферийные серверы в виртуальной сети NVA, выглядят следующим образом:

| Описание | Таблица маршрутов | Статический маршрут              |
| ----------- | ----------- | ------------------------- |
| VNet 2       | По умолчанию     | 10.2.0.0/16-> еастусконн |
| Виртуальная сеть 4       | По умолчанию     | 10.4.0.0/16-> веконн     |

Теперь виртуальная Глобальная сеть знает, в какое подключение следует отправить пакеты, но соединение должно знать, что делать при получении этих пакетов: это место, где используются таблицы маршрутов подключения. Здесь мы будем использовать более короткие префиксы (/24 вместо более длинных/16), чтобы убедиться, что эти маршруты имеют предпочтение по маршрутам, импортированным из NVA виртуальных сетей (VNet 2 и VNet 4):

| Описание | Соединение | Статический маршрут            |
| ----------- | ---------- | ----------------------- |
| Виртуальная сеть 5       | еастусконн | 10.2.1.0/24-> 10.2.0.5 |
| Виртуальная сеть 6       | еастусконн | 10.2.2.0/24-> 10.2.0.5 |
| Виртуальная сеть 7       | веконн     | 10.4.1.0/24-> 10.4.0.5 |
| Виртуальная сеть 8       | веконн     | 10.4.2.0/24-> 10.4.0.5 |

Теперь NVA виртуальных сетей, non-NVA виртуальных сетей и ветви узнают, как достичь всех NVA периферийных серверов. Дополнительные сведения о маршрутизации виртуальных концентраторов см. в статье [о маршрутизации виртуальных концентраторов](about-virtual-hub-routing.md).

## <a name="architecture"></a><a name="architecture"></a>Архитектура

На **рис. 2**есть два концентратора; **HUB1** и **HUB2**.

* **HUB1** и **HUB2** напрямую подключены к NVA виртуальных сетей **vnet 2** и **vnet 4**.

* **Виртуальная сеть 5** и **Виртуальная сеть 6** соединены с **виртуальной сетью 2**.

* **Виртуальная сеть 7** и **Виртуальная сеть 8** соединены с **виртуальной сетью 4**.

* **Виртуальных сетей 5, 6, 7, 8** — это непрямые периферийные серверы, которые не подключаются напрямую к виртуальному концентратору.

**Рис. 2**

:::image type="content" source="./media/routing-scenarios/nva/nva.png" alt-text="Рис. 1" lightbox="./media/routing-scenarios/nva/nva.png":::

## <a name="scenario-workflow"></a><a name="workflow"></a>Рабочий процесс сценария

Чтобы настроить маршрутизацию через NVA, выполните следующие действия:

1. Определяет подключение к виртуальной сети NVA периферийных серверов. На **рис. 2**они являются подключением **vnet 2 (Еастусконн)** и **подключением к виртуальной сети 4 (веконн)**.

   Убедитесь, что определяемые пользователем маршруты настроены:
   * Из VNet 5 и VNet 6 в сеть 2 NVA IP
   * Из VNet 7 и VNet 8 в VNet 4 NVA IP 
   
   Вам не нужно подключать виртуальных сетей 5, 6, 7, 8 к виртуальным концентраторам напрямую. Убедитесь, что группы безопасности сети в виртуальных сетей 5, 6, 7, 8 разрешают трафик для ветви (VPN/ER/P2S) или виртуальных сетей, подключенные к удаленным виртуальных сетей. Например, виртуальных сетей 5, 6 должен обеспечить группы безопасности сети разрешение трафика для префиксов локальных адресов и виртуальных сетей 7, 8, подключенных к удаленному концентратору 2.

Виртуальная глобальная сеть не поддерживает сценарий, в котором виртуальных сетей 5, 6 подключение к виртуальному концентратору и обмен данными через виртуальную сеть 2 NVA IP; Таким образом, необходимо подключить виртуальных сетей 5, 6 к VNet2, а также виртуальную сеть 7, 8 — к виртуальной сети 4.

2. Добавьте агрегированную статическую запись маршрута для виртуальных сетей 2, 5, 6 в таблицу маршрутов по умолчанию Hub 1.

   :::image type="content" source="./media/routing-scenarios/nva/nva-static-expand.png" alt-text="Рис. 1":::

3. Настройте статический маршрут для виртуальных сетей 5, 6 в виртуальном сетевом подключении виртуальной сети 2. Сведения о настройке конфигурации маршрутизации для подключения к виртуальной сети см. в разделе [Маршрутизация виртуальных концентраторов](how-to-virtual-hub-routing.md#routing-configuration).

4. Добавьте агрегированную статическую запись маршрута для виртуальных сетей 4, 7, 8 в таблицу маршрутов по умолчанию для концентратора 1.

5. Повторите шаги 2, 3 и 4 для таблицы маршрутов по умолчанию для концентратора 2.

Это приведет к изменению конфигурации маршрутизации, как показано на **рис. 3**ниже.

**Рис. 3**

   :::image type="content" source="./media/routing-scenarios/nva/nva-result.png" alt-text="Рис. 1" lightbox="./media/routing-scenarios/nva/nva-result.png":::

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о виртуальной глобальной сети см. в статье, содержащей [Часто задаваемые вопросы](virtual-wan-faq.md) о ней.
* Дополнительные сведения о маршрутизации виртуальных концентраторов см. в статье [о маршрутизации виртуальных концентраторов](about-virtual-hub-routing.md).
