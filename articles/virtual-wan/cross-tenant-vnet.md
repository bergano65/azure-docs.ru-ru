---
title: 'Подключение виртуальных сетей между клиентами к концентратору: PowerShell'
titleSuffix: Azure Virtual WAN
description: Эта статья поможет вам подключить виртуальных сетей между клиентами к виртуальному концентратору с помощью PowerShell.
services: virtual-wan
author: wtnlee
ms.service: virtual-wan
ms.topic: how-to
ms.date: 09/28/2020
ms.author: wellee
ms.openlocfilehash: c49a85c71c9b877be7e143f5caf27dc307fe0c12
ms.sourcegitcommit: 8a1ba1ebc76635b643b6634cc64e137f74a1e4da
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/09/2020
ms.locfileid: "94381275"
---
# <a name="connect-cross-tenant-vnets-to-a-virtual-wan-hub"></a>Подключение виртуальных сетей между клиентами к виртуальному концентратору глобальной сети

Эта статья поможет вам использовать виртуальную сеть WAN для подключения виртуальной сети к виртуальному концентратору в другом клиенте. Эта архитектура полезна при наличии клиентских рабочих нагрузок, которые должны быть подключены к одной и той же сети, но находятся в разных клиентах. Например, как показано на следующей схеме, можно подключить нестандартную виртуальную сеть (удаленный клиент) к виртуальному концентратору Contoso (родительский клиент).

:::image type="content" source="./media/cross-tenant-vnet/connectivity.png" alt-text="Настройка конфигурации маршрутизации" :::

Вы узнаете, как выполнять следующие задачи:

* Добавьте еще один клиент в качестве участника в подписку Azure.
* Подключение перекрестной виртуальной сети клиента к виртуальному концентратору.

Шаги для этой конфигурации выполняются с помощью сочетания портал Azure и PowerShell. Однако сама функция доступна только в PowerShell и CLI.

## <a name="before-you-begin"></a>Перед началом

### <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить действия, описанные в этой статье, необходимо, чтобы в вашей среде уже была настроена следующая конфигурация:

* Виртуальная глобальная сеть и виртуальный концентратор в родительской подписке.
* Виртуальная сеть, настроенная в подписке в другом (удаленном) клиенте.
* Убедитесь, что адресное пространство виртуальной сети в удаленном клиенте не перекрывается с любым другим адресным пространством в любом другом виртуальных сетей, уже подключенном к родительскому виртуальному концентратору.

### <a name="working-with-azure-powershell"></a>Работа с Azure PowerShell

[!INCLUDE [PowerShell](../../includes/vpn-gateway-cloud-shell-powershell.md)]

## <a name="assign-permissions"></a><a name="rights"></a>Назначение разрешений

Чтобы в родительской подписке с виртуальным концентратором можно было изменять и получать доступ к виртуальным сетям в удаленном клиенте, необходимо назначить разрешения **участника** родительской подписке из подписки удаленного клиента.

1. Добавьте назначение роли **участника** в родительскую учетную запись (то есть с помощью виртуального КОНЦЕНТРАТОРА глобальной сети). Для назначения этой роли можно использовать либо PowerShell, либо портал Azure. Инструкции см. в следующих статьях, посвященных **добавлению или удалению назначений ролей** .

   * [PowerShell](../role-based-access-control/role-assignments-powershell.md)
   * [Портал](../role-based-access-control/role-assignments-portal.md)

1. Затем добавьте подписку удаленного клиента и родительскую подписку клиента в текущий сеанс PowerShell. Выполните следующую команду. Если вы вошли в родительский узел, необходимо выполнить команду только для удаленного клиента.

   ```azurepowershell-interactive
   Add-AzAccount -SubscriptionId "xxxxx-b34a-4df9-9451-4402dcaecc5b"
   ```

1. Убедитесь, что назначение роли прошло успешно, войдя в Azure PowerShell с помощью родительских учетных данных, и выполните следующую команду:

   ```azurepowershell-interactive
   Get-AzSubscription
   ```

1. Если разрешения успешно распространены на родительский объект и были добавлены в сеанс, то подписка, принадлежащая удаленному клиенту, будет отображаться в выходных данных команды.

## <a name="connect-vnet-to-hub"></a><a name="connect"></a>Подключение виртуальной сети к концентратору

В следующих шагах выполняется переключение между контекстом двух подписок при связывании виртуальной сети с виртуальным концентратором. Замените примеры значений, чтобы они отражали собственную среду.

1. Убедитесь, что вы являетесь в контексте удаленной учетной записи, выполнив следующую команду:

   ```azurepowershell-interactive
   Select-AzSubscription -SubscriptionId "[remote ID]"
   ```

1. Создайте локальную переменную для хранения метаданных виртуальной сети, которую необходимо подключить к концентратору.

   ```azurepowershell-interactive
   $remote = Get-AzVirtualNetwork -Name "[vnet name]" -ResourceGroupName "[resource group name]"
   ```

1. Переключитесь обратно на родительскую учетную запись.

   ```azurepowershell-interactive
   Select-AzSubscription -SubscriptionId "[parent ID]"
   ```

1. Подключите виртуальную сеть к концентратору.

   ```azurepowershell-interactive
   New-AzVirtualHubVnetConnection -ResourceGroupName "[parent resource group name]" -VirtualHubName "[virtual hub name]" -Name "[name of connection]" -RemoteVirtualNetwork $[local variable name]
   ```

1. Новое подключение можно просмотреть либо в PowerShell, либо в портал Azure.

   * **PowerShell:** Если соединение было успешно сформировано, метаданные из вновь сформированного соединения будут отображаться в консоли PowerShell.
   * **Портал Azure:** Перейдите к виртуальным сетевым концентраторам, подключениям **> подключения к виртуальной сети**. Можно просмотреть указатель на соединение. Чтобы просмотреть фактический ресурс, вам понадобятся соответствующие разрешения.
   
## <a name="troubleshooting"></a><a name="troubleshoot"></a>Устранение неполадок

* Убедитесь, что метаданные в $remote (из предыдущего [раздела](#connect)) соответствуют сведениям из портал Azure.
* Разрешения можно проверить с помощью параметров IAM группы ресурсов удаленного клиента или с помощью команд Azure PowerShell (Get-Азсубскриптион).
* Заключите в кавычки имена групп ресурсов или любых других переменных, зависящих от среды (например, "VirtualHub1" или "VirtualNetwork1").

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о виртуальной глобальной сети см. в следующих статьях:

* [Вопросы и ответы](virtual-wan-faq.md) по виртуальной глобальной сети
