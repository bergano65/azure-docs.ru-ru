---
title: Устранение ошибок резервного копирования баз данных SAP HANA
description: Здесь описано, как устранить распространенные ошибки, которые могут возникнуть при использовании Azure Backup для резервного копирования баз данных SAP HANA.
ms.topic: troubleshooting
ms.date: 11/7/2019
ms.openlocfilehash: 5cdad55ef849b9ced31646466e2c2c170ebf0827
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "89377690"
---
# <a name="troubleshoot-backup-of-sap-hana-databases-on-azure"></a>Устранение ошибок резервного копирования баз данных SAP HANA в Azure

В этой статье содержатся сведения об устранении ошибок при резервном копировании баз данных SAP HANA на виртуальных машинах Azure. Дополнительные сведения о сценариях резервного копирования SAP HANA, которые сейчас поддерживаются, см. в разделе [Поддержка сценариев](sap-hana-backup-support-matrix.md#scenario-support).

## <a name="prerequisites-and-permissions"></a>Необходимые условия и разрешения

Прежде чем приступать к настройке резервного копирования, ознакомьтесь с [необходимыми условиями](tutorial-backup-sap-hana-db.md#prerequisites) и разделом [Функции скрипта предварительной регистрации](tutorial-backup-sap-hana-db.md#what-the-pre-registration-script-does).

## <a name="common-user-errors"></a>Распространенные ошибки пользователей

### <a name="usererrorhanainternalrolenotpresent"></a>UserErrorHANAInternalRoleNotPresent

| **Сообщение об ошибке**      | <span style="font-weight:normal">Azure Backup не имеет необходимых привилегий роли для выполнения резервного копирования</span>    |
| ---------------------- | ------------------------------------------------------------ |
| **Возможные причины**    | Возможно, роль была перезаписана.                          |
| **Рекомендуемое действие** | Чтобы устранить эту проблему, запустите скрипт из области **Discover DB** (Обнаружение БД) или скачайте его [здесь](https://aka.ms/scriptforpermsonhana). Кроме того, можно добавить роль SAP_INTERNAL_HANA_SUPPORT для пользователя, выполняющего резервное копирование рабочей нагрузки (AZUREWLBACKUPHANAUSER). |

### <a name="usererrorinopeninghanaodbcconnection"></a>UserErrorInOpeningHanaOdbcConnection

| Сообщение об ошибке      | <span style="font-weight:normal">Не удалось подключиться к системе HANA</span>                        |
| ------------------ | ------------------------------------------------------------ |
| **Возможные причины**    | Возможно, экземпляр SAP HANA не работает.<br/>Не заданы необходимые разрешения для Azure Backup для взаимодействия с базой данных HANA. |
| **Рекомендуемое действие** | Проверьте, работает ли база данных SAP HANA. Если база данных работает, проверьте, заданы ли все необходимые разрешения. Если заданы не все разрешения, выполните [скрипт предварительной регистрации](https://aka.ms/scriptforpermsonhana), чтобы добавить недостающие разрешения. |

### <a name="usererrorhanainstancenameinvalid"></a>UserErrorHanaInstanceNameInvalid

| Сообщение об ошибке      | <span style="font-weight:normal">The specified SAP HANA instance is either invalid or can't be found</span> (Указанный экземпляр SAP HANA не найден или является недопустимым)  |
| ------------------ | ------------------------------------------------------------ |
| **Возможные причины**    | Невозможно создать резервные копии нескольких экземпляров SAP HANA на одной виртуальной машине Azure. |
| **Рекомендуемое действие** | Запустите [скрипт предварительной регистрации](https://aka.ms/scriptforpermsonhana) на экземпляре SAP HANA, для которого необходимо создать резервную копию. Если проблема будет повторяться, обратитесь в службу поддержки Майкрософт. |

### <a name="usererrorhanaunsupportedoperation"></a>UserErrorHanaUnsupportedOperation

| Сообщение об ошибке      | <span style="font-weight:normal">Указанная операция SAP HANA не поддерживается</span>              |
| ------------------ | ------------------------------------------------------------ |
| **Возможные причины**    | Azure Backup для SAP HANA не поддерживает добавочное резервное копирование и действия, выполняемые на SAP HANA собственных клиентах (панель «Studio/панель» или «DBA») |
| **Рекомендуемое действие** | Дополнительные сведения см. [здесь](./sap-hana-backup-support-matrix.md#scenario-support). |

### <a name="usererrorhanapodoesnotsupportbackuptype"></a>UserErrorHANAPODoesNotSupportBackupType

| Сообщение об ошибке      | <span style="font-weight:normal">This SAP HANA database doesn't support the requested backup type</span> (Эта база данных SAP HANA не поддерживает запрошенный тип резервного копирования)  |
| ------------------ | ------------------------------------------------------------ |
| **Возможные причины**    | Azure Backup не поддерживает добавочное резервное копирование и резервное копирование с помощью моментальных снимков |
| **Рекомендуемое действие** | Дополнительные сведения см. [здесь](./sap-hana-backup-support-matrix.md#scenario-support). |

### <a name="usererrorhanalsnvalidationfailure"></a>UserErrorHANALSNValidationFailure

| Сообщение об ошибке      | <span style="font-weight:normal">Backup log chain is broken</span> (Цепочка журналов резервного копирования повреждена)                                    |
| ------------------ | ------------------------------------------------------------ |
| **Возможные причины**    | Возможно, расположение резервной копии журналов было изменено с backint на файловую систему, либо исполняемый файл backint был изменен. |
| **Рекомендуемое действие** | Для устранения проблемы активируйте создание полной резервной копии.                   |

### <a name="usererrorsdctomdcupgradedetected"></a>UserErrorSDCtoMDCUpgradeDetected

| Сообщение об ошибке      | <span style="font-weight:normal">Обнаружено обновление SDC до MDC</span>                                   |
| ------------------ | ------------------------------------------------------------ |
| **Возможные причины**    | Экземпляр SAP HANA был обновлен с SDC до MDC. После обновления произойдет сбой резервного копирования. |
| **Рекомендуемое действие** | Чтобы устранить проблему, выполните действия, описанные в разделе об [обновлении с SDC до MDC](#sdc-to-mdc-upgrade-with-a-change-in-sid). |

### <a name="usererrorinvalidbackintconfiguration"></a>UserErrorInvalidBackintConfiguration

| Сообщение об ошибке      | <span style="font-weight:normal">Обнаружена недопустимая конфигурация Backint</span>                       |
| ------------------ | ------------------------------------------------------------ |
| **Возможные причины**    | Параметры резервного копирования неправильно указаны для Azure Backup |
| **Рекомендуемое действие** | Проверьте, установлены ли следующие параметры (backint):<br/>\* [catalog_backup_using_backint:true];<br/>\* [enable_accumulated_catalog_backup:false];<br/>\* [parallel_data_backup_backint_channels:1];<br/>\* [log_backup_timeout_s:900)];<br/>\* [backint_response_timeout:7200].<br/>Если в узле (HOST) имеются параметры на основе backint, удалите их. Если параметры отсутствуют на уровне узла, но были изменены вручную на уровне базы данных, верните для них подходящие значения, как описано выше. Также можно [отключить защиту и сохранить данные резервной копии](./sap-hana-db-manage.md#stop-protection-for-an-sap-hana-database) на портале Azure, а затем **возобновить резервное копирование**. |

### <a name="usererrorincompatiblesrctargetsystemsforrestore"></a>UserErrorIncompatibleSrcTargetSystemsForRestore

|Сообщение об ошибке  |Исходная и конечная системы для восстановления несовместимы  |
|---------|---------|
|Возможные причины   | Исходная и конечная системы, выбранные для восстановления, несовместимы.        |
|Рекомендуемое действие   |   Убедитесь, что используемый вами сценарий восстановления не указан в следующем списке возможных несовместимых восстановлений: <br><br>   **Вариант 1.** SYSTEMDB невозможно переименовать во время восстановления.  <br><br> **Вариант 2.** Исходная система — SDC, а целевая система — MDC: невозможно восстановить базу данных-источник в виде SYSTEMDB или базу данных клиента в целевой системе. <br><br> **Вариант 3.** Исходная система — MDC, а целевая система — SDC: невозможно восстановить базу данных-источник (SYSTEMDB или базу данных клиента) в целевой системе. <br><br>  Дополнительные сведения см. в примечании **1642148** на портале [SAP Support Launchpad](https://launchpad.support.sap.com). |

## <a name="restore-checks"></a>Проверки восстановления

### <a name="single-container-database-sdc-restore"></a>Восстановление базы данных с одним контейнером (SDC)

Укажите подходящие входные данные при восстановлении базы данных с одним контейнером для HANA на другой компьютер SDC. Имя базы данных должно быть указано в нижнем регистре. В конце имени нужно добавить "sdc" в скобках. Имя экземпляра HANA будет отображаться прописными буквами.

Предположим, создается резервная копия экземпляра HANA SDC с именем H21. На странице элементов резервного копирования имя элемента будет отображаться так: **h21(sdc)** . При попытке восстановления этой базы данных в другой целевой системе SDC, например H11, необходимо предоставить следующие входные данные.

![Имя восстановленной базы данных SDC](media/backup-azure-sap-hana-database/hana-sdc-restore.png)

Обратите внимание на следующие моменты.

- По умолчанию в качестве имени восстановленной базы данных будет указано имя элемента резервного копирования. В нашем случае — h21(sdc).
- Выбор целевого объекта в качестве H11 не приведет к автоматическому изменению имени восстановленной базы данных. **Нужно указать h11(sdc)** . В отношении SDC имя восстановленной базы данных будет идентификатором целевого экземпляра, написанным строчными буквами с добавлением "sdc" в скобках.
- Так как SDC может иметь только одну базу данных, необходимо также установить флажок, чтобы разрешить переопределение существующих данных базы данных с помощью данных точек восстановления.
- В Linux учитывается регистр. Поэтому будьте внимательны и не меняйте регистр.

### <a name="multiple-container-database-mdc-restore"></a>Восстановление базы данных с несколькими контейнерами (MDC)

В базах данных с несколькими контейнерами для HANA стандартная конфигурация — SYSTEMDB + 1 или более баз данных клиентов. Восстановление всего экземпляра SAP HANA означает восстановление как SYSTEMDB, так и баз данных клиентов. Сначала восстанавливается SYSTEMDB, а затем начинается восстановление баз данных клиентов. По сути, системная база данных переопределяет системные сведения для выбранного целевого объекта. При таком восстановлении также переопределяются связанные с Backint сведения в целевом экземпляре. Поэтому после восстановления системной базы данных на целевом экземпляре запустите скрипт предварительной регистрации еще раз. Только после этого будут выполнены восстановления баз данных клиентов.

## <a name="back-up-a-replicated-vm"></a>Создание резервной копии реплицированной виртуальной машины

### <a name="scenario-1"></a>Сценарий 1

Исходная виртуальная машина была реплицирована с помощью Azure Site Recovery или резервной копии виртуальной машины Azure. Новая виртуальная машина была создана для имитации старой виртуальной машины. То есть параметры у них полностью одинаковые. (Это связано с тем, что исходная виртуальная машина была удалена, а восстановление было выполнено из резервной копии виртуальной машины или Azure Site Recovery.)

Этот сценарий может включать в себя два возможных варианта. Узнайте, как создать резервную копию реплицированной виртуальной машины в обоих случаях.

1. Новая виртуальная машина имеет то же имя и находится в той же группе ресурсов и подписке, что и удаленная виртуальная машина.

    - Расширение уже существует на виртуальной машине, но не отображается ни для одной из служб.
    - Запустите скрипт предварительной регистрации.
    - Повторно зарегистрируйте расширение для того же компьютера на портале Azure. Для этого выберите **Резервное копирование** -> **Просмотр сведений** -> выберите соответствующую виртуальную машину Azure -> "Повторная регистрация".
    - После этого будут успешно запущены существующие резервные копии баз данных (из удаленной виртуальной машины).

2. У созданной виртуальной машины будет одно из двух:

    - имя, отличное от имени удаленной виртуальной машины;
    - то же имя, что и у удаленной виртуальной машины, но новая виртуальная машина будет находиться в другой группе ресурсов или подписке (по сравнению с удаленной виртуальной машиной).

    В этом случае выполните следующие действия:

    - Расширение уже существует на виртуальной машине, но не отображается ни для одной из служб.
    - Запустите скрипт предварительной регистрации.
    - Если вы выполните обнаружение и настроите защиту для новых баз данных, на портале начнут отображаться дубликаты активных баз данных. Чтобы избежать этого, [отключите защиту с сохранением данных](sap-hana-db-manage.md#stop-protection-for-an-sap-hana-database) для старых баз данных. Затем продолжите выполнение оставшихся действий.
    - Выполните обнаружение баз данных для включения резервного копирования.
    - Включите резервное копирование для этих баз данных.
    - Существующие резервные копии баз данных (из удаленной виртуальной машины) будут по-прежнему храниться в хранилище (их резервные копии сохраняются в соответствии с политикой).

### <a name="scenario-2"></a>Сценарий 2

Исходная виртуальная машина была реплицирована с помощью Azure Site Recovery или резервной копии виртуальной машины Azure. Новая виртуальная машина была создана на основе содержимого — для использования в качестве шаблона. Это новая виртуальная машина с новым идентификатором безопасности.

Чтобы включить резервное копирование на новой виртуальной машине, сделайте следующее:

- Расширение уже существует на виртуальной машине, но не отображается ни для одной из служб.
- Запустите скрипт предварительной регистрации. В зависимости от идентификатора безопасности новой виртуальной машины возможны два сценария:
  - У исходной виртуальной машины и новой виртуальной машины будет одинаковый идентификатор безопасности. Скрипт предварительной регистрации будет выполнен успешно.
  - У исходной виртуальной машины и новой виртуальной машины будут разные идентификаторы безопасности. При запуске скрипта предварительной регистрации произойдет сбой. В этом случае обратитесь в службу поддержки за помощью.
- Выполните обнаружение баз данных, для которых нужно создать резервную копию.
- Включите резервное копирование для этих баз данных.

## <a name="sdc-version-upgrade-or-mdc-version-upgrade-on-the-same-vm"></a>Обновление версии SDC или MDC на той же виртуальной машине

Обновление операционной системы, изменение версии SDC или MDC, которое не приводит к изменению идентификатора безопасности, можно выполнить следующим образом.

- Убедитесь, что новая версия ОС, SDC или MDC в настоящее время [поддерживается Azure Backup](sap-hana-backup-support-matrix.md#scenario-support).
- [Остановите защиту с сохранением данных для](sap-hana-db-manage.md#stop-protection-for-an-sap-hana-database) базы данных.
- Выполните обновление.
- Запустите скрипт предварительной регистрации повторно. Как правило, в процессе обновления удаляются необходимые роли. Выполнение скрипта предварительной регистрации поможет проверить все необходимые роли.
- Снова возобновите защиту базы данных.

## <a name="sdc-to-mdc-upgrade-with-no-change-in-sid"></a>Обновление с SDC до MDC без изменений идентификатора безопасности

Обновление с SDC до MDC, которое не приводит к изменению идентификатора безопасности, можно выполнить следующим образом.

- Убедитесь, что новая версия MDC в настоящее время [поддерживается Azure Backup](sap-hana-backup-support-matrix.md#scenario-support).
- [Остановите защиту с сохранением данных](sap-hana-db-manage.md#stop-protection-for-an-sap-hana-database) для старой базы данных SDC.
- Выполните обновление. После завершения система HANA станет MDC с системной базой данных и базами данных клиента.
- Запустите [скрипт предварительной регистрации](https://aka.ms/scriptforpermsonhana) повторно.
- Повторно зарегистрируйте расширение для того же компьютера на портале Azure. Для этого выберите **Резервное копирование** -> **Просмотр сведений** -> выберите соответствующую виртуальную машину Azure -> "Повторная регистрация".
- Выберите повторное **Обнаружение баз данных** для той же виртуальной машины. При этом новые базы данных из шага 3 должны отображаться как SYSTEMBD и клиентская база данных, а не SDC.
- Старая база данных SDC будет по-прежнему существовать в хранилище, а ее резервные копии данных будут храниться в соответствии с политикой.
- Настройте резервное копирование для этих баз данных.

## <a name="sdc-to-mdc-upgrade-with-a-change-in-sid"></a>Обновление с SDC до MDC с изменением идентификатора безопасности

Обновление с SDC до MDC, которое приводит к изменению идентификатора безопасности, можно выполнить следующим образом.

- Убедитесь, что новая версия MDC в настоящее время [поддерживается Azure Backup](sap-hana-backup-support-matrix.md#scenario-support).
- **Остановите защиту с сохранением данных** для старой базы данных SDC.
- Выполните обновление. После завершения система HANA станет MDC с системной базой данных и базами данных клиента.
- Повторно запустите [скрипт предварительной регистрации](https://aka.ms/scriptforpermsonhana) с правильными сведениями (новый идентификатор безопасности и MDC). Из-за изменения идентификатора безопасности могут возникнуть проблемы с выполнением скрипта. В таком случае обратитесь в службу поддержки Azure Backup.
- Повторно зарегистрируйте расширение для того же компьютера на портале Azure. Для этого выберите **Резервное копирование** -> **Просмотр сведений** -> выберите соответствующую виртуальную машину Azure -> "Повторная регистрация".
- Выберите повторное **Обнаружение баз данных** для той же виртуальной машины. При этом новые базы данных из шага 3 должны отображаться как SYSTEMBD и клиентская база данных, а не SDC.
- Старая база данных SDC будет по-прежнему существовать в хранилище, а ее резервные копии данных будут храниться в соответствии с политикой.
- Настройте резервное копирование для этих баз данных.

## <a name="re-registration-failures"></a>Сбои повторной регистрации

Перед запуском операции повторной регистрации проверьте наличие одного или нескольких следующих признаков.

- Все операции (такие как резервное копирование, восстановление и настройка резервного копирования) на виртуальной машине завершаются ошибкой с одним из следующих кодов: **WorkloadExtensionNotReachable, UserErrorWorkloadExtensionNotInstalled, WorkloadExtensionNotPresent, WorkloadExtensionDidntDequeueMsg**.
- Если в области **Backup Status** (Состояние резервного копирования) для элемента резервного копирования отображается **Недоступно**, исключите все остальные причины, которые могут привести к тому же состоянию:

  - отсутствие разрешения на выполнение операций, связанных с резервным копированием на виртуальной машине;
  - виртуальная машина выключена, поэтому невозможно выполнить резервное копирование;
  - проблемы с сетью.

Эти признаки могут возникнуть по одной или нескольким из следующих причин:

- Расширение удалено из портала.
- Восстановлено предыдущее состояние виртуальной машины с помощью восстановления с диска на месте.
- Виртуальная машина была выключена в течение длительного периода, поэтому срок действия конфигурации расширения на ней истек.
- Виртуальная машина была удалена, а затем была создана другая виртуальная машина с тем же именем и в той же группе ресурсов, что и удаленная виртуальная машина.

В предыдущих сценариях рекомендуется активировать повторную регистрацию на виртуальной машине.

## <a name="next-steps"></a>Дальнейшие действия

- Ознакомьтесь с [часто задаваемыми вопросами](./sap-hana-faq-backup-azure-vm.md) о резервном копировании баз данных SAP HANA на виртуальных машинах Azure.
