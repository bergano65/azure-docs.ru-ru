---
title: Резервное копирование баз данных SQL Server в Azure | Документация Майкрософт
description: Узнайте, как выполнить резервное копирование SQL Server в Azure. Здесь также описывается восстановление SQL Server.
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: tutorial
ms.date: 03/19/2019
ms.author: raynew
ms.openlocfilehash: 4eaaff859811e4d97cbd4f73231d702285792064
ms.sourcegitcommit: 8a59b051b283a72765e7d9ac9dd0586f37018d30
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2019
ms.locfileid: "58285451"
---
# <a name="about-sql-server-backup-in-azure-vms"></a>Сведения о резервном копировании SQL Server на виртуальных машинах Azure

Базы данных SQL Server являются критическими рабочими нагрузками, требующими низкой целевой точки восстановления (RPO) и долгосрочного хранения. Вы можете выполнить резервное копирование баз данных SQL Server в виртуальных машинах Azure с помощью [Azure Backup](backup-overview.md).

## <a name="backup-process"></a>Процесс резервного копирования

Это решение использует собственные API-интерфейсы SQL для создания резервных копий баз данных SQL.

* После того как вы укажете виртуальную машину SQL Server, которую нужно защитить, и выполните запрос баз данных на ней, служба Azure Backup установит на виртуальную машину расширение резервного копирования рабочих нагрузок с именем `AzureBackupWindowsWorkload`.
* Это расширение состоит из координатора и подключаемого модуля SQL. В то время как координатор отвечает за запуск рабочих процессов для различных операций, таких как настройка резервного копирования, резервное копирование и восстановление, подключаемый модуль отвечает за фактический поток данных.
* Чтобы иметь возможность обнаруживать базы данных на этой виртуальной машине, Azure Backup создает учетную запись `NT SERVICE\AzureWLBackupPluginSvc`. Эта учетная запись используется для резервного копирования и восстановления и требует разрешений системного администратора SQL. Azure Backup будет использовать учетную запись `NT AUTHORITY\SYSTEM` для обнаружения и запроса баз данных, поэтому эта учетная запись должна соответствовать общедоступному имени входа в SQL. Если вы не создавали виртуальную машину SQL Server из Azure Marketplace, может появиться ошибка **UserErrorSQLNoSysadminMembership**. В этом случае [выполните эти инструкции](backup-azure-sql-database.md).
* После того как вы запустите настройку защиты для выбранных баз данных, служба резервного копирования установит координатор с расписаниями резервного копирования и другими сведениями о политике, которые расширение кэширует локально на виртуальной машине. 
* В назначенное время координатор связывается с подключаемым модулем и начинает потоковую передачу данных резервного копирования с сервера SQL с помощью VDI.  
* Подключаемый модуль отправляет данные непосредственно в хранилище Служб восстановления, что устраняет необходимость в промежуточном хранении. Данные зашифрованы и хранятся службой Azure Backup в учетных записях хранения.
* Когда передача данных завершается, координатор подтверждает фиксацию с помощью службы резервного копирования.

  ![Архитектура службы резервного копирования SQL](./media/backup-azure-sql-database/backup-sql-overview.png)

## <a name="before-you-start"></a>Перед началом работы

Прежде чем начать, проверьте следующие компоненты:

1. Убедитесь, что у вас есть экземпляр SQL Server, работающий в Azure. Вы можете [быстро создать экземпляр SQL Server](../virtual-machines/windows/sql/quickstart-sql-vm-create-portal.md) в marketplace.
2. Просмотрите [рекомендации о функциях](#feature-consideration-and-limitations) и сведения о [поддержке сценариев](#scenario-support).
3. [Ознакомьтесь с часто задаваемыми вопросами об этом сценарии](faq-backup-sql-server.md).

## <a name="scenario-support"></a>Поддержка сценария

**Поддержка** | **Дополнительные сведения**
--- | ---
**Поддерживаемые развертывания** | Поддерживаются виртуальные машины Azure Marketplace SQL и не связанные с Marketplace виртуальные машины (установленный вручную SQL Server).
**Поддерживаемые географические регионы** | Юго-Восточная Австралия (ASE), Восточная Австралия (AE), <br> Южная Бразилия (BRS).<br> Центральная Канада (CNC), Восточная Канада (CE),<br> Юго-Восточная Азия (SEA), Восточная Азия (EA), <br> восточная часть США (EUS), восточная часть США 2 (EUS2), центрально-западная часть США (WCUS), западная часть США (WUS), западная часть США 2 (WUS 2), центрально-северная часть США (NCUS), центральная часть США (CUS), центрально-южная часть США (SCUS), <br> Центральная Индия (INC), Южная Индия (INS), <br> Восточная Япония (JPE), Западная Япония (JPW), <br> Республика Корея, центральный регион (KRC), Республика Корея, южный регион (KRS), <br> Северная Европа (NE), Западная Европа, <br> южная часть Соединенного Королевства (UKS), западная часть Соединенного Королевства (UKW).
**Поддерживаемые операционные системы** | Windows Server 2016, Windows Server 2012 R2 и Windows Server 2012<br/><br/> Linux в настоящее время не поддерживается.
**Поддерживаемые версии SQL Server** | SQL Server 2017; SQL Server 2016, SQL Server 2014, SQL Server 2012.<br/><br/> Enterprise, Standard, Web, Developer, Express.
**Поддерживаемые версии .NET** | На виртуальной машине установлен .NET Framework 4.5.2 или более поздняя версия.

## <a name="feature-consideration-and-limitations"></a>Рекомендации и ограничения касательно функций

- Резервное копирование SQL Server можно настроить на портале Azure или в **PowerShell**. Интерфейс командной строки не поддерживается.
- Виртуальной машине, на которой выполняется SQL Server, необходимо подключение к Интернету для доступа к общедоступным IP-адресам Azure.
- **Экземпляры отказоустойчивого кластера** SQL Server Always On не поддерживаются.
- Операции резервного копирования и восстановления для зеркальных баз данных и моментальных снимков базы данных не поддерживаются.
- Не используйте несколько решений для резервного копирования автономного экземпляра SQL Server или группы доступности SQL Always On, так как это может привести к сбою резервного копирования.
- Резервное копирование двух узлов группы доступности по отдельности с использованием одинаковых или разных решений также может привести к сбою резервного копирования. Azure Backup может обнаруживать и защищать все узлы, находящиеся в том же регионе, что и хранилище. Если группа доступности SQL Server Always On охватывает несколько регионов Azure, создайте резервную копию из региона, в котором есть первичный узел. Azure Backup может обнаруживать и защищать все базы данных в группе доступности в соответствии с установленным параметром резервного копирования.  
- Для **баз данных только для чтения** Azure Backup поддерживает только полные резервные копии и полные резервные копии только для копирования.
- Базу данных с большим числом файлов невозможно защитить. Максимальное число поддерживаемых файлов — **около 1000**.  
- Вы можете создать резервные копии **около 2000** баз данных SQL Server в хранилище. Если у вас больше баз данных, можно создать несколько хранилищ.
- Вы можете настроить резервное копирование до **50** баз данных за один раз. Это ограничение помогает оптимизировать нагрузку резервного копирования.
- Поддерживаются базы данных размером до **2 ТБ**. При работе с базами больших размеров могут возникнуть проблемы с производительностью.
- Чтобы понять, сколько баз данных можно защитить на одном сервере, необходимо учитывать такие факторы, как пропускная способность, размер виртуальной машины, частота резервного копирования, размер базы данных и т. д. Мы работаем над планировщиком, который поможет вам рассчитать это число самостоятельно. Мы опубликуем его в ближайшее время.
- В случае наличия групп доступности резервное копирование выполняется с разных узлов на основе нескольких факторов. Поведение резервного копирования для группы доступности представлено ниже.

### <a name="backup-behavior-in-case-of-always-on-availability-groups"></a>Поведение резервного копирования в случае наличия групп доступности Always On

В зависимости от установленного параметра резервного копирования и типов резервных копий (полная, разностная, резервная копия журналов, полная резервная копия только для копирования) резервные копии создаются с определенного узла (первичного или вторичного).

- **Параметр резервного копирования: первичный узел**

**Тип резервного копирования** | **Node**
    --- | ---
    Полное | Первичная
    Разностная | Первичная
    Журнал |  Первичная
    Полная резервная копия (только копирование) |  Первичная

- **Параметр резервного копирования: только вторичный узел**

**Тип резервного копирования** | **Node**
--- | ---
Полное | Первичная
Разностная | Первичная
Журнал |  Вторичная
Полная резервная копия (только копирование) |  Вторичная

- **Параметр резервного копирования: вторичный узел**

**Тип резервного копирования** | **Node**
--- | ---
Полное | Первичная
Разностная | Первичная
Журнал |  Вторичная
Полная резервная копия (только копирование) |  Вторичная

- **Без параметров резервного копирования**

**Тип резервного копирования** | **Node**
--- | ---
Полное | Первичная
Разностная | Первичная
Журнал |  Вторичная
Полная резервная копия (только копирование) |  Вторичная

## <a name="fix-sql-sysadmin-permissions"></a>Исправление разрешений sysadmin SQL

  Если вам требуется исправить разрешения из-за ошибки **UserErrorSQLNoSysadminMembership**, сделайте следующее:

  1. Войдите в SQL Server Management Studio (SSMS) с помощью учетной записи, имеющей разрешение sysadmin SQL Server. Если вам не требуются специальные разрешения, можно использовать проверку подлинности Windows.
  2. На сервере SQL Server последовательно откройте папки **Security (Безопасность) и Logins (Имена входа)**.

      ![Открытие папки "Безопасность/Имена для входа" для просмотра учетных записей](./media/backup-azure-sql-database/security-login-list.png)

  3. Щелкните правой кнопкой мыши папку **Имена для входа** и выберите **Создать имя для входа**. В меню **Создание имени входа** выберите **Поиск**.

      ![Выбор "Найти" в диалоговом окне "Login - New" (Создание имени для входа)](./media/backup-azure-sql-database/new-login-search.png)

  4. Учетная запись виртуальной службы Windows **NT SERVICE\AzureWLBackupPluginSvc** была создана во время регистрации виртуальной машины и обнаружения баз данных SQL. Введите имя учетной записи, как показано в поле **Введите имя объекта**. Выберите **Проверить имена**, чтобы разрешить имя. Последовательно выберите **ОК**.

      ![Выбор "Проверить имена" для разрешения имени неизвестной службы](./media/backup-azure-sql-database/check-name.png)

  5. Убедитесь, что в качестве **роли сервера** выбрана роль **sysadmin**. Последовательно выберите **ОК**. Теперь должны существовать необходимые разрешения.

      ![Убедитесь, что для сервера выбрана роль sysadmin.](./media/backup-azure-sql-database/sysadmin-server-role.png)

  6. Теперь свяжите базу данных с хранилищем Служб восстановления. В списке **Защищенные серверы** на портале Azure щелкните правой кнопкой мыши сервер, на котором произошла ошибка, и выберите **Повторно обнаружить базы данных**.

      ![Проверка наличия у сервера соответствующих разрешений](./media/backup-azure-sql-database/check-erroneous-server.png)

  7. Проверьте ход выполнения в области **Уведомления**. Когда выбранные базы данных будут найдены, появится сообщение об успешном завершении.

      ![Сообщение об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)


## <a name="next-steps"></a>Дополнительная информация

- Дополнительные сведения о резервном копировании баз данных SQL Server см. в [этой статье](backup-sql-server-database-azure-vms.md).
- Дополнительные сведения о восстановлении резервных копий баз данных SQL Server см. в [этой статье](restore-sql-database-azure-vm.md).
- Дополнительные сведения об управлении резервными копиями баз данных SQL Server см. в [этой статье](manage-monitor-sql-database-backup.md).
