---
title: Резервное копирование баз данных SQL Server в Azure
description: This article explains how to back up SQL Server to Azure. Здесь также описывается восстановление SQL Server.
ms.topic: conceptual
ms.date: 06/18/2019
ms.openlocfilehash: 39f2348a95be95a03dada45d48952dce99ec4ec7
ms.sourcegitcommit: 95931aa19a9a2f208dedc9733b22c4cdff38addc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/25/2019
ms.locfileid: "74462589"
---
# <a name="about-sql-server-backup-in-azure-vms"></a>Сведения о резервном копировании SQL Server на виртуальных машинах Azure

Базы данных SQL Server являются критическими рабочими нагрузками, требующими низкой целевой точки восстановления (RPO) и долгосрочного хранения. Вы можете создать резервную копию баз данных SQL Server в виртуальных машинах Azure с помощью [Azure Backup](backup-overview.md).

## <a name="backup-process"></a>Процесс резервного копирования

Это решение использует собственные API-интерфейсы SQL для создания резервных копий баз данных SQL.

* После того как вы укажете виртуальную машину SQL Server, которую нужно защитить, и выполните запрос баз данных на ней, служба Azure Backup установит на виртуальную машину расширение резервного копирования рабочих нагрузок с именем `AzureBackupWindowsWorkload`.
* Это расширение состоит из координатора и подключаемого модуля SQL. В то время как координатор отвечает за запуск рабочих процессов для различных операций, таких как настройка резервного копирования, резервное копирование и восстановление, подключаемый модуль отвечает за фактический поток данных.
* Чтобы иметь возможность обнаруживать базы данных на этой виртуальной машине, Azure Backup создает учетную запись `NT SERVICE\AzureWLBackupPluginSvc`. Эта учетная запись используется для резервного копирования и восстановления и требует разрешений системного администратора SQL. `NT SERVICE\AzureWLBackupPluginSvc` — это [учетная запись виртуальной службы](https://docs.microsoft.com/windows/security/identity-protection/access-control/service-accounts#virtual-accounts), поэтому для нее не требуется управление паролями. Azure Backup будет использовать учетную запись `NT AUTHORITY\SYSTEM` для обнаружения и запроса баз данных, поэтому эта учетная запись должна соответствовать общедоступному имени входа в SQL. Если вы не создавали виртуальную машину SQL Server из Azure Marketplace, может появиться ошибка **UserErrorSQLNoSysadminMembership**. В этом случае [выполните эти инструкции](#set-vm-permissions).
* Когда вы запустите настройку защиты для выбранных баз данных, служба резервного копирования установит координатор с расписаниями резервного копирования и другими сведениями о политике, которые расширение кэширует локально на виртуальной машине.
* В назначенное время координатор связывается с подключаемым модулем и начинает потоковую передачу данных резервного копирования с сервера SQL с помощью VDI.  
* Подключаемый модуль отправляет данные непосредственно в хранилище Служб восстановления, что устраняет необходимость в промежуточном хранении. Данные зашифрованы и хранятся службой Azure Backup в учетных записях хранения.
* Когда передача данных завершается, координатор подтверждает фиксацию с помощью службы резервного копирования.

  ![Архитектура службы резервного копирования SQL](./media/backup-azure-sql-database/backup-sql-overview.png)

## <a name="before-you-start"></a>Перед началом работы

Прежде чем начать, проверьте следующее:

1. Убедитесь, что у вас есть экземпляр SQL Server, работающий в Azure. Вы можете [быстро создать экземпляр SQL Server](../virtual-machines/windows/sql/quickstart-sql-vm-create-portal.md) в marketplace.
2. Просмотрите [рекомендации о функциях](#feature-consideration-and-limitations) и сведения о [поддержке сценариев](#scenario-support).
3. [Ознакомьтесь с часто задаваемыми вопросами об этом сценарии](faq-backup-sql-server.md).

## <a name="scenario-support"></a>Поддержка сценария

**Поддержка** | **Дополнительные сведения**
--- | ---
**Поддерживаемые развертывания** | Поддерживаются виртуальные машины Azure Marketplace SQL и не связанные с Marketplace виртуальные машины (установленный вручную SQL Server).
**Поддерживаемые географические регионы** | Юго-Восточная Австралия (ASE), Восточная Австралия (AE), Центральная Австралия (AC), Центральная Австралия 2 (AC 2) <br> Южная Бразилия (BRS).<br> Центральная Канада (CNC), Восточная Канада (CE),<br> Юго-Восточная Азия (SEA), Восточная Азия (EA), <br> восточная часть США (EUS), восточная часть США 2 (EUS2), центрально-западная часть США (WCUS), западная часть США (WUS), западная часть США 2 (WUS 2), центрально-северная часть США (NCUS), центральная часть США (CUS), центрально-южная часть США (SCUS), <br> Центральная Индия (INC), Южная Индия (INS), Западная Индия <br> Восточная Япония (JPE), Западная Япония (JPW), <br> Республика Корея, центральный регион (KRC), Республика Корея, южный регион (KRS), <br> Северная Европа (NE), Западная Европа, <br> южная часть Соединенного Королевства (UKS), западная часть Соединенного Королевства (UKW). <br> US Gov (Аризона), US Gov (Вирджиния), US Gov (Техас), центральный регион US DoD, восточный регион US DoD <br> Северная Германия, Центрально-Западная Германия <br> Северная Швейцария, Западная Швейцария <br> Центральная Франция <br> Восточный Китай, Восточный Китай 2, Северный Китай, Северный Китай 2
**Поддерживаемые операционные системы** | Windows Server 2019, Windows Server 2016, Windows Server 2012, Windows Server 2008 R2 с пакетом обновления 1 (SP1) <br/><br/> Linux в настоящее время не поддерживается.
**Поддерживаемые версии SQL Server** | SQL Server 2019, SQL Server 2017, как описано на странице [поиска жизненного цикла приложения](https://support.microsoft.com/lifecycle/search?alpha=SQL%20server%202017), SQL Server 2016 и SharePoint Server, как описано на странице [поиска жизненного цикла приложения](https://support.microsoft.com/lifecycle/search?alpha=SQL%20server%202016%20service%20pack), SQL Server 2014, SQL Server 2012, SQL Server 2008 R2, SQL Server 2008 <br/><br/> Enterprise, Standard, Web, Developer, Express.
**Поддерживаемые версии .NET** | Виртуальная машина с .NET Framework версии 4.5.2 и выше.

## <a name="feature-consideration-and-limitations"></a>Рекомендации и ограничения касательно функций

* Резервное копирование SQL Server можно настроить на портале Azure или в **PowerShell**. Интерфейс командной строки не поддерживается.
* Решение поддерживается на обоих типах [развертываний](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-deployment-model) — виртуальные машины Azure Resource Manager и классические виртуальные машины.
* Виртуальной машине, на которой выполняется SQL Server, необходимо подключение к Интернету для доступа к общедоступным IP-адресам Azure.
* SQL Server **Failover Cluster Instance (FCI)** is not supported.
* Операции создания резервной копии и восстановления для зеркальных баз данных и моментальных снимков базы данных не поддерживаются.
* Не используйте несколько решений для резервного копирования автономного экземпляра SQL Server или группы доступности SQL Always On, так как это может привести к сбою резервного копирования.
* Резервное копирование двух узлов группы доступности по отдельности с использованием одинаковых или разных решений также может привести к сбою резервного копирования.
* Для **баз данных только для чтения** Azure Backup поддерживает только полные резервные копии и полные резервные копии только для копирования.
* Базу данных с большим числом файлов невозможно защитить. Максимальное число поддерживаемых файлов — **около 1000**.  
* Вы можете создать резервные копии **около 2000** баз данных SQL Server в хранилище. Если у вас больше баз данных, можно создать несколько хранилищ.
* Вы можете настроить резервное копирование до **50** баз данных за один раз. Это ограничение помогает оптимизировать нагрузку резервного копирования.
* We support databases up to **2 TB** in size; for sizes greater than that performance issues may come up.
* To have a sense of as to how many databases can be protected per server, we need to consider factors such as bandwidth, VM size, backup frequency, database size, etc. [Download](https://download.microsoft.com/download/A/B/5/AB5D86F0-DCB7-4DC3-9872-6155C96DE500/SQL%20Server%20in%20Azure%20VM%20Backup%20Scale%20Calculator.xlsx) the resource planner that gives the approximate number of databases you can have per server based on the VM resources and the backup policy.
* В случае наличия групп доступности резервное копирование выполняется с разных узлов на основе нескольких факторов. Поведение резервного копирования для группы доступности представлено ниже.

### <a name="back-up-behavior-in-case-of-always-on-availability-groups"></a>Поведение создания резервной копии при наличии групп доступности Always On

Мы советуем, чтобы резервное копирование настраивалось только на одном узле группы доступности. Резервное копирование всегда должно быть настроено в одном регионе с основным узлом. Другими словами, необходимо, чтобы основной узел всегда присутствовал в регионе, в котором вы настраиваете резервное копирование. Если все узлы группы доступности находятся в одном регионе с настраиваемым резервным копированием, то об этом можно не беспокоиться.

#### <a name="for-cross-region-ag"></a>Группа доступности перехода в другой регион

* Независимо от параметров резервного копирования резервные копии не создаются из узлов, которые не находятся в том же регионе, где настроена архивация. Так как резервное копирование между регионами не поддерживается. Если у вас есть только 2 узла и второстепенный узел в другом регионе. В этом случае резервные копии будут продолжать выполняться с основного узла (если только не установлен параметр резервного копирования — "только вторичный узел").
* В случае отработки отказа в регионе, отличном от того, в котором настроено резервное копирование, архивация на узлах в таком регионе завершится сбоем.

В зависимости от установленного параметра резервного копирования и типов резервных копий (полная, разностная, резервная копия журналов, полная резервная копия только для копирования) резервные копии создаются с определенного узла (первичного или вторичного).

* **Backup preference: Primary**

**Тип резервного копирования** | **Node**
    --- | ---
    Полная | Первичная
    Разностная | Первичная
    Журнал |  Первичная
    Полная резервная копия (только копирование) |  Первичная

* **Backup preference: Secondary Only**

**Тип резервного копирования** | **Node**
--- | ---
Полная | Первичная
Разностная | Первичная
Журнал |  Вторичная
Полная резервная копия (только копирование) |  Вторичная

* **Backup preference: Secondary**

**Тип резервного копирования** | **Node**
--- | ---
Полная | Первичная
Разностная | Первичная
Журнал |  Вторичная
Полная резервная копия (только копирование) |  Вторичная

* **Без параметров резервного копирования**

**Тип резервного копирования** | **Node**
--- | ---
Полная | Первичная
Разностная | Первичная
Журнал |  Вторичная
Полная резервная копия (только копирование) |  Вторичная

## <a name="set-vm-permissions"></a>Настройка разрешений виртуальной машины

  При запуске обнаружения в SQL Server Azure Backup выполнит следующие действия.

* Добавляет расширение AzureBackupWindowsWorkload.
* Чтобы обнаруживать базы данных на виртуальной машине, Azure Backup создает учетную запись NT SERVICE\AzureWLBackupPluginSvc. Эта учетная запись используется для резервного копирования и восстановления и требует разрешений системного администратора SQL.
* Для предоставления баз данных, запущенных на виртуальной машине, Azure Backup использует учетную запись NT AUTHORITY\SYSTEM. Эта учетная запись должна быть общедоступной для входа в SQL.

Если вы не создавали виртуальную машину SQL Server в Azure Marketplace или если вы используете SQL 2008 и SQL 2008 R2, может появиться ошибка **UserErrorSQLNoSysadminMembership**.

Сведения о предоставленных разрешениях для **SQL 2008** и **SQL 2008 R2** используемых в Windows 2008 R2, см. в [статье](#give-sql-sysadmin-permissions-for-sql-2008-and-sql-2008-r2).

Для всех остальных версий следует исправить разрешения с помощью следующих шагов.

  1. Войдите в SQL Server Management Studio (SSMS) с помощью учетной записи, имеющей разрешение sysadmin SQL Server. Если вам не требуются специальные разрешения, можно использовать проверку подлинности Windows.
  2. На сервере SQL Server последовательно откройте папки **Security (Безопасность) и Logins (Имена входа)** .

      ![Открытие папки "Безопасность/Имена для входа" для просмотра учетных записей](./media/backup-azure-sql-database/security-login-list.png)

  3. Щелкните правой кнопкой мыши папку **Имена для входа** и выберите **Создать имя для входа**. В меню **Создание имени входа** выберите **Поиск**.

      ![Выбор "Найти" в диалоговом окне "Login - New" (Создание имени для входа)](./media/backup-azure-sql-database/new-login-search.png)

  4. Учетная запись виртуальной службы Windows **NT SERVICE\AzureWLBackupPluginSvc** была создана во время регистрации виртуальной машины и обнаружения баз данных SQL. Введите имя учетной записи, как показано в поле **Введите имя объекта**. Выберите **Проверить имена**, чтобы разрешить имя. Последовательно выберите **ОК**.

      ![Выбор "Проверить имена" для разрешения имени неизвестной службы](./media/backup-azure-sql-database/check-name.png)

  5. Убедитесь, что в качестве **роли сервера** выбрана роль **sysadmin**. Последовательно выберите **ОК**. Теперь должны существовать необходимые разрешения.

      ![Убедитесь, что для сервера выбрана роль sysadmin.](./media/backup-azure-sql-database/sysadmin-server-role.png)

  6. Теперь свяжите базу данных с хранилищем Служб восстановления. В списке **Защищенные серверы** на портале Azure щелкните правой кнопкой мыши сервер, на котором произошла ошибка, и выберите **Повторно обнаружить базы данных**.

      ![Проверка наличия у сервера соответствующих разрешений](./media/backup-azure-sql-database/check-erroneous-server.png)

  7. Проверьте ход выполнения в области **Уведомления**. Когда выбранные базы данных будут найдены, появится сообщение об успешном завершении.

      ![Сообщение об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)

> [!NOTE]
> Если в среде SQL Server установлено несколько экземпляров SQL Server, то необходимо добавить разрешение sysadmin для учетной записи **NT Service\AzureWLBackupPluginSvc** для всех этих экземпляров.

### <a name="give-sql-sysadmin-permissions-for-sql-2008-and-sql-2008-r2"></a>Присвоение разрешений администратора SQL в SQL 2008 и SQL 2008 R2

Добавьте в экземпляр SQL Server имена входа **NT AUTHORITY\SYSTEM** и **NT Service\AzureWLBackupPluginSvc**.

1. Перейдите к экземпляру SQL Server в обозревателе объектов.
2. Перейдите в раздел "Безопасность -> Имена входа"
3. Щелкните правой кнопкой мыши "Имена входа", и выберите *Создать имя входа...*

    ![Создание имени входа с помощью SSMS](media/backup-azure-sql-database/sql-2k8-new-login-ssms.png)

4. Перейдите на вкладку "Общие" и в качестве имени входа введите **NT AUTHORITY\SYSTEM**.

    ![Имя входа для SSMS](media/backup-azure-sql-database/sql-2k8-nt-authority-ssms.png)

5. Перейдите к *Роли сервера* и выберите такие роли, как *общедоступная* и *администратор*.

    ![Выбор ролей в SSMS](media/backup-azure-sql-database/sql-2k8-server-roles-ssms.png)

6. Перейдите в раздел *Состояние*. *Предоставить* разрешение на подключение к ядру СУБД и вход как *Включено*.

    ![Предоставление разрешений в SSMS](media/backup-azure-sql-database/sql-2k8-grant-permission-ssms.png)

7. Нажмите кнопку ОК.
8. Чтобы добавить имя для входа NT Service\AzureWLBackupPluginSvc в экземпляр SQL Server, повторите ту же последовательность шагов (1 - 7 приведенных выше). Если имя для входа уже существует, убедитесь, что ему присвоена роль администратора сервера и в разделе состояния этому имени предоставлено разрешение на подключение к ядру СУБД и вход в качестве включено.
9. After granting permission, **Rediscover DBs** in the portal: Vault **->** Backup Infrastructure **->** Workload in Azure VM:

    ![Повторное обнаружение баз данных на портале Azure](media/backup-azure-sql-database/sql-rediscover-dbs.png)

Кроме этого, можно автоматизировать раздачу разрешений путем выполнения следующих команд PowerShell в режиме администратора. По умолчанию в качестве имени экземпляра устанавливается значение MSSQLSERVER. Если возникнет необходимость, то в скрипте можно изменить имя экземпляра если изменить его аргумент.

```powershell
param(
    [Parameter(Mandatory=$false)]
    [string] $InstanceName = "MSSQLSERVER"
)
if ($InstanceName -eq "MSSQLSERVER")
{
    $fullInstance = $env:COMPUTERNAME   # In case it is the default SQL Server Instance
}
else
{
    $fullInstance = $env:COMPUTERNAME + "\" + $InstanceName   # In case of named instance
}
try
{
    sqlcmd.exe -S $fullInstance -Q "sp_addsrvrolemember 'NT Service\AzureWLBackupPluginSvc', 'sysadmin'" # Adds login with sysadmin permission if already not available
}
catch
{
    Write-Host "An error occurred:"
    Write-Host $_.Exception|format-list -force
}
try
{
    sqlcmd.exe -S $fullInstance -Q "sp_addsrvrolemember 'NT AUTHORITY\SYSTEM', 'sysadmin'" # Adds login with sysadmin permission if already not available
}
catch
{
    Write-Host "An error occurred:"
    Write-Host $_.Exception|format-list -force
}
```

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о резервном копировании баз данных SQL Server см. в [этой статье](backup-sql-server-database-azure-vms.md).
* Дополнительные сведения о восстановлении резервных копий баз данных SQL Server см. в [этой статье](restore-sql-database-azure-vm.md).
* Дополнительные сведения об управлении резервными копиями баз данных SQL Server см. в [этой статье](manage-monitor-sql-database-backup.md).
