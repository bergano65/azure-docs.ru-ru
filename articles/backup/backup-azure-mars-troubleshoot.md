---
title: Устранение неполадок агента Azure Backup
description: Устранение неполадок при установке и регистрации агента Azure Backup
ms.reviewer: saurse
author: dcurwin
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 07/15/2019
ms.author: dacurwin
ms.openlocfilehash: 2ff5d760579c31c4bd11252e09da1cbb94576229
ms.sourcegitcommit: 0f54f1b067f588d50f787fbfac50854a3a64fff7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/12/2019
ms.locfileid: "68954657"
---
# <a name="troubleshoot-the-microsoft-azure-recovery-services-mars-agent"></a>Устранение неполадок агента Службы восстановления Microsoft Azure (MARS)

В этой статье описывается, как устранить ошибки, которые могут возникнуть во время настройки, регистрации, резервного копирования и восстановления.

## <a name="basic-troubleshooting"></a>Базовое устранение неполадок

Перед началом устранения неполадок агента служб восстановления Azure (MARS) рекомендуется проверить следующее:

- [Убедитесь, что агент Mars обновлен](https://go.microsoft.com/fwlink/?linkid=229525&clcid=0x409).
- [Убедитесь в наличии сетевого подключения между агентом MARS и Azure](https://aka.ms/AB-A4dp50).
- Убедитесь, что режим MARS выполняется (в консоли службы). Если необходимо, перезапустите и повторите операцию.
- [Убедитесь, что на диске с объемом от 5% до 10% доступно свободное место в папке временных файлов](https://aka.ms/AB-AA4dwtt).
- [Проверьте, мешает ли другой процесс или антивирусному программному обеспечению Azure Backup](https://aka.ms/AB-AA4dwtk).
- Если запланированное резервное копирование завершается сбоем, но резервное копирование выполняется вручную, см. раздел Резервное копирование [не выполняется в соответствии](https://aka.ms/ScheduledBackupFailManualWorks)
- Убедитесь, что в ОС установлены последние обновления.
- [Убедитесь, что из резервной копии исключены неподдерживаемые диски и файлы с](backup-support-matrix-mars-agent.md#supported-drives-or-volumes-for-backup)неподдерживаемыми атрибутами.
- Убедитесь, что часы в защищенной системе настроены на правильный часовой пояс.
- [Убедитесь, что на сервере установлен .NET Framework 4.5.2 или более поздней версии](https://www.microsoft.com/download/details.aspx?id=30653).
- Если вы пытаетесь повторно зарегистрировать сервер в хранилище, выполните следующие действия.
  - Убедитесь, что агент удален на сервере и удаляется с портала.
  - Используйте ту же парольную фразу, которая была первоначально использована для регистрации сервера.
- Для автономных резервных копий перед началом резервного копирования убедитесь, что Azure PowerShell 3.7.0 установлен на компьютере источника и копии.
- Если агент резервного копирования работает на виртуальной машине Azure, см. [эту статью](https://aka.ms/AB-AA4dwtr).

## <a name="invalid-vault-credentials-provided"></a>Указаны недопустимые учетные данные хранилища

**Сообщение об ошибке** Указаны недопустимые учетные данные хранилища. Файл либо поврежден, либо не содержит последних учетных данных, связанных со службой восстановления. (ID: 34513)

| Причина: | Рекомендуемые действия |
| ---     | ---    |
| **Учетные данные хранилища недействительны** <br/> <br/> Возможно, файлы учетных данных хранилища повреждены или срок их действия истек. (Например, они могли быть загружены более 48 часов до момента регистрации.)| Скачайте новые учетные данные из хранилища служб восстановления на портал Azure. (См. шаг 6 в разделе [Загрузка агента Mars](https://docs.microsoft.com/azure/backup/backup-configure-vault#download-the-mars-agent) ). Затем выполните следующие действия: <ul><li> Если вы уже установили и зарегистрировали режим MARS, откройте консоль MMC Microsoft Azure Backup Agent и выберите пункт **зарегистрировать сервер** в области **действия** , чтобы завершить регистрацию с новыми учетными данными. <br/> <li> В случае сбоя новой установки попробуйте переустановить с новыми учетными данными.</ul> **Примечание**. Если загружено несколько файлов учетных данных хранилища, в течение следующих 48 часов будет действителен только последний файл. Рекомендуется скачать новый файл учетных данных хранилища.
| **Регистрация в прокси-сервере или брандмауэре блокируется** <br/>или диспетчер конфигурации служб <br/>**Нет подключения к Интернету** <br/><br/> Если на компьютере или прокси-сервере ограничено подключение к Интернету и вы не гарантируете доступ к необходимым URL-адресам, регистрация завершится ошибкой.| Выполните следующие действия.<br/> <ul><li> Поработайте с ИТ, чтобы убедиться, что система подключена к Интернету.<li> Если у вас нет прокси-сервера, при регистрации агента убедитесь, что параметр прокси-сервер не выбран. [Проверьте параметры прокси-сервера](#verifying-proxy-settings-for-windows).<li> Если у вас есть брандмауэр или прокси-сервер, обратитесь к группе работы с сетью, чтобы убедиться, что эти URL-адреса и IP-адрес имеют доступ:<br/> <br> **URL-адреса**<br> `www.msftncsi.com` <br> . Microsoft.com <br> . WindowsAzure.com <br> . microsoftonline.com <br> . windows.net <br>**IP-адреса**<br>  20.190.128.0/18 <br>  40.126.0.0/18 <br/></ul></ul>Повторите попытку регистрации после выполнения описанных выше действий по устранению неполадок.
| **Антивирусная программа блокирует регистрацию** | Если на сервере установлено антивирусное программное обеспечение, добавьте необходимые правила исключения в антивирусную проверку для следующих файлов и папок: <br/><ul> <li> CBengine.exe. <li> CSC. exe<li> Вспомогательная папка. По умолчанию используется папка C:\Program Files\Microsoft Azure Recovery Services Ажент\скратч. <li> Папка Bin в папке C:\Program Files\Microsoft Azure Recovery Services Ажент\бин.

### <a name="additional-recommendations"></a>Дополнительные рекомендации
- Перейдите к папке C:/Windows/Temp, и если там скопилось более 60 000 или 65 000 файлов (с расширением TMP), удалите эти файлы.
- Убедитесь, что дата и время на компьютере соответствуют местному часовому поясу.
- Убедитесь, что [эти сайты](backup-configure-vault.md#verify-internet-access) добавлены на надежные сайты в Internet Explorer.

### <a name="verifying-proxy-settings-for-windows"></a>Проверка параметров прокси-сервера для Windows

1. Скачайте PsExec со страницы [Sysinternals](https://docs.microsoft.com/sysinternals/downloads/psexec) .
1. Запустите `psexec -i -s "c:\Program Files\Internet Explorer\iexplore.exe"` из командной строки с повышенными привилегиями.

   Эта команда открывает Internet Explorer.
1. Выберите **инструменты** > **Интернет свойства** > подключениясетевые > **Параметры**.
1. Проверьте параметры прокси-сервера для системной учетной записи.
1. Если прокси-сервер не настроен и указаны сведения о прокси-сервере, удалите эти сведения.
1. Если прокси-сервер настроен и сведения о прокси-сервере неверны, убедитесь в правильности **IP-адреса и порта прокси-сервера** .
1. Закройте Internet Explorer.

## <a name="unable-to-download-vault-credential-file"></a>Не удалось скачать файл учетных данных хранилища

| Error   | Рекомендуемые действия |
| ---     | ---    |
|Не удалось скачать файл учетных данных хранилища. (ID: 403) | <ul><li> Попробуйте скачать учетные данные хранилища с помощью другого браузера или выполните следующие действия: <ul><li> Запустите Internet Explorer. Выберите F12. </li><li> Перейдите на вкладку **сеть** и очистите кэш и файлы cookie. </li> <li> Обновите страницу.<br></li></ul> <li> Проверьте, отключена ли подписка или истек ее срок действия.<br></li> <li> Проверьте, блокирует ли какое-либо правило брандмауэра скачивание. <br></li> <li> Убедитесь, что вы не исчерпали ограничение на хранилище (50 компьютеров на хранилище).<br></li>  <li> Убедитесь, что у пользователя есть разрешения Azure Backup, необходимые для загрузки учетных данных хранилища и регистрации сервера в хранилище. См. раздел [Использование управления доступом на основе ролей для управления Azure Backup точек восстановления](backup-rbac-rs-vault.md).</li></ul> |

## <a name="the-microsoft-azure-recovery-service-agent-was-unable-to-connect-to-microsoft-azure-backup"></a>Агенту службы восстановления Microsoft Azure не удалось подключиться к службе Microsoft Azure Backup

| Error  | Возможная причина | Рекомендуемые действия |
| ---     | ---     | ---    |
| <br /><ul><li>Агенту службы восстановления Microsoft Azure не удалось подключиться к Microsoft Azure Backup. (ID: 100050) Проверьте параметры сети и убедитесь, что вы можете подключиться к Интернету.<li>(407) требуется проверка подлинности прокси-сервера. |Подключение блокируется прокси-сервером. |  <ul><li>В Internet Explorer откройте **меню Сервис** > **Свойства** > обозревателя**Безопасность** > **Интернет**. Выберите **Пользовательский уровень** и прокрутите вниз до раздела **скачивание файла** . Нажмите кнопку **Включить**.<p>Также может потребоваться добавить URL-адреса [и IP-адреса](backup-configure-vault.md#verify-internet-access) на надежные сайты в Internet Explorer.<li>Измените параметры для использования прокси-сервера. Затем введите сведения о прокси-сервере.<li> Если компьютер имеет ограниченный доступ к Интернету, убедитесь, что параметры брандмауэра на компьютере или прокси-сервере разрешают указанные [URL-адреса](backup-configure-vault.md#verify-internet-access). <li>Если на сервере установлено антивирусное программное обеспечение, исключите эти файлы из антивирусной проверки: <ul><li>CBEngine.exe (вместо dpmra.exe).<li>CSC.exe (связан с .NET Framework). Для каждой .NET Framework версии, установленной на сервере, имеется файл CSC. exe. Исключите файлы CSC. exe для всех версий .NET Framework на затронутом сервере. <li>Вспомогательная папка или расположение кэша. <br>Расположение вспомогательной папки по умолчанию или путь к кэшу — C:\Program Files\Microsoft Azure Recovery Services Ажент\скратч.<li>Папка Bin в папке C:\Program Files\Microsoft Azure Recovery Services Ажент\бин.


## <a name="failed-to-set-the-encryption-key-for-secure-backups"></a>Не удалось настроить ключ шифрования для защиты резервных копий.

| Error | Возможные причины | Рекомендуемые действия |
| ---     | ---     | ---    |
| <br />Не удалось настроить ключ шифрования для безопасной архивации. Активация не выполнена полностью, но парольная фраза для шифрования сохранена в следующем файле. |<li>Сервер уже зарегистрирован в другом хранилище.<li>При настройке повреждена парольная фраза.| Отмените регистрацию сервера в хранилище и повторно зарегистрируйте его с помощью новой парольной фразы.

## <a name="the-activation-did-not-complete-successfully"></a>Активация не была успешно завершена

| Error  | Возможные причины | Рекомендуемые действия |
|---------|---------|---------|
|<br />Активация не выполнена. Сбой текущей операции из-за внутренней ошибки в службе [0x1FC07]. Повторите операцию позднее. Если проблему не удается устранить, обратитесь в службу поддержки Майкрософт.     | <li> Временная папка находится на томе, на котором недостаточно места. <li> Временная папка была неправильно перемещена. <li> Отсутствует файл OnlineBackup.KEK.         | <li>Обновите агент MARS до [последней версии](https://aka.ms/azurebackup_agent) .<li>Переместите вспомогательную папку или расположение кэша на том с свободным пространством от 5% до 10% от общего размера данных резервной копии. Чтобы правильно переместить расположение кэша, ознакомьтесь с [общими вопросами о резервном копировании файлов и папок](https://docs.microsoft.com/azure/backup/backup-azure-file-folder-backup-faq#manage-the-backup-cache-folder).<li> Убедитесь, что присутствует файл OnlineBackup.KEK. <br>*По умолчанию для временной папки или пути кэша используется папка C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch*.        |

## <a name="encryption-passphrase-not-correctly-configured"></a>Парольная фраза для шифрования неправильно настроена

| Error  | Возможные причины | Рекомендуемые действия |
|---------|---------|---------|
| <br />Ошибка 34506. Парольная фраза для шифрования, хранящаяся на этом компьютере, настроена неправильно.    | <li> Временная папка находится на томе, на котором недостаточно места. <li> Временная папка была неправильно перемещена. <li> Отсутствует файл OnlineBackup.KEK.        | <li>Обновите агент MARS до [последней версии](https://aka.ms/azurebackup_agent).<li>Переместите вспомогательную папку или расположение кэша на том с свободным пространством от 5% до 10% от общего размера данных резервной копии. Чтобы правильно переместить расположение кэша, ознакомьтесь с [общими вопросами о резервном копировании файлов и папок](https://docs.microsoft.com/azure/backup/backup-azure-file-folder-backup-faq#manage-the-backup-cache-folder).<li> Убедитесь, что присутствует файл OnlineBackup.KEK. <br>*По умолчанию для временной папки или пути кэша используется папка C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch*.         |


## <a name="backups-dont-run-according-to-schedule"></a>Резервные копии не выполняются в соответствии с расписанием
Если запланированные резервные копии не инициируются автоматически, но ручное резервное копирование работает правильно, попробуйте выполнить следующие действия.

- Убедитесь, что расписание резервного копирования Windows Server не конфликтует с расписанием архивации файлов и папок Azure.

- Убедитесь, что для состояния оперативной архивации задано значение **включено**. Чтобы проверить состояние, сделайте следующее:

  1. В планировщик задач разверните узел **Майкрософт** и выберите **оперативная архивация**.
  1. Дважды щелкните **Microsoft-OnlineBackup** и перейдите на вкладку **триггеры** .
  1. Проверьте, имеет ли состояние значение **включено**. Если это не так, выберите пункт **изменить**, выберите **включено**и нажмите кнопку **ОК**.

- Убедитесь, что учетная запись пользователя, выбранная для запуска задачи, является группой **System** или **Local Administrators** на сервере. Чтобы проверить учетную запись пользователя, перейдите на вкладку **Общие** и проверьте параметры **безопасности** .

- Убедитесь, что на сервере установлен PowerShell 3,0 или более поздней версии. Чтобы проверить версию PowerShell, выполните следующую команду и убедитесь, что `Major` номер версии — 3 или более поздней:

  `$PSVersionTable.PSVersion`

- Убедитесь, что этот путь является частью `PSMODULEPATH` переменной среды:

  `<MARS agent installation path>\Microsoft Azure Recovery Services Agent\bin\Modules\MSOnlineBackup`

- Если для политики выполнения PowerShell для `LocalMachine` задано значение "ограничено", командлет PowerShell, который запускает задачу резервного копирования, может завершиться ошибкой. Выполните следующие команды в режиме с повышенными правами, чтобы проверить и установить политику `Unrestricted` выполнения в значение или: `RemoteSigned`

  `PS C:\WINDOWS\system32> Get-ExecutionPolicy -List`

  `PS C:\WINDOWS\system32> Set-ExecutionPolicy Unrestricted`

- Убедитесь, что отсутствуют отсутствующие или поврежденные файлы Мсонлинебаккуп модуля PowerShell. При наличии отсутствующих или поврежденных файлов выполните следующие действия.

  1. На любом компьютере с агентом MARS, который работает правильно, скопируйте папку Мсонлинебаккуп из папки C:\Program Files\Microsoft Azure Recovery Services Ажент\бин\модулес.
  1. На проблематичном компьютере вставьте скопированные файлы в ту же папку (C:\Program Files\Microsoft Azure Recovery Services Ажент\бин\модулес).

     Если на компьютере уже есть папка Мсонлинебаккуп, вставьте файлы в нее или замените все существующие файлы.


> [!TIP]
> Чтобы обеспечить согласованное применение изменений, перезапустите сервер после выполнения описанных выше действий.


## <a name="troubleshoot-restore-problems"></a>Устранение неполадок при восстановлении

Служба Azure Backup может не подключить том восстановления даже через несколько минут. И во время процесса могут появляться сообщения об ошибках. Чтобы начать восстановление в обычном режиме, выполните следующие действия.

1.  Отмените процесс подключения, если он выполняется в течение нескольких минут.

2.  Проверьте, установлена ли последняя версия агента резервного копирования. Чтобы проверить версию, на панели **действия** консоли Mars выберите **сведения об агенте службы восстановления Microsoft Azure**. Убедитесь, что номер **версии** равен или выше, чем у версии, упомянутой [в этой статье](https://go.microsoft.com/fwlink/?linkid=229525). Щелкните эту ссылку, чтобы [скачать последнюю версию](https://go.microsoft.com/fwLink/?LinkID=288905).

3.  Перейдите в **Device Manager** > **контроллеры хранилища** и найдите **инициатор iSCSI (Майкрософт**). Если вы обнаружите его, перейдите непосредственно к шагу 7.

4.  Если не удается найти службу инициатора iSCSI (Майкрософт), попробуйте найти запись в разделе **Device Manager** > **контроллеры хранилища** с именем неизвестное **устройство** с идентификатором оборудования **рут\исксипрт**.

5.  Щелкните правой кнопкой мыши неизвестное **устройство** и выберите команду **Обновить драйвер программного обеспечения**.

6.  Обновите драйвер, выбрав параметр **Автоматический поиск обновленных драйверов**. Это обновление должно изменить состояние неизвестного **устройства** на **инициатор iSCSI (Майкрософт**):

    ![Снимок экрана. Диспетчер устройств Azure Backup с выделенными контроллерами хранилища](./media/backup-azure-restore-windows-server/UnknowniSCSIDevice.png)

7.  Выберите службы **диспетчера** > задач **(local)**  > **Служба инициатора iSCSI (Майкрософт**):

    ![Снимок экрана. Диспетчер задач Azure Backup с выделенными локальными службами](./media/backup-azure-restore-windows-server/MicrosoftInitiatorServiceRunning.png)

8.  Перезапустите службу инициатора iSCSI (Майкрософт). Для этого щелкните службу правой кнопкой мыши и выберите пункт " **Закрыть**". Затем щелкните его правой кнопкой мыши и выберите **запустить**.

9.  Повторите восстановление с помощью [мгновенного восстановления](backup-instant-restore-capability.md).

Если восстановление по-прежнему не выполняется, перезапустите сервер или клиент. Если вы не хотите перезапускать или если восстановление по-прежнему завершается сбоем даже после перезагрузки сервера, попробуйте выполнить [восстановление с другого компьютера](backup-azure-restore-windows-server.md#use-instant-restore-to-restore-data-to-an-alternate-machine).


## <a name="troubleshoot-cache-problems"></a>Устранение неполадок с кэшем

Операция резервного копирования может завершиться ошибкой, если папка кэша (также называемая временной папкой) неправильно настроена, отсутствуют предварительные требования или доступ ограничен.

### <a name="pre-requisites"></a>Предварительные требования

Для выполнения операций агента MARS с целью успешности папки кэша необходимо соблюдать указанные ниже требования.

- [Убедитесь, что от 5% до 10% свободного места на диске доступно во временной папке.](backup-azure-file-folder-backup-faq.md#whats-the-minimum-size-requirement-for-the-cache-folder)
- [Убедитесь, что расположение временной папки является допустимым и доступным](backup-azure-file-folder-backup-faq.md#how-to-check-if-scratch-folder-is-valid-and-accessible)
- [Убедитесь, что атрибуты файлов в папке кэша поддерживаются](backup-azure-file-folder-backup-faq.md#are-there-any-attributes-of-the-cache-folder-that-arent-supported)
- [Убедитесь, что выделенное место для хранения теневых копий достаточно для процесса резервного копирования](#increase-shadow-copy-storage)
- [Убедитесь, что другие процессы (например, антивирусное программное обеспечение) не ограничивают доступ к папке кэша.](#another-process-or-antivirus-software-blocking-access-to-cache-folder)

### <a name="increase-shadow-copy-storage"></a>Увеличение хранилища теневых копий
Операции резервного копирования могут завершиться ошибкой, если недостаточно места для хранения теневых копий, необходимых для защиты источника данных. Чтобы устранить эту проблему, увеличьте объем хранилища теневых копий на защищенном томе с помощью команды vssadmin, как показано ниже.
- Проверьте текущее пространство теневого хранилища в командной строке с повышенными привилегиями:<br/>
  `vssadmin List ShadowStorage /For=[Volume letter]:`
- Увеличьте дисковое пространство для теневого копирования с помощью следующей команды:<br/>
  `vssadmin Resize ShadowStorage /On=[Volume letter]: /For=[Volume letter]: /Maxsize=[size]`

### <a name="another-process-or-antivirus-software-blocking-access-to-cache-folder"></a>Другой процесс или антивирусная программа, блокирующая доступ к папке кэша
Если на сервере установлено антивирусное программное обеспечение, добавьте необходимые правила исключения в антивирусную проверку для следующих файлов и папок:  
- Вспомогательная папка. По умолчанию используется папка C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch
- Папка Bin в папке C:\Program Files\Microsoft Azure Recovery Services Ажент\бин
- CBengine.exe.
- CSC. exe

## <a name="common-issues"></a>Распространенные проблемы
В этом разделе рассматриваются распространенные ошибки, возникающие при использовании агента MARS.

### <a name="salchecksumstoreinitializationfailed"></a>салчекксумстореинитиализатионфаилед

Сообщение об ошибке | Рекомендуемое действие |
-- | --
Агенту Службы восстановления Microsoft Azure не удалось получить доступ к контрольной сумме резервной копии, хранящейся в вспомогательном | Чтобы устранить эту проблему, выполните приведенные ниже действия и перезапустите сервер. <br/> - [Проверьте наличие антивирусной программы или других процессов, блокирующих файлы вспомогательного расположения.](#another-process-or-antivirus-software-blocking-access-to-cache-folder)<br/> - [Проверьте, является ли вспомогательное расположение допустимым и доступным для агента MARS.](backup-azure-file-folder-backup-faq.md#how-to-check-if-scratch-folder-is-valid-and-accessible)

### <a name="salvhdinitializationerror"></a>салвхдинитиализатионеррор

Сообщение об ошибке | Рекомендуемое действие |
-- | --
Агенту Службы восстановления Microsoft Azure не удалось получить доступ к вспомогательному расположению для инициализации виртуального жесткого диска | Чтобы устранить эту проблему, выполните приведенные ниже действия и перезапустите сервер. <br/> - [Проверьте наличие антивирусной программы или других процессов, блокирующих файлы вспомогательного расположения.](#another-process-or-antivirus-software-blocking-access-to-cache-folder)<br/> - [Проверьте, является ли вспомогательное расположение допустимым и доступным для агента MARS.](backup-azure-file-folder-backup-faq.md#how-to-check-if-scratch-folder-is-valid-and-accessible)

### <a name="sallowdiskspace"></a>салловдискспаце

Сообщение об ошибке | Рекомендуемое действие |
-- | --
Сбой резервного копирования из-за нехватки места в томе, где находится вспомогательная папка | Чтобы устранить эту проблему, проверьте приведенные ниже действия и повторите операцию.<br/>- [Убедитесь, что агент MARS является последним](https://go.microsoft.com/fwlink/?linkid=229525&clcid=0x409)<br/> - [Проверка и устранение проблем с хранилищем, влияющих на рабочую область резервного копирования](#pre-requisites)

### <a name="salbitmaperror"></a>SalBitmapError

Сообщение об ошибке | Рекомендуемое действие |
-- | --
Не удалось найти изменения в файле. Это может быть вызвано разными причинами. Повторите операцию. | Чтобы устранить эту проблему, проверьте приведенные ниже действия и повторите операцию.<br/> - [Убедитесь, что агент MARS является последним](https://go.microsoft.com/fwlink/?linkid=229525&clcid=0x409) <br/> - [Проверка и устранение проблем с хранилищем, влияющих на рабочую область резервного копирования](#pre-requisites)


## <a name="next-steps"></a>Следующие шаги
* Дополнительные сведения о [резервном копировании Windows Server с помощью агента Azure Backup](tutorial-backup-windows-server-to-azure.md).
* Если необходимо восстановить резервную копию, см. раздел [Восстановление файлов на компьютер с Windows](backup-azure-restore-windows-server.md).
