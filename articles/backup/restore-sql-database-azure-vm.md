---
title: Восстановление баз данных SQL Server на виртуальной машине Azure
description: В этой статье описывается, как восстановить SQL Server базы данных, работающие на виртуальной машине Azure и резервные копии которых Azure Backup. Можно также использовать восстановление между регионами для восстановления баз данных в дополнительный регион.
ms.topic: conceptual
ms.date: 05/22/2019
ms.openlocfilehash: bbafd179f4b2f4e91a4bf19da41ffc14e4775e5c
ms.sourcegitcommit: 2989396c328c70832dcadc8f435270522c113229
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/19/2020
ms.locfileid: "92172172"
---
# <a name="restore-sql-server-databases-on-azure-vms"></a>Восстановление баз данных SQL Server на виртуальных машинах Azure

В этой статье описывается, как восстановить базу данных SQL Server, которая работает на виртуальной машине Azure, которая была создана [Azure Backupной](backup-overview.md) службой, в хранилище служб восстановления Azure Backup.

В этой статье описывается восстановление баз данных SQL Server. Дополнительные сведения см. [в статье резервное копирование SQL Server баз данных на виртуальных машинах Azure](backup-azure-sql-database.md).

## <a name="restore-to-a-time-or-a-recovery-point"></a>Восстановление на время или точку восстановления

Azure Backup можете восстановить базы данных SQL Server, работающие на виртуальных машинах Azure, следующим образом:

- Восстановление до определенной даты или времени (во второй) с помощью резервных копий журнала транзакций. Azure Backup автоматически определяет соответствующую полную разностную резервную копию и цепочку резервных копий журналов, которые требуются для восстановления в зависимости от выбранного времени.
- Восстановление определенной полной или разностной резервной копии для восстановления до определенной точки восстановления.

## <a name="prerequisites"></a>предварительные требования

Перед восстановлением базы данных обратите внимание на следующее.

- Можно восстановить базу данных на экземпляре SQL Server, расположенном в том же регионе Azure.
- Целевой сервер должен быть зарегистрирован в том же хранилище, что и исходный сервер.
- Чтобы восстановить базу данных, зашифрованную с помощью TDE, на другой SQL Server, необходимо сначала [восстановить сертификат на целевом сервере](/sql/relational-databases/security/encryption/move-a-tde-protected-database-to-another-sql-server).
- Базы данных с поддержкой [CDC](/sql/relational-databases/track-changes/enable-and-disable-change-data-capture-sql-server) следует восстановить с помощью параметра [восстановить как файлы](#restore-as-files) .
- Перед восстановлением базы данных "Master" запустите экземпляр SQL Server в однопользовательском режиме с помощью параметра запуска **-m азуреворклоадбаккуп**.
  - Значение параметра **-m** — это имя клиента.
  - Только указанное имя клиента может открыть соединение.
- Для всех системных баз данных (Model, Master, msdb) перед запуском восстановления завершите работу службы агент SQL Server.
- Закройте все приложения, которые могут попытаться подключиться к любой из этих баз данных.
- Если на сервере работает несколько экземпляров, все они будут работать, иначе сервер не будет отображаться в списке целевых серверов для восстановления базы данных.

## <a name="restore-a-database"></a>Восстановление базы данных

Для восстановления необходимы следующие разрешения.

- Разрешения **оператора Backup** в хранилище, в котором выполняется восстановление.
- Доступ **участника (с правами на запись)** к исходной виртуальной машине, резервное копирование которой выполняется.
- Доступ **участника (с правами на запись)** к целевой виртуальной машине:
  - Если выполняется восстановление на ту же виртуальную машину, это исходная виртуальная машина.
  - Если выполняется восстановление в альтернативное расположение, это новая целевая виртуальная машина.

Восстановление состоит из следующих шагов.

1. Откройте хранилище, в котором зарегистрирована виртуальная машина SQL Server.
2. На панели мониторинга хранилища в разделе **Использование** выберите **Элементы архивации**.
3. В меню **Элементы архивации** в разделе **Тип управления резервным копированием** выберите **SQL in Azure VM** (SQL на виртуальной машине Azure).

    ![Выбор "SQL in Azure VM" (SQL на виртуальной машине Azure)](./media/backup-azure-sql-database/sql-restore-backup-items.png)

4. Выберите базу данных для восстановления.

    ![Выбор базы данных для восстановления](./media/backup-azure-sql-database/sql-restore-sql-in-vm.png)

5. Просмотрите меню базы данных. Оно предоставляет сведения о резервном копировании базы данных, включая:

    - самые старые и самые новые точки восстановления;
    - Состояние резервного копирования журнала за последние 24 часа для баз данных, находясь в режиме полного восстановления и с неполным протоколированием и настроенных для резервных копий журналов транзакций.

6. Выберите **Восстановить**.

    ![Выбор "Восстановить"](./media/backup-azure-sql-database/restore-db.png)

7. В поле **Конфигурация восстановления**укажите, где (или как) следует восстановить данные.
   - **Альтернативное расположение**. Восстановите базу данных в альтернативное расположение и сохранив исходную базу данных.
   - **Перезаписать базу данных**: восстановление данных в том же экземпляре SQL Server, где находится исходный источник. В этом варианте перезаписывается исходная база данных.

        > [!IMPORTANT]
        > Если выбранная база данных принадлежит к группе доступности Always On, SQL Server не позволит перезаписать базу данных. Доступно только значение **Альтернативное расположение**.
        >
   - **Восстановить в виде файлов**. вместо восстановления в качестве базы данных восстановите файлы резервных копий, которые можно будет восстановить в виде базы данных, на любом компьютере, где имеются файлы, с помощью SQL Server Management Studio.
     ![Меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-configuration.png)

### <a name="restore-to-an-alternate-location"></a>Восстановление в альтернативном расположении

1. В меню **восстановить конфигурацию** в разделе **место для восстановления**выберите **альтернативное расположение**.
1. Выберите имя сервера SQL Server и экземпляр, в котором нужно восстановить базу данных.
1. В поле **Имя восстановленной базы данных** введите имя целевой базы данных.
1. Если это применимо, выберите параметр **Overwrite if the DB with the same name already exists on selected SQL instance** (Перезаписать, если база данных с тем же именем уже существует в выбранном экземпляре SQL).
1. Выберите **пункт точка восстановления**и укажите, следует ли выполнить [Восстановление до определенной точки во времени](#restore-to-a-specific-point-in-time) или выполнить [Восстановление до определенной точки восстановления](#restore-to-a-specific-restore-point).

    ![Выбор точки восстановления](./media/backup-azure-sql-database/select-restore-point.png)

    ![Восстановление до точки во времени](./media/backup-azure-sql-database/restore-to-point-in-time.png)

1. В меню **Расширенная конфигурация** выполните следующие действия.

    - Если вы хотите, чтобы база данных оставалась неработоспособной после восстановления, включите **RESTORE WITH NORECOVERY**.
    - Если вы хотите изменить расположение для восстановления на целевом сервере, введите новые целевые пути.

        ![Введите целевые пути](./media/backup-azure-sql-database/target-paths.png)

1. Нажмите кнопку **ОК** , чтобы активировать восстановление. Отслеживать ход восстановления в области **уведомлений** или отслеживать его в представлении **задания резервного копирования** в хранилище.

    > [!NOTE]
    > Восстановление до точки во времени доступно только для резервных копий журналов баз данных, находясь в режиме полного восстановления и с неполным протоколированием.

### <a name="restore-and-overwrite"></a>Восстановление и перезапись

1. В меню **восстановить конфигурацию** в разделе **место для восстановления**выберите **перезаписать базу данных**  >  **ОК**.

    ![Выбор "Перезаписать базу данных"](./media/backup-azure-sql-database/restore-configuration-overwrite-db.png)

2. В окне **Выбор точки восстановления**выберите **журналы (на момент времени)** для [восстановления до определенной точки во времени](#restore-to-a-specific-point-in-time). Или выберите **полную & разностную резервную копию** для восстановления до [определенной точки восстановления](#restore-to-a-specific-restore-point).

    > [!NOTE]
    > Восстановление до точки во времени доступно только для резервных копий журналов баз данных, находясь в режиме полного восстановления и с неполным протоколированием.

### <a name="restore-as-files"></a>Восстановление в виде файлов

Чтобы восстановить данные резервной копии в виде BAK-файлов вместо базы данных, выберите **восстановить как файлы**. После сохранения файлов по указанному пути можно взять эти файлы на любой компьютер, где необходимо восстановить их в качестве базы данных. Так как эти файлы можно переместить на любой компьютер, теперь можно восстановить данные в рамках подписок и регионов.

1. В разделе **где и как выполнить восстановление**выберите **восстановить как файлы**.
1. Выберите имя SQL Server, в которое необходимо восстановить файлы резервной копии.
1. В **целевом пути на сервере** введите путь к папке на сервере, выбранном на шаге 2. Это расположение, в котором служба будет выводить дамп всех необходимых файлов резервных копий. Как правило, использование пути к общей сетевой папке или пути к подключенной общей папке Azure, если он указан в качестве пути назначения, упрощает доступ к этим файлам с других компьютеров в той же сети или с подключенной к ним общей папкой Azure.<BR>

    >Чтобы восстановить файлы резервной копии базы данных в общей папке Azure, подключенной к целевой зарегистрированной виртуальной машине, убедитесь, что NT AUTHORITY\SYSTEM имеет доступ к общей папке. Вы можете выполнить указанные ниже действия, чтобы предоставить разрешения на чтение и запись для подключения к AFS, подключенной к виртуальной машине.
    >
    >- Выполните команду `PsExec -s cmd` , чтобы войти в оболочку NT AUTHORITY\SYSTEM
    >   - Выполните команду `cmdkey /add:<storageacct>.file.core.windows.net /user:AZURE\<storageacct> /pass:<storagekey>`.
    >   - Проверка доступа с помощью `dir \\<storageacct>.file.core.windows.net\<filesharename>`
    >- Запуск восстановления в качестве файлов из хранилища архивации в `\\<storageacct>.file.core.windows.net\<filesharename>` качестве пути<BR>
    Вы можете загрузить PsExec со страницы [Sysinternals](/sysinternals/downloads/psexec) .

1. Щелкните **ОК**.

    ![Выберите восстановить как файлы](./media/backup-azure-sql-database/restore-as-files.png)

1. Выберите **пункт точка восстановления**и укажите, следует ли выполнить [Восстановление до определенной точки во времени](#restore-to-a-specific-point-in-time) или выполнить [Восстановление до определенной точки восстановления](#restore-to-a-specific-restore-point).

1. Все файлы резервных копий, связанные с выбранной точкой восстановления, записываются в целевой путь. Файлы можно восстановить как базу данных на любом компьютере, на котором они находятся, с помощью SQL Server Management Studio.

    ![Восстановленные файлы резервной копии в целевом пути](./media/backup-azure-sql-database/sql-backup-files.png)

### <a name="restore-to-a-specific-point-in-time"></a>Восстановление данных до определенной точки во времени

Если вы выбрали **Logs (Point in Time)** (Журналы (восстановление до точки во времени)) как тип восстановления, выполните следующие действия:

1. В разделе **Дата и время восстановления**Откройте календарь. В календаре даты с точками восстановления отображаются жирным шрифтом, а текущая дата выделяется.
1. Выберите дату, которая содержит точки восстановления. Нельзя выбрать даты, не имеющие точек восстановления.

    ![Открытие календаря](./media/backup-azure-sql-database/recovery-point-logs-calendar.png)

1. После выбора даты временная шкала отображает доступные точки восстановления в непрерывном диапазоне.
1. Укажите время восстановления на графе временной шкалы или выберите время. Нажмите кнопку **ОК**.

### <a name="restore-to-a-specific-restore-point"></a>Восстановление данных до определенной точки восстановления

Если вы выбрали **Full & Differential** (Полная и разностная) как тип восстановления, выполните следующие действия:

1. Чтобы завершить процедуру, из списка точек восстановления выберите точку восстановления и нажмите кнопку **ОК**.

    ![Выбор полной точки восстановления](./media/backup-azure-sql-database/choose-full-recovery-point.png)

    >[!NOTE]
    > По умолчанию отображаются точки восстановления за последние 30 дней. Вы можете отобразить точки восстановления старше 30 дней, выбрав **Фильтр** и выбрав Настраиваемый диапазон.

### <a name="restore-databases-with-large-number-of-files"></a>Восстановление баз данных с большим количеством файлов

Если общий размер строки файлов в базе данных превышает [определенный предел](backup-sql-server-azure-troubleshoot.md#size-limit-for-files), Azure Backup сохраняет список файлов базы данных в другом компоненте, чтобы не задавать целевой путь восстановления во время операции восстановления. Файлы будут восстановлены по пути SQL по умолчанию.

  ![Восстановление базы данных с большим размером файла](./media/backup-azure-sql-database/restore-large-files.jpg)

## <a name="cross-region-restore"></a>Восстановление между регионами

В качестве одного из вариантов восстановления. восстановление между регионами (КРР) позволяет восстанавливать базы данных SQL, размещенные на виртуальных машинах Azure, в дополнительном регионе, который является парным регионом Azure.

Чтобы перейти к функции в предварительной версии, ознакомьтесь с [разделом перед началом](./backup-create-rs-vault.md#set-cross-region-restore).

Чтобы узнать, включен ли КРР, следуйте инструкциям в разделе [Настройка восстановления между регионами](backup-create-rs-vault.md#configure-cross-region-restore) .

### <a name="view-backup-items-in-secondary-region"></a>Просмотр элементов резервного копирования в дополнительном регионе

Если КРР включен, можно просмотреть элементы резервного копирования в дополнительном регионе.

1. На портале перейдите к **Recovery Services vault**  >  **элементу резервное копирование**хранилища служб восстановления.
1. Выберите **дополнительный регион** , чтобы просмотреть элементы в дополнительном регионе.

>[!NOTE]
>В списке будут показаны только типы управления резервным копированием, поддерживающие функцию КРР. В настоящее время допускается только восстановление данных вторичного региона в дополнительный регион.

![Элементы резервного копирования в дополнительном регионе](./media/backup-azure-sql-database/backup-items-secondary-region.png)

![Базы данных в дополнительном регионе](./media/backup-azure-sql-database/databases-secondary-region.png)

### <a name="restore-in-secondary-region"></a>Восстановление в дополнительном регионе

Пользовательский интерфейс восстановления в дополнительном регионе будет аналогичен пользовательскому интерфейсу восстановления в основном регионе. При настройке сведений в области восстановление конфигурации для настройки восстановления вам будет предложено указать только дополнительные параметры региона.

![Где и как выполнить восстановление](./media/backup-azure-sql-database/restore-secondary-region.png)

>[!NOTE]
>Виртуальную сеть в дополнительном регионе необходимо назначить уникальной, и ее нельзя использовать для других виртуальных машин в этой группе ресурсов.

![Идет активация уведомления о состоянии восстановления](./media/backup-azure-arm-restore-vms/restorenotifications.png)

>[!NOTE]
>
>- После запуска восстановления и на этапе пересылки данных задание восстановления нельзя отменить.
>- Роли Azure, необходимые для восстановления в дополнительном регионе, совпадают с ролями в основном регионе.

### <a name="monitoring-secondary-region-restore-jobs"></a>Мониторинг заданий восстановления в дополнительном регионе

1. На портале выберите **Recovery Services vault**  >  **задания резервного копирования** хранилища служб восстановления.
1. Выберите **дополнительный регион** , чтобы просмотреть элементы в дополнительном регионе.

    ![Задания резервного копирования отфильтрованы](./media/backup-azure-sql-database/backup-jobs-secondary-region.png)

## <a name="next-steps"></a>Дальнейшие действия

[Управление и мониторинг](manage-monitor-sql-database-backup.md) SQL Server базы данных, для которых выполняется резервное копирование Azure Backup.