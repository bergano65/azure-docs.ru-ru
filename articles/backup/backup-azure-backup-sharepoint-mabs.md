---
title: Резервное копирование фермы SharePoint в Azure с помощью MABS
description: Резервное копирование данных SharePoint с помощью Azure Backup Server. Эта статья содержит информацию о настройке фермы SharePoint для сохранения нужных данных в Azure. Защищенные данные SharePoint можно восстановить с диска или из Azure.
ms.topic: conceptual
ms.date: 04/26/2020
ms.openlocfilehash: 00af51764d5a9454b002de6375b2b16d6e80c300
ms.sourcegitcommit: 419cf179f9597936378ed5098ef77437dbf16295
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/27/2020
ms.locfileid: "89017436"
---
# <a name="back-up-a-sharepoint-farm-to-azure-with-mabs"></a>Резервное копирование фермы SharePoint в Azure с помощью MABS

Резервное копирование SharePoint в Microsoft Azure с помощью Microsoft Azure Backup Server (MABS) во многом напоминает резервное копирование других источников данных. Служба архивации Azure позволяет гибко планировать архивацию, задавая ежедневные, еженедельные, ежемесячные или ежегодные точки архивации, и предоставляет параметры политики хранения для любой из этих точек. MABS дает возможность сохранять копии локальных дисков для краткосрочных целей времени восстановления, а также сохранять копии в Azure для экономичного и длительного хранения.

Резервное копирование SharePoint в Azure с помощью MABS аналогично процессу резервного копирования SharePoint в DPM (Data Protection Manager) локально. В этой статье будут представлены конкретные рекомендации для Azure.

## <a name="sharepoint-supported-versions-and-related-protection-scenarios"></a>Поддерживаемые версии SharePoint и соответствующие сценарии защиты

Список поддерживаемых версий SharePoint и версий MABS, необходимых для их резервного копирования, см. в [матрице защиты MABS](./backup-mabs-protection-matrix.md).

## <a name="before-you-start"></a>Перед началом работы

Перед архивацией фермы SharePoint в Azure необходимо выполнить некоторые действия.

### <a name="whats-not-supported"></a>Что не поддерживается

* Защита фермы SharePoint с помощью MABS не охватывает индексы поиска или базы данных службы приложений. Защиту этих баз данных необходимо настраивать отдельно.

* MABS не поддерживает резервное копирование баз данных SharePoint SQL Server, размещенных в общих хранилищах на масштабируемом файловом сервере.

### <a name="prerequisites"></a>Предварительные требования

Прежде чем продолжить, выполните все [предварительные требования для использования Microsoft Azure Backup](backup-azure-dpm-introduction.md#prerequisites-and-limitations) в отношении защиты рабочих нагрузок. В частности, необходимо создать хранилище резервных копий, скачать учетные данные хранилища, установить агент службы Azure Backup и зарегистрировать Azure Backup Server в хранилище.

Дополнительные предварительные требования и ограничения

* По умолчанию при организации защиты SharePoint защита распространяется на все базы данных содержимого (а также на базы данных SharePoint_Config и SharePoint_AdminContent*). Чтобы добавить настройки, такие как индексы поиска, шаблоны или базы данных службы приложений, или службу профилей пользователей, необходимо настроить их для защиты отдельно. Убедитесь, что включена защита для всех папок, включающих эти типы компонентов или файлы настройки.

* Невозможно защитить базы данных SharePoint в качестве источника данных SQL Server. Из резервной копии фермы можно восстановить отдельные базы данных.

* Помните, что MABS выполняется как **Локальная система**, а для создания резервных копий баз данных SQL Server эта учетная запись должна иметь права системного администратора учетной записи для SQL Server. На сервере SQL Server, резервную копию которого требуется создать, задайте для параметра NT AUTHORITY\SYSTEM свойство **sysadmin**.

* На каждые 10 млн элементов, содержащихся в ферме, требуется не менее 2 ГБ памяти в томе, где находится папка MABS. Эта память нужна для создания каталога. Чтобы использовать MABS для восстановления определенных элементов (семейства веб-сайтов, сайты, списки, библиотеки документов, папки, документы или элементы списков), операция создания каталога формирует список URL-адресов, сохраняемых в каждой базе данных содержимого. Этот список URL-адресов можно просмотреть в консоли администратора MABS, открыв панель восстанавливаемых элементов в области задач "Восстановление".

* При наличии в ферме SharePoint баз данных SQL Server, использующих псевдонимы SQL Server, установите компоненты для связи с клиентами SQL Server на интерфейсный веб-сервер, который будет защищен с помощью MABS.

* Защита элементов хранилища приложения с помощью SharePoint 2013 не поддерживается.

* MABS не поддерживает защиту удаленного хранилища FILESTREAM. Хранилище FILESTREAM должно быть частью базы данных.

## <a name="configure-backup"></a>Настройка резервного копирования

Чтобы создать резервную копию фермы SharePoint, настройте защиту для SharePoint с помощью ConfigureSharePoint.exe, а затем создайте группу защиты в MABS.

1. **Запустите ConfigureSharePoint.exe** — это средство служит для настройки службы модуля записи VSS SharePoint \(WSS\) и предоставляет агенту защиты учетные данные для фермы SharePoint. После развертывания агента защиты файл ConfigureSharePoint.exe можно найти в папке `<MABS Installation Path\>\bin` на интерфейсном веб\-сервере.  Если у вас несколько серверов WFE, необходимо установить их только на один из них. Выполните следующее.

    * На сервере WFE в командной строке перейдите к папке `\<MABS installation location\>\\bin\\` и запустите `ConfigureSharePoint \[\-EnableSharePointProtection\] \[\-EnableSPSearchProtection\] \[\-ResolveAllSQLAliases\] \[\-SetTempPath <path>\]`, где:

        * **EnableSharePointProtection** включает защиту фермы SharePoint, включает модуль записи VSS и регистрирует идентификатор приложения DCOM WssCmdletsWrapper для запуска от лица пользователя, чьи учетные данные указываются с этим параметром. Эта учетная запись должна быть администратором фермы, а также локальным администратором на интерфейсном веб\-сервере.

        * **EnableSPSearchProtection** включает защиту службы поиска WSS 3.0 SP с помощью раздела реестра SharePointSearchEnumerationEnabled в разделе HKLM\\Software\\Microsoft\\ Microsoft Data Protection Manager\\Agent\\2.0\\ на интерфейсном веб\-сервере, а также регистрирует идентификатор приложения DCOM WssCmdletsWrapper для запуска от лица пользователя, чьи учетные данные указываются с этим параметром. Эта учетная запись должна быть администратором фермы, а также локальным администратором на интерфейсном веб\-сервере.

        * **ResolveAllSQLAliases** отображает все псевдонимы, о которых сообщает модуль SharePoint для записи VSS и выполняет их разрешение с соответствующей системой SQL Server. Он также отображает соответствующие разрешенные имена экземпляров. Если серверы находятся в режиме зеркального отображения, также отображает дублируемый сервер. Сообщает обо всех псевдонимах, которые не удается разрешить с системой SQL Server.

        * **SetTempPath** — устанавливает путь для переменных среды TEMP и TMP. Недостаточное дисковое пространство во временной папке администратора фермы может послужить причиной сбоя при поэлементном восстановлении крупного семейства веб-сайтов, веб-сайта, списка или элемента. Этот параметр позволяет вам изменить путь к папке хранения временных файлов, указав том, в котором имеется достаточно пространства для сохранения восстанавливаемого семейства веб-сайтов или веб-сайта.

    * Введите учетные данные администратора фермы. Эта учетная запись должна быть членом локальной группы администраторов на интерфейсном веб-сервере. Если администратор фермы не является локальным администратором, предоставьте на интерфейсном веб-сервере следующие разрешения.

        * Предоставьте группе **WSS_Admin_WPG** полный доступ к папке MABS (`%Program Files%\Data Protection Manager\DPM\`).

        * Предоставьте группе **WSS_Admin_WPG** доступ на чтение к разделу реестра MABS (`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft Data Protection Manager`).

        После каждого изменения в учетных данных администратора фермы SharePoint файл ConfigureSharePoint.exe необходимо перезапускать.

1. Чтобы создать группу защиты, в консоли MABS выберите **Защита** > **Действия** > **Создать группу защиты**, чтобы запустить мастер **Создание группы защиты**.

1. На экране **Выбор типа группы защиты** выберите **Серверы**.

1. В окне **Выбор участников группы** разверните сервер, на котором находится роль WFE. Если имеется несколько серверов WFE, выберите тот, на котором установлен файл ConfigureSharePoint.exe.

    При развертывании сервера SharePoint MABS отправляет в модуль VSS запросы на просмотр данных, которые MABS может защитить.  Если база данных SharePoint является удаленной, MABS подключается к ней. Если источники данных SharePoint не отображаются, убедитесь, что модуль записи VSS работает на сервере SharePoint, а также на всех удаленных SQL Server, а также убедитесь в том, что агент MABS установлен на сервере SharePoint и на удаленном сервере SQL Server. Кроме того, убедитесь, что базы данных SharePoint не защищены в других местах как базы данных SQL Server.

1. На странице **Выбор метода защиты данных** выберите способ обработки краткосрочного и долгосрочного резервного копирования. Краткосрочное \- резервное копирование всегда является первым диском с возможностью резервного копирования с диска в облако Azure с Azure Backup в \( течение короткого или долгосрочного \- срока \) .

1. На странице **Выбор краткосрочных целей** выберите способ резервного копирования для краткосрочного хранения на диске.   Для параметра **Диапазон хранения** укажите, как долго требуется хранить данные на диске. Для параметра **Частота синхронизации** укажите, как часто необходимо выполнять добавочное резервное копирование на диск. Если вы не хотите указывать интервал резервного копирования, можно выбрать параметр "Непосредственно перед точкой восстановления", чтобы MABS выполнял резервное копирование непосредственно перед каждой запланированной точкой восстановления.

1. На экране "Проверка выделения места на диске" просмотрите объем выделенного хранилища в пуле носителей для группы защиты.

    **Общий размер данных** обозначает объем данных, для которых вы будете создать резервную копию, а в разделе **Дисковое пространство, которое нужно подготовить в MABS** указывается рекомендуемое пространство для группы защиты. MABS выбирает идеальный том резервного копирования на основе параметров. Однако вы можете изменить выбор тома для резервного копирования в разделе **Сведения о выделении места на диске**. Для рабочих нагрузок выберите в раскрывающемся меню предпочитаемый объем хранилища. Вы можете изменить значения для параметров **Общий объем** и **Доступный объем** в области **Доступный объем на диске**. Неподготовленное пространство — это объем хранилища, который MABS рекомендует добавить в том, чтобы обеспечить беспроблемное резервное копирование.

1. В разделе **Выбор метода создания реплики** укажите, как нужно выполнять начальную полную репликацию данных.  При репликации по сети рекомендуется выбирать часы с наименьшей загрузкой. Для больших объемов данных или неоптимальных условий сети лучше выбрать автономную репликацию данных с использованием съемных носителей.

1. В разделе **Выбрать параметры проверки согласованности** выберите способ автоматизации проверок согласованности. Можно включить запуск проверки только в том случае, когда данные реплики становятся несогласованными, или по расписанию. Если вы не хотите настраивать автоматическую проверку согласованности, ее можно выполнить вручную в любое время, щелкнув правой кнопкой мыши группу защиты в области **Защита** консоли MABS и выбрав команду **Выполнить проверку согласованности**.

1. Если вы выбрали резервное копирование в облако с помощью Azure Backup на странице **Указание данных для оперативной защиты**, выберите рабочие нагрузки для резервного копирования в Azure.

1. На экране **расписания резервного копирования в сети** укажите периодичность добавочного резервного копирования в Azure. Можно запланировать резервное копирование на каждый день, каждую неделю, каждый месяц и каждый год, а также выбрать время и (или) дату резервного копирования. Максимальная частота резервного копирования — дважды в день. Каждый раз при выполнении резервного копирования в Azure создается точка восстановления данных из копии данных резервного копирования, хранящихся на диске MABS.

1. На экране **Укажите политику хранения в сети** можно выбрать режим хранения в Azure для точек восстановления, содержащих ежедневные, еженедельные, ежемесячные или ежегодные резервные копии.

1. На экране **Выберите репликацию в сети** укажите, как должна выполняться начальная полная репликация данных. Можно выполнить репликацию по сети или сделать автономную резервную копию (автономное заполнение). Автономное резервное копирование использует функцию импорта Azure. [Дополнительные сведения](./backup-azure-backup-import-export.md).

1. На странице **Сводка** проверьте выбранные параметры. Когда вы нажмете **Создать группу**, будет выполнена начальная репликация данных. По завершении для группы защиты отобразится **ОК** на странице **Состояние**. После этого резервное копирование будет выполняться в соответствии с параметрами группы защиты.

## <a name="monitoring"></a>Наблюдение

После создания группы защиты будет выполнена первоначальная репликация, и MABS начнет архивацию и синхронизацию данных SharePoint. MABS контролирует первоначальную синхронизацию и последующее резервное копирование.  Данные SharePoint можно отслеживать двумя способами.

* С помощью мониторинга MABS по умолчанию можно настроить уведомления для упреждающего мониторинга с помощью публикации оповещений и настройки уведомлений. Можно настроить получение критических, предупреждающих и информационных оповещений по электронной почте, а также получение сведений о состоянии восстановленных экземпляров.

* При использовании Operations Manager вы можете публиковать оповещения централизованно.

### <a name="set-up-monitoring-notifications"></a>Настройка уведомлений мониторинга

1. В консоли администратора MABS щелкните **Мониторинг** > **Действие** > **Параметры**.

2. Щелкните **SMTP-сервер**, введите имя сервера, порт и электронный адрес, с которого будут отправляться уведомления. Адрес должен быть допустимым.

3. В разделе **SMTP-сервер с проверкой подлинности** введите имя пользователя и пароль. Вводимые имя и пароль пользователя должны относиться к учетной записи домена того пользователя, адрес которого используется в качестве адреса отправителя. В противном случае доставка уведомления не сработает.

4. Чтобы проверить параметры SMTP-сервера, щелкните **Отправить тестовое сообщение**, введите адрес электронной почты, на который MABS должен отправить тестовое сообщение, а затем нажмите кнопку **ОК**. Выберите **Параметры** > **Уведомления** и выберите типы оповещений, о которых необходимо уведомлять получателей. В поле **Получатели** введите адреса электронной почты получателей копий уведомлений.

### <a name="publish-operations-manager-alerts"></a>Публикация оповещений Operations Manager

1. В консоли администратора MABS щелкните **Мониторинг** > **Действие** > **Параметры** > **Публикация оповещений** > **Опубликовать активные оповещения**

2. После включения функции **Публикация оповещений** все существующие оповещения MABS, которые могут потребовать действий пользователей, публикуются в журнале событий **Оповещения MABS**. Агент Operations Manager, установленный на сервере MABS, затем публикует эти оповещения в Operations Manager и продолжит обновлять консоль по мере создания новых предупреждений.

## <a name="restore-a-sharepoint-item-from-disk-by-using-mabs"></a>Восстановление элемента SharePoint с диска с помощью MABS

В приведенном ниже примере *элемент восстановления SharePoint* был случайно удален и должен быть восстановлен.
![DPM SharePoint Protection4](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection5.png)

1. Откройте **консоль администратора MABS**. На вкладке **Защита** отображаются все фермы SharePoint, защищаемые MABS.

    ![MABS SharePoint Protection3](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection4.png)
2. Чтобы начать восстановление элемента, откройте вкладку **Восстановление** .

    ![MABS SharePoint Protection5](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection6.png)
3. Чтобы найти *элемент восстановления SharePoint* , можно использовать поиск на основе подстановки в пределах диапазона точек восстановления.

    ![MABS SharePoint Protection6](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection7.png)
4. Найдите в результатах поиска нужную точку восстановления, щелкните элемент правой кнопкой мыши и выберите пункт **Восстановить**.
5. Вы можете просмотреть разные точки восстановления и выбрать базу данных или элементы для восстановления. Выберите **дату и время восстановления**, а затем выберите **базу данных, ферму SharePoint, точку восстановления и элемент** в соответствующих полях.

    ![MABS SharePoint Protection7](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection8.png)
6. Щелкните элемент правой кнопкой мыши и выберите параметр **Восстановить**, чтобы открыть **мастер восстановления**. Щелкните **Далее**.

    ![Просмотр выбранных параметров восстановления](./media/backup-azure-backup-sharepoint/review-recovery-selection.png)
7. Выберите желаемый тип восстановления и нажмите кнопку **Далее**.

    ![Тип восстановления](./media/backup-azure-backup-sharepoint/select-recovery-type.png)

   > [!NOTE]
   > Выбранный в примере параметр **Восстановить в исходное местоположение** восстанавливает элемент на исходный сайт SharePoint.
   >
   >
8. Выберите желаемый **процесс восстановления** на соответствующей странице мастера.

   * Выберите **восстановить без использования фермы восстановления** , если ферма SharePoint не изменилась и совпадает с восстанавливаемой точкой восстановления.
   * Если с момента создания точки восстановления ферма SharePoint изменилась, выберите вариант **Восстановление с использованием фермы восстановления** .

     ![процесс восстановления](./media/backup-azure-backup-sharepoint/recovery-process.png)
9. Укажите размещение промежуточного экземпляра SQL Server для временного восстановления базы данных, а также промежуточную общую папку на сервере MABS и на сервере, где выполняется SharePoint, для восстановления элемента.

    ![Расположение промежуточного хранения 1](./media/backup-azure-backup-sharepoint/staging-location1.png)

    MABS присоединяет базу данных содержимого, в которой размещается элемент SharePoint, к временному экземпляру SQL Server. Затем он восстанавливает элемент из базы данных контента и помещает его в промежуточную папку на сервере MABS. Теперь элемент, восстановленный в папке промежуточного хранения, нужно экспортировать в папку промежуточного хранения на ферме SharePoint.

    ![Расположение промежуточного хранения 2](./media/backup-azure-backup-sharepoint/staging-location2.png)
10. Откройте страницу **Указание параметров восстановления**и примените параметры безопасности к ферме SharePoint или к точке восстановления. Щелкните **Далее**.

    ![Варианты восстановления](./media/backup-azure-backup-sharepoint/recovery-options.png)

    > [!NOTE]
    > Здесь же можно отрегулировать использование пропускной способности сети. Это позволит сократить нежелательную нагрузку на сервер в рабочие часы.
    >
    >
11. Просмотрите сводные данные и нажмите кнопку **Восстановить** , чтобы начать восстановление файла.

    ![Сводка параметров восстановления](./media/backup-azure-backup-sharepoint/recovery-summary.png)
12. Теперь откройте вкладку **Мониторинг** в **консоли администратора MABS** и проверьте **состояние** восстановления.

    ![Состояние восстановления](./media/backup-azure-backup-sharepoint/recovery-monitoring.png)

    > [!NOTE]
    > Файл восстановлен. Обновите сайт SharePoint, чтобы проверить восстановленный файл.
    >
    >

## <a name="restore-a-sharepoint-database-from-azure-by-using-mabs"></a>Восстановление базы данных SharePoint из Azure с помощью MABS

1. Чтобы восстановить базу данных контента SharePoint, просмотрите различные точки восстановления (как было показано ранее) и выберите желаемую точку восстановления.

    ![MABS SharePoint Protection8](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection9.png)
2. Дважды щелкните точку восстановления SharePoint, чтобы отобразить доступные регистрационные сведения SharePoint.

   > [!NOTE]
   > Так как для фермы SharePoint предусмотрен длительный срок хранения в Azure, на сервере MABS нет доступных сведений о каталоге (метаданных). В результате каждый раз, когда базу данных контента SharePoint требуется вернуть в состояние на определенный момент, необходимо каталогизировать ферму SharePoint заново.
   >
   >
3. Нажмите кнопку **Повторить каталогизацию**.

    ![MABS SharePoint Protection10](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection12.png)

    Откроется окно состояния **Повторная каталогизация облака** .

    ![MABS SharePoint Protection11](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection13.png)

    После завершения каталогизации состояние изменится на *Успешно*. Щелкните **Закрыть**.

    ![MABS SharePoint Protection12](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection14.png)
4. Щелкните объект SharePoint на вкладке MABS **Восстановление**, чтобы получить структуру базы данных контента. Щелкните элемент правой кнопкой мыши и выберите **Восстановить**.

    ![MABS SharePoint Protection13](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection15.png)
5. Выполните процедуру восстановления, описанную ранее в этой статье, чтобы восстановить базу данных содержимого SharePoint с диска.

## <a name="switching-the-front-end-web-server"></a>Переключение интерфейсного веб-сервера

Если у вас есть несколько интерфейсных веб-серверов и вы хотите переключить сервер, который MABS использует для защиты фермы, выполните следующие действия.

В следующей процедуре используется пример фермы серверов с двумя интерфейсными веб-серверами, *Server1* и *Server2*. Для защиты фермы MABS использует *Server1*. Измените интерфейсный веб-сервер, используемый MABS, на *Server2*, чтобы можно было удалить *Server1* из фермы.

> [!NOTE]
> Если интерфейсный веб-сервер, используемый MABS для защиты фермы, недоступен, используйте следующую процедуру, чтобы изменить интерфейсный веб-сервер, начиная с шага 4.

### <a name="to-change-the-front-end-web-server-that-mabs-uses-to-protect-the-farm"></a>Изменение интерфейсного веб-сервера, используемого MABS для защиты фермы

1. Завершите работу службы модуля записи VSS SharePoint на *Server1*, выполнив в командной строке следующую команду:

    ```CMD
    stsadm -o unregisterwsswriter
    ```

1. На сервере *Server1* откройте редактор реестра и перейдите к следующему разделу:

   **HKLM\System\CCS\Services\VSS\VssAccessControl**

1. Проверьте все значения, перечисленные в подразделе VssAccessControl. Если какая-либо запись имеет значение 0, а другой модуль записи VSS выполняется от имени соответствующей учетной записи, измените значение на 1.

1. Установите агент защиты на *Server2*.

   > [!WARNING]
   > Переключать интерфейсные веб-серверы можно только в том случае, если оба сервера находятся в одном домене.

1. На сервере *Server2* в окне командной строки перейдите в каталог `_MABS installation location_\bin\` и запустите **ConfigureSharepoint**. Дополнительные сведения об использовании средства ConfigureSharePoint см. в статье [Настройка резервного копирования](#configure-backup).

1. Выберите группу защиты, к которой принадлежит ферма серверов, а затем щелкните **Изменить группу защиты**.

1. В мастере изменения группы на странице **Выбор участников группы** разверните узел *Server2* и выберите ферму серверов, а затем завершите работу мастера.

   Запустится проверка согласованности.

1. Если вы выполнили шаг 6, теперь можно удалить том из группы защиты.

## <a name="next-steps"></a>Дальнейшие действия

См. статью [Резервное копирование сервера Exchange Server в службу Azure Backup с помощью Azure Backup Server](backup-azure-exchange-mabs.md).
См. статью [Резервное копирование баз данных SQL Server в Azure с помощью Azure Backup Server](backup-azure-sql-mabs.md).
