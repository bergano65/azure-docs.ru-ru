---
title: Управление точками восстановления
description: Узнайте, как служба Azure Backup управляет точками восстановления для виртуальных машин.
ms.topic: conceptual
ms.date: 11/08/2020
ms.openlocfilehash: 256df693aba0f799c24bcba6defe846e5c37ccaa
ms.sourcegitcommit: 0dcafc8436a0fe3ba12cb82384d6b69c9a6b9536
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/10/2020
ms.locfileid: "94428710"
---
# <a name="manage-recovery-points"></a>Управление точками восстановления

В этой статье описывается, как работает сохранение для виртуальных машин. Каждый раз, когда происходит резервное копирование, создаются точки восстановления, из которых можно выполнять операции восстановления.

Для виртуальных машин начальное резервное копирование является полной резервной копией, а последующие резервные копии — добавочные.

## <a name="recovery-points-and-retention"></a>Точки восстановления и хранение

### <a name="scheduled-initial-and-incremental-backup"></a>Запланированное первоначальное и добавочное резервное копирование

Возьмем упрощенный пример виртуальной машины *v1* с диском данных, состоящим из четырех блоков: блок 1, блок 2, блок 3 и блок 4. Размер каждого блока составляет 16 КБ.

![Виртуальная машина с четырьмя блоками](./media/manage-recovery-points/four-blocks.png)

**Шаг 1. начальное резервное копирование:** Начальное резервное копирование является полной резервной копией. Он выступает в качестве базовых показателей, на которые применяются последующие добавочные резервные копии. Предположим, что данные записаны в блок 1 и блок 2 на исходной виртуальной машине. Одни и те же данные будут реплицированы как D1 и D2 в хранилище служб восстановления.

![Начальная Архивация реплицирована](./media/manage-recovery-points/initial-backup.png)

**Шаг 2. добавочное резервное копирование 1:** Рассмотрим новые данные, добавленные в блок 3 виртуальной машины. Одни и те же данные будут реплицироваться при следующем добавочном резервном копировании, а только измененный блок сохраняется как D3.  На каждом шаге, даже если 1 КБ блока изменяется, в точку восстановления отправляется весь блок размером 16 КБ.

![Первое добавочное резервное копирование](./media/manage-recovery-points/first-incremental-backup.png)

**Шаг 3. добавочная архивация 2:**  Теперь рассмотрим изменения данных на блоке 3 и 2 на исходной виртуальной машине. Эти изменения будут реплицированы при следующем добавочном резервном копировании как D3 ' и D2 '.

![Второе добавочное резервное копирование](./media/manage-recovery-points/second-incremental-backup.png)

### <a name="on-demand-backup"></a>Резервное копирование по запросу

Вы можете запустить резервное копирование виртуальной машины по запросу, когда вы настроите на ней защиту.

- Резервная копия по запросу будет полной резервной копией, если она срабатывает перед первой запланированной первоначальной архивацией.
- Если начальная резервная копия завершена и запускается резервное копирование по запросу, то это добавочное резервное копирование.
- Время хранения точек восстановления, созданных для резервного копирования по запросу, — это значение хранения, указанное при активации резервного копирования.

### <a name="storage-cost"></a>Стоимость хранения

**Точка восстановления** , созданная для начальной резервной копии, содержит все блоки, содержащие данные. Последующие добавочные точки восстановления состоят только из блоков, которые имеют измененные данные. Затраты на хранение соответствуют сумме всех блоков, охватывающих все точки восстановления.

Используйте приведенный выше пример, чтобы понять стоимость хранилища после каждого шага:

|Шаг  |Тип резервных копий  |Измененные блоки  |Тип хранилища |
|------|---------|---------|---------|
|1     |     Начальное резервное копирование    | Блок 1, блок 2        |    Соответствует точке восстановления 1 (D1 + D2)     |
|2     |  Добавочное резервное копирование 1       |  Блок 3       |   Соответствует точке восстановления 1 (D1 + D2) + точка восстановления 2 (D3)      |
|3     |    Добавочная архивация 2     |    Блок 2, блок 3     |   Соответствует точке восстановления 1 (D1 + D2) + точка восстановления 2 (D3) + точка восстановления 3 (D2 "+ D3")      |

### <a name="recovery-point-expiration"></a>Срок действия точки восстановления

Каждая точка восстановления имеет длительность хранения, как указано в политике резервного копирования. Очистка происходит через регулярные интервалы времени, и все точки восстановления с истекшим сроком действия очищаются.

По истечении срока действия точки восстановления она либо удаляется, либо объединяется.

### <a name="case-1-initial-recovery-point-expires"></a>Вариант 1. срок действия начальной точки восстановления истекает

После истечения срока действия первоначальной точки восстановления она выполняет слияние со следующей добавочной точкой восстановления. Все блоки данных, перезаписанные в добавочной точке восстановления, удаляются, а остальные объединяются. Затем добавочная архивация станет начальной полной резервной копией. Рассмотрим пример:

- *Точка восстановления 1* , созданная во время начальной архивации, содержит полную резервную копию виртуальной машины.
- Когда срок действия *точки восстановления 1* истечет, *точка восстановления 2* будет следующей полной резервной копией.
- Блок D1 объединяется с *точкой восстановления 2* и D2 удаляется, так как данные в блоке 2 перезаписаны в *точке восстановления 2*. Это изменение захватывается как блок D2.
- Блок D1 сохраняется в последовательных точках восстановления, пока не будет изменен до следующего резервного копирования.

![Первый случай](./media/manage-recovery-points/first-case.png)

### <a name="case-2-in-between-incremental-recovery-point-expires"></a>Вариант 2. срок действия добавочной точки восстановления истекает

- Если срок действия *точки восстановления 2* истекает до *точки восстановления 1* , данные из *точки восстановления 2* объединяются со следующей доступной точкой восстановления: *точка восстановления 3*. Таким образом, блок D3 объединяется с *точкой восстановления 3*.
- *Точка восстановления 1* по-прежнему является полной резервной копией с блоками D1 и D2.

![Второй вариант](./media/manage-recovery-points/second-case.png)

### <a name="case-3-on-demand-recovery-point-expires"></a>Вариант 3. срок действия точки восстановления по требованию истек

В этом примере запланировано выполнение политики расписания (ежедневное резервное копирование) с сроком хранения в *n* дней.  Если резервное копирование по запросу запускается в течение четвертого дня до следующего запланированного резервного копирования, а срок хранения равен 10 дням, то по-прежнему будет выполняться добавочное резервное копирование. Точка восстановления ( *Rp1 по запросу* ) будет создана после *точки восстановления 3* и до *точки восстановления 4*.  По истечении дня до 14 срок действия точки восстановления по запросу ( *Rp1 по запросу* ) истечет, и она будет объединена со следующей доступной точкой восстановления. Блоки данных, которые все еще находятся на сервере, объединяются, а блоки данных, которые были изменены (перезаписаны или удалены), удаляются из точки восстановления с истекшим сроком действия.

![Третий вариант](./media/manage-recovery-points/third-case.png)

### <a name="impact-of-policy-change-on-recovery-points"></a>Влияние изменения политики на точки восстановления

При изменении политики она применяется как к новым, так и к существующим точкам восстановления. Дополнительные сведения см. [в разделе влияние изменения политики на точки восстановления](backup-architecture.md#impact-of-policy-change-on-recovery-points).

### <a name="impact-of-stop-protection-on-recovery-points"></a>Влияние отключения защиты на точки восстановления

Существует два способа отключения защиты виртуальной машины.

- **Отключите защиту и удалите данные резервных копий.** Этот параметр останавливает все будущие задания резервного копирования, не защищая виртуальную машину, и удаляет все точки восстановления. Если [обратимое удаление](backup-azure-security-feature-cloud.md) включено, удаленные данные будут храниться в течение 14 дней. Плата за элементы в обратимо удаленном состоянии не взимается. Данные можно отменить в течение 14 дней. Если обратимое удаление не включено, данные будут немедленно очищены, и вы не сможете восстановить виртуальную машину или использовать параметр **возобновления резервного копирования** .
- **Отключите защиту и храните данные резервной копии.** Этот параметр останавливает все будущие задания резервного копирования, не защищая виртуальную машину. Однако служба Azure Backup постоянно будет хранить точки восстановления, резервные копии которых были созданы. Необходимо заплатить, чтобы удержать точки восстановления в хранилище (Дополнительные сведения см. в [Azure Backup ценах](https://azure.microsoft.com/pricing/details/backup/) ). При необходимости вы сможете восстановить виртуальную машину. Если вы решили возобновить защиту виртуальной машины, можно использовать параметр **возобновить резервное копирование** . После возобновления резервного копирования правила хранения будут применяться к точкам истечения срока действия. Резервные копии данных также можно удалить с помощью параметра  **удалить данные резервной копии** .

## <a name="impact-of-deleting-a-vm-without-stop-protection"></a>Влияние удаления виртуальной машины без отключения защиты

Удаление виртуальной машины без отключения защиты влияет на точки восстановления, и это нежелательный сценарий. В идеале перед удалением виртуальной машины необходимо остановить резервное копирование. Так как ресурс не существует, запланированные резервные копии будут завершаться ошибкой [VMNotFoundV2](backup-azure-vms-troubleshoot.md#320001-resourcenotfound---could-not-perform-the-operation-as-vm-no-longer-exists--400094-bcmv2vmnotfound---the-virtual-machine-doesnt-exist--an-azure-virtual-machine-wasnt-found). Точки восстановления будут периодически очищаться в соответствии с политикой хранения, но последняя копия виртуальной машины будет оставаться бессрочной, а плата будет взиматься соответствующим образом. В зависимости от вашего сценария у вас есть два следующих варианта:

- **Вариант 1.** Восстановите виртуальную машину с помощью любой точки восстановления. Если вы хотите восстановить удаленную виртуальную машину, восстановите ее с тем же именем и в той же группе ресурсов. Если вы защищаете восстановленную виртуальную машину в том же хранилище, существующие точки восстановления будут автоматически присоединены.
- **Вариант 2.** Перейдите в хранилище служб восстановления и отключите защиту с помощью Delete Data.

### <a name="impact-of-expired-recovery-points-for-items-in-soft-deleted-state"></a>Влияние просроченных точек восстановления на элементы в обратимо удаленном состоянии

Если для хранилища служб восстановления включено [обратимое удаление](backup-azure-security-feature-cloud.md) , то точка восстановления с истекшим сроком действия остается в обратимо удаленном состоянии и не очищается. Если точка восстановления находится в состоянии обратимого удаления, плата не взимается.

### <a name="impact-of-churn-on-backup-performance"></a>Влияние обновления на производительность резервного копирования

Предположим, что общий объем хранилища виртуальной машины составляет 8 ТБ, а обновление составляет 5%. Затем соответствующее хранилище добавочных резервных копий будет иметь 5% от 8 ТБ, 0,4 ТБ. Более высокие обновления соответствуют более высокому серверному хранилищу для последующих добавочных резервных копий. Обновление влияет на производительность резервного копирования. Чем выше обработка, тем медленнее процесс резервного копирования и чем больше потребление серверного хранилища.

Чтобы понять, как обновление влияет на производительность резервного копирования, рассмотрим следующий сценарий:

|Виртуальные машины  |VM1  |VM2  |VM3  |
|---------|---------|---------|---------|
|Количество дисков данных    | 4 (A1, A2, A3, A4)        | 4 (B1, B2, B3, B4)        |  4 (C1, C2, C3, C4)       |
|Размер каждого диска   |      4 TБ   | 4 TБ        |  4 TБ       |
|Обновление данных резервной копии    |   A1 – 4 ТБ      | B1-1 ТБ; B2 – 1 ТБ <br> B3 – 1 ТБ; B4-1 ТБ  |   C1 – 2 ТБ; C4 — 2 ТБ      |

Производительность резервного копирования будет содержаться в VM2>VM3>VM1. Причина этого заключается в том, что обработанные данные распределяются по различным дискам. Так как резервная копия дисков выполняется параллельно, VM2 будет показывать наилучшую производительность.

## <a name="next-steps"></a>Дальнейшие действия

- [Архитектура и компоненты Azure Backup](backup-architecture.md)
