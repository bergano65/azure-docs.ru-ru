---
title: Резервное копирование и восстановление зашифрованных виртуальных машин Azure
description: В этой статье описывается, как выполнять резервное копирование и восстановление зашифрованных виртуальных машин Azure с помощью службы Azure Backup.
ms.topic: conceptual
ms.date: 08/18/2020
ms.openlocfilehash: 6ce0068203c91d9d2031ce2f8735cccf94172dd8
ms.sourcegitcommit: 419cf179f9597936378ed5098ef77437dbf16295
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/27/2020
ms.locfileid: "89014920"
---
# <a name="back-up-and-restore-encrypted-azure-virtual-machines"></a>Резервное копирование и восстановление зашифрованных виртуальных машин Azure

В этой статье описывается, как выполнять резервное копирование и восстановление виртуальных машин Azure Windows или Linux с помощью зашифрованных дисков, используя службу [Azure Backup](backup-overview.md) . Дополнительные сведения см. в статье [Шифрование резервных копий виртуальных машин Azure](backup-azure-vms-introduction.md#encryption-of-azure-vm-backups).

## <a name="encryption-using-platform-managed-keys"></a>Шифрование с использованием ключей, управляемых платформой

По умолчанию все диски на виртуальных машинах автоматически шифруются с помощью ключей, управляемых платформой (PMK), использующих [Шифрование службы хранилища](https://docs.microsoft.com/azure/storage/common/storage-service-encryption). Вы можете создавать резервные копии этих виртуальных машин с помощью Azure Backup без каких бы то ни было определенных действий, необходимых для поддержки шифрования в вашей конечной среде. Дополнительные сведения о шифровании ключей, управляемых платформой, [см. в этой статье](https://docs.microsoft.com/azure/virtual-machines/windows/disk-encryption#platform-managed-keys).

![Зашифрованные диски](./media/backup-encryption/encrypted-disks.png)

## <a name="encryption-using-customer-managed-keys"></a>Шифрование с использованием управляемых пользователем ключей

При шифровании дисков с настраиваемыми управляемыми ключами (CMK) ключ, используемый для шифрования дисков, хранится в Azure Key Vault и управляется вами. Шифрование службы хранилища (SSE) с использованием CMK отличается от шифрования дисков Azure (ADE). ADE использует средства шифрования операционной системы. SSE шифрует данные в службе хранилища, позволяя использовать любую ОС или образы для виртуальных машин. Дополнительные сведения о шифровании управляемых дисков с помощью управляемых клиентом ключей см. в [этой статье](https://docs.microsoft.com/azure/virtual-machines/windows/disk-encryption#customer-managed-keys).

## <a name="encryption-support-using-ade"></a>Поддержка шифрования с помощью ADE

Azure Backup поддерживает резервное копирование виртуальных машин Azure с дисками ОС и данных, зашифрованными с помощью шифрования дисков Azure (ADE). ADE использует BitLocker для шифрования виртуальных машин Windows и функцию DM-Encryption для виртуальных машин Linux. ADE интегрируется с Azure Key Vault для управления ключами и секретами шифрования дисков. Ключи шифрования ключа Key Vault (ключи обмена ключами) можно использовать для добавления дополнительного уровня безопасности, шифрования секретов шифрования перед их записью в Key Vault.

Azure Backup можете выполнять резервное копирование и восстановление виртуальных машин Azure с помощью ADE с приложением Azure AD и без него, как показано в следующей таблице.

**Тип диска виртуальной машины** | **ADE (BEK/DM-шифрования)** | **ADE и KEK**
--- | --- | ---
**Неуправляемые** | Да | Да
**Управляемые**  | Да | Да

- Дополнительные сведения о [ADE](../security/fundamentals/azure-disk-encryption-vms-vmss.md), [Key Vault](../key-vault/general/overview.md)и [ключи обмена ключами](../virtual-machine-scale-sets/disk-encryption-key-vault.md#set-up-a-key-encryption-key-kek).
- Ознакомьтесь с [вопросами и](../security/fundamentals/azure-disk-encryption-vms-vmss.md) ответами по шифрованию дисков виртуальной машины Azure.

### <a name="limitations"></a>Ограничения

- Вы можете выполнять резервное копирование и восстановление зашифрованных виртуальных машин в рамках одной и той же подписки и региона.
- Azure Backup поддерживает виртуальные машины, зашифрованные с помощью автономных ключей. Любой ключ, который является частью сертификата, используемого для шифрования виртуальной машины, сейчас не поддерживается.
- Вы можете выполнять резервное копирование и восстановление зашифрованных виртуальных машин в той же подписке и регионе, что и резервное хранилище служб восстановления.
- Зашифрованные виртуальные машины нельзя восстановить на уровне файла или папки. Чтобы восстановить файлы и папки, необходимо восстановить всю виртуальную машину.
- При восстановлении виртуальной машины нельзя использовать параметр [заменить существующую виртуальную машину](backup-azure-arm-restore-vms.md#restore-options) для зашифрованных виртуальных машин. Этот параметр поддерживается только для незашифрованных управляемых дисков.

## <a name="before-you-start"></a>Перед началом работы

Прежде чем начать, сделайте следующее:

1. Убедитесь, что у вас есть одна или несколько виртуальных машин [Windows](../virtual-machines/linux/disk-encryption-overview.md) или [Linux](../virtual-machines/linux/disk-encryption-overview.md) с включенными файлами ADE.
2. [Обзор матрицы поддержки](backup-support-matrix-iaas.md) для резервного копирования виртуальных машин Azure
3. [Создайте](backup-create-rs-vault.md) резервное хранилище служб восстановления, если оно отсутствует.
4. Если включить шифрование для виртуальных машин, для которых уже включено резервное копирование, необходимо просто предоставить резервную копию с разрешениями на доступ к Key Vault, чтобы резервные копии могли продолжать работу без перерывов. Дополнительные [сведения](#provide-permissions) о назначении этих разрешений.

Кроме того, в некоторых случаях может потребоваться несколько действий:

- **Установить агент виртуальной машины**. Для создания резервных копий виртуальных машин Azure служба Azure Backup устанавливает на них расширение агента виртуальной машины Azure. Если виртуальная машина создана из образа Azure Marketplace, агент установлен и запущен. Если вы создаете пользовательскую виртуальную машину или выполняете миграцию локального компьютера, может потребоваться [установить агент вручную](backup-azure-arm-vms-prepare.md#install-the-vm-agent).

## <a name="configure-a-backup-policy"></a>Настройка политики резервного копирования

1. Если вы еще не создали резервное хранилище служб восстановления, следуйте [этим инструкциям](backup-create-rs-vault.md).
1. Откройте хранилище на портале и выберите **+ Backup (+ резервная копия** ) в разделе **Обзор** .

    ![Панель резервного копирования](./media/backup-azure-vms-encryption/select-backup.png)

1. В качестве **цели резервного копирования**  >  **, где выполняется рабочая нагрузка?** выберите **Azure**.
1. В **поле что вы хотите создать резервную копию?** выберите **Виртуальная машина**. Затем выберите **резервное копирование**.

      ![Область сценариев](./media/backup-azure-vms-encryption/select-backup-goal-one.png)

1. В поле **Политика архивации**  >  **выберите Политика архивации**выберите политику, которую нужно связать с хранилищем. Нажмите кнопку **ОК**.
    - Политика архивации определяет время создания резервных копий и время их хранения.
    - Подробные сведения о политике по умолчанию указаны в раскрывающемся меню.

    ![Выбор политики резервного копирования](./media/backup-azure-vms-encryption/select-backup-goal-two.png)

1. Если вы не хотите использовать политику по умолчанию, выберите **создать**и [Создайте настраиваемую политику](backup-azure-arm-vms-prepare.md#create-a-custom-policy).

1. В разделе **Виртуальные машины** щелкните **Добавить**.

    ![Добавить виртуальные машины](./media/backup-azure-vms-encryption/add-virtual-machines.png)

1. Выберите зашифрованные виртуальные машины, для которых требуется создать резервную копию, с помощью политики SELECT и нажмите кнопку **ОК**.

      ![Выбор зашифрованных виртуальных машин](./media/backup-azure-vms-encryption/selected-encrypted-vms.png)

1. Если вы используете Azure Key Vault, на странице хранилища вы увидите сообщение о том, что Azure Backup требуется доступ только для чтения к ключам и секретам в Key Vault.

    - Если вы получили это сообщение, никаких действий не требуется.

        ![Доступ — ОК](./media/backup-azure-vms-encryption/access-ok.png)

    - При появлении этого сообщения необходимо задать разрешения, как описано в [следующей процедуре](#provide-permissions).

        ![Предупреждение о доступе](./media/backup-azure-vms-encryption/access-warning.png)

1. Выберите **включить резервное копирование** , чтобы развернуть политику архивации в хранилище, и включите архивацию для выбранных виртуальных машин.

## <a name="trigger-a-backup-job"></a>активация задания архивации;

Начальное резервное копирование будет выполняться в соответствии с расписанием, но его можно запустить немедленно, как показано ниже.

1. В меню хранилище выберите пункт **архивные элементы**.
2. В списке **элементы архивации**выберите **Виртуальная машина Azure**.
3. В списке **архивные элементы** щелкните многоточие (...).
4. Выберите **архивацию сейчас**.
5. В окне **Создать резервную копию** используйте элементы управления "Календарь", чтобы выбрать последний день, до которого должна храниться точка восстановления. Нажмите кнопку **ОК**.
6. Отслеживайте уведомления на портале. Вы можете отслеживать ход выполнения задания на панели мониторинга хранилища в разделе **Задания резервного копирования** > **Выполняется**. В зависимости от размера виртуальной машины создание начального архива может занять некоторое время.

## <a name="provide-permissions"></a>Предоставление разрешений

Azure Backup требуется доступ только для чтения для резервного копирования ключей и секретов вместе со связанными виртуальными машинами.

- Ваша Key Vault связана с клиентом Azure AD подписки Azure. Если вы являетесь **пользователем-членом**, Azure Backup получит доступ к Key Vault без дальнейших действий.
- Если вы являетесь **гостевым пользователем**, необходимо предоставить разрешения для Azure Backup доступа к хранилищу ключей.

Чтобы задать разрешения, сделайте следующее:

1. В портал Azure выберите **все службы**и выполните поиск **хранилищ ключей**.
1. Выберите хранилище ключей, связанное с зашифрованной виртуальной машиной, для которой выполняется резервное копирование.
1. Выберите **политики доступа**  >  **Добавить политику доступа**.

    ![Добавление политики доступа](./media/backup-azure-vms-encryption/add-access-policy.png)

1. В окне **Добавление политики доступа**  >  **Настройка из шаблона (необязательно)** выберите **Azure Backup**.
    - Необходимые разрешения автоматически заполняются в раскрывающихся списках **Разрешения ключей** и **Разрешения секретов**.
    - Если виртуальная машина шифруется **только**с помощью BEK, отмените выбор **разрешений для ключевых** , так как вам нужны только разрешения для секретов.

    ![Выбор Azure Backup](./media/backup-azure-vms-encryption/select-backup-template.png)

1. Выберите **Добавить**. **Служба управления архивацией** добавляется в **политики доступа**.

    ![Политики доступа](./media/backup-azure-vms-encryption/backup-service-access-policy.png)

1. Выберите **сохранить** , чтобы предоставить Azure Backup с разрешениями.

## <a name="restore-an-encrypted-vm"></a>Восстановление зашифрованной виртуальной машины

Зашифрованные виртуальные машины можно восстановить только путем восстановления диска виртуальной машины, как описано ниже. **Замена существующей** и **восстановленной виртуальной машины** не поддерживается.

Восстановите зашифрованные виртуальные машины следующим образом:

1. [Восстановите диск виртуальной машины](backup-azure-arm-restore-vms.md#restore-disks).
2. Повторно создайте экземпляр виртуальной машины, выполнив одно из следующих действий.
    1. Используйте шаблон, созданный во время операции восстановления, чтобы настроить параметры виртуальной машины и активировать развертывание виртуальной машины. [Подробнее](backup-azure-arm-restore-vms.md#use-templates-to-customize-a-restored-vm).
    2. Создайте новую виртуальную машину на основе восстановленных дисков с помощью PowerShell. [Подробнее](backup-azure-vms-automation.md#create-a-vm-from-restored-disks).
3. Для виртуальных машин Linux переустановите расширение ADE, чтобы диски данных были открыты и подключены.

## <a name="next-steps"></a>Дальнейшие действия

При возникновении проблем ознакомьтесь со следующими статьями:

- [Распространенные ошибки](backup-azure-vms-troubleshoot.md) при резервном копировании и восстановлении зашифрованных виртуальных машин Azure.
- Проблемы с [агентом виртуальной машины Azure или расширением резервного копирования](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md) .
