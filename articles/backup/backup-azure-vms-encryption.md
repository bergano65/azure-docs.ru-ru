---
title: Резервное копирование и восстановление зашифрованных виртуальных машин Azure с помощью службы архивации Azure
description: Описывает способ резервного копирования и восстановления зашифрованных виртуальных машин Azure в службе архивации Azure.
services: backup
author: geetha
manager: vijayts
ms.service: backup
ms.topic: conceptual
ms.date: 4/3/2019
ms.author: geetha
ms.openlocfilehash: 99117c96f79dd7d0da388a0e793908f6ffb8ed27
ms.sourcegitcommit: 62d3a040280e83946d1a9548f352da83ef852085
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2019
ms.locfileid: "59266450"
---
# <a name="back-up-and-restore-encrypted-azure-vm"></a>Резервное копирование и восстановление зашифрованных виртуальных Машин Azure

В этой статье описывается резервное копирование и восстановление Windows или Linux в Azure виртуальных машин (ВМ) с помощью зашифрованных дисков с помощью [Azure Backup](backup-overview.md) службы.

Если вы хотите узнать больше о как Azure Backup взаимодействует с виртуальных машин Azure, прежде чем начать, ознакомьтесь с этими материалами:

- [Просмотрите](backup-architecture.md#architecture-direct-backup-of-azure-vms) архитектура резервного копирования виртуальной Машины Azure.
- [Дополнительные сведения о](backup-azure-vms-introduction.md) резервного копирования виртуальных Машин Azure и расширение резервного копирования Azure.

## <a name="encryption-support"></a>Поддержка шифрования

Azure Backup поддерживает резервное копирование виртуальных машин Azure, имеют их ОС и дисков данных зашифрованы с помощью шифрования дисков Azure (ADE). ADE использует BitLocker для шифрования виртуальных машин Windows и dm-crypt для виртуальных машин Linux. Шифрования дисков AZURE интегрируется с Azure Key Vault для управления ключами и секретами шифрования дисков. Ключи шифрования ключа хранилища ключей (ключи шифрования ключей) можно добавить дополнительный уровень безопасности, шифровать секреты шифрования до их записи в хранилище ключей.

Служба архивации Azure можно резервное копирование и восстановление виртуальных машин Azure, с помощью ADE с и без приложения Azure AD, как описано в следующей таблице.

**Тип диска виртуальной машины** | **ADE (BEK или dm-crypt)** | **ADE и KEK**
--- | --- | --- 
**Неуправляемые** | Да | Да
**Управляемый код**  | Да | Да

- Дополнительные сведения о [ADE](../security/azure-security-disk-encryption-overview.md), [Key Vault](../key-vault/key-vault-overview.md), и [ключи шифрования ключей](https://blogs.msdn.microsoft.com/cclayton/2017/01/03/creating-a-key-encrypting-key-kek/).
- Чтение [часто задаваемые вопросы о](../security/azure-security-disk-encryption-faq.md) для шифрования дисков виртуальной Машины Azure.



### <a name="limitations"></a>Ограничения

- Вы можете резервного копирования и восстановления зашифрованных виртуальных машин в пределах одной и той же подписке и регионе.
- Azure Backup поддерживает виртуальные машины, зашифрованные с помощью автономного ключей. Любой ключ, который является частью сертификат, используемый для шифрования виртуальной Машины сейчас не поддерживается.
- Вы можете резервного копирования и восстановления зашифрованных виртуальных машин в пределах одной и той же подписке и регионе, что хранилище резервного копирования служб восстановления.
- Зашифрованные виртуальные машины нельзя восстановить на уровне файла или папки. Необходимо восстановить всю виртуальную Машину для восстановления файлов и папок.
- При восстановлении виртуальной Машины, нельзя использовать [заменить существующую виртуальную Машину](backup-azure-arm-restore-vms.md#restore-options) параметр для зашифрованных виртуальных машин. Этот параметр поддерживается только для незашифрованных управляемых дисков.




## <a name="before-you-start"></a>Перед началом

Прежде чем начать, сделайте следующее:

1. Убедитесь, что у вас есть один или несколько [Windows](../security/azure-security-disk-encryption-windows.md) или [Linux](../security/azure-security-disk-encryption-linux.md) поддержкой виртуальных машин с помощью шифрования дисков AZURE.
2. [Ознакомьтесь с таблицей поддержки](backup-support-matrix-iaas.md) резервном копировании виртуальных Машин Azure
3. [Создание](backup-azure-arm-vms-prepare.md#create-a-vault) хранилище резервного копирования служб восстановления, если у вас ее нет.
4. При включении шифрования для виртуальных машин, которые уже включены в резервной копии, необходимо просто обеспечить резервное копирование с разрешениями на доступ к хранилищу ключей, таким образом, чтобы резервные копии можно продолжить работу без перебоев в работе. [Дополнительные сведения](#provide-permissions) о назначении этих разрешений.

Кроме того существует несколько моментов, которые в некоторых случаях может потребоваться:

- **Установка агента виртуальной Машины на виртуальной Машине**: Для создания резервных копий виртуальных машин Azure служба Azure Backup устанавливает на них расширение агента виртуальной машины Azure. Если виртуальная машина создана из образа Azure marketplace, агент будет установлен и запущен. Если создать настраиваемую виртуальную Машину, или перенести на локальном компьютере, может потребоваться [установить агент вручную](backup-azure-arm-vms-prepare.md#install-the-vm-agent).
- **Явным образом разрешить исходящий доступ**: Как правило не нужно явным образом разрешить исходящий сетевой доступ для виртуальной Машины Azure для его для взаимодействия со службой Azure Backup. Тем не менее, некоторые виртуальные машины могут возникнуть проблемы с подключением, показывающий **ExtensionSnapshotFailedNoNetwork** ошибка при попытке подключения. В этом случае следует [явным образом разрешить исходящий доступ](backup-azure-arm-vms-prepare.md#explicitly-allow-outbound-access), поэтому расширение резервного копирования Azure могут взаимодействовать с Azure общедоступных IP-адресов для трафика резервного копирования.



## <a name="configure-a-backup-policy"></a>Настройка политики резервного копирования

1. Если вы еще не создали резервное хранилище служб восстановления, выполните [эти инструкции](backup-azure-arm-vms-prepare.md#create-a-vault)
2. Откройте хранилище на портале и выберите **резервного копирования** в **Приступая к работе** раздел.

    ![Колонка резервного копирования](./media/backup-azure-vms-encryption/select-backup.png)

3. В **цель резервного копирования** > **где выполняется рабочая нагрузка?** выберите **Azure**.
4. В **желаемое действие для резервного копирования?** выберите **виртуальной машины** > **ОК**.

      ![Колонка сценариев](./media/backup-azure-vms-encryption/select-backup-goal-one.png)

5. В **политика архивации** > **Выбор политики архивации**, выберите политику, в которой вы хотите связать с хранилищем. Затем нажмите кнопку **ОК**.
    - Политика архивации указывает, когда резервные копии создаются, и как долго они хранятся.
    - Подробные сведения о политике по умолчанию указаны в раскрывающемся меню.

    ![Открытие колонки сценария](./media/backup-azure-vms-encryption/select-backup-goal-two.png)

6. Если вы не хотите использовать политику по умолчанию, выберите **Create New**, и [создать настраиваемую политику](backup-azure-arm-vms-prepare.md#create-a-custom-policy).


7. Выберите зашифрованные виртуальные машины, которые планируется резервное копирование с помощью выберите политику и выберите **ОК**.

      ![Выбор зашифрованных виртуальных машин](./media/backup-azure-vms-encryption/selected-encrypted-vms.png)

8. Если вы используете Azure Key Vault, на странице "хранилище", вы увидите сообщение, что Azure Backup требуется доступ только для чтения к ключам и секретам в хранилище ключей.

    - Если вы получили это сообщение, никаких действий не требуется.
    
        ![Доступ разрешен](./media/backup-azure-vms-encryption/access-ok.png)
        
    - Если вы получили это сообщение, необходимо задать разрешения, как описано в разделе [описанная ниже процедура](#provide-permissions).
    
        ![Предупреждение доступа](./media/backup-azure-vms-encryption/access-warning.png)

9. Нажмите кнопку **включить резервное копирование** для развертывания политики архивации в хранилище и включение резервного копирования для выбранных виртуальных машин. 


## <a name="trigger-a-backup-job"></a>активация задания архивации;

Начальное резервное копирование будет выполняться в соответствии с расписанием, но его можно запустить непосредственно в следующим образом:

1. В меню хранилища щелкните **Элементы архивации**.
2. На плитке **Элементы архивации** щелкните **Виртуальная машина Azure**.
3. В **архивные элементы** списке, нажмите кнопку с многоточием (...).
4. Щелкните **Создать резервную копию**.
5. В **моментальная Архивация**, использование элементов управления календарем выберите последний день, следует ли хранить точки восстановления. Затем нажмите кнопку **ОК**.
6. Отслеживайте уведомления на портале. Вы можете отслеживать ход выполнения задания на панели мониторинга хранилища в разделе **Задания резервного копирования** > **Выполняется**. В зависимости от размера виртуальной машины создание начального архива может занять некоторое время.


## <a name="provide-permissions"></a>Предоставить разрешения

Azure виртуальной Машине требуется доступ только для чтения для резервного копирования ключей и секретов, а также связанных виртуальных машин.

- Хранилище ключей, связанный с клиентом Azure AD подписки Azure. Если вы являетесь **участником**, Azure Backup получает доступ к хранилищу ключей без дополнительной настройки.
- Если вы являетесь **гостевого пользователя**, необходимо предоставить разрешения для службы архивации Azure для доступа к хранилищу ключей.

Чтобы задать разрешения:

1. На портале Azure выберите **все службы**и выполните поиск **хранилища ключей**.
2. Выберите хранилище ключей, связанное с зашифрованной виртуальной Машины выполняется резервное копирование.
3. Выберите **политики доступа** > **добавить**.
4. Выберите **Выбор субъекта**, а затем введите **управления архивацией**. 
5. Выберите **резервное копирование службы управления** > **выберите**.

    ![Выбор службы резервного копирования](./media/backup-azure-vms-encryption/select-backup-service.png)

6. В **добавить политику доступа** > **настроить при помощи шаблона (необязательно)** выберите **Azure Backup**.
    - Необходимые разрешения автоматически заполняются в раскрывающихся списках **Разрешения ключей** и **Разрешения секретов**.
    - Если виртуальная машина зашифрована с помощью **только BEK**, отменить выбор **разрешения ключей** так, как требуется разрешения только для секретов. 

    ![Выбор службы Azure Backup](./media/backup-azure-vms-encryption/select-backup-template.png)

6. Нажмите кнопку **ОК**. **Резервное копирование службы управления** добавляется **политики доступа**. 

    ![Политики доступа](./media/backup-azure-vms-encryption/backup-service-access-policy.png)

7. Нажмите кнопку **Сохранить** для предоставления службы архивации Azure с разрешениями.

## <a name="restore-an-encrypted-vm"></a>Восстановление зашифрованной виртуальной машины

Восстановление зашифрованных виртуальных машин следующим образом:

1. [Восстановление диска виртуальной Машины](backup-azure-arm-restore-vms.md#restore-disks).
2. Затем выполните одно из следующих действий.
    - Используйте шаблон, который создается во время операции восстановления, чтобы настроить параметры виртуальной Машины и активировать развертывание виртуальной Машины. [Узнайте больше](backup-azure-arm-restore-vms.md#use-templates-to-customize-a-restored-vm).
    - Создание новой виртуальной Машины с восстановленного диска, с помощью Powershell. [Узнайте больше](backup-azure-vms-automation.md#create-a-vm-from-restored-disks).

## <a name="next-steps"></a>Дальнейшие действия

Если вы столкнетесь с проблемами, просмотрите

- [Распространенные ошибки](backup-azure-vms-troubleshoot.md#troubleshoot-backup-of-encrypted-vms) при резервном копировании и восстановлении зашифрованных виртуальных машин Azure.
- [Общие](backup-azure-vms-troubleshoot.md) выдает виртуальной Машины Azure.
- [Расширение агента или резервного копирования виртуальной Машины Azure](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md) проблемы.
