---
title: Архитектура службы Azure Backup
description: Обзор архитектуры, компонентов и процессов, используемых службой Azure Backup.
author: dcurwin
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 02/19/2019
ms.author: dacurwin
ms.openlocfilehash: e072923c2c8b1d8e5bb281a5bcff992b25289b4d
ms.sourcegitcommit: cf36df8406d94c7b7b78a3aabc8c0b163226e1bc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/09/2019
ms.locfileid: "73888491"
---
# <a name="azure-backup-architecture-and-components"></a>Архитектура и компоненты Azure Backup

Вы можете использовать [службу Azure Backup](backup-overview.md) для резервного копирования данных на облачную платформу Microsoft Azure. В этой статье описаны архитектура, компоненты и процессы Azure Backup.

## <a name="what-does-azure-backup-do"></a>Что такое Azure Backup

Azure Backup выполняет резервное копирование данных, состояния компьютера и рабочих нагрузок, выполняющихся на локальных компьютерах и экземплярах виртуальных машин Azure. Есть несколько сценариев Azure Backup:

## <a name="how-does-azure-backup-work"></a>Как работает Azure Backup

Резервное копирование компьютеров и данных можно выполнять с помощью нескольких методов.

- **Резервное копирование локальных компьютеров**:
  - Вы можете выполнять резервное копирование локальных компьютеров Windows непосредственно в Azure с помощью агента Azure Backup Службы восстановления Microsoft Azure (MARS). Компьютеры Linux не поддерживаются.
  - Можно выполнить резервное копирование локальных компьютеров на резервный сервер — System Center Data Protection Manager (DPM) или Microsoft Azure Backup Server (MABS). Затем можно создать резервную копию резервного сервера в хранилище служб восстановления в Azure.

- **Резервное копирование виртуальных машин Azure**:
  - Вы можете напрямую создавать резервные копии виртуальных машин Azure. Azure Backup устанавливает расширение резервного копирования на агент виртуальной машины Azure, который выполняется на виртуальной машине. Это расширение создает резервную копию всей виртуальной машины.
  - Вы можете создавать резервные копии отдельных файлов и папок с виртуальной машины Azure с помощью агента MARS.
  - Вы можете выполнить резервное копирование виртуальных машин Azure в MABS, которые выполняются в Azure, а затем создать резервную копию MABS в хранилище служб восстановления.

Узнайте больше о [том, что можно архивировать](backup-overview.md) , и о [поддерживаемых сценариях резервного копирования](backup-support-matrix.md).

## <a name="where-is-data-backed-up"></a>Куда выполняется резервное копирование данных

Azure Backup сохраняет резервные копии данных в хранилище служб восстановления. Хранилище — это сущность оперативного хранилища в Azure, которая используется для хранения данных, таких как резервные копии, точки восстановления и политики резервного копирования.

Хранилища служб восстановления имеют следующие возможности.

- Эти хранилища упрощают организацию данных резервного копирования и одновременно снижают затраты на управление.
- В рамках одной подписки Azure можно создать до 500 хранилищ.
- Вы можете отслеживать резервные копии элементов в хранилище, включая виртуальные машины Azure и локальные компьютеры.
- Можно управлять доступом к хранилищу с помощью [управления доступом на основе ролей Azure (RBAC)](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal).
- Нужно указать способ репликации данных в хранилище для обеспечения избыточности:
  - **Локально избыточное хранилище (LRS)** . для защиты от сбоев в центре обработки данных можно использовать LRS. LRS реплицирует данные в единицу масштабирования хранилища. [Дополнительные сведения](https://docs.microsoft.com/azure/storage/common/storage-redundancy-lrs)
  - **Геоизбыточное хранилище (GRS)** . для защиты от простоев в пределах региона можно использовать GRS. GRS реплицирует данные в дополнительный регион. [Дополнительные сведения](https://docs.microsoft.com/azure/storage/common/storage-redundancy-grs)
  - По умолчанию в хранилищах служб восстановления используется GRS.

## <a name="backup-agents"></a>Агенты Backup

Azure Backup предоставляет разные агенты резервного копирования в зависимости от типа компьютера, для которого создается резервная копия:

**Agent** | **Дополнительные сведения**
--- | ---
**Агент MARS** | <ul><li>Выполняется на отдельных локальных компьютерах Windows Server для резервного копирования файлов, папок и состояния системы.</li> <li>Выполняется на виртуальных машинах Azure для резервного копирования файлов, папок и состояния системы.</li> <li>Выполняется на серверах DPM/MABS для резервного копирования диска локального хранилища DPM/MABS в Azure.</li></ul>
**Расширение виртуальной машины Azure** | Выполняется на виртуальных машинах Azure для создания их резервных копий в хранилище.

## <a name="backup-types"></a>Типы резервных копий

В следующей таблице описаны различные типы резервных копий и их использование.

**Тип резервного копирования** | **Дополнительные сведения** | **Использование**
--- | --- | ---
**Полное** | Полная резервная копия содержит весь источник данных. Требует больше пропускной способности сети, чем разностное или добавочное резервное копирование. | Используется для начального резервного копирования.
**Разностное** |  Разностная резервная копия хранит блоки, измененные с момента создания исходной полной резервной копии. Использует меньшее количество сетевых и хранилищ и не сохраняет избыточные копии неизмененных данных.<br/><br/> Неэффективно, так как передаются и сохраняются блоки данных, которые не изменяются между более поздними резервными копиями. | Не используется службой Azure Backup.
**Добавочное** | При добавочной архивации сохраняются только те блоки данных, которые были изменены с момента создания предыдущей резервной копии. Высокая эффективность хранилища и сети. <br/><br/> При добавочном резервном копировании нет необходимости дополнять полные резервные копии. | Используется для резервного копирования на диск DPM или MABS и во всех резервных копиях в Azure. Не используется для резервного копирования SQL Server.

## <a name="sql-server-backup-types"></a>Типы резервного копирования SQL Server

В следующей таблице описаны различные типы резервных копий, используемые для баз данных SQL Server и частоту их использования:

**Тип резервного копирования** | **Дополнительные сведения** | **Использование**
--- | --- | ---
**Полная резервная копия** | При этом типе резервного копирования создается резервная копия всей базы данных. Он содержит все данные в определенной базе данных или в наборе файловых групп или файлов. Полная резервная копия также содержит достаточно журналов для восстановления этих данных. | Максимально в день можно активировать одну полную резервную копию.<br/><br/> Вы можете создать полную резервную копию в течение ежедневного или еженедельного интервала.
**Разностная резервная копия** | Разностное резервное копирование основано на самой последней предыдущей резервной копии данных.<br/><br/> Она содержит только данные, которые были изменены с момента создания полной резервной копии. |  Максимально в день можно активировать одну разностную резервную копию.<br/><br/> Невозможно настроить создание полной и разностной резервных копий в один день.
**Резервная копия журналов транзакций** | Резервная копия журналов транзакций дает возможность восстановления на определенный момент времени с точностью до секунды. | Максимально каждые 15 минут можно настраивать резервные копии журналов транзакций.

### <a name="comparison-of-backup-types"></a>Сравнение типов резервных копий

Использование хранилища, целевое время восстановления (RTO) и использование ресурсов сети различаются для каждого типа резервного копирования. На следующем рисунке показано сравнение типов резервных копий.

- Источник данных A состоит из 10 блоков хранения — a1-A10, которые архивируются ежемесячно.
- Блоки A2, A3, A4 и A9 были изменены в первом месяце, а блок A5 — следующем месяце.
- Если применяется разностное резервное копирование, во втором месяце создаются резервные копии измененных блоков A2, A3, A4 и A9. В третьем месяце эти блоки архивируются повторно, как и измененный блок A5. Измененные блоки будут архивироваться, пока не будет создана следующая полная резервная копия.
- Для добавочных резервных копий во втором месяце блоки a2, A3, A4 и A9 помечаются как измененные и перенесенные. В третьем месяце помечается и передается только измененный блок A5.

![Изображение, показывающее сравнения методов резервного копирования](./media/backup-architecture/backup-method-comparison.png)

## <a name="backup-features"></a>Функции службы Backup

В следующей таблице перечислены поддерживаемые функции для различных типов резервного копирования.

**Компонент** | **Локальные компьютеры Windows Server (Direct)** | **Виртуальные машины Azure** | **Компьютеры или приложения с DPM/MABS**
--- | --- | --- | ---
Резервное копирование в хранилище | ![Yes][green] | ![Yes][green] | ![Yes][green]
Резервное копирование на диск DPM/MABS, затем в Azure | | | ![Yes][green]
Сжатие данных, отправляемых для резервного копирования | ![Yes][green] | При передаче данных сжатие не происходит. Хранилище немного увеличивается, но восстановление выполняется быстрее.  | ![Yes][green]
Добавочное резервное копирование |![Yes][green] |![Yes][green] |![Yes][green]
Резервное копирование дедуплицированных дисков | | | ![Частично][yellow]<br/><br/> Только для серверов DPM или MABS, развернутых локально.

![Ключ таблицы](./media/backup-architecture/table-key.png)

## <a name="architecture-direct-backup-of-azure-vms"></a>Архитектура: непосредственная Архивация виртуальных машин Azure

1. При включении резервного копирования для виртуальной машины Azure резервная копия выполняется в соответствии с указанным расписанием.
1. Во время первой архивации на виртуальной машине устанавливается расширение резервного копирования, если виртуальная машина запущена.
    - Для виртуальных машин Windows установлено расширение VMSnapshot.
    - Для виртуальных машин Linux установлено расширение VMSnapshot Linux.
1. Расширение принимает моментальный снимок на уровне хранилища.
    - Для виртуальных машин Windows, работающих под управлением, резервное копирование координат с помощью служба теневого копирования томов Windows (VSS) для получения моментального снимка виртуальной машины, совместимой с приложениями. По умолчанию резервное копирование занимает все резервные копии VSS. Если не удалось сделать моментальный снимок с согласованием приложений, служба делает моментальный снимок с согласованием файлов.
    - Для виртуальных машин Linux резервное копирование использует моментальный снимок, совместимый с файлами. Для моментальных снимков, совместимых с приложениями, необходимо вручную настроить скрипты до и после.
    - Служба Backup оптимизируется за счет резервного копирования каждого диска виртуальной машины в параллельном режиме. Для каждого диска, для которого создается резервная копия, служба Azure Backup считывает блоки на диске и сохраняет только измененные данные.
1. После создания моментального снимка данные передаются в хранилище.
    - Копируются только те блоки данных, которые изменились с момента создания последней резервной копии.
    - Данные не шифруются. Azure Backup можете выполнять резервное копирование виртуальных машин Azure, которые были зашифрованы с помощью шифрования дисков Azure.
    - Данные моментального снимка нельзя сразу же скопировать в хранилище. В пиковое время резервное копирование может занять некоторое время. Общее время архивации для виртуальной машины будет менее 24 часов для политик ежедневного резервного копирования.
1. После отправки данных в хранилище создается точка восстановления. По умолчанию моментальные снимки хранятся в течение двух дней до их удаления. Эта функция позволяет выполнять операции восстановления из этих моментальных снимков, тем самым уменьшая время восстановления. Он сокращает время, необходимое для преобразования и копирования данных из хранилища. См. раздел [Azure backup функция мгновенного восстановления](https://docs.microsoft.com/azure/backup/backup-instant-restore-capability).

Виртуальным машинам Azure требуется доступ к Интернету для команд управления. Если выполняется резервное копирование рабочих нагрузок внутри виртуальной машины (например, SQL Server резервных копий базы данных), серверным данным также требуется доступ к Интернету.

![Резервное копирование виртуальных машин Azure](./media/backup-architecture/architecture-azure-vm.png)

## <a name="architecture-direct-backup-of-on-premises-windows-server-machines-or-azure-vm-files-or-folders"></a>Архитектура: непосредственная Архивация локальных компьютеров Windows Server или файлов или папок виртуальной машины Azure

1. Чтобы настроить сценарий, скачайте и установите агент MARS на компьютере. Затем вы можете выбрать, что делать для резервного копирования, когда будут выполняться резервные копии и как долго они будут храниться в Azure.
1. Начальная архивация выполняется в соответствии с настройками резервного копирования.
1. Агент MARS использует VSS для создания моментального снимка томов, выбранных для резервного копирования.
    - Агент MARS использует только операцию записи системы Windows для записи моментального снимка.
    - Поскольку агент не использует модули записи VSS приложений, он не отслеживает моментальные снимки, совместимые с приложениями.
1. После создания моментального снимка с помощью VSS агент MARS создает виртуальный жесткий диск (VHD) в папке кэша, указанной при настройке резервного копирования. Агент также хранит контрольные суммы для каждого блока данных.
1. Добавочное резервное копирование выполняется по заданному расписанию, если только не выполняется прямое резервное копирование.
1. При добавочном резервном копировании идентифицируются измененные файлы и создается новый виртуальный жесткий диск, VHD сжимается и шифруется, а затем отправляется в хранилище.
1. После завершения добавочного резервного копирования новый виртуальный жесткий диск объединяется с VHD, созданным после начальной репликации. Этот объединенный виртуальный жесткий диск предоставляет Последнее состояние, которое будет использоваться для сравнения текущей резервной копии.

![Резервное копирование локальных компьютеров Windows Server с помощью агента MARS](./media/backup-architecture/architecture-on-premises-mars.png)

## <a name="architecture-back-up-to-dpmmabs"></a>Архитектура: резервное копирование на DPM/MABS

1. Установите агент защиты DPM или MABS на компьютерах, которые требуется защитить. Затем вы добавите компьютеры в группу защиты DPM.
    - Чтобы защитить локальные компьютеры, сервер DPM или MABS должен располагаться локально.
    - Для защиты виртуальных машин Azure сервер MABS должен находиться в Azure и быть запущен в качестве виртуальной машины Azure.
    - DPM/MABS позволяет защищать резервные тома, общие ресурсы, файлы и папки. Вы также можете защитить состояние системы компьютера (без исходного состояния), а также защитить определенные приложения с помощью параметров резервного копирования с учетом приложений.
1. При настройке защиты для компьютера или приложения в DPM/MABS необходимо выбрать резервное копирование на локальный диск MABS/DPM для краткосрочного хранения и в Azure для оперативной защиты. Вы также указываете, когда должна выполняться резервное копирование в локальное хранилище DPM/MABS и когда необходимо запустить оперативное резервное копирование в Azure.
1. Диск защищенной рабочей нагрузки архивируется на локальные диски MABS/DPM в соответствии с указанным расписанием.
4. Диски DPM/MABS архивируются в хранилище агентом MARS, который выполняется на сервере DPM/MABS.

![Резервное копирование компьютеров и рабочих нагрузок, защищенных с помощью DPM или MABS](./media/backup-architecture/architecture-dpm-mabs.png)

## <a name="azure-vm-storage"></a>Хранилище виртуальной машины Azure

Виртуальные машины Azure используют диски для хранения операционной системы, приложений и данных. Каждая виртуальная машина Azure имеет по крайней мере два диска: диск для операционной системы и временный диск. Виртуальные машины Azure также могут иметь диски данных для данных приложений. Диски хранятся как виртуальные жесткие диски.

- Виртуальные жесткие диски хранятся в виде страничных BLOB-объектов в учетных записях хранения Standard или Premium в Azure.
  - **Хранилище уровня "Стандартный":** Надежная и экономичная поддержка дисков для виртуальных машин, работающих под управлением рабочих нагрузок, которые не чувствительны к задержке. Хранилище уровня "Стандартный" может использовать стандартные диски твердотельных накопителей (SSD) или диски стандартного жесткого диска (HDD).
  - **Хранилище класса Premium:** Поддержка дисков с высокой производительностью. Используются диски SSD ценовой категории "Премиум".
- Есть разные уровни производительности дисков:
  - **HDD (цен. Категория "Стандартный") диск:** Поддерживаются дисками жестких дисков и используются для экономичного хранения.
  - **SSD (цен. Категория "Стандартный") диск:** Объединяет элементы дисков SSD уровня "Премиум" и "Стандартный" дисков HDD. Обеспечивает более устойчивую производительность и надежность, чем жесткий диск, но по-прежнему экономичность.
  - **SSD (цен. Категория "Премиум") диск:** Поддерживаются SSDs и обеспечивают высокую производительность и низкую задержку для виртуальных машин, на которых выполняются рабочие нагрузки с интенсивным вводом-выводом.
- Диски могут быть управляемыми или неуправляемыми:
  - **Неуправляемые диски:** Традиционные типы дисков, используемые виртуальными машинами. Вы можете создать собственную учетную запись хранения и указать ее во время создания такого диска. Затем необходимо выяснить, как максимизировать ресурсы хранилища для виртуальных машин.
  - **Управляемые диски:** Azure создает учетные записи хранения и управляет ими. Вы указываете размер и уровень производительности диска, а Azure создает управляемые диски. При добавлении дисков и масштабирования виртуальных машин Azure обрабатывает учетные записи хранения.

Дополнительные сведения о хранилище дисков и доступных типах дисков для виртуальных машин см. в следующих статьях:

- [Управляемые диски Azure для виртуальных машин Windows](../virtual-machines/windows/managed-disks-overview.md)
- [Управляемые диски Azure для виртуальных машин Linux](../virtual-machines/linux/managed-disks-overview.md)
- [Доступные типы дисков для виртуальных машин](../virtual-machines/windows/disks-types.md)

### <a name="back-up-and-restore-azure-vms-with-premium-storage"></a>Резервное копирование и восстановление виртуальных машин Azure в хранилище класса Premium

Для резервного копирования виртуальных машин Azure можно использовать хранилище класса Premium с Azure Backup:

- В процессе резервного копирования виртуальных машин с хранилищем класса Premium служба Backup создает временное промежуточное расположение с именем *AzureBackup-* в учетной записи хранения. Размер промежуточного расположения равен размеру моментального снимка точки восстановления.
- Убедитесь, что в учетной записи хранения класса Premium достаточно свободного места для расположения временного промежуточного хранения. [Дополнительные сведения](../storage/common/storage-scalability-targets.md#premium-performance-storage-account-scale-limits) Не следует изменять расположение временного промежуточного хранения.
- По завершении задания резервного копирования расположение промежуточного хранения удаляется.
- Плата за использование расположения промежуточного хранения взимается в соответствии с [тарифами на использование хранилища класса Premium](../virtual-machines/windows/disks-types.md#billing).

При восстановлении виртуальных машин Azure с помощью хранилища класса Premium их можно восстановить в хранилище уровня "Премиум" или "Стандартный". Как правило, их можно восстановить в хранилище класса Premium. Но если вам требуется только подмножество файлов с виртуальной машины, это может быть выгодно для восстановления в стандартном хранилище.

### <a name="back-up-and-restore-managed-disks"></a>Резервное копирование и восстановление управляемых дисков

Вы можете выполнять резервное копирование виртуальных машин Azure с управляемыми дисками:

- Резервное копирование виртуальных машин с управляемыми дисками выполняется так же, как и любых других виртуальных машин Azure. Резервное копирование виртуальной машины можно выполнить непосредственно в настройках виртуальной машины. Кроме того, вы можете включить резервное копирование виртуальных машин в хранилище Служб восстановления.
- Виртуальные машины, использующие управляемые диски, можно архивировать с помощью наборов точек восстановления, созданных на основе управляемых дисков.
- Azure Backup также поддерживает резервное копирование виртуальных машин с управляемыми дисками, которые были зашифрованы с помощью шифрования дисков Azure.

При восстановлении виртуальных машин с управляемыми дисками можно выполнить восстановление на полную виртуальную машину с управляемыми дисками или с учетной записью хранения.

- В процессе восстановления Azure обрабатывает управляемые диски. Если вы используете учетную запись хранения, вы управляете учетной записью хранения, созданной в процессе восстановления.
- При восстановлении зашифрованной управляемой виртуальной машины убедитесь, что ключи и секреты виртуальной машины существуют в хранилище ключей, прежде чем начать процесс восстановления.

## <a name="next-steps"></a>Дополнительная информация

- Изучите таблицу поддержки, чтобы [узнать о поддерживаемых функциях и ограничениях для сценариев резервного копирования](backup-support-matrix.md).
- Настройте резервное копирование для одного из следующих сценариев:
  - [Резервное копирование виртуальных машин Azure](backup-azure-arm-vms-prepare.md).
  - [Прямое резервное копирование компьютеров Windows](tutorial-backup-windows-server-to-azure.md) без сервера резервного копирования.
  - [Настройка MABS](backup-azure-microsoft-azure-backup.md) для резервного копирования в Azure и последующее резервное копирование рабочих нагрузок в MABS.
  - [Настройка DPM](backup-azure-dpm-introduction.md) для резервного копирования в Azure и последующее резервное копирование рабочих нагрузок в DPM.

[green]: ./media/backup-architecture/green.png
[yellow]: ./media/backup-architecture/yellow.png
[red]: ./media/backup-architecture/red.png
