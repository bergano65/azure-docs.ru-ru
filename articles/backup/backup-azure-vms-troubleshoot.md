---
title: Устранение неполадок при резервном копировании виртуальных машин Azure
description: Из этой статьи вы узнаете, как устранять ошибки, возникающие при резервном копировании и восстановлении виртуальных машин Azure.
ms.reviewer: srinathv
author: dcurwin
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 08/30/2019
ms.author: dacurwin
ms.openlocfilehash: 78de85cede228f4b1c6ff01388fd7a08f78aa74f
ms.sourcegitcommit: 827248fa609243839aac3ff01ff40200c8c46966
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/07/2019
ms.locfileid: "73747191"
---
# <a name="troubleshooting-backup-failures-on-azure-virtual-machines"></a>Устранение ошибок резервного копирования на виртуальных машинах Azure

Вы можете устранить ошибки, возникшие при использовании Azure Backup, с приведенными ниже сведениями.

## <a name="backup"></a>Архивация

В этом разделе рассматривается сбой операции резервного копирования виртуальной машины Azure.

### <a name="basic-troubleshooting"></a>Базовое устранение неполадок

* Убедитесь, что агент виртуальной машины (Агент Вашингтон) является [последней версией](https://docs.microsoft.com/azure/backup/backup-azure-arm-vms-prepare#install-the-vm-agent).
* Убедитесь, что версия ОС виртуальной машины Windows или Linux поддерживается, см. [таблицу поддержки резервного копирования виртуальных машин IaaS](https://docs.microsoft.com/azure/backup/backup-support-matrix-iaas).
* Убедитесь, что другая служба архивации не запущена.
  * Чтобы убедиться в отсутствии проблем с расширением моментальных снимков, [удалите расширения для принудительной перезагрузки и повторите попытку резервного копирования](https://docs.microsoft.com/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout#the-backup-extension-fails-to-update-or-load).
* Убедитесь, что виртуальная машина подключена к Интернету.
  * Убедитесь, что другая служба архивации не запущена.
* На `Services.msc`убедитесь, что служба **гостевого агента Windows Azure** **запущена**. Если служба **гостевого агента Windows Azure** отсутствует, установите ее из [резервного копирования виртуальных машин Azure в хранилище служб восстановления](https://docs.microsoft.com/azure/backup/backup-azure-arm-vms-prepare#install-the-vm-agent).
* **Журнал событий** может показывать ошибки резервного копирования, которые относятся к другим продуктам резервного копирования, например системе архивации данных Windows Server, а также не из-за службы архивации Azure. Чтобы определить, связана ли эта ошибка с Azure Backup, выполните следующие действия.
  * Если в источнике события или в сообщении возникла ошибка, проверьте, были **ли резервные** копии виртуальной машины Azure IaaS выполнены успешно и создана ли точка восстановления с требуемым типом моментального снимка.
  * Если Azure Backup работает, то, скорее всего, эта ошибка связана с другим решением резервного копирования.
  * Ниже приведен пример ошибки в средстве просмотра событий 517, где служба архивации Azure работала нормально, но ошибка "cистема архивации данных Windows Server":<br>
    Сбой ![cистема архивации данных Windows Server](media/backup-azure-vms-troubleshoot/windows-server-backup-failing.png)
  * Если Azure Backup происходит сбой, найдите соответствующий код ошибки в разделе Общие ошибки резервного копирования виртуальных машин в этой статье.

## <a name="common-issues"></a>Распространенные проблемы

Ниже приведены распространенные проблемы, связанные с ошибками резервного копирования на виртуальных машинах Azure.

## <a name="copyingvhdsfrombackupvaulttakinglongtime---copying-backed-up-data-from-vault-timed-out"></a>Копингвхдсфромбаккупваулттакинглонгтиме — истекло время ожидания при копировании резервных копий данных из хранилища

Код ошибки: Копингвхдсфромбаккупваулттакинглонгтиме <br/>
Сообщение об ошибке: истекло время ожидания при копировании резервных копий данных из хранилища

Это может произойти из-за временных ошибок хранилища или недостаточных операций ввода-вывода в хранилище для службы резервного копирования, чтобы передавать данные в хранилище в течение времени ожидания. Настройте резервное копирование виртуальных машин, используя эти [рекомендации](backup-azure-vms-introduction.md#best-practices), и повторите операцию резервного копирования.

## <a name="usererrorvmnotindesirablestate---vm-is-not-in-a-state-that-allows-backups"></a>Усереррорвмнотиндесираблестате — виртуальная машина не находится в состоянии, допускающем резервное копирование.

Код ошибки: Усереррорвмнотиндесираблестате <br/>
Сообщение об ошибке: виртуальная машина не находится в состоянии, допускающем резервное копирование.<br/>

Не удалось выполнить операцию резервного копирования, так как виртуальная машина находится в состоянии сбоя. Для успешной операции резервного копирования виртуальная машина должна быть в состоянии "Выполняется", "Остановлено" или "Остановлено (освобождено)".

* Если виртуальная машина находится в состоянии перехода из **рабочего** в состояние **завершения работы**, дождитесь изменения состояния. Затем запустите задание резервного копирования.
* Если это виртуальная машина Linux, которая использует модуль ядра Security Enhanced Linux, то необходимо исключить путь агента Linux для Azure **/var/lib/waagent** из политики безопасности, чтобы обеспечить установку расширения резервного копирования.

## <a name="usererrorfsfreezefailed---failed-to-freeze-one-or-more-mount-points-of-the-vm-to-take-a-file-system-consistent-snapshot"></a>Усереррорфсфризефаилед — не удалось заморозить одну или несколько точек подключения виртуальной машины, чтобы сделать моментальный снимок, совместимый с файловой системой

Код ошибки: Усереррорфсфризефаилед <br/>
Сообщение об ошибке: не удалось заморозить одну или несколько точек подключения виртуальной машины, чтобы сделать моментальный снимок, совместимый с файловой системой.

* Проверьте состояние файловой системы всех подключенных устройств с помощью команды **tune2fs** , например **tune2fs-l/dev/sdb1 \\** .\| **состояние файловой**системы grep.
* Отключите устройства, для которых состояние файловой системы не было очищено, с помощью команды **umount** .
* Выполните проверку согласованности файловой системы на этих устройствах с помощью команды **fsck** .
* Подключите устройства еще раз и повторите операцию резервного копирования.</ol>

## <a name="extensionsnapshotfailedcom--extensioninstallationfailedcom--extensioninstallationfailedmdtc---extension-installationoperation-failed-due-to-a-com-error"></a>Екстенсионснапшотфаиледком/Екстенсионинсталлатионфаиледком/Екстенсионинсталлатионфаиледмдтк: сбой установки или операции расширения из-за ошибки COM+

Код ошибки: Екстенсионснапшотфаиледком <br/>
Сообщение об ошибке: операция моментального снимка завершилась сбоем из-за ошибки COM+

Код ошибки: Екстенсионинсталлатионфаиледком  <br/>
Сообщение об ошибке: сбой установки или операции расширения из-за ошибки COM+

Код ошибки: Екстенсионинсталлатионфаиледмдтк <br/>
Сообщение об ошибке: сбой установки расширения с ошибкой "COM+ не удалось связаться с Microsoft координатор распределенных транзакций <br/>

Сбой операции резервного копирования из-за проблемы с **системным приложением COM+** службы Windows.  Проблему можно устранить следующим способом.

* Попробуйте запустить или перезапустить **Системное приложение COM+** службы Windows (из командной строки с повышенными привилегиями **— net start COMSysApp**).
* Убедитесь, что служба **координатор распределенных транзакций** запущена как учетная запись **сетевой службы** . Если это не так, измените его для запуска от имени учетной записи **сетевой службы** и перезапустите **приложение COM+ System**.
* Если не удается перезапустить службу, переустановите **координатор распределенных транзакций** службу, выполнив следующие действия:
  * Остановите работу службы MSDTC.
  * Откройте окно командной строки (cmd).
  * Выполните команду "MSDTC-Uninstall"
  * Выполните команду "MSDTC-Install"
  * Запустите службу MSDTC.
* Запустите службу Windows **Системное приложение COM+** . После запуска службы **Системное приложение COM+** активируйте задание резервного копирования на портале Azure.</ol>

## <a name="extensionfailedvsswriterinbadstate---snapshot-operation-failed-because-vss-writers-were-in-a-bad-state"></a>Екстенсионфаиледвссвритеринбадстате-не удалось выполнить операцию моментального снимка, так как модули записи VSS находятся в неправильном состоянии

Код ошибки: Екстенсионфаиледвссвритеринбадстате <br/>
Сообщение об ошибке: сбой операции snapshot, так как модули записи VSS находятся в неправильном состоянии.

Перезапустите модули записи VSS, которые находятся в неисправном состоянии. В командной строке с повышенными привилегиями выполните команду ```vssadmin list writers```. В выходных данных содержатся все модули записи VSS и их состояние. Перезапустите каждый модуль записи VSS, состояние которого отличается от **[1] Стабильный**, выполнив следующие команды из командной строки с повышенными привилегиями.

* ```net stop serviceName```
* ```net start serviceName```

## <a name="extensionconfigparsingfailure--failure-in-parsing-the-config-for-the-backup-extension"></a>Екстенсионконфигпарсингфаилуре — сбой при анализе конфигурации для расширения резервного копирования

Код ошибки: Екстенсионконфигпарсингфаилуре<br/>
Сообщение об ошибке: сбой при синтаксическом анализе конфигурации для модуля резервного копирования.

Эта ошибка возникает из-за изменения разрешений в каталоге **MachineKeys**: **%systemdrive%\programdata\microsoft\crypto\rsa\machinekeys**.
Выполните следующую команду и убедитесь, что разрешения для каталога **MachineKeys** по умолчанию:**icacls%системдриве%\програмдата\микрософт\крипто\рса\мачинекэйс**.

Разрешения по умолчанию:

* Все: (R, W)
* Builtin \ администраторы: (F)

Если для каталога **MachineKeys** назначены другие разрешения, выполните следующие действия, чтобы изменить разрешения, удалить сертификат и активировать архивацию.

1. Исправьте разрешения для каталога **MachineKeys**. С помощью свойств безопасности обозревателя и дополнительных параметров безопасности в каталоге сбросьте разрешения к значениям по умолчанию. Удалите дополнительные пользовательские объекты, отличные от объектов по умолчанию, из каталога и убедитесь, что у **всех** есть доступ к таким операциям:

   * – вывод списка папок, чтение данных;
   * – чтение атрибутов;
   * – чтение дополнительных атрибутов;
   * – создание файлов, запись данных;
   * – создание папок, добавление данных;
   * – запись атрибутов;
   * – запись дополнительных атрибутов;
   * – разрешения на чтение.
2. Удалите все сертификаты с полем **Получатель сертификата**, имеющим значение классической модели развертывания или **Windows Azure CRP Certificate Generator**.

   * [Практическое руководство. Просмотр сертификатов с помощью оснастки консоли MMC](https://msdn.microsoft.com/library/ms788967(v=vs.110).aspx).
   * В разделе **Личное** > **Сертификаты** удалите все сертификаты с полем **Получатель сертификата**, имеющим значение **Windows Azure CRP Certificate Generator**.
3. Активируйте задание архивации виртуальной машины.

## <a name="extensionstuckindeletionstate---extension-state-is-not-supportive-to-backup-operation"></a>Екстенсионстуккинделетионстате — состояние расширения не поддерживает операцию резервного копирования

Код ошибки: Екстенсионстуккинделетионстате <br/>
Сообщение об ошибке: состояние расширения не поддерживает операцию резервного копирования

Сбой операции резервного копирования из-за несоответствия состояния расширения резервного копирования. Проблему можно устранить следующим способом.

* Убедитесь, что гостевой агент установлен и отвечает на запросы.
* В портал Azure перейдите к **виртуальной машине** > **все параметры** > **расширения** .
* Выберите расширение резервного копирования VmSnapshot или VmSnapshotLinux и щелкните **Удалить**.
* После удаления расширения резервного копирования повторите операцию резервного копирования
* При выполнении последующей операции резервного копирования будет установлено новое расширение в требуемом состоянии.

## <a name="extensionfailedsnapshotlimitreachederror---snapshot-operation-failed-as-snapshot-limit-is-exceeded-for-some-of-the-disks-attached"></a>Екстенсионфаиледснапшотлимитреачедеррор-не удалось выполнить операцию snapshot, так как превышено ограничение на количество моментальных снимков для некоторых подключенных дисков

Код ошибки: Екстенсионфаиледснапшотлимитреачедеррор  <br/>
Сообщение об ошибке: сбой операции snapshot, так как превышено ограничение на количество моментальных снимков для некоторых дисков

Не удалось выполнить операцию создания моментального снимка, так как превышено ограничение на количество моментальных снимков для некоторых подключенных дисков. Выполните приведенные ниже действия по устранению неполадок и повторите операцию.

* Удалите ненужные моментальные снимки BLOB-объекта диска. Будьте осторожны, чтобы не удалять большой двоичный объект диска, необходимо удалить только BLOB-объекты моментальных снимков.
* Если обратимое удаление включено на дисковых учетных записях виртуальной машины, настройте обратимое удаление, чтобы существующие моментальные снимки были меньше максимально допустимого в любой момент времени.
* Если в резервной виртуальной машине включено Azure Site Recovery, выполните следующие действия.

  * Убедитесь, что для параметра **исаниснапшотфаилед** задано значение false в/ЕТК/Азуре/вмбаккуп.конф
  * Запланируйте Azure Site Recovery в другое время, чтобы не конфликтовать с операцией резервного копирования.

## <a name="extensionfailedtimeoutvmnetworkunresponsive---snapshot-operation-failed-due-to-inadequate-vm-resources"></a>Екстенсионфаиледтимеаутвмнетворкунреспонсиве-сбой операции создания моментального снимка из-за недостаточных ресурсов виртуальной машины.

Код ошибки: Екстенсионфаиледтимеаутвмнетворкунреспонсиве<br/>
Сообщение об ошибке: сбой операции snapshot из-за недостаточных ресурсов виртуальной машины.

Операция резервного копирования на виртуальной машине завершилась сбоем из-за задержки в сетевых вызовах во время выполнения операции создания моментального снимка. Чтобы устранить эту проблему, выполните шаг 1. Если проблема повторится, попробуйте выполнить шаги 2 и 3.

**Шаг 1**. Создание моментального снимка с помощью узла

В командной строке с повышенными правами (администратора) выполните следующую команду:

```text
REG ADD "HKLM\SOFTWARE\Microsoft\BcdrAgentPersistentKeys" /v SnapshotMethod /t REG_SZ /d firstHostThenGuest /f
REG ADD "HKLM\SOFTWARE\Microsoft\BcdrAgentPersistentKeys" /v CalculateSnapshotTimeFromHost /t REG_SZ /d True /f
```

Это позволит обеспечить создание моментальных снимков через ОС узла, а не гостевую ОС. Повторите резервное копирование.

**Шаг 2**. Попробуйте изменить расписание резервного копирования на время, когда виртуальная машина будет меньше загрузки (меньше ресурсов ЦП и операций ввода-вывода и т. д.).

**Шаг 3**. Попробуйте [увеличить размер виртуальной машины](https://azure.microsoft.com/blog/resize-virtual-machines/) и повторите операцию

## <a name="common-vm-backup-errors"></a>Распространенные ошибки резервного копирования виртуальных машин

| Сведения об ошибке | Возможное решение |
| ------ | --- |
| **Код ошибки**: 320001, ResourceNotFound <br/> **Сообщение об ошибке**: не удалось выполнить операцию, так как виртуальная машина больше не существует. <br/> <br/> **Код ошибки**: 400094, BCMV2VMNotFound <br/> **Сообщение об ошибке**: виртуальная машина не существует <br/> <br/>  Виртуальная машина Azure не найдена.  |Эта ошибка возникает, когда основная виртуальная машина удалена, но политика резервного копирования продолжает ее поиск, чтобы выполнить резервное копирование. Чтобы исправить эту ошибку, выполните следующие действия. <ol><li> Повторно создайте виртуальную машину с тем же именем и тем же именем группы ресурсов **имя облачной службы**,<br>**or** (или).</li><li> Отключите защиту виртуальной машины, удаляя или не удаляя данные резервного копирования. Дополнительные сведения см. в разделе [Отключение защиты виртуальных машин](backup-azure-manage-vms.md#stop-protecting-a-vm).</li></ol>|
| **Код ошибки**: усереррорвмпровисионингстатефаилед<br/> **Сообщение об ошибке**: виртуальная машина находится в состоянии сбоя подготовки: <br>Перезапустите виртуальную машину и убедитесь, что она находится в запущенном или остановленном состоянии. | Эта ошибка возникает, когда неполадка расширения приводит к тому, что виртуальная машина переходит в состояние сбоя подготовки. Перейдите к списку расширений и проверьте, нет ли сбоев в работе расширений. Удалите соответствующее расширение и попробуйте перезапустить виртуальную машину. Если все расширения находятся в рабочем состоянии, проверьте, запущена ли служба агента виртуальной машины. Если нет, то перезапустите службу агента виртуальной машины. |
|**Код ошибки**: усереррорбкмпремиумсторажекуотаеррор<br/> **Сообщение об ошибке**: не удалось скопировать моментальный снимок виртуальной машины из-за нехватки свободного места в учетной записи хранения | Для резервного копирования виртуальных машин уровня "Премиум" в стеке резервных копий виртуальных машин версии 1 мы копируем моментальный снимок в учетную запись хранения. Это гарантирует, что трафик управления резервным копированием, который возникает при работе с моментальным снимком, не ограничивает число операций ввода-вывода, доступных для приложения, использующего диски уровня "Премиум". <br><br>Корпорация Майкрософт рекомендует выделять только 50 %, 17,5 ТБ, от общего объема хранилища учетной записи хранения. Затем служба Azure Backup может скопировать моментальный снимок в учетную запись хранения и перенести данные из этого скопированного расположения в учетной записи хранения в хранилище. |
| **Код ошибки**: 380008, азуревмоффлине <br/> **Сообщение об ошибке**: не удалось установить расширение служб восстановления Microsoft, так как виртуальная машина не запущена | Необходимым условием для расширения служб восстановления Azure является наличие агента виртуальной машины. Установите агент виртуальной машины Azure и перезапустите операцию регистрации. <br> <ol> <li>Убедитесь, что агент виртуальной машины установлен правильно. <li>Убедитесь, что флажок в конфигурации виртуальной машины установлен на правильное значение.</ol> Ознакомьтесь со сведениями об установке агента виртуальной машины и проверке правильности ее выполнения. |
| **Код ошибки**: екстенсионснапшотбитлоккереррор <br/> **Сообщение об ошибке**: сбой операции моментального снимка с ошибкой служба ТЕНЕВОГО копирования ТОМОВ (VSS) **. этот диск заблокирован шифрование диска BitLocker. Необходимо разблокировать этот диск с помощью панели управления.** |Отключите BitLocker для всех дисков на виртуальной машине и проверьте, устранена ли проблема с VSS. |
| **Код ошибки**: вмнотиндесираблестате <br/> **Сообщение об ошибке**: виртуальная машина находится не в состоянии, допускающем резервное копирование. |<ul><li>Если виртуальная машина находится в состоянии перехода из **рабочего** в состояние **завершения работы**, дождитесь изменения состояния. Затем запустите задание резервного копирования. <li> Если это виртуальная машина Linux, которая использует модуль ядра Security Enhanced Linux, то необходимо исключить путь агента Linux для Azure **/var/lib/waagent** из политики безопасности, чтобы обеспечить установку расширения резервного копирования.  |
| На виртуальной машине отсутствует агент виртуальной машины. <br>Установите необходимые компоненты и агент виртуальной машины. Затем перезапустите операцию. |Дополнительные сведения об [установке агента виртуальной машины и проверке установки агента виртуальной машины](#vm-agent). |
| **Код ошибки**: екстенсионснапшотфаиледносекуренетворк <br/> **Сообщение об ошибке**: операция моментального снимка завершилась сбоем из-за сбоя создания защищенного канала связи по сети. | <ol><li> Откройте редактор реестра, запустив файл **regedit.exe** в режиме с повышенными правами. <li> Определите все версии платформы .NET Framework, установленные в системе. Они находятся в иерархии раздела реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft**. <li> Для каждой платформы .NET Framework в этом разделе реестра добавьте следующий раздел: <br> **SchUseStrongCrypto"=dword:00000001**. </ol>|
| **Код ошибки**: екстенсионвкредистинсталлатионфаилуре <br/> **Сообщение об ошибке**: сбой операции создания моментального снимка из C++ -за сбоя при установке распространяемого компонента Visual Studio 2012. | Перейдите по адресу К:\паккажес\плугинс\микрософт.Азуре.рековерисервицес.вмснапшот\ажентверсион и установите vcredist2013_x64.<br/>Убедитесь, что значение раздела реестра, разрешающее установку службы, задано как правильное значение. То есть установите **Начальное** значение в **HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Msiserver** , равное **3** , а не **4**. <br><br>Если проблемы с установкой не исчезли, перезапустите службу установки, последовательно выполнив команды **MSIEXEC /UNREGISTER** и **MSIEXEC /REGISTER** в командной строке с повышенными привилегиями.  |

## <a name="jobs"></a>Задания

| Сведения об ошибке | Возможное решение |
| --- | --- |
| Отмена не поддерживается в этом типе задания. <br>Дождитесь завершения задания. |None |
| Задание не находится в состоянии отмены. <br>Дождитесь завершения задания. <br>**or** (или).<br> Выбранное задание не находится в состоянии отмены. <br>Дождитесь остановки задания. |Скорее всего, задание почти выполнено. Дождитесь завершения задания.|
| Резервное копирование не может отменить задание, так как оно не выполняется. <br>Отмена поддерживается только для выполняющихся заданий. Попытайтесь отменить выполняющееся задание. |Эта ошибка возникает из-за переходного состояния. Подождите минуту и повторите отмену. |
| При резервном копировании не удалось отменить задание. <br>Дождитесь завершения задания. |None |

## <a name="restore"></a>Восстановление

| Сведения об ошибке | Возможное решение |
| --- | --- |
| Сбой восстановления из-за внутренней ошибки облака. |<ol><li>В облачной службе, в которую вы пытаетесь выполнить восстановление, настроены параметры DNS. Проверьте параметр <br>**$deployment = Get-AzureDeployment -ServiceName "ServiceName" -Slot "Production"     Get-AzureDns -DnsSettings $deployment.DnsSettings**.<br>Если настроен **адрес**, это означает, что настроены и параметры DNS.<br> <li>В облачной службе, в которую вы пытаетесь выполнить восстановление, настроен параметр **ReservedIP**, а существующие в ней виртуальные машины находятся в остановленном состоянии. Вы можете проверить, что облачная служба зарезервировала IP-адрес, используя следующие командлеты PowerShell: **$deploy = Get-AzureDeployment -ServiceName "servicename" -Slot "Production" $dep.ReservedIPName**. <br><li>Вы пытаетесь восстановить виртуальную машину в ту же облачную службу со следующими специальными конфигурациями сети: <ul><li>– виртуальные машины во внутренней и внешней конфигурации балансировщика нагрузки;<li>– виртуальные машины с несколькими зарезервированными IP-адресами; <li>– виртуальные машины с несколькими сетевыми адаптерами. </ul><li>Выберите новую облачную службу в пользовательском интерфейсе или просмотрите [рекомендации по восстановлению](backup-azure-arm-restore-vms.md#restore-vms-with-special-configurations) для виртуальных машин со специальными конфигурациями сети.</ol> |
| Выбранное DNS-имя уже занято. <br>Укажите другое DNS-имя и повторите попытку. |Указанное здесь DNS-имя ссылается на имя облачной службы обычно с расширением **.cloudapp.net**. Это имя должно быть уникальным. Если возникает эта ошибка, во время восстановления необходимо выбрать другое имя виртуальной машины. <br><br> Эта ошибка отображается только для пользователей портала Azure. Восстановление с помощью PowerShell выполняется успешно, так как восстанавливаются только диски, а виртуальная машина не создается. Ошибка возникнет, если вы явно создадите виртуальную машину после восстановления дисков. |
| Указана неправильная конфигурация виртуальной сети. <br>Укажите другую конфигурацию виртуальной сети и повторите попытку. |None |
| Указанная облачная служба использует зарезервированный IP-адрес, который не соответствует конфигурации восстанавливаемой виртуальной машины. <br>Укажите другую облачную службу, которая не использует зарезервированный IP-адрес. Или выберите другую точку восстановления. |None |
| Облачная служба достигла ограничения на количество входных конечных точек. <br>Повторите операцию, указав другую облачную службу или используя существующую конечную точку. |None |
| Хранилище Служб восстановления и целевая учетная запись хранения находятся в двух разных регионах. <br>Убедитесь, что указанная в операции восстановления учетная запись хранения находится в том же регионе Azure, что и хранилище Служб восстановления. |None |
| Учетная запись хранения, указанная для операции восстановления, не поддерживается. <br>Поддерживаются только базовые или стандартные учетные записи хранения с локально избыточными или геоизбыточными параметрами репликации. Выберите поддерживаемую учетную запись хранения. |None |
| Тип учетной записи хранения, указанной для операции восстановления, не подключен к сети. <br>Убедитесь, что учетная записи хранения, указанная в операции восстановления, подключена к сети. |Эта ошибка может возникать из-за временной ошибки в службе хранилища Azure или из-за сбоя. Выберите другую учетную запись хранения. |
| Достигнут предел квоты группы ресурсов. <br>Удалите некоторые группы ресурсов с портала Azure или обратитесь в службу поддержки Azure, чтобы увеличить границы. |None |
| Выбранная подсеть не существует. <br>Выберите подсеть для проверки. |None |
| У службы Backup нет разрешения на доступ к ресурсам в вашей подписке. |Чтобы устранить эту ошибку, сначала восстановите диски, выполнив шаги, описанные в разделе [Восстановление резервных копий дисков](backup-azure-arm-restore-vms.md#restore-disks). Затем выполните команды PowerShell, описанные в разделе [Создание виртуальной машины с восстановленного диска](backup-azure-vms-automation.md#restore-an-azure-vm). |

## <a name="backup-or-restore-takes-time"></a>Резервное копирование или восстановление занимает время

Если резервное копирование занимает более 12 часов, или восстановление занимает более 6 часов [, ознакомьтесь с рекомендациями](backup-azure-vms-introduction.md#best-practices)и [вопросами производительности](backup-azure-vms-introduction.md#backup-performance) .

## <a name="vm-agent"></a>Агент виртуальной машины

### <a name="set-up-the-vm-agent"></a>Настройка агента виртуальной машины

Как правило, агент виртуальной машины уже имеется на виртуальных машинах, которые созданы с помощью коллекции Azure. Но на виртуальных машинах, которые переносятся из локальных центров обработки данных, агента виртуальной машины не будет. Для таких виртуальных машин агент ВМ необходимо установить явным образом.

#### <a name="windows-vms"></a>Виртуальные машины Windows

* Скачайте и установите [MSI-файл агента](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора.
* Для виртуальных машин, созданных с использованием классической модели развертывания, [обновите свойство классических виртуальных машин](https://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы указать, что агент установлен. Этот шаг является необязательным для виртуальных машин Azure Resource Manager.

#### <a name="linux-vms"></a>Виртуальные машины Linux

* Установите последнюю версию агента из репозитория дистрибутива. Сведения об имени пакета см. в [репозитории агента Linux](https://github.com/Azure/WALinuxAgent).
* Для виртуальных машин, созданных с использованием классической модели развертывания, [используйте этот блог](https://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы обновить свойство виртуальных машин и указать, что агент установлен. Этот шаг не является обязательным для виртуальных машин Resource Manager.

### <a name="update-the-vm-agent"></a>Обновление агента виртуальной машины

#### <a name="windows-vms"></a>Виртуальные машины Windows

* Чтобы обновить агент виртуальной машины, переустановите [его двоичные файлы](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Прежде чем обновлять агент, убедитесь, что не выполняются никакие операции резервного копирования.

#### <a name="linux-vms"></a>Виртуальные машины Linux

* Чтобы обновить агент виртуальной машины Linux, следуйте инструкциям в статье [Как обновить агент Azure Linux на виртуальной машине](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

    > [!NOTE]
    > Рекомендуется обновлять агент только через репозиторий дистрибутива.

    Не рекомендуется скачивать код агента с портала GitHub. Если последняя версия агента не доступна для дистрибутива, обратитесь в службу поддержки дистрибутива, чтобы получить инструкции по получению последней версии агента. Последние сведения об [агенте Windows Azure Linux](https://github.com/Azure/WALinuxAgent/releases) см. в репозитории GitHub.

### <a name="validate-vm-agent-installation"></a>Проверка установки агента виртуальной машины

Для проверки версии агента виртуальной машины на виртуальных машинах Windows выполните следующие действия.

1. Войдите в систему виртуальной машины Azure и перейдите в папку **C:\WindowsAzure\Packages**. В ней должен находиться файл **WaAppAgent.exe**.
2. Щелкните правой кнопкой мыши файл и выберите **Свойства**. Затем перейдите на вкладку **сведения** . Поле **версия продукта** должно иметь значение отображаться 2.6.1198.718 или выше.

## <a name="troubleshoot-vm-snapshot-issues"></a>Решение проблем со снимками виртуальных машин

Архивация виртуальных машин зависит от команды моментального снимка в базовом хранилище. Отсутствие доступа к хранилищу или задержка в выполнении задачи создания моментального снимка может привести к неудачному завершению задания резервного копирования. Сбой задачи создания снимка может быть вызван следующими условиями.

* **Сетевой доступ к хранилищу блокируется при помощи групп NSG**. Дополнительные сведения о том, как [установить сетевой доступ](backup-azure-arm-vms-prepare.md#establish-network-connectivity) к хранилищу, можно получить с помощью списка разрешенных IP-адресов или с помощью прокси сервера.
* **Виртуальные машины с настроенной архивацией SQL Server могут вызвать задержку задачи создания моментальных снимков**. По умолчанию при архивации виртуальной машины создается полная резервная копия VSS на виртуальных машинах Windows. На виртуальных машинах, где выполняется SQL Server и настроена архивация SQL Server, это может привести к задержке создания моментального снимка. Если эти задержки приводят к ошибкам резервного копирования, установите следующий ключ реестра.

   ```text
   [HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
   "USEVSSCOPYBACKUP"="TRUE"
   ```

* **Состояние виртуальной машины отображается неправильно из-за того, что работа виртуальной машины была завершена в сеансе удаленного рабочего стола**. При использовании удаленного рабочего стола для завершении работы виртуальной машины проверьте, правильно ли отображается на портале состояние виртуальной машины. Если это не так, завершите работу виртуальной машины на портале с помощью команды **Завершение работы** на панели мониторинга виртуальной машины.
* **Если больше четырех виртуальных машин используют одну облачную службу, настройте несколько политик резервного копирования**. Задайте время резервного копирования таким образом, чтобы оно выполнялось не более, чем на четырех виртуальных машинах одновременно. Задайте время начала архивации в разных политиках так, чтобы между ними был один час разницы.
* **Виртуальная машина использует большие ресурсы процессора или памяти**. Если виртуальная машина работает при большой загрузке памяти или процессора (более 90 %), задача создания моментального снимка помещается в очередь, задерживается. Со временем время ожидания истекает. Если эта проблема возникает, попробуйте выполнить резервное копирование по запросу.

## <a name="networking"></a>Сеть

Как и в случае со всеми другими расширениями, для нормальной работы расширению Backup требуется доступ к общедоступному Интернету. Отсутствие доступа к общедоступному Интернету может приводить к различным проблемам:

* Операция установки расширения может завершаться с ошибкой.
* Операции резервного копирования (например, создание моментального снимка диска) могут завершаться с ошибкой.
* Операция отображения состояния процесса резервного копирования может завершаться с ошибкой.

Необходимость разрешения общедоступных IP-адресов обсуждается в [этом блоге службы поддержки Azure](https://blogs.msdn.com/b/mast/archive/2014/06/18/azure-vm-provisioning-stuck-on-quot-installing-extensions-on-virtual-machine-quot.aspx). Проверьте конфигурации DNS для виртуальной сети и убедитесь, что URI Azure можно разрешить.

После правильного разрешения имен также требуется предоставить доступ к IP-адресам Azure. Чтобы разблокировать доступ к инфраструктуре Azure, выполните одно из следующих действий.

* Разрешить список диапазонов IP-адресов центра обработки данных Azure:
   1. Получите список IP- [адресов центра обработки данных Azure](https://www.microsoft.com/download/details.aspx?id=41653) , которые будут находиться в списке разрешений.
   1. Разблокируйте IP-адреса с помощью командлета [New-NetRoute](https://docs.microsoft.com/powershell/module/nettcpip/new-netroute). Запустите этот командлет на виртуальной машине Azure в окне PowerShell с повышенными привилегиями. Запустите от имени администратора.
   1. Добавьте правила в группу безопасности сети, если она настроена, для доступа к IP-адресам.
* Создание пути для прохождения трафика HTTP
   1. При наличии каких-либо ограничений сети разверните прокси-сервер HTTP для перенаправления трафика. Например, группа безопасности сети. Инструкции по развертыванию прокси-сервера HTTP см. в разделе [Установка сетевого подключения](backup-azure-arm-vms-prepare.md#establish-network-connectivity).
   1. Добавьте правила в группу безопасности сети, если она настроена, чтобы разрешить доступ к Интернету из прокси-сервера HTTP.

> [!NOTE]
> Для работы резервного копирования службы архивации на виртуальной машине IaaS DHCP должна быть включена для учетной записи гостя. Если вам нужен статический частный IP-адрес, настройте его с помощью портала Azure или PowerShell. Убедитесь, что параметр DHCP для виртуальной машины включен.
> Дополнительные сведения о том, как настроить статический IP-адрес с помощью PowerShell см. раздели:
>
> * [Добавление статического внутреннего IP-адреса для существующей виртуальной машины](../virtual-network/virtual-networks-reserved-private-ip.md#how-to-add-a-static-internal-ip-to-an-existing-vm)
> * [Изменение метода распределения для частного IP-адреса, назначенного сетевому интерфейсу](../virtual-network/virtual-networks-static-private-ip-arm-ps.md#change-the-allocation-method-for-a-private-ip-address-assigned-to-a-network-interface)
>
>
