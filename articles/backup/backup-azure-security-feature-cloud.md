---
title: Обратимое удаление для Azure Backup
description: Узнайте, как использовать функции безопасности в Azure Backup, чтобы сделать резервные копии более безопасными.
ms.topic: conceptual
ms.date: 04/30/2020
ms.openlocfilehash: 921d04c530695ee8909fb17b216029849c4fc4a2
ms.sourcegitcommit: c6b9a46404120ae44c9f3468df14403bcd6686c1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2020
ms.locfileid: "88892479"
---
# <a name="soft-delete-for-azure-backup"></a>Обратимое удаление для Azure Backup

Среди пользователей растет обеспокоенность вопросами безопасности, связанными с вредоносными программами, программами-шантажистами и вторжениями в системы. Эти угрозы могут привести к значительным расходам и потере данных. Для защиты от таких атак Azure Backup теперь предоставляет функции безопасности, помогающие защитить данные резервных копий даже после удаления.

Одной из таких функций является обратимое удаление. При обратимом удалении, даже если вредоносный субъект удаляет резервную копию (или данные резервной копии случайно удаляются), данные резервного копирования сосохранены в течение 14 дополнительных дней, что позволяет восстановить этот элемент без потери данных. Дополнительные 14 дней хранения резервных копий данных в состоянии "обратимого" удаления не несут никаких затрат.

Для этих служб доступна защита с обратимым удалением:

- [Обратимое удаление для виртуальных машин Azure](soft-delete-virtual-machines.md)
- [Обратимое удаление для SQL Server на виртуальной машине Azure и обратимое удаление для SAP HANA в рабочих нагрузках виртуальных машин Azure](soft-delete-sql-saphana-in-azure-vm.md)

На этой блок-схеме показаны различные шаги и состояния элемента резервного копирования, когда включено обратимое удаление.

![Жизненный цикл элемента резервного копирования с обратимым удалением](./media/backup-azure-security-feature-cloud/lifecycle.png)

## <a name="enabling-and-disabling-soft-delete"></a>Включение и отключение обратимого удаления

Обратимое удаление по умолчанию включено для вновь созданных хранилищ, чтобы защитить данные резервных копий от случайных или вредоносных удалений.  Отключение этой функции не рекомендуется. Единственное обстоятельство, когда следует отключать обратимое удаление, — это планирование перемещения защищенных элементов в новое хранилище и не может ждать 14 дней, необходимых перед удалением и повторной защитой (например, в тестовой среде). Только владелец хранилища может отключить эту функцию. Если отключить эту функцию, все будущие удаления защищенных элементов приведут к немедленному удалению без возможности восстановления. Резервные копии данных, которые находятся в состоянии обратимого удаления перед отключением этой функции, будут оставаться в состоянии обратимого удаления в течение 14 дней. Если вы хотите безвозвратно удалить эти данные немедленно, необходимо отменить удаление и удалить их снова, чтобы окончательно удалить их.

 Важно помнить, что после отключения обратимого удаления эта функция отключается для всех типов рабочих нагрузок, включая SQL Server и SAP HANAные рабочие нагрузки. Например, после включения [предварительной версии SQL Server/SAP HANA](./soft-delete-sql-saphana-in-azure-vm.md#steps-to-enroll-in-preview) для подписки невозможно отключить обратимое удаление только для SQL server или SAP HANA баз данных, сохраняя при этом поддержку виртуальных машин в том же хранилище. Для детального управления можно создавать отдельные хранилища.

### <a name="disabling-soft-delete-using-azure-portal"></a>Отключение обратимого удаления с помощью портал Azure

Чтобы отключить обратимое удаление, выполните следующие действия.

1. В портал Azure перейдите в хранилище, а затем выберите **Параметры**  ->  **Свойства**.
2. На панели Свойства выберите **Параметры безопасности**  ->  **Обновить**.  
3. В области Параметры безопасности в разделе **обратимое удаление**выберите **Отключить**.

![Отключение обратимого удаления](./media/backup-azure-security-feature-cloud/disable-soft-delete.png)

### <a name="disabling-soft-delete-using-azure-powershell"></a>Отключение обратимого удаления с помощью Azure PowerShell

> [!IMPORTANT]
> Версия AZ. RecoveryServices, необходимая для использования обратимого удаления с помощью Azure PowerShell, является минимальной 2.2.0. Используйте ```Install-Module -Name Az.RecoveryServices -Force``` для получения последней версии.

Чтобы отключить, используйте командлет PowerShell [Set-азрековерисервицесваултбаккуппроперти](/powershell/module/az.recoveryservices/set-azrecoveryservicesbackupproperty) .

```powershell
Set-AzRecoveryServicesVaultProperty -VaultId $myVaultID -SoftDeleteFeatureState Disable


StorageModelType       :
StorageType            :
StorageTypeState       :
EnhancedSecurityState  : Enabled
SoftDeleteFeatureState : Disabled
```

### <a name="disabling-soft-delete-using-rest-api"></a>Отключение обратимого удаления с помощью REST API

Чтобы отключить функцию обратимого удаления с помощью REST API, см. действия, описанные [здесь](use-restapi-update-vault-properties.md#update-soft-delete-state-using-rest-api).

## <a name="permanently-deleting-soft-deleted-backup-items"></a>Окончательное удаление обратимо удаленных архивных элементов

Резервное копирование данных в обратимо удаленном состоянии перед отключением этой функции будет оставаться в обратимо удаленном состоянии. Если вы хотите безвозвратно удалить эти данные немедленно, удалите их и удалите снова, чтобы окончательно удалить их.

### <a name="using-azure-portal"></a>Использование портала Azure

Выполните следующие действия:

1. Выполните действия по [отключению обратимого удаления](#enabling-and-disabling-soft-delete).

2. В портал Azure перейдите в хранилище, перейдите к **элементу Архивация**и выберите Обратимо удаленный элемент.

   ![Выбор обратимо удаленного элемента](./media/backup-azure-security-feature-cloud/vm-soft-delete.png)

3. Выберите параметр отменить **Удаление**.

   ![Выберите отменить удаление](./media/backup-azure-security-feature-cloud/choose-undelete.png)

4. Появится окно. Выберите отменить **Удаление**.

   ![Выберите отменить удаление](./media/backup-azure-security-feature-cloud/undelete-vm.png)

5. Выберите **удалить резервные копии данных** , чтобы окончательно удалить данные резервной копии.

   ![Выберите Удалить данные архивации](/azure/backup/media/backup-azure-manage-vms/delete-backup-buttom.png)

6. Введите имя элемента резервного копирования, чтобы подтвердить, что необходимо удалить точки восстановления.

   ![Введите имя элемента архивации](/azure/backup/media/backup-azure-manage-vms/delete-backup-data1.png)

7. Чтобы удалить данные архивации для элемента, выберите **Удалить**. Сообщение уведомления позволяет убедиться, что данные резервного копирования удалены.

### <a name="using-azure-powershell"></a>Использование Azure PowerShell

Если элементы были удалены до отключения обратимого удаления, они будут находиться в состоянии обратимого удаления. Чтобы немедленно удалить их, операция удаления должна быть отменена, а затем снова выполнена.

Определяет элементы, которые находятся в состоянии обратимого удаления.

```powershell

Get-AzRecoveryServicesBackupItem -BackupManagementType AzureVM -WorkloadType AzureVM -VaultId $myVaultID | Where-Object {$_.DeleteState -eq "ToBeDeleted"}

Name                                     ContainerType        ContainerUniqueName                      WorkloadType         ProtectionStatus     HealthStatus         DeleteState
----                                     -------------        -------------------                      ------------         ----------------     ------------         -----------
VM;iaasvmcontainerv2;selfhostrg;AppVM1    AzureVM             iaasvmcontainerv2;selfhostrg;AppVM1       AzureVM              Healthy              Passed               ToBeDeleted

$myBkpItem = Get-AzRecoveryServicesBackupItem -BackupManagementType AzureVM -WorkloadType AzureVM -VaultId $myVaultID -Name AppVM1
```

Затем отмените операцию удаления, которая была выполнена, когда обратимое удаление было включено.

```powershell
Undo-AzRecoveryServicesBackupItemDeletion -Item $myBKpItem -VaultId $myVaultID -Force

WorkloadName     Operation            Status               StartTime                 EndTime                   JobID
------------     ---------            ------               ---------                 -------                   -----
AppVM1           Undelete             Completed            12/5/2019 12:47:28 PM     12/5/2019 12:47:40 PM     65311982-3755-46b5-8e53-c82ea4f0d2a2
```

Так как обратимое удаление теперь отключено, операция удаления приведет к немедленному удалению данных резервного копирования.

```powershell
Disable-AzRecoveryServicesBackupProtection -Item $myBkpItem -RemoveRecoveryPoints -VaultId $myVaultID -Force

WorkloadName     Operation            Status               StartTime                 EndTime                   JobID
------------     ---------            ------               ---------                 -------                   -----
AppVM1           DeleteBackupData     Completed            12/5/2019 12:44:15 PM     12/5/2019 12:44:50 PM     0488c3c2-accc-4a91-a1e0-fba09a67d2fb
```

### <a name="using-rest-api"></a>Использование REST API

Если элементы были удалены до отключения обратимого удаления, они будут находиться в состоянии обратимого удаления. Чтобы немедленно удалить их, операция удаления должна быть отменена, а затем снова выполнена.

1. Сначала отмените операции удаления, выполнив описанные [здесь](backup-azure-arm-userestapi-backupazurevms.md#undo-the-deletion)действия.
2. Затем отключите функцию обратимого удаления с помощью REST API, выполнив описанные [здесь](use-restapi-update-vault-properties.md#update-soft-delete-state-using-rest-api)действия.
3. Затем удалите резервные копии с помощью REST API, как описано [здесь](backup-azure-arm-userestapi-backupazurevms.md#stop-protection-and-delete-data).

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="do-i-need-to-enable-the-soft-delete-feature-on-every-vault"></a>Нужно ли включать функцию обратимого удаления в каждом хранилище?

Нет, он встроен и включен по умолчанию для всех хранилищ служб восстановления.

### <a name="can-i-configure-the-number-of-days-for-which-my-data-will-be-retained-in-soft-deleted-state-after-the-delete-operation-is-complete"></a>Можно ли настроить число дней, в течение которых мои данные будут храниться в обратимо удаленном состоянии после завершения операции удаления?

Нет, после операции удаления в течение 14 дней потребуется дополнительное хранение.

### <a name="do-i-need-to-pay-the-cost-for-this-additional-14-day-retention"></a>Нужно ли платить за это дополнительное 14-дневное хранение?

Нет, за 14-дневное дополнительное хранение не взимается никаких затрат, как часть функций обратимого удаления.

### <a name="can-i-perform-a-restore-operation-when-my-data-is-in-soft-delete-state"></a>Можно ли выполнить операцию восстановления, когда данные находятся в состоянии обратимого удаления?

Нет, для восстановления необходимо отменить удаление ресурса с обратимым удалением. Операция отмены удаления переместит ресурс обратно в **состояние защита с сохранением данных** , где можно выполнить восстановление в любой момент времени. Сборщик мусора остается приостановленным в этом состоянии.

### <a name="will-my-snapshots-follow-the-same-lifecycle-as-my-recovery-points-in-the-vault"></a>Будут ли мои моментальные снимки следовать тому же жизненному циклу, что и мои точки восстановления в хранилище?

Да.

### <a name="how-can-i-trigger-the-scheduled-backups-again-for-a-soft-deleted-resource"></a>Как снова запустить запланированное резервное копирование для ресурса с обратимым удалением?

После отмены удаления, за которым следует операция возобновления, этот ресурс будет защищен повторно. Операция возобновления связывает политику резервного копирования для активации запланированных резервных копий с выбранным сроком хранения. Кроме того, сборщик мусора запускается сразу после завершения операции возобновления. Если вы хотите выполнить восстановление из точки восстановления, которая находится за предельным сроком действия, рекомендуется выполнить ее перед запуском операции возобновления.

### <a name="can-i-delete-my-vault-if-there-are-soft-deleted-items-in-the-vault"></a>Можно ли удалить хранилище, если в хранилище есть обратимо удаленные элементы?

Хранилище служб восстановления невозможно удалить, если в хранилище есть элементы резервного копирования в обратимо удаленном состоянии. Обратимо удаленные элементы окончательно удаляются через 14 дней после операции удаления. Если вы не можете подождать 14 дней, [Отключите обратимое удаление, отмените](#enabling-and-disabling-soft-delete)удаление обратимо удаленных элементов и удалите их, чтобы окончательно удалить их. Убедившись в отсутствии защищенных элементов и обратимых удаленных элементов, хранилище можно удалить.  

### <a name="can-i-delete-the-data-earlier-than-the-14-days-soft-delete-period-after-deletion"></a>Можно ли удалить данные, предшествующие 14-дневному периоду обратимого удаления после удаления?

Нет. Нельзя принудительно удалять обратимо удаленные элементы. Они автоматически удаляются через 14 дней. Эта функция безопасности включена для защиты резервных копий данных от случайных или вредоносных удалений.  Необходимо подождать 14 дней, прежде чем выполнять любые другие действия с элементом.  Обратимо удаленные элементы не будут начисляться.  Если необходимо повторно защитить элементы, помеченные для обратимого удаления, в течение 14 дней в новом хранилище, обратитесь в службу поддержки Майкрософт.

### <a name="can-soft-delete-operations-be-performed-in-powershell-or-cli"></a>Могут ли операции обратимого удаления выполняться в PowerShell или CLI?

Операции обратимого удаления можно выполнить с помощью PowerShell. В настоящее время CLI не поддерживается.

## <a name="next-steps"></a>Дальнейшие шаги

- [Общие сведения о средствах безопасности в Azure Backup](security-overview.md)
