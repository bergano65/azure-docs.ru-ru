---
title: Устранение неполадок при восстановлении файлов виртуальной машины Azure
description: Устранение неполадок при восстановлении файлов и папок из резервной копии виртуальной машины Azure.
ms.topic: troubleshooting
ms.date: 07/12/2020
ms.openlocfilehash: c4d0d233237cb477d72efea0b91d4e5288e2a302
ms.sourcegitcommit: 78ecfbc831405e8d0f932c9aafcdf59589f81978
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2021
ms.locfileid: "98735883"
---
# <a name="troubleshoot-issues-in-file-recovery-of-an-azure-vm-backup"></a>Устранение неполадок при восстановлении файлов резервной копии виртуальной машины Azure

Эта статья содержит инструкции по устранению неполадок, которые помогут устранить неполадки при восстановлении файлов и папок из резервной копии виртуальной машины Azure.

## <a name="common-error-messages"></a>Распространенные сообщения об ошибках

В этом разделе описаны действия по устранению сообщений об ошибках, которые могут появиться.

### <a name="exception-caught-while-connecting-to-target"></a>"Произошло исключение при подключении к целевому объекту"

**Возможная причина**: скрипт не может получить доступ к точке восстановления.

**Рекомендуемое действие**. чтобы устранить эту проблему, выполните действия, перечисленные в [сценарии, но подключение не удалось](#the-script-runs-but-the-connection-to-the-iscsi-target-failed).

### <a name="the-target-has-already-been-logged-in-via-an-iscsi-session"></a>"Целевой объект уже вошел в систему через сеанс iSCSI"

**Возможная причина**: сценарий уже был запущен на том же компьютере, а диски подключены.

**Рекомендуемое действие**: тома точки восстановления уже подключены. Их невозможно подключить с теми же буквами диска, что и у исходной виртуальной машины. Просмотрите доступные тома в проводнике.

### <a name="this-script-is-invalid-because-the-disks-have-been-dismounted-via-portalexceeded-the-12-hr-limit-download-a-new-script-from-the-portal"></a>"Этот скрипт является недопустимым, так как диски были отключены через портал, превышено ограничение в 12 часов. Скачать новый скрипт с портала "

**Возможная причина**: диски были отключены от портала или превышено 12-часовое предельное время.

**Рекомендуемое действие**: 12 часов после скачивания скрипта становятся недействительными и не могут быть запущены. Перейдите на портал и Скачайте новый скрипт, чтобы продолжить восстановление файлов.

### <a name="iscsi_tcp-module-cant-be-loaded-or-iscsi_tcp_module-not-found"></a>не удается загрузить модуль iscsi_tcp (или) iscsi_tcp_module не найден

**Рекомендуемое действие**. чтобы устранить эту проблему, выполните действия, описанные в разделе [Загрузка скрипта успешно, но не удается запустить](#the-script-downloads-successfully-but-fails-to-run).

## <a name="common-problems"></a>Распространенные проблемы

В этом разделе приведены шаги по устранению распространенных проблем, которые могут возникнуть при скачивании и выполнении скрипта для восстановления файлов.

### <a name="you-cant-download-the-script"></a>Невозможно скачать скрипт

1. Убедитесь, что у вас есть [необходимые разрешения для скачивания скрипта](./backup-azure-restore-files-from-vm.md#select-recovery-point-who-can-generate-script).
1. Проверьте подключение к целевому IP-адресу Azure. В командной строке с повышенными привилегиями выполните одну из следующих команд:

   `nslookup download.microsoft.com`

    или

    `ping download.microsoft.com`

### <a name="the-script-downloads-successfully-but-fails-to-run"></a>Сценарий успешно скачивается, но не запускается

При запуске скрипта Python для восстановления на уровне элементов (ILR) на SUSE Linux Enterprise Server 12 SP4 происходит сбой с ошибкой "не удается загрузить модуль iscsi_tcp" или "не найден" iscsi_tcp_module.

**Возможная причина**: модуль ILR использует **iscsi_tcp** для установления TCP-подключения к службе резервного копирования. В составе выпуска SLES 12 SP4 пакет SUSE удален **iscsi_tcp** из пакета Open-iSCSI, поэтому операция ILR завершается сбоем.

**Рекомендуемое действие**: выполнение скрипта восстановления файлов не поддерживается на виртуальных машинах SUSE 12 SP4. Попробуйте выполнить операцию восстановления в более старой версии SUSE 12 SP4.

### <a name="the-script-runs-but-the-connection-to-the-iscsi-target-failed"></a>Сценарий выполняется, но не удалось подключиться к целевому объекту iSCSI

При подключении к целевому сообщению может появиться сообщение об ошибке "исключение перехвачено.

1. Убедитесь, что компьютер, на котором выполняется сценарий, соответствует [требованиям к доступу](./backup-azure-restore-files-from-vm.md#step-4-access-requirements-to-successfully-run-the-script).
1. Проверьте подключение к целевому IP-адресу Azure. В командной строке с повышенными привилегиями выполните одну из следующих команд:

   `nslookup download.microsoft.com`

   или

   `ping download.microsoft.com`
1. Обеспечьте доступ к исходящему порту iSCSI 3260.
1. Проверьте брандмауэр или NSG блокировку трафика для целевых IP-адресов Azure или URL службы восстановления.
1. Убедитесь, что антивирусная программа не блокирует выполнение сценария.

### <a name="youre-connected-to-the-recovery-point-but-the-disks-werent-attached"></a>Вы подключены к точке восстановления, но диски не подключены

Устраните эту проблему, выполнив действия, описанные в операционной системе.

#### <a name="windows-file-recovery-fails-on-server-with-storage-pools"></a>Сбой восстановления файлов Windows на сервере с пулами носителей

При первом запуске сценария в Windows Server 2012 R2 и Windows Server 2016 (с пулами носителей) пул носителей может быть подключен к виртуальной машине только для чтения.

>[!Tip]
> Убедитесь, что у вас есть [правильный компьютер для выполнения скрипта](https://docs.microsoft.com/azure/backup/backup-azure-restore-files-from-vm#step-2-ensure-the-machine-meets-the-requirements-before-executing-the-script).

Чтобы устранить эту проблему, вручную назначьте доступ для чтения и записи пулу носителей и Подключите виртуальные диски:

1. Перейдите в **Диспетчер сервера**  >  **Файловые службы и**  >    >  **Пулы** носителей тома.

   ![Снимок экрана, показывающий параметры пулов носителей.](./media/backup-azure-restore-files-from-vm/windows-storage-1.png)

1. В окне **пул носителей** щелкните правой кнопкой мыши доступный пул носителей и выберите **задать Read-Write доступ**.

   ![Снимок экрана: параметры щелчка правой кнопкой мыши для очереди хранилища.](./media/backup-azure-restore-files-from-vm/windows-storage-read-write-2.png)

1. После назначения пулу носителей доступа для чтения и записи щелкните правой кнопкой мыши в разделе **Виртуальные диски** и выберите **Подключить виртуальный диск**.

   ![Снимок экрана, показывающий параметры щелчка правой кнопкой мыши для виртуального диска.](./media/backup-azure-restore-files-from-vm/server-manager-virtual-disk-3.png)

#### <a name="linux-file-recovery-fails-to-auto-mount-because-the-disk-doesnt-contain-volumes"></a>При восстановлении файлов Linux не удается выполнить автоматическую установку, так как диск не содержит томов

При восстановлении файлов служба архивации обнаруживает тома и автоматически подключает их. Однако если резервные диски имеют необработанные разделы, эти диски не будут подключаться и диск данных не будет подключен к восстановлению.

Чтобы устранить эту проблему, перейдите к разделу [Восстановление файлов из резервной копии виртуальной машины Azure](https://docs.microsoft.com/azure/backup/backup-azure-restore-files-from-vm#lvmraid-arrays-for-linux-vms).

#### <a name="linux-file-recovery-fails-because-the-os-couldnt-identify-the-file-system"></a>Восстановление файлов Linux завершается сбоем, так как ОС не удалось опознать файловую систему.

При запуске скрипта восстановления файлов происходит сбой подключения диска данных. Появится сообщение об ошибке "не удалось подключить следующие разделы, так как ОС не удалось определить файловую систему".

Чтобы устранить эту проблему, проверьте, зашифрован ли том с помощью приложения стороннего производителя. Если он зашифрован, диск или виртуальная машина не будут отображаться на портале как зашифрованные.

1. Войдите на виртуальную машину с резервным копированием и выполните следующую команду:

   `lsblk -f`

   ![Снимок экрана, показывающий результаты команды для вывода списка блочных устройств.](./media/backup-azure-restore-files-from-vm/disk-without-volume-5.png)

1. Проверьте файловую систему и шифрование. Если том зашифрован, восстановление файлов не поддерживается. Дополнительные сведения см. в статье [Матрица поддержки для резервного копирования виртуальных машин Azure](https://docs.microsoft.com/azure/backup/backup-support-matrix-iaas#support-for-file-level-restore).

### <a name="disks-are-attached-but-the-volumes-arent-mounted"></a>Диски подключены, но тома не подключены

Устраните эту проблему, выполнив действия, описанные в операционной системе.

#### <a name="windows"></a>Windows

При запуске скрипта восстановления файлов для Windows отображается сообщение "0 томов восстановления подключено". Однако диски обнаруживаются в консоли управления дисками.

**Возможная причина**: при подключении томов через iSCSI некоторые обнаруженные тома находятся в автономном режиме. Когда канал iSCSI обменивается данными между виртуальной машиной и службой, он обнаруживает эти тома и переводит их в режим «в сети», но не монтирует их.

   ![Снимок экрана с подключенными томами восстановления (0).](./media/backup-azure-restore-files-from-vm/disk-not-attached-6.png)

Чтобы определить и устранить эту проблему, выполните следующие действия.

>[!Tip]
>Убедитесь, что у вас есть [правильный компьютер для выполнения скрипта](https://docs.microsoft.com/azure/backup/backup-azure-restore-files-from-vm#step-2-ensure-the-machine-meets-the-requirements-before-executing-the-script).

1. В окне **cmd** запустите **diskmgmt** , чтобы открыть **оснастку "Управление дисками**".
1. Найдите дополнительные диски. В следующем примере **диск 2** является дополнительным диском.

   ![Снимок экрана: окно управления дисками с дополнительным диском.](./media/backup-azure-restore-files-from-vm/disk-management-7.png)

1. Щелкните правой кнопкой мыши элемент **создать том**, а затем выберите команду **изменить букву диска и пути**.

   ![Снимок экрана, показывающий параметры щелчка правой кнопкой мыши на дополнительном диске.](./media/backup-azure-restore-files-from-vm/disk-management-8.png)

1. В окне **изменить букву диска или путь** выберите **назначить следующую букву диска**, назначить доступный диск, а затем нажмите кнопку **ОК**.

   ![Снимок экрана: окно "изменить букву диска" или "путь".](./media/backup-azure-restore-files-from-vm/disk-management-9.png)

1. Откройте проводник, чтобы просмотреть выбранный диск и просмотреть файлы.

#### <a name="linux"></a>Linux

>[!Tip]
>Убедитесь, что у вас есть [правильный компьютер для выполнения скрипта](https://docs.microsoft.com/azure/backup/backup-azure-restore-files-from-vm#step-2-ensure-the-machine-meets-the-requirements-before-executing-the-script).

Если защищенная виртуальная машина Linux использует массивы LVM или RAID, выполните действия, описанные в статье [Восстановление файлов из резервной копии виртуальной машины Azure](https://docs.microsoft.com/azure/backup/backup-azure-restore-files-from-vm#lvmraid-arrays-for-linux-vms).

### <a name="you-cant-copy-the-files-from-mounted-volumes"></a>Невозможно скопировать файлы из подключенных томов

Копирование может завершиться ошибкой "0x80070780: файл недоступен для системы". 

Проверьте, включена ли Дедупликация дисков на исходном сервере. Если это так, убедитесь, что на сервере восстановления также включено Дедупликация на дисках. Вы можете оставить дедупликацию ненастроенной, чтобы не дублировать диски на сервере восстановления.

## <a name="next-steps"></a>Следующие шаги

- [Восстановление файлов и папок из резервной копии виртуальной машины Azure](backup-azure-restore-files-from-vm.md)