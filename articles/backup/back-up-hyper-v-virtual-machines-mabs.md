---
title: Резервное копирование виртуальных машин Hyper-V с помощью MABS
description: Эта статья содержит процедуры резервного копирования и восстановления виртуальных машин с помощью Microsoft Azure Backup Server (MABS).
ms.topic: conceptual
ms.date: 07/18/2019
ms.openlocfilehash: fc4e34e11e2474521082b1c23f600e9a5ca7a9fe
ms.sourcegitcommit: 3246e278d094f0ae435c2393ebf278914ec7b97b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/02/2020
ms.locfileid: "89378004"
---
# <a name="back-up-hyper-v-virtual-machines-with-azure-backup-server"></a>Резервное копирование виртуальных машин Hyper-V с помощью Azure Backup Server

В этой статье объясняется, как выполнять резервное копирование виртуальных машин Hyper-V с помощью Microsoft Azure Backup Server (MABS).

## <a name="supported-scenarios"></a>Поддерживаемые сценарии

MABS может выполнять резервное копирование виртуальных машин, работающих на серверах узлов Hyper-V, в следующих сценариях:

- **Виртуальные машины с локальным или прямо подключенным хранилищем** — резервное копирование виртуальных машин, размещенных на отдельных серверах Hyper-V с локальным или непосредственно подключенным хранилищем. Например: жесткий диск, устройство сети хранения данных (SAN) или устройство хранения данных, подключенное к сети (NAS). Агент защиты MABS должен быть установлен на всех узлах.

- **Виртуальные машины в кластере с хранилищем CSV** — резервное копирование виртуальных машин, размещенных в кластере Hyper-V, с хранилищем общих томов кластера (CSV). Агент защиты MABS устанавливается на каждом узле кластера.

## <a name="host-versus-guest-backup"></a>Размещение и гостевая резервная копия

MABS может выполнять резервное копирование виртуальных машин Hyper-V на уровне узла или гостя. На уровне узла агент защиты MABS устанавливается на сервере узла Hyper-V или в кластере и защищает все виртуальные машины и файлы данных, работающие на этом узле.   На уровне гостя агент устанавливается на каждой виртуальной машине и защищает рабочую нагрузку, которая находится на этом компьютере.

Оба способа имеют свои преимущества и недостатки.

- Резервные копии на уровне узла являются гибкими, так как они работают независимо от типа операционной системы, работающей на гостевых машинах, и не требует установки агента защиты MABS на каждой виртуальной машине. При развертывании резервной копии на уровне узла можно восстановить всю виртуальную машину или файлы и папки (восстановление на уровне элементов).

- Резервное копирование на уровне гостя полезно, если требуется защитить определенные рабочие нагрузки, работающие на виртуальной машине. На уровне узла можно восстановить всю виртуальную машину или определенные файлы, но она не будет предоставлять восстановление в контексте конкретного приложения. Например, чтобы восстановить определенные элементы SharePoint из резервной виртуальной машины, необходимо выполнить резервное копирование этой виртуальной машины на уровне гостя. Используйте резервное копирование на гостевом уровне, если хотите защитить данные, хранящиеся на транзитных дисках. Транзит позволяет виртуальной машине напрямую обращаться к устройству хранения и не хранить данные виртуального тома в VHD-файле.

## <a name="how-the-backup-process-works"></a>Принцип работы процесса резервного копирования

MABS выполняет резервное копирование с помощью VSS следующим образом. Шаги в этом описании нумеруются для ясности.

1. Модуль синхронизации на основе блоков MABS создает начальную копию защищенной виртуальной машины и гарантирует, что копия виртуальной машины будет завершена и целостна.

2. После внесения и проверки начальной копии MABS использует модуль записи VSS Hyper-V для записи резервных копий. Модуль записи VSS предоставляет набор дисковых блоков, совместимых с данными, которые синхронизируются с сервером MABS. Такой подход обеспечивает преимущество полного резервного копирования на сервере MABS, одновременно сокращая объем данных резервных копий, которые должны передаваться по сети.

3. Агент защиты MABS на сервере под управлением Hyper-V использует существующие API Hyper-V для определения того, поддерживает ли Защищенная виртуальная машина VSS.

   - Если виртуальная машина соответствует требованиям к оперативной архивации и на ней установлены службы интеграции Hyper-V, модуль записи VSS Hyper-V рекурсивно перенаправляет запрос VSS ко всем процессам, поддерживающим VSS, в виртуальной машине. Эта операция выполняется без установки агента защиты MABS на виртуальной машине. Благодаря рекурсивному запросу VSS модуль записи VSS Hyper-V обеспечивает синхронизацию операций записи на диск, поэтому запись моментального снимка VSS происходит без потери данных.

     Компонент служб интеграции Hyper-V вызывает модуль записи VSS в службах VSS на виртуальных машинах, чтобы убедиться, что их данные приложений находятся в согласованном состоянии.

   - Если виртуальная машина не соответствует требованиям оперативного резервного копирования, MABS автоматически использует API Hyper-V для приостановки виртуальной машины перед записью файлов данных.

4. После синхронизации исходной базовой копии виртуальной машины с сервером MABS все изменения, внесенные в ресурсы виртуальной машины, фиксируются в новой точке восстановления. Точка восстановления представляет согласованное состояние виртуальной машины в конкретный момент времени. Записи точки восстановления могут происходить как минимум один раз в день. При создании новой точки восстановления MABS использует репликацию на уровне блоков в сочетании с модулем записи VSS Hyper-V, чтобы определить, какие блоки были изменены на сервере, на котором выполняется Hyper-V после создания последней точки восстановления. Затем эти блоки данных передаются на сервер MABS и применяются к реплике защищенных данных.

5. Сервер MABS использует VSS на томах, на которых размещены данные восстановления, чтобы было доступно несколько теневых копий. Каждая из этих теневых копий предоставляет отдельный процесс восстановления. Точки восстановления VSS хранятся на сервере MABS. Временная копия, созданная на сервере с Hyper-V, хранится только в течение синхронизации MABS.

>[!NOTE]
>
>Начиная с Windows Server 2016, виртуальные жесткие диски Hyper-V имеют встроенное отслеживание изменений, известное как устойчивое отслеживание изменений (RCT). MABS использует RCT (собственное отслеживание изменений в Hyper-V), что снижает потребность в длительных проверках согласованности в таких сценариях, как сбои виртуальной машины. RCT обеспечивает лучшую устойчивость, чем функция отслеживания изменений, предоставляемая резервными копиями на основе моментального снимка VSS. MABS V3 оптимизирует использование ресурсов сети и хранилища, передавая только измененные данные во время каких-либо проверок согласованности.

## <a name="backup-prerequisites"></a>Необходимые компоненты для резервного копирования

Ниже приведены предварительные требования для резервного копирования виртуальных машин Hyper-V с помощью MABS.

|Предварительное требование|Сведения|
|------------|-------|
|Предварительные требования для MABS|— Если вы хотите выполнить восстановление на уровне элементов для виртуальных машин (восстановление файлов, папок, томов), необходимо установить роль Hyper-V на сервере MABS.  Если вы хотите восстановить только виртуальную машину, а не уровень элемента, роль не требуется.<br />— Вы можете защитить до 800 виртуальных машин размером 100 ГБ на одном сервере MABS и разрешить несколько серверов MABS, поддерживающих кластеры большего размера.<br />-MABS исключает файл подкачки из добавочных резервных копий для повышения производительности резервного копирования виртуальных машин.<br />-MABS может выполнять резервное копирование сервера или кластера Hyper-V в том же домене, что и сервер MABS, или в дочернем или доверенном домене. Если требуется выполнить резервное копирование Hyper-V в Рабочей группе или недоверенном домене, необходимо настроить проверку подлинности. Для одного сервера Hyper-V можно использовать NTLM или проверку подлинности на основе сертификата. Для кластера можно использовать только проверку подлинности на сертификат.<br />— Резервное копирование данных виртуальной машины на транзитные диски на уровне узла не поддерживается. В этом сценарии мы рекомендуем использовать резервное копирование на уровне узла для резервного копирования VHD-файлов и резервных копий на гостевом компьютере, чтобы создать резервные копии других данных, которые не видны на узле.<br />   — Можно выполнять резервное копирование виртуальных машин, хранящихся на дисках с дедупликацией.|
|Необходимые компоненты для виртуальных машин Hyper-V|— Версия интеграционных компонентов, работающих на виртуальной машине, должна совпадать с версией узла Hyper-V. <br />— Для создания резервной копии каждой виртуальной машины вам потребуется свободное пространство на томе, где расположены файлы виртуального жесткого диска, чтобы во время резервного копирования у Hyper-V было достаточно места для разностных дисков (AVHD). Это пространство должно быть как минимум равно объему, рассчитанному по формуле **начальный размер диска\*коэффициент изменения\*временное окно резервного копирования**. При выполнении нескольких операций резервного копирования в кластере вам потребуется столько места, сколько требуется суммарно для разностных дисков всех виртуальных машин из расчета по указанной формуле.<br />— Для резервного копирования виртуальных машин, расположенных на серверах узлов Hyper-V под управлением Windows Server 2012 R2, на виртуальной машине должен быть указан контроллер SCSI, даже если он не подключен ни к чему. (В Windows Server 2012 R2 оперативная архивация узел Hyper-V подключает новый виртуальный жесткий диск к виртуальной машине, а затем размонтирует его. Это поддерживается только контроллером SCSI, поэтому он необходим для оперативного резервного копирования виртуальной машины.  Без этого параметра при попытке резервного копирования виртуальной машины будет выдано событие с ИДЕНТИФИКАТОРом 10103.)|
|Предварительные условия (и необходимые компоненты) для Linux|— Вы можете выполнять резервное копирование виртуальных машин Linux с помощью MABS. Поддерживаются только моментальные снимки с файловой согласованностью.|
|Резервное копирование виртуальных машин с хранилищем CSV|— Для хранилища CSV установите аппаратный поставщик служб теневого копирования томов (VSS) на сервере Hyper-V. Свяжитесь с вашим поставщиком сети хранения данных (SAN) по поводу аппаратного поставщика VSS.<br />— Если один узел неожиданно завершает работу в кластере CSV, MABS выполняет проверку согласованности для виртуальных машин, запущенных на этом узле.<br />— Если сервер Hyper-V с включенным шифрованием диска BitLocker в кластере CSV необходимо перезагрузить, потребуется выполнить проверку согласованности для виртуальных машин Hyper-V.|
|Резервное копирование виртуальных машин с хранилищем SMB|— Включите автоматическое подключение на сервере, на котором работает Hyper-V, чтобы включить защиту виртуальных машин.<br />   — Отключите разгрузку TCP Chimney.<br />— Все учетные записи machine$ Hyper-V должны иметь полные права доступа к определенным удаленным общим файловым ресурсам SMB.<br />— Убедитесь, что путь к файлу для всех компонентов виртуальной машины во время восстановления в альтернативное расположение меньше 260 символов. В противном случае восстановление может быть продолжено, но Hyper-V не сможет подключить виртуальную машину.<br />— Следующие сценарии не поддерживаются:<br />     Развертывания, в которых некоторые компоненты виртуальной машины находятся на локальных томах и некоторые компоненты находятся на удаленных томах; адрес IPv4 или IPv6 для расположения файлового сервера хранилища и восстановление виртуальной машины на компьютер, использующий удаленные общие ресурсы SMB.<br />— Необходимо включить службу агента VSS файлового сервера на каждом сервере SMB. Добавьте ее в меню **Добавление ролей и компонентов**  >  **Выбор ролей сервера**  >  **файлы и службы хранилища**  >  **файловые**службы файловая  >  **Служба**  >  **Служба агента VSS файлового сервера**.|

## <a name="back-up-virtual-machines"></a>Резервное копирование виртуальных машин

1. Настройте [сервер MABS](backup-azure-microsoft-azure-backup.md) и [хранилище](backup-mabs-add-storage.md). При настройке хранилища используйте следующие рекомендации по выделению емкости хранилища.
   - Средний размер виртуальной машины — 100 ГБ
   - Число виртуальных машин на сервер MABS — 800
   - Общий размер 800 виртуальных машин — 80 ТБ
   - Объем необходимого пространства для хранения резервных копий — 80 ТБ

2. Настройте агент защиты MABS на сервере Hyper-V или узлах кластера Hyper-V. Если вы выполняете резервное копирование на гостевом уровне, агент устанавливается на виртуальных машинах, на которых вы хотите создать резервную копию на гостевом уровне.

3. В консоли администратора MABS выберите **Защита**  >  **создать группу защиты** , чтобы открыть мастер **создания новой группы защиты** .

4. На странице **Выбор элементов группы** выберите виртуальные машины, для которых необходимо обеспечить защиту, на серверах узлов Hyper-V, где они размещаются. Рекомендуется поместить все виртуальные машины, для которых задана одна политика защиты, в одну группу защиты. Для эффективного использования пространства можно включить совместное размещение. Совместное размещение позволяет размещать данные из разных групп защиты на одном диске или ленточном накопителе, с тем чтобы нескольким источникам данных был назначен один том реплики и точки восстановления.

5. На странице **Выбор метода защиты данных** укажите имя группы защиты. Выберите параметры **Краткосрочная защита с использованием диска** и **Мне нужна оперативная защита** , чтобы выполнить резервное копирование данных в Azure с помощью службы архивации Azure.

6. В области **Укажите краткосрочные цели**  >  **диапазон хранения**укажите, как долго требуется хранить данные на диске. В поле **периодичность синхронизации**укажите, как часто должны выполняться добавочные резервные копии данных. Вместо выбора интервала для добавочных резервных копий можно выбрать параметр **Непосредственно перед точкой восстановления**. Если этот параметр включен, MABS будет выполнять быструю полную архивацию непосредственно перед каждой запланированной точкой восстановления.

    > [!NOTE]
    >
    >Если вы защищаете рабочие нагрузки приложения, точки восстановления создаются в соответствии с частотой синхронизации (если приложение поддерживает добавочное резервное копирование). В противном случае MABS выполняет быструю полную архивацию вместо добавочного резервного копирования и создает точки восстановления в соответствии с расписанием быстрой архивации.

7. На странице **Проверка выделения места на диске** проверьте пространство на диске пула носителей, выделенное для этой группы защиты.

   **Общий размер данных** обозначает объем данных, для которых вы будете создать резервную копию, а в разделе **Дисковое пространство, которое нужно подготовить в MABS** указывается рекомендуемое пространство для группы защиты. MABS выбирает идеальный том резервного копирования на основе параметров. Однако вы можете изменить выбор тома для резервного копирования в разделе **Сведения о выделении места на диске**. Для рабочих нагрузок выберите предпочтительное хранилище в раскрывающемся меню. Вы можете изменить значения для параметров **Общий объем** и **Доступный объем** в области **Доступный объем на диске**. Неподготовленное пространство — это объем хранилища, который MABS рекомендует добавить в том, чтобы обеспечить беспроблемное резервное копирование.

8. На странице **Выбор метода создания реплики** определите, каким образом будет выполняться начальная репликация данных в группе защиты. При выборе **автоматической репликации по сети**рекомендуется выбрать время непиковой нагрузки. Для больших объемов данных или менее оптимальных условий сети рассмотрите возможность выбора **вручную**, что требует репликации данных в автономном режиме с помощью съемного носителя.

9. На странице **Параметры проверки согласованности** выберите способ автоматизации проверки согласованности. Проверку можно выполнять, когда данные реплики становятся несогласованными или по расписанию. Если вы не хотите настраивать автоматическую проверку согласованности, ее можно выполнить вручную в любое время, щелкнув правой кнопкой мыши группу защиты и выбрав команду **Выполнить проверку согласованности**.

    После создания группы защиты осуществляется начальная репликация данных в соответствии с выбранным вами способом. После начальной репликации каждая операция резервного копирования выполняется в соответствии с параметрами группы защиты. Если необходимо восстановить резервные копии данных, обратите внимание на следующее:

## <a name="back-up-replica-virtual-machines"></a>Резервное копирование реплик виртуальных машин

Если MABS работает на Windows Server 2012 R2 или более поздней версии, можно выполнить резервное копирование реплик виртуальных машин. Это может быть удобно по ряду причин.

**Уменьшение влияния резервного копирования на выполняющуюся рабочую нагрузку**. Создание резервной копии виртуальной машины влечет за собой дополнительные издержки, поскольку создается моментальный снимок. Путем разгрузки процесса резервного копирования на дополнительный удаленный сайт выполнение рабочей нагрузки больше не затрагивается операцией резервного копирования. Это применимо только к развертываниям, в которых резервная копия хранится в удаленном расположении. Например, можно выполнять ежедневное резервное копирование и хранить данные локально, чтобы затем быстро восстанавливать нужные объекты, и ежемесячно или ежеквартально создавать резервные копии из хранящихся удаленно виртуальных машин реплик, чтобы обеспечить долгосрочную защиту.

**Экономия пропускной способности**. В стандартном удаленном развертывании офиса филиала или головного офиса вам потребуется выделить соответствующий объем пропускной способности, необходимый для передачи резервных копий данных между расположениями. При разработке стратегии репликации и отработки отказа в дополнение к стратегии резервного копирования данных можно сократить объем избыточных данных, передаваемых по сети. Резервное копирование данных виртуальной машины реплики, а не первичной, позволяет сэкономить издержки на отправку резервных копий данных по сети.

**Резервное копирование в среде поставщика услуг размещения**. Размещенный центр обработки данных можно использовать как расположение реплики: в этом случае нет необходимости в дополнительном центре обработки данных. В этом случае для соглашения об уровне обслуживания поставщика услуг размещения требуется соответствующая резервная копия виртуальных машин реплики.

До запуска отработки отказа реплика виртуальной машины находится в отключенном состоянии, и модуль VSS не может гарантировать выполнение резервного копирования с учетом используемых приложений. Поэтому резервная копия виртуальной машины реплики будет считаться только отказоустойчивой. Если отказоустойчивость не может быть гарантирована, резервное копирование завершится ошибкой. Это может случаться по ряду причин.

- Реплика виртуальной машины неисправна и находится в критическом состоянии.

- Выполняется повторная синхронизация реплики виртуальной машины (в состоянии "Выполняется повторная синхронизация" или "Требуется повторная синхронизация").

- Начальная репликация между основным и дополнительным сайтом находится в процессе выполнения или ожидает виртуальную машину.

- журналы. HRL применяются к виртуальной машине реплики, или предыдущее действие по применению журналов. HRL на виртуальном диске завершилось сбоем или было отменено или прервано.

- Выполняется миграция или отработка отказа реплики виртуальной машины.

## <a name="recover-backed-up-virtual-machines"></a>Восстановление из резервной копии виртуальных машин

При восстановлении резервной копии виртуальной машины для выбора виртуальной машины и конкретной точки восстановления используется мастер восстановления. Чтобы открыть мастер восстановления и восстановить виртуальную машину, выполните следующие действия.

1. В консоли администратора MABS введите имя виртуальной машины или раскройте список защищенных элементов и выберите виртуальную машину, которую необходимо восстановить.

2. В области **точки восстановления для** в календаре выберите любую дату, чтобы просмотреть доступные точки восстановления. Затем в области **Путь** выберите точку восстановления, которая будет использоваться в мастере восстановления.

3. В меню **действия** выберите команду **восстановить** , чтобы открыть мастер восстановления.

    Выбранная виртуальная машина и точка восстановления будут выведены в разделе **Просмотр выбора для восстановления**. Выберите **Далее**.

4. На экране **Выбор типа восстановления** выберите место, куда нужно восстановить данные, а затем нажмите кнопку **Далее**.

    - **Восстановить в исходном экземпляре**. При восстановлении в исходном экземпляре исходный VHD-файл удаляется. MABS восстанавливает VHD и другие файлы конфигурации в исходное расположение с помощью модуля записи VSS Hyper-V. По окончании процесса восстановления виртуальные машины по-прежнему имеют высокую доступность.
        Для восстановления группа ресурсов должна существовать. Если группа ресурсов недоступна, восстановите виртуальную машину в другом расположении, а затем сделайте ее высокодоступной.

    - **Восстановить как виртуальную машину на любой узел**: MABS поддерживает восстановление по альтернативному расположению (ALR), которое обеспечивает простое восстановление защищенной виртуальной машины Hyper-v на другой узел Hyper-v, независимо от архитектуры процессора. Виртуальные машины Hyper-V, восстановленные на узле кластера, не будут высоким уровнем доступности. Если выбран этот параметр, мастер восстановления выводит дополнительную страницу для определения места назначения и пути к нему.

    - **Копировать в сетевую папку**: MABS поддерживает восстановление на уровне элементов (ILR), что позволяет выполнять восстановление файлов, папок, томов и виртуальных жестких дисков на уровне элементов из резервной копии на уровне узла виртуальных машин Hyper-V в сетевую папку или том на защищенном сервере MABS. Для выполнения восстановления на уровне элементов не обязательно устанавливать агент защиты MABS в гостевой системе. Если выбран этот параметр, мастер восстановления выводит дополнительную страницу для определения места назначения и пути к нему.

5. В поле **Укажите параметры восстановления** настройте параметры восстановления и нажмите кнопку **Далее**.

    - Если вы восстанавливаете виртуальную машину с низкой пропускной способностью, выберите **изменить** , чтобы включить **регулирование использования полосы пропускания сети**. После включения функции регулирования полосы пропускания можно указать необходимый объем пропускной способности и время, когда будет доступна такая пропускная способность.
    - Выберите **включить восстановление на основе SAN с помощью моментальных снимков оборудования** , если вы настроили сеть.
    - Выберите **Отправить по электронной почте сообщение о завершении этого восстановления**, а затем укажите адреса электронной почты, если требуется задать отправку уведомлений после завершения процесса восстановления.

6. На странице "Сводка" убедитесь, что все сведения верны. Если сведения неверны или вы хотите внести изменения, нажмите кнопку **назад**. Если вы удовлетворены параметрами, нажмите кнопку **восстановить** , чтобы начать процесс восстановления.

7. На странице **Состояния восстановления** содержатся сведения о задании восстановления.

## <a name="next-steps"></a>Дальнейшие действия

[Восстановление данных с сервера Azure Backup Server](./backup-azure-alternate-dpm-server.md)
