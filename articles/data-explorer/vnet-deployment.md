---
title: Развертывание обозреватель данных Azure в виртуальной сети (Предварительная версия)
description: Узнайте, как развернуть обозреватель данных Azure в виртуальной сети.
author: basaba
ms.author: basaba
ms.reviewer: orspodek
ms.service: data-explorer
ms.topic: conceptual
ms.date: 10/31/2019
ms.openlocfilehash: 28b9c55df8cd7883e05e964b8b67e08c7a3eb8c1
ms.sourcegitcommit: 6c01e4f82e19f9e423c3aaeaf801a29a517e97a0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/04/2019
ms.locfileid: "74812730"
---
# <a name="deploy-azure-data-explorer-into-your-virtual-network-preview"></a>Развертывание обозреватель данных Azure в виртуальной сети (Предварительная версия)

В этой статье объясняются ресурсы, которые имеются при развертывании кластера Azure обозреватель данных в настраиваемой виртуальной сети Azure. Эта информация поможет вам развернуть кластер в подсети виртуальной сети (VNet). Дополнительные сведения о виртуальных сетях Azure см. в статье [что такое виртуальная сеть Azure?](/azure/virtual-network/virtual-networks-overview)

   ![Схема виртуальной сети](media/vnet-deployment/vnet-diagram.png)

Azure обозреватель данных поддерживает развертывание кластера в подсети в виртуальной сети (VNet). Эта возможность позволяет выполнять следующие задачи:

* Примените правила [группы безопасности сети](/azure/virtual-network/security-overview) (NSG) к трафику кластера Azure обозреватель данных.
* Подключите локальную сеть к подсети кластера Azure обозреватель данных.
* Обеспечьте безопасность источников подключения к данным ([концентратора событий](/azure/event-hubs/event-hubs-about) и [Сетка событий](/azure/event-grid/overview)) с [конечными точками службы](/azure/virtual-network/virtual-network-service-endpoints-overview).

> [!NOTE]
> Интеграция и развертывание виртуальной сети находятся в режиме предварительного просмотра. Чтобы включить эту функцию, откройте запрос в [службу поддержки](https://ms.portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview).

## <a name="access-your-azure-data-explorer-cluster-in-your-vnet"></a>Доступ к кластеру Azure обозреватель данных в виртуальной сети

Вы можете получить доступ к кластеру Azure обозреватель данных с помощью следующих IP-адресов для каждой службы (механизма и служб управления данными):

* **Частный IP-адрес**: используется для доступа к кластеру в виртуальной сети.
* **Общедоступный IP-адрес**. используется для доступа к кластеру извне виртуальной сети для управления и мониторинга, а также в качестве исходного адреса для исходящих подключений, запущенных из кластера.

Для доступа к службе создаются следующие записи DNS: 

* `[clustername].[geo-region].kusto.windows.net` (Engine) `ingest-[clustername].[geo-region].kusto.windows.net` (Управление данными) сопоставляются с общедоступным IP-адресом для каждой службы. 

* `private-[clustername].[geo-region].kusto.windows.net` (Engine) `private-ingest-[clustername].[geo-region].kusto.windows.net` (Управление данными) сопоставляются с частным IP-адресом для каждой службы.

## <a name="plan-subnet-size-in-your-vnet"></a>Планирование размера подсети в виртуальной сети

Размер подсети, используемой для размещения кластера Azure обозреватель данных, нельзя изменить после развертывания подсети. В виртуальной сети Azure обозреватель данных использует один частный IP-адрес для каждой виртуальной машины и два частных IP-адреса для внутренних подсистем балансировки нагрузки (механизм и управление данными). Сеть Azure также использует пять IP-адресов для каждой подсети. Azure обозреватель данных подготавливает две виртуальные машины для службы управления данными. Виртуальные машины службы ядра подготавливаются к масштабированию конфигурации на уровне пользователя.

Общее число IP-адресов:

| Использование | Число адресов |
| --- | --- |
| Служба ядра | 1 на экземпляр |
| Служба управления данными | 2 |
| Внутренние подсистемы балансировки нагрузки | 2 |
| Зарезервированные адреса Azure | 5 |
| **Всего** | **#engine_instances + 9** |

> [!IMPORTANT]
> Размер подсети должен быть заранее запланирован, так как он не может быть изменен после развертывания Azure обозреватель данных. Поэтому необходимо соответствующим образом зарезервировать необходимый размер подсети.

## <a name="service-endpoints-for-connecting-to-azure-data-explorer"></a>Конечные точки службы для подключения к Azure обозреватель данных

[Конечные точки службы Azure](/azure/virtual-network/virtual-network-service-endpoints-overview) позволяют защищать ресурсы нескольких клиентов Azure в виртуальной сети.
Развертывание кластера обозреватель данных Azure в подсети позволяет настроить подключения к данным с помощью [концентратора событий](/azure/event-hubs/event-hubs-about) или службы " [Сетка событий](/azure/event-grid/overview) " при ограничении базовых ресурсов для подсети Azure обозреватель данных.

> [!NOTE]
> При использовании программы установки EventGrid с [хранилищем](/azure/storage/common/storage-introduction) и [концентратором событий] учетная запись хранения, используемая в подписке, может быть заблокирована с конечными точками службы в подсети Azure обозреватель данных и разрешать Доверенные службы платформы Azure в [конфигурации брандмауэра](/azure/storage/common/storage-network-security), но концентратор событий не может включить конечную точку службы, так как она не поддерживает доверенные [службы платформы Azure](/azure/event-hubs/event-hubs-service-endpoints).

## <a name="dependencies-for-vnet-deployment"></a>Зависимости для развертывания виртуальной сети

### <a name="network-security-groups-configuration"></a>Конфигурация групп безопасности сети

[Группы безопасности сети (NSG)](/azure/virtual-network/security-overview) обеспечивают возможность управления доступом к сети в виртуальной сети. Доступ к обозреватель данных Azure можно получить с помощью двух конечных точек: HTTPs (443) и TDS (1433). Следующие правила NSG должны быть настроены таким образом, чтобы разрешить доступ к этим конечным точкам для управления, мониторинга и правильной работы кластера.

#### <a name="inbound-nsg-configuration"></a>Конфигурация входящей NSG

| **Использование**   | **from**   | **To**   | **Протокол**   |
| --- | --- | --- | --- |
| Управление  |[ADX Management Addresses](#azure-data-explorer-management-ip-addresses)/Азуредатаексплорерманажемент (сервицетаг) | Подсеть ADX: 443  | TCP  |
| Наблюдение за работоспособностью системы  | [Адреса мониторинга работоспособности ADX](#health-monitoring-addresses)  | Подсеть ADX: 443  | TCP  |
| Внутренняя связь ADX  | Подсеть ADX: все порты  | Подсеть ADX: все порты  | Все  |
| Разрешить входящий трафик балансировщика нагрузки Azure (проба работоспособности)  | AzureLoadBalancer  | Подсеть ADX: 80443  | TCP  |

#### <a name="outbound-nsg-configuration"></a>Исходящая конфигурация NSG

| **Использование**   | **from**   | **To**   | **Протокол**   |
| --- | --- | --- | --- |
| Зависимость от службы хранилища Azure  | Подсеть ADX  | Хранилище: 443  | TCP  |
| Зависимость от Azure Data Lake  | Подсеть ADX  | AzureDataLake: 443  | TCP  |
| Получение EventHub и мониторинг службы  | Подсеть ADX  | EventHub: 443, 5671  | TCP  |
| Опубликовать метрики  | Подсеть ADX  | Азуремонитор: 443 | TCP  |
| Загрузка конфигурации Azure Monitor  | Подсеть ADX  | [Адреса конечных точек конфигурации Azure Monitor](#azure-monitor-configuration-endpoint-addresses): 443 | TCP  |
| Active Directory (если применимо) | Подсеть ADX | AzureActiveDirectory: 443 | TCP |
| Центр сертификации | Подсеть ADX | Интернет: 80 | TCP |
| Взаимодействие изнутри  | Подсеть ADX  | Подсеть ADX: все порты  | Все  |
| Порты, используемые для подключаемых модулей `sql\_request` и `http\_request`  | Подсеть ADX  | Интернет: настраиваемый  | TCP  |

### <a name="relevant-ip-addresses"></a>Соответствующие IP-адреса

#### <a name="azure-data-explorer-management-ip-addresses"></a>IP-адреса управления обозреватель данных Azure

| Регион | Адреса |
| --- | --- |
| Центральная Австралия | 20.37.26.134 |
| Central2 Австралия | 20.39.99.177 |
| Восточная Австралия | 40.82.217.84 |
| Юго-Восточная Австралия | 20.40.161.39 |
| бразилсаус | 191.233.25.183 |
| Центральная Канада | 40.82.188.208 |
| Восточная Канада | 40.80.255.12 |
| Центральная Индия | 40.81.249.251 |
| Центральная часть США | 40.67.188.68 |
| Центральная часть США (EUAP) | 40.89.56.69 |
| Восточная Азия | 20.189.74.103 |
| Восточная часть США | 52.224.146.56 |
| Восток США 2 | 52.232.230.201 |
| Восточная США 2 (EUAP) | 52.253.226.110 |
| Центральная Франция | 40.66.57.91 |
| Южная Франция | 40.82.236.24 |
| Восточная Япония | 20.43.89.90 |
| Западная Япония | 40.81.184.86 |
| Республика Корея, центральный регион | 40.82.156.149 |
| Республика Корея, южный регион | 40.80.234.9 |
| Центрально-северная часть США | 40.81.45.254 |
| Северная Европа | 52.142.91.221 |
| Северная часть ЮАР | 102.133.129.138 |
| Западная часть ЮАР | 102.133.0.97 |
| Центрально-южная часть США | 20.45.3.60 |
| Юго-Восточная Азия | 40.119.203.252 |
| Южная Индия | 40.81.72.110 |
| Южная часть Соединенного Королевства | 40.81.154.254 |
| Западная часть Соединенного Королевства | 40.81.122.39 |
| Центрально-западная часть США | 52.159.55.120 |
| Западная Европа | 51.145.176.215 |
| Западная Индия | 40.81.88.112 |
| Западная часть США | 13.64.38.225 |
| Западная часть США 2 | 40.90.219.23 |

#### <a name="health-monitoring-addresses"></a>Адреса мониторинга работоспособности

| Регион | Адреса |
| --- | --- |
| Центральная Австралия | 191.239.64.128 |
| Центральная Австралия 2 | 191.239.64.128 |
| Восточная Австралия | 191.239.64.128 |
| Юго-Восточная Австралия | 191.239.160.47 |
| Южная часть Бразилии | 23.98.145.105 |
| Центральная Канада | 168.61.212.201 |
| Восточная Канада | 168.61.212.201 |
| Центральная Индия | 23.99.5.162 |
| Центральная часть США | 168.61.212.201 |
| Центральная часть США (EUAP) | 168.61.212.201 |
| Восточная Азия | 168.63.212.33 |
| Восточная часть США | 137.116.81.189 |
| Восточная часть США 2 | 137.116.81.189 |
| Восточная часть США 2 (EUAP) | 137.116.81.189 |
| Центральная Франция | 23.97.212.5 |
| Южная Франция | 23.97.212.5 |
| Восточная Япония | 138.91.19.129 |
| Западная Япония | 138.91.19.129 |
| Республика Корея, центральный регион | 138.91.19.129 |
| Республика Корея, южный регион | 138.91.19.129 |
| Центрально-северная часть США | 23.96.212.108 |
| Северная Европа | 191.235.212.69 
| Северная Африка, Северный | 104.211.224.189 |
| Западная Южная Африка | 104.211.224.189 |
| Центрально-южная часть США | 23.98.145.105 |
| Южная Индия | 23.99.5.162 |
| Юго-Восточная Азия | 168.63.173.234 |
| Южная часть Соединенного Королевства | 23.97.212.5 |
| Западная часть Соединенного Королевства | 23.97.212.5 |
| Центрально-западная часть США | 168.61.212.201 |
| Западная Европа | 23.97.212.5 |
| Западная Индия | 23.99.5.162 |
| Западная часть США | 23.99.5.162 |
| Западная часть США 2 | 23.99.5.162 | 

#### <a name="azure-monitor-configuration-endpoint-addresses"></a>Адреса конечных точек конфигурации Azure Monitor

| Регион | Адреса |
| --- | --- |
| Центральная Австралия | 52.148.86.165 |
| Центральная Австралия 2 | 52.148.86.165 |
| Восточная Австралия | 52.148.86.165 |
| Юго-Восточная Австралия | 52.148.86.165 |
| Южная Бразилия | 13.68.89.19 |
| Центральная Канада | 13.90.43.231 |
| Восточная Канада | 13.90.43.231 |
| Центральная Индия | 13.71.25.187 |
| Центральная американская | 52.173.95.68 |
| Центральная американская (EUAP) | 13.90.43.231 |
| Восточная Азия | 13.75.117.221 |
| Восточная часть США | 13.90.43.231 |
| Восточная часть США 2 | 13.68.89.19 | 
| Восточная часть США 2 (EUAP) | 13.68.89.19 |
| Центральная Франция | 52.174.4.112 |
| Южная Франция | 52.174.4.112 |
| Восточная Япония | 13.75.117.221 |
| Западная Япония | 13.75.117.221 |
| Центральная Корея | 13.75.117.221 |
| Южная Корея | 13.75.117.221 |
| Северо — центральная часть США | 52.162.240.236 |
| Северная Европа | 52.169.237.246 |
| Северная Африка, Северный | 13.71.25.187 |
| Западная Южная Африка | 13.71.25.187 |
| Юго-Центральный регион США | 13.84.173.99 |
| Южная Индия | 13.71.25.187 |
| Юго-Восточная Азия | 52.148.86.165 |
| южная часть Соединенного Королевства | 52.174.4.112 |
| западная часть Соединенного Королевства | 52.169.237.246 |
| Центрально-западная часть США | 52.161.31.69 |
| Западная Европа | 52.174.4.112 |
| Западная Индия | 13.71.25.187 |
| Западная часть США | 40.78.70.148 |
| Западная часть США 2 | 52.151.20.103 |

## <a name="expressroute-setup"></a>Установка ExpressRoute

Используйте ExpressRoute для подключения к виртуальной сети Azure в локальной сети. Распространенной установкой является объявление маршрута по умолчанию (0.0.0.0/0) через сеанс протокол BGP (BGP). Это вынуждает трафик, поступающий из виртуальной сети, перенаправляться в локальную сеть клиента, которая может удалить трафик, что приведет к прерыванию исходящих потоков. Чтобы преодолеть это значение по умолчанию, можно настроить [определяемый пользователем маршрут (UDR)](/azure/virtual-network/virtual-networks-udr-overview#user-defined) (0.0.0.0/0), а следующий прыжок будет иметь значение " *Интернет*". Так как UDR имеет приоритет над BGP, трафик будет направлен в Интернет.

## <a name="securing-outbound-traffic-with-firewall"></a>Защита исходящего трафика с помощью брандмауэра

Если вы хотите защитить исходящий трафик с помощью [брандмауэра Azure](/azure/firewall/overview) или любого виртуального устройства для ограничения доменных имен, в брандмауэре должны быть разрешены следующие полные доменные имена (FQDN).

```
prod.warmpath.msftcloudes.com:443
production.diagnostics.monitoring.core.windows.net:443
graph.windows.net:443
*.update.microsoft.com:443
shavamanifestcdnprod1.azureedge.net:443
login.live.com:443
wdcp.microsoft.com:443
login.microsoftonline.com:443
azureprofilerfrontdoor.cloudapp.net:443
*.core.windows.net:443
*.servicebus.windows.net:443
shoebox2.metrics.nsatc.net:443
prod-dsts.dsts.core.windows.net:443
ocsp.msocsp.com:80
*.windowsupdate.com:80
ocsp.digicert.com:80
go.microsoft.com:80
dmd.metaservices.microsoft.com:80
www.msftconnecttest.com:80
crl.microsoft.com:80
www.microsoft.com:80
adl.windows.com:80
crl3.digicert.com:80
```

Кроме того, необходимо определить [таблицу маршрутов](/azure/virtual-network/virtual-networks-udr-overview) в подсети с [адресами управления](#azure-data-explorer-management-ip-addresses) и [адресами мониторинга работоспособности](#health-monitoring-addresses) в *Интернете* следующего прыжка, чтобы предотвратить возникновение проблем с асимметричными маршрутами.

Например, для региона " **Западная часть США** " необходимо определить следующие определяемые пользователем маршруты:

| Name | Префикс адреса | Следующий прыжок |
| --- | --- | --- |
| ADX_Management | 13.64.38.225/32 | Интернет |
| ADX_Monitoring | 23.99.5.162/32 | Интернет |

## <a name="deploy-azure-data-explorer-cluster-into-your-vnet-using-an-azure-resource-manager-template"></a>Развертывание кластера Azure обозреватель данных в виртуальной сети с помощью шаблона Azure Resource Manager

Чтобы развернуть кластер Azure обозреватель данных в виртуальной сети, используйте [развертывание кластера azure обозреватель данных в](https://azure.microsoft.com/resources/templates/101-kusto-vnet/) шаблоне виртуальной сети Azure Resource Manager.

Этот шаблон создает кластер, виртуальную сеть, подсеть, группу безопасности сети и общедоступные IP-адреса.
