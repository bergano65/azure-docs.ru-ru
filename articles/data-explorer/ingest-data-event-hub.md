---
title: Прием данных из концентратора событий в Azure Data Explorer
description: В этой статье вы узнаете, как глотать (загружать) данные в Azure Data Explorer из концентратора событий.
author: orspod
ms.author: orspodek
ms.reviewer: tzgitlin
ms.service: data-explorer
ms.topic: conceptual
ms.date: 01/08/2020
ms.openlocfilehash: bce92eeed669628fa1b6318abd6b0c13f7e84848
ms.sourcegitcommit: 27bbda320225c2c2a43ac370b604432679a6a7c0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/31/2020
ms.locfileid: "80411206"
---
# <a name="ingest-data-from-event-hub-into-azure-data-explorer"></a>Прием данных из концентратора событий в Azure Data Explorer

> [!div class="op_single_selector"]
> * [Портал](ingest-data-event-hub.md)
> * [C #](data-connection-event-hub-csharp.md)
> * [Python](data-connection-event-hub-python.md)
> * [Шаблон менеджера ресурсов Azure](data-connection-event-hub-resource-manager.md)

Обозреватель данных Azure — это быстрая и высокомасштабируемая служба для изучения данных журналов и телеметрии. Обозреватель данных Azure позволяет выполнять прием (загрузку) данных из концентраторов событий, платформы потоковой передачи больших данных и службы приема данных событий. [Центры событий](/azure/event-hubs/event-hubs-about) могут обрабатывать миллионы событий в секунду практически в режиме реального времени. В этой статье вы создаете концентратор событий, подключаетесь к нему из Azure Data Explorer и видите поток данных по системе.

## <a name="prerequisites"></a>Предварительные требования

* Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free/) Azure, прежде чем начинать работу.
* [Тестовый кластер и база данных](create-cluster-database-portal.md).
* [Пример приложения](https://github.com/Azure-Samples/event-hubs-dotnet-ingest), создающего данные и отправляющего их в концентратор событий. Загрузите пример приложения в систему.
* [Visual Studio 2019](https://visualstudio.microsoft.com/vs/) для запуска примера приложения.

## <a name="sign-in-to-the-azure-portal"></a>Вход на портал Azure

Войдите на [портал Azure](https://portal.azure.com/).

## <a name="create-an-event-hub"></a>Создание концентратора событий

В этой статье вы генерируете выборочные данные и отправляете их в концентратор событий. Первым шагом является создание концентратора событий. Это делается с помощью шаблона Azure Resource Manager на портале Azure.

1. Нажмите следующую кнопку, чтобы начать развертывание и создание концентратора событий. Чтобы закончить выполнение инструкций из этой статьи, щелкните правой кнопкой мыши и выберите ссылку **Открыть в новом окне**.

    [![Развертывание в Azure](media/ingest-data-event-hub/deploybutton.png)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F201-event-hubs-create-event-hub-and-consumer-group%2Fazuredeploy.json)

    Кнопка **Развернуть в Azure** выполняет переход на портал Azure для заполнения формы развертывания.

    ![Развертывание в Azure](media/ingest-data-event-hub/deploy-to-azure.png)

1. Выберите подписку, в которой нужно создать концентратор событий, и создайте группу ресурсов с именем *test-hub-rg*.

    ![Создание группы ресурсов](media/ingest-data-event-hub/create-resource-group.png)

1. Заполните форму, указав следующую информацию.

    ![Форма развертывания](media/ingest-data-event-hub/deployment-form.png)

    Используйте значения по умолчанию для всех параметров, отсутствующих в следующей таблице.

    **Параметр** | **Рекомендуемое значение** | **Описание поля**
    |---|---|---|
    | Подписка | Ваша подписка | Выберите подписку Azure, которую нужно использовать для своего концентратора событий.|
    | Группа ресурсов | *test-hub-rg* | Создайте новую группу ресурсов. |
    | Расположение | *Западная часть США* | Выберите *Запад США* для этой статьи. Для производственной системы выберите регион, лучше всего соответствующий вашим потребностям. Создайте пространство имен концентратора событий в одном расположении с кластером Kusto, чтобы обеспечить оптимальную производительность (крайне важно для пространств имен концентраторов событий с высокой пропускной способностью).
    | Имя пространства имен | Уникальное имя пространства имен | Выберите уникальное имя, идентифицирующее пространство имен. Например, *mytestnamespace*. К введенному имени добавляется имя домена *servicebus.windows.net*. Имя может содержать только буквы, цифры и дефисы. Имя должно начинаться с буквы или цифры и заканчиваться буквой или цифрой. Длина значения в символах должна быть от 6 до 50.
    | Имя концентратора событий | *test-hub* | Концентратор событий находится в пространстве имен, предоставляющем уникальный контейнер области. Имя концентратора событий должно быть уникальным в пределах пространства имен. |
    | Имя группы потребителей | *test-group* | Группы получателей событий позволяют каждому из нескольких получающих события приложений иметь отдельное представление потока событий. |
    | | |

1. Выберите **Купить**, что подтверждает создание ресурсов в вашей подписке.

1. На панели инструментов щелкните **Уведомления**, чтобы отслеживать процесс подготовки. Успешное выполнение развертывания может занять несколько минут, но теперь можно перейти к следующему шагу.

    ![Уведомления](media/ingest-data-event-hub/notifications.png)

## <a name="create-a-target-table-in-azure-data-explorer"></a>Создание целевой таблицы в обозревателе данных Azure

Теперь создадим таблицу в обозревателе данных Azure, в которые концентраторы событий будут отправлять данные. Таблица создается в кластере и базе данных, представленных в разделе **Необходимые компоненты**.

1. Войдите на портал Azure, перейдите в свой кластер и выберите **Запрос**.

    ![Ссылка приложения запроса](media/ingest-data-event-hub/query-explorer-link.png)

1. Скопируйте следующую команду в окно и выберите **Выполнить**, чтобы создать таблицу (TestTable), которая будет принимать входящие данные.

    ```Kusto
    .create table TestTable (TimeStamp: datetime, Name: string, Metric: int, Source:string)
    ```

    ![Выполнение создания запроса](media/ingest-data-event-hub/run-create-query.png)

1. Скопируйте следующую команду в окно и выберите **Выполнить** для сопоставления входящих данных JSON с именами столбцов и типами данных таблицы (TestTable).

    ```Kusto
    .create table TestTable ingestion json mapping 'TestMapping' '[{"column":"TimeStamp", "Properties": {"Path": "$.timeStamp"}},{"column":"Name", "Properties": {"Path":"$.name"}} ,{"column":"Metric", "Properties": {"Path":"$.metric"}}, {"column":"Source", "Properties": {"Path":"$.source"}}]'
    ```

## <a name="connect-to-the-event-hub"></a>Подключение к концентратору событий

Теперь вы можете подключиться к концентратору событий с помощью Azure Data Explorer. После установки этого подключения данные, поступающие в концентратор событий, передаются потоком в тестовую таблицу, созданную ранее в этой статье.

1. Выберите **уведомления** на панели инструментов, чтобы убедиться в успешном развертывании концентратора событий.

1. В созданном кластере выберите **Базы данных**, затем **TestDatabase**.

    ![Выбор тестовой базы данных](media/ingest-data-event-hub/select-test-database.png)

1. Выберите **Прием данных** и **Добавить подключение к данным**. Заполните форму, указав следующую информацию. По завершении нажмите кнопку **Создать**.

    ![Подключение концентратора событий](media/ingest-data-event-hub/event-hub-connection.png)

    **Источник данных:**

    **Параметр** | **Рекомендуемое значение** | **Описание поля**
    |---|---|---|
    | Имя подключения к данным | *test-hub-connection* | Имя создаваемого подключения к обозревателю данных Azure.|
    | Пространство имен концентратора событий | Уникальное имя пространства имен | Имя, выбранное ранее и определяющее пространство имен. |
    | концентратор событий; | *test-hub* | Созданный концентратор событий. |
    | Группа потребителей | *test-group* | Группа получателей событий, определенная в созданном концентраторе событий. |
    | Свойства системы событий | Выберите соответствующие свойства | [Свойства системы концентратора событий](/azure/service-bus-messaging/service-bus-amqp-protocol-guide#message-annotations). При наличии нескольких записей на сообщение события свойства системы будут добавлены к первой. При добавлении свойств системы [создавайте](/azure/kusto/management/create-table-command) или [обновляйте](/azure/kusto/management/alter-table-command) схему таблицы и [отображение,](/azure/kusto/management/mappings) чтобы включить выбранные свойства. |
    | Сжатие | *Нет* | Тип сжатия полезной нагрузки событийного концентратора. Поддерживаемые типы сжатия: *Нет, ГЗип*.|
    | | |

    **Целевая таблица:**

    Существуют два варианта маршрутизации принятых данных: *статическая* и *динамическая*. 
    В этой статье используется статическая маршрутизация, для которой нужно указать имя таблицы, формат данных и сопоставление. Поэтому не устанавливайте флажок **Мои данные содержат сведения о маршрутизации**.

     **Параметр** | **Рекомендуемое значение** | **Описание поля**
    |---|---|---|
    | Таблица | *TestTable* | Таблица, созданная в базе данных **TestDatabase**. |
    | Формат данных | *JSON* | Поддерживаемые форматы: Avro, CSV, JSON, MULTILINE JSON, PSV, SOHSV, SCSV, TSV, TSVE, TXT, ORC и PARQUET. |
    | Сопоставление столбцов | *TestMapping* | [Карта,](/azure/kusto/management/mappings) созданная в **TestDatabase,** которая отображает поступающие данные JSON к именам столбцов и типам данных **TestTable.** Требуется для JSON или MULTILINE JSON, и необязательно для других форматов.|
    | | |

    > [!NOTE]
    > * Выберите **My data includes routing info** (Мои данные содержат сведения о маршрутизации) для использования динамической маршрутизации, при которой данные содержат необходимые сведения о маршрутизации, как показано в комментариях [примера приложения](https://github.com/Azure-Samples/event-hubs-dotnet-ingest). Если заданы свойства статической и динамической маршрутизации, то свойство динамической маршрутизации переопределяет свойство статической. 
    > * Попамейтеся только события, оканивающиеся после создания соединения данных.
    > * Вы также можете установить тип сжатия с помощью динамических свойств, как видно из [примера приложения.](https://github.com/Azure-Samples/event-hubs-dotnet-ingest)
    > * Форматы Avro, ORC и PAR-,, а также свойства системы событий не поддерживаются на полезной нагрузке сжатия G-ip.

[!INCLUDE [data-explorer-container-system-properties](../../includes/data-explorer-container-system-properties.md)]

## <a name="copy-the-connection-string"></a>Копирование строки подключения

При запуске [примера приложения](https://github.com/Azure-Samples/event-hubs-dotnet-ingest), указанного в списке предварительных требований, потребуется строка подключения для пространства имен концентратора событий.

1. В созданном пространстве имен концентратора событий выберите **Политики общего доступа**, затем **RootManageSharedAccessKey**.

    ![Политики общего доступа](media/ingest-data-event-hub/shared-access-policies.png)

1. Строка **копирования подключения - основной ключ**. Вставьте его при работе со следующим разделом.

    ![Строка подключения](media/ingest-data-event-hub/connection-string.png)

## <a name="generate-sample-data"></a>Создание примера данных

Используйте [пример приложения](https://github.com/Azure-Samples/event-hubs-dotnet-ingest), загруженный для создания данных.

1. Откройте решение для примера приложения в Visual Studio.

1. В файле *program.cs* обновите константу `connectionString`, указав строку подключения, скопированную из пространства имен концентратора событий.

    ```csharp
    const string eventHubName = "test-hub";
    // Copy the connection string ("Connection string-primary key") from your Event Hub namespace.
    const string connectionString = @"<YourConnectionString>";
    ```

1. Выполните сборку и запустите приложение. Приложение отправляет сообщения в концентратор событий, и он печатает состояние каждые десять секунд.

1. После отправки приложением нескольких сообщений перейдите к следующему шагу: просмотрите поток данных, поступающий в концентратор событий центра и тестовую таблицу.

## <a name="review-the-data-flow"></a>Просмотр потока данных

Теперь, когда приложение создает данные, вы можете просмотреть поток данных, поступающих из концентратора событий в таблицу в кластере.

1. На портале Azure, в разделе своего концентратора событий, во время работы приложения появится пик активности.

    ![График концентратора событий](media/ingest-data-event-hub/event-hub-graph.png)

1. Чтобы проверить, сколько сообщений поступило в базу данных к этому моменту, выполните следующий запрос в тестовой базе данных.

    ```Kusto
    TestTable
    | count
    ```

1. Чтобы увидеть содержимое сообщений, выполните следующий запрос:

    ```Kusto
    TestTable
    ```

    Результат должен выглядеть примерно так:

    ![Набор результатов для сообщений](media/ingest-data-event-hub/message-result-set.png)

    > [!NOTE]
    > * В Azure Data Explorer настроена политика агрегирования (пакетной обработки) для приема данных, предназначенных для оптимизации процесса. Политика настроена на 5 минут или 500 МБ данных, по умолчанию, так что вы можете столкнуться с задержкой. Просмотрите [политику пакетирования](/azure/kusto/concepts/batchingpolicy) для вариантов агрегирования. 
    > * В него входит время отклика Event Hub 10 секунд или 1 МБ. 
    > * Назначьте таблицу для поддержки потоковой передачи и удаления задержки во времени отклика. Посмотреть [политику потоковой передачи.](/azure/kusto/concepts/streamingingestionpolicy) 

## <a name="clean-up-resources"></a>Очистка ресурсов

Если не планируется повторно использовать концентратор событий, очистите **test-hub-rg**, чтобы избежать взимания оплаты.

1. На портале Azure выберите **Группа ресурсов** слева, а затем выберите созданную группу ресурсов.  

    Если левое меню свернуто, нажмите ![кнопку "Развернуть",](media/ingest-data-event-hub/expand.png) чтобы развернуть его.

   ![Выбор удаляемой группы ресурсов](media/ingest-data-event-hub/delete-resources-select.png)

1. В разделе **test-resource-group** выберите **Удалить группу ресурсов**.

1. В новом окне введите имя удаляемой группы ресурсов (*test-hub-rg*) и нажмите кнопку **Удалить**.

## <a name="next-steps"></a>Следующие шаги

* [Данные запросов в Azure Data Explorer](web-query-data.md)
