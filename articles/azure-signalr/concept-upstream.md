---
title: Параметры вышестоящей службы в службе SignalR Azure
description: Получите представление о параметрах и протоколах вышестоящего обмена сообщениями.
author: chenyl
ms.service: signalr
ms.topic: conceptual
ms.date: 06/11/2020
ms.author: chenyl
ms.openlocfilehash: 33df4410b9dd82fd0b1c732eb03ab5e0e77e9869
ms.sourcegitcommit: 799f0f187f96b45ae561923d002abad40e1eebd6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/24/2020
ms.locfileid: "97763121"
---
# <a name="upstream-settings"></a>Параметры функции отправки данных в вышестоящий ресурс

Вышестоящее средство — это предварительная версия функции, которая позволяет службе Azure SignalR отправить сообщения и события подключения в набор конечных точек в бессерверном режиме. Можно использовать вышестоящий метод для вызова метода концентратора из клиентов в бессерверном режиме и разрешить конечным точкам получать уведомления при подключении или отключении клиентских подключений.

> [!NOTE]
> Параметры вышестоящей конфигурации можно настроить только в бессерверном режиме.

## <a name="details-of-upstream-settings"></a>Сведения о параметрах вышестоящей передачи

Вышестоящее параметры состоят из списка элементов с учетом порядка. Каждый элемент состоит из следующих элементов:

* Шаблон URL-адреса, указывающий, куда отправляются сообщения.
* Набор правил.
* Конфигурации проверки подлинности. 

Когда происходит указанное событие, правила элемента проверяются по одному по порядку. Сообщения будут отправляться на вышестоящий URL-адрес первого совпадающего элемента.

### <a name="url-template-settings"></a>Параметры шаблона URL-адреса

Можно параметризовать URL-адрес для поддержки различных шаблонов. Существует три предопределенных параметра:

|Предопределенный параметр|Описание|
|---------|---------|
|центра| Центр — это концепция службы Azure SignalR. Концентратор — это единица изоляции. Область действия пользователей и доставки сообщений ограничена центром.|
|категори| Категория может иметь одно из следующих значений: <ul><li>**подключения**: события времени жизни соединения. Он срабатывает при подключении или отключении клиентского подключения. Он включает в себя подключенные и отключенные события.</li><li>**сообщения**: срабатывает, когда клиенты вызывают метод концентратора. Он включает все остальные события, кроме тех, которые указаны в категории **подключения** .</li></ul>|
|журнале| Для категории **Messages** событие является целевым объектом в [сообщении вызова](https://github.com/dotnet/aspnetcore/blob/master/src/SignalR/docs/specs/HubProtocol.md#invocation-message-encoding) , отправляемом клиентами. Для категории **подключения** используются только *подключенные* и *Отключенные* .|

Эти предопределенные параметры можно использовать в шаблоне URL-адреса. При вычислении вышестоящего URL-адреса параметры будут заменены указанным значением. Пример: 
```
http://host.com/{hub}/api/{category}/{event}
```
При подключении клиента в концентраторе "чат" на этот URL-адрес будет отправлено сообщение:
```
http://host.com/chat/api/connections/connected
```
Когда клиент в центре "чат" вызывает метод концентратора `broadcast` , на этот URL-адрес будет отправлено сообщение:
```
http://host.com/chat/api/messages/broadcast
```

### <a name="key-vault-secret-reference-in-url-template-settings"></a>Key Vault ссылка на секретный код в параметрах шаблона URL-адреса

URL-адрес вышестоящего не является шифрованием неактивных данных. Если у вас есть конфиденциальная информация, рекомендуется использовать Key Vault, чтобы сохранить их там, где управление доступом обеспечивает лучшую страховку. По сути, можно включить управляемое удостоверение службы Azure SignalR, а затем предоставить разрешение на чтение для экземпляра Key Vault и использовать ссылку Key Vault вместо открытого текста в шаблоне вышестоящего URL-адреса.

1. Добавьте удостоверение, назначенное системой, или пользовательское удостоверение. См. статью [Добавление управляемого удостоверения на портале Azure](./howto-use-managed-identity.md#add-a-system-assigned-identity) .

2. Предоставьте секретное разрешение на чтение для управляемого удостоверения в политиках доступа в Key Vault. См. раздел [Назначение политики доступа Key Vault с помощью портал Azure](https://docs.microsoft.com/azure/key-vault/general/assign-access-policy-portal)

3. Замените конфиденциальный текст синтаксисом `{@Microsoft.KeyVault(SecretUri=<secret-identity>)}` в шаблоне вышестоящего URL-адреса.

> [!NOTE]
> Содержимое секрета считывается только при изменении параметров восходящего потока или при изменении управляемого удостоверения. Прежде чем использовать ссылку на секрет Key Vault, убедитесь, что вы получили разрешение на чтение с помощью управляемого удостоверения.

### <a name="rule-settings"></a>Параметры правила

Вы можете задать правила для *правил концентратора*, *правил категорий* и *правил событий* отдельно. Правило сопоставления поддерживает три формата. Возьмем в качестве примера правила событий.
- Используйте звездочку (*) для сопоставления любых событий.
- Для объединения нескольких событий используйте запятую (,). Например, `connected, disconnected` соответствует подключенным и отключенным событиям.
- Используйте полное имя события для сопоставления с событием. Например, `connected` соответствует подключенному событию.

> [!NOTE]
> Если вы используете функции Azure и [триггер SignalR](../azure-functions/functions-bindings-signalr-service-trigger.md), триггер SignalR будет предоставлять одну конечную точку в следующем формате: `<Function_App_URL>/runtime/webhooks/signalr?code=<API_KEY>` .
> Можно просто настроить **Параметры шаблона URL-адреса** для этого URL-адреса и использовать **Параметры правил** по умолчанию. Дополнительные сведения о поиске и службах см. в разделе [Интеграция службы SignalR](../azure-functions/functions-bindings-signalr-service-trigger.md#signalr-service-integration) `<Function_App_URL>` `<API_KEY>` .

### <a name="authentication-settings"></a>Параметры проверки подлинности

Можно настроить проверку подлинности для каждого элемента вышестоящего параметра отдельно. При настройке проверки подлинности маркер задается в `Authentication` заголовке вышестоящего сообщения. Сейчас служба Azure SignalR поддерживает следующие типы проверки подлинности:
- `None`
- `ManagedIdentity`

При выборе `ManagedIdentity` необходимо включить управляемое удостоверение в службе Azure SignalR заранее и при необходимости указать ресурс. Дополнительные сведения см. в статье [управляемые удостоверения для службы Azure SignalR](howto-use-managed-identity.md) .

## <a name="create-upstream-settings-via-the-azure-portal"></a>Создание вышестоящего параметра с помощью портал Azure

1. Перейдите в службу Azure SignalR.
2. Выберите **Параметры** и переключите **режим службы** на **бессерверный**. Отобразятся параметры восходящего потока:

    :::image type="content" source="media/concept-upstream/upstream-portal.png" alt-text="Параметры функции отправки данных в вышестоящий ресурс":::

3. Добавьте URL-адреса в **шаблон вышестоящего URL-адреса**. Затем параметры, такие как **правила центра** , будут показывать значение по умолчанию.
4. Чтобы задать параметры для **правил концентратора**, **правил событий**, **правил категорий** и **вышестоящей проверки подлинности**, выберите значение **Правила концентратора**. Появится страница, позволяющая изменить параметры.

    :::image type="content" source="media/concept-upstream/upstream-detail-portal.png" alt-text="Сведения о вышестоящем параметре":::

5. Чтобы настроить **вышестоящий способ проверки подлинности**, сначала убедитесь, что вы включили управляемое удостоверение. Затем выберите **использовать управляемое удостоверение**. В соответствии с вашими потребностями можно выбрать любые параметры в разделе **идентификатор ресурса проверки подлинности**. Дополнительные сведения см. в статье [управляемые удостоверения для службы Azure SignalR](howto-use-managed-identity.md) .

## <a name="create-upstream-settings-via-resource-manager-template"></a>Создание вышестоящего параметра с помощью шаблона диспетчер ресурсов

Чтобы создать вышестоящий параметр с помощью [шаблона Azure Resource Manager](../azure-resource-manager/templates/overview.md), задайте `upstream` свойство в `properties` свойстве. В следующем фрагменте кода показано, как задать `upstream` свойство для создания и обновления параметров восходящего потока данных.

```JSON
{
  "properties": {
    "upstream": {
      "templates": [
        {
          "UrlTemplate": "http://host.com/{hub}/api/{category}/{event}",
          "EventPattern": "*",
          "HubPattern": "*",
          "CategoryPattern": "*",
          "Auth": {
            "Type": "ManagedIdentity",
            "ManagedIdentity": {
              "Resource": "<resource>"
            }
          }
        }
      ]
    }
  }
}
```

## <a name="serverless-protocols"></a>Бессерверные протоколы

Служба Azure SignalR отправляет сообщения конечным точкам, которые следуют следующим протоколам. Вы можете использовать [привязку триггера службы SignalR](../azure-functions/functions-bindings-signalr-service-trigger.md) с приложение-функция, которая обрабатывает эти протоколы.

### <a name="method"></a>Метод

POST

### <a name="request-header"></a>Заголовок запроса

|Имя |Описание|
|---------|---------|
|X-АСРС-Connection-ID |Идентификатор соединения для клиентского соединения.|
|X-АСРС-HUB |Концентратор, к которому принадлежит клиентское соединение.|
|X-АСРС-Category |Категория, к которой относится сообщение.|
|X-АСРС-событие |Событие, к которому относится сообщение.|
|X-АСРС-Signature |Код проверки подлинности сообщения на основе хэша (HMAC), используемый для проверки. Дополнительные сведения см. в [сигнатуре](#signature) .|
|X-АСРС-User-Claims |Группа утверждений клиентского соединения.|
|X-АСРС-User-ID |Удостоверение пользователя клиента, который отправляет сообщение.|
|X-АСРС-клиент-запрос |Запрос запроса, когда клиенты подключаются к службе.|
|Проверка подлинности |Необязательный токен, когда вы используете `ManagedIdentity` . |

### <a name="request-body"></a>Тело запроса

#### <a name="connected"></a>Подключен

Content-Type: application/json

#### <a name="disconnected"></a>Отключено

Тип содержимого: `application/json`

|Имя  |Тип  |Описание  |
|---------|---------|---------|
|Ошибка |строка |Сообщение об ошибке закрытого соединения. Пусто, когда соединения закрываются без ошибок.|

#### <a name="invocation-message"></a>Сообщение вызова

Content-Type: `application/json` или `application/x-msgpack`

|Имя  |Тип  |Описание  |
|---------|---------|---------|
|InvocationId |строка | Необязательная строка, представляющая сообщение вызова. Поиск сведений в [вызовах](https://github.com/dotnet/aspnetcore/blob/master/src/SignalR/docs/specs/HubProtocol.md#invocations).|
|Назначение |строка | То же, что и у события, и того же целевого объекта в [сообщении вызова](https://github.com/dotnet/aspnetcore/blob/master/src/SignalR/docs/specs/HubProtocol.md#invocation-message-encoding). |
|Аргументы |Массив объектов |Массив, содержащий аргументы, применяемые к методу, на который ссылается `Target` . |

### <a name="signature"></a>Подпись

Служба вычислит код SHA256 для `X-ASRS-Connection-Id` значения, используя первичный ключ доступа и вторичный ключ доступа в качестве `HMAC` ключа. Служба задаст ее в `X-ASRS-Signature` заголовке при выполнении HTTP-запросов к вышестоящему потоку:
```
Hex_encoded(HMAC_SHA256(accessKey, connection-id))
```

## <a name="next-steps"></a>Дальнейшие действия

- [Управляемые удостоверения для службы Azure SignalR](howto-use-managed-identity.md)
- [Azure Functions development and configuration with Azure SignalR Service](signalr-concept-serverless-development-config.md) (Разработка и настройка функций Azure с помощью Службы Azure SignalR)
- [Обработку сообщений из службы SignalR (привязка триггера)](../azure-functions/functions-bindings-signalr-service-trigger.md)
- [Пример привязки триггера службы SignalR](https://github.com/aspnet/AzureSignalR-samples/tree/master/samples/BidirectionChat)
