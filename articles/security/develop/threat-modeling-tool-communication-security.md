---
title: Безопасность обмена данными для Microsoft Threat Modeling Tool
titleSuffix: Azure
description: Сведения об устранении угроз безопасности связи, предоставляемых в Threat Modeling Tool. См. сведения об устранении рисков и просмотр примеров кода.
services: security
documentationcenter: na
author: jegeib
manager: jegeib
editor: jegeib
ms.assetid: na
ms.service: security
ms.subservice: security-develop
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/07/2017
ms.author: jegeib
ms.custom: devx-track-csharp
ms.openlocfilehash: d9a4eabf37101622ac69ae05f3bec232fb8d2fe6
ms.sourcegitcommit: 5831eebdecaa68c3e006069b3a00f724bea0875a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/11/2020
ms.locfileid: "94517535"
---
# <a name="security-frame-communication-security--mitigations"></a>Механизм безопасности. Безопасность обмена данными | Устранение угроз 
| Продукт или служба | Статья |
| --------------- | ------- |
| **Концентратор событий Azure** | <ul><li>[Обеспечьте безопасное подключение к концентратору событий с использованием протокола SSL/TLS](#comm-ssltls)</li></ul> |
| **Dynamics CRM** | <ul><li>[Проверьте привилегии учетной записи службы и выполнение политик безопасности CRM пользовательскими службами и на страницах ASP.NET](#priv-aspnet)</li></ul> |
| **Фабрика данных Azure**. | <ul><li>[Использование шлюза управления данными при подключении локальной SQL Server к фабрике данных Azure](#sqlserver-factory)</li></ul> |
| **Сервер удостоверений** | <ul><li>[Убедитесь, что весь трафик к серверу удостоверений находится по HTTPS-соединению](#identity-https)</li></ul> |
| **Веб-приложение** | <ul><li>[Проверьте сертификаты X.509, используемые для проверки подлинности подключений SSL, TLS и DTLS](#x509-ssltls)</li><li>[Настройка TLS/SSL-сертификата для пользовательского домена в службе приложений Azure](#ssl-appservice)</li><li>[Настройте принудительную передачу всего трафика к службе приложений Azure через HTTPS-подключение](#appservice-https)</li><li>[Включите строгий режим безопасности транспорта HTTP (HSTS)](#http-hsts)</li></ul> |
| **База данных** | <ul><li>[Убедитесь, что шифрование подключения к SQL Server и проверка сертификата](#sqlserver-validation)</li><li>[Настройте принудительное шифрование подключений к SQL Server](#encrypted-sqlserver)</li></ul> |
| **Хранилище Azure** | <ul><li>[Настройте подключение к службе хранилища Azure по протоколу HTTPS](#comm-storage)</li><li>[Проверяйте MD5-хэш после скачивания большого двоичного объекта по протоколу HTTP](#md5-https)</li><li>[Используйте клиент, совместимый с SMB 3,0, чтобы обеспечить шифрование данных в файловых ресурсах Azure.](#smb-shares)</li></ul> |
| **Мобильный клиент** | <ul><li>[Реализация закрепления сертификата](#cert-pinning)</li></ul> |
| **WCF** | <ul><li>[Включите безопасный канал транспорта HTTPS](#https-transport)</li><li>[WCF. Настройте уровень защиты сообщений с помощью параметра EncryptAndSign](#message-protection)</li><li>[Используйте учетную запись с минимальными привилегиями для запуска службы WCF](#least-account-wcf)</li></ul> |
| **Веб-интерфейс API** | <ul><li>[Настройте принудительную передачу всего трафика к веб-интерфейсам API через HTTPS-подключение](#webapi-https)</li></ul> |
| **Кэш Azure для Redis** | <ul><li>[Убедитесь, что обмен данными с кэшем Azure для Redis осуществляется по протоколу TLS.](#redis-ssl)</li></ul> |
| **Полевой шлюз Интернета вещей** | <ul><li>[Безопасное подключение устройства к полевой шлюзу](#device-field)</li></ul> |
| **Облачный шлюз Интернета вещей** | <ul><li>[Защитите подключение между устройством и облачным шлюзом с помощью SSL/TLS](#device-cloud)</li></ul> |

## <a name="secure-communication-to-event-hub-using-ssltls"></a><a id="comm-ssltls"></a>Обеспечьте безопасное подключение к концентратору событий с использованием протокола SSL/TLS

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | концентратору событий Azure | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | Универсальный шаблон |
| **Атрибуты**              | Недоступно  |
| **Справочные материалы**              | [Общие сведения о проверке подлинности в Центрах событий Azure и модели безопасности](../../event-hubs/authenticate-shared-access-signature.md) |
| **Шаги** | Настройте безопасные HTTP- или AMQP-подключения к концентратору событий, используя протокол SSL/TLS. |

## <a name="check-service-account-privileges-and-check-that-the-custom-services-or-aspnet-pages-respect-crms-security"></a><a id="priv-aspnet"></a>Проверьте привилегии учетной записи службы и выполнение политик безопасности CRM пользовательскими службами и на страницах ASP.NET

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Dynamics CRM | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | Универсальный шаблон |
| **Атрибуты**              | Недоступно  |
| **Справочные материалы**              | Недоступно  |
| **Шаги** | Проверьте привилегии учетной записи службы и выполнение политик безопасности CRM пользовательскими службами и на страницах ASP.NET |

## <a name="use-data-management-gateway-while-connecting-on-premises-sql-server-to-azure-data-factory"></a><a id="sqlserver-factory"></a>Использование шлюза управления данными при подключении локальной SQL Server к фабрике данных Azure

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Фабрика данных Azure | 
| **Этап SDL**               | Развертывание |  
| **Применимые технологии** | Универсальный шаблон |
| **Атрибуты**              | Типы связанных служб — Azure и локальная служба |
| **Справочные материалы**              |[Перемещение данных между локальной средой и фабрикой данных Azure](../../data-factory/v1/data-factory-move-data-between-onprem-and-cloud.md#create-gateway), [шлюзом управления данными](../../data-factory/v1/data-factory-data-management-gateway.md) |
| **Шаги** | <p>Чтобы подключиться к источникам данных, защищенным в корпоративной сети или брандмауэром, требуется шлюз управления данными (DMG).</p><ol><li>Заблокировав доступ к компьютеру, вы изолируете шлюз управления данными и предотвратите повреждение данных неисправными программами или их перехват на исходном компьютере. (В частности, необходимо установить последние обновления, выполнять управляемую подготовку учетных записей, а также включить минимальное требуемое количество портов, аудит, шифрование дисков и т. д.)</li><li>Ключ шлюза данных должен меняться через короткие промежутки времени или после обновления пароля учетной записи службы DMG.</li><li>Транзиты данных через связанную службу должны быть зашифрованы.</li></ol> |

## <a name="ensure-that-all-traffic-to-identity-server-is-over-https-connection"></a><a id="identity-https"></a>Настройте передачу всего трафика на сервер удостоверений через HTTPS-подключение

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Сервер удостоверений | 
| **Этап SDL**               | Развертывание |  
| **Применимые технологии** | Универсальный шаблон |
| **Атрибуты**              | Недоступно  |
| **Справочные материалы**              | [Сведения о ключах, подписях и шифровании на платформе IdentityServer3](https://identityserver.github.io/Documentation/docsv2/configuration/crypto.html), [информация о развертывании платформы IdentityServer3](https://identityserver.github.io/Documentation/docsv2/advanced/deployment.html) |
| **Шаги** | По умолчанию все входящие подключения к IdentityServer должны выполняться по протоколу HTTPS. Взаимодействие с IdentityServer должно выполняться только через защищенные транспортные протоколы. Существуют определенные сценарии развертывания, такие как разгрузка TLS, где это требование может быть ослаблено. Дополнительные сведения см. на странице развертывания платформы IdentityServer. |

## <a name="verify-x509-certificates-used-to-authenticate-ssl-tls-and-dtls-connections"></a><a id="x509-ssltls"></a>Проверьте сертификаты X.509, используемые для проверки подлинности подключений SSL, TLS и DTLS

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Веб-приложение | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | Универсальный шаблон |
| **Атрибуты**              | Недоступно  |
| **Справочные материалы**              | Недоступно  |
| **Шаги** | <p>Приложения, использующие протокол SSL, TLS и DTLS, должны тщательно проверять сертификаты X.509 сущностей, к которым они подключаются. Приложение должно проверить следующее:</p><ul><li>Доменное имя</li><li>Даты действия (даты начала и окончания срока действия).</li><li>Состояние отзыва.</li><li>Использование (например, проверка подлинности сервера для серверов, проверка подлинности клиента для клиентов).</li><li>Цепь доверия. Сертификаты должны быть привязаны к корневому центру сертификации, доверенному на платформе или явно настроенному администратором.</li><li>Длина открытого ключа сертификата должна быть больше 2048 бит.</li><li>Должен использоваться алгоритм хэширования версии SHA256 или более поздней. |

## <a name="configure-tlsssl-certificate-for-custom-domain-in-azure-app-service"></a><a id="ssl-appservice"></a>Настройка TLS/SSL-сертификата для пользовательского домена в службе приложений Azure

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Веб-приложение | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | Универсальный шаблон |
| **Атрибуты**              | EnvironmentType: Azure |
| **Справочные материалы**              | [Включение протокола HTTPS для приложения в службе приложений Azure](../../app-service/configure-ssl-bindings.md) |
| **Шаги** | По умолчанию служба Azure включает протокол HTTPS для каждого приложения с помощью группового сертификата домена *.azurewebsites.net. Однако, как и все домены с подстановочными знаками, он не так безопасен, как личный домен с собственным сертификатом. Дополнительные сведения см. в [этой статье](https://casecurity.org/2014/02/26/pros-and-cons-of-single-domain-multi-domain-and-wildcard-certificates/). Рекомендуется включить TLS для личного домена, через который будет осуществляться доступ к развернутому приложению.|

## <a name="force-all-traffic-to-azure-app-service-over-https-connection"></a><a id="appservice-https"></a>Настройте принудительную передачу всего трафика к службе приложений Azure через HTTPS-подключение

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Веб-приложение | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | Универсальный шаблон |
| **Атрибуты**              | EnvironmentType: Azure |
| **Справочные материалы**              | [Принудительное использование HTTPS в службе приложений Azure](../../app-service/configure-ssl-bindings.md#enforce-https) |
| **Шаги** | <p>По умолчанию Azure включает протокол HTTPS для службы приложений Azure с помощью группового сертификата домена *.azurewebsites.net. Поэтому этот протокол принудительно применять не нужно. Посетители по-прежнему могут получить доступ к приложению, используя протокол HTTP, что может поставить под угрозу безопасность приложения, и следовательно, владелец приложения должен явным образом применить протокол HTTPS. В приложения ASP.NET MVC необходимо добавить [фильтр RequireHttps](/dotnet/api/system.web.mvc.requirehttpsattribute), который принудительно пересылает незащищенные HTTP-запросы по протоколу HTTPS.</p><p>Кроме того, чтобы применить HTTPS, вы можете использовать модуль переопределения URL-адресов, входящий в состав службы приложений Azure. Модуль переопределения URL-адресов позволяет разработчикам определять правила, применяемые к входящим запросам перед их обработкой и отправкой в приложение. Правила этого модуля задаются в файле web.config, который хранится в корневом каталоге приложения.</p>|

### <a name="example"></a>Пример
В примере ниже показано базовое правило модуля переопределения URL-адресов, которое заставляет весь входящий трафик использовать HTTPS.
```XML
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <rule name="Force HTTPS" enabled="true">
          <match url="(.*)" ignoreCase="false" />
          <conditions>
            <add input="{HTTPS}" pattern="off" />
          </conditions>
          <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" appendQueryString="true" redirectType="Permanent" />
        </rule>
      </rules>
    </rewrite>
  </system.webServer>
</configuration>
```
Это правило работает путем возврата кода состояния HTTP 301 (постоянное перенаправление), когда пользователь запрашивает страницу с помощью HTTP. Код состояния 301 перенаправляет запрос на тот же запрошенный посетителем URL-адрес, но заменяет в запросе HTTP на HTTPS. Например, `HTTP://contoso.com` будет перенаправлено в `HTTPS://contoso.com`. 

## <a name="enable-http-strict-transport-security-hsts"></a><a id="http-hsts"></a>Включите строгий режим безопасности транспорта HTTP (HSTS)

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Веб-приложение | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | Универсальный шаблон |
| **Атрибуты**              | Недоступно  |
| **Справочные материалы**              | [Памятка OWASP по HSTS](https://cheatsheetseries.owasp.org/cheatsheets/HTTP_Strict_Transport_Security_Cheat_Sheet.html) |
| **Шаги** | <p>Строгий режим безопасности транспорта HTTP — включаемый компонент системы безопасности, заданный веб-приложением с помощью специального заголовка ответа. После получения этого заголовка поддерживаемый браузер прерывает передачу любых данных в определенный домен по протоколу HTTP, а вместо этого передает эти данные по протоколу HTTPS. HSTS также предотвращает переходы на вредоносные страницы по протоколу HTTPS в браузерах.</p><p>Чтобы реализовать HSTS, следующий заголовок ответа необходимо настроить для веб-сайта глобально, либо в коде, либо в конфигурации. Долгосрочный транспорт — Безопасность: max-age = 300; includeSubDomains HSTS устраняет следующие угрозы:</p><ul><li>Уязвимость к атакам "злоумышленник в середине" при использовании закладок или ввода `https://example.com` вручную. HSTS автоматически перенаправляет HTTP-запросы к целевому домену по протоколу HTTPS.</li><li>Веб-приложение, предназначенное для использования протокола HTTPS, содержит HTTP-ссылки или передает содержимое по протоколу HTTP. HSTS автоматически перенаправляет HTTP-запросы к целевому домену по протоколу HTTPS.</li><li>Злоумышленник с помощью атаки "злоумышленник в середине" пытается перехватить трафик пользователя, используя недопустимый сертификат, и надеется, что этот пользователь примет недействительный сертификат. HSTS не разрешит пользователю переопределить правильный сертификат.</li></ul>|

## <a name="ensure-sql-server-connection-encryption-and-certificate-validation"></a><a id="sqlserver-validation"></a>Включите шифрование подключения и проверку сертификатов SQL Server

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | База данных | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | SQL Azure  |
| **Атрибуты**              | Версия SQL: 12 |
| **Справочные материалы**              | [Рекомендации по написанию безопасных строк подключения для базы данных SQL](https://social.technet.microsoft.com/wiki/contents/articles/2951.windows-azure-sql-database-connection-security.aspx#best) |
| **Шаги** | <p>Все связи между базой данных SQL и клиентским приложением шифруются с помощью протокола TLS, который ранее назывался SSL (SSL). База данных SQL не поддерживает незашифрованные соединения. Для проверки сертификатов с помощью кода приложения или инструментов явно запрашивайте зашифрованное подключение и не доверяйте сертификатам сервера. Если код приложения или инструменты не запрашивают зашифрованное подключение, они все равно его получат.</p><p>Но эти программные средства могут не проверять сертификаты сервера, поэтому становятся восприимчивыми к атакам «злоумышленник в середине». Для проверки сертификатов с помощью кода приложения ADO.NET задайте параметры `Encrypt=True` и `TrustServerCertificate=False` в строке подключения к базе данных. Чтобы проверить сертификаты с помощью SQL Server Management Studio, откройте диалоговое окно "Соединение с сервером". На вкладке "Свойства соединения" щелкните "Шифровать соединение".</p>|

## <a name="force-encrypted-communication-to-sql-server"></a><a id="encrypted-sqlserver"></a>Настройте принудительное шифрование подключений к SQL Server

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | База данных | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | Локальные |
| **Атрибуты**              | Версия SQL: MsSQL2016, MsSQL2012, MsSQL2014 |
| **Справочные материалы**              | [Включение зашифрованных соединений для ядра СУБД](/sql/database-engine/configure-windows/enable-encrypted-connections-to-the-database-engine)  |
| **Шаги** | Включение шифрования TLS повышает безопасность данных, передаваемых по сетям между экземплярами SQL Server и приложений. |

## <a name="ensure-that-communication-to-azure-storage-is-over-https"></a><a id="comm-storage"></a>Настройте подключение к службе хранилища Azure по протоколу HTTPS

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Хранилище Azure | 
| **Этап SDL**               | Развертывание |  
| **Применимые технологии** | Универсальный шаблон |
| **Атрибуты**              | Недоступно  |
| **Справочные материалы**              | [Руководство по безопасности службы хранилища Azure. Шифрование на уровне транспорта с помощью протокола HTTPS](../../storage/blobs/security-recommendations.md#networking) |
| **Шаги** | Чтобы обеспечить безопасную передачу данных службы хранилища Azure, при вызове интерфейсов REST API или доступе к объектам в хранилище всегда используйте протокол HTTPS. Кроме того, подписанные URL-адреса, которые можно применять для доступа к объектам в службе хранилища Azure, дают возможность указывать, что с ними может использоваться только протокол HTTPS. Это позволяет гарантировать, что все получатели ссылок с маркерами SAS будут применять надлежащий протокол.|

## <a name="validate-md5-hash-after-downloading-blob-if-https-cannot-be-enabled"></a><a id="md5-https"></a>Проверяйте MD5-хэш после скачивания большого двоичного объекта по протоколу HTTP

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Хранилище Azure | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | Универсальный шаблон |
| **Атрибуты**              | Тип хранилища: большой двоичный объект |
| **Справочные материалы**              | [Общие сведения о проверке MD5 в службе BLOB-объектов Microsoft Azure](https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/17/windows-azure-blob-md5-overview/) |
| **Шаги** | <p>Служба BLOB-объектов Microsoft Azure предоставляет механизм, обеспечивающий безопасность данных на уровне приложения и транспортного протокола. Если по какой-либо причине необходимо использовать протокол HTTP вместо HTTPS и вы работаете с блочными BLOB-объектами, то можно использовать проверку MD5 для проверки целостности передаваемых больших двоичных объектов.</p><p>Это поможет защититься от ошибок транспортного и сетевого уровня, но не обязательно предотвратит атаки промежуточного уровня. Если можно использовать протокол HTTPS, который обеспечивает безопасность на транспортном уровне, то применение проверки MD5 является избыточным и ненужным.</p>|

## <a name="use-smb-30-compatible-client-to-ensure-in-transit-data-encryption-to-azure-file-shares"></a><a id="smb-shares"></a>Используйте клиент, совместимый с SMB 3.0, для шифрования данных, передаваемых в общую папку Azure

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Мобильный клиент | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | Универсальный шаблон |
| **Атрибуты**              | Тип хранилища: файлы |
| **Справочные материалы**              | [Сведения о хранилище файлов Azure](https://azure.microsoft.com/blog/azure-file-storage-now-generally-available/#comment-2529238931), [Приступая к работе с хранилищем файлов Azure в Windows](../../storage/files/storage-dotnet-how-to-use-files.md#understanding-the-net-apis) |
| **Шаги** | Хранилище файлов Azure поддерживает протокол HTTPS при использовании REST API, но чаще применяется как общая папка SMB, подключенная к виртуальной машине. Протокол SMB 2.1 не поддерживает шифрование, поэтому подключения допускаются только в пределах одного региона Azure. Однако протокол SMB 3.0 поддерживает шифрование и может использоваться с Windows Server 2012 R2, Windows 8, Windows 8.1 и Windows 10, обеспечивая доступ между регионами и даже доступ на компьютере. |

## <a name="implement-certificate-pinning"></a><a id="cert-pinning"></a>Реализуйте привязку сертификата

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Хранилище Azure | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | Универсальное, Windows Phone |
| **Атрибуты**              | Недоступно  |
| **Справочные материалы**              | [Привязка сертификата и открытого ключа](https://owasp.org/www-community/controls/Certificate_and_Public_Key_Pinning) |
| **Шаги** | <p>Привязка сертификата защищает от атак "злоумышленник в середине". Этот процесс заключается в привязке узла к ожидаемому сертификату X509 или открытому ключу. После добавления сертификата или открытого ключа для узла их необходимо привязать к нему. </p><p>Таким словами, когда злоумышленник попытается выполнить атаку TLS MITM, во время подтверждения TLS ключ от сервера злоумышленника будет отличаться от ключа закрепленного сертификата, и запрос будет отклонен, что позволяет избежать закрепления сертификатов MITM, реализуя `ServerCertificateValidationCallback` делегат ServicePointManager.</p>|

### <a name="example"></a>Пример
```csharp
using System;
using System.Net;
using System.Net.Security;
using System.Security.Cryptography;

namespace CertificatePinningExample
{
    class CertificatePinningExample
    {
        /* Note: In this example, we're hardcoding a the certificate's public key and algorithm for 
           demonstration purposes. In a real-world application, this should be stored in a secure
           configuration area that can be updated as needed. */

        private static readonly string PINNED_ALGORITHM = "RSA";

        private static readonly string PINNED_PUBLIC_KEY = "3082010A0282010100B0E75B7CBE56D31658EF79B3A1" +
            "294D506A88DFCDD603F6EF15E7F5BCBDF32291EC50B2B82BA158E905FE6A83EE044A48258B07FAC3D6356AF09B2" +
            "3EDAB15D00507B70DB08DB9A20C7D1201417B3071A346D663A241061C151B6EC5B5B4ECCCDCDBEA24F051962809" +
            "FEC499BF2D093C06E3BDA7D0BB83CDC1C2C6660B8ECB2EA30A685ADE2DC83C88314010FFC7F4F0F895EDDBE5C02" +
            "ABF78E50B708E0A0EB984A9AA536BCE61A0C31DB95425C6FEE5A564B158EE7C4F0693C439AE010EF83CA8155750" +
            "09B17537C29F86071E5DD8CA50EBD8A409494F479B07574D83EDCE6F68A8F7D40447471D05BC3F5EAD7862FA748" +
            "EA3C92A60A128344B1CEF7A0B0D94E50203010001";


        public static void Main(string[] args)
        {
            HttpWebRequest request = (HttpWebRequest)WebRequest.Create("https://azure.microsoft.com");
            request.ServerCertificateValidationCallback = (sender, certificate, chain, sslPolicyErrors) =>
            {
                if (certificate == null || sslPolicyErrors != SslPolicyErrors.None)
                {
                    // Error getting certificate or the certificate failed basic validation
                    return false;
                }

                var targetKeyAlgorithm = new Oid(certificate.GetKeyAlgorithm()).FriendlyName;
                var targetPublicKey = certificate.GetPublicKeyString();
                
                if (targetKeyAlgorithm == PINNED_ALGORITHM &&
                    targetPublicKey == PINNED_PUBLIC_KEY)
                {
                    // Success, the certificate matches the pinned value.
                    return true;
                }
                // Reject, either the key or the algorithm does not match the expected value.
                return false;
            };

            try
            {
                var response = (HttpWebResponse)request.GetResponse();
                Console.WriteLine($"Success, HTTP status code: {response.StatusCode}");
            }
            catch(Exception ex)
            {
                Console.WriteLine($"Failure, {ex.Message}");
            }
            Console.WriteLine("Press any key to end.");
            Console.ReadKey();
        }
    }
}
```

## <a name="enable-https---secure-transport-channel"></a><a id="https-transport"></a>Включите безопасный канал транспорта HTTPS

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | WCF | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | .NET Framework 3 |
| **Атрибуты**              | Недоступно  |
| **Справочные материалы**              | [MSDN](/previous-versions/msp-n-p/ff648500(v=pandp.10)), [Fortify Kingdom](https://vulncat.fortify.com/en/detail?id=desc.config.dotnet.wcf_misconfiguration_transport_security_enabled) |
| **Шаги** | В конфигурации приложения должно быть задано, что для доступа к конфиденциальной информации используется протокол HTTPS.<ul><li>**Пояснение.** Если приложение обрабатывает конфиденциальную информацию и не использует шифрование на уровне сообщений, доступ к нему должен осуществляться только через зашифрованный канал транспорта.</li><li>**Рекомендации.** Отключите транспортный протокол HTTP и включите HTTPS. Например, замените тег `<httpTransport/>` на `<httpsTransport/>`. Не следует полагаться на конфигурацию сети (брандмауэра), чтобы обеспечить доступ к приложению только через защищенный канал. С философской точки зрения безопасность приложения не должна зависеть от сети.</li></ul><p>В практическом плане сотрудники, ответственные за обеспечение безопасности сети, не всегда проверяют возникающие требования к безопасности приложения.</p>|

## <a name="wcf-set-message-security-protection-level-to-encryptandsign"></a><a id="message-protection"></a>WCF. Настройте уровень защиты сообщений с помощью параметра EncryptAndSign

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | WCF | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | .NET Framework 3 |
| **Атрибуты**              | Недоступно  |
| **Справочные материалы**              | [MSDN](/previous-versions/msp-n-p/ff650862(v=pandp.10)) |
| **Шаги** | <ul><li>**Пояснение.** Если для уровня защиты задано значение none, защита сообщений отключена. Конфиденциальность и целостность достигается при использовании соответствующего уровня настройки.</li><li>**ПРОЕКТИРОВАН**<ul><li>Задайте значение `Mode=None`, чтобы отключить защиту сообщений.</li><li>При использовании значения `Mode=Sign` сообщения подписываются, но не шифруются. Следует использовать, если важна целостность данных.</li><li>При использовании значения `Mode=EncryptAndSign` сообщения подписываются и шифруются.</li></ul></li></ul><p>Мы рекомендуем отключить шифрование сообщений и только подписывать их, если вы просто хотите проверить целостность информации, не принимая во внимание конфиденциальность. Рассмотрите этот вариант для операций и контрактов службы, в которых необходимо проверить исходного отправителя, но конфиденциальные данные не передаются. При уменьшении уровня защиты следует следить за тем, чтобы сообщение не содержало каких бы то ни было персональных данных.</p>|

### <a name="example"></a>Пример
В следующих примерах служба и операция только подписывают сообщение. Пример контракта службы `ProtectionLevel.Sign`. Ниже приведен пример использования параметра ProtectionLevel.Sign на уровне контракта службы. 
```
[ServiceContract(Protection Level=ProtectionLevel.Sign] 
public interface IService 
  { 
  string GetData(int value); 
  } 
```

### <a name="example"></a>Пример
Пример контракта операции `ProtectionLevel.Sign` (для более детального управления). Ниже приведен пример использования параметра `ProtectionLevel.Sign` на уровне контракта операции.

```
[OperationContract(ProtectionLevel=ProtectionLevel.Sign] 
string GetData(int value);
``` 

## <a name="wcf-use-a-least-privileged-account-to-run-your-wcf-service"></a><a id="least-account-wcf"></a>Используйте учетную запись с минимальными привилегиями для запуска службы WCF

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | WCF | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | .NET Framework 3 |
| **Атрибуты**              | Недоступно  |
| **Справочные материалы**              | [MSDN](/previous-versions/msp-n-p/ff648826(v=pandp.10)) |
| **Шаги** | <ul><li>**Пояснение.** Не запускайте службы WCF, используя учетную запись с высоким уровнем привилегий или учетную запись администратора. В случае компрометации служб это может иметь значительные последствия.</li><li>**Рекомендации.** Используйте для размещения службы WCF учетную запись с минимальными привилегиями. Это позволит уменьшить вероятность атаки на приложение и связанные с ней риски. Если для учетной записи службы требуются дополнительные права доступа к ресурсам инфраструктуры, например к MSMQ, журналу событий, счетчикам производительности и файловой системе, задайте необходимые разрешения, чтобы запустить службу WCF успешно.</li></ul><p>Если службе требуется доступ к определенным ресурсам от имени исходного вызывающего объекта, используйте олицетворение и делегирование, чтобы передать удостоверения этого объекта для проверки авторизации подчиненных. В сценариях разработки используйте учетную запись локальной сетевой службы (специальная встроенная учетная запись с меньшими привилегиями доступа). В рабочем сценарии создайте пользовательскую учетную запись службы домена с минимальными привилегиями</p>|

## <a name="force-all-traffic-to-web-apis-over-https-connection"></a><a id="webapi-https"></a>Настройте принудительную передачу всего трафика к веб-интерфейсам API через HTTPS-подключение

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Веб-API | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | MVC 5, MVC 6 |
| **Атрибуты**              | Недоступно  |
| **Справочные материалы**              | [Информация о работе с SSL в веб-интерфейсе API](https://www.asp.net/web-api/overview/security/working-with-ssl-in-web-api) |
| **Шаги** | Если приложение имеет и привязку HTTP, и HTTPS, для доступа к сайту клиенты по-прежнему могут использовать протокол HTTP. Чтобы избежать этого, используйте фильтр действий. Это позволит всегда передавать запросы к защищенным интерфейсам API по протоколу HTTPS.|

### <a name="example"></a>Пример 
В следующем коде показан фильтр проверки подлинности веб-API, который проверяет TLS: 
```csharp
public class RequireHttpsAttribute : AuthorizationFilterAttribute
{
    public override void OnAuthorization(HttpActionContext actionContext)
    {
        if (actionContext.Request.RequestUri.Scheme != Uri.UriSchemeHttps)
        {
            actionContext.Response = new HttpResponseMessage(System.Net.HttpStatusCode.Forbidden)
            {
                ReasonPhrase = "HTTPS Required"
            };
        }
        else
        {
            base.OnAuthorization(actionContext);
        }
    }
}
```
Добавьте этот фильтр к действиям веб-API, для которых требуется TLS: 
```csharp
public class ValuesController : ApiController
{
    [RequireHttps]
    public HttpResponseMessage Get() { ... }
}
```
 
## <a name="ensure-that-communication-to-azure-cache-for-redis-is-over-tls"></a><a id="redis-ssl"></a>Убедитесь, что обмен данными с кэшем Azure для Redis осуществляется по протоколу TLS.

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Кэш Redis для Azure | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | Универсальный шаблон |
| **Атрибуты**              | Недоступно  |
| **Справочные материалы**              | [Поддержка Azure Redis TLS](../../azure-cache-for-redis/cache-faq.md) |
| **Шаги** | Сервер Redis не поддерживает протокол TLS, а кэш Azure для Redis —. Если вы подключаетесь к кэшу Azure для Redis и ваш клиент поддерживает протокол TLS, например StackExchange.Redis, то следует использовать TLS. По умолчанию порт, отличный от TLS, отключен для нового кэша Azure для экземпляров Redis. Убедитесь, что параметры безопасности по умолчанию не изменяются, пока не будет определена зависимость от поддержки TLS для клиентов Redis. |

Обратите внимание, что Redis рассчитан на доступ доверенных клиентов в надежных средах. Поэтому мы не рекомендуем предоставлять доступ к экземпляру Redis непосредственно через Интернет или в средах, где к TCP-порту или сокету UNIX Redis могут напрямую подключиться ненадежные клиенты. 

## <a name="secure-device-to-field-gateway-communication"></a><a id="device-field"></a>Защитите подключение между устройством и полевым шлюзом

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Полевой шлюз Интернета вещей | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | Универсальный шаблон |
| **Атрибуты**              | Недоступно  |
| **Справочные материалы**              | Недоступно  |
| **Шаги** | Как правило, устройства на основе IP-адресов должны использовать протоколы связи, доступные через канал SSL/TLS. Это позволяет защитить данные при передаче. Для всех остальных протоколов, не поддерживающих SSL/TLS, выберите безопасную версию протокола, обеспечивающего безопасность на уровне транспорта или сообщения. |

## <a name="secure-device-to-cloud-gateway-communication-using-ssltls"></a><a id="device-cloud"></a>Защитите подключение между устройством и облачным шлюзом с помощью SSL/TLS

| Title                   | Сведения      |
| ----------------------- | ------------ |
| **Компонент**               | Облачный шлюз Интернета вещей | 
| **Этап SDL**               | Сборка |  
| **Применимые технологии** | Универсальный шаблон |
| **Атрибуты**              | Недоступно  |
| **Справочные материалы**              | [Выбор протокола связи](../../iot-hub/iot-hub-devguide.md) |
| **Шаги** | Защитите протоколы HTTP/AMQP или MQTT с помощью SSL/TLS. |