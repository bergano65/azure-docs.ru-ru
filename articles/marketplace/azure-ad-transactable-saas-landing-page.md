---
title: Создание целевой страницы для вашего предложения SaaS в коммерческом магазине
description: Узнайте, как создать целевую страницу для предложения SaaS на языке Transact.
author: mingshen-ms
ms.author: mingshen
ms.reviewer: dannyevers
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: how-to
ms.date: 09/02/2020
ms.openlocfilehash: d4c23e6b213c102813758742b8d191735207d285
ms.sourcegitcommit: 857859267e0820d0c555f5438dc415fc861d9a6b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2020
ms.locfileid: "93124906"
---
# <a name="build-the-landing-page-for-your-transactable-saas-offer-in-the-commercial-marketplace"></a>Создание целевой страницы для вашего предложения SaaS в коммерческом магазине

В этой статье описывается процесс создания целевой страницы для приложения SaaS, которое будет продано в коммерческом магазине Майкрософт.

## <a name="overview"></a>Обзор

Целевую страницу можно представить как "зал ожидания" для предложения SaaS (программное обеспечение как услуга). Когда покупатель подписывается на предложение, коммерческий магазин направляет его на целевую страницу, чтобы активировать и настроить свою подписку на приложение SaaS. Это можно рассматривать как шаг подтверждения заказа, позволяющий покупателю узнать, что они приобрели, и подтвердить сведения об учетной записи. Используя Azure Active Directory (Azure AD) и Microsoft Graph, вы включите единый вход (SSO) для покупателя и получите важные сведения о покупателе, который можно использовать для подтверждения и активации подписки, включая их имя, адрес электронной почты и организацию.

Поскольку сведения, необходимые для активации подписки, ограничены и предоставляются Azure AD и Microsoft Graph, не нужно запрашивать сведения, требующие более простого согласия. Если вам нужны сведения о пользователе, требующие дополнительного согласия для вашего приложения, необходимо запросить эту информацию после завершения активации подписки. Это позволяет активировать беспроблемную подписку для покупателя и снизить риск отказа.

Целевая страница обычно включает в себя следующее:

- Представьте название предложения и план приобретения, а также условия выставления счетов.
- Предоставление сведений об учетной записи покупателя, включая имя, фамилию, организацию и адрес электронной почты.
- Предложить покупателю подтвердить или заменить другие сведения об учетной записи.
- Руководство по покупателю на следующих шагах после активации. Например, получите приветственное сообщение электронной почты, Управляйте подпиской, получите поддержку или ознакомьтесь с документацией.

> [!NOTE]
> Покупатель также будет перенаправлен на целевую страницу при управлении подпиской после активации. После активации подписки покупателя необходимо использовать единый вход, чтобы разрешить пользователю выполнять вход. Рекомендуется направить пользователя на профиль учетной записи или страницу конфигурации.

В следующих разделах описывается процесс создания целевой страницы.

1. [Создайте регистрацию приложения Azure AD](#create-an-azure-ad-app-registration) для целевой страницы.
1. [Используйте пример кода в качестве отправной точки](#use-a-code-sample-as-a-starting-point) для приложения.
1. [Используйте два приложения Azure AD для повышения безопасности в рабочей среде](#use-two-azure-ad-apps-to-improve-security-in-production).
1. [Разрешите маркер идентификации покупки Marketplace](#resolve-the-marketplace-purchase-identification-token) , добавленный в URL-адрес коммерческого рынка.
1. [Чтение сведений из утверждений, закодированных в маркере идентификации](#read-information-from-claims-encoded-in-the-id-token), который был получен от Azure AD после входа, отправленного с запросом.
1. При необходимости [Используйте API Microsoft Graph](#use-the-microsoft-graph-api) для сбора дополнительных сведений.

## <a name="create-an-azure-ad-app-registration"></a>Создание регистрации приложения Azure AD

Коммерческий рынок полностью интегрирован с Azure AD. Покупатели поступают в Marketplace, прошедшем проверку подлинности с помощью [учетной записи Azure AD или учетная запись Майкрософт (MSA)](../active-directory/fundamentals/active-directory-whatis.md#terminology). После приобретения покупатель поступает из коммерческого рынка в URL-адрес целевой страницы для активации и управления подпиской приложения SaaS. Вы должны предоставить покупателю возможность входа в приложение с помощью единого входа Azure AD. (URL-адрес целевой страницы указан на странице [технической настройки](plan-saas-offer.md#technical-information) предложения.

Первый шаг к использованию удостоверения заключается в том, чтобы убедиться, что Целевая страница зарегистрирована как приложение Azure AD. Регистрация приложения позволяет использовать Azure AD для проверки подлинности пользователей и запроса доступа к ресурсам пользователей. Оно может рассматриваться как определение приложения, которое позволяет службе определять, как выдавать маркеры приложению в зависимости от параметров приложения.

### <a name="register-a-new-application-using-the-azure-portal"></a>Регистрация нового приложения с помощью портала Azure

Чтобы приступить к работе, следуйте инструкциям по [регистрации нового приложения](../active-directory/develop/quickstart-register-app.md). Чтобы позволить пользователям из других компаний посетить приложение, необходимо выбрать один из вариантов для клиентов, которые могут использовать приложение.

Если вы собираетесь запросить API Microsoft Graph, [Настройте новое приложение для доступа к веб-API](../active-directory/develop/quickstart-configure-app-access-web-apis.md). При выборе разрешений API для этого приложения значение по умолчанию " **пользователь. чтение** " достаточно для сбора основных сведений о покупателе, чтобы процесс адаптации был гладким и автоматическим. Не запрашивать разрешения API с меткой **"требуется согласие администратора"** , так как это позволит всем пользователям, не являющимся администраторами, посетить целевую страницу.

Если вам требуются повышенные разрешения в процессе адаптации или подготовки, рассмотрите возможность использования функции [добавочного согласия](../active-directory/azuread-dev/azure-ad-endpoint-comparison.md) Azure AD, чтобы все покупатели, отправленные из Marketplace, могли изначально взаимодействовать с целевой страницей.

## <a name="use-a-code-sample-as-a-starting-point"></a>Использование примера кода в качестве отправной точки

Мы предоставили несколько примеров приложений, которые реализуют простой веб-сайт с включенным именем входа Azure AD. После регистрации приложения в Azure AD в колонке **Краткое руководство** предлагается список распространенных типов приложений и стеков разработки, как показано на рис. 1. Выберите тот, который соответствует вашей среде, и следуйте инструкциям по скачиванию и настройке.

**_Рис. 1. колонка краткого руководства в портал Azure_* _

:::image type="content" source="./media/azure-ad-saas/azure-ad-quickstart-blade.png" alt-text="В этой статье показана колонка быстрый запуск в портал Azure.":::

После загрузки кода и настройки среды разработки измените параметры конфигурации в приложении, чтобы они отражали идентификатор приложения, идентификатор клиента и секрет клиента, записанные в предыдущей процедуре. Обратите внимание, что точные шаги будут отличаться в зависимости от используемого примера.

## <a name="use-two-azure-ad-apps-to-improve-security-in-production"></a>Использование двух приложений Azure AD для повышения безопасности в рабочей среде

В этой статье представлена упрощенная версия архитектуры для реализации целевой страницы для предложения SaaS коммерческого рынка. При запуске страницы в рабочей среде рекомендуется повысить безопасность, взаимодействующую с API-интерфейсами выполнения SaaS только через другое защищенное приложение. Для этого необходимо создать два новых приложения:

- Во-первых, приложение для создания многоклиентской страницы, описанное в этой точке, за исключением функций для обращения к API-интерфейсам выполнения SaaS. Эта функция будет разгружаться в другое приложение, как описано ниже.
- Во-вторых, приложение для взаимодействия с API-интерфейсами выполнения SaaS. Это приложение должно быть единственным клиентом, предназначенным только для Организации, и можно установить список управления доступом, чтобы ограничить доступ к API только из этого приложения.

Это позволяет решению работать в сценариях, которые наблюдают принцип [разделения проблем](/dotnet/architecture/modern-web-apps-azure/architectural-principles#separation-of-concerns) . Например, Целевая страница использует первое зарегистрированное приложение Azure AD для входа пользователя. После входа пользователя Целевая страница использует второй Azure AD для запроса маркера доступа для вызова API-интерфейса выполнения SaaS и вызова операции разрешения.

## <a name="resolve-the-marketplace-purchase-identification-token"></a>Разрешение маркера идентификации покупки Marketplace

Когда покупатель отправляется на целевую страницу, в параметр URL-адреса добавляется маркер. Этот маркер отличается от токена, выданного Azure AD, и маркера доступа, используемого для проверки подлинности между службами, и используется в качестве входных данных для [API-интерфейсов выполнения SaaS](./partner-center-portal/pc-saas-fulfillment-api-v2.md#resolve-a-purchased-subscription) , чтобы получить сведения о подписке. Как и все вызовы API-интерфейсов выполнения SaaS, запрос между службами будет проходить проверку подлинности с помощью маркера доступа, основанного на пользовательском ИДЕНТИФИКАТОРе приложения Azure AD для проверки подлинности между службами.

> [!NOTE]
> В большинстве случаев предпочтительнее сделать этот вызов из второго приложения с одним клиентом. См. статью [использование двух приложений Azure AD для повышения безопасности в рабочей среде](#use-two-azure-ad-apps-to-improve-security-in-production) выше.

### <a name="request-an-access-token"></a>Запрос маркера доступа

Для проверки подлинности приложения с помощью API-интерфейсов выполнения SaaS необходим маркер доступа, который можно создать, вызвав конечную точку OAuth Azure AD. См. раздел [как получить маркер авторизации издателя](./partner-center-portal/pc-saas-registration.md#how-to-get-the-publishers-authorization-token).

### <a name="call-the-resolve-endpoint"></a>Вызов конечной точки разрешения

Интерфейсы API выполнения SaaS реализуют конечную точку [разрешения](./partner-center-portal/pc-saas-fulfillment-api-v2.md#resolve-a-purchased-subscription) , которую можно вызвать, чтобы подтвердить допустимость токена Marketplace и получить сведения о подписке.

## <a name="read-information-from-claims-encoded-in-the-id-token"></a>Чтение сведений из утверждений, закодированных в маркере идентификации

В рамках потока [подключения OpenID Connect](../active-directory/develop/v2-protocols-oidc.md) Azure AD добавляет [маркер идентификации](../active-directory/develop/id-tokens.md) в запрос при отправке покупателю на целевую страницу. Этот маркер содержит несколько частей основных сведений, которые могут быть полезны в процессе активации, включая сведения, приведенные в этой таблице.

| Значение | Описание |
| ------------ | ------------- |
| aud | Предполагаемая аудитория для этого маркера. В этом случае оно должно соответствовать ИДЕНТИФИКАТОРу приложения и быть проверено. |
| preferred_username | Первичное имя пользователя для посещения. Это может быть адрес электронной почты, номер телефона или другой идентификатор. |
| электронная почта | Адрес электронной почты пользователя. Обратите внимание, что это поле может быть пустым. |
| name | Удобное для восприятия значение, идентифицирующее тему маркера. В этом случае это будет имя покупателя. |
| oid | Идентификатор в системе идентификации Майкрософт, однозначно определяющий пользователя в разных приложениях. Microsoft Graph вернет это значение в качестве свойства идентификатора для данной учетной записи пользователя. |
| tid | Идентификатор, представляющий клиент Azure AD, с которого связан покупатель. В случае с идентификатором MSA это всегда будет ``9188040d-6c67-4c5b-b112-36a304b66dad`` . Дополнительные сведения см. в примечании в следующем разделе: использование API Microsoft Graph. |
| sub | Идентификатор, который уникальным образом идентифицирует пользователя в этом конкретном приложении. |
|||

## <a name="use-the-microsoft-graph-api"></a>Использование API Microsoft Graph

Маркер идентификации содержит основные сведения для идентификации покупателя, но процесс активации может потребовать дополнительных сведений, например компании-покупателю, для завершения процесса адаптации. Используйте [API Microsoft Graph](/graph/use-the-api) , чтобы запросить эти сведения, чтобы не принуждать пользователя к повторному вводу этих сведений. Стандартные разрешения _ *пользователя. Read* * по умолчанию включают в себя следующие сведения.

| Значение | Описание |
| ------------ | ------------- |
| displayName | Имя, отображаемое в адресной книге для пользователя. |
| givenName | Имя пользователя. |
| jobTitle | Должность пользователя. |
| mail | SMTP-адрес пользователя. |
| mobilePhone | Основной номер сотового телефона для пользователя. |
| preferredLanguage | Код ISO 639-1 для предпочтительного языка пользователя. |
| surname | Фамилия пользователя. |
|||

Дополнительные свойства, например имя компании пользователя или расположение пользователя (страна), можно выбрать для включения в запрос. Дополнительные сведения см. [в разделе Свойства типа ресурса "пользователь"](/graph/api/resources/user?view=graph-rest-1.0#properties) .

Большинство приложений, зарегистрированных в Azure AD, предоставляют делегированные разрешения на чтение сведений о пользователе из клиента Azure AD своей компании. Любой запрос на Microsoft Graph для этой информации должен сопровождаться маркером доступа для проверки подлинности. Конкретные действия по созданию маркера доступа будут зависеть от используемого стека технологий, но пример кода будет содержать пример. Дополнительные сведения см. [в разделе Получение доступа от имени пользователя](/graph/auth-v2-user).

> [!NOTE]
> Учетные записи клиента MSA (с ИДЕНТИФИКАТОРом клиента ``9188040d-6c67-4c5b-b112-36a304b66dad`` ) не будут возвращать больше информации, чем уже были собраны с маркером идентификатора. Поэтому этот вызов можно пропустить в API Graph для этих учетных записей.

## <a name="next-steps"></a>Дальнейшие действия

- [Создание предложения SaaS в коммерческом магазине](create-new-saas-offer.md)