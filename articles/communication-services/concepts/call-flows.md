---
title: Потоки вызовов в Службах коммуникации Azure
titleSuffix: An Azure Communication Services concept document
description: Сведения о потоках вызовов в Службах коммуникации Azure.
author: mikben
manager: jken
services: azure-communication-services
ms.author: mikben
ms.date: 09/30/2020
ms.topic: overview
ms.service: azure-communication-services
ms.openlocfilehash: 9fe5cb13ee352b2c49ab6ae57cabd6116cdfa720
ms.sourcegitcommit: eb6bef1274b9e6390c7a77ff69bf6a3b94e827fc
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/05/2020
ms.locfileid: "91667679"
---
# <a name="call-flows"></a>Потоки вызовов

[!INCLUDE [Public Preview Notice](../includes/public-preview-include.md)]

В следующем разделе содержатся общие сведения о потоках вызовов в Службах коммуникации Azure. Потоки сигнализации и мультимедиа могут быть разными в зависимости от типов вызовов, которые совершают ваши пользователи. Например, это могут быть голосовые вызовы через IP (VoIP) "один к одному", ТСОП "один к одному" или групповые вызовы с разными сочетаниями подключений по VoIP и ТСОП. Изучите раздел [Типы вызовов](./voice-video-calling/about-call-types.md).

## <a name="about-signaling-and-media-protocols"></a>О протоколах сигнализации и передачи мультимедиа

При установке одиночного или группового вызова используются два протокола: HTTP (REST) для сигнализации и SRTP для передачи мультимедиа. 

Сигнализация между клиентскими библиотеками и (или) контроллерами сигнализации Служб коммуникации осуществляется по протоколу HTTP REST (TLS). Мультимедийный трафик в реальном времени (RTP) передается преимущественно по протоколу UDP. Если использование UDP запрещено брандмауэром, клиентская библиотека будет использовать протокол TCP для передачи мультимедиа. 

Давайте рассмотрим протоколы сигнализации и передачи мультимедиа в разных сценариях. 

## <a name="call-flow-cases"></a>Примеры потока вызовов

### <a name="case-1-voip-where-a-direct-connection-between-two-devices-is-possible"></a>Вариант 1. VoIP с возможностью прямого подключения между двумя устройствами

При вызове VoIP или видеовызове "один к одному" трафик передается по самому прямому пути. Прямой путь здесь означает, что если две клиентские библиотеки могут обращаться друг к другу напрямую, они всегда будут устанавливать прямое соединение. Обычно это возможно, если две клиентские библиотеки находятся в одной подсети (например, в подсети 192.168.1.0/24) или если устройства находятся в подсетях, которые могут видеть друг друга (в нашем примере это клиентские библиотеки в подсетях 10.10.0.0/16 и 192.168.1.0/24).

:::image type="content" source="./media/call-flows/about-voice-case-1.png" alt-text="Схема, демонстрирующая прямой вызов VoIP между пользователями и Службами коммуникации.":::

### <a name="case-2-voip-where-a-direct-connection-between-devices-is-not-possible-but-where-connection-between-nat-devices-is-possible"></a>Вариант 2. VoIP с отсутствием возможности прямого подключения между устройствами, но с возможностью подключения между устройствами NAT

Если два устройства находятся в подсетях, которые не видят друг друга (например, если Анна работает в кафе, а Олег дома), но возможно подключение между соответствующими устройствами NAT, клиентские библиотеки на стороне клиента будут использовать подключение через устройства NAT. 

Для Анны это устройство NAT в кафе, а для Олега — устройство NAT дома. Устройства Анны и Олега обменяются внешними адресами своих устройств NAT. Клиентские библиотеки узнают свои внешние адреса из службы STUN, которую Службы коммуникации Azure предоставляют бесплатно. Логика обработки подтверждения между устройствами Анны и Олега внедрена в клиентские библиотеки, предоставляемые Службой коммуникации Azure. (Дополнительная настройка не требуется.)

:::image type="content" source="./media/call-flows/about-voice-case-2.png" alt-text="Схема, демонстрирующая прямой вызов VoIP между пользователями и Службами коммуникации.":::

### <a name="case-3-voip-where-neither-a-direct-nor-nat-connection-is-possible"></a>Случай 3. VoIP с невозможностью подключения напрямую или через NAT

Если одно из клиентских устройств или оба они размещены за симметричным NAT, требуется отдельная облачная служба для ретрансляции мультимедиа между двумя клиентскими библиотеками. Для этого Службы коммуникации также предоставляют службу TURN. В клиентской библиотеке, которая обращается к Службам коммуникации, служба TURN применяется автоматически с учетом обнаруженных сетевых требований. Использование службы TURN от Майкрософт оплачивается отдельно.

:::image type="content" source="./media/call-flows/about-voice-case-3.png" alt-text="Схема, демонстрирующая прямой вызов VoIP между пользователями и Службами коммуникации.":::
 
### <a name="case-4-group-calls-with-pstn"></a>Вариант 4. Групповые вызовы через ТСОП

Как сигнализация, так и передача мультимедиа для вызовов ТСОП передаются через ресурс телефонии Служб коммуникации Azure. Этот ресурс взаимосвязан с другими операторами.

Поток мультимедийного трафика ТСОП проходит через специальный компонент — обработчик мультимедиа.

:::image type="content" source="./media/call-flows/about-voice-pstn.png" alt-text="Схема, демонстрирующая прямой вызов VoIP между пользователями и Службами коммуникации.":::

> [!NOTE]
> Наш обработчик мультимедиа является одновременно и агентом B2BUA, как определено в стандарте [RFC 3261 SIP о протоколе инициации сеанса](https://tools.ietf.org/html/rfc3261) (информация для тех, кто знаком с обработкой мультимедиа). Это означает, что он может выполнять преобразование кодеков при обработке вызовов между сетями Майкрософт и других операторов. Контроллер сигнализации Служб коммуникации Azure — это реализация прокси-сервера SIP согласно тому же стандарту RFC от Майкрософт.

Для групповых вызовов потоки мультимедиа и сигнализация всегда проходят через серверную часть Служб коммуникации Azure. Аудио и (или) видео от всех участников объединяются в обработчике мультимедиа. Все участники группового вызова отправляют аудио- и (или) видеопотоки в обработчик мультимедиа, а он возвращает им объединенные потоки мультимедиа.

По умолчанию в качестве протокола реального времени (RTP) для групповых вызовов используется UDP.

> [!NOTE]
> Обработчик мультимедиа может выполнять роль MCU или SFU.

:::image type="content" source="./media/call-flows/about-voice-group-calls.png" alt-text="Схема, демонстрирующая прямой вызов VoIP между пользователями и Службами коммуникации.":::

Если клиентская библиотека не может использовать UDP для передачи мультимедиа из-за ограничений брандмауэра, будет предпринята попытка использовать протокол TCP. Обратите внимание, что обработчик мультимедиа работает с UDP, поэтому в описанном выше случае с групповым вызовом включается служба TURN из Служб коммуникации, которая будет выполнять преобразование из TCP в UDP. В этом случае будет взиматься плата за службу TURN, если вы не отключите ее вручную.

:::image type="content" source="./media/call-flows/about-voice-group-calls-2.png" alt-text="Схема, демонстрирующая прямой вызов VoIP между пользователями и Службами коммуникации.":::

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Начало работы с вызовами](../quickstarts/voice-video-calling/getting-started-with-calling.md)

Вас могут заинтересовать следующие документы:

- Дополнительные сведения о [типах вызовов](../concepts/voice-video-calling/about-call-types.md).
- Сведения об [архитектуре "клиент — сервер"](./client-and-server-architecture.md)
