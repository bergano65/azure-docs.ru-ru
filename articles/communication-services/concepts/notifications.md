---
title: Уведомления в Службах коммуникации Azure
titleSuffix: An Azure Communication Services concept document
description: Отправка уведомлений пользователям приложений, созданных на основе Служб коммуникации Azure.
author: mikben
manager: jken
services: azure-communication-services
ms.author: mikben
ms.date: 09/30/2020
ms.topic: overview
ms.service: azure-communication-services
ms.openlocfilehash: d2b77708609f61eeb4ce33148f020027d646836b
ms.sourcegitcommit: 1140ff2b0424633e6e10797f6654359947038b8d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/30/2020
ms.locfileid: "97813604"
---
# <a name="communication-services-notifications"></a>Уведомления в Службах коммуникации

[!INCLUDE [Public Preview Notice](../includes/public-preview-include.md)]

Чат в Службах коммуникации Azure и вызов клиентских библиотек создают канал обмена сообщениями в режиме реального времени, который позволяет эффективно и надежно передавать сообщения в подключенные клиенты. Это позволяет создавать расширенные возможности взаимодействия в режиме реального времени в приложениях без необходимости реализации сложной логики опроса HTTP. Однако в мобильных приложениях этот сигнальный канал остается подключенным только тогда, когда приложение активно на переднем плане. Если вы хотите, чтобы пользователи получали входящие вызовы или сообщения чата, пока приложение находится в фоновом режиме, следует использовать push-уведомления.

Push-уведомления позволяют отправлять данные из приложения на мобильные устройства пользователей. Push-уведомления можно использовать для отображения диалогового окна, воспроизведения звука или отображения входящего вызова. Службы коммуникации Azure обеспечивают интеграцию со службой [Сетка событий Azure](../../event-grid/overview.md) и [Центрами уведомлений Azure](../../notification-hubs/notification-hubs-push-notification-overview.md), которые позволяют добавлять push-уведомления в приложения.

## <a name="trigger-push-notifications-via-azure-event-grid"></a>Активация push-уведомлений с помощью службы "Сетка событий Azure"

Службы коммуникации Azure интегрируются со службой [Сетка событий Azure](https://azure.microsoft.com/services/event-grid/), чтобы получать уведомления о событиях в реальном времени в надежном, безопасном режиме с возможностью масштабирования. Эту интеграцию можно использовать для создания службы уведомлений, которая предоставляет пользователям мобильные push-уведомления, создав подписку на службу "Сетка событий", которая активирует [Функцию Azure](../../azure-functions/functions-overview.md) или веб-перехватчик.

:::image type="content" source="./media/notifications/acs-events-int.png" alt-text="Диаграмма, на которой показано, как Службы коммуникации интегрируются со службой &quot;Сетка событий&quot;.":::

Дополнительные сведения об обработке событий в Службах коммуникации Azure см. [здесь](./event-handling.md).

## <a name="deliver-push-notifications-via-azure-notification-hubs"></a>Доставка push-уведомлений с помощью Центров уведомлений Azure

Центр уведомлений Azure можно подключить к ресурсу Служб коммуникации, чтобы автоматически отправлять push-уведомления на мобильное устройство пользователя при получении входящего вызова. Эти push-уведомления следует использовать для пробуждения приложения из фонового режима и отображения интерфейса пользователя, благодаря чему пользователь может принять или отклонить вызов. 

:::image type="content" source="./media/notifications/acs-anh-int.png" alt-text="Схема интеграции Службы коммуникации с Центрами уведомлений Azure":::

Службы коммуникации используют Центр уведомлений Azure в качестве сквозной службы для взаимодействия с различными службами push-уведомлений, соответствующих для конкретных платформ, с помощью API-интерфейса [Direct Send](/rest/api/notificationhubs/direct-send). Это позволяет повторно использовать имеющиеся ресурсы и конфигурации Центра уведомлений Azure, чтобы обеспечить низкую задержку и надежный вызов уведомлений для приложений.

> [!NOTE]
> Сейчас поддерживаются только push-уведомления о вызовах.

### <a name="notification-hub-provisioning"></a>Подготовка Центра уведомлений 

Чтобы доставить push-уведомления на клиентские устройства с помощью Центров уведомлений, [создайте Центр уведомлений](../../notification-hubs/create-notification-hub-portal.md) в той же подписке, что и ресурс Служб коммуникации. Центры уведомлений необходимо настроить для требуемой системы отправки уведомлений платформы. Сведения о том, как получать push-уведомления в клиентское приложение из Центров уведомлений, см. в статье [Начало работы с Центрами уведомлений для приложений универсальной платформы Windows](../../notification-hubs/notification-hubs-android-push-notification-google-fcm-get-started.md). Вы также можете выбрать целевую клиентскую платформу из раскрывающегося списка в верхней части страницы.

> [!NOTE]
> Сейчас поддерживаются платформы APNs и FCM.  
Платформу APNs нужно настроить в режиме аутентификации по токену. Режим аутентификации по сертификату сейчас не поддерживается. 

После настройки Центра уведомлений его можно связать с ресурсом Служб коммуникации, указав строку подключения для Центра с помощью клиента Azure Resource Manager или с помощью портала Azure. Строка подключения должна содержать разрешения `Send`. Рекомендуем вам создать отдельную политику доступа только с разрешениями `Send` для своего центра. Дополнительные сведения о политиках безопасности и доступа к Центрам уведомлений см. [здесь](../../notification-hubs/notification-hubs-push-notification-security.md).

#### <a name="using-the-azure-resource-manager-client-to-link-your-notification-hub"></a>Связывание центра уведомлений с помощью клиента Azure Resource Manager

Чтобы войти в Azure Resource Manager, выполните следующую процедуру и войдите с использованием своих учетных данных.

```console
armclient login
```

 После успешного входа выполните следующую команду для подготовки Центра уведомлений:

```console
armclient POST /subscriptions/<sub_id>/resourceGroups/<resource_group>/providers/Microsoft.Communication/CommunicationServices/<resource_id>/linkNotificationHub?api-version=2020-08-20-preview "{'connectionString': '<connection_string>','resourceId': '<resource_id>'}"
```

#### <a name="using-the-azure-portal-to-link-your-notification-hub"></a>Связывание центра уведомлений с помощью портала Azure

На портале перейдите к ресурсу Служб коммуникации Azure. В ресурсе Служб коммуникации выберите "Push-уведомления" в меню слева на странице Служб коммуникации и подключитесь к Центру уведомлений, подготовленному ранее. Вам потребуется указать строку подключения и идентификатор ресурса:

:::image type="content" source="./media/notifications/acs-anh-portal-int.png" alt-text="Настройки push-уведомлений на портале Azure":::

> [!NOTE]
> Если строка подключения к концентратору уведомлений Azure обновляется, необходимо также обновить ресурс Служб коммуникации.  
Любое изменение, касающееся подключения концентратора, отразится в плоскости данных (т. е. при отправке уведомления) в течение максимум ``10`` минут. Это касается и тех случаев, когда подключение к концентратору устанавливается впервые, **если** перед этим были отправлены уведомления.

### <a name="device-registration"></a>Регистрация устройства 

Сведения о регистрации маркера устройств в Службах коммуникации см. в [кратком руководстве по голосовым вызовам](../quickstarts/voice-video-calling/getting-started-with-calling.md).

### <a name="troubleshooting-guide-for-push-notifications"></a>Руководство по устранению неполадок с push-уведомлениями

Если push-уведомления не приходят на устройство, причину этого нужно искать в одной из трех областей:

- уведомления не поступают из Служб коммуникации в Центры уведомлений;
- система отправки уведомлений платформы (например, APNs или FCM) не принимает их из Центров уведомлений Azure;
- система отправки уведомлений платформы не доставляет уведомления на устройство.

Возможные причины потери уведомлений в первой области (Службы коммуникации — Центры уведомлений) рассмотрены ниже, а на в двух других — в статье [Диагностика причин потери уведомлений в Центрах уведомлений Azure](../../notification-hubs/notification-hubs-push-notification-fixer.md).

Один из способов проверить, отправляет ли ресурс Служб коммуникации уведомления в Центры уведомлений, — проверить метрику `incoming messages` в [метриках связанного центра уведомлений](../../azure-monitor/platform/metrics-supported.md#microsoftnotificationhubsnamespacesnotificationhubs).

Ниже перечислены некоторые распространенные ошибки конфигурации, из-за которых уведомления не поступают из Служб коммуникации в связанный центр уведомлений.

#### <a name="azure-notification-hub-not-linked-to-the-communication-services-resource"></a>Центр уведомлений Azure не связан со Службами коммуникации

Возможно, вы не связали свой центр уведомлений Azure с ресурсом Служб коммуникации. Сведения о том, как это сделать, см. в разделе [Подготовка центра уведомлений](#notification-hub-provisioning).

#### <a name="the-linked-azure-notification-hub-isnt-configured"></a>Связанный центр уведомлений Azure не настроен

Вам необходимо настроить связанный центр уведомлений, используя учетные данные системы отправки уведомлений платформы для платформы, которую вы хотите использовать (например, iOS или Android). Сведения о том, как это сделать, см. в [кратком руководстве по настройке push-уведомлений в центре уведомлений](../../notification-hubs/configure-notification-hub-portal-pns-settings.md).

#### <a name="the-linked-azure-notification-hub-doesnt-exist"></a>Отсутствует связанный центр уведомлений Azure

Центр уведомлений Azure, связанный с вашим ресурсом Служб коммуникации, больше не существует. Проверьте наличие связанного центра уведомлений.

#### <a name="the-azure-notification-hub-apns-platform-is-configured-with-certificate-authentication-mode"></a>Служба push-уведомлений Apple настроена для работы с центром уведомлений Azure в режиме аутентификации по сертификату

Работа с платформой APNs в режиме аутентификации по сертификату сейчас не поддерживается. Платформу APNs нужно настроить в режиме аутентификации по токену, как описано в [кратком руководстве по настройке push-уведомлений в центре уведомлений](../../notification-hubs/configure-notification-hub-portal-pns-settings.md).

#### <a name="the-linked-connection-string-doesnt-have-send-permission"></a>Строка подключения не имеет разрешения `Send`

Для строки подключения, используемой для связывания центра уведомлений с ресурсом Служб коммуникации, необходимо разрешение `Send`. Дополнительные сведения о том, как добавить новую строку подключения или просмотреть текущую в центре уведомлений Azure, см. в статье о [политиках безопасности и доступа в Центрах уведомлений](../../notification-hubs/notification-hubs-push-notification-security.md).

#### <a name="the-linked-connection-string-or-azure-notification-hub-resourceid-arent-valid"></a>Недействительная строка подключения или идентификатор ресурса для связанного центра уведомлений

Убедитесь, что в настройках ресурса Служб коммуникации правильно указана строка подключения и идентификатор ресурса для центра уведомлений.

#### <a name="the-linked-connection-string-is-regenerated"></a>Строка подключения была создана повторно

Если вы повторно создали строку подключения к связанному центру уведомлений Azure, ее необходимо обновить в настройках ресурса Служб коммуникации, как описано в разделе о [повторном связывании центра уведомлений](#notification-hub-provisioning).

## <a name="next-steps"></a>Дальнейшие действия

* См. общие сведения о [службе "Сетка событий Azure"](../../event-grid/overview.md).
* Дополнительные сведения о концепциях Центра уведомлений Azure см. в статье [Документация по Центрам уведомлений Azure](../../notification-hubs/index.yml).