---
title: Перемещение ресурсов SQL Azure между регионами с помощью Azure Resource Mover
description: Сведения о перемещении ресурсов SQL Azure в другой регион с помощью Azure Resource Mover
author: rayne-wiselman
manager: evansma
ms.service: resource-move
ms.topic: tutorial
ms.date: 09/09/2020
ms.author: raynew
ms.custom: mvc
ms.openlocfilehash: 0718151039d88ffb76a07ce082c08fb011dab88b
ms.sourcegitcommit: 3be3537ead3388a6810410dfbfe19fc210f89fec
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2020
ms.locfileid: "89652519"
---
# <a name="tutorial-move-azure-sql-database-resources-to-another-region"></a>Руководство по Перемещение ресурсов Базы данных SQL Azure в другой регион

В этом руководстве описано, как перемещать базы данных SQL Azure и эластичные пулы в другой регион Azure с помощью [Azure Resource Mover](overview.md).

> [!NOTE]
> Azure Resource Mover сейчас поддерживается в предварительной версии.

В этом руководстве описано следующее:

> [!div class="checklist"]
> * Проверка предварительных требований.
> * Выбор ресурсов, которые требуется переместить.
> * Разрешение зависимостей ресурсов.
> * Подготовка и перемещение SQL Server в целевой регион.
> * Подготовка и перемещение баз данных и эластичных пулов.
> * Отмена и фиксация перемещения. 
> * Удаление ресурсов в исходном регионе после перемещения (при необходимости). 

> [!NOTE]
> В учебниках показан самый быстрый способ выполнения сценария и используются параметры по умолчанию. 

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу. Затем войдите на [портал Azure](https://portal.azure.com).

## <a name="prerequisites"></a>Предварительные требования

-  Убедитесь, что у вас есть доступ *владельца* в подписке, содержащей ресурсы, которые вы хотите переместить.
    - При первом добавлении ресурса для определенной пары источника и назначения в подписке Azure Resource Mover создает [управляемое удостоверение, назначаемое системой](../active-directory/managed-identities-azure-resources/overview.md#managed-identity-types) (ранее известное как управляемая службой идентификация (MSI)), которая является доверенной для подписки.
    - Чтобы создать удостоверение и назначить ему требуемую роль (участника или администратора доступа пользователя в исходной подписке), учетной записи, используемой для добавления ресурсов, требуются разрешения *владельца* в подписке. [Дополнительные сведения](../role-based-access-control/rbac-and-directory-admin-roles.md#azure-roles) о ролях Azure.
- Подписке требуется достаточный объем квот, чтобы создать ресурсы, перемещаемые в целевой регион. Если квота отсутствует, [запросите дополнительные ресурсы](/azure/azure-resource-manager/management/azure-subscription-service-limits).
- Проверьте цены в целевым регионе, в который вы перемещаете ресурсы. Оцените затраты с помощью [калькулятора цен](https://azure.microsoft.com/pricing/calculator/).
    

## <a name="check-sql-requirements"></a>Проверка требований SQL

1. [Проверьте](support-matrix-move-region-sql.md), какие компоненты базы данных и эластичного пула поддерживаются для перехода в другой регион.
2. В целевом регионе создайте целевой сервер для каждого исходного сервера. [Подробнее](/azure/azure-sql/database/active-geo-replication-security-configure#how-to-configure-logins-and-users).
4. Если базы данных зашифрованы с помощью прозрачного шифрования данных (TDE) и вы используете собственный ключ шифрования в Azure Key Vault, узнать, как переместить хранилища ключей в другой регион можно [здесь](../key-vault/general/move-region.md).
5. Если синхронизация данных SQL включена, то перемещение баз данных-участников поддерживается. После перемещения необходимо настроить синхронизацию данных SQL с новой целевой базой данных.
6. Перед перемещением удалите дополнительные параметры безопасности данных. После перемещения [настройте параметры](/azure/sql-database/sql-database-advanced-data-security) на уровне SQL Server в целевом регионе.
7. Если аудит включен, после перемещения политики сбрасываются до значений по умолчанию. После перемещения [настройте аудит](/azure/sql-database/sql-database-auditing) снова.
7. Политики хранения резервных копий для исходной базы данных переносятся в целевую базу данных. [Дополнительные сведения ](/azure/sql-database/sql-database-long-term-backup-retention-configure ) об изменении параметров после перемещения.
8. Перед перемещением удалите правила брандмауэра на уровне сервера. Правила брандмауэра уровня базы данных копируются с исходного сервера на целевой сервер во время перемещения. После перемещения [настройте правила брандмауэра](/azure/sql-database/sql-database-server-level-firewall-rule) для SQL Server в целевом регионе.
9. Перед перемещением удалите параметры автоматической настройки. [Настройте автоматическую настройку](/azure/sql-database/sql-database-automatic-tuning-enable) после перемещения.
10. Перед перемещением удалите параметры оповещений базы данных. Выполните [сброс](/azure/sql-database/sql-database-insights-alerts-portal) после перемещения.
    
## <a name="select-resources"></a>Выбор ресурсов

Выберите ресурсы, которые требуется переместить.

- В выбранном исходном регионе можно выбрать любой поддерживаемый тип ресурса в любой группе ресурсов.
- Ресурсы перемещаются в целевой регион в той же подписке, где расположен исходный регион. Если требуется изменить подписку, это можно сделать после перемещения ресурсов.

1. На портале Azure найдите и выберите *средство перемещения ресурсов*. Затем в разделе **Службы** выберите **Azure Resource Mover**.

     ![Результаты поиска средства перемещения ресурсов на портале Azure](./media/tutorial-move-region-sql/search.png)

2. В разделе **Обзор** нажмите кнопку **Начало работы**.

    ![Кнопка добавления ресурсов для перемещения в другой регион](./media/tutorial-move-region-sql/get-started.png)

3. В разделе **Перемещение ресурсов** > **Источник и назначение** выберите исходную подписку и регион.
4. В разделе **Назначение** выберите регион, в который необходимо переместить ресурсы. Затем нажмите кнопку **Далее**.
5. В разделе **Metadata region** (Регион метаданных) выберите место хранения метаданных ресурсов, которые вы перемещаете. Группа ресурсов создается специально для этой цели. Затем нажмите кнопку **Далее**.

    ![Страница для выбора исходного и целевого региона](./media/tutorial-move-region-sql/source-target.png)

6. В разделе **Перемещаемые ресурсы** выберите **Выбор ресурсов**.
7. В разделе **Выбор ресурсов** выберите ресурсы. Вы можете добавить только ресурсы, поддерживаемые для перемещения. Затем нажмите кнопку **Done**(Готово).

    ![Страница для выбора перемещаемых ресурсов SQL](./media/tutorial-move-region-sql/select-resources.png)

8. В разделе **Перемещаемые ресурсы** нажмите кнопку **Далее**.

9. В разделе **Просмотреть и добавить** проверьте параметры источника и назначения. Вы должны понимать, что перемещаемые метаданные будут храниться в группе ресурсов, созданной для этой цели в области метаданных.


    ![Страница просмотра параметров и сведений о выполнении перемещения](./media/tutorial-move-region-sql/review.png)

10. Нажмите кнопку **Продолжить**, чтобы приступить к добавлению ресурсов.
11. После успешного завершения процесса добавления в области уведомления выберите **Adding resources for move** (Добавление ресурсов для перемещения).
12. Щелкнув уведомление, изучите ресурсы на странице **Across regions** (Между регионами).


> [!NOTE]
> 
> - Теперь SQL Server находится в состоянии *ожидания ручного назначения*.
> - Другие добавленные ресурсы находятся в состоянии *ожидания подготовки*.
> - Если требуется удалить ресурс из перемещаемой коллекции, действия зависят от того, где происходит процесс перемещения. [Подробнее](remove-move-resources.md).

## <a name="resolve-dependencies"></a>Устранение ошибок, связанных с зависимостями


1. В разделе **Между регионами** если в списке ресурсов отображается сообщение *Validate dependencies* (Проверить зависимости) в столбце **Проблемы**, нажмите кнопку **Проверить зависимости**. Начнется процесс проверки.
2. Если зависимости обнаружены, выберите **Добавить зависимости**.

    ![Кнопка добавления зависимостей](./media/tutorial-move-region-sql/add-dependencies.png)
   
3. В разделе **Добавить зависимости** выберите зависимые ресурсы, а затем нажмите кнопку **Добавить зависимости**. Проверьте ход выполнения в области уведомлений.

4. При необходимости добавьте дополнительные зависимости и проверьте их снова. 

5. На странице **Across regions** (Между регионами) убедитесь, что ресурсы теперь находятся в состоянии *ожидания подготовки* без неполадок.

    ![Страница с ресурсами с состоянием ожидания подготовки](./media/tutorial-move-region-sql/prepare-pending.png)



## <a name="move-the-sql-server"></a>Перенос сервера SQL Server

Назначьте целевой SQL Server в целевом регионе и зафиксируйте перемещение.

### <a name="assign-a-target-sql-server"></a>Назначение целевого сервера SQL Server

1. В разделе **Между регионами**для ресурса SQL Server в столбце **Конфигурация назначения** выберите **Ресурс не назначен**.
2. Выберите существующий ресурс SQL Server в целевом регионе. 
    
    ![Запись, показывающая состояние SQL Server "Ожидание фиксации перемещения"](./media/tutorial-move-region-sql/sql-server-commit-move-pending.png) 

    
> [!NOTE]
> Состояние источника SQL Server меняется на *Ожидание фиксации перемещения*. 

### <a name="commit-the-sql-server-move"></a>Фиксация перемещения SQL Server

1. В разделе **Между регионами** выберите SQL Server, а затем щелкните **Фиксация**.
2. В разделе **Commit resources** (Фиксация ресурсов) нажмите кнопку **Зафиксировать**.

    ![Страница фиксации перемещения SQL Server](./media/tutorial-move-region-sql/commit-sql-server.png)

3. Отслеживать ход перемещения можно на панели уведомлений.

> [!NOTE]
> После фиксации SQL Server теперь находится в состоянии *ожидание удаления источника*.


## <a name="prepare-resources-to-move"></a>Добавление ресурсов для перемещения

После перемещения исходного SQL Server можно подготовиться к перемещению других ресурсов.

## <a name="prepare-an-elastic-pool"></a>Подготовка эластичного пула

1. В разделе **Между регионами** выберите исходный эластичный пул (demo-test1-elasticpool в нашем пошаговом руководстве), а затем щелкните **Подготовить**.

    ![Кнопка подготовки ресурсов](./media/tutorial-move-region-sql/prepare-elastic.png)

2. В разделе **Подготовка ресурсов** нажмите кнопку **Подготовить**.
3. Как только уведомления покажут, что процесс подготовки выполнен успешно, щелкните **Обновить**.

> [!NOTE]
> Теперь пул эластичных БД находится в состоянии *Ожидание начала перемещения*.

## <a name="prepare-a-single-database"></a>Подготовка отдельной базы данных

1. В разделе **Между регионами** выберите одну базу данных (не в эластичном пуле), а затем щелкните **Подготовить**.

    ![Кнопка подготовки выбранных ресурсов](./media/tutorial-move-region-sql/prepare-db.png)

2. В разделе **Подготовка ресурсов** нажмите кнопку **Подготовить**.
3. Как только уведомления покажут, что процесс подготовки выполнен успешно, щелкните **Обновить**.

> [!NOTE]
> Теперь база данных создана в целевом регионе и находится в состоянии *Ожидание начала перемещения*.


## <a name="move-the-pool-and-prepare-pool-databases"></a>Перемещение пула и подготовка баз данных пула

Чтобы подготовить базы данных в эластичном пуле, пул эластичных БД должен находиться в состоянии *Ожидание фиксации перемещения*. Чтобы перейти к этому состоянию, начните перемещение пула.

#### <a name="initiate-move---elastic-pool"></a>Начало перемещения — эластичный пул

1. В разделе **Между регионами** выберите исходный эластичный пул (demo-test1-elasticpool в нашем пошаговом руководстве), а затем щелкните **Начать перемещение**.
2. В разделе **Перемещение ресурсов** нажмите кнопку **Initiate move** (Начать перемещение).

    
    ![Кнопка начала перемещения пула эластичных БД](./media/tutorial-move-region-sql/initiate-elastic.png)

1. Отслеживать ход перемещения можно на панели уведомлений.
1. Когда уведомления покажут, что перемещение прошло успешно, щелкните **Обновить**.

> [!NOTE]
> Теперь пул эластичных БД находится в состоянии *Ожидание фиксации перемещения*.

#### <a name="prepare-database"></a>Подготовка базы данных

1. В разделе **Между регионами**выберите базу данных (demo-test2-sqldb в нашем пошаговом руководстве), а затем щелкните **Подготовить**.
2. В разделе **Подготовка ресурсов** нажмите кнопку **Подготовить**.

    ![Кнопка подготовки базы данных в эластичном пуле](./media/tutorial-move-region-sql/prepare-database-elastic.png) 

Во время подготовки в целевом регионе создается целевая база данных и начинается репликация данных. После подготовки база данных находится в состоянии *Ожидание начала перемещения*. 

![Кнопка подготовки выбранной базы данных в эластичном пуле](./media/tutorial-move-region-sql/initiate-move-pending.png) 

## <a name="move-databases"></a>Перемещение баз данных

Начните перемещение базы данных.
1. В разделе **Across regions** (Между регионами) выберите ресурсы с состоянием **ожидания начала перемещения**. Затем нажмите кнопку **Initiate move** (Начать перемещение).
2. В разделе **Перемещение ресурсов** нажмите кнопку **Initiate move** (Начать перемещение).

    ![Страница начала перемещения](./media/tutorial-move-region-sql/initiate-move.png)

3. Отслеживать ход перемещения можно на панели уведомлений.

> [!NOTE]
> Теперь базы данных находятся в состоянии *Ожидание фиксации перемещения*.


## <a name="discard-or-commit"></a>Отмена или фиксация

После первоначального перемещения нужно решить, следует ли фиксировать перемещение или отменить его. 

- **Отмена**. Если вы выполняете тестирование и не хотите фактически перемещать исходный ресурс, вы можете отменить перемещение. При отмене перемещения ресурс возвращается в состояние **ожидания начала перемещения**.
- **Фиксация**. Фиксация завершает перемещение в целевой регион. После фиксации исходный ресурс будет находиться в состоянии **ожидания удаления источника**. Затем вы можете его удалить.


## <a name="discard-the-move"></a>Отмена перемещения 

Вы можете отменить перемещение следующим образом:

1. В разделе **Across regions** (Между регионами) выберите ресурсы с состоянием **ожидания фиксации перемещения** и нажмите кнопку **Discard move** (Отменить перемещение).
2. В разделе **Discard move** (Отмена перемещения) нажмите кнопку **Отменить**.
3. Отслеживать ход перемещения можно на панели уведомлений.


> [!NOTE]
> - После отмены перемещения ресурсы находятся в состоянии *ожидания начала перемещения*.
> - Если имеется только эластичный пул, выполняется отмена и этот эластичный пул, созданный в целевом регионе, удаляется.
> - Если имеется эластичный пул со связанными базами данных в состоянии *Ожидание фиксации переноса*, то удалить такой эластичный пул невозможно.
> - Если вы отменяете базу данных SQL, ресурсы целевой области не удаляются. 

Если вы хотите снова начать перемещение после отмены, выберите базу данных SQL или эластичный пул и запустите перемещение еще раз.


## <a name="commit-the-move"></a>Фиксация перемещения

Завершите перемещения баз данных и эластичных пулов следующим образом.


1. Убедитесь, что SQL Server в состоянии *Ожидание удаления источника*.
2. Перед фиксацией обновите строки подключения к базе данных в целевом регионе.
3. В режиме **Между регионами** выберите ресурсы SQL, а затем щелкните **Фиксировать перемещение**.
4. В разделе **Commit resources** (Фиксация ресурсов) нажмите кнопку **Зафиксировать**.

    ![Режим фиксации](./media/tutorial-move-region-sql/commit-sql-resources.png)

5. Отслеживать ход фиксации можно на панели уведомлений.


> [!NOTE]
> В процессе фиксации базы данных SQL некоторое время простаивают.
> Зафиксированные базы данных и эластичные пулы теперь находятся в состоянии *Ожидание удаления источника*.
> После фиксации обновите параметры базы данных, в том числе правила брандмауэра, политики и оповещения в целевой базе данных.


## <a name="delete-source-resources-after-commit"></a>Удаление исходных ресурсов после фиксации

После перемещения при необходимости можно удалить ресурсы в исходном регионе. 

1. В разделе **Across Regions** (Между регионами) щелкните имя каждого исходного ресурса, который требуется удалить.
2. На странице свойства каждого ресурса нажмите кнопку **Удалить**.

## <a name="next-steps"></a>Дальнейшие действия

Изучив это руководство, вы:

> [!div class="checklist"]
> * Базы данных SQL Azure перемещены в другой регион Azure.
> * Пулы эластичных баз данных SQL Azure перемещены в другой регион.

Теперь попробуйте перемещение виртуальных машин Azure в другой регион

> [!div class="nextstepaction"]
> [Перенос виртуальных машин Azure](./tutorial-move-region-virtual-machines.md)
