---
title: Включение функции "Запуск и остановки виртуальных машин в нерабочее время" в службе автоматизации Azure
description: В этой статье рассказывается, как включить функцию "Запуск и остановка виртуальных машин в нерабочее время" для виртуальных машин Azure.
services: automation
ms.subservice: process-automation
ms.date: 04/01/2020
ms.topic: conceptual
ms.openlocfilehash: dde2c3e4cf496bb15ca91c72d9a41936af7051c5
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "83743758"
---
# <a name="enable-startstop-vms-during-off-hours"></a>Включение Запуска и остановки виртуальных машин в нерабочее время

Последовательно выполните описанные в этом разделе действия, чтобы включить для виртуальных машин функцию "Запуск и остановка виртуальных машин в нерабочее время" с использованием новой или существующей учетной записи службы автоматизации и связанной рабочей области Log Analytics. После завершения настройки задайте переменные для компонента под свои потребности.

>[!NOTE]
>Чтобы использовать эту функцию с классическими виртуальными машинами, требуется классическая учетная запись запуска от имени, которая не создается по умолчанию. Дополнительные сведения см. в разделе [Создание классической учетной записи запуска от имени](automation-create-standalone-account.md#create-a-classic-run-as-account).
>

## <a name="create-resources-for-the-feature"></a>Создание ресурсов для поддержки этой функции

1. Войдите на [портал](https://portal.azure.com) Azure.
2. Найдите и выберите раздел **Учетные записи службы автоматизации**.
3. На странице учетных записей службы автоматизации выберите в списке нужную учетную запись.
4. На странице учетной записи службы автоматизации выберите **Запуск и остановка виртуальных машин** в разделе **Связанные ресурсы**. На этой странице можно щелкнуть **Дополнительные сведения и включение решения**. Если эта функция уже развернута, щелкните **Настройка решения** и найдите ее в списке.

   ![Включение из учетной записи службы автоматизации](./media/automation-solution-vm-management/enable-from-automation-account.png)

   > [!NOTE]
   > Также ресурс можно создать из любого места на портале Azure, щелкнув действие **Создать ресурс**. На странице "Marketplace" введите ключевое слово, например **Start** или **Start/Stop**. Как только вы начнете вводить символы, список отфильтруется соответствующим образом. Кроме того, можно ввести одно или несколько ключевых слов из полного имени функции и нажать клавишу **ВВОД**. Выберите **Запуск и остановка виртуальных машин в нерабочее время** в результатах поиска.

5. На странице "Запуск и остановка виртуальных машин в нерабочее время" для выбранного развертывания просмотрите сводные данные и щелкните **Создать**.

   ![Портал Azure](media/automation-solution-vm-management/azure-portal-01.png)

## <a name="configure-the-feature"></a>Настройка функции

После создания ресурса появится страница "Добавление решения". На ней будет предложено настроить решение перед его импортом в подписку службы автоматизации. Дополнительные сведения см. в статье [Настройка запуска и остановки виртуальных машин в нерабочее время](automation-solution-vm-management-config.md).

   ![Страница "Добавление решения" в решении по управлению виртуальными машинами](media/automation-solution-vm-management/azure-portal-add-solution-01.png)

## <a name="select-a-log-analytics-workspace"></a>Выбор рабочей области Log Analytics

1. На странице "Добавление решения" выберите **Рабочая область**. Выберите рабочую область Log Analytics, связанную с подпиской Azure, которую использует учетная запись службы автоматизации. 

2. Если у вас нет рабочей области, выберите **Создать рабочую область**. На странице "Рабочая область Log Analytics" сделайте следующее:

   - Укажите имя для новой рабочей области Log Analytics, например **ContosoLAWorkspace**.
   - В раскрывающемся списке **Подписка** выберите вариант, с которым нужно связать рабочую область, если вариант по умолчанию вам не подходит.
   - В качестве **группы ресурсов** можно использовать имеющуюся группу или создать новую.
   - Выберите **расположение**.
   - Выберите **ценовую категорию**. Выберите параметр **За ГБ (отдельный)** . [Цены](https://azure.microsoft.com/pricing/details/log-analytics/) на Azure Monitor были изменены, и теперь доступен только уровень "За ГБ".

   > [!NOTE]
   > При включении функций не все регионы поддерживают связывание рабочей области Log Analytics и учетной записи службы автоматизации. Список поддерживаемых пар сопоставлений см. в статье о [сопоставлении региона для учетной записи службы автоматизации и рабочей области Log Analytics](how-to/region-mappings.md).

3. Указав необходимые сведения на странице "Рабочая область Log Analytics", щелкните **Создать**. Вы можете отслеживать ход выполнения, выбрав **Уведомления** в меню. После завершения вновь отобразится страница "Добавление решения".

## <a name="add-automation-account"></a>Добавление учетной записи службы автоматизации

На странице "Добавление решения" выберите **Учетная запись службы автоматизации**. Вы можете выбрать существующую учетную запись службы автоматизации, которая еще не связана с рабочей областью Log Analytics. При создании рабочей области Log Analytics вы можете создать связанную с ней учетную запись службы автоматизации. Выберите имеющуюся учетную запись службы автоматизации или щелкните **Создать учетную запись службы автоматизации**, а затем на странице добавления учетной записи службы автоматизации введите имя для учетной записи в поле **Имя**.

Все остальные параметры заполняются автоматически в зависимости от выбранной рабочей области Log Analytics. и их нельзя изменить. По умолчанию проверка подлинности runbook, добавленных в эту возможность, осуществляется с учетной записью запуска от имени Azure. 

Нажмите кнопку **ОК**, чтобы проверить параметры конфигурации и создать учетную запись службы автоматизации. Ход создания можно просмотреть в разделе **Уведомления** в меню.

## <a name="define-feature-parameters"></a>Определение параметров функции

1. На странице "Добавление решения" выберите **Конфигурация**. Появится страница "Параметры".

    ![Страница "Параметры" решения](media/automation-solution-vm-management/azure-portal-add-solution-02.png)

2. Укажите значение в поле **Target ResourceGroup Names** (Имена целевых групп ресурсов). Это поле определяет имена групп, которые содержат виртуальные машины, которыми будет управлять эта функция. Вы можете указать несколько имен, разделяя их запятыми. В именах не учитывается регистр. Если необходимо использовать виртуальные машины во всех группах ресурсов в рамках подписки, используйте подстановочный знак. Значения хранятся в переменных `External_Start_ResourceGroupNames` и `External_Stop_ResourceGroupNames`.

    > [!IMPORTANT]
    > Значение по умолчанию **Target ResourceGroup Names** (Имена целевых групп ресурсов) — **&ast;** . Этот параметр распространяется на все виртуальные машины в подписке. Если вы не хотите, чтобы функция применялась для всех виртуальных машин в подписке, перед выбором расписания укажите список имен групп ресурсов.
  
3. Укажите значение в поле **VM Exclude List (string)** (Список исключаемых виртуальных машин (строка)). Это список, содержащий одну или несколько виртуальных машин из целевой группы ресурсов. Вы можете указать несколько имен, разделяя их запятыми. В именах не учитывается регистр. Поддерживается использование подстановочных знаков. Это значение хранится в переменной `External_ExcludeVMNames`.
  
4. Используйте поле **Расписание**, чтобы выбрать расписание для управления виртуальными машинами с помощью этой функции. Выберите дату и время начала для расписания, чтобы действия по расписанию ежедневно повторялись в указанное время. Выбрать другой регион невозможно. Чтобы настроить для расписания использование конкретного часового пояса после настройки функции, ознакомьтесь с разделом [Изменение расписаний запуска и завершения работы](automation-solution-vm-management-config.md#modify-the-startup-and-shutdown-schedules).

5. Чтобы получать уведомления по электронной почте от [группы действий](../azure-monitor/platform/action-groups.md), сохраните значение по умолчанию **Да** в поле **Уведомления по электронной почте** и укажите допустимый адрес электронной почты. Если вы указали здесь значение **Нет**, но впоследствии решили получать уведомления по электронной почте, вы можете добавить в созданную группу действий список допустимых адресов электронной почты, разделяя их запятыми. 

6. Включите следующие правила генерации оповещений:

   - `AutoStop_VM_Child`
   - `Scheduled_StartStop_Parent`
   - `Sequenced_StartStop_Parent`

## <a name="create-alerts"></a>Создание оповещений

Функция "Запуск и остановка виртуальных машин в нерабочее время" не имеет предопределенных предупреждений. Изучите статью [Создание оповещений журнала с помощью Azure Monitor](../azure-monitor/platform/alerts-log.md), где описано создание оповещений о сбое заданий, которое поможет организовать процессы и процедуры для DevOps или эксплуатации.

## <a name="deploy-the-feature"></a>Развертывание функции

1. Когда завершите начальную настройку обязательных параметров функции, щелкните **ОК**, чтобы закрыть страницу "Параметры".

2. Нажмите кнопку **Создать**. После проверки всех параметров функция будет развернута в вашей подписке. Этот процесс может занять несколько секунд. Ход его выполнения можно просмотреть в разделе меню **Уведомления**.

    > [!NOTE]
    > Если у вас есть подписка в рамках программы "Поставщик облачных решений Azure" (Azure CSP), после завершения развертывания в своей учетной записи автоматизации перейдите к области **Переменные** в разделе **Общие ресурсы** и задайте переменной [External_EnableClassicVMs](automation-solution-vm-management.md#variables) значение **False**. Это предотвратит поиск ресурсов в классической виртуальной машине со стороны решения.

## <a name="next-steps"></a>Дальнейшие действия

* Сведения о настройке функции см. в статье [Настройка запуска и остановки виртуальных машин в нерабочее время](automation-solution-vm-management-config.md).
* Сведения об устранении ошибок, связанных с этой функцией, см. в статье [Устранение неполадок с функцией "Запуск и остановка виртуальных машин в нерабочее время"](troubleshoot/start-stop-vm.md).