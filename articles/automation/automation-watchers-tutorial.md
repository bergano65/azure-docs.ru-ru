---
title: Отслеживание обновленных файлов с помощью задачи наблюдателя службы автоматизации Azure
description: В этой статье объясняется, как создать задачу наблюдателя в учетной записи службы автоматизации Azure, чтобы отслеживать создание файлов в папке.
services: automation
ms.subservice: process-automation
ms.topic: conceptual
ms.date: 10/30/2018
ms.openlocfilehash: 38963a8e1bfdbde50439ed871aa33e9aaa830d35
ms.sourcegitcommit: ec682dcc0a67eabe4bfe242fce4a7019f0a8c405
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2020
ms.locfileid: "86185659"
---
# <a name="track-updated-files-with-a-watcher-task"></a>Отслеживание обновленных файлов с помощью задачи наблюдателя

Служба автоматизации Azure использует задачи наблюдателя для слежения за событиями и активации действий с помощью модулей runbook PowerShell. Задача наблюдателя состоит из двух частей: наблюдателя и действия. Модуль runbook наблюдателя запускается с интервалом, определенным в задаче наблюдателя, и выводит данные в модуль runbook действия. 

> [!NOTE]
> Задачи наблюдателя не поддерживаются в Azure для Китая (21Vianet).

> [!IMPORTANT]
> Начиная с мая 2020 года слежение за событиями, планирование повторяющихся задач и запуск действий поддерживается с помощью Azure Logic Apps. См. статью [Планирование и выполнение повторяющихся автоматизированных задач, процессов и рабочих процессов с помощью Azure Logic Apps](../logic-apps/concepts-schedule-automated-recurring-tasks-workflows.md).

В этом руководстве пошагово описывается создание задачи службы "Наблюдатель" для отслеживания добавления новых файлов в каталог. Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Импорт runbook службы "Наблюдатель"
> * Создание переменной службы автоматизации
> * Создание runbook действия
> * Создание задачи службы "Наблюдатель"
> * Активация службы "Наблюдатель"
> * Изучение выходных данных

## <a name="prerequisites"></a>Предварительные требования

Ниже перечислены необходимые условия для выполнения инструкций из этого руководства.

* Подписка Azure. Если у вас ее нет, [активируйте преимущества для подписчиков MSDN](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/) или [зарегистрируйте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
* [Учетная запись службы автоматизации](./index.yml) для хранения runbook наблюдателя, runbook действия и задачи наблюдателя.
* [Гибридная рабочая роль runbook](automation-hybrid-runbook-worker.md), в которой выполняется задача наблюдателя.
* Модули runbook PowerShell. Модули runbook рабочего процесса PowerShell не поддерживаются задачами наблюдателя.

## <a name="import-a-watcher-runbook"></a>Импорт runbook службы "Наблюдатель"

В этом руководстве для поиска новых файлов в каталоге используется runbook службы "Наблюдатель" **Watch-NewFile**. Runbook службы "Наблюдатель" получает время последней записи в файлы в папке и ищет файлы, для которых это значение не превышает заданный предел.

Этот процесс импорта можно также выполнить с помощью [коллекции PowerShell](https://www.powershellgallery.com).

1. Перейдите на страницу коллекции [Watch-NewFile.ps1](https://gallery.technet.microsoft.com/scriptcenter/Watcher-runbook-that-looks-36fc82cd).
2. На вкладке **Служба автоматизации Azure** щелкните **Deploy to Azure Automation** (Развернуть в службе автоматизации Azure).

Вы также можете импортировать этот модуль runbook в учетную запись службы автоматизации на портале, выполнив следующие действия.

1. Откройте учетную запись службы автоматизации и щелкните на странице "Модули Runbook".
2. Щелкните **Обзор коллекции**.
3. Найдите пункт **Watcher runbook** (Модуль runbook наблюдателя), выберите **Watcher runbook that looks for new files in a directory** (Модуль runbook наблюдателя, ищущий новые файлы в каталоге) и щелкните **Импорт**.
  ![Импорт runbook службы автоматизации с помощью пользовательского интерфейса](media/automation-watchers-tutorial/importsourcewatcher.png)
4. Укажите имя и описание модуля runbook, затем щелкните **ОК**, чтобы импортировать модуль runbook в учетную запись службы автоматизации.
5. Щелкните **Изменить**, затем щелкните **Опубликовать**. При появлении соответствующего запроса щелкните **Да**, чтобы опубликовать модуль runbook.

## <a name="create-an-automation-variable"></a>Создание переменной службы автоматизации

[Переменная службы автоматизации](./shared-resources/variables.md) используется для хранения меток времени, которые приведенный выше runbook считывает из каждого файла и сохраняет.

1. Выберите **Переменные** в разделе **Общие ресурсы**, затем щелкните **+ Добавить переменную**.
1. Введите имя "Watch-NewFileTimestamp".
1. Выберите тип DateTime (Дата и время).
1. Щелкните **Создать**, чтобы создать переменную службы автоматизации.

## <a name="create-an-action-runbook"></a>Создание runbook действия

Runbook действия используется в задаче службы "Наблюдатель" для работы с данными, передаваемыми в нее из runbook службы "Наблюдатель". Необходимо импортировать определенный заранее модуль runbook действия с именем **Process-NewFile** из [коллекции PowerShell](https://www.powershellgallery.com). 

Чтобы создать runbook действия, сделайте следующее:

1. Перейдите на страницу коллекции [Process-NewFile.ps1](https://gallery.technet.microsoft.com/scriptcenter/Watcher-action-that-b4ff7cdf).
2. На вкладке **Служба автоматизации Azure** щелкните **Deploy to Azure Automation** (Развернуть в службе автоматизации Azure).

Вы также можете импортировать этот модуль runbook в учетную запись службы автоматизации на портале Azure:

1. Перейдите к своей учетной записи службы автоматизации и в категории **Автоматизация процессов** выберите **Модули Runbook**.
1. Щелкните **Обзор коллекции**.
1. Найдите пункт **Watcher action** (Действие наблюдателя), выберите **Watcher action that processes events triggered by a watcher runbook** (Действие наблюдателя, обрабатывающее события, активированные с помощью runbook наблюдателя) и щелкните **Импорт**.
  ![Импорт runbook действия с помощью пользовательского интерфейса](media/automation-watchers-tutorial/importsourceaction.png)
1. Укажите имя и описание модуля runbook, затем щелкните **ОК**, чтобы импортировать модуль runbook в учетную запись службы автоматизации.
1. Щелкните **Изменить**, затем щелкните **Опубликовать**. При появлении соответствующего запроса щелкните **Да**, чтобы опубликовать модуль runbook.

## <a name="create-a-watcher-task"></a>Создание задачи службы "Наблюдатель"

На этом этапе настраивается задача наблюдателя, указывающая на модуль runbook наблюдателя и модуль runbook действия, определенные в предыдущих разделах.

1. Перейдите к своей учетной записи службы автоматизации и в категории **Автоматизация процессов** выберите **Задачи наблюдателя**.
1. Откройте страницу "Задачи наблюдателя" и щелкните **+ Добавить задачу наблюдателя**.
1. Введите имя **WatchMyFolder**.

1. Щелкните **Настройка наблюдателя** и выберите runbook **Watch-NewFile**.

1. Введите следующие значения параметров.

   * **FOLDERPATH** (Путь к папке). Папка в гибридной рабочей роли Runbook, где создаются файлы, например **d:\examplefiles**.
   * **EXTENSION** (Расширение). Расширение для конфигурации. Оставьте поле пустым, чтобы обрабатывались все расширения файлов.
   * **RECURSE** (Рекурсия). Рекурсивная операция. Оставьте это значение в качестве значения по умолчанию.
   * **RUN SETTINGS** (Параметры запуска). Настройка для запуска модуля runbook. Выберите гибридную рабочую роль.

1. Щелкните **ОК**, а затем **Выбрать**, чтобы вернуться на страницу "Наблюдатель".
1. Щелкните **Настройка действия** и выберите runbook с именем **Process-NewFile**.
1. Введите следующие значения параметров.

   * **EVENTDATA** (Данные событий). Не указывайте. Данные передаются из runbook наблюдателя.
   * **RUN SETTINGS** (Параметры запуска). Настройка для запуска модуля runbook. Оставьте значение "Azure", так как этот модуль runbook выполняется в службе автоматизации Azure.

1. Щелкните **ОК**, а затем **Выбрать**, чтобы вернуться на страницу "Наблюдатель".
1. Нажмите кнопку **ОК**, чтобы создать задачу службы "Наблюдатель".

![Настройка действия службы "Наблюдатель" с помощью пользовательского интерфейса](media/automation-watchers-tutorial/watchertaskcreation.png)

## <a name="trigger-a-watcher"></a>Активация службы "Наблюдатель"

Выполните описанный ниже тест, чтобы убедиться, что задача наблюдателя работает должным образом. 

1. Установите удаленное подключение к гибридной рабочей роли Runbook. 
2. Откройте **PowerShell** и создайте тестовый файл в папке.

```azurepowerShell-interactive
New-Item -Name ExampleFile1.txt
```

В следующем примере показаны ожидаемые выходные данные.

```output
    Directory: D:\examplefiles


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----       12/11/2017   9:05 PM              0 ExampleFile1.txt
```

## <a name="inspect-the-output"></a>Изучение выходных данных

1. Перейдите к своей учетной записи службы автоматизации и в категории **Автоматизация процессов** выберите **Задачи наблюдателя**.
1. Щелкните задачу наблюдателя с именем **WatchMyFolder**.
1. Щелкните **Просмотреть потоки наблюдателей** в разделе **Потоки**, чтобы убедиться, что наблюдатель обнаружил новый файл и запустил модуль runbook действия.
1. Щелкните **Просмотреть задания действий наблюдателя**, чтобы просмотреть задания модуля runbook действия. Вы можете выбрать любое задание, чтобы просмотреть сведения о нем.

   ![Задания действия службы "Наблюдатель" в пользовательском интерфейсе](media/automation-watchers-tutorial/WatcherActionJobs.png)

Ожидаемые выходные данные при обнаружении нового файла можно увидеть в следующем примере.

```output
Message is Process new file...

Passed in data is @{FileName=D:\examplefiles\ExampleFile1.txt; Length=0}
```

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как выполнять следующие задачи:

> [!div class="checklist"]
> * Импорт runbook службы "Наблюдатель"
> * Создание переменной службы автоматизации
> * Создание runbook действия
> * Создание задачи службы "Наблюдатель"
> * Активация службы "Наблюдатель"
> * Изучение выходных данных

Перейдите по ссылке для получения дополнительных сведений о создании собственного runbook.

> [!div class="nextstepaction"]
> [Создание модуля runbook PowerShell](learn/automation-tutorial-runbook-textual-powershell.md)
