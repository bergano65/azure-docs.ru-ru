---
title: Обработка ошибок в графических модулях runbook службы автоматизации Azure
description: В этой статье описывается, как реализовать логику обработки ошибок в графических модулях runbook службы автоматизации Azure.
services: automation
ms.subservice: process-automation
ms.date: 03/16/2018
ms.topic: conceptual
ms.openlocfilehash: 26a4a3dbd54256fbc193fba299d0f7504f407254
ms.sourcegitcommit: 0b80a5802343ea769a91f91a8cdbdf1b67a932d3
ms.contentlocale: ru-RU
ms.lasthandoff: 05/25/2020
ms.locfileid: "83832271"
---
# <a name="handle-errors-in-graphical-runbooks"></a>Обработка ошибок в графических модулях runbook

Ключевым принципом разработки для графических модулей runbook службы автоматизации Azure является идентификация проблем, которые могут возникнуть во время выполнения модуля runbook. например состояние успеха, состояния ожидаемых ошибок и условия непредвиденных ошибок.

Зачастую, если при выполнении модулей runbook с каким-либо действием возникает устранимая ошибка, Windows PowerShell разрешает ситуацию с этим действием, обрабатывая последующее действие обычным образом и не обращая внимания на ошибку. Ошибка, вероятнее всего, вызовет исключение, но следующее действие по-прежнему может быть выполнено.

Графический модуль runbook должен включать код обработки ошибок для решения проблем с выполнением. Чтобы проверить выходные данные действия или обработать ошибку, можно использовать действие кода PowerShell, определить условную логику в ссылке выходных данных действия или применить другой метод.

Графические модули runbook службы автоматизации Azure теперь включают возможность обработки ошибок. Теперь можно преобразовывать исключения в устранимые ошибки и создавать ссылки ошибок между действиями. Этот улучшенный процесс позволит модулю runbook перехватывать ошибки и справляться с реализованными или непредвиденными условиями. 

## <a name="powershell-error-types"></a>Типы ошибок PowerShell

Во время выполнения могут возникать два типа ошибок PowerShell: неустранимые и устранимые.
 
### <a name="terminating-error"></a>Неустранимая ошибка

Неустранимая ошибка: серьезная ошибка, возникающая во время выполнения, которая полностью прерывает выполнение команды (или скрипта). К примерам можно отнести несуществующие командлеты, синтаксические ошибки, предотвращающие выполнение командлета, и другие неустранимые ошибки.

### <a name="non-terminating-error"></a>Устранимая ошибка

Устранимая ошибка: несерьезная ошибка, которая не останавливает выполнение, несмотря на состояние ошибки. Примеры включают ошибки из-за отсутствия файла и проблемы с разрешениями.

## <a name="when-to-use-error-handling"></a>Применение обработки ошибок

Используйте обработку ошибок в модуле runbook, когда критическое важное действие выдает ошибку или исключение. При этом важно предотвратить обработку следующего действия в модуле runbook и соответствующим образом обработать ошибку. Это особенно важно, если модули runbook поддерживают бизнес-процессы или операции, связанные со службами.

## <a name="add-error-links"></a>Добавление ссылок ошибки

Для каждого действия, которое может вызвать ошибку, можно добавить ссылку ошибки, указывающую на любое другое действие. Действие назначения может быть любого типа: действие кода, вызов командлета, вызов другого модуля runbook и т. д. Кроме того, действие назначения может иметь исходящие ссылки, обычные или ссылки ошибок. Эти ссылки позволяют модулю runbook применять сложную логику обработки ошибок, не требующую использования действия кода.

Рекомендуется создать выделенный модуль runbook для обработки ошибок с общими функциональными возможностями. Но это не обязательно. Например, рассмотрим модуль runbook, который пытается запустить виртуальную машину и установить на нее приложение. Если виртуальная машина запускается неправильно, модуль runbook:

1. отправляет уведомление об этой проблеме;
2. запускает другой модуль runbook, который автоматически подготавливает новую виртуальную машину.

В этом случае можно создать ссылку ошибки в runbook, указывающую на действие для обработки шага 1. Например, runbook может связать командлет `Write-Warning` с действием шага 2 (к примеру, командлетом [Start-AzAutomationRunbook](https://docs.microsoft.com/powershell/module/az.automation/start-azautomationrunbook?view=azps-3.5.0)).

Можно также обобщить это поведение для нескольких модулей runbook, поместив эти два действия в отдельные модули для обработки ошибок. Перед тем как исходный модуль runbook вызовет модуль runbook для обработки ошибок, он может создать пользовательское сообщение на основе своих данных и передать его как параметр в модуль для обработки ошибок.

## <a name="turn-exceptions-into-non-terminating-errors"></a>Преобразование исключений в устранимые ошибки

Каждое действие в модуле runbook имеет параметр конфигурации, преобразующий исключения в устранимые ошибки. Эта функция отключена по умолчанию. Рекомендуется включить этот параметр для всех действий, в которых модуль runbook обрабатывает ошибки. Этот параметр гарантирует, что модуль runbook будет обрабатывать как устранимые, так и неустранимые ошибки в действии как неустранимые ошибки, используя ссылку на ошибку.  

После включения этого параметра конфигурации необходимо создать в модуле runbook действие, которое обрабатывает ошибку. Если действие приводит к возникновению ошибки, модуль переходит по исходящим ссылкам на ошибки. Обычные ссылки игнорируются, даже если действие также создает обычные выходные данные.<br><br> ![Пример ссылки ошибки в модуле Runbook службы автоматизации](media/automation-runbook-graphical-error-handling/error-link-example.png)

В следующем примере модуль runbook получает переменную, содержащую имя компьютера виртуальной машины. Затем он пытается запустить виртуальную машину в следующем действии.<br><br> ![Пример обработки ошибок в модуле runbook службы автоматизации](media/automation-runbook-graphical-error-handling/runbook-example-error-handling.png)<br><br>      

Действие `Get-AutomationVariable` и командлет [Start-AzVM](https://docs.microsoft.com/powershell/module/Az.Compute/Start-AzVM?view=azps-3.5.0) настроены для преобразования исключений в ошибки. Если не удается получить переменную или запустить виртуальную машину, код выдает ошибки.<br><br> ![Параметры действия обработки ошибок в модуле runbook службы автоматизации](media/automation-runbook-graphical-error-handling/activity-blade-convertexception-option.png).

Ссылки ошибок ведут от этих действий к одному действию кода `error management`. Это действие настраивается с помощью простого выражения PowerShell, которое использует ключевое слово `throw` для остановки обработки, а также `$Error.Exception.Message`, чтобы получить сообщение, описывающее текущее исключение.<br><br> ![Пример кода для обработки ошибок в модуле runbook службы автоматизации](media/automation-runbook-graphical-error-handling/runbook-example-error-handling-code.png)

## <a name="next-steps"></a>Дальнейшие действия

* Сведения об устранении ошибок графических модулей runbook см. в разделе [Устранение неполадок runbook](troubleshoot/runbooks.md).