---
title: Развертывание гибридной рабочей роли Runbook в службе автоматизации Azure
description: В этой статье рассказывается, как развернуть гибридную рабочую роль Runbook, которую можно использовать для запуска модулей Runbook на компьютерах под управлением Windows в локальном центре обработки данных или в облачной среде.
services: automation
ms.subservice: process-automation
ms.date: 11/23/2020
ms.topic: conceptual
ms.openlocfilehash: cb501b954897beb73ae05bfdc7b5ded2221dc114
ms.sourcegitcommit: b8eba4e733ace4eb6d33cc2c59456f550218b234
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/23/2020
ms.locfileid: "95493933"
---
# <a name="deploy-a-windows-hybrid-runbook-worker"></a>Развертывание гибридной рабочей роли Runbook для Windows

Вы можете использовать функцию гибридной рабочей роли Runbook пользователя в службе автоматизации Azure для запуска модулей Runbook непосредственно на компьютере с Azure или без Azure, включая серверы, зарегистрированные на [серверах с поддержкой Arc Azure](../azure-arc/servers/overview.md). С компьютера или сервера, на котором размещается роль, можно запускать модули Runbook напрямую и для ресурсов в среде, чтобы управлять этими локальными ресурсами.

Служба автоматизации Azure хранит и управляет модулями Runbook, а затем доставляет их на один или несколько определенных компьютеров. В этой статье описывается развертывание гибридной рабочей роли Runbook пользователя на компьютере Windows, удаление рабочей роли и удаление группы гибридных рабочих ролей Runbook.

После успешного развертывания рабочей роли Runbook ознакомьтесь с [запуском модулей runbook в гибридной рабочей роли Runbook](automation-hrw-run-runbooks.md), чтобы узнать, как настроить модули runbook для автоматизации процессов в локальном центре обработки данных или другой облачной среде.

## <a name="prerequisites"></a>Предварительные условия

Прежде чем начать, убедитесь, что у вас есть следующее.

### <a name="a-log-analytics-workspace"></a>Рабочая область Log Analytics

Гибридная Рабочая роль Runbook зависит от Azure Monitor Log Analytics рабочей области для установки и настройки роли. Его можно создать с помощью [Azure Resource Manager](../azure-monitor/samples/resource-manager-workspace.md#create-a-log-analytics-workspace), с помощью [PowerShell](../azure-monitor/scripts/powershell-sample-create-workspace.md?toc=/powershell/module/toc.json)или в [портал Azure](../azure-monitor/learn/quick-create-workspace.md).

Если у вас нет рабочей области Log Analytics Azure Monitor, ознакомьтесь с [руководством по проектированию журналов Azure Monitor](../azure-monitor/platform/design-logs-deployment.md) перед созданием рабочей области.

### <a name="log-analytics-agent"></a>Агент Log Analytics

Для работы гибридной рабочей роли Runbook требуется [агент log Analytics](../azure-monitor/platform/log-analytics-agent.md) для поддерживаемой операционной системы Windows. Для серверов или компьютеров, размещенных за пределами Azure, можно установить агент Log Analytics с помощью [серверов с поддержкой Arc Azure](../azure-arc/servers/overview.md).

### <a name="supported-windows-operating-system"></a>Поддерживаемая операционная система Windows

Гибридная Рабочая роль Runbook поддерживает следующие операционные системы:

* Windows Server 2019
* Windows Server 2016, версии 1709 и 1803
* Windows Server 2012, 2012 R2
* Windows Server 2008 (x64) с пакетом обновления 2 (SP2), 2008 R2
* Все устройства с Windows 10 Корпоративная (с несколькими сеансами), и Профессиональная
* Windows 8 Корпоративная и Профессиональная
* Windows 7 с пакетом обновления 1 (SP1)

### <a name="minimum-requirements"></a>Минимальные требования

Ниже приведены минимальные требования для гибридной рабочей роли системы Windows и пользователя.

* Windows PowerShell версии 5.1 или более поздней ([скачать WMF 5.1](https://www.microsoft.com/download/details.aspx?id=54616));
* .NET Framework 4.6.2 или более поздней версии.
* два ядра;
* 4 ГБ ОЗУ;
* Порт 443 (исходящий).

### <a name="network-configuration"></a>Конфигурация сети

Требования к сети для гибридной рабочей роли Runbook см. в разделе [Настройка сети](automation-hybrid-runbook-worker.md#network-planning).

### <a name="adding-a-machine-to-a-hybrid-runbook-worker-group"></a>Добавление компьютера в группу гибридных рабочих ролей Runbook

Рабочий компьютер можно добавить в группу гибридных рабочих ролей Runbook в одной из учетных записей службы автоматизации. Для компьютеров, на которых размещена система гибридной рабочей роли Runbook, управляемая Управление обновлениями, их можно добавить в группу гибридных рабочих ролей Runbook. Но вы должны использовать одну и ту же учетную запись службы автоматизации как для Управление обновлениями, так и для членства в группе гибридной рабочей роли Runbook.

>[!NOTE]
>Служба автоматизации Azure [Управление обновлениями](update-management/update-mgmt-overview.md) автоматически устанавливает гибридную рабочую роль Runbook системы на компьютере Azure или не на Azure, для которого включена Управление обновлениями. Однако этот рабочий процесс не зарегистрирован ни в одной из гибридных групп рабочих ролей Runbook в учетной записи службы автоматизации. Чтобы запустить модули Runbook на этих компьютерах, необходимо добавить их в группу гибридных рабочих ролей Runbook. Выполните шаг 6 раздела [Развертывание вручную](#manual-deployment) , чтобы добавить его в группу.

## <a name="enable-for-management-with-azure-automation-state-configuration"></a>Включить для управления с помощью конфигурации состояния службы автоматизации Azure

Дополнительные сведения о включении компьютеров для управления с помощью конфигурации состояния службы автоматизации Azure см. в статье [Включение управления с помощью конфигурации состояния службы автоматизации Azure на компьютерах](automation-dsc-onboarding.md).

> [!NOTE]
> Для управления конфигурацией компьютеров, поддерживающих гибридную рабочую роль Runbook с настройкой требуемого состояния (DSC), необходимо добавить компьютеры в качестве узлов DSC.

## <a name="installation-options"></a>Варианты установки

Чтобы установить и настроить гибридную рабочую роль Runbook пользователя Windows, можно использовать один из следующих методов.

* Используйте предоставленный сценарий PowerShell, чтобы полностью [автоматизировать](#automated-deployment) процесс настройки одного или нескольких компьютеров с ОС Windows. Мы рекомендуем этот способ для компьютеров в центре обработки данных или в другой облачной среде.
* Вручную импортируйте решение службы автоматизации, установите агент Log Analytics для Windows и настройте рабочую роль на компьютере.

## <a name="automated-deployment"></a>Автоматизированное развертывание

В методе автоматического развертывания используется **New-OnPremiseHybridWorker.ps1** скриптов PowerShell для автоматизации и настройки роли гибридного рабочего процесса Runbook Windows. Он выполняет следующие действия:

* Устанавливает необходимые модули
* Вход с использованием учетной записи Azure
* Проверка существования указанной группы ресурсов и учетной записи службы автоматизации
* Создает ссылки на атрибуты учетной записи службы автоматизации
* Создает рабочую область Log Analytics Azure Monitor, если не указано
* Включение решения службы автоматизации Azure в рабочей области
* Скачивание и установка агента Log Analytics для Windows
* Регистрация компьютера в качестве гибридной рабочей роли Runbook

Выполните следующие действия, чтобы установить роль на компьютере с Windows с помощью скрипта.

1. Скачайте скрипт **New-OnPremiseHybridWorker.ps1** из [коллекции PowerShell](https://www.powershellgallery.com/packages/New-OnPremiseHybridWorker). После скачивания скрипта скопируйте или запустите его на целевом компьютере. Во время выполнения скрипт **New-OnPremiseHybridWorker.ps1** использует следующие параметры.

    | Параметр | Состояние | Описание |
    | --------- | ------ | ----------- |
    | `AAResourceGroupName` | Обязательный | имя группы ресурсов, связанной с вашей учетной записью службы автоматизации. |
    | `AutomationAccountName` | Обязательный | имя учетной записи службы автоматизации.
    | `Credential` | Необязательно | Учетные данные для входа в среду Azure. |
    | `HybridGroupName` | Обязательный | имя группы гибридных рабочих ролей Runbook, которую вы указываете в качестве целевой для модулей runbook, поддерживающих этот сценарий. |
    | `OMSResourceGroupName` | Необязательно | имя группы ресурсов для рабочей области Log Analytics. Если эта группа ресурсов не указана, используется значение `AAResourceGroupName`. |
    | `SubscriptionID` | Обязательный | Идентификатор подписки Azure, которая связана с учетной записью службы автоматизации. |
    | `TenantID` | Необязательно | Идентификатор организации клиента, которая связана с учетной записью службы автоматизации. |
    | `WorkspaceName` | Необязательно | Имя рабочей области Log Analytics. Если у вас нет рабочей области Log Analytics, сценарий создаст и настроит ее. |

2. Откройте 64-разрядную командную строку PowerShell с повышенными привилегиями.

3. В командной строке PowerShell перейдите к папке, содержащей скачанный скрипт. Измените значения параметров `AutomationAccountName`, `AAResourceGroupName`, `OMSResourceGroupName`, `HybridGroupName`, `SubscriptionID` и `WorkspaceName`. Затем выполните сценарий.

    После выполнения сценария вы увидите запрос на аутентификацию в Azure. Необходимо войти с учетной записью, которая является членом роли **администраторов Подписки** и соадминистратором подписки.

    ```powershell-interactive
    $NewOnPremiseHybridWorkerParameters = @{
      AutomationAccountName = <nameOfAutomationAccount>
      AAResourceGroupName   = <nameOfResourceGroup>
      OMSResourceGroupName  = <nameOfResourceGroup>
      HybridGroupName       = <nameOfHRWGroup>
      SubscriptionID        = <subscriptionId>
      WorkspaceName         = <nameOfLogAnalyticsWorkspace>
    }
    .\New-OnPremiseHybridWorker.ps1 @NewOnPremiseHybridWorkerParameters
    ```

4. Вы получите предложение подтвердить установку пакета NuGet и указать учетные данные Azure для аутентификации. Если у вас нет последней версии NuGet, ее можно скачать из [доступных версий распространения NuGet](https://www.nuget.org/downloads).

5. Проверьте развертывание после завершения скрипта. На странице **гибридные группы рабочих ролей Runbook** в учетной записи службы автоматизации на вкладке **Гибридная группа рабочих ролей Runbook пользователя** отображается новая группа и число членов. Если указать имеющуюся группу, количество элементов в ней увеличивается. Вы можете выбрать группу из списка на странице, в меню слева выберите **гибридные рабочие роли** . На странице **гибридные рабочие роли** можно увидеть каждый член группы в списке.

## <a name="manual-deployment"></a>Развертывание вручную

Чтобы установить и настроить гибридную рабочую роль Runbook Windows, выполните следующие действия.

1. Включите решение службы автоматизации Azure в рабочей области Log Analytics, выполнив следующую команду в командной строке PowerShell с повышенными привилегиями или в Cloud Shell в [портал Azure](https://portal.azure.com).

    ```powershell
    Set-AzOperationalInsightsIntelligencePack -ResourceGroupName <resourceGroupName> -WorkspaceName <workspaceName> -IntelligencePackName "AzureAutomation" -Enabled $true
    ```

2. Разверните агент Log Analytics на целевом компьютере.

    * Для виртуальных машин Azure установите агент Log Analytics для Windows с помощью [расширения виртуальной машины для Windows](../virtual-machines/extensions/oms-windows.md). Это расширение устанавливает агент Log Analytics на виртуальных машинах Azure и регистрирует виртуальные машины в существующей рабочей области Log Analytics. Вы можете использовать шаблон Azure Resource Manager, PowerShell или политику Azure, чтобы назначить встроенную политику [развертывания log Analytics Agent для *Linux* или виртуальных машин *Windows*](../governance/policy/samples/built-in-policies.md#monitoring) . После установки агента можно добавить компьютер в группу гибридных рабочих ролей Runbook в учетной записи службы автоматизации.
    
    * Для компьютеров, не относящихся к Azure, можно установить агент Log Analytics с помощью [серверов с поддержкой Arc Azure](../azure-arc/servers/overview.md). Серверы с поддержкой Arc поддерживают развертывание агента Log Analytics с помощью следующих методов.
    
        - Использование платформы расширений виртуальных машин.
        
            Эта функция на серверах с поддержкой Arc Azure позволяет развернуть расширение виртуальной машины агента Log Analytics на сервере Windows и (или) Linux, отличном от Azure. Для управления расширениями виртуальной машины можно использовать следующие методы на гибридных компьютерах или серверах, управляемых с помощью серверов с поддержкой ARC:
        
            - [портал Azure](../azure-arc/servers/manage-vm-extensions-portal.md).
            - [Интерфейс командной строки Azure](../azure-arc/servers/manage-vm-extensions-cli.md)
            - [Azure PowerShell](../azure-arc/servers/manage-vm-extensions-powershell.md)
            - [Шаблоны диспетчер ресурсов](../azure-arc/servers/manage-vm-extensions-template.md) Azure
        
        - Использование политики Azure.
        
            При таком подходе вы используете политику Azure [Deploy log Analytics Agent на компьютерах Linux или Windows Azure Arc](../governance/policy/samples/built-in-policies.md#monitoring) , чтобы выполнять аудит, если на сервере с поддержкой Arc установлен агент log Analytics. Если агент не установлен, он автоматически развертывает его с помощью задачи исправления. Кроме того, если планируется отслеживать компьютеры с Azure Monitor для виртуальных машин, используйте инициативу [Enable Azure Monitor для виртуальных машин](../governance/policy/samples/built-in-initiatives.md#monitoring) для установки и настройки агента log Analytics.

    Мы рекомендуем установить агент Log Analytics для Windows или Linux с помощью политики Azure.

3. Проверка того, что агент сообщает о рабочей области

    Агент Log Analytics для Windows подключает компьютеры к рабочей области Log Analytics Azure Monitor. При установке агента на компьютере и подключении его к рабочей области автоматически загружаются компоненты, необходимые для работы гибридного рабочего процесса Runbook.

    Подключение агента к рабочей области Log Analytics занимает несколько минут, и после этого вы можете выполнить следующий запрос и убедиться, что он отправляет данные пульса в рабочую область.

    ```kusto
    Heartbeat 
    | where Category == "Direct Agent"
    | where TimeGenerated > ago(30m)
    ```

    В результатах поиска должны отобразиться записи пульса для компьютера, указывающие, что он подключен и сообщает службе. По умолчанию каждый агент перенаправляет запись пульса в назначенную ему рабочую область. Выполните следующие шаги, чтобы завершить установку и настройку агента.

4. Подтвердите версию гибридной рабочей роли Runbook на компьютере, на котором размещен агент Log Analytics, перейдите к `C:\Program Files\Microsoft Monitoring Agent\Agent\AzureAutomation\` вложенной папке **версии** и запишите ее. Эта папка будет отображаться на компьютере несколько минут после включения решения в рабочей области.

5. Установите среду Runbook и подключитесь к службе автоматизации Azure. При настройке агента для отправки отчетов в рабочую область Log Analytics и импорта решения **автоматизации** решение отправляет `HybridRegistration` модуль PowerShell. Этот модуль содержит `Add-HybridRunbookWorker` командлет. Используйте этот командлет для установки среды Runbook на компьютере и его регистрации в службе автоматизации Azure.

    Откройте сеанс PowerShell с правами администратора и импортируйте модуль, выполнив указанные ниже команды.

    ```powershell-interactive
    cd "C:\Program Files\Microsoft Monitoring Agent\Agent\AzureAutomation\<version>\HybridRegistration"
    Import-Module .\HybridRegistration.psd1
    ```

6. Выполните `Add-HybridRunbookWorker` командлет, указав значения для параметров `Url` , `Key` и `GroupName` .

    ```powershell-interactive
    Add-HybridRunbookWorker –GroupName <String> -Url <Url> -Key <String>
    ```

    Сведения, необходимые для параметров, можно получить на `Url` `Key` странице **ключи** в учетной записи службы автоматизации. Выберите **ключи** в разделе **Параметры учетной записи** в левой части страницы.

    ![Страница "Управление ключами"](media/automation-hybrid-runbook-worker/elements-panel-keys.png)

    * Для `Url` параметра скопируйте значение для **URL-адреса**.

    * Для `Key` параметра скопируйте значение для **первичного ключа доступа**.

    * Для параметра `GroupName` укажите имя группы гибридных рабочих ролей Runbook. Если эта группа уже существует в учетной записи службы автоматизации, в нее добавляется текущий компьютер. Если эта группа не существует, она добавляется.

    * При необходимости задайте параметр `Verbose`, чтобы получить сведения об установке.

7. Проверьте развертывание после завершения выполнения команды. На странице **гибридные группы рабочих ролей Runbook** в учетной записи службы автоматизации на вкладке **Гибридная группа рабочих ролей Runbook пользователя** отображается новая или существующая группа и число членов. Если указать имеющуюся группу, количество элементов в ней увеличивается. Вы можете выбрать группу из списка на странице, в меню слева выберите **гибридные рабочие роли**. На странице **гибридные рабочие роли** можно увидеть каждый член группы в списке.

## <a name="install-powershell-modules"></a>Установка модулей PowerShell

Модули Runbook могут использовать любые из действий и командлетов, которые определены в модулях, установленных в вашей среде службы автоматизации Azure. Так как эти модули не развертываются автоматически на локальных компьютерах, их необходимо установить вручную. Исключением является модуль Azure. Этот модуль устанавливается по умолчанию и предоставляет доступ к командлетам для всех служб и действий службы автоматизации Azure.

Так как главной целью гибридной рабочей роли Runbook является управление локальными ресурсами, вам с большой вероятностью потребуются модули, которые поддерживают эти ресурсы (в частности, модуль `PowerShellGet`). Сведения об установке модулей Windows PowerShell см. в [этой статье](/powershell/scripting/developer/windows-powershell).

Устанавливаемые модули должны находиться в расположении, указанном в переменной среды `PSModulePath`, чтобы гибридная рабочая роль автоматически импортировала их. Дополнительные сведения см. в разделе [Установка модулей в PSModulePath](/powershell/scripting/developer/module/installing-a-powershell-module).

## <a name="remove-the-hybrid-runbook-worker"></a><a name="remove-windows-hybrid-runbook-worker"></a>Удаление гибридной рабочей роли Runbook

1. На портале Azure перейдите в свою учетную запись в службе автоматизации.

2. В разделе **Параметры учетной записи** выберите **Ключи** и запишите значения **URL-адреса** и **первичного ключа доступа**.

3. Откройте сеанс PowerShell в режиме администратора и выполните следующую команду, указав значения URL-адреса и первичного ключа доступа. Используйте параметр `Verbose`, чтобы получить подробный журнал процесса удаления. Чтобы удалить устаревшие машины из группы гибридной рабочей роли, используйте необязательный параметр `machineName`.

```powershell-interactive
Remove-HybridRunbookWorker -Url <URL> -Key <primaryAccessKey> -MachineName <computerName>
```

## <a name="remove-a-hybrid-worker-group"></a>Удаление группы гибридных рабочих ролей

Чтобы удалить группу гибридных рабочих ролей Runbook, сначала необходимо удалить гибридную рабочую роль Runbook с каждого компьютера, который является членом группы. Затем выполните указанные ниже действия для удаления группы:

1. На портале Azure откройте учетную запись службы автоматизации.

2. В разделе **Автоматизация процессов** выберите **Группы гибридных рабочих ролей**. Выберите группу, которую нужно удалить. Откроется страница свойств этой группы.

   ![Страница свойств](media/automation-hybrid-runbook-worker/automation-hybrid-runbook-worker-group-properties.png)

3. На странице свойств выбранной группы выберите **Удалить**. Появится сообщение с запросом на подтверждение этого действия. Выберите **Да**, если хотите продолжить.

   ![Сообщение с подтверждением](media/automation-hybrid-runbook-worker/automation-hybrid-runbook-worker-confirm-delete.png)

   Для завершения процесса может потребоваться несколько секунд. Ход создания можно просмотреть в разделе **Уведомления** в меню.

## <a name="next-steps"></a>Дальнейшие действия

* Чтобы узнать, как настроить модули runbook для автоматизации процессов в локальном центре обработки данных или другой облачной среде, см. статью [Запуск модулей runbook в гибридной рабочей роли Runbook](automation-hrw-run-runbooks.md).

* Дополнительные сведения см. в статье [Устранение неполадок с гибридными рабочими ролями Runbook](troubleshoot/hybrid-runbook-worker.md#general).
