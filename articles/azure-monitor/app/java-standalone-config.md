---
title: Параметры конфигурации — Azure Monitor Application Insights Java
description: Параметры конфигурации для Azure Monitor Application Insights Java
ms.topic: conceptual
ms.date: 11/04/2020
ms.custom: devx-track-java
ms.openlocfilehash: b703a708af564b9dafc8c1409333a2cfed6d2653
ms.sourcegitcommit: 0dcafc8436a0fe3ba12cb82384d6b69c9a6b9536
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/10/2020
ms.locfileid: "94427706"
---
# <a name="configuration-options-for-azure-monitor-application-insights-java"></a>Параметры конфигурации для Azure Monitor Application Insights Java

> [!WARNING]
> **При обновлении с предварительной версии 3,0**
>
> Внимательно изучите все приведенные ниже параметры конфигурации, так как структура JSON полностью изменена, а также само имя файла, которое было в нижнем регистре.

## <a name="connection-string-and-role-name"></a>Строка подключения и имя роли

Строка подключения и имя роли — это наиболее распространенные параметры, необходимые для начала работы.

```json
{
  "connectionString": "InstrumentationKey=...",
  "role": {
    "name": "my cloud role name"
  }
}
```

Строка подключения является обязательной, и имя роли важно каждый раз при отправке данных из разных приложений в один и тот же ресурс Application Insights.

Дополнительные сведения и дополнительные параметры конфигурации см. ниже.

## <a name="configuration-file-path"></a>Путь к файлу конфигурации

По умолчанию Application Insights Java 3,0 ждет, что файл конфигурации будет называться `applicationinsights.json` и находиться в том же каталоге, что и `applicationinsights-agent-3.0.0.jar` .

Можно указать собственный путь к файлу конфигурации, используя либо

* `APPLICATIONINSIGHTS_CONFIGURATION_FILE` переменная среды или
* `applicationinsights.configuration.file` Системное свойство Java

Если указан относительный путь, он будет разрешаться относительно каталога, в котором находится `applicationinsights-agent-3.0.0.jar` .

## <a name="connection-string"></a>Строка подключения

Требуется строка подключения. Строку подключения можно найти в ресурсе Application Insights:

:::image type="content" source="media/java-ipa/connection-string.png" alt-text="Строка подключения Application Insights":::


```json
{
  "connectionString": "InstrumentationKey=..."
}
```

Можно также задать строку подключения с помощью переменной среды `APPLICATIONINSIGHTS_CONNECTION_STRING` .

Если не задать строку подключения, агент Java будет отключен.

## <a name="cloud-role-name"></a>Имя облачной роли

Имя облачной роли используется для обозначения компонента на схеме приложения.

Если вы хотите задать имя роли облака:

```json
{
  "role": {   
    "name": "my cloud role name"
  }
}
```

Если имя роли облака не задано, имя ресурса Application Insights будет использоваться для обозначения компонента на схеме приложения.

Вы также можете задать имя роли облака с помощью переменной среды `APPLICATIONINSIGHTS_ROLE_NAME` .

## <a name="cloud-role-instance"></a>Экземпляр облачной роли

По умолчанию экземпляр облачной роли имеет имя компьютера.

Если вы хотите задать для экземпляра роли облака нечто другое, а не имя компьютера:

```json
{
  "role": {
    "name": "my cloud role name",
    "instance": "my cloud role instance"
  }
}
```

Вы также можете задать экземпляр роли облака с помощью переменной среды `APPLICATIONINSIGHTS_ROLE_INSTANCE` .

## <a name="sampling"></a>Выборка

Выборка полезна, если необходимо снизить затраты.
Выборка выполняется в качестве функции для идентификатора операции (также известного как идентификатор трассировки), поэтому один и тот же идентификатор операции всегда будет принимать одно и то же решение выборки. Это гарантирует, что вы не будете получать части распределенной транзакции, выборке в, в то время как другие ее части.

Например, если выбрать для выборки значение 10%, будут отображены только 10% транзакций, но каждый из этих 10% будет иметь полные сведения о транзакциях.

Ниже приведен пример того, как задать выборку для записи приблизительно **1/3 из всех транзакций** . Убедитесь, что задана частота выборки, правильная для вашего варианта использования:

```json
{
  "sampling": {
    "percentage": 33.333
  }
}
```

Можно также задать процент выборки с помощью переменной среды `APPLICATIONINSIGHTS_SAMPLING_PERCENTAGE` .

> [!NOTE]
> В качестве процента выборки выберите значение в процентах, близкое к 100/N, где N — это целое число. В настоящее время выборка не поддерживает другие значения.

## <a name="jmx-metrics"></a>Метрики JMX

Если вы хотите получить дополнительные метрики JMX:

```json
{
  "jmxMetrics": [
    {
      "name": "JVM uptime (millis)",
      "objectName": "java.lang:type=Runtime",
      "attribute": "Uptime"
    },
    {
      "name": "MetaSpace Used",
      "objectName": "java.lang:type=MemoryPool,name=Metaspace",
      "attribute": "Usage.used"
    }
  ]
}
```

`name` имя метрики, которое будет назначено этой метрике JMX (может быть любым).

`objectName` — [имя объекта](https://docs.oracle.com/javase/8/docs/api/javax/management/ObjectName.html) MBean-компонента JMX, который требуется получить.

`attribute` имя атрибута внутри MBean-компонента JMX, который требуется получить.

Поддерживаются числовые и логические значения метрик JMX. Метрики логического JMX сопоставлены с `0` false, а `1` значение true.

[//]: # "Примечание. не Задокументируйте APPLICATIONINSIGHTS_JMX_METRICS здесь"
[//]: # "JSON, внедренный в env, является запутанным, и его следует задокументировать только для сценария подключения с некодированным кодом"

## <a name="custom-dimensions"></a>Пользовательские измерения

Если вы хотите добавить пользовательские измерения ко всем данным телеметрии:

```json
{
  "customDimensions": {
    "mytag": "my value",
    "anothertag": "${ANOTHER_VALUE}"
  }
}
```

`${...}` может использоваться для считывания значения из указанной переменной среды при запуске.

## <a name="telemetry-processors-preview"></a>Обработчики данных телеметрии (Предварительная версия)

Эта функция предоставляется в предварительной версии.

Он позволяет настроить правила, которые будут применяться к телеметрии запросов, зависимостей и трассировки, например:
 * Маскирование конфиденциальных данных
 * Условно добавить пользовательские измерения
 * Обновление имени телеметрии, используемого для агрегирования и вывода

Дополнительные сведения см. в документации по [обработчику данных телеметрии](./java-standalone-telemetry-processors.md) .

## <a name="auto-collected-logging"></a>Автоматическое собираемое ведение журнала

Log4j, Logback и Java. util. Logging устанавливаются в автоматическом инструментировании. ведение журнала выполняется с помощью этих платформ ведения журналов.

По умолчанию ведение журнала выполняется только в том случае, если ведение журнала выполняется на `INFO` уровне или выше.

Если вы хотите изменить этот уровень коллекции, сделайте следующее:

```json
{
  "instrumentation": {
    "logging": {
      "level": "WARN"
    }
  }
}
```

Можно также задать пороговое значение с помощью переменной среды `APPLICATIONINSIGHTS_INSTRUMENTATION_LOGGING_LEVEL` .

Это допустимые `level` значения, которые можно указать в `applicationinsights.json` файле и их соответствие уровням ведения журнала в разных платформах ведения журналов.

| уровень             | Log4j  | Logback | ИЮЛ     |
|-------------------|--------|---------|---------|
| OFF               | OFF    | OFF     | OFF     |
| АВАРИЙ             | АВАРИЙ  | ОШИБКА   | SEVERE  |
| Ошибка (или СЕРЬЕЗная) | ОШИБКА  | ОШИБКА   | SEVERE  |
| ПРЕДУПРЕЖДАть (или ПРЕДУПРЕЖДАть) | ДАТЬ   | ДАТЬ    | ПРЕДУПРЕЖДЕНИЕ |
| ИНФОРМАЦИЯ              | ИНФОРМАЦИЯ   | ИНФОРМАЦИЯ    | ИНФОРМАЦИЯ    |
| CONFIG            | DEBUG  | DEBUG   | CONFIG  |
| ОТЛАДКа (или Точная)   | DEBUG  | DEBUG   | FINE    |
| FINER             | DEBUG  | DEBUG   | FINER   |
| TRACE (или FINEST) | TRACE  | TRACE   | FINEST  |
| ALL               | ALL    | ALL     | ALL     |

## <a name="auto-collected-micrometer-metrics-including-spring-boot-actuator-metrics"></a>Автособираемые метрики Микрометер (включая метрики загрузчика пружины)

Если приложение использует [микрометер](https://micrometer.io), то метрики, отправляемые в глобальный реестр микрометер, будут собираться в автоматическом виде.

Кроме того, если приложение использует [пружинный выключатель загрузки](https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html), то метрики, настроенные с помощью пружинного выключателя, также будут собираться в автоматическом виде.

Чтобы отключить автоматическую коллекцию метрик Микрометер (включая метрики выключателя пружины), выполните следующие действия.

> [!NOTE]
> Плата за настраиваемые метрики взимается отдельно и может привести к дополнительным затратам. Обязательно ознакомьтесь с подробными [сведениями о ценах](https://azure.microsoft.com/pricing/details/monitor/). Чтобы отключить метрики Микрометер и пружины, добавьте приведенную ниже конфигурацию в файл конфигурации.

```json
{
  "instrumentation": {
    "micrometer": {
      "enabled": false
    }
  }
}
```

## <a name="heartbeat"></a>Пульс

По умолчанию Application Insights Java 3,0 отправляет метрику пульса каждые 15 минут. Если вы используете метрику пульса для активации оповещений, можно увеличить частоту этого пульса:

```json
{
  "heartbeat": {
    "intervalSeconds": 60
  }
}
```

> [!NOTE]
> Вы не можете уменьшить частоту пульса, так как данные пульса также используются для мониторинга Application Insights использования.

## <a name="http-proxy"></a>Прокси-сервер HTTP

Если приложение находится за брандмауэром и не может напрямую подключаться к Application Insights (см. [IP-адреса, используемые Application Insights](./ip-addresses.md)), можно настроить Application Insights Java 3,0 для использования прокси-сервера http:

```json
{
  "proxy": {
    "host": "myproxy",
    "port": 8080
  }
}
```

[//]: # "Обратите внимание, что не следует объявлять поддержку Опентелеметри до тех пор, пока мы не поддерживаем 0.10.0, который содержит существенные критические изменения"

[//]: # "Поддержка # # для предварительных выпусков API Опентелеметри в 1,0"

[//]: # "Поддержка предварительно 1,0 версий API Опентелеметри является явной, так как API Опентелеметри еще не является стабильным."
[//]: # "и поэтому каждая версия агента поддерживает только определенные версии API Опентелеметри, предшествующие 1,0."
[//]: # "(это ограничение не будет применяться после выпуска API Опентелеметри 1,0)."

[//]: # "JSON"
[//]: # "{"
[//]: # "  \"Предварительный просмотр \" : {"
[//]: # "    \"Опентелеметряписуппорт \" : true"
[//]: # "  }"
[//]: # "}"
[//]: # "```"

## <a name="self-diagnostics"></a>Самостоятельная диагностика

"Самодиагностика" относится к внутреннему журналу Application Insights Java 3,0.

Эта функция может оказаться полезной для обнаружения и диагностики проблем с Application Insights.

По умолчанию Application Insights Java 3,0 записывает в журнал на уровне `INFO` как для файла `applicationinsights.log` , так и для консоли, соответствующей этой конфигурации:

```json
{
  "selfDiagnostics": {
    "destination": "file+console",
    "level": "INFO",
    "file": {
      "path": "applicationinsights.log",
      "maxSizeMb": 5,
      "maxHistory": 1
    }
  }
}
```

`destination` может быть одним из `file` , `console` или `file+console` .

`level` может быть одним из `OFF` , `ERROR` , `WARN` , `INFO` , `DEBUG` или `TRACE` .

`path` может быть абсолютным или относительным путем. Относительные пути разрешаются в каталоге, где находится `applicationinsights-agent-3.0.0.jar` .

`maxSizeMb` максимальный размер файла журнала до его перебора.

`maxHistory` число файлов журнала, которые были включены в сохраняемые файлы журналов (помимо текущего файла журнала).

## <a name="an-example"></a>Пример

Это лишь пример, показывающий, как выглядит файл конфигурации с несколькими компонентами.
Настройте конкретные параметры в зависимости от ваших потребностей.

```json
{
  "connectionString": "InstrumentationKey=...",
  "role": {
    "name": "my cloud role name"
  },
  "sampling": {
    "percentage": 100
  },
  "jmxMetrics": [
  ],
  "customDimensions": {
  },
  "instrumentation": {
    "logging": {
      "level": "INFO"
    },
    "micrometer": {
      "enabled": true
    }
  },
  "httpProxy": {
  },
  "preview": {
    "processors": [
    ]
  },
  "selfDiagnostics": {
    "destination": "file+console",
    "level": "INFO",
    "file": {
      "path": "applicationinsights.log",
      "maxSizeMb": 5,
      "maxHistory": 1
    }
  }
}
```