---
title: Метрики на основе журналов и предварительно агрегированные метрики в Azure Application Insights | Microsoft Docs
description: Причины использовать метрики на основе журналов и предварительно агрегированные метрики в Azure Application Insights
ms.topic: conceptual
author: vgorbenko
ms.author: vitalyg
ms.date: 09/18/2018
ms.reviewer: mbullwin
ms.openlocfilehash: 30487eebed361e5b010df023a9b1a44f96590b14
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81271086"
---
# <a name="log-based-and-pre-aggregated-metrics-in-application-insights"></a>Метрики на основе журналов и предварительно агрегированные метрики в Application Insights

В этой статье объясняется различие между "традиционными" Application Insights метриками, основанными на журналах, и предварительно агрегированными метриками, которые в настоящее время доступны в общедоступной предварительной версии. Метрики обоих типов доступны пользователям Application Insights, и каждый тип по-своему полезен при отслеживании работоспособности, диагностике и аналитике приложений. Разработчики, которые инструментируют приложения, могут решить, какой тип метрики лучше всего подходит для определенного сценария, учитывая размер приложения, ожидаемый объем данных телеметрии и бизнес-требования к точности метрик и созданию оповещений.

## <a name="log-based-metrics"></a>Метрики на основе журналов

До последнего момента модель данных телеметрии мониторинга приложений в Application Insights была исключительно основана на небольшом количестве предопределенных типов событий, таких как запросы, исключения, вызовы зависимостей, Просмотры страниц и т. д. Разработчики могут использовать пакет SDK для выпуска этих событий вручную (путем написания кода, который явным образом вызывает пакет SDK), или же они могут полагаться на автоматическую коллекцию событий из автоматической инструментирования. Так или иначе, в серверной части Application Insights все собранные события хранятся в виде журналов, а колонки Application Insights на портале Azure выступают в качестве аналитического и диагностического средства для визуализации данных, касающихся событий, из журналов.

Использование журналов для хранения полного набора событий может оказаться очень полезным при аналитике и диагностике. Например, вы можете получить точные сведения о количестве запросов к определенному URL-адресу, а также о количестве отдельных пользователей, которые совершили эти запросы. Кроме того, вы можете получить подробные диагностические трассировки, включая исключения или вызовы зависимостей для любого сеанса пользователя. Наличие такого рода информации может значительно повысить наглядность сведений о работоспособности приложения и его использовании. Это позволяет сократить время, необходимое для диагностики проблем, связанных с приложением.

В то же время сбор полного набора событий может оказаться непрактичным (или даже невозможным) для приложений, создающих большой объем данных телеметрии. Для ситуаций, когда объем событий слишком велик, в Application Insights используется несколько методов сокращения объема данных телеметрии, например [выборки](https://docs.microsoft.com/azure/application-insights/app-insights-sampling) и [фильтрация](https://docs.microsoft.com/azure/application-insights/app-insights-api-filtering-sampling). Эти методы позволяют уменьшить количество собираемых и хранимых событий. К сожалению, при уменьшении количества хранимых событий снижается точность метрики, которая, по сути, должна выполнять агрегирование событий, которые хранятся в журналах, во время выполнения запросов.

> [!NOTE]
> В Application Insights метрики, которые основаны на агрегировании данных о событиях и измерениях, хранящихся в журналах, при выполнении запросов, называются метриками на основе журналов. Эти метрики обычно имеют несколько измерений (в зависимости от свойств событий), благодаря чему они превосходно подходят для аналитики, но выборка и фильтрация отрицательно влияют на точность этих метрик.

## <a name="pre-aggregated-metrics"></a>Предварительно агрегированные метрики

Помимо метрик на основе журнала, в конце 2018 группа Application Insights поставляла общедоступную предварительную версию метрик, которые хранятся в специализированном репозитории, оптимизированном для временных рядов. Новые метрики больше не хранятся в виде отдельных событий с большим количеством свойств. Вместо этого они хранятся в виде предварительно агрегированных временных рядов и имеют только основные измерения. В результате новые метрики превосходно показали себя во время выполнения запросов: получение данных происходит гораздо быстрее и требует меньших затрат вычислительной мощности. Соответственно, это позволяет использовать новые сценарии, например [оповещения об измерениях метрик в режиме практически реального времени](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-near-real-time-metric-alerts), более быстродействующие [панели мониторинга](https://docs.microsoft.com/azure/azure-monitor/app/overview-dashboard) и многое другое.

> [!IMPORTANT]
> Метрики на основе журналов и предварительно агрегированные метрики сосуществуют в Azure Application Insights. Чтобы отличить эти два, в Application Insights UX предварительно агрегированные метрики теперь называются "стандартными метриками (Предварительная версия)", а традиционные метрики событий были переименованы в "метрики на основе журнала".

Более новые пакеты SDK (пакет SDK [Application Insights 2.7](https://www.nuget.org/packages/Microsoft.ApplicationInsights/2.7.2) или более поздней версии для .NET) выполняют предварительное агрегирование метрик в процессе сбора данных перед применением методов уменьшения объема данных телеметрии. Это означает, что точность новых метрик не влияет на выборку и фильтрацию при использовании последних пакетов SDK Application Insights.

Для пакетов SDK, которые не реализуют предварительную агрегацию (т. е. более ранние версии Application Insights пакетов SDK или для инструментирования браузера), Application Insights Серверная часть по-прежнему заполняет новые метрики, выполняя статистическую обработку событий, полученных конечной точкой сбора данных о событиях Application Insights. Это означает, что, хотя объем данных, передаваемых по сети, не имеет смысла, вы по-прежнему можете использовать предварительно агрегированные метрики и повысить производительность и поддержку обработки оповещений в режиме реального времени с помощью пакетов SDK, которые не являются предварительно агрегированными метриками во время сбора.

Стоит упомянуть, что перед выборкой при приеме конечная точка сбора данных выполняет предварительное агрегирование событий, и это означает, что [выборка при приеме](https://docs.microsoft.com/azure/application-insights/app-insights-sampling) никогда не влияет на точность предварительно агрегированных метрик независимо от версии пакета SDK, которую вы используете для своего приложения.  

## <a name="using-pre-aggregation-with-application-insights-custom-metrics"></a>Использование предварительного агрегирования для пользовательских метрик Application Insights

Вы можете использовать предварительное агрегирование для пользовательских метрик. Два основных преимущества этого — возможность настройки и создания оповещений для измерений пользовательской метрики и снижение объема данных, отправляемых из пакета SDK в конечную точку сбора данных Application Insights.

Существует несколько [способов отправки пользовательских метрик из пакета SDK Application Insights](https://docs.microsoft.com/azure/application-insights/app-insights-api-custom-events-metrics). Если в используемой вами версии пакета SDK есть методы [GetMetric и TrackValue](https://docs.microsoft.com/azure/application-insights/app-insights-api-custom-events-metrics#getmetric), то для отправки пользовательских метрик лучше всего использовать эти методы. В этом случае предварительное агрегирование будет выполняться в пакете SDK. Будет уменьшен не только объем данных, хранящихся в Azure, но и объем данных, передаваемых из пакета SDK в Application Insights. В противном случае используйте метод [trackMetric](https://docs.microsoft.com/azure/application-insights/app-insights-api-custom-events-metrics#trackmetric), который выполняет предварительное агрегирование событий метрик в процессе приема данных.

## <a name="custom-metrics-dimensions-and-pre-aggregation"></a>Измерения пользовательских метрик и предварительное агрегирование

Все отправляемые вами метрики, которые используют вызовы API [trackMetric](https://docs.microsoft.com/azure/application-insights/app-insights-api-custom-events-metrics#trackmetric) или [GetMetric и TrackValue](https://docs.microsoft.com/azure/application-insights/app-insights-api-custom-events-metrics#getmetric), автоматически сохраняются и в журналах, и в хранилищах метрик. В то время как для версии пользовательской метрики, основанной на журналах, всегда хранятся все измерения, для предварительно агрегированной версии по умолчанию метрики измерения не хранятся. Вы можете включить сбор измерений пользовательских метрик на вкладке [использование и оценочная стоимость](https://docs.microsoft.com/azure/application-insights/app-insights-pricing) , установив флажок "включить предупреждения для пользовательских измерений метрик": 

![Использование и ожидаемые затраты](./media/pre-aggregated-metrics-log-metrics/001-cost.png)

## <a name="why-is-collection-of-custom-metrics-dimensions-turned-off-by-default"></a>Почему сбор измерений пользовательских метрик выключен по умолчанию?

По умолчанию сбор измерений пользовательских метрик выключен, так как в будущем для услуги хранения пользовательских метрик с измерениями счета будут выставляться отдельно от счетов за использование Application Insights, а хранение пользовательских метрик без измерений будет бесплатным (в пределах квоты). Вы можете узнать о предстоящих изменениях модели ценообразования на нашей официальной [странице с ценами](https://azure.microsoft.com/pricing/details/monitor/).

## <a name="creating-charts-and-exploring-log-based-and-standard-pre-aggregated-metrics"></a>Создание диаграмм и изучение метрик на основе журналов и стандартных предварительно агрегированных метрик

Используйте [Azure Monitor обозреватель метрик](../platform/metrics-getting-started.md) , чтобы построить диаграммы из предварительно агрегированных и основанных на журналах метрик, а также для создания панелей мониторинга с диаграммами. Выбрав нужный ресурс Application Insights, с помощью средства выбора пространства имен вы можете переключаться между стандартными (ознакомительная версия) метриками и метриками на основе журналов либо выбирать пространства имен пользовательских метрик:

![Пространство имен метрик](./media/pre-aggregated-metrics-log-metrics/002-metric-namespace.png)

## <a name="pricing-models-for-application-insights-metrics"></a>Модели ценообразования для метрик Application Insights

При приеме метрик в Application Insights, как на основе журнала, так и с предварительно агрегированными, будут создаваться затраты на основе размера полученных данных, как описано [здесь](https://docs.microsoft.com/azure/azure-monitor/app/pricing#pricing-model). Пользовательские метрики, включая все ее измерения, всегда хранятся в Application Insights хранилище журналов. Кроме того, предварительно агрегированная версия пользовательских метрик (без измерений) перенаправляется в хранилище метрик по умолчанию.

Если выбрать параметр [включить предупреждения для настраиваемых измерений метрик](#custom-metrics-dimensions-and-pre-aggregation) для хранения всех измерений предварительно агрегированных метрик в хранилище метрик, может создать **Дополнительные** затраты на основе [цен на настраиваемые метрики](https://azure.microsoft.com/pricing/details/monitor/).

## <a name="next-steps"></a>Дальнейшие шаги

* [Создание оповещений в режиме практически реального времени](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-near-real-time-metric-alerts)
* [GetMetric и TrackValue](https://docs.microsoft.com/azure/application-insights/app-insights-api-custom-events-metrics#getmetric)