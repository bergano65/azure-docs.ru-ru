---
title: Мониторинг с помощью многошаговых веб-тестов (Azure Application Insights)
description: Настройка многошаговых веб-тестов для мониторинга веб-приложений в Azure Application Insights
ms.topic: conceptual
ms.date: 05/26/2020
ms.openlocfilehash: 04361f7b3306c5f7c164a849d8b05d7cf4756999
ms.sourcegitcommit: 64fc70f6c145e14d605db0c2a0f407b72401f5eb
ms.contentlocale: ru-RU
ms.lasthandoff: 05/27/2020
ms.locfileid: "83873353"
---
# <a name="multi-step-web-tests"></a>Многошаговые веб-тесты

Вы можете отслеживать записанную последовательность URL-адресов и взаимодействий с веб-сайтом с помощью многошаговых веб-тестов. Эта статья поможет вам создать многошаговый веб-тест с помощью Visual Studio Enterprise.

> [!NOTE]
> Многошаговые веб-тесты зависят от файлов веб-тестов в Visual Studio. Как было [объявлено](https://devblogs.microsoft.com/devops/cloud-based-load-testing-service-eol/) ранее, Visual Studio 2019 станет последней версией с поддержкой веб-тестов. При этом важно отметить следующее. Несмотря на отсутствие новых возможностей, предоставляемые возможности веб-тестов будут доступными в Visual Studio 2019 в течение всего жизненного цикла поддержки этого продукта. Группа разработчиков Azure Monitor ответила на многие вопросы о перспективах многоэтапных тестов доступности — см. [здесь](https://github.com/MicrosoftDocs/azure-docs/issues/26050#issuecomment-468814101).  
> </br>
> **Облако Azure для государственных организаций** [не поддерживает](https://docs.microsoft.com/azure/azure-government/) многошаговые веб-тесты.


## <a name="pre-requisites"></a>Предварительные требования

* Visual Studio 2017 Enterprise или более новая версия.
* Средства Visual Studio для тестирования производительности веб-сайтов и нагрузочного тестирования.

Чтобы найти эти обязательные средства тестирования, сделайте следующее: Запустите **Установщик Visual Studio** >  и выберите **Отдельные компоненты** > **Отладка и тестирование** > **Средства для тестирования производительности веб-сайтов и нагрузочного тестирования**.

![Снимок экрана: пользовательский интерфейс установщика Visual Studio, где выбран раздел "Отдельные компоненты" и установлен флажок рядом с пунктом "Средства для тестирования производительности веб-сайтов и нагрузочного тестирования"](./media/availability-multistep/web-performance-load-testing.png)

> [!NOTE]
> Многошаговые веб-тесты влекут определенные дополнительные затраты. Дополнительные сведения об этом см. в [официальном справочнике по ценам](https://azure.microsoft.com/pricing/details/application-insights/).

## <a name="record-a-multi-step-web-test"></a>Запись многошагового веб-теста 

> [!WARNING]
> Мы не рекомендуем использовать средство записи многошаговых веб-тестов. Оно было разработано для статических страниц HTML с простыми взаимодействиями и не предоставляет возможностей для работы с современными веб-страницами.

Рекомендации по созданию веб-тестов в Visual Studio см. в [официальной документации по Visual Studio 2019](https://docs.microsoft.com/visualstudio/test/how-to-create-a-web-service-test?view=vs-2019).

## <a name="upload-the-web-test"></a>Отправка веб-теста

1. На портале Application Insights в колонке "Доступность" выберите **Создать тест** > **Тип теста** > **Многошаговый веб-тест**.

2. Установите значения для параметров местоположений, частоты и оповещений.

### <a name="frequency--location"></a>Частота и расположение

|Параметр| Объяснение
|----|----|----|
|**Периодичность проведения тестирования**| Задает частоту выполнения теста для всех тестовых расположений. При стандартной частоте в пять минут и с пятью тестовыми расположениями ваш сайт будет проверяться в среднем каждую минуту.|
|**Расположения тестирования**| Определяет места, из которых наши серверы отправляют веб-запросы на указанный URL-адрес. Чтобы вы могли различать проблемы с веб-сайтом и сетью, **мы рекомендуем использовать не менее пяти расположений**. Вы можете выбрать до 16 таких расположений.

### <a name="success-criteria"></a>Критерии успешного завершения

|Параметр| Объяснение
|----|----|----|
| **Время ожидания тестирования** |Уменьшите значение этого параметра, чтобы получать оповещения о медленных откликах. Тест считается неудачной попыткой, если ответы от сайта не были получены в течение заданного периода. Если выбрать параметр **Анализировать зависимые запросы**, все изображения, файлы стилей, скрипты и другие зависимые ресурсы будут получены в течение этого периода.|
| **HTTP-ответ** | Возвращаемый код состояния, который считается успешным результатом. Код 200 указывает на возврат нормальной веб-страницы.|
| **Совпадение содержимого** | Произвольная строка, например "Welcome!". Проверим наличие точного совпадения (с учетом регистра) в каждом ответе. Это должна быть строка обычного текста без подстановочных знаков. Не забывайте, что если контент страницы изменяется, необходимо обновить эту строку. **В совпадении содержимого поддерживаются только символы английского алфавита** |

### <a name="alerts"></a>видны узлы

|Параметр| Объяснение
|----|----|----|
|**Почти в реальном времени (предварительная версия)** | Мы рекомендуем использовать оповещения "Почти в реальном времени". Настройка этого типа оповещений выполняется после создания теста доступности.  |
|**Классический** | Мы не рекомендуем использовать классический тип оповещений для новых тестов доступности.|
|**Пороговое значение для расположения оповещения**|Мы рекомендуем как минимум 3 из 5 расположений. Оптимальное отношение между пороговым значением для оповещения расположения и числом тестовых расположений: **пороговое значение для оповещения расположения** = **число расположений теста** – 2, минимум с пятью расположениями теста.|

## <a name="configuration"></a>Конфигурация

### <a name="plugging-time-and-random-numbers-into-your-test"></a>Включение значения времени и случайных чисел в тесты

Предположим, что вы тестируете инструмент, который получает зависящие от времени данные (например, запасы) от внешнего источника. При записи веб-теста необходимо использовать определенные значения времени, но они должны быть заданы как параметры теста StartTime и EndTime.

![Снимок экрана: приложение myawesomestockapp](./media/availability-multistep/app-insights-72webtest-parameters.png)

При запуске теста параметру EndTime следует всегда присваивать текущее время, а параметру StartTime – время за 15 минут до текущего.

Подключаемый модуль даты и времени позволяет указывать время в качестве параметров.

1. Добавьте подключаемые модули веб-теста для всех необходимых значений переменных параметров. На панели инструментов веб-теста выберите **Добавить подключаемый модуль веб-теста**.
    
    ![Добавление подключаемого модуля веб-тестов](./media/availability-multistep/app-insights-72webtest-plugin-name.png)
    
    В этом примере используется два экземпляра подключаемого модуля даты и времени. Для первого экземпляра будет задано время за 15 минут до текущего, а для второго — текущее время.

2. Откройте свойства каждого подключаемого модуля. Присвойте ему имя и настройте его для использования текущего времени. Для одного из экземпляров задайте для параметра "Добавление минут" значение "-15".

    ![Параметры контекста](./media/availability-multistep/app-insights-72webtest-plugin-parameters.png)

3. В параметрах веб-теста используйте {{имя подключаемого модуля}} для ссылки на имя подключаемого модуля.

    ![StartTime](./media/availability-multistep/app-insights-72webtest-plugins.png)

Теперь можно передать тест на портал. Он будет использовать динамические значения при каждом тестировании.

### <a name="dealing-with-sign-in"></a>Работа с входом

Если пользователи входят в приложение, вы можете протестировать страницы входа, используя несколько способов имитации входа. Выбор подхода зависит от типа безопасности в приложении.

Во всех случаях учетную запись в приложении следует создавать только для целей тестирования. По возможности ограничьте разрешения для этой тестовой учетной записи, чтобы веб-тесты не доставляли неудобств реальным пользователям.

**Простое имя пользователя и пароль.** Записывает веб-тест обычным образом. Сначала удалите файлы cookie.

**Проверка подлинности SAML**.

|Имя свойства| Описание|
|----|-----|
| URI аудитории | URI аудитории для токена SAML.  Это URI службы контроля доступа (ACS), в который включаются пространство имен и имя узла ACS. |
| Пароль сертификата | Это пароль для сертификата клиента, который предоставляет доступ к внедренному закрытому ключу. |
| Сертификат клиента  | Это сертификат клиента с закрытым ключом, который закодирован как строка Base64. |
| Идентификатор имени | Идентификатор имени для токена. |
| Не позднее | Срок действия токена.  Значение по умолчанию равно 5 минутам. |
| До | Срок действия токена, созданного ранее (на случай отклонений во времени).  Отрицательное значение; по умолчанию — 5 минут. |
| Имя целевого параметра контекста | Имя параметра контекста, в который будет записано сформированное утверждение. |


**Секрет клиента.** Если в приложении предусмотрен маршрут входа с использованием секрета клиента, используйте этот маршрут. Azure Active Directory (AAD) — это пример службы, в которой доступен вход в систему с использованием секрета клиента. В AAD секрет клиента — это ключ приложения.

Ниже приведен пример веб-теста веб-приложения Azure с использованием ключа приложения.

![Снимок экрана: пример](./media/availability-multistep/client-secret.png)

Получите токен из Azure AD с помощью секрета клиента (AppKey).
Извлеките токен носителя из ответа.
Вызовите интерфейс API, используя токен носителя в заголовке авторизации.
Убедитесь, что веб-тест является клиентом, т. е. имеет собственное приложение в AAD, и используйте соответствующие значения clientId и appkey. У тестируемой службы также есть собственное приложение в AAD: универсальный код ресурса URI appID этого приложения содержится в веб-тесте в поле resource.

### <a name="open-authentication"></a>Открытая проверка подлинности
Пример открытой проверки подлинности — это вход с помощью учетной записи Майкрософт или Google. Многие приложения, использующие OAuth, предоставляют альтернативный вариант с использованием секрета клиента, поэтому сначала стоит попробовать эту возможность.

Если в вашем тесте должен выполняться вход с использованием OAuth, общий порядок действий таков:

Проверьте трафик между веб-браузером, сайтом проверки подлинности и приложением при помощи Fiddler или аналогичного средства.
Выполните вход несколько раз с разных компьютеров или из разных браузеров либо через большие промежутки времени (чтобы истек срок действия маркеров).
Сравнивая различные сеансы, определите маркер, возвращаемый с сайта проверки подлинности, который затем передается на сервер приложения после входа.
Запишите веб-тест с помощью Visual Studio.
Параметризуйте маркеры, задав параметр при возврате маркера из структуры проверки подлинности и использовав его в запросе к сайту. (Visual Studio попытается параметризовать тест, но не сможет правильно параметризовать маркеры).

## <a name="troubleshooting"></a>Устранение неполадок

См. инструкции по [устранению неполадок](troubleshoot-availability.md).

## <a name="next-steps"></a>Дальнейшие действия

* [Оповещения о доступности](availability-alerts.md)
* [Веб-тесты проверки связи по URL-адресу](monitor-web-app-availability.md)
