---
title: Устранение неполадок в Azure Application Insights Profiler
description: В этой статье представлены действия по устранению неполадок и сведения, помогающие разработчикам включать и использовать Application Insights Profiler.
ms.topic: conceptual
author: cweining
ms.author: cweining
ms.date: 08/06/2018
ms.reviewer: mbullwin
ms.openlocfilehash: 47a452377c8fed9808957f45fcc4ec686fcef87d
ms.sourcegitcommit: 77ab078e255034bd1a8db499eec6fe9b093a8e4f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/16/2020
ms.locfileid: "97561041"
---
# <a name="troubleshoot-problems-enabling-or-viewing-application-insights-profiler"></a>Устранение неполадок по включению и просмотру Application Insights Profiler

> [!CAUTION]
> Обнаружена ошибка профилировщика для ASP.NET Core приложений в службе приложений Azure. У нас есть исправление, но развертывание в мире займет несколько недель. Вы можете обойти ошибку, добавив пакет SDK Application Insights в приложение с помощью приведенных [здесь](./asp-net-core.md#enable-application-insights-server-side-telemetry-visual-studio)инструкций.

## <a name="general-troubleshooting"></a><a id="troubleshooting"></a>Общие сведения об устранении неполадок

### <a name="profiles-are-uploaded-only-if-there-are-requests-to-your-application-while-profiler-is-running"></a>Профили загружаются только в том случае, если есть запросы к вашему приложению во время работы Profiler

Azure Application Insights Profiler собирает данные в течение двух минут каждый час. Кроме того, при нажатии кнопки **Profile Now (профиль** ) на панели **Configure Application Insights Profiler (Настройка** профиля) также можно получить данные.

> [!NOTE]
> Данные профилирования передаются только в том случае, если они могут быть присоединены к запросу, произошедшему во время работы профилировщика. 

Profiler записывает сообщения трассировки и пользовательские события в ресурс Application Insights. Эти события можно использовать для просмотра работы профилировщика.

1. Выполните поиск сообщений трассировки и пользовательских событий, записанных с помощью Profiler в ресурс Application Insights. Можно использовать эту строку для поиска необходимых данных:

    ```
    stopprofiler OR startprofiler OR upload OR ServiceProfilerSample
    ```
    На приведенном ниже снимке экрана показан пример выполнения двух операций поиска на двух разных ресурсах ИИ. 
    
   * В левой части приведено приложение, которое не получает запросы во время работы Profiler. Отображается сообщение со сведениями о том, что отправка была отменена из-за отсутствия действий. 

   * Справа можно увидеть, что Profiler запущен и уже отправил пользовательские события при обнаружении запросов, которые появились во время его работы. Если `ServiceProfilerSample` отображается пользовательское событие, это означает, что профиль был захвачен и доступен в области **производительности Application Insights** .

     Если записи не отображаются, профилировщик не выполняется. Вам потребуется прочитать разделы по устранению неполадок для конкретного типа приложения, приведенные ниже в этой статье.  

     ![Поиск данных телеметрии Profiler][profiler-search-telemetry]

### <a name="other-things-to-check"></a>Что нужно еще проверить:
* Проверьте, работает ли приложение на платформе .NET Framework 4.6.
* Если веб-приложение является приложением ASP.NET Core, оно должно работать под управлением ASP.NET Core 2.0.
* Если данные, которые вы пытаетесь просмотреть, хранятся дольше нескольких недель, попробуйте ограничить фильтр времени и повторите попытку. Трассировки удаляются через 7 дней.
* Убедитесь, что учетные записи-посредники или брандмауэр не блокировали доступ к https://gateway.azureserviceprofiler.net .
* Профилировщик не поддерживается в планах службы приложений "бесплатный" или "общий". Если вы используете один из этих планов, попробуйте выполнить масштабирование до одного из базовых планов и профилировщика, которые должны начать работу.

### <a name="double-counting-in-parallel-threads"></a><a id="double-counting"></a>Двойной подсчет в параллельных потоках

В некоторых случаях значение метрики общего времени в средстве просмотра стека больше, чем длительность запроса.

Такая ситуация может возникать, когда с запросом связано два или более параллельных потока. В таком случае общее время потока будет больше затраченного времени.

Один поток может ожидать завершения другого. Средство просмотра пытается это обнаружить и исключить ненужное ожидание. При этом вместо исключения отображается слишком много сведений. Это могут быть критически важные сведения.

При появлении параллельных потоков в трассировке определите, какие потоки ожидают, чтобы можно было определить критический путь для запроса.

Обычно поток, который быстро переходит в состояние ожидания, просто ожидает другие потоки. Сосредоточьтесь на других потоках и игнорируйте время ожидания потоков.

### <a name="error-report-in-the-profile-viewer"></a>Отчет об ошибках в средстве просмотра данных о профилировании
Отправьте запрос в службу поддержки на портале. Обязательно укажите идентификатор корреляции из сообщения об ошибке.

## <a name="troubleshoot-profiler-on-azure-app-service"></a>Устранение проблем с Profiler в Службе приложений Azure
Для правильной работы Profiler:
* Необходимо использовать план службы веб-приложений уровня "Базовый" или выше.
* Для веб-приложения нужно включить Application Insights.
* Веб-приложение должно иметь следующие параметры приложения:

    |Параметр приложения    | Значение    |
    |---------------|----------|
    |APPINSIGHTS_INSTRUMENTATIONKEY         | iKey для ресурса Application Insights    |
    |APPINSIGHTS_PROFILERFEATURE_VERSION | 1.0.0 |
    |DiagnosticServices_EXTENSION_VERSION | ~3 |


* Веб-задание **ApplicationInsightsProfiler3** должно быть запущено. Чтобы проверить веб-задание:
   1. Перейдите к [Kudu](/archive/blogs/cdndevs/the-kudu-debug-console-azure-websites-best-kept-secret).
   1. В меню **Tools** (Средства) выберите **WebJobs Dashboard** (Панель мониторинга веб-заданий).  
      Откроется область **WebJobs** (Веб-задания). 
   
      ![На снимке экрана показана область веб-заданий, в которой отображаются имя, состояние и время последнего выполнения заданий.][profiler-webjob]   
   
   1. Чтобы просмотреть сведения о веб-задании, включая журнал, щелкните ссылку **ApplicationInsightsProfiler3** .  
     Откроется область **Continuous WebJob Details** (Сведения о непрерывных веб-заданиях).

      ![На снимке экрана показана область сведений о непрерывном веб-процессе.][profiler-webjob-log]

Если профилировщик не работает, можно скачать журнал и отправить его в нашу группу за помощью serviceprofilerhelp@microsoft.com .

### <a name="check-the-diagnostic-services-site-extension-status-page"></a>Проверка страницы "состояние" расширения сайта служб диагностики
Если профилировщик был включен с помощью [панели Application Insights](profiler.md) на портале, он был включен расширением веб-сайта служб диагностики.

Страницу состояния этого расширения можно проверить, перейдя по следующему URL-адресу: `https://{site-name}.scm.azurewebsites.net/DiagnosticServices`

> [!NOTE]
> Домен ссылки на страницу состояния будет зависеть от облака.
Этот домен будет таким же, как и сайт управления KUDU для службы приложений.

На этой странице состояния указывается состояние установки для агентов профилировщика и Snapshot Collector. Если произошла непредвиденная ошибка, она отобразится и покажет, как ее исправить.

Вы можете использовать сайт управления KUDU для службы приложений, чтобы получить базовый URL-адрес этой страницы состояния:
1. Откройте службу приложений на портале Azure.
2. Выберите **Дополнительные инструменты** или выполните поиск по запросу **KUDU**.
3. Выберите **Перейти**.
4. На сайте управления KUDU в URL-адресе **добавьте следующий текст `/DiagnosticServices` и нажмите клавишу ВВОД**.
 Он завершится следующим образом: `https://<kudu-url>/DiagnosticServices`

Отобразится страница состояния, аналогичная приведенной ниже: ![ страница состояние служб диагностики.](./media/diagnostic-services-site-extension/status-page.png)
    
### <a name="manual-installation"></a>Установка вручную

При настройке профилировщика в параметры веб-приложения вносятся обновления. Обновления можно применить вручную, если этого требует ваша среда. Например, если приложение выполняется в среде веб-приложений для PowerApps. Чтобы применить обновления вручную, выполните следующие действия.

1. В области **управления веб-приложением** откройте **Параметры**.

1. Задайте для **.NET Framework версию** **4.6**.

1. Установите для параметра **Всегда включено** значение **Включено**.
1. Создайте следующие параметры приложения:

    |Параметр приложения    | Значение    |
    |---------------|----------|
    |APPINSIGHTS_INSTRUMENTATIONKEY         | iKey для ресурса Application Insights    |
    |APPINSIGHTS_PROFILERFEATURE_VERSION | 1.0.0 |
    |DiagnosticServices_EXTENSION_VERSION | ~3 |

### <a name="too-many-active-profiling-sessions"></a>Слишком много активных сеансов профилирования

Профилировщик можно включить не более чем в четырех веб-приложениях, работающих в одном плане обслуживания. Если у вас больше четырех, профилировщик может создать исключение *Microsoft. сервицепрофилер. Exceptions. туманетвсессионексцептион*. Чтобы решить эту проблему, переместите некоторые веб-приложения в другой план обслуживания.

### <a name="deployment-error-directory-not-empty-dhomesitewwwrootapp_datajobs"></a>Ошибка развертывания: каталог не пустой "D:\\домашний\\сайт\\wwwroot\\App_Data\\jobs"

При повторном развертывании в ресурсе веб-приложений с включенным Profiler может отобразиться сообщение, содержащее сведения о следующей ошибке:

*Каталог не пуст, d: \\ домашний \\ сайт \\ wwwroot \\ App_Data \\ задания "*

Эта ошибка возникает при запуске веб-развертывание из скриптов или из Azure Pipelines. Чтобы устранить эту проблему, необходимо добавить приведенные ниже параметры развертывания в задачу веб-развертывания.

```
-skip:Directory='.*\\App_Data\\jobs\\continuous\\ApplicationInsightsProfiler.*' -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data\\jobs\\continuous$' -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data\\jobs$'  -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data$'
```

Эти параметры удаляют папку, используемую Application Insights Profiler, и разблокируют процесс повторного развертывания. Текущий запущенный экземпляр профилировщика не будет затронут.

### <a name="how-do-i-determine-whether-application-insights-profiler-is-running"></a>Как определить, работает ли Application Insights Profiler?

Profiler запускается в качестве непрерывного веб-задания в веб-приложении. Вы можете открыть ресурс веб-приложения в [портал Azure](https://portal.azure.com). Проверьте состояние **ApplicationInsightsProfiler** в области **Веб-задания**. Если он не работает, откройте **Журналы**, чтобы просмотреть дополнительные сведения.

## <a name="troubleshoot-vms-and-cloud-services"></a>Устранение неполадок виртуальных машин и облачных служб

>**Исправлена ошибка в профилировщике, который поставляется в WAD для облачных служб.** Последняя версия WAD (1.12.2.0) для облачных служб работает со всеми последними версиями пакета SDK для App Insights. Узлы облачных служб будут автоматически обновлять WAD, но это немедленный процесс. Чтобы принудительно выполнить обновление, можно повторно развернуть службу или перезагрузить узел.

Чтобы узнать, правильно ли настроен профилировщик, система диагностики Azure, выполните следующие действия. 
1. Убедитесь, что содержимое развернутой конфигурации система диагностики Azure является предполагаемым. 

1. Во-вторых, убедитесь, что система диагностики Azure передает правильный ключ инструментирования iKey в командной строке Profiler. 

1. В-третьих, просмотрите файл журнала Profiler, чтобы выяснить, почему Profiler получает ошибку при работе. 

Чтобы проверить параметры, которые использовались для системы диагностики Azure:

1. Войдите на виртуальную машину, а затем откройте файл журнала в этом расположении. Версия подключаемого модуля может быть более новой на компьютере.
    
    Для виртуальных машин:
    ```
    c:\WindowsAzure\logs\Plugins\Microsoft.Azure.Diagnostics.PaaSDiagnostics\1.11.3.12\DiagnosticsPlugin.log
    ```
    
    Для облачных служб:
    ```
    c:\logs\Plugins\Microsoft.Azure.Diagnostics.PaaSDiagnostics\1.11.3.12\DiagnosticsPlugin.log  
    ```

1. В этом файле в строке **WadCfg** вы найдете параметры, которые были переданы на виртуальную машину для настройки системы диагностики Azure. Можно проверить правильность ключа инструментирования, который используется в приемнике Profiler.

1. Проверьте командную строку, которая используется для запуска Profiler. Аргументы, используемые для запуска профилировщика, находятся в следующем файле. (Диск может иметь значение c: или d:, и каталог может быть скрытым.)

    Для виртуальных машин:
    ```
    C:\ProgramData\ApplicationInsightsProfiler\config.json
    ```
    
    для облачных служб:
    ```
    D:\ProgramData\ApplicationInsightsProfiler\config.json
    ```

1. Проверьте правильность ключа инструментирования ikey в командной строке Profiler. 

1. Используя путь, указанный в предыдущем *config.js* файле, проверьте файл журнала профилировщика с именем **бутстрапн. log**. Он отобразит информацию об отладке, включающую параметры, используемые Profiler. Также отобразятся сообщения о состоянии и ошибках из Profiler.  

    Для виртуальных машин файл находится здесь:
    ```
    C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics\1.17.0.6\ApplicationInsightsProfiler
    ```

    Для облачных служб:
    ```
    C:\Logs\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics\1.17.0.6\ApplicationInsightsProfiler
    ```

    Если профилировщик выполняется во время получения запросов приложением, отображается следующее сообщение: *Activity, обнаруженная из iKey*. 

    При передаче трассировки отображается следующее сообщение: *Начало передачи трассировки*. 


## <a name="edit-network-proxy-or-firewall-rules"></a>Изменение правил прокси-сервера сети или брандмауэра

Если приложение подключается к Интернету через прокси-сервер или брандмауэр, может потребоваться обновить правила для взаимодействия со службой профилировщика.

IP-адреса, используемые Application Insights Profiler, включены в тег службы Azure Monitor. Дополнительные сведения см. в [документации по тегам служб](https://docs.microsoft.com/azure/virtual-network/service-tags-overview).


[profiler-search-telemetry]:./media/profiler-troubleshooting/Profiler-Search-Telemetry.png
[profiler-webjob]:./media/profiler-troubleshooting/Profiler-webjob.png
[profiler-webjob-log]:./media/profiler-troubleshooting/Profiler-webjob-log.png
