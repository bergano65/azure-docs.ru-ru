---
title: Устранение неполадок в Azure с помощью Application Insights Profiler | Документация Майкрософт
description: В этой статье содержатся инструкции по устранению неполадок и сведения, помогающие разработчикам в решении проблем с включением или использованием Application Insights Profiler.
services: application-insights
documentationcenter: ''
author: cweining
manager: carmonm
ms.service: application-insights
ms.workload: tbd
ms.tgt_pltfrm: ibiza
ms.topic: conceptual
ms.reviewer: mbullwin
ms.date: 08/06/2018
ms.author: cweining
ms.openlocfilehash: b6a7fe2c12b2f1f5bcc0ba8cccd1a51ee39c4a6f
ms.sourcegitcommit: 90cec6cccf303ad4767a343ce00befba020a10f6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/07/2019
ms.locfileid: "55882096"
---
# <a name="troubleshoot-problems-enabling-or-viewing-application-insights-profiler"></a>Устранение неполадок по включению и просмотру Application Insights Profiler

## <a id="troubleshooting"></a>Общие действия по устранению неполадок

### <a name="profiles-are-uploaded-only-if-there-are-requests-to-your-application-while-profiler-is-running"></a>Профили загружаются только в том случае, если есть запросы к вашему приложению во время работы Profiler

Azure Application Insights Profiler собирает данные профилирования в течение двух минут каждый час. Он также собирает данные, когда вы нажимаете кнопку **Профилировать** на панели **Configure Application Insights Profiler** (Настройка Application Insights Profiler). Но данные профилирования отправляются только тогда, когда их можно привязать к запросу, который появился во время работы Profiler. 

Profiler записывает сообщения трассировки и пользовательские события в ресурс Application Insights. Можно использовать эти события, чтобы просмотреть работу Profiler. Если предполагается, что Profiler должен работать и захватывать трассировки, но они не отображаются на странице **Производительность**, вы можете проверить работу Profiler с помощью таких действий.

1. Выполните поиск сообщений трассировки и пользовательских событий, записанных с помощью Profiler в ресурс Application Insights. Можно использовать эту строку для поиска необходимых данных:

    ```
    stopprofiler OR startprofiler OR upload OR ServiceProfilerSample
    ```
    На приведенном ниже снимке экрана показан пример выполнения двух операций поиска на двух разных ресурсах ИИ. 
    
    * В левой части приведено приложение, которое не получает запросы во время работы Profiler. Отображается сообщение со сведениями о том, что отправка была отменена из-за отсутствия действий. 

    * Справа можно увидеть, что Profiler запущен и уже отправил пользовательские события при обнаружении запросов, которые появились во время его работы. Если отображается пользовательское событие ServiceProfilerSample, это означает, что Profiler вложил трассировку в запрос и вы можете просмотреть трассировку на панели **производительности Application Insights**.

    Если вы не видите никакой телеметрии вообще, то Profiler не работает. Вам потребуется прочитать разделы по устранению неполадок для конкретного типа приложения, приведенные ниже в этой статье.  

     ![Поиск данных телеметрии Profiler][profiler-search-telemetry]

1. Если запросы возникают во время работы Profiler, убедитесь, что они обрабатываются в рамках вашего приложения, в котором включен Profiler. Хотя приложения иногда состоят из нескольких компонентов, Profiler доступен только для некоторых из них. На панели **Configure Application Insights Profiler** (Настройка Application Insights Profiler) отобразятся компоненты с отправленной трассировкой.

### <a name="other-things-to-check"></a>Что нужно еще проверить:
* Проверьте, работает ли приложение на платформе .NET Framework 4.6.
* Если веб-приложение является приложением ASP.NET Core, оно должно работать под управлением ASP.NET Core 2.0.
* Если данные, которые вы пытаетесь просмотреть, хранятся дольше нескольких недель, попробуйте ограничить фильтр времени и повторите попытку. Трассировки удаляются через 7 дней.
* Убедитесь, что доступ к https://gateway.azureserviceprofiler.net для прокси-серверов или брандмауэра не заблокирован.

### <a id="double-counting"></a>Двойной подсчет в параллельных потоках

В некоторых случаях значение метрики общего времени в средстве просмотра стека больше, чем длительность запроса.

Это может произойти при наличии нескольких потоков, связанных с запросом и работающих в параллельном режиме. В таком случае общее время потока будет больше затраченного времени. Один поток может ожидать завершения другого. Средство просмотра пытается это обнаружить и исключить ненужное ожидание. При этом вместо исключения отображается слишком много сведений. Это могут быть критически важные сведения.

Обнаружив параллельные потоки в трассировках, укажите, какие потоки находятся в состоянии ожидания, чтобы можно было определить критический путь к запросу. Обычно поток, который быстро переходит в состояние ожидания, просто ожидает другие потоки. Сосредоточьтесь на других потоках и игнорируйте время ожидания потоков.

### <a name="error-report-in-the-profile-viewer"></a>Отчет об ошибках в средстве просмотра данных о профилировании
Отправьте запрос в службу поддержки на портале. Обязательно укажите идентификатор корреляции из сообщения об ошибке.

## <a name="troubleshoot-profiler-on-azure-app-service"></a>Устранение проблем с Profiler в Службе приложений Azure
Для правильной работы Profiler:
* Необходимо использовать план службы веб-приложений уровня "Базовый" или выше.
* Для веб-приложения нужно включить Application Insights.
* Веб-приложение должно содержать параметр приложения **APPINSIGHTS_INSTRUMENTATIONKEY**, настроенный с тем же ключом инструментирования, который использует пакет SDK Application Insights.
* Веб-приложение должно иметь параметр приложения **APPINSIGHTS_PROFILERFEATURE_VERSION**, определенный и настроенный в соответствии с версией 1.0.0.
* В веб-приложении должен быть определен параметр **DiagnosticServices_EXTENSION_VERSION** со значением ~3.
* Веб-задание **ApplicationInsightsProfiler3** должно быть запущено. Чтобы проверить веб-задание:
   1. Перейдите к [Kudu](https://blogs.msdn.microsoft.com/cdndevs/2015/04/01/the-kudu-debug-console-azure-websites-best-kept-secret/).
   1. В меню **Tools** (Средства) выберите **WebJobs Dashboard** (Панель мониторинга веб-заданий).  
      Откроется область **WebJobs** (Веб-задания). 
   
      ![profiler-webjob]   
   
   1. Щелкните ссылку **ApplicationInsightsProfiler2**, чтобы получить подробную информацию о веб-задании, включая журнал.  
     Откроется область **Continuous WebJob Details** (Сведения о непрерывных веб-заданиях).

      ![profiler-webjob-log]

Скачайте журнал и отправьте его нашей команде, чтобы выяснить причину отказа запуска Profiler. 
    
### <a name="manual-installation"></a>Ручная установка

При настройке профилировщика в параметры веб-приложения вносятся обновления. Обновления можно применить вручную, если этого требует ваша среда. Например, если приложение выполняется в среде веб-приложений для PowerApps. Чтобы применить обновления вручную, сделайте следующее:

1. В области **управления веб-приложением** выберите **Параметры**.

1. Для **платформы .NET Framework** установите версию **4.6**.

1. Установите для параметра **Всегда включено** значение **Включено**.

1. Добавьте параметр приложения **APPINSIGHTS_INSTRUMENTATIONKEY** и задайте для него значение с тем же ключом инструментирования, который используется пакетом SDK.

1. Добавьте параметр приложения **APPINSIGHTS_PROFILERFEATURE_VERSION** и задайте ему значение 1.0.0.

1. Добавьте параметр **DiagnosticServices_EXTENSION_VERSION** и укажите значение ~3.

### <a name="too-many-active-profiling-sessions"></a>Слишком много активных сеансов профилирования

Сейчас вы можете включить профилировщик не более, чем в четырех веб-приложениях Azure и слотах развертывания, работающих в рамках одного плана службы. Если в рамках одного плана службы приложений у вас работает больше четырех веб-приложений, Profiler может вызвать исключение *Microsoft.ServiceProfiler.Exceptions.TooManyETWSessionException*. Profiler запускается отдельно для каждого веб-приложения и пытается запустить сеанс трассировки событий Windows (ETW) для каждого приложения. Существует ограничение на количество сеансов ETW, выполняемых одновременно. Если веб-задание Profiler содержит слишком много активных сеансов профилирования, то перенесите некоторые веб-приложения в другой план службы.

### <a name="deployment-error-directory-not-empty-dhomesitewwwrootappdatajobs"></a>Ошибка развертывания: "Каталог не пустой "D:\\домашний\\сайт\\wwwroot\\App_Data\\jobs"".

При повторном развертывании в ресурсе веб-приложений с включенным Profiler может отобразиться сообщение, содержащее сведения о следующей ошибке:

*Каталог не пустой "D:\\домашний\\сайт\\wwwroot\\App_Data\\jobs"*.

Эта ошибка происходит при запуске веб-развертывания с помощью сценариев или в конвейере развертывания Azure DevOps. Чтобы устранить эту проблему, необходимо добавить приведенные ниже параметры развертывания в задачу веб-развертывания.

```
-skip:Directory='.*\\App_Data\\jobs\\continuous\\ApplicationInsightsProfiler.*' -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data\\jobs\\continuous$' -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data\\jobs$'  -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data$'
```

Эти параметры удаляют папку, используемую Application Insights Profiler, и разблокируют процесс повторного развертывания. Текущий запущенный экземпляр профилировщика не будет затронут.

### <a name="how-do-i-determine-whether-application-insights-profiler-is-running"></a>Как определить, работает ли Application Insights Profiler?

Profiler запускается в качестве непрерывного веб-задания в веб-приложении. Вы можете открыть ресурс веб-приложения на [портале Azure](https://portal.azure.com). Проверьте состояние **ApplicationInsightsProfiler** в области **Веб-задания**. Если он не работает, откройте **Журналы**, чтобы просмотреть дополнительные сведения.

## <a name="troubleshoot-problems-with-profiler-and-azure-diagnostics"></a>Устранение неполадок с Profiler и системой диагностики Azure

Существуют три шага, чтобы проверить, что Profiler настроен правильно с помощью системы диагностики Azure. 
1. Сначала убедитесь, что содержимое развернутой конфигурации системы диагностики Azure соответствует вашим ожиданиям. 

1. Во-вторых, убедитесь, что система диагностики Azure передает правильный ключ инструментирования iKey в командной строке Profiler. 

1. В-третьих, просмотрите файл журнала Profiler, чтобы выяснить, почему Profiler получает ошибку при работе. 

Чтобы проверить параметры, которые использовались для системы диагностики Azure:

1. Войдите на виртуальную машину и откройте файл журнала в этом расположении: 

    ```
    c:\logs\Plugins\Microsoft.Azure.Diagnostics.PaaSDiagnostics\1.11.3.12\DiagnosticsPlugin.logs  
    ```

1. В этом файле в строке **WadCfg** вы найдете параметры, которые были переданы на виртуальную машину для настройки системы диагностики Azure. Можно проверить правильность ключа инструментирования, который используется в приемнике Profiler.

1. Проверьте командную строку, которая используется для запуска Profiler. Следующий файл содержит аргументы, используемые для запуска Profiler:

    ```
    D:\ProgramData\ApplicationInsightsProfiler\config.json
    ```

1. Проверьте правильность ключа инструментирования ikey в командной строке Profiler. 

1. Используя путь, обнаруженный в файле *config.json* выше, проверьте файл журнала Profiler. Он отобразит информацию об отладке, включающую параметры, используемые Profiler. Также отобразятся сообщения о состоянии и ошибках из Profiler.  

    Если Profiler работает, пока приложение получает запросы, отобразится следующее сообщение: *Activity detected from iKey* (Обнаружены действия с использованием iKey). 

    При отправке трассировки отображается следующее сообщение: *Start to upload trace* (Начало отправки трассировки). 


[profiler-search-telemetry]:./media/profiler-troubleshooting/Profiler-Search-Telemetry.png
[profiler-webjob]:./media/profiler-troubleshooting/Profiler-webjob.png
[profiler-webjob-log]:./media/profiler-troubleshooting/Profiler-webjob-log.png








