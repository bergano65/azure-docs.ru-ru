---
title: Snapshot Debugger Application Insights Azure для приложений .NET
description: Отладочные моментальные снимки автоматически собираются при порождении исключений в рабочих приложениях .NET
ms.topic: conceptual
ms.custom: devx-track-dotnet
ms.date: 10/23/2019
ms.reviewer: cweining
ms.openlocfilehash: ab142b4e0a2d5486727ffc71fc94ae4944513052
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "88935812"
---
# <a name="debug-snapshots-on-exceptions-in-net-apps"></a>Отладочные моментальные снимки для исключений в приложениях .NET
При возникновении исключения, можно автоматически собирать отладочный моментальный снимок из работающего веб-приложения. Моментальный снимок отображает состояние исходного кода и переменных в момент порождения этого исключения. Snapshot Debugger в [Azure Application Insights](./app-insights-overview.md) отслеживает данные телеметрии исключений из веб-приложения. Он собирает моментальные снимки для наиболее частых исключений, чтобы предоставить вам необходимые сведения для диагностики проблем в рабочей среде. Включите в приложение [пакет NuGet сборщика моментальных снимков](https://www.nuget.org/packages/Microsoft.ApplicationInsights.SnapshotCollector) и при необходимости настройте параметры коллекции в [ApplicationInsights.config](./configuration-with-applicationinsights-config.md). Моментальные снимки отображаются на [исключениях](./asp-net-exceptions.md) на портале Application Insights.

Вы можете просмотреть отладочные моментальные снимки на портале, чтобы изучить стек вызовов и проверить значения переменных в каждом кадре стека вызовов. Чтобы получить более широкие возможности отладки с помощью исходного кода, откройте моментальные снимки с помощью Visual Studio 2019 Enterprise. В Visual Studio можно также [задать точек прикрепления для интерактивного создания моментальных снимков](https://aka.ms/snappoint) без ожидания исключения.

Отладочные моментальные снимки хранятся в течение 15 дней. Такая политика хранения задается для каждого приложения отдельно. Если нужно изменить этот параметр, вы можете запросить изменения, открыв окно Службы Поддержки на портале Microsoft Azure.

## <a name="enable-application-insights-snapshot-debugger-for-your-application"></a>Включение Snapshot Debugger Application Insights для приложения
Коллекция моментальных снимков доступна для:
* .NET Framework и приложений ASP.NET выполняющихся с помощью .NET Framework 4.5 или более поздней версии.
* .NET Core 2.0 и приложений ASP.NET Core 2.0 под управлением Windows.

Поддерживаются следующие среды:

* [Служба приложений Azure](snapshot-debugger-appservice.md?toc=/azure/azure-monitor/toc.json)
* [Облачные службы Azure](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json) под управлением ОС семейства 4 или более поздней версии
* [Службы Service Fabric Azure](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json) , работающие под Windows Server 2012 R2 или более поздней версии
* [Виртуальные машины Azure и масштабируемые наборы виртуальных машин](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json) под Windows Server 2012 R2 или более поздней версии
* [Локальные виртуальные или физические компьютеры](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json) под управлением Windows Server 2012 R2 или более поздней версии или Windows 8.1 или более поздней версии.

> [!NOTE]
> Клиентские приложения (например, WPF, Windows Forms или UWP) не поддерживаются.

Если вы включили Snapshot Debugger но не видите моментальные снимки, ознакомьтесь с нашим [руководством по устранению неполадок](snapshot-debugger-troubleshoot.md?toc=/azure/azure-monitor/toc.json).

## <a name="grant-permissions"></a>Предоставить разрешения

Доступ к моментальным снимкам защищен с помощью управления доступом на основе ролей (RBAC). Чтобы проверить моментальный снимок, вы сначала должны быть добавлены к нужной роли владельцем подписки.

> [!NOTE]
> Владельцы и участники не получают эту роль автоматически. При необходимости просмотреть моментальные снимки нужно самостоятельно добавиться к роли.

Владельцам подписки следует назначить роль `Application Insights Snapshot Debugger` пользователям, которые будут проверять моментальные снимки. Владельцы подписок могут назначить эту роль отдельным пользователям или группам для целевого ресурса Application Insights или его группы ресурсов или подписки.

1. Перейдите к ресурсу Application Insights на портале Azure.
1. Щелкните **Управление доступом (IAM)** .
1. Нажмите кнопку **+ добавить назначение роли** .
1. В раскрывающемся списке **Роли** выберите **Отладчик моментальных снимков Application Insights**.
1. Выполните поиск и введите имя пользователя, который будет добавлен.
1. Нажмите кнопку **Сохранить**, чтобы добавить пользователя к роли.


> [!IMPORTANT]
> Моментальные снимки могут содержать личные и другие конфиденциальные данные в значениях переменных и параметров.

## <a name="view-snapshots-in-the-portal"></a>Просмотр моментальных снимков на портале

После возникновения исключения в приложении и создания моментального снимка должны быть моментальные снимки для просмотра. Создание моментального снимка и его просмотр на портале может занять от 5 до 10 минут. Чтобы просмотреть моментальные снимки, на панели **сбоя** нажмите кнопку **операции** при просмотре вкладки **операции** или нажмите кнопку **исключения** при просмотре вкладки **исключения** :

![Страница "ошибки"](./media/snapshot-debugger/failures-page.png)

Выберите операцию или исключение на правой панели, чтобы открыть панель **подробных сведений о транзакциях** , а затем выберите событие исключения. Если для данного исключения доступен моментальный снимок, на правой панели появится кнопка **Открыть отладочный моментальный снимок** с подробными сведениями об [исключении](./asp-net-exceptions.md).

![Кнопка "Open Debug Snapshot" (Открыть отладочный моментальный снимок) для исключения](./media/snapshot-debugger/e2e-transaction-page.png)

В представлении "Debug Snapshot" (Отладочный моментальный снимок) можно увидеть стек вызовов и область переменных. При выборе кадров стека вызовов в области стека вызовов можно просматривать локальные переменные и параметры для этого вызова функции в области переменных.

![Просмотр отладочного моментального снимка на портале](./media/snapshot-debugger/open-snapshot-portal.png)

Моментальные снимки могут содержать конфиденциальные сведения и по умолчанию не отображаются. Для просмотра моментальных снимков вам должна быть назначена роль `Application Insights Snapshot Debugger`.

## <a name="view-snapshots-in-visual-studio-2017-enterprise-or-above"></a>Просмотр моментальных снимков в Visual Studio 2017 Enterprise или более поздней версии
1. Нажмите кнопку **скачать моментальный снимок** , чтобы скачать `.diagsession` файл, который можно открыть с помощью Visual Studio Enterprise.

2. Чтобы открыть `.diagsession` файл, необходимо установить компонент snapshot Debugger Visual Studio. Компонент Snapshot Debugger является обязательным компонентом рабочей нагрузки ASP.net в Visual Studio и может быть выбран из списка отдельных компонентов в установщике Visual Studio. Если вы используете версию Visual Studio до Visual Studio 2017 версии 15,5, необходимо установить расширение из [Visual Studio Marketplace](https://aka.ms/snapshotdebugger).

3. После открытия файла моментального снимка в Visual Studio появится страница мини-дампа отладки. Щелкните **Debug Managed Code** (Отладить управляемый код), чтобы начать отладку моментального снимка. Откроется строка кода, на которой было порождено исключение, и вы сможете выполнить отладку текущего состояния процесса.

    ![Просмотр отладочного моментального снимка в Visual Studio](./media/snapshot-debugger/open-snapshot-visualstudio.png)

Загруженный моментальный снимок содержит все файлы символов, найденные на сервере веб-приложения. Эти файлы символов требуются для связывания данных моментального снимка с исходным кодом. Для приложений службы приложений не забудьте включить развертывание символов при публикации веб-приложения.

## <a name="how-snapshots-work"></a>Как работают моментальные снимки

Сборщик моментальных снимков реализуется в виде [обработчика телеметрии Application Insights](./configuration-with-applicationinsights-config.md#telemetry-processors-aspnet). При запуске приложения обработчик телеметрии как компонент сборщика моментальных снимков добавляется в конвейер телеметрии вашего приложения.
Каждый раз, когда приложение вызывает [TrackException](./asp-net-exceptions.md#exceptions), сборщик моментальных снимков вычисляет идентификатор проблемы из типа вызываемого исключения и метод создания исключения.
При этом значение счетчика увеличивается для соответствующего идентификатора проблемы. Когда счетчик достигает значения `ThresholdForSnapshotting`, идентификатор проблемы добавляется в план сбора.

Сборщик Snapshot Collector также отслеживает исключения во время их создания, используя подписку на событие [AppDomain.CurrentDomain.FirstChanceException](/dotnet/api/system.appdomain.firstchanceexception). При возникновении этого события идентификатор проблемы исключения вычисляется и сравнивается с идентификаторами в плане сбора.
Если обнаружено соответствие, создается моментальный снимок выполняющегося процесса. Моментальному снимку назначается уникальный идентификатор, и к исключению добавляется метка с этим идентификатором. После возврата ответа обработчиком FirstChanceException вызванное исключение обрабатывается в обычном режиме. Со временем исключение снова достигает метода TrackException. Тогда оно вместе с идентификатором моментального снимка сообщается в Application Insights.

Основной процесс продолжает выполняться и обслуживать трафик для пользователей с небольшим прерыванием. Тем временем моментальный снимок передается в процесс передачи моментальных снимков. Отправитель моментальных снимков создает минидамп и передает его в Application Insights вместе с соответствующими PDB-файлами символов.

> [!TIP]
> - Моментальный снимок процесса — это приостановленный клон выполняющегося процесса.
> - Создание моментального снимка занимает около 10–20 мс.
> - Значение по умолчанию для `ThresholdForSnapshotting` — 1. Это минимальное значение. Таким образом, прежде чем будет создан моментальный снимок, приложение должно вызвать то же исключение **дважды**.
> - Задайте для `IsEnabledInDeveloperMode` значение true, если требуется создавать моментальные снимки во время отладки в Visual Studio.
> - Частота создания моментальных снимков ограничивается параметром `SnapshotsPerTenMinutesLimit`. По умолчанию установлено ограничение — один моментальный снимок каждые десять минут.
> - Можно отправлять не более 50 моментальных снимков в день.

## <a name="limitations"></a>Ограничения

Срок хранения данных по умолчанию составляет 15 дней. Для каждого экземпляра Application Insights максимально допустимое количество моментальных снимков 50 в день.

### <a name="publish-symbols"></a>Публикация символов
Отладчику моментальных снимков требуется наличие файлов символов на рабочем сервере для декодирования переменных и обеспечения возможности отладки в Visual Studio.
Выпуск 15.2 (или выше) приложения Visual Studio 2017 по умолчанию публикует символы для сборок выпуска при публикации в службе приложений. В предыдущих версиях в профиль публикации `.pubxml` необходимо добавить приведенную ниже строку, чтобы символы публиковались в режиме выпуска.

```xml
    <ExcludeGeneratedDebugSymbol>False</ExcludeGeneratedDebugSymbol>
```

Для службы вычислений Azure и других типов служб файлы символов должны находиться в одной папке с DLL-файлом основного приложения (как правило, `wwwroot/bin`) или быть доступными по текущему пути.

> [!NOTE]
> Дополнительные сведения о различных доступных параметрах символов см. в [документации по Visual Studio](/visualstudio/ide/reference/advanced-build-settings-dialog-box-csharp?view=vs-2019#output
). Для получения наилучших результатов рекомендуется использовать «Full», «Portable» или «Embedded».

### <a name="optimized-builds"></a>Оптимизированные сборки
В некоторых случаях локальные переменные не могут отображаться в сборках выпуска из-за оптимизаций, примененных JIT-компиляторов.
Однако в службах приложений Azure сборщик моментальных снимков может деоптимизировать методы создания исключений, которые являются частью плана сбора.

> [!TIP]
> Установите расширение сайта Application Insights в службе приложений для получения поддержки деоптимизации.

## <a name="next-steps"></a>Дальнейшие действия
Включите Snapshot Debugger Application Insights для приложения:

* [Служба приложений Azure](snapshot-debugger-appservice.md?toc=/azure/azure-monitor/toc.json)
* [Oблачныe службы Azure2](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json)
* [Службы Service Fabric Azure](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json)
* [Профилирование веб-приложений, работающих на виртуальной машине Azure или в масштабируемом наборе виртуальных машин, с помощью Application Insights Profiler](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json)
* [Локальные виртуальные или физические компьютеры](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json)

Кроме Application Insights Snapshot Debugger:
 
* [Установите в коде точки прикрепления](/visualstudio/debugger/debug-live-azure-applications), чтобы получать моментальные снимки не ожидая исключений.
* В статье [Диагностика исключений в веб-приложениях с помощью Application Insights](./asp-net-exceptions.md) объясняется, как отобразить дополнительные исключения в Application Insights.
* В статье [Интеллектуальное обнаружение в Application Insights](./proactive-diagnostics.md) описывается автоматическое обнаружение аномалий производительности.

