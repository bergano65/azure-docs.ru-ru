---
title: Сведения о работоспособности виртуальных машин Azure | Документация Майкрософт
description: В этой статье описывается, как оценить работоспособность виртуальных машин и базовых операционных систем с помощью Azure Monitor для виртуальных машин.
ms.service: azure-monitor
ms.subservice: ''
ms.topic: conceptual
author: mgoedtel
ms.author: magoedte
ms.date: 10/15/2019
ms.openlocfilehash: e19ba55e48c537974ad4136d40505514b92d387d
ms.sourcegitcommit: 0b1a4101d575e28af0f0d161852b57d82c9b2a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2019
ms.locfileid: "73162294"
---
# <a name="understand-the-health-of-your-azure-virtual-machines"></a>Сведения о работоспособности виртуальных машин Azure

Azure включает в себя службы для конкретных ролей или задач в области мониторинга, но не предоставляет подробные сведения о работоспособности операционных систем (OSs), размещенных на виртуальных машинах Azure. Хотя Azure Monitor можно использовать для различных условий, он не предназначен для моделирования и представления работоспособности основных компонентов или общей работоспособности виртуальных машин.

С помощью Azure Monitor для виртуальных машин работоспособности можно активно отслеживать доступность и производительность гостевой ОС Windows или Linux. Функция работоспособности использует модель, представляющую ключевые компоненты и их связи, содержит критерии, определяющие, как измерять работоспособность компонента и отправляет предупреждение при обнаружении неработоспособного состояния.

Просмотр общего состояния работоспособности виртуальной машины Azure и базовой ОС может осуществляться с двух точек: непосредственно с виртуальной машины или всех виртуальных машин в группе ресурсов из Azure Monitor.

В этой статье показано, как быстро оценить, исследовать и устранить проблемы работоспособности при их обнаружении с помощью функции работоспособности Azure Monitor для виртуальных машин.

Сведения о настройке Azure Monitor для виртуальных машин, см. в [этой статье](vminsights-enable-overview.md).

## <a name="monitoring-configuration-details"></a>Сведения о настройке мониторинга

В этом разделе описываются критерии работоспособности по умолчанию для мониторинга виртуальных машин Azure под управлением Windows и Linux. Все критерии работоспособности предварительно настроены для отправки предупреждения при обнаружении неработоспособного состояния.

| Имя монитора | Частота (мин.) | Длительность лукбакк (мин.) | operator | Threshold (Пороговое значение) | Оповещение о состоянии | Серьезность | Категория рабочей нагрузки | 
|--------------|-----------|----------|----------|-----------|----------------|----------|-------------------|
| Логический диск в сети | 5 | 15 | <> | 1 (true) | Критический | Sev1 | Linux | 
| свободное пространство на логическом диске; | 5 | 15 | < | 200 МБ (предупреждение)<br> 100 МБ (критическое) | Предупреждение | Sev1<br> Sev2 | Linux | 
| свободные дескрипторы на логическом диске (в процентах); | 5 | 15 | < | 5 % | Критический | Sev1 | Linux | 
| свободное пространство на логическом диске (в процентах); | 5 | 15 | < | 5 % | Критический | Sev1 | Linux | 
| Состояние сетевого адаптера | 5 | 15 | <> | 1 (true) | Предупреждение | Sev2 | Linux | 
| Объем доступной памяти операционной системы, МБ | 5 | 10 | < | 2,5 МБ | Критический | Sev1 | Linux | 
| Среднее время чтения с диска (с) | 5 | 25 | > | 0,05 s | Критический | Sev1 | Linux | 
| Среднее время обращения к диску (сек.) | 5 | 25 | > | 0,05 s | Критический | Sev1 | Linux | 
| СР. время записи на диск (сек.) " | 5 | 25 | > | 0,05 s | Критический | Sev1 | Linux | 
| Состояние диска | 5 | 25 | <> | 1 (true) | Критический | Sev1 | Linux | 
| Общий процент загруженности процессора операционной системой | 5 | 10 | >= | 95% | Критический | Sev1 | Linux | 
| общий процент использования ЦП; | 5 | 10 | >= | 95% | Критический | Sev1 | Windows | 
| ошибка или повреждение файловой системы; | 60 | 60 | <> | 4 | Критический | Sev1 | Windows | 
| среднее время на операцию чтения, секунд (логический диск); | 1 | 15 | > | 0.04 s | Предупреждение | Sev2 | Windows | 
| среднее время на операцию перемещения, секунд (логический диск); | 1 | 15 | > | 0.04 s | Предупреждение | Sev2 | Windows | 
| Среднее время обращения к логическому диску (с) на операцию записи (логический диск) | 1 | 15 | > | 0.04 s | Предупреждение | Sev2 | Windows | 
| текущая длина очереди диска (логический диск); | 5 | 60 | >= | 32 | Предупреждение | Sev2 | Windows | 
| Свободное место на логическом диске (МБ) | 15 | 60 | > | 500 МБ предупреждений<br> 300 МБ критическое | Критический | Sev1<br> Sev2 | Windows | 
| Свободное место на логическом диске (%) | 15 | 60 | > | предупреждение 10%<br> 5% критическое | Критический | Sev1<br> Sev2 | Windows |
| процент времени простоя логического диска; | 15 | 360 | <= | 20 % | Предупреждение | Sev2 | Windows | 
| процент используемой пропускной способности чтения; | 5 | 60 | >= | 60 % | Предупреждение | Sev2 | Windows | 
| процент используемой общей пропускной способности; | 5 | 60 | >= | 75 % | Предупреждение | Sev2 | Windows | 
| процент используемой пропускной способности записи; | 5 | 60 | >= | 60 % | Предупреждение | Sev2 | Windows | 
| работоспособность службы DHCP-клиента; | 5 | 12 | <> | 4 (работает) | Критический | Sev1 | Windows | 
| работоспособность службы DNS-клиента; | 5 | 12 | <> | 4 (работает) | Критический | Sev1 | Windows | 
| работоспособность службы журнала событий Windows; | 5 | 12 | <> | 4 (работает) | Критический | Sev1 | Windows | 
| работоспособность службы брандмауэра Windows; | 5 | 12 | <> | 4 (работает) | Критический | Sev1 | Windows | 
| работоспособность службы RPC; | 5 | 12 | <> | 4 (работает) | Критический | Sev1 | Windows | 
| работоспособность службы сервера; | 5 | 12 | <> | 4 (работает) | Критический | Sev1 | Windows | 
| работоспособность службы удаленного управления Windows. | 5 | 12 | <> | 4 (работает) | Критический | Sev1 | Windows | 
| доступный объем памяти, мегабайт; | 5 | 10 | < | 100 МБ | Критический | Sev1 | Windows | 
| Свободные записи системной таблицы страниц | 5 | 10 | <= | 5000 | Критический | Sev1 | Windows | 
| страниц памяти в секунду; | 5 | 10 | >= | 5000/с | Предупреждение | Sev1 | Windows | 
| процент используемой выделенной памяти; | 5 | 10 | > | 80 % | Критический | Sev1 | Windows | 
| среднее время на операцию перемещения, секунд (диск); | 1 | 15 | > | 0.04 s | Предупреждение | Sev2 | Windows | 
| Среднее время записи на диск (сек.) | 1 | 15 | > | 0.04 s | Предупреждение | Sev2 | Windows | 
| Текущая длина очереди диска | 5 | 60 | >= | 32 | Предупреждение | Sev2 | Windows | 
| процент времени простоя диска; | 5 | 60 | >= | 20 % | Предупреждение | Sev2 | Windows | 

>[!NOTE]
>Лукбакк длительность представляет частоту, с которой окно «Поиск» проверяет значения метрик, например за последние пять минут.  

>[!NOTE]
>Частота указывает, как часто оповещение метрики проверяет, выполняются ли условия, например каждую минуту.  Это скорость, с которой выполняется критерий работоспособности, а лукбакк — это время, в течение которого оценивается критерий работоспособности. Например, критерий работоспособности оценивается, если уровень **использования ЦП** превышает 95% с частотой 5 минут и остается больше 95% в течение 15 минут (3 последовательных цикла оценки), а затем состояние обновляется до критического. уровень серьезности, если он еще не был.

## <a name="sign-in-to-the-azure-portal"></a>Вход на портал Azure

Чтобы войти в систему, перейдите на [портал Azure](https://portal.azure.com).

## <a name="introduction-to-azure-monitor-for-vms-health"></a>Общие сведения о работоспособности Azure Monitor для виртуальных машин

Прежде чем использовать функцию работоспособности для отдельной виртуальной машины или группы виртуальных машин, важно понять, как представляются данные и какие представления представляют.

### <a name="view-health-directly-from-a-vm"></a>Просмотр состояния работоспособности непосредственно с виртуальной машины

Чтобы просмотреть работоспособность виртуальной машины Azure, выберите **Insights (Предварительная версия)** в левой области виртуальной машины. На странице VM Insights вкладка **работоспособность** открыта по умолчанию и отображает представление работоспособности виртуальной машины.

![Представление работоспособности выбранной виртуальной машины Azure в Azure Monitor для виртуальных машин](./media/vminsights-health/vminsights-directvm-health-01.png)

В разделе **работоспособность гостевой виртуальной машины** в таблице показан сводный показатель работоспособности компонентов производительности, отслеживаемых критериями работоспособности для виртуальной машины, и общее число оповещений о работоспособности виртуальной машины, вызванных неработоспособными компонентами. К этим компонентам относятся **ЦП**, **память**, **диск**и **сеть**. Разверните значок рядом с полем работоспособность гостевой виртуальной машины, чтобы просмотреть работоспособность его компонентов.

![Azure Monitor для виртуальных машин состояние работоспособности компонента выбранной виртуальной машины Azure](./media/vminsights-health/vminsights-directvm-health-02.png)

Выбор состояния рядом с компонентом откроет интерфейс диагностики работоспособности в контексте выбранного компонента. Он показывает композицию состояния этого компонента и описывает, какие критерии исправности используются для расчета его работоспособности. Дополнительные сведения см. в разделе [Диагностика работоспособности и работа с критериями работоспособности](#health-diagnostics). Дополнительные сведения об оповещениях см. в разделе [оповещения](#alerts).

В следующей таблице описываются состояния работоспособности, которые могут быть определены для виртуальной машины:

|Значок |Исправное состояние |Значение |
|-----|-------------|---------------|
| |Работоспособность |Виртуальная машина находится в пределах определенных условий работоспособности. Это состояние указывает, что проблемы не обнаружены, и виртуальная машина работает нормально. С родительским сводным монитором работоспособность выстраивается и отражает лучшее или наихудшее состояние дочернего оператора.|
| |Критический |Состояние не входит в заданное условие работоспособности, что свидетельствует о обнаружении одной или нескольких критических проблем. Эти проблемы необходимо устранить, чтобы восстановить нормальную функциональность. С родительским сводным монитором состояние работоспособности сведено и отражает наилучшее или наихудшее состояние дочернего элемента.|
| |Предупреждение |Состояние находится между двумя пороговыми значениями для определенного условия работоспособности, где одно из них указывает на состояние предупреждения, а другое — на критическое состояние (можно настроить три пороговых значения состояния работоспособности) или когда некритическая проблема может вызвать критические проблемы, если распознан. При наличии родительского сводного монитора, если один или несколько дочерних элементов находятся в состоянии предупреждения, родительский монитор будет отражать состояние предупреждения. Если один дочерний элемент находится в критическом состоянии и другой дочерний элемент в состоянии предупреждения, родительский накопитель будет отображать состояние работоспособности как критическое.|
| |Unknown |Невозможно вычислить состояние по нескольким причинам. В следующем разделе приведены дополнительные сведения и возможные решения. |

Неизвестное состояние работоспособности может быть вызвано следующими проблемами:

- Агент был перенастроен и больше не отправляет отчеты в рабочую область, указанную при включении Azure Monitor для виртуальных машин. Сведения о настройке агента для передачи отчетов в рабочую область см. в разделе [Добавление или удаление рабочей области](../platform/agent-manage.md#adding-or-removing-a-workspace).
- Виртуальная машина удалена.
- Рабочая область, связанная с Azure Monitor для виртуальных машин, была удалена. Вы можете восстановить рабочую область, если у вас есть преимущества поддержки Premier. Перейдите на [сайт Premier](https://premier.microsoft.com/) и откройте запрос в службу поддержки.
- Зависимости решения удалены. Чтобы повторно включить решения ServiceMap и Инфраструктуреинсигхтс в рабочей области Log Analytics, переустановите решение ServiceMap с помощью [шаблона Azure Resource Manager](vminsights-enable-at-scale-powershell.md#install-the-servicemap-solution). Чтобы переустановить решение Инфаструктуреинсигхтс, отправьте сообщение электронной почты vminsights@microsoft.com. 
- Работа виртуальной машины была завершена.
- Служба виртуальной машины Azure недоступна, или выполняется обслуживание.
- Достигнут [ежедневный объем данных рабочей области или предел хранения](../platform/manage-cost-storage.md) .

Выберите **Просмотреть диагностику работоспособности** , чтобы открыть страницу со всеми компонентами виртуальной машины, связанными критериями работоспособности, изменениями состояния и другими проблемами, обнаруженными компонентами мониторинга, связанными с виртуальной машиной.

Дополнительные сведения см. в разделе [Диагностика работоспособности](#health-diagnostics).

В разделе **работоспособности** в таблице показан сводный показатель работоспособности компонентов производительности, отслеживаемых критериями работоспособности. К этим компонентам относятся **ЦП**, **память**, **диск**и **сеть**. При выборе компонента открывается страница со списком всех критериев мониторинга и состояния работоспособности этого компонента.

При доступе к работоспособности с виртуальной машины Azure, работающей под управлением Windows, состояние работоспособности пяти основных служб Windows отображается в разделе **работоспособность основных служб**. При выборе любой из служб открывается страница со списком критериев работоспособности для этого компонента и его состоянием работоспособности.

При выборе имени для критериев работоспособности открывается панель свойств. На этой панели можно просматривать сведения о конфигурации, в том числе если критерии работоспособности имеют соответствующее оповещение Azure Monitor.

Дополнительные сведения см. в разделе [Диагностика работоспособности и работа с критериями работоспособности](#health-diagnostics).

### <a name="aggregate-vm-perspective"></a>Совокупная перспектива ВМ

Чтобы просмотреть коллекцию работоспособности для всех виртуальных машин в группе ресурсов, выберите **Azure Monitor** в списке переходов на портале, а затем выберите **виртуальные машины (Предварительная версия)** .

![Страница аналитики виртуальных машин. Представление мониторинга в Azure Monitor](./media/vminsights-health/vminsights-aggregate-health.png)

В раскрывающемся списке **Подписка** и **Группа ресурсов** выберите подходящую группу ресурсов, включающую виртуальные машины, связанные с группой, чтобы просмотреть состояние работоспособности отчета. Выбор применяется только к функции работоспособности и не переносится на вкладки " **производительность** " или " **схема** ".

На вкладке **работоспособность** представлены следующие сведения.

* Количество виртуальных машин в критическом или неработоспособном состоянии, а также Количество работоспособных или не отправляемых данных (называемое неизвестным состоянием).
* Что и количество виртуальных машин по ОС, сообщающих о неработоспособном состоянии.
* Количество виртуальных машин в неработоспособном состоянии из-за проблемы, обнаруженной с помощью процессора, диска, памяти или сетевого адаптера, разбитого по состоянию работоспособности.
* Количество виртуальных машин в неработоспособном состоянии из-за проблемы, обнаруженной в базовой службе ОС, в категории по состоянию работоспособности.

На вкладке **работоспособность** можно определить критические проблемы, обнаруженные критериями работоспособности при мониторинге виртуальной машины, а также сведения об оповещениях и связанных статьях базы знаний. Эти статьи помогут в диагностике и устранении проблем. Чтобы открыть страницу [Все оповещения](../../azure-monitor/platform/alerts-overview.md#all-alerts-page), отфильтрованную по конкретной серьезности, щелкните ее.

В списке **Распределение виртуальных машин по операционной системе** перечислены виртуальные машины по каждому выпуску Windows и (или) версии дистрибутива Linux. В каждой категории ОС виртуальные машины разбиваются дальше в зависимости от работоспособности виртуальной машины.

![Страница аналитики виртуальных машин. Представление с распределением виртуальных машин](./media/vminsights-health/vminsights-vmdistribution-by-os.png)

Выберите любой столбец, включая **число виртуальных машин**, **критическое**, **предупреждение**, **работоспособное**или **неизвестное**. Просмотрите список отфильтрованных результатов на странице **виртуальные машины** , которые соответствуют выбранному столбцу.

Например, чтобы просмотреть все виртуальные машины, которые работают Red Hat Enterprise Linux выпуске 7,5, выберите значение **счетчика виртуальных машин** для этой ОС, после чего будут перечислены виртуальные машины, соответствующие этому фильтру, и их текущее состояние работоспособности.

![Пример сводного монитора для виртуальных машин Red Hat Linux](./media/vminsights-health/vminsights-rollup-vm-rehl-01.png)

При нажатии кнопки **отобразить флажок работоспособности** возвращается состояние работоспособности для отфильтрованных результатов в таблице.  

![Пример состояния работоспособности виртуальных машин Red Hat Linux](./media/vminsights-health/vminsights-rollup-vm-rehl-02.png)

Для любого из элементов списка можно щелкнуть соответствующее состояние работоспособности, чтобы запустить диагностику работоспособности, которое показывает, как оценивается работоспособность для выбранной виртуальной машины. 

На странице **виртуальные машины** при выборе имени виртуальной машины в столбце **имя виртуальной**машины вы направляетесь на страницу **экземпляра виртуальной машины** . На этой странице содержатся дополнительные сведения о предупреждениях и условиях работоспособности, влияющих на выбранную виртуальную машину. Отфильтруйте сведения о состоянии работоспособности, щелкнув значок **состояния работоспособности** в левом верхнем углу страницы, чтобы узнать, какие компоненты являются неработоспособными. Можно также просмотреть предупреждения о работоспособности виртуальной машины, вызванные неработоспособным компонентом, отнесенным к категории серьезности предупреждения.

В представлении **списка виртуальных машин** выберите имя виртуальной машины, чтобы открыть страницу **работоспособности** для этой виртуальной машины, аналогично тому, как если бы вы выбрали **Insights (Предварительная версия)** непосредственно на виртуальной машине.

![Страница аналитики виртуальных машин. Информация по выбранной виртуальной машине Azure](./media/vminsights-health/vminsights-directvm-health.png)

На странице " **виртуальные машины (Предварительная версия)" на Azure Monitor** отображается сводное состояние работоспособности для виртуальной машины и оповещений. Это состояние работоспособности классифицировано по степени серьезности, которое представляет предупреждения о работоспособности виртуальной машины, вызываемые при изменении состояния работоспособности на неработоспособное, в зависимости от критериев. Если выбрать **виртуальные машины в критическом** состоянии, откроется страница со списком из одной или нескольких виртуальных машин в критическое состояние работоспособности.

При выборе состояния работоспособности для одной из виртуальных машин отображается представление **Диагностика работоспособности** виртуальной машины. В этом представлении можно определить, какие критерии работоспособности соответствуют проблемам состояния работоспособности. Когда откроется страница **Диагностика работоспособности** , в ней отобразятся все компоненты виртуальной машины и связанные с ними критерии работоспособности с текущим состоянием работоспособности.

Дополнительные сведения см. в разделе [Диагностика работоспособности](#health-diagnostics).

Щелкните **Просмотреть все условия работоспособности**, чтобы открыть страницу со списком всех доступных для этой функции критериев работоспособности. Эти данные можно дополнительно отфильтровать по следующим параметрам:

* **Введите**. Существует три типа критериев работоспособности для оценки условий и свертки общего состояния работоспособности отслеживаемой виртуальной машины.
    - **Единица измерения**. Измеряет определенный аспект виртуальной машины. Этот тип критериев работоспособности может проверять счетчик производительности, чтобы определить производительность компонента, выполнение сценария для выполнения искусственной транзакции или наблюдение за событием, указывающим на ошибку. Фильтр по умолчанию имеет значение Unit.
    - **Зависимость**. Предоставляет сводный показатель работоспособности между различными сущностями. Этот критерий работоспособности позволяет зависеть от работоспособности объекта другого типа, на котором она полагается для успешной работы.
    - **Статистическое выражение**. Предоставляет объединенное состояние работоспособности аналогичных критериев работоспособности. Критерии работоспособности единицы и зависимости обычно настраиваются в соответствии со статистическим критерием работоспособности. Критерий агрегации не только позволяет лучше упорядочить несколько разных критериев для одной сущности, но и определить уникальные состояния работоспособности для отдельных категорий сущностей.

* **Категория**. Тип критериев исправности, используемых для группировки аналогичных критериев в целях составления отчетов. Эти категории являются " **доступность** " и " **производительность**".

Чтобы узнать, какие экземпляры неработоспособны, выберите значение в столбце **неработоспособный компонент** . В таблице на этой странице перечислены компоненты, которые находятся в критическом состоянии работоспособности.

## <a name="health-diagnostics"></a>Диагностика работоспособности

Страница **Диагностика работоспособности** позволяет визуализировать модель работоспособности виртуальной машины. На этой странице перечислены все компоненты виртуальных машин, связанные с ними критерии работоспособности, изменения состояния и другие важные проблемы, обнаруженные отслеживаемыми компонентами, связанными с виртуальной машиной.

![Пример страницы диагностики работоспособности для виртуальной машины](./media/vminsights-health/health-diagnostics-page-01.png)

Запустите диагностику работоспособности, используя следующие методы.

* По сводному состоянию работоспособности для всех виртуальных машин с точки зрения агрегатной виртуальной машины в Azure Monitor:

    1. На странице **работоспособность** выберите значок **критическое**, **предупреждение**, **работоспособное**или **неизвестное** состояние работоспособности в разделе **работоспособность гостевой виртуальной машины**.
    2. Перейдите на страницу со списком всех виртуальных машин, соответствующих этой фильтруемой категории.
    3. Выберите значение в столбце **состояние работоспособности** , чтобы открыть область диагностики работоспособности, ограниченную этой виртуальной машиной.

* По ОС из совокупной перспективы виртуальной машины в Azure Monitor. Из раздела **Распределение виртуальных машин** при выборе любого из значений в столбцах открывается страница **Виртуальные машины** со списком в табличном виде, который отфильтрован по выбранной категории. При выборе значения в столбце **состояние работоспособности** открывается диагностика работоспособности для выбранной виртуальной машины.
 
* На вкладке **работоспособность** Azure Monitor для виртуальных машин Гостевая виртуальная машина, выбрав пункт **Просмотр диагностических сведений о работоспособности**.

Диагностика работоспособности организует сведения о работоспособности в две категории: доступность и производительность.
 
Все критерии работоспособности, определенные для компонента, такие как логический диск, ЦП и т. д., можно просмотреть без фильтрации по двум категориям. Эти представления могут быть в любом представлении критериев или с помощью фильтрации результатов по любой категории при выборе уровня **доступности** или **производительности**.

Кроме того, категорию критерии можно увидеть рядом со столбцом **критерии работоспособности** . Если критерии не соответствуют выбранной категории, в столбце **критерии работоспособности** отобразится сообщение **о недоступности критериев работоспособности для выбранной категории** .

Состояние критериев работоспособности определяется одним из четырех типов: **критическое**, **предупреждение**, **работоспособное**и **неизвестное**. Первые три можно настроить, то есть можно изменить пороговые значения мониторов непосредственно в области конфигурации **критерии работоспособности** . Это можно также сделать с помощью операции Azure Monitor REST API [обновления монитора](https://docs.microsoft.com/rest/api/monitor/microsoft.workloadmonitor/monitors/update). **Неизвестный** параметр недоступен для настройки и зарезервирован для конкретных сценариев.

На странице **Диагностика работоспособности** есть три основных раздела.

* "Модель компонентов";
* Критерии работоспособности
* "Изменения состояния".

![Разделы страницы диагностики работоспособности](./media/vminsights-health/health-diagnostics-page-02.png)

### <a name="component-model"></a>Модель компонентов

Крайний левый столбец на странице " **Диагностика работоспособности** " является **моделью компонента**. Все компоненты, связанные с виртуальной машиной, отображаются в этом столбце вместе с текущим состоянием работоспособности.

В следующем примере обнаруженные компоненты — **диск**, **логический диск**, **процессор**, **память**и **Операционная система**. В этом столбце обнаруживаются и отображаются несколько экземпляров этих компонентов.

Например, на следующем рисунке показано, что виртуальная машина имеет два экземпляра логических дисков, **C:** и **D:** , которые находятся в работоспособном состоянии:

![Пример модели компонентов в разделе диагностики работоспособности](./media/vminsights-health/health-diagnostics-page-component.png)

### <a name="health-criteria"></a>Критерии работоспособности

Центральный столбец на странице "Диагностика работоспособности" является **критерием работоспособности**. Модель работоспособности, созданная для виртуальной машины, отображается здесь в виде иерархического дерева. Модель работоспособности для виртуальной машины состоит из критериев работоспособности "Блок" и "Агрегация".

![Пример критериев работоспособности в разделе диагностики работоспособности](./media/vminsights-health/health-diagnostics-page-healthcriteria.png)

Критерий работоспособности измеряет работоспособность наблюдаемого экземпляра, который может быть пороговым значением, состоянием сущности и т. д. В качестве условия работоспособности можно задать два или три настраиваемых пороговых значения состояния работоспособности, как описано выше. В любой момент критерий работоспособности может находиться только в одном из возможных состояний.

Модель работоспособности определяет критерии, определяющие работоспособность общего целевого объекта и компонентов целевого объекта. Иерархия критериев показана в разделе **критерии работоспособности** на странице **Диагностика работоспособности** .

Политика сводного показателя работоспособности является частью конфигурации составных критериев исправности (значение по умолчанию — **наихудший**). Набор критериев работоспособности по умолчанию, выполняемый в рамках этой функции, можно найти в разделе [сведения о конфигурации мониторинга](#monitoring-configuration-details) этой статьи.

Для получения списка всех критериев работоспособности можно также использовать [список экземпляров монитора Azure Monitor REST API по ресурсам](https://docs.microsoft.com/rest/api/monitor/microsoft.workloadmonitor/monitorinstances/listbyresource) . Эти критерии включают сведения о конфигурации, выполняемые для ресурса виртуальной машины Azure.

Для типа критериев работоспособности **единицы** можно изменить конфигурацию, щелкнув ссылку с многоточием справа. Выберите пункт **отобразить подробности** , чтобы открыть панель конфигурации.

![Пример конфигурации критериев работоспособности](./media/vminsights-health/health-diagnostics-vm-example-02.png)

В области Конфигурация для выбранных критериев работоспособности, если вы используете пример среднего времени **на запись на диск**, можно настроить пороговое значение с другим числовым значением. Это монитор с двумя состояниями, то есть он может измениться только от состояния **работоспособности** до **предупреждения**.

Другие критерии исправности иногда используют три состояния, где можно настроить значения предупреждений и критических порогов состояния работоспособности. Также можно изменить пороговое значение с помощью Azure Monitor [конфигурации монитора](https://docs.microsoft.com/rest/api/monitor/microsoft.workloadmonitor/monitors/update)REST API.

>[!NOTE]
>Применение изменений конфигурации критериев работоспособности к одному экземпляру применяет их ко всем отслеживаемым экземплярам. Например, если выбрать **Disk-1 D:** , а затем изменить среднее время **записи на диск (в секундах** ), это изменение применяется ко всем экземплярам, обнаруженным и отслеживаемым на виртуальной машине.


![Пример настройки критерия работоспособности для базового монитора](./media/vminsights-health/health-diagnostics-criteria-config-01.png)

Если вы хотите узнать больше о критериях работоспособности, мы включили статьи базы знаний, которые помогут определить проблемы, причины и способы их устранения. Выберите **Просмотреть сведения** на странице, чтобы просмотреть связанную статью базы знаний.

Чтобы просмотреть все статьи базы знаний, входящие в состав Azure Monitor для виртуальных машин работоспособности, см. [документацию Azure Monitor](https://docs.microsoft.com/azure/monitoring/infrastructure-health/).

### <a name="state-changes"></a>Изменения состояний

В крайнем правом столбце страницы " **Диагностика работоспособности** " **изменилось состояние**. В этом столбце перечислены все изменения состояния, связанные с критериями работоспособности, выбранными в разделе **критерии работоспособности** , или изменением состояния виртуальной машины, если виртуальная машина была выбрана из столбца **модель компонентов** или **критерии работоспособности** таблицы.

![Пример изменений состояний в разделе диагностики работоспособности](./media/vminsights-health/health-diagnostics-page-statechanges.png)

В следующем разделе показано состояние условий работоспособности и соответствующее время. Эти сведения показывают Последнее состояние в верхней части столбца.

### <a name="association-of-component-model-health-criteria-and-state-changes-columns"></a>Сопоставление столбцов модели компонентов, условий работоспособности и изменений состояния

Эти три столбца связаны друг с другом. При выборе экземпляра в столбце **модель компонентов** столбец **критериев работоспособности** фильтруется по этому представлению компонента. Соответственно, столбец **изменения состояния** обновляется на основе выбранных критериев работоспособности.

![Пример выбора отслеживаемого экземпляра и фильтрации результатов](./media/vminsights-health/health-diagnostics-vm-example-01.png)

Например, если выбрать *диск-1 D:* из списка в разделе **модель компонентов**, **критерии работоспособности** фильтруются на *Disk-1d:* , а **изменения состояния** — в зависимости от доступности *Disk-1 D:* .

Чтобы просмотреть обновленное состояние работоспособности, можно обновить страницу диагностика работоспособности, щелкнув ссылку **Обновить** . Если состояние работоспособности для критерия работоспособности изменяется с определенным заданным интервалом, это действие позволит избежать ожидания и сразу отобразить свежие данные о работоспособности. **Состояние критериев работоспособности** — это фильтр, позволяющий ограничить область результатов на основе выбранного состояния работоспособности: работоспособное, предупреждение, критическое, неизвестное и все. Время **последнего обновления** в правом верхнем углу представляет время последнего обновления страницы "Диагностика работоспособности".

## <a name="alerts"></a>Оповещения

Работоспособность Azure Monitor для виртуальных машин интегрируется с [оповещениями Azure](../../azure-monitor/platform/alerts-overview.md). Он выдает предупреждение, когда предопределенные критерии при обнаружении изменяются с работоспособного состояния на неработоспособное. Оповещения классифицируются по степени серьезности, от уровень серьезности 0 до уровень серьезности 4, где уровень серьезности 0 в качестве самого высокого уровня.

Оповещения не связаны с группой действий, чтобы уведомлять вас о том, что оповещение активировано. Для пользователя с ролью владельца в области подписки необходимо настроить уведомления, выполнив действия, описанные в разделе [Настройка оповещений](#configure-alerts) .

Общее число оповещений о работоспособности виртуальной машины, классифицированных по степени серьезности, доступно на панели мониторинга **работоспособности** в разделе **оповещения** . Когда вы выбираете общее число оповещений или число, соответствующее определенному уровню серьезности, открывается страница **Оповещения** со списком всех оповещений для выбранного элемента.

Например, если выбрать строку, соответствующую **уровень серьезности Level 1**, вы увидите следующее представление:

![Пример оповещений для уровня серьезности 1](./media/vminsights-health/vminsights-sev1-alerts-01.png)

Страница **все оповещения** не ограничивается отображением только тех предупреждений, которые соответствуют вашему выбору. Кроме того, он фильтруется по **типу ресурса** , чтобы отображались только оповещения о работоспособности, вызванные РЕСУРСОМ виртуальной машины. Этот формат отражается в списке предупреждений под **целевым ресурсом**столбца, где отображается виртуальная машина Azure, вызвавшая предупреждение при выполнении неработоспособного условия.

Оповещения от других типов ресурсов или служб не должны включаться в это представление. Эти оповещения включают в себя оповещения журнала, основанные на запросах журналов или оповещениях метрик, которые обычно отображаются на странице Azure Monitor [все оповещения](../../azure-monitor/platform/alerts-overview.md#all-alerts-page) .

Можно отфильтровать это представление, выбрав значения в раскрывающихся меню в верхней части страницы.

|Столбец |Описание |
|-------|------------|
|Subscription |Выберите подписку Azure. В представление включены только оповещения из выбранных подписок. |
|Группа ресурсов |Выбор одной группы ресурсов. Только те предупреждения, которые отмечены в выбранной группе ресурсов, включены в представление. |
|Тип ресурса |Выбор одной или нескольких группу ресурсов. По умолчанию только оповещения целевого объекта **Виртуальные машины** выбраны и включены в это представление. Этот столбец становится доступным только после указания группы ресурсов. |
|Ресурс |Выбор ресурса. В представление включены только те оповещения, целью которых выбраны ресурсы. Этот столбец доступен только после указания типа ресурса. |
|Серьезность |Чтобы включить оповещения всех уровней, выберите уровни оповещения или **Все**. |
|Состояние монитора |Выберите условие монитора, чтобы отфильтровать предупреждения, если они были запущены или разрешены системой, если условие больше не активно. Или выберите **все** , чтобы включить предупреждения обо всех условиях. |
|Состояние оповещения |Выберите состояние оповещения, **новое**, **Подтверждение**, **закрыто**или **все** , чтобы включить оповещения обо всех состояниях. |
|Мониторинг службы |Чтобы включить все службы, выберите службу или **Все**. Для этой функции поддерживаются только предупреждения из VM Insights.|
|Диапазон времени| Только оповещения, выполненные в рамках выбранного временного интервала, будут включены в представление. Поддерживаемые значения: за последний час, за последние 24 часа, за последние 7 дней и за последние 30 дней. |

При выборе оповещения отображается страница **сведений о предупреждении** . Эта страница содержит подробные сведения о предупреждении и позволяет изменить его состояние.

Дополнительные сведения об управлении оповещениями см. в статье [Создание и просмотр оповещений метрик, а также управление ими с помощью Azure Monitor](../../azure-monitor/platform/alerts-metric.md).

>[!NOTE]
>Создание новых оповещений на основе критериев исправности или изменение существующих правил генерации оповещений о работоспособности в Azure Monitor с портала в настоящее время не поддерживается.


![Панель сведений о выбранном оповещении](./media/vminsights-health/alert-details-pane-01.png)

Вы можете изменить состояние предупреждения для одного или нескольких оповещений, выбрав их, а затем выбрав **изменить состояние** на странице **все оповещения** в левом верхнем углу. Выберите одно из состояний на панели **изменить состояние оповещения** , добавьте описание изменения в поле **Комментарий** , а затем нажмите кнопку **ОК** , чтобы зафиксировать изменения. После проверки сведений и применения изменений Следите за ходом выполнения в разделе **уведомления** в меню.

### <a name="configure-alerts"></a>Настройка оповещений
Вы не можете управлять определенными задачами управления оповещениями из портал Azure. Эти задачи необходимо выполнить с помощью [REST API Azure Monitor](https://docs.microsoft.com/rest/api/monitor/microsoft.workloadmonitor/components). В частности:

- Включение или отключение предупреждения для критериев работоспособности
- Настройка уведомлений для оповещений об условиях работоспособности

В каждом примере используется [ARMClient](https://github.com/projectkudu/armclient) на компьютере Windows. Если вы не знакомы с этим методом, см. раздел [Использование ARMClient](../platform/rest-api-walkthrough.md#use-armclient).

#### <a name="enable-or-disable-an-alert-rule"></a>Включение или отключение правила генерации оповещений

Чтобы включить или отключить оповещение для конкретных критериев работоспособности, свойство **алертженератион** должно быть изменено со значением **отключено** или **включено**.

Чтобы найти *monitorId* для конкретных критериев работоспособности, в следующем примере показано, как запросить это значение для критерия **"логический Disk Seconds for Reper**:

1. В окне терминала введите **armclient.exe login**. При этом будет предложено войти в Azure.

2. Введите следующую команду, чтобы получить все условия работоспособности, активные на конкретной виртуальной машине, и укажите значение свойства *monitorId* :

    ```
    armclient GET "subscriptions/subscriptionId/resourceGroups/resourcegroupName/providers/Microsoft.Compute/virtualMachines/vmName/providers/Microsoft.WorkloadMonitor/monitors?api-version=2018-08-31-preview"
    ```

    В следующем примере показаны выходные данные команды *ARMCLIENT Get* . Запишите значение *MonitorId*. Это значение является обязательным для следующего шага, где необходимо указать идентификатор критериев работоспособности и изменить его свойство, чтобы создать оповещение.

    ```
    "id": "/subscriptions/a7f23fdb-e626-4f95-89aa-3a360a90861e/resourcegroups/Lab/providers/Microsoft.Compute/virtualMachines/SVR01/providers/Microsoft.WorkloadMonitor/monitors/ComponentTypeId='LogicalDisk',MonitorId='Microsoft_LogicalDisk_AvgDiskSecPerRead'",
      "name": "ComponentTypeId='LogicalDisk',MonitorId='Microsoft_LogicalDisk_AvgDiskSecPerRead'",
      "type": "Microsoft.WorkloadMonitor/virtualMachines/monitors"
    },
    {
      "properties": {
        "description": "Monitor the performance counter LogicalDisk\\Avg Disk Sec Per Transfer",
        "monitorId": "Microsoft_LogicalDisk_AvgDiskSecPerTransfer",
        "monitorName": "Microsoft.LogicalDisk.AvgDiskSecPerTransfer",
        "monitorDisplayName": "Average Logical Disk Seconds Per Transfer",
        "parentMonitorName": null,
        "parentMonitorDisplayName": null,
        "monitorType": "Unit",
        "monitorCategory": "PerformanceHealth",
        "componentTypeId": "LogicalDisk",
        "componentTypeName": "LogicalDisk",
        "componentTypeDisplayName": "Logical Disk",
        "monitorState": "Enabled",
        "criteria": [
          {
            "healthState": "Warning",
            "comparisonOperator": "GreaterThan",
            "threshold": 0.1
          }
        ],
        "alertGeneration": "Enabled",
        "frequency": 1,
        "lookbackDuration": 17,
        "documentationURL": "https://aka.ms/Ahcs1r",
        "configurable": true,
        "signalType": "Metrics",
        "signalName": "VMHealth_Avg. Logical Disk sec/Transfer"
      },
      "etag": null,
    ```

3. Введите следующую команду, чтобы изменить свойство *алертженератион* :

    ```
    armclient patch subscriptions/subscriptionId/resourceGroups/resourcegroupName/providers/Microsoft.Compute/virtualMachines/vmName/providers/Microsoft.WorkloadMonitor/monitors/Microsoft_LogicalDisk_AvgDiskSecPerTransfer?api-version=2018-08-31-preview "{'properties':{'alertGeneration':'Disabled'}}"
    ```   

4. Введите команду GET, которая используется на шаге 2, чтобы убедиться, что для свойства установлено значение **Disabled (отключено**).

#### <a name="associate-an-action-group-with-health-criteria"></a>Связывание группы действий с критериями работоспособности

Работоспособность Azure Monitor для виртуальных машин поддерживает SMS и уведомления по электронной почте, когда оповещения формируются из неработоспособных критериев работоспособности. Чтобы настроить уведомления, запишите имя настроенной группы действий для отправки SMS или уведомлений по электронной почте.

>[!NOTE]
>Это действие должно выполняться для каждой отслеживаемой виртуальной машины, для которой требуется получить уведомление. Он не применяется ко всем виртуальным машинам в группе ресурсов.

1. В окне терминала введите *имя входа armclient. exe*. При этом будет предложено войти в Azure.

2. Введите следующую команду, чтобы связать группу действий с правилами генерации оповещений:
 
    ```
    $payload = "{'properties':{'ActionGroupResourceIds':['/subscriptions/subscriptionId/resourceGroups/resourcegroupName/providers/microsoft.insights/actionGroups/actiongroupName']}}"
    armclient PUT https://management.azure.com/subscriptions/subscriptionId/resourceGroups/resourcegroupName/providers/Microsoft.Compute/virtualMachines/vmName/providers/Microsoft.WorkloadMonitor/notificationSettings/default?api-version=2018-08-31-preview $payload
    ```

3. Чтобы убедиться, что значение свойства **актионграупресаурцеидс** успешно Обновлено, введите следующую команду:

    ```
    armclient GET "subscriptions/subscriptionName/resourceGroups/resourcegroupName/providers/Microsoft.Compute/virtualMachines/vmName/providers/Microsoft.WorkloadMonitor/notificationSettings?api-version=2018-08-31-preview"
    ```

    Выходные данные должны выглядеть, как в следующих критериях:
    
    ```
    {
      "value": [
        {
          "properties": {
            "actionGroupResourceIds": [
              "/subscriptions/a7f23fdb-e626-4f95-89aa-3a360a90861e/resourceGroups/Lab/providers/microsoft.insights/actionGroups/Lab-IT%20Ops%20Notify"
            ]
          },
          "etag": null,
          "id": "/subscriptions/a7f23fdb-e626-4f95-89aa-3a360a90861e/resourcegroups/Lab/providers/Microsoft.Compute/virtualMachines/SVR01/providers/Microsoft.WorkloadMonitor/notificationSettings/default",
          "name": "notificationSettings/default",
          "type": "Microsoft.WorkloadMonitor/virtualMachines/notificationSettings"
        }
      ],
      "nextLink": null
    }
    ```

## <a name="next-steps"></a>Дальнейшие действия

- Чтобы определить ограничения и общую производительность виртуальной машины, см. статью [Просмотр производительности виртуальной машины Azure](vminsights-performance.md).

- Дополнительные сведения об обнаруженных зависимостях приложений см. в статье [просмотр Azure Monitor для виртуальных машин Map](vminsights-maps.md).
