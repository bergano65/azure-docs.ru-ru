---
title: Использование управляемых клиентом учетных записей хранения в Azure Monitor Log Analytics
description: Использование собственной учетной записи хранения для Log Analytics сценариев
ms.subservice: logs
ms.topic: conceptual
author: noakup
ms.author: noakuper
ms.date: 09/03/2020
ms.openlocfilehash: f424a2c3102f7b270a64c612a91d645ab71461fc
ms.sourcegitcommit: d22a86a1329be8fd1913ce4d1bfbd2a125b2bcae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/26/2020
ms.locfileid: "96184099"
---
# <a name="using-customer-managed-storage-accounts-in-azure-monitor-log-analytics"></a>Использование управляемых клиентом учетных записей хранения в Azure Monitor Log Analytics

Log Analytics полагается на хранилище Azure в различных сценариях. Это обычно управляется автоматически. Однако в некоторых случаях требуется предоставить собственную учетную запись хранения и управлять ею, которая также называется управляемой клиентом учетной записью хранения. В этом документе подробно описывается использование управляемого клиентом хранилища для приема журналов WAD/LAD, сценариев для частных ссылок и шифрования ключа, управляемого клиентом (CMK). 

> [!NOTE]
> Не рекомендуется зависеть от содержимого, Log Analytics отправки в управляемое клиентом хранилище, учитывая, что форматирование и содержимое могут измениться.

## <a name="ingesting-azure-diagnostics-extension-logs-wadlad"></a>Прием журналов расширений система диагностики Azure (WAD/LAD)
Агенты расширения система диагностики Azure (также называемые WAD и LAD для агентов Windows и Linux соответственно) собираются различные журналы операционной системы и сохраняют их в управляемой пользователем учетной записи хранения. Затем эти журналы можно принять в Log Analytics для их анализа и анализа.
Как получить журналы расширений система диагностики Azure из учетной записи хранения Подключите учетную запись хранения к рабочей области Log Analytics как к источнику данных хранилища с помощью [портал Azure](./diagnostics-extension-logs.md#collect-logs-from-azure-storage) или путем вызова [API Storage Insights](/rest/api/loganalytics/connectedsources/storage%20insights/createorupdate).

Поддерживаемые типы данных:
* Системный журнал
* События Windows
* Service Fabric
* События ETW
* Журналы IIS

## <a name="using-private-links"></a>Использование частных ссылок
Управляемые учетные записи хранения клиентов требуются в некоторых случаях, когда частные ссылки используются для подключения к ресурсам Azure Monitor. Один из таких случаев — прием пользовательских журналов или журналов IIS. Эти типы данных сначала отправляются в виде больших двоичных объектов в промежуточную учетную запись хранения Azure, а затем принимаются только в рабочую область. Аналогичным образом некоторые Azure Monitor решения могут использовать учетные записи хранения для хранения больших файлов, таких как файлы дампа программы Watson, которые используются решением центра безопасности Azure. 

##### <a name="private-link-scenarios-that-require-a-customer-managed-storage"></a>Сценарии с закрытой ссылкой, для которых требуется управляемое клиентом хранилище
* Прием пользовательских журналов и журналов IIS
* Разрешение на получение решения ASC для получения файлов дампа программы Watson

### <a name="how-to-use-a-customer-managed-storage-account-over-a-private-link"></a>Использование управляемой клиентом учетной записи хранения по частной ссылке
##### <a name="workspace-requirements"></a>Требования к рабочей области
При подключении к Azure Monitor через частную связь, Log Analytics агенты могут только отправить журналы в рабочие области, связанные с вашей сетью по частной ссылке. Для этого правила необходимо правильно настроить Azure Monitor объект области закрытых ссылок (АМПЛС), подключить его к рабочим областям, а затем подключить АМПЛС к сети по частной ссылке. Дополнительные сведения о процедуре настройки АМПЛС см. в статье [Использование частной связи Azure для безопасного подключения сетей к Azure Monitor](./private-link-security.md). 
##### <a name="storage-account-requirements"></a>Требования к учетной записи хранения
Чтобы учетная запись хранения была успешно подключена к частной ссылке, она должна:
* Они должны находиться в виртуальной сети или в одноранговых сетях и подключаться к виртуальной сети по частной ссылке. Это позволяет агентам в виртуальной сети отсылать журналы в учетную запись хранения.
* Находиться в том же регионе, что и Рабочая область, с которой он связан.
* Разрешить Azure Monitor доступ к учетной записи хранения. Если вы решили разрешить доступ к учетной записи хранения только для выбранных сетей, необходимо также разрешить это исключение: "разрешить доверенным службам Майкрософт доступ к этой учетной записи хранения". Это позволяет Log Analytics читать журналы, полученные в этой учетной записи хранения.
* Если Рабочая область обрабатывает трафик из других сетей, необходимо настроить учетную запись хранения, чтобы разрешить входящий трафик, исходящий из соответствующих сетей и Интернета.

##### <a name="link-your-storage-account-to-a-log-analytics-workspace"></a>Связывание учетной записи хранения с рабочей областью Log Analytics
Вы можете связать учетную запись хранения с рабочей областью с помощью [Azure CLI](/cli/azure/monitor/log-analytics/workspace/linked-storage) или [REST API](/rest/api/loganalytics/linkedstorageaccounts). Применимые значения dataSourceType:
* CustomLogs — используется для хранения пользовательских журналов и журналов IIS во время приема.
* Азуреватсон — используйте хранилище для файлов дампа программы Watson, отправленных решением ASC (центр безопасности Azure). Дополнительные сведения об управлении хранением, замене связанной учетной записи хранения и мониторинге действий с учетной записью хранения см. в разделе [Управление связанными учетными записями хранения](#managing-linked-storage-accounts). 

## <a name="encrypting-data-with-cmk"></a>Шифрование данных с помощью CMK
Служба хранилища Azure шифрует все неактивных данных в учетной записи хранения. По умолчанию он шифрует данные с помощью ключей, управляемых корпорацией Майкрософт (ММК). Однако служба хранилища Azure вместо этого позволяет использовать ключ, управляемый клиентом (CMK), из хранилища ключей Azure для шифрования данных хранилища. Вы можете либо импортировать собственные ключи в Azure Key Vault, либо использовать Azure Key Vault API для создания ключей.
##### <a name="cmk-scenarios-that-require-a-customer-managed-storage-account"></a>Сценарии CMK, для которых требуется управляемая клиентом учетная запись хранения
* Шифрование запросов оповещений журнала с помощью CMK
* Шифрование сохраненных запросов с помощью CMK

### <a name="how-to-apply-cmk-to-customer-managed-storage-accounts"></a>Как применить CMK к учетным записям хранения, управляемым клиентом
##### <a name="storage-account-requirements"></a>Требования к учетной записи хранения
Учетная запись хранения и Key Vault должны быть расположены в одном регионе, но могут находиться в разных подписках. Дополнительные сведения о шифровании службы хранилища Azure и управлении ключами см. [в статье шифрование службы хранилища Azure для неактивных данных](../../storage/common/storage-service-encryption.md).

##### <a name="apply-cmk-to-your-storage-accounts"></a>Применение CMK к учетным записям хранения
Чтобы настроить учетную запись хранения Azure для использования управляемых клиентом ключей с Azure Key Vault, используйте [портал Azure](../../storage/common/customer-managed-keys-configure-key-vault.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json), [PowerShell](../../storage/common/customer-managed-keys-configure-key-vault.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json) или [CLI](../../storage/common/customer-managed-keys-configure-key-vault.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json). 

## <a name="managing-linked-storage-accounts"></a>Управление связанными учетными записями хранения

Чтобы связать или отменить связь учетных записей хранения с рабочей областью, используйте [Azure CLI](/cli/azure/monitor/log-analytics/workspace/linked-storage) или [REST API](/rest/api/loganalytics/linkedstorageaccounts).

##### <a name="create-or-modify-a-link"></a>Создание или изменение ссылки
При связывании учетной записи хранения с рабочей областью Log Analytics начнет использовать ее вместо учетной записи хранения, которой владеет служба. Вы можете выполнить следующие действия: 
* Регистрация нескольких учетных записей хранения для распределения нагрузки журналов между ними
* Повторно использовать одну и ту же учетную запись хранения для нескольких рабочих областей

##### <a name="unlink-a-storage-account"></a>Удаление привязки учетной записи хранения
Чтобы отменить использование учетной записи хранения, отключите связь хранилища с рабочей областью. Отмена связи всех учетных записей хранения с рабочей областью означает, Log Analytics будет пытаться полагаться на учетные записи хранения, управляемые службой. Если сеть имеет ограниченный доступ к Интернету, эти хранилища могут быть недоступны, и в любом сценарии, использующем хранилище, произойдет сбой.

##### <a name="replace-a-storage-account"></a>Замена учетной записи хранения
Чтобы заменить учетную запись хранения, используемую для приема,
1.  **Создайте ссылку на новую учетную запись хранения.** Агенты ведения журнала получают обновленную конфигурацию и начинают отправлять данные в новое хранилище. Процесс может занять несколько минут.
2.  **Затем удалите связь со старой учетной записью хранения, чтобы агенты не перестанут записывать в удаленную учетную запись.** Процесс приема данных позволяет считывать данные из этой учетной записи до тех пор, пока все они не будут приняты. Не удаляйте учетную запись хранения, пока не будут приняты данные всех журналов.

### <a name="maintaining-storage-accounts"></a>Обслуживание учетных записей хранения
##### <a name="manage-log-retention"></a>Управление хранением журнала
При использовании собственной учетной записи хранения срок хранения не ограничен. Иными словами, Log Analytics не удаляет журналы, хранящиеся в частном хранилище. Вместо этого следует настроить политику для выполнения загрузки в соответствии с вашими предпочтениями.

##### <a name="consider-load"></a>Рассмотрите возможность загрузки
Учетные записи хранения могут выполнять определенную нагрузку на запросы на чтение и запись перед началом запросов на регулирование (Дополнительные сведения см. в разделе [целевые показатели масштабируемости и производительности для хранилища BLOB-объектов](../../storage/common/scalability-targets-standard-account.md) ). Регулирование влияет на время, необходимое для приема журналов. Если ваша учетная запись хранения перегружена, зарегистрируйте дополнительную учетную запись хранения, чтобы распределить нагрузку между ними. Чтобы отслеживать емкость и производительность учетной записи хранения, проверьте ее [в портал Azure]( https://docs.microsoft.com/azure/azure-monitor/insights/storage-insights-overview).

### <a name="related-charges"></a>Связанные расходы
На учетные записи хранения начисляются объем хранимых данных, тип хранилища и тип избыточности. Дополнительные сведения см. в статьях [Цены на хранение блочных BLOB-объектов](https://azure.microsoft.com/pricing/details/storage/blobs) и [Цены на хранилище таблиц Azure](https://azure.microsoft.com/pricing/details/storage/tables).


## <a name="next-steps"></a>Дальнейшие действия

- Узнайте [, как использовать частную ссылку Azure для безопасного подключения сетей к Azure Monitor](private-link-security.md)
- Дополнительные сведения о [Azure Monitor управляемых клиентом ключах](customer-managed-keys.md)
