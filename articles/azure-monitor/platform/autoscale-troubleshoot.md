---
title: Устранение неполадок автоматического масштабирования Azure
description: Отслеживание проблем с автомасштабированием Azure, используемых в Service Fabric, виртуальных машинах, веб-приложениях и облачных службах.
author: rboucher
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 11/4/2019
ms.author: robb
ms.subservice: autoscale
ms.openlocfilehash: 410c182075d0aa288ad05195958c396f1a357ff1
ms.sourcegitcommit: 8bd85510aee664d40614655d0ff714f61e6cd328
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/06/2019
ms.locfileid: "74893575"
---
# <a name="troubleshooting-azure-autoscale"></a>Устранение неполадок автоматического масштабирования Azure
 
Azure Monitor Автомасштабирование позволяет получить правильный объем ресурсов, выполняющихся для выполнения нагрузки на приложение. Она позволяет добавлять ресурсы для увеличения нагрузки, а также экономить деньги за счет удаления ресурсов, которые находятся в состоянии простоя. Масштабирование можно выполнить по расписанию, с фиксированным временем или с выбранной метрикой ресурса. Дополнительные сведения см. в разделе [Общие сведения об автомасштабировании](autoscale-overview.md).

Служба автомасштабирования предоставляет метрики и журналы, чтобы понять, какие действия масштабирования были выполнены, и оценить условия, которые привели к этим действиям. Вы можете найти ответы на такие вопросы:

- Почему служба была горизонтально масштабирована или в?
- Почему моя служба не масштабируется?
- Почему не удалось выполнить действие автоматического масштабирования?
- Почему действие автомасштабирования занимает время масштабирования?
  
## <a name="autoscale-metrics"></a>Метрики автомасштабирования

Автомасштабирование предоставляет [четыре метрики](metrics-supported.md#microsoftinsightsautoscalesettings) для понимания работы. 

- **Наблюдаемое значение метрики** — значение метрики, которую вы выбрали для выполнения действия масштабирования, как видно или вычислено модулем автомасштабирования. Поскольку один параметр автомасштабирования может иметь несколько правил и, следовательно, несколько источников метрик, можно использовать "источник метрики" в качестве измерения.
- **Порог метрики** — порог, заданный для выполнения действия масштабирования. Поскольку один параметр автомасштабирования может иметь несколько правил и, следовательно, несколько источников метрик, можно отфильтровать использование "правила метрики" в качестве измерения.
- **Наблюдаемая емкость** — активное количество экземпляров целевого ресурса, отображаемое модулем автомасштабирования.
- **Инициированные действия масштабирования** — количество действий масштабирования и масштабирования, инициированных модулем автомасштабирования. В действиях можно выполнять фильтрацию по масштабированию и масштабированию.

Вы можете использовать [Обозреватель метрик](metrics-getting-started.md) , чтобы выработать приведенные выше метрики в одном месте. На диаграмме должна отобразиться:

  - Фактическая метрика
  - Метрика, показанная или вычисленная модулем автомасштабирования
  - пороговое значение для действия масштабирования
  - изменение емкости 

## <a name="example-1---analyzing-a-simple-autoscale-rule"></a>Пример 1. анализ простого правила автомасштабирования 

У нас есть простой параметр автомасштабирования для масштабируемого набора виртуальных машин, который:

- масштабируется, когда средняя доля ЦП в наборе превышает 70% в течение 10 минут. 
- масштабируется, когда процент ЦП в наборе составляет менее 5% в течение более 10 минут. 

Давайте рассмотрим метрики из службы автомасштабирования.
 
![Пример масштабируемого набора виртуальных машин в процентах](media/autoscale-troubleshoot/autoscale-vmss-CPU-ex-full-1.png)

![Пример масштабируемого набора виртуальных машин в процентах](media/autoscale-troubleshoot/autoscale-vmss-CPU-ex-full-2.png)

***Рис. 1a. Метрика ЦП в процентах для масштабируемого набора виртуальных машин и наблюдаемая метрика значения метрики для параметра автомасштабирования***

![Пороговое значение метрики и наблюдаемая емкость](media/autoscale-troubleshoot/autoscale-metric-threshold-capacity-ex-full.png)

***Рис. 1b. пороговое значение метрики и наблюдаемая емкость***

На рис. 1b **пороговое значение метрики** (светло-синяя линия) для правила горизонтального масштабирования равно 70.  **Наблюдаемая емкость** (темно-синяя линия) показывает количество активных экземпляров, которые в настоящее время 3. 

> [!NOTE]
> **Пороговое значение метрики** необходимо отфильтровать с помощью правила "измерение триггера измерения масштаб (увеличение)", чтобы увидеть пороговое значение горизонтального масштабирования и масштаб в правиле (уменьшить). 

## <a name="example-2---advanced-autoscaling-for-a-virtual-machine-scale-set"></a>Пример 2. Расширенное Автомасштабирование для масштабируемого набора виртуальных машин

У нас есть параметр автомасштабирования, который позволяет масштабировать ресурс масштабируемого набора виртуальных машин на основе собственных метрик **исходящих потоков**. Обратите внимание, что установлен параметр **деление метрика на число экземпляров** для порогового значения метрики. 

Правило действия масштабирования: 

Если значение **исходящего потока на экземпляр** больше 10, служба автомасштабирования должна масштабироваться на 1 экземпляр. 

В этом случае наблюдаемое значение метрики механизма автомасштабирования вычисляется как фактическое значение метрики, деленное на количество экземпляров. Если наблюдаемое значение метрики меньше порогового значения, действие масштабирования не инициируется. 
 
![Пример диаграмм метрик автомасштабирования для масштабируемого набора виртуальных машин](media/autoscale-troubleshoot/autoscale-vmss-metric-chart-ex-1.png)

![Пример диаграмм метрик автомасштабирования для масштабируемого набора виртуальных машин](media/autoscale-troubleshoot/autoscale-vmss-metric-chart-ex-2.png)

***Рис. 2. Пример диаграмм метрик автомасштабирования для масштабируемого набора виртуальных машин***

На рис. 2 показаны две диаграммы метрик. 

На диаграмме вверху показано фактическое значение метрики **исходящих потоков** . Фактическое значение равно 6. 

На диаграмме внизу отображается несколько значений. 
 - **Наблюдаемое значение метрики** (светло-синий) равно 3, так как имеется 2 активных экземпляра, а 6, деленное на 2, равно 3. 
 - **Наблюдаемая емкость** (сиреневый) показывает число экземпляров, отображаемое модулем автомасштабирования. 
 - **Пороговое значение метрики** (светло-зеленый) равно 10. 

Если существует несколько правил масштабирования, можно использовать разделение или параметр **Добавить фильтр** в диаграмме обозревателя метрик для просмотра метрики по определенному источнику или правилу. Дополнительные сведения о разделении диаграммы метрик см. в разделе [Дополнительные возможности диаграмм метрик — разделение](metrics-charts.md#apply-splitting-to-a-chart)

## <a name="example-3---understanding-autoscale-events"></a>Пример 3. Основные сведения о событиях автомасштабирования

На экране настройки автомасштабирования перейдите на вкладку **Журнал выполнения** , чтобы просмотреть последние действия по масштабированию. На вкладке также показано изменение **наблюдаемой емкости** с течением времени. Чтобы получить дополнительные сведения обо всех действиях автомасштабирования, включая операции обновления и удаления, просмотрите журнал действий и выполните фильтрацию по операциям автомасштабирования.

![Журнал выполнения параметров автомасштабирования](media/autoscale-troubleshoot/autoscale-setting-run-history-smaller.png)

## <a name="autoscale-resource-logs"></a>Автоматическое масштабирование журналов ресурсов

Как и любой другой ресурс Azure, служба автомасштабирования предоставляет [журналы ресурсов](resource-logs-overview.md). Существует две категории журналов.

- **Вычисления автомасштабирования** . модуль автомасштабирования записывает записи журнала для каждой оценки отдельных условий при каждом выполнении проверки.  Запись содержит подробные сведения об наблюдаемых значениях метрик, правилах, которые были оценены, а также значение, если вычисление привело к действию масштабирования.

- **Действия автоматического масштабирования** . подсистема записывает события масштабирования, инициированные службой автомасштабирования, и результаты этих действий масштабирования (успех, сбой и объем масштабирования, отображаемый службой автомасштабирования).

Как и в случае с любой Azure Monitor поддерживаемой службой, можно использовать [параметры диагностики](diagnostic-settings.md) для маршрутизации следующих журналов:

- в рабочую область Log Analytics для подробного анализа
- в концентраторы событий, а затем в средства, не связанные с Azure
- в учетную запись хранения Azure для архивации  

![Параметры диагностики автомасштабирования](media/autoscale-troubleshoot/diagnostic-settings.png)

На предыдущем рисунке показан портал Azure параметры диагностики автомасштабирования. Здесь можно выбрать вкладку "Диагностика и журналы ресурсов" и включить сбор журналов и маршрутизацию. Вы также можете выполнить то же действие с помощью REST API, интерфейса командной строки, PowerShell диспетчер ресурсов шаблонов для параметров диагностики, выбрав тип ресурса *Microsoft. Insights/AutoscaleSettings*. 

## <a name="troubleshooting-using-autoscale-logs"></a>Устранение неполадок с помощью журналов автомасштабирования 

Для лучшего удобства устранения неполадок рекомендуется перенаправлять журналы в Azure Monitor журналы (Log Analytics) через рабочую область при создании параметра автомасштабирования. Этот процесс показан на рисунке в предыдущем разделе. Вы можете проверить действия оценки и масштабирования лучше с помощью Log Analytics.

После настройки журналов автомасштабирования для отправки в рабочую область Log Analytics можно выполнить следующие запросы для проверки журналов. 

Чтобы приступить к работе, попробуйте выполнить этот запрос, чтобы просмотреть самые последние журналы оценки автомасштабирования:

```Kusto
AutoscaleEvaluationsLog
| limit 50
```

Или попробуйте выполнить следующий запрос, чтобы просмотреть самые последние журналы действий масштабирования:

```Kusto
AutoscaleScaleActionsLog
| limit 50
```

Используйте следующие разделы для этих вопросов. 

## <a name="a-scale-action-occurred-that-i-didnt-expect"></a>Произошло действие масштабирования, которое я не ожидал

Сначала выполните запрос для действия масштабирования, чтобы найти требуемое действие масштабирования. Если это последнее действие масштабирования, используйте следующий запрос:

```Kusto
AutoscaleScaleActionsLog
| take 1
```

Выберите поле CorrelationId из журнала действий масштабирования. Используйте CorrelationId, чтобы найти правильный журнал оценки. При выполнении приведенного ниже запроса будут показаны все правила и условия, которые были оценены в ходе действия масштабирования.

```Kusto
AutoscaleEvaluationsLog
| where CorrelationId = "<correliationId>"
```

## <a name="what-profile-caused-a-scale-action"></a>Какой профиль вызывал действие масштабирования?

Выполнено масштабированное действие, но имеются перекрывающиеся правила и профили, и необходимо выполнить отправку вниз, которая привела к выполнению действия. 

Найдите correlationId действия масштабирования (как описано в примере 1), а затем выполните запрос к журналам оценки, чтобы узнать больше о профиле.

```Kusto
AutoscaleEvaluationsLog
| where CorrelationId = "<correliationId_Guid>"
| where ProfileSelected == true
| project ProfileEvaluationTime, Profile, ProfileSelected, EvaluationResult
```

Вы также можете лучше понять оценку всего профиля с помощью следующего запроса.

```Kusto
AutoscaleEvaluationsLog
| where TimeGenerated > ago(2h)
| where OperationName contains == "profileEvaluation"
| project OperationName, Profile, ProfileEvaluationTime, ProfileSelected, EvaluationResult
```

## <a name="a-scale-action-did-not-occur"></a>Действие масштабирования не выполнено

Ожидалось действие масштабирования, которое не было выполнено. Могут отсутствовать события или журналы действий масштабирования.

Если вы используете правило масштабирования на основе метрик, проверьте метрики автомасштабирования. Возможно, **наблюдаемое значение метрики** или **наблюдаемая емкость** не являются ожидаемыми, поэтому правило масштабирования не срабатывает. Вы по-прежнему увидите оценки, но не правило горизонтального масштабирования. Также возможно, что время, необходимое для выполнения действия масштабирования, было недоступно. 

 Проверьте журналы оценки автомасштабирования в течение периода времени, в течение которого должно выполняться действие масштабирования. Проверьте все выполненные оценки и причины, по которым он не инициировал действие масштабирования.


```Kusto
AutoscaleEvaluationsLog
| where TimeGenerated > ago(2h)
| where OperationName == "MetricEvaluation" or OperationName == "ScaleRuleEvaluation"
| project OperationName, MetricData, ObservedValue, Threshold, EstimateScaleResult
```

## <a name="scale-action-failed"></a>Сбой действия масштабирования

Может возникнуть ситуация, когда служба автомасштабирования выполняла действие масштабирования, но система решила не масштабировать или не удалось выполнить действие масштабирования. Используйте этот запрос, чтобы найти действия по масштабированию, завершившиеся сбоем.

```Kusto
AutoscaleScaleActionsLog
| where ResultType == "Failed"
| project ResultDescription
```

Создайте правила генерации оповещений, чтобы получать уведомления о действиях и сбоях автомасштабирования. Вы также можете создать правила генерации оповещений, чтобы получать уведомления о событиях автомасштабирования.

## <a name="schema-of-autoscale-resource-logs"></a>Схема журналов ресурсов автомасштабирования

Дополнительные сведения см. в статье [Автомасштабирование журналов ресурсов](autoscale-resource-log-schema.md) .

## <a name="next-steps"></a>Дальнейшие действия
Ознакомьтесь со сведениями о рекомендациях по [автомасштабированию](autoscale-best-practices.md). 