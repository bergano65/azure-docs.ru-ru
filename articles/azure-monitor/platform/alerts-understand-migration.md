---
title: Общие сведения о миграции для Azure Monitor оповещений
description: Узнайте, как работает миграция оповещений и устранение неполадок.
ms.topic: conceptual
ms.date: 07/10/2019
ms.author: yalavi
author: yalavi
ms.subservice: alerts
ms.openlocfilehash: 52a74593fcfbdc2c1e464077e4ae460f6a5a9c39
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "87852401"
---
# <a name="understand-migration-options-to-newer-alerts"></a>Общие сведения о вариантах миграции для новых оповещений

Классические оповещения удаляются, но по-прежнему используются для [ресурсов, которые](./monitoring-classic-retirement.md)пока не поддерживают новые оповещения. Вскоре будет выводится новая дата для миграции оставшихся предупреждений, [облака Azure для государственных организаций](../../azure-government/documentation-government-welcome.md)и [Azure Китая (21vianet](https://docs.azure.cn/)).

В этой статье объясняется, как работает средство миграции вручную и Добровольная миграция, которые будут использоваться для переноса оставшихся правил генерации оповещений. Кроме того, здесь описываются способы устранения некоторых распространенных проблем.

> [!IMPORTANT]
> Миграция не влияет на оповещения журнала действий (включая оповещения о работоспособности службы) и оповещения журнала. Миграция применяется только к классическим правилам генерации оповещений, описанным [здесь](monitoring-classic-retirement.md#retirement-of-classic-monitoring-and-alerting-platform).

> [!NOTE]
> Если классические правила генерации оповещений недопустимы, т. е. они находятся в [нерекомендуемых метриках](#classic-alert-rules-on-deprecated-metrics) или ресурсах, которые были удалены, они не будут перенесены и станут недоступны после прекращения использования службы.

## <a name="manually-migrating-classic-alerts-to-newer-alerts"></a>Ручная миграция классических оповещений в новые предупреждения

Клиенты, заинтересованные в ручном переносе своих оставшихся оповещений, уже могут сделать это с помощью следующих разделов. В этих разделах также определяются метрики, снятые поставщиком ресурсов, и в настоящее время их нельзя перенести напрямую.

### <a name="guest-metrics-on-virtual-machines"></a>Метрики гостя на виртуальных машинах

Прежде чем создавать новые оповещения метрики для гостевых метрик, необходимо отправить метрики гостя в хранилище пользовательских метрик Azure Monitor. Выполните следующие инструкции, чтобы включить приемник Azure Monitor в параметрах диагностики:

- [Включение метрик гостя для виртуальных машин Windows](collect-custom-metrics-guestos-resource-manager-vm.md)
- [Включение метрик гостевого компьютера для виртуальных машин Linux](collect-custom-metrics-linux-telegraf.md)

После выполнения этих действий можно создать новые оповещения на основе метрик для гостевых метрик. После создания новых оповещений метрик можно удалить классические оповещения.

### <a name="storage-account-metrics"></a>Метрики учетной записи хранения

Все классические оповещения в учетных записях хранения можно перенести, за исключением предупреждений по этим метрикам:

- PercentAuthorizationError
- PercentClientOtherError
- PercentNetworkError
- PercentServerOtherError
- PercentSuccess
- PercentThrottlingError
- PercentTimeoutError
- AnonymousThrottlingError
- SASThrottlingError
- ThrottlingError

Классические правила генерации оповещений для метрик процента должны быть перенесены на основе [сопоставления старых и новых метрик хранилища](../../storage/common/storage-metrics-migration.md#metrics-mapping-between-old-metrics-and-new-metrics). Необходимо соответствующим образом изменить пороговые значения, так как новая метрика станет абсолютной.

Классические правила генерации оповещений на Анонимауссроттлинжеррор, Сассроттлинжеррор и Сроттлинжеррор должны быть разделены на два новых оповещения, поскольку не существует Объединенных метрик, предоставляющая те же функциональные возможности. Пороговые значения потребуется адаптировать соответствующим образом.

### <a name="cosmos-db-metrics"></a>Метрики Cosmos DB

Все классические оповещения о метриках Cosmos DB можно перенести, за исключением предупреждений по этим метрикам:

- Среднее число запросов в секунду
- Уровень согласованности
- HTTP 2xx
- HTTP 3xx:
- HTTP 400
- HTTP 401:
- Внутренняя ошибка сервера
- Максимальное количество использованных РУПМ в минуту
- Максимальное число получателей в секунду
- Количество неудачных запросов Mongo
- Mongo неудачные запросы на удаление
- Mongo неудачных запросов вставки
- Mongo другие неудачные запросы
- Mongo другая плата за запросы
- Mongo другая частота запросов
- Запросы с ошибками запросов Mongo
- Неудачных запросов на обновление Mongo
- Наблюдаемая задержка чтения
- Наблюдаемая задержка записи
- Доступность службы
- Емкость хранилища
- Регулируемые запросы
- Общее количество запросов

Среднее число запросов в секунду, уровень согласованности, максимальное количество РУПМ, потребляемых в минуту, Макс. в секунду, наблюдаемая задержка чтения, наблюдаемая задержка записи, в настоящее время емкость хранилища не доступна в [новой системе](metrics-supported.md#microsoftdocumentdbdatabaseaccounts).

Оповещения о метриках запросов, например HTTP 2xx, HTTP 3xx, HTTP 400, HTTP 401, внутренняя ошибка сервера, доступность службы, регулируемые запросы и общее количество запросов, не переносятся, так как запросы между классическими метриками и новыми метриками различны. Оповещения о них необходимо будет вручную создать повторно с скорректированными пороговыми значениями.

Оповещения о неудачных запросах Mongo должны быть разделены на несколько предупреждений, так как отсутствует Объединенная метрика, предоставляющая те же функциональные возможности. Пороговые значения потребуется адаптировать соответствующим образом.

### <a name="classic-compute-metrics"></a>Классические метрики вычислений

Все оповещения в классических показателях вычислений не будут перенесены с помощью средства миграции, так как классические ресурсы вычислений еще не поддерживаются с новыми предупреждениями. Поддержка новых оповещений для этих типов ресурсов в настоящее время доступна в общедоступной предварительной версии, и клиенты могут повторно создавать новые эквивалентные правила оповещений на основе их классических правил генерации оповещений.

### <a name="classic-alert-rules-on-deprecated-metrics"></a>Классические правила генерации оповещений на устаревших метриках

Это классические правила генерации оповещений для метрик, которые ранее поддерживались, но в конечном итоге являются устаревшими. Небольшой процент от клиента может иметь недопустимые классические правила генерации оповещений для таких метрик. Так как эти правила оповещений являются недопустимыми, они не будут перенесены.

| Тип ресурса| Устаревшие метрики |
|-------------|----------------- |
| Microsoft.DBforMySQL/servers | compute_consumption_percent, compute_limit |
| Microsoft.DBforPostgreSQL/servers | compute_consumption_percent, compute_limit |
| Microsoft.Network/publicIPAddresses | дефаултддостригжеррате |
| Microsoft.SQL/servers/databases | service_level_objective, storage_limit, storage_used, регулирование, dtu_consumption_percent, storage_used |
| Microsoft. Web/hostingEnvironments/мултиролепулс | аверажемемориворкингсет |
| Microsoft. Web/hostingEnvironments/внешнего размещения | битесрецеивед, хттпкуеуеленгс |

## <a name="how-equivalent-new-alert-rules-and-action-groups-are-created"></a>Как создаются эквивалентные новые правила генерации оповещений и группы действий

Средство миграции преобразует классические правила генерации оповещений в эквивалентные новые правила генерации оповещений и группы действий. Для большинства классических правил генерации оповещений эквивалентные новые правила генерации оповещений находятся в одной и той же метрике с такими же свойствами, как `windowSize` и `aggregationType` . Однако некоторые классические правила генерации оповещений относятся к метрикам, имеющим разные эквивалентные метрики в новой системе. Следующие принципы применяются к переносу классических оповещений, если они не указаны в разделе ниже.

- **Frequency**: определяет, как часто будет проверяться наличие в классическом или новом правиле генерации оповещений для условия. `frequency`В классических правилах оповещений пользователь не настраивается пользователем и всегда был 5 минут для всех типов ресурсов, кроме Application Insights компонентов, для которых он был 1 мин. Таким образом, частота эквивалентных правил также равна 5 минутам и 1 минутам соответственно.
- **Тип статистической обработки**: определяет, как Статистическая обработка метрики осуществляется по интересующему окну. `aggregationType`Кроме того, между классическими предупреждениями и новыми оповещениями для большинства метрик. В некоторых случаях, поскольку метрика отличается между классическими предупреждениями и новыми оповещениями, `aggregationType` используется эквивалент или, `primary Aggregation Type` определенный для метрики.
- **Units**: свойство метрики, для которой создается оповещение. Некоторые эквивалентные метрики имеют разные единицы измерения. При необходимости пороговое значение корректируется соответствующим образом. Например, если исходная метрика содержит секунды как единицы, но эквивалентная новая метрика имеет миллисекунды как единицы, то исходное пороговое значение умножается на 1000 для обеспечения того же поведения.
- **Размер окна**: определяет окно, по которому объединяются данные метрики для сравнения с пороговым значением. Для стандартных `windowSize` значений, таких как 5mins, 15mins, 30mins, 1hour, 3hours, 6 часов, 12 часов, 1 день, для эквивалентного нового правила генерации оповещений не вносится никаких изменений. Для других значений `windowSize` выбирается ближайший вариант для использования. Большинство клиентов не влияют на это изменение. Для небольшого количества клиентов может потребоваться настроить пороговое значение, чтобы добиться точно такого же поведения.

В следующих разделах мы подробно рассмотрим метрики, имеющие другую эквивалентную метрику в новой системе. Все метрики, которые остаются неизменными для классических и новые правила генерации оповещений, не перечислены. Список метрик, поддерживаемых в новой системе, можно найти [здесь](metrics-supported.md).

### <a name="microsoftstorageaccountsservices"></a>Microsoft. StorageAccounts/Services

Для служб учетных записей хранения, таких как BLOB-объекты, таблицы, файлы и очереди, следующие метрики сопоставляются с эквивалентными метриками, как показано ниже.

| Метрика в классических оповещениях | Эквивалентная метрика в новых предупреждениях | Комментарии|
|--------------------------|---------------------------------|---------|
| AnonymousAuthorizationError| Метрика транзакций с измерениями «ResponseType» = «AuthorizationError» и «Authentication» = «Anonymous»| |
| AnonymousClientOtherError | Метрика транзакций с измерениями «ResponseType» = «Клиентосереррор» и «Authentication» = «Anonymous» | |
| анонимаусклиенттимеаутеррор| Метрика транзакций с измерениями «ResponseType» = «ClientTimeOutError» и «Authentication» = «Anonymous» | |
| AnonymousNetworkError | Метрика транзакций с измерениями «ResponseType» = «NetworkError» и «Authentication» = «Anonymous» | |
| AnonymousServerOtherError | Метрика транзакций с измерениями «ResponseType» = «Серверосереррор» и «Authentication» = «Anonymous» | |
| анонимауссервертимеаутеррор | Метрика транзакций с измерениями «ResponseType» = «ServerTimeOutError» и «Authentication» = «Anonymous» | |
| AnonymousSuccess | Метрика транзакций с измерениями «ResponseType» = «Success» и «Authentication» = «Anonymous» | |
| AuthorizationError | Метрика транзакций с измерениями "ResponseType" = "AuthorizationError" | |
| AverageE2ELatency | SuccessE2ELatency | |
| AverageServerLatency | SuccessServerLatency | |
| Capacity | BlobCapacity | Используйте `aggregationType` "Average" вместо "Last". Метрика применяется только к службам BLOB-объектов |
| ClientOtherError | Метрика транзакций с измерениями "ResponseType" = "Клиентосереррор"  | |
| ClientTimeoutError | Метрика транзакций с измерениями "ResponseType" = "ClientTimeOutError" | |
| ContainerCount | ContainerCount | Используйте `aggregationType` "Average" вместо "Last". Метрика применяется только к службам BLOB-объектов |
| NetworkError | Метрика транзакций с измерениями "ResponseType" = "NetworkError" | |
| ObjectCount | BlobCount| Используйте `aggregationType` "Average" вместо "Last". Метрика применяется только к службам BLOB-объектов |
| SASAuthorizationError | Метрика транзакций с измерениями "ResponseType" = "AuthorizationError" и "Authentication" = "SAS" | |
| SASClientOtherError | Метрика транзакций с измерениями "ResponseType" = "Клиентосереррор" и "Authentication" = "SAS" | |
| сасклиенттимеаутеррор | Метрика транзакций с измерениями "ResponseType" = "ClientTimeOutError" и "Authentication" = "SAS" | |
| SASNetworkError | Метрика транзакций с измерениями "ResponseType" = "NetworkError" и "Authentication" = "SAS" | |
| SASServerOtherError | Метрика транзакций с измерениями "ResponseType" = "Серверосереррор" и "Authentication" = "SAS" | |
| сассервертимеаутеррор | Метрика транзакций с измерениями "ResponseType" = "ServerTimeOutError" и "Authentication" = "SAS" | |
| SASSuccess | Метрика транзакций с измерениями "ResponseType" = "Success" и "Authentication" = "SAS" | |
| ServerOtherError | Метрика транзакций с измерениями "ResponseType" = "Серверосереррор" | |
| ServerTimeOutError | Метрика транзакций с измерениями "ResponseType" = "ServerTimeOutError"  | |
| Успех | Метрика транзакций с измерениями "ResponseType" = "Success" | |
| TotalBillableRequests| Transactions | |
| TotalEgress | Исходящие | |
| TotalIngress | Входящий трафик | |
| TotalRequests | Transactions | |

### <a name="microsoftinsightscomponents"></a>Microsoft. Insights/компоненты

Для Application Insights эквивалентными метриками могут быть, как показано ниже:

| Метрика в классических оповещениях | Эквивалентная метрика в новых предупреждениях | Комментарии|
|--------------------------|---------------------------------|---------|
| доступность. Аваилабилитиметрик. значение | availabilityResults/availabilityPercentage|   |
| доступность. Дуратионметрик. значение | availabilityResults/duration| Умножьте исходное пороговое значение на 1000 в качестве единиц для классической метрики в секундах, а для новой — в миллисекундах.  |
| Басицексцептионбровсер. Count | exceptions/browser|  Используйте `aggregationType` "Count" вместо "Sum". |
| Басицексцептионсервер. Count | exceptions/server| Используйте `aggregationType` "Count" вместо "Sum".  |
| Клиентперформанце. Клиентпроцесс. Value | browserTimings/processingDuration| Умножьте исходное пороговое значение на 1000 в качестве единиц для классической метрики в секундах, а для новой — в миллисекундах.  |
| Клиентперформанце. networkConnection. Value | browserTimings/networkDuration|  Умножьте исходное пороговое значение на 1000 в качестве единиц для классической метрики в секундах, а для новой — в миллисекундах. |
| Клиентперформанце. действия ReceiveRequest. Value | browserTimings/receiveDuration| Умножьте исходное пороговое значение на 1000 в качестве единиц для классической метрики в секундах, а для новой — в миллисекундах.  |
| Клиентперформанце. sendRequest. Value | browserTimings/sendDuration| Умножьте исходное пороговое значение на 1000 в качестве единиц для классической метрики в секундах, а для новой — в миллисекундах.  |
| Клиентперформанце. Total. Value | browserTimings/totalDuration| Умножьте исходное пороговое значение на 1000 в качестве единиц для классической метрики в секундах, а для новой — в миллисекундах.  |
| performanceCounter.available_bytes. Value | performanceCounters/memoryAvailableBytes|   |
| performanceCounter.io_data_bytes_per_sec. Value | performanceCounters/processIOBytesPerSecond|   |
| performanceCounter.number_of_exceps_thrown_per_sec. Value | performanceCounters/exceptionsPerSecond|   |
| performanceCounter.percentage_processor_time_normalized. Value | performanceCounters/processCpuPercentage|   |
| performanceCounter.percentage_processor_time. Value | performanceCounters/processCpuPercentage| Пороговое значение должно быть соответствующим образом изменено, так как исходная метрика находилась во всех ядрах, а новая метрика будет нормализована до одного ядра. Средство миграции не изменяет пороговые значения.  |
| performanceCounter.percentage_processor_total. Value | performanceCounters/processorCpuPercentage|   |
| performanceCounter.process_private_bytes. Value | performanceCounters/processPrivateBytes|   |
| performanceCounter.request_execution_time. Value | performanceCounters/requestExecutionTime|   |
| performanceCounter.requests_in_application_queue. Value | performanceCounters/requestsInQueue|   |
| performanceCounter.requests_per_sec. Value | performanceCounters/requestsPerSecond|   |
| Длительность запроса | requests/duration| Умножьте исходное пороговое значение на 1000 в качестве единиц для классической метрики в секундах, а для новой — в миллисекундах.  |
| Частота запросов | requests/rate|   |
| Рекуестфаилед. Count | requests/failed| Используйте `aggregationType` "Count" вместо "Sum".   |
| представление. количество | pageViews/count| Используйте `aggregationType` "Count" вместо "Sum".   |

### <a name="microsoftdocumentdbdatabaseaccounts"></a>Microsoft.DocumentDB/databaseAccounts

Для Cosmos DB эквивалентными метриками могут быть, как показано ниже:

| Метрика в классических оповещениях | Эквивалентная метрика в новых предупреждениях | Комментарии|
|--------------------------|---------------------------------|---------|
| AvailableStorage     |AvailableStorage|   |
| Размер данных | DataUsage| |
| Число документов | DocumentCount||
| Размер индексов | IndexUsage||
| Плата за Mongo число запросов| Монгорекуестчарже с измерением "CommandName" = "Count"||
| Частота запросов Mongo Count | Монгорекуестскаунт с измерением "CommandName" = "Count"||
| Плата за запрос на удаление Mongo | Монгорекуестчарже с измерением "CommandName" = "Delete"||
| Частота запросов Mongo на удаление | Монгорекуестскаунт с измерением "CommandName" = "Delete"||
| Плата за запрос вставки Mongo | Монгорекуестчарже с измерением "CommandName" = "Insert"||
| Частота запросов Mongo на вставку | Монгорекуестскаунт с измерением "CommandName" = "Insert"||
| Плата за запрос Mongo запросов | Монгорекуестчарже с измерением "CommandName" = "Find"||
| Частота запросов Mongo на чтение | Монгорекуестскаунт с измерением "CommandName" = "Find"||
| Плата за запрос на обновление Mongo | Монгорекуестчарже с измерением "CommandName" = "Update"||
| Служба недоступна| ServiceAvailability||
| TotalRequestUnits | TotalRequestUnits||

### <a name="how-equivalent-action-groups-are-created"></a>Как создаются эквивалентные группы действий

Классические правила генерации оповещений имеют электронную почту, веб-перехватчик, приложение логики и действия Runbook, привязанные к самому правилу оповещения. Новые правила генерации оповещений используют группы действий, которые можно повторно использовать в нескольких правилах генерации оповещений. Средство миграции создает одну группу действий для тех же действий независимо от того, сколько правил генерации оповещений использует действие. Группы действий, созданные средством миграции, используют формат именования "Migrated_AG *".

> [!NOTE]
> Классические оповещения отправляли локализованные сообщения электронной почты на основе локали классического администратора при использовании для уведомления ролей классического администратора. Новые сообщения электронной почты с оповещениями отправляются через группы действий и доступны только на английском языке.

## <a name="rollout-phases"></a>Этапы выпуска

Средство миграции выполняется поэтапно для клиентов, использующих классические правила генерации оповещений. Владельцы подписки получат сообщение электронной почты, когда подписка будет готова к миграции с помощью средства.

> [!NOTE]
> Так как средство выходит за этапы, вы можете заметить, что некоторые подписки еще не готовы к переносу на ранних этапах.

Большинство подписок в настоящий момент помечены как готовые к миграции. Все подписки с классическими оповещениями для следующих типов ресурсов все еще не готовы к миграции.

- Microsoft. classicCompute/имя_домена/слоты/роли
- Microsoft. Insights/компоненты

## <a name="who-can-trigger-the-migration"></a>Кто может активировать миграцию?

Любой пользователь, имеющий встроенную роль участника мониторинга на уровне подписки, может запустить миграцию. Пользователи, имеющие пользовательскую роль со следующими разрешениями, также могут активировать миграцию:

- */чтение
- Microsoft.Insights/actiongroups/*
- Microsoft.Insights/AlertRules/*
- Microsoft.Insights/metricAlerts/*
- Microsoft.AlertsManagement/smartDetectorAlertRules/*

> [!NOTE]
> Кроме указанных выше разрешений, подписка должна быть дополнительно зарегистрирована в поставщике ресурсов Microsoft. Алертсманажемент. Это необходимо для успешной миграции предупреждений об аномалиях сбоя на Application Insights. 

## <a name="common-problems-and-remedies"></a>Распространенные проблемы и способы их устранения

После [активации миграции](alerts-using-migration-tool.md)вы получите электронное сообщение по указанным адресам, чтобы уведомить вас о завершении миграции или о необходимости каких-либо действий. В этом разделе описаны некоторые распространенные проблемы и способы их решения.

### <a name="validation-failed"></a>Проверка завершена с ошибкой

Из-за внесения последних изменений в классические правила генерации оповещений в подписке невозможно перенести подписку. Эта проблема является временной. Вы можете перезапустить миграцию после того, как миграция перейдет в состояние **готовности к миграции** через несколько дней.

### <a name="scope-lock-preventing-us-from-migrating-your-rules"></a>Блокировка области не позволила перенести правила

В рамках миграции будут созданы новые оповещения о метриках и новые группы действий, а затем классические правила генерации оповещений будут удалены. Однако блокировка области может препятствовать созданию и удалению ресурсов. В зависимости от блокировки области некоторые или все правила не могут быть перенесены. Эту проблему можно устранить, удалив блокировку области для подписки, группы ресурсов или ресурса, которая указана в [средстве миграции](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/MigrationBladeViewModel), и снова запустите миграцию. Блокировка области не может быть отключена и должна быть удалена в течение процесса миграции. Дополнительные [сведения об управлении блокировками областей](../../azure-resource-manager/management/lock-resources.md#portal).

### <a name="policy-with-deny-effect-preventing-us-from-migrating-your-rules"></a>Политика с результатом "deny" не позволила перенести ваши правила

В рамках миграции будут созданы новые оповещения о метриках и новые группы действий, а затем классические правила генерации оповещений будут удалены. Однако политика может препятствовать созданию ресурсов. В зависимости от политики некоторые или все правила не могут быть перенесены. Политики, блокирующие процесс, перечислены в [средстве миграции](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/MigrationBladeViewModel). Устраните эту проблему одним из следующих причин:

- Исключение подписок или групп ресурсов на время процесса миграции из назначения политики. Дополнительные [сведения об управлении областью исключения политик](../../governance/policy/tutorials/create-and-manage.md#exempt-a-non-compliant-or-denied-resource-using-exclusion).
- Удаление или изменение влияния на "Audit" или "Append" (например, может решить проблемы, связанные с отсутствующими тегами). Дополнительные [сведения об управлении последствиями политик](../../governance/policy/concepts/definition-structure.md#policy-rule).

## <a name="next-steps"></a>Дальнейшие шаги

- [Как использовать средство миграции](alerts-using-migration-tool.md)
- [Подготовка к миграции](alerts-prepare-migration.md)
