---
title: Оповещения журнала в Azure Monitor
description: Активация сообщений электронной почты, уведомлений, вызов URL-адресов веб-сайтов (Web перехватчики) или Автоматизация при выполнении указанного условия запроса журнала
author: yanivlavi
ms.author: yalavi
ms.topic: conceptual
ms.date: 5/31/2019
ms.subservice: alerts
ms.openlocfilehash: 8081c60833c3c02d55ae66ca695ba106dba01450
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91294144"
---
# <a name="log-alerts-in-azure-monitor"></a>Оповещения журнала в Azure Monitor

## <a name="overview"></a>Обзор

Оповещения журнала — это один из типов оповещений, которые поддерживаются в [оповещениях Azure](./alerts-overview.md). Оповещения журнала позволяют пользователям использовать [log Analytics](../log-query/get-started-portal.md) запрос для проверки журнала ресурсов каждые заданные частоты и запуска предупреждения на основе результатов. Правила могут запускать одно или несколько действий с помощью [групп действий](./action-groups.md).

> [!NOTE]
> Данные журнала из [log Analytics рабочей области](../log-query/get-started-portal.md) можно отправить в хранилище метрик Azure Monitor. Поведение оповещений метрик [отличается от поведения](alerts-metric-overview.md), которое может быть более желательным в зависимости от данных, с которыми вы работаете. Сведения о том, что и как можно направить журналы в метрики, см. в разделе [метрики оповещений для журналов](alerts-metric-logs.md).

> [!NOTE]
> В настоящее время дополнительная плата за использование версий API `2020-05-01-preview` и оповещений журнала не взимается.  Цены на функции, доступные в предварительной версии, будут объявлены в будущем и появится уведомление перед началом выставления счетов. Если вы решили продолжить использование новой версии API и оповещений журнала на основе ресурсов по истечении периода уведомления, плата будет взиматься по применимой ставке.

## <a name="prerequisites"></a>Предварительные требования

Оповещения журнала выполняют запросы к данным Log Analytics. Сначала следует начать [сбор данных журнала](resource-logs.md) и запросить проблемы в данных журнала. Вы можете использовать [раздел "примеры запросов предупреждений](../log-query/saved-queries.md) " в log Analytics, чтобы понять, что можно обнаружить или приступить к [написанию собственного запроса](../log-query/get-started-portal.md).

[Участник мониторинга Azure](./roles-permissions-security.md) — это общая роль, которая необходима для создания, изменения и обновления оповещений журнала. Также требуются права на выполнение запроса & для журналов ресурсов. Частичный доступ к журналам ресурсов может привести к сбою запросов или вернуть частичные результаты. Дополнительные [сведения о настройке оповещений журнала в Azure](./alerts-log.md).

> [!NOTE]
> Оповещения журнала для Log Analytics, используемых для управления с помощью [API предупреждений](api-alerts.md)устаревших log Analytics. Дополнительные [сведения о переключении на текущий API счедуледкуерирулес](alerts-log-api-switch.md).

## <a name="query-evaluation-definition"></a>Определение оценки запроса

Определение условия для правил поиска по журналам начинается с:

- Какой запрос выполнить?
- Как использовать результаты?

В следующих разделах описываются различные параметры, которые можно использовать для задания указанной выше логики.

### <a name="log-query"></a>Запрос журнала
[Log Analytics](../log-query/get-started-portal.md) запрос, используемый для вычисления правила. Результаты, возвращаемые этим запросом, используются для определения того, следует ли активировать предупреждение. Запрос может быть ограничен:

- Конкретный ресурс, например виртуальная машина.
- Ресурс в масштабе, например подписка или группа ресурсов.
- Несколько ресурсов, использующих [запрос между ресурсами](../log-query/cross-workspace-query.md#querying-across-log-analytics-workspaces-and-from-application-insights). 
 
> [!IMPORTANT]
> Запросы предупреждений имеют ограничения для обеспечения оптимальной производительности и релевантности результатов. [Дополнительные сведения](./alerts-log-query.md)см. здесь.

> [!IMPORTANT]
> Запросы с использованием ресурсов и [перекрестных ресурсов](../log-query/cross-workspace-query.md#querying-across-log-analytics-workspaces-and-from-application-insights) поддерживаются только с помощью текущего API счедуледкуерирулес. Если используется устаревший [API-интерфейс предупреждений log Analytics](api-alerts.md), необходимо будет переключиться. [Дополнительные сведения о переключении](./alerts-log-api-switch.md)

#### <a name="query-time-range"></a>Диапазон времени запроса

Диапазон времени задается в определении условия правила. В рабочих областях и Application Insights он называется **period**. Во всех остальных типах ресурсов он называется **диапазоном времени запроса переопределения**.

Как и в log Analytics, диапазон времени ограничивает данные запроса до указанного диапазона. Даже если в запросе используется команда **назад** , диапазон времени будет применен.

Например, запрос сканирует 60 минут, если диапазон времени равен 60 минутам, даже если текст содержит **назад (1d)**. Диапазон времени и фильтрация времени запроса должны совпадать. В этом примере, если изменить **Period**  /  **диапазон времени запроса переопределения** периода на один день, будет работать должным образом.

### <a name="measure"></a>Measure

Оповещения журнала включают в журнал числовые значения, которые могут быть оценены. Вы можете измерять два различных момента:

#### <a name="count-of-the-results-table-rows"></a>Число строк таблицы результатов

Количество результатов является мерой по умолчанию. Идеально подходит для работы с такими событиями, как журналы событий Windows, системный журнал, исключения приложений. Активируется, когда записи журнала происходят или не происходят в течение расчетного временного интервала.

Оповещения журнала работают наилучшим образом при попытке обнаружить данные в журнале. При попытке обнаружить недостаток данных в журналах он будет работать менее эффективно. Например, оповещение о пульсе виртуальной машины.

Для рабочих областей и Application Insights они вызываются **в зависимости** от выбранного **количества результатов**. Во всех остальных типах ресурсов он называется **Measure** и **строками таблицы**выбора.

> [!NOTE]
> Поскольку журналы представляют собой частично структурированные данные, они по сути являются более скрытыми, чем метрика, при попытке обнаружить недостаток данных в журналах может возникнуть ошибка, и следует использовать [оповещения метрик](alerts-metric-overview.md). Вы можете отправить данные в хранилище метрик из журналов с помощью [оповещений метрик для журналов](alerts-metric-logs.md).

##### <a name="example-of-results-table-rows-count-use-case"></a>Пример варианта использования количества строк таблицы результатов

Вы хотите получить информацию о том, что приложение ответило с кодом ошибки 500 (внутренняя ошибка сервера). Необходимо создать правило генерации оповещений со следующими сведениями:

- **Запрос:** 

```Kusto
requests
| where resultCode == "500"
```

- **Период времени:** 15 минут
- **Периодичность оповещений:** 15 минут
- **Пороговое значение:** больше 0.

Затем правила генерации оповещений отслеживают любые запросы, которые заканчиваются кодом ошибки 500. Запрос выполняется каждые 15 минут за последние 15 минут. Если найдена даже одна запись, она запускает оповещение и запускает настроенные действия.

#### <a name="calculation-of-measure-based-on-a-numeric-column-such-as-cpu-counter-value"></a>Вычисление меры на основе числового столбца (например, значения счетчика ЦП)

Для рабочих областей и Application Insights они вызываются на **основе** **измерения метрик**выбора. Во всех остальных типах ресурсов он называется **Measure** и выбирает любое имя столбца чисел.

### <a name="aggregation-type"></a>Тип агрегирования

Вычисление, выполненное над несколькими записями для объединения их в одно числовое значение. Пример:
- Функция **Count** возвращает количество записей в запросе
- Функция **Average** Возвращает среднее значение [**детализации статистической**](#aggregation-granularity) функции столбца меры.

В рабочих областях и Application Insights они поддерживаются только в типе мер **измерения метрики** . Результат запроса должен содержать столбец с именем AggregatedValue, который предоставляет числовое значение после определяемого пользователем агрегата. Во всех остальных типах ресурсов **тип агрегирования** выбирается из поля с таким именем.

### <a name="aggregation-granularity"></a>Гранулярность статистической обработки

Определяет интервал, используемый для объединения нескольких записей в одно числовое значение. Например, если вы указали **5 минут**, записи будут сгруппированы по 5-минутным интервалам, используя указанный **тип агрегирования** .

В рабочих областях и Application Insights они поддерживаются только в типе мер **измерения метрики** . Результат запроса должен содержать [bin ()](/azure/kusto/query/binfunction) , которая задает интервал в результатах запроса. В других типах ресурсов поле, которое управляет этим параметром, называется **гранулярностью статистической обработки**.

> [!NOTE]
> Так как [bin ()](/azure/kusto/query/binfunction) может привести к нечетным интервалам времени, служба оповещений автоматически преобразует функцию [bin ()](/azure/kusto/query/binfunction) в функцию [bin_at ()](/azure/kusto/query/binatfunction) с соответствующим временем во время выполнения, чтобы гарантировать результат с фиксированной точкой.

### <a name="split-by-alert-dimensions"></a>Разбиение по измерениям предупреждений

Разбиение предупреждений по числу или строковым столбцам в отдельные предупреждения путем группирования в уникальные сочетания. При создании основанных на ресурсах оповещений в масштабе (области подписки или группы ресурсов) можно разделить по столбцу ИДЕНТИФИКАТОРов ресурсов Azure. При разделении в столбце ИДЕНТИФИКАТОРов ресурсов Azure целевой объект предупреждения изменится на указанный ресурс.

В рабочих областях и Application Insights они поддерживаются только в типе мер **измерения метрики** . Поле называется **Aggregate по**. Он ограничен тремя столбцами. Наличие более трех групп по столбцам в запросе может привести к непредвиденным результатам. Во всех остальных типах ресурсов он настраивается в разделе **разделение по измерениям** (ограничено шестью разбиениями).

#### <a name="example-of-splitting-by-alert-dimensions"></a>Пример разделения по измерениям предупреждений

Например, вы хотите отслеживать ошибки для нескольких виртуальных машин, на которых выполняется веб-сайт или приложение в определенной группе ресурсов. Это можно сделать с помощью правила оповещения журнала следующим образом:

- **Запрос:** 

    ```Kusto
    // Reported errors
    union Event, Syslog // Event table stores Windows event records, Syslog stores Linux records
    | where EventLevelName == "Error" // EventLevelName is used in the Event (Windows) records
    or SeverityLevel== "err" // SeverityLevel is used in Syslog (Linux) records
    ```

    При использовании рабочих областей и Application Insights с логикой оповещений **измерения метрики** эту строку необходимо добавить в текст запроса:

    ```Kusto
    | summarize AggregatedValue = count() by Computer, bin(TimeGenerated, 15m)
    ```

- **Столбец идентификаторов ресурсов:** _ResourceId (столбец "разделение по идентификатору ресурса" в правилах оповещений доступен только для подписок и групп ресурсов в настоящее время)
- **Измерения/агрегированные по:**
  - Computer = VM1, VM2 (Фильтрация значений в определении правил генерации оповещений сейчас недоступна для рабочих областей и Application Insights. Фильтрация в тексте запроса.)
- **Период времени:** 15 минут
- **Периодичность оповещений:** 15 минут
- **Пороговое значение:** больше 0.

Это правило отслеживает, имеются ли в виртуальной машине события ошибок за последние 15 минут. Каждая виртуальная машина отслеживается отдельно и активирует действия по отдельности.

> [!NOTE]
> Разбиение по измерениям предупреждений доступно только для текущего API Счедуледкуерирулес. Если используется устаревший [API-интерфейс предупреждений log Analytics](api-alerts.md), необходимо будет переключиться. Дополнительные [сведения о переключении](./alerts-log-api-switch.md). Оповещения, ориентированные на ресурсы в масштабе, поддерживаются только в версии API `2020-05-01-preview` и выше.

## <a name="alert-logic-definition"></a>Определение логики предупреждения

Определив запрос для выполнения и оценки результатов, необходимо определить логику предупреждений и время срабатывания действий. В следующих разделах описываются различные параметры, которые можно использовать.

### <a name="threshold-and-operator"></a>Пороговое значение и оператор

Результаты запроса преобразуются в число, которое сравнивается с пороговым значением и оператором.

### <a name="frequency"></a>Частота

Интервал, в течение которого выполняется запрос. Может принимать значение от 5 минут до одного дня. Должен быть равен или меньше [времени выполнения запроса](#query-time-range) , чтобы не пропускать записи журнала.

Например, если задать период времени 30 минут и частоту в 1 час.  Если запрос выполняется в 00:00, он возвращает записи между 23:30 и 00:00. При следующем выполнении запроса будет 01:00, возвращающий записи между 00:30 и 01:00. Любые записи, созданные между 00:00 и 00:30, никогда не будут оцениваться.

### <a name="number-of-violations-to-trigger-alert"></a>Число нарушений, вызывающих срабатывание предупреждения

Можно указать период оценки предупреждения и количество сбоев, необходимых для запуска оповещения. Позволяет лучше определить время, в течение которого будет запускаться оповещение. 

Например, если [**степень гранулярности статистической обработки**](#aggregation-granularity) правила определена как "5 минут", оповещение можно запустить только в случае трех сбоев (15 минут) последнего часа. Этот параметр определяется бизнес-политикой приложения.

## <a name="state-and-resolving-alerts"></a>Состояние и разрешение предупреждений

Оповещения журнала не имеют состояния. Оповещения срабатывают каждый раз при выполнении условия, даже если они были запущены ранее. Запущенные предупреждения не разрешаются. Предупреждение можно [Пометить как закрытое](alerts-managing-alert-states.md). Можно также отключить действия, чтобы предотвратить срабатывание триггеров в течение периода после запуска правила генерации оповещений.

В рабочих областях и Application Insights это называется **подавлять предупреждения**. Во всех остальных типах ресурсов это называется « **звуковые действия**». 

См. пример оценки предупреждений:

| время;    | Оценка условия журнала | Результат 
| ------- | ----------| ----------| ------- 
| 00:05 | FALSE | Предупреждение не срабатывает. Действия не вызваны.
| 00:10 | TRUE  | Оповещение срабатывает и группы действий с именем. АКТИВНО новое состояние оповещения.
| 00:15 | TRUE  | Оповещение срабатывает и группы действий с именем. АКТИВНО новое состояние оповещения.
| 00:20 | FALSE | Предупреждение не срабатывает. Действия не вызваны. Состояние оповещений предыдущей остается активным.

## <a name="pricing-and-billing-of-log-alerts"></a>Цены и выставление счетов за оповещения журнала

Сведения о ценах находятся на [странице цен на Azure Monitor](https://azure.microsoft.com/pricing/details/monitor/). Оповещения журнала перечислены в разделе Поставщик ресурсов `microsoft.insights/scheduledqueryrules` с помощью:

- Заносить в журнал оповещения на Application Insights, которые отображаются с точным именем ресурса, а также с указанием свойств группы ресурсов и предупреждения.
- Заносить в журнал оповещения на Log Analytics, которые отображаются с точным именем ресурса, а также с указанием свойств группы ресурсов и предупреждения; При создании с помощью [API счедуледкуерирулес](/rest/api/monitor/scheduledqueryrules).
- Оповещения журнала, созданные из [устаревших log Analytics API](./api-alerts.md) , не Отписывают [ресурсы Azure](../../azure-resource-manager/management/overview.md) и не имеют принудительно уникальных имен ресурсов. Эти предупреждения по-прежнему создаются `microsoft.insights/scheduledqueryrules` как скрытые ресурсы, которые имеют эту структуру именования ресурсов `<WorkspaceName>|<savedSearchId>|<scheduleId>|<ActionId>` . Оповещения журнала для API прежних версий отображаются с выше скрытым именем ресурса вместе с группой ресурсов и свойствами предупреждения.

> [!NOTE]
> Неподдерживаемые символы ресурсов, такие как `<, >, %, &, \, ?, /` , заменяются `_` на скрытые имена ресурсов, и это также отражается в сведениях о выставлении счетов.

> [!NOTE]
> Оповещения журнала для Log Analytics, которыми можно управлять с помощью [API предупреждений](api-alerts.md) устаревших log Analytics и устаревших шаблонов [log Analytics сохраненных поисков и предупреждений](../insights/solutions.md). Дополнительные [сведения о переключении на текущий API счедуледкуерирулес](alerts-log-api-switch.md). Любое Управление правилами генерации оповещений следует выполнять с помощью [устаревшего log Analytics API](api-alerts.md) , пока вы не решите переключиться и вы не сможете использовать скрытые ресурсы.

## <a name="next-steps"></a>Дальнейшие шаги

* Дополнительные сведения о [создании оповещений журнала в Azure](./alerts-log.md).
* Информация о [веб-перехватчиках в оповещениях журналов в Azure](alerts-log-webhook.md).
* Сведения об [оповещениях Azure](./alerts-overview.md).
* Дополнительные сведения о [log Analytics](../log-query/log-query-overview.md).

