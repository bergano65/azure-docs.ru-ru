---
title: Azure Monitor статистической схемой метрик и отображаемым описанием
description: Подробные сведения о статистической обработке метрик в Azure Monitor
author: rboucher
ms.author: robb
services: azure-monitor
ms.topic: conceptual
ms.date: 01/12/2020
ms.subservice: metrics
ms.openlocfilehash: 1d83ef07714e0ce69f01aa240cc3058195c7b1af
ms.sourcegitcommit: 25d1d5eb0329c14367621924e1da19af0a99acf1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/16/2021
ms.locfileid: "98251987"
---
# <a name="azure-monitor-metrics-metrics-aggregation-and-display-explained"></a>Azure Monitor статистической схемой метрик и отображаемым описанием

В этой статье объясняется агрегирование метрик в базе данных временных рядов Azure Monitor, в которой Azure Monitor [метрики платформы](data-platform.md) и [пользовательские метрики](metrics-custom-overview.md). Эта статья также относится к стандартным [метрикам Application Insights](../app/app-insights-overview.md). 

Это сложный раздел, который не требуется для понимания всех сведений, приведенных в этой статье, для эффективного использования метрик Azure Monitor.

## <a name="overview-and-terms"></a>Общие сведения и термины

При добавлении метрики в диаграмму обозреватель метрик автоматически выбирает агрегирование по умолчанию. Значение по умолчанию имеет смысл в основных сценариях, но можно использовать различные агрегаты для получения более подробных сведений о метрике. Для просмотра различных агрегатов на диаграмме необходимо понимать, как обозреватель метрик обрабатывает их.

Давайте сначала определим несколько терминов:

- **Значение метрики** — одно значение измерения, собранное для конкретного ресурса.
- **Период времени** — универсальный период времени.
- **Интервал времени** — период времени между сбором значений двух метрик. 
- **Диапазон времени** — период времени, отображаемый на диаграмме. Стандартное значение по умолчанию — 24 часа. Доступны только определенные диапазоны. 
- **Степень гранулярности** или промежуток **времени** — период времени, используемый для объединения значений вместе, чтобы разрешить отображение на диаграмме. Доступны только определенные диапазоны. Текущая минимальная — 1 минута. Значение гранулярности времени должно быть меньше выбранного диапазона времени, чтобы быть полезным, в противном случае для всей диаграммы отображается только одно значение. 
- **Тип статистической обработки** — тип статистики, вычисленной по нескольким значениям метрик.  
- **Aggregate** — процесс принятия нескольких входных значений и последующего их использования для получения одного выходного значения с помощью правил, определенных типом статистической обработки. Например, получение среднего значения для нескольких значений.  

Метрики представляют собой ряд значений метрик, захваченных с регулярным интервалом времени. При построении диаграммы значения выбранной метрики обрабатываются отдельно по мере гранулярности по времени (также известного как Гран времени). Размер детализации времени выбирается с помощью [панели выбора времени обозреватель метрик](metrics-getting-started.md#select-a-time-range). Если вы не сделаете явный выбор, то гранулярность времени будет автоматически выбрана на основе выбранного в данный момент диапазона времени. После выбора значения метрик, записанные во время каждого интервала гранулярности, суммируются и помещаются в диаграмму — по одной точке на каждый интервал.

## <a name="aggregation-types"></a>Типы агрегата 

В обозревателе метрик доступно пять базовых типов агрегирования. Обозреватель метрик скрывает ненужные агрегаты и не может использоваться для заданной метрики. 

- **Sum** — сумма всех значений, захваченных за интервал агрегирования. Иногда это называется общим агрегированием.
- **Count** — количество измерений, захваченных за интервал агрегирования. Функция Count не учитывает значение измерения, а только число записей. 
- **Среднее** — среднее значение метрики, захваченное за интервал агрегирования. Для большинства метрик это значение является суммой или количеством. 
- **Min** — наименьшее значение, захваченное за интервал агрегирования.
- **Max** — наибольшее значение, захваченное за интервал агрегирования.

Например, предположим, что на диаграмме показана общая метрика **сети** для виртуальной машины с помощью статистической **функции Sum** за последний 24-часовой интервал времени. Диапазон времени и степень гранулярности можно изменить в правом верхнем углу диаграммы, как показано на следующем снимке экрана.

:::image type="content" source="media/metrics-aggregation-explained/time-range-granularity-picker.png" alt-text="Снимок экрана: средство выбора степени детализации диапазона времени и времени" border="true":::

Для детализации по времени — 30 минут, а диапазон времени — 24 часа:

- Диаграмма отображается с 48 точек. Это составляет 24 часа x 2 точек на час (60min/30 мин), Объединенных 1 минуты. 
- График подключается к 48 точкам в области построения диаграммы. 
- Каждая точка данных представляет сумму всех исходящих сетевых байтов, отправленных в течение каждого из соответствующих 30-минутных периодов времени. 


 :::image type="content" source="media/metrics-aggregation-explained/24-hour-30-min-gran.png" alt-text="Снимок экрана, показывающий, что данные на графике заданы в 24-часовом диапазоне времени, с детализацией по 30-минутному времени" border="true" lightbox="media/metrics-aggregation-explained/24-hour-30-min-gran.png":::

*Щелкните изображения в этом разделе, чтобы просмотреть более крупные версии.*

Если изменить гранулярность времени на 15 минут, диаграмма будет выводиться с 96 агрегированных точек данных. То есть 60min/15 мин = 4 точки в час x 24 часа.

:::image type="content" source="media/metrics-aggregation-explained/24-hour-15-min-gran.png" alt-text="Снимок экрана, показывающий данные на графике, для которых задан 24-часовой диапазон времени и 15-минутная гранулярность времени" border="true" lightbox="media/metrics-aggregation-explained/24-hour-15-min-gran.png":::

Для детализации по времени (5 минут) вы получаете 24 x (60/5) = 288 точек. 

:::image type="content" source="media/metrics-aggregation-explained/24-hour-5-min-gran.png" alt-text="Снимок экрана, показывающий данные на графе линий, для которых задан 24-часовой диапазон времени и 5-минутная гранулярность времени" border="true" lightbox="media/metrics-aggregation-explained/24-hour-15-min-gran.png":::

Для детализации по времени, равной 1 минуте (наименьшей вероятности на диаграмме), вы получаете 24 x 60/1 = 1440 точек. 

:::image type="content" source="media/metrics-aggregation-explained/24-hour-1-min-gran.png" alt-text="Снимок экрана, показывающий данные на графе линий, для которых задан 24-часовой диапазон времени, и 1-минутная гранулярность времени" border="true" lightbox="media/metrics-aggregation-explained/24-hour-1-min-gran.png":::

Диаграммы выглядят по-разному для этих суммирований, как показано на предыдущих снимках экрана.  Обратите внимание, что в течение небольшого периода времени на виртуальную машину наблюдается большой объем выходных данных относительно оставшейся части временного окна.  

Гранулярность времени позволяет настроить соотношение "сигнал-шум" на диаграмме. Более высокие агрегаты изменяют шум и гладкие пики.  Обратите внимание на вариации на диаграмме с 1 минутами, а также их смягчение при переходе к более высоким значениям гранулярности. 

Такое сглаживание важно при отправке этих данных в другие системы, например оповещения. Обычно вы не хотите получать оповещения очень короткими пиковыми нагрузками в течение 90% времени ЦП. Но если ЦП остается в 90% в течение 5 минут, это, скорее всего, важно. Если вы настроили правило генерации оповещений на ЦП (или любую метрику), то увеличение детализации по времени может уменьшить количество полученных оповещений. 

Важно установить "нормальный" для рабочей нагрузки, чтобы определить, какой интервал времени лучше. Это одно из преимуществ [динамических предупреждений](alerts-dynamic-thresholds.md), которое не рассматривается в этом разделе.  

## <a name="how-the-system-collects-metrics"></a>Как система собирает метрики

Сбор данных зависит от метрики. Существует два типа периодов сбора.

### <a name="measurement-collection-frequency"></a>Частота сбора измерения 

- **Обычная** — метрика собирается в соответствии с постоянным временным интервалом, который не изменяется.

- **На основе действий** — метрика собирается в зависимости от того, когда происходит транзакция определенного типа. Каждая транзакция имеет запись метрики и отметку времени. Они не собираются через регулярные интервалы, поэтому количество записей в течение заданного периода времени сохранится. 

### <a name="granularity"></a>Степень детализации данных

Минимальный интервал времени равен 1 минуте, но базовая система может захватывать данные быстрее в зависимости от метрики. Например, процент загрузки ЦП будет записываться каждые 15 секунд с регулярным интервалом. Поскольку ошибки HTTP отправляются в виде транзакций, они могут легко превысить несколько минут. Другие метрики, такие как хранилище SQL, фиксируются каждые 20 минут. Этот вариант относится к отдельному поставщику ресурсов и типу. Большинство пытается предоставить минимальный интервал.

### <a name="dimensions-splitting-and-filtering"></a>Измерения, разделение и фильтрация

Метрики фиксируются для каждого отдельного ресурса. Однако уровень, при котором метрики собираются, хранятся и могут быть различными. Этот уровень представлен дополнительными метриками, доступными в **измерениях метрик**. Каждый поставщик отдельных ресурсов определяет, насколько детализированы данные, которые они собираются. Azure Monitor определяет, как должны быть представлены и сохранены данные. 

При диаграмме метрики в обозревателе метрик можно «разделить» диаграмму по измерению.  Разделение диаграммы означает, что вы ищете базовые данные для более подробной информации и видите, что данные диаграммы или фильтруются в обозревателе метрик.

Например, [Microsoft. ApiManagement/Service](metrics-supported.md#microsoftapimanagementservice) имеет *Расположение* в виде измерения для многих метрик. 

- **Емкость** — одна из таких метрик. Наличие измерения « *Расположение* » подразумевает, что базовая система хранит запись метрики для емкости каждого местоположения, а не только один для агрегатной суммы. Затем эти сведения можно получить или разделить на диаграмме метрик.  

- При просмотре **общей продолжительности запросов к шлюзу** существует 2 *расположения* и *имя узла*, а также сведения о расположении длительности и имени узла, с которого оно поступило.  

- Одна из более гибких метрик, **запросов**, имеет 7 различных измерений. 
 
Дополнительные сведения о каждой метрике и доступных измерениях см. в статье [Поддерживаемые метрики](metrics-supported.md) Azure Monitor. Кроме того, документация для каждого поставщика ресурсов и типа может предоставить дополнительные сведения об измерениях и их измерении.

Можно использовать разбиение и фильтрацию совместно, чтобы подробно изучить проблему. Ниже приведен пример графика с средним числом *записываемых байтов на диск* для группы виртуальных машин в группе ресурсов. У нас есть сводный показатель всех виртуальных машин с этой метрикой, но, возможно, мы хотим узнать, какие показатели на самом деле отвечают за пиковые нагрузки вокруг 06:00. Являются ли они одним и тем же компьютером? Сколько компьютеров задействовано?  

:::image type="content" source="media/metrics-aggregation-explained/total-disk write-bytes-all-VMs.png" alt-text="Снимок экрана: общее количество записей на диске для всех виртуальных машин в группе ресурсов гостиниц contoso" border="true" lightbox="media/metrics-aggregation-explained/total-disk write-bytes-all-VMs.png":::

*Щелкните изображения в этом разделе, чтобы просмотреть более крупные версии.*

При применении разделения можно увидеть базовые данные, но это немного несложно. На диаграмме выше будут собираются 20 виртуальных машин. В этом случае мы использовали нашу мышь для наведения большого пикового значения в 06:00, что говорит нам о том, что CH-DCVM11 является причиной. но все остальные данные, связанные с этой виртуальной машиной, трудно увидеть, так как другие виртуальные машины перекрывают диаграмму. 

:::image type="content" source="media/metrics-aggregation-explained/split-total-disk write-bytes-all-VMs.png" alt-text="Снимок экрана с записью на диск байтов для всех виртуальных машин в гостиницах группы ресурсов, разделенных по имени виртуальной машины" border="true" lightbox="media/metrics-aggregation-explained/split-total-disk write-bytes-all-VMs.png":::

С помощью фильтрации можно очистить диаграмму, чтобы увидеть, что происходит на самом деле. Вы можете установить или снять флажки для виртуальных машин, которые вы хотите просмотреть. Обратите внимание на пунктирные линии. Они упоминаются в следующем разделе.

:::image type="content" source="media/metrics-aggregation-explained/split-filter-total-disk write-bytes-all-VMs.png" alt-text="Снимок экрана: запись байт записи на диск для всех виртуальных машин в группе ресурсов гостиниц Contoso разделение и фильтрация по имени виртуальной машины" border="true" lightbox="media/metrics-aggregation-explained/split-filter-total-disk write-bytes-all-VMs.png":::

Дополнительные сведения о том, как отобразить данные разделенного измерения на диаграмме обозревателя метрик, см. в разделе [Дополнительные возможности обозревателя метрик — фильтры и разделение](metrics-charts.md#filters).

### <a name="null-and-zero-values"></a>NULL и нулевые значения

Если система принимает данные метрик из ресурса, но не получает их, то записывает значение NULL.  Значение NULL отличается от нулевого значения, что становится важным при вычислении агрегатов и диаграмм. Значения NULL не считаются допустимыми измерениями. 

Значения NULL на разных диаграммах отображаются по-разному. Точечные диаграммы пропускают точку на диаграмме. Линейчатые диаграммы пропускают отображение полосы. На графиках значения NULL могут отображаться в виде [пунктирных или пунктирных линий](metrics-troubleshoot.md#chart-shows-dashed-line) , таких как показанные на снимке экрана в предыдущем разделе. При вычислении средних значений, содержащих значения NULL, необходимо меньше точек данных, из которых следует брать среднее значение.  Иногда такое поведение может привести к непредвиденному сбросу значений на диаграмме, хотя обычно меньше, чем, если значение было преобразовано в ноль и используется как допустимая точка с данным.  

[Пользовательские метрики](metrics-custom-overview.md) всегда используют значения NULL, если данные не получены. При использовании [метрик платформы](data-platform.md)каждый поставщик ресурсов принимает решение, следует ли использовать НУЛИ или значения NULL в зависимости от того, что наиболее эффективно для данной метрики.

Azure Monitor предупреждения используют значения, которые поставщик ресурсов записывает в базу данных метрики, поэтому важно понять, как поставщик ресурсов обрабатывает значения NULL, просматривая данные первыми.

## <a name="how-aggregation-works"></a>Как работает Статистическая обработка

Диаграммы метрик в предыдущей системе отображают различные типы агрегированных данных. Система предварительно выполняет статистическую обработку данных, чтобы запрошенные диаграммы могли отображаться быстрее без большого числа повторных вычислений.  

В этом примере:

- Мы собираем **фиктивную** транзакционную метрику, именуемую **ошибками HTTP** 
- *Сервер* является измерением для метрики **ошибок HTTP** .
- У нас есть 3 сервера — сервер A, B и C.

Чтобы упростить объяснение, мы начнем с только типа статистической обработки SUM. 

### <a name="sub-minute-to-1-minute-aggregation"></a>Агрегирование за подминуты до 1-минутного объединения

Первые необработанные данные метрик собираются и сохраняются в базе данных метрик Azure Monitor. В этом случае каждый сервер имеет записи транзакций, хранящиеся с меткой времени, поскольку *сервер* является измерением. Учитывая, что минимальный период времени, который можно просмотреть как клиент, составляет 1 минуту, эти метки времени сначала объединяются в 1-минутные значения метрик для каждого отдельного сервера.  Процесс агрегирования для сервера B показан на рисунке ниже. Серверы A и C выполняются таким же образом и имеют разные данные.  

:::image type="content" source="media/metrics-aggregation-explained/sub-minute-transaction.png" alt-text="Снимок экрана, показывающий вложенные записи о транзакциях в 1-минутные агрегаты. " border="false":::

Полученные 1-минутные статистические значения хранятся в базе данных метрик в виде новых записей, чтобы их можно было собрать для последующего вычисления. 

:::image type="content" source="media/metrics-aggregation-explained/sub-minute-transaction-dimension-aggregated.png" alt-text="Снимок экрана, показывающий несколько 1-минутных статистических записей по измерению сервера. Серверы A, B и C отображаются по отдельности." border="false":::

### <a name="dimension-aggregation"></a>Агрегирование измерений

1-минутные вычисления затем сворачиваются по измерениям и снова сохраняются в виде отдельных записей.   В этом случае все данные всех отдельных серверов объединяются в метрику интервала в 1 минуту и сохраняются в базе данных метрик для использования в последующих агрегатах.

:::image type="content" source="media/metrics-aggregation-explained/1-minute-transaction-dimension-flattened-aggregated.png" alt-text="Снимок экрана, показывающий несколько 1-минутных Объединенных записей о сервере A, B и C, Объединенных в 1 минуту всех серверов целиком" border="false":::

Для ясности в следующей таблице показан метод агрегирования.

| Период   | Сервер А | сервера В. | сервер С | Sum (A + B + C)|
| -------- | -------- | -------- | -------- | --------   |  
| Минута 1 | 1        | 1        | 1        | 3          |
| Минута 2 | 0        | 5        | 1        | 6          |
| Минута 3 | 0        | 5        | 1        | 6          |
| Минута 4 | 2        | 3        | 4        | 9          |
| Минута 5 | 1        | 0        | 3        | 4          |
| Минута 6 | 1        | 0        | 4        | 5          |
| Минута 7 | 1        | 2        | 4        | 7          |
| Минута 8 | 0        | 1        | 0        | 1          |
| Минута 9 | 1        | 1        | 4        | 6          |
| Минута 10| 2        | 1        | 0        | 3          |

Выше показано только одно измерение, но этот же процесс агрегирования и хранения выполняется для **всех измерений** , поддерживаемых метрикой.

- Сбор значений в 1-минутный объединенный набор по этому измерению. Сохраните эти значения. 
- Свернуть измерение в суммарную сумму за 1 минуту. Сохраните эти значения. 

Рассмотрим еще одно измерение ошибок HTTP, именуемое сетевого адаптера. Предположим, у нас есть разное количество адаптеров на один сервер.

- Сервер A имеет один адаптер
- Сервер B содержит два адаптера
- Сервер C имеет 3 адаптера

Мы соберем данные для следующих транзакций отдельно. Они будут помечены:

- Время
- Значение
- Сервер, от которого поступила транзакция
- Адаптер, из которого получена транзакция

Затем каждый из этих поминутных потоков будет объединен в 1-минутное значение временных рядов и сохранено в базе данных метрики Azure Monitor:

- Сервер A, адаптер 1
- Сервер B, адаптер 1
- Сервер B, адаптер 2
- Сервер C, адаптер 1
- Сервер C, адаптер 2
- Сервер C, адаптер 3

Кроме того, будут сохранены следующие свернутые агрегаты:

- Сервер A, адаптер 1 (поскольку нет ничего для сворачивания, он будет сохранен повторно).
- Сервер B, адаптер 1 + 2
- Сервер C, адаптер 1 + 2 + 3
- ВСЕ серверы, все адаптеры

Это показывает, что метрики с большим количеством измерений имеют большее число агрегатов. Неважно знать все перестановки, просто понять причину. Система должна иметь как отдельные данные, так и Объединенные данные, сохраненные для быстрого получения доступа к любой диаграмме. Система выбирает либо наиболее подходящий сохраненный агрегат, либо базовые необработанные данные в зависимости от того, что вы выбрали для показа. 

### <a name="aggregation-with-no-dimensions"></a>Агрегирование без измерений

Так как эта метрика имеет *сервер* измерений, можно получить доступ к базовым данным для серверов a, B и C с помощью разбиения и фильтрации, как описано выше в этой статье. Если у метрики нет *сервера* в качестве измерения, вы как клиент можете получить доступ к агрегированным суммам в 1 минуту, показанных на диаграмме черным цветом. То есть значения 3, 6, 6, 9 и т. д. Система также не будет выполнять базовую работу по агрегированию значений разбиения, которые никогда не будут использовать их в обозревателе метрик, или отправить их через метрики REST API. 

## <a name="viewing-time-granularities-above-1-minute"></a>Просмотр детализаций времени выше 1 минуты

Если вы запрашиваете метрики с большей степенью детализации, система использует суммарные суммы, равные 1 минуте, чтобы вычислить суммы для большей детализации времени.  Ниже в пунктирных линиях показан метод суммирования для интервалов в 2 минуты и 5 минут. Опять же, для простоты отображается только тип статистической обработки SUM.

:::image type="content" source="media/metrics-aggregation-explained/1-minute-to-2-min-5-min.png" alt-text="Снимок экрана, показывающий несколько 1-минутных статистических записей по измерению сервера, объединенное в 2-min и 5-min периоды времени." border="false":::

В течение 2-минутного времени детализации.

| Период       | Сумм       
| -------------|-------------|  
| Минута 1 & 2 | (3 + 6) = 9 |
| Минута 3 & 4 | (6 + 9) = 15|
| Минута 4 & 5 | (4 + 5) = 9 |
| Минута 6 & 7 | (7 + 1) = 8 |
| Минута 8 & 9 | (6 + 3) = 9 |

Для 5-минутной гранулярности времени.

| Период              |            Сумм        |
|---------------------|------------------------|  
| От 1 до 5 минут  | 3 + 6 + 6 + 9 + 4 = 28 |
| Минуты с 6 по 10 | 5 + 7 + 1 + 6 + 3 = 22 |

Система использует хранимые статистические данные, обеспечивающие лучшую производительность. 

Ниже приведена более крупная диаграмма для процесса статистической обработки в 1 минуту, и некоторые из стрелок остались неудобочитаемыми.

:::image type="content" source="media/metrics-aggregation-explained/sum-aggregation-full.png" alt-text="Снимок экрана, показывающий консолидацию предыдущих 3 снимков экрана. Несколько 1-минутных статистических записей по измерению сервера, агрегированных за 1 минуты, 2 минуты и 5-минутные интервалы. Серверы A, B и C отображаются по отдельности." border="false":::

## <a name="more-complex-example"></a>Более сложный пример

Ниже приведен более крупный пример с использованием значений для вымышленной метрики, именуемой временем ответа HTTP в миллисекундах.  Здесь представлены дополнительные уровни сложности.

1. Мы отображаем агрегирование для Sum, Count, min и Max, а также вычисление среднего.
2. Мы видим значения NULL и как они влияют на вычисления. 

Рассмотрим следующий пример. В полях и на стрелках показаны примеры статистической обработки и вычисления значений. 

Один и тот же процесс предварительной обработки в 1 минуты, описанный в предыдущем разделе, применяется для сумм, количества, минимума и максимума.  Однако среднее значение не является предварительно агрегированным. Он пересчитывается с использованием статистических данных, чтобы избежать ошибок вычислений.
 
:::image type="content" source="media/metrics-aggregation-explained/full-aggregation-example-all-types.png" alt-text="Снимок экрана с сложным примером агрегирования и вычисления суммы, количества, минимума, максимального и среднего значения от 1 минуты до 10 минут." border="false" lightbox="media/metrics-aggregation-explained/full-aggregation-example-all-types.png":::

Рассмотрим минуту 6 для агрегирования за 1 минуту, как показано выше. Эта минута является точкой, когда сервер B перешел в автономный режим и остановил данные отчетов, возможно, из-за перезагрузки. 

С минуты 6 вычисленные 1-минутные типы агрегирования: 

| Тип агрегирования | Значение        | Примечания |
|------------------|--------------|-------|
| SUM              | 53 + 20 = 73 | |
| Счетчик            | 2            | Показывает результат действия значений NULL.  Значение было равно 3, если сервер был подключен к сети.  |
| Минимальное          | 20           | |
| Максимальная          | 53           | |
| Среднее значение          | 73/2       | Сумма всегда делится на число. Он никогда не хранится и всегда пересчитывается для каждой гранулярности по времени, используя агрегированные числа для этой гранулярности. Обратите внимание на повторное вычисление за 5-минутную и 10-минутную детализацию, выделенную выше. |

Красный цвет текста указывает значения, которые могут считаться за пределами нормального диапазона, и показывает, как они передаются (или завершаются сбоем) во время детализации. Обратите внимание, что значения *min* и *Max* указывают на наличие базовых аномалий, в то время как *средние* и *итоги* теряют эти сведения во время детализации.  

Можно также увидеть, что значения NULL обеспечивают лучшее вычисление среднего, чем, если вместо этого использовались нули.  

> [!NOTE] 
> Хотя в этом примере это не так, *Счетчик Count* равен *сумме* в случаях, когда метрика всегда фиксируется со значением 1. Это часто происходит, когда метрика отслеживает возникновение транзакционного события, например количество ошибок HTTP, упомянутых в предыдущем примере в этой статье.

## <a name="next-steps"></a>Дальнейшие действия

- [Приступая к работе с обозревателем метрик](metrics-getting-started.md)
- [Расширенный обозреватель метрик](metrics-charts.md)
