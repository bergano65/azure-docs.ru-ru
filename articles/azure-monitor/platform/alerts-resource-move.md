---
title: Как обновить правила генерации оповещений или правила действий при перемещении их целевого ресурса в другой регион Azure
description: Основные сведения и инструкции по обновлению правил генерации оповещений или правил действий при перемещении их целевого ресурса в другой регион Azure.
author: harelbr
ms.author: harelbr
ms.topic: how-to
ms.custom: subject-moving-resources
ms.date: 06/26/2020
ms.subservice: alerts
ms.openlocfilehash: 4ea5c8552d35db67a1d2caf20c0143c74cdd642e
ms.sourcegitcommit: 3543d3b4f6c6f496d22ea5f97d8cd2700ac9a481
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/20/2020
ms.locfileid: "86505488"
---
# <a name="how-to-update-alert-rules-or-action-rules-when-their-target-resource-moves-to-a-different-azure-region"></a>Как обновить правила генерации оповещений или правила действий при перемещении их целевого ресурса в другой регион Azure

В этой статье описывается, почему при перемещении других ресурсов Azure между регионами могут быть затронуты существующие [Правила оповещений](./alerts-overview.md) и [правила действий](./alerts-action-rules.md) , а также способы определения и устранения этих проблем. Дополнительные сведения о перемещении ресурсов между регионами и контрольном списке разработки процесса перемещения см. в [документации по перемещению основного ресурса](../../azure-resource-manager/management/move-region.md) .

## <a name="why-the-problem-exists"></a>Почему существует проблема

Правила оповещений и правила действий ссылаются на другие ресурсы Azure. К примерам относятся [виртуальные машины Azure](../../site-recovery/azure-to-azure-tutorial-migrate.md), [Azure SQL](../../azure-sql/database/move-resources-across-regions.md)и служба [хранилища Azure](../../storage/common/storage-account-move.md). При перемещении ресурсов, на которые ссылаются эти правила, правила, скорее всего, перестанут работать правильно, так как они не могут найти ресурсы, на которые они ссылаются.

Существуют две основные причины, по которым правила могут перестать работать после перемещения целевых ресурсов.

- Область действия правила явно ссылается на старый ресурс.
- Правило оповещений основано на метриках.

## <a name="rule-scope-explicitly-refers-to-the-old-resource"></a>Область действия правила явно ссылается на старый ресурс.

При перемещении ресурса в большинстве случаев изменяется его идентификатор ресурса. В фоновом режиме система реплицирует ресурс в новый регион, прежде чем удалять его из старого региона. Этот процесс требует одновременного существования двух ресурсов и двух различных идентификаторов ресурсов в течение небольшого периода времени. Так как идентификаторы ресурсов должны быть уникальными, во время процесса должен быть создан новый идентификатор. 

**Как перемещение ресурса влияет на существующие правила?**

Правила оповещений и правила действий имеют область действия ресурсов, к которым они применяются. Областью может быть вся подписка, Группа ресурсов или один или несколько конкретных ресурсов.
Например, вот правило с областью действия с двумя ресурсами (две виртуальные машины):

![Правило генерации оповещений с несколькими ресурсами](media/alerts-resource-move/multi-resource-alert-rule.png)

Если область правила явно упоминает ресурс, а этот ресурс переместил и изменил свой идентификатор ресурса, то это правило будет искать неверный или несуществующий ресурс, что приведет к сбою.

**Как устранить проблему?**

Обновите или повторно создайте затронутое правило, чтобы оно указывало на новый ресурс. Процесс обновления области находится далее в этой статье.

Проблема применима к следующим типам правил:

- Правила генерации оповещений журнала действий
- Правила действий
- Классические оповещения
- Оповещения метрики. Дополнительные сведения см. в следующих разделах: [Правила оповещений, основанные на метриках](#alert-rules-based-on-metrics).

> [!NOTE]
> Правила оповещений поиска по журналам и правила оповещений Smart детектор не затрагиваются, так как их область действия — Рабочая область или Application Insights. Ни одна из этих областей не поддерживает перемещение по регионам.

## <a name="alert-rules-based-on-metrics"></a>Правила генерации оповещений на основе метрик

Метрики выпуска ресурсов Azure являются региональными. Каждый раз, когда ресурс перемещается в новый регион, он начинает выдавать свои метрики в новом регионе. В результате все правила генерации оповещений, основанные на метриках, необходимо обновить или создать заново, чтобы они указывали на текущий поток метрик в правильном регионе.

Это описание относится к правилам генерации оповещений [метрик](alerts-metric-overview.md) и [тестам доступности](../app/monitor-web-app-availability.md).

Если **все** ресурсы в области перемещены, вам не нужно повторно создавать правило. Можно просто обновить любое поле правила генерации оповещений, например описание правила генерации оповещений, и сохранить его.
Если были перемещены **только некоторые** ресурсы в области, необходимо удалить перемещенные ресурсы из существующего правила и создать новое правило, охватывающее только перемещенные ресурсы.

## <a name="procedures-to-fix-problems"></a>Процедуры для устранения проблем

### <a name="identifying-rules-associated-with-a-moved-resource-from-the-azure-portal"></a>Определение правил, связанных с перемещенным ресурсом из портал Azure

- **Для правил генерации оповещений** перейдите в раздел оповещения > Управление правилами генерации оповещений > фильтровать по содержащей подписку и перемещенному ресурсу.
> [!NOTE]
> Правила генерации оповещений журнала действий не поддерживают этот процесс. Невозможно обновить область действия правила оповещения журнала действий и указать ресурс в другой подписке. Вместо этого можно создать новое правило, которое заменит старое.

- **Для правил действий** — перейдите к оповещениям > Управление действиями > правила действий (Предварительная версия) > отфильтровать по содержащей подписке и перемещенному ресурсу.

### <a name="change-scope-of-a-rule-from-the-azure-portal"></a>Изменение области действия правила из портал Azure

1. Откройте правило, определенное на предыдущем шаге, щелкнув его.
2. В разделе **ресурс**щелкните **изменить** и при необходимости измените область.
3. При необходимости настройте другие свойства правила.
4. Выберите команду **Сохранить**.

![Изменить область действия правила оповещения](media/alerts-resource-move/change-alert-rule-scope.png)

### <a name="change-the-scope-of-a-rule-using-azure-resource-manager-templates"></a>Изменение области действия правила с помощью шаблонов Azure Resource Manager

1. Получите шаблон Azure Resource Manager правила.  Чтобы экспортировать шаблон правила из портал Azure:
   1. Перейдите к разделу "группы ресурсов" на портале и откройте группу ресурсов, содержащую правило.
   2. В разделе Обзор установите флажок **Показывать скрытый тип** и отфильтруйте соответствующий тип правила.
   3. Выберите соответствующее правило, чтобы просмотреть сведения о нем.
   4. В разделе **Параметры**выберите **Экспорт шаблона**.
2. Измените шаблон. При необходимости разделите их на два правила (относящиеся к некоторым случаям оповещений метрик, как указано выше).
3. Повторно разверните шаблон.

### <a name="change-scope-of-a-rule-using-rest-api"></a>Изменение области действия правила с помощью REST API

1. Получить существующее правило ([оповещения метрик](/rest/api/monitor/metricalerts/get), [оповещения журнала действий](/rest/api/monitor/activitylogalerts/get))
2. Изменение области ([оповещения журнала действий](/rest/api/monitor/activitylogalerts/update))
3. Повторное развертывание правила ([оповещения метрик](/rest/api/monitor/metricalerts/createorupdate), [оповещения журнала действий](/rest/api/monitor/activitylogalerts/createorupdate))

### <a name="change-scope-of-a-rule-using-powershell"></a>Изменение области действия правила с помощью PowerShell

1. Получите существующее правило ([оповещения метрик](/powershell/module/az.monitor/get-azmetricalertrulev2), [оповещения журнала действий](/powershell/module/az.monitor/get-azactivitylogalert), [правила действий](/powershell/module/az.alertsmanagement/get-azactionrule)).
2. Измените область. При необходимости разделите их на два правила (относящиеся к некоторым случаям оповещений метрик, как указано выше).
3. Повторное развертывание правила ([оповещения метрик](/powershell/module/az.monitor/add-azmetricalertrulev2), [оповещения журнала действий](/powershell/module/az.monitor/enable-azactivitylogalert), [правила действий](/powershell/module/az.alertsmanagement/set-azactionrule)).

### <a name="change-the-scope-of-a-rule-using-azure-cli"></a>Изменение области действия правила с помощью Azure CLI

1.  Получение существующего правила ([оповещения метрик](/cli/azure/monitor/metrics/alert?view=azure-cli-latest#az-monitor-metrics-alert-show), [оповещения журнала действий](/cli/azure/monitor/activity-log/alert#az-monitor-activity-log-alert-list)).
2.  Непосредственное обновление области действия правила ([оповещения метрик](/cli/azure/monitor/metrics/alert#az-monitor-metrics-alert-update), [оповещения журнала действий](/cli/azure/monitor/activity-log/alert/scope))
3.  При необходимости разделите их на два правила (относящиеся к некоторым случаям оповещений метрик, как указано выше).

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как устранять другие проблемы с [уведомлениями об оповещениях](alerts-troubleshoot.md), [оповещениями метрик](alerts-troubleshoot-metric.md)и [оповещениями журналов](alerts-troubleshoot-log.md). 
