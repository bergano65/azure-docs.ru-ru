---
title: Подключение Operations Manager к Azure Monitor | Документация Майкрософт
description: Чтобы не увеличивать затраты на System Center Operations Manager и использовать расширенные возможности в Log Analytics, Operations Manager можно интегрировать с рабочей областью.
services: log-analytics
documentationcenter: ''
author: mgoedtel
manager: carmonm
editor: ''
ms.assetid: 245ef71e-15a2-4be8-81a1-60101ee2f6e6
ms.service: log-analytics
ms.workload: na
ms.tgt_pltfrm: na
ms.topic: conceptual
ms.date: 08/13/2019
ms.author: magoedte
ms.openlocfilehash: a559fe86850ee9c1378876bc5ed8f2d0ddfb2d99
ms.sourcegitcommit: 0c906f8624ff1434eb3d3a8c5e9e358fcbc1d13b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/16/2019
ms.locfileid: "69543047"
---
# <a name="connect-operations-manager-to-azure-monitor"></a>Подключение Operations Manager к Azure Monitor

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../../includes/azure-monitor-log-analytics-rebrand.md)]

Чтобы сохранить существующие инвестиции в [System Center Operations Manager](https://docs.microsoft.com/system-center/scom/key-concepts?view=sc-om-1807) и использовать расширенные возможности с Azure Monitor, можно интегрировать Operations Manager с рабочей областью log Analytics. Это позволяет использовать возможности журналов в Azure Monitor при продолжении использования Operations Manager:

* мониторинг работоспособности ИТ-служб с помощью Operations Manager;
* управление интеграцией с решениями ITSM, поддерживающими управление различными инцидентами и неполадками;
* управление жизненным циклом агентов, развернутых на виртуальных машинах IaaS в локальных и общедоступных облаках, мониторинг работоспособности в которых выполняется с помощью Operations Manager.

Интеграция с System Center Operations Manager добавляет значение в стратегию операций службы с использованием скорости и эффективности Azure Monitor при сборе, хранении и анализе данных журнала из Operations Manager. Azure Monitor запросы журналов помогают сопоставляться и работать в целях выявления проблем с проблемами и отображая повторов для поддержки существующего процесса управления проблемами. Гибкость механизма обработки запросов для изучения данных о производительности, событиях и предупреждениях с широкими возможностями панелей мониторинга и отчетов для предоставления этих данных осмысленными способами демонстрирует надежность Azure Monitor приOperations Manager.

Агенты, отправляющие отчеты в группу управления Operations Manager, собираются данные с серверов на основе [log Analytics источников данных](agent-data-sources.md) и решений, включенных в рабочей области. В зависимости от того, какие решения включены, их данные отправляются непосредственно с сервера управления Operations Manager в службу, либо из-за объема данных, собираемых в управляемой агентом системе, отправляются непосредственно из агента в Log Analytics рабочую область. Сервер управления перенаправляет данные непосредственно в службу. Они никогда не записываются в рабочую базу данных или хранилище данных. Когда сервер управления теряет подключение к Azure Monitor, он кэширует данные локально до тех пор, пока не будет восстановлена связь. Если сервер управления находится в автономном режиме из-за запланированного обслуживания или незапланированного сбоя, другой сервер управления в группе управления возобновляет подключение к Azure Monitor.  

На следующей схеме показано подключение между серверами управления и агентами в группе управления System Center Operations Manager и Azure Monitor, включая направление и порты.   

![oms-operations-manager-integration-diagram](./media/om-agents/oms-operations-manager-connection.png)

Если политики ИТ-безопасности запрещают подключение компьютеров в сети к Интернету, серверы управления можно настроить для подключения к шлюзу Log Analytics, чтобы получать сведения о конфигурации и отправлять собранные данные в зависимости от включенного решения. Дополнительные сведения и инструкции по настройке группы управления Operations Manager для связи через шлюз Log Analytics для Azure Monitor см. в разделе [Подключение компьютеров к Azure Monitor с помощью шлюза log Analytics](../../azure-monitor/platform/gateway.md).  

## <a name="prerequisites"></a>Предварительные требования

Прежде чем начать, ознакомьтесь со следующими требованиями.

* Azure Monitor поддерживает только System Center Operations Manager 2016 или более поздней версии, Operations Manager 2012 SP1 UR6 или более поздней версии и Operations Manager 2012 R2 UR2 или более поздней версии. Поддержка прокси-сервера была добавлена в Operations Manager 2012 с пакетом обновления 1 (SP1) и накопительным пакетом обновления 7 (UR7) и в Operations Manager 2012 R2 с накопительным пакетом обновления 3 (UR3).
* Для интеграции System Center Operations Manager 2016 с Cloud правительства США требуется обновленный пакет управления Advisor, входящий в состав накопительного пакета обновления 2 или более поздней версии. Для System Center Operations Manager 2012 R2 требуется обновленный пакет управления Advisor, входящий в состав накопительного пакета обновления 3 или более поздней версии.
* Все агенты Operations Manager должны удовлетворять минимальным требованиям поддержки. Убедитесь, что агенты соответствуют минимальным требованиям, иначе взаимодействие с агентом Windows может завершиться сбоем и привести к созданию ошибок в журнале событий Operations Manager.
* Рабочая область Log Analytics. Дополнительные сведения см. в статье [Управление рабочими областями](../../azure-monitor/platform/manage-access.md?toc=/azure/azure-monitor/toc.json).   
* Вы прошли проверку подлинности в Azure с учетной записью, которая является членом [роли участника Log Analytics](../../azure-monitor/platform/manage-access.md#manage-accounts-and-users).

* Поддерживаемые регионы. System Center Operations Manager для подключения к рабочей области Log Analytics поддерживаются только следующие регионы Azure:
    - Центрально-западная часть США
    - Юго-Восточная Австралия
    - Западная Европа
    - East US
    - Юго-Восточная Азия
    - Восточная Япония
    - Южная часть Соединенного Королевства
    - Центральная Индия
    - Центральная Канада
    - Западная часть США 2

>[!NOTE]
>Последние изменения в интерфейсах API Azure не позволят клиентам успешно настраивать интеграцию между группой управления и Azure Monitor в первый раз. Если вы уже интегрировали свою группу управления со службой, на вас это не воздействует, пока вам не потребуется перенастроить существующее подключение.  
>Новый пакет управления был выпущен для следующих версий Operations Manager:
> - Для System Center Operations Manager 2019 пакет управления предоставляется вместе со сборкой Operations Manager.
>- Пакет управления Operations Manager 1801 также применим для Operations Manager 1807.
>- Для System Center Operations Manager 1801 Загрузите пакет управления [отсюда](https://www.microsoft.com/download/details.aspx?id=57173).
>- Для System Center 2016-Operations Manager Скачайте пакет управления [отсюда](https://www.microsoft.com/download/details.aspx?id=57172).  
>- Для System Center Operations Manager 2012 R2 Загрузите пакет управления [отсюда](https://www.microsoft.com/download/details.aspx?id=57171).  


### <a name="network"></a>Network

Ниже перечислены сведения о конфигурации прокси-сервера и брандмауэра, необходимые для взаимодействия агента Operations Manager, серверов управления и консоли Operations с Azure Monitor. Трафик от каждого компонента исходит из сети в Azure Monitor.   

|Resource | Номер порта| Обход проверки HTTP|  
|---------|------|-----------------------|  
|**Агент**|||  
|\*.ods.opinsights.azure.com| 443 |Да|  
|\*.oms.opinsights.azure.com| 443|Да|  
|\*.blob.core.windows.net| 443|Да|  
|\*.azure-automation.net| 443|Да|  
|**Сервер управления**|||  
|\*.service.opinsights.azure.com| 443||  
|\*.blob.core.windows.net| 443| Да|  
|\*.ods.opinsights.azure.com| 443| Да|  
|*.azure-automation.net | 443| Да|  
|**Operations Manager консоль для Azure Monitor**|||  
|service.systemcenteradvisor.com| 443||  
|\*.service.opinsights.azure.com| 443||  
|\*.live.com| 80 и 443||  
|\*microsoft.com| 80 и 443||  
|\*.microsoftonline.com| 80 и 443||  
|\*.mms.microsoft.com| 80 и 443||  
|login.windows.net| 80 и 443||  
|portal.loganalytics.io| 80 и 443||
|api.loganalytics.io| 80 и 443||
|docs.loganalytics.io| 80 и 443||  

### <a name="tls-12-protocol"></a>Протокол TLS 1.2

Чтобы обеспечить безопасность передаваемых данных в Azure Monitor, мы настоятельно рекомендуем настроить агент и группу управления для использования по крайней мере протокола TLS 1,2. Более старые версии протоколов TLS/SSL оказались уязвимы. Хотя они все еще используются для обеспечения обратной совместимости, применять их **не рекомендуется**. См. дополнительные сведения о [безопасной отправке данных с помощью TLS 1.2](../../azure-monitor/platform/data-security.md#sending-data-securely-using-tls-12).

## <a name="connecting-operations-manager-to-azure-monitor"></a>Подключение Operations Manager к Azure Monitor

Выполните следующие действия, чтобы настроить группу управления Operations Manager для подключения к одной из рабочих областей Log Analytics.

Во время первой регистрации группы управления Operations Manager в рабочей области Log Analytics параметр для указания конфигурации прокси-сервера для группы управления недоступен в консоли управления.  Этот параметр станет доступным после успешной регистрации группы управления в службе.  Для обхода этой проблемы вам необходимо обновить конфигурацию прокси-сервера системы с помощью Netsh в системе, в которой выполняется консоль управления, чтобы настроить интеграцию, и обновить все серверы управления в группе управления.  

1. Откройте командную строку с повышенными привилегиями.
   1\. Перейдите в **Пуск** и введите **cmd**.
   2\. Щелкните правой кнопкой мыши **командную строку**, а затем выберите "Запустить от имени администратора".
1. Введите следующую команду и нажмите клавишу **ВВОД**:

    `netsh winhttp set proxy <proxy>:<port>`

После выполнения следующих действий по интеграции с Azure Monitor можно удалить конфигурацию, выполнив `netsh winhttp reset proxy` команду, а затем воспользоваться параметром **Настройка прокси-сервера** в консоли управления, чтобы указать прокси-сервер или log Analytics сервера шлюза. .

1. В консоли Operations Manager щелкните рабочую область **Администрирование** .
1. Разверните узел Operations Management Suite и щелкните **Подключение**.
1. Щелкните ссылку **Register to Operations Management Suite** (Зарегистрироваться в Operations Management Suite).
1. На странице **Мастер подключения Operations Management Suite: проверка подлинности** введите адрес электронной почты или номер телефона и пароль учетной записи администратора, связанной с вашей подпиской OMS, и щелкните **Войти**.

   >[!NOTE]
   >Имя набора Operations Management Suite было снято с учета.

1. После успешной аутентификации на странице **Мастер подключения Operations Management Suite: выбор рабочей области** вам предлагается выбрать клиент Azure, подписку и рабочую область Log Analytics. При наличии нескольких рабочих областей выберите в раскрывающемся списке рабочую область, которую необходимо зарегистрировать в группе управления Operations Manager, и нажмите кнопку **Далее**.

   > [!NOTE]
   > Одновременно в Operations Manager поддерживается только одна рабочая область Log Analytics. Подключение и компьютеры, зарегистрированные в Azure Monitor с предыдущей рабочей областью, удаляются из Azure Monitor.
   >
   >
1. На странице **Мастер подключения Operations Management Suite: сводка** проверьте параметры и, если они верны, щелкните **Создать**.
1. На странице **Мастер подключения Operations Management Suite: окончание** щелкните **Закрыть**.

### <a name="add-agent-managed-computers"></a>Добавление управляемых агентом компьютеров

Настройка интеграции с рабочей областью Log Analytics позволяет только установить подключение к службе. При этом сбор данных из агентов, которые создают отчеты для группы управления, выполняться не будет. Это не происходит до тех пор, пока не будет настроено, какие конкретные компьютеры, управляемые агентом, собираются данные журнала для Azure Monitor. Можно выбрать компьютеры по отдельности или выбрать группу, в которой содержатся компьютеры Windows. Нельзя выбрать группу, в которой содержатся экземпляры другого класса, например логические диски или базы данных SQL.

1. Откройте консоль Operations Manager и выберите рабочую область **Администрирование** .
1. Разверните узел Operations Management Suite и щелкните **Подключение**.
1. В разделе "Действия" с правой стороны панели щелкните ссылку **Добавить компьютер/группу** .
1. В диалоговом окне **Поиск компьютера** можно выполнить поиск компьютеров или групп, отслеживаемых с помощью Operations Manager. Выберите компьютеры или группы, включая Operations Manager сервер управления для подключения к Azure Monitor, нажмите кнопку **Добавить**, а затем нажмите кнопку **ОК**.

Компьютеры и группы, настроенные для сбора данных с узла управляемых компьютеров, можно просмотреть в разделе Operations Management Suite в рабочей области **Администрирование** консоли управления. Здесь также можно при необходимости добавлять или удалять компьютеры и группы.

### <a name="configure-proxy-settings-in-the-operations-console"></a>Настройка параметров прокси-сервера в консоли управления

Если внутренний прокси-сервер находится между группой управления и Azure Monitor, выполните следующие действия. Эти параметры централизованно управляются из группы управления и распределяются между управляемыми агентами системами, которые включены в область для получения данных журнала для Azure Monitor.  Это дает преимущества, если определенные решения обходят сервер управления и отправляют данные непосредственно в службу.

1. Откройте консоль Operations Manager и выберите рабочую область **Администрирование** .
1. Разверните узел Operations Management Suite и щелкните **Подключения**.
1. В представлении "Подключение к OMS" щелкните **Настройка прокси-сервера**.
1. На странице **Мастер Operations Management Suite: прокси-сервер** выберите **Использовать прокси-сервер для доступа к набору Operations Management Suite**, а затем введите URL-адрес с номером порта (например, http://corpproxy:80 ) и щелкните **Готово**.

Если для прокси-сервера требуется проверка подлинности, выполните следующие действия, чтобы настроить учетные данные и параметры, которые необходимо распространить на управляемые компьютеры, которые сообщают Azure Monitor в группе управления.

1. Откройте консоль Operations Manager и выберите рабочую область **Администрирование** .
1. В разделе **Конфигурация запуска от имени** выберите **Профили**.
1. Откройте профиль **Запуск от имени прокси-сервера профиля System Center Advisor** .
1. В мастере профилей запуска от имени нажмите кнопку "Добавить", чтобы использовать учетную запись запуска от имени. Можно создать [учетную запись запуска от имени](https://technet.microsoft.com/library/hh321655.aspx) или использовать существующую. Эта учетная запись должна иметь достаточные разрешения для передачи данных через прокси-сервер.
1. Чтобы настроить учетную запись для управления, выберите **Выбранный класс, группа или объект**, нажмите кнопку **Выбрать…** , а затем нажмите кнопку **Группа…** , чтобы открыть поле **Поиск групп**.
1. Найдите и выберите **группу серверов мониторинга Microsoft System Center Advisor**. Выбрав группы, нажмите кнопку **ОК**, чтобы закрыть поле **Поиск групп**.
1. Нажмите кнопку **ОК**, чтобы закрыть окно **Добавление учетной записи запуска от имени**.
1. Нажмите кнопку **Сохранить** , чтобы закрыть мастер и сохранить изменения.

После создания подключения и настройки того, какие агенты будут получать данные журнала и сообщать о Azure Monitor, в группе управления будет применена следующая конфигурация, не обязательно в порядке:

* Будет создана учетная запись запуска от имени **Microsoft.SystemCenter.Advisor.RunAsAccount.Certificate** . Она связана с профилем запуска от имени **Microsoft System Center Advisor Run As Profile Blob** (Запуск от имени большого двоичного объекта профиля Microsoft System Center Advisor) и предназначена для двух классов: **сервера сбора** и **группы управления Operations Manager**.
* Будут созданы два соединителя.  Первый называется **Microsoft. SystemCenter. Advisor. Connect** и автоматически настраивается с подпиской, которая пересылает все предупреждения, созданные из экземпляров всех классов в группе управления, в Azure Monitor. Второй соединитель — **соединитель Advisor**, который отвечает за взаимодействие с Azure Monitor и обмен данными.
* Агенты и группы, выбранные для сбора данных в группе управления, добавляются в **группу серверов мониторинга Microsoft System Center Advisor**.

## <a name="management-pack-updates"></a>Обновления пакета управления

После завершения настройки группа управления Operations Manager устанавливает соединение с Azure Monitor. Сервер управления синхронизируется с веб-службой и получает обновленные сведения о конфигурации в виде пакетов управления для решений, которые вы включили для интеграции с Operations Manager. Operations Manager проверяет наличие обновлений для этих пакетов управления, автоматически скачивает и импортирует их. Существует два правила для управления этими действиями:

* **Microsoft. SystemCenter. Advisor. MPUpdate** — обновляет базовые пакеты управления Azure Monitor. По умолчанию выполняется каждые 12 часов.
* **Microsoft.SystemCenter.Advisor.Core.GetIntelligencePacksRule** : обновляет пакеты управления решения, включенные в рабочую область. По умолчанию выполняется каждые 5 (пять) минут.

Эти два правила можно переопределить, чтобы запретить автоматическую загрузку, отключив их, или изменить частоту синхронизации сервера управления с Azure Monitor, чтобы определить, доступен ли новый пакет управления и следует ли его загрузить. Чтобы изменить значение в секундах параметра **Частота** для изменения расписания синхронизации или изменить параметр **Включено** для отключения правил, выполните действия, описанные в статье [Переопределение правила или монитора состояния](https://technet.microsoft.com/library/hh212869.aspx). Примените переопределенные значения для всех объектов класса группы управления Operations Manager.

Если изменять существующий процесс управления изменениями для контроля выпусков пакетов управления в рабочей группе управления не требуется, отключите правила и включайте их только тогда, когда требуются обновления. При наличии в среде группы управления разработкой и контролем качества и подключения к Интернету, для поддержки этого сценария эту группу управления можно настроить с рабочей областью Log Analytics. Это позволяет просматривать и оценивать итеративные выпуски пакетов управления Azure Monitor до их выпуска в рабочую группу управления.

## <a name="switch-an-operations-manager-group-to-a-new-log-analytics-workspace"></a>Перевод группы Operations Manager в новую рабочую область Log Analytics

1. Войдите на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com).
1. На портале Azure щелкните **Другие службы** в нижнем левом углу. В списке ресурсов введите **Log Analytics**. Как только вы начнете вводить символы, список отфильтруется соответствующим образом. Выберите **Log Analytics**, а затем создайте рабочую область.  
1. Откройте консоль Operations Manager под учетной записью пользователя, который является членом роли администраторов Operations Manager, и выберите **администрирование** рабочей области.
1. Разверните Log Analytics и выберите **Подключения**.
1. Щелкните ссылку **Повторная настройка Operation Management Suite** в середине панели.
1. Выполните инструкции **мастера переноса Log Analytics** и введите адрес электронной почты или номер телефона и пароль учетной записи администратора, связанной с новой рабочей областью Log Analytics.

   > [!NOTE]
   > На странице **Мастер подключения Operations Management Suite: выбор рабочей области** представлена имеющаяся используемая рабочая область.
   >
   >

## <a name="validate-operations-manager-integration-with-azure-monitor"></a>Проверка интеграции Operations Manager с Azure Monitor

Существует несколько разных способов проверки успешности интеграции Azure Monitor Operations Manager.

### <a name="to-confirm-integration-from-the-azure-portal"></a>Подтверждение интеграции на портале Azure

1. На портале Azure щелкните **Другие службы** в нижнем левом углу. В списке ресурсов введите **Log Analytics**. Как только вы начнете вводить символы, список отфильтруется соответствующим образом.
1. В списке рабочих областей Log Analytics выберите необходимую рабочую область.  
1. Выберите **Дополнительные параметры**, **Подключенные источники**, а затем — **System Center**.
1. В разделе System Center Operations Manager вы увидите название группы управления с указанием числа агентов и состояния, а также сведениями о последнем получении данных.

   ![oms-settings-connectedsources](./media/om-agents/oms-settings-connectedsources.png)

### <a name="to-confirm-integration-from-the-operations-console"></a>Подтверждение интеграции в консоли управления

1. Откройте консоль Operations Manager и выберите рабочую область **Администрирование** .
1. Выберите **Пакеты управления** и в текстовом поле **Поиск** введите **Помощник** или **Аналитика**.
1. В зависимости от решений, которые вы включили, в результатах поиска отобразится соответствующий пакет управления.  Например, если вы включили решение для управления оповещениями, в списке отобразится пакет управления Microsoft System Center Advisor Alert Management.
1. Из представления **Мониторинг** перейдите в представление **Operations Management Suite: состояние работоспособности**.  Выберите сервер управления в области **Management Server State** (Состояние сервера управления), а затем в области **Подробное представление** проверьте, соответствует ли значение свойства **Authentication service URI** (Универсальный код ресурса (URI) службы проверки подлинности) идентификатору рабочей области Log Analytics.

   ![oms-opsmgr-mg-authsvcuri-property-ms](./media/om-agents/oms-opsmgr-mg-authsvcuri-property-ms.png)

## <a name="remove-integration-with-azure-monitor"></a>Удаление интеграции с Azure Monitor

Если интеграция группы управления Operations Manager и рабочей области Log Analytics больше не требуется, для надлежащего удаления подключения и конфигурации в группе управления необходимо выполнить несколько действий. В следующей процедуре вы обновляете рабочую область Log Analytics, удаляя ссылку на группу управления, удаляйте соединители Azure Monitor, а затем удаляйте пакеты управления, поддерживающие интеграцию со службой.  

Пакеты управления для решений, которые вы включили, интегрируются с Operations Manager и пакеты управления, необходимые для поддержки интеграции с Azure Monitor, нельзя легко удалить из группы управления. Это связано с тем, что некоторые из пакетов управления Azure Monitor имеют зависимости от других связанных пакетов управления. Чтобы удалить пакеты управления, зависимые от других таких пакетов, скачайте сценарий для [удаления пакета управления с зависимостями](https://gallery.technet.microsoft.com/scriptcenter/Script-to-remove-a-84f6873e) из центра сценариев TechNet.  

1. Откройте командную оболочку Operations Manager под учетной записью пользователя, который является членом роли администраторов Operations Manager.

    > [!WARNING]
    > Прежде чем продолжить, убедитесь, что у вас нет пользовательских пакетов управления, в названии которых есть слово Advisor или IntelligencePack, иначе при выполнении указанных ниже действий они будут удалены из группы управления.
    >

1. В командной оболочки введите `Get-SCOMManagementPack -name "*Advisor*" | Remove-SCOMManagementPack -ErrorAction SilentlyContinue`
1. Затем введите `Get-SCOMManagementPack -name “*IntelligencePack*” | Remove-SCOMManagementPack -ErrorAction SilentlyContinue`
1. Чтобы удалить оставшиеся пакеты управления, зависимые от других пакетов управления System Center Advisor, используйте сценарий *RecursiveRemove.ps1*, который вы ранее скачали из центра сценариев TechNet.  

    > [!NOTE]
    > Операция удаления пакетов управления Advisor с помощью PowerShell не будет автоматически удалять пакеты управления Microsoft System Center Advisor или Microsoft System Center Advisor Internal.  Не пытайтесь удалить их.  
    >  

1. Откройте консоль операций Operations Manager под учетной записью пользователя, который является членом роли администраторов Operations Manager.
1. В разделе **Администрирование** выберите узел **Пакеты управления**, а в поле **Искать:** введите **Advisor** и убедитесь, что в группу управления по-прежнему импортируются следующие пакеты управления:

   * Microsoft System Center Advisor;
   * Microsoft System Center Advisor Internal.

1. На портале Azure щелкните элемент **Параметры**.
1. Выберите **Подключенные источники**.
1. В таблице в разделе System Center Operations Manager должно быть указано имя группы управления, которую нужно удалить из рабочей области. В столбце **Последние данные** нажмите кнопку **Удалить**.  

    > [!NOTE]
    > Ссылка **Удалить** не будет доступна в течение 14 дней, если не будет обнаружено никакой активности из подключенной группы управления.  
    >

1. Откроется окно с запросом подтверждения удаления.  Нажмите кнопку **Да** , чтобы продолжить.

Чтобы удалить два соединителя — Microsoft.SystemCenter.Advisor.DataConnector и Advisor Connector, сохраните приведенный ниже скрипт PowerShell на свой компьютер и выполните его, как показано в следующих примерах.

```
    .\OM2012_DeleteConnectors.ps1 “Advisor Connector” <ManagementServerName>
    .\OM2012_DeleteConnectors.ps1 “Microsoft.SystemCenter.Advisor.DataConnector” <ManagementServerName>
```

> [!NOTE]
> Если компьютер, на котором выполняется этот сценарий, не является сервером управления, на нем должна быть установлена командная строка оболочки Operations Manager в зависимости от версии вашей группы управления.
>
>

```powershell
    param(
    [String] $connectorName,
    [String] $msName="localhost"
    )
    $mg = new-object Microsoft.EnterpriseManagement.ManagementGroup $msName
    $admin = $mg.GetConnectorFrameworkAdministration()
    ##########################################################################################
    # Configures a connector with the specified name.
    ##########################################################################################
    function New-Connector([String] $name)
    {
         $connectorForTest = $null;
         foreach($connector in $admin.GetMonitoringConnectors())
    {
    if($connectorName.Name -eq ${name})
    {
         $connectorForTest = Get-SCOMConnector -id $connector.id
    }
    }
    if ($connectorForTest -eq $null)
    {
         $testConnector = New-Object Microsoft.EnterpriseManagement.ConnectorFramework.ConnectorInfo
         $testConnector.Name = $name
         $testConnector.Description = "${name} Description"
         $testConnector.DiscoveryDataIsManaged = $false
         $connectorForTest = $admin.Setup($testConnector)
         $connectorForTest.Initialize();
    }
    return $connectorForTest
    }
    ##########################################################################################
    # Removes a connector with the specified name.
    ##########################################################################################
    function Remove-Connector([String] $name)
    {
        $testConnector = $null
        foreach($connector in $admin.GetMonitoringConnectors())
       {
        if($connector.Name -eq ${name})
       {
         $testConnector = Get-SCOMConnector -id $connector.id
       }
      }
     if ($testConnector -ne $null)
     {
        if($testConnector.Initialized)
     {
     foreach($alert in $testConnector.GetMonitoringAlerts())
     {
       $alert.ConnectorId = $null;
       $alert.Update("Delete Connector");
     }
     $testConnector.Uninitialize()
     }
     $connectorIdForTest = $admin.Cleanup($testConnector)
     }
    }
    ##########################################################################################
    # Delete a connector's Subscription
    ##########################################################################################
    function Delete-Subscription([String] $name)
    {
      foreach($testconnector in $admin.GetMonitoringConnectors())
      {
      if($testconnector.Name -eq $name)
      {
        $connector = Get-SCOMConnector -id $testconnector.id
      }
    }
    $subs = $admin.GetConnectorSubscriptions()
    foreach($sub in $subs)
    {
      if($sub.MonitoringConnectorId -eq $connector.id)
      {
        $admin.DeleteConnectorSubscription($admin.GetConnectorSubscription($sub.Id))
      }
     }
    }
    #New-Connector $connectorName
    write-host "Delete-Subscription"
    Delete-Subscription $connectorName
    write-host "Remove-Connector"
    Remove-Connector $connectorName
```

Если в будущем вы захотите снова подключить свою группу управления к рабочей области Log Analytics, вам потребуется повторно импортировать файл пакета управления `Microsoft.SystemCenter.Advisor.Resources.\<Language>\.mpb`. В зависимости от версии System Center Operations Manager, развернутой в среде, этот файл может находится в следующих расположениях:

* В исходном носителе в папке `\ManagementPacks` для System Center Operations Manager 2016 и более поздних версий.
* От последнего накопительного пакета обновления, примененного к вашей группе управления. Для Operations Manager 2012, исходная папка — `%ProgramFiles%\Microsoft System Center 2012\Operations Manager\Server\Management Packs for Update Rollups` , а для 2012 R2 она находится в `System Center 2012 R2\Operations Manager\Server\Management Packs for Update Rollups`папке.

## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения о добавлении функций и сборе данных см. в разделе [добавление Azure Monitor решений из коллекция решений](../../azure-monitor/insights/solutions.md).
