---
title: Общие сведения о журнале действий Azure
description: Узнайте, что такое журнал действий Azure и как его использовать для просмотра событий, происходящих в рамках подписки Azure.
author: johnkemnetz
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 05/30/2018
ms.author: johnkem
ms.subservice: logs
ms.openlocfilehash: b84238e8a659358f2c065eb1533f0d21a5335d43
ms.sourcegitcommit: 1a19a5845ae5d9f5752b4c905a43bf959a60eb9d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/11/2019
ms.locfileid: "59496885"
---
# <a name="monitor-subscription-activity-with-the-azure-activity-log"></a>Мониторинг действий подписки с помощью журнала действий Azure

**Журнал действий Azure** — это журнал подписки с подробными сведениями о событиях на уровне подписки, которые произошли в Azure. Сюда входят различные данные — от операционных данных Azure Resource Manager до обновлений в событиях работоспособности службы. Журнал действий раньше назывался журналом аудита или операционным журналом, так как категория "Административная" содержит связанные с подписками события на уровне управления. С помощью журнала изменений можно ответить на вопросы "что? кто? когда?" о любой операции записи (PUT, POST, DELETE) с ресурсами в вашей подписке. Вы также можете отслеживать состояние операции и другие ее свойства. Журнал действий не содержит операции чтения (GET) или операции с ресурсами, которые используют классическую модель или модель RDFE.

![Журналы действий и другие типы журналов](./media/activity-logs-overview/Activity_Log_vs_other_logs_v5.png)

Рис. 1. Журналы действий и другие типы журналов

Журналы действий отличаются от [журналов диагностики](diagnostic-logs-overview.md). Журналы действий предоставляют внешние данные об операциях с ресурсами (плоскость управления). Журналы диагностики выдаются ресурсом и содержат данные о его работе (плоскость данных).

> [!WARNING]
> Журнал действий Azure используется главным образом для действий, которые происходят в Azure Resource Manager. Ресурсы, использующие классическую модель или модель RDFE, не отслеживаются. Для некоторых классических типов ресурсов в Azure Resource Manager имеется прокси-поставщик ресурсов (например, Microsoft.ClassicCompute). Если вы взаимодействуете с ресурсом классического типа через Azure Resource Manager с помощью этих прокси-поставщиков ресурсов, то такие операции отображаются в журнале действий. Если вы взаимодействуете с ресурсом классического типа за пределами прокси Azure Resource Manager, ваши действия записываются только в журнал операций. Журнал операций можно просмотреть в отдельном разделе портала.
>
>

События из журнала изменений можно получить с помощью портала Azure, интерфейса командной строки, командлетов PowerShell или REST API Azure Monitor.

> [!NOTE]
> [Новые оповещения](../../azure-monitor/platform/alerts-overview.md) предоставляют дополнительные возможности для создания и администрирования правил генерации оповещений для журнала действий.  [Узнайте больше](../../azure-monitor/platform/alerts-activity-log.md).

## <a name="categories-in-the-activity-log"></a>Категории в журнале действий
Журнал действий содержит несколько категорий данных. Подробные сведения о схемах этих категорий см. в [этой статье](../../azure-monitor/platform/activity-log-schema.md). в частности такие:
* **Административная**. Эта категория содержит записи всех операций создания, обновления, удаления и других действий, которые выполняются через Resource Manager. В качестве примеров типов событий, которые относятся к этой категории, можно назвать "создание виртуальной машины" или "удаление группы безопасности сети". Каждое действие, выполняемое пользователем или приложением с помощью Resource Manager, моделируется как операция с определенным типом ресурсов. Если тип операции — "запись", "удаление" или "действие", то любые сведения об этой операции (о ее запуске, успешном выполнении или сбое) записываются в категорию "Административная". Категория "Административная" также включает в себя любые изменения в управлении доступом на основе ролей, которые происходят в подписке.
* **Работоспособность службы**. Эта категория содержит записи всех инцидентов, связанных с работоспособностью службы, которые произошли в Azure. В качестве примера типа события из этой категории можно назвать следующее: "В работе SQL Azure в восточной части США наблюдаются простои". Существует шесть разновидностей событий работоспособности служб: Action Required (Требуется действие), Assisted Recovery (Помощь при восстановлении), Incident (Инцидент), Maintenance (Обслуживание), Information (Информация) и Security (Безопасность). Они отображаются, только если в подписке есть ресурс, на который повлияет данное событие.
* **Работоспособность ресурсов**. Эта категория содержит записи всех событий, связанных с работоспособностью службы, которые произошли в Azure. Пример события такого типа из этой категории: Virtual Machine health status changed to unavailable (Состояние работоспособности виртуальной машины изменилось на "Недоступно"). Существует четыре вида событий работоспособности ресурсов: Available (Доступно), Unavailable (Недоступно), Degraded (Понижено) и Unknown (Неизвестно). Кроме того, события работоспособности ресурсов можно классифицировать по свойствам PlatformInitiated (Инициировано платформой) и UserInitiated (Инициировано пользователем).
* **Оповещение**. Эта категория содержит записи всех активаций оповещений Azure. В качестве примера типа события из этой категории можно назвать следующее: "Процент использования ЦП на виртуальной машине myVM за последние 5 минут превышал 80 %". Различные системы Azure работают по принципу оповещений, то есть вы можете определить какое-то правило, и система будет направлять вам уведомление, когда условия этого правила выполняются. Каждый раз, когда "активируется" поддерживаемый тип оповещения Azure или выполняются условия для создания уведомления, в эту категорию журнала активности также передается запись об активации.
* **Автомасштабирование**. Эта категория содержит записи всех событий, связанных с операциями системы автоматического масштабирования, в основе которой лежат параметры автомасштабирования, определенные в подписке. В качестве примера типа события из этой категории можно назвать следующее: "Не удалось выполнить автоматическое увеличение масштаба". С помощью функции автомасштабирования можно автоматически увеличивать или уменьшать число экземпляров в поддерживаемом типе ресурсов на основе времени суток и (или) загружать данные (метрики), используя параметр автомасштабирования. Когда выполняются условия для увеличения или уменьшения масштаба, в эту категорию записываются соответствующие события (запуск, успешное выполнение или сбой).
* **Рекомендация**. Эта категория содержит события рекомендаций от Помощника по Azure.
* **Безопасность**. Эта категория содержит запись любых предупреждений, созданных центром безопасности Azure. Примером типа события в этой категории является "Выполнен подозрительный файл с двойным расширением".
* **Политика** — эта категория содержит записи всех операций действия эффекта, выполняемых Политикой Azure. Примеры типов событий, которые отобразятся в этой категории, включают Audit и Deny. Каждое действие, выполняемое Политикой, моделируется как операция для ресурса.

## <a name="event-schema-per-category"></a>Схема событий по категориям

[См. в этой статье, чтобы разобраться со схемой событий журнала действий по категориям.](../../azure-monitor/platform/activity-log-schema.md)

## <a name="what-you-can-do-with-the-activity-log"></a>Что можно делать с журналом действий

Ниже описано несколько доступных операций с журналом действий.

![Журнал действий Azure](./media/activity-logs-overview/Activity_Log_Overview_v3.png)


* Запросы и просмотры журнала на **портале Azure**.
* [Создание оповещения о событии журнала действий.](../../azure-monitor/platform/activity-log-alerts.md)
* [Stream его **концентратора событий** ](../../azure-monitor/platform/activity-logs-stream-event-hubs.md) для обработки в сторонней службе или пользовательском аналитическом решении, такие как Power BI.
* Анализ журнала в Power BI с помощью [ **пакет содержимого Power BI**](https://powerbi.microsoft.com/documentation/powerbi-content-pack-azure-audit-logs/).
* [Сохранение журнала в **учетную запись хранения** для архивации или проверки вручную](../../azure-monitor/platform/archive-activity-log.md). В **профиле журнала** можно задать время хранения (в днях).
* Обращение к журналу с помощью командлетов PowerShell, интерфейса командной строки или REST API.

## <a name="query-the-activity-log-in-the-azure-portal"></a>Запрос журнала действий на портале Azure

На портале Azure журнал действий можно просмотреть в нескольких расположениях:
* В области **Журнал действий**, к которой можно перейти, выполнив поиск журнала действий в разделе **Все службы** на панели навигации слева.
* В области **Монитор**, которая по умолчанию отображается на панели навигации слева. Журнал действий занимает один раздел Azure Monitor.
* В большинстве колонок **ресурсов**, например, в колонке конфигурации виртуальной машины. Журнал действий занимает раздел в большинстве этих колонок ресурсов. Если щелкнуть его, события будут автоматически отфильтрованы в соответствии с определенным ресурсом.

На портале Azure можно отфильтровать журнал действий по приведенным ниже полям.
* "Временной интервал": время начала и окончания событий.
* "Категория": категории событий, как описано выше.
* "Подписка": одно или несколько имен подписок Azure.
* "Группа ресурсов": одна или несколько групп ресурсов в этих подписках.
* "Имя ресурса": имя определенного ресурса.
* "Тип ресурса": тип ресурса, например, Microsoft.Compute/virtualmachines.
* "Имя операции": имя операции Azure Resource Manager, например Microsoft.SQL/servers/Write.
* "Серьезность": уровень серьезности события ("Информационное", "Предупреждение", "Ошибка", "Критическое").
* "Кем инициировано событие": "вызывающая сторона" или пользователь, выполнивший операцию.
* "Открыть поиск": текстовое поле поиска, с помощью которого можно искать указанную строку во всех полях всех событий.

Когда вы определите набор фильтров, этот запрос можно закрепить на панели мониторинга Azure, чтобы всегда следить за определенными событиями.

Чтобы еще больше расширить возможности, можно щелкнуть значок **Журналы**. Это позволит отобразить данные журнала действий в [решении для сбора и анализа данных из журнала действий](../../azure-monitor/platform/collect-activity-logs.md). В колонке "Журнал действий" доступны основные фильтры и средства обзора журналов, тогда как функция ведения журналов Azure Monitor позволяет сводить, запрашивать и визуализировать данные более эффективными способами.

## <a name="export-the-activity-log-with-a-log-profile"></a>Экспорт журнала действий с помощью профиля журнала

**Профиль журнала** определяет, как экспортируется журнал действий. С помощью профиля журнала вы можете настроить следующие параметры.

* Куда будет отправлен журнал действий (учетная запись хранения или Центры событий).
* Какие категории событий будут отправляться (запись, удаление, действие). *Значение «категории» в профилях журнала и событий журнала действий отличается. В профиле журнала "категория" обозначает тип операции (запись, удаление, действие). В событии журнала действий свойство «категория» представляет источник или тип события (например, администрирования, ServiceHealth, оповещения и многое другое).*
* Какие регионы (расположения) будут экспортированы. Обязательно укажите глобальное расположение, так как в журнале действий существует множество глобальных событий.
* Как долго должен храниться журнал действий в учетной записи хранения.
    - Срок хранения 0 дней означает, что журналы хранятся неограниченно долго. В противном случае — значение может быть любое число от 1 до 365 дней.
    - Если политики хранения заданы, но хранение журналов в учетной записи хранения отключено (например, выбраны только Центры событий или Log Analytics), политики хранения не будут применены.
    - Политики хранения применяются по дням, поэтому в конце дня (по времени в формате UTC) журналы, срок которых теперь превышает период хранения, будут удалены. Например, если настроена политика хранения в течение одного дня, то в начале текущего дня журналы за вчерашний день будет удалены. Удаление начинается в полночь по времени UTC. Обратите внимание, что удаление журналов из учетной записи хранения может занять до 24 часов.

Вы можете использовать учетную запись хранения или пространство имен концентратора событий, не входящее в подписку, в которой создаются журналы. Пользователю, который настраивает этот параметр, должен быть предоставлен соответствующий уровень доступа RBAC к обеим подпискам.

Эти параметры можно настроить с помощью параметра "Экспорт" в колонке журнала изменений на портале. Их также можно настроить программно [с помощью REST API Azure Monitor](https://msdn.microsoft.com/library/azure/dn931927.aspx), командлетов PowerShell или интерфейса командной строки. Для каждой подписки может существовать только один профиль журнала.

### <a name="configure-log-profiles-using-the-azure-portal"></a>Настройка профилей журнала на портале Azure

С помощью параметра "Экспорт в концентратор событий" на портале Azure можно выполнить потоковую передачу журнала действий в концентратор событий или сохранить журнал в учетную запись хранения.

1. Перейдите к области **Журнал действий** с помощью меню в левой части портала.

    ![Переход к журналу действий на портале](./media/activity-logs-overview/activity-logs-portal-navigate-v2.png)
2. Щелкните **Экспорт в концентратор событий** в верхней части колонки.

    ![Кнопка экспорта на портале](./media/activity-logs-overview/activity-logs-portal-export-v2.png)
3. В появившейся колонке вы можете выбрать следующие параметры:
   * регионы, события которых нужно экспортировать;
   * учетная запись хранения, в которой вы хотите сохранить события;
   * сколько дней следует хранить эти события в хранилище (если выбрать значение "0 дней", журналы будут храниться бессрочно);
   * пространство имен служебной шины, в котором следует создать концентратор событий для потоковой передачи этих событий.

     ![Колонка экспорта журнала действий](./media/activity-logs-overview/activity-logs-portal-export-blade.png)
4. Нажмите кнопку **Сохранить** , чтобы сохранить эти параметры. Параметры будут немедленно применены к подписке

### <a name="configure-log-profiles-using-the-azure-powershell-cmdlets"></a>Настройка профилей журнала с помощью командлетов Azure PowerShell

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

#### <a name="get-existing-log-profile"></a>Получение существующего профиля журнала

```powershell
Get-AzLogProfile
```

#### <a name="add-a-log-profile"></a>Добавление профиля журнала

```powershell
Add-AzLogProfile -Name my_log_profile -StorageAccountId /subscriptions/s1/resourceGroups/myrg1/providers/Microsoft.Storage/storageAccounts/my_storage -serviceBusRuleId /subscriptions/s1/resourceGroups/Default-ServiceBus-EastUS/providers/Microsoft.ServiceBus/namespaces/mytestSB/authorizationrules/RootManageSharedAccessKey -Location global,westus,eastus -RetentionInDays 90 -Category Write,Delete,Action
```

| Свойство | Обязательно для заполнения | ОПИСАНИЕ |
| --- | --- | --- |
| Name |Yes |Имя профиля журнала. |
| StorageAccountId |Нет  |Идентификатор ресурса для учетной записи хранения, в которую будет сохранен журнал действий. |
| serviceBusRuleId |Нет  |Идентификатор правила служебной шины для пространства имен служебной шины, в котором вы сможете создать концентраторы событий. Это строка в таком формате: `{service bus resource ID}/authorizationrules/{key name}`. |
| Расположение |Yes |Разделенный запятыми список регионов, для которых будут собираться события журнала действий. |
| RetentionInDays |Yes |Количество дней, в течение которых будут храниться события: от 1 до 2 147 483 647. Нулевое значение означает, что журналы хранятся неограниченно долго, то есть всегда. |
| Категория |Нет  |Разделенный запятыми список категорий событий, которые будут собираться. Возможные значения: Write, Delete или Action. |

#### <a name="remove-a-log-profile"></a>Удаление профиля журнала

```powershell
Remove-AzLogProfile -name my_log_profile
```

### <a name="configure-log-profiles-using-the-azure-cli"></a>Настройка профилей журнала с использованием Azure CLI

#### <a name="get-existing-log-profile"></a>Получение существующего профиля журнала

```azurecli
az monitor log-profiles list
az monitor log-profiles show --name <profile name>
```

Свойство `name` должно содержать имя профиля журнала.

#### <a name="add-a-log-profile"></a>Добавление профиля журнала

```azurecli
az monitor log-profiles create --name <profile name> \
    --locations <location1 location2 ...> \
    --location <location> \
    --categories <category1 category2 ...>
```

Полную документацию по созданию профиля монитора с помощью CLI см. в [справочнике по командам CLI](/cli/azure/monitor/log-profiles#az-monitor-log-profiles-create).

#### <a name="remove-a-log-profile"></a>Удаление профиля журнала

```azurecli
az monitor log-profiles delete --name <profile name>
```

## <a name="next-steps"></a>Следующие шаги

* [Дополнительные сведения о журнале действий (прежнее название — журналы аудита)](../../azure-resource-manager/resource-group-audit.md)
* [Потоковая передача журнала действий Azure в Центры событий](../../azure-monitor/platform/activity-logs-stream-event-hubs.md)
