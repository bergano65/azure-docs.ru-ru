---
title: Сбор и анализ данных счетчиков производительности в Azure Monitor | Документация Майкрософт
description: Счетчики производительности собираются службой Azure Monitor для анализа производительности в агентах Windows и Linux.  В этой статье описывается настройка коллекции счетчиков производительности для агентов Windows и Linux, сведения об этих счетчиках, которые хранятся в рабочей области, и их анализ на портале Azure.
ms.service: azure-monitor
ms.subservice: logs
ms.topic: conceptual
author: MGoedtel
ms.author: magoedte
ms.date: 11/28/2018
ms.openlocfilehash: d007d3dab1625d58a561d35bb111923fbdeb3482
ms.sourcegitcommit: 4c3d6c2657ae714f4a042f2c078cf1b0ad20b3a4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/25/2019
ms.locfileid: "72932439"
---
# <a name="windows-and-linux-performance-data-sources-in-azure-monitor"></a>Источники данных о производительности Windows и Linux в Azure Monitor
Счетчики производительности в Windows и Linux позволяют получить представление о производительности компонентов оборудования, операционных систем и приложений.  Azure Monitor может собирать счетчики производительности с высокой частотой для анализа данных практически в режиме реального времени, а также данные о производительности для более долгосрочного анализа и формирования отчетов.

![Счетчики производительности](media/data-sources-performance-counters/overview.png)

## <a name="configuring-performance-counters"></a>Настройка счетчиков производительности
Счетчики производительности настраиваются в [меню "Данные" раздела "Дополнительные параметры"](agent-data-sources.md#configuring-data-sources).

При первой настройке счетчиков производительности Windows или Linux для новой рабочей области вы можете быстро создать несколько распространенных счетчиков.  Рядом с каждым счетчиком в списке есть флажок.  Отметьте все счетчики, которые нужно создать изначально, и щелкните ссылку **Добавить выбранные счетчики производительности**.

Для каждого счетчика производительности Windows можно выбрать конкретный экземпляр. В случае счетчиков производительности Linux экземпляр выбранного счетчика применяется ко всем дочерним счетчикам родительского счетчика. В следующей таблице представлены распространенные экземпляры для счетчиков производительности Linux и Windows.

| Имя экземпляра | Описание |
| --- | --- |
| \_Total |Общее количество всех экземпляров |
| \* |Все экземпляры |
| (/&#124;/var) |Сопоставление экземпляров с именем / или/var |

### <a name="windows-performance-counters"></a>Счетчики производительности Windows

![Настройка счетчиков производительности Windows](media/data-sources-performance-counters/configure-windows.png)

Чтобы добавить новый счетчик производительности Windows для сбора данных, выполните описанные ниже действия.

1. Введите в текстовое поле имя счетчика в формате *объект(экземпляр)\счетчик*.  По мере ввода вы увидите соответствующий список распространенных счетчиков.  Выберите счетчик из списка или введите собственный.  Кроме того, вы можете получить все экземпляры определенного счетчика, указав *объект\счетчик*.  

    При сборе данных счетчиков производительности SQL Server из именованных экземпляров имена всех этих счетчиков начинаются с *MSSQL$* , после чего следует имя экземпляра.  Например, чтобы собрать показатели счетчика "Коэффициент попаданий в кэш журнала" для всех баз данных из объекта производительности базы данных для экземпляра SQL (INST2), укажите `MSSQL$INST2:Databases(*)\Log Cache Hit Ratio`.

2. Щелкните **+** или нажмите клавишу **ВВОД**, чтобы добавить счетчик в список.
3. При добавлении счетчика по умолчанию устанавливается **интервал выборки** 10 секунд.  Вы можете увеличить это значение до 1800 секунд (30 минут), уменьшив таким образом объем собираемых данных по производительности.
4. Закончив добавление счетчиков, нажмите кнопку **Сохранить** в верхней части экрана, чтобы сохранить конфигурацию.

### <a name="linux-performance-counters"></a>Счетчики производительности Linux

![Настройка счетчиков производительности Linux](media/data-sources-performance-counters/configure-linux.png)

Чтобы добавить новый счетчик производительности Linux для сбора данных, выполните описанные ниже действия.

1. По умолчанию все изменения конфигурации автоматически отправляются во все агенты.  Файл конфигурации агентов Linux отправляется в сборщик данных Fluentd.  Если вы хотите изменить этот файл вручную в каждом агенте Linux, снимите флажок *Применить указанную ниже конфигурацию к моим компьютерам Linux* и следуйте приведенным ниже указаниям.
2. Введите в текстовое поле имя счетчика в формате *объект(экземпляр)\счетчик*.  По мере ввода вы увидите соответствующий список распространенных счетчиков.  Выберите счетчик из списка или введите собственный.  
3. Щелкните **+** или нажмите клавишу **ВВОД**, чтобы добавить счетчик к списку других счетчиков для объекта.
4. Для всех счетчиков объекта используется один и тот же **интервал выборки**.  По умолчанию это 10 секунд.  Вы можете увеличить значение интервала вплоть до 1800 секунд (30 минут), что позволит снизить для хранилища требования к собираемым данным о производительности.
5. Закончив добавление счетчиков, нажмите кнопку **Сохранить** в верхней части экрана, чтобы сохранить конфигурацию.

#### <a name="configure-linux-performance-counters-in-configuration-file"></a>Настройка счетчиков производительности Linux в файле конфигурации
Вместо настройки счетчиков производительности Linux с помощью портала Azure можно отредактировать файлы конфигурации в агенте Linux.  Собираемые метрики производительности определяются конфигурацией в файле **/etc/opt/microsoft/omsagent/\<ИД_рабочей_области\>/conf/omsagent.conf**.

Каждый объект или категорию метрики производительности для сбора следует определить в файле конфигурации в качестве одного элемента `<source>` . Синтаксис соответствует шаблону ниже.

    <source>
      type oms_omi  
      object_name "Processor"
      instance_regex ".*"
      counter_name_regex ".*"
      interval 30s
    </source>


В следующей таблице описаны параметры, используемые в этом элементе.

| Параметры | Описание |
|:--|:--|
| object\_name | Имя объекта в коллекции. |
| instance\_regex |  *Регулярное выражение*, определяющее экземпляры, которые следует собирать. Значение `.*` указывает все экземпляры. Для сбора метрик процессора только для экземпляра \_Total можно указать `_Total`. Для сбора метрик обработки только для экземпляра crond или sshd можно указать `(crond\|sshd)`. |
| counter\_name\_regex | *Регулярное выражение*, определяющее счетчики (для объекта), которые следует собирать. Для сбора всех счетчиков для объекта укажите `.*`. Для сбора только счетчиков области подкачки для объекта памяти, например, можно указать: `.+Swap.+` |
| interval | Частота сбора счетчиков объекта. |


В следующей таблице перечислены объекты и счетчики, которые можно указать в файле конфигурации.  Для определенных приложений доступны дополнительные счетчики, как описано в статье [Сбор данных производительности приложений Linux в Log Analytics](data-sources-linux-applications.md).

| Имя объекта | Имя счетчика |
|:--|:--|
| Логический диск | Процент свободных индексных дескрипторов |
| Логический диск | Процент свободного места |
| Логический диск | Процент используемых индексных дескрипторов |
| Логический диск | Процент используемого места |
| Логический диск | Скорость чтения с диска (байт/с) |
| Логический диск | Операций чтения с диска в секунду |
| Логический диск | Обращений к диску в секунду |
| Логический диск | Скорость записи на диск (байт/с) |
| Логический диск | Операций записи на диск в секунду |
| Логический диск | Свободно мегабайт |
| Логический диск | Скорость обмена с логическим диском (байт/с) |
| Память | Процент доступной памяти |
| Память | Процент доступной области подкачки |
| Память | Процент используемой памяти |
| Память | Процент используемой области подкачки |
| Память | Доступный объем памяти в МБ |
| Память | Доступный объем подкачки в МБ |
| Память | Операций чтения со страницы в секунду |
| Память | Операций записи на страницу в секунду |
| Память | Страниц в секунду |
| Память | Используемая области подкачки в МБ |
| Память | Используемый объем памяти в МБ |
| Network | Всего передано байт |
| Network | Всего получено байт |
| Network | Всего байт |
| Network | Всего передано пакетов |
| Network | Всего получено пакетов |
| Network | Всего ошибок Rx |
| Network | Всего ошибок Tx |
| Network | Всего конфликтов |
| Физический диск | Среднее время чтения с диска (с) |
| Физический диск | Среднее время обращения к диску (сек.) |
| Физический диск | Среднее время записи на диск (сек.) |
| Физический диск | Скорость обмена с физическим диском (байт/с) |
| Процесс | Процент времени работы в привилегированном режиме |
| Процесс | Процент времени пользователя |
| Процесс | Используемая память в КБ |
| Процесс | Виртуальная общая память |
| Процессор | Процент времени DPC |
| Процессор | Процент времени простоя |
| Процессор | Процент времени прерывания |
| Процессор | Процент времени ожидания ввода-вывода |
| Процессор | Процент времени работы с низким приоритетом |
| Процессор | Процент времени работы в привилегированном режиме |
| Процессор | % загруженности процессора |
| Процессор | Процент времени пользователя |
| Система | Объем свободной физической памяти |
| Система | Объем свободного места в файлах подкачки |
| Система | Объем свободной виртуальной памяти |
| Система | Процессы |
| Система | Объем, сохраненный в файлах подкачки |
| Система | Время доступности |
| Система | Пользователи |


Ниже показана конфигурация по умолчанию для метрик производительности.

    <source>
      type oms_omi
      object_name "Physical Disk"
      instance_regex ".*"
      counter_name_regex ".*"
      interval 5m
    </source>

    <source>
      type oms_omi
      object_name "Logical Disk"
      instance_regex ".*
      counter_name_regex ".*"
      interval 5m
    </source>

    <source>
      type oms_omi
      object_name "Processor"
      instance_regex ".*
      counter_name_regex ".*"
      interval 30s
    </source>

    <source>
      type oms_omi
      object_name "Memory"
      instance_regex ".*"
      counter_name_regex ".*"
      interval 30s
    </source>

## <a name="data-collection"></a>Сбор данных
Служба Azure Monitor будет собирать данные со всех указанных счетчиков производительности с заданным для них интервалом выборки во всех агентах, в которых установлен счетчик.  Данные не агрегируются. Необработанные данные доступны во всех представлениях запросов по журналам в течение времени, определенного подпиской.

## <a name="performance-record-properties"></a>Свойства записи о производительности
Записи о производительности имеют тип **Perf** и свойства, описанные в приведенной ниже таблице.

| Свойство | Описание |
|:--- |:--- |
| Компьютер |Компьютер, с которого было получено событие. |
| CounterName |Имя счетчика производительности. |
| CounterPath |Полный путь к счетчику в формате \\\\\<компьютер>\\объект(экземпляр)\\счетчик. |
| CounterValue |Числовое значение счетчика. |
| InstanceName |Имя экземпляра события.  Если экземпляра нет, используется пустое значение. |
| ObjectName |Имя объекта производительности. |
| SourceSystem |Тип агента, из которого были получены данные. <br><br>OpsManager — агент Windows, подключенный напрямую или через SCOM <br> Linux — все агенты Linux  <br> AzureStorage – диагностика Azure |
| TimeGenerated |Дата и время выборки данных. |

## <a name="sizing-estimates"></a>Оценки размера
 Сбор данных для одного счетчика с 10-секундным интервалом генерирует около 1 МБ данных в день на каждый экземпляр.  Оценить требования конкретного счетчика к объему памяти можно по указанной ниже формуле.

    1 MB x (number of counters) x (number of agents) x (number of instances)

## <a name="log-queries-with-performance-records"></a>Запросы по журналам с записями о производительности
Ниже приведены различные примеры запросов по журналу, которые извлекают записи о производительности.

| Запрос | Описание |
|:--- |:--- |
| Perf |Все данные о производительности. |
| Perf &#124; where Computer == "MyComputer" |Все данные о производительности с определенного компьютера |
| Perf &#124; where CounterName == "Current Disk Queue Length" |Все данные о производительности с определенного счетчика |
| Производительность &#124; , где objectName = = "процессор" и CounterName = = "% загруженности процессора" и instanceName = = " &#124; _Total" обобщить Авгкпу = AVG (CounterValue) by Computer |Средний объем использования ЦП на всех компьютерах |
| Производительность &#124; , где CounterName = = "% загруженности &#124; процессора" обобщить AggregatedValue = Max (CounterValue) by Computer |Максимальный объем использования ЦП на всех компьютерах |
| Производительность &#124; , где objectName = = "LogicalDisk" и CounterName = = "Текущая длина очереди диска" и Computer = = "микомпутернаме &#124; " суммировать AggregatedValue = AVG (CounterValue) по InstanceName |Средняя длина текущей дисковой очереди по всем экземплярам заданного компьютера |
| Производительность &#124; , где CounterName = = "передача с диска/ &#124; с" Сводка AggregatedValue = процентиль (CounterValue, 95) по компьютерам |95-й процентиль для обращений к диску/с на всех компьютерах |
| Perf &#124; where CounterName == "% Processor Time" and InstanceName == "_Total" &#124; summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 1h), Computer |Средняя почасовая нагрузка на ЦП по всем компьютерам |
| Perf &#124; where Computer == "MyComputer" and CounterName startswith_cs "%" and InstanceName == "_Total" &#124; summarize AggregatedValue = percentile(CounterValue, 70) by bin(TimeGenerated, 1h), CounterName | Почасовые 70-е процентили по каждому процентному счетчику для конкретного компьютера |
| Perf &#124; where CounterName == "% Processor Time" and InstanceName == "_Total" and Computer == "MyComputer" &#124; summarize ["min(CounterValue)"] = min(CounterValue), ["avg(CounterValue)"] = avg(CounterValue), ["percentile75(CounterValue)"] = percentile(CounterValue, 75), ["max(CounterValue)"] = max(CounterValue) by bin(TimeGenerated, 1h), Computer |Почасовые средние, минимальные, максимальные значения и 75-е процентили по загрузке ЦП для конкретного компьютера |
| Perf &#124; where ObjectName == "MSSQL$INST2:Databases" and InstanceName == "master" | Все данные производительности из объекта производительности базы данных master именованного экземпляра SQL Server (INST2).  




## <a name="next-steps"></a>Дальнейшие действия
* [Сбор данных счетчиков производительности из приложений Linux](data-sources-linux-applications.md), включая MySQL и сервер HTTP Apache.
* Узнайте больше о [запросах журнала](../log-query/log-query-overview.md), которые можно применять для анализа данных, собираемых из источников данных и решений.  
* Экспортируйте собранные данные в [Power BI](powerbi.md) для дополнительной визуализации и анализа.
