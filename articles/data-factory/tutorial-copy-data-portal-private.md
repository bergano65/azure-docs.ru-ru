---
title: Создание конвейера Фабрики данных Azure с помощью частных конечных точек
description: В этом руководстве описано, как с помощью портала Azure создать фабрику данных с конвейером. Этот конвейер использует действие копирования для копирования данных из хранилища BLOB-объектов Azure в базу данных SQL Azure.
services: data-factory
documentationcenter: ''
author: linda33wj
manager: shwang
ms.reviewer: douglasl
ms.service: data-factory
ms.workload: data-services
ms.topic: tutorial
ms.custom: seo-lt-2019
ms.date: 01/15/2021
ms.author: jingwang
ms.openlocfilehash: dfd2ed47c3fd963d7e119d235719771b25bdaf34
ms.sourcegitcommit: 25d1d5eb0329c14367621924e1da19af0a99acf1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/16/2021
ms.locfileid: "98249522"
---
# <a name="copy-data-securely-from-azure-blob-storage-to-a-sql-database-by-using-private-endpoints"></a>Безопасное копирование данных из Хранилища BLOB-объектов Azure в Базу данных SQL с помощью частных конечных точек

[!INCLUDE[appliesto-adf-xxx-md](includes/appliesto-adf-xxx-md.md)]

В этом руководстве вы создадите фабрику данных с помощью пользовательского интерфейса фабрики данных Azure. *Конвейер в этой фабрике данных безопасно копирует данные из Хранилища BLOB-объектов Azure в службу "База данных SQL Azure" (где доступ к обоим хранилищам возможен только из определенных сетей) с помощью частных конечных точек в [управляемой виртуальной сети Фабрики данных Azure](managed-virtual-network-private-endpoint.md).* Шаблон конфигурации в этом руководстве применяется к копированию из файлового в реляционное хранилище данных. Список хранилищ данных, которые поддерживаются в качестве источников и приемников, см. в таблице [Поддерживаемые хранилища данных и форматы](./copy-activity-overview.md).

> [!NOTE]
> Если вы еще не работали с фабрикой данных, ознакомьтесь со статьей [Введение в фабрику данных Azure](./introduction.md).

Вот какие шаги выполняются в этом руководстве:

* Создали фабрику данных.
* создание конвейера с действием копирования;


## <a name="prerequisites"></a>Предварительные требования
* **Подписка Azure**. Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free/) Azure, прежде чем начинать работу.
* **Учетная запись хранения Azure**. В этом руководстве в качестве *источника* будет использоваться хранилище BLOB-объектов. Если у вас нет учетной записи хранения, создайте ее, следуя действиям в [этом разделе](../storage/common/storage-account-create.md?tabs=azure-portal). *Убедитесь, что получить доступ к учетной записи хранения можно только из выбранных сетей.* 
* **База данных SQL Azure**. Используйте базу данных как хранилище данных-*приемник*. Если у вас нет базы данных SQL, создайте ее, следуя указаниям в статье [Создание базы данных SQL Azure на портале Azure](../azure-sql/database/single-database-create-quickstart.md). *Убедитесь, что получить доступ к службе "База данных SQL" можно только из выбранных сетей.* 

### <a name="create-a-blob-and-a-sql-table"></a>Создание большого двоичного объекта и таблицы SQL

Теперь подготовьте хранилище больших двоичных объектов и базу данных SQL к изучению этого учебника, выполнив следующие действия.

#### <a name="create-a-source-blob"></a>Создание исходного большого двоичного объекта

1. Откройте Блокнот. Скопируйте следующий текст и сохраните его в файл **emp.txt** на диске.

    ```
    FirstName,LastName
    John,Doe
    Jane,Doe
    ```

1. Создайте контейнер с именем **adftutorial** в хранилище BLOB-объектов. Создайте папку **input** в этом контейнере. Затем отправьте файл **emp.txt** в папку **input**. Эти задачи можно выполнить с помощью портала Azure или специальных средств, таких как [Обозреватель службы хранилища Azure](https://storageexplorer.com/).

#### <a name="create-a-sink-sql-table"></a>Создание таблицы-приемника SQL

Используйте следующий скрипт SQL, чтобы создать таблицу **dbo.emp** в базе данных SQL.

```sql
CREATE TABLE dbo.emp
(
    ID int IDENTITY(1,1) NOT NULL,
    FirstName varchar(50),
    LastName varchar(50)
)
GO

CREATE CLUSTERED INDEX IX_emp_ID ON dbo.emp (ID);
```

## <a name="create-a-data-factory"></a>Создание фабрики данных
На этом этапе вы создадите фабрику данных и запустите пользовательский интерфейс службы "Фабрика данных" для создания конвейера в фабрике данных.

1. Откройте Microsoft Edge или Google Chrome. Сейчас только эти браузеры поддерживают пользовательский интерфейс фабрики данных.

1. В меню слева выберите **Создать ресурс** > **Аналитика** > **Фабрика данных**.

1. На странице **Новая фабрика данных** в поле **Имя** введите **ADFTutorialDataFactory**.

   Имя фабрики данных Azure должно быть *глобально уникальным*. Если вы увидите следующую ошибку касательно значения имени, введите другое имя фабрики данных (например, yournameADFTutorialDataFactory). Дополнительные сведения о правилах именования артефактов фабрики данных см. в статье [Фабрика данных Azure — правила именования](./naming-rules.md).

1. Выберите **подписку** Azure, в рамках которой вы хотите создать фабрику данных.

1. Для **группы ресурсов** выполните одно из следующих действий:

    - Выберите **Использовать существующую** и укажите существующую группу ресурсов в раскрывающемся списке.
    - Выберите **Создать новую** и укажите имя группы ресурсов. 
     
    Сведения о группах ресурсов см. в статье [Общие сведения об Azure Resource Manager](../azure-resource-manager/management/overview.md). 

1. В качестве **версии** выберите **V2**.

1. В поле **Расположение** выберите расположение фабрики данных. В раскрывающемся списке отображаются только поддерживаемые расположения. Хранилища данных (например, служба хранилища Azure и база данных SQL) и вычислительные ресурсы (например, Azure HDInsight), используемые фабрикой данных, могут располагаться в других регионах.

1. Нажмите кнопку **создания**.

1. После завершения создания вы увидите уведомление в центре уведомлений. Выберите **Перейти к ресурсу**, чтобы открыть страницу **фабрики данных**.

1. Выберите **Создание и мониторинг**, чтобы запустить на отдельной вкладке пользовательский интерфейс фабрики данных.

## <a name="create-an-azure-integration-runtime-in-data-factory-managed-virtual-network"></a>Создание среды выполнения интеграции Azure в управляемой виртуальной сети Фабрики данных
На этом шаге вы создадите среду выполнения интеграции Azure и включите управляемую виртуальную сеть Фабрики данных.

1. На портале Фабрики данных перейдите в раздел **Управление** и выберите **Создать**, чтобы создать среду выполнения интеграции Azure.

   ![Снимок экрана: создание среды выполнения интеграции Azure.](./media/tutorial-copy-data-portal-private/create-new-azure-ir.png)
1. На странице **Integration runtime setup** (Настройка среды выполнения интеграции) выберите, какую среду выполнения интеграции следует создать на основе требуемых возможностей. По условиям этого руководства выберите **Azure** и нажмите кнопку **Продолжить**. 
1. Выберите **Azure** и щелкните **Продолжить**, чтобы создать среду выполнения интеграции Azure.

   ![Снимок экрана: новая среда выполнения интеграции Azure.](./media/tutorial-copy-data-portal-private/azure-ir.png)
1. В разделе **Virtual network configuration (Preview)** (Конфигурация виртуальной сети (предварительная версия)) выберите **Включить**.

   ![Снимок экрана: включение среды выполнения интеграции Azure.](./media/tutorial-copy-data-portal-private/enable-managed-vnet.png)
1. Нажмите кнопку **создания**.

## <a name="create-a-pipeline"></a>Создание конвейера
На этом шаге вы создадите в фабрике данных конвейер с действием копирования. Это действие копирования копирует данные из хранилища BLOB-объектов в базу данных SQL. В предыдущем [руководстве](./quickstart-create-data-factory-portal.md) вы создали конвейер, выполнив следующие действия:

1. Создание связанной службы.
1. Создание входных и выходных наборов данных.
1. Создали конвейер.

В этом учебнике вы сразу приступите к созданию конвейера, а связанные службы и наборы данных будете создавать по мере необходимости для настройки конвейера.

1. На странице **Начало работы** выберите **Create pipeline** (Создать конвейер).

   ![Снимок экрана: создание конвейера.](./media/doc-common-process/get-started-page.png)
1. На панели свойств для конвейера введите **CopyPipeline** в поле имени конвейера.

1. На панели элементов **Действия** разверните категорию **Move and Transform** (Переместить и преобразовать) и перетащите действие **Копирование данных** из панели элементов в область конструктора конвейера. В качестве имени введите **CopyFromBlobToSql**.

    ![Снимок экран: действие копирования.](./media/tutorial-copy-data-portal-private/drag-drop-copy-activity.png)

### <a name="configure-a-source"></a>Настройка источника

>[!TIP]
>В этом учебнике в качестве типа проверки подлинности для исходного хранилища данных используется **ключ учетной записи**. При необходимости вы также можете выбрать другие поддерживаемые способы проверки подлинности, такие как **универсальный код ресурса SAS**, **субъект-службу** и **управляемое удостоверение**. Дополнительные сведения см. в соответствующих разделах статьи [Копирование данных в хранилище больших двоичных объектов Azure и обратно с помощью фабрики данных Azure](./connector-azure-blob-storage.md#linked-service-properties).
>
>Чтобы безопасно хранить секреты для хранилищ данных, также рекомендуется использовать Azure Key Vault. Дополнительные сведения и иллюстрации см. в статье [Хранение учетных данных в Azure Key Vault](./store-credentials-in-key-vault.md).

#### <a name="create-a-source-dataset-and-linked-service"></a>Создание исходного набора данных и связанной службы

1. Перейдите на вкладку **Источник**. Выберите **+ Создать**, чтобы создать исходный набор данных.

1. В диалоговом окне **Новый набор данных** выберите **Хранилище BLOB-объектов Azure** и щелкните **Продолжить**. Выберите **Хранилище BLOB-объектов** для исходного набора данных, потому что именно там находится источник данных.

1. В диалоговом окне **Выбор формата** выберите тип формата ваших данных, а затем нажмите кнопку **Продолжить**.

1. В диалоговом окне **Установка свойств** введите **SourceBlobDataset** в качестве **имени**. Установите флажок **Использовать первую строку в качестве заголовка**. В текстовом поле **Связанная служба** выберите **+ Создать**.

1. В окне **New Linked Service (Azure Blob Storage)** (Новая связанная служба (хранилище BLOB-объектов Azure)) в качестве **имени** введите **AzureStorageLinkedService** и выберите учетную запись хранения в списке **Имя учетной записи хранения**. 

1. Обязательно включите режим **Интерактивная разработка**. Его включение может занять около одной минуты.

    ![Снимок экрана: режим "Интерактивная разработка".](./media/tutorial-copy-data-portal-private/interactive-authoring.png)

1. Выберите **Test connection** (Проверить подключение). Эта операция должна завершиться сбоем, если получить доступ к учетной записи хранения можно только из **выбранной сети**. Это означает, что Фабрике данных нужно создать частную конечную точку и получить для нее утверждение, прежде чем использовать ее. В сообщении об ошибке должна присутствовать ссылка, по которой вы можете перейти к интерфейсу создания управляемой частной конечной точки. Кроме того, можно сразу открыть вкладку **Управление** и выполнить инструкции из [следующего раздела](#create-a-managed-private-endpoint), чтобы создать управляемую частную конечную точку.

   > [!NOTE]
   > Вкладка **Управление** может быть доступна не для всех экземпляров фабрики данных. Если она не отображается, вы можете получить доступ к частным конечным точкам, выбрав **Создание** > **Подключения** > **Частная конечная точка**.
1. Не закрывая это диалоговое окно, перейдите к учетной записи хранения.

1. Следуйте инструкциям в [этом разделе](#approval-of-a-private-link-in-a-storage-account), чтобы утвердить частную ссылку.

1. Вернитесь к диалоговому окну. Выберите **Проверить соединение**, а затем нажмите кнопку **Создать**, чтобы развернуть связанную службу.

1. После создания связанной службы снова откроется страница **Установка свойств**. Рядом с полем **Путь к файлу** выберите **Обзор**.

1. Перейдите к папке **adftutorial/input**, выберите файл **emp.txt** и нажмите кнопку **OK**.

1. Щелкните **ОК**. Автоматически откроется страница конвейера. Убедитесь, что на вкладке **Источник** выбрано значение **SourceBlobDataset**. Чтобы просмотреть данные на этой странице, выберите **Просмотр данных**.

    ![Снимок экрана: исходный набор данных.](./media/tutorial-copy-data-portal-private/source-dataset-selected.png)

#### <a name="create-a-managed-private-endpoint"></a>Создание управляемой частной конечной точки

Если вы не переходили по гиперссылке при проверке подключения, перейдите по указанному пути. Здесь вам нужно создать управляемую частную конечную точку, которая будет подключаться к созданной связанной службе.

1. Перейдите на вкладку **Управление**.

   > [!NOTE]
   > Вкладка **Управление** может быть доступна не для всех экземпляров фабрики данных. Если она не отображается, вы можете получить доступ к частным конечным точкам, выбрав **Создание** > **Подключения** > **Частная конечная точка**.

1. Перейдите в раздел **Managed private endpoints** (Управляемые частные конечные точки).

1. В разделе **управляемых частных конечных точек** выберите **+ Создать**.

    ![Снимок экрана: кнопка "Создать" в разделе Managed private endpoints (Управляемые частные конечные точки).](./media/tutorial-copy-data-portal-private/new-managed-private-endpoint.png) 

1. Выберите в списке плитку **Хранилище BLOB-объектов Azure**, а затем щелкните **Продолжить**.

1. Введите имя созданной учетной записи хранения.

1. Нажмите кнопку **создания**.

1. Через несколько секунд для созданной частной ссылки отобразится состояние ожидания утверждения.

1. Выберите созданную частную конечную точку. Вы увидите гиперссылку, которая ведет к интерфейсу утверждения частной конечной точки на уровне учетной записи хранения.

    ![Снимок экрана: область управляемой частной конечной точки.](./media/tutorial-copy-data-portal-private/manage-private-endpoint.png) 

#### <a name="approval-of-a-private-link-in-a-storage-account"></a>Утверждение частной ссылки в учетной записи хранения
1. В разделе **Параметры** для учетной записи хранения выберите **Подключения частных конечных точек**.

1. Установите флажок для созданной частной конечной точки и выберите **Утвердить**.

    ![Снимок экрана: кнопка "Утвердить" для частной конечной точки.](./media/tutorial-copy-data-portal-private/approve-private-endpoint.png)

1. Добавьте описание и выберите **Да**.
1. Вернитесь к разделу **Managed private endpoints** (Управляемые частные конечные точки) на вкладке **Управление** для Фабрики данных.
1. Через одну-две минуты в пользовательском интерфейсе Фабрики данных отобразится состояние ожидания утверждения частной конечной точки.


### <a name="configure-a-sink"></a>Настройка приемника
>[!TIP]
>В этом учебнике проверка подлинности хранилища данных приемника выполняется с помощью **проверки подлинности SQL**. При необходимости вы также можете выбрать другие поддерживаемые способы проверки подлинности, такие как **субъект-службу** и **управляемое удостоверение**. Дополнительные сведения см. в соответствующих разделах статьи о [копировании и преобразовании данных в службе "База данных SQL Azure" с помощью Фабрики данных Azure](./connector-azure-sql-database.md#linked-service-properties).
>
>Чтобы безопасно хранить секреты для хранилищ данных, также рекомендуется использовать Azure Key Vault. Дополнительные сведения и иллюстрации см. в статье [Хранение учетных данных в Azure Key Vault](./store-credentials-in-key-vault.md).

#### <a name="create-a-sink-dataset-and-linked-service"></a>Создание целевого набора данных и связанной службы
1. Перейдите на вкладку **Приемник** и выберите **+ Создать**, чтобы создать целевой набор данных.

1. В диалоговом окне **Новый набор данных** в поле поиска введите **SQL**, чтобы отфильтровать соединители. Выберите **База данных SQL Azure** и нажмите кнопку **Продолжить**. В этом руководстве вы будете копировать данные в базу данных SQL.

1. В диалоговом окне **Установка свойств** введите **OutputSqlDataset** в качестве **имени**. В раскрывающемся списке **Связанная служба** выберите **+ Создать**. Связанную службу нужно сопоставить с набором данных. Связанная служба содержит строку подключения, которая потребуется фабрике данных для подключения к базе данных SQL в среде выполнения. Набор данных определяет контейнер, папку и (необязательно) файл, куда копируются данные.

1. В диалоговом окне **New Linked Service (Azure SQL Database)** (Новая связанная служба (База данных SQL Azure)) сделайте следующее:

    1. В поле **Имя** введите **AzureSqlDatabaseLinkedService**.
    1. В списке **Имя сервера** выберите необходимый экземпляр SQL Server.
    1. Обязательно включите режим **Интерактивная разработка**.
    1. В списке **Имя базы данных** выберите базу данных SQL.
    1. В поле **Имя пользователя** введите имя пользователя.
    1. В поле **Пароль** введите пароль для этого пользователя.
    1. Выберите **Test connection** (Проверить подключение). Операция должна завершиться сбоем, так как получить доступ к серверу SQL можно только из **выбранных сетей**. Это означает, что Фабрике данных нужно создать частную конечную точку и получить для нее утверждение, прежде чем использовать ее. В сообщении об ошибке должна присутствовать ссылка, по которой вы можете перейти к интерфейсу создания управляемой частной конечной точки. Кроме того, можно сразу открыть вкладку **Управление** и выполнить инструкции из следующего раздела, чтобы создать управляемую частную конечную точку.
    1. Не закрывая это диалоговое окно, перейдите к выбранному экземпляру SQL Server.
    1. Следуйте инструкциям в [этом разделе](#approval-of-a-private-link-in-sql-server), чтобы утвердить частную ссылку.
    1. Вернитесь к диалоговому окну. Выберите **Проверить соединение**, а затем нажмите кнопку **Создать**, чтобы развернуть связанную службу.

1. Автоматически откроется диалоговое окно **Установка свойств**. В поле **Таблица** выберите **[dbo].[emp]** . Нажмите кнопку **ОК**.

1. Перейдите на вкладку с конвейером и убедитесь, что в поле **Sink Dataset** (Целевой набор данных) выбрано значение **OutputSqlDataset**.

    ![Снимок экрана: вкладка "Конвейер".](./media/tutorial-copy-data-portal-private/pipeline-tab-2.png)

При необходимости вы можете сопоставить схему источника с соответствующей схемой назначения, выполнив действия в статье [Сопоставление схемы в действии копирования](./copy-activity-schema-and-type-mapping.md).

#### <a name="create-a-managed-private-endpoint"></a>Создание управляемой частной конечной точки

Если вы не переходили по гиперссылке при проверке подключения, перейдите по указанному пути. Здесь вам нужно создать управляемую частную конечную точку, которая будет подключаться к созданной связанной службе.

1. Перейдите на вкладку **Управление**.
1. Перейдите в раздел **Managed private endpoints** (Управляемые частные конечные точки).
1. В разделе **управляемых частных конечных точек** выберите **+ Создать**.

    ![Снимок экрана: кнопка "Создать" в разделе Managed private endpoints (Управляемые частные конечные точки).](./media/tutorial-copy-data-portal-private/new-managed-private-endpoint.png) 

1. Выберите в списке плитку **База данных SQL Azure**, а затем нажмите кнопку **Продолжить**.
1. Введите имя выбранного экземпляра SQL Server.
1. Нажмите кнопку **создания**.
1. Через несколько секунд для созданной частной ссылки отобразится состояние ожидания утверждения.
1. Выберите созданную частную конечную точку. Вы увидите гиперссылку, которая ведет к интерфейсу утверждения частной конечной точки на уровне SQL Server.


#### <a name="approval-of-a-private-link-in-sql-server"></a>Утверждение частной ссылки в экземпляре SQL Server
1. В разделе **Параметры** для экземпляра SQL Server выберите **Подключения частных конечных точек**.
1. Установите флажок для созданной частной конечной точки и выберите **Утвердить**.
1. Добавьте описание и выберите **Да**.
1. Вернитесь к разделу **Managed private endpoints** (Управляемые частные конечные точки) на вкладке **Управление** для Фабрики данных.
1. Через одну-две минуты для частной конечной точки отобразится состояние ожидания утверждения.

#### <a name="debug-and-publish-the-pipeline"></a>Отладка и публикация конвейера

Вы можете отладить работу конвейера, прежде чем публиковать артефакты (связанные службы, наборы данных и конвейер) в фабрике данных или вашем собственном репозитории Git Azure Repos.

1. Чтобы выполнить отладку конвейера, на панели инструментов щелкните **Отладка**. Состояние выполнения конвейера вы можете найти на вкладке **Выходные данные** в нижней части окна.
1. После успешного запуска конвейера в верхней панели инструментов выберите **Опубликовать все**. Это действие опубликует созданные сущности (наборы данных и конвейеры) в фабрике данных.
1. Дождитесь сообщения **Successfully published** (Публикация выполнена). Чтобы отобразить сообщения с уведомлениями, выберите **Показывать уведомления** в правом верхнем углу (кнопка в виде колокольчика).


#### <a name="summary"></a>Итоги
В этом примере конвейер копирует данные из Хранилища BLOB-объектов в службу "База данных SQL" с помощью частной конечной точки в управляемой виртуальной сети Фабрики данных. Вы ознакомились с выполнением следующих задач:

* Создали фабрику данных.
* создание конвейера с действием копирования;