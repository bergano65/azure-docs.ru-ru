---
title: Создание локальной среды выполнения интеграции в фабрике данных Azure
description: Узнайте, как создать локальную среду выполнения интеграции в фабрике данных Azure, которая позволяет фабрикам данных обращаться к хранилищам данных в частной сети.
services: data-factory
documentationcenter: ''
ms.service: data-factory
ms.workload: data-services
ms.tgt_pltfrm: na
ms.topic: conceptual
ms.date: 06/18/2019
author: nabhishek
ms.author: abnarain
manager: craigg
ms.openlocfilehash: 4662e5047e981c74d2422830bc5b152dae738337
ms.sourcegitcommit: b5d59c6710046cf105236a6bb88954033bd9111b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/27/2019
ms.locfileid: "74559319"
---
# <a name="create-and-configure-a-self-hosted-integration-runtime"></a>Создание и настройка локальной среды выполнения интеграции

Среда выполнения интеграции (IR) — это инфраструктура вычислений, которую Фабрика данных Azure использует для обеспечения интеграции данных в разных сетевых средах. Дополнительные сведения о среде выполнения интеграции см. [в этом обзоре](concepts-integration-runtime.md).

Локальная среда выполнения интеграции может выполнять операции копирования между облачным хранилищем данных и хранилищем данных в частной сети. Он также может отправлять действия преобразования в ресурсы вычислений в локальной сети или в виртуальной сети Azure. Для установки локальной среды выполнения интеграции требуется локальный компьютер или виртуальная машина в частной сети.  

В этой статье описывается, как создать и настроить локальное IR-соединение.

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="setting-up-a-self-hosted-integration-runtime"></a>Настройка локальной среды выполнения интеграции

Чтобы создать и настроить локальную среду выполнения интеграции, используйте следующие процедуры.

### <a name="create-a-self-hosted-ir-via-azure-powershell"></a>Создание локальной среды IR с помощью Azure PowerShell

1. Для этой задачи можно использовать Azure PowerShell. Вот пример:

    ```powershell
    Set-AzDataFactoryV2IntegrationRuntime -ResourceGroupName $resourceGroupName -DataFactoryName $dataFactoryName -Name $selfHostedIntegrationRuntimeName -Type SelfHosted -Description "selfhosted IR description"
    ```
  
2. [Скачайте](https://www.microsoft.com/download/details.aspx?id=39717) и установите на локальном компьютере локальную среду выполнения интеграции.

3. Получите ключ проверки подлинности и зарегистрируйте локальную среду выполнения интеграции с помощью этого ключа. Ниже приведен пример скрипта PowerShell.

    ```powershell

    Get-AzDataFactoryV2IntegrationRuntimeKey -ResourceGroupName $resourceGroupName -DataFactoryName $dataFactoryName -Name $selfHostedIntegrationRuntimeName  

    ```

### <a name="create-a-self-hosted-ir-via-azure-data-factory-ui"></a>Создание самостоятельно размещенного IR через пользовательский интерфейс фабрики данных Azure

Чтобы создать локальное IR с помощью пользовательского интерфейса фабрики данных Azure, выполните следующие действия.

1. На странице Приступая к **работе** в пользовательском интерфейсе фабрики данных Azure выберите вкладку **Автор** на самой левой панели.

   ![Кнопка "Автор" домашней страницы](media/doc-common-process/get-started-page-author-button.png)

1. Выберите **подключения** в нижней части самой левой панели и в окне **подключения** выберите пункт **среды выполнения интеграции** . Выберите **+ создать**.

   ![Создание среды выполнения интеграции](media/create-self-hosted-integration-runtime/new-integration-runtime.png)

1. В окне **Настройка среды выполнения интеграции** выберите **выполнить перемещение данных и отправка действий во внешние расчеты**и нажмите кнопку **продолжить**.

1. Введите имя для своего типа IR и нажмите кнопку **создать**.

1. Выберите ссылку в **параметре 1** , чтобы открыть Экспресс – установку на компьютере. Чтобы настроить вручную, выполните действия, описанные в разделе **вариант 2** . Следующие инструкции основаны на настройке вручную.

   ![Настройка среды выполнения интеграции](media/create-self-hosted-integration-runtime/integration-runtime-setting-up.png)

    1. Скопируйте и вставьте ключ проверки подлинности. Выберите **скачать и установить среду выполнения интеграции**.

    1. Скачайте локальную среду выполнения интеграции на локальном компьютере Windows. Запустите установщик.

    1. На странице **Register Integration Runtime (Self-Hosted)** Вставьте сохраненный ранее ключ и нажмите кнопку **Register (зарегистрировать**).
    
       ![Регистрация среды выполнения интеграции](media/create-self-hosted-integration-runtime/register-integration-runtime.png)

    1. На странице **Новый узел среды выполнения интеграции (с локальным размещением)** нажмите кнопку **Finish** (Завершить)

1. После успешной регистрации локальной среды выполнения интеграции вы увидите следующее окно:

    ![Успешная регистрация](media/create-self-hosted-integration-runtime/registered-successfully.png)

### <a name="set-up-a-self-hosted-ir-on-an-azure-vm-via-an-azure-resource-manager-template"></a>Настройка самостоятельно размещенного IR на виртуальной машине Azure с помощью шаблона Azure Resource Manager

Вы можете автоматизировать самостоятельную настройку IR на виртуальной машине Azure с помощью [шаблона "создать IR](https://github.com/Azure/azure-quickstart-templates/tree/master/101-vms-with-selfhost-integration-runtime)". Шаблон обеспечивает простой способ работы с автономным локальным IR в виртуальной сети Azure. У IR есть функции высокой доступности и масштабируемости, при условии, что число узлов установлено равным 2 или выше.

### <a name="set-up-an-existing-self-hosted-ir-via-local-powershell"></a>Настройка существующего саморазмещенного IR через локальную среду PowerShell

Можно использовать командную строку для установки или управления существующими локальными ИК-соединениями. Такое использование может помочь в автоматизации установки и регистрации на узлах IR, размещенных на собственном сервере.

Дмгкмд. exe входит в состав самостоятельно размещенного установщика. Обычно он находится в папке C:\Program Files\Microsoft Integration Runtime\3.0\Shared\. Это приложение поддерживает различные параметры и может вызываться через командную строку с помощью сценариев пакетной службы для автоматизации.

Используйте приложение следующим образом:

```powershell
dmgcmd [ -RegisterNewNode "<AuthenticationKey>" -EnableRemoteAccess "<port>" ["<thumbprint>"] -EnableRemoteAccessInContainer "<port>" ["<thumbprint>"] -DisableRemoteAccess -Key "<AuthenticationKey>" -GenerateBackupFile "<filePath>" "<password>" -ImportBackupFile "<filePath>" "<password>" -Restart -Start -Stop -StartUpgradeService -StopUpgradeService -TurnOnAutoUpdate -TurnOffAutoUpdate -SwitchServiceAccount "<domain\user>" ["<password>"] -Loglevel <logLevel> ]
```

Ниже приведены подробные сведения о параметрах и свойствах приложения. 

| Свойство                                                    | Описание                                                  | Обязательно для заполнения |
| ----------------------------------------------------------- | ------------------------------------------------------------ | -------- |
| **Регистерневноде** "`<AuthenticationKey>`"                     | Регистрация узла локальной среды выполнения интеграции с указанным ключом проверки подлинности. | Нет       |
| **Енаблеремотеакцесс** "`<port>`" ["`<thumbprint>`"]            | Включите удаленный доступ на текущем узле, чтобы настроить кластер с высоким уровнем доступности. Или включить учетные данные непосредственно для локальной среды IR без использования фабрики данных Azure. Второй вариант выполняется с помощью командлета **New-AzDataFactoryV2LinkedServiceEncryptedCredential** на удаленном компьютере в той же сети. | Нет       |
| **Енаблеремотеакцессинконтаинер** "`<port>`" ["`<thumbprint>`"] | Включите удаленный доступ к текущему узлу, когда узел выполняется в контейнере. | Нет       |
| **дисаблеремотеакцесс**                                         | Отключить удаленный доступ к текущему узлу. Удаленный доступ необходим для многоузловой установки. Командлет PowerShell **New-AzDataFactoryV2LinkedServiceEncryptedCredential** работает, даже если удаленный доступ отключен. Это поведение имеет значение true, если командлет выполняется на том же компьютере, где размещена локальная IR-узел. | Нет       |
| **Ключ** "`<AuthenticationKey>`"                                 | Перезапишите или обновите предыдущий ключ проверки подлинности. Будьте внимательны с этим действием. Предыдущий узел IR может переходить в режим «вне сети», если ключ является новой средой выполнения интеграции. | Нет       |
| **Женератебаккупфиле** "`<filePath>`"`<password>`"            | Создать файл резервной копии для текущего узла. Файл резервной копии содержит ключ узла и учетные данные хранилища данных. | Нет       |
| **Импортбаккупфиле** "`<filePath>`"`<password>`"              | Восстановите узел из файла резервной копии.                          | Нет       |
| **Перезапуск**                                                     | Перезапустите службу узла локальной среды выполнения интеграции.   | Нет       |
| **Начало**                                                       | Запустите службу узла локальной среды выполнения интеграции.     | Нет       |
| **Остановить**                                                        | Завершите работу службы узла локальной среды выполнения интеграции.        | Нет       |
| **стартупградесервице**                                         | Запустите службу обновления локальной среды выполнения интеграции.       | Нет       |
| **стопупградесервице**                                          | Останавливает службу обновления локальной среды выполнения интеграции.        | Нет       |
| **турнонаутаупдате**                                            | Включите автоматическое обновление среды выполнения интеграции с локальным размещением.        | Нет       |
| **турноффаутаупдате**                                           | Отключите автоматическое обновление среды выполнения интеграции с локальным размещением.       | Нет       |
| **Свитчсервицеаккаунт** "`<domain\user>`" ["`<password>`"]           | Настройте DIAHostService для запуска от имени новой учетной записи. Используйте пустой пароль "" для системных учетных записей и виртуальных учетных записей. | Нет       |
| **Loglevel** `<logLevel>`                                       | Задайте для уровня журнала трассировки событий Windows (ETW) значение **Off**, **Error**, **verbose**или **ALL**. Это свойство главным образом используется специалистами по служба поддержки Майкрософт при отладке установки. | Нет       |

## <a name="command-flow-and-data-flow"></a>Поток команд и поток данных

При перемещении данных между локальной средой и облаком для передачи данных между локальным источником данных и облаком в действии используется самостоятельная среда выполнения интеграции.

Ниже приведен общий обзор действий потока данных для копирования с помощью локальной среды IR:

![Общий обзор потока данных](media/create-self-hosted-integration-runtime/high-level-overview.png)

1. Разработчик данных создает локальную среду выполнения интеграции в фабрике данных Azure с помощью командлета PowerShell. В настоящее время портал Azure не поддерживает эту функцию.
1. Разработчик данных создает связанную службу для локального хранилища данных. Разработчик делает это, указывая экземпляр локальной среды выполнения интеграции, который служба должна использовать для подключения к хранилищам данных.
1. Узел локальной среды выполнения интеграции шифрует учетные данные с помощью программного интерфейса защиты данных (API защиты данных) и сохраняет учетные данные локально. Если вы настроили несколько узлов для обеспечения высокой доступности, учетные данные дополнительно синхронизируются между этими узлами. Каждый узел шифрует учетные данные с помощью API защиты данных и сохраняет их локально. Синхронизация учетных данных выполняется локальной средой выполнения интеграции, и разработчик данных может отслеживать этот процесс.
1. Фабрика данных Azure взаимодействует с локальной средой выполнения интеграции для планирования заданий и управления ими. Обмен данными осуществляется через канал управления, использующий общее подключение [ретранслятора служебной шины Azure](https://docs.microsoft.com/azure/service-bus-relay/relay-what-is-it#wcf-relay) . Когда необходимо запустить задание действия, фабрика данных помещает запрос в очередь вместе с любыми учетными данными. Это делается в том случае, если учетные данные еще не хранятся в локальной среде выполнения интеграции. Локальная среда выполнения интеграции запускает задание после опроса очереди.
1. Самостоятельная среда выполнения интеграции копирует данные между локальным хранилищем и облачным хранилищем. Направление копирования зависит от того, как действие копирования настроено в конвейере данных. Для этого шага локальная среда выполнения интеграции напрямую взаимодействует с облачными службами хранения, такими как хранилище BLOB-объектов Azure, по защищенному каналу HTTPS.

## <a name="considerations-for-using-a-self-hosted-ir"></a>Рекомендации по использованию локальной среды выполнения интеграции

- Можно использовать одну локальную среду выполнения интеграции для нескольких локальных источников данных. Вы также можете поделиться им с другой фабрикой данных в том же клиенте Azure Active Directory (Azure AD). Дополнительные сведения см. в разделе о [совместном использовании локальной среды выполнения интеграции](#create-a-shared-self-hosted-integration-runtime-in-azure-data-factory).
- На любой отдельный компьютер можно установить только один экземпляр локальной среды выполнения интеграции. Если у вас есть две фабрики данных, которым требуется доступ к локальным источникам данных, используйте [функцию совместного доступа](#create-a-shared-self-hosted-integration-runtime-in-azure-data-factory) к локальной среде для совместного размещения ИК-связи или установите локально РАЗМЕЩЕНное IR-соединение на двух локальных компьютерах, по одному для каждой фабрики данных.  
- Локальная среда выполнения интеграции не должна находиться на том же компьютере, что и источник данных. Однако, если локальная среда выполнения интеграции близка к источнику данных, сокращается время, в течение которого локальная среда выполнения интеграции подключается к источнику данных. Рекомендуется установить локальную среду выполнения интеграции на компьютере, отличающемся от того, на котором размещен локальный источник данных. Если локальная среда выполнения интеграции и источник данных находятся на разных компьютерах, то локальная среда выполнения интеграции не конкурирует с источником данных для ресурсов.
- Вы можете установить несколько локальных сред выполнения интеграции на разных компьютерах и подключить их к одному локальному источнику данных. Например, при наличии двух локальных сред выполнения интеграции, обслуживающих две фабрики данных, один и тот же локальный источник данных можно зарегистрировать в обеих фабриках данных.
- Если на компьютере уже установлен шлюз для обслуживания Power BI, установите отдельную локальную среду выполнения интеграции для фабрики данных на другом компьютере.
- Используйте локальную среду выполнения интеграции для поддержки интеграции данных в виртуальной сети Azure.
- Источник данных следует считать локальным и находящимся за брандмауэром, даже если используется Azure ExpressRoute. Используйте локальную среду выполнения интеграции для подключения службы к источнику данных.
- Используйте локальную среду выполнения интеграции, даже если хранилище данных находится в облаке на виртуальной машине Azure "инфраструктура как услуга" (IaaS).
- Задачи могут завершиться ошибкой в локальной среде выполнения интеграции, установленной на сервере Windows Server, для которого включено шифрование, совместимое с FIPS. Чтобы устранить эту проблему, отключите на сервере шифрование, совместимое с FIPS. Чтобы отключить шифрование, совместимое с FIPS, измените значение следующего подраздела реестра с 1 (включено) на 0 (отключено): `HKLM\System\CurrentControlSet\Control\Lsa\FIPSAlgorithmPolicy\Enabled`.

## <a name="prerequisites"></a>Технические условия

- Поддерживаются следующие версии Windows:
  + Windows 7 с пакетом обновления 1
  + Windows 8.1
  + Windows 10
  + Windows Server 2008 R2 с пакетом обновления 1;
  + Windows Server 2012
  + Windows Server 2012 R2
  + Windows Server 2016
  + Windows Server 2019
   
   Установка локальной среды выполнения интеграции на контроллере домена не поддерживается.
- Требуется .NET Framework 4.6.1 или более поздней версии. Если локальная среда выполнения интеграции устанавливается на компьютер под управлением Windows 7, установите .NET Framework 4.6.1 или более поздней версии. Дополнительные сведения см. в разделе [Требования к системе для .NET Framework](/dotnet/framework/get-started/system-requirements).
- Рекомендуемая минимальная конфигурация для компьютера с локальной средой выполнения интеграции — процессор с тактовой частотой 2 ГГц с четырьмя ядрами, 8 ГБ ОЗУ и 80 ГБ свободного пространства на жестком диске.
- Если хост-компьютер находится в спящем режиме, локальная среда выполнения интеграции не реагирует на запросы данных. Перед установкой локальной среды выполнения интеграции на компьютере следует настроить соответствующую схему управления питанием. Если компьютер настроен на режим гибернации, установщик локальной среды выполнения интеграции запрашивает сообщение.
- Для успешной установки и настройки локальной среды выполнения интеграции требуются права администратора на компьютере.
- Операции копирования-действия выполняются с определенной частотой. Использование процессора и ОЗУ на компьютере соответствует тому же шаблону, что и пиковое время простоя. Использование ресурсов также зависит интенсивно от объема перемещаемых данных. Когда выполняется несколько заданий копирования, в пиковые периоды уровень использования ресурсов системы повышается.
- При извлечении данных в форматах Parquet, ORC или Avro могут возникать сбои. Дополнительные сведения о Parquet см. [в статье формат Parquet в фабрике данных Azure](https://docs.microsoft.com/azure/data-factory/format-parquet#using-self-hosted-integration-runtime). Создание файлов выполняется на компьютере интеграции с локальным размещением. Для работы при создании файла необходимо выполнить следующие предварительные требования.
    - [Распространяемый пакет Visual C++ 2010](https://download.microsoft.com/download/3/2/2/3224B87F-CFA0-4E70-BDA3-3DE650EFEBA5/vcredist_x64.exe) Пакет (x64)
    - Среда выполнения Java (JRE) версии 8 от поставщика JRE, например, [внедрения OpenJDK](https://adoptopenjdk.net/). Убедитесь, что задана переменная среды `JAVA_HOME`.

## <a name="installation-best-practices"></a>Рекомендации по установке

Локальную среду выполнения интеграции можно установить, загрузив пакет установки MSI из [центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=39717). Пошаговые инструкции см. в статье [Перемещение данных между локальными средами и облаком](tutorial-hybrid-copy-powershell.md) .

- Настройте схему управления питанием на размещающем компьютере для локальной среды выполнения интеграции, чтобы компьютер не был в спящем режиме. Если хост-компьютер перейдет в режим гибернации, локальная среда выполнения интеграции будет отключена.
- Регулярно создавайте резервные копии учетных данных, связанных с локальной средой выполнения интеграции.
- Сведения об автоматизации автономных операций настройки ИК-связи см. в статье [Настройка существующего саморазмещенного ИК-соединения с помощью PowerShell](#setting-up-a-self-hosted-integration-runtime).  

## <a name="install-and-register-a-self-hosted-ir-from-microsoft-download-center"></a>Установка и регистрация самостоятельно размещенного IR в центре загрузки Майкрософт

1. Перейдите на [страницу загрузки среды выполнения интеграции Майкрософт](https://www.microsoft.com/download/details.aspx?id=39717).
1. Выберите **скачать**, выберите 64-разрядную версию и нажмите кнопку **Далее**. 32-разрядная версия не поддерживается.
1. Запустите файл MSI напрямую или сохраните его на жестком диске и запустите его.
1. В окне **приветствия** выберите язык и нажмите кнопку **Далее**.
1. Примите условия лицензионного соглашения об использовании программного обеспечения Майкрософт и выберите **Далее**.
1. Выберите **папку** для установки локальной среды выполнения интеграции и нажмите кнопку **Далее**.
1. На странице **Готово к установке** выберите **Установить**.
1. Нажмите кнопку **Готово** , чтобы завершить установку.
1. Получите ключ проверки подлинности с помощью PowerShell. Ниже представлен код PowerShell для получения ключа проверки подлинности.

    ```powershell
    Get-AzDataFactoryV2IntegrationRuntimeKey -ResourceGroupName $resourceGroupName -DataFactoryName $dataFactoryName -Name $selfHostedIntegrationRuntime
    ```

1. В окне **регистрация Integration Runtime (Self-hosted)** Microsoft Integration Runtime Configuration Manager, выполняющихся на компьютере, выполните следующие действия.

    1. Вставьте в текстовое поле ключ проверки подлинности.

    1. Чтобы просмотреть текст ключа, щелкните **Show authentication key** (Показать ключ проверки подлинности).

    1. Выберите **Зарегистрировать**.

## <a name="high-availability-and-scalability"></a>Высокий уровень доступности и масштабируемости

Можно связать локальную среду выполнения интеграции с несколькими локальными компьютерами или виртуальными машинами в Azure. Такие компьютеры называются узлами. Для локальной среды выполнения интеграции можно использовать до четырех узлов. Ниже приведены преимущества использования нескольких узлов на локальных компьютерах, на которых установлен шлюз для логического шлюза.

* Более высокая доступность локальной среды выполнения интеграции, поэтому она больше не является единственной точкой отказа в решении больших данных или интеграции облачных данных с фабрикой данных. Эта доступность позволяет обеспечить непрерывность при использовании до четырех узлов.
* Повышение производительности и пропускной способности при перемещении данных между локальными и облачными хранилищами данных. Узнайте больше о [сравнении производительности](copy-activity-performance.md).

Можно связать несколько узлов, установив программное обеспечение локальной среды выполнения интеграции из [центра загрузки](https://www.microsoft.com/download/details.aspx?id=39717). Затем зарегистрируйте его с помощью любого из ключей проверки подлинности, полученных из командлета **New-AzDataFactoryV2IntegrationRuntimeKey** , как описано в этом [руководстве](tutorial-hybrid-copy-powershell.md).

> [!NOTE]
> Для связывания каждого узла не нужно создавать локальную среду выполнения интеграции. Вы можете установить эту среду на другом компьютере и зарегистрировать ее, используя тот же ключ проверки подлинности.

> [!NOTE]
> Перед добавлением нового узла для обеспечения высокой доступности и масштабируемости убедитесь, что на первом узле включен параметр **Удаленный доступ к интрасети** . Для этого выберите **Microsoft Integration Runtime Configuration Manager** > **Параметры** > **Удаленный доступ к интрасети**.

### <a name="scale-considerations"></a>Рекомендации по масштабированию

#### <a name="scale-out"></a>Масштабирование

Если загрузка процессора высока, а объем доступной памяти невелик на локальной среде IR, добавьте новый узел, чтобы расширить нагрузку на компьютеры. Если действия не выполнены из-за истечения времени ожидания или автономного узла IR, он помогает при добавлении узла в шлюз.

#### <a name="scale-up"></a>Увеличение масштаба

Если процессор и доступная оперативная память недостаточно загружены, но выполнение параллельных заданий достигает пределов узла, увеличение масштаба путем увеличения числа параллельных заданий, которые может запустить узел. Кроме того, при истечении времени ожидания действий может потребоваться увеличение масштаба, поскольку перегружается локальная IR-среда. Как показано на следующем рисунке, можно увеличить максимальную емкость для узла:  

![Увеличение числа параллельных заданий, которые могут выполняться на узле](media/create-self-hosted-integration-runtime/scale-up-self-hosted-IR.png)

### <a name="tlsssl-certificate-requirements"></a>Требования к TLS- и SSL-сертификатам

Ниже приведены требования к сертификату TLS/SSL, который используется для защиты обмена данными между узлами среды выполнения интеграции.

- Сертификат должен быть общедоступным доверенным сертификатом X509 v3. Рекомендуется использовать сертификаты, выданные центром сертификации общедоступных партнеров (CA).
- Все узлы среды выполнения интеграции должны доверять этому сертификату.
- Не рекомендуется использовать сертификаты альтернативного имени (SAN), так как используется только последний элемент SAN. Все остальные элементы сети SAN игнорируются. Например, если у вас есть сертификат SAN, San которого — **node1.domain.contoso.com** и **NODE2.domain.contoso.com**, этот сертификат можно использовать только на компьютере, полное доменное имя которого — **NODE2.domain.contoso.com**.
- Сертификат может использовать любой размер ключа, поддерживаемый Windows Server 2012 R2 для SSL-сертификатов.
- Сертификаты, использующие ключи CNG, не поддерживаются.  

> [!NOTE]
> Этот сертификат используется:
>
> - Для шифрования портов на автономном узле IR.
> - Для связи между узлами для синхронизации состояния, которая включает синхронизацию связанных служб между узлами.
> - Если командлет PowerShell используется для параметров учетных данных связанной службы из локальной сети.
>
> Мы рекомендуем использовать этот сертификат, если окружение частной сети не защищено или если требуется обеспечить безопасность обмена данными между узлами в частной сети.
>
> Перемещение данных при передаче из локальной среды IR в другие хранилища данных всегда происходит в зашифрованном канале независимо от того, задан ли этот сертификат.

## <a name="create-a-shared-self-hosted-integration-runtime-in-azure-data-factory"></a>Создание общей локальной среды выполнения интеграции в фабрике данных Azure

Вы можете повторно использовать существующую инфраструктуру локальной среды IR, которую вы уже настроили в фабрике данных. Это повторное использование позволяет создать связанную локальную среду выполнения интеграции в другой фабрике данных, ссылаясь на существующий общий объект IR, размещенный на собственном сервере.

Чтобы ознакомиться с введением и демонстрацией этой функции, просмотрите следующее 12-минутное видео:

> [!VIDEO https://channel9.msdn.com/Shows/Azure-Friday/Hybrid-data-movement-across-multiple-Azure-Data-Factories/player]

### <a name="terminology"></a>Термины

- **Общие IR**— это изначально размещенная локальная среда IR, которая работает в физической инфраструктуре.  
- **Связанный IR**— IR, который ссылается на другой общий IR. Связанный IR является логическим IR и использует инфраструктуру другого общедоступного саморазмещенного ИК-соединения.

### <a name="methods-to-share-a-self-hosted-integration-runtime"></a>Методы совместного размещения локальной среды выполнения интеграции

Сведения о совместном использовании локальной среды выполнения интеграции с несколькими фабриками данных см. в статье [Создание общей локальной среды выполнения интеграции](create-shared-self-hosted-integration-runtime-powershell.md) для получения дополнительных сведений.

### <a name="monitoring"></a>Мониторинг

#### <a name="shared-ir"></a>Общие IR

![Варианты поиска общей среды выполнения интеграции](media/create-self-hosted-integration-runtime/Contoso-shared-IR.png)

![Мониторинг общей среды выполнения интеграции](media/create-self-hosted-integration-runtime/contoso-shared-ir-monitoring.png)

#### <a name="linked-ir"></a>Связанный IR

![Варианты поиска связанной среды выполнения интеграции](media/create-self-hosted-integration-runtime/Contoso-linked-ir.png)

![Мониторинг связанной среды выполнения интеграции](media/create-self-hosted-integration-runtime/Contoso-linked-ir-monitoring.png)

### <a name="known-limitations-of-self-hosted-ir-sharing"></a>Известные ограничения общего доступа к локальной среде IR

* Фабрика данных, в которой создается связанный IR-файл, должна иметь [MSI](https://docs.microsoft.com/azure/active-directory/managed-service-identity/overview). По умолчанию фабрики данных, созданные в портал Azure или командлетах PowerShell, имеют неявно созданный MSI. Но при создании фабрики данных с помощью шаблона Azure Resource Manager или пакета SDK необходимо явно задать свойство **Identity** . Этот параметр гарантирует, что диспетчер ресурсов создаст фабрику данных, содержащую MSI.

* Пакет SDK для .NET фабрики данных, поддерживающий эту функцию, должен иметь версию 1.1.0 или более позднюю.

* Чтобы предоставить разрешение, требуется роль владельца или Наследуемая роль владельца в фабрике данных, где существует общий IR.

* Функция общего доступа работает только для фабрик данных в одном клиенте Azure AD.

* Для [гостевых пользователей](https://docs.microsoft.com/azure/active-directory/governance/manage-guest-access-with-access-reviews)Azure AD функция поиска в пользовательском интерфейсе, в которой перечислены все фабрики данных с помощью ключевого слова поиска, [не работает](https://msdn.microsoft.com/library/azure/ad/graph/howto/azure-ad-graph-api-permission-scopes#SearchLimits). Но при условии, что гостевой пользователь является владельцем фабрики данных, вы можете совместно использовать IR без функции поиска. Для MSI-файла фабрики данных, которому требуется предоставить общий доступ к IR, введите этот MSI в поле **назначить разрешение** и выберите **Добавить** в пользовательском интерфейсе фабрики данных.

  > [!NOTE]
  > Эта функция доступна только в фабрике данных версии 2.

## <a name="notification-area-icons-and-notifications"></a>Значки и уведомления в области уведомлений

При наведении курсора на значок или сообщение в области уведомлений можно просмотреть сведения о состоянии локальной среды выполнения интеграции.

![Уведомления в области уведомлений](media/create-self-hosted-integration-runtime/system-tray-notifications.png)

## <a name="ports-and-firewalls"></a>Порты и брандмауэры

Есть два брандмауэра, которые следует учитывать:

- *Корпоративный брандмауэр* , который работает на центральном маршрутизаторе Организации;
- *Брандмауэр Windows* , настроенный в качестве управляющей программы на локальном компьютере, где установлена локальная среда выполнения интеграции

![Брандмауэры](media/create-self-hosted-integration-runtime/firewall.png)

На уровне корпоративного брандмауэра необходимо настроить следующие домены и исходящие порты:

[!INCLUDE [domain-and-outbound-port-requirements](../../includes/domain-and-outbound-port-requirements.md)]

На уровне брандмауэра Windows или компьютера эти исходящие порты обычно включены. Если это не так, домены и порты можно настроить на компьютере с локальной средой выполнения интеграции.

> [!NOTE]
> В зависимости от источника и приемников может потребоваться разрешить дополнительные домены и исходящие порты в корпоративном брандмауэре или брандмауэре Windows.
>
> Для некоторых облачных баз данных, таких как база данных SQL Azure и Azure Data Lake, может потребоваться разрешить IP-адреса на компьютерах локальной среды выполнения интеграции в конфигурации брандмауэра.

### <a name="copy-data-from-a-source-to-a-sink"></a>Копирование данных из источника в приемник

Убедитесь, что вы правильно включили правила брандмауэра для корпоративного брандмауэра, брандмауэра Windows на компьютере локальной среды выполнения интеграции и самого хранилища данных. Включение этих правил позволяет локальной среде выполнения интеграции успешно подключаться к источнику и приемнику. Активируйте правила для каждого хранилища данных, задействованного в операции копирования.

Например, чтобы скопировать данные из локального хранилища данных в приемник базы данных SQL или приемник хранилища данных SQL Azure, выполните следующие действия.

1. Разрешите исходящий трафик TCP через порт 1433 для брандмауэра Windows и корпоративного брандмауэра.
1. Настройте параметры брандмауэра базы данных SQL, чтобы добавить IP-адрес компьютера, на котором размещена локальная среда выполнения интеграции, в список разрешенных IP-адресов.

> [!NOTE]
> Если брандмауэр не разрешает исходящий порт 1433, то локальная среда выполнения интеграции не сможет напрямую получить доступ к базе данных SQL. В этом случае можно использовать [промежуточное копирование](copy-activity-performance.md) в базу данных SQL и хранилище данных SQL. В этом сценарии для перемещения данных требуется только протокол HTTPS (порт 443).

## <a name="proxy-server-considerations"></a>Рекомендации для прокси-сервера

Если для доступа в Интернет в вашей корпоративной среде используется прокси-сервер, настройте параметры этого прокси-сервера в локальной среде выполнения интеграции. Прокси-сервер можно настроить на этапе начальной регистрации.

![Укажите прокси-сервер](media/create-self-hosted-integration-runtime/specify-proxy.png)

При настройке локальная среда выполнения интеграции использует прокси-сервер для подключения к источнику и назначению облачной службы (использующей протокол HTTP или HTTPS). Именно поэтому во время начальной настройки выбирается **ссылка изменить** .

![Настройка прокси-сервера](media/create-self-hosted-integration-runtime/set-http-proxy.png)

Доступны три варианта конфигурации.

- **Не использовать прокси-сервер**. локальная среда выполнения интеграции явно не использует прокси-сервер для подключения к облачным службам.
- **Использовать системный прокси-сервер**. локальная среда выполнения интеграции использует параметр прокси-сервера, настроенный в файлах diahost. exe. config и diawp. exe. config. Если в этих файлах не указана конфигурация прокси-сервера, локальная среда выполнения интеграции подключается к облачной службе напрямую, не пробегая через прокси-сервер.
- **Использовать настраиваемый прокси-сервер**. Настройте параметр HTTP-прокси для использования в локальной среде выполнения интеграции вместо использования конфигураций в файлах diahost. exe. config и diawp. exe. config. Значения **адреса** и **порта** являются обязательными. Значения **имени пользователя** и **пароля** необязательны в зависимости от настройки проверки подлинности прокси-сервера. Все параметры шифруются с помощью Windows DPAPI в локальной среде выполнения интеграции и хранятся локально на компьютере.

Служба узла среды выполнения интеграции автоматически перезапускается после сохранения обновленных параметров прокси-сервера.

После регистрации локальной среды выполнения интеграции, если вы хотите просмотреть или изменить параметры прокси-сервера, используйте Microsoft Integration Runtime Configuration Manager.

1. Откройте **диспетчер конфигураций Microsoft Integration Runtime**.
1. Перейдите на вкладку **Параметры**.
1. В разделе **прокси-сервер HTTP**щелкните ссылку **изменить** , чтобы открыть диалоговое окно **Установка прокси-сервера HTTP** .
1. Щелкните **Далее**. Вы увидите предупреждение о том, что у вас есть разрешение на сохранение параметра прокси-сервера, и перезапустите службу узла среды выполнения интеграции.

Для просмотра и обновления прокси-сервера HTTP можно использовать средство диспетчера конфигурации.

![Просмотр и обновление прокси-сервера](media/create-self-hosted-integration-runtime/view-proxy.png)

> [!NOTE]
> При настройке прокси-сервера с проверкой подлинности NTLM служба узла среды выполнения интеграции работает под учетной записью домена. Если позже вы измените пароль для учетной записи домена, не забудьте обновить параметры конфигурации для службы и перезапустить службу. По этой причине мы рекомендуем получить доступ к прокси-серверу с помощью выделенной учетной записи домена, которая не требует частого обновления пароля.

### <a name="configure-proxy-server-settings"></a>Настройка параметров прокси-сервера

Если для прокси-сервера HTTP выбран параметр **использовать системный прокси** -сервер, то локальная среда выполнения интеграции использует параметры прокси-сервера в файлах diahost. exe. config и diawp. exe. config. Если в этих файлах не указан прокси-сервер, локальная среда выполнения интеграции подключается к облачной службе напрямую, не пробегая через прокси-сервер. Ниже приводится процедура обновления файла конфигурации diahost.exe.config:

1. В проводнике Создайте надежную копию папки C:\Program Files\Microsoft Integration Runtime\3.0\Shared\diahost.exe.config в качестве резервной копии исходного файла.
1. Откройте Блокнот с правами администратора.
1. В Блокноте откройте текстовый файл C:\Program Files\Microsoft Integration Runtime\3.0\Shared\diahost.exe.config.
1. Найдите тег **System.NET** по умолчанию, как показано в следующем коде:

    ```xml
    <system.net>
        <defaultProxy useDefaultCredentials="true" />
    </system.net>
    ```
    Затем можно добавить данные прокси-сервера, как показано в следующем примере:

    ```xml
    <system.net>
        <defaultProxy enabled="true">
              <proxy bypassonlocal="true" proxyaddress="http://proxy.domain.org:8888/" />
        </defaultProxy>
    </system.net>
    ```

    Тег прокси позволяет дополнительным свойствам указать необходимые параметры, такие как `scriptLocation`. Синтаксис см. в разделе [\<прокси-\> элемент (параметры сети)](https://msdn.microsoft.com/library/sa91de1e.aspx) .

    ```xml
    <proxy autoDetect="true|false|unspecified" bypassonlocal="true|false|unspecified" proxyaddress="uriString" scriptLocation="uriString" usesystemdefault="true|false|unspecified "/>
    ```
1. Сохраните файл конфигурации в его исходном расположении. Затем перезапустите службу узла локальной среды выполнения интеграции, которая будет принимать изменения.

   Чтобы перезапустить службу, используйте приложение "службы" на панели управления. Или нажмите в диспетчере конфигураций Integration Runtime кнопку **Остановить службу**, а затем выберите **Запустить службу**.

   Если служба не запускается, вероятно, вы добавили в измененный файл конфигурации приложения неверный синтаксис XML-тегов.

> [!IMPORTANT]
> Не забудьте обновить оба файла (diahost.exe.config и diawp.exe.config).

Также необходимо убедиться, что Microsoft Azure находится в списке разрешений вашей компании. Список допустимых IP-адресов Azure можно скачать в [центре загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=41653).

### <a name="possible-symptoms-for-issues-related-to-the-firewall-and-proxy-server"></a>Возможные симптомы проблем, связанных с брандмауэром и прокси-сервером

Если отображаются сообщения об ошибках, аналогичные приведенным ниже, вероятная причина — неправильная настройка брандмауэра или прокси-сервера. Такая конфигурация предотвращает подключение локальной среды выполнения интеграции к фабрике данных для самостоятельной проверки подлинности. Чтобы убедиться, что брандмауэр и прокси-сервер настроены должным образом, см. предыдущий раздел.

* При попытке зарегистрировать локальную среду выполнения интеграции появляется следующее сообщение об ошибке: "не удалось зарегистрировать этот Integration Runtime узел! Убедитесь, что ключ проверки подлинности допустим, а служба узла службы интеграции запущена на этом компьютере ".
* При открытии диспетчера конфигураций среды выполнения интеграции отображается состояние **Отключено** или **Подключение**. При просмотре журналов событий Windows в разделе **Просмотр событий** > **журналы приложений и служб** > **Microsoft Integration Runtime**отображаются такие сообщения об ошибках:

    ```
    Unable to connect to the remote server
    A component of Integration Runtime has become unresponsive and restarts automatically. Component name: Integration Runtime (Self-hosted).
    ```

### <a name="enable-remote-access-from-an-intranet"></a>Включение удаленного доступа из интрасети

При использовании PowerShell для шифрования учетных данных с сетевого компьютера, отличного от того, где установлена локальная среда выполнения интеграции, можно включить параметр **Удаленный доступ из интрасети** . Если вы запускаете PowerShell для шифрования учетных данных на компьютере, где установлена локальная среда выполнения интеграции, вы не можете включить **Удаленный доступ из интрасети**.

Включите **Удаленный доступ из интрасети** , прежде чем добавлять другой узел для обеспечения высокой доступности и масштабируемости.  

При запуске установки локальной среды выполнения интеграции 3,3 или более поздней версии по умолчанию установщик локальной среды выполнения интеграции отключает **Удаленный доступ из интрасети** на компьютере, где размещена локальная среда выполнения интеграции.

При использовании брандмауэра от партнера или других пользователей можно вручную открыть порт 8060 или настраиваемый пользователем порт. Если при настройке локальной среды выполнения интеграции возникла проблема с брандмауэром, используйте следующую команду, чтобы установить локальную среду выполнения интеграции без настройки брандмауэра.

```
msiexec /q /i IntegrationRuntime.msi NOFIREWALL=1
```

Если вы решили не открывать порт 8060 на компьютере, где размещена локальная среда выполнения интеграции, используйте механизмы, отличные от приложения учетные данные, для настройки учетных данных хранилища данных. Например, можно использовать командлет PowerShell **New-AzDataFactoryV2LinkedServiceEncryptCredential** .

## <a name="next-steps"></a>Дальнейшие действия

Пошаговые инструкции см. в разделе [учебник. Копирование локальных данных в облако](tutorial-hybrid-copy-powershell.md).
