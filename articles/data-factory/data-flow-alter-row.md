---
title: Преобразование изменения строк в потоке данных для сопоставления
description: Сведения о том, как изменить целевой объект базы данных с помощью преобразования изменения строк в потоке данных для сопоставления
author: kromerm
ms.author: makromer
ms.reviewer: daperlov
ms.service: data-factory
ms.topic: conceptual
ms.custom: seo-lt-2019
ms.date: 05/06/2020
ms.openlocfilehash: c3858756a0140481c0ab249e29c95f76c4b90da5
ms.sourcegitcommit: 999ccaf74347605e32505cbcfd6121163560a4ae
ms.contentlocale: ru-RU
ms.lasthandoff: 05/08/2020
ms.locfileid: "82982655"
---
# <a name="alter-row-transformation-in-mapping-data-flow"></a>Преобразование изменения строк в потоке данных для сопоставления

[!INCLUDE[appliesto-adf-asa-md](includes/appliesto-adf-asa-md.md)]

Преобразование изменения строк позволяет задать для строк политики вставки, удаления, обновления и вставки с обновлением. В качестве выражений можно добавить условия "один ко многим". Эти условия следует указывать в порядке приоритета, так как для каждой строки будет выбрана политика, заданная первым из подходящих выражений сопоставления. Каждое из этих условий может вызвать вставку, обновление, удаление или вставку с обновлением одной или нескольких строк. С помощью инструкции изменения строк можно создавать в базе действия DDL и DML.

![Параметры изменения строк](media/data-flow/alter-row1.png "Параметры изменения строк")

Преобразования изменения строк применимы только к приемникам баз данных или CosmosDB, размещенным в потоке данных. Назначаемые строкам действия (вставка, обновление, удаление или вставка с обновлением) не будут выполняться во время сеансов отладки. Активируйте в конвейере действие выполнения потока данных, чтобы применить политики изменения строк к таблицам базы данных.

> [!VIDEO https://www.microsoft.com/en-us/videoplayer/embed/RE4vJYc]

## <a name="specify-a-default-row-policy"></a>Указание политики строк по умолчанию

Создайте преобразование изменения строк и укажите политику строк с условием `true()`. Каждая строка, которая не соответствует ни одному из ранее определенных выражений, будет помечена указанной политикой строк. По умолчанию отметку `Insert` получает каждая строка, не соответствующая ни одному из условных выражений.

![Политика изменения строк](media/data-flow/alter-row4.png "Политика изменения строк")

> [!NOTE]
> Чтобы пометить все строки одной политикой, создайте условие для этой политики и обозначьте это условие как `true()`.

## <a name="view-policies-in-data-preview"></a>Просмотр политик в режиме предварительного просмотра данных

Используйте [режим отладки](concepts-data-flow-debug-mode.md), чтобы в области просмотра данных изучить результаты применения политик изменения строк. Предварительный просмотр данных для преобразования изменения строк не приводит к созданию действий DDL или DML для целевого объекта.

![Политики изменения строк](media/data-flow/alter-row3.png "Политики изменения строк")

Каждая политика изменения строк представляется значком, который обозначает, будет ли выполняться операция вставки, обновления, вставки с обновлением или удаления. В верхнем колонтитуле области просмотра показано количество строк, затронутых каждой политикой.

## <a name="allow-alter-row-policies-in-sink"></a>Включение политик изменения строк в приемнике

Чтобы политики изменения строк работали, поток данных должен записывать данные в приемник, представляющий базу данных или Cosmos. На вкладке **Параметры** для этого приемника укажите, какие политики изменения строк допустимы для этого приемника.

![Приемник изменения строк](media/data-flow/alter-row2.png "Приемник изменения строк")

По умолчанию допускаются только политики вставки. Чтобы разрешить обновления, вставки с обновлением и (или) удаления, установите для приемника флажки, соответствующие этим условиям. Если вы разрешите операции обновления, вставки с обновлением и (или) удаления, необходимо указать в приемнике ключевые столбцы, по которым проверяется соответствие.

> [!NOTE]
> Если при операциях вставки, обновления или вставки с обновлением будет выполняться попытка изменить схему целевой таблицы в приемнике, поток данных завершится ошибкой. Чтобы изменить схему целевой таблицы в базе данных, выберите действие **повторного создания таблицы**. Это действие позволяет удалить таблицу и заново создать ее с новым определением схемы.

Чтобы преобразовать приемник, необходимо указать один или несколько ключей для уникальной идентификации строк в целевой базе данных. Для приемников SQL ключи задаются на вкладке параметров приемника. Для Cosmos DB ключ секции можно задать в параметрах, одновременно указав системное поле "id" из Cosmos DB в сопоставлении приемника. Для Cosmos DB системный столбец "id" является обязательным для операций обновления, вставки с обновлением и (или) удаления.

## <a name="merges-and-upserts-with-azure-sql-database-and-synapse"></a>Операции слияния и вставки с обновлением в Базе данных SQL Azure и Synapse

Потоки данных ADF поддерживают операции слияния для Базы данных SQL Azure и пула баз данных Synapse (хранилище данных) с возможностью вставки с обновлением (upsert).

Но иногда схема целевой базы данных использует свойство identity из ключевых столбцов. ADF требует указать ключи, которые будут использоваться для сопоставления значений строк при операциях обновления и удаления. Но если для целевого столбца задано свойство identity и используется политика upsert, целевая база данных не позволит выполнять запись в такой столбец. Кроме того, могут возникнуть ошибки при попытке вставки с обновлением, которая затрагивает столбец распределения распределенной таблицы.

Устранить эту проблему можно следующими способами:

1. Откройте параметры преобразования для этого приемника и установите флажок Skip writing key columns (Пропустить запись ключевых столбцов). В этом случае ADF не будет записывать столбец, выбранный в качестве значения ключа для сопоставления.

2. Если это не тот ключевой столбец, который вызывает ошибку для столбцов идентификаторов, попробуйте применить параметр SQL для предварительной обработки преобразования приемника: ```SET IDENTITY_INSERT tbl_content ON```. Затем отключите его с помощью свойства SQL для пост-обработки: ```SET IDENTITY_INSERT tbl_content OFF```.

3. Для обоих вариантов (с использованием свойства identity или столбца распределения) можно изменить логику, заменив Upsert отдельными условиями обновления и вставки через преобразование условного разбиения. Так вы можете задать для пути обновления сопоставление, в котором игнорируется сопоставление ключевых столбцов.

## <a name="data-flow-script"></a>Скрипт потока данных

### <a name="syntax"></a>Синтаксис

```
<incomingStream>
    alterRow(
           insertIf(<condition>?),
           updateIf(<condition>?),
           deleteIf(<condition>?),
           upsertIf(<condition>?),
        ) ~> <alterRowTransformationName>
```

### <a name="example"></a>Пример

Ниже приведен пример преобразования изменения строк с именем `CleanData`. В примере принимается входящий поток `SpecifyUpsertConditions` и создается три условия изменения строк. В предыдущем преобразовании вычисляется столбец с именем `alterRowCondition`, который определяет, будет ли выполняться операция обновления, вставки с обновлением и (или) удаления в базе данных. Если в этом столбце указано строковое значение, соответствующее правилу изменения строк, назначается политика из этого правила.

В интерфейсе Фабрики данных это преобразование выглядит следующим образом:

![Пример изменения строк](media/data-flow/alter-row4.png "Пример изменения строк")

Скрипт потока данных для этого преобразования представлен в следующем фрагменте кода:

```
SpecifyUpsertConditions alterRow(insertIf(alterRowCondition == 'insert'),
    updateIf(alterRowCondition == 'update'),
    deleteIf(alterRowCondition == 'delete')) ~> AlterRow
```

## <a name="next-steps"></a>Дальнейшие действия

После преобразования изменения строк, возможно, потребуется [передать данные в целевое хранилище данных](data-flow-sink.md).
