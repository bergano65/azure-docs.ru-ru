---
title: Сопоставление схем в действии копирования | Документация Майкрософт
description: Узнайте, как действие копирования в фабрике данных Azure сопоставляет схемы и типы исходных данных с данными приемника во время копирования данных.
services: data-factory
documentationcenter: ''
author: linda33wj
manager: craigg
ms.reviewer: douglasl
ms.service: data-factory
ms.workload: data-services
ms.tgt_pltfrm: na
ms.topic: conceptual
ms.date: 12/20/2018
ms.author: jingwang
ms.openlocfilehash: c2f58a3510699cdf74e3150d3ad5882929f4f05b
ms.sourcegitcommit: a408b0e5551893e485fa78cd7aa91956197b5018
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/17/2019
ms.locfileid: "54358717"
---
# <a name="schema-mapping-in-copy-activity"></a>Сопоставление схем в действии копирования
Эта статья содержит сведения о том, как действие копирования фабрики данных Azure сопоставляет схемы и типы исходных данных с данными приемника во время выполнения копирования данных.

## <a name="column-mapping"></a>Сопоставление столбцов

Сопоставление столбцов применяется при копировании данных из одной табличной формы в другую. По умолчанию действие копирования **сопоставляет исходные данные с данными приемника по именам столбцов**, если только не настроено [явное сопоставление столбцов](#explicit-column-mapping). В частности, действие копирования выполняет следующие задачи:

1. Считывает данные из источника и определяет исходную схему.

    * Для источников данных с предопределенной схемой в хранилище данных или формате файла, например базы данных или файлы с метаданными (Avro, ORC, Parquet или текст с заголовком), исходная схема извлекается из результата запроса или метаданных файла.
    * Для источников данных с гибкой схемой, например таблица Azure или база данных Cosmos DB, исходная схема выводится из результата запроса. Это можно изменить, задав параметр structure в наборе данных.
    * Для текстового файла без заголовка имена столбцов по умолчанию создаются с помощью шаблонов Prop_0 и Prop_1. Это можно изменить, задав параметр structure в наборе данных.
    * Для источника Dynamics необходимо предоставить сведения о схеме в разделе набора данных structure.

2. Выполняет явное сопоставление столбцов, если указано.

3. Записывает данные в приемник.

    * Для хранилищ данных с предопределенной схемой данные записываются в столбцы с одинаковым именем.
    * Для хранилищ данных без фиксированной схемы и форматов файла имена столбцов и метаданные будут созданы на основе исходной схемы.

### <a name="explicit-column-mapping"></a>Явное сопоставление столбцов

Вы можете задать свойство **columnMappings** в разделе **typeProperties** действия копирования, чтобы выполнить явное сопоставление столбцов. В этом сценарии раздел structure является обязательным для входных и выходных наборов данных. Функция сопоставления столбцов поддерживает сопоставление **всех или подмножества столбцов в разделе structure набора данных, используемого в качестве источника, со всеми столбцами в разделе structure набора данных, используемого в качестве приемника**. Ниже приведены неправильные условия, которые приводят к порождению исключения.

* В результате запроса исходного хранилища данных нет имени столбца, указанного в разделе structure входного набора данных.
* Приемник данных (если имеется предопределенная схема) не содержит имя столбца, указанное в разделе structure выходного набора данных.
* Меньше или больше столбцов в structure набора данных приемника, чем указано в сопоставлении.
* Повторяющееся сопоставление.

#### <a name="explicit-column-mapping-example"></a>Пример явного сопоставления столбцов

В этом примере входная таблица имеет структуру, и она указывает на таблицу в локальной базе данных SQL.

```json
{
    "name": "SqlServerInput",
    "properties": {
        "structure":
         [
            { "name": "UserId"},
            { "name": "Name"},
            { "name": "Group"}
         ],
        "type": "SqlServerTable",
        "linkedServiceName": {
            "referenceName": "SqlServerLinkedService",
            "type": "LinkedServiceReference"
        },
        "typeProperties": {
            "tableName": "SourceTable"
        }
    }
}
```

В этом примере выходная таблица имеет структуру, и она указывает на таблицу в локальной базе данных SQL Azure.

```json
{
    "name": "AzureSqlOutput",
    "properties": {
        "structure":
        [
            { "name": "MyUserId"},
            { "name": "MyName" },
            { "name": "MyGroup"}
        ],
        "type": "AzureSqlTable",
        "linkedServiceName": {
            "referenceName": "AzureSqlLinkedService",
            "type": "LinkedServiceReference"
        },
        "typeProperties": {
            "tableName": "SinkTable"
        }
    }
}
```

Ниже приведен фрагмент JSON, который определяет действие копирования в конвейере. Столбцы из источника сопоставляются со столбцами в приемнике (**ColumnMappings**) с помощью свойства **Translator**.

```json
{
    "name": "CopyActivity",
    "type": "Copy",
    "inputs": [
        {
            "referenceName": "SqlServerInput",
            "type": "DatasetReference"
        }
    ],
    "outputs": [
        {
            "referenceName": "AzureSqlOutput",
            "type": "DatasetReference"
        }
    ],
    "typeProperties":    {
        "source": { "type": "SqlSource" },
        "sink": { "type": "SqlSink" },
        "translator":
        {
            "type": "TabularTranslator",
            "columnMappings": 
            {
                "UserId": "MyUserId",
                "Group": "MyGroup",
                "Name": "MyName"
            }
        }
    }
}
```

Если вы используете синтаксис `"columnMappings": "UserId: MyUserId, Group: MyGroup, Name: MyName"`, чтобы указать сопоставление столбцов, оно будет поддерживаться без изменений.

**Процесс сопоставления столбцов:**

![Процесс сопоставления столбцов](./media/copy-activity-schema-and-type-mapping/column-mapping-sample.png)

## <a name="schema-mapping"></a>Сопоставление схем

Сопоставление схем применяется при копировании данных из иерархической в табличную форму или наоборот, например при копировании из MongoDB или REST в текстовый файл, а также при копирование из SQL в API Azure Cosmos DB для MongoDB. В разделе `translator` действия копирования поддерживаются следующие свойства.

| Свойство | ОПИСАНИЕ | Обязательно |
|:--- |:--- |:--- |
| Тип | Свойство типа преобразователя действия копирования должно иметь следующее значение. **TabularTranslator** | Yes |
| schemaMapping | Коллекция пар "ключ — значение", которая представляет отношение сопоставления между табличными и иерархическими данными.<br/>- **Ключ:** имя столбца табличных данных, заданное в структуре набора данных.<br/>- **Значение:** выражение пути JSON для каждого поля, которое используется для извлечения и сопоставления данных. Для полей в области корневого объекта выражение пути должно начинаться с корня $. Для полей внутри массива, выбранных с помощью свойства `collectionReference`, выражение должно начинаться с элемента массива.  | Yes |
| collectionReference | Для итерации и извлечения данных из объектов **в поле массива** с таким же шаблоном и построчного преобразования этих данных по каждому объекту укажите путь JSON массива для перекрестного применения. Это свойство поддерживается только при копировании иерархических данных. | Нет  |

**Пример: копирование из MongoDB в SQL.**

Например, если у вас есть документ MongoDB со следующим содержимым: 

```json
{
    "id": {
        "$oid": "592e07800000000000000000"
    },
    "number": "01",
    "date": "20170122",
    "orders": [
        {
            "prod": "p1",
            "price": 23
        },
        {
            "prod": "p2",
            "price": 13
        },
        {
            "prod": "p3",
            "price": 231
        }
    ],
    "city": [ { "name": "Seattle" } ]
}
```

и вы хотите скопировать его в таблицу Azure SQL в следующем формате путем сведения данных внутри массива *(order_pd и order_price)* и перекрестного соединения с общими сведениями о корневом объекте *(number, date и city)*.

| orderNumber | orderDate | order_pd | order_price | city |
| --- | --- | --- | --- | --- |
| 01 | 20170122 | P1 | 23 | Сиэтл; |
| 01 | 20170122 | P2 | 13 | Сиэтл; |
| 01 | 20170122 | P3 | 231 | Сиэтл; |

Настройте правило сопоставления схем, как в следующем примере JSON действия копирования.

```json
{
    "name": "CopyFromMongoDBToSqlAzure",
    "type": "Copy",
    "typeProperties": {
        "source": {
            "type": "MongoDbV2Source"
        },
        "sink": {
            "type": "SqlSink"
        },
        "translator": {
            "type": "TabularTranslator",
            "schemaMapping": {
                "orderNumber": "$.number", 
                "orderDate": "$.date", 
                "order_pd": "prod", 
                "order_price": "price",
                "city": " $.city[0].name"
            },
            "collectionReference":  "$.orders"
        }
    }
}
```

## <a name="data-type-mapping"></a>Сопоставление типов данных

Действие копирования выполняет сопоставление типов источника с типами приемника. Такое сопоставление выполняется в два этапа.

1. Преобразование собственных типов источников в промежуточные типы данных фабрики данных Azure.
2. Преобразование промежуточных типов данных фабрики данных Azure в собственный тип приемника.

Вы можете найти сопоставление собственного типа с промежуточным типом данных в разделе "Сопоставление типов данных" каждой статьи о соединителях.

### <a name="supported-data-types"></a>Поддерживаемые типы данных.

Фабрика данных поддерживает следующие промежуточные типы форматов. При настройке информации о типе в конфигурации [структуры данных](concepts-datasets-linked-services.md#dataset-structure) можно указать следующие значения.

* Byte[]
* Логическое
* DateTime
* Datetimeoffset
* Decimal
* Double
* Guid
* Int16
* Int32
* Int64
* Single
* Строка
* Timespan

### <a name="explicit-data-type-conversion"></a>Явное преобразование типов данных

При копировании данных в хранилища данных с фиксированной схемой, например SQL Server или Oracle, если источник и приемник имеют разный тип одного и того же столбца, явное преобразование типа должно быть объявлено на стороне источника.

* Для исходного файла, например CSV или Avro, преобразование типа должно быть объявлено через структуру источника с полным списком столбцов (именем столбца на стороне источника и типом на стороне приемника).
* Для реляционного источника (например, SQL или Oracle) преобразование типа должно быть достигнуто посредством явного преобразования типов в инструкции запроса.

## <a name="when-to-specify-dataset-structure"></a>Когда следует указывать набор данных structure

В приведенных ниже сценариях в наборе данных необходимо указать structure.

* Применение [явного преобразования типов данных](#explicit-data-type-conversion) для источников файлов во время копирования (входной набор данных).
* Применение [явного сопоставления столбцов](#explicit-column-mapping) во время копирования (входной и выходной набор данных).
* Копирование из источника Dynamics 365 или Dynamics CRM (входной набор данных).
* Копирование в Cosmos DB в качестве вложенного объекта, если источником не являются JSON-файлы (выходной набор данных).

В приведенных ниже сценариях в наборе данных рекомендуется указать structure.

* Копирование из текстового файла без заголовка (входной набор данных). Вы можете указать имена столбцов для текстового файла, сопоставив их с соответствующими столбцами приемника, чтобы не настраивать явное сопоставление столбцов.
* Копирование из хранилищ данных с гибкой схемой, например таблица Azure и Cosmos DB (входной набор данных), чтобы обеспечить копирование ожидаемых данных (столбцов) вместо того, чтобы позволить действию копирования выводить схему на основе верхних строк во время каждого выполнения действия.


## <a name="next-steps"></a>Дополнительная информация
См. другие статьи о действиях копирования:

- [Действие копирования в фабрике данных Azure](copy-activity-overview.md)
- [Отказоустойчивость действия копирования в фабрике данных Azure](copy-activity-fault-tolerance.md)
- [Руководство по настройке производительности действия копирования](copy-activity-performance.md)
