---
title: Отработка отказа и исправление — кэш Azure для Redis
description: Сведения об отработке отказа, установке исправлений и процессе обновления кэша Azure для Redis.
author: asasine
ms.service: cache
ms.topic: conceptual
ms.date: 10/18/2019
ms.author: adsasine
ms.openlocfilehash: 6ff33bd594181aabc4fd7d55ce33f780a0d06086
ms.sourcegitcommit: 5a8c65d7420daee9667660d560be9d77fa93e9c9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/15/2019
ms.locfileid: "74122188"
---
# <a name="failover-and-patching-for-azure-cache-for-redis"></a>Отработка отказа и исправление для кэша Azure для Redis

Для создания устойчивых и успешных клиентских приложений важно понимать отработку отказа в контексте службы кэша Azure для Redis. Отработка отказа может быть частью плановых операций управления или может быть вызвана незапланированными сбоями оборудования или сети. Частое использование отработки отказа кэша происходит, когда служба управления исходит из кэша Azure для двоичных файлов Redis. В этой статье описывается, что такое отработка отказа, как она происходит при установке исправлений, а также описывается создание отказоустойчивого клиентского приложения.

## <a name="what-is-a-failover"></a>Что такое отработка отказа?

Начнем с обзора отработки отказа для кэша Azure для Redis.

### <a name="a-quick-summary-of-cache-architecture"></a>Краткий обзор архитектуры кэша

Кэш состоит из нескольких виртуальных машин с отдельными частными IP-адресами. Каждая виртуальная машина, также известная как узел, подключается к общей подсистеме балансировки нагрузки с одним виртуальным IP-адресом. Каждый узел запускает серверный процесс Redis и доступен с помощью имени узла и портов Redis. Каждый узел считается узлом главной или реплики. Когда клиентское приложение подключается к кэшу, его трафик проходит через эту подсистему балансировки нагрузки и автоматически направляется на главный узел.

В базовом кэше один узел всегда является главным. В кэше уровня "Стандартный" или "Премиум" существует два узла: один выбирается в качестве главного, а другой — репликой. Так как кэши уровня "Стандартный" и "Премиум" имеют несколько узлов, один узел может быть недоступен, пока другие продолжают обрабатывать запросы. Кластеризованные кэши состоят из множества сегментов, каждый из которых имеет отдельные узлы главной и реплики. Возможно, один сегмент не работает, а остальные остаются доступными.

> [!NOTE]
> Базовый кэш не содержит несколько узлов и не предлагает соглашение об уровне обслуживания (SLA) для его доступности. Базовые кэши рекомендуется использовать только в целях разработки и тестирования. Используйте кэш уровня "Стандартный" или "Премиум" для развертывания с несколькими узлами, чтобы повысить доступность.

### <a name="explanation-of-a-failover"></a>Объяснение отработки отказа

Отработка отказа происходит, когда узел реплики становится главным узлом, а старый главный узел закрывает существующие соединения. После того как главный узел поступает в резервную копию, он заметит изменения в ролях и понизить его до того, как станет репликой. Затем он подключается к новому главному серверу и синхронизирует данные. Отработка отказа может быть запланирована или незапланирована.

*Плановая отработка отказа* выполняется во время системных обновлений, таких как установка исправлений или обновление ОС, а также операции управления, такие как масштабирование и перезагрузка. Поскольку узлы получают предварительное уведомление об обновлении, они могут совместно менять роли и быстро обновлять подсистему балансировки нагрузки изменения. Плановая отработка отказа обычно завершается менее 1 секунды.

*Внеплановая отработка отказа* может произойти из-за сбоя оборудования, сбоя сети или других непредвиденных сбоев главного узла. Узел реплики становится главным, но процесс занимает больше времени. Узел реплики должен сначала определить, что его главный узел недоступен, прежде чем он сможет запустить процесс отработки отказа. Узел реплики также должен проверить, что незапланированный сбой не является временным или локальным, чтобы избежать ненужной отработки отказа. Эта задержка при обнаружении означает, что внеплановая отработка отказа обычно завершается в течение 10 – 15 секунд.

## <a name="how-does-patching-occur"></a>Как происходит исправление?

Служба кэша Azure для службы Redis регулярно обновляет кэш, используя новейшие функции и исправления платформы. Для исправления кэша служба выполняет следующие действия.

1. Служба управления выбирает один узел для исправления.
1. Если выбранный узел является главным узлом, соответствующий узел реплики выполняет совместную повышение уровня. Это повышение считается плановой отработкой отказа.
1. Выбранный узел перезагружается для получения новых изменений и резервного копирования в качестве узла реплики.
1. Узел реплики подключается к главному узлу и синхронизирует данные.
1. По завершении синхронизации данных процесс исправления повторяется для оставшихся узлов.

Поскольку установка исправлений является плановой отработкой отказа, узел реплики быстро становится главным и начинает обслуживать запросы и новые подключения. Базовые кэши не имеют узла реплики и недоступны до завершения обновления. Каждый сегмент кластеризованного кэша обновляется отдельно и не закрывает соединения с другим сегментом.

> [!IMPORTANT]
> Узлы исправлены по одному, чтобы предотвратить потери данных. Базовые кэши будут содержать потери данных. В кластеризованные кэши внесены исправления по одному сегменту за раз.

Несколько кэшей в одной группе ресурсов и регионе также будут исправлены по одному за раз.  Кэши, которые находятся в разных группах ресурсов или в разных регионах, могут быть исправлены одновременно.

Так как полная синхронизация данных происходит до повторения процесса, вероятность потери данных при использовании кэша уровня "Стандартный" или "Премиум" вряд ли будет возникать. Можно дополнительно защититься от потери данных путем [экспорта](cache-how-to-import-export-data.md#export) данных и включения [сохраняемости](cache-how-to-premium-persistence.md).

## <a name="additional-cache-load"></a>Дополнительная загрузка кэша

В случае отработки отказа кэш уровня "Стандартный" и "Премиум" должен реплицировать данные с одного узла на другой. Эта репликация приводит к увеличению нагрузки в памяти сервера и ЦП. Если экземпляр кэша уже загружен, то клиентские приложения могут столкнуться с увеличенной задержкой. В исключительных случаях клиентские приложения могут получить исключения времени ожидания. Чтобы уменьшить влияние этой дополнительной нагрузки, [Настройте](cache-configure.md#memory-policies) параметр `maxmemory-reserved` кэша.

## <a name="how-does-a-failover-affect-my-client-application"></a>Как отработка отказа влияет на мое клиентское приложение?

Количество ошибок, обнаруженных клиентским приложением, зависит от того, сколько операций было отложено для этого подключения во время отработки отказа. Все подключения, направляемые через узел, который закрыл подключения, увидят ошибки. Многие клиентские библиотеки могут вызывать ошибки различных типов при разрыве соединений, в том числе исключения времени ожидания, исключения соединения или исключения сокетов. Количество и тип исключений зависит от того, где в коде пути к коду происходит, когда кэш закрывает свои подключения. Например, операция, которая отправляет запрос, но не получила ответ при отработке отказа, может получить исключение времени ожидания. Новые запросы к закрытому объекту соединения получают исключения подключения до тех пор, пока не будет выполнено повторное подключение.

Большинство клиентских библиотек пытаются повторно подключиться к кэшу, если они настроены для этого. Однако непредвиденные ошибки иногда могут помещают объекты библиотеки в невосстанавливаемое состояние. Если ошибки сохраняются дольше, чем предварительно настроенное время, объект соединения следует создать заново. В Microsoft.NET и других объектно-ориентированных языках повторное создание подключения без перезапуска приложения можно выполнить с помощью [шаблона отложенной\<t\>](https://gist.github.com/JonCole/925630df72be1351b21440625ff2671f#reconnecting-with-lazyt-pattern).

### <a name="how-do-i-make-my-application-resilient"></a>Разделы справки сделать приложение устойчивым?

Так как вы не можете полностью избежать отработки отказа, запишите клиентские приложения для обеспечения устойчивости к разрывам соединений и неудачным запросам. Хотя большинство клиентских библиотек автоматически повторно подключается к конечной точке кэша, некоторые из них пытаются повторить неудачные запросы. В зависимости от сценария приложения может быть целесообразно использовать логику повторных попыток с параметром отхода.

Чтобы проверить устойчивость клиентского приложения, используйте [перезагрузку](cache-administration.md#reboot) в качестве ручного триггера для разрыва соединения. Кроме того, рекомендуется [запланировать обновление](cache-administration.md#schedule-updates) кэша. Сообщите службе управления о необходимости применения исправлений среды выполнения Redis в течение указанных еженедельных окон. Обычно эти окна являются периодами нехватки трафика клиентского приложения, чтобы избежать потенциальных инцидентов.

### <a name="client-network-configuration-changes"></a>Изменение конфигурации сети клиента

Некоторые изменения конфигурации сети на стороне клиента могут вызвать ошибки "нет подключения". К таким изменениям могут относить следующие:

- Переключение виртуального IP-адреса клиентского приложения между промежуточным и рабочим слотами.
- Масштабирование размера или количества экземпляров приложения.

Такие изменения могут вызвать проблемы с подключением, которая длится менее одной минуты. Возможно, клиентское приложение потеряет подключение к другим внешним сетевым ресурсам в дополнение к кэшу Azure для службы Redis.

## <a name="next-steps"></a>Дополнительная информация

- [Запланируйте обновление](cache-administration.md#schedule-updates) кэша.
- Протестируйте устойчивость приложения с помощью [перезагрузки](cache-administration.md#reboot).
- [Настройка](cache-configure.md#memory-policies) резервирования и политик памяти.
