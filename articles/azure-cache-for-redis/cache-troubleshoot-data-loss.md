---
title: Устранение неполадок, связанных с потерей данных, в Кэше Azure для Redis
description: Узнайте, как устранять неполадки, связанные с потерей данных, в Кэше Azure для Redis, такие как частичная или полная утрата ключей, а также истечение срока действия ключа.
author: yegu-ms
ms.author: yegu
ms.service: cache
ms.topic: conceptual
ms.date: 10/17/2019
ms.openlocfilehash: 29492ee6b7bce50c4807a36d0c252e18e6aadf87
ms.sourcegitcommit: 98854e3bd1ab04ce42816cae1892ed0caeedf461
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "88008956"
---
# <a name="troubleshoot-data-loss-in-azure-cache-for-redis"></a>Устранение неполадок, связанных с потерей данных, в Кэше Azure для Redis

В этой статье описывается, как диагностировать фактические и предполагаемые потери данных, которые могут возникнуть в Кэше Azure для Redis.

> [!NOTE]
> Шаги по устранению проблем в этой статье также включают в себя указания по выполнению команд Redis и мониторингу различных метрик производительности. Дополнительные сведения и указания см. в разделе [Дополнительные сведения](#additional-information).
>

## <a name="partial-loss-of-keys"></a>Частичная утрата ключей

Кэш Azure для Redis не удаляет ключи случайным образом, если они сохранены в памяти, но может удалить ключи согласно политикам истечения срока действия или вытеснения, а также при получении явной команды удаления ключа. Ключи, которые были записаны на основной узел в кэше Azure уровня "Премиум" или "Стандартный" для экземпляра Redis, также могут быть недоступны в реплике сразу. Данные реплицируются из основного экземпляра в реплику асинхронным образом и без блокировки.

Если вы обнаружите, что ключи исчезли из кэша, проверьте следующие возможные причины.

| Причина | Описание |
|---|---|
| [Окончание срока действия ключей](#key-expiration) | Ключи удалены, так как для них задано истечение времени ожидания. |
| [Вытеснение ключей](#key-eviction) | Ключи удалены из-за нехватки памяти. |
| [Удаление ключей](#key-deletion) | Ключи удалены с помощью явных команд удаления. |
| [Асинхронная репликация](#async-replication) | Ключи недоступны в реплике из-за задержек репликации данных. |

### <a name="key-expiration"></a>Окончание срока действия ключа

Кэш Azure для Redis удаляет ключ автоматически, если этому ключу назначено время ожидания и этот период истек. Дополнительные сведения об окончании срока действия ключа Redis см. в документации по команде [EXPIRE](https://redis.io/commands/expire). Значения времени ожидания также можно задать с помощью [SET](https://redis.io/commands/set), [SETEX](https://redis.io/commands/setex), [GETSET](https://redis.io/commands/getset) и других команд **\*STORE**.

Чтобы получить данные статистики о числе ключей с истекшим сроком действия, используйте команду [INFO](https://redis.io/commands/info). В разделе `Stats` отображается общее число ключей с истекшим сроком действия. В разделе `Keyspace` содержатся дополнительные сведения о числе ключей с истекшим временем ожидания и средним значением времени ожидания.

```
# Stats

expired_keys:46583

# Keyspace

db0:keys=3450,expires=2,avg_ttl=91861015336
```

Вы также можете просмотреть метрики диагностики для кэша, чтобы определить, существует ли корреляция между моментом, когда пропал ключ, и увеличением числа ключей с истекшим сроком действия. Сведения об использовании уведомлений пространства ключей или команды **MONITOR** для отладки проблем такого вида см. в приложении [Отладка отсутствия данных в пространстве ключей Redis](https://gist.github.com/JonCole/4a249477142be839b904f7426ccccf82#appendix).

### <a name="key-eviction"></a>Вытеснение ключей

Для хранения данных Кэшу Azure для Redis требуется определенный объем памяти. Он очищает ключи, если нужно освободить память. Когда значения **used_memory** или **used_memory_rss** в команде [INFO](https://redis.io/commands/info) приближаются к заданному значению параметра **maxmemory**, Кэш Azure для Redis начинает вытеснять ключи из памяти на основе [политики кэша](https://redis.io/topics/lru-cache).

Количество вытесненных ключей можно отслеживать с помощью команды [INFO](https://redis.io/commands/info).

```
# Stats

evicted_keys:13224
```

Вы также можете просмотреть метрики диагностики для кэша, чтобы определить, существует ли корреляция между моментом, когда пропал ключ, и увеличением числа вытесненных ключей. Сведения об использовании уведомлений пространства ключей или команды **MONITOR** для отладки проблем такого вида см. в приложении [Отладка отсутствия данных в пространстве ключей Redis](https://gist.github.com/JonCole/4a249477142be839b904f7426ccccf82#appendix).

### <a name="key-deletion"></a>Удаление ключей

Клиенты Redis могут использовать команду [DEL](https://redis.io/commands/del) или [HDEL](https://redis.io/commands/hdel), чтобы явно удалить ключи из Кэша Azure для Redis. Число операций удаления можно узнать с помощью команды [INFO](https://redis.io/commands/info). Если были вызваны команды **DEL** или **HDEL**, они будут указаны в разделе `Commandstats`.

```
# Commandstats

cmdstat_del:calls=2,usec=90,usec_per_call=45.00

cmdstat_hdel:calls=1,usec=47,usec_per_call=47.00
```

### <a name="async-replication"></a>Асинхронная репликация

Любой кэш Azure для экземпляра Redis на уровне "Стандартный" или "Премиум" настраивается с помощью основного узла и по крайней мере одной реплики. Данные копируются из основного источника в реплику асинхронно с помощью фонового процесса. На веб-сайте [redis.io](https://redis.io/topics/replication) описано, как работает репликация данных Redis в целом. Если клиенты часто записывают данные в Redis, может произойти частичная утрата данных, так как мгновенное выполнение репликации не гарантируется. Например, если первичный ресурс перестает работать *после того* , как клиент записывает в него ключ, но *до* того, как фоновый процесс сможет отправить этот ключ в реплику, этот ключ будет потерян, когда реплика станет новым первичным экземпляром.

## <a name="major-or-complete-loss-of-keys"></a>Значительная или полная утрата ключей

Если вы обнаружите, что большинство ключей или все ключи исчезли из кэша, проверьте следующие возможные причины.

| Причина | Описание |
|---|---|
| [Очистка ключей](#key-flushing) | Ключи были очищены вручную. |
| [Неправильный выбор базы данных](#incorrect-database-selection) | Кэш Azure для Redis настроен на использование базы данных, отличной от используемой по умолчанию. |
| [Сбой экземпляра Redis](#redis-instance-failure) | Сервер Redis недоступен. |

### <a name="key-flushing"></a>Очистка ключей

Клиенты могут использовать команду [FLUSHDB](https://redis.io/commands/flushdb), чтобы удалить все ключи в *одной* базе данных или [FLUSHALL](https://redis.io/commands/flushall), чтобы удалить все ключи из *всех* баз данных в кэше Redis. Чтобы узнать, очищены ли ключи, используйте команду [INFO](https://redis.io/commands/info). В разделе `Commandstats` показано, была ли вызвана команда **FLUSH**:

```
# Commandstats

cmdstat_flushall:calls=2,usec=112,usec_per_call=56.00

cmdstat_flushdb:calls=1,usec=110,usec_per_call=52.00
```

### <a name="incorrect-database-selection"></a>Неправильный выбор базы данных

Кэш Azure для Redis использует базу данных **db0** по умолчанию. Если переключиться на другую базу данных (например, **db1**) и попытаться считать ключи из нее, то Кэш Azure для Redis не обнаружит их там. Каждая база данных является логически отдельной единицей и содержит разный набор данных. Примените команду [SELECT](https://redis.io/commands/select), чтобы использовать другие доступные базы данных и искать в них ключи.

### <a name="redis-instance-failure"></a>Сбой экземпляра Redis

Redis — это хранилище данных в памяти. Данные хранятся на физических компьютерах или виртуальных машинах, где размещен кэш Redis. Экземпляр Кэша Azure для Redis ценовой категории "Базовый" работает только на отдельной виртуальной машине. Если эта виртуальная машина перестанет работать, все сохраненные в кэше данные будут утеряны. 

Кэши ценовой категории "Стандартный" и "Премиум" обеспечивают более высокую устойчивость к потере данных за счет использования двух виртуальных машин в реплицированной конфигурации. При сбое основного узла в таком кэше узел реплики принимает данные для автоматического обслуживания. Эти виртуальные машины размещаются в отдельных доменах на случай неисправностей и обновлений, что позволяет избежать одновременной недоступности обеих этих виртуальных машин. Однако крупный сбой центра обработки данных может привести к недоступности обеих виртуальных машин. В таких редких случаях ваши данные будут утеряны.

Рассмотрите возможность использования [сохраняемости данных Redis](https://redis.io/topics/persistence) и [георепликации](https://docs.microsoft.com/azure/azure-cache-for-redis/cache-how-to-geo-replication), чтобы улучшить защиту данных от этих сбоев инфраструктуры.

## <a name="additional-information"></a>Дополнительные сведения

- [Устранение неполадок с Кэшем Azure для Redis на стороне сервера](cache-troubleshoot-server.md)
- [Выбор подходящего уровня](cache-overview.md#choosing-the-right-tier)
- [Как отслеживать кэш Redis для Azure?](cache-how-to-monitor.md)
- [Как выполнять команды Redis?](cache-development-faq.md#how-can-i-run-redis-commands)
