---
title: Устранение неполадок, связанных с кэшем Azure для Redis на стороне клиента | Документация Майкрософт
description: Узнайте, как устранять распространенные проблемы на стороне клиента с помощью кэша Azure для Redis.
services: cache
documentationcenter: ''
author: yegu-ms
manager: maiye
editor: ''
ms.assetid: ''
ms.service: cache
ms.workload: tbd
ms.tgt_pltfrm: cache
ms.devlang: na
ms.topic: article
ms.date: 10/18/2019
ms.author: yegu
ms.openlocfilehash: 18fb2f7c5a411ff2026437b647be56812b4d2521
ms.sourcegitcommit: 8e271271cd8c1434b4254862ef96f52a5a9567fb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/23/2019
ms.locfileid: "72819626"
---
# <a name="troubleshoot-azure-cache-for-redis-client-side-issues"></a>Устранение неполадок, связанных с кэшем Azure для Redis на стороне клиента

В этом разделе обсуждаются проблемы, которые возникают из-за условий в клиенте Redis, используемом приложением.

- [Нехватка памяти в клиенте Redis](#memory-pressure-on-redis-client)
- [Интенсивность трафика](#traffic-burst)
- [Высокий коэффициент загрузки ЦП клиента](#high-client-cpu-usage)
- [Ограничение пропускной способности на стороне клиента](#client-side-bandwidth-limitation)
- [Большой размер запроса или ответа](#large-request-or-response-size)

## <a name="memory-pressure-on-redis-client"></a>Нехватка памяти в клиенте Redis

Нехватка памяти на клиентском компьютере приводит ко всем типам проблем производительности, которые могут откладывать обработку ответов из кэша. При попадании в нехватку памяти система может выполнить страничную загрузку данных на диск. Именно _ошибки страниц_ существенно замедляют работу системы.

Чтобы определить нехватку памяти на клиенте, выполните следующие действия.

- Отслеживайте использование памяти на компьютере, чтобы убедиться, что она не превышает объем доступной памяти.
- Наблюдение за счетчиком производительности `Page Faults/Sec` клиента. Во время нормальной работы в большинстве систем возникают ошибки страниц. Пиковые сбои страниц, соответствующие времени ожидания запросов, могут указывать на нехватку памяти.

Высокая нехватка памяти на клиенте может быть устранена несколькими способами:

- Ознакомьтесь с шаблонами использования памяти, чтобы уменьшить потребление памяти на клиенте.
- Обновите виртуальную машину клиента до большего размера с большим объемом памяти.

## <a name="traffic-burst"></a>Интенсивность трафика

Увеличение трафика в сочетании с недостаточными параметрами `ThreadPool` может привести к возникновению задержек обработки данных, отправленных сервером Redis, но еще не использованных на стороне клиента.

Отслеживайте изменение статистики `ThreadPool` с течением времени [, используя пример `ThreadPoolLogger`](https://github.com/JonCole/SampleCode/blob/master/ThreadPoolMonitor/ThreadPoolLogger.cs). Для дальнейшего изучения можно использовать `TimeoutException` сообщения из StackExchange. Redis, как показано ниже.

    System.TimeoutException: Timeout performing EVAL, inst: 8, mgr: Inactive, queue: 0, qu: 0, qs: 0, qc: 0, wr: 0, wq: 0, in: 64221, ar: 0,
    IOCP: (Busy=6,Free=999,Min=2,Max=1000), WORKER: (Busy=7,Free=8184,Min=2,Max=8191)

В предыдущем исключении есть несколько интересных проблем:

- Обратите внимание, что в разделах `IOCP` и `WORKER` значение `Busy` больше, чем значение `Min`. Это различие означает, что параметры `ThreadPool` требуют настройки.
- Кроме того, обратите внимание на `in: 64221`. Это значение указывает, что 64 211 байт были получены на уровне сокета ядра клиента, но не были считаны приложением. Это различие обычно означает, что ваше приложение (например, StackExchange. Redis) не считывает данные из сети так быстро, как сервер отправляет их вам.

Вы можете [настроить параметры `ThreadPool`](https://gist.github.com/JonCole/e65411214030f0d823cb) , чтобы обеспечить быстрое увеличение масштаба пула потоков в сценариях пакетной обработки.

## <a name="high-client-cpu-usage"></a>Высокий коэффициент загрузки ЦП клиента

Высокая загрузка ЦП указывает, что система не может справиться с работой, о которой потребовалось. Несмотря на то, что кэш отправил ответ быстро, клиент может не обработать ответ своевременно.

Отслеживайте загрузку ЦП на уровне системы клиента с помощью метрик, доступных в портал Azure или с помощью счетчиков производительности на компьютере. Следите за тем, чтобы не отслеживать ЦП *процесса* , поскольку один процесс может иметь низкую загрузку ЦП, но может быть высокий уровень ЦП на уровне системы. Понаблюдайте за пиками загрузки ЦП, которые соответствуют времени ожидания. Высокая загрузка ЦП может также привести к увеличению количества `in: XXX` значений в `TimeoutException` сообщениях об ошибках, как описано в разделе « [пакет трафика](#traffic-burst) ».

> [!NOTE]
> В StackExchange.Redis 1.1.603 и более поздней версии в сообщениях об ошибках `TimeoutException` содержится метрика `local-cpu`. Убедитесь, что вы используете последнюю версию [пакета NuGet для StackExchange.Redis](https://www.nuget.org/packages/StackExchange.Redis/). Это важно, так как ошибки в коде постоянно исправляют, что позволяет обеспечить надежность в отношении времени ожидания.
>

Чтобы устранить высокую загрузку ЦП клиентом, выполните следующие действия.

- Выясните, что вызывает пиковые выпуски ЦП.
- Обновите клиент до размера виртуальной машины с большим объемом ресурсов ЦП.

## <a name="client-side-bandwidth-limitation"></a>Ограничение пропускной способности на стороне клиента

В зависимости от архитектуры клиентских компьютеров на них применяются разные ограничения доступности пропускной способности сети. Если клиент превышает доступную пропускную способность путем перегрузки емкости сети, данные не обрабатываются на стороне клиента так быстро, как они отправляются сервером. Это может привести к превышению времени ожидания.

Отслеживайте изменение использования пропускной способности с течением времени [, используя пример `BandwidthLogger`](https://github.com/JonCole/SampleCode/blob/master/BandWidthMonitor/BandwidthLogger.cs). В некоторых окружениях с ограниченными разрешениями (например, веб-сайты Azure) этот код может не удастся выполнить.

Чтобы устранить эту проблемы, Сократите потребление пропускной способности сети или увеличьте размер виртуальной машины клиента до одной с большим количеством сетевых ресурсов.

## <a name="large-request-or-response-size"></a>Большой размер запроса или ответа

Из-за большого размера запроса или ответа может истекать время ожидания. Например, предположим, что значение времени ожидания, настроенное для клиента, равно 1 секунде. Приложение одновременно запрашивает два ключа (например, А и Б) в одном физическом сетевом подключении. Большинство клиентов поддерживают запрос "Конвейеризация", где оба запроса "A" и "B" отправляются один за другим без ожидания их ответов. Сервер отправляет ответы в том же порядке. Если ответ "A" большой, он может получить большую часть времени ожидания для последующих запросов.

В следующем примере запрос "A" и "B" быстро отправляются на сервер. Сервер быстро начинает отправлять ответы "A" и "B". В связи с временем передаваемых данных ответ "B" должен ожидать истечения времени ожидания ответа, несмотря на то, что сервер быстро ответил.

    |-------- 1 Second Timeout (A)----------|
    |-Request A-|
         |-------- 1 Second Timeout (B) ----------|
         |-Request B-|
                |- Read Response A --------|
                                           |- Read Response B-| (**TIMEOUT**)

Запрос или ответ сложно измерить. Вы можете инструментировать клиентский код для контроля больших запросов и ответов.

Разрешения для крупных размеров откликов являются изменяемыми, но включают:

1. Оптимизируйте приложение для большого количества небольших значений, а не для нескольких больших значений.
    - Поэтому рекомендуется разбить данные на небольшие связанные части.
    - См. статью [что такое идеальный диапазон размера значения для Redis? Слишком большой размер 100 КБ?](https://groups.google.com/forum/#!searchin/redis-db/size/redis-db/n7aa2A4DZDs/3OeEPHSQBAAJ) Дополнительные сведения о том, почему рекомендуется использовать меньшее значение.
1. Увеличьте размер виртуальной машины, чтобы получить возможности более высокой пропускной способности
    - Дополнительная пропускная способность на виртуальной машине клиента или сервера может сократить время передачи данных для больших ответов.
    - Сравните текущее использование сети на обоих компьютерах с ограничениями вашей текущей виртуальной машины. Дополнительная пропускная способность только на сервере или на клиенте может быть недостаточно.
1. Увеличьте число объектов подключения, используемых приложением.
    - Используйте метод циклического перебора, чтобы выполнять запросы через различные объекты соединения.

## <a name="additional-information"></a>Дополнительные сведения

- [Устранение неполадок в кэше Azure для Redis неполадок на стороне сервера](cache-troubleshoot-server.md)
- [Как измерить и протестировать производительность моего кэша?](cache-faq.md#how-can-i-benchmark-and-test-the-performance-of-my-cache)
