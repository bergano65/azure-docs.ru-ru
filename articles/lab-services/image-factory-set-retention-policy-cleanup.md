---
title: Настройка политики хранения в Azure DevTest Labs | Документация Майкрософт
description: Узнайте, как настроить политику хранения, очистить фабрику и снять с учета старые образы из DevTest Labs.
services: devtest-lab, lab-services
documentationcenter: na
author: spelluru
manager: femila
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/25/2019
ms.author: spelluru
ms.openlocfilehash: cf1c18fc799014ad862c93076d695f2516c6363d
ms.sourcegitcommit: c31dbf646682c0f9d731f8df8cfd43d36a041f85
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/27/2019
ms.locfileid: "74560172"
---
# <a name="create-a-custom-image-factory-in-azure-devtest-labs"></a>Создание настраиваемой фабрики изображений в Azure DevTest Labs
В этой статье описывается настройка политики хранения, очистка фабрики и снятие старых образов из всех других DevTest Labs в Организации. 

## <a name="prerequisites"></a>Технические условия
Прежде чем продолжить, убедитесь, что вы выполнили эти статьи:

- [Создание фабрики образов](image-factory-create.md)
- [Запуск фабрики образов из Azure DevOps](image-factory-set-up-devops-lab.md)
- [Сохранение пользовательских образов и распространение в несколько лабораторных занятий](image-factory-save-distribute-custom-images.md)

Следующие элементы уже должны быть на месте:

- Лаборатория для фабрики изображений в Azure DevTest Labs
- Одна или несколько целевых Azure DevTest Labs, где фабрика будет распространять золотые образы
- Проект Azure DevOps, используемый для автоматизации фабрики образов.
- Расположение исходного кода, содержащего скрипты и конфигурацию (в нашем примере — в том же проекте DevOps, который использовался выше)
- Определение сборки для управления задачами Azure PowerShell
 
## <a name="setting-the-retention-policy"></a>Настройка политики хранения
Перед настройкой шагов очистки определите, сколько исторических образов вы хотите хранить в DevTest Labs. При [выполнении фабрики образов из статьи DevOps Azure](image-factory-set-up-devops-lab.md) вы настроили различные переменные сборки. Один из них был **имажеретентион**. Для этой переменной задается значение `1`. Это означает, что DevTest Labs не будет вести журнал пользовательских образов. Будут доступны только новейшие распределенные образы. Если изменить эту переменную на `2`, будет поддерживаться новейшее распределенное изображение и предыдущие. Это значение можно задать, чтобы определить количество исторических образов, которые вы хотите поддерживать в DevTest Labs.

## <a name="cleaning-up-the-factory"></a>Очистка фабрики
Первым шагом при очистке фабрики является удаление виртуальных машин с эталонными изображениями из фабрики образов. Существует сценарий для выполнения этой задачи, как и в предыдущих сценариях. Первым шагом является добавление в определение сборки еще одной задачи **Azure PowerShell** , как показано на следующем рисунке:

![Шаг PowerShell](./media/set-retention-policy-cleanup/powershell-step.png)

Когда в списке появится новая задача, выберите элемент и заполните все сведения, как показано на следующем рисунке:

![Очистка старых образов задача PowerShell](./media/set-retention-policy-cleanup/configure-powershell-task.png)

Параметры сценария: `-DevTestLabName $(devTestLabName)`.

## <a name="retire-old-images"></a>Снять с учета старые образы 
Эта задача удаляет все старые образы, сохраняя только журнал, соответствующий переменной сборки **имажеретентион** . Добавьте дополнительную задачу сборки **Azure PowerShell** в определение сборки. После добавления выберите задачу и заполните сведения, как показано на следующем рисунке: 

![Снятие задачи PowerShell с учета старых образов](./media/set-retention-policy-cleanup/retire-old-image-task.png)

Параметры сценария: `-ConfigurationLocation $(System.DefaultWorkingDirectory)$(ConfigurationLocation) -SubscriptionId $(SubscriptionId) -DevTestLabName $(devTestLabName) -ImagesToSave $(ImageRetention)`

## <a name="queue-the-build"></a>Поставить сборку в очередь
Теперь, когда определение сборки завершено, помещает новую сборку в очередь, чтобы убедиться в том, что все работает. После успешного завершения сборки новые пользовательские образы отобразятся в целевой лаборатории. Если вы проверите лабораторию фабрики образов, вы не увидите подготовленных виртуальных машин. Кроме того, если вы помещаете в очередь дальнейшие сборки, вы увидите, что задачи очистки удаляют старые пользовательские образы из DevTest Labs в соответствии со значением срока хранения, заданным в переменных сборки.

> [!NOTE]
> Если вы выполнили конвейер сборки в конце последней статьи серии, вручную удалите виртуальные машины, созданные в лаборатории фабрики образов, прежде чем поставит в очередь новую сборку.  Этап очистки вручную требуется только в том случае, если все готово к работе.



## <a name="summary"></a>Резюме
Теперь у вас есть работающая фабрика образов, которая может создавать и распространять пользовательские образы в лаборатории по требованию. На этом этапе нужно правильно настроить образы и определить целевые лабораторные занятия. Как упоминалось в предыдущей статье, файл **Labs. JSON** , расположенный в папке **конфигурации** , указывает, какие образы должны быть доступны в каждой из целевых лабораторных занятий. При добавлении других DevTest лабораторий в организацию необходимо просто добавить запись в Labs. JSON для новой лаборатории.

Добавление нового образа в фабрику также является простым. Если вы хотите включить в фабрику новый образ, откройте [портал Azure](https://portal.azure.com), перейдите к фабрике DevTest Labs, нажмите кнопку, чтобы добавить виртуальную машину, и выберите нужный образ и артефакты Marketplace. Вместо нажатия кнопки **создать** для создания новой виртуальной машины выберите **Просмотреть Azure Resource Manager шаблон**и сохраните шаблон в виде JSON-файла в папке **голденимажес** в репозитории. При следующем запуске фабрики образов будет создан пользовательский образ.


## <a name="next-steps"></a>Дальнейшие действия
1. [Запланируйте сборку или выпуск](/azure/devops/pipelines/build/triggers?view=azure-devops&tabs=designer) , чтобы периодически запускать фабрику образов. Он регулярно обновляет созданные на основе фабрики образы.
2. Сделайте более золотой образ для фабрики. Вы также можете [создать артефакты](devtest-lab-artifact-author.md) , чтобы создать скрипты для дополнительных частей задач установки виртуальной машины и включить артефакты в образы фабрики.
4. Создайте [отдельную сборку или выпуск](/azure/devops/pipelines/overview?view=azure-devops-2019) , чтобы запустить скрипт **дистрибутеимажес** отдельно. Этот скрипт можно выполнить при внесении изменений в Labs. JSON и получения образов, скопированных в целевые лаборатории, без необходимости повторного создания всех образов.

