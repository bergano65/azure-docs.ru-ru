---
title: Включение вложенной виртуализации на виртуальной машине шаблона в службах лаборатории Azure (пользовательский интерфейс) | Документация Майкрософт
description: Узнайте, как создать шаблон виртуальной машины с несколькими вложенными виртуальными машинами.  Иначе говоря, получите сведения о поддержке вложенной виртуализацией для шаблона виртуальной машины в Службах лабораторий Azure.
author: emaher
ms.topic: article
ms.date: 06/26/2020
ms.author: enewman
ms.openlocfilehash: ad92862c78260e7385168faf794c013e85f66b82
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "85445735"
---
# <a name="enable-nested-virtualization-on-a-template-virtual-machine-in-azure-lab-services-manually"></a>Включение вложенной виртуализации на виртуальной машине шаблона в службах лаборатории Azure вручную

Вложенная виртуализация позволяет создать среду с несколькими виртуальными машинами в шаблоне виртуальной машины для лаборатории. После публикации такого шаблона у каждого пользователя лаборатории будет виртуальная машина с несколькими вложенными виртуальными машинами.  Дополнительные сведения о вложенной виртуализации и службах лаборатории Azure см. [в статье Включение вложенной виртуализации на виртуальной машине шаблона в службах лаборатории Azure](how-to-enable-nested-virtualization-template-vm.md).

В этой статье описывается, как настроить вложенную виртуализацию на компьютере шаблона в службах лаборатории Azure с помощью ролей и средств Windows напрямую.  Чтобы класс использовал вложенную виртуализацию, необходимо выполнить несколько моментов.  Приведенные ниже инструкции описывают, как вручную настроить шаблон компьютера служб лаборатории с помощью Hyper-V.  Действия предназначены для Windows Server 2016 или Windows Server 2019.  

>[!IMPORTANT]
>Выберите один из этих размеров виртуальной машины при создании лаборатории: **Средний (вложенная виртуализация)** или **Крупный (вложенная виртуализация)** .  Иначе вложенная виртуализация не будет работать.  

## <a name="enable-hyper-v-role"></a>Включение роли Hyper-V

Следующие шаги описывают действия, необходимые для включения Hyper-V в Windows Server с помощью любого диспетчер сервера.  После успешного завершения установки диспетчер Hyper-V будет доступен для добавления, изменения и удаления клиентских виртуальных машин.

1. В **Диспетчер сервера**на странице Панель мониторинга щелкните **Добавить роли и компоненты**.
2. На странице **Перед работой** нажмите кнопку **Далее**.
3. На странице **Выбор типа установки** сохраните выбранные по умолчанию параметры установки на основе ролей или компонентов и нажмите кнопку **Далее**.
4. На странице **Выбор целевого сервера** выберите выбрать сервер в пуле серверов.   Текущий сервер уже будет выбран.  Нажмите кнопку "Далее".
5. На странице **Выбор ролей сервера** выберите **Hyper-V**.  
6. Появится всплывающее окно **мастера добавления ролей и компонентов** .  Выберите **включить средства управления (если применимо)**.  Нажмите кнопку **Добавить компоненты** .
7. На странице **Выбор ролей сервера** нажмите кнопку **Далее**.
8. На **странице Выбор компонентов**нажмите кнопку **Далее**.
9. На странице **Hyper-V** нажмите кнопку **Далее**.
10. На странице **Создание виртуальных коммутаторов** примите значения по умолчанию и нажмите кнопку **Далее**.
11. На странице **Миграция виртуальных машин** примите значения по умолчанию и нажмите кнопку **Далее**.
12. На странице **хранилища по умолчанию** примите значения по умолчанию и нажмите кнопку **Далее**.
13. На странице **Подтверждение выбора установки** установите флажок **автоматически перезагружать сервер назначения при необходимости**.
14. При появлении всплывающего окна **мастера добавления ролей и компонентов** нажмите кнопку **Да**.
15. Щелкните **Install**(Установить).
16. Дождитесь завершения **установки** , чтобы сообщить о завершении роли Hyper-V.  Компьютер может перезапуститься в процессе установки.
17. Нажмите кнопку **Закрыть**.

## <a name="enable-dhcp-role"></a>Включить роль DHCP

Для всех виртуальных машин клиента Hyper-V, созданных, требуется IP-адрес в сети NAT.  Мы создадим сеть NAT позже.  Одним из способов назначения IP-адресов является настройка узла, в данном случае шаблона виртуальной машины лаборатории в качестве DHCP-сервера.  Ниже приведены шаги, необходимые для включения роли DHCP.

1. В **Диспетчер сервера**на странице **панель мониторинга** щелкните **Добавить роли и компоненты**.
2. На странице **Перед работой** нажмите кнопку **Далее**.
3. На странице **Выбор типа установки** выберите **Установка ролей или компонентов** и нажмите кнопку **Далее**.
4. На странице **Выбор целевого сервера** выберите текущий сервер из пула серверов, а затем нажмите кнопку **Далее**.
5. На странице **Выбор ролей сервера** выберите **DHCP-сервер**.  
6. Появится всплывающее окно **мастера добавления ролей и компонентов** .  Выберите **включить средства управления (если применимо)**.  Нажмите кнопку **Добавить компоненты**.

    >[!NOTE]
    >Может появиться сообщение об ошибке проверки того, что не найдены статические IP-адреса.  Это предупреждение можно пропустить в нашем сценарии.

7. На странице **Выбор ролей сервера** нажмите кнопку **Далее**.
8. На странице **Выбор компонентов** нажмите кнопку **Далее**.
9. На странице **DHCP-сервер** нажмите кнопку **Далее**.
10. На странице **Подтверждение выбранных элементов для установки** нажмите кнопку **Установить**.
11. Подождите, пока на **странице "ход выполнения установки** " будет указано, что роль DHCP завершена.
12. Нажмите кнопку Закрыть.

## <a name="enable-routing-and-remote-access-role"></a>Включение роли маршрутизации и удаленного доступа

1. В **Диспетчер сервера**на странице **панель мониторинга** щелкните **Добавить роли и компоненты**.
2. На странице **Перед работой** нажмите кнопку **Далее**.
3. На странице **Выбор типа установки** выберите **Установка ролей или компонентов** и нажмите кнопку **Далее**.
4. На странице **Выбор целевого сервера** выберите текущий сервер из пула серверов, а затем нажмите кнопку **Далее**.
5. На странице **Выбор ролей сервера** выберите **Удаленный доступ**. Нажмите кнопку **ОК**.
6. На странице **Выбор компонентов** нажмите кнопку **Далее**.
7. На странице **Удаленный доступ** нажмите кнопку **Далее**.
8. На странице **службы ролей** выберите **Маршрутизация**.
9. Появится всплывающее окно **мастера добавления ролей и компонентов** .  Выберите **включить средства управления (если применимо)**.  Нажмите кнопку **Добавить компоненты**.
10. Щелкните **Далее**.
11. На странице **Роль веб-сервера (IIS)** нажмите кнопку **Далее**.
12. На странице **Выберите службы роли** нажмите кнопку **Далее**.
13. На странице **Подтверждение выбранных элементов для установки** нажмите кнопку **Установить**.
14. Дождитесь завершения **установки** , чтобы указать, что роль удаленного доступа завершена.  
15. Нажмите кнопку **Закрыть**.

## <a name="create-virtual-nat-network"></a>Создание виртуальной сети NAT

Теперь, когда все необходимые роли установлены, пришло время создать сеть NAT.  Процесс создания предполагает создание коммутатора и сети NAT.  Сеть NAT (преобразование сетевых адресов) назначает общедоступный IP-адрес группе виртуальных машин в частной сети, чтобы разрешить подключение к Интернету.  В нашем случае в качестве вложенных виртуальных машин будет использоваться группа частных виртуальных машин.  Сеть NAT позволит вложенным виртуальным машинам взаимодействовать друг с другом. Коммутатор — это сетевое устройство, которое обрабатывает получение и маршрутизацию трафика в сети.

### <a name="create-a-new-virtual-switch"></a>Создание нового виртуального коммутатора

1. Откройте **Диспетчер Hyper-V** из средства администрирования Windows.
2. Выберите текущий сервер в меню навигации слева.
3. Щелкните **Диспетчер виртуальных коммутаторов...** в меню **действия** в правой части **диспетчера Hyper-V**.
4. На всплывающем окне **диспетчера виртуальных коммутаторов** выберите **internal (внутренний** ) для типа создаваемого коммутатора.  Щелкните **Создать виртуальный коммутатор**.
5. Для вновь созданного виртуального коммутатора присвойте ему имя.  В этом примере мы будем использовать "Лабсервицессвитч".  Нажмите кнопку **ОК**.
6. Будет создан новый сетевой адаптер.  Имя будет похоже на "адаптера vethernet (Лабсервицессвитч)".  Чтобы проверить, откройте **Панель управления**, щелкните **сеть и Интернет**, щелкните **Просмотр состояния сети и задачи**.  В левой части экрана щелкните **изменить параметры адаптера**.

### <a name="create-a-nat-network"></a>Создание сети NAT

1. Откройте средство " **Маршрутизация и удаленный доступ** " в средствах администрирования Windows.
2. Выберите локальный сервер на левой навигационной странице.
3. Выберите **действие**  ->  **Настройка и включите маршрутизацию и удаленный доступ**.
4. Когда появится **Мастер установки сервера маршрутизации и удаленного доступа** , нажмите кнопку **Далее**.
5. На странице **Конфигурация** выберите Конфигурация **преобразования сетевых адресов (NAT)** .  Щелкните **Далее**.

    >[!WARNING]
    >Не выбирайте параметр "доступ к виртуальной частной сети (VPN) и NAT".

6. На странице **Подключение к Интернету** на основе NAT выберите "Ethernet".  Не выбирайте подключение "адаптера vethernet (Лабсервицессвитч)", созданное в диспетчере Hyper-V. Щелкните **Далее**.
7. На последней странице мастера нажмите кнопку **Готово** .
8. Когда откроется диалоговое окно **Запуск службы** , нажмите кнопку **запустить службу**.
9. Дождитесь запуска службы.

## <a name="update-network-adapter-settings"></a>Обновить параметры сетевого адаптера

Сетевой адаптер будет связан с IP-адресом, используемым для IP-адреса шлюза по умолчанию для сети NAT, созданной ранее.  В этом примере мы создадим IP-адрес 192.168.0.1 с маской подсети 255.255.255.0.  Мы будем использовать виртуальный коммутатор, созданный ранее.

1. Откройте **Панель управления**, щелкните **сеть и Интернет**, щелкните **Просмотр состояния сети и задачи**.
2. В левой части экрана щелкните **изменить параметры адаптера**.  
3. В окне " **Сетевые подключения** " дважды щелкните "адаптера vethernet (лабсервицессвитч)", чтобы отобразить диалоговое окно сведений о **состоянии адаптера vethernet (лабсервицессвитч)** .
4. Нажмите кнопку **Свойства** .
5. Выберите элемент **Протокол Интернета версии 4 (TCP/IPv4)** и нажмите кнопку **свойства** .
6. В диалоговом окне **свойств протокола Интернета версии 4 (TCP/IPv4)** выберите **использовать следующий IP-адрес**.  В поле IP-адрес введите 192.168.0.1. Для маски подсети введите 255.255.255.0.  Оставьте поле Шлюз по умолчанию пустым.  Также оставьте пустыми DNS-серверы.

    >[!NOTE]
    > Наш диапазон для сети NAT будет в нотации CIDR, 192.168.0.0/24.  При этом создается диапазон пригодных для использования IP-адресов от 192.168.0.1 до 192.168.0.254.  По соглашению шлюзы имеют первый IP-адрес в диапазоне подсети.

7. Щелкните ОК.

## <a name="create-dhcp-scope"></a>Создать область DHCP

Ниже приведены инструкции по добавлению области DHCP.  В этой статье сеть NAT имеет формат 192.168.0.0/24 в нотации CIDR.  При этом создается диапазон пригодных для использования IP-адресов от 192.168.0.1 до 192.168.0.254.  Созданная область должна находиться в диапазоне возможных адресов, за исключением того, что ранее был создан IP-адрес.

1. Откройте **Администрирование и откройте средство** администрирования **DHCP** .
2. В средстве **DHCP** разверните узел для текущего сервера и выберите **IPv4**.
3. В меню Действие выберите пункт **создать область...**
4. Когда появится **Мастер создания области** , нажмите кнопку **Далее** на странице **приветствия** .
5. На странице **имя области** введите "лабсервицесдхкпскопе" или другое запоминающееся имя.  Щелкните **Далее**.
6. На странице **диапазон IP-адресов** введите следующие значения.

    - 192.168.0.100 для начального IP-адреса
    - 192.168.0.200 для конечного IP-адреса
    - 24 для длины
    - 255.255.255.0 для маски подсети

7. Щелкните **Далее**.
8. На странице **Добавление исключений и задержка** нажмите кнопку **Далее**.
9. На странице **срок аренды** нажмите кнопку **Далее**.
10. На странице **Настройка параметров DHCP** выберите **Да, я хочу настроить эти параметры сейчас**. Щелкните **Далее**.
11. На **маршрутизаторе (шлюз по умолчанию)**
12. Добавьте 192.168.0.1, если это еще не сделано. Щелкните **Далее**.
13. На странице **доменное имя и DNS-серверы** добавьте 168.63.129.16 в качестве IP-адреса DNS-сервера, если это еще не сделано.  168.63.129.16 — это IP-адрес статического DNS-сервера Azure. Щелкните **Далее**.
14. На странице **WINS-серверы** нажмите кнопку **Далее**.
15. На странице " **Активация области** " выберите **Да, я хочу активировать эту область сейчас**.  Щелкните **Далее**.
16. На странице **Завершение работы мастера создания области** нажмите кнопку **Готово**.

## <a name="conclusion"></a>Заключение

Теперь ваш компьютер шаблона готов к созданию виртуальных машин Hyper-V.   Инструкции по созданию виртуальных машин Hyper-V см. [в статье Создание виртуальной машины в Hyper-v](https://docs.microsoft.com/windows-server/virtualization/hyper-v/get-started/create-a-virtual-machine-in-hyper-v) .  См. также [Центр оценки Майкрософт](https://www.microsoft.com/evalcenter/) для извлечения доступных операционных систем и программного обеспечения.

## <a name="next-steps"></a>Дальнейшие действия

Дальнейшие действия являются общими для настройки любой лаборатории.

- [Добавление пользователей](tutorial-setup-classroom-lab.md#add-users-to-the-lab)
- [Настройка квоты](how-to-configure-student-usage.md#set-quotas-for-users)
- [Настройка расписания](tutorial-setup-classroom-lab.md#set-a-schedule-for-the-lab)
- [Ссылки для регистрации электронной почты учащихся](how-to-configure-student-usage.md#send-invitations-to-users)