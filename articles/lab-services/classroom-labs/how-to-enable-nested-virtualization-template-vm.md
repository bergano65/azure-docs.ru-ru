---
title: Реализация вложенной виртуализации для шаблона виртуальной машины в Службах лабораторий Azure | Документация Майкрософт
description: Узнайте, как создать шаблон виртуальной машины с несколькими вложенными виртуальными машинами.  Иначе говоря, получите сведения о поддержке вложенной виртуализацией для шаблона виртуальной машины в Службах лабораторий Azure.
services: lab-services
documentationcenter: na
author: spelluru
manager: ''
editor: ''
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/04/2019
ms.author: spelluru
ms.openlocfilehash: b7831e554fcca20134d5cf8608481ff0c82eb8a0
ms.sourcegitcommit: bb0afd0df5563cc53f76a642fd8fc709e366568b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/19/2020
ms.locfileid: "83592004"
---
# <a name="enable-nested-virtualization-on-a-template-virtual-machine-in-azure-lab-services"></a>Реализация вложенной виртуализации для шаблона виртуальной машины в Службах лабораторий Azure

Сейчас службы лаборатории Azure позволяют настроить в лаборатории один шаблон виртуальной машины и создать одну копию для каждого пользователя. Если вы занимаетесь обучением по вопросам сетей, безопасности или информационных технологий, вам будет полезно предоставить каждому учащемуся целую среду, в которой несколько виртуальных машин могут взаимодействовать друг с другом по сети.

Вложенная виртуализация позволяет создать среду с несколькими виртуальными машинами в шаблоне виртуальной машины для лаборатории. После публикации такого шаблона у каждого пользователя лаборатории будет виртуальная машина с несколькими вложенными виртуальными машинами.  В этой статье описана реализация вложенной виртуализации для шаблона компьютера в Службах лабораторий Azure

## <a name="what-is-nested-virtualization"></a>Что такое вложенная виртуализация?

Вложенная виртуализация позволяет создавать виртуальные машины внутри другой виртуальной машины. Вложенная виртуализация выполняется через Hyper-V и доступна только на виртуальных машинах Windows.

Дополнительные сведения о вложенной виртуализации см. в следующих статьях:

- [Вложенная виртуализация в Azure.](https://azure.microsoft.com/blog/nested-virtualization-in-azure/)
- [Как включить вложенную виртуализацию на виртуальных машинах Azure](../../virtual-machines/windows/nested-virtualization.md)

## <a name="considerations"></a>Рекомендации

Прежде чем настраивать вложенную виртуализацию для лаборатории, необходимо учесть некоторые факторы.

- При создании лаборатории выберите размер виртуальной машины: **Средний (вложенная виртуализация)** или **Крупный (вложенная виртуализация)** . Только эти размеры виртуальных машин поддерживают вложенную виртуализацию.
- Выберите их них тот, который обеспечит достаточную производительность для базовых и клиентских виртуальных машин.  Не забывайте, что при использовании виртуализации выбранный размер должен быть достаточным не для одного компьютера, а для всех одновременно работающих компьютеров Hyper-V.
- Клиентские виртуальные машины не смогут обращаться к ресурсам Azure, таким как DNS-серверы, расположенным в виртуальной сети Azure.
- Для базовой виртуальной машины узла требуется дополнительная настройка, чтобы разрешить подключение клиентского компьютера к Интернету.
- Клиентские виртуальные машины лицензируются как независимые компьютеры. Сведения о лицензировании операционных систем и других продуктов Майкрософт см. на [этой странице](https://www.microsoft.com/licensing/default). Прежде чем настраивать шаблон компьютера, проверьте лицензионные соглашения для любого другого используемого в ней программного обеспечения.

## <a name="enable-nested-virtualization-on-a-template-vm"></a>Включение вложенной виртуализации в шаблоне виртуальной машины

В этой статье предполагается, что вы уже создали учетную запись лаборатории и саму лабораторию.  Сведения о создании новой учетной записи лаборатории см. в [этом руководстве](tutorial-setup-lab-account.md). Дополнительные сведения о создании лаборатории см. в [руководстве по настройке лаборатории для аудитории](tutorial-setup-classroom-lab.md).

>[!IMPORTANT]
>Выберите один из этих размеров виртуальной машины при создании лаборатории: **Средний (вложенная виртуализация)** или **Крупный (вложенная виртуализация)** .  Иначе вложенная виртуализация не будет работать.  

Чтобы подключиться к шаблону виртуальной машины, используйте [руководство по созданию шаблона аудитории и управлению им](how-to-create-manage-template.md).

Чтобы организовать вложенную виртуализацию, нужно выполнить несколько задач.  

- **Включите роль Hyper-V.** Для создания и запуска виртуальных машин Hyper-V на виртуальной машине служб лаборатории необходимо включить роль Hyper-V.
- **Включите DHCP.**  Если для виртуальной машины Служб лаборатории включена роль DHCP, виртуальным машинам Hyper-V будут автоматически назначаться IP-адреса.
- **Создайте сеть NAT для виртуальных машин Hyper-V.**  В сети NAT включается возможность доступа к Интернету для виртуальных машин Hyper-V.  Виртуальные машины Hyper-V могут взаимодействовать друг с другом.

>[!NOTE]
>Сеть NAT, созданная на виртуальной машине служб лаборатории, позволит виртуальной машине Hyper-V обращаться к Интернету и другим виртуальным машинам Hyper-V на той же виртуальной машине служб лаборатории.  Виртуальные машины Hyper-V не смогут обращаться к ресурсам Azure, таким как DNS-серверы, расположенным в виртуальной сети Azure.

Перечисленные выше задачи можно выполнить с помощью скриптов или средств Windows.  Дополнительные сведения об этом см. в разделах ниже.

### <a name="using-script-to-enable-nested-virtualization"></a>Использование скрипта для включения вложенной виртуализации

Чтобы применить автоматизированную настройку вложенной виртуализации для Windows Server 2016 или Windows Server 2019, см. статью [Включение вложенной виртуализации для шаблона виртуальной машины в Службах лабораторий Azure с помощью скрипта](how-to-enable-nested-virtualization-template-vm-using-script.md). Для установки роли Hyper-V вы примените скрипты из [набора для Hyper-V в Службах лаборатории](https://github.com/Azure/azure-devtestlab/tree/master/samples/ClassroomLabs/Scripts/HyperV).  Эти скрипты также позволяют настроить сеть, чтобы разрешить доступ к Интернету для виртуальных машин Hyper-V.

### <a name="using-windows-tools-to-enable-nested-virtualization"></a>Использование средств Windows для включения вложенной виртуализации

Чтобы настроить вложенную виртуализацию для Windows Server 2016 или Windows Server 2019 с помощью ролей и средств администрирования Windows, воспользуйтесь статьей [Включение вложенной виртуализации вручную в шаблоне виртуальной машине в Службах лабораторий Azure](how-to-enable-nested-virtualization-template-vm-ui.md).  Эти инструкции охватывают и настройку сети, обеспечивающую доступ к Интернету для виртуальных машин Hyper-V.
