---
title: Агент синхронизации данных для синхронизация данных SQL
description: Узнайте, как установить и запустить агент синхронизации данных для синхронизация данных SQL в Azure для синхронизации данных с SQL Server базами данных.
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: conceptual
author: stevestein
ms.author: sstein
ms.reviewer: carlrab
ms.date: 12/20/2018
ms.openlocfilehash: 8033e64924b5faa1cfdc9c04cdd8711850185dca
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "84195461"
---
# <a name="data-sync-agent-for-sql-data-sync"></a>Агент синхронизации данных для синхронизация данных SQL
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

Синхронизируйте данные с SQL Server базами данных, установив и настроив агент синхронизации данных для синхронизация данных SQL в Azure. Дополнительные сведения о синхронизации данных SQL см. в статье [Синхронизация данных в нескольких облачных и локальных базах данных с помощью синхронизации данных SQL](sql-data-sync-data-sql-server-sql-database.md).

> [!IMPORTANT]
> В настоящее время синхронизация данных SQL **не поддерживает Azure** SQL управляемый экземпляр.

## <a name="download-and-install"></a>Загрузите и установите

Чтобы скачать агент синхронизации данных, перейдите на [Синхронизация данных SQL агент](https://www.microsoft.com/download/details.aspx?id=27693).

### <a name="install-silently"></a>Установка в автоматическом режиме

Чтобы установить Агент синхронизации данных в автоматическом режиме с командной строки, введите команду, аналогичную примеру. Проверьте имя скачанного файла .msi и предоставьте ваши значения для аргументов **TARGETDIR** и **SERVICEACCOUNT**.

- Если не указать значение для **TARGETDIR**, `C:\Program Files (x86)\Microsoft SQL Data Sync 2.0` будет значением по умолчанию.

- Если указать в `LocalSystem` качестве значения **учетная запись службы**, то при настройке агента для подключения к SQL Server используйте проверку подлинности SQL Server.

- Если указать учетную запись пользователя домена или учетную запись локального пользователя в качестве параметра **SERVICEACCOUNT**, необходимо также указать пароль в аргументе **SERVICEPASSWORD**. Например, `SERVICEACCOUNT="<domain>\<user>"  SERVICEPASSWORD="<password>"`.

```cmd
msiexec /i "SQLDataSyncAgent-2.0-x86-ENU.msi" TARGETDIR="C:\Program Files (x86)\Microsoft SQL Data Sync 2.0" SERVICEACCOUNT="LocalSystem" /qn
```

## <a name="sync-data-with-a-sql-server-database"></a>Синхронизация данных с базой данных SQL Server

Сведения о настройке агента синхронизации данных для синхронизации данных с одной или несколькими SQL Server базами данных см. в разделе [Добавление базы данных SQL Server](sql-data-sync-sql-server-configure.md#add-on-prem).

## <a name="data-sync-agent-faq"></a><a name="agent-faq"></a> Часто задаваемые вопросы об Агенте синхронизации данных

### <a name="why-do-i-need-a-client-agent"></a>Зачем нужен агент клиента?

Служба синхронизации данных SQL взаимодействует с базами данных SQL Server через агент клиента. Эта функция безопасности избавляет от необходимости поддерживать прямую связь с базами данных, которые защищены брандмауэром. Когда служба синхронизации данных SQL обменивается данными с агентом, используется шифрование соединения и уникальный маркер (*ключ агента*). Базы данных SQL Server выполняют аутентификацию агента по строке подключения и ключу агента. Такой подход обеспечивает высокий уровень безопасности для ваших данных.

### <a name="how-many-instances-of-the-local-agent-ui-can-be-run"></a>Сколько можно запустить экземпляров локального агента пользовательского интерфейса?

Вы можете запустить только один экземпляр пользовательского интерфейса.

### <a name="how-can-i-change-my-service-account"></a>Как изменить учетную запись службы?

После установки агента клиента есть только один способ изменить учетную запись службы: нужно ее удалить и заново установить агент клиента с новой учетной записью.

### <a name="how-do-i-change-my-agent-key"></a>Как изменить ключ агента?

Каждый ключ агента можно использовать для агента только один раз. Его нельзя использовать повторно, если вы удалите агент и установите его заново, а также нельзя применять для нескольких агентов. Если вам нужно создать новый ключ для существующего агента, следите за тем, чтобы в агенте клиента и в службе синхронизации данных SQL был указан один и тот же ключ.

### <a name="how-do-i-retire-a-client-agent"></a>Как отключить агент клиента?

Чтобы немедленно отключить агент (запретить его использование), повторно создайте для него ключ на портале, но не передавайте этот ключ в пользовательский интерфейс агента. При повторном создании ключа нельзя использовать предыдущий, независимо от наличия связи с соответствующим агентом.

### <a name="how-do-i-move-a-client-agent-to-another-computer"></a>Как перенести агент клиента на другой компьютер?

Если вы хотите запустить локальный агент на другом компьютере, выполните следующие действия:

1. Установите агент на новом компьютере.
2. Войдите на портал синхронизации данных SQL и повторно создайте ключ агента для нового агента.
3. Через пользовательский интерфейс нового агента отправьте ему только что созданный ключ агента.
4. Подождите, пока агент клиента скачает список локальных баз данных, которые уже зарегистрированы в системе.
5. Предоставьте учетные данные для подключение ко всем базам данных, которые отмечены как недоступные. Теперь эти базы данных должны стать доступными с нового компьютера, на котором вы установили агент.

## <a name="troubleshoot-data-sync-agent-issues"></a><a name="agent-tshoot"></a> Устранение неполадок Агента синхронизации данных

- [Установка, удаление или восстановление агента клиента завершается ошибкой](#agent-install)

- [Агент клиента не работает после отмены удаления](#agent-uninstall)

- [В списке агента отсутствует моя база данных](#agent-list)

- [Агент клиента не запускается (ошибка 1069)](#agent-start)

- [Не удается отправить ключ агента](#agent-key)

- [Агент клиента невозможно удалить с портала, если связанная с ним локальная база данных недоступна](#agent-delete)

- [Приложение локального агента синхронизации не может подключиться к локальной службе синхронизации](#agent-connect)

### <a name="the-client-agent-install-uninstall-or-repair-fails"></a><a name="agent-install"></a>Сбой установки, удаления или восстановления агента клиента

- **Причина**. Этот сбой может произойти во множестве случаев. Чтобы определить конкретную причину этого сбоя, просмотрите журналы.

- **Решение**. Чтобы найти конкретную причину сбоя, следует создать и просмотреть журналы установщика Windows. Включить ведение журнала можно с помощью командной строки. Например, если `SQLDataSyncAgent-2.0-x86-ENU.msi` — это скачанный файл установки, создайте и изучите файлы журналов, используя следующие команды:

  - Для установки: `msiexec.exe /i SQLDataSyncAgent-2.0-x86-ENU.msi /l*v LocalAgentSetup.Log`
  - Для удаления: `msiexec.exe /x SQLDataSyncAgent-2.0-x86-ENU.msi /l*v LocalAgentSetup.Log`

    Вы также можете включить ведение журнала для всех установок, выполняемых установщиком Windows. Дополнительные сведения см. в статье базы знаний Майкрософт [Как включить ведение журнала работы установщика Windows](https://support.microsoft.com/help/223300/how-to-enable-windows-installer-logging). В ней также описано расположение этих журналов.

### <a name="the-client-agent-doesnt-work-after-i-cancel-the-uninstall"></a><a name="agent-uninstall"></a> Агент клиента не работает после отмены удаления

Агент клиента не работает, даже если вы отменили его удаление.

- **Причина**. Эта проблема возникает из-за того, что агент клиента синхронизации данных SQL не хранит учетные данные.

- **Решение**. Попробуйте применить следующие два способа:

    -   Используйте services.msc для повторного ввода учетных данных агента клиента.
    -   Удалите этот агент клиента и установите его заново. Скачайте и установите последний агент клиента из [центра загрузки](https://www.microsoft.com/download/details.aspx?id=27693).

### <a name="my-database-isnt-listed-in-the-agent-list"></a><a name="agent-list"></a>Моя база данных отсутствует в списке агентов

При попытке добавить существующую базу данных SQL Server в группу синхронизации база данных не отображается в списке агентов.

Этот сбой может произойти в следующих случаях:

- **Причина**. Агент клиента и группа синхронизации находятся в разных центрах обработки данных.

- **Решение**. Агент клиента и группа синхронизации должны находиться в одном центре обработки данных. Чтобы обеспечить это, имеются две возможности:

    -   Создайте новый агент в центре обработки данных, в котором находится группа синхронизации. Затем зарегистрируйте базу данных в этом агенте.
    -   Удалите текущую группу синхронизации. Затем повторно создайте группу синхронизации в центре обработки данных, в котором находится агент.

- **Причина**. Список баз данных агента клиента устарел.

- **Решение**. Остановите и перезапустите службу агента клиента.

    Локальный агент скачивает список связанных баз данных только при первой отправке ключа агента. Он не скачивает список связанных баз данных при последующих отправках ключа агента. Базы данных, зарегистрированные во время перемещения агента, не отображаются в исходном экземпляре агента.

### <a name="client-agent-doesnt-start-error-1069"></a><a name="agent-start"></a> Агент клиента не запускается (ошибка 1069)

Вы обнаружили, что агент не работает на компьютере, на котором размещен сервер SQL Server. При попытке запустить агент вручную отображается диалоговое окно с сообщением об ошибке: "Ошибка 1069. Служба не запущена из-за ошибки входа в систему".

![Диалоговое окно ошибки с синхронизацией данных 1069](./media/sql-data-sync-agent-overview/sync-error-1069.png)

- **Причина**. Вероятной причиной этой ошибки является то, что пароль на локальном сервере изменился с момента создания агента и его пароля.

- **Решение**. Обновите пароль агента до текущего пароля сервера.

  1. Найдите службу агента клиента синхронизации данных SQL.  
    а. Щелкните **Запуск**.  
    b. В поле поиска введите **services.msc**.  
    c. В результатах поиска выберите **службы**.  
    d. В окне **Службы** прокрутите список до записи **Агент синхронизации данных SQL**.  
  1. Щелкните правой кнопкой мыши **Агент синхронизации данных SQL**, а затем выберите **Остановить**.
  1. Щелкните правой кнопкой мыши **Агент синхронизации данных SQL**, а затем выберите **Свойства**.
  1. В окне **Свойства агента синхронизации данных SQL** щелкните вкладку **Вход**.
  1. Введите пароль в поле **Пароль**.
  1. Повторно введите пароль в поле **Подтверждение пароля**.
  1. Нажмите кнопку **Применить**, а затем кнопку **ОК**.
  1. В окне **Службы** щелкните правой кнопкой мыши службу **Агент синхронизации данных SQL**, а затем щелкните **Запуск**.
  1. Закройте окно **службы** .

### <a name="i-cant-submit-the-agent-key"></a><a name="agent-key"></a>Невозможно отправить ключ агента

После создания или повторного создания ключа агента вы пытаетесь передать этот ключ через приложение SqlAzureDataSyncAgent. Но выполнить отправку не удается.

![Диалоговое окно ошибки синхронизации: не удается отправить ключ агента](./media/sql-data-sync-agent-overview/sync-error-cant-submit-agent-key.png)

- **Предварительные требования**. Прежде чем продолжить, обратите внимание на следующие условия:

  - Служба синхронизации данных SQL Windows запущена.

  - Учетная запись службы синхронизации данных SQL Windows имеет доступ к сети.

  - Исходящий порт 1433 открыт в локальном правиле брандмауэра.

  - Локальный IP-адрес добавляется к серверу или в правило брандмауэра базы данных для синхронизации базы данных метаданных.

- **Причина**. Ключ агента уникально идентифицирует каждый локальный агент. Ключ должен соответствовать двум условиям:

  -   Ключи агента клиента на сервере синхронизации данных SQL и локальном компьютере должны быть идентичными.
  -   Ключ агента клиента можно использовать только один раз.

- **Решение**. Если агент не работает, это связано с тем, что одно или оба условия не выполняются. Чтобы агент снова заработал:

  1. Создайте ключ.
  1. Примените новый ключ к агенту.

  Примените новый ключ к агенту.

  1. Используйте проводник для перехода в каталог установки агента. Каталог установки по умолчанию — C:\\Program Files (x86)\\Microsoft SQL Data Sync.
  1. Дважды щелкните подкаталог bin.
  1. Откройте приложение SqlAzureDataSyncAgent.
  1. Щелкните **Submit Agent Key** (Отправить ключ агента).
  1. Вставьте ключ из буфера обмена в соответствующем поле.
  1. Нажмите кнопку **ОК**.
  1. Закройте программу.

### <a name="the-client-agent-cant-be-deleted-from-the-portal-if-its-associated-on-premises-database-is-unreachable"></a><a name="agent-delete"></a> Агент клиента невозможно удалить с портала, если связанная с ним локальная база данных недоступна

Если локальная конечная точка (то есть база данных), которая зарегистрирована в агенте клиента синхронизации данных SQL, становится недоступной, агент клиента нельзя удалить.

- **Причина**. Локальный агент не может быть удален, так как недоступная база данных все еще зарегистрирована в агенте. При попытке удалить агент процесс удаления пытается подключиться к базе данных, что приводит к ошибке.

- **Решение**. Используйте принудительное удаление, чтобы удалить недоступную базу данных.

> [!NOTE]
> Если таблицы метаданных синхронизации остаются после принудительного удаления, используйте `deprovisioningutil.exe`, чтобы очистить их.

### <a name="local-sync-agent-app-cant-connect-to-the-local-sync-service"></a><a name="agent-connect"></a>Приложению локального агента синхронизации не удается подключиться к локальной службе синхронизации

- **Решение**. Попробуйте сделать следующее.

  1. Выйдите из приложения.  
  1. Откройте панель "Службы компонентов".  
    а. В поле поиска на панели задач введите **services.msc**.  
    b. В результатах поиска дважды щелкните **Службы**.  
  1. Остановите работу службы **синхронизации данных SQL**.
  1. Перезапустите службу **Синхронизация данных SQL** .  
  1. Повторно откройте приложение.

## <a name="run-the-data-sync-agent-from-the-command-prompt"></a>Запустите Агент синхронизации данных из командной строки

Вы можете запустить такие команды Агента синхронизации данных из командной строки:

### <a name="ping-the-service"></a>Проверка связи со службой

#### <a name="usage"></a>Использование

```cmd
SqlDataSyncAgentCommand.exe -action pingsyncservice
```

#### <a name="example"></a>Пример

```cmd
SqlDataSyncAgentCommand.exe -action "pingsyncservice"
```

### <a name="display-registered-databases"></a>Отображение зарегистрированных баз данных

#### <a name="usage"></a>Использование

```cmd
SqlDataSyncAgentCommand.exe -action displayregistereddatabases
```

#### <a name="example"></a>Пример

```cmd
SqlDataSyncAgentCommand.exe -action "displayregistereddatabases"
```

### <a name="submit-the-agent-key"></a>Отправление ключа агента

#### <a name="usage"></a>Использование

```cmd
Usage: SqlDataSyncAgentCommand.exe -action submitagentkey -agentkey [agent key]  -username [user name] -password [password]
```

#### <a name="example"></a>Пример

```cmd
SqlDataSyncAgentCommand.exe -action submitagentkey -agentkey [agent key generated from portal, PowerShell, or API] -username [user name to sync metadata database] -password [user name to sync metadata database]
```

### <a name="register-a-database"></a>Регистрация базы данных

#### <a name="usage"></a>Использование

```cmd
SqlDataSyncAgentCommand.exe -action registerdatabase -servername [on-premisesdatabase server name] -databasename [on-premisesdatabase name]  -username [domain\\username] -password [password] -authentication [sql or windows] -encryption [true or false]
```

#### <a name="examples"></a>Примеры

```cmd
SqlDataSyncAgentCommand.exe -action "registerdatabase" -serverName localhost -databaseName testdb -authentication sql -username <user name> -password <password> -encryption true

SqlDataSyncAgentCommand.exe -action "registerdatabase" -serverName localhost -databaseName testdb -authentication windows -encryption true

```

### <a name="unregister-a-database"></a>Отмена регистрации базы данных

При использовании этой команды для отмены регистрации базы данных, она полностью отзывает базу данных. Если база присутствует в других группах синхронизации, такая операция нарушит другие группы синхронизации.

#### <a name="usage"></a>Использование

```cmd
SqlDataSyncAgentCommand.exe -action unregisterdatabase -servername [on-premisesdatabase server name] -databasename [on-premisesdatabase name]
```

#### <a name="example"></a>Пример

```cmd
SqlDataSyncAgentCommand.exe -action "unregisterdatabase" -serverName localhost -databaseName testdb
```

### <a name="update-credentials"></a>Обновление учетных данных

#### <a name="usage"></a>Использование

```cmd
SqlDataSyncAgentCommand.exe -action updatecredential -servername [on-premisesdatabase server name] -databasename [on-premisesdatabase name]  -username [domain\\username] -password [password] -authentication [sql or windows] -encryption [true or false]
```

#### <a name="examples"></a>Примеры

```cmd
SqlDataSyncAgentCommand.exe -action "updatecredential" -serverName localhost -databaseName testdb -authentication sql -username <user name> -password <password> -encryption true

SqlDataSyncAgentCommand.exe -action "updatecredential" -serverName localhost -databaseName testdb -authentication windows -encryption true
```

## <a name="next-steps"></a>Дальнейшие шаги

Дополнительные сведения о Синхронизации данных SQL см. в следующих статьях:

-   Обзор. [Синхронизация данных в нескольких облачных и локальных базах данных с помощью синхронизации данных SQL в Azure](sql-data-sync-data-sql-server-sql-database.md)
-   Настройка синхронизации данных
    - На портале — [учебник. настройка синхронизация данных SQL для синхронизации данных между базой данных SQL Azure и SQL Server](sql-data-sync-sql-server-configure.md)
    - С помощью PowerShell
        -  [Синхронизация нескольких баз данных в базе данных SQL Azure с помощью PowerShell](scripts/sql-data-sync-sync-data-between-sql-databases.md)
        -  [Использование PowerShell для синхронизации между базой данных в базе данных SQL Azure и базой данных в экземпляре SQL Server](scripts/sql-data-sync-sync-data-between-azure-onprem.md)
-   Рекомендации: [Рекомендации по синхронизации данных SQL](sql-data-sync-best-practices.md).
-   Мониторинг: [Мониторинг синхронизации данных SQL с помощью журналов Azure Monitor](sql-data-sync-monitor-sync.md)
-   Устранение неполадок-[Устранение неполадок в Azure синхронизация данных SQL] SQL-Data-Sync-troubleshoot.md)
-   Обновление схемы синхронизации
    -   С помощью Transact-SQL — [Автоматизируйте репликацию изменений схемы с помощью синхронизация данных SQL в Azure](sql-data-sync-update-sync-schema.md) .
    -   С помощью PowerShell: [Использование PowerShell для обновления схемы синхронизации в существующей группе синхронизации](scripts/update-sync-schema-in-sync-group.md).
