---
title: Высокий уровень доступности
titleSuffix: Azure SQL Database and SQL Managed Instance
description: Узнайте о возможностях и функциях обеспечения высокой доступности и функций SQL Управляемый экземпляр в службе "база данных SQL Azure"
services: sql-database
ms.service: sql-db-mi
ms.subservice: high-availability
ms.custom: sqldbrb=2
ms.devlang: ''
ms.topic: conceptual
author: sashan
ms.author: sashan
ms.reviewer: sstein, sashan
ms.date: 08/12/2020
ms.openlocfilehash: 93e9ad28b14a51432fd9ccd32d1a155eaff2e190
ms.sourcegitcommit: 6906980890a8321dec78dd174e6a7eb5f5fcc029
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/22/2020
ms.locfileid: "92427141"
---
# <a name="high-availability-for-azure-sql-database-and-sql-managed-instance"></a>Высокий уровень доступности для базы данных SQL Azure и Управляемый экземпляр SQL
[!INCLUDE[appliesto-sqldb-sqlmi](../includes/appliesto-sqldb-sqlmi.md)]

Цель архитектуры высокого уровня доступности в базе данных SQL Azure и Управляемый экземпляр SQL — гарантировать, что ваша база данных будет работать в течение не менее 99,99% времени (Дополнительные сведения о конкретном соглашении об уровне обслуживания для разных уровней см. в статье [соглашение об уровне обслуживания для базы данных SQL Azure и sql управляемый экземпляр](https://azure.microsoft.com/support/legal/sla/sql-database/)), не беспокоясь о влиянии операций обслуживания и простоев. Azure автоматически обрабатывает критически важные задачи обслуживания, такие как исправления, резервные копии, обновления Windows и SQL Azure, а также незапланированные события, такие как оборудование, программное обеспечение или сбои сети.  Когда базовая база данных в базе данных SQL Azure обновляется или отменяется, время простоя не заметно, если в приложении используется [логика повторных попыток](develop-overview.md#resiliency) . База данных SQL и SQL Управляемый экземпляр могут быстро восстанавливаться даже в самых важных условиях, гарантируя доступность данных в постоянном доступе.

Решение высокой доступности предназначено для того, чтобы гарантировать, что зафиксированные данные никогда не будут потеряны из-за сбоев, операции обслуживания не затрагивают рабочую нагрузку и что база данных не будет единственной точкой отказа в архитектуре программного обеспечения. Периоды обслуживания и простой, из-за которых нужно остановить рабочую нагрузку во время обновления или обслуживания базы данных, отсутствуют.

Существует две модели архитектуры высокого уровня доступности:

- **Стандартная модель доступности** , основанная на разделении вычислений и хранилища.  Он полагается на высокий уровень доступности и надежности удаленного уровня хранилища. Эта архитектура предназначена для ориентированных на бюджет бизнес-приложений, которые могут допускать снижение производительности во время действий по обслуживанию.
- **Модель доступности** уровня "Премиум", основанная на кластере процессов ядра СУБД. Это зависит от того факта, что всегда существует кворум доступных узлов ядра СУБД. Эта архитектура предназначена для критически важных приложений с высокой производительностью операций ввода-вывода, высокой частотой транзакций и гарантирует минимального воздействия на производительность рабочей нагрузки во время операций обслуживания.

База данных SQL и SQL Управляемый экземпляр работают на последней стабильной версии SQL Server ядра СУБД и операционной системы Windows, и большинство пользователей не заметят, что обновления выполняются непрерывно.

## <a name="basic-standard-and-general-purpose-service-tier-locally-redundant-availability"></a>Локально избыточная доступность уровня служб "базовый", "Стандартный" и общего назначения

Уровни служб "базовый", "Стандартный" и "общего назначения" используют стандартную архитектуру доступности для бессерверных и подготовленных вычислений. На следующем рисунке показаны четыре разных узла с раздельными уровнями вычислений и хранилища.

![Разделение уровней вычисления и хранения](./media/high-availability-sla/general-purpose-service-tier.png)

Стандартная модель доступности включает два уровня:

- Уровень вычислений без отслеживания состояния, который запускает `sqlservr.exe` процесс и содержит только временные и кэшированные данные, такие как tempdb, базы данных моделей на подключенном SSD, а также кэш планов, буферный пул и пул columnstore в памяти. Этот узел работает Service Fabric Azure, который инициализирует `sqlservr.exe` , управляет работоспособностью узла и выполняет отработку отказа на другой узел, если это необходимо.
- Уровень данных с отслеживанием состояния с файлами базы данных (MDF/LDF), которые хранятся в хранилище BLOB-объектов Azure. Хранилище BLOB-объектов Azure имеет встроенную возможность обеспечения доступности и избыточности данных. Она гарантирует, что каждая запись в файле журнала или странице в файле данных будет сохранена даже в случае `sqlservr.exe` сбоя процесса.

При обновлении ядра СУБД или операционной системы или при обнаружении сбоя Azure Service Fabric переместит процесс без отслеживания состояния `sqlservr.exe` на другой расчетный узел без отслеживания состояния с достаточной свободной емкостью. Перемещение данных в хранилище BLOB-объектов Azure не затрагивается, а файлы данных и журналов присоединяются к только что инициализированному `sqlservr.exe` процессу. Этот процесс гарантирует доступность 99,99%, но при этом интенсивная рабочая нагрузка может вызвать некоторое снижение производительности во время перехода, так как новый `sqlservr.exe` процесс начинается с холодного кэша.

## <a name="general-purpose-service-tier-zone-redundant-availability-preview"></a>Общего назначения избыточной доступности зоны уровня служб (Предварительная версия)

Конфигурация избыточности в пределах зоны для уровня служб общего назначения использует [зоны доступности Azure](../../availability-zones/az-overview.md)   для репликации баз данных между несколькими физическими расположениями в регионе Azure.Выбрав избыточность зоны, можно сделать новые и существующие отдельные базы данных и эластичные пулы общего назначения устойчивыми к значительному набору сбоев, включая катастрофовые перебои в центрах обработки данных, без каких-либо изменений логики приложения.

Конфигурация избыточности в рамках зоны для уровня общего назначения имеет два уровня:  

- Уровень данных с отслеживанием состояния с файлами базы данных (MDF/LDF), которые хранятся в ZRS PFS ( [файловый ресурс хранилища уровня Premium](../../storage/files/storage-how-to-create-premium-fileshare.md), избыточный в виде зоны). При использовании [хранилища, избыточного](../../storage/common/storage-redundancy.md) в пределах зоны, файлы данных и журнала синхронно копируются в три зоны доступности Azure с физической изоляцией.
- Уровень вычислений без отслеживания состояния, выполняющий процесс sqlservr.exe и содержащий только временные и кэшированные данные, такие как TempDB, базы данных модели на подключенном SSD, а также кэш планов, буферный пул и пул columnstore в памяти. Этот узел работает в Azure Service Fabric, который инициализирует sqlservr.exe, управляет работоспособностью узла и при необходимости выполняет отработку отказа на другой узел. Для баз данных общего назначения, избыточных в рамках зоны, узлы с запасной емкостью доступны в других Зоны доступности для отработки отказа.

Ниже приведена схема, которая является избыточной версией архитектуры высокой доступности для уровня служб общего назначения.

![Конфигурация, избыточная в рамках зоны, для общего назначения](./media/high-availability-sla/zone-redundant-for-general-purpose.png)

> [!IMPORTANT]
> Актуальные сведения о регионах, поддерживающих избыточные базы данных в пределах зоны, см. в разделе [Поддержка служб по регионам](../../availability-zones/az-region.md). Конфигурация с избыточностью зоны доступна только при выборе оборудования для вычислений го поколения. Эта функция недоступна в Управляемый экземпляр SQL.

> [!NOTE]
> Общего назначения базы данных размером 80 Виртуальное ядро могут снизить производительность с избыточной конфигурацией зоны. Такие операции, как резервное копирование, восстановление, копирование базы данных и настройка отношений геоаварийного восстановления, могут испытывать низкую производительность для отдельных баз данных, превышающих 1 ТБ. 

## <a name="premium-and-business-critical-service-tier-locally-redundant-availability"></a>Premium и критически важный для бизнеса уровень служб локально избыточная доступность

Уровни служб "Премиум" и "критически важный для бизнеса" используют модель доступности уровня "Премиум", которая интегрирует ресурсы вычислений ( `sqlservr.exe` процесс) и хранилище (локально подключенный SSD) на одном узле. Высокий уровень доступности достигается за счет репликации вычислений и хранилища на дополнительные узлы с созданием кластера из трех и четырех узлов.

![Кластер узлов ядра СУБД](./media/high-availability-sla/business-critical-service-tier.png)

Файлы базы данных (MDF/LDF) помещаются в подключенное хранилище SSD, чтобы обеспечить очень низкую задержку в рабочей нагрузке. Высокий уровень доступности реализуется с помощью технологии, подобной SQL Server [группы доступности Always on](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server). Кластер включает одну первичную реплику, доступную для операций чтения и записи клиентов, а также до трех вторичных реплик (вычислений и хранения), содержащих копии данных. Основной узел постоянно передает изменения на вторичные узлы по порядку и гарантирует, что данные синхронизируются по крайней мере с одной вторичной репликой перед фиксацией каждой транзакции. Этот процесс гарантирует, что если основной узел аварийно завершает работу по какой-либо причине, всегда существует полностью синхронизированный узел для отработки отказа. Отработка отказа инициируется Service Fabricом Azure. После того как вторичная реплика станет новым основным узлом, создается другая вторичная реплика, чтобы убедиться, что кластер имеет достаточное количество узлов (набор кворума). После завершения отработки отказа подключения SQL Azure автоматически перенаправляются на новый основной узел.

В качестве дополнительного преимущества модель доступности Premium включает возможность перенаправлять подключения SQL Azure только для чтения на одну из вторичных реплик. Эта функция называется [горизонтальным масштабированием для чтения](read-scale-out.md). Она предоставляет 100% дополнительной мощности вычислений без дополнительной платы, чтобы отключить загрузку операций только для чтения, таких как аналитические рабочие нагрузки, из первичной реплики.

## <a name="premium-and-business-critical-service-tier-zone-redundant-availability"></a>Избыточная доступность зоны уровня служб Premium и критически важный для бизнеса 

По умолчанию кластер узлов для модели доступности уровня "Премиум" создается в одном центре обработки данных. С появлением [зоны доступности Azure](../../availability-zones/az-overview.md)база данных SQL может разместить разные реплики базы данных критически важный для бизнеса в разных зонах доступности в одном регионе. Чтобы исключить единую точку сбоя, круг управления также дублируется в нескольких зонах в виде трех кругов шлюзов. Маршрутизацией для конкретного круга шлюза управляет [диспетчер трафика Azure](../../traffic-manager/traffic-manager-overview.md) (ATM). Так как конфигурация избыточности в зонах на уровнях "Премиум" или "критически важный для бизнеса" не создает дополнительную избыточность базы данных, ее можно включить без дополнительных затрат. Выбрав конфигурацию с избыточностью зоны, можно сделать базы данных уровня "Премиум" или "критически важный для бизнеса" устойчивыми к большому набору сбоев, включая разрушительные простои центра обработки данных, без каких-либо изменений в логике приложения. Можно также преобразовать любые существующие базы данных или пулы уровня "Премиум" или "Критически важный для бизнеса" в конфигурацию с избыточностью в пределах зоны.

Поскольку базы данных, избыточные в пределах зоны, имеют реплики в разных центрах обработки с определенным расстоянием между ними, увеличенная задержка сети может увеличить время фиксации и, таким же, повлиять на производительность некоторых рабочих нагрузок OLTP. Вы всегда можете вернуться к конфигурации с одной зоной, отключив параметр избыточности в пределах зоны. Этот процесс представляет собой оперативную операцию, аналогичную регулярному обновлению уровня служб. В конце этого процесса база данных или пул переносится из круга с избыточностью в пределах зоны в круг с одной зоной, или наоборот.

> [!IMPORTANT]
> В настоящее время избыточные базы данных и пулы эластичных БД поддерживаются только на уровнях служб "Премиум" и "критически важный для бизнеса" в области выбора. При использовании уровня критически важный для бизнеса конфигурация с избыточностью зоны доступна только при выборе оборудования для вычислений го поколения. Актуальные сведения о регионах, поддерживающих избыточные базы данных в пределах зоны, см. в разделе [Поддержка служб по регионам](../../availability-zones/az-region.md).

> [!NOTE]
> Эта функция недоступна в Управляемый экземпляр SQL.

На следующей схеме показана версия архитектуры с высоким уровнем доступности и избыточностью в пределах зоны.

![Архитектура с высоким уровнем доступности и избыточностью в пределах зоны](./media/high-availability-sla/zone-redundant-business-critical-service-tier.png)


## <a name="hyperscale-service-tier-availability"></a>Доступность уровня службы "линейка"

Архитектура уровня службы "линейка" описана в статье [Архитектура распределенных функций](https://docs.microsoft.com/azure/sql-database/sql-database-service-tier-hyperscale#distributed-functions-architecture) . она доступна только для базы данных SQL, а не для SQL управляемый экземпляр.

![Функциональная архитектура с масштабированием](./media/high-availability-sla/hyperscale-architecture.png)

Модель доступности в масштабировании включает четыре слоя:

- Уровень вычислений без отслеживания состояния, который запускает `sqlservr.exe` процессы и содержит только временные и кэшированные данные, такие как неохватывающие кэш RBPEX, tempdb, базу данных model и т. д. на подключенном SSD, а также кэш планов, буферный пул и пул columnstore в памяти. Этот уровень без отслеживания состояния включает основную реплику вычислений и, при необходимости, ряд вторичных реплик, которые могут использоваться в качестве целевых объектов отработки отказа.
- Уровень хранилища без отслеживания состояния, сформированный серверами страниц. Этот уровень является механизмом распределенного хранилища для `sqlservr.exe` процессов, выполняющихся в репликах вычислений. Каждый сервер страниц содержит только временные и кэшированные данные, например, охватывающий кэш RBPEX на подключенном SSD-накопителе и страницы данных, кэшированные в памяти. На каждом сервере страниц имеется парный сервер страниц в конфигурации "активный — активный", обеспечивающий балансировку нагрузки, избыточность и высокий уровень доступности.
- Уровень хранения журнала транзакций с отслеживанием состояния, сформированный узлом вычислений, на котором выполняется процесс службы журнала, зона размещения журнала транзакций и долгосрочное хранение журнала транзакций. Целевая зона и долгосрочное хранение используют службу хранилища Azure, которая обеспечивает доступность и [избыточность](https://docs.microsoft.com/azure/storage/common/storage-redundancy) для журнала транзакций, гарантируя устойчивость данных для зафиксированных транзакций.
- Уровень хранилища данных с отслеживанием состояния с файлами базы данных (MDF/NDF), которые хранятся в службе хранилища Azure и обновляются серверами страниц. Этот уровень использует функции доступности и [избыточности](https://docs.microsoft.com/azure/storage/common/storage-redundancy) данных в службе хранилища Azure. Гарантируется, что каждая страница в файле данных будет сохранена даже в том случае, если процессы на других уровнях сбоя в архитектуре пройдут сбой или если произошел сбой в работе узлов вычислений.

На всех уровнях масштабирования выполняются узлы, работающие на Service Fabric Azure, которые позволяют управлять работоспособностью каждого узла и при необходимости выполнять отработку отказа на доступные работоспособные узлы.

Дополнительные сведения о высокой доступности в масштабировании см. [в статье высокая доступность базы данных в масштабах](https://docs.microsoft.com/azure/sql-database/sql-database-service-tier-hyperscale#database-high-availability-in-hyperscale).


## <a name="accelerated-database-recovery-adr"></a>Ускоренное восстановление базы данных (ADR)

Технология [ускоренного восстановления базы данных (ADR)](../accelerated-database-recovery.md) — это новая функция ядра СУБД, которая значительно улучшает доступность базы данных, особенно при наличии длительных транзакций. В настоящее время ADR доступен для базы данных SQL Azure, Azure SQL Управляемый экземпляр и Azure синапсе Analytics (ранее — хранилище данных SQL).

## <a name="testing-application-fault-resiliency"></a>Тестирование отказоустойчивости приложения

Высокий уровень доступности — это фундаментальная часть Базы данных SQL и платформы Управляемого экземпляра SQL, которая прозрачно работает для приложения базы данных. Однако мы понимаем, что может потребоваться проверить, как операции автоматического перехода на другой ресурс, инициированные во время запланированных или незапланированных событий, повлияют на приложение перед развертыванием его в рабочей среде. Можно запустить отработку отказа вручную, вызвав специальный API для перезапуска базы данных, эластичного пула или управляемого экземпляра. В случае избыточной зоны или эластичного пула, вызов API приведет к перенаправлению клиентских подключений к новой базе данных-источнику в зоне доступности, отличной от зоны доступности старой первичной реплики. Таким образом, помимо проверки того, как отработка отказа влияет на существующие сеансы базы данных, можно также проверить, изменяются ли они в результате изменений задержки в сети. Так как операция перезапуска является неуправляемой, и большое количество них может нагрузить эту платформу, только один вызов отработки отказа разрешается каждые 30 минут для каждой базы данных, эластичного пула или управляемого экземпляра.

Отработку отказа можно инициировать с помощью PowerShell, REST API или Azure CLI.

|Тип развертывания|PowerShell|REST API| Azure CLI|
|:---|:---|:---|:---|
|База данных|[Invoke-Азсклдатабасефаиловер](https://docs.microsoft.com/powershell/module/az.sql/invoke-azsqldatabasefailover)|[Отработка отказа базы данных](/rest/api/sql/databases(failover)/failover/)|[AZ RESTful](https://docs.microsoft.com/cli/azure/reference-index#az-rest) можно использовать для вызова вызова REST API из Azure CLI|
|Эластичный пул|[Invoke-Азсклеластикпулфаиловер](https://docs.microsoft.com/powershell/module/az.sql/invoke-azsqlelasticpoolfailover)|[Отработка отказа эластичного пула](/rest/api/sql/elasticpools(failover)/failover/)|[AZ RESTful](https://docs.microsoft.com/cli/azure/reference-index#az-rest) можно использовать для вызова вызова REST API из Azure CLI|
|Базы данных SQL|[Invoke-Азсклинстанцефаиловер](/powershell/module/az.sql/Invoke-AzSqlInstanceFailover/)|[Управляемые экземпляры — отработка отказа](https://docs.microsoft.com/rest/api/sql/managed%20instances%20-%20failover/failover)|[AZ SQL MI Failover](/cli/azure/sql/mi/#az-sql-mi-failover)|

> [!IMPORTANT]
> Команда отработки отказа недоступна для доступных для чтения вторичных реплик баз данных с масштабированием.

## <a name="conclusion"></a>Заключение

База данных SQL Azure и Управляемый экземпляр Azure SQL — это встроенное решение с высоким уровнем доступности, которое тесно интегрировано с платформой Azure. Это зависит от Service Fabric для обнаружения сбоев и восстановления, в хранилище BLOB-объектов Azure для защиты данных, а также на Зоны доступности для повышения отказоустойчивости (как упоминалось ранее в документе, который еще не применим к Azure SQL Управляемый экземпляр). Кроме того, база данных SQL и SQL Управляемый экземпляр используют технологию группы доступности Always On из экземпляра SQL Server для репликации и отработки отказа. Сочетание этих технологий позволяет приложениям полностью реализовать преимущества модели смешанного хранения и поддерживать наиболее ресурсоемкие соглашения об уровне обслуживания.

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте больше о [зонах доступности Azure](../../availability-zones/az-overview.md).
- Дополнительные сведения о [Service Fabric](../../service-fabric/service-fabric-overview.md)
- Дополнительные сведения о [диспетчере трафика Azure](../../traffic-manager/traffic-manager-overview.md).
- Узнайте, [как инициировать отработку отказа вручную на управляемый экземпляр SQL](../managed-instance/user-initiated-failover.md)
- Чтобы изучить дополнительные возможности обеспечения высокой доступности и аварийного восстановления, ознакомьтесь с [непрерывностью бизнес-процессов](business-continuity-high-availability-disaster-recover-hadr-overview.md).
