---
title: Аварийное восстановление
description: Узнайте, как восстановить базу данных из регионального центра обработки данных или сбой с помощью активной георепликации базы данных SQL Azure и возможностей географического восстановления.
services: sql-database
ms.service: sql-database
ms.subservice: high-availability
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: mathoma, sstein
ms.date: 06/21/2019
ms.openlocfilehash: e88c1b976ce1de0ce0be4b6a5f85af6790802323
ms.sourcegitcommit: 32c521a2ef396d121e71ba682e098092ac673b30
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2020
ms.locfileid: "91321634"
---
# <a name="restore-your-azure-sql-database-or-failover-to-a-secondary"></a>Восстановление базы данных SQL Azure или отработки отказа на сервер-получатель
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

База данных SQL Azure предоставляет следующие возможности восстановления после сбоя:

- [активная георепликация;](active-geo-replication-overview.md)
- [Группы автоматической отработки отказа](auto-failover-group-overview.md)
- [Геовосстановление](recovery-using-backups.md#point-in-time-restore)
- [Базы данных, избыточные между зонами](high-availability-sla.md)

Чтобы узнать о сценариях непрерывности бизнес-процессов и функциях, которые их обеспечивают, ознакомьтесь с [непрерывностью бизнес-процессов](business-continuity-high-availability-disaster-recover-hadr-overview.md).

> [!NOTE]
> При использовании избыточных между зонами пулов и баз данных уровня "Премиум"или "Критически важный для бизнеса" процесс восстановления автоматизирован. Поэтому описанные в этой статье действия выполнять не нужно.
>
> База данных-источник и база данных-получатель должны иметь один и тот же уровень служб. Также настоятельно рекомендуется создать базу данных-получатель с тем же объемом вычислений (DTU или виртуальных ядер), что и в первичной реплике. Дополнительные сведения см. в разделе [обновление или понижение уровня в качестве базы данных источника](active-geo-replication-overview.md#upgrading-or-downgrading-primary-database).
>
> Используйте одну или несколько групп отработки отказа для управления отработкой отказа нескольких баз данных.
> При добавлении существующей связи георепликации к группе отработки отказа убедитесь, что база данных-получатель геореплицируемых данных настроена с тем же уровнем служб и объемом вычислительных ресурсов, что и база данных-источник. Дополнительные сведения см. [в разделе Использование групп автоматической отработки отказа для включения прозрачной и координированной отработки отказа нескольких баз данных](auto-failover-group-overview.md).

## <a name="prepare-for-the-event-of-an-outage"></a>Подготовка к событию сбоя

Для успешного восстановления в другой регион с помощью групп отработки отказа или геоизбыточных резервных копий необходимо подготовить сервер в другом центре обработки данных, который в случае сбоя станет новым сервером-источником, если это будет необходимо. Следует также задокументировать и внедрить четко определенные инструкции, чтобы обеспечить отсутствие проблем при восстановлении. Эти подготовительные действия приведены ниже.

- Найдите сервер в другом регионе, чтобы стать новым основным сервером. При использовании геовосстановления обычно это сервер в [сопряженном регионе](../../best-practices-availability-paired-regions.md) того региона, в котором расположена база данных. Это исключает дополнительные затраты на трафик во время операций геовосстановления.
- Идентифицируйте и при необходимости определите правила брандмауэра для IP-адресов уровня сервера, необходимые пользователям для доступа к новой базе данных-источнику.
- Определите, как пользователи будут перенаправляться к новому серверу-источнику: например, изменяя строки подключения или записи DNS.
- Определите и при необходимости создайте имена для входа, которые должны присутствовать в базе данных master на новом сервере-источнике, и убедитесь, что эти имена для входа имеют соответствующие разрешения в базе данных master, если таковые имеются. Дополнительные сведения см. в разделе [Как управлять безопасностью базы данных SQL после аварийного восстановления](active-geo-replication-security-configure.md).
- Определите правила генерации оповещений, которые потребуется обновить для сопоставления с новой базой данных-источником.
- Задокументируйте конфигурацию аудита текущей базы данных-источника.
- Выполните [детализацию аварийного восстановления](disaster-recovery-drills.md). Чтобы сымитировать сбой для географического восстановления, можно удалить или переименовать исходную базу данных, что приведет к сбою подключения приложения. Чтобы сымитировать сбой с помощью групп отработки отказа, отключите веб-приложение или виртуальную машину, подключенную к базе данных, или отработку отказа базы данных, чтобы вызвать сбой подключения приложения.

## <a name="when-to-initiate-recovery"></a>Время начала восстановления

Операция восстановления влияет на приложение. Для ее выполнения необходимо изменить строку подключения SQL или перенаправление с помощью DNS, что может привести к безвозвратной потере данных. Поэтому восстановление следует выполнять, только если сбой будет длиться дольше, чем целевое время восстановления приложения. При развертывании приложения в рабочей среде следует выполнять регулярное отслеживание работоспособности приложений и использовать следующие точки данных для подтверждения гарантированного восстановления.

1. Постоянная ошибка подключения из уровня приложения к базе данных.
2. На портале Azure отображается оповещение о происшествии с большой степенью воздействия в регионе.

> [!NOTE]
> Если вы используете группы отработки отказа и настраиваете автоматический переход на другой ресурс, восстановление выполняется автоматически. Кроме того, этот процесс прозрачен для приложения.

В зависимости от устойчивости приложения к простоям базы данных и возможных последствий для бизнеса можно рассмотреть следующие варианты восстановления.

Для получения последней геореплицированной точки восстановления используйте операцию [получения восстанавливаемой базы данных](https://msdn.microsoft.com/library/dn800985.aspx) (*LastAvailableBackupDate*).

## <a name="wait-for-service-recovery"></a>Ожидание восстановления служб

Группы Azure прилагают все усилия для максимально быстрого восстановления работоспособности служб, но в зависимости от причины это может занимать часы и даже дни.  Если длительный простой некритичен для вашего приложения, вы можете просто дождаться завершения восстановления. В этом случае вам не нужно предпринимать какие-либо действия. Текущее состояние служб можно просмотреть на [панели мониторинга работоспособности служб Azure](https://azure.microsoft.com/status/). После восстановления региона ваше приложение снова станет доступным.

## <a name="fail-over-to-geo-replicated-secondary-server-in-the-failover-group"></a>Отработка отказа на геореплицированный сервер-получатель в группе отработки отказа

Если время простоя приложения может привести к появлению бизнес-ответственности, следует использовать группы отработки отказа. Это позволит приложению в случае сбоя быстро восстановить доступность в другом регионе. Дополнительные сведения см. в [руководстве по реализации географически распределенной базы данных](geo-distributed-application-configure-tutorial.md).

Чтобы восстановить доступность баз данных, необходимо инициировать отработку отказа на сервер-получатель с помощью одного из поддерживаемых методов.

Чтобы настроить переход на геореплицированную базу данных-получатель, используйте сведения в одном из следующих руководств:

- [Настройка активной георепликации для базы данных SQL Azure с помощью портала Azure и запуск отработки отказа](active-geo-replication-configure-portal.md)
- [Настройка активной георепликации для отдельной базы данных SQL Azure с помощью PowerShell](scripts/setup-geodr-and-failover-database-powershell.md)
- [Отработка отказа на сервер-получатель с помощью Transact-SQL (T-SQL)](/sql/t-sql/statements/alter-database-transact-sql?view=azuresqldb-current#e-failover-to-a-geo-replication-secondary)

## <a name="recover-using-geo-restore"></a>Восстановление с использованием геовосстановления

Если время простоя приложения не приводит к появлению бизнес-обязательств, можно использовать [геовосстановление](recovery-using-backups.md) в качестве метода восстановления баз данных приложений. Эта функция создает копию базы данных из последней геоизбыточной резервной копии.

## <a name="configure-your-database-after-recovery"></a>Настройка базы данных после восстановления

Если вы выполняете восстановления после сбоя с помощью геовосстановления, убедитесь, что подключение к новым базам данных настроено надлежащим образом. В противном случае вы не сможете восстановить нормальную работу приложения. Ниже приведен контрольный список задач для подготовки восстановленной базы данных к использованию в рабочей среде.

### <a name="update-connection-strings"></a>Обновление строк подключения

Так как восстановленная база данных будет находиться на другом сервере, измените строку подключения в приложении, чтобы она указывала на этот сервер.

Дополнительные сведения об изменении строк подключения см. в разделе о соответствующем языке разработки для своей [библиотеки подключений](connect-query-content-reference-guide.md#libraries).

### <a name="configure-firewall-rules"></a>Настройка правил брандмауэра

Убедитесь, что правила брандмауэра, настроенные на сервере и в базе данных, соответствуют правилам, настроенным на основном сервере и в базе данных-источнике. Дополнительные сведения см. в статье [Практическое руководство. Настройка параметров брандмауэра для Базы данных SQL](firewall-configure.md).

### <a name="configure-logins-and-database-users"></a>Настройка учетных данных и пользователей базы данных

Убедитесь, что все учетные данные, используемые приложением, существуют на сервере с восстановленной базой данных. Дополнительные сведения см. в статье [Настройка безопасности для георепликации](active-geo-replication-security-configure.md).

> [!NOTE]
> Необходимо настроить и протестировать правила брандмауэра и имена для входа (и их разрешения) на сервере во время отработки аварийного восстановления. Эти объекты уровня сервера и их конфигурации могут быть недоступны во время сбоя.

### <a name="setup-telemetry-alerts"></a>Настройка оповещений телеметрии

Убедитесь, что существующие настройки правил оповещения обновлены. Они должны соответствовать восстановленной базе данных и другому серверу.

Подробнее о правилах генерации оповещений базы данных см. в разделах [Получение уведомлений об оповещениях](../../azure-monitor/platform/alerts-overview.md) и [Получение информации о работоспособности службы](../../service-health/service-notifications.md).

### <a name="enable-auditing"></a>Включение аудита

Если для доступа к базе данных требуется аудит, то после восстановления базы данных необходимо включить аудит. Дополнительные сведения см. в статье [Аудит базы данных](../../azure-sql/database/auditing-overview.md).

## <a name="next-steps"></a>Дальнейшие действия

- Чтобы узнать об автоматически создаваемых резервных копиях базы данных SQL Azure, ознакомьтесь с разделом [создаваемых автоматически резервных копий базы данных SQL](automated-backups-overview.md)
- Чтобы изучить сценарии проектирования и восстановления непрерывности бизнес-процессов, ознакомьтесь со [сценариями обеспечения непрерывности](business-continuity-high-availability-disaster-recover-hadr-overview.md)
- Чтобы узнать об использовании создаваемых автоматически резервных копий для восстановления, ознакомьтесь с [восстановлением базы данных из резервных копий, инициируемых службой](recovery-using-backups.md)
