---
title: Правила брандмауэра для IP-адресов
description: Настройте правила брандмауэра IP на уровне сервера для базы данных в базе данных SQL Azure или в брандмауэре Azure синапсе Analytics. Управление доступом и настройка правил брандмауэра для IP-адресов на уровне базы данных для базы данных SQL.
services: sql-database
ms.service: sql-database
ms.subservice: security
titleSuffix: Azure SQL Database and Azure Synapse Analytics
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: conceptual
author: VanMSFT
ms.author: vanto
ms.reviewer: sstein
ms.date: 06/17/2020
ms.openlocfilehash: 9b6b0ee6fa33ecd0d677d7d075236517d85d4ab7
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91335149"
---
# <a name="azure-sql-database-and-azure-synapse-ip-firewall-rules"></a>Правила брандмауэра для базы данных SQL Azure и IP-адреса Azure синапсе
[!INCLUDE[appliesto-sqldb-asa](../includes/appliesto-sqldb-asa.md)]

Например, при создании нового сервера в базе данных SQL Azure или Azure синапсе Analytics с именем *MySQLServer*, к примеру, брандмауэр уровня сервера блокирует доступ к общедоступной конечной точке сервера (который доступен по адресу *MySQLServer.Database.Windows.NET*). Для простоты *база данных SQL* используется для ссылки на базу данных SQL и Azure синапсе Analytics (ранее — хранилище данных SQL).

> [!IMPORTANT]
> Эта статья *не* относится к *управляемому экземпляру базы данных SQL Azure*. Сведения о конфигурации сети см. [в статье подключение приложения к Azure SQL управляемый экземпляр](../managed-instance/connect-application-instance.md).
>
> Azure синапсе поддерживает только правила брандмауэра для IP-адресов уровня сервера. Правила брандмауэра для IP-адресов уровня базы данных не поддерживаются.

## <a name="how-the-firewall-works"></a>Как работает брандмауэр

Попытки подключения из Интернета и Azure должны проходить через брандмауэр перед достижением сервера или базы данных, как показано на следующей схеме.

   ![Схема конфигурации брандмауэра][1]

### <a name="server-level-ip-firewall-rules"></a>Правила брандмауэра для IP-адресов на уровне сервера

Эти правила позволяют клиентам обращаться ко всему серверу, то есть ко всем базам данных, которыми он управляет. Правила хранятся в базе данных *master* . Для сервера можно задать не более 128 правил брандмауэра для IP-адресов на уровне сервера. Если у вас есть **разрешение на доступ к этому параметру сервера для служб и ресурсов Azure** , это считается одним правилом брандмауэра для сервера.
  
Правила брандмауэра IP на уровне сервера можно настроить с помощью инструкций портал Azure, PowerShell или Transact-SQL.

- Чтобы использовать портал или PowerShell, необходимо быть владельцем подписки или участником подписки.
- Чтобы использовать Transact-SQL, необходимо подключиться к базе данных *master* в качестве имени входа субъекта уровня сервера или администратора Azure Active Directory. (Правило брандмауэра IP уровня сервера должно быть создано пользователем, имеющим разрешения уровня Azure.)

### <a name="database-level-ip-firewall-rules"></a>Правила брандмауэра для IP-адресов на уровне базы данных

Правила брандмауэра для IP-адресов уровня базы данных позволяют клиентам получать доступ к определенным (защищенным) базам данных. Правила создаются для каждой базы данных (включая базу данных *master* ) и хранятся в отдельной базе данных.
  
- Создавать и администрировать правила брандмауэра IP уровня базы данных для баз данных master и User можно только с помощью инструкций Transact-SQL и только после настройки первого брандмауэра на уровне сервера.
- Если указать диапазон IP-адресов в правиле брандмауэра IP уровня базы данных, который находится за пределами диапазона в правиле брандмауэра IP на уровне сервера, то только те клиенты, у которых есть IP-адреса в диапазоне уровня базы данных, могут получить доступ к базе данных.
- Для базы данных можно задать не более 128 правил брандмауэра для IP-адресов на уровне базы данных. Дополнительные сведения о настройке правил брандмауэра для IP-адресов на уровне базы данных см. в примере ниже в этой статье и см. в разделе [sp_set_database_firewall_rule (база данных SQL Azure)](https://msdn.microsoft.com/library/dn270010.aspx).

### <a name="recommendations-for-how-to-set-firewall-rules"></a>Рекомендации по настройке правил брандмауэра

При возможности рекомендуется использовать правила брандмауэра для IP-адресов уровня базы данных. Такой подход повышает безопасность и расширяет возможности для переноса базы данных. Используйте правила брандмауэра IP на уровне сервера для администраторов. Их также можно использовать при наличии большого количества баз данных, имеющих одинаковые требования к доступу, и вы не хотите настраивать каждую базу данных по отдельности.

> [!NOTE]
> Сведения о портативных базах данных в контексте непрерывности бизнес-процессов см. в разделе [Требования к проверке подлинности для аварийного восстановления](active-geo-replication-security-configure.md).

## <a name="server-level-versus-database-level-ip-firewall-rules"></a>Правила брандмауэра для IP-адресов уровня сервера и уровня базы данных

*Необходимо ли полностью изолировать пользователей одной базы данных от пользователей другой базы данных ?*

Если *Да*, используйте правила брандмауэра для IP-адресов на уровне базы данных, чтобы предоставить доступ. Этот метод позволяет избежать использования правил брандмауэра IP на уровне сервера, позволяющих получить доступ через брандмауэр ко всем базам данных. Это снизит глубину защиты.

*Требуются ли пользователям с IP-адресами доступ ко всем базам данных?*

Если *Да*, используйте правила брандмауэра IP на уровне сервера, чтобы сократить число попыток настройки правил брандмауэра IP.

*Имеет ли пользователь или группа, которые настраивают правила брандмауэра IP, доступ только через портал Azure, PowerShell или REST API?*

В этом случае необходимо использовать правила брандмауэра для IP-адресов на уровне сервера. Правила брандмауэра IP-адресов уровня базы данных можно настроить только с помощью Transact-SQL.  

*Пользователь или группа, которые настраивают правила брандмауэра IP-адресов, не имеют разрешения высокого уровня на уровне базы данных?*

Если это так, используйте правила брандмауэра IP на уровне сервера. Для настройки правил брандмауэра для IP-адресов уровня базы данных с помощью Transact-SQL требуется по крайней мере разрешение *Control Database* на уровне базы данных.  

*Пользователь или группа, которые настраивают или подлежат аудиту правил брандмауэра IP-адресов, централизованно управляют правилами брандмауэра IP-адресов для многих (возможно, сотен) баз данных?*

В этом сценарии рекомендации определяются вашими потребностями и средой. Правила брандмауэра для IP-адресов на уровне сервера проще настроить, но сценарии позволяют настроить правила уровня базы данных. Даже если используются правила брандмауэра IP на уровне сервера, может потребоваться выполнить аудит правил брандмауэра для IP-адресов на уровне базы данных, чтобы узнать, есть ли пользователи с разрешением *Control* на базу данных создание правил брандмауэра для IP-адресов на уровне базы данных.

*Можно ли использовать правила брандмауэра IP уровня сервера и уровня базы данных?*

Да. Некоторым пользователям, например администраторам, могут потребоваться правила брандмауэра для IP-адресов на уровне сервера. А другим пользователям, например пользователям приложения базы данных, необходимы правила брандмауэра для IP-адресов на уровне базы данных.

### <a name="connections-from-the-internet"></a>Подключения через Интернет

Когда компьютер пытается подключиться к серверу из Интернета, брандмауэр сначала проверяет исходный IP-адрес запроса по правилам брандмауэра IP уровня базы данных для базы данных, которую запрашивает соединение.

- Если адрес находится в диапазоне, указанном в правилах брандмауэра IP-адресов уровня базы данных, то соединение предоставляется базе данных, содержащей правило.
- Если адрес не входит в диапазон правил брандмауэра для IP-адресов уровня базы данных, брандмауэр проверяет правила брандмауэра IP-адресов на уровне сервера. Если адрес находится в диапазоне, который находится в правилах брандмауэра IP на уровне сервера, соединение предоставляется. Правила брандмауэра IP-адресов уровня сервера применяются ко всем базам данных, которыми управляет сервер.  
- Если адрес находится не в диапазоне, который находится в каком-либо из правил брандмауэра на уровне базы данных или на уровне сервера, запрос на подключение завершается ошибкой.

> [!NOTE]
> Чтобы получить доступ к базе данных SQL Azure с локального компьютера, убедитесь, что брандмауэр в сети и локальный компьютер разрешают исходящие подключения через TCP-порт 1433.

### <a name="connections-from-inside-azure"></a>Подключения из Azure

Чтобы разрешить приложениям, размещенным в Azure, подключаться к серверу SQL Server, необходимо включить подключения Azure. Когда приложение из Azure пытается подключиться к серверу, брандмауэр проверяет, разрешены ли подключения Azure. Это можно включить непосредственно из колонки портал Azure, задав правила брандмауэра, а также включив параметр **Разрешить службам и ресурсам Azure доступ к этому серверу** **в** параметрах **брандмауэры и виртуальные сети** . Если соединение не разрешено, запрос не достигает сервера.

> [!IMPORTANT]
> Этот параметр позволяет настроить брандмауэр для разрешения всех подключений из Azure, включая подключения из подписок других клиентов. При выборе этого параметра убедитесь, что учетные данные и разрешения пользователя ограничивают доступ только для полномочных пользователей.

## <a name="permissions"></a>Разрешения

Чтобы иметь возможность создавать правила брандмауэра для IP-адресов для SQL Server Azure и управлять ими, необходимо:

- в роли [участника SQL Server](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#sql-server-contributor)
- в роли [диспетчера безопасности SQL](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#sql-security-manager)
- Владелец ресурса, который содержит SQL Server Azure

## <a name="create-and-manage-ip-firewall-rules"></a>Создание и администрирование правил брандмауэра для IP-адресов

Первый параметр брандмауэра на уровне сервера создается с помощью [портал Azure](https://portal.azure.com/) или программным путем с помощью [Azure PowerShell](https://docs.microsoft.com/powershell/module/az.sql), [Azure CLI](https://docs.microsoft.com/cli/azure/sql/server/firewall-rule)или [REST API](https://docs.microsoft.com/rest/api/sql/firewallrules/createorupdate)Azure. Вы создаете дополнительные правила брандмауэра IP на уровне сервера и управляете ими с помощью этих методов или Transact-SQL.

> [!IMPORTANT]
> Правила брандмауэра IP уровня базы данных могут создаваться и управляться только с помощью Transact-SQL.

Для повышения производительности правила брандмауэра для IP-адресов на уровне сервера временно кэшируются на уровне базы данных. Сведения об обновлении кэша см. в статье [DBCC FLUSHAUTHCACHE (Transact-SQL)](https://msdn.microsoft.com/library/mt627793.aspx).

> [!TIP]
> [Аудит базы данных](../../azure-sql/database/auditing-overview.md) можно использовать для аудита изменений брандмауэра на уровне сервера и базы данных.

### <a name="use-the-azure-portal-to-manage-server-level-ip-firewall-rules"></a>Использование портал Azure для управления правилами брандмауэра IP на уровне сервера

Чтобы задать правило брандмауэра IP на уровне сервера в портал Azure, перейдите на страницу Обзор для своей базы данных или сервера.

> [!TIP]
> Руководство см. в разделе [Создание базы данных с помощью портал Azure](single-database-create-quickstart.md).

#### <a name="from-the-database-overview-page"></a>На странице "Обзор базы данных"

1. Чтобы задать правило брандмауэра IP на уровне сервера на странице Обзор базы данных, на панели инструментов выберите **задать брандмауэр сервера** , как показано на следующем рисунке.

    ![Правило брандмауэра IP-адреса сервера](./media/firewall-configure/sql-database-server-set-firewall-rule.png)

    Откроется страница **Параметры брандмауэра** сервера.

2. Выберите **Добавить IP-адрес клиента** на панели инструментов для добавления IP-адреса компьютера, который вы используете, а затем нажмите кнопку **сохранить**. Для текущего IP-адреса будет создано правило брандмауэра для IP-адресов на уровне сервера.

    ![Задать правило брандмауэра IP на уровне сервера](./media/firewall-configure/sql-database-server-firewall-settings.png)

#### <a name="from-the-server-overview-page"></a>На странице обзора сервера

Откроется страница обзора сервера. Он отображает полное имя сервера (например, *mynewserver20170403.Database.Windows.NET*) и предоставляет параметры для дальнейшей настройки.

1. Чтобы задать правило уровня сервера на этой странице, выберите брандмауэр в меню **Параметры** в левой части **экрана** .

2. Выберите **Добавить IP-адрес клиента** на панели инструментов для добавления IP-адреса компьютера, который вы используете, а затем нажмите кнопку **сохранить**. Для текущего IP-адреса будет создано правило брандмауэра для IP-адресов на уровне сервера.

### <a name="use-transact-sql-to-manage-ip-firewall-rules"></a>Использование Transact-SQL для управления правилами брандмауэра IP-адресов

| Представление каталога или хранимая процедура | Level | Описание |
| --- | --- | --- |
| [sys.firewall_rules](/sql/relational-databases/system-catalog-views/sys-firewall-rules-azure-sql-database) |Сервер |Отображает текущие правила брандмауэра для IP-адресов на уровне сервера |
| [sp_set_firewall_rule](/sql/relational-databases/system-stored-procedures/sp-set-firewall-rule-azure-sql-database) |Сервер |Создает или обновляет правила брандмауэра для IP-адресов на уровне сервера |
| [sp_delete_firewall_rule](/sql/relational-databases/system-stored-procedures/sp-delete-firewall-rule-azure-sql-database) |Сервер |Удаляет правила брандмауэра для IP-адресов на уровне сервера |
| [sys.database_firewall_rules](/sql/relational-databases/system-catalog-views/sys-database-firewall-rules-azure-sql-database) |База данных |Отображает текущие правила брандмауэра для IP-адресов на уровне базы данных |
| [sp_set_database_firewall_rule](/sql/relational-databases/system-stored-procedures/sp-set-database-firewall-rule-azure-sql-database) |База данных |Создает или обновляет правила брандмауэра для IP-адресов на уровне базы данных |
| [sp_delete_database_firewall_rule](/sql/relational-databases/system-stored-procedures/sp-delete-database-firewall-rule-azure-sql-database) |Базы данных |Удаляет правила брандмауэра для IP-адресов на уровне базы данных |

В следующем примере просматриваются существующие правила, включается диапазон IP-адресов на сервере *contoso*и удаляется правило брандмауэра IP-адреса.

```sql
SELECT * FROM sys.firewall_rules ORDER BY name;
```

Затем добавьте правило брандмауэра для IP-адресов на уровне сервера.

```sql
EXECUTE sp_set_firewall_rule @name = N'ContosoFirewallRule',
   @start_ip_address = '192.168.1.1', @end_ip_address = '192.168.1.10'
```

Чтобы удалить правило брандмауэра IP на уровне сервера, выполните хранимую процедуру *sp_delete_firewall_rule* . В следующем примере удаляется правило *ContosoFirewallRule*:

```sql
EXECUTE sp_delete_firewall_rule @name = N'ContosoFirewallRule'
```

### <a name="use-powershell-to-manage-server-level-ip-firewall-rules"></a>Использование PowerShell для управления правилами брандмауэра IP на уровне сервера

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается базой данных SQL Azure, но теперь для модуля AZ. SQL используется вся разработка. Сведения об этих командлетах см. в разделе [AzureRM.Sql](/powershell/module/AzureRM.Sql/). Аргументы для команд в модулях AZ и AzureRm существенно идентичны.

| Командлет | Level | Описание |
| --- | --- | --- |
| [Get-Азсклсерверфиреваллруле](/powershell/module/az.sql/get-azsqlserverfirewallrule) |Сервер |Возвращает текущие правила брандмауэра уровня сервера |
| [New-AzSqlServerFirewallRule](/powershell/module/az.sql/new-azsqlserverfirewallrule) |Сервер |Создает новое правило брандмауэра уровня сервера |
| [Set-Азсклсерверфиреваллруле](/powershell/module/az.sql/set-azsqlserverfirewallrule) |Сервер |Обновляет свойства существующего правила брандмауэра уровня сервера |
| [Remove-Азсклсерверфиреваллруле](/powershell/module/az.sql/remove-azsqlserverfirewallrule) |Сервер |Удаляет правила брандмауэра уровня сервера |

В следующем примере с помощью PowerShell задается правило брандмауэра IP на уровне сервера:

```powershell
New-AzSqlServerFirewallRule -ResourceGroupName "myResourceGroup" `
    -ServerName $servername `
    -FirewallRuleName "ContosoIPRange" -StartIpAddress "192.168.1.0" -EndIpAddress "192.168.1.255"
```

> [!TIP]
> Для $servername укажите имя сервера, а не полное DNS-имя, например, укажите **мисклдбсервер** вместо **mysqldbserver.Database.Windows.NET** .
>
> Примеры для PowerShell в контексте краткого руководства см. в статьях создание базы данных [PowerShell](powershell-script-content-guide.md) и [Настройка правила брандмауэра IP на уровне сервера с помощью PowerShell](scripts/create-and-configure-database-powershell.md).

### <a name="use-cli-to-manage-server-level-ip-firewall-rules"></a>Использование интерфейса командной строки для управления правилами брандмауэра IP на уровне сервера

| Командлет | Level | Описание |
| --- | --- | --- |
|[az sql server firewall-rule create](/cli/azure/sql/server/firewall-rule#az-sql-server-firewall-rule-create)|Сервер|Создает правило брандмауэра для IP-адресов на уровне сервера|
|[az sql server firewall-rule list](/cli/azure/sql/server/firewall-rule#az-sql-server-firewall-rule-list)|Сервер|Выводит список правил брандмауэра для IP-адресов на сервере|
|[az sql server firewall-rule show](/cli/azure/sql/server/firewall-rule#az-sql-server-firewall-rule-show)|Сервер|Отображение сведений о правиле брандмауэра IP-адресов|
|[az sql server firewall-rule update](/cli/azure/sql/server/firewall-rule##az-sql-server-firewall-rule-update)|Сервер|Обновляет правило брандмауэра IP-адресов.|
|[az sql server firewall-rule delete](/cli/azure/sql/server/firewall-rule#az-sql-server-firewall-rule-delete)|Сервер|Удаление правила брандмауэра IP-адресов|

В следующем примере с помощью интерфейса командной строки задается правило брандмауэра IP на уровне сервера:

```azurecli-interactive
az sql server firewall-rule create --resource-group myResourceGroup --server $servername \
-n ContosoIPRange --start-ip-address 192.168.1.0 --end-ip-address 192.168.1.255
```

> [!TIP]
> Для $servername укажите имя сервера, а не полное DNS-имя, например, укажите **мисклдбсервер** вместо **mysqldbserver.Database.Windows.NET** .
>
> Пример для интерфейса командной строки в контексте краткого руководства см. в разделе [CREATE DB-Azure CLI](az-cli-script-samples-content-guide.md) и [Создание отдельной базы данных и настройка правила брандмауэра IP на уровне сервера с помощью Azure CLI](scripts/create-and-configure-database-cli.md).

### <a name="use-a-rest-api-to-manage-server-level-ip-firewall-rules"></a>Использование REST API для управления правилами брандмауэра IP на уровне сервера

| API | Level | Описание |
| --- | --- | --- |
| [Вывод списка правил брандмауэра](https://docs.microsoft.com/rest/api/sql/firewallrules/listbyserver) |Сервер |Отображает текущие правила брандмауэра для IP-адресов на уровне сервера |
| [Создание или обновление правил брандмауэра](https://docs.microsoft.com/rest/api/sql/firewallrules/createorupdate) |Сервер |Создает или обновляет правила брандмауэра для IP-адресов на уровне сервера |
| [Удаление правил брандмауэра](https://docs.microsoft.com/rest/api/sql/firewallrules/delete) |Сервер |Удаляет правила брандмауэра для IP-адресов на уровне сервера |
| [Получение правил брандмауэра](https://docs.microsoft.com/rest/api/sql/firewallrules/get) | Сервер | Возвращает правила брандмауэра для IP-адресов на уровне сервера |

## <a name="troubleshoot-the-database-firewall"></a>Устранение неполадок брандмауэра базы данных

Если доступ к базе данных SQL Azure не работает должным образом, учитывайте следующие моменты.

- **Конфигурация локального брандмауэра**

  Прежде чем компьютер сможет получить доступ к Базе данных SQL Azure, может потребоваться создать на компьютере исключение брандмауэра для TCP-порта 1433. Чтобы установить подключения внутри границы облака Azure, может потребоваться открыть дополнительные порты. Дополнительные сведения см. в разделе "база данных SQL: за пределами Vs Inside" [портов за пределами 1433 для ADO.NET 4,5 и базы данных SQL Azure](adonet-v12-develop-direct-route-ports.md).

- **Преобразование сетевых адресов:**

  В связи с преобразованием сетевых адресов (NAT) IP-адрес, используемый вашим компьютером для подключения к базе данных SQL Azure, может отличаться от IP-адреса в параметрах IP-конфигурации вашего компьютера. Чтобы просмотреть IP-адрес, который используется компьютером для подключения к Azure, сделайте следующее:
    1. Войдите на портал.
    1. Перейдите на вкладку **Настройка** на сервере, на котором размещена ваша база данных.
    1. **IP-адрес текущего клиента** отображается в разделе **Разрешенные IP-адреса** . Выберите **Добавить** для **разрешенных IP-адресов** , чтобы разрешить этому компьютеру доступ к серверу.

- **Изменения в списке разрешений еще не вступили в действие:**

  Для вступления в силу изменений конфигурации брандмауэра базы данных SQL Azure может потребоваться около пяти минут.

- **Имя входа не имеет полномочий или был использован неверный пароль:**

  Если у имени входа нет разрешений на сервере или пароль неверен, соединение с сервером будет отклонено. Создание параметра брандмауэра дает клиентам *возможность* попытаться подключиться к серверу. Клиент по-прежнему должен предоставлять необходимые учетные данные безопасности. Дополнительные сведения о подготовке имен входа см. в разделе [Управление доступом к базе данных и предоставление доступа к ним](logins-create-manage.md).

- **Динамический IP-адрес:**

  Если у вас есть подключение к Интернету, использующее динамическую IP-адресацию, и у вас возникли проблемы с брандмауэром, попробуйте одно из следующих решений.
  
  - Попросите поставщика услуг Интернета указать диапазон IP-адресов, назначенный клиентским компьютерам, которые обращаются к серверу. Добавьте этот диапазон IP-адресов в качестве правила брандмауэра IP.
  - Для клиентских компьютеров следует получить статические IP-адреса. Добавьте IP-адреса в качестве правил брандмауэра IP-адресов.

## <a name="next-steps"></a>Дальнейшие шаги

- Убедитесь, что корпоративная сетевая среда разрешает входящий трафик из диапазонов вычислительных IP-адресов (включая диапазоны SQL), которые используются центрами обработки данных Azure. Может потребоваться добавить эти IP-адреса в список разрешений. См. раздел [диапазоны IP-адресов центра обработки данных Microsoft Azure](https://www.microsoft.com/download/details.aspx?id=41653).  
- Краткое руководство по созданию правила брандмауэра IP на уровне сервера см. в статье [Создание отдельной базы данных в базе данных SQL Azure](single-database-create-quickstart.md).
- Дополнительные сведения о подключении к базе данных в базе данных SQL Azure из приложений с открытым исходным кодом или сторонними приложениями см. [в статье примеры кода для быстрого запуска клиента в базе данных SQL Azure](connect-query-content-reference-guide.md#libraries).
- Дополнительные сведения о дополнительных портах, которые, возможно, потребуется открыть, см. в разделе "база данных SQL: за пределами Vs внутри" [портов за пределами 1433 для ADO.NET 4,5 и базы данных SQL](adonet-v12-develop-direct-route-ports.md) .
- Общие сведения о безопасности базы данных SQL Azure см. в разделе [Защита базы данных](security-overview.md).

<!--Image references-->
[1]: ./media/firewall-configure/sqldb-firewall-1.png
