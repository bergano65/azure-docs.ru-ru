---
title: Копирование базы данных
description: Создайте транзакционно согласованную копию существующей базы данных в базе данных SQL Azure на том же сервере или на другом сервере.
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: sqldbrb=1, devx-track-azurecli
ms.devlang: ''
ms.topic: how-to
author: stevestein
ms.author: sashan
ms.reviewer: ''
ms.date: 10/30/2020
ms.openlocfilehash: 7f053b1984a2d838deb14bacd10cdc071e19d8a1
ms.sourcegitcommit: c4c554db636f829d7abe70e2c433d27281b35183
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "98035144"
---
# <a name="copy-a-transactionally-consistent-copy-of-a-database-in-azure-sql-database"></a>Копирование транзакционно согласованной копии базы данных в базе данных SQL Azure

[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

База данных SQL Azure предоставляет несколько методов создания копии существующей [базы данных](single-database-overview.md) на том же или на другом сервере. Базу данных можно скопировать с помощью портал Azure, PowerShell, Azure CLI или T-SQL.

## <a name="overview"></a>Обзор

Копия базы данных — это транзакционно согласованный моментальный снимок базы данных-источника на момент времени после инициирования запроса на копирование. Для копии можно выбрать один и тот же сервер или другой сервер. Кроме того, можно выбрать сохранение избыточности резервных копий, уровня служб и размера вычислений базы данных-источника, а также использование другой избыточности хранилища резервных копий или размера вычислений в пределах одного или другого уровня служб. После завершения копирования копия становится полностью работоспособной и независимой базой данных. Имена входа, пользователи и разрешения в копируемой базе данных управляются независимо от базы данных источника. Копия создается с помощью технологии георепликации. После завершения заполнения реплик связь георепликации автоматически прекращается. Все требования для использования георепликации применяются к операции копирования базы данных. Дополнительные сведения см. в разделе [Общие сведения об активной георепликации](active-geo-replication-overview.md) .

> [!NOTE]
> Настраиваемая избыточность хранилища резервных копий базы данных SQL Azure в настоящее время доступна в общедоступной предварительной версии Южная Бразилия и общедоступна в регионе Azure Юго-Восточной Азии. Если в предварительной версии база данных-источник создается с избыточностью хранилища резервных копий с локально избыточностью или с избыточностью зоны, копирование базы данных на сервер в другом регионе Azure не поддерживается. 

## <a name="logins-in-the-database-copy"></a>Имена входа в копии базы данных

При копировании базы данных на тот же сервер можно использовать одни и те же имена входа в обеих базах данных. Субъект безопасности, используемый для копирования базы данных, становится владельцем новой базы данных.

При копировании базы данных на другой сервер участник безопасности, инициирующий операцию копирования на целевом сервере, станет владельцем новой базы данных.

Независимо от целевого сервера все пользователи базы данных, их разрешения и идентификаторы безопасности (SID) копируются в копию базы данных. Использование [пользователей автономной базы данных](logins-create-manage.md) для доступа к данным гарантирует, что скопированная база данных будет иметь те же учетные данные пользователя, поэтому после завершения копирования вы сможете немедленно получить к ней доступ с теми же учетными данными.

Если для доступа к данным и копирования базы данных на другой сервер используются имена для входа на уровне сервера, то доступ на основе имени для входа может не работать. Это может произойти из-за того, что имена для входа не существуют на целевом сервере или пароли и идентификаторы безопасности (SID) отличаются. Дополнительные сведения об управлении именами входа при копировании базы данных на другой сервер см. в статье [Управление безопасностью базы данных SQL Azure после аварийного восстановления](active-geo-replication-security-configure.md). После выполнения операции копирования на другом сервере и до повторного сопоставления других пользователей только имя входа, связанное с владельцем базы данных, или администратор сервера может войти в скопированную базу данных. Сведения об устранении имен входа и установке доступа к данным после копирования см. в разделе [разрешение имен для входа](#resolve-logins).

## <a name="copy-using-the-azure-portal"></a>Копирование с помощью портала Azure

Чтобы скопировать базу данных с помощью портала Azure, откройте страницу базы данных и щелкните **Копировать**.

   ![Копирование базы данных](./media/database-copy/database-copy.png)

## <a name="copy-using-powershell-or-the-azure-cli"></a>Копирование с помощью PowerShell или Azure CLI

Чтобы скопировать базу данных, используйте следующие примеры.

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

Для PowerShell используйте командлет [New-азсклдатабасекопи](/powershell/module/az.sql/new-azsqldatabasecopy) .

> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager (RM) по-прежнему поддерживается базой данных SQL Azure, но вся будущая разработка предназначена для модуля AZ. SQL. Исправления ошибок для модуля AzureRM будут продолжать выпускаться как минимум до декабря 2020 г.  Аргументы команд в модулях Az и AzureRm практически идентичны. Дополнительные сведения о совместимости см. в статье [Знакомство с новым модулем Az для Azure PowerShell](/powershell/azure/new-azureps-module-az).

```powershell
New-AzSqlDatabaseCopy -ResourceGroupName "<resourceGroup>" -ServerName $sourceserver -DatabaseName "<databaseName>" `
    -CopyResourceGroupName "myResourceGroup" -CopyServerName $targetserver -CopyDatabaseName "CopyOfMySampleDatabase"
```

Копия базы данных является асинхронной операцией, но Целевая база данных создается сразу после принятия запроса. Если необходимо отменить операцию копирования, пока все еще выполняется, удалите целевую базу данных с помощью командлета [Remove-азсклдатабасе](/powershell/module/az.sql/new-azsqldatabase) .

Полный пример скрипта PowerShell см. в разделе [копирование базы данных на новый сервер](scripts/copy-database-to-new-server-powershell.md).

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

```azurecli
az sql db copy --dest-name "CopyOfMySampleDatabase" --dest-resource-group "myResourceGroup" --dest-server $targetserver `
    --name "<databaseName>" --resource-group "<resourceGroup>" --server $sourceserver
```

Копия базы данных является асинхронной операцией, но Целевая база данных создается сразу после принятия запроса. Если необходимо отменить операцию копирования, пока все еще выполняется, удалите целевую базу данных с помощью команды [AZ SQL DB Delete](/cli/azure/sql/db#az-sql-db-delete) .

* * *

## <a name="copy-using-transact-sql"></a>Копирование с помощью Transact-SQL

Войдите в базу данных master с помощью имени входа администратора сервера или имени входа, создавшего базу данных, которую необходимо скопировать. Для успешности копирования базы данных имена входа, не являющиеся администраторами сервера, должны быть членами `dbmanager` роли. Дополнительные сведения об именах для входа и подключении к серверу см. в статье [Проверка подлинности и авторизация в базе данных SQL: предоставление доступа](logins-create-manage.md).

Начало копирования базы данных источника с помощью [создания базы данных... В качестве копии](/sql/t-sql/statements/create-database-transact-sql?view=azuresqldb-current&preserve-view=true#copy-a-database) инструкции. Инструкция T-SQL продолжит выполнение до тех пор, пока не будет завершена операция копирования базы данных.

> [!NOTE]
> Завершение выполнения инструкции T-SQL не приводит к завершению операции копирования базы данных. Чтобы завершить операцию, удалите целевую базу данных.
>

> [!IMPORTANT]
> Выбор избыточности хранилища резервных копий при использовании T-SQL создание базы данных... КОПИЯ команды пока не поддерживается. 

### <a name="copy-to-the-same-server"></a>Копирование на тот же сервер

Войдите в базу данных master с помощью имени входа администратора сервера или имени входа, создавшего базу данных, которую необходимо скопировать. Для успешности копирования базы данных имена входа, не являющиеся администраторами сервера, должны быть членами `dbmanager` роли.

Эта команда копирует Database1 в новую базу данных с именем Database2 на том же сервере. Операция копирования может занять некоторое время в зависимости от размера базы данных.

   ```sql
   -- execute on the master database to start copying
   CREATE DATABASE Database2 AS COPY OF Database1;
   ```

### <a name="copy-to-an-elastic-pool"></a>Копирование в эластичный пул

Войдите в базу данных master с помощью имени входа администратора сервера или имени входа, создавшего базу данных, которую необходимо скопировать. Для успешности копирования базы данных имена входа, не являющиеся администраторами сервера, должны быть членами `dbmanager` роли.

Эта команда копирует Database1 в новую базу данных с именем Database2 в эластичном пуле с именем pool1. Операция копирования может занять некоторое время в зависимости от размера базы данных.

Database1 может быть отдельной базой данных или в составе пула. Поддерживается копирование между разными пулами уровней, но некоторые межуровневые копии не будут выполнены. Например, можно скопировать одну или эластичную базу данных Standard в пул общего назначения, но нельзя скопировать стандартную эластичную базу данных в пул уровня "Премиум". 

   ```sql
   -- execute on the master database to start copying
   CREATE DATABASE "Database2"
   AS COPY OF "Database1"
   (SERVICE_OBJECTIVE = ELASTIC_POOL( name = "pool1" ) ) ;
   ```

### <a name="copy-to-a-different-server"></a>Копирование на другой сервер

Войдите в базу данных master на целевом сервере, где должна быть создана новая база данных. Используйте имя входа с тем же именем и паролем, что и у владельца базы данных-источника на исходном сервере. Имя входа на целевом сервере также должно быть членом `dbmanager` роли или иметь имя входа администратора сервера.

Эта команда копирует Database1 на сервере server1 в новую базу данных с именем Database2 на сервере server2. Операция копирования может занять некоторое время в зависимости от размера базы данных.

```sql
-- Execute on the master database of the target server (server2) to start copying from Server1 to Server2
CREATE DATABASE Database2 AS COPY OF server1.Database1;
```

> [!IMPORTANT]
> Брандмауэры обоих серверов должны разрешать входящие подключения от IP-адреса клиента, выполняющего создание базы данных T-SQL... В качестве копии команды.

### <a name="copy-to-a-different-subscription"></a>Копирование в другую подписку

Вы можете выполнить действия, описанные в разделе [копирование базы данных SQL в другой сервер](#copy-to-a-different-server) , чтобы скопировать базу данных на сервер в другой подписке с помощью T-SQL. Убедитесь, что используется имя входа с тем же именем и паролем, что и у владельца базы данных-источника. Кроме того, имя входа должно быть членом `dbmanager` роли или администратора сервера на исходном и целевом серверах.

```sql
Step# 1
Create login and user in the master database of the source server.

CREATE LOGIN loginname WITH PASSWORD = 'xxxxxxxxx'
GO
CREATE USER [loginname] FOR LOGIN [loginname] WITH DEFAULT_SCHEMA=[dbo]
GO

Step# 2
Create the user in the source database and grant dbowner permission to the database.

CREATE USER [loginname] FOR LOGIN [loginname] WITH DEFAULT_SCHEMA=[dbo]
GO
exec sp_addrolemember 'db_owner','loginname'
GO

Step# 3
Capture the SID of the user “loginname” from master database

SELECT [sid] FROM sysusers WHERE [name] = 'loginname'

Step# 4
Connect to Destination server.
Create login and user in the master database, same as of the source server.

CREATE LOGIN loginname WITH PASSWORD = 'xxxxxxxxx', SID = [SID of loginname login on source server]
GO
CREATE USER [loginname] FOR LOGIN [loginname] WITH DEFAULT_SCHEMA=[dbo]
GO
exec sp_addrolemember 'dbmanager','loginname'
GO

Step# 5
Execute the copy of database script from the destination server using the credentials created

CREATE DATABASE new_database_name
AS COPY OF source_server_name.source_database_name
```

> [!NOTE]
> [Портал Azure](https://portal.azure.com), PowerShell и Azure CLI не поддерживают копирование базы данных в другую подписку.

> [!TIP]
> Копирование базы данных с помощью T-SQL поддерживает копирование базы данных из подписки в другом клиенте Azure. Это поддерживается только при использовании имени входа для проверки подлинности SQL для входа на целевой сервер.

## <a name="monitor-the-progress-of-the-copying-operation"></a>Отслеживание хода операции копирования

Отслеживайте процесс копирования, запрашивая представления [sys. databases](/sql/relational-databases/system-catalog-views/sys-databases-transact-sql), [sys.dm_database_copies](/sql/relational-databases/system-dynamic-management-views/sys-dm-database-copies-azure-sql-database)и [sys.dm_operation_status](/sql/relational-databases/system-dynamic-management-views/sys-dm-operation-status-azure-sql-database) . Во время копирования в столбце **state_desc** представления sys. databases для новой базы данных задается значение **копирование**.

* В случае сбоя копирования в столбце **state_desc** представления sys. databases для новой базы данных устанавливается значение **SUSPECT**. Выполните инструкцию DROP для новой базы данных и повторите попытку позднее.
* Если копирование выполняется, столбец **state_desc** в представлении sys. databases для новой базы данных устанавливается в состояние «в **сети**». Это означает, что копирование завершено и новая база данных является обычной базой данных, которую можно изменять независимо от исходной.

> [!NOTE]
> Чтобы отменить копирование до его завершения, выполните в новой базе данных инструкцию [DROP DATABASE](/sql/t-sql/statements/drop-database-transact-sql).

> [!IMPORTANT]
> Если необходимо создать копию с целью существенно меньшей цели обслуживания, чем у источника, то Целевая база данных может не иметь достаточных ресурсов для завершения процесса заполнения, и это может привести к сбою в области Opera. В этом сценарии для создания копии на другом сервере и (или) другом регионе используется запрос географического восстановления. Дополнительные сведения см. в статье [Восстановление базы данных SQL Azure с помощью резервных копий](recovery-using-backups.md#geo-restore) .

## <a name="azure-roles-to-manage-database-copy"></a>Роли Azure для управления копированием базы данных

Чтобы создать копию базы данных, необходимо быть в следующих ролях:

* владельца подписки или
* Роль участника SQL Server или
* Пользовательская роль в исходной и целевой базах данных со следующим разрешением:

   Microsoft. SQL/Servers/databases/Read Microsoft. SQL/Servers/databases/Write

Чтобы отменить копирование базы данных, необходимо иметь следующие роли.

* владельца подписки или
* Роль участника SQL Server или
* Пользовательская роль в исходной и целевой базах данных со следующим разрешением:

   Microsoft. SQL/Servers/databases/Read Microsoft. SQL/Servers/databases/Write

Для управления копированием базы данных с помощью портал Azure также необходимы следующие разрешения.

   Microsoft. Resources/Subscriptions/Resources/Read Microsoft. Resources/Subscriptions/Resources/Write Microsoft. Resources/deployments/Read Microsoft. Resources/deployments/Write Microsoft. Resources/deployments

Если вы хотите просмотреть операции в развертываниях в группе ресурсов на портале, операции в нескольких поставщиках ресурсов, включая операции SQL, понадобятся вам следующие дополнительные роли Azure:

   Microsoft. Resources/Subscriptions/resourcegroups/deployments/Operations/Read Microsoft. Resources/Subscriptions/resourcegroups/deployments/оператионстатусес/Read

## <a name="resolve-logins"></a>Разрешение имен для входа

После того, как новая база данных будет подключена к сети на целевом сервере, используйте инструкцию [ALTER USER](/sql/t-sql/statements/alter-user-transact-sql?view=azuresqldb-current&preserve-view=true) для повторного сопоставления пользователей из новой базы данных с именами входа на целевом сервере. Сведения о разрешении потерянных пользователей см. в разделе [Диагностика пользователей, утративших связь с учетной записью](/sql/sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server). См. также [руководство по управлению безопасностью базы данных SQL Azure после аварийного восстановления](active-geo-replication-security-configure.md).

Все пользователи в новой базе данных получают такие же разрешения, как и в исходной базе данных. Пользователь, инициировавший копирование базы данных, станет владельцем новой базы данных. После завершения копирования и повторного сопоставления других пользователей только владелец базы данных может войти в новую базу данных.

Дополнительные сведения об управлении пользователями и именами входа при копировании базы данных на другой сервер см. в статье [Управление безопасностью базы данных SQL Azure после аварийного восстановления](active-geo-replication-security-configure.md).

## <a name="database-copy-errors"></a>Ошибки копирования базы данных

При копировании базы данных в базе данных SQL Azure могут возникнуть следующие ошибки. Дополнительные сведения см. в статье [Копирование базы данных SQL Azure](database-copy.md).

| Код ошибки | Статус | Описание |
| ---:| ---:|:--- |
| 40635 |16 |Клиент с IP-адресом %.&#x2a;ls временно отключен. |
| 40637 |16 |Возможность создания копии базы данных в настоящее время отключена. |
| 40561 |16 |Не удалось скопировать базу данных. Исходная или целевая база данных не существует. |
| 40562 |16 |Не удалось скопировать базу данных. Исходная база данных удалена. |
| 40563 |16 |Не удалось скопировать базу данных. Целевая база данных удалена. |
| 40564 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку. |
| 40565 |16 |Не удалось скопировать базу данных. Допускается не более одной одновременной операции копирования базы данных из одного источника. Удалите целевую базу данных и повторите попытку позднее. |
| 40566 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку. |
| 40567 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку. |
| 40568 |16 |Не удалось скопировать базу данных. Исходная база данных стала недоступна. Удалите целевую базу данных и повторите попытку. |
| 40569 |16 |Не удалось скопировать базу данных. Целевая база данных стала недоступна. Удалите целевую базу данных и повторите попытку. |
| 40570 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку позднее. |
| 40571 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку позднее. |

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения об именах входа см. в статьях [Управление именами входа](logins-create-manage.md) и [Управление безопасностью базы данных SQL Azure после аварийного восстановления](active-geo-replication-security-configure.md).
* Сведения о том, как экспортировать базу данных, см. в разделе [Экспорт базы данных в BACPAC-](database-export.md)файл.
