---
title: Диагностика производительности в процессе масштабирования
description: В этой статье описывается устранение проблем с производительностью масштабирования в базе данных SQL Azure.
services: sql-database
ms.service: sql-database
ms.subservice: service
ms.custom: seo-lt-2019 sqldbrb=1
ms.topic: troubleshooting
author: denzilribeiro
ms.author: denzilr
ms.reviewer: sstein
ms.date: 10/18/2019
ms.openlocfilehash: 7bd2b404627e21a80fc41a4561300d7252d1519c
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "84324404"
---
# <a name="sql-hyperscale-performance-troubleshooting-diagnostics"></a>Диагностика по устранению неполадок производительности в SQL
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

Для устранения проблем с производительностью в базе данных с масштабированием [Общие методологии настройки производительности](monitor-tune-overview.md) на кластерном узле базы данных SQL Azure являются отправной точкой для анализа производительности. Тем не менее, учитывая [распределенную архитектуру](service-tier-hyperscale.md#distributed-functions-architecture) масштабирования, в помощь добавлены дополнительные диагностические средства. В этой статье описываются диагностические данные, относящиеся к масштабированию.

## <a name="log-rate-throttling-waits"></a>Ожиданий регулирования скорости записи в журнал

Каждый уровень обслуживания базы данных SQL Azure имеет ограничения частоты создания журнала, принудительно реализованные через [Управление частотой ведения журнала](resource-limits-logical-server.md#transaction-log-rate-governance). В этом случае ограничение на создание журнала в настоящее время равно 100 МБ/с, независимо от уровня обслуживания. Однако бывают случаи, когда скорость создания журнала в основной реплике вычислений должна регулироваться для поддержки соглашений об уровне обслуживания для восстановления. Такое регулирование происходит, когда [сервер страницы или другая реплика вычислений](service-tier-hyperscale.md#distributed-functions-architecture) значительно отчасти от применения новых записей журнала из службы журналов.

Следующие типы ожидания (в [sys. dm_os_wait_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-wait-stats-transact-sql/)) описывают причины, по которым скорость ведения журнала может регулироваться в основной реплике вычислений:

|Тип ожидания    |Описание:                         |
|-------------          |------------------------------------|
|RBIO_RG_STORAGE        | Происходит, когда скорость создания журнала основного узла базы данных в масштабе подкачки регулируется из-за отложенного потребления журнала на серверах страниц.         |
|RBIO_RG_DESTAGE        | Происходит при регулировании частоты создания журнала для масштабируемого узла базы данных, обусловленной задержкой использования журнала в долгосрочном хранилище журналов.         |
|RBIO_RG_REPLICA        | Происходит, когда частота создания журнала для расчетного узла базы данных в масштабе подсчета регулируется из-за отложенного потребления журнала вторичными репликами, доступными для чтения.         |
|RBIO_RG_LOCALDESTAGE   | Происходит при регулировании частоты создания журнала для расчетного узла базы данных в соответствии с задержкой использования журнала службой журнала.         |

## <a name="page-server-reads"></a>Операции чтения сервера страниц

Реплики вычислений не кэшируют полную копию базы данных локально. Данные, локальные для реплики вычислений, хранятся в буферном пуле (в памяти) и в локальном кэше расширения пула отказоустойчивого буфера (RBPEX), который является частичным (не охватывающим) кэшем страниц данных. Размер этого локального кэша RBPEX пропорционально размеру вычислений, и в три раза больше памяти уровня вычислений. RBPEX похож на буферный пул в том, что он имеет наиболее часто запрашиваемые данные. С другой стороны, на каждом сервере страницы есть кэш RBPEX для части базы данных, которую она поддерживает.

При выполнении операции чтения в реплике вычислений, если данные не существуют в буферном пуле или локальном кэше RBPEX, выдается вызов функции Page (идентификатор страницы, LSN), а страница извлекается с соответствующего сервера страниц. Операции чтения с серверов страниц — это удаленные операции чтения, поэтому они выполняются медленнее, чем операции чтения из локальной RBPEX. При устранении проблем с производительностью, связанных с операциями ввода-вывода, необходимо иметь возможность определить, сколько IOs выполнялось с помощью относительно медленных операций чтения с удаленного сервера страниц.

Несколько динамических управляемых представлений (DMV) и расширенные события имеют столбцы и поля, указывающие число удалений операций чтения с сервера страниц, которое можно сравнить с общим количеством операций чтения. Хранилище запросов также захватывает удаленные операции чтения в рамках статистики времени выполнения запроса.

- Столбцы, доступные для чтения сервера страниц отчетов, доступны в представлениях DMV выполнения и представлении каталога, например:

  - [sys.dm_exec_requests](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-requests-transact-sql/)
  - [sys.dm_exec_query_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-query-stats-transact-sql/)
  - [sys.dm_exec_procedure_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-procedure-stats-transact-sql/)
  - [sys.dm_exec_trigger_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-trigger-stats-transact-sql/)
  - [sys.query_store_runtime_stats](/sql/relational-databases/system-catalog-views/sys-query-store-runtime-stats-transact-sql/)
- Операции чтения сервера страниц добавляются к следующим расширенным событиям:
  - sql_statement_completed
  - sp_statement_completed
  - sql_batch_completed
  - rpc_completed
  - scan_stopped
  - query_store_begin_persist_runtime_stat
  - запрос — store_execution_runtime_info
- Актуалпажесерверреадс/Актуалпажесерверреадахеадс добавляются в XML плана запроса для реальных планов. Пример:

`<RunTimeCountersPerThread Thread="8" ActualRows="90466461" ActualRowsRead="90466461" Batches="0" ActualEndOfScans="1" ActualExecutions="1" ActualExecutionMode="Row" ActualElapsedms="133645" ActualCPUms="85105" ActualScans="1" ActualLogicalReads="6032256" ActualPhysicalReads="0" ActualPageServerReads="0" ActualReadAheads="6027814" ActualPageServerReadAheads="5687297" ActualLobLogicalReads="0" ActualLobPhysicalReads="0" ActualLobPageServerReads="0" ActualLobReadAheads="0" ActualLobPageServerReadAheads="0" />`

> [!NOTE]
> Чтобы просмотреть эти атрибуты в окне "Свойства плана запроса", требуется SSMS 18,3 или более поздней версии.

## <a name="virtual-file-stats-and-io-accounting"></a>Статистика виртуальных файлов и учет операций ввода-вывода

В базе данных SQL Azure представление [sys. dm_io_virtual_file_stats ()](/sql/relational-databases/system-dynamic-management-views/sys-dm-io-virtual-file-stats-transact-sql/) DMF является основным способом мониторинга операций ввода-вывода базы данных SQL. Характеристики ввода-вывода в масштабировании отличаются в соответствии с [распределенной архитектурой](service-tier-hyperscale.md#distributed-functions-architecture). В этом разделе мы рассмотрим операции ввода-вывода (чтение и запись) для файлов данных, как показано в этом DMF. В процессе масштабирования каждый файл данных, видимый в этом DMF, соответствует удаленному серверу страниц. Упомянутый здесь кэш RBPEX является локальным кэшем на основе SSD, который является неохватывающим кэшем в реплике вычислений.

### <a name="local-rbpex-cache-usage"></a>Использование локального кэша RBPEX

Локальный кэш RBPEX существует в реплике вычислений в локальном хранилище SSD. Поэтому операции ввода-вывода в этом кэше выполняются быстрее, чем операции ввода-вывода на серверах удаленных страниц. В настоящее время [sys. dm_io_virtual_file_stats ()](/sql/relational-databases/system-dynamic-management-views/sys-dm-io-virtual-file-stats-transact-sql/) в базе данных с использованием масштабирования имеет специальную строку, сообщающую о вводе-выводе в локальном кэше RBPEX в реплике вычислений. Эта строка имеет значение 0 для обоих `database_id` `file_id` столбцов и. Например, приведенный ниже запрос возвращает статистику использования RBPEX с момента запуска базы данных.

`select * from sys.dm_io_virtual_file_stats(0,NULL);`

Отношение операций чтения к RBPEX к агрегированным операциям чтения, выполненным для всех остальных файлов данных, обеспечивает коэффициент попаданий в кэш RBPEX.

### <a name="data-reads"></a>Операции чтения данных

- При выполнении операций чтения ядром СУБД SQL Server в реплике вычислений они могут обслуживаться либо локальным кэшем RBPEX, либо удаленными серверами страниц, либо сочетанием этих двух параметров при чтении нескольких страниц.
- Если в процессе считывания реплики вычитает некоторые страницы из определенного файла, например file_id 1, если эти данные находятся исключительно в локальном кэше RBPEX, все операции ввода-вывода для этого чтения зависят от file_id 0 (RBPEX). Если какая-либо часть этих данных находится в локальном кэше RBPEX, а какая-то часть находится на удаленном сервере страниц, операция ввода-вывода учитывается в file_id 0 для части, обслуживаемой из RBPEX, а часть, обслуживаемой удаленным сервером страниц, учитывается в file_id 1.
- Если реплика вычислений запрашивает страницу в определенном [номере LSN](/sql/relational-databases/sql-server-transaction-log-architecture-and-management-guide/) с сервера страниц, то если сервер страницы не был найден ЗАПРОШЕНному номеру LSN, то чтение из реплики вычислений будет ожидать до тех пор, пока страница не будет возвращена в реплику вычислений. При любом чтении с сервера страниц в реплике вычислений вы увидите тип PAGEIOLATCH_ * Wait, если он ожидает ввода-вывода. В режиме масштабирования это время ожидания включает как время, необходимое для получения запрошенной страницы на сервере страниц, так и номер LSN, а также время, необходимое для перемещения страницы с сервера страниц в реплику вычислений.
- Большие операции чтения, например упреждающее чтение, часто выполняются с помощью [операций чтения с разбивкой](/sql/relational-databases/reading-pages/)на несколько. Это позволяет одновременно считывать до 4 МБ страниц, что считается одним чтением в SQL Server ядре СУБД. Однако при чтении данных в RBPEX эти операции чтения продаются как несколько отдельных 8-КИЛОБАЙТных операций чтения, так как буферный пул и RBPEX всегда используют 8-КИЛОБАЙТные страницы. В результате число операций чтения IOs для RBPEX может быть больше фактического числа операций ввода/вывода, выполняемых ядром.

### <a name="data-writes"></a>Операции записи данных

- Первичная расчетная реплика не записывается непосредственно на серверы страниц. Вместо этого записи журнала из службы журнала воспроизводятся на соответствующих серверах страниц.
- Операции записи, происходящие в реплике вычислений, преимущественно записываются в локальный RBPEX (file_id 0). Для операций записи по логическим файлам, размер которых превышает 8 КБ, другими словами, которые были выполнены с помощью функции [сбора и записи](/sql/relational-databases/writing-pages/), каждая операция записи преобразуется в несколько 8 КБ отдельных операций записи в RBPEX, так как буферный пул и RBPEX всегда используют 8-килобайтные страницы. В результате число операций записи IOs, наблюдаемых в RBPEX, может быть больше, чем реальное число операций ввода/вывода, выполняемых ядром.
- Файлы данных, отличные от file_id 0, которые соответствуют серверам страниц, также показывают операции записи. На уровне служб с масштабированием эти записи моделируются, так как реплики вычислений никогда не записываются непосредственно на серверы страниц. При записи операций ввода-вывода и пропускной способности учитывается, как они происходят в реплике вычислений, но задержка для файлов данных, отличных от file_id 0, не отражает фактическую задержку при записи сервера страниц.

### <a name="log-writes"></a>Записи журнала

- На основном вычислении запись журнала учитывается в file_id 2 из sys. dm_io_virtual_file_stats. Запись в журнал в основном вычислений — это запись в основную зону журнала.
- Записи журнала не зафиксированы на вторичной реплике при фиксации. В режиме «линейка» журнал применяется службой журналов ко вторичным репликам асинхронно. Поскольку записи журнала в действительности не происходят во вторичных репликах, любые учетные данные операций ввода-вывода в журнале на вторичных репликах предназначены только для отслеживания.

## <a name="data-io-in-resource-utilization-statistics"></a>Ввод-вывод данных в статистику использования ресурсов

В базе данных, отличной от для масштабирования, объединенные операции чтения и записи операций ввода-вывода в файлы данных, относящиеся к ограничению операций ввода-вывода данных управления [ресурсами](/azure/sql-database/sql-database-resource-limits-database-server#resource-governance) , отображаются в столбцах [sys. dm_db_resource_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database) и [sys. resource_stats](/sql/relational-databases/system-catalog-views/sys-resource-stats-azure-sql-database) `avg_data_io_percent` . То же значение указывается в портал Azure в качестве _процента операций ввода-вывода данных_.

В этом столбце в базе данных для масштабирования в этой статье задается отчет об использовании операций ввода-вывода в секунду относительно ограничения локального хранилища только для реплик вычислений, а именно для операций ввода-вывода в RBPEX и `tempdb` . Значение 100% в этом столбце указывает, что управление ресурсами ограничивает число операций ввода-вывода в локальном хранилище. Если это связано с проблемой с производительностью, настройте рабочую нагрузку для создания меньшего количества операций ввода-вывода или увеличьте цель службы базы данных, чтобы увеличить [ограничение максимального количества](resource-limits-vcore-single-databases.md) _операций ввода-вывода_ в управлении ресурсами. Для управления ресурсами при операциях чтения и записи RBPEX система подсчитывает количество отдельных 8-КИЛОБАЙТных IOs, а не более крупных IOs, которые могут выдаваться ядром СУБД SQL Server.

Операция ввода-вывода данных на серверах удаленных страниц не отображается в представлениях использования ресурсов или на портале, но указывается в [представлении sys. dm_io_virtual_file_stats () DMF ()](/sql/relational-databases/system-dynamic-management-views/sys-dm-io-virtual-file-stats-transact-sql/) , как отмечалось ранее.

## <a name="additional-resources"></a>Дополнительные ресурсы

- Ограничения ресурсов Виртуальное ядро для отдельной базы данных с горизонтальным масштабированием см. в разделе [Виртуальное ядро Service Tier Limits](resource-limits-vcore-single-databases.md#hyperscale---provisioned-compute---gen5)
- Сведения о настройке производительности базы данных SQL Azure см. [в статье производительность запросов в базе данных SQL Azure](performance-guidance.md) .
- Сведения о настройке производительности с помощью хранилища запросов см. в разделе [мониторинг производительности с помощью хранилища запросов](/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store/) .
- Сведения о скриптах мониторинга динамического административного представления см. в статье [мониторинг производительности базы данных SQL Azure с помощью динамических административных представлений](monitoring-with-dmvs.md) .
