---
title: Средства контроля сетевого доступа
titleSuffix: Azure SQL Database & Azure Synapse Analytics
description: Обзор управления доступом к сети для базы данных SQL Azure и Azure синапсе Analytics (ранее — хранилище данных SQL).
services: sql-database
ms.service: sql-database
ms.subservice: security
ms.custom: sqldbrb=3
ms.devlang: ''
ms.topic: conceptual
author: rohitnayakmsft
ms.author: rohitna
ms.reviewer: vanto
ms.date: 03/09/2020
ms.openlocfilehash: 4afb6844512bd59a5c377d826267a748837ed855
ms.sourcegitcommit: a2d8acc1b0bf4fba90bfed9241b299dc35753ee6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/12/2020
ms.locfileid: "91952001"
---
# <a name="azure-sql-database-and-azure-synapse-analytics-network-access-controls"></a>Управление доступом к сети для базы данных SQL Azure и Azure синапсе Analytics

При создании логического сервера SQL Server из [портал Azure](single-database-create-quickstart.md) для базы данных SQL Azure и Azure синапсе Analytics результат представляет собой общедоступную конечную точку в формате *yourservername.Database.Windows.NET*.

Чтобы выборочно разрешить доступ к базе данных через общедоступную конечную точку, можно использовать следующие элементы управления доступом к сети:

- Разрешить службы Azure. Если задано значение ON, другие ресурсы в границах Azure, например виртуальная машина Azure, могут получить доступ к базе данных SQL.
- Правила брандмауэра IP-адресов. Используйте эту функцию, чтобы явно разрешить подключения с определенного IP-адреса, например с локальных компьютеров.

Вы также можете разрешить закрытый доступ к базе данных из [виртуальных сетей](../../virtual-network/virtual-networks-overview.md) с помощью:

- Правила брандмауэра виртуальной сети: Используйте эту функцию, чтобы разрешить трафик из определенной виртуальной сети в границах Azure.
- Частная ссылка: Используйте эту функцию для создания частной конечной точки для [логического сервера SQL Server](logical-servers.md) в определенной виртуальной сети.

> [!IMPORTANT]
> Эта статья *не* применима к **SQL управляемый экземпляр**. Дополнительные сведения о конфигурации сети см. в разделе [Подключение к Azure SQL управляемый экземпляр](../managed-instance/connect-application-instance.md) .

Подробное описание этих элементов управления доступом и их действия см. в приведенном ниже видеоролике.

> [!VIDEO https://channel9.msdn.com/Shows/Data-Exposed/Data-Exposed--SQL-Database-Connectivity-Explained/player?WT.mc_id=dataexposed-c9-niner]

## <a name="allow-azure-services"></a>Разрешить службы Azure

По умолчанию при создании нового логического сервера SQL Server [из портал Azure](single-database-create-quickstart.md)этот параметр имеет значение **Off**. Этот параметр отображается, если подключение разрешено с помощью конечной точки общедоступной службы.

Этот параметр можно также изменить через панель брандмауэра после создания логического сервера SQL Server, как показано ниже.
  
![Снимок экрана: Управление брандмауэром сервера][2]

Если задано значение **On**, сервер разрешает передачу данных из всех ресурсов в пределах границы Azure, которые могут входить в вашу подписку или быть не включены в нее.

Во многих случаях параметр **On** имеет больше разрешений, чем требуется большинству клиентов. Вы можете задать для этого параметра значение **Off** и заменить его более ограниченными правилами брандмауэра IP-адресов или правилами брандмауэра виртуальной сети. 

Однако это влияет на следующие функции, которые выполняются на виртуальных машинах в Azure, которые не являются частью виртуальной сети и поэтому подключаются к базе данных через IP-адрес Azure:

### <a name="import-export-service"></a>Служба импорта и экспорта

Служба импорта и экспорта не работает, если для параметра **Разрешить доступ к службам Azure** задано значение **выкл**. Однако эту проблему можно решить [, вручную запустив sqlpackage.exe из виртуальной машины Azure или выполнив экспорт](https://docs.microsoft.com/azure/sql-database/import-export-from-vm) непосредственно в коде с помощью API DACFx.

### <a name="data-sync"></a>Синхронизация данных

Чтобы использовать функцию синхронизации данных с параметром **Разрешить доступ к службам Azure** со значением **Off**, необходимо создать отдельные записи правил брандмауэра, чтобы [Добавить IP-адреса](firewall-create-server-level-portal-quickstart.md) из **тега службы SQL** для региона, в котором размещена база данных- **концентратор** .
Добавьте эти правила брандмауэра уровня сервера на серверы, на которых размещены базы данных- **концентраторы** и **элементы** (которые могут находиться в разных регионах).

Используйте следующий сценарий PowerShell для создания IP-адресов, соответствующих тегу службы SQL для региона "Западная часть США".

```powershell
PS C:\>  $serviceTags = Get-AzNetworkServiceTag -Location eastus2
PS C:\>  $sql = $serviceTags.Values | Where-Object { $_.Name -eq "Sql.WestUS" }
PS C:\> $sql.Properties.AddressPrefixes.Count
70
PS C:\> $sql.Properties.AddressPrefixes
13.86.216.0/25
13.86.216.128/26
13.86.216.192/27
13.86.217.0/25
13.86.217.128/26
13.86.217.192/27
```

> [!TIP]
> Get-AzNetworkServiceTag Возвращает глобальный диапазон для тега службы SQL, несмотря на указание параметра location. Не забудьте отфильтровать его в регионе, где размещена база данных центра, используемая группой синхронизации.

Обратите внимание, что выходные данные скрипта PowerShell находятся в нотации неInter-Domainной маршрутизации (CIDR). Его необходимо преобразовать в формат начального и конечного IP-адресов с помощью [Get-IPrangeStartEnd.ps1](https://gallery.technet.microsoft.com/scriptcenter/Start-and-End-IP-addresses-bcccc3a9) следующим образом:

```powershell
PS C:\> Get-IPrangeStartEnd -ip 52.229.17.93 -cidr 26
start        end
-----        ---
52.229.17.64 52.229.17.127
```

Этот дополнительный скрипт PowerShell можно использовать для преобразования всех IP-адресов из CIDR в формат начального и конечного IP-адресов.

```powershell
PS C:\>foreach( $i in $sql.Properties.AddressPrefixes) {$ip,$cidr= $i.split('/') ; Get-IPrangeStartEnd -ip $ip -cidr $cidr;}
start          end
-----          ---
13.86.216.0    13.86.216.127
13.86.216.128  13.86.216.191
13.86.216.192  13.86.216.223
```

Теперь можно добавить их как отдельные правила брандмауэра, а затем установить параметр **Разрешить службам Azure доступ к серверу**  .

## <a name="ip-firewall-rules"></a>Правила брандмауэра для IP-адресов

Брандмауэр на основе IP-адреса — это функция логического сервера SQL в Azure, которая предотвращает доступ к серверу до тех пор, пока вы явно не [добавите IP-адреса](firewall-create-server-level-portal-quickstart.md) клиентских компьютеров.

## <a name="virtual-network-firewall-rules"></a>Правила брандмауэра для виртуальной сети

В дополнение к правилам IP, брандмауэр сервера позволяет определить *правила виртуальной сети*.  
Дополнительные сведения см. в статье [конечные точки и правила службы виртуальной сети для базы данных SQL Azure](vnet-service-endpoint-rule-overview.md) или просмотрите это видео:

> [!VIDEO https://channel9.msdn.com/Shows/Data-Exposed/Data-Exposed--Demo--Vnet-Firewall-Rules-for-SQL-Database/player?WT.mc_id=dataexposed-c9-niner]

### <a name="azure-networking-terminology"></a>Терминология сети Azure

При просмотре правил брандмауэра виртуальной сети учитывайте следующие термины сети Azure.

**Виртуальная сеть:** С подпиской Azure могут быть связаны виртуальные сети.

**Подсеть**. Виртуальная сеть содержит **подсети**. Все ваши виртуальные машины Azure назначены в подсети. Одна подсеть может содержать несколько виртуальных машин или других вычислительных узлов. Кластерные узлы, находящиеся за пределами виртуальной сети, не могут получить доступ к виртуальной сети, если только не настроена безопасность для разрешения доступа.

**Конечная точка службы виртуальной сети:** [Конечная точка службы виртуальной сети](../../virtual-network/virtual-network-service-endpoints-overview.md) — это подсеть, значения свойств которой включают одно или несколько формальных имен типов служб Azure. В этой статье мы будем рады получить имя типа **Microsoft. SQL**, которое ссылается на службу Azure с именем "база данных SQL".

**Правило виртуальной сети:** Правило виртуальной сети для сервера — это подсеть, указанная в списке управления доступом (ACL) сервера. Чтобы быть в списке ACL для базы данных в базе данных SQL, подсеть должна содержать имя типа **Microsoft. SQL** . Правило виртуальной сети указывает серверу принимать подключения от всех узлов, надаваемых в подсети.

## <a name="ip-vs-virtual-network-firewall-rules"></a>Правила брандмауэра IP-адреса и виртуальной сети

Брандмауэр базы данных SQL Azure позволяет указать диапазоны IP-адресов, из которых сообщения принимаются в базу данных SQL. Эта методика хорошо подходит для постоянных IP-адресов, которые находятся за пределами частной сети Azure. Однако виртуальные машины в частной сети Azure настроены с использованием *динамических* IP-адресов. Динамические IP-адреса могут измениться после перезапуска виртуальной машины и, в свою очередь, сделать недействительным правило брандмауэра на основе IP-адресов. Было бы неразумно указывать динамический IP-адрес в правиле брандмауэра в рабочей среде.

Это ограничение можно обойти, получая *статический* IP-адрес для виртуальной машины. Дополнительные сведения см. [в разделе Создание виртуальной машины со статическим общедоступным IP-адресом с помощью портал Azure](../../virtual-network/virtual-network-deploy-static-pip-arm-portal.md). Тем не менее, подход статического IP-адреса может стать трудным для управления, и он требует больших затрат, когда выполняется масштабирование.

Правила виртуальной сети проще устанавливать и управлять доступом из определенной подсети, содержащей ваши виртуальные машины.

> [!NOTE]
> Пока еще невозможно разместить базу данных SQL в подсети. Если сервер был узлом в подсети виртуальной сети, все узлы в виртуальной сети могут взаимодействовать с базой данных SQL. В этом случае виртуальные машины могли взаимодействовать с базой данных SQL без необходимости в каких-либо правилах виртуальной сети или правилах фильтрации IP-адресов.

## <a name="private-link"></a>Приватный канал

Частная ссылка позволяет подключаться к серверу через **закрытую конечную точку**. Частная конечная точка — это частный IP-адрес в определенной [виртуальной сети](../../virtual-network/virtual-networks-overview.md) и подсети.

## <a name="next-steps"></a>Дальнейшие действия

- Краткое руководство по созданию правила брандмауэра IP на уровне сервера см. в разделе [Создание базы данных в базе данных SQL](single-database-create-quickstart.md).

- Краткое руководство по созданию правила брандмауэра виртуальной сети на уровне сервера см. в статье [конечные точки и правила службы виртуальной сети для базы данных SQL Azure](vnet-service-endpoint-rule-overview.md).

- Дополнительные сведения о подключении к базе данных в базе данных SQL из приложений с открытым кодом или сторонними приложениями см. [в статье примеры кода для быстрого запуска клиента в базе данных SQL](https://msdn.microsoft.com/library/azure/ee336282.aspx).

- Дополнительные сведения о портах, которые, возможно, потребуется открыть, см. в разделе **Снаружи или внутри** статьи [Порты для ADO.NET 4.5, отличные от порта 1433](adonet-v12-develop-direct-route-ports.md).

- Общие сведения о подключении к базе данных SQL Azure см. в статье [Архитектура подключения к SQL Azure](connectivity-architecture.md) .

- Общие сведения о методах защиты в Базе данных SQL Azure см. в [этой статье](security-overview.md).

<!--Image references-->
[1]: media/quickstart-create-single-database/new-server2.png
[2]: media/quickstart-create-single-database/manage-server-firewall.png
 
