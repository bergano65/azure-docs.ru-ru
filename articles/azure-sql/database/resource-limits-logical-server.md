---
title: Ограничения ресурсов для логических серверов в Azure
description: В этой статье приводятся общие сведения об ограничениях ресурсов для логического сервера в Azure, используемого базой данных SQL Azure и Azure синапсе Analytics. Здесь также содержится информация о том, что происходит, когда эти ограничения ресурсов соответствуют или превышают допустимые нормы.
services: sql-database
ms.service: sql-database
ms.subservice: single-database
ms.custom: ''
ms.devlang: ''
ms.topic: reference
author: stevestein
ms.author: sstein
ms.reviewer: sashan,moslake,josack
ms.date: 02/02/2021
ms.openlocfilehash: e8f18f56c746f0d12f43cc2fb6ce9088a9b82b45
ms.sourcegitcommit: 740698a63c485390ebdd5e58bc41929ec0e4ed2d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "99492388"
---
# <a name="resource-limits-for-azure-sql-database-and-azure-synapse-analytics-servers"></a>Ограничения ресурсов для базы данных SQL Azure и серверов Azure синапсе Analytics
[!INCLUDE[appliesto-sqldb-asa](../includes/appliesto-sqldb-asa.md)]

В этой статье приводятся общие сведения об ограничениях ресурсов для логического сервера, используемого базой данных SQL Azure и Azure синапсе Analytics. Он предоставляет сведения о том, что происходит при достижении или превышении лимитов ресурсов, а также описывает механизмы управления ресурсами, используемые для принудительного применения этих ограничений.

> [!NOTE]
> Ограничения для Управляемый экземпляр Azure SQL см. в разделе [ограничения ресурсов базы данных SQL для управляемых экземпляров](../managed-instance/resource-limits.md).

## <a name="maximum-resource-limits"></a>Максимальное ограничение ресурсов

| Ресурс | Ограничение |
| :--- | :--- |
| Баз данных на сервер | 5000 |
| Количество серверов по умолчанию на одну подписку в любом регионе | 20 |
| Максимальное количество серверов на одну подписку в любом регионе | 200 |  
| Квота DTU или eDTU на сервер | 54 000 |  
| Квота виртуальных ядер на сервер или экземпляр | 540 |
| Максимальное число пулов на сервер | ограничено числом DTU или виртуальных ядер Например, если каждый пул поддерживает 1000 DTU, тогда один сервер может поддерживать 54 пула.|
|||

> [!IMPORTANT]
> По мере приближения количества баз данных к пороговому значению для сервера может произойти следующее:
>
> - Увеличение задержки при выполнении запросов к базе данных master.  Сюда входят представления статистических данных использования ресурсов, такие как sys.resource_stats.
> - Увеличение задержки при управлении и отображении для точек наблюдения портала, включая перечисление баз данных на сервере.

> [!NOTE]
> Чтобы получить дополнительную квоту DTU/eDTU, квоту Виртуальное ядро или больше серверов по сравнению с суммой по умолчанию, отправьте новый запрос в службу поддержки в портал Azure. Дополнительные сведения см. в статье [запрос увеличения квоты для базы данных SQL Azure](quota-increase-request.md).

### <a name="storage-size"></a>Объем памяти

Размеры хранилища ресурсов для отдельных баз данных см. в разделе [ограничения ресурсов на основе DTU](resource-limits-dtu-single-databases.md) или ограничения на [ресурсы на основе виртуальное ядро](resource-limits-vcore-single-databases.md) для ограничения размера хранилища на ценовую категорию.

## <a name="what-happens-when-database-resource-limits-are-reached"></a>Что происходит при достижении ограничения ресурсов базы данных?

### <a name="compute-cpu"></a>Вычислительный ЦП

Когда загрузка ЦП вычислительной базы данных становится высокой, задержка запросов увеличивается, а время ожидания запросов может исключаться. В этих условиях запросы могут помещаться в очередь службой и предоставлять ресурсы для выполнения, так как ресурсы становятся свободными.
При интенсивном использовании вычислительных ресурсов возможны следующие варианты предотвращения последствий:

- Увеличение объема вычислительных ресурсов базы данных или эластичного пула для предоставления базе данных дополнительных вычислительных ресурсов. См. разделы [Масштабирование ресурсов отдельной базы данных](single-database-scale.md) и [Масштабирование ресурсов эластичного пула](elastic-pool-scale.md).
- Оптимизация запросов для уменьшения использования ресурсов ЦП каждым запросом. Дополнительные сведения см. в разделе [Настройка запросов и указания на них](performance-guidance.md#query-tuning-and-hinting).

### <a name="storage"></a>Память

Когда используемое пространство базы данных достигает максимального размера, операции вставки и обновления, увеличивающие размер данных, завершаются сбоем и клиенты получают [сообщение об ошибке](troubleshoot-common-errors-issues.md). Инструкции SELECT и DELETE продолжают выполняться.

При интенсивном использовании пространства возможны следующие варианты предотвращения последствий:

- Увеличение максимального размера базы данных или эластичного пула или Добавление дополнительного хранилища. См. разделы [Масштабирование ресурсов отдельной базы данных](single-database-scale.md) и [Масштабирование ресурсов эластичного пула](elastic-pool-scale.md).
- Если база данных находится в эластичном пуле, то можно также переместить базу данных за пределы пула, чтобы ее пространство не было общим для других баз данных.
- Сжатие базы данных для освобождения неиспользуемого пространства. Дополнительные сведения см. [в статье Управление дисковым пространством в базе данных SQL Azure](file-space-manage.md).
- Проверьте, не занят ли высокий объем пространства, из-за пикового размера постоянного хранилища версий (постоянного хранилища версий). ПОСТОЯННОГО хранилища версий является частью каждой базы данных и используется для реализации  [ускоренного восстановления базы данных](../accelerated-database-recovery.md). Чтобы определить текущий размер постоянного хранилища версий, см. раздел [Устранение неполадок постоянного хранилища версий](https://docs.microsoft.com/sql/relational-databases/accelerated-database-recovery-management#troubleshooting). Распространенной причиной для большого размера постоянного хранилища версий является транзакция, которая открыта в течение длительного времени (в часах), что предотвращает очистку старых версий в постоянного хранилища версий.

### <a name="sessions-and-workers-requests"></a>Сеансы и рабочие роли (запросы)

Максимальное количество сеансов и рабочих ролей определяется уровнем служб и размером вычислений (DTU/Edtu или виртуальных ядер). При достижении ограничения числа сеансов или рабочих ролей новые запросы отклоняются, а клиенты получают сообщение об ошибке. Хотя приложение может управлять числом доступных подключений, число параллельных рабочих ролей зачастую существенно труднее оценивать и контролировать. Это особенно справедливо во время пиковых периодов загрузки при достижении пределов ресурсов базы данных, а работники — из-за длительного выполнения запросов, больших блокирующих цепочек или чрезмерного параллелизма запросов.

При интенсивном использовании сеансов и рабочих ролей возможны следующие варианты предотвращения последствий:

- Повышение уровня служб или объема вычислительных ресурсов базы данных или эластичного пула. См. разделы [Масштабирование ресурсов отдельной базы данных](single-database-scale.md) и [Масштабирование ресурсов эластичного пула](elastic-pool-scale.md).
- Оптимизация запросов для сокращения использования ресурсов, необходимых каждому запросу, если причиной повышенного использования рабочих ролей является состязание за вычислительные ресурсы. Дополнительные сведения см. в разделе [Настройка запросов и указания на них](performance-guidance.md#query-tuning-and-hinting).
- Уменьшение параметра [MAXDOP](/sql/database-engine/configure-windows/configure-the-max-degree-of-parallelism-server-configuration-option#Guidelines) (максимальная степень параллелизма).
- Оптимизация рабочей нагрузки запросов для сокращения числа вхождений и длительности блокировки запросов. Дополнительные сведения см. в статье [изучение и устранение проблем с БЛОКИРОВКОЙ SQL Azure](understand-resolve-blocking.md).

### <a name="memory"></a>Память

В отличие от других ресурсов (ЦП, рабочих процессов, хранилища), достижение ограничения памяти не негативно влияет на производительность запросов и не приводит к ошибкам и сбоям. Как подробно описано в разделе [руководство по архитектуре управления памятью](/sql/relational-databases/memory-management-architecture-guide), SQL Server ядро СУБД часто использует всю доступную память. Память используется преимущественно для кэширования данных, чтобы избежать более дорогостоящего доступа к хранилищу. Таким же выше потребление памяти обычно повышает производительность запросов из-за ускорения чтения из памяти, а не медленных операций чтения из хранилища.

После запуска ядра СУБД, когда Рабочая нагрузка начинает считывать данные из хранилища, ядро СУБД активно кэширует данные в памяти. По истечении этого периода обычно ожидается, что `avg_memory_usage_percent` `avg_instance_memory_percent` столбцы и в [sys.dm_db_resource_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database) закрываются или равны 100%, особенно для баз данных, которые не находятся в состоянии простоя и не полностью умещаются в памяти.

Помимо кэша данных, память используется в других компонентах ядра СУБД. Если требуется память и вся доступная память использовалась кэшем данных, ядро СУБД динамически сжимает размер кэша данных, чтобы сделать память доступной для других компонентов, и динамически увеличит кэш данных, когда другие компоненты выосвобождают память.

В редких случаях Рабочая нагрузка может привести к нехватке памяти, что приведет к ошибкам нехватки памяти. Это может произойти на любом уровне использования памяти в диапазоне от 0% до 100%. Это более вероятно для небольших вычислительных размеров с пропорционально меньшим объемом памяти и (или) с рабочими нагрузками, в которых используется больше памяти для обработки запросов, например в [сжатых пулах эластичных БД](elastic-pool-resource-management.md).

При возникновении ошибок нехватки памяти возможны следующие варианты устранения рисков.
- Повышение уровня служб или объема вычислительных ресурсов базы данных или эластичного пула. См. разделы [Масштабирование ресурсов отдельной базы данных](single-database-scale.md) и [Масштабирование ресурсов эластичного пула](elastic-pool-scale.md).
- Оптимизация запросов и конфигурации для уменьшения использования памяти. В следующей таблице описаны распространенные решения.

|Решение|Описание|
| :----- | :----- |
|Уменьшение размера предоставления памяти|Дополнительные сведения о предоставлении памяти см. в записи блога общие сведения о [SQL Server памяти](https://techcommunity.microsoft.com/t5/sql-server/understanding-sql-server-memory-grant/ba-p/383595) . Распространенным решением для предотвращения чрезмерно больших объемов памяти является актуальность [статистики](/sql/relational-databases/statistics/statistics) . Это приводит к более точной оценке использования памяти ядром запросов, что позволяет избежать ненужных больших объемов памяти.</br></br>В базах данных, использующих уровень совместимости 140 и более поздних версий, ядро СУБД может автоматически корректировать размер предоставления памяти с помощью [обратной связи памяти в пакетном режиме](/sql/relational-databases/performance/intelligent-query-processing#batch-mode-memory-grant-feedback). В базах данных, использующих уровень совместимости 150 и более поздних версий, ядро СУБД аналогично использует [обратную связь с предоставлением памяти в режиме строк](/sql/relational-databases/performance/intelligent-query-processing#row-mode-memory-grant-feedback)для более распространенных запросов в режиме строки. Эта встроенная функция позволяет избежать ошибок нехватки памяти из-за недостаточного объема памяти.|
|Уменьшение размера кэша планов запросов|Ядро СУБД кэширует планы запросов в памяти, чтобы избежать компиляции плана запроса для каждого выполнения запроса. Чтобы избежать превышения кэша планов запросов, вызванных планами кэширования, которые используются только один раз, включите OPTIMIZE_FOR_AD_HOC_WORKLOADSную [конфигурацию уровня базы данных](/sql/t-sql/statements/alter-database-scoped-configuration-transact-sql).|
|Уменьшение размера памяти блокировки|Ядро СУБД использует память для [блокировок](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide#Lock_Engine). По возможности Избегайте больших транзакций, которые могут получить большое количество блокировок и приведут к чрезмерному потреблению памяти с высокой блокировкой.|


## <a name="resource-consumption-by-user-workloads-and-internal-processes"></a>Потребление ресурсов по рабочим нагрузкам пользователей и внутренним процессам

Использование ЦП и памяти пользовательскими рабочими нагрузками в каждой базе данных сообщается в [sys.dm_db_resource_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database) и [sys.resource_stats](/sql/relational-databases/system-catalog-views/sys-resource-stats-azure-sql-database) представлениях `avg_cpu_percent` в `avg_memory_usage_percent` столбцах и. Для эластичных пулов в представлении [sys.elastic_pool_resource_stats](/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) отображается отчет о потреблении ресурсов на уровне пула. Загрузка ЦП пользовательской рабочей нагрузки также сообщается по `cpu_percent` метрике Azure Monitor для [отдельных баз данных](../../azure-monitor/platform/metrics-supported.md#microsoftsqlserversdatabases) и [эластичных пулов](../../azure-monitor/platform/metrics-supported.md#microsoftsqlserverselasticpools) на уровне пула.

Базе данных SQL Azure требуются ресурсы вычислений для реализации основных функций службы, таких как высокий уровень доступности и аварийное восстановление, резервное копирование и восстановление баз данных, мониторинг, хранилище запросов, автоматическая настройка и т. д. Система устанавливает ограниченную часть общих ресурсов для этих внутренних процессов с помощью механизмов управления [ресурсами](#resource-governance) , делая оставшуюся часть ресурсов доступной для пользовательских рабочих нагрузок. Иногда, когда внутренние процессы не используют ресурсы вычислений, система делает их доступными для пользовательских рабочих нагрузок.

Общее использование ЦП и памяти рабочими нагрузками пользователей и внутренними процессами сообщается в [sys.dm_db_resource_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database) и [sys.resource_stats](/sql/relational-databases/system-catalog-views/sys-resource-stats-azure-sql-database) представлениях в `avg_instance_cpu_percent` `avg_instance_memory_percent` столбцах и. Эти данные также сообщаются по `sqlserver_process_core_percent` `sqlserver_process_memory_percent` метрикам и Azure Monitor для [отдельных баз данных](../../azure-monitor/platform/metrics-supported.md#microsoftsqlserversdatabases) и [эластичных пулов](../../azure-monitor/platform/metrics-supported.md#microsoftsqlserverselasticpools) на уровне пула.

Более подробные сведения о последнем потреблении ресурсов по рабочим нагрузкам пользователей и внутренним процессам сообщается в представлениях [sys.dm_resource_governor_resource_pools_history_ex](/sql/relational-databases/system-dynamic-management-views/sys-dm-resource-governor-resource-pools-history-ex-azure-sql-database) и [sys.dm_resource_governor_workload_groups_history_ex](/sql/relational-databases/system-dynamic-management-views/sys-dm-resource-governor-workload-groups-history-ex-azure-sql-database) . Дополнительные сведения о пулах ресурсов и группах рабочей нагрузки, на которые имеются ссылки в этих представлениях, см. в разделе [Управление ресурсами](#resource-governance). Эти представления сообщают об использовании ресурсов пользовательскими рабочими нагрузками и конкретными внутренними процессами в связанных пулах ресурсов и группах рабочей нагрузки.

В контексте наблюдения за производительностью и устранения неполадок важно учитывать как **использование ЦП пользователями** ( `avg_cpu_percent` , `cpu_percent` ), так и **Общее использование ЦП** рабочими нагрузками пользователей и внутренними процессами ( `avg_instance_cpu_percent` , `sqlserver_process_core_percent` ).

**Использование ЦП пользователем** вычисляется в процентах от пределов пользовательской нагрузки в каждой цели обслуживания. Загрузка **ЦП пользователем** на 100% означает, что Рабочая нагрузка пользователя достигла ограничения цели обслуживания. Однако, когда **Общее потребление ресурсов ЦП** достигает диапазона 70-100%, можно увидеть, что пропускная способность рабочей нагрузки будет увеличиваться, а задержка запросов увеличится, даже если отчет о **потреблении загруженных ЦП пользователя** значительно ниже 100%. Чаще всего это происходит при использовании меньшей цели службы с умеренным выделением ресурсов для вычислений, но с относительно интенсивными пользовательскими рабочими нагрузками, например в [сжатых пулах эластичных](elastic-pool-resource-management.md)баз данных. Это также может происходить с меньшими целями службы, когда внутренние процессы временно нуждаются в дополнительных ресурсах, например при создании новой реплики базы данных.

Если **Общая загрузка ЦП** высока, варианты устранения рисков аналогичны описанным выше и включают повышение уровня обслуживания и/или оптимизацию пользовательской рабочей нагрузки.

## <a name="resource-governance"></a>Управление ресурсами

Чтобы применить ограничения ресурсов, база данных SQL Azure использует реализацию управления ресурсами, основанную на SQL Server [Resource Governor](/sql/relational-databases/resource-governor/resource-governor), измененных и расширенных для запуска в базе данных SQL Azure. В базе данных SQL, нескольких [пулах ресурсов](/sql/relational-databases/resource-governor/resource-governor-resource-pool) и [группах рабочей нагрузки](/sql/relational-databases/resource-governor/resource-governor-workload-group)с ограничениями ресурсов, установленными на уровне пула и группы, предоставляется [сбалансированная база данных как услуга](https://azure.microsoft.com/blog/resource-governance-in-azure-sql-database/). Рабочая нагрузка пользователя и внутренние рабочие нагрузки классифицируются в отдельные пулы ресурсов и группы рабочей нагрузки. Рабочая нагрузка пользователя на первичную и доступную для чтения вторичные реплики, включая геореплики, классифицируется в `SloSharedPool1` пул ресурсов и `UserPrimaryGroup.DBId[N]` группу рабочей нагрузки, где `N` означает значение идентификатора базы данных. Кроме того, для различных внутренних рабочих нагрузок существует несколько пулов ресурсов и групп рабочей нагрузки.

Кроме использования Resource Governor для управления ресурсами в процессе SQL, база данных SQL Azure также использует [объекты заданий](/windows/win32/procthread/job-objects) Windows для контроля ресурсов на уровне процесса и [файловый сервер Windows Диспетчер ресурсов (FSRM)](/windows-server/storage/fsrm/fsrm-overview) в управлении квотами на хранилище.

Управление ресурсами базы данных SQL Azure является иерархическим. С начала до конца ограничения применяются на уровне ОС и на уровне тома хранилища с помощью механизмов управления ресурсами операционной системы и Resource Governor, на уровне пула ресурсов с помощью Resource Governor, а затем на уровне группы рабочей нагрузки с помощью Resource Governor. Ограничения управления ресурсами, действующие для текущей базы данных или эластичного пула, отображаются в представлении [sys.dm_user_db_resource_governance](/sql/relational-databases/system-dynamic-management-views/sys-dm-user-db-resource-governor-azure-sql-database) .

### <a name="data-io-governance"></a>Управление вводом-выводом данных

Управление вводом-выводом данных — это процесс в базе данных SQL Azure, который позволяет ограничить операции чтения и записи физических операций ввода-вывода для файлов данных базы данных. Ограничения на операции ввода-вывода для каждого уровня обслуживания задаются для того, чтобы максимально сокращать «шум» соседа, чтобы обеспечить равномерное распределение ресурсов в многоклиентской службе и оставаться в пределах возможностей базового оборудования и хранилища.

Для отдельных баз данных ограничения группы рабочей нагрузки применяются ко всем операциям ввода-вывода хранилища для базы данных, а ограничения пула ресурсов применяются ко всем базам данных хранилища в том же выделенном пуле SQL, включая `tempdb` базу данных. Для эластичных пулов ограничения группы рабочей нагрузки применяются к каждой базе данных в пуле, а ограничение пула ресурсов применяется ко всему пулу эластичных БД, включая `tempdb` базу данных, которая является общей для всех баз данных в пуле. В общем случае ограничения пула ресурсов могут быть недостижимыми рабочей нагрузкой для базы данных (отдельной или в составе пула), так как ограничения группы рабочей нагрузки ниже ограничений пула ресурсов и ограничивают скорость операций ввода-вывода и пропускную способность. Однако ограничения пула могут быть достигнуты в совокупной рабочей нагрузке на несколько баз данных в одном пуле.

Например, если запрос формирует 1000 операций ввода-вывода в секунду без какого-либо управления ресурсами ввода/вывода, но для группы рабочей нагрузки максимальное ограничение в секунду равно 900, запрос не сможет создать более чем 900 операций ввода/вывода. Однако если предельное число операций ввода-вывода в секунду для пула ресурсов равно 1500, а общее количество операций ввода/вывода из всех групп рабочей нагрузки, связанных с пулом ресурсов, превышает 1500, то операция ввода-вывода одного и того же запроса может быть снижена под пределами группы в 900 операций ввода-вывода в секунду.

Значения min/max для операций ввода-вывода и пропускной способности, возвращаемые представлением [sys.dm_user_db_resource_governance](/sql/relational-databases/system-dynamic-management-views/sys-dm-user-db-resource-governor-azure-sql-database) , действуют как ограничения/Caps, а не как гарантии. Кроме того, управление ресурсами не гарантирует какую бы то ни было определенной задержки хранилища. Максимально достижимая задержка, число операций ввода-вывода в секунду и пропускная способность для заданной рабочей нагрузки пользователя зависят не только от ограничений управления ресурсами ввода-вывода, но и от того, какие размеры ввода-вывода используются, а также от возможностей базового хранилища. База данных SQL использует IOs, размер которых варьируется в диапазоне от 512 КБ до 4 МБ. Для принудительного применения ограничений операций ввода-вывода каждый из них учитывается независимо от их размера, за исключением баз данных с файлами данных в службе хранилища Azure. В этом случае IOs размером свыше 256 КБ учитывается как несколько 256 КБ, чтобы согласовать с учетом операций ввода-вывода службы хранилища Azure.

Для баз данных уровня "базовый", "Стандартный" и "общего назначения", которые используют файлы данных в службе хранилища Azure, `primary_group_max_io` значение может быть недостижимо, если в базе данных недостаточно файлов данных для кумулятивного предоставления этого числа операций ввода-вывода или если данные не распределяются равномерно по файлам, или если уровень производительности базовых больших двоичных объектов ограничивает количество операций ввода/вывода, которые ниже ограничений управления ресурсами Аналогично, при небольшом объеме операций ввода-вывода журнала, создаваемом частыми фиксациями транзакций, это `primary_max_log_rate` значение может быть недостижимо рабочей нагрузкой вследствие ограничения количества операций в секунду для базового большого двоичного объекта службы хранилища Azure. Для баз данных, использующих хранилище Azure класса Premium, база данных SQL Azure использует достаточно больших двоичных объектов хранилища для получения необходимых операций ввода-вывода в секунду, независимо от размера базы данных. Для больших баз данных создается несколько файлов данных для увеличения общей емкости операций ввода-вывода в секунду и пропускной способности.

Значения использования ресурсов, такие как `avg_data_io_percent` и `avg_log_write_percent` , сообщаемые в представлениях [sys.dm_db_resource_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database),  [sys.resource_stats](/sql/relational-databases/system-catalog-views/sys-resource-stats-azure-sql-database)и [sys.elastic_pool_resource_stats](/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) , рассчитываются в процентах от максимального ограничения управления ресурсами. Таким образом, если другие факторы, кроме управления ресурсами, ограничивают количество операций ввода-вывода и пропускную способность, то при увеличении рабочей нагрузки можно просматривать операции ввода-вывода и задержки при увеличении и задержке, даже если отчет об использовании ресурсов остается ниже 100%.

Чтобы просмотреть и записать операции ввода-вывода, пропускную способность и задержку для каждого файла базы данных, используйте функцию [sys.dm_io_virtual_file_stats ()](/sql/relational-databases/system-dynamic-management-views/sys-dm-io-virtual-file-stats-transact-sql) . Эта функция вымещает все операции ввода-вывода для базы данных, включая фоновые операции ввода-вывода, которые не учитывают базу `avg_data_io_percent` , но используют операцию ввода-вывода и пропускную способность базового хранилища и могут повлиять на наблюдаемую задержку Функция предоставляет дополнительную задержку, которая может быть представлена в управлении ресурсами ввода-вывода для операций чтения и записи в `io_stall_queued_read_ms` `io_stall_queued_write_ms` столбцах и соответственно.

### <a name="transaction-log-rate-governance"></a>Управление частотой ведения журнала транзакций

Управление скоростью журнала транзакций — это процесс в базе данных SQL Azure, который используется для ограничения высоких скоростей приема рабочих нагрузок, таких как массовая вставка, выбор в и построение индекса. Эти ограничения отправляются и применяются на уровне второго уровня к частоте формирования записей журнала, ограничивая пропускную способность независимо от того, сколько IOs может быть выдано для файлов данных.  Скорость создания журнала транзакций в настоящее время масштабируется линейно до точки, зависящей от оборудования, с максимальной частотой ведения журнала 96 МБ/с в модели приобретения Виртуальное ядро.

> [!NOTE]
> Фактическая физическая операция ввода/вывода с файлами журнала транзакций не регулируется или ограничена.

Скорость ведения журнала задается таким, что их можно достигать и поддерживать в различных сценариях, в то время как вся система может поддерживать свои функции с минимальным влиянием на нагрузку пользователей. Управление частотой ведения журнала гарантирует, что резервные копии журналов транзакций остаются в рамках опубликованных соглашений об уровне обслуживания для восстановления.  Эта система управления также предотвращает чрезмерную невыполненную работу на вторичных репликах.

По мере создания записей журнала каждая операция оценивается и оценивается на необходимость задержки, чтобы поддерживать максимальную требуемую скорость ведения журнала (МБ/с в секунду). Задержки не добавляются, когда записи журнала записываются в хранилище, а в процессе создания частоты журнала применяется управление скоростью журнала.

Фактические частоты создания журналов, накладываемые во время выполнения, могут также повлиять на механизмы обратной связи, временно сокращая допустимые скорости ведения журнала, чтобы система могла стабилизировать работу системы. Управление местом в файле журнала, что позволяет избежать появления пространства журнала, а механизмы репликации группы доступности временно снижают общие системные ограничения.

Формирование трафика регулятора скорости ведения журнала осуществляется с помощью следующих типов ожидания (которые доступны в представлениях [sys.dm_exec_requests](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-requests-transact-sql) и [sys.dm_os_wait_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-wait-stats-transact-sql) ):

| Тип ожидания | Примечания |
| :--- | :--- |
| LOG_RATE_GOVERNOR | Ограничение базы данных |
| POOL_LOG_RATE_GOVERNOR | Ограничение пула |
| INSTANCE_LOG_RATE_GOVERNOR | Ограничение уровня экземпляра |  
| HADR_THROTTLE_LOG_RATE_SEND_RECV_QUEUE_SIZE | Элемент управления обратной связи, физическая репликация группы доступности в категории "Премиум/критически важный для бизнеса" не содержаться |  
| HADR_THROTTLE_LOG_RATE_LOG_SIZE | Элемент управления обратной связи, ограничивающий тариф, чтобы избежать возникновения нехватки пространства журнала |
| HADR_THROTTLE_LOG_RATE_MISMATCHED_SLO | Управление обратной связью с георепликацией, ограничение частоты ведения журнала во избежание высокой задержки данных и недоступности геореплик|
|||

При возникновении ограничения скорости ведения журнала, которое ограничивает требуемую масштабируемость, рассмотрите следующие варианты.

- Увеличьте масштаб до более высокого уровня обслуживания, чтобы получить максимальную частоту записи в журнал 96 МБ/с или переключиться на другой уровень служб. Уровень службы " [горизонтальное масштабирование](service-tier-hyperscale.md) " обеспечивает частоту записи в журнал 100 МБ/с независимо от выбранного уровня обслуживания.
- Если загружаемые данные являются временными, например промежуточные данные в процессе ETL, их можно загрузить в базу данных tempdb (с минимальным протоколированием).
- Для аналитических сценариев загрузите в таблицу, охваченную кластеризованным индексом columnstore. Это сокращает необходимую частоту ведения журнала из-за сжатия. Этот метод увеличивает загрузку ЦП и применяется только к наборам данных, которые используют преимущества кластеризованных индексов columnstore.

### <a name="storage-space-governance"></a>Управление дисковым пространством

На уровнях служб Premium и критически важный для бизнеса файлы данных и журналов транзакций хранятся на локальном томе SSD компьютера, на котором размещена база данных или эластичный пул. Это обеспечивает высокую скорость операций ввода-вывода и пропускную способность, а также низкие задержки ввода-вывода Размер этого локального тома зависит от аппаратных возможностей и является конечным. На данном компьютере пространство локального тома потребляется базами данных клиентов, включая `tempdb` , операционную систему, программное обеспечение управления, данные мониторинга, журналы и т. д. При создании, удалении баз данных и увеличении или уменьшении использования места на компьютере с течением времени локальное потребление места на машине снижается. 

Если система обнаружит, что свободное место на компьютере мало, а база данных или эластичный пул не хватает места, она переместит базу данных или эластичный пул на другой компьютер с достаточным объемом свободного места, что позволит увеличить максимальный размер настроенной цели обслуживания. Такое перемещение происходит в режиме «в сети», аналогично операции масштабирования базы данных и имеет аналогичное [воздействие](single-database-scale.md#impact), включая короткий (секунды) отработку отказа в конце операции. Эта отработка отказа прерывает открытые соединения и откатывает транзакции, потенциально влияющие на приложения, использующие базу данных в это время.

Поскольку данные физически копируются на другой компьютер, перемещение больших баз данных может потребовать значительного времени. В течение этого времени, если локальное использование пространства большой пользовательской базой данных или эластичным пулом или `tempdb` база данных растет очень быстро, риск возникновения нехватки пространства увеличится. Система инициирует перемещение базы данных в сбалансированном виде, чтобы предотвратить ошибки нехватки пространства и избежать ненужных отработок отказа.

## <a name="next-steps"></a>Дальнейшие действия

- Сведения об общих ограничениях Azure см. в разделе [Подписка Azure, границы, квоты и ограничения службы](../../azure-resource-manager/management/azure-subscription-service-limits.md).
- Сведения о DTU и eDTU см. в разделе [Общие сведения об обычных единицах передачи данных (DTU) и единицах передачи данных в эластичной базе данных (eDTU)](purchasing-models.md#dtu-based-purchasing-model).
- Сведения об ограничениях на размер базы данных tempdb см. в [этом разделе](/sql/relational-databases/databases/tempdb-database#tempdb-database-in-sql-database).
