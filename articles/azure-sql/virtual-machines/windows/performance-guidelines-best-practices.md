---
title: Рекомендации по оптимизации производительности SQL Server в Azure | Документация Майкрософт
description: Содержит рекомендации по оптимизации производительности SQL Server в Виртуальные машины Microsoft Azure.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
editor: ''
tags: azure-service-management
ms.assetid: a0c85092-2113-4982-b73a-4e80160bac36
ms.service: virtual-machines-sql
ms.subservice: performance
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 11/09/2020
ms.author: mathoma
ms.reviewer: jroth
ms.openlocfilehash: 2b4e8d980ee2b5c69687fc7ad8975e26fe38071a
ms.sourcegitcommit: dfc4e6b57b2cb87dbcce5562945678e76d3ac7b6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2020
ms.locfileid: "97360124"
---
# <a name="performance-guidelines-for-sql-server-on-azure-virtual-machines"></a>Рекомендации по оптимизации производительности SQL Server на виртуальных машинах Azure
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этой статье приводятся рекомендации по оптимизации производительности SQL Server в Виртуальные машины Microsoft Azure.

## <a name="overview"></a>Обзор

При запуске SQL Server на виртуальных машинах Azure рекомендуется продолжать использовать те же параметры настройки производительности базы данных, которые применяются для SQL Server в локальных серверных средах. Однако производительность реляционной базы данных в общедоступном облаке зависит от многих факторов, таких как размер виртуальной машины и конфигурации дисков с данными.

[SQL Server образы, подготовленные в портал Azure](sql-vm-create-portal-quickstart.md) следовать рекомендациям по общей [конфигурации](storage-configuration.md)хранилища. Завершив подготовку обдумайте, нужно ли применить другие виды оптимизации, описанные в этой статье. При принятии решений учитывайте характер рабочих нагрузок, а затем проверьте выбор путем тестирования.

> [!TIP]
> Как правило, существует компромисс между оптимизацией затрат и оптимизацией производительности. Эта статья посвящена *повышению производительности* SQL Server на виртуальных машинах Azure. Если рабочая нагрузка не так велика, могут потребоваться не все перечисленные ниже оптимизации. При оценке этих рекомендаций учитывайте актуальные потребности в производительности, затраты и характер рабочих нагрузок.

## <a name="quick-checklist"></a>Краткий контрольный список

Ниже приведен краткий контрольный список для достижения оптимальной производительности SQL Server на виртуальных машинах Azure.

| Область | Оптимизация |
| --- | --- |
| [Размер виртуальной машины](#vm-size-guidance) | — Используйте размеры виртуальных машин с 4 или более виртуальных ЦП, такими как [Standard_M8-4 мс](/azure/virtual-machines/m-series), [E4ds_v4](../../../virtual-machines/edv4-edsv4-series.md#edv4-series)или [DS12_v2](../../../virtual-machines/dv2-dsv2-series-memory.md#dsv2-series-11-15) или более поздней версии. <br/><br/> — Используйте размеры виртуальных машин, [оптимизированных для памяти](../../../virtual-machines/sizes-memory.md) , для лучшей производительности SQL Server рабочих нагрузок. <br/><br/> -Серии [DSv2 11-15](../../../virtual-machines/dv2-dsv2-series-memory.md), [Edsv4](../../../virtual-machines/edv4-edsv4-series.md) , [M](/azure/virtual-machines/m-series)и [Mv2](../../../virtual-machines/mv2-series.md) предлагают оптимальное соотношение памяти и виртуальное ядро, необходимое для рабочих нагрузок OLTP. Обе виртуальные машины серии M предлагают наибольшее соотношение объема памяти и виртуальное ядро, необходимое для критически важных рабочих нагрузок, а также идеально подходит для рабочих нагрузок хранилища данных. <br/><br/> — Для критически важных и рабочих нагрузок хранилища данных может потребоваться более высокое соотношение памяти и виртуальное ядро. <br/><br/> -Используйте образы виртуальных машин Azure в Marketplace, так как параметры SQL Server и хранилище настроены для обеспечения оптимальной производительности SQL Server. <br/><br/> — Собирайте характеристики производительности целевой рабочей нагрузки и используйте их для определения подходящего размера виртуальной машины для вашего бизнеса.|
| [Память](#storage-guidance) | — Для подробного тестирования SQL Server производительности виртуальных машин Azure с помощью TPC-E и TPC_Cных тестов производительности см. в блоге [оптимизировать производительность OLTP](https://techcommunity.microsoft.com/t5/SQL-Server/Optimize-OLTP-Performance-with-SQL-Server-on-Azure-VM/ba-p/916794). <br/><br/> – Используйте [диски SSD ценовой категории "Премиум"](https://techcommunity.microsoft.com/t5/SQL-Server/Optimize-OLTP-Performance-with-SQL-Server-on-Azure-VM/ba-p/916794), чтобы обеспечить лучшее соотношение цены и производительности. Настройка [кэша только для чтения](../../../virtual-machines/premium-storage-performance.md#disk-caching) для файлов данных и без кэша для файла журнала. <br/><br/> — Используйте [Ultra Disks](../../../virtual-machines/disks-types.md#ultra-disk) , если Рабочая нагрузка требует меньше задержек при работе с хранилищем (1 мс). Дополнительные сведения см. в статье [Переход на Ultra Disk](storage-migrate-to-ultradisk.md) . <br/><br/> – Соберите данные о требованиях к задержке при обращении к хранилищу для файлов данных SQL Server, журналов и базы данных TempDB, [выполнив мониторинг приложения](../../../virtual-machines/premium-storage-performance.md#application-performance-requirements-checklist), прежде чем выбирать тип диска. Если < 1-MS требуются задержки хранилища, используйте Ultra Disks, в противном случае используйте SSD уровня "Премиум". Если низкая задержка требуется только для файлов журналов, но не для файлов данных, [подготовьте диски ценовой категории "Ультра"](../../../virtual-machines/disks-enable-ultra-ssd.md) с нужными уровнями пропускной способности и скорости ввода-вывода только для файлов журналов. <br/><br/>  – Служба хранилища ценовой категории "Стандартный" рекомендуется только для разработки и тестирования, а также для хранения файлов резервных копий. Она не должна использоваться для производственных рабочих нагрузок. <br/><br/> Храните [учетную запись хранения](../../../storage/common/storage-account-create.md) и виртуальную машину SQL Server в одном и том же регионе.<br/><br/> – Отключите [геоизбыточное хранилище](../../../storage/common/storage-redundancy.md) (георепликацию) Azure в учетной записи хранения.  |
| [диски;](#disks-guidance) | – Используйте как минимум 2 [диска SSD ценовой категории "Премиум"](../../../virtual-machines/disks-types.md#premium-ssd) (1 для файлов журнала и 1 для файлов данных). <br/><br/> — Для рабочих нагрузок, для которых требуются < задержки ввода-вывода в 1 мс, включите ускоритель записи для серии M и рассмотрите возможность использования SSD (цен. категория "Ультра") дисков для ES и серии DS. <br/><br/> – Включите [кэширование операций чтения](../../../virtual-machines/premium-storage-performance.md#disk-caching) на дисках, где размещаются файлы данных.<br/><br/> — Добавьте дополнительные 20% операций ввода-вывода или пропускной способности уровня "Премиум", чем требуется рабочей нагрузки при [настройке хранилища для SQL Server файлов данных, журналов и tempdb](storage-configuration.md) . <br/><br/> Избегайте использования дисков операционной системы или временных дисков для хранения базы данных или журналов.<br/><br/> Не включайте кэширование на дисках, где находится файл журнала.  **Важно!** при изменении параметров кэша для диска виртуальных машин Azure следует прекращать работу службы SQL Server.<br/><br/> – Обеспечьте чередование нескольких дисков данных Azure для увеличения пропускной способности хранилища.<br/><br/> Выполняйте форматирование с использованием задокументированных размеров кластеров. <br/><br/> – Разместите базу данных TempDB на локальном диске SSD `D:\` для критически важных рабочих нагрузок SQL Server (выбрав правильный размер виртуальной машины). Если вы создаете виртуальную машину из шаблонов быстрого запуска портал Azure или Azure и [размещаете временную базу данных на локальном диске](https://techcommunity.microsoft.com/t5/SQL-Server/Announcing-Performance-Optimized-Storage-Configuration-for-SQL/ba-p/891583), дальнейшие действия не требуются. во всех остальных случаях выполните действия в блоге, чтобы  [использовать SSDS для хранения базы данных tempdb](https://cloudblogs.microsoft.com/sqlserver/2014/09/25/using-ssds-in-azure-vms-to-store-sql-server-TempDB-and-buffer-pool-extensions/) , чтобы предотвратить сбои после перезагрузки. Если емкости локального диска недостаточно для размещения TempDB, разместите эту базу данных в пуле носителей, созданном путем [чередования](../../../virtual-machines/premium-storage-performance.md) дисков SSD ценовой категории "Премиум" с [кэшированием только для чтения](../../../virtual-machines/premium-storage-performance.md#disk-caching). |
| [ВВОД-ВЫВОД](#io-guidance) |Включите сжатие страниц базы данных.<br/><br/> Включите быструю инициализацию для файлов данных.<br/><br/> Ограничьте авторасширение базы данных.<br/><br/> Отключите автосжатие базы данных.<br/><br/> Переместите все базы данных на диски с данными, включая системные базы данных.<br/><br/> Переместите журнал ошибок SQL Server и каталоги файлов трассировки на диски данных.<br/><br/> – Настройте расположения по умолчанию для файлов резервных копий и базы данных.<br/><br/> - [Включите блокировку страниц в памяти.](/sql/database-engine/configure-windows/enable-the-lock-pages-in-memory-option-windows)<br/><br/> — Оцените и примените [последние накопительные обновления](/sql/database-engine/install-windows/latest-updates-for-microsoft-sql-server) для установленной версии SQL Server. |
| [Характерные особенности компонента](#feature-specific-guidance) | — Резервное копирование непосредственно в хранилище BLOB-объектов Azure.<br/><br/>– Используйте [резервные копии моментальных снимков файлов](/sql/relational-databases/backup-restore/file-snapshot-backups-for-database-files-in-azure) для баз данных размером более 12 ТБ. <br/><br/>– Используйте несколько файлов TempDB (1 файл на ядро, до 8 файлов).<br/><br/>– Задайте максимальный объем памяти сервера на уровне 90 % или оставьте до 50 ГБ для операционной системы. <br/><br/>– Включите программную архитектуру NUMA. |


<br/>
Дополнительные сведения о том, *как* выполнить эти оптимизации и *для чего* они необходимы, см. в подробных сведениях и руководствах, предоставленных в следующих разделах.
<br/><br/>

## <a name="getting-started"></a>Начало работы

Если вы создаете новый SQL Server на виртуальной машине Azure и не выполняете миграцию текущей исходной системы, создайте новую виртуальную машину SQL Server в соответствии с требованиями поставщика.  Требования к поставщику для SQL Server виртуальной машины аналогичны требованиям к развертыванию в локальной среде. 

Если вы создаете новую виртуальную машину SQL Server с новым приложением, созданным для облака, вы можете легко масштабировать виртуальную машину SQL Server по мере развития требований к данным и использованию.
Запускайте среды разработки с использованием серии D-Series, серии B или Av2 и развивайте среду с течением времени. 

Рекомендуемый минимум для производственной среды OLTP — 4 Виртуальное ядро, 32 ГБ памяти и отношение памяти к Виртуальное ядро 8. Для новых сред Начните с 4 Виртуальное ядро компьютеров и масштабируйте их до 8, 16, 32 виртуальных ядер или более при изменении требований к данным и вычислительным ресурсам. Для пропускной способности OLTP целевые SQL Server виртуальные машины с 5000 операций ввода-вывода в секунду для каждого Виртуальное ядро. 

Используйте SQL Server образы VM Marketplace с конфигурацией хранилища на портале. Это упростит создание пулов носителей, необходимых для получения размера, операций ввода-вывода в секунду и пропускной способности, необходимой для рабочих нагрузок. Важно выбрать SQL Server виртуальных машин, поддерживающих хранилище класса Premium и кэширование хранилища класса Premium. Дополнительные сведения см. в разделе " [хранилище](#storage-guidance) ". 

SQL Server в хранилище данных и критически важных средах часто требуется масштабироваться сверх соотношения "память — Виртуальное ядро". Для средних сред можно выбрать соотношение 16 ядер к памяти и соотношение 32 ядра к памяти для больших сред хранилища данных. 

SQL Server средах хранилища данных часто получают преимущества параллельной обработки больших компьютеров. По этой причине серии M и Mv2 являются надежными вариантами для больших сред хранилища данных.

## <a name="vm-size-guidance"></a>Рекомендации по выбору размеров виртуальных машин

Используйте конфигурацию виртуальных ЦП и памяти исходного компьютера в качестве основы для миграции текущей локальной базы данных SQL Server в SQL Server на виртуальных машинах Azure. Поднесите базовую лицензию в Azure, чтобы воспользоваться преимуществами [преимущество гибридного использования Azure](https://azure.microsoft.com/pricing/hybrid-benefit/) и сэкономить на SQL Server стоимости лицензирования.

**В качестве отправной точки для рабочих нагрузок рабочей SQL Server Майкрософт рекомендует отношение "память — Виртуальное ядро", равное 8.** Меньшее соотношение приемлемо для непроизводственных рабочих нагрузок. 

Выберите [оптимизированную для памяти](../../../virtual-machines/sizes-memory.md), [Общее назначение](../../../virtual-machines/sizes-general.md), [оптимизированное для хранилища](../../../virtual-machines/sizes-storage.md)или [ограниченный](../../../virtual-machines/constrained-vcpu.md) размер виртуальной машины Виртуальное ядро, который лучше всего подходит для SQL Server производительности в зависимости от рабочей нагрузки (OLTP или хранилище данных). 

### <a name="memory-optimized"></a>Оптимизированные для операций в памяти

[Размер виртуальных машин, оптимизированных для памяти](../../../virtual-machines/sizes-memory.md) , является первичным целевым объектом для SQL Server виртуальных машин и рекомендуемым вариантом корпорации Майкрософт. Виртуальные машины, оптимизированные для памяти, обеспечивают более надежное соотношение памяти и процессора, а также средние и большие кэши. 

#### <a name="m-and-mv2-series"></a>Серии M и Mv2

[Серия M](/azure/virtual-machines/m-series) предлагает виртуальное ядро количество и память для некоторых из самых больших SQL Server рабочих нагрузок.  

[Серия Mv2](../../../virtual-machines/mv2-series.md) имеет наибольшее количество Виртуальное ядро и память, поэтому рекомендуется для критически важных рабочих нагрузок и хранилищ данных. Экземпляры серии Mv2 — это оптимизированные для памяти размеры виртуальных машин, обеспечивающие непревзойденную вычислительную производительность для поддержки больших баз данных в памяти и рабочих нагрузок с высоким соотношением памяти к ЦП, которое идеально подходит для серверов реляционных баз данных, больших кэшей и аналитики в памяти.

Например, [Standard_M64ms](/azure/virtual-machines/m-series) имеет отношение 28 памяти к Виртуальное ядро.

К некоторым функциям серии M и Mv2, привлекательным для SQL Server производительности, относятся [хранилище класса Premium](../../../virtual-machines/premium-storage-performance.md) и [Поддержка кэширования хранилища](../../../virtual-machines/premium-storage-performance.md#disk-caching) уровня "Премиум", поддержка [Ultra-Disk](../../../virtual-machines/disks-enable-ultra-ssd.md) и [ускорение записи](../../../virtual-machines/how-to-enable-write-accelerator.md).

#### <a name="edsv4-series"></a>Серия Edsv4

[Серия Edsv4](../../../virtual-machines/edv4-edsv4-series.md) предназначена для приложений, интенсивно использующих память. На этих виртуальных машинах имеется большая емкость SSD локального хранилища, строгое число операций ввода-вывода в секунду, до 504 гиб ОЗУ и Улучшенное вычисление по сравнению с предыдущими размерами Ev3/Esv3 с Gen2 виртуальными машинами. На этих виртуальных машинах имеется почти согласованное соотношение памяти и виртуальное ядро, что идеально подходит для стандартных рабочих нагрузок SQL Server. 

Эта серия виртуальных машин идеально подходит для корпоративных приложений и приложений с большим временем задержки и высокой скоростью локального хранилища.

Виртуальные машины серии Edsv4 поддерживают [хранилище класса Premium](../../../virtual-machines/premium-storage-performance.md)и [кэширование хранилища класса Premium](../../../virtual-machines/premium-storage-performance.md#disk-caching).

#### <a name="dsv2-series-11-15"></a>Серия DSv2 11–15

[DSv2-series 11-15](../../../virtual-machines/dv2-dsv2-series-memory.md#dsv2-series-11-15) имеет те же конфигурации памяти и дисков, что и в предыдущей серии D. Этот ряд имеет согласованное соотношение памяти и ЦП 7 на всех виртуальных машинах. 

[DSv2-series 11-15](../../../virtual-machines/dv2-dsv2-series-memory.md#dsv2-series-11-15) поддерживает [хранилище класса Premium](../../../virtual-machines/premium-storage-performance.md) и [кэширование хранилища класса](../../../virtual-machines/premium-storage-performance.md#disk-caching)Premium, что настоятельно рекомендуется для оптимальной производительности.

### <a name="general-purpose"></a>Общее назначение

[Размеры виртуальных машин общего назначения](../../../virtual-machines/sizes-general.md) предназначены для обеспечения сбалансированного соотношения памяти и виртуальное ядро для небольших рабочих нагрузок уровня записи, таких как разработка и тестирование, веб-серверы и небольшие серверы баз данных. 

Из-за меньшего соотношения памяти и виртуальное ядрои с виртуальными машинами общего назначения важно тщательно отслеживать счетчики производительности на основе памяти, чтобы убедиться, что SQL Server способен получить память кэша буфера. Дополнительные сведения см. в разделе [Базовая производительность памяти](#memory) . 

Поскольку начальная рекомендация для рабочих нагрузок рабочей нагрузки — это соотношение "память — Виртуальное ядро", минимальная рекомендуемая конфигурация для виртуальной машины общего назначения, в которой выполняется SQL Server, составляет 4 виртуальных ЦП и 32 ГБ памяти. 

#### <a name="ddsv4-series"></a>Серия Ddsv4

[Серия Ddsv4](../../../virtual-machines/ddv4-ddsv4-series.md) предлагает достаточное сочетание виртуальных ЦП, памяти и временного диска, но с меньшей поддержкой памяти и виртуальное ядро. 

Виртуальные машины Ddsv4 имеют меньшую задержку и более скоростное локальное хранилище.

Эти компьютеры идеально подходят для параллельных развертываний SQL и приложений, требующих быстрого доступа к временным хранилищам и реляционным базам данных отделов. Для всех виртуальных машин в этой серии используется стандартное соотношение Виртуальное ядро памяти 4. 

Поэтому рекомендуется использовать D8ds_v4 в качестве начальной виртуальной машины в этой серии, которая имеет 8 виртуальных ядер и 32 ГБ памяти. Самый крупный компьютер — это D64ds_v4, в котором 64 ГБ памяти, виртуальных ядер и 256 гигабайт.

Виртуальные машины [серии Ddsv4](../../../virtual-machines/ddv4-ddsv4-series.md) поддерживают [хранилище класса Premium](../../../virtual-machines/premium-storage-performance.md) и [кэширование хранилища класса](../../../virtual-machines/premium-storage-performance.md#disk-caching)Premium.

> [!NOTE]
> [Ddsv4-Series](../../../virtual-machines/ddv4-ddsv4-series.md) не имеет соотношения "память — Виртуальное ядро", равное 8, которое рекомендуется для рабочих нагрузок SQL Server. Таким образом, следует рассмотреть возможность использования этих виртуальных машин только для небольших рабочих нагрузок приложений и разработки.

#### <a name="b-series"></a>Серия B

Масштабируемые размеры виртуальных машин [серии B](../../../virtual-machines/sizes-b-series-burstable.md) идеально подходят для рабочих нагрузок, которые не требуют единообразной производительности, такой как проверка концепции и очень небольшие серверы приложений и разработки. 

Большинство размеров виртуальных машин [серии B](../../../virtual-machines/sizes-b-series-burstable.md) имеют соотношение "память — Виртуальное ядро", равное 4. Самым большим из этих компьютеров является [Standard_B20ms](../../../virtual-machines/sizes-b-series-burstable.md) с 20 виртуальных ядер и 80 ГБ памяти.

Эта серия уникальна, так как приложения имеют возможность **ускорения** работы в рабочее время с разбивкой на отдельные кредиты в зависимости от размера компьютера. 

После исчерпания кредитов виртуальная машина возвращается к производительности базового компьютера.

Преимущество серии B — это экономия вычислительных ресурсов, которую можно достигнуть по сравнению с другими размерами виртуальных машин в других рядах, особенно если требуется вычислительная мощность в течение дня.

Эта серия поддерживает [хранилище класса Premium](../../../virtual-machines/premium-storage-performance.md), но **не поддерживает** [кэширование хранилища класса Premium](../../../virtual-machines/premium-storage-performance.md#disk-caching).

> [!NOTE] 
> Для [пакетной серии B](../../../virtual-machines/sizes-b-series-burstable.md) не установлено соотношение "память — Виртуальное ядро", равное 8, которое рекомендуется для рабочих нагрузок SQL Server. Поэтому рекомендуется использовать эти виртуальные машины только для небольших приложений, веб-серверов и рабочих нагрузок разработки.

#### <a name="av2-series"></a>Серия Av2

Виртуальные машины [серии Av2](../../../virtual-machines/av2-series.md) лучше всего подходят для рабочих нагрузок начального уровня, таких как разработка и тестирование, веб-серверы с небольшим трафиком, небольшие и средние базы данных приложений, а также средства проверки концепции.

Только [Standard_A2m_v2](../../../virtual-machines/av2-series.md) (2 виртуальных ядер и 16 ГБ памяти), [Standard_A4m_v2](../../../virtual-machines/av2-series.md) (4 виртуальных ядер и 32 ГБ памяти), а также [Standard_A8m_v2](../../../virtual-machines/av2-series.md) (8 виртуальных ядер и 64 ГБ памяти) имеют оптимальное соотношение памяти и виртуальное ядро для этих трех основных виртуальных машин. 

Эти виртуальные машины являются хорошим вариантом для небольших SQL Server машин разработки и тестирования. 

8 Виртуальное ядро [Standard_A8m_v2](../../../virtual-machines/av2-series.md) также может быть хорошим вариантом для небольших приложений и веб-серверов.

> [!NOTE] 
> Серия Av2 не поддерживает хранилище класса Premium и поэтому не рекомендуется для рабочих нагрузок рабочей SQL Server даже с виртуальными машинами, имеющими соотношение памяти с виртуальное ядро 8.

### <a name="storage-optimized"></a>Оптимизированные для операций в хранилище

[Размеры виртуальных машин, оптимизированных для хранилища](../../../virtual-machines/sizes-storage.md) , предназначены для конкретных вариантов использования. Эти виртуальные машины специально разработаны с оптимизированной пропускной способностью диска и операциями ввода-вывода. Эта серия виртуальных машин предназначена для сценариев больших данных, хранилищ данных и больших транзакционных баз данных. 

#### <a name="lsv2-series"></a>Серия Lsv2

[Lsv2-Series](../../../virtual-machines/lsv2-series.md) имеет высокую пропускную способность, низкую задержку и локальное хранилище NVMe. Виртуальные машины серии Lsv2 оптимизированы для использования локального диска на узле, подключенном непосредственно к виртуальной машине, вместо использования устойчивых дисков данных. 

Эти виртуальные машины являются надежными вариантами для больших данных, хранилищ данных, отчетов и рабочих нагрузок ETL. Высокая пропускная способность и операции ввода-вывода в локальном хранилище NVMe являются хорошим вариантом использования для обработки файлов, которые будут загружены в базу данных, и других сценариев, в которых исходные данные могут быть воссозданы из исходной системы или других репозиториев, таких как хранилище BLOB-объектов Azure или Azure Data Lake. [Серия Lsv2](../../../virtual-machines/lsv2-series.md) Виртуальные машины могут также занимать свою производительность диска в течение 30 минут за раз.

Эти виртуальные машины размером от 8 до 80 виртуальных ЦП с 8 гиб памяти на виртуальных ЦП и каждые 8 1,92 виртуальных ЦП ТБ твердотельного накопителя NVMe. Это означает, что для самой крупной виртуальной машины этой серии [L80s_v2](../../../virtual-machines/lsv2-series.md), существует 80 виртуальных цп и 640 Bib памяти с 10 раз 1.92 ТБ хранилища NVMe.  Существует согласованное соотношение памяти и виртуальное ядро, равное 8, для всех этих виртуальных машин.

Хранилище NVMe является эфемерным, поэтому при перезагрузке виртуальной машины данные на этих дисках будут потеряны.

Серии Lsv2 и Ls поддерживают [хранилище класса Premium](../../../virtual-machines/premium-storage-performance.md), но не кэширование хранилища класса Premium. Создание локального кэша для увеличения числа операций ввода-вывода не поддерживается. 

> [!WARNING]
> Хранение файлов данных в эфемерном хранилище NVMe может привести к утере данных при освобождении виртуальной машины. 

### <a name="constrained-vcores"></a>Ограниченный виртуальных ядер

Для высокопроизводительных рабочих нагрузок SQL Server часто требуется больший объем памяти, операций ввода-вывода и пропускной способности без увеличения числа Виртуальное ядро. 

Большинство рабочих нагрузок OLTP — это базы данных приложений, управляемые большим количеством небольших транзакций. При использовании рабочих нагрузок OLTP считывается или изменяется только небольшой объем данных, но объем транзакций, управляемых количеством пользователей, значительно выше. Важно иметь SQL Serverную память, доступную для планов кэширования, сохранять недавно использовавшиеся данные для повышения производительности, а также обеспечивать быстрое считывание данных в память. 

Этим средам OLTP требуется больший объем памяти, быстрый объем хранилища и пропускная способность ввода-вывода, необходимая для оптимального выполнения. 

Чтобы обеспечить такой уровень производительности без повышения SQL Server стоимости лицензирования, Azure предлагает размеры виртуальных машин с [ограниченным количеством виртуальных ЦП](../../../virtual-machines/constrained-vcpu.md). 

Это помогает управлять затратами на лицензирование за счет сокращения числа доступных виртуальных ядер при сохранении одинаковой памяти, хранилища и пропускной способности ввода-вывода родительской виртуальной машины.

Число виртуальных ЦП может быть ограничено одной половиной до одного квартала исходного размера виртуальной машины. Уменьшение числа виртуальных ядер, доступных для виртуальной машины, обеспечит более высокое соотношение памяти и виртуальное ядро.

Эти новые размеры виртуальных машин имеют суффикс, указывающий количество активных виртуальных ЦП, чтобы упростить их определение. 

Например, для [M64-32ms](../../../virtual-machines/constrained-vcpu.md) требуется только лицензирование 32 SQL Server виртуальных ядер с памятью, операциями ввода-вывода и пропускной способностью [M64ms](/azure/virtual-machines/m-series) , а [M64 – 16ms](../../../virtual-machines/constrained-vcpu.md) требуется только лицензирование 16 виртуальных ядер.  Несмотря на то, что [M64-16ms](../../../virtual-machines/constrained-vcpu.md) имеет квартал SQL Server стоимости лицензирования M64ms, стоимость виртуальной машины будет одинаковой.

> [!NOTE] 
> - С ограниченными рабочими нагрузками для средних и крупных хранилищ данных может быть выгодно несколько [Виртуальное ядро виртуальных машин](../../../virtual-machines/constrained-vcpu.md), но рабочие нагрузки хранилища данных обычно характеризуются меньшим числом пользователей и процессов, обращающихся к большим объемам данных через планы запросов, которые выполняются параллельно. 
> - Стоимость вычислений, которая включает в себя лицензирование операционной системы, останется такой же, как и родительская виртуальная машина. 

## <a name="storage-guidance"></a>Рекомендации по выбору хранилища

Подробное тестирование производительности SQL Server на виртуальных машинах Azure с помощью тестов TPC-E и TPC-C см. в блоге [Оптимизация производительности OLTP](https://techcommunity.microsoft.com/t5/SQL-Server/Optimize-OLTP-Performance-with-SQL-Server-on-Azure-VM/ba-p/916794). 

Для всех производственных рабочих нагрузок мы рекомендуем использовать кэш BLOB-объектов Azure с дисками SSD ценовой категории "Премиум". 

> [!WARNING]
> HDD и SSD (цен. категория "Стандартный") характеризуются различными задержками и пропускной способностью и рекомендуется только для рабочих нагрузок по разработке и тестированию. Для производственных рабочих нагрузок необходимо использовать SSD (цен. категория "Премиум").

Кроме того, рекомендуется создать свою учетную запись хранения Azure в одном центре обработки данных с виртуальными машинами SQL Server для уменьшения задержек при передаче данных. При создании учетной записи хранения отключите георепликацию, поскольку согласованный порядок записи на несколько дисков не гарантируется. Вместо этого рекомендуется реализовать средства аварийного восстановления SQL Server между двумя центрами обработки данных Azure. Дополнительные сведения см. в статье [Высокий уровень доступности и аварийное восстановление для SQL Server на виртуальных машинах Azure](business-continuity-high-availability-disaster-recovery-hadr-overview.md).

## <a name="disks-guidance"></a>Рекомендации по использованию дисков

На виртуальных машинах Azure есть три основных типа дисков:

* **Диск ОС**. при создании виртуальной машины Azure платформа присоединяет по крайней мере один диск (помеченный как диск **C** ) к виртуальной машине для диска операционной системы. Этот диск представляет собой VHD-файл, сохраненный как страничный BLOB-объект в хранилище.
* **Временный диск**: виртуальные машины Azure содержат еще один диск (обозначенный буквой **D**), который называется временным диском. Это диск на узле, который может использоваться для области временных файлов.
* **Диски данных**: Вы также можете присоединить к виртуальной машине дополнительные диски, например диски данных, и они также будут сохранены в хранилище как страничные BLOB-объекты.

В следующих разделах приводятся рекомендации по использованию этих дисков.

### <a name="operating-system-disk"></a>Диск операционной системы

Диск операционной системы — это VHD, который можно загружать и подключать в качестве работающей версии операционной системы и помечен как диск **C** .

По умолчанию для диска операционной системы применяется политика кэширования **Чтение и запись**. Для приложений, чувствительных к уровню производительности, рекомендуется использовать диски данных вместо диска операционной системы. См. подраздел "Диски данных" ниже.

### <a name="temporary-disk"></a>Временный диск

Временный диск хранилища, помеченный как диск **D** , не сохраняется в хранилище BLOB-объектов Azure. Не храните файлы пользовательской базы данных или файлы журнала транзакций пользователя на диске **D**.

Разместите базу данных TempDB на локальном диске SSD `D:\` для критически важных рабочих нагрузок SQL Server (выбрав правильный размер виртуальной машины). Если вы создаете виртуальную машину из шаблонов быстрого запуска портал Azure или Azure и [размещаете временную базу данных на локальном диске](https://techcommunity.microsoft.com/t5/SQL-Server/Announcing-Performance-Optimized-Storage-Configuration-for-SQL/ba-p/891583), дальнейшие действия не требуются. во всех остальных случаях выполните действия в блоге, чтобы  [использовать SSDS для хранения базы данных tempdb](https://cloudblogs.microsoft.com/sqlserver/2014/09/25/using-ssds-in-azure-vms-to-store-sql-server-TempDB-and-buffer-pool-extensions/) , чтобы предотвратить сбои после перезагрузки. Если емкости локального диска недостаточно для размещения TempDB, разместите эту базу данных в пуле носителей, созданном путем [чередования](../../../virtual-machines/premium-storage-performance.md) дисков SSD ценовой категории "Премиум" с [кэшированием только для чтения](../../../virtual-machines/premium-storage-performance.md#disk-caching).

Для виртуальных машин, которые поддерживают диски SSD ценовой категории "Премиум", базу данных TempDB можно разместить на диске с поддержкой дисков SSD ценовой категории "Премиум" с включенным кэшированием чтения.


### <a name="data-disks"></a>Диски данных

* **Используйте диски SSD ценовой категории "Премиум" для файлов данных и журналов.** Если вы не применяете чередование дисков, используйте два диска SSD ценовой категории "Премиум", где один диск содержит файлы журналов, а другой — файлы данных. Каждый SSD ценовой категории "Премиум" обеспечивает определенное количество операций ввода-вывода в секунду и пропускную способность (МБ/с) в зависимости от своего размера, как описано в [этой статье](../../../virtual-machines/disks-types.md). При использовании метода чередования дисков, например дискового пространства, можно достичь оптимальной производительности, имея два пула: один для файлов журнала, а другой для файлов данных. Но если вы планируете использовать экземпляры отказоустойчивого кластера (FCI) SQL Server, необходимо настроить один пул или использовать [общие папки ценовой категории "Премиум"](failover-cluster-instance-premium-file-share-manually-configure.md).

   > [!TIP]
   > - Результаты тестирования различных конфигураций дисков и рабочих нагрузок см. в следующей записи блога: [рекомендации по настройке хранилища для SQL Server на виртуальных машинах Azure](/archive/blogs/sqlserverstorageengine/storage-configuration-guidelines-for-sql-server-on-azure-vm).
   > - Чтобы обеспечить надежную работу критически важных серверов SQL Server, для которых требуется порядка 50 000 операций ввода-вывода в секунду, рассмотрите возможность замены дисков P10–P30 дисками SSD (цен. категория "Ультра"). Дополнительные сведения доступны в этой записи блога: [Mission critical performance with Ultra SSD](https://azure.microsoft.com/blog/mission-critical-performance-with-ultra-ssd-for-sql-server-on-azure-vm/) (Выполнение критически важных операций с помощью дисков SSD (цен. категория "Ультра")).

   > [!NOTE]
   > При подготовке виртуальной машины SQL Server на портале у вас есть возможность изменить конфигурацию хранилища. В зависимости от конфигурации Azure настраивает один или несколько дисков. Несколько дисков объединяются в единый пул хранилищ с чередованием. Файлы данных и журналов совместно размещаются в этой конфигурации. Дополнительные сведения см. в статье [Настройка хранилища для виртуальных машин SQL Server](storage-configuration.md).

* **Чередование дисков**. для большей пропускной способности можно добавить дополнительные диски данных и использовать чередование дисков. Чтобы определить количество дисков данных, необходимо проанализировать количество операций ввода-вывода в секунду и пропускную способность, необходимые для ваших файлов журналов, файлов данных и tempdb. Обратите внимание, что разные размеры виртуальной машины накладывают разные ограничения на количество операций ввода-вывода в секунду и пропускную способность. Ознакомьтесь с таблицами зависимости количества операций ввода-вывода в секунду от [размера виртуальной машины](../../../virtual-machines/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json). Придерживайтесь приведенных ниже рекомендаций.

  * Для Windows 8 и Windows Server 2012 или более поздней версии используйте [дисковые пространства](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh831739(v=ws.11)), придерживаясь приведенных ниже рекомендаций.

      1. Задайте для чередования значение 64 КБ (65 536 байт) для рабочих нагрузок OLTP и 256 КБ (262 144 байт) для рабочих нагрузок хранилища данных, чтобы избежать снижения производительности из-за рассогласования разделов. Это следует сделать в PowerShell.
      2. Задайте число столбцов равным количеству физических дисков. Используйте PowerShell (не пользовательский интерфейс диспетчера сервера) при настройке более 8 дисков. 

    Например, следующая оболочка PowerShell создает новый пул носителей с размером чередования в 64 КБ и число столбцов, равное количеству физических дисков в пуле носителей:

    ```powershell
    $PhysicalDisks = Get-PhysicalDisk | Where-Object {$_.FriendlyName -like "*2" -or $_.FriendlyName -like "*3"}
    
    New-StoragePool -FriendlyName "DataFiles" -StorageSubsystemFriendlyName "Storage Spaces*" `
        -PhysicalDisks $PhysicalDisks | New- VirtualDisk -FriendlyName "DataFiles" `
        -Interleave 65536 -NumberOfColumns $PhysicalDisks .Count -ResiliencySettingName simple `
        –UseMaximumSize |Initialize-Disk -PartitionStyle GPT -PassThru |New-Partition -AssignDriveLetter `
        -UseMaximumSize |Format-Volume -FileSystem NTFS -NewFileSystemLabel "DataDisks" `
        -AllocationUnitSize 65536 -Confirm:$false 
    ```

  * Для Windows 2008 R2 или более ранней версии можно воспользоваться динамическими дисками (чередующимися томами операционной системы), при этом размер чередования всегда составляет 64 КБ. Эта возможность не поддерживается в Windows 8 и Windows Server 2012. Дополнительные сведения см. в заявлении о поддержке в статье [Virtual Disk Service is transitioning to Windows Storage Management API](/windows/win32/w8cookbook/vds-is-transitioning-to-wmiv2-based-windows-storage-management-api) (Служба виртуальных дисков переходит на API управления хранилищами Windows).

  * Если вы используете [локальные дисковые пространства (S2D)](/windows-server/storage/storage-spaces/storage-spaces-direct-in-vm) с [экземплярами отказоустойчивого кластера SQL Server](failover-cluster-instance-storage-spaces-direct-manually-configure.md), вам нужно настроить единый пул. Хотя в этом пуле можно создать тома с разной емкостью, они будут иметь общую характеристику, например одну политику кэширования.

  * Определите число дисков, связанных с пулом хранилищ, на основании ожидаемой нагрузки. Помните, что в разных размерах виртуальной машины можно подключать различное число дисков данных. Дополнительные сведения см. в статье [размеры виртуальных машин](../../../virtual-machines/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

  * Если вы не используете твердотельные накопители уровня "Премиум" (сценарии разработки и тестирования), рекомендуется добавить максимальное число дисков данных, поддерживаемое [размером виртуальной машины](../../../virtual-machines/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) , и использовать чередование дисков.

* **Политика кэширования**: изучите предложенные ниже рекомендации по выбору политики кэширования в зависимости от конфигурации хранилища.

  * Если вы используете отдельные диски для файлов данных и файлов журналов, включите кэширование операций чтения только на дисках с файлами данных и файлами TempDB. Это позволит существенно повысить производительность. Не включайте кэширование для диска, где хранятся файлы журналов, так как это немного снижает производительность.

  * Если вы используете чередование дисков в едином пуле хранилища, для большинства рабочих нагрузок кэширование операций чтения повысит производительность. Если у вас есть отдельные пулы хранения для файлов журнала и данных, включите кэширование чтения только в пуле хранения для файлов данных. Для некоторых рабочих нагрузок с операциями записи большого объема данных можно повысить производительность, отключив кэширование. Точные данные можно получить только путем тестирования.

  * Все описанные выше рекомендации относятся к SSD (цен. категория "Премиум"). Если SSD (цен. категория "Премиум") не используется, не включайте кэширование ни для каких дисков данных.

  * Инструкции по настройке кэширования дисков см. в указанных ниже статьях. Для классической модели развертывания (ASM) изучите: [Set-AzureOSDisk](/previous-versions/azure/jj152847(v=azure.100)) и [Set-AzureDataDisk](/previous-versions/azure/jj152851(v=azure.100)). Для модели развертывания Azure Resource Manager изучите следующие ресурсы: [Set-AzOSDisk](/powershell/module/az.compute/set-azvmosdisk) и [Set-AzVMDataDisk](/powershell/module/az.compute/set-azvmdatadisk).

     > [!WARNING]
     > При изменении параметра кэша для дисков виртуальных машин Azure следует отключить службу SQL Server, чтобы избежать возможного повреждения базы данных.

* **Размер единицы размещения NTFS**: При форматировании диска с данными мы советуем использовать размер единицы размещения 64 КБ для файлов данных и журналов, а также TempDB. Если база данных TempDB размещена на временном диске (D:\ ) производительность, достигаемая за счет использования этого диска, перевешивает потребность в размере единицы распределения 64 КБ. 

* **Рекомендации по управлению дисками**: при удалении диска данных или изменении его типа кэша остановите службу SQL Server. При изменении параметров кэширования диска ОС Azure останавливает виртуальную машину, изменяет тип кэша и перезапускает виртуальную машину. При изменении параметров кэша диска данных виртуальная машина не останавливается. Диск данных отключается от нее на время внесения изменений, а затем снова подключается к виртуальной машине.

  > [!WARNING]
  > Если не останавливать службу SQL Server на время таких операций, это может привести к повреждению базы данных.


## <a name="io-guidance"></a>Рекомендации по использованию операций ввода-вывода

* Наилучшие результаты работы с SSD (цен. категория "Премиум") достигаются при параллелизации приложений и запросов. SSD (цен. категория "Премиум") предназначено для сценариев, где глубина очереди ввода-вывода больше 1, поэтому прирост производительности для однопоточных последовательных запросов почти не ощущается (даже если они направляются в хранилище в большом объеме). Например, это может негативно повлиять на результаты однопоточного тестирования в средствах анализа производительности, таких как SQLIO.

* Рекомендуется использовать [сжатие страниц базы данных](/sql/relational-databases/data-compression/data-compression) , так как это позволяет повысить производительность рабочих нагрузок с большим объемом операций ввода-вывода. Однако сжатие данных может повысить потребление ресурсов ЦП на сервере базы данных.

* Рекомендуется включить быструю инициализацию файлов для сокращения времени, необходимого для начального выделения файлов. Чтобы воспользоваться преимуществами быстрой инициализации файлов, назначьте SE_MANAGE_VOLUME_NAME учетной записи службы SQL Server (MSSQLSERVER) и добавьте ее в политику безопасности **Выполнение задач по обслуживанию томов**. Если вы используете образ платформы SQL Server для Azure, то учетная запись службы по умолчанию (NT Service\MSSQLSERVER) не добавляется в политику безопасности **Выполнение задач по обслуживанию томов**. Другими словами, быстрая инициализация файлов в образе платформы SQL Server Azure не включена. После добавления учетной записи службы SQL Server в политику безопасности **Выполнение задач по обслуживанию томов** перезапустите службу SQL Server. Использование этой функции может быть показано из соображений безопасности. Дополнительные сведения см. в разделе [Инициализация файлов базы данных](/sql/relational-databases/databases/database-instant-file-initialization).

* Имейте в виду, что **автоувеличение** считается просто случайом для непредвиденного роста. Не используйте авторасширение для повседневного управления ростом данных и журналов. При использовании авторасширения предварительно увеличьте размер файла с помощью параметра размера.

* Убедитесь, что **автосжатие** отключено, чтобы избежать ненужных затрат ресурсов, что может отрицательно повлиять на производительность.

* Переместите все базы данных на диски с данными, включая системные базы данных. Дополнительные сведения см. в статье [Перемещение системных баз данных](/sql/relational-databases/databases/move-system-databases).

* Переместите журнал ошибок SQL Server и каталоги файлов трассировки на диски с данными. Для этого в диспетчере конфигурации SQL Server щелкните правой кнопкой мыши свой экземпляр SQL Server и выберите пункт "Свойства". На вкладке **Параметры запуска** можно изменить параметры файлов трассировки и журнала ошибок. Каталог дампа указан на вкладке **Дополнительно** . На приведенных далее снимках экрана показано, где находится параметр запуска журнала ошибок.

    ![Снимок экрана SQL ErrorLog](./media/performance-guidelines-best-practices/sql_server_error_log_location.png)

* Настройте резервное копирование и расположение файлов базы данных по умолчанию. Следуйте рекомендациям в этой статье и внесите изменения в окне свойств сервера. Инструкции см. в статье [Просмотр или изменение расположения по умолчанию для файлов данных и журнала (среда SQL Server Management Studio)](/sql/database-engine/configure-windows/view-or-change-the-default-locations-for-data-and-log-files). На следующем снимке экрана показано, где нужно внести необходимые изменения.

    ![Файлы журнала данных SQL и резервных копий](./media/performance-guidelines-best-practices/sql_server_default_data_log_backup_locations.png)
* Включение блокировки страниц для сокращения числа операций ввода-вывода, а также операций разбиения по страницам. Дополнительные сведения см. в статье [Включение параметра «Блокировка страниц в памяти» (Windows)](/sql/database-engine/configure-windows/enable-the-lock-pages-in-memory-option-windows).

* Если вы используете SQL Server 2012, установите накопительный пакет обновления 10 для пакета обновления 1. Это обновление содержит исправление для низкой производительности ввода-вывода при выполнении оператора выборки во временную таблицу в SQL Server 2012. Дополнительные сведения см. в этой [статье базы знаний](https://support.microsoft.com/kb/2958012).

* Рекомендуется сжимать файлы данных при их передаче в среду Azure и из нее.

## <a name="feature-specific-guidance"></a>Обзор конкретных функций

Для некоторых развертываний получить дополнительные преимущества, используя более сложные методики настройки. В следующем списке перечислены некоторые функции SQL Server, которые могут помочь добиться лучшей производительности:

### <a name="back-up-to-azure-storage"></a>Резервное копирование в службу хранилища Azure
При выполнении резервного копирования для SQL Server, выполняющихся на виртуальных машинах Azure, можно использовать [SQL Server резервное копирование на URL-адрес](/sql/relational-databases/backup-restore/sql-server-backup-to-url). Эта функция доступна, начиная с накопительного пакета обновления 2 для пакета обновления 1 SQL Server 2012, и рекомендуется к применению при архивации на подключенные диски данных. При резервном копировании и восстановлении в хранилище Azure или из него следуйте рекомендациям, приведенным в [статье SQL Server Backup to URL, рекомендации и устранение неполадок и восстановление из резервных копий, хранящихся в службе хранилища Azure](/sql/relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting). Вы также можете автоматизировать эти резервные копии, используя [автоматическую архивацию для SQL Server на виртуальных машинах Azure](../../../azure-sql/virtual-machines/windows/automated-backup-sql-2014.md).

В выпусках, предшествующих SQL Server 2012, можно использовать [инструмент архивации SQL Server в Azure](https://www.microsoft.com/download/details.aspx?id=40740). Это средство может помочь повысить пропускную способность при архивации благодаря использованию нескольких чередующихся целей архивации.

### <a name="sql-server-data-files-in-azure"></a>Файлы данных SQL Server в Azure

эта новая функция, [Файлы данных SQL Server в Microsoft Azure](/sql/relational-databases/databases/sql-server-data-files-in-microsoft-azure), доступна, начиная с SQL Server 2014. Выполнение SQL Server с файлами данных в Azure демонстрирует уровень производительности, сравнимый с использованием дисков данных Azure.

### <a name="failover-cluster-instance-and-storage-spaces"></a>Экземпляр отказоустойчивого кластера и дисковые пространства

Если при добавлении узлов в кластер на странице **подтверждения** используются дисковые пространства, снимите флажок **Добавить все подходящие хранилища в кластер**. 

![Снятие флажка для допустимого хранилища](./media/performance-guidelines-best-practices/uncheck-eligible-cluster-storage.png)

Если вы используете дисковые пространства и не сняли флажок **Добавление всех допустимых хранилищ в кластер**, то Windows отключит виртуальные диски во время процесса кластеризации. Как следствие, они не отобразятся в диспетчере дисков или Explorer, пока дисковые пространства не будут удалены из кластера и повторно подключены с помощью PowerShell. Дисковые пространства группируют несколько дисков в пулы носителей. Дополнительные сведения см. в статье [Обзор дисковых пространств](/windows-server/storage/storage-spaces/overview).

## <a name="multiple-instances"></a>Несколько экземпляров 

При развертывании нескольких экземпляров SQL Server на одной виртуальной машине учитывайте следующие рекомендации. 

- Задайте параметр max server memory для каждого экземпляра SQL Server, чтобы убедиться, что для операционной системы оставлена память. Не забудьте обновить ограничения памяти для экземпляров SQL Server, если изменить объем памяти, выделенной виртуальной машине. 
- Наличие отдельных LUN для данных, журналов и TempDB, так как все они имеют разные шаблоны рабочей нагрузки и не должны затронуть друг друга. 
- Тщательно протестируйте среду в рабочих нагрузках, находящихся в рабочем окружении, чтобы убедиться, что она может управлять пиковой нагрузкой в рамках соглашения об уровне обслуживания приложения 

Признаки перегруженных систем могут включать, но не ограничиваются, нехватка рабочих потоков, время ожидания отклика и/или зависание системной памяти диспетчера. 



## <a name="collect-performance-baseline"></a>Получение базовых показателей производительности

Для более удобного подхода Соберите счетчики производительности с помощью PerfMon/LogMan и запишите SQL Server статистику ожидания, чтобы лучше понять общие проблемы и потенциальные узкие места исходной среды. 

Начните с сбора данных о ЦП, памяти, операциях [ввода-вывода](../../../virtual-machines/premium-storage-performance.md#iops), [пропускной способности](../../../virtual-machines/premium-storage-performance.md#throughput)и [задержке](../../../virtual-machines/premium-storage-performance.md#latency) исходной рабочей нагрузки в пиковое время после [контрольного списка производительности приложения](../../../virtual-machines/premium-storage-performance.md#application-performance-requirements-checklist). 

Сбор данных в часы пиковой загрузки, например рабочие нагрузки в течение обычного рабочего дня, а также другие процессы высокой нагрузки, такие как обработка на конце дня и рабочие нагрузки ETL на выходные. Рассмотрите возможность масштабирования ресурсов для нетипично интенсивных рабочих нагрузок, таких как обработка в конце квартала, а затем масштабирование выполняется после завершения рабочей нагрузки. 

Используйте анализ производительности, чтобы выбрать [Размер виртуальной машины](../../../virtual-machines/sizes-memory.md) , который может масштабироваться в требованиях к производительности рабочей нагрузки.


### <a name="iops-and-throughput"></a>Операции ввода-вывода в секунду

SQL Server производительность в значительной степени зависит от подсистемы ввода-вывода. Если ваша база данных не умещается в физическую память, SQL Server постоянно переносит страницы базы данных в буферный пул и из него. Файлы данных для SQL Server должны обрабатываться по-разному. Доступ к файлам журнала выполняется последовательно, за исключением случаев, когда требуется откатить транзакцию, где файлы данных, включая TempDB, обращаются к ним случайным образом. При наличии медленных подсистем ввода-вывода пользователи могут столкнуться с проблемами производительности, например с медленным временем отклика и задачами, которые не были завершены из-за истечения времени ожидания. 

Виртуальные машины Azure Marketplace имеют файлы журналов на физическом диске, отдельном от файлов данных по умолчанию. Файлы данных TempDB и их размер соответствуют рекомендациям и предназначены для эфемерной D:/ диск.. 

Следующие счетчики системного монитора позволяют проверить пропускную способность ввода-вывода, необходимую для SQL Server. 
* **Операций чтения \логикалдиск\диск/с** (операций чтения и записи в секунду)
* **Операций записи \логикалдиск\диск/с** (операций чтения и записи в секунду) 
* **\Логикалдиск\диск байт/с** (требования к пропускной способности для файлов данных, журналов и tempdb)

Используя операции ввода-вывода и требования к пропускной способности на пиковых уровнях, оцените размеры виртуальных машин, которые соответствуют емкости измерений. 

Если для рабочей нагрузки требуется 20 КБ операций ввода-вывода в секунду и 10 000 операций ввода-вывода, можно выбрать E16s_v3 (до 32 КБ кэшированных и 25600 некэшированных операций ввода-вывода) или M16_s (с двумя дисками P30, которые были помещены с помощью дисковых пространств до 20 КБ). 

Убедитесь, что вы понимаете требования к пропускной способности и операциям ввода-вывода для рабочей нагрузки, так как виртуальные машины имеют разные ограничения шкалы для операций ввода-вывода

### <a name="memory"></a>Память

Следите за внешней памятью, используемой операционной системой, а также памятью, используемой внутренне SQL Server. Определение нажима для любого из этих компонентов поможет установить размер виртуальных машин и определить возможности для настройки. 

Следующие счетчики системного монитора могут помочь проверить работоспособность памяти SQL Server виртуальной машины. 
* [\Память\Доступный объем в МБ](/azure/monitoring/infrastructure-health/vmhealth-windows/winserver-memory-availmbytes)
* [\SQLServer: память Манажер\таржет Server Memory (КБ)](/sql/relational-databases/performance-monitor/sql-server-buffer-manager-object)
* [\SQLServer: память Манажер\тотал Server Memory (КБ)](/sql/relational-databases/performance-monitor/sql-server-buffer-manager-object)
* [\SQLServer: операций записи Манажер\лази буфера/с](/sql/relational-databases/performance-monitor/sql-server-buffer-manager-object)
* [\SQLServer: ожидаемый срок жизни буфера buffer](/sql/relational-databases/performance-monitor/sql-server-buffer-manager-object)

### <a name="compute--processing"></a>Вычисление и обработка

Управление расчетами в Azure осуществляется иначе, чем в локальной среде. Локальные серверы создаются в течение последних нескольких лет без обновления из-за затрат на управление и стоимости приобретения нового оборудования. Виртуализация позволяет устранить некоторые из этих проблем, но приложения оптимизируются, чтобы использовать наибольшее преимущество базового оборудования. Это означает, что любое значительное изменение потребления ресурсов требует перераспределения всей физической среды. 

Это не является сложной проблемой в Azure, которая позволяет легко достичь новой виртуальной машины на другом ряде оборудования и даже в другом регионе. 

В Azure вы хотите использовать как можно больше ресурсов виртуальных машин, поэтому виртуальные машины Azure должны быть настроены таким образом, чтобы среднее значение ЦП максимально велико, без влияния на рабочую нагрузку. 

Следующие счетчики системного монитора могут помочь проверить работоспособность вычислений SQL Server виртуальной машины.
* **\ Процессор Information (_Total) \% время процессора**
* **Процессорное время \Process (sqlservr) \%**

> [!NOTE] 
> В идеале рекомендуется использовать 80% вычислений с пиковыми нагрузками выше 90%, но не достижением 100% за любой длительный период времени. По сути, вам нужно только подготавливать необходимые приложения, а затем планировать масштабирование в соответствии с потребностями бизнеса. 

## <a name="next-steps"></a>Дальнейшие действия

Рекомендации по обеспечению безопасности см. [в статье вопросы безопасности SQL Server на виртуальных машинах Azure](security-considerations-best-practices.md).

Ознакомьтесь с другими статьями, посвященными виртуальным машинам SQL Server, используя руководство с [обзором SQL Server на виртуальных машинах с Windows](sql-server-on-azure-vm-iaas-what-is-overview.md). Если у вас есть вопросы по виртуальным машинам SQL Server, см. раздел [часто задаваемых вопросов](frequently-asked-questions-faq.md).
