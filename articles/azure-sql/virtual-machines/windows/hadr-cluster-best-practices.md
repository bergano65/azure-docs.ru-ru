---
title: Рекомендации по конфигурации кластера
description: Сведения о поддерживаемых конфигурациях кластера при настройке высокого уровня доступности и аварийного восстановления для SQL Server на виртуальных машинах Azure, таких как поддерживаемые кворумы или параметры маршрутизации подключений.
services: virtual-machines
documentationCenter: na
author: MashaMSFT
editor: monicar
tags: azure-service-management
ms.service: virtual-machines-sql
ms.topic: conceptual
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 06/02/2020
ms.author: mathoma
ms.openlocfilehash: 1a2c4364337083be005c550a8859079cd3bb1218
ms.sourcegitcommit: 419c8c8061c0ff6dc12c66ad6eda1b266d2f40bd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/18/2020
ms.locfileid: "92167956"
---
# <a name="cluster-configuration-best-practices-sql-server-on-azure-vms"></a>Рекомендации по настройке кластера (SQL Server на виртуальных машинах Azure)
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

Кластер используется для обеспечения высокой доступности и аварийного восстановления (HADR) с SQL Server на виртуальных машинах Azure. 

В этой статье приведены рекомендации по конфигурации кластера для [экземпляров отказоустойчивого кластера (FCI)](failover-cluster-instance-overview.md) и [групп доступности](availability-group-overview.md) при их использовании с SQL Server на виртуальных машинах Azure. 


## <a name="networking"></a>Сеть

Используйте одну сетевую карту на сервер (узел кластера) и одну подсеть. Сеть Azure имеет физическую избыточность, что делает дополнительные сетевые карты и подсети ненужными в гостевом кластере виртуальной машины Azure. Отчет о проверке кластера выдаст предупреждение о том, что узлы доступны только в одной сети. Это предупреждение можно игнорировать в гостевых отказоустойчивых кластерах виртуальных машин Azure.

## <a name="quorum"></a>Кворум

Несмотря на то, что кластер с двумя узлами будет работать без [ресурса кворума](/windows-server/storage/storage-spaces/understand-quorum), клиентам необходимо использовать ресурс кворума для поддержки рабочей среды. При проверке кластера не будет передаваться ни один кластер без ресурса кворума. 

Технически кластер из трех узлов может потерять вероятность потери одного узла (не более двух узлов) без ресурса кворума. Но после отключения кластера от двух узлов существует риск того, что кластерные ресурсы будут переведены в автономный режим в случае потери узла или сбоя связи, чтобы предотвратить сценарий разбиения.

Настройка ресурса кворума позволит кластеру продолжить работу в сети только с одним узлом в режиме в сети.

В следующей таблице перечислены параметры кворума, доступные в заказе, рекомендуемом для использования с виртуальной машиной Azure. предпочтительнее использовать диск-свидетель. 


||[Диск-свидетель](/windows-server/failover-clustering/manage-cluster-quorum#configure-the-cluster-quorum)  |[Облако-свидетель](/windows-server/failover-clustering/deploy-cloud-witness)  |[Файловый ресурс-свидетель](/windows-server/failover-clustering/manage-cluster-quorum#configure-the-cluster-quorum)  |
|---------|---------|---------|---------|
|**Поддерживаемая ОС**| Все |Windows Server 2016+| Все|


### <a name="disk-witness"></a>Диск-свидетель

Диск-свидетель — это небольшой кластерный диск в группе хранения, доступной для кластера. Этот диск является высокодоступным и может выполнять отработку отказа между узлами. Он содержит копию базы данных кластера с размером по умолчанию, который обычно меньше 1 ГБ. Диск-свидетель является предпочтительным вариантом кворума для любого кластера, использующего общие диски Azure (или любое решение общего диска, такое как общая SCSI, iSCSI или оптоволоконный канал SAN).  Кластеризованный общий том нельзя использовать в качестве диска-свидетеля.

Настройте общий диск Azure в качестве диска-свидетеля. 

Чтобы приступить к работе, см. раздел [Настройка диска-свидетеля](/windows-server/failover-clustering/manage-cluster-quorum#configure-the-cluster-quorum).


**Поддерживаемая ОС:** All   


### <a name="cloud-witness"></a>Облако-свидетель

Облачный следящий сервер — это тип следящего сервера кворума отказоустойчивого кластера, который использует Microsoft Azure для передачи голоса по кворуму кластера. Размер по умолчанию составляет около 1 МБ и содержит только метку времени. Облако-свидетель идеально подходит для развертываний на нескольких сайтах, в нескольких зонах и в нескольких регионах.

Чтобы приступить к работе, см. раздел [Настройка облачного следящего сервера](/windows-server/failover-clustering/deploy-cloud-witness#CloudWitnessSetUp).


**Поддерживаемая ОС:** Windows Server 2016 и более поздних версий.   


### <a name="file-share-witness"></a>Файловый ресурс-свидетель

Файловый ресурс-свидетель — это общая папка SMB, которая обычно настраивается на файловом сервере под Windows Server. Он хранит сведения о кластеризации в файле следящего сервера. log, но не сохраняет копию базы данных кластера. В Azure можно настроить [файловый ресурс Azure](../../../storage/files/storage-how-to-create-file-share.md) для использования в качестве файлового ресурса-свидетеля или использовать общую папку на отдельной виртуальной машине.

Если вы собираетесь использовать файловый ресурс Azure, его можно подключить с помощью того же процесса, который используется для [подключения общей папки Premium](failover-cluster-instance-premium-file-share-manually-configure.md#mount-premium-file-share). 

Чтобы приступить к работе, см. раздел [Настройка файлового ресурса-свидетеля](/windows-server/failover-clustering/manage-cluster-quorum#configure-the-cluster-quorum).


**Поддерживаемая ОС:** Windows Server 2012 и более поздних версий   

## <a name="connectivity"></a>Соединение

В традиционной локальной сетевой среде SQL Server экземпляр отказоустойчивого кластера является единственным экземпляром SQL Server, работающим на одном компьютере. Так как экземпляр отказоустойчивого кластера отключается от узла к узлу, имя виртуальной сети (VNN) для экземпляра предоставляет единую точку подключения и позволяет приложениям подключаться к экземпляру SQL Server, не зная, какой узел в данный момент активен. Когда происходит отработка отказа, имя виртуальной сети регистрируется на новом активном узле после его запуска. Этот процесс является прозрачным для клиента или приложения, которое подключается к SQL Server, что сокращает время простоя, которое клиент или приложение выдает в случае сбоя. Аналогичным образом, прослушиватель группы доступности использует VNN для маршрутизации трафика к соответствующей реплике. 

Используйте VNN с Azure Load Balancer или именем распределенной сети (DNN), чтобы направить трафик в VNN экземпляра отказоустойчивого кластера с SQL Server на виртуальных машинах Azure или заменить существующий прослушиватель VNN в группе доступности. 


В следующей таблице сравниваются Поддерживаемые подключения HADR. 

| |**Имя виртуальной сети (VNN)**  |**Имя распределенной сети (DNN)**  |
|---------|---------|---------|
|**Минимальная версия ОС**| All | Windows Server 2016 |
|**Минимальная версия SQL Server** |All |SQL Server 2019 CU2 (для FCI)<br/> SQL Server 2019 CU8 (для группы доступности)|
|**Поддерживаемое решение HADR** | Экземпляр отказоустойчивого кластера <br/> группа доступности | Экземпляр отказоустойчивого кластера <br/> группа доступности|


### <a name="virtual-network-name-vnn"></a>Имя виртуальной сети (VNN)

Так как виртуальная IP-точка доступа работает иначе в Azure, необходимо настроить [Azure Load Balancer](../../../load-balancer/index.yml) для маршрутизации трафика по IP-адресу узлов FCI или прослушивателя группы доступности. В виртуальных машинах Azure подсистема балансировки нагрузки содержит IP-адрес VNN, от которых полагаются кластерные ресурсы SQL Server. Балансировщик нагрузки распределяет входящие потоки, поступающие на внешний интерфейс, а затем направляет трафик в экземпляры, определенные внутренним пулом. Поток трафика настраивается с помощью правил балансировки нагрузки и проверок работоспособности. В SQL Server FCI экземпляры пула серверной части — это виртуальные машины Azure под управлением SQL Server. 

При использовании балансировщика нагрузки существует небольшая задержка отработки отказа, поскольку проверка работоспособности по умолчанию выполняет проверки активности каждые 10 секунд. 

Чтобы приступить к работе, Узнайте, как настроить Azure Load Balancer для [экземпляра отказоустойчивого кластера](failover-cluster-instance-vnn-azure-load-balancer-configure.md) или [группы доступности](availability-group-vnn-azure-load-balancer-configure.md) .

**Поддерживаемая ОС:** All   
**Поддерживаемая версия SQL:** All   
**Поддерживаемое решение HADR**: экземпляр отказоустойчивого кластера и группа доступности   


### <a name="distributed-network-name-dnn"></a>Имя распределенной сети (DNN)

Имя распределенной сети — это новая функция Azure для SQL Server 2019. DNN предоставляет альтернативный способ для SQL Server клиентов подключаться к экземпляру отказоустойчивого кластера SQL Server или к группе доступности без использования балансировщика нагрузки. 

При создании ресурса DNN кластер привязывает DNS-имя с IP адресами всех узлов в кластере. Клиент SQL попытается подключиться к каждому IP-адресу в этом списке, чтобы найти ресурс для подключения.  Вы можете ускорить этот процесс, указав `MultiSubnetFailover=True` в строке подключения. Этот параметр указывает поставщику, что необходимо параллельно пытаться использовать все IP-адреса, чтобы клиент мог мгновенно подключиться к FCI или прослушивателю. 

По возможности рекомендуется использовать имя распределенной сети в подсистеме балансировки нагрузки, поскольку: 
- Комплексное решение является более надежным, так как вам больше не нужно поддерживать ресурс балансировщика нагрузки. 
- Устранение проверок балансировщика нагрузки уменьшает длительность отработки отказа. 
- DNN упрощает подготовку и управление экземпляром отказоустойчивого кластера или прослушивателем группы доступности с SQL Server на виртуальных машинах Azure. 

Большинство функций SQL Server прозрачно взаимодействуют с FCI и группами доступности при использовании DNN, но некоторые функции могут требовать особого внимания. Дополнительные сведения см. в статьях [взаимодействие FCI и DNN](failover-cluster-instance-dnn-interoperability.md) и группа [доступности и DNN взаимодействие](availability-group-dnn-interoperability.md) . 

Чтобы приступить к работе, научитесь настраивать ресурс имени распределенной сети для [экземпляра отказоустойчивого кластера](failover-cluster-instance-distributed-network-name-dnn-configure.md) или [группы доступности](availability-group-distributed-network-name-dnn-listener-configure.md) .

**Поддерживаемая ОС:** Windows Server 2016 и более поздних версий.   
**Поддерживаемая версия SQL**: SQL Server 2019 CU2 (FCI) и SQL Server 2019 CU8 (AG)   
**Поддерживаемое решение HADR**: экземпляр отказоустойчивого кластера и группа доступности   


## <a name="limitations"></a>Ограничения

При работе с FCI или группами доступности и SQL Server на виртуальных машинах Azure учитывайте следующие ограничения. 

### <a name="msdtc"></a>MSDTC 

Виртуальные машины Azure поддерживают координатор распределенных транзакций (Майкрософт) в Windows Server 2019 с хранилищем на общих томах кластера (CSV) и с [Azure Load Balancer ценовой категории "Стандартный"](../../../load-balancer/load-balancer-standard-overview.md) или на виртуальных машинах SQL Server, использующих общие диски Azure. 

Координатор распределенных транзакций (Майкрософт) не поддерживается на Виртуальных машинах Azure в Windows Server 2016 и более ранних версий с общими томами кластера по следующим причинам:

- Кластерный ресурс MSDTC нельзя настроить для использования общего хранилища. В Windows Server 2016, если вы создаете ресурс MSDTC, не будет отображаться доступное общее хранилище, даже если оно существует. Эта проблема устранена в Windows Server 2019.
- Load Balancer ценовой категории "Стандартный" не обрабатывает порты RPC.


## <a name="next-steps"></a>Дальнейшие действия

Определив соответствующие рекомендации для решения, начните с [подготовки SQL Server виртуальной машины для FCI](failover-cluster-instance-prepare-vm.md) или создав свою группу доступности с помощью [портал Azure](availability-group-azure-portal-configure.md), [Azure CLI, PowerShell](availability-group-az-cli-configure.md)или шаблонов быстрого запуска [Azure](availability-group-quickstart-template-configure.md). 

