---
title: Взаимодействие функций с SQL Server FCI & DNN
description: 'Дополнительные сведения о дополнительных вопросах при работе с определенными SQL Serverными функциями и ресурсом распределенного сетевого имени (DNN) с экземпляром отказоустойчивого кластера на SQL Server на виртуальных машинах Azure. '
services: virtual-machines
documentationCenter: na
author: MashaMSFT
editor: monicar
tags: azure-service-management
ms.service: virtual-machines-sql
ms.topic: how-to
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 06/02/2020
ms.author: mathoma
ms.openlocfilehash: ca782e9949f990857db408919cac342d7f712d2b
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91272622"
---
# <a name="feature-interoperability-with-sql-server-fci--dnn"></a>Взаимодействие функций с SQL Server FCI & DNN
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

Существуют некоторые SQL Server функции, использующие жестко запрограммированное имя виртуальной сети (VNN). Поэтому при использовании ресурса имени распределенной сети (DNN) с экземпляром отказоустойчивого кластера и SQL Server на виртуальных машинах Azure необходимо учитывать некоторые дополнительные соображения. 

В этой статье содержатся сведения о настройке сетевого псевдонима при использовании ресурса DNN, а также о том, какие компоненты SQL Server требуются для дополнительного рассмотрения.

## <a name="create-network-alias-fci"></a>Создать псевдоним сети (FCI)

Некоторые серверные компоненты зависят от жестко запрограммированного значения VNN, и для правильной работы требуется сетевой псевдоним, который сопоставляет VNN с DNS-именем DNN. Выполните действия, описанные в разделе [Создание псевдонима сервера](/sql/database-engine/configure-windows/create-or-delete-a-server-alias-for-use-by-a-client) , чтобы создать псевдоним, который сопоставляет VNN с DNS-именем DNN. 

Для экземпляра по умолчанию можно напрямую сопоставлять VNN с DNS-именем DNN, таким как VNN = DNN DNS Name.
Например, если VNN имеет имя `FCI1` , то имя экземпляра — `MSSQLSERVER` , а DNN — `FCI1DNN` (клиенты ранее подключаются к `FCI` , а затем — к `FCI1DNN` ). Сопоставьте VNN `FCI1` с DNN `FCI1DNN` . 

Для именованного экземпляра сопоставление псевдонимов сети должно выполняться для полного экземпляра, так что `VNN\Instance`  =  `DNN\Instance` . Например, если VNN имеет имя `FCI1` , то имя экземпляра — `instA` , а DNN — `FCI1DNN` (клиенты ранее подключаются к `FCI1\instA` , а затем — к `FCI1DNN\instaA` ). Сопоставьте VNN `FCI1\instaA` с DNN `FCI1DNN\instaA` . 



## <a name="client-drivers"></a>Клиентские драйверы

Для драйверов ODBC, OLEDB, ADO.NET, JDBC, PHP и Node.js пользователям необходимо явным образом указать DNS-имя DNN в качестве имени сервера в строке подключения. Чтобы обеспечить быстрое подключение при отработке отказа, добавьте `MultiSubnetFailover=True` в строку подключения, если клиент SQL его поддерживает. 

## <a name="tools"></a>Инструменты

Пользователям [SQL Server Management Studio](/sql/ssms/sql-server-management-studio-ssms), [sqlcmd](/sql/tools/sqlcmd-utility), [Azure Data Studio](/sql/azure-data-studio/what-is)и [SQL Server Data Tools](/sql/ssdt/sql-server-data-tools) необходимо явным образом указать DNS-имя DNN в качестве имени сервера в строке подключения. 

## <a name="availability-groups-and-fci"></a>Группы доступности и FCI

Группу доступности Always On можно настроить с помощью экземпляра отказоустойчивого кластера в качестве одной из реплик. В этой конфигурации URL-адрес конечной точки зеркального отображения для реплики FCI должен использовать DNN FCI. Аналогично, если FCI используется в качестве реплики только для чтения, маршрутизация только для чтения в реплике FCI должна использовать FCI DNN. 

Для конечной точки зеркального отображения используется формат: `ENDPOINT_URL = 'TCP://<DNN DNS name>:<mirroring endpoint port>'` . 

Например, если DNS-имя DNN — `dnnlsnr` , а `5022` — Порт конечной точки зеркального отображения FCI, фрагмент кода TRANSACT-SQL (T-SQL) для создания URL-адреса конечной точки выглядит следующим образом: 

```sql
ENDPOINT_URL = 'TCP://dnnlsnr:5022'
```

Аналогично, формат URL-адреса маршрутизации только для чтения: `TCP://<DNN DNS name>:<SQL Server instance port>` . 

Например, если DNS-имя DNN — `dnnlsnr` , а `1444` — порт, используемый целевым объектом, предназначенным только для чтения, SQL Server FCI, фрагмент кода T-SQL для создания URL-адреса маршрутизации только для чтения выглядит следующим образом: 

```sql
READ_ONLY_ROUTING_URL = 'TCP://dnnlsnr:1444'
```

Вы можете опустить порт в URL-адресе, если это порт 1433 по умолчанию. Для именованного экземпляра настройте статический порт для именованного экземпляра и укажите его в URL-адресе маршрутизации только для чтения.  

## <a name="replication"></a>Репликация

Репликация включает три компонента: издатель, распространитель, подписчик. Любой из этих компонентов может быть экземпляром отказоустойчивого кластера. Поскольку FCI VNN интенсивно используется в конфигурации репликации, как явно, так и неявно, для работы репликации может потребоваться сетевой псевдоним, который сопоставляет VNN с DNN. 

Используйте имя VNN в качестве имени FCI в репликации, но *перед настройкой репликации*Создайте псевдоним сети в следующих удаленных ситуациях:

| **Компонент репликации (FCI с DNN)** | **Удаленный компонент** | **Сетевая схема псевдонима** | **Сервер с картой сети**| 
|---------|---------|---------|-------- | 
|Издатель | Распространитель | Издатель VNN к издателю DNN| Распространитель| 
|Распространитель|Подписчик |Распространитель VNN к распространителю DNN| Подписчик | 
|Распространитель|Издатель | Распространитель VNN к распространителю DNN | Издатель| 
|Подписчик| Распространитель| Подписчик VNN подписчику DNN | Распространитель| 

Например, предположим, что у вас есть издатель, настроенный как FCI с помощью DNN в топологии репликации, а распространитель удален. В этом случае создайте сетевой псевдоним на сервере распространителя, чтобы подключить издатель VNN к издателю DNN: 

:::image type="content" source="media/failover-cluster-instance-dnn-interoperability/alias-in-configuration-manager.png" alt-text="Настройте DNS-имя DNN в качестве сетевого псевдонима с помощью диспетчер конфигурации SQL Server." :::

Используйте полное имя экземпляра для именованного экземпляра, как показано на следующем рисунке: 

:::image type="content" source="media/failover-cluster-instance-dnn-interoperability/alias-named-instance-configuration-manager.png" alt-text="Настройте DNS-имя DNN в качестве сетевого псевдонима с помощью диспетчер конфигурации SQL Server." :::

## <a name="database-mirroring"></a>Зеркальное отображение базы данных

Можно настроить зеркальное отображение базы данных с помощью FCI в качестве участника зеркального отображения базы данных. Настройте его с помощью [Transact-SQL (T-SQL)](/sql/database-engine/database-mirroring/example-setting-up-database-mirroring-using-windows-authentication-transact-sql) , а не SQL Server Management Studio графического пользовательского интерфейса. Использование T-SQL обеспечит создание конечной точки зеркального отображения базы данных с помощью DNN вместо VNN. 

Например, если DNS-имя DNN имеет значение `dnnlsnr` , а конечная точка зеркального отображения базы данных — 7022, то следующий фрагмент кода T-SQL настраивает участника зеркального отображения базы данных: 

```sql
ALTER DATABASE AdventureWorks
    SET PARTNER =
    'TCP://dnnlsnr:7022'
GO 
```

Для клиентского доступа свойство " **партнер по обеспечению отработки отказа** " может выполнять отработку отказа зеркального отображения базы данных, но не FCI 

## <a name="msdtc"></a>MSDTC

FCI может участвовать в распределенных транзакциях, которые координируются в Microsoft координатор распределенных транзакций (MSDTC). Хотя кластеризованные и локальные MSDTC поддерживаются с помощью FCI DNN в Azure, подсистема балансировки нагрузки все еще необходима для кластеризованной службы MSDTC. DNN, определенные в FCI, не заменяют требования к Azure Load Balancer для кластеризованного MSDTC в Azure. 

## <a name="filestream"></a>FileStream

Хотя FileStream поддерживается для базы данных в FCI, доступ к FileStream или FileTable с помощью API-интерфейсов файловой системы с DNN не поддерживается. 

## <a name="linked-servers"></a>Связанные серверы

Использование связанного сервера с FCI DNN поддерживается. Либо используйте DNN напрямую для настройки связанного сервера, либо используйте сетевой псевдоним для привязки VNN к DNN. 


Например, чтобы создать связанный сервер с DNN DNS-именем `dnnlsnr` для именованного экземпляра `insta1` , используйте следующую команду TRANSACT-SQL (T-SQL):

```sql
USE [master]   
GO   

EXEC master.dbo.sp_addlinkedserver    
    @server = N'dnnlsnr\inst1',    
    @srvproduct=N'SQL Server' ;   
GO 
```

Кроме того, можно создать связанный сервер, используя имя виртуальной сети (VNN), но необходимо определить сетевой псевдоним, чтобы связать VNN с DNN. 

Например, для имени экземпляра `insta1` , имени VNN `vnnname` и имени DNN `dnnlsnr` используйте следующую команду Transact-SQL (T-SQL), чтобы создать связанный сервер с помощью VNN:

```sql
USE [master]
GO   

EXEC master.dbo.sp_addlinkedserver   
    @server = N'vnnname\inst1',    
    @srvproduct=N'SQL Server' ;   
GO 

```

Затем создайте сетевой псевдоним для сопоставлений `vnnname\insta1` `dnnlsnr\insta1` . 



## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы


- Какая версия SQL Server предоставляет поддержку DNN? 

   SQL Server 2019 CU2 и более поздних версий.

- Каково ожидаемое время отработки отказа при использовании DNN?

   Для DNN время отработки отказа будет просто FCI временем отработки отказа, без времени добавления (например, время проверки при использовании Azure Load Balancer).

- Есть ли требования к версии для клиентов SQL, поддерживающих DNN с OLEDB и ODBC?

   Мы рекомендуем использовать `MultiSubnetFailover=True` поддержку строки подключения для DNN. Он доступен начиная с SQL Server 2012 (11. x).

- Требуются ли SQL Server изменения конфигурации, необходимые для использования DNN? 

   SQL Server не требует изменения конфигурации для использования DNN, но некоторые функции SQL Server могут потребовать больше внимания. 

- Поддерживает ли DNN кластеры с несколькими подсетями?

   Да. Кластер привязывает DNN в DNS с физическими IP-адресами всех узлов в кластере независимо от подсети. Клиент SQL пытается выполнить все IP-адреса DNS-имени независимо от подсети. 



## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в разделе: 

- [технологии кластера под управлением Windows](/windows-server/failover-clustering/failover-clustering-overview);   
- [Экземпляры отказоустойчивого кластера SQL Server](/sql/sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server)

