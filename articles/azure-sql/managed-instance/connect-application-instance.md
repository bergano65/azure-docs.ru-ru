---
title: Подключение приложения к SQL Управляемый экземпляр
titleSuffix: Azure SQL Managed Instance
description: В этой статье описано, как подключить приложение к Azure SQL Управляемый экземпляр.
services: sql-database
ms.service: sql-managed-instance
ms.subservice: operations
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: conceptual
author: srdan-bozovic-msft
ms.author: srbozovi
ms.reviewer: sstein, bonova, carlrab, vanto
ms.date: 11/09/2018
ms.openlocfilehash: a5d002532adb043fa5196231964d5b6e2c81417c
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "84706381"
---
# <a name="connect-your-application-to-azure-sql-managed-instance"></a>Connect your application to Azure SQL Managed Instance (Подключение приложения к управляемому экземпляру SQL Azure)
[!INCLUDE[appliesto-sqlmi](../includes/appliesto-sqlmi.md)]

Сейчас вам доступно много вариантов для размещения приложений.

Вы можете разместить приложение в облаке с помощью службы приложений Azure или некоторых интегрированных в Azure виртуальных сетей параметров, таких как Среда службы приложений Azure, виртуальные машины Azure и масштабируемые наборы виртуальных машин. Также можно применить гибридную схему работы с облаком, оставляя приложения в локальной среде.

Независимо от выбранного варианта, вы можете подключить его к Azure SQL Управляемый экземпляр. 

![Высокий уровень доступности](./media/connect-application-instance/application-deployment-topologies.png)

В этой статье описано, как подключить приложение к Управляемому экземпляру SQL Azure в ряде сценариев для различных приложений. 

## <a name="connect-inside-the-same-vnet"></a>Подключение в той же виртуальной сети

Подключение приложения в той же виртуальной сети, что и SQL Управляемый экземпляр, является простейшим сценарием. Виртуальные машины внутри виртуальной сети могут подключаться друг к другу напрямую, даже если они находятся в разных подсетях. Это означает, что все, что необходимо для подключения приложения в Среда службы приложений или виртуальной машине, — это задать соответствующим образом строку подключения.  

## <a name="connect-inside-a-different-vnet"></a>Подключение внутри другой виртуальной сети

Подключение приложения, расположенного в другой виртуальной сети от SQL Управляемый экземпляр, является более сложным, поскольку SQL Управляемый экземпляр имеет частные IP-адреса в собственной виртуальной сети. Для подключения приложению требуется доступ к виртуальной сети, где развернут SQL Управляемый экземпляр. Поэтому необходимо установить соединение между приложением и виртуальной сетью SQL Управляемый экземпляр. Чтобы этот сценарий работал, виртуальные сети не обязательно должны находиться в одной подписке.

Существует два варианта подключения виртуальных сетей.

- [Пиринг VPN Azure](../../virtual-network/virtual-network-peering-overview.md)
- VPN-шлюз между виртуальными сетями ([портал Azure](../../vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal.md), [PowerShell](../../vpn-gateway/vpn-gateway-vnet-vnet-rm-ps.md), [Azure CLI](../../vpn-gateway/vpn-gateway-howto-vnet-vnet-cli.md)).

Пиринг предпочтительнее, так как он использует магистральную сеть Майкрософт, поэтому с точки зрения подключения нет заметных различий в задержке между виртуальными машинами в одноранговой виртуальной сети и в той же виртуальной сети. Пиринг виртуальных сетей ограничен сетями в одном регионе.  

> [!IMPORTANT]
> Сценарий пиринга виртуальной сети для SQL Управляемый экземпляр ограничен сетями в том же регионе из-за [ограничений глобального пиринга виртуальной сети](../../virtual-network/virtual-network-manage-peering.md#requirements-and-constraints). Дополнительные сведения см. в разделе, посвященном [часто задаваемым вопросам о виртуальных сетях Azure](https://docs.microsoft.com/azure/virtual-network/virtual-networks-faq#what-are-the-constraints-related-to-global-vnet-peering-and-load-balancers) . 

## <a name="connect-from-on-premises"></a>Подключение из локальной среды 

Вы также можете подключить локальное приложение к SQL Управляемый экземпляр. Доступ к Управляемый экземпляр SQL можно получить только через частный IP-адрес. Чтобы получить доступ к нему из локальной среды, необходимо установить подключение типа "сеть — сеть" между приложением и виртуальной сетью SQL Управляемый экземпляр.

Существует два способа подключения локальной среды к виртуальной сети Azure.

- VPN-подключение типа "сеть — сеть" ([портал Azure](../../vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal.md), [PowerShell](../../vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell.md), [Azure CLI](../../vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-cli.md))
- Подключение к [Azure ExpressRoute](../../expressroute/expressroute-introduction.md)  

Если локальное подключение к Azure установлено и вы не можете установить подключение к SQL Управляемый экземпляр, проверьте, имеет ли брандмауэр открытое исходящее подключение к порту SQL 1433, а также диапазон портов 11000-11999 для перенаправления.

## <a name="connect-the-developer-box"></a>Подключение к полю разработчика

Можно также подключить поле разработчика к SQL Управляемый экземпляр. Доступ к Управляемый экземпляр SQL можно получить только по частному IP-адресу, поэтому для доступа к нему из окна разработчика необходимо сначала установить соединение между полем разработчика и виртуальной сетью SQL Управляемый экземпляр. Для этого настройте подключение типа "точка — сеть" к виртуальной сети с помощью собственной проверки подлинности на основе сертификата Azure. Дополнительные сведения см. в статье [Настройка подключения типа "точка — сеть" для подключения к Azure SQL управляемый экземпляр с локального компьютера](point-to-site-p2s-configure.md).

## <a name="connect-with-vnet-peering"></a>Подключение с помощью пиринга виртуальной сети

Другой сценарий, реализованный клиентами, заключается в том, что VPN-шлюз устанавливается в отдельную виртуальную сеть и подписку на одном из размещенных Управляемый экземпляр SQL. Затем между двумя виртуальными сетями устанавливается пиринговая связь. На следующей схеме примера архитектуры показано, как это можно реализовать.

![Пиринг между виртуальными сетями](./media/connect-application-instance/vnet-peering.png)

После настройки базовой инфраструктуры необходимо изменить некоторые параметры, чтобы VPN-шлюз мог видеть IP-адреса в виртуальной сети, где размещается SQL Управляемый экземпляр. Чтобы сделать это, внесите следующие изменения в разделе **Параметры пиринга**.

1. В виртуальной сети, в которой размещен VPN-шлюз, перейдите к разделу **пиринга**, перейдите к подключению к виртуальной сети для управляемый экземпляр SQL, а затем выберите **Разрешить транзит шлюза**.
2. В виртуальной сети, в которой размещается SQL Управляемый экземпляр, перейдите в раздел **пиринга**, перейдите к подключению к виртуальной сети VPN-шлюза и щелкните **использовать удаленные шлюзы**.

## <a name="connect-azure-app-service"></a>Подключение службы приложений Azure 

Вы также можете подключить приложение, размещенное в службе приложений Azure. Доступ к Управляемый экземпляр SQL можно получить только по частному IP-адресу, поэтому для доступа к нему из службы приложений Azure необходимо сначала установить подключение между приложением и виртуальной сетью SQL Управляемый экземпляр. См. статью [интеграция приложения с виртуальной сетью Azure](../../app-service/web-sites-integrate-with-vnet.md).  

Сведения об устранении неполадок см. в разделе [Устранение неполадок виртуальных сетей и приложений](../../app-service/web-sites-integrate-with-vnet.md#troubleshooting). Если не удается установить подключение, попробуйте [синхронизировать конфигурацию сети](azure-app-sync-network-configuration.md).

Особый случай подключения службы приложений Azure к SQL Управляемый экземпляр — при интеграции службы приложений Azure с сетью, подключенной к виртуальной сети Управляемый экземпляр SQL. В этом случае следует дополнительно настроить следующее.

- Виртуальная сеть SQL Управляемый экземпляр не должна иметь шлюз  
- Для виртуальной сети SQL Управляемый экземпляр должен быть `Use remote gateways` установлен параметр
- Для одноранговой виртуальной сети должен быть `Allow gateway transit` установлен параметр

Этот вариант сценария показан на схеме ниже.

![Пиринговая связь с интеграцией приложения](./media/connect-application-instance/integrated-app-peering.png)

>[!NOTE]
>Функция интеграции виртуальной сети не интегрирует приложение с виртуальной сетью, имеющей шлюз ExpressRoute. Даже если шлюз ExpressRoute настроен в режиме сосуществования, интеграция с виртуальной сетью не работает. Если вам требуется доступ к ресурсам через подключение ExpressRoute, можно использовать Среда службы приложений, который выполняется в виртуальной сети.

## <a name="troubleshooting-connectivity-issues"></a>Устранение неполадок с подключением

Для устранения проблем с подключением просмотрите следующие сведения:

- Если не удается подключиться к SQL Управляемый экземпляр из виртуальной машины Azure в той же виртуальной сети, но в другой подсети, проверьте, установлен ли в подсети виртуальной машины набор групп безопасности сети, который может блокировать доступ. Кроме того, следует открыть исходящее подключение через порт SQL 1433, а также порты в диапазоне 11000-11999, так как они необходимы для подключения через перенаправление в границах Azure.
- Убедитесь, что для таблицы маршрутов, связанной с виртуальной сетью, **включено** распространение BGP.
- Если используется VPN-подключение типа "точка — сеть", в конфигурации на портале Azure проверьте, отображаются ли числа для **входящего и исходящего трафика**. Ненулевые значения указывают, что Azure направляет трафик в локальную сеть и из нее.

   ![Число передаваемых байт для входящих и исходящих подключений](./media/connect-application-instance/ingress-egress-numbers.png)

- Убедитесь, что клиентский компьютер (на котором работает VPN-клиент) имеет записи маршрутов для всех виртуальных сетей, к которым необходимо получить доступ. Маршруты хранятся в `%AppData%\ Roaming\Microsoft\Network\Connections\Cm\<GUID>\routes.txt`.

   ![route.txt](./media/connect-application-instance/route-txt.png)

   Как показано на этом рисунке, для каждой задействованной виртуальной сети имеется две записи и третья запись для конечной точки VPN, настроенной на портале.

   Другой способ проверить маршруты — с помощью следующей команды. В выходных данных отображаются маршруты к различным подсетям:

   ```cmd
   C:\ >route print -4
   ===========================================================================
   Interface List
   14...54 ee 75 67 6b 39 ......Intel(R) Ethernet Connection (3) I218-LM
   57...........................rndatavnet
   18...94 65 9c 7d e5 ce ......Intel(R) Dual Band Wireless-AC 7265
   1...........................Software Loopback Interface 1
   Adapter===========================================================================

   IPv4 Route Table
   ===========================================================================
   Active Routes:
   Network Destination        Netmask          Gateway       Interface  Metric
          0.0.0.0          0.0.0.0       10.83.72.1     10.83.74.112     35
         10.0.0.0    255.255.255.0         On-link       172.26.34.2     43
         10.4.0.0    255.255.255.0         On-link       172.26.34.2     43
   ===========================================================================
   Persistent Routes:
   None
   ```

- Если вы используете пиринг виртуальных сетей, убедитесь, что выполнены инструкции по настройке [Разрешить транзит шлюза и использовать удаленные шлюзы](#connect-from-on-premises).

- Если вы используете пиринг виртуальных сетей для подключения размещенного приложения службы приложений Azure, а в виртуальной сети SQL Управляемый экземпляр есть диапазон общедоступных IP-адресов, убедитесь, что параметры размещенного приложения позволяют маршрутизировать исходящий трафик в общедоступные IP-сети. Следуйте инструкциям в статье [Интеграция с региональными виртуальными сетями](../../app-service/web-sites-integrate-with-vnet.md#regional-vnet-integration).

## <a name="required-versions-of-drivers-and-tools"></a>Необходимые версии драйверов и средств

Если требуется подключиться к SQL Управляемый экземпляр, рекомендуется использовать следующие минимальные версии средств и драйверов.

| Драйвер или средство | Версия |
| --- | --- |
|.NET Framework | 4.6.1 (или .NET Core) |
|Драйвер ODBC| версия 17 |
|Драйвер PHP| 5.2.0 |
|Драйвер JDBC| 6.4.0 |
|Драйвер Node.js| 2.1.1 |
|Драйвер OLEDB| 18.0.2.0 |
|SSMS| 18,0 или [более поздней версии](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms) |
|[ОБЪЕКТАХ](https://docs.microsoft.com/sql/relational-databases/server-management-objects-smo/sql-server-management-objects-smo-programming-guide) | [150](https://www.nuget.org/packages/Microsoft.SqlServer.SqlManagementObjects) или более поздней версии |

## <a name="next-steps"></a>Дальнейшие шаги

- Дополнительные сведения о SQL Управляемый экземпляр см. в статье [что такое sql управляемый экземпляр?](sql-managed-instance-paas-overview.md).
- Руководство, в котором показано, как создать управляемый экземпляр, см. в разделе [Создание управляемого экземпляра](instance-create-quickstart.md).
