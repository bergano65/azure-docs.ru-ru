---
title: Аудит управляемого экземпляра SQL
description: Узнайте, как приступить к работе с аудитом Управляемый экземпляр Azure SQL с помощью T-SQL
services: sql-database
ms.service: sql-managed-instance
ms.subservice: security
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: how-to
f1_keywords:
- mi.azure.sqlaudit.general.f1
author: DavidTrigano
ms.author: datrigan
ms.reviewer: vanto
ms.date: 05/26/2020
ms.openlocfilehash: d8a6ead23e080b5e1e17403873e2dbaedc0ce177
ms.sourcegitcommit: 4bebbf664e69361f13cfe83020b2e87ed4dc8fa2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/01/2020
ms.locfileid: "91620364"
---
# <a name="get-started-with-azure-sql-managed-instance-auditing"></a>Приступая к работе с аудитом Управляемый экземпляр Azure SQL
[!INCLUDE[appliesto-sqlmi](../includes/appliesto-sqlmi.md)]

Аудит [управляемый экземпляр Azure SQL](sql-managed-instance-paas-overview.md) отслеживает события базы данных и записывает их в журнал аудита в учетной записи хранения Azure. Аудит также дает следующие возможности.

- Помогает поддерживать соответствие нормативным требованиям, лучше понимать происходящее в базах данных, а также получать аналитические сведения о расхождениях и аномалиях, которые могут указывать на проблемы в бизнесе или потенциальные нарушения безопасности.
- Средства аудита способствуют соблюдению стандартов соответствия, но не гарантируют их выполнение. Дополнительные сведения о программах Azure, поддерживающих соответствие стандартам, см. в [центр управления безопасностью Azure](https://gallery.technet.microsoft.com/Overview-of-Azure-c1be3942), где можно найти самый актуальный список сертификатов соответствия.

## <a name="set-up-auditing-for-your-server-to-azure-storage"></a>Настройка аудита для сервера в службе хранилища Azure

В следующем разделе описывается настройка аудита для управляемого экземпляра.

1. Перейдите на [портал Microsoft Azure](https://portal.azure.com).
2. Создайте **контейнер** службы хранилища Azure для хранения журналов аудита.

   1. Перейдите к учетной записи хранения Azure, в которой вы хотите хранить журналы аудита.

      > [!IMPORTANT]
      > - Используйте учетную запись хранения из того же региона, где размещен управляемый экземпляр, чтобы избежать операций чтения и записи между регионами. 
      > - Если ваша учетная запись хранения находится за виртуальной сетью или брандмауэром, см. раздел [предоставление доступа из виртуальной сети](https://docs.microsoft.com/azure/storage/common/storage-network-security#grant-access-from-a-virtual-network).
      > - Если для периода хранения вместо 0 (неограниченный период хранения) указать любое другое значение, то оно будет применяться только к журналам, записанным после изменения. Журналы, записанные в то время, когда был установлен неограниченный период хранения, сохранятся даже после включения определенного периода хранения.

   1. На странице учетной записи хранения перейдите на вкладку **Обзор** и щелкните **BLOB-объекты**.

      ![Мини-приложение BLOB-объектов Azure](./media/auditing-configure/1_blobs_widget.png)

   1. В верхнем меню щелкните **+ Контейнер**, чтобы создать новый контейнер.

      ![Значок создания контейнера больших двоичных объектов](./media/auditing-configure/2_create_container_button.png)

   1. Укажите **имя**контейнера, задайте для **общего уровня доступа** значение **частный**, а затем нажмите кнопку **ОК**.

      ![Конфигурация создания контейнера больших двоичных объектов](./media/auditing-configure/3_create_container_config.png)

    > [!IMPORTANT]
    > Клиенты, желающие настроить неизменяемое хранилище журналов для событий аудита на уровне сервера или базы данных, должны следовать [инструкциям, предоставленным службой хранилища Azure](https://docs.microsoft.com/azure/storage/blobs/storage-blob-immutability-policies-manage#enabling-allow-protected-append-blobs-writes). (Убедитесь, что выбран параметр **разрешить дополнительные добавления** при настройке неизменяемого хранилища BLOB-объектов.)
  
3. После создания контейнера для журналов аудита существует два способа настроить его в качестве цели для журналов аудита: [с помощью T-SQL](#blobtsql) или [пользовательского интерфейса SQL Server Management Studio (SSMS)](#blobssms):

   - <a id="blobtsql"></a>Настройка хранилища больших двоичных объектов для журналов аудита с помощью T-SQL:

     1. В списке контейнеров щелкните только что созданный контейнер, а затем **Свойства контейнера**.

        ![Кнопка свойств контейнера больших двоичных объектов](./media/auditing-configure/4_container_properties_button.png)

     1. Скопируйте URL-адрес контейнера, щелкнув значок копирования, и сохраните этот URL-адрес (например, в Блокноте) для дальнейшего использования. URL-адрес контейнера должен иметь формат `https://<StorageName>.blob.core.windows.net/<ContainerName>`.

        ![Копирование URL-адреса контейнера больших двоичных объектов](./media/auditing-configure/5_container_copy_name.png)

     1. Создайте **маркер SAS** хранилища Azure, чтобы предоставить учетной записи хранения права доступа для аудита управляемого экземпляра.

        - Перейдите к учетной записи хранения Azure, в которой был создан контейнер на предыдущем шаге.

        - Щелкните **подпись общего доступа** в меню **Параметры хранилища** .

          ![Значок подписанного URL-адреса в меню параметров хранилища.](./media/auditing-configure/6_storage_settings_menu.png)

        - Настройте SAS следующим образом.

          - **Допустимые службы**: большой двоичный объект

          - **Дата начала**: чтобы избежать проблем, связанных с часовым поясом, используйте вчерашний день.

          - **Дата окончания**: выберите дату истечения срока действия МАРКЕРа SAS

            > [!NOTE]
            > Чтобы избежать сбоев аудита, не забудьте возобновить маркер по истечении срока действия.

          - Нажмите кнопку **Создать SAS**.

            ![Конфигурация SAS](./media/auditing-configure/7_sas_configure.png)

        - Маркер SAS появится внизу. Скопируйте маркер, щелкнув значок копирования, и сохраните его (например, в Блокноте) для дальнейшего использования.

          ![Копирование маркера SAS](./media/auditing-configure/8_sas_copy.png)

          > [!IMPORTANT]
          > Удалите символ знака вопроса (?) в начале маркера.

     1. Подключитесь к управляемому экземпляру с помощью SQL Server Management Studio или любого другого поддерживаемого средства.

     1. Выполните следующую инструкцию T-SQL, чтобы **создать новые учетные данные** с помощью URL-адреса контейнера и маркера SAS, созданного на предыдущих шагах.

        ```SQL
        CREATE CREDENTIAL [<container_url>]
        WITH IDENTITY='SHARED ACCESS SIGNATURE',
        SECRET = '<SAS KEY>'
        GO
        ```

     1. Выполните следующую инструкцию T-SQL для создания нового аудита сервера (выберите собственное имя аудита и используйте URL-адрес контейнера, созданный на предыдущих шагах). Если параметр не указан, `RETENTION_DAYS` по умолчанию используется значение 0 (неограниченный срок хранения):

        ```SQL
        CREATE SERVER AUDIT [<your_audit_name>]
        TO URL ( PATH ='<container_url>' , RETENTION_DAYS =  integer )
        GO
        ```

        Продолжайте [Создание спецификации аудита сервера или спецификации аудита базы данных](#createspec).

   - <a id="blobssms"></a>Настройка хранилища BLOB-объектов для журналов аудита с помощью SQL Server Management Studio 18 (Предварительная версия):

     1. Подключитесь к управляемому экземпляру с помощью пользовательского интерфейса SQL Server Management Studio.

     1. Разверните корневое Примечание в обозревателе объектов.

     1. Разверните узел **Безопасность** , щелкните правой кнопкой мыши узел **аудиты** и выберите пункт **создать аудит**:

        ![Развертывание узла аудитов и безопасности](./media/auditing-configure/10_mi_SSMS_new_audit.png)

     1. Убедитесь, что в **пункте назначение аудита** выбран **URL-адрес** , и щелкните **Обзор**:

        ![Просмотр службы хранилища](./media/auditing-configure/11_mi_SSMS_audit_browse.png)

     1. Войдите в учетную запись Azure (необязательно):

        ![Вход в Azure](./media/auditing-configure/12_mi_SSMS_sign_in_to_azure.png)

     1. Выберите подписку, учетную запись хранения и контейнер BLOB-объектов из раскрывающихся списков или создайте собственный контейнер, щелкнув **создать**. После завершения нажмите кнопку **ОК**.

        ![Выберите подписку Azure, учетную запись хранения и контейнер больших двоичных объектов.](./media/auditing-configure/13_mi_SSMS_select_subscription_account_container.png)

     1. В диалоговом окне **Создание аудита** нажмите кнопку **ОК** .

4. <a id="createspec"></a>После настройки контейнера больших двоичных объектов в качестве целевого для журналов аудита создайте и включите спецификацию аудита сервера или спецификацию аудита базы данных, как в случае SQL Server.

   - [Инструкции по созданию спецификации аудита сервера T-SQL](https://docs.microsoft.com/sql/t-sql/statements/create-server-audit-specification-transact-sql)
   - [Инструкции по созданию спецификации аудита базы данных T-SQL](https://docs.microsoft.com/sql/t-sql/statements/create-database-audit-specification-transact-sql)

5. Включите аудит сервера, созданный на шаге 3.

    ```SQL
    ALTER SERVER AUDIT [<your_audit_name>]
    WITH (STATE=ON);
    GO
    ```

Дополнительные сведения см. в следующих статьях:

- [Аудит различий между Управляемый экземпляр Azure SQL и базой данных в SQL Server](#auditing-differences-between-databases-in-azure-sql-managed-instance-and-databases-in-sql-server)
- [CREATE SERVER AUDIT](https://docs.microsoft.com/sql/t-sql/statements/create-server-audit-transact-sql)
- [ALTER SERVER AUDIT](https://docs.microsoft.com/sql/t-sql/statements/alter-server-audit-transact-sql)

## <a name="set-up-auditing-for-your-server-to-event-hubs-or-azure-monitor-logs"></a>Настройка аудита сервера для концентраторов событий или журналов Azure Monitor

Журналы аудита из управляемого экземпляра можно отправить в службы "концентраторы событий Azure" или в журналы Azure Monitor. В этом разделе описывается, как это настроить.

1. Перейдите в [портал Azure](https://portal.azure.com/) управляемому экземпляру.

2. Щелкните **Параметры диагностики**.

3. Щелкните **Включить диагностику**. Если система диагностики уже включена, вместо нее будет отображаться **параметр "Дополнительные параметры диагностики** ".

4. Выберите **SQLSecurityAuditEvents** из списка журналов.

5. Выберите назначение для событий аудита: концентраторы событий, журналы Azure Monitor или и то, и другое. Настройте необходимые параметры (например, рабочую область Log Analytics) для каждой цели.

6. Выберите команду **Сохранить**.

    ![Настройка параметров диагностики](./media/auditing-configure/9_mi_configure_diagnostics.png)

7. Подключитесь к управляемому экземпляру, используя **SQL Server Management Studio (SSMS)** или любой другой поддерживаемый клиент.

8. Выполните следующую инструкцию T-SQL для создания аудита сервера.

    ```SQL
    CREATE SERVER AUDIT [<your_audit_name>] TO EXTERNAL_MONITOR;
    GO
    ```

9. Создайте и включите спецификацию аудита сервера или спецификацию аудита базы данных, как в случае SQL Server.

   - [Руководство по созданию спецификации T-SQL для аудита сервера](https://docs.microsoft.com/sql/t-sql/statements/create-server-audit-specification-transact-sql)
   - [Руководство по созданию спецификации T-SQL для аудита базы данных](https://docs.microsoft.com/sql/t-sql/statements/create-database-audit-specification-transact-sql)

10. Включите аудит сервера, созданный на шаге 8.

    ```SQL
    ALTER SERVER AUDIT [<your_audit_name>]
    WITH (STATE=ON);
    GO
    ```

## <a name="consume-audit-logs"></a>Использование журналов аудита

### <a name="consume-logs-stored-in-azure-storage"></a>Использование журналов аудита, которые хранятся в службе хранилища Azure

Просмотреть журналы аудита больших двоичных объектов можно несколькими способами.

- Системная функция `sys.fn_get_audit_file` (T-SQL) возвращает данные журнала аудита в табличном формате. Дополнительные сведения об использовании этой функции см. в статье [sys.fn_get_audit_file (Transact-SQL)](https://docs.microsoft.com/sql/relational-databases/system-functions/sys-fn-get-audit-file-transact-sql).

- Журналы аудита можно просматривать с помощью таких инструментов, как [обозреватель хранилищ Azure](https://azure.microsoft.com/features/storage-explorer/). В службе хранилища Azure журналы аудита сохраняются в виде коллекции файлов больших двоичных объектов в контейнере, который был определен для хранения журналов аудита. Дополнительные сведения об иерархии папки для хранения, соглашении об именовании и формате журнала см. в [документации по формату журнала аудита больших двоичных объектов](https://go.microsoft.com/fwlink/?linkid=829599).

- Полный список методов использования журнала аудита см. в статье Приступая к [работе с аудитом базы данных SQL Azure](../../azure-sql/database/auditing-overview.md).

### <a name="consume-logs-stored-in-event-hubs"></a>Использование журналов, хранящихся в концентраторах событий

Чтобы использовать данные журналов аудита из концентраторов событий, необходимо настроить поток для использования событий и их записи в целевой объект. Дополнительные сведения см. в статье Что такое Центры событий?.

### <a name="consume-and-analyze-logs-stored-in-azure-monitor-logs"></a>Использование и анализ журналов, хранящихся в журналах Azure Monitor

Если журналы аудита записываются в журналы Azure Monitor, они доступны в рабочей области Log Analytics, где можно выполнять расширенный поиск по данным аудита. В качестве отправной точки перейдите в рабочую область Log Analytics. В разделе **Общие** щелкните **журналы** и введите простой запрос, например: `search "SQLSecurityAuditEvents"` для просмотра журналов аудита.  

Журналы Azure Monitor предоставляют аналитические сведения о работе систем в режиме реального времени. Вы можете использовать встроенный поиск и настраиваемые панели мониторинга для быстрого анализа миллионов записей по всем рабочим нагрузкам и серверам. Дополнительные полезные сведения о языке и командах поиска по журналам Azure Monitor см. в [этой статье](https://docs.microsoft.com/azure/azure-monitor/log-query/log-query-overview).

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../../includes/azure-monitor-log-analytics-rebrand.md)]

## <a name="auditing-differences-between-databases-in-azure-sql-managed-instance-and-databases-in-sql-server"></a>Различия в аудите баз данных в Управляемый экземпляр и базах данных SQL Azure в SQL Server

Основные различия между аудитом в базах данных Управляемый экземпляр Azure SQL и базах данных в SQL Server:

- С Управляемый экземпляр Azure SQL, аудит работает на уровне сервера и хранит `.xel` файлы журнала в хранилище BLOB-объектов Azure.
- В SQL Server аудит работает на уровне сервера, но хранит события в файлах System/журналы событий Windows.

Аудит XEvent в управляемых экземплярах поддерживает целевые объекты хранилища BLOB-объектов Azure. Журналы файловой системы и журналы Windows **не поддерживаются**.

Основные различия в синтаксисе `CREATE AUDIT` для аудита в хранилище BLOB-объектов Azure:

- Предоставляется новый синтаксис `TO URL` , позволяющий указать URL-адрес контейнера хранилища BLOB-объектов Azure, в который `.xel` помещаются файлы.
- `TO EXTERNAL MONITOR`Для включения концентраторов событий и Azure Monitor целей журнала предоставляется новый синтаксис.
- Синтаксис `TO FILE` **не поддерживается** , так как Azure SQL управляемый экземпляр не может получить доступ к файловым ресурсам Windows.
- Параметр завершения работы **не поддерживается**.
- Значение 0 для `queue_delay`**не поддерживается**.

## <a name="next-steps"></a>Дальнейшие действия

- Полный список методов использования журнала аудита см. в статье Приступая к [работе с аудитом базы данных SQL Azure](../../azure-sql/database/auditing-overview.md).
- Дополнительные сведения о программах Azure, поддерживающих соответствие стандартам, см. в [центр управления безопасностью Azure](https://gallery.technet.microsoft.com/Overview-of-Azure-c1be3942), где можно найти самый актуальный список сертификатов соответствия.

<!--Image references-->
