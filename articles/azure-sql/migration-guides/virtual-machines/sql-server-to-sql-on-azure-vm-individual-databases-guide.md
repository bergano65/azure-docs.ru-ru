---
title: SQL Server SQL Server на виртуальных машинах Azure (руководством по миграции)
description: Следуйте этому руководству, чтобы перенести отдельные базы данных SQL Server в SQL Server на виртуальных машинах Azure.
ms.custom: ''
ms.service: virtual-machines-sql
ms.subservice: ''
ms.devlang: ''
ms.topic: how-to
author: markjones-msft
ms.author: markjon
ms.reviewer: mathoma
ms.date: 11/06/2020
ms.openlocfilehash: c7a62bb3ed07ffbd8cfef520e5d504c810d11e5a
ms.sourcegitcommit: b4880683d23f5c91e9901eac22ea31f50a0f116f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/11/2020
ms.locfileid: "94497301"
---
# <a name="migration-guide-sql-server-to-sql-server-on-azure-vms"></a>Руководство по миграции: SQL Server для SQL Server на виртуальных машинах Azure 
[!INCLUDE[appliesto--sqlmi](../../includes/appliesto-sqlvm.md)]

В этом руководстве по миграции рассматривается **Обнаружение** , **Оценка** и **Миграция** пользовательских баз данных из SQL Server в экземпляр SQL Server на виртуальных машинах Azure с помощью резервного копирования и восстановления, а также доставки журналов с использованием [Помощник по миграции базы данных (DMA)](/sql/dma/dma-overview) для оценки. 

Вы можете выполнить миграцию SQL Server, выполняемого локально или в:

- SQL Server на виртуальных машинах  
- Amazon Web Services (AWS) EC2 
- Служба реляционной базы данных Amazon (AWS RDS) 
- Подсистема вычислений (Google Cloud Platform-обеспечить)

Дополнительные сведения о дополнительных стратегиях миграции см. в статье [SQL Server Обзор миграции виртуальной машины](sql-server-to-sql-on-azure-vm-migration-overview.md).

:::image type="content" source="media/sql-server-to-sql-on-azure-vm-migration-overview/migration-process-flow-small.png" alt-text="Поток процесса миграции":::

## <a name="prerequisites"></a>Предварительные требования

Миграция на SQL Server на виртуальных машинах Azure требует следующих действий. 

- [Помощник по миграции базы данных (DMA)](https://www.microsoft.com/download/details.aspx?id=53595).
- Проект службы " [Миграция Azure](/azure/migrate/create-manage-projects)".
- Подготовленная Целевая [SQL Server на виртуальной машине Azure](/azure/azure-sql/virtual-machines/windows/create-sql-vm-portal) , которая имеет ту же или более позднюю версию, что и исходная SQL Server.
- [Подключение между Azure и локальной](/architecture/reference-architectures/hybrid-networking)средой.
- [Выбор соответствующей стратегии миграции](sql-server-to-sql-on-azure-vm-migration-overview.md#migrate).

## <a name="pre-migration"></a>Подготовка к миграции

Перед началом миграции найдите топологию среды SQL и оцените допустимость предполагаемой миграции. 

### <a name="discover"></a>Обнаружить

Служба "миграция Azure" оценивает Пригодность для миграции локальных компьютеров, выполняет масштабирование на основе производительности и предоставляет оценки затрат на работу в локальной среде. Чтобы спланировать миграцию, используйте службу "миграция Azure" для [обнаружения существующих источников данных и сведения о функциях,](../../../migrate/concepts-assessment-calculation.md) используемых экземплярами SQL Server. Этот процесс включает проверку сети для обнаружения всех экземпляров SQL Server в Организации с использованием версии и используемых функций. 

> [!IMPORTANT]
> При выборе целевой виртуальной машины Azure для экземпляра SQL Server необходимо учитывать [рекомендации по производительности SQL Server на виртуальных машинах Azure](../../virtual-machines/windows/performance-guidelines-best-practices.md).

Дополнительные средства обнаружения см. в разделе [службы и средства](../../../dms/dms-tools-matrix.md#business-justification-phase) , доступные для сценариев переноса данных.


### <a name="assess"></a>Оценка

После обнаружения всех источников данных используйте [Помощник по миграции данных (DMA)](/dma/dma-overview) , чтобы оценить миграцию локальных экземпляров SQL Server в экземпляр SQL Server на виртуальной машине Azure, чтобы определить зазоры между исходным и целевым экземплярами. 


> [!NOTE]
> Если вы _не_ обновляете версию SQL Server, пропустите этот шаг и перейдите к разделу [Миграция](#migrate) . 


#### <a name="assess-user-databases"></a>Оценка пользовательских баз данных 

Помощник по миграции данных (DMA) помогает выполнить миграцию на современные платформы данных, выявляя проблемы совместимости, которые могут повлиять на функциональность базы данных в новой версии SQL Server. DMA рекомендует повысить производительность и надежность для целевой среды, а также позволяет перемещать схемы, данные и объекты входа с исходного сервера на целевой сервер.

Дополнительные сведения см. в разделе [Оценка](/sql/dma/dma-migrateonpremsql) . 


> [!IMPORTANT]
>В зависимости от типа оценки разрешения, необходимые для источника SQL Server, могут отличаться. 
   > - Для помощника по **четности функций** учетные данные, предоставленные для подключения к исходной SQL Server базе данных, должны быть членами роли сервера *sysadmin* .
   > - Для помощника по проблемам совместимости предоставленные учетные данные должны иметь по крайней мере `CONNECT SQL` `VIEW SERVER STATE` `VIEW ANY DEFINITION` разрешения.
   > - Прежде чем выполнять оценку, DMA выделит разрешения, необходимые для выбранного помощника.


#### <a name="assess-applications"></a>Оценка приложений

Как правило, уровень приложения обращается к пользовательским базам данных для сохранения и изменения данных.  DMA может оценивать уровень доступа к данным приложения двумя способами: 

- Использование захваченных [расширенных событий](/sql/relational-databases/extended-events/extended-events) или [SQL Server Profiler трассировок ](/sql/tools/sql-server-profiler/create-a-trace-sql-server-profiler) пользовательских баз данных. Можно также использовать [Database experimentation Assistant](/sql/dea/database-experimentation-assistant-capture-trace) для создания журнала трассировки, который также можно использовать для тестирования a/B.

- С помощью [набора средств миграции доступа к данным (Предварительная версия)](https://marketplace.visualstudio.com/items?itemName=ms-databasemigration.data-access-migration-toolkit) (дамт), который обеспечивает обнаружение и оценку SQL-запросов в коде и используется для переноса исходного кода приложения с одной платформы базы данных на другую. Это средство поддерживает различные популярные типы файлов, включая C# и Java, XML и обычный текст. Руководство по выполнению оценки ДАМТ см. в блоге по [использованию дмат](https://techcommunity.microsoft.com/t5/microsoft-data-migration/using-data-migration-assistant-to-assess-an-application-s-data/ba-p/990430) .

Используйте DMA для [импорта](/sql/dma/dma-assesssqlonprem#add-databases-and-extended-events-trace-to-assess) захваченных файлов трассировки или файлов дамт во время оценки пользовательских баз данных. 


#### <a name="scale-assessments"></a>Оценка масштаба

При наличии нескольких серверов, для которых требуется оценка DMA, можно автоматизировать процесс с помощью [интерфейса командной строки](/sql/dma/dma-commandline). С помощью интерфейса можно заранее подготовить команды оценки для каждого экземпляра SQL Server в области для миграции. 

Для сводных отчетов по крупным площадям теперь можно консолидировать оценки Помощник по миграции данных (DMA) [в службе "миграция Azure](/sql/dma/dma-assess-sql-data-estate-to-sqldb)".

#### <a name="refactor-databases-with-dma"></a>Рефакторинг баз данных с помощью DMA

Основываясь на результатах оценки DMA, вы можете получить ряд рекомендаций, чтобы гарантировать, что пользовательские базы данных работают и правильно работают после миграции. DMA предоставляет подробные сведения о затронутых объектах, а также ресурсы для устранения каждой проблемы. Перед миграцией в рабочую среду рекомендуется разрешить все критические изменения и изменения в поведении.

Для устаревших функций можно выбрать Запуск пользовательских баз данных в исходном режиме [совместимости](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) , если вы хотите избежать этих изменений и ускорить миграцию. Однако это предотвратит [Обновление совместимости базы данных](/sql/database-engine/install-windows/compatibility-certification#compatibility-levels-and-database-engine-upgrades) до тех пор, пока не будут устранены устаревшие элементы.

Настоятельно рекомендуется, чтобы все исправления DMA были внесены в скрипт и применены к целевой SQL Server базе данных во время выполнения [процедуры после миграции](#post-migration).

> [!CAUTION]
> Не все SQL Server версии поддерживают все режимы совместимости. Убедитесь, что [Целевая версия SQL Server](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) поддерживает выбранную совместимость с базой данных. Например, SQL Server 2019 не поддерживает базы данных с совместимостью уровня 90 (то есть SQL Server 2005). Эти базы данных потребуют, по крайней мере, обновление до уровня совместимости 100.
>

## <a name="migrate"></a>Миграция

После завершения действий, выполняемых перед миграцией, можно приступать к миграции пользовательских баз данных и компонентов. Перенесите базы данных с помощью предпочтительного [метода миграции](sql-server-to-sql-on-azure-vm-migration-overview.md#migrate).  

Ниже приведены инструкции по выполнению миграции с помощью резервного копирования и восстановления, а также о минимальном простом переносе с помощью резервного копирования и восстановления вместе с доставкой журналов. 

### <a name="backup-and-restore"></a>Резервное копирование и восстановление

Чтобы выполнить стандартную миграцию с помощью резервного копирования и восстановления, выполните следующие действия. 

1. Настройте подключение к целевой SQL Server на виртуальной машине Azure в соответствии с вашими требованиями. Ознакомьтесь с разделом [Подключение к виртуальной машине SQL Server в Azure (диспетчер ресурсов)](../../virtual-machines/windows/ways-to-connect-to-sql.md).
1. Приостановка и остановка всех приложений, использующих базы данных, предназначенные для миграции. 
1. Убедитесь, что пользовательские базы данных неактивны в [режиме одного пользователя](/sql/relational-databases/databases/set-a-database-to-single-user-mode). 
1. Создайте полную резервную копию базы данных в локальном расположении.
1. Скопируйте локальные файлы резервных копий на виртуальную машину с помощью удаленного рабочего стола, [Azure обозреватель данных](/data-explorer/data-explorer-overview)или [служебной программы командной строки AZCopy](../../../storage/common/storage-use-azcopy-v10.md) (рекомендуется > 2 ТБ резервных копий).
1. Восстановите полные резервные копии базы данных в SQL Server на виртуальной машине Azure.

### <a name="log-shipping--minimize-downtime"></a>Доставка журналов (сокращение времени простоя)

Чтобы выполнить минимальный перенос времени простоя с помощью резервного копирования, восстановления и доставки журналов, выполните следующие действия. 

1. Настройте подключение к целевой SQL Server на виртуальной машине Azure в соответствии с вашими требованиями. Ознакомьтесь с разделом [Подключение к виртуальной машине SQL Server в Azure (диспетчер ресурсов)](../../virtual-machines/windows/ways-to-connect-to-sql.md).
1. Убедитесь, что локальные базы данных пользователей, подлежат миграции, находятся в модели полного восстановления или с неполным протоколированием.
1. Выполните полное резервное копирование базы данных в локальное расположение и измените любые существующие задания полного резервного копирования базы данных, чтобы использовать ключевое слово [COPY_ONLY](/sql/relational-databases/backup-restore/copy-only-backups-sql-server) для сохранения цепочки журналов.
1. Скопируйте локальные файлы резервных копий на виртуальную машину с помощью удаленного рабочего стола, [Azure обозреватель данных](/data-explorer/data-explorer-overview)или [служебной программы командной строки AZCopy](../../../storage/common/storage-use-azcopy-v10.md) (рекомендуется >1 ТБ резервных копий).
1. Восстановите полные резервные копии базы данных на SQL Server виртуальной машине Azure.
1. Настройте [доставку журналов](/sql/database-engine/log-shipping/configure-log-shipping-sql-server) между локальной базой данных и целевым SQL Server на виртуальной машине Azure. Не следует повторно инициализировать базы данных, так как она уже была выполнена на предыдущих шагах.
1. **Вырежьте** на целевой сервер. 
   1. Приостановка и остановка приложений, использующих переносимые базы данных. 
   1. Убедитесь, что пользовательские базы данных неактивны в [режиме одного пользователя](/sql/relational-databases/databases/set-a-database-to-single-user-mode). 
   1. Когда все будет готово, выполните доставку журналов с [управляемой отработкой отказа](/sql/database-engine/log-shipping/fail-over-to-a-log-shipping-secondary-sql-server) для локальных баз данных, чтобы целевой SQL Server на виртуальной машине Azure.



### <a name="migrating-objects-outside-user-databases"></a>Миграция объектов за пределами пользовательских баз данных

Возможно, имеются дополнительные SQL Server объекты, необходимые для беспрепятственной работы пользовательских баз данных после миграции. 

В следующей таблице перечислены компоненты и рекомендуемые методы миграции, которые можно выполнить до или после миграции пользовательских баз данных. 


| **Возможность** | **Компонент** | **Методы миграции** |
| --- | --- | --- |
| **Базы данных** | Моделирование  | Скрипт с SQL Server Management Studio |
|| Базе | Запланируйте перемещение базы данных TempDB на [временный диск виртуальной машины Azure (SSD](../../virtual-machines/windows/performance-guidelines-best-practices.md#temporary-disk)) для лучшей производительности. Не забудьте выбрать размер виртуальной машины, имеющей достаточный локальный SSD для размещения базы данных TempDB. |
|| Пользовательские базы данных с FILESTREAM |  Используйте методы [резервного копирования и восстановления](../../virtual-machines/windows/migrate-to-vm-from-sql-server.md#back-up-and-restore) для миграции. DMA не поддерживает базы данных с FILESTREAM. |
| **Безопасность** | Имена входа SQL Server и Windows | Используйте DMA для [переноса имен входа пользователей](/sql/dma/dma-migrateserverlogins). |
|| Роли SQL Server | Скрипт с SQL Server Management Studio |
|| Поставщики служб шифрования | Рекомендуемое [преобразование для использования службы Azure Key Vault](../../virtual-machines/windows/azure-key-vault-integration-configure.md). В этой процедуре используется [поставщик ресурсов виртуальной машины SQL](../../virtual-machines/windows/sql-vm-resource-provider-register.md). |
| **Объекты сервера** | Устройства резервного копирования | Замените на резервную копию базы данных с помощью [службы Azure Backup](../../../backup/backup-sql-server-database-azure-vms.md) или создайте резервные копии в службе [хранилища Azure](../../virtual-machines/windows/azure-storage-sql-server-backup-restore-use.md) (SQL Server 2012 SP1 CU2 +). В этой процедуре используется [поставщик ресурсов виртуальной машины SQL](../../virtual-machines/windows/sql-vm-resource-provider-register.md).|
|| Связанные серверы | Скрипт с SQL Server Management Studio. |
|| Триггеры сервера | Скрипт с SQL Server Management Studio. |
| **Репликация** | Локальные публикации | Скрипт с SQL Server Management Studio. |
|| Локальные подписчики | Скрипт с SQL Server Management Studio. |
| **Polybase** | PolyBase | Скрипт с SQL Server Management Studio. |
| **Управление** | Database Mail | Скрипт с SQL Server Management Studio. |
| **Агент SQL Server** | Задания | Скрипт с SQL Server Management Studio. |
|| Предупреждения | Скрипт с SQL Server Management Studio. |
|| Операторы | Скрипт с SQL Server Management Studio. |
|| прокси-серверы; | Скрипт с SQL Server Management Studio. |
| **Операционная система** | Файлы, общие файловые ресурсы | Запишите все дополнительные файлы или общие файловые ресурсы, используемые серверами SQL Server, и выполните репликацию на целевом объекте виртуальной машины Azure. |


## <a name="post-migration"></a>Действия после миграции

После успешного завершения этапа миграции выполните ряд задач, выполняемых после миграции, чтобы убедиться, что все работает как можно более гладко и эффективно.

### <a name="remediate-applications"></a>Исправление приложений

После переноса данных в целевую среду все приложения, которые раньше использовали источник, должны приступить к приему целевого объекта. Выполнение этой задачи может в некоторых случаях внести изменения в приложения.

Примените все базы данных Помощник по миграции рекомендованные исправления к пользовательской базе данных. Рекомендуется включить эти сценарии, чтобы обеспечить согласованность и разрешить автоматизацию.

### <a name="perform-tests"></a>Выполнение тестов

Тестовый подход к переносу базы данных состоит из выполнения следующих действий.

1. **Разработка проверочных тестов.**  Используйте SQL-запросы для тестирования миграции баз данных. Создание запросов проверки для выполнения как в исходной, так и в целевой базах данных. Запросы на проверку должны охватывать определенную область.
2. **Настройка тестовой среды.**  Тестовая среда должна содержать копию базы данных-источника и целевой базы данных. Не забудьте изолировать тестовую среду.
3. **Выполнение проверочных тестов.**  Выполните проверочные тесты для источника и целевого объекта, а затем проанализируйте результаты.
4. **Запустите тесты производительности.**  Запустите тест производительности для источника и целевого объекта, а затем проанализируйте и сравните результаты.

> [!TIP]
> Используйте [Database experimentation Assistant (ДЕА)](/sql/dea/database-experimentation-assistant-overview) , чтобы помочь в оценке производительности целевого SQL Server.
>

### <a name="optimize"></a>Оптимизация

Этап последующей миграции крайне важен для согласования проблем с точностью и полнотой данных, а также для устранения потенциальных проблем с производительностью рабочей нагрузки.

Дополнительные сведения об этих проблемах и конкретные действия по их устранению см. в следующих ресурсах:

- [Рекомендации по проверке и оптимизации после миграции.](/sql/relational-databases/post-migration-validation-and-optimization-guide)
- [Настройка производительности виртуальных машин SQL Azure](../../virtual-machines/windows/performance-guidelines-best-practices.md).
- [Центр оптимизации затрат Azure](https://azure.microsoft.com/overview/cost-optimization/).

## <a name="next-steps"></a>Следующие шаги

- Чтобы проверить доступность служб, применимых к SQL Server, см. [Глобальный центр инфраструктуры Azure](https://azure.microsoft.com/global-infrastructure/services/?regions=all&amp;products=synapse-analytics,virtual-machines,sql-database) .

- Сведения о службах и средствах Майкрософт и сторонних поставщиков, которые помогут вам в использовании различных сценариев переноса баз данных и данных, а также специальных задач см. в статье [служба и средства для переноса данных.](../../../dms/dms-tools-matrix.md)

- Дополнительные сведения о SQL Azure см. в следующих статьях:
   - [Варианты развертывания](../../azure-sql-iaas-vs-paas-what-is-overview.md)
   - [SQL Server на виртуальных машинах Azure](../../virtual-machines/windows/sql-server-on-azure-vm-iaas-what-is-overview.md)
   - [Калькулятор совокупной стоимости владения Azure](https://azure.microsoft.com/pricing/tco/calculator/) 


- Дополнительные сведения о структуре и цикле внедрения для миграции в облако см. в разделе
   -  [Cloud Adoption Framework для Azure](/azure/cloud-adoption-framework/migrate/azure-best-practices/contoso-migration-scale)
   -  [Рекомендации по затратам и изменению размеров рабочих нагрузок, переносятся в Azure](/azure/cloud-adoption-framework/migrate/azure-best-practices/migrate-best-practices-costs) 

- Сведения о лицензировании см. в разделе
   - [Использование собственной лицензии с Преимущество гибридного использования Azure](../../virtual-machines/windows/licensing-model-azure-hybrid-benefit-ahb-change.md)
   - [Бесплатная расширенная поддержка для SQL Server 2008 и SQL Server 2008 R2](../../virtual-machines/windows/sql-server-2008-extend-end-of-support.md)


- Чтобы оценить уровень доступа к приложениям, см. раздел [набор средств миграции для доступа к данным (Предварительная версия)](https://marketplace.visualstudio.com/items?itemName=ms-databasemigration.data-access-migration-toolkit)
- Дополнительные сведения о выполнении проверки уровня доступа к данным A/B см. [Database experimentation Assistant](/sql/dea/database-experimentation-assistant-overview).
