---
title: Ускоренное восстановление базы данных
titleSuffix: Azure SQL
description: Ускоренное восстановление базы данных обеспечивает быстрое и стабильное восстановление базы данных, моментальный откат транзакций и агрессивное усечение журнала для баз данных в портфеле SQL Azure.
ms.service: sql-database
ms.subservice: high-availability
ms.custom: sqldbrb=4
ms.devlang: ''
ms.topic: conceptual
author: mashamsft
ms.author: mathoma
ms.reviewer: sstein
ms.date: 05/19/2020
ms.openlocfilehash: 4c679b6bb0f5645ea7a972be03ba3621b824a501
ms.sourcegitcommit: 32c521a2ef396d121e71ba682e098092ac673b30
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2020
ms.locfileid: "91327635"
---
# <a name="accelerated-database-recovery-in-azure-sql"></a>Ускоренное восстановление базы данных в SQL Azure 
[!INCLUDE[appliesto-sqldb-sqlmi](includes/appliesto-sqldb-sqlmi.md)]

**Ускоренное восстановление базы данных (ADR)** — это SQL Server компонент ядра СУБД, который значительно повышает доступность базы данных, особенно в случае длительных транзакций, путем перепроектирования SQL Server процесса восстановления ядра СУБД. 

В настоящее время ADR доступен для базы данных SQL Azure, Управляемый экземпляр Azure SQL, баз данных в Azure синапсе Analytics (в настоящее время в предварительной версии) и SQL Server на виртуальных машинах Azure, начиная с SQL Server 2019. 

> [!NOTE] 
> Параметр ADR включен по умолчанию в базе данных SQL Azure и Azure SQL Управляемый экземпляр и отключение ADR для любого из этих продуктов не поддерживается. 

## <a name="overview"></a>Обзор

Основные преимущества ADR

- **Быстрое и согласованное восстановление баз данных**

  При использовании ADR длительные транзакции не влияют на общее время восстановления, благодаря чему обеспечивается быстрое и согласованное восстановление базы данных независимо от количества активных транзакций в системе или их размеров.

- **Мгновенный откат транзакции**

  При использовании ADR откат транзакций совершается мгновенно независимо от времени активности транзакции или количества выполненных обновлений.

- **Агрессивное усечение журнала**

  При использовании правила ADR журнал транзакций агрессивно усекается, даже при наличии активных долго выполняющихся транзакций, что предотвращает ее неконтролируемое увеличение контроля.

## <a name="standard-database-recovery-process"></a>Стандартный процесс восстановления базы данных

Восстановление базы данных соответствует модели восстановления [Овен](https://people.eecs.berkeley.edu/~brewer/cs262/Aries.pdf) и состоит из трех этапов, которые показаны на следующей схеме и более подробно описаны ниже.

![текущий процесс восстановления](./media/accelerated-database-recovery/current-recovery-process.png)

- **Стадия анализа**

  Пересылка журнала транзакций с начала последней успешной контрольной точки (или самой старой "грязной" страницы номер LSN) до конца, чтобы определить состояние каждой транзакции на момент остановки базы данных.

- **Стадия повтора**

  Пересылка журнала транзакций от самой старой незафиксированной транзакции до конца, чтобы перевести базу данных в состояние сбоя, повторно выполнив все зафиксированные операции.

- **Стадия отката**

  В каждой транзакции, которая была активна на момент сбоя, происходит перемещение по журналу назад и отменяются операции, выполненные в ходе этой транзакции.

На основе этой структуры время, необходимое ядру СУБД SQL Server для восстановления после неожиданной перезагрузки, (примерно) пропорционально размеру самой длинной активной транзакции в системе на момент сбоя. Для восстановления требуется откат всех незавершенных транзакций. Необходимое время пропорционально объему работы, выполненному транзакцией, и времени ее активности. Таким образом, процесс восстановления может занять длительное время в наличии длительных транзакций (таких как большие операции с массовыми вставками или операции построения индекса для большой таблицы).

Кроме того, отмена или откат большой транзакции по этой схеме также может занять много времени, так как используется та же самая стадия восстановления (стадия отката), как описано выше.

Кроме того, ядро СУБД SQL Server не может Усечь журнал транзакций, если имеются длительные транзакции, поскольку для процессов восстановления и отката требуются соответствующие записи журнала. В результате такого конструктивного механизма SQL Server СУБД некоторые клиенты использовались для решения проблемы, так как размер журнала транзакций растет очень много и потребляет огромные объемы дискового пространства.

## <a name="the-accelerated-database-recovery-process"></a>Процесс ускоренного восстановления базы данных

ADR устраняет описанные выше проблемы, полностью переполняя процесс восстановления SQL Server ядра СУБД следующим образом:

- Процесс длится фиксированное время или производится мгновенно благодаря тому, что не приходится проверять журнал от начала самой старой активной транзакции. В случае с ADR журнал транзакций обрабатывается только из последней успешной контрольной точки (или самого старого номера LSN, который был изменен в журнале страниц). В результате длительные транзакции не влияют на время восстановления.
- Уменьшается место, которое требуется для журнала транзакций, так как больше не нужно обрабатывать журнал для всей транзакции. В результате журнал транзакций может агрессивно усекаться при наличии контрольных точек и резервных копий.

На самом общем уровне ADR обеспечивает быстрое восстановление баз данных благодаря управлению версиями всех физических изменений базы данных и отмене только логических операций, которая может производиться почти мгновенно. Любая транзакция, которая была активна на момент сбоя, помечается как прерванная, и поэтому любые версии, созданные такими транзакциями, могут быть проигнорированы в параллельных запросах пользователей.

Процесс восстановления ADR состоит из тех же трех этапов, что и текущий процесс восстановления. Этапы восстановления ADR проиллюстрированы на следующей схеме, а их подробное описание представлено ниже.

![Процесс восстановления ADR](./media/accelerated-database-recovery/adr-recovery-process.png)

- **Стадия анализа**

  Процесс остается таким же, как и раньше, с добавлением реконструирования sLog и копированием записей журнала для операций без управления версиями.
  
- **Стадия повтора**

  Эта стадия разделена на два этапа.
  - Этап 1

      Повтор из sLog (от самой старой незафиксированной транзакции до последней контрольной точки). Повтор — это быстрая операция, так как требует обработки всего нескольких записей из sLog.

  - Этап 2

     Повтор в журнале транзакций начинается с последней контрольной точки (вместо самой старой незафиксированной транзакции).

- **Стадия отката**

   Стадия отката, выполняемая с помощью ADR, завершается почти мгновенно с использованием sLog для отката неверсионных операций и постоянного хранилища версий (PVS) с логической отменой для выполнения отката версий на уровне строк.

## <a name="adr-recovery-components"></a>Компоненты восстановления ADR

Ниже приведены четыре основных компонента ADR.

- **Постоянное хранилище версий (PVS)**

  Хранилище сохраненных версий — это новый механизм ядра СУБД SQL Server для сохранения версий строк, созданных в самой базе данных, а не в традиционном `tempdb` хранилище версий. PVS позволяет изолировать ресурсы, а также повышает доступность получателей, доступных для чтения.

- **Логическая Отмена**

  Логический откат — это асинхронный процесс, ответственный за отмену изменений на уровне строк, предоставляя мгновенный откат и отмену операций с управлением версиями. Логический откат выполняется следующим образом.

  - Отслеживание всех прерванных транзакций и пометка их невидимыми для других транзакций. 
  - Выполнение отката с помощью постоянного хранилища версий для всех пользовательских транзакций вместо физического сканирования журнала транзакций и отмены изменений по одному за раз.
  - Освобождение всех блокировок сразу после прерывания транзакции. Так как прерывание подразумевает простое пометку изменений в памяти, процесс очень эффективен, поэтому блокировки не должны храниться в течение длительного времени.

- **sLog**

  sLog — это дополнительный поток журнала в памяти, в котором хранятся записи журнала для операций без версий (таких как перевод кэша метаданных в недействительное состояние, получение блокировки и т. д.). sLog обладает следующими особенностями:

  - малый объем и размещение в памяти;
  - сохраняется на диске путем сериализации во время обработки контрольных точек;
  - периодическое усекается при фиксации транзакций;
  - ускоряет повтор и отмену благодаря обработке только операций без версий;  
  - обеспечивает агрессивное усечение журнала транзакций за счет сохранения только необходимых записей журнала.

- **Очистка**

  Очистка — это асинхронный процесс, который периодически активируется и очищает ненужные версии страниц.

## <a name="accelerated-database-recovery-patterns"></a>Шаблоны восстановления баз данных с ускорением

Преимущество следующих типов рабочих нагрузок от ADR:

- Рабочие нагрузки с долго выполняющимися транзакциями.
- Рабочие нагрузки, в которых встречаются случаи, когда активные транзакции вызывают значительное увеличение журнала транзакций.  
- Рабочие нагрузки с длительными периодами недоступности базы данных из-за длительного восстановления (например, непредвиденный перезапуск службы или откат транзакций вручную).
