---
title: Планирование виртуальной сети для Azure HDInsight
description: Узнайте, как спланировать развертывание виртуальной сети Azure для подключения HDInsight к другим облачным ресурсам или ресурсам в вашем центре обработки данных.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.custom: hdinsightactive
ms.topic: conceptual
ms.date: 07/23/2019
ms.openlocfilehash: 8d89031a3b27742149d450ab79c9febf0aaef1ff
ms.sourcegitcommit: dbde4aed5a3188d6b4244ff7220f2f75fce65ada
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/19/2019
ms.locfileid: "74185623"
---
# <a name="plan-a-virtual-network-for-azure-hdinsight"></a>Планирование виртуальной сети для Azure HDInsight

В этой статье содержатся общие сведения об использовании [виртуальных сетей Azure](../virtual-network/virtual-networks-overview.md) с Azure HDInsight. Здесь также обсуждаются решения по проектированию и реализации, которые необходимо выполнить, прежде чем можно будет реализовать виртуальную сеть для кластера HDInsight. После завершения этапа планирования можно приступить к [созданию виртуальных сетей для кластеров Azure HDInsight](hdinsight-create-virtual-network.md). Дополнительные сведения об IP-адресах управления HDInsight, которые необходимы для правильной настройки групп безопасности сети и определяемых пользователем маршрутов, см. в разделе [IP-адреса управления hdinsight](hdinsight-management-ip-addresses.md).

Виртуальная сеть Azure обеспечивает реализацию следующих сценариев:

* Подключение к HDInsight непосредственно из локальной сети.
* Подключение к хранилищам данных HDInsight в виртуальной сети Azure.
* Прямой доступ к службам [Apache Hadoop](https://hadoop.apache.org/), недоступным из Интернета. Например, возможность напрямую работать с API [Apache Kafka](https://kafka.apache.org/) или использовать API Java для [Apache HBase](https://hbase.apache.org/).

> [!IMPORTANT]
> Создание кластера HDInsight в виртуальной сети приведет к созданию нескольких сетевых ресурсов, таких как сетевые карты и подсистемы балансировки нагрузки. **Не** удаляйте эти сетевые ресурсы, так как они необходимы для правильной работы кластера с виртуальной сетью.
>
> После 28 февраля 2019 виртуальные сетевые ресурсы (например, сетевые карты, фунты и т. д.) для новых кластеров HDInsight, созданных в виртуальной сети, будут подготовлены в той же группе ресурсов кластера HDInsight. Ранее эти ресурсы были подготовлены в группе ресурсов виртуальной сети. Нет изменений в текущих работающих кластерах и созданных кластерах без виртуальной сети.

## <a name="planning"></a>Планирование

Ниже перечислены вопросы, на которые необходимо ответить, если планируется установка HDInsight в виртуальной сети.

* Необходимо ли установить HDInsight в существующей виртуальной сети? Или вы создаете новую сеть?

    При использовании существующей виртуальной сети может потребоваться изменить параметры конфигурации сети, прежде чем устанавливать HDInsight. Дополнительные сведения см. в разделе [Добавление HDInsight в существующую виртуальную сеть](#existingvnet).

* Необходимо ли подключить виртуальную сеть, содержащую HDInsight, к другой виртуальной сети или к локальной сети?

    Для удобства работы с ресурсами в сетях может потребоваться создать пользовательский DNS-сервер и настроить переадресацию DNS. Дополнительные сведения см. в разделе [Подключение нескольких сетей](#multinet).

* Необходимо ли ограничить/перенаправить входящий или исходящий трафик в HDInsight?

    Для HDInsight требуется неограниченная связь с определенными IP-адресами в центре обработки данных Azure. Существует несколько портов, которые следует разрешить в брандмауэрах для взаимодействия с клиентами. Дополнительные сведения см. в разделе [Управление сетевым трафиком](#networktraffic).

## <a id="existingvnet"></a>Добавление HDInsight в существующую виртуальную сеть

Следуйте инструкциям в этом разделе, чтобы узнать, как добавить новый кластер HDInsight в существующую виртуальную сеть Azure.

> [!NOTE]  
> В виртуальную сеть невозможно добавить существующий кластер HDInsight.

1. Какая модель используется для развертывания виртуальной сети: классическая модель или развертывание с помощью диспетчера ресурсов?

    Для HDInsight 3.4 и более поздней версии требуется виртуальная сеть диспетчера ресурсов. Для работы более ранних версий HDInsight требовалась классическая виртуальная сеть.

    Если существующая сеть является классической виртуальной сетью, необходимо создать виртуальную сеть диспетчера ресурсов и затем соединить их друг с другом. [Подключение виртуальных сетей из разных моделей развертывания с помощью портала](../vpn-gateway/vpn-gateway-connect-different-deployment-models-portal.md).

    После присоединения экземпляр HDInsight, который установлен в сети диспетчера ресурсов, может взаимодействовать с ресурсами в классической сети.

2. Применяются ли группы безопасности сети, определяемые пользователем маршруты или виртуальные сетевые устройства для ограничения входящего или исходящего трафика виртуальной сети?

    Поскольку HDInsight является управляемой службой, ей требуется неограниченный доступ к нескольким IP-адресам в центре обработки данных Azure. Чтобы разрешить взаимодействие с этими IP-адресами, обновите существующие группы безопасности сети и определяемые пользователем маршруты.
    
    В состав HDInsight входит несколько служб, которые используют различные порты. Не блокируйте трафик на этих портах. Список портов, трафик через которые следует разрешить на межсетевых экранах виртуального устройства, см. в разделе "Безопасность".
    
    Чтобы найти существующую конфигурацию безопасности, используйте следующие команды Azure PowerShell или Azure CLI:

    * Группы безопасности сети

        Замените `RESOURCEGROUP` именем группы ресурсов, содержащей виртуальную сеть, а затем введите команду:
    
        ```powershell
        Get-AzNetworkSecurityGroup -ResourceGroupName  "RESOURCEGROUP"
        ```
    
        ```azurecli
        az network nsg list --resource-group RESOURCEGROUP
        ```

        Дополнительные сведения см. в документе, посвященном [устранению неполадок с группами безопасности сети](../virtual-network/diagnose-network-traffic-filter-problem.md).

        > [!IMPORTANT]  
        > Правила группы безопасности сети применяются в порядке, основанном на приоритете правила. Применяется первое правило, которое соответствует шаблону трафика; другие правила не применяются к этому трафику. Правила применяются в следующем порядке: от правила с максимальными разрешениями к правилу с минимальными разрешениями. Дополнительные сведения см. в документе [Фильтрация сетевого трафика с помощью групп безопасности сети](../virtual-network/security-overview.md).

    * Определяемые пользователем маршруты

        Замените `RESOURCEGROUP` именем группы ресурсов, содержащей виртуальную сеть, а затем введите команду:

        ```powershell
        Get-AzRouteTable -ResourceGroupName "RESOURCEGROUP"
        ```

        ```azurecli
        az network route-table list --resource-group RESOURCEGROUP
        ```

        Дополнительные сведения см. в документе, посвященном [устранению неполадок с маршрутами](../virtual-network/diagnose-network-routing-problem.md).

3. Создайте кластер HDInsight и выберите виртуальную сеть Azure во время настройки. Следуйте инструкциям в следующих документах, чтобы понять процесс создания кластера:

    * [Создание кластера HDInsight с использованием портала Azure](hdinsight-hadoop-create-linux-clusters-portal.md)
    * [Создание кластера HDInsight с использованием Azure PowerShell](hdinsight-hadoop-create-linux-clusters-azure-powershell.md)
    * [Создание кластеров HDInsight с помощью интерфейса командной строки Azure](hdinsight-hadoop-create-linux-clusters-azure-cli.md)
    * [Создание кластеров Hadoop в HDInsight с помощью шаблонов Resource Manager](hdinsight-hadoop-create-linux-clusters-arm-templates.md)

   > [!IMPORTANT]  
   > Добавление кластера HDInsight в виртуальную сеть — это необязательный шаг настройки. При настройке кластера не забудьте выбрать виртуальную сеть.

## <a id="multinet"></a>Подключение нескольких сетей

Самая сложная задача в конфигурации с несколькими сетями — это разрешение имен между сетями.

Azure предоставляет разрешение имен для служб Azure, установленных в виртуальной сети. Эта встроенная функция разрешения имен позволяет HDInsight подключаться к следующим ресурсам с помощью полного доменного имени (FQDN):

* любые ресурсы, доступные в Интернете; например, microsoft.com, windowsupdate.com;

* любой ресурс, который находится в той же виртуальной сети Azure, с помощью __внутреннего DNS-имени__ ресурса; Например, при использовании разрешения имен по умолчанию ниже приведены примеры внутренних DNS-имен, назначенных рабочим узлам HDInsight.

  * wn0-hdinsi.0owcbllr5hze3hxdja3mqlrhhe.ex.internal.cloudapp.net;
  * wn2-hdinsi.0owcbllr5hze3hxdja3mqlrhhe.ex.internal.cloudapp.net.

    Оба этих узла могут взаимодействовать напрямую друг с другом и с другими узлами в HDInsight, используя внутренние DNS-имена.

При использовании разрешения имен по умолчанию HDInsight __запрещено__ разрешать имена ресурсов в сетях, которые присоединены к виртуальной сети. Например, подключение локальной сети к виртуальной сети является распространенной практикой. Если используется лишь разрешение имен по умолчанию, HDInsight не может обращаться к ресурсам локальной сети по имени. Это также относится и к ресурсам: ресурсы в локальной сети не могут обращаться к ресурсам в виртуальной сети по имени.

> [!WARNING]  
> Перед созданием кластера HDInsight необходимо создать пользовательский DNS-сервер и настроить виртуальную сеть на использование этого сервера.

Чтобы включить разрешение имен между виртуальной сетью и ресурсами в присоединенных сетях, выполните указанные ниже действия.

1. Создайте пользовательский DNS-сервер в виртуальной сети Azure, где планируется установить HDInsight.

2. Настройте виртуальную сеть для использования с пользовательским DNS-сервером.

3. Найдите назначенный Azure DNS-суффикс для виртуальной сети. Это значение аналогично `0owcbllr5hze3hxdja3mqlrhhe.ex.internal.cloudapp.net`. Сведения о поиске DNS-суффиксов см. в разделе [Пример: пользовательский DNS-сервер](hdinsight-create-virtual-network.md#example-dns).

4. Настройте перенаправление между DNS-серверами. Конфигурация зависит от типа удаленной сети.

   * Если удаленная сеть является локальной, настройте DNS следующим образом:
        
     * __Пользовательский DNS-сервер__ (в виртуальной сети):

         * Перенаправляйте запросы DNS-суффиксов виртуальной сети на рекурсивный сопоставитель Azure (168.63.129.16). Azure обрабатывает запросы к ресурсам в виртуальной сети

         * Остальные запросы перенаправляйте на локальный DNS-сервер. Локальный DNS-сервер обрабатывает все остальные запросы на разрешение имен, включая запросы к интернет-ресурсам, таким как microsoft.com.

     * __Локальный DNS-сервер__: перенаправляйте запросы DNS-суффиксов виртуальной сети на пользовательский DNS-сервер. Последний затем перенаправляет их на рекурсивный сопоставитель Azure.

       Такая конфигурация пересылает запросы полных доменных имен с DNS-суффиксом для виртуальных сетей на пользовательский DNS-сервер. Все остальные запросы (даже для общедоступных интернет-адресов) обрабатываются локальным DNS-сервером.

   * Если удаленная сеть является еще одной виртуальной сетью Azure, настройте DNS следующим образом:

     * __Пользовательский DNS-сервер__ (в каждой виртуальной сети):

         * Запросы DNS-суффиксов виртуальных сетей перенаправляются на пользовательские DNS-серверы. DNS-сервер в каждой виртуальной сети должен разрешать ресурсы в своей сети.

         * Все остальные запросы перенаправляются на рекурсивный сопоставитель Azure. Рекурсивный сопоставитель отвечает за разрешение локальных и интернет-ресурсов.

       DNS-сервер для каждой сети перенаправляет запросы на другой сервер на основе DNS-суффикса. Все остальные запросы разрешаются рекурсивным сопоставителем Azure.

     Пример каждой конфигурации см. в разделе [Пример: пользовательский DNS-сервер](hdinsight-create-virtual-network.md#example-dns).

Дополнительные сведения см. в документе [Разрешение имен для виртуальных машин и экземпляров ролей](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md).

## <a name="directly-connect-to-apache-hadoop-services"></a>Прямое соединение со службами Apache Hadoop

Вы можете подключиться к кластеру по адресу `https://CLUSTERNAME.azurehdinsight.net`. Этот адрес использует общедоступный IP-адрес, который может быть недоступен, если вы использовали NSG для ограничения входящего трафика из Интернета. Кроме того, при развертывании кластера в виртуальной сети доступ к нему можно получить с помощью частной конечной точки `https://CLUSTERNAME-int.azurehdinsight.net`. Эта конечная точка разрешается в частный IP-адрес виртуальной сети для доступа к кластеру.

Для подключения к Apache Ambari и другим веб-страницам через виртуальную сеть сделайте следующее:

1. Чтобы найти внутренние полные доменные имена (FQDN) узлов кластера HDInsight, используйте один из следующих методов:

    Замените `RESOURCEGROUP` именем группы ресурсов, содержащей виртуальную сеть, а затем введите команду:

    ```powershell
    $clusterNICs = Get-AzNetworkInterface -ResourceGroupName "RESOURCEGROUP" | where-object {$_.Name -like "*node*"}

    $nodes = @()
    foreach($nic in $clusterNICs) {
        $node = new-object System.Object
        $node | add-member -MemberType NoteProperty -name "Type" -value $nic.Name.Split('-')[1]
        $node | add-member -MemberType NoteProperty -name "InternalIP" -value $nic.IpConfigurations.PrivateIpAddress
        $node | add-member -MemberType NoteProperty -name "InternalFQDN" -value $nic.DnsSettings.InternalFqdn
        $nodes += $node
    }
    $nodes | sort-object Type
    ```

    ```azurecli
    az network nic list --resource-group RESOURCEGROUP --output table --query "[?contains(name,'node')].{NICname:name,InternalIP:ipConfigurations[0].privateIpAddress,InternalFQDN:dnsSettings.internalFqdn}"
    ```

    В возвращенном списке узлов найдите полные доменные имена (FQDN) головных узлов и используйте эти имена для подключения к Ambari и другим веб-службам. Например, воспользуйтесь `http://<headnode-fqdn>:8080` для доступа к Ambari.

    > [!IMPORTANT]  
    > Некоторые службы, размещенные на головных узлах, одновременно активны только на одном узле. Если при попытке доступа к службе на одном головном узле появляется сообщение об ошибке 404, переключитесь на другой головной узел.

2. Чтобы определить узел и порт, через которые доступна служба, обратитесь к документу [Порты, используемые службами Hadoop в HDInsight](./hdinsight-hadoop-port-settings-for-services.md).

## <a id="networktraffic"></a>Управление сетевым трафиком

### <a name="techniques-for-controlling-inbound-and-outbound-traffic-to-hdinsight-clusters"></a>Методы управления входящим и исходящим трафиком в кластерах HDInsight

Для управления сетевым трафиком в виртуальных сетях Azure можно использовать следующие методы:

* **Группы безопасности сети** (NSG) позволяют фильтровать входящий и исходящий трафик в сети. Дополнительные сведения см. в документе [Фильтрация сетевого трафика с помощью групп безопасности сети](../virtual-network/security-overview.md).

* **Сетевые виртуальные устройства** (NVA) можно использовать только с исходящим трафиком. NVA реплицирует функциональность таких устройств, как брандмауэры и маршрутизаторы. Дополнительные сведения см. в документе [Сетевые устройства](https://azure.microsoft.com/solutions/network-appliances).

В качестве управляемой службы HDInsight требует неограниченного доступа к службе работоспособности и управления службой хранилища HDInsight как для входящего, так и для исходящего трафика из виртуальной сети. При использовании группы безопасности сети необходимо убедиться, что эти службы по-прежнему могут взаимодействовать с кластером HDInsight.

![Схема сущностей HDInsight, созданных в настраиваемой виртуальной сети Azure](./media/hdinsight-plan-virtual-network-deployment/hdinsight-vnet-diagram.png)

### <a name="hdinsight-with-network-security-groups"></a>HDInsight с группами безопасности сети

Если вы планируете использовать **группы безопасности сети** для управления сетевым трафиком, перед установкой HDInsight выполните следующие действия.

1. Определите регион Azure, который планируется использовать для HDInsight.

2. Найдите теги службы, необходимые HDInsight для вашего региона. Дополнительные сведения см. в статье [теги службы группы безопасности сети (NSG) для Azure HDInsight](hdinsight-service-tags.md).

3. Создайте или измените группы безопасности сети для подсети, в которую планируется установить HDInsight.

    * __Группы безопасности сети__: разрешите __входящий__ трафик через порт __443__ с диапазона IP-адресов. Это обеспечит, чтобы службы управления HDInsight могли получить доступ к кластеру извне виртуальной сети.

Дополнительные сведения о группах безопасности сети см. в разделе [Общие сведения о группах безопасности сети](../virtual-network/security-overview.md).

### <a name="controlling-outbound-traffic-from-hdinsight-clusters"></a>Управление исходящим трафиком из кластеров HDInsight

Дополнительные сведения об управлении исходящим трафиком из кластеров HDInsight см. в статье [Настройка ограничения исходящего сетевого трафика для кластеров Azure hdinsight](hdinsight-restrict-outbound-traffic.md).

#### <a name="forced-tunneling-to-on-premise"></a>Локальное принудительное туннелирование

Принудительное туннелирование — это определяемая пользователем конфигурация маршрутизации, где весь трафик из подсети принудительно направляется в определенную сеть или расположение, например в локальную сеть. HDInsight __не__ поддерживает принудительное туннелирование трафика в локальные сети. 

## <a id="hdinsight-ip"></a> Требуемые IP-адреса

Если для управления трафиком используются группы безопасности сети или определяемые пользователем маршруты, см. раздел [IP-адреса управления HDInsight](hdinsight-management-ip-addresses.md).
    
## <a id="hdinsight-ports"></a> Требуемые порты

Если вы планируете использовать **брандмауэр** и получить доступ к кластеру за пределами определенных портов, вам следует разрешить трафик на этих портах, необходимых для вашего сценария. По умолчанию специальные списки разрешенных портов не требуются, если трафик управления Azure, описанный в предыдущем разделе, может достигать кластера на порте 443.

См. [список портов, используемых службами Hadoop в HDInsight](hdinsight-hadoop-port-settings-for-services.md).

Дополнительные сведения о правилах межсетевого экрана для виртуальных модулей см. в документе [Сценарий использования виртуальных устройств](../virtual-network/virtual-network-scenario-udr-gw-nva.md).

## <a name="load-balancing"></a>Балансировка нагрузки.

При создании кластера HDInsight также создается балансировщик нагрузки. Тип этой подсистемы балансировки нагрузки — это [уровень SKU "базовый](../load-balancer/load-balancer-overview.md#skus) ", имеющий определенные ограничения. Одно из этих ограничений заключается в том, что если у вас есть две виртуальные сети в разных регионах, вы не сможете подключиться к базовым подсистемам балансировки нагрузки. Дополнительные сведения см. [в статье вопросы и ответы по виртуальным сетям: ограничения для пиринга глобальной виртуальной](../virtual-network/virtual-networks-faq.md#what-are-the-constraints-related-to-global-vnet-peering-and-load-balancers)сети.

## <a name="next-steps"></a>Дополнительная информация

* Примеры кода и примеры создания виртуальных сетей Azure см. в статье [Создание виртуальных сетей для кластеров Azure HDInsight](hdinsight-create-virtual-network.md).
* Полный пример настройки HDInsight для подключения к локальной сети см. в статье [Подключение HDInsight к локальной сети](./connect-on-premises-network.md).
* Сведения о настройке кластеров Apache HBase в виртуальных сетях Azure см. [в статье Создание кластеров Apache HBase в HDInsight в виртуальной сети Azure](hbase/apache-hbase-provision-vnet.md).
* См. инструкции по [настройке георепликации кластера Apache HBase в виртуальных сетях Azure](hbase/apache-hbase-replication.md).
* Дополнительные сведения о виртуальных сетях Azure см. в статье [Виртуальная сеть Azure](../virtual-network/virtual-networks-overview.md).
* Дополнительные сведения о группах безопасности сети см. в статье [Фильтрация сетевого трафика с помощью групп безопасности сети](../virtual-network/security-overview.md).
* Дополнительные сведения о пользовательских маршрутах см. в статье [User-defined routes and IP forwarding](../virtual-network/virtual-networks-udr-overview.md) (Определяемые пользователем маршруты и IP-пересылка).
