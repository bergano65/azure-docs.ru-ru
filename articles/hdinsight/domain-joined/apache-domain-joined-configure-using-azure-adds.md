---
title: Настройка кластера HDInsight с Корпоративным пакетом безопасности с помощью Azure AD-DS
description: Узнайте, как установить и настроить кластер HDInsight с Корпоративным пакетом безопасности с помощью доменных служб Azure Active Directory.
services: hdinsight
ms.service: hdinsight
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: hrasheed
ms.topic: conceptual
ms.date: 10/9/2018
ms.openlocfilehash: 6218a96b3939b2a07832dd3d6d19327cfb039b68
ms.sourcegitcommit: c2c279cb2cbc0bc268b38fbd900f1bac2fd0e88f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/24/2018
ms.locfileid: "49986939"
---
# <a name="configure-a-hdinsight-cluster-with-enterprise-security-package-by-using-azure-active-directory-domain-services"></a>Настройка кластера HDInsight с корпоративным пакетом безопасности с помощью доменных служб Azure Active Directory

Кластеры Azure HDInsight с корпоративным пакетом безопасности предоставляют многопользовательский режим доступа. Кластеры HDInsight с корпоративным пакетом безопасности подключаются к доменам. Таким образом, пользователи домена могут использовать свои учетные данные домена для проверки подлинности в кластерах и выполнения заданий по обработке больших объемов данных. 

Из этой статьи вы узнаете, как настроить присоединенный к домену кластер HDInsight с корпоративным пакетом безопасности с помощью доменных служб Azure Active Directory (Azure AD-DS).

>[!NOTE]
>Корпоративный пакет безопасности доступен в общедоступной версии в HDI 3.6 для Spark, Interactive и Hadoop. Корпоративный пакет безопасности для типов кластеров HBase и Kafka находится на этапе предварительной версии.

## <a name="enable-azure-ad-ds"></a>Включение Azure AD-DS

> [!NOTE]
> Создать экземпляр Azure AD-DS могут только администраторы клиента. Если системой хранения данных кластера является Azure Data Lake Storage (ADLS) 1-го или 2-го поколения, отключите MFA только для тех пользователей, которым будет предоставлен доступ к кластеру. Если системой хранения данных кластера является хранилище BLOB-объектов Azure (WASB), оставьте Многофакторную идентификацию включенной.

Включение доменных служб Azure AD является необходимым предварительным условием, которое нужно выполнить, прежде чем вы сможете создать кластер HDInsight с ESP. Дополнительные сведения см. в разделе [Включение доменных служб Azure Active Directory с помощью портала Azure](../../active-directory-domain-services/active-directory-ds-getting-started.md). 

Если доменные службы Azure AD включены, все пользователи и объекты начинают синхронизацию из Azure Active Directory в Azure AD DS по умолчанию. Продолжительность операции синхронизации зависит от числа объектов в Azure AD. Синхронизация сотен тысяч объектов может занять несколько дней. 

Пользователи могут выбрать для синхронизации только группы, которым требуется доступ к кластерам HDInsight. Этот вариант синхронизации только определенных групп называется *синхронизацией определенных объектов*. Инструкции см. в статье [Configure Scoped Synchronization from Azure AD to your managed domain](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-scoped-synchronization) (Настройка синхронизации определенных объектов из Azure AD в управляемый домен).

При включении защищенных протоколов LDAP укажите в сертификате доменное имя в качестве имени субъекта или альтернативного имени субъекта. Например, если ваше доменное имя — *contoso.com*, убедитесь, что в сертификате существует такое же имя субъекта или альтернативное имя субъекта. Дополнительные сведения см. в разделе [Настройка защищенного протокола LDAP для управляемого домена Azure AD-DS](../../active-directory-domain-services/active-directory-ds-admin-guide-configure-secure-ldap.md).


## <a name="check-azure-ad-ds-health-status"></a>Проверка состояния работоспособности Azure AD DS
Просмотрите состояние работоспособности доменных служб Active Directory Azure, выбрав **Работоспособность** в категории **Управление**. Убедитесь, что состояние Azure AD DS отображается с зеленым значком (выполняется) и синхронизация завершена.

![Работоспособность доменных служб Azure Active Directory](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-aadds-health.png)

## <a name="create-and-authorize-a-managed-identity"></a>Создание и авторизация управляемого удостоверения

**Управляемое удостоверение, назначаемое пользователем,** позволяет упростить операции в доменных службах. При назначении управляемого удостоверения роли участника доменных служб HDInsight можно считывать, создавать, изменять и удалять операции доменных служб. Некоторые операции доменных служб, например создание подразделений и субъектов-служб, требуются для Корпоративного пакета безопасности HDInsight. Управляемые удостоверения можно создать в любой подписке. Дополнительные сведения см. в статье [Что такое управляемые удостоверения для ресурсов Azure?](../../active-directory/managed-identities-azure-resources/overview.md)

Чтобы настроить управляемое удостоверение для использования с кластерами HDInsight ESP, создайте управляемое удостоверение, назначаемое пользователем, если у вас его еще нет. Инструкции доступны в статье [Создание, получение списка, удаление ролей и их назначение для управляемого удостоверения, назначаемого пользователем, с помощью портала Azure](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal). Затем назначьте управляемое удостоверение роли **участника доменных служб HDInsight** в управлении доступом Azure AD DS (для такого назначения роли требуются привилегии администратора AAD DS).

![Служба контроля доступа доменных служб Azure Active Directory](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-configure-managed-identity.png)

Назначение управляемого удостоверения для роли **Участник доменных служб HDInsight** гарантирует, что у удостоверения есть необходимый уровень доступа для выполнения определенных операций доменных служб в домене AAD-DS.

После создания управляемого удостоверения и назначения нужной роли администратор AAD DS может настроить список тех, кто может использовать это управляемое удостоверение. Для настройки пользователей управляемого удостоверения администратор должен выбрать управляемое удостоверение на портале, а затем щелкнуть **Управление доступом (IAM)** в разделе **Обзор**. Затем в правой области назначьте роль оператора управляемого удостоверения пользователям или группам, которым нужно создать кластеры HDInsight ESP. Например, администратор AAD DS может назначить эту роль группе "MarketingTeam" для управляемого удостоверения "sjmsi", как показано на рисунке ниже.

![Назначение роли оператора управляемого удостоверения HDInsight](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-managed-identity-operator-role-assignment.png)

## <a name="networking-considerations"></a>Рекомендации по работе с сетями

После включения доменных служб Azure AD локальный сервер службы доменных имен (DNS) будет запущен на виртуальных машинах AD. Настройте виртуальную сеть Azure AD DS, чтобы использовать эти настраиваемые DNS-серверы. Чтобы найти нужные IP-адреса, выберите **Свойства** в категории **управления** и просмотрите IP-адреса, появившиеся в списке под параметром **IP-адрес в виртуальной сети**.

![Поиск IP-адресов для локальных DNS-серверов](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-aadds-dns.png)

Измените конфигурацию DNS-серверов в виртуальной сети Azure AD DS, чтобы использовать эти настраиваемые IP-адреса, выбрав **DNS-серверы** в категории **Параметры**. Затем щелкните переключатель рядом с параметром **Custom** (Пользовательский), введите в указанное ниже текстовое поле первый IP-адрес и нажмите кнопку **Сохранить**. Добавьте дополнительные IP-адреса, используя те же шаги.

![Обновление конфигурации DNS виртуальной сети](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-aadds-vnet-configuration.png)

Проще разместить экземпляр Azure AD-DS и кластер HDInsight в одной и той же виртуальной сети Azure. Если вы планируете использовать разные виртуальные сети, необходимо их сверять, чтобы контроллер домена был виден в HDI виртуальных машин. Дополнительные сведения см. в статье [Пиринг между виртуальными сетями](../../virtual-network/virtual-network-peering-overview.md). 

После установки пиринговой связи между виртуальными сетями настройте виртуальную сеть HDInsight, чтобы использовать настраиваемый DNS-сервер, и введите частные IP-адреса Azure AD DS в качестве адресов DNS-сервера. Если обе виртуальные сети используют одни DNS-серверы, настраиваемое доменное имя разрешится к правильному IP-адресу и будет доступно в HDInsight. Например, для доменного имени "contoso.com" после выполнения этого шага при проверке связи с "contoso.com" должен быть выведен правильный IP-адрес Azure AD DS. 

![Настройка пользовательских DNS-серверов для пиринговой виртуальной сети](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-aadds-peered-vnet-configuration.png)

**Чтобы проверить** правильность установки сети, присоедините виртуальную машину Windows к виртуальной сети или подсети HDInsight и проверьте связь по доменному имени (оно должно разрешить протокол IP), а затем запустите **ldp.exe** для доступа к домену Azure AD DS. Затем **присоедините эту виртуальную машину Windows к домену, чтобы подтвердить**, что все необходимые вызовы RPC между клиентом и сервером успешно выполнены. Можно также использовать **nslookup** для подтверждения сетевого доступа к учетной записи хранения или любой внешней базе данных (например, внешнему хранилищу метаданных Hive или базе данных Ranger).
Если доменные службы AAD защищены группой безопасности сети, убедитесь, что все [необходимые порты](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd772723(v=ws.10)#communication-to-domain-controllers) находятся в списке разрешений в правилах NSG подсети AAD DS. 

## <a name="create-a-hdinsight-cluster-with-esp"></a>Создание кластера HDInsight с корпоративным пакетом безопасности

После правильной настройки предыдущих шагов следующим шагом будет создание кластера HDInsight с поддержкой ESP. При создании кластера HDInsight вы можете включить Корпоративный пакет безопасности на **пользовательской** вкладке. Если необходимо применить шаблон Azure Resource Manager для развертывания, используйте интерфейс портала один раз и загрузите предварительно заполненный шаблон на последней странице "Итоги" для повторного пользования в будущем.

![Безопасность и сеть Azure HDInsight](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-create-cluster-security-networking.png)

После включения корпоративного пакета безопасности будет выполняться автоматическое обнаружение и проверка распространенных неправильных настроек, связанных с Azure AD-DS.

![Проверка домена Azure HDInsight с корпоративным пакетом безопасности](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-create-cluster-esp-domain-validate.png)

Чем раньше будут обнаружены ошибки, тем больше времени вы сэкономите, исправив их до создания кластера.

![Непройденные проверки домена в Azure HDInsight с корпоративным пакетом безопасности](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-create-cluster-esp-domain-validate-failed.png)

При создании кластера HDInsight с корпоративным пакетом безопасности необходимо указать следующие параметры.

- **Администратор кластера**: выберите администратора кластера в синхронизированных службах Azure AD-DS. Эта учетная запись должна быть синхронизирована и доступна в Azure AD DS.

- **Cluster access groups** (Группы доступа к кластеру): группы безопасности, пользователей которых нужно синхронизировать с кластером, должны быть доступны в Azure AD-DS. Например, группа HiveUsers. Дополнительные сведения см. в статье [Создание группы и добавление в нее пользователей в Azure Active Directory](../../active-directory/fundamentals/active-directory-groups-create-azure-portal.md).

- **URL-адрес LDAPS**. Например, ldaps://contoso.com:636.

На следующем снимке экрана показана успешная конфигурация на портале Azure:

![Конфигурация доменных служб Active Directory в Azure HDInsight с корпоративным пакетом безопасности](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-domain-joined-configuration-azure-aads-portal.png).

Созданное управляемое удостоверение можно выбрать из раскрывающегося списка назначаемых пользователем управляемых удостоверений при создании нового кластера.

![Конфигурация доменных служб Active Directory в Azure HDInsight с корпоративным пакетом безопасности](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-identity-managed-identity.png).


## <a name="next-steps"></a>Дополнительная информация
* Сведения о настройке политик Hive и выполнении запросов Hive см. в разделе [Настройка политик Hive в кластерах HDInsight с корпоративным пакетом безопасности](apache-domain-joined-run-hive.md).
* Сведения о подключении к кластерам HDInsight с корпоративным пакетом безопасности с использованием SSH см. в разделе [Использование SSH с Hadoop на основе Linux в HDInsight из Linux, Unix или OS X](../hdinsight-hadoop-linux-use-ssh-unix.md#domainjoined).
