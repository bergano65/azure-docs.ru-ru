---
title: Создание собственных ключей для Apache Kafka в Azure HDInsight (предварительная версия)
description: В этой статье описывается использование собственных ключей из Azure Key Vault для шифрования данных, хранимых в Apache Kafka в Azure HDInsight.
services: hdinsight
ms.service: hdinsight
author: mamccrea
ms.author: mamccrea
ms.reviewer: mamccrea
ms.topic: conceptual
ms.date: 09/24/2018
ms.openlocfilehash: 85fea195b05bea8a1db70f8b5b81cabdfe7c6c72
ms.sourcegitcommit: 3856c66eb17ef96dcf00880c746143213be3806a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/02/2018
ms.locfileid: "48041515"
---
# <a name="bring-your-own-key-for-apache-kafka-on-azure-hdinsight-preview"></a>Создание собственных ключей для Apache Kafka в Azure HDInsight (предварительная версия)

Azure HDInsight включает поддержку создания собственных ключей (BYOK) для Apache Kafka. Эта функция позволяет вам владеть ключами, используемыми для шифрования неактивных данных, и управлять ими. 

Все управляемые диски в HDInsight защищены с помощью шифрования службы хранилища Azure (SSE). По умолчанию данные на этих дисках зашифрованы с помощью ключей, управляемых корпорацией Майкрософт. При включении BYOK необходимо указать ключ шифрования для HDInsight и управлять им с помощью Azure Key Vault. 

Шифрование BYOK — это процедура из одного этапа, выполняемая во время создания кластера без дополнительных затрат. Вам нужно всего лишь зарегистрировать HDInsight в качестве управляемого удостоверения в Azure Key Vault и добавить ключ шифрования при создании кластера.

Все сообщения к кластеру Kafka (включая реплики, обслуживаемые Kafka) шифруются с помощью симметричного ключа шифрования данных (DEK). Ключ DEK защищен с помощью ключа шифрования ключей (KEK) из вашего хранилища ключей. Процессы шифрования и расшифровки полностью обрабатываются Azure HDInsight. 

Для безопасной смены ключей в хранилище ключей можно использовать портал Azure или Azure CLI. При смене ключа кластер Kafka HDInsight начинает использовать новый ключ в течение нескольких минут. Включите функции защиты ключей "Не очищать" и "Обратимое удаление" для защиты от программ-шантажистов или случайного удаления. Ключи без таких функций защиты не поддерживаются.

## <a name="get-started-with-byok"></a>Начало работы с BYOK

1. Создайте управляемые удостоверения для ресурсов Azure.

   Для проверки подлинности в Key Vault создайте назначаемое пользователем управляемое удостоверение с помощью [портала Azure](../../active-directory/managed-service-identity/how-to-manage-ua-identity-portal.md), [Azure PowerShell](../../active-directory/managed-service-identity/how-to-manage-ua-identity-powershell.md), [Azure Resource Manager](../../active-directory/managed-service-identity/how-to-manage-ua-identity-arm.md) или [Azure CLI](../../active-directory/managed-service-identity/how-to-manage-ua-identity-cli.md). Хотя Azure Active Directory требуется для использования управляемых удостоверений и BYOK в Kafka, корпоративный пакет безопасности (ESP) не является обязательным требованием. Не забудьте сохранить идентификатор ресурса управляемого удостоверения для его добавления в политику доступа Key Vault.

   ![Создание назначаемого пользователем управляемого удостоверения на портале Azure](./media/apache-kafka-byok/user-managed-identity-portal.png)

2. Импортируйте существующее хранилище ключей или создайте новое.

   HDInsight поддерживает только Azure Key Vault. Если у вас есть собственное хранилище ключей, вы можете импортировать ключи в Azure Key Vault. Помните, что для ключей должны быть включены функции "Обратимое удаление" и "Не очищать". Функции "Обратимое удаление" и "Не очищать" доступны через интерфейсы REST, .NET/C#, PowerShell и Azure CLI.

   Чтобы создать новое хранилище ключей, выполните краткое руководство по [Azure Key Vault](../../key-vault/key-vault-get-started.md). Дополнительные сведения об импорте существующих ключей см. в статье [Сведения о ключах, секретах и сертификатах](../../key-vault/about-keys-secrets-and-certificates.md).

   Чтобы создать новый ключ, выберите **Создать или импортировать** из меню **Ключи** в разделе **Параметры**.

   ![Создание нового ключа в хранилище ключей Azure](./media/apache-kafka-byok/kafka-create-new-key.png)

   Задайте **Параметры**, чтобы **Создать** и присвоить имя для ключа.

   ![Создание нового ключа в хранилище ключей Azure](./media/apache-kafka-byok/kafka-create-a-key.png)

   Выберите ключ, созданный из списка ключей.

   ![Список ключей в Azure Key Vault](./media/apache-kafka-byok/kafka-key-vault-key-list.png)

   Используя собственный ключ для шифрования кластера Kafka, необходимо предоставить ключ URI. Скопируйте **идентификатор ключа** и сохраните его, пока не будете готовы к созданию кластера.

   ![Копирование идентификатор ключа](./media/apache-kafka-byok/kafka-get-key-identifier.png)
   
3. Добавьте управляемое удостоверение в политику доступа хранилища ключей.

   Создайте политику доступа Azure Key Vault.

   ![Создание политики доступа Azure Key Vault.](./media/apache-kafka-byok/add-key-vault-access-policy.png)

   В поле **Выбор субъекта** выберите назначаемое пользователем управляемое удостоверение, которое вы создали.

   ![Задание выбранного субъекта для политики доступа Azure Key Vault](./media/apache-kafka-byok/add-key-vault-access-policy-select-principal.png)

   Задайте **разрешения ключей** **Получение**, **Распаковка ключа** и **Упаковка ключа**.

   ![Настройка разрешений ключей для политики доступа Azure Key Vault](./media/apache-kafka-byok/add-key-vault-access-policy-keys.png)

   Задайте **разрешения секретов** **Получение**, **Задание** и **Удаление**.

   ![Настройка разрешений ключей для политики доступа Azure Key Vault](./media/apache-kafka-byok/add-key-vault-access-policy-secrets.png)

4. Создание кластера HDInsight

   Теперь можно создать кластер HDInsight. BYOK может применяться только к новым кластерам во время создания кластера. Шифрование невозможно удалить из кластеров BYOK, кроме того, BYOK нельзя добавить в имеющиеся кластеры.

   ![Шифрование дисков Kafka на портале Azure](./media/apache-kafka-byok/apache-kafka-byok-portal.png)

   Во время создания кластера укажите полный URL-адрес ключа, включая версию ключа. Например, `https://contoso-kv.vault.azure.net/keys/kafkaClusterKey/46ab702136bc4b229f8b10e8c2997fa4`. Кроме того, необходимо назначить кластеру управляемое удостоверение и указать URI ключа.

## <a name="faq-for-byok-to-kafka"></a>Часто задаваемые вопросы о BYOK в Kafka

**Как кластер Kafka получает доступ к хранилищу ключей?**

   Свяжите управляемое удостоверение с кластером Kafka HDInsight во время создания кластера. Это управляемое удостоверение можно создать до или во время создания кластера. Вам также потребуется предоставить управляемому удостоверению доступ к хранилищу ключей, где хранится ключ.

**Эта функция доступна для всех кластеров Kafka в HDInsight?**

   Шифрование BYOK поддерживается только для кластеров Kafka 1.1 и более поздних версий.

**Можно ли использовать разные ключи для разных разделов и секций?**

   Нет, все управляемые диски в кластере шифруются с помощью одного ключа.

**Как восстановить кластер, если ключи удалены?**

   Поскольку поддерживаются только ключи с включенной функцией "Обратимое удаление", после восстановления ключей в хранилище ключей кластер снова сможет получить к ним доступ. Сведения о восстановлении ключа Azure Key Vault см. в разделе [Restore-AzureKeyVaultKey](/powershell/module/azurerm.keyvault/restore-azurekeyvaultkey).

**Могут ли приложения-производители и потребители одновременно работать с кластером BYOK и кластером без BYOK?**

   Да. Использование BYOK является прозрачным для приложений-производителей и потребителей. Шифрование выполняется на уровне операционной системы. В существующие приложения-производители и потребители Kafka никакие изменения вносить не требуется.

**Диски операционной системы диски и диски ресурсов тоже шифруются?**

   Нет. Диски ОС и диски ресурсов не шифруются.

**В случае масштабирования кластера будут ли новые брокеры поддерживать BYOK?**

   Да. Кластеру требуется доступ к ключу в хранилище ключей во время масштабирования. Один ключ используется для шифрования всех управляемых дисков в кластере.

**Доступна ли функция BYOK в моем расположении?**

   Функция создания собственных ключей для Kafka доступна во всех общедоступных облаках.

## <a name="next-steps"></a>Дополнительная информация

* Дополнительные сведения об Azure Key Vault см. в статье [Что такое Azure Key Vault?](../../key-vault/key-vault-whatis.md)
* Чтобы приступить к работе с Azure Key Vault, см. инструкции по [началу работы с Azure Key Vault](../../key-vault/key-vault-get-started.md).
