---
title: Управление журналами для кластера HDInsight в Azure HDInsight
description: Определение типов, размеров и политик хранения для файлов журнала действий HDInsight.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: how-to
ms.custom: hdinsightactive
ms.date: 02/05/2020
ms.openlocfilehash: 95472d53045e23741286188da004eb649570a965
ms.sourcegitcommit: 3bcce2e26935f523226ea269f034e0d75aa6693a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/23/2020
ms.locfileid: "92487234"
---
# <a name="manage-logs-for-an-hdinsight-cluster"></a>Управление журналами для кластера HDInsight

Кластер HDInsight создает множество файлов журналов. Например, Apache Hadoop и связанные с ним службы, такие как Apache Spark, создают подробные журналы выполнения заданий. Управление файлами журналов является частью поддержания работоспособности кластера HDInsight. Кроме того, к архивации журналов могут применяться нормативные требования.  Из-за количества и размера файлов журналов оптимизация хранения и архивирования журналов помогает в управлении затратами на обслуживание.

Управление журналами кластера HDInsight включает в себя хранение информации обо всех аспектах среды кластера. Эти сведения включают все связанные журналы служб Azure, конфигурацию кластера, сведения о выполнении заданий, любые состояния ошибок и другие данные по мере необходимости.

Типичные шаги в управлении журналом HDInsight:

* Шаг 1. Определение политики хранения журналов
* Шаг 2. Управление журналами конфигурации версий службы кластера
* Шаг 3. Управление файлами журнала выполнения заданий кластера
* Шаг 4. Прогнозирование размера хранилища журналов и затрат
* Шаг 5. Определение политик архивации журнала процессов

## <a name="step-1-determine-log-retention-policies"></a>Шаг 1. Определение политики хранения журналов

Первым шагом при создании стратегии управления журналом кластера HDInsight является сбор сведений о бизнес-сценариях и требованиях хранения истории выполнения заданий.

### <a name="cluster-details"></a>Сведения о кластере

Следующие сведения о кластере полезны для сбора информации в вашей стратегии управления журналами. Соберите эти сведения из всех кластеров HDInsight, созданных в определенной учетной записи Azure.

* Имя кластера
* Регионы кластеров и зоны доступности Azure
* Состояние кластера, включая сведения о последнем изменении состояния
* Тип и количество экземпляров HDInsight для головного узла, узлов ядра и задач

Вы можете получить большую часть этих сведений верхнего уровня, используя портал Azure.  Кроме того, вы можете использовать [Azure CLI](/cli/azure/) для получения сведений о кластерах HDInsight:

```azurecli
az hdinsight list --resource-group <ResourceGroup>
az hdinsight show --resource-group <ResourceGroup> --name <ClusterName>
```

Чтобы просмотреть эти сведения, можно также использовать PowerShell.  Дополнительные сведения см. в статье [Управление кластерами Apache Hadoop в HDInsight с помощью Azure PowerShell](hdinsight-administer-use-powershell.md).

### <a name="understand-the-workloads-running-on-your-clusters"></a>Общие сведения о рабочих нагрузках в кластерах

Важно понимать типы рабочих нагрузок, выполняемых в вашем кластере HDInsight, для разработки соответствующих стратегий ведения журналов для каждого типа.

* Являются ли рабочие нагрузки экспериментальными (для разработки или тестирования) или рабочего уровня?
* Как часто обычно выполняются рабочие нагрузки рабочего уровня?
* Являются ли какие-либо из рабочих нагрузок ресурсоемкими или долгосрочными?
* Используется ли в какой-либо из рабочих нагрузок сложный набор служб Hadoop, для которых создается несколько типов журналов?
* Имеет ли какая-либо из рабочих нагрузок соответствующие нормативные требования к выполнению преобразования?

### <a name="example-log-retention-patterns-and-practices"></a>Пример журнала хранения шаблонов и рекомендации по работе с ним

* Рассмотрите возможность отслеживания преобразования данных путем добавления идентификатора к каждой записи в журнале или с помощью других методов. Это позволит отследить исходный источник данных и операцию и наблюдать за данными на каждом этапе, чтобы понять их последовательность и допустимость.

* Подумайте, как вы можете получать журналы из кластера или из нескольких кластеров для таких целей, как аудит, мониторинг, планирование и оповещение. Вы можете использовать пользовательское решение для доступа к файлам журнала и их загрузке на регулярной основе, а также комбинировать и анализировать их для отображения панели мониторинга. Вы также можете добавить дополнительные возможности для оповещения о безопасности или обнаружении сбоев. Вы можете создавать эти программы с помощью PowerShell, SDK HDInsight или кода, который обращается к классической модели развертывания Azure.

* Подумайте, будет ли решение для мониторинга или служба полезной. Microsoft System Center предоставляет [пакет управления HDInsight](https://systemcenter.wiki/?Get_ManagementPackBundle=Microsoft.HDInsight.mpb&FileMD5=10C7D975C6096FFAA22C84626D211259). Вы также можете использовать сторонние средства, такие как Apache Chukwa и Ganglia, для сбора и централизации журналов. Многие компании предлагают службы для мониторинга решений для обработки больших данных на основе Hadoop, например: Center, Compuware APM, Сематекст SPM и Зеттасет Orchestrator.

## <a name="step-2-manage-cluster-service-versions-and-view-logs"></a>Шаг 2. Управление версиями службы кластеров и просмотр журналов

Типичный кластер HDInsight использует несколько служб и программные пакеты с открытым кодом (такие как Apache HBase, Apache Spark и т. д.). Для некоторых рабочих нагрузок, таких как биоинформатика, вам может потребоваться сохранить историю журналов конфигурации службы в дополнение к журналам выполнения заданий.

### <a name="view-cluster-configuration-settings-with-the-ambari-ui"></a>Просмотр параметров конфигурации кластера в пользовательском интерфейсе Ambari

Apache Ambari упрощает конфигурацию кластера HDInsight, управление им и его мониторинг за счет пользовательского веб-интерфейса и интерфейса REST API. Ambari есть в кластерах HDInsight на основе Linux. Выберите панель **панель мониторинга кластера** на странице портал Azure HDInsight, чтобы открыть страницу ссылки **панели мониторинга кластера** .  Выберите область **Панель мониторинга кластера HDInsight**, чтобы открыть пользовательский интерфейс Ambari.  Вам будет предложено ввести учетные данные для входа в кластер.

Чтобы открыть список просмотров службы, на странице портала Azure для HDInsight выберите область **Просмотры Ambari**.  Этот список меняется в зависимости от установленных библиотек.  Например, в нем могут быть диспетчер очередей YARN, представления Hive и Tez.  Выберите ссылку на службу для просмотра сведений о конфигурации и службе.  На странице **стека и версии** пользовательского интерфейса Ambari содержатся сведения о конфигурации служб в кластере и история версий служб. Чтобы перейти к этому разделу, в пользовательском интерфейсе Ambari выберите меню **Администратор**, а затем — **Stacks and Versions** (Стеки и версии).  Выберите вкладку **версий**, чтобы просмотреть сведения о версии службы:

![Стек и версии администратора Apache Ambari](./media/hdinsight-log-management/ambari-stack-versions.png)

С помощью пользовательского интерфейса Ambari вы можете загрузить конфигурацию для любых служб, запущенных на конкретном узле в кластере.  Выберите меню **Узлы**, а затем перейдите по ссылке на нужный узел. На странице этого узла выберите **Host Actions** (Действия на узле), а затем **Download Client Configs** (Скачать конфигурацию клиента).

![Настройки клиента узла для загрузки Apache Ambari](./media/hdinsight-log-management/download-client-configs.png)

### <a name="view-the-script-action-logs"></a>Просмотр журналов действий сценария

С помощью [действий сценария](hdinsight-hadoop-customize-cluster-linux.md) HDInsight можно запустить сценарии в кластере вручную или в соответствии с указанным временем. Например, действия скрипта можно использовать для установки дополнительного программного обеспечения в кластере или изменения параметров конфигурации (сброса значений по умолчанию). Журналы сценариев действий могут помочь понять ошибки, возникшие во время настройки кластера, а также изменения настроек конфигурации, которые могут повлиять на производительность и доступность кластера.  Чтобы увидеть состояние действия сценария, нажмите кнопку **Операции** в пользовательском интерфейсе Ambari или получите доступ к журналам состояний в учетной записи хранения по умолчанию. Журналы хранилища находятся в `/STORAGE_ACCOUNT_NAME/DEFAULT_CONTAINER_NAME/custom-scriptaction-logs/CLUSTER_NAME/DATE`.

### <a name="view-ambari-alerts-status-logs"></a>Просмотр журналов состояния оповещений Ambari

Apache Ambari записывает изменения состояния оповещений в `ambari-alerts.log` . Полный путь — `/var/log/ambari-server/ambari-alerts.log` . Чтобы включить отладку для журнала, измените свойство в `/etc/ambari-server/conf/log4j.properties.` поле изменить, а затем введите в разделе `# Log alert state changes` от:

```
log4j.logger.alerts=INFO,alerts

to

log4j.logger.alerts=DEBUG,alerts
```

## <a name="step-3-manage-the-cluster-job-execution-log-files"></a>Шаг 3. Управление файлами журнала выполнения заданий кластера

Следующий шаг заключается в анализе файлов журнала выполнения заданий для различных служб,  таких как Apache HBase, Apache Spark и т. д. Кластер Hadoop создает большое количество подробных журналов, поэтому определение того, какие журналы являются полезными (а какие нет), может занять много времени.  Важно понимать систему ведения журналов для целевого управления файлами журналов.  На следующем рисунке показан пример файла журнала.

![Пример выходных данных файла журнала HDInsight](./media/hdinsight-log-management/hdi-log-file-example.png)

### <a name="access-the-hadoop-log-files"></a>Доступ к файлам журналов Hadoop

HDInsight хранит свои файлы журналов как в файловой системе кластера, так и в службе хранилища Azure. Вы можете проверить файлы журнала в кластере, открыв [SSH](hdinsight-hadoop-linux-use-ssh-unix.md) -подключение к кластеру и просмотрев файловую систему, или с помощью портала состояния Hadoop YARN на удаленном сервере головного узла. Просмотреть файлы журналов в службе хранилища Azure можно с помощью любого из средств, которые могут получать доступ к данным из службы хранилища Azure и скачивать их из нее. Примеры: [AzCopy](../storage/common/storage-use-azcopy.md), [CloudXplorer](https://clumsyleaf.com/products/cloudxplorer)и Visual Studio Обозреватель сервера. Кроме того, можно использовать PowerShell и библиотеки клиента хранилища Azure или пакеты SDK .NET Azure для доступа к данным в хранилище BLOB-объектов.

Hadoop выполняет работу заданий в виде *попыток завершения задач* на различных узлах в кластере. HDInsight может инициировать попытки выполнения задач, завершая любые другие попытки выполнения задач, которые не выполняются первыми. Это создает множество операций, которые регистрируются в файлах журнала контроллера, stderr и syslog в режиме реального времени. Кроме того, несколько попыток выполняются одновременно, но файл журнала может отображать результаты только линейно.

#### <a name="hdinsight-logs-written-to-azure-blob-storage"></a>Журналы HDInsight, записываемые в хранилище BLOB-объектов Azure

Кластеры HDInsight сконфигурированы для записи журналов задач в учетную запись хранения BLOB-объектов Azure для любого задания, которое отправляется с помощью командлетов Azure PowerShell или API-интерфейсов отправки .NET.  При отправке задания через SSH в кластер сведения о регистрации выполнения хранятся в таблицах Azure, как описано в предыдущем разделе.

В дополнение к основным файлам журнала, созданным HDInsight, установленные службы, такие как YARN, также создают файлы журналов выполнения задач.  Число и тип файлов журналов зависит от установленных служб.  Стандартные службы — Apache HBase Apache Spark и т. д.  Просмотрите файлы выполнения журнала заданий для каждой службы, чтобы понять общие сведения о файлах ведения журналов, доступных в вашем кластере.  Каждая служба имеет собственный уникальный метод ведения журналов и расположение для хранения файлов журналов.  Примеры подробных сведений о доступе к наиболее распространенным файлам журналов служб (из YARN) обсуждаются в следующем разделе.

### <a name="hdinsight-logs-generated-by-yarn"></a>Журналы HDInsight, формируемые службой YARN

Служба YARN объединяет журналы со всех контейнеров на рабочем узле и хранит их как один сводный файл журнала на рабочем узле. Этот журнал хранится в файловой системе по умолчанию после завершения приложения. Ваше приложение может использовать сотни или тысячи контейнеров, но журналы для всех контейнеров, выполненных на одном рабочем узле, всегда объединяются в один файл. В приложении используется только один журнал для каждого рабочего узла. Объединение журналов включено по умолчанию на кластерах HDInsight версии 3.0 и более поздних версий. Объединенные журналы находятся в хранилище по умолчанию для кластера.

```
/app-logs/<user>/logs/<applicationId>
```

Агрегированные журналы не могут быть прочитаны напрямую, так как они написаны в двоичном формате TFile, индексируемом по контейнеру. Чтобы отобразить эти журналы для интересующих вас приложений или контейнеров в виде обычного текста, используйте журналы YARN ResourceManager или средства CLI.

#### <a name="yarn-cli-tools"></a>Средства CLI для YARN

Чтобы использовать инструменты интерфейса командной строки для YARN, необходимо сначала подключиться к кластеру HDInsight с помощью SSH. Укажите сведения `<applicationId>`, `<user-who-started-the-application>`, `<containerId>` и `<worker-node-address>` при выполнении этих команд. Эти журналы можно отобразить в виде обычного текста, запустив одну из указанных ниже команд.

```bash
yarn logs -applicationId <applicationId> -appOwner <user-who-started-the-application>
yarn logs -applicationId <applicationId> -appOwner <user-who-started-the-application> -containerId <containerId> -nodeAddress <worker-node-address>
```

#### <a name="yarn-resourcemanager-ui"></a>Пользовательский интерфейс YARN ResourceManager

Пользовательский интерфейс YARN ResourceManager работает на головном узле кластера. Для доступа к нему можно использовать веб-интерфейс Ambari. Чтобы просмотреть журналы YARN, выполните следующие действия:

1. В браузере перейдите на адрес `https://CLUSTERNAME.azurehdinsight.net`. Параметр CLUSTERNAME нужно заменить именем кластера HDInsight.
2. В списке служб в левой части страницы выберите YARN.
3. В раскрывающемся списке "Быстрые ссылки" выберите один из главных узлов кластера, а затем щелкните **ResourceManager logs** (Журналы Resource Manager). Вы увидите список ссылок на журналы YARN.

## <a name="step-4-forecast-log-volume-storage-sizes-and-costs"></a>Шаг 4. Прогнозирование размера хранилища журналов и затрат

После завершения предыдущих шагов у вас появится представление о типах и объемах файлов журналов, которые создаются кластерами HDInsight.

Далее проанализируйте объем данных журнала в местах хранения ключей журнала за период времени. Например, вы можете анализировать увеличение объема в течение 30, 60 или 90 дней.  Запишите эти сведения в электронную таблицу или используйте другие инструменты, такие как Visual Studio, обозреватель хранилища Azure или Power Query для Excel. Дополнительные сведения см. в статье об [анализе журналов HDInsight](hdinsight-debug-jobs.md).  

Теперь у вас достаточно информации для создания стратегии управления ключевыми журналами.  Используйте электронную таблицу (или другой инструмент) для прогнозирования роста объема журналов и затрат на хранение в Azure.  Также следует учитывать все требования к хранению журналов для набора журналов, которые вы проведете.  Теперь можно повторно прогнозировать будущие затраты на хранение журналов, определив, какие файлы журналов можно удалить (если они есть) и какие журналы следует сохранять и архивировать в менее дорогостоящем хранилище Azure.

## <a name="step-5-determine-log-archive-policies-and-processes"></a>Шаг 5. Определение политик архивации журнала процессов

Определив файлы журналов для удаления, вы можете настроить параметры ведения журнала во многих службах Hadoop для автоматического удаления файлов журнала по истечении заданного периода времени.

Для некоторых файлов журнала можно использовать более экономный подход архивирования файлов журналов. Для Azure Resource Manager журналов действий этот подход можно исследовать с помощью портал Azure.  Настройте архивацию журналов диспетчер ресурсов, щелкнув ссылку **Журнал действий** в портал Azure для своего экземпляра HDInsight.  В верхней части страницы поиска журналов действий выберите пункт меню **Экспорт**, чтобы открыть область **Экспорт журнала действий**.  Укажите подписку, регион, необходимость экспорта в учетную запись хранения и количество дней хранения журналов. В этой же области можно также указать, следует ли экспортировать журналы в концентратор событий.

![Предварительный просмотр журнала действий портал Azure экспорта](./media/hdinsight-log-management/hdi-export-log-files.png)

Кроме того, можно создать сценарий архивации журнала с помощью PowerShell.  Пример сценария PowerShell см. в разделе [Archive Azure Automation logs to Azure Blob Storage](https://gallery.technet.microsoft.com/scriptcenter/Archive-Azure-Automation-898a1aa8) (Архивация журналов службы автоматизации Azure для хранилища BLOB-объектов).

### <a name="accessing-azure-storage-metrics"></a>Доступ к метрикам службы хранилища Azure

Служба хранилища Azure может быть настроена для ведения журнала операций и доступа к хранилищу. Вы можете использовать эти подробные журналы для мониторинга и планирования емкости, а также для аудита запросов на хранение. Зарегистрированная информация включает в себя детали задержки, позволяющие отслеживать и точно настраивать производительность ваших решений.
С помощью пакета SDK для .NET для Hadoop можно просмотреть файлы журналов, созданные для хранилища Azure, в котором хранятся данные для кластера HDInsight.

### <a name="control-the-size-and-number-of-backup-indexes-for-old-log-files"></a>Управление размером и числом индексов резервного копирования для старых файлов журнала

Чтобы контролировать размер и количество хранимых файлов журналов, задайте следующие свойства `RollingFileAppender`:

* `maxFileSize` — это критический размер файла, при котором будет выполнен откат файла. Значение по умолчанию — 10 МБ.
* `maxBackupIndex` указывает количество создаваемых файлов резервных копий, по умолчанию 1.

### <a name="other-log-management-techniques"></a>Другие способы управления журналами

Чтобы избежать недостатка места на диске, можно использовать некоторые средства операционной системы, такие как [logrotate](https://linux.die.net/man/8/logrotate) , для управления обработкой файлов журналов. `logrotate` можно настроить для ежедневного запуска для сжатия файлов журналов и удаления старых файлов. Подход зависит от требований, например, как долго следует хранить файлы на локальных узлах.  

Вы также можете проверить, включено ли ведение журнала отладки для одной или нескольких служб, что значительно увеличивает размер журнала выходных данных.  

Чтобы собирать журналы со всех узлов в централизованном месте, можно создать поток данных, такой как получение всех записей журнала в Solr.

## <a name="next-steps"></a>Дальнейшие действия

* [Monitoring and logging](https://msdn.microsoft.com/library/dn749790.aspx) (Мониторинг и ведение журнала)
* [Доступ к журналам приложений Apache Hadoop YARN в HDInsight под управлением Linux](hdinsight-hadoop-access-yarn-app-logs-linux.md)
* [How to control size of log files for various HDP components?](https://community.hortonworks.com/articles/8882/how-to-control-size-of-log-files-for-various-hdp-c.html) (Как контролировать размер файлов журнала для различных компонентов HDP).
