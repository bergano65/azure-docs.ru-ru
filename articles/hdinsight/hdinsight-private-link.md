---
title: Защита и изоляция кластеров Azure HDInsight с помощью частной ссылки (Предварительная версия)
description: Узнайте, как изолировать кластеры Azure HDInsight в виртуальной сети с помощью частной ссылки Azure.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: conceptual
ms.date: 10/15/2020
ms.openlocfilehash: fac26c616c977eedc466f004a9455297ec995fb8
ms.sourcegitcommit: 9eda79ea41c60d58a4ceab63d424d6866b38b82d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/30/2020
ms.locfileid: "96352547"
---
# <a name="secure-and-isolate-azure-hdinsight-clusters-with-private-link-preview"></a>Защита и изоляция кластеров Azure HDInsight с помощью частной ссылки (Предварительная версия)

В [архитектуре виртуальной сети Azure hdinsight по умолчанию](./hdinsight-virtual-network-architecture.md)поставщик ресурсов HDINSIGHT (RP) взаимодействует с кластером, используя общедоступные IP-адреса. Для некоторых сценариев требуется полная изоляция сети без использования общедоступных IP-адресов. В этой статье вы узнаете о дополнительных элементах управления, которые можно использовать для создания частного кластера HDInsight. Сведения о том, как ограничить трафик к кластеру и из него без полной изоляции сети, см. [в разделе Управление сетевым трафиком в Azure HDInsight](./control-network-traffic.md).

Вы можете создать частные кластеры HDInsight, настроив определенные свойства сети в шаблоне Azure Resource Manager (ARM). Для создания частных кластеров HDInsight можно использовать два свойства:

* Удалите общедоступные IP-адреса, задав `resourceProviderConnection` для параметра значение исходящие.
* Включите частную связь Azure и используйте [частные конечные точки](../private-link/private-endpoint-overview.md) , установив `privateLink` для параметра значение включено.

## <a name="remove-public-ip-addresses"></a>Удаление общедоступных IP-адресов

По умолчанию HDInsight RP использует *входящее* подключение к кластеру с помощью общедоступных IP-адресов. Если `resourceProviderConnection` для свойства Network задано значение *Исходящие*, то он обращается к RP HDInsight, чтобы подключения всегда инициирулись из кластера в RP. Без входящего подключения не требуется наличие тегов входящей службы или общедоступных IP-адресов.

Базовые подсистемы балансировки нагрузки, используемые в архитектуре виртуальной сети по умолчанию, автоматически предоставляют общедоступный NAT (преобразование сетевых адресов) для доступа к необходимым исходящим зависимостям, таким как HDInsight RP. Если вы хотите ограничить исходящие подключения к общедоступному Интернету, можно [настроить брандмауэр](./hdinsight-restrict-outbound-traffic.md), но это не обязательно.

Настройка `resourceProviderConnection` для исходящего трафика также позволяет получить доступ к ресурсам кластера, таким как Azure Data Lake Storage 2-го поколения или External метахранилища, с помощью частных конечных точек. Использование частных конечных точек для этих ресурсов не мандетори, но если вы планируете использовать частные конечные точки для этих ресурсов, необходимо настроить частные конечные точки и записи DNS, `before` создаваемые кластером HDInsight. Мы рекомендуем создавать и предоставлять все необходимые внешние базы данных SQL, такие как Apache Ranger, Ambari, Oozie и Hive метахранилища, во время создания кластера. Требование заключается в том, что все эти ресурсы должны быть доступны из подсети кластера через собственную закрытую конечную точку или иным образом.

Использование частных конечных точек для Azure Key Vault не поддерживается. Если вы используете Azure Key Vault для шифрования неактивных CMK, конечная точка Azure Key Vault должна быть доступна из подсети HDInsight без закрытой конечной точки.

На следующей схеме показано, как может выглядеть возможная архитектура виртуальной сети HDInsight, если `resourceProviderConnection` для параметра задано значение исходящие:

:::image type="content" source="media/hdinsight-private-link/outbound-resource-provider-connection-only.png" alt-text="Схема архитектуры HDInsight с использованием подключения поставщика исходящих ресурсов":::

После создания кластера следует настроить правильное разрешение DNS. В общедоступной зоне DNS, управляемой Azure, создается следующее каноническое имя записи DNS (CNAME): `azurehdinsight.net` .

```dns
<clustername>    CNAME    <clustername>-int
```

Чтобы получить доступ к кластеру с помощью полных доменных имен кластера, можно либо использовать частные IP-адреса внутренней подсистемы балансировки нагрузки напрямую, либо использовать собственную зону Частная зона DNS для переопределения конечных точек кластера в соответствии с вашими потребностями. Например, можно использовать зону Частная зона DNS `azurehdinsight.net` . и при необходимости добавьте свои частные IP-адреса:

```dns
<clustername>        A   10.0.0.1
<clustername-ssh>    A   10.0.0.2
```

## <a name="enable-private-link"></a>Включить закрытую ссылку

Частная ссылка, которая отключена по умолчанию, требует обширных сведений о сети для настройки определяемых пользователем маршрутов (UDR) и правил брандмауэра перед созданием кластера. Использование этого параметра является необязательным, но оно доступно только в том случае, если `resourceProviderConnection` для свойства Network задано значение *Исходящие* , как описано в предыдущем разделе.

Если параметр `privateLink` *включен*, создаются внутренние подсистемы [балансировки нагрузки](../load-balancer/load-balancer-overview.md) (SLB), а для каждого SLB подготавливается служба частной связи Azure. Служба частной связи позволяет получить доступ к кластеру HDInsight из частных конечных точек.

Стандартные подсистемы балансировки нагрузки не обеспечивают автоматическое предоставление [общедоступного исходящего трафика NAT](../load-balancer/load-balancer-outbound-connections.md) , такого как базовые подсистемы балансировки нагрузки. Для исходящих зависимостей необходимо предоставить собственное решение NAT, например [NAT виртуальной сети](../virtual-network/nat-overview.md) или [брандмауэр](./hdinsight-restrict-outbound-traffic.md). Кластеру HDInsight по-прежнему требуется доступ к его исходящим зависимостям. Если эти исходящие зависимости не допускаются, создание кластера может завершиться ошибкой.

### <a name="prepare-your-environment"></a>Подготовка среды

Для сукцессгфулл создания служб частной связи необходимо явно [отключить сетевые политики для службы частных ссылок](../private-link/disable-private-link-service-network-policy.md).

На следующей схеме показан пример конфигурации сети, необходимой перед созданием кластера. В этом примере весь исходящий трафик [принудительно](../firewall/forced-tunneling.md) передается в брандмауэр Azure с помощью UDR, а необходимые Исходящие зависимости должны быть разрешены в брандмауэре перед созданием кластера. Для кластеров Корпоративный пакет безопасности сетевое подключение к Azure Active Directoryным службам домена может предоставляться через пиринг виртуальных сетей.

:::image type="content" source="media/hdinsight-private-link/before-cluster-creation.png" alt-text="Схема среды частной связи перед созданием кластера":::

После настройки сети можно создать кластер с подключением к исходящему поставщику ресурсов и включить закрытую связь, как показано на следующем рисунке. В этой конфигурации для каждой стандартной подсистемы балансировки нагрузки подготавливается общедоступные IP-адреса и служба частных ссылок.

:::image type="content" source="media/hdinsight-private-link/after-cluster-creation.png" alt-text="Схема среды частной связи после создания кластера":::

### <a name="access-a-private-cluster"></a>Доступ к частному кластеру

Для доступа к частным кластерам можно использовать частные IP-адреса внутренней подсистемы балансировки нагрузки напрямую или использовать расширения DNS частной связи и частные конечные точки. Если `privateLink` для параметра задано значение включено, можно создать собственные частные конечные точки и настроить разрешение DNS с помощью частных зон DNS.

Записи частной ссылки, созданные в общедоступной зоне DNS под управлением Azure `azurehdinsight.net` , следующие:

```dns
<clustername>        CNAME    <clustername>.privatelink
<clustername>-int    CNAME    <clustername>-int.privatelink
<clustername>-ssh    CNAME    <clustername>-ssh.privatelink
```

На следующем рисунке показан пример закрытых записей DNS, необходимых для доступа к кластеру из виртуальной сети, которая не является одноранговым или не имеет прямой информации о подсистемах балансировки нагрузки кластера. Вы можете использовать частную зону Azure для переопределения `*.privatelink.azurehdinsight.net` полных доменных имен и разрешения на IP-адреса частных конечных точек.

:::image type="content" source="media/hdinsight-private-link/access-private-clusters.png" alt-text="Схема архитектуры частной связи":::

## <a name="how-to-create-clusters"></a>Как создавать кластеры?
### <a name="use-arm-template-properties"></a>Использование свойств шаблона ARM

В следующем фрагменте кода JSON содержатся два свойства сети, которые необходимо настроить в шаблоне ARM для создания частного кластера HDInsight.

```json
networkProperties: {
    "resourceProviderConnection": "Inbound" | "Outbound",
    "privateLink": "Enabled" | "Disabled"
}
```

Полный шаблон с множеством функций безопасности в HDInsight Enterprise, включая частную ссылку, см. в статье [шаблон безопасности в hdinsight Enterprise](https://github.com/Azure-Samples/hdinsight-enterprise-security/tree/main/ESP-HIB-PL-Template).

### <a name="use-azure-powershell"></a>Использование Azure PowerShell

Чтобы использовать PowerShell, см. пример [здесь](/powershell/module/az.hdinsight/new-azhdinsightcluster?view=azps-5.1.0#example-4--create-an-azure-hdinsight-cluster-with-relay-outbound-and-private-link-feature).

### <a name="use-azure-cli"></a>Использование Azure CLI
Чтобы использовать Azure CLI, см. пример [здесь](/cli/azure/hdinsight?view=azure-cli-latest#az_hdinsight_create-examples).

## <a name="next-steps"></a>Дальнейшие действия

* [Корпоративный пакет безопасности для Azure HDInsight](enterprise-security-package.md)
* [Общие сведения и рекомендации по корпоративной безопасности в Azure HDInsight](./domain-joined/general-guidelines.md)