---
title: Подключение Azure HDInsight к локальной сети
description: Узнайте, как создать кластер HDInsight в виртуальной сети Azure, а затем подключить его к локальной сети. Узнайте, как настроить разрешение имен между HDInsight и локальной сетью с помощью DNS-сервера.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.custom: hdinsightactive
ms.topic: conceptual
ms.date: 04/04/2019
ms.openlocfilehash: 52fe8c05101f9647549acec276f0bdb9fa52d1c7
ms.sourcegitcommit: c174d408a5522b58160e17a87d2b6ef4482a6694
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2019
ms.locfileid: "59256810"
---
# <a name="connect-hdinsight-to-your-on-premises-network"></a>Подключение HDInsight к локальной сети

Узнайте, как подключить HDInsight к локальной сети с помощью виртуальной сети Azure и VPN-шлюза. В этом документе содержатся следующие сведения о планировании:

* Использование HDInsight в виртуальной сети Azure, которая подключается к локальной сети.
* Настройка разрешения DNS-имен между виртуальной и локальной сетями.
* Настройка групп безопасности сети для ограничения доступа к HDInsight из Интернета.
* Порты, предоставляемые HDInsight в виртуальной сети.

## <a name="overview"></a>Обзор

Чтобы разрешить HDInsight и ресурсам в присоединенной сети связываться по имени, необходимо выполнить такие действия:

* Создайте виртуальную сеть Azure.
* Создать пользовательский DNS-сервер в виртуальной сети Azure.
* Настроить виртуальную сеть для использования пользовательского DNS-сервера вместо рекурсивного сопоставителя Azure по умолчанию.
* Настроить переадресацию между пользовательским и локальным DNS-сервером.

Такая конфигурация позволяет следующие действия:

* Переадресовывать запросы полных доменных имен с DNS-суффиксом __для виртуальных сетей__ к пользовательскому DNS-серверу. Затем пользовательский DNS-сервер переадресовывает эти запросы к рекурсивному сопоставителю Azure, который вернет IP-адрес.
* Переадресовывать остальные запросы на локальный DNS-сервер. Даже запросы к общедоступным интернет-ресурсам, таким как microsoft.com, переадресовываются на локальный DNS-сервер для разрешения имен.

На следующей схеме зеленые линии — это запросы ресурсов, которые заканчиваются на DNS-суффикс виртуальной сети. Синие линии — это запросы ресурсов в локальной сети или в общедоступном Интернете.

![Схема разрешения DNS-запросов в конфигурации, используемая в этом документе](./media/connect-on-premises-network/on-premises-to-cloud-dns.png)

## <a name="prerequisites"></a>Технические условия

* Клиент SSH. Дополнительные сведения см. в руководстве по [подключению к HDInsight (Apache Hadoop) с помощью SSH](./hdinsight-hadoop-linux-use-ssh-unix.md).
* Если с помощью PowerShell, вам потребуется [AZ модуля](https://docs.microsoft.com/powershell/azure/overview).
* Если желающим использовать Azure CLI и вы еще не установили его, см. в разделе [установите Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli).

## <a name="create-virtual-network-configuration"></a>Создайте конфигурацию виртуальной сети

Дополнительные сведения о том, как создать виртуальную сеть Azure, подключенную к локальной сети, см. в следующих документах:

* [Использование портала Azure](../vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal.md)
* [Использование Azure PowerShell](../vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell.md)
* [Использование интерфейса командной строки Azure](../vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-cli.md)

## <a name="create-custom-dns-server"></a>Создание пользовательского DNS-сервера

> [!IMPORTANT]  
> Перед установкой HDInsight в виртуальную сеть необходимо создать DNS-сервер и настроить его.

В следующих шагах описывается, как с помощью [портала Azure](https://portal.azure.com) создать виртуальную машину Azure. Другие способы создания виртуальных машин см. в статьях [Создание виртуальной машины Linux с помощью Azure CLI](../virtual-machines/linux/quick-create-cli.md) и [Создание виртуальной машины Linux с помощью портала Azure](../virtual-machines/linux/quick-create-powershell.md).  Чтобы создать виртуальную машину Linux, использующую программное обеспечение DNS [Bind](https://www.isc.org/downloads/bind/), выполните следующие действия:

1. Войдите на [портале Azure](https://portal.azure.com).
  
2. В меню слева, перейдите к **+ создать ресурс** > **вычислений** > **Ubuntu Server 18.04 LTS**.

    ![Создание виртуальной машины Ubuntu](./media/connect-on-premises-network/create-ubuntu-vm.png)

3. На вкладке __Основные сведения__ задайте следующие параметры.  
  
    | Поле | Значение |
    | --- | --- |
    |Подписка |Выберите соответствующую подписку.|
    |Группа ресурсов |Выберите группу ресурсов, которая содержит виртуальную сеть, созданную ранее.|
    |Имя виртуальной машины | Введите понятное имя, идентифицирующее виртуальную машину. В этом примере используется **DNSProxy**.|
    |Регион | Выберите тот же регион, что и для созданной ранее виртуальной сети.  Не во всех регионах доступны виртуальные машины всех размеров.  |
    |Параметры доступности |  Выберите нужный уровень доступности.  Azure предлагает широкий набор параметров для управления доступностью и устойчивостью для приложений.  Сконструируйте свое решение для использования реплицированных виртуальных машин в зонах доступности или группах доступности, чтобы защитить приложения и данные от сбоев центра обработки данных и мероприятий по обслуживанию. В этом примере используется параметр **Избыточность инфраструктуры не требуется**. |
    |Образ — | Оставьте **LTS Ubuntu Server 18.04**. |
    |Authentication type (Тип проверки подлинности) | __Пароль__ или __открытый ключ SSH__: метод проверки подлинности для учетной записи SSH. Мы рекомендуем использовать открытые ключи, так как они обеспечивают повышенную безопасность. В этом примере используется **пароль**.  Дополнительные сведения см.в статье [Как создать и использовать пару из открытого и закрытого ключей SSH для виртуальных машин Linux в Azure](../virtual-machines/linux/mac-create-ssh-keys.md).|
    |Имя пользователя |Введите имя пользователя администратора для виртуальной машины.  В этом примере используется **sshuser**.|
    |Пароль или открытый ключ SSH | Соответствующее поле определяется выбранным **типом проверки подлинности**.  Введите соответствующее значение.|
    |Общедоступные входящие порты|Выберите **Разрешить выбранные порты**. Затем выберите **SSH (22)** из **выберите входящие порты** стрелку раскрывающегося списка.|

    ![Базовая конфигурация виртуальной машины](./media/connect-on-premises-network/vm-basics.png)

    Оставьте значения других параметров по умолчанию и откройте вкладку **Сеть**.

4. На вкладке **Сеть** введите следующие сведения.

    | Поле | Значение |
    | --- | --- |
    |Виртуальная сеть | Выберите созданную ранее виртуальную сеть.|
    |Подсеть | Выберите подсеть по умолчанию для созданной ранее виртуальной сети. __Не выбирайте__ подсеть, используемую VPN-шлюзом.|
    |Общедоступный IP-адрес | Используйте значение заполняется автоматически.  |

    ![Параметры виртуальной сети](./media/connect-on-premises-network/virtual-network-settings.png)

    Оставьте значения других параметров по умолчанию и откройте вкладку **Проверить и создать**.

5. На вкладке **Просмотр и создание** выберите **Создать** для создания виртуальной машины.

### <a name="review-ip-addresses"></a>Проверка IP-адресов
После создания виртуальной машины вы получите уведомление **Развертывание прошло успешно** с кнопкой **Перейти к ресурсу**.  Выберите **Перейти к ресурсу**, чтобы перейти к новой виртуальной машине.  Из представления по умолчанию для новой виртуальной машины выполните следующие действия, чтобы определить связанные IP-адреса.

1. В разделе **Параметры** выберите **Свойства**.

2. Запишите значения **ОБЩЕДОСТУПНЫЙ IP-АДРЕС/ИМЯ DNS** и **ЧАСТНЫЙ IP-АДРЕС**. Они вам еще пригодятся.

   ![Общедоступные и частные IP-адреса](./media/connect-on-premises-network/vm-ip-addresses.png)

### <a name="install-and-configure-bind-dns-software"></a>Установка и настройка Bind (программное обеспечение DNS)

1. Используйте SSH для подключения к __общедоступному IP-адресу__ виртуальной машины. Замените `sshuser` с учетной записью пользователя SSH, указанные при создании виртуальной Машины. В следующем примере устанавливается подключение к виртуальной машине по адресу 40.68.254.142:

    ```bash
    ssh sshuser@40.68.254.142
    ```

2. Чтобы установить Bind, используйте следующие команды из сеанса SSH:

    ```bash
    sudo apt-get update -y
    sudo apt-get install bind9 -y
    ```

3. Чтобы настроить Bind на переадресацию запросов разрешения имен DNS-сервера в локальной среде, используйте следующий текст в качестве содержимого `/etc/bind/named.conf.options` файла:

        acl goodclients {
            10.0.0.0/16; # Replace with the IP address range of the virtual network
            10.1.0.0/16; # Replace with the IP address range of the on-premises network
            localhost;
            localnets;
        };

        options {
                directory "/var/cache/bind";

                recursion yes;

                allow-query { goodclients; };

                forwarders {
                192.168.0.1; # Replace with the IP address of the on-premises DNS server
                };

                dnssec-validation auto;

                auth-nxdomain no;    # conform to RFC1035
                listen-on { any; };
        };

    > [!IMPORTANT]  
    > Замените значения в разделе `goodclients` следующим диапазоном IP-адресов виртуальной и локальной сети. Этот раздел определяет адреса, по которым этот DNS-сервер принимает запросы.
    >
    > Замените запись `192.168.0.1` в разделе `forwarders` IP-адресом локального DNS-сервера. Эта запись направляет DNS-запросы к локальному DNS-серверу для разрешения.

    Чтобы изменить этот файл, используйте следующую команду:

    ```bash
    sudo nano /etc/bind/named.conf.options
    ```

    Чтобы сохранить файл, нажмите клавиши __CTRL+X__, затем — __Y__ и __ВВОД__.

4. В сеансе SSH используйте следующую команду:

    ```bash
    hostname -f
    ```

    Эта команда возвращает значение следующего вида:

    ```output
    dnsproxy.icb0d0thtw0ebifqt0g1jycdxd.ex.internal.cloudapp.net
    ```

    Текст `icb0d0thtw0ebifqt0g1jycdxd.ex.internal.cloudapp.net` — это __DNS-суффикс__ для виртуальной сети. Сохраните это значение, так как оно будет использовано позже.

5. Чтобы настроить Bind для разрешения DNS-имен ресурсов в виртуальной сети, в качестве содержимого файла `/etc/bind/named.conf.local` добавьте следующий текст:

        // Replace the following with the DNS suffix for your virtual network
        zone "icb0d0thtw0ebifqt0g1jycdxd.ex.internal.cloudapp.net" {
            type forward;
            forwarders {168.63.129.16;}; # The Azure recursive resolver
        };

    > [!IMPORTANT]  
    > Текст `icb0d0thtw0ebifqt0g1jycdxd.ex.internal.cloudapp.net` нужно заменить DNS-суффиксом, полученным ранее.

    Чтобы изменить этот файл, используйте следующую команду:

    ```bash
    sudo nano /etc/bind/named.conf.local
    ```

    Чтобы сохранить файл, нажмите клавиши __CTRL+X__, затем — __Y__ и __ВВОД__.

6. Чтобы запустить Bind, используйте следующую команду:

    ```bash
    sudo service bind9 restart
    ```

7. Чтобы убедиться, что привязка может разрешать имена ресурсов в локальной сети, используйте следующие команды:

    ```bash
    sudo apt install dnsutils
    nslookup dns.mynetwork.net 10.0.0.4
    ```

    > [!IMPORTANT]  
    > Замените `dns.mynetwork.net` полным доменным именем (FQDN) ресурса в локальной сети.
    >
    > Замените `10.0.0.4` __внутренним IP-адресом__ пользовательского DNS-сервера в виртуальной сети.

    Ответ будет выглядеть следующим образом:

    ```output
    Server:         10.0.0.4
    Address:        10.0.0.4#53

    Non-authoritative answer:
    Name:   dns.mynetwork.net
    Address: 192.168.0.4
    ```

## <a name="configure-virtual-network-to-use-the-custom-dns-server"></a>Настроить виртуальную сеть для использования пользовательского DNS-сервера

Чтобы настроить виртуальную сеть для использования с пользовательским DNS-сервером вместо рекурсивного сопоставителя Azure, сделайте следующее на [портале Azure](https://portal.azure.com).

1. В меню слева, перейдите к **все службы** > **сети** > **виртуальные сети**.

2. Выберите свою виртуальную сеть из списка, чтобы открыть представление по умолчанию для виртуальной сети.  

3. В представлении по умолчанию в разделе **Параметры** выберите **DNS-серверы**.  

4. Выберите __Пользовательский__ и введите **ЧАСТНЫЙ IP-АДРЕС** пользовательского DNS-сервера.   

5. Щелкните __Сохранить__.  <br />  

    ![Задание пользовательского DNS-сервера для сети](./media/connect-on-premises-network/configure-custom-dns.png)

## <a name="configure-on-premises-dns-server"></a>Настройте локальный DNS-сервер

В предыдущем разделе пользовательский DNS-сервер настраивался для переадресации запросов на локальный DNS-сервер. Теперь необходимо настроить локальный DNS-сервер на перенаправление запросов на пользовательский DNS-сервер.

Конкретные указания о настройке DNS-сервера см. в документации по программному обеспечению конкретного DNS-сервера. Ищите указания по настройке __сервера условной пересылки__.

Сервер условной пересылки только переадресовывает запросы по определенным DNS-суффиксам. В этом случае необходимо настроить сервер пересылки для DNS-суффикса виртуальной сети. Запросы для этого суффикса должны переадресовываться на IP-адрес пользовательского DNS-сервера. 

Далее представлен пример конфигурации сервера условной пересылки для программного обеспечения DNS **Bind**:

    zone "icb0d0thtw0ebifqt0g1jycdxd.ex.internal.cloudapp.net" {
        type forward;
        forwarders {10.0.0.4;}; # The custom DNS server's internal IP address
    };

Дополнительные сведения об использовании DNS в **Windows Server 2016** см. в документации по [Add-DnsServerConditionalForwarderZone](https://technet.microsoft.com/itpro/powershell/windows/dnsserver/add-dnsserverconditionalforwarderzone).

Настроив локальный DNS-сервер, можно использовать команду `nslookup` из локальной сети, чтобы убедиться, что можно разрешать имена в виртуальной сети. Следующий пример: 

```bash
nslookup dnsproxy.icb0d0thtw0ebifqt0g1jycdxd.ex.internal.cloudapp.net 196.168.0.4
```

В этом примере локальный DNS-сервер по адресу 196.168.0.4 используется для разрешения имен пользовательского DNS-сервера. Замените IP-адрес IP-адресом локального DNS-сервера. Замените адрес `dnsproxy` полным доменным именем пользовательского DNS-сервера.

## <a name="optional-control-network-traffic"></a>Необязательно: Управление сетевым трафиком

Для управления сетевым трафиком можно использовать группы безопасности сети или определяемые пользователем маршруты. Группы безопасности сети позволяют фильтровать входящий и исходящий трафик, а также разрешать или запрещать его. Определяемые пользователем маршруты позволяют управлять потоком трафика между ресурсами в виртуальной сети, Интернете и локальной сети.

> [!WARNING]  
> Для HDInsight требуется входящий доступ с определенных IP-адресов в облаке Azure и неограниченный исходящий доступ. При использовании группы безопасности сети или определяемых пользователем маршрутов для управления трафиком, необходимо выполнить следующее:

1. Найдите IP-адреса расположения, которое содержит виртуальную сеть. Список требуемых IP-адресов по расположениям см. в [этом разделе](./hdinsight-extend-hadoop-virtual-network.md#hdinsight-ip).

2. Для IP-адресов, определенных на шаге 1, необходимо разрешить входящий трафик.

   * Если вы используете __NSG__: разрешите __входящий__ трафик через порт __443__ для этих IP-адресов.
   * Если вы используете __UDR__: задайте в качестве типа маршрута для __следующего прыжка__ значение __Интернет__ для IP-адресов.

Примеры использования Azure PowerShell и Azure CLI для создания групп безопасности см. в статье [Расширение возможностей HDInsight с помощью виртуальной сети Azure](./hdinsight-extend-hadoop-virtual-network.md#hdinsight-nsg).

## <a name="create-the-hdinsight-cluster"></a>Создание кластера HDInsight

> [!WARNING]  
> Перед установкой HDInsight в виртуальной сети, необходимо настроить пользовательский DNS-сервер.

Следуйте указаниям в документе [Создание кластеров под управлением Linux в HDInsight с помощью портала Azure](./hdinsight-hadoop-create-linux-clusters-portal.md), чтобы создать кластер HDInsight.

> [!WARNING]  
> * При создании кластера необходимо выбрать расположение, которое содержит вашу виртуальную сеть.
> * В разделе конфигурации __Дополнительные параметры__ нужно выбрать виртуальную сеть и подсеть, созданные ранее.

## <a name="connecting-to-hdinsight"></a>Подключение к HDInsight

В большей части документации по HDInsight предполагается, что у вас есть доступ к кластеру через Интернет. Например, что вы можете подключиться к кластеру по адресу `https://CLUSTERNAME.azurehdinsight.net`. Этот адрес использует общедоступный шлюз, который будет недоступен, если вы использовали группы безопасности сети или определяемые пользователем маршруты для ограничения доступа из Интернета.

В некоторых документах также указывается `headnodehost` при подключении к кластеру из сеанса SSH. Этот адрес доступен только узлам в кластере и не может использоваться в клиентах, подключенных через виртуальную сеть.

Для прямого подключения к HDInsight через виртуальную сеть сделайте следующее:

1. Чтобы найти внутренние полные доменные имена узлов кластера HDInsight, используйте один из следующих методов:

    ```powershell
    $resourceGroupName = "The resource group that contains the virtual network used with HDInsight"

    $clusterNICs = Get-AzNetworkInterface -ResourceGroupName $resourceGroupName | where-object {$_.Name -like "*node*"}

    $nodes = @()
    foreach($nic in $clusterNICs) {
        $node = new-object System.Object
        $node | add-member -MemberType NoteProperty -name "Type" -value $nic.Name.Split('-')[1]
        $node | add-member -MemberType NoteProperty -name "InternalIP" -value $nic.IpConfigurations.PrivateIpAddress
        $node | add-member -MemberType NoteProperty -name "InternalFQDN" -value $nic.DnsSettings.InternalFqdn
        $nodes += $node
    }
    $nodes | sort-object Type
    ```

    ```azurecli
    az network nic list --resource-group <resourcegroupname> --output table --query "[?contains(name,'node')].{NICname:name,InternalIP:ipConfigurations[0].privateIpAddress,InternalFQDN:dnsSettings.internalFqdn}"
    ```

2. Чтобы определить порт, через который доступна служба, см. статью [Порты, используемые службами Hadoop в HDInsight](./hdinsight-hadoop-port-settings-for-services.md).

    > [!IMPORTANT]  
    > Некоторые службы, размещенные на головных узлах, одновременно активны только на одном узле. Если при попытке доступа к службе на одном головном узле происходит сбой, переключитесь к другому головному узлу.
    >
    > Например, Apache Ambari одновременно активен только на одном головном узле. Если при попытке доступа к Ambari на одном головном узле он возвращает ошибку 404, значит он выполняется на другом головном узле.

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения об использовании HDInsight в виртуальной сети см. в статье [Расширение возможностей HDInsight с помощью виртуальной сети Azure](./hdinsight-extend-hadoop-virtual-network.md).

* Дополнительные сведения о виртуальных сетях Azure см. в статье [Виртуальная сеть Azure](../virtual-network/virtual-networks-overview.md).

* Дополнительные сведения о группах безопасности сети см. в статье [Фильтрация сетевого трафика с помощью групп безопасности сети](../virtual-network/security-overview.md).

* Дополнительные сведения о пользовательских маршрутах см. в статье [User-defined routes and IP forwarding](../virtual-network/virtual-networks-udr-overview.md) (Определяемые пользователем маршруты и IP-пересылка).
