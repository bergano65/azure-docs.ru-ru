---
title: Устранение ошибок неисправного шлюза — шлюз приложений Azure
description: Из этой статьи вы узнаете, как устранять ошибки 502 шлюза приложений.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 11/14/2019
ms.author: amsriva
ms.openlocfilehash: baf1eccdd6fe910bd98e8b39ef29b7bd8e88a7d5
ms.sourcegitcommit: b1a8f3ab79c605684336c6e9a45ef2334200844b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/13/2019
ms.locfileid: "74048157"
---
# <a name="troubleshooting-bad-gateway-errors-in-application-gateway"></a>Устранение ошибок "Недопустимый шлюз" в шлюзе приложений

Узнайте, как устранить ошибки неисправного шлюза (502), полученные при использовании шлюза приложений Azure.

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="overview"></a>Обзор

После настройки шлюза приложений может появиться сообщение об ошибке "сервер: 502-веб-сервер получил недопустимый ответ при выступающем в качестве шлюза или прокси-сервера". Эта ошибка может возникать по следующим основным причинам.

* NSG, UDR или Custom DNS блокирует доступ к членам серверного пула.
* Серверные виртуальные машины или экземпляры масштабируемого набора виртуальных машин не отвечают на зонд работоспособности по умолчанию.
* недопустимая или неправильная конфигурация пользовательских проб работоспособности;
* Пул серверной части шлюза приложений Azure [не настроен или пуст](#empty-backendaddresspool).
* в [наборе масштабирования виртуальных машин нет работоспособных](#unhealthy-instances-in-backendaddresspool) экземпляров или виртуальных машин;
* для пользовательских запросов [истекло время ожидания или возникли проблемы с подключением](#request-time-out).

## <a name="network-security-group-user-defined-route-or-custom-dns-issue"></a>Проблема группы безопасности сети, определенного пользователем маршрута или пользовательской службы DNS

### <a name="cause"></a>Причина:

Если доступ к серверной части заблокирован из-за NSG, UDR или настраиваемой службы DNS, экземпляры шлюза приложений не могут подключиться к внутреннему пулу. Это приводит к сбоям проверки, что приводит к ошибкам 502.

NSG/UDR может присутствовать в подсети шлюза приложений или в подсети, в которой развернуты виртуальные машины приложения.

Аналогично, наличие настраиваемой службы DNS в виртуальной сети также может вызвать проблемы. Полное доменное имя, используемое для членов внутреннего пула, может неправильно разрешаться пользовательским DNS-сервером для виртуальной сети.

### <a name="solution"></a>Решение

Проверьте конфигурацию NSG, UDR и DNS, сделав следующее:

* Проверьте группы безопасности сети, связанные с подсетью шлюза приложений. Убедитесь, что обмен данными с серверной частью не заблокирован.
* Проверьте UDR, связанные с подсетью шлюза приложений. Убедитесь, что UDR не направляет трафик из внутренней подсети. Например, проверьте маршрутизацию на виртуальные сетевые устройства или маршруты по умолчанию, объявляемые в подсети шлюза приложений через ExpressRoute или VPN.

```azurepowershell
$vnet = Get-AzVirtualNetwork -Name vnetName -ResourceGroupName rgName
Get-AzVirtualNetworkSubnetConfig -Name appGwSubnet -VirtualNetwork $vnet
```

* Проверьте действующую NSG и маршрут с серверной виртуальной машиной.

```azurepowershell
Get-AzEffectiveNetworkSecurityGroup -NetworkInterfaceName nic1 -ResourceGroupName testrg
Get-AzEffectiveRouteTable -NetworkInterfaceName nic1 -ResourceGroupName testrg
```

* Проверьте наличие пользовательской службы DNS в виртуальной сети. Службу DNS можно проверить, просмотрев подробности свойств виртуальной сети в выходных данных.

```json
Get-AzVirtualNetwork -Name vnetName -ResourceGroupName rgName 
DhcpOptions            : {
                           "DnsServers": [
                             "x.x.x.x"
                           ]
                         }
```
При наличии убедитесь, что DNS-сервер может правильно разрешить полное доменное имя участника серверного пула.

## <a name="problems-with-default-health-probe"></a>Проблемы со стандартной пробой работоспособности

### <a name="cause"></a>Причина:

ошибки 502 также могут быть часто индикаторами, что проба работоспособности по умолчанию не может связаться с внутренними виртуальными машинами.

При подготовке экземпляра шлюза приложений автоматически настраивается проверка работоспособности по умолчанию для каждого BackendAddressPool с помощью свойств BackendHttpSetting. Пользователю ничего не нужно вводить для настройки этой пробы. В частности, при настройке правила балансировки нагрузки между BackendHttpSetting и BackendAddressPool устанавливается связь. Для каждой из этих связей настраивается проверка по умолчанию, и шлюз приложений запускает периодическую проверку работоспособности подключения к каждому экземпляру в BackendAddressPool на порте, указанном в элементе BackendHttpSetting. 

В следующей таблице перечислены значения, связанные с зондом работоспособности по умолчанию.

| Свойства проверки | Значение | ОПИСАНИЕ |
| --- | --- | --- |
| URL-адрес проверки |`http://127.0.0.1/` |URL-адрес |
| Интервал |30 |Интервал проверки в секундах |
| Время ожидания |30 |Время ожидания проверки в секундах |
| Пороговое значение сбоя |3 |Количество повторных попыток проверки. Сервер внутреннего пула считается неисправным, когда количество повторных неудачных попыток проверки достигает порогового значения сбоя. |

### <a name="solution"></a>Решение

* Убедитесь, что стандартный сайт настроен и ожидает передачи данных по адресу 127.0.0.1.
* Если в параметре BackendHttpSetting задан порт, отличный от 80, на стандартном сайте нужно настроить ожидание передачи данных через этот порт.
* Вызов к `http://127.0.0.1:port` должен вернуть код результата HTTP 200. Это должно быть возвращено в течение 30-секундного периода ожидания.
* Убедитесь, что настроенный порт открыт и в нем нет правил брандмауэра или групп безопасности сети Azure, которые блокируют входящий или исходящий трафик на настроенном порту.
* Если классические виртуальные машины Azure или облачная служба используются с полным доменным именем или общедоступным IP-адресом, убедитесь, что соответствующая [Конечная точка](../virtual-machines/windows/classic/setup-endpoints.md?toc=%2fazure%2fapplication-gateway%2ftoc.json) открыта.
* Если виртуальная машина настроена с помощью Azure Resource Manager и находится за пределами виртуальной сети, в которой развернут шлюз приложений, [Группа безопасности сети](../virtual-network/security-overview.md) должна быть настроена для разрешения доступа к нужному порту.

## <a name="problems-with-custom-health-probe"></a>Проблемы с пользовательскими пробами работоспособности

### <a name="cause"></a>Причина:

Пользовательские пробы работоспособности более гибкие по сравнению со стандартными. При использовании пользовательских зондов можно настроить интервал пробы, URL-адрес, путь для проверки и количество неудачных откликов, которые следует принять, прежде чем пометить экземпляр пула серверной части как неработоспособный.

Добавляются следующие дополнительные свойства:

| Свойства проверки | ОПИСАНИЕ |
| --- | --- |
| имя |Имя проверки. Это имя используется для указания проверки в параметрах HTTP внутреннего сервера |
| Протокол |Протокол, используемый для проверки. Проба использует протокол, определенный в параметрах HTTP серверной части. |
| Узел |Имя узла для проверки. Применяется, только если в шлюзе приложений настроено несколько сайтов. (То есть указывается не имя узла виртуальной машины.) |
| Путь |Относительный путь проверки. Путь должен начинаться с "/". Проба отправляется по адресу \<протокол\>://\<узел\>:\<порт\>\<путь\>. |
| Интервал |Интервал проверки в секундах. Интервал времени между двумя последовательными проверками. |
| Время ожидания |Время ожидания проверки в секундах. Если в течение этого времени ожидания не получен допустимый ответ, проба помечается как неудачный. |
| Пороговое значение сбоя |Количество повторных попыток проверки. Сервер внутреннего пула считается неисправным, когда количество повторных неудачных попыток проверки достигает порогового значения сбоя. |

### <a name="solution"></a>Решение

Настройте пользовательскую пробу производительности правильно, как описано в таблице выше. Кроме действий по устранению неполадок, описанных выше, требуется соблюдение следующих условий:

* проба указана правильно, согласно [руководству](application-gateway-create-probe-ps.md);
* Если шлюз приложений настроен для одного сайта, по умолчанию имя узла должно быть указано как `127.0.0.1`, если иное не настроено в пользовательской зонде.
* Убедитесь, что вызов к http://\<узел\>:\<порт\>\<путь\> возвращает HTTP-код результата 200.
* Убедитесь, что интервал, время ожидания и Унхеалтисрешолд находятся в допустимых диапазонах.
* При использовании зонда HTTPS убедитесь, что внутренний сервер не требует SNI путем настройки резервного сертификата.

## <a name="request-time-out"></a>Время ожидания запроса

### <a name="cause"></a>Причина:

При получении запроса от пользователя шлюз приложений применяет настроенные правила к запросу и направляет его в экземпляр пула серверной части. Затем в течение указанного интервала он ожидает отклик от серверного экземпляра. По умолчанию этот интервал составляет **20** секунд. Если шлюз приложений не получает ответ от серверного приложения в этот интервал, запрос пользователя возвращает ошибку 502.

### <a name="solution"></a>Решение

Шлюз приложений позволяет настроить этот параметр с помощью BackendHttpSetting, который затем можно применить к разным пулам. Разные пулы внутренних серверных пулов могут иметь разные BackendHttpSetting, а также настроено другое время ожидания запроса.

```azurepowershell
    New-AzApplicationGatewayBackendHttpSettings -Name 'Setting01' -Port 80 -Protocol Http -CookieBasedAffinity Enabled -RequestTimeout 60
```

## <a name="empty-backendaddresspool"></a>Пустой серверный пул адресов

### <a name="cause"></a>Причина:

Если в шлюзе приложений нет виртуальных машин или масштабируемых наборов виртуальных машин, настроенных в пуле внутренних адресов, он не сможет направить запрос клиента и отправит ошибку неправильного шлюза.

### <a name="solution"></a>Решение

Убедитесь, что пул внутренних адресов не пуст. Это можно сделать с помощью PowerShell, интерфейса командной строки или на портале.

```azurepowershell
Get-AzApplicationGateway -Name "SampleGateway" -ResourceGroupName "ExampleResourceGroup"
```

Выходные данные командлета, приведенного выше, должны содержать непустой серверный пул адресов. В следующем примере показаны два возвращенных пула, для которых настроено полное доменное имя или IP-адреса для внутренних виртуальных машин. Состояние подготовки серверного пула адресов должно быть "Выполнено".

BackendAddressPoolsText:

```json
[{
    "BackendAddresses": [{
        "ipAddress": "10.0.0.10",
        "ipAddress": "10.0.0.11"
    }],
    "BackendIpConfigurations": [],
    "ProvisioningState": "Succeeded",
    "Name": "Pool01",
    "Etag": "W/\"00000000-0000-0000-0000-000000000000\"",
    "Id": "/subscriptions/<subscription id>/resourceGroups/<resource group name>/providers/Microsoft.Network/applicationGateways/<application gateway name>/backendAddressPools/pool01"
}, {
    "BackendAddresses": [{
        "Fqdn": "xyx.cloudapp.net",
        "Fqdn": "abc.cloudapp.net"
    }],
    "BackendIpConfigurations": [],
    "ProvisioningState": "Succeeded",
    "Name": "Pool02",
    "Etag": "W/\"00000000-0000-0000-0000-000000000000\"",
    "Id": "/subscriptions/<subscription id>/resourceGroups/<resource group name>/providers/Microsoft.Network/applicationGateways/<application gateway name>/backendAddressPools/pool02"
}]
```

## <a name="unhealthy-instances-in-backendaddresspool"></a>Неработоспособные экземпляры в серверном пуле адресов

### <a name="cause"></a>Причина:

Если все экземпляры BackendAddressPool неработоспособны, шлюз приложений не имеет серверной части для маршрутизации запроса пользователя. Это также может быть так, когда серверные экземпляры находятся в работоспособном состоянии, но не развернуто необходимое приложение.

### <a name="solution"></a>Решение

Сделайте экземпляры работоспособными и правильно настройте приложение. Убедитесь, что серверные экземпляры могут отвечать на запросы проверки связи из другой виртуальной машины в той же виртуальной сети. При настройке с общедоступной конечной точкой Убедитесь, что запрос браузера к веб-приложению является обслуживаемым.

## <a name="next-steps"></a>Дополнительная информация

Если описанные выше действия не помогли устранить проблему, отправьте запрос в [службу поддержки](https://azure.microsoft.com/support/options/).

