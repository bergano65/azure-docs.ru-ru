---
title: Включение сквозного режима TLS в Шлюзе приложений Azure
description: В этой статье рассматривается поддержка сквозного режима TLS в Шлюзе приложений.
services: application-gateway
author: surajmb
ms.service: application-gateway
ms.topic: conceptual
ms.date: 08/21/2020
ms.author: victorh
ms.openlocfilehash: c39401289ffc6f27c292168adaa15c5163a3967b
ms.sourcegitcommit: 0ce1ccdb34ad60321a647c691b0cff3b9d7a39c8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/05/2020
ms.locfileid: "93396929"
---
# <a name="overview-of-tls-termination-and-end-to-end-tls-with-application-gateway"></a>Обзор завершения сеансов TLS и использования сквозного режима TLS в Шлюзе приложений

Протокол TLS, ранее известный как SSL, является стандартной технологией безопасности для установления зашифрованного соединения между веб-сервером и браузером. Эта связь гарантирует, что все данные, передаваемые между веб-сервером и браузерами, остаются закрытыми и зашифрованными. Шлюз приложений поддерживает как завершение сеансов TLS на шлюзе, так и сквозное шифрование TLS.

## <a name="tls-termination"></a>Терминирование TLS

Шлюз приложений поддерживает завершение сеансов TLS на шлюзе, после чего трафик обычно передается в незашифрованном виде на внутренние серверы. Завершение сеансов TLS на шлюзе приложений дает ряд преимуществ.

- **Улучшенная производительность**. Наибольшее влияние на производительность расшифровка TLS оказывает в момент первоначального подтверждения. Для повышения производительности сервер, выполняющий расшифровку, кэширует идентификаторы сеанса TLS и управляет его билетами. Если это выполняется в шлюзе приложений, все запросы от одного клиента могут использовать кэшированные значения. Если это выполняется на внутренних серверах, то при каждой пересылке клиентских запросов на другой сервер клиент должен пройти повторную проверку подлинности. Эту проблему можно устранить с помощью билетов TLS, но они поддерживаются не всеми клиентами и могут быть сложными в настройке и управлении.
- **Более эффективное использование внутренних серверов**. Обработка SSL/TLS создает большую нагрузку на процессор, которая растет по мере увеличения размеров ключей. Устранение этого рабочего процесса с внутренних серверов позволяет использовать их более эффективно по прямому назначению: для доставки содержимого.
- **Интеллектуальная маршрутизация**. Расшифровывая трафик, шлюз приложений получает доступ к содержимому запроса, в том числе заголовкам, URI и т. п., и может использовать эти данные для маршрутизации запросов.
- **Управление сертификатами**. Нет необходимости приобретать и устанавливать сертификаты на все внутренние серверы. Достаточно сделать это для шлюза приложений. Это сэкономит время и деньги.

Чтобы настроить завершение сеансов TLS, необходимо добавить в прослушиватель сертификат TLS/SSL. Тогда Шлюз приложений сможет получить симметричный ключ в соответствии со спецификацией протокола TLS/SSL. Затем симметричный ключ используется для шифрования и расшифровки трафика, отправляемого на шлюз. Сертификат TLS/SSL должен быть в формате PFX (файл обмена личной информацией). Этот формат файла позволяет экспортировать закрытый ключ, необходимый шлюзу приложений для шифрования и расшифровки трафика.

> [!IMPORTANT] 
> Сертификат на прослушивателе требует передачи всей цепочки сертификатов (корневой сертификат из ЦС, промежуточные и конечные сертификаты) для установки цепочки доверия. 


> [!NOTE] 
>
> Шлюз приложений не предоставляет возможности создания нового сертификата или отправки запроса на сертификат в центр сертификации.

Чтобы TLS-подключение работало, сертификат TLS/SSL должен соответствовать следующим условиям:

- Текущие дата и время находятся в пределах диапазона "Действителен с" и "Действителен до" для сертификата.
- Общее имя сертификата соответствует заголовку узла в запросе. Например, если клиент запрашивает `https://www.contoso.com/`, то должно использоваться общее имя `www.contoso.com`.

### <a name="certificates-supported-for-tls-termination"></a>Поддерживаемые сертификаты для завершения сеансов TLS

Шлюз приложений поддерживает использование сертификатов следующих типов:

- Сертификат центра сертификации (ЦС). Цифровой сертификат, выданный центром сертификации (ЦС).
- Сертификат с расширенной проверкой (РП). Сертификат, соответствующий стандартным отраслевым рекомендациям. При этом строка поиска в браузере станет зеленой и в ней будет отображаться название компании.
- Шаблон сертификата. Этот сертификат поддерживает любое количество поддоменов на основе шаблона *.site.com, где вместо * должен быть ваш поддомен. Однако он не поддерживает запись "site.com", поэтому если пользователи обращаются к веб-сайту, не вводя в начале "www", то этот сертификат не применяется.
- Самозаверяющие сертификаты. Клиентские браузеры не могут доверять этим сертификатам и предупредят пользователя о том, что сертификат виртуальной службы не входит в цепочку доверия. Самозаверяющие сертификаты хорошо подходят для тестирования или сред, где клиентами управляют администраторы, которые могут безопасно обойти оповещения системы безопасности браузера. Не следует использовать самозаверяющие сертификаты для рабочих нагрузок в рабочей среде.

Дополнительные сведения см. в статье о [настройке завершения сеансов TLS с помощью шлюза приложений](./create-ssl-portal.md).

### <a name="size-of-the-certificate"></a>Размер сертификата
Чтобы узнать о максимальном поддерживаемом размере сертификата TLS/SSL, ознакомьтесь с разделом [Ограничения Шлюза приложений](../azure-resource-manager/management/azure-subscription-service-limits.md#application-gateway-limits).

## <a name="end-to-end-tls-encryption"></a>Сквозное шифрование TLS

Иногда незашифрованное соединение с внутренними серверами необходимо запретить. Это может быть связано с требованиями безопасности и соответствия или с тем, что приложение может принимать только безопасные подключения. Шлюз приложений Azure обеспечивает сквозное шифрование TLS, позволяющее выполнить такие требования.

Сквозной протокол TLS позволяет шифровать и безопасно передавать конфиденциальные данные на внутренние серверы при использовании функций балансировки нагрузки уровня 7 для Шлюза приложений. К ним относится применение сходства сеансов на основе файлов cookie, маршрутизация на основе URL-адресов, поддержка маршрутизации на основе сайтов и возможность перезаписи или внедрения заголовков X-Forwarded-* и т. п.

Если на Шлюзе приложений настроен сквозной режим связи TLS, он завершает сеансы TLS пользователей на шлюзе и расшифровывает пользовательский трафик. Затем он применяет настроенные правила и выбирает подходящий экземпляр внутреннего пула для передачи трафика в него. Затем Шлюз приложений инициирует новое TLS-подключение ко внутреннему серверу и повторно шифрует данные с помощью сертификата открытого ключа внутреннего сервера, прежде чем передать запрос в серверную часть. Любой ответ веб-сервера проходит через тот же процесс на пути к пользователю. Чтобы включить сквозной режим TLS, следует задать значение HTTPS для параметра протокола в [настройках HTTP внутреннего сервера](./configuration-overview.md#http-settings), который применяется к внутреннему пулу.

Для Шлюза приложений и номера SKU WAF версии 1 политика TLS применяется как к внешнему, так и к внутреннему трафику. Для внешнего трафика Шлюз приложений выступает в качестве сервера и применяет политику. Для внутреннего трафика Шлюз приложений выступает в качестве клиента и отправляет сведения о протоколе или шифре как о предпочитаемых во время подтверждения TLS.

Для Шлюза приложений и номера SKU WAF версии 2 политика TLS применяется только к внутреннему трафику, а все шифры предоставляются внутреннему серверу, который может управлять выбором конкретных шифров и версии TLS во время подтверждения.

Шлюз приложений взаимодействует с этими внутренними серверами, которые либо разрешают список сертификатов с помощью шлюза приложений, либо сертификаты, подписанные хорошо известными центрами сертификации, а CN сертификата соответствует имени узла в параметрах серверной части HTTP. К ним относятся доверенные службы Azure, такие как Служба приложений Azure и ее веб-приложения, а также Управление API Azure.

Если сертификаты элементов во внутреннем пуле не подписаны широко известными центрами сертификации, то для обеспечения безопасной связи сертификат необходимо настроить для каждого экземпляра во внутреннем пуле с включенным сквозным шифрованием TLS. Это гарантирует, что шлюз приложений взаимодействует только с известными экземплярами серверной части, тем самым защищая сквозной обмен данными.

> [!NOTE] 
>
> Сертификат, добавленный в **настройки внутреннего трафика HTTP** для проверки подлинности внутренних серверов, может совпадать с сертификатом, добавленным в **прослушиватель** для завершения сеанса TLS на шлюзе приложений, или отличаться (для большей безопасности).

![Сценарий со сквозным шифрованием TLS][1]

В этом примере запросы, в которых используется TLS1.2, направляются на внутренние серверы в пул 1 с помощью сквозного шифрования TLS.

## <a name="end-to-end-tls-and-allow-listing-of-certificates"></a>Сквозной протокол TLS и разрешение перечисления сертификатов

Шлюз приложений взаимодействует только с известными экземплярами серверной части, которые разрешают перечисление их сертификатов с помощью шлюза приложений. Процесс настройки сквозного шифрования TLS несколько отличается для разных версий Шлюза приложений. Он описан в следующем разделе отдельно для каждой из них.

## <a name="end-to-end-tls-with-the-v1-sku"></a>Сквозное шифрование TLS с номером SKU версии 1

Чтобы обеспечить сквозное шифрование TLS на внутренних серверах и маршрутизацию запросов к ним на Шлюзе приложений, необходимо воспользоваться зондами работоспособности и получить ответ, который ее подтверждает.

Для зондов работоспособности HTTPS Шлюз приложений с номером SKU версии 1 использует точное совпадение сертификата проверки подлинности (открытого ключа сертификата внутреннего сервера, а не корневого сертификата), отправленного в параметры HTTP.

Разрешены только подключения к известным и разрешенным интерфейсам. Остальные внутренние серверы зонды работоспособности считают неработоспособными. Самозаверяющие сертификаты предназначены только для тестирования и не рекомендуются для рабочих нагрузок в рабочей среде. Такие сертификаты должны быть разрешены для использования шлюзом приложений, как описано в предыдущих шагах, прежде чем их можно будет использовать.

> [!NOTE]
> Для надежных служб Azure, таких как Служба приложений Azure, настраивать сертификат проверки подлинности и доверенный корневой сертификат не требуется. По умолчанию они считаются доверенными.

## <a name="end-to-end-tls-with-the-v2-sku"></a>Сквозное шифрование TLS с номером SKU версии 2

Сертификаты проверки подлинности устарели и заменены доверенными корневыми сертификатами в номере SKU Шлюза приложений версии 2. Они действуют идентично сертификатам проверки подлинности, за исключением нескольких ключевых различий:

- Сертификаты, подписанные хорошо известными ЦС, общие имена которых совпадают с именем узла в параметрах HTTP внутренних серверов, не требуют никаких дополнительных действий для обеспечения работы сквозного шифрования TLS. 

   Например, если сертификаты серверной части выданы хорошо известным центром сертификации и имеют общее имя contoso.com, а в поле узла в параметрах HTTP внутреннего сервера также указано значение contoso.com, дополнительные действия не требуются. Для протокола в параметрах HTTP серверной части можно задать HTTPS. Таким образом, и для зонда работоспособности, и для пути данных будет включен TLS. При использовании Службы приложений Azure или других веб-служб Azure в качестве внутреннего сервера они имеют неявное доверие. В этом случае для сквозного шифрования TLS дополнительные шаги не требуются.
   
> [!NOTE] 
>
> Чтобы TLS/SSL-сертификат был доверенным, он должен быть выдан широко известным центром сертификации. Если сертификат не был выдан доверенным центром сертификации, шлюз приложений проверяет, выдавался ли сертификат выдающего ЦС доверенным центром сертификации и так далее до тех пор, пока не будет найден доверенный центр сертификации. В этом случае устанавливается надежное безопасное подключение. Если доверенный ЦС не найден, шлюз приложений помечает внутренний сервер как неработоспособный. Поэтому рекомендуется, чтобы сертификат внутреннего сервера содержал как корневой, так и промежуточный ЦС.

- Если сертификат самозаверяющий или подписан неизвестными посредниками, тогда для включения сквозного шифрования TLS для номера SKU версии 2 необходимо определить доверенный корневой сертификат. Шлюз приложений взаимодействует только с внутренними серверами, корневой сертификат сертификата сервера которых совпадает с одним из сертификатов из списка доверенных корневых сертификатов в параметре HTTP внутреннего сервера, который связан с пулом.

- Помимо соответствия корневому сертификату Шлюз приложений версии 2 также проверяет, соответствуют ли параметры узла, указанные в параметрах HTTP внутреннего сервера, обычному имени, представленному сертификатом TLS/SSL внутреннего сервера. При попытке установить TLS-подключение к серверной части Шлюз приложений версии 2 задает расширение SNI узлу, указанному в параметрах HTTP серверной части.

- Если вместо поля узел в параметре HTTP серверной части выбран вариант **выбрать имя узла из внутреннего целевого объекта** , то для заголовка SNI всегда будет ЗАДАНО полное доменное имя внутреннего пула, а на сертификате TLS/SSL внутреннего сервера должно совпадать полное доменное имя. Участники серверного пула с IP-адресами в этом сценарии не поддерживаются.

- Корневой сертификат — это закодированный в Base64 корневой сертификат из списка сертификатов внутреннего сервера.

## <a name="sni-differences-in-the-v1-and-v2-sku"></a>Различия SNI в номере SKU версии 1 и 2

Как упоминалось ранее, шлюз приложений завершает трафик TLS от клиента на прослушивателе Шлюза приложений (назовем его внешним подключением), расшифровывает трафик, применяет необходимые правила для определения внутреннего сервера, на который пересылается запрос, и устанавливает новый сеанс TLS с внутренним сервером (назовем его внутренним подключением).

В следующих таблицах описаны различия в SNI для номеров SKU версии 1 и 2 с точки зрения внутренних и внешних подключений.

### <a name="frontend-tls-connection-client-to-application-gateway"></a>Внешнее TLS-подключение (от клиента к шлюзу приложений)

---
Сценарий | Версия 1 | Версия 2 |
| --- | --- | --- |
| Клиент указывает заголовок SNI, и все прослушиватели для нескольких сайтов включены с флагом "Требовать SNI" | Возвращает соответствующий сертификат, а если сайт не существует (в соответствии со значением server_name), подключение сбрасывается. | Возвращает подходящий сертификат при его наличии, в противном случае возвращает сертификат первого настроенного прослушивателя HTTPS (по порядку).|
| Клиент не указывает заголовок SNI, и все заголовки для нескольких сайтов включены с флагом "Требовать SNI" | Сбрасывает подключение. | Возвращает сертификат первого настроенного прослушивателя HTTPS (по порядку).
| Клиент не указал заголовок SNI, и имеется базовый прослушиватель, для которого настроен сертификат | Возвращает клиенту сертификат, настроенный в основном прослушивателе (заданный по умолчанию или резервный). | Возвращает сертификат первого настроенного прослушивателя HTTPS (по порядку). |

### <a name="backend-tls-connection-application-gateway-to-the-backend-server"></a>Серверное подключение TLS (от шлюза приложений к внутреннему серверу)

#### <a name="for-probe-traffic"></a>Для трафика зонда

---
Сценарий | Версия 1 | Версия 2 |
| --- | --- | --- |
| Заголовок SNI (server_name) во время подтверждения TLS в качестве полного доменного имени | Указывается в качестве полного доменного имени из внутреннего пула. Согласно [RFC 6066](https://tools.ietf.org/html/rfc6066), литеральные адреса IPv4 и IPv6 в имени узла SNI не допускаются. <br> **Примечание.** Полное доменное имя во внутреннем пуле, если DNS разрешает его в IP-адрес внутреннего сервера (общедоступный или частный). | Заголовок SNI (server_name) задается в качестве имени узла, полученного из пользовательского зонда, связанного с параметрами HTTP (если они настроены), имени узла, указанного в параметрах HTTP, или полного доменного имени, указанного во внутреннем пуле. Порядок приоритетности: пользовательский зонд > параметры HTTP > внутренний пул. <br> **Примечание.** Если имена узлов, настроенные в параметрах HTTP и пользовательском зонде, различаются, то в соответствии с порядком приоритетности заголовком SNI будет имя узла из пользовательского зонда.
| Адрес внутреннего пула является IP-адресом (в версии 1), или имя узла пользовательского зонда настроено как IP-адрес (в версии 2) | Заголовок SNI (server_name) не будет задан. <br> **Примечание.** В этом случае внутренний сервер должен иметь возможность возвращать сертификат по умолчанию и резервные сертификаты, и это должно быть разрешено в параметрах HTTP в разделе сертификат проверки подлинности. Если на внутреннем сервере не настроен сертификат (по умолчанию или резервной), а ожидается SNI, сервер может сбросить подключение, что приведет к сбою зонда. | Учитывая порядок приоритетности, упомянутый ранее, если имя узла — это IP-адрес, SNI не устанавливается в соответствии с [RFC 6066](https://tools.ietf.org/html/rfc6066). <br> **Примечание.** SNI также не устанавливается в зондах для версии 2, если не настроен пользовательский зонд, а в параметрах HTTP или внутреннем пуле не задано имя узла. |

> [!NOTE] 
> Если пользовательская проба не настроена, шлюз приложений отправляет зонд по умолчанию в следующем формате- \<protocol\> ://127.0.0.1: \<port\> /. Например, для зонда HTTPS по умолчанию он будет отправлен как https://127.0.0.1:443/. Обратите внимание, что указанное здесь значение 127.0.0.1 используется только в качестве заголовка узла HTTP и в соответствии с RFC 6066 не будет использоваться в качестве заголовка SNI. Дополнительные сведения об ошибках зондов работоспособности см. в [руководстве по устранению неполадок, связанных с работоспособностью внутреннего сервера](application-gateway-backend-health-troubleshooting.md).

#### <a name="for-live-traffic"></a>Для трафика в реальном времени

---
Сценарий | Версия 1 | Версия 2 |
| --- | --- | --- |
| Заголовок SNI (server_name) во время подтверждения TLS в качестве полного доменного имени | Указывается в качестве полного доменного имени из внутреннего пула. Согласно [RFC 6066](https://tools.ietf.org/html/rfc6066), литеральные адреса IPv4 и IPv6 в имени узла SNI не допускаются. <br> **Примечание.** Полное доменное имя во внутреннем пуле, если DNS разрешает его в IP-адрес внутреннего сервера (общедоступный или частный). | Заголовок SNI (server_name) задается как имя узла из параметров HTTP. В противном случае, если выбран параметр *PickHostnameFromBackendAddress* или не указано имя узла, этот заголовок будет задан как полное доменное имя в конфигурации внутреннего пула.
| Адрес внутреннего пула является IP-адресом, или имя узла не задано в параметрах HTTP | SNI не задается в соответствии с [RFC 6066](https://tools.ietf.org/html/rfc6066), если запись внутреннего пула не является полным доменным именем. | Заголовком SNI будет имя узла из входного полного доменного имени, полученного от клиента. При этом общее имя сертификата внутреннего сервера должно соответствовать этому имени узла.

## <a name="next-steps"></a>Дальнейшие действия

Ознакомившись со сквозным шифрованием TLS, [настройте сквозное шифрование TLS в Шлюзе приложений с помощью PowerShell](application-gateway-end-to-end-ssl-powershell.md), чтобы создать шлюз приложений, использующий сквозное шифрование TLS.

<!--Image references-->

[1]: ./media/ssl-overview/scenario.png