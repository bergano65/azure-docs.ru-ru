---
title: Завершение TLS с сертификатами Azure Key Vault
description: Сведения о том, как интегрировать Шлюз приложений Azure с Key Vault для хранения сертификатов сервера, подключенных к прослушивателям с поддержкой HTTPS.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: conceptual
ms.date: 11/16/2020
ms.author: victorh
ms.openlocfilehash: 95ca4933b97199ba6d8ac1bed7587af5d3bd559f
ms.sourcegitcommit: 8e7316bd4c4991de62ea485adca30065e5b86c67
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2020
ms.locfileid: "94648129"
---
# <a name="tls-termination-with-key-vault-certificates"></a>Завершение TLS с сертификатами Key Vault

Управляемое платформой хранилище секретов [Azure Key Vault](../key-vault/general/overview.md) можно применять для защиты секретов, ключей и сертификатов TLS/SSL. Шлюз приложений Azure теперь поддерживает интеграцию с Key Vault для сертификатов сервера, подключенных к прослушивателям с поддержкой HTTPS. Эта поддержка ограничена номером SKU шлюза приложений версии 2.

Интеграция Key Vault предлагает две модели для завершения TLS:

- Можно явно предоставить сертификаты TLS/SSL, подключенные к прослушивателю. Эта модель является традиционным способом передачи сертификатов TLS/SSL в шлюз приложений для завершения TLS.
- При создании прослушивателя с поддержкой HTTPS можно дополнительно указать ссылку на существующий Key Vault сертификат или секрет.

Интеграция шлюза приложений с Key Vault предлагает множество преимуществ, в том числе:

- Более высокий уровень безопасности, поскольку сертификаты TLS/SSL не обрабатываются группой разработчиков приложений напрямую. Интеграция позволяет отдельной группе безопасности:
  * Настройте шлюзы приложений.
  * Управление жизненным циклом шлюза приложений.
  * Предоставьте выбранным шлюзам приложений разрешения на доступ к сертификатам, хранящимся в хранилище ключей.
- Поддержка импорта существующих сертификатов в хранилище ключей. Или используйте Key Vault API для создания новых сертификатов и управления ими с любыми доверенными партнерами Key Vault.
- Поддержка автоматического продления сертификатов, хранящихся в хранилище ключей.

Сейчас шлюз приложений поддерживает только сертификаты, проверенные программным обеспечением. Аппаратный модуль безопасности (HSM) — проверенные сертификаты не поддерживаются. После того как шлюз приложений настроен для использования сертификатов Key Vault, его экземпляры получают сертификат из Key Vault и устанавливают их локально для завершения TLS. Экземпляры также опрашиваются Key Vault с интервалами в 4 часа для получения обновленной версии сертификата, если он существует. Если найден обновленный сертификат, то сертификат TLS/SSL, который сейчас связан с прослушивателем HTTPS, автоматически поворачивается.

> [!NOTE]
> Портал Azure поддерживает только сертификаты KeyVault, а не секреты. Шлюз приложений по-прежнему поддерживает ссылки на секреты из KeyVault, но только через ресурсы, не относящиеся к порталу, такие как PowerShell, CLI, API, шаблоны ARM и т. д. 

## <a name="how-integration-works"></a>Как работает интеграция

Для интеграции шлюза приложений с Key Vault требуется процесс настройки, сопоставленный с тремя шагами:

1. **Создание управляемого удостоверения, назначаемого пользователем**

   Вы создаете или повторно используете существующее назначенное пользователем управляемое удостоверение, которое шлюз приложений использует для получения сертификатов от Key Vault от вашего имени. Дополнительные сведения см. [в разделе Создание, перечисление, удаление или назначение роли назначенному пользователем управляемому удостоверению с помощью портал Azure](../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal.md). На этом шаге создается новое удостоверение в клиенте Azure Active Directory. Удостоверение является доверенным для подписки, которая используется для создания удостоверения.

1. **Настройка хранилища ключей**

   Затем импортируйте существующий сертификат или создайте новый в хранилище ключей. Сертификат будет использоваться приложениями, которые выполняются через шлюз приложений. На этом шаге можно также использовать секрет хранилища ключей, который хранится в виде PFX-файла в формате "без пароля", с основанием 64. Рекомендуется использовать тип сертификата из-за возможности автопродления, доступной для объектов типа сертификата в хранилище ключей. После создания сертификата или секрета вы определяете политики доступа в хранилище ключей, *чтобы предоставить удостоверению доступ к* секрету.
   
   > [!IMPORTANT]
   > В настоящее время шлюз приложений требует Key Vault, чтобы разрешить доступ из всех сетей, чтобы использовать интеграцию. Она не поддерживает интеграцию Key Vault, если Key Vault настроена на разрешение только частных конечных точек и выбор доступа к сетям. Поддержка частных и выбранных сетей находится в Works для полной интеграции Key Vault с шлюзом приложений. 

   > [!NOTE]
   > Если вы развертываете шлюз приложений с помощью шаблона ARM, используя Azure CLI или PowerShell или с помощью приложения Azure, развернутого из портал Azure, SSL-сертификат хранится в хранилище ключей в виде файла PFX в кодировке Base64. [Для передачи безопасного значения параметра во время развертывания](../azure-resource-manager/templates/key-vault-parameter.md)необходимо выполнить действия, описанные в разделе Использование Azure Key Vault. 
   >
   > Особенно важно установить `enabledForTemplateDeployment` для значение `true` . Сертификат может быть незащищенным паролем или иметь пароль. В случае сертификата с паролем в следующем примере показана возможная конфигурация `sslCertificates` записи в `properties` для конфигурации шаблона ARM для шлюза приложений. Значения `appGatewaySSLCertificateData` и `appGatewaySSLCertificatePassword` ищутся из хранилища ключей, как описано в разделе [эталонные секреты с динамическим идентификатором](../azure-resource-manager/templates/key-vault-parameter.md#reference-secrets-with-dynamic-id). Чтобы увидеть, как выполняется поиск, перейдите по ссылке назад `parameters('secretName')` . Если сертификат не защищен паролем, пропустите `password` запись.
   >   
   > ```
   > "sslCertificates": [
   >     {
   >         "name": "appGwSslCertificate",
   >         "properties": {
   >             "data": "[parameters('appGatewaySSLCertificateData')]",
   >             "password": "[parameters('appGatewaySSLCertificatePassword')]"
   >         }
   >     }
   > ]
   > ```

1. **Настройка шлюза приложений**

   После выполнения двух предыдущих шагов можно настроить или изменить существующий шлюз приложений для использования управляемого удостоверения, назначенного пользователем. Дополнительные сведения см. в разделе [Set-азаппликатионгатевайидентити](/powershell/module/az.network/set-azapplicationgatewayidentity).

   Можно также настроить SSL-сертификат прослушивателя HTTP, чтобы он указывал на полный URI Key Vault сертификата или секретного идентификатора.

   ![Сертификаты хранилища ключей](media/key-vault-certs/ag-kv.png)

## <a name="next-steps"></a>Дальнейшие действия

[Настройка завершения TLS с использованием Key Vault сертификатов с помощью Azure PowerShell](configure-keyvault-ps.md)
