---
title: Обзор мониторинга работоспособности для шлюза приложений Azure
description: Шлюз приложений Azure отслеживает работоспособность всех ресурсов в своем пуле внутренних серверов и автоматически удаляет из пула все ресурсы, которые считаются неработоспособными.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 07/09/2020
ms.author: victorh
ms.openlocfilehash: b613e89fbe29074160d83a96d2cd13505244994a
ms.sourcegitcommit: ec682dcc0a67eabe4bfe242fce4a7019f0a8c405
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2020
ms.locfileid: "86186726"
---
# <a name="application-gateway-health-monitoring-overview"></a>Обзор мониторинга работоспособности шлюза приложений

Шлюз приложений Azure по умолчанию отслеживает работоспособность всех ресурсов в своем пуле внутренних серверов и автоматически удаляет из пула все ресурсы, признанные неработоспособными. Шлюз приложений продолжает отслеживать неисправные экземпляры и добавляет их в пул внутренних серверов, как только они становятся доступными и начинают отвечать на проверку работоспособности. По умолчанию шлюз приложений отправляет зонды работоспособности с тем же портом, который определен в параметрах HTTP серверной части. Пользовательский порт пробы можно настроить с помощью пользовательской проверки работоспособности.

Исходный IP-адрес, используемый шлюзом приложений для проверки работоспособности, зависит от внутреннего пула:
 
- Если адрес сервера во внутреннем пуле является общедоступной конечной точкой, то исходный адрес является общедоступным IP-адресом шлюза приложений.
- Если адрес сервера во внутреннем пуле является частной конечной точкой, то исходный IP-адрес находится в пространстве частных IP-адресов подсети шлюза приложений.

![пример проверки работоспособности шлюза приложений][1]

Помимо проверки работоспособности по умолчанию проверку также можно настроить в соответствии с требованиями приложения. В этой статье рассматривается как проверка работоспособности по умолчанию, так и пользовательская проверка работоспособности.

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="default-health-probe"></a>Проверка работоспособности по умолчанию

Если ни одной из пользовательских проверок работоспособности не настроено, шлюз приложений автоматически настраивает проверку работоспособности по умолчанию. Поведение мониторинга выполняется путем создания HTTP-запроса GET к IP адресам или полному доменному имени, настроенному во внутреннем пуле. Для проверок по умолчанию, если параметры HTTP серверной части настроены для использования протокола HTTPS, проба проверяет работоспособность внутренних серверов с помощью протокола HTTPS.

Пример: Вы настроили шлюз приложений таким образом, что внутренние серверы A, B и C используются для получения сетевого трафика HTTP на порт 80. Мониторинг работоспособности по умолчанию проверяет три сервера каждые 30 секунд для работоспособного HTTP-ответа с временем ожидания 30 секунд для каждого запроса. HTTP-ответ, подтверждающий работоспособность, имеет [код состояния](https://msdn.microsoft.com/library/aa287675.aspx) от 200 до 399. В этом случае HTTP-запрос GET для пробы работоспособности будет выглядеть следующим образом http://127.0.0.1/ .

Если проверка по умолчанию для сервера A завершается неудачно, шлюз приложений прекратит пересылку запросов на этот сервер. Проверка работоспособности по умолчанию по-прежнему продолжает проверять сервер A каждые 30 секунд. Когда сервер A успешно отвечает на один запрос от проверки работоспособности по умолчанию, шлюз приложений снова пересылает запросы на сервер.

### <a name="default-health-probe-settings"></a>Параметры проверки работоспособности по умолчанию

| Свойства проверки | Значение | Описание |
| --- | --- | --- |
| URL-адрес проверки |\<protocol\>://127.0.0.1:\<port\>/ |Протокол и порт наследуются от параметров HTTP серверной части, с которыми связан зонд. |
| Интервал |30 |Количество времени (в секундах) ожидания перед отправкой следующей пробы работоспособности.|
| Время ожидания |30 |Количество времени (в секундах), в течение которого Шлюз приложений ожидает ответа пробы, прежде чем пометить ее как неработоспособную. Если проба возвращается как работоспособная, соответствующая серверная часть сразу же обозначается как работоспособная.|
| Пороговое значение сбоя |3 |Управляет количеством проб, которые нужно отправить в случае сбоя стандартной пробы работоспособности. В версии v1 эти дополнительные пробы работоспособности отправляются в быструю последовательность, чтобы быстро определить работоспособность серверной части и не ждать интервала пробы. В случае номера SKU версии 2 пробы работоспособности ожидают заданное количество времени. Сервер внутреннего пула считается неисправным, когда количество повторных неудачных попыток проверки достигает порогового значения сбоя. |

Проба по умолчанию выглядит только в \<protocol\> : \/ /127.0.0.1: \<port\> для определения состояния работоспособности. Если необходимо настроить пробу работоспособности для перехода на настраиваемый URL-адрес или изменить любые другие параметры, используйте пользовательские пробы. Дополнительные сведения о проверках HTTPS см. в статье [Общие сведения о завершении работы TLS и сквозном TLS с помощью шлюза приложений](ssl-overview.md#for-probe-traffic).

### <a name="probe-intervals"></a>Интервалы пробы

Все экземпляры Шлюза приложений проверяют серверную часть независимо друг от друга. Такая же конфигурация пробы применяется к каждому экземпляру Шлюза приложений. Например, если конфигурация пробы предназначена для отправки проб работоспособности каждые 30 секунд, а Шлюз приложений содержит два экземпляра, то оба экземпляра отправляют пробу работоспособности каждые 30 секунд.

При наличии нескольких прослушивателей каждый прослушиватель проверяет серверную часть независимо друг от друга. Например, при наличии двух прослушивателей, указывающих на один и тот же серверный пул в двух разных портах (настроенных с помощью двух параметров HTTP серверной части), каждый прослушиватель самостоятельно проверяет одну серверную часть. В этом случае есть две пробы в каждом экземпляре Шлюза приложений для двух прослушивателей. Если в этом сценарии есть два экземпляра Шлюза приложений, серверная виртуальная машина получит четыре пробы в рамках заданного интервала пробы.

## <a name="custom-health-probe"></a>Пользовательская проверка работоспособности

Пользовательские зонды позволяют более детально контролировать мониторинг работоспособности. При использовании пользовательских зондов можно настроить пользовательское имя узла, путь URL-адреса, интервал пробы и количество откликов, которые не удалось принять, прежде чем пометить экземпляр пула серверной части как неработоспособный и т. д.

### <a name="custom-health-probe-settings"></a>Параметры пользовательской проверки работоспособности

В следующей таблице приведены описания свойств из пользовательской пробы работоспособности.

| Свойства проверки | Описание |
| --- | --- |
| Имя |Имя проверки. Это имя используется для определения и ссылки на зонд в параметрах HTTP серверной части. |
| Протокол |Протокол, используемый для проверки. Это должно совпадать с протоколом, определенным в параметрах HTTP серверной части, с которыми он связан.|
| Узел |Имя узла для отправки пробы. В версии 1 SKU это значение будет использоваться только в заголовке узла запроса на пробу. В версии 2 SKU он будет использоваться как заголовок узла, так и SNI. |
| путь |Относительный путь проверки. Путь должен начинаться с "/". |
| Port |Если этот параметр определен, он используется в качестве порта назначения. В противном случае он использует тот же порт, что и параметры HTTP, с которыми он связан. Это свойство доступно только в SKU v2
| Интервал |Интервал проверки в секундах. Это значение представляет собой интервал времени между двумя последовательными зондами |
| Время ожидания |Время ожидания проверки в секундах. Если в течение этого времени ожидания не получен допустимый ответ, проба помечается как сбойный.  |
| Пороговое значение сбоя |Количество повторных попыток проверки. Сервер фонового сервера помечается после того, как число последовательных сбоев зонда достигнет порога неработоспособности |

### <a name="probe-matching"></a>Поиск соответствий

По умолчанию ответ HTTP(S) с кодом состояния 200–399 указывает на работоспособность. Настраиваемые пробы работоспособности поддерживают два критерия соответствия. Критерий соответствия можно использовать, чтобы дополнительно изменить стандартную интерпретацию содержимого ответа, указывающего на работоспособность.

Эти критерии соответствия приведены ниже. 

- **Соответствие кода состояния ответа HTTP**. Критерий соответствия пробы для приема определенного пользователем отдельного кода ответа HTTP или их диапазонов. Поддерживаются отдельные коды состояния ответа, разделенные запятыми, и диапазоны кодов состояния.
- **Соответствие текста ответа HTTP**. Критерий соответствия пробы, позволяющий проверять текст ответа HTTP и сопоставлять его с указанной пользователем строкой. Возможен только поиск указанной пользователем строки в тексте ответа, но не полного регулярного выражения.

Критерий соответствия можно задать с помощью командлета `New-AzApplicationGatewayProbeHealthResponseMatch`.

Пример:

```azurepowershell
$match = New-AzApplicationGatewayProbeHealthResponseMatch -StatusCode 200-399
$match = New-AzApplicationGatewayProbeHealthResponseMatch -Body "Healthy"
```
После задания критерия соответствия его можно добавить в конфигурацию пробы с помощью параметра `-Match` в PowerShell.

## <a name="nsg-considerations"></a>Рекомендации по группам безопасности сети

Необходимо разрешить входящий трафик Интернета через TCP-порты 65503–65534 для номера SKU шлюза приложений версии 1, а также через TCP-порты 65200–65535 для номера SKU версии 2 с целевой подсетью **Любая** и источником **GatewayManager** (тег службы источника). Такой диапазон портов требуется для обмена данными в рамках инфраструктуры Azure.

Кроме того, не должно блокироваться исходящее подключение к Интернету, а также необходимо разрешить входящий трафик из тега **AzureLoadBalancer**.

Дополнительные сведения см. в статье [Обзор конфигурации шлюза приложений](configuration-overview.md#network-security-groups-on-the-application-gateway-subnet).

## <a name="next-steps"></a>Дальнейшие действия
Ознакомившись со сведениями о мониторинге работоспособности шлюза приложений, можно настроить [пользовательскую проверку работоспособности](application-gateway-create-probe-portal.md) на портале Azure либо [пользовательскую проверку работоспособности](application-gateway-create-probe-ps.md) с использованием модели развертывания PowerShell или Azure Resource Manager.

[1]: ./media/application-gateway-probe-overview/appgatewayprobe.png
