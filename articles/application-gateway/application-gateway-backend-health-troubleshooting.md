---
title: Устранение проблем с работоспособностью серверной части в Шлюзе приложений Azure
description: В этой статье описывается, как устранять проблемы работоспособности серверной части для Шлюза приложений Azure.
services: application-gateway
author: surajmb
ms.service: application-gateway
ms.topic: troubleshooting
ms.date: 06/09/2020
ms.author: surmb
ms.openlocfilehash: b8acf1b025a5943773821c8ab78de6288eb6bec2
ms.sourcegitcommit: 0ce1ccdb34ad60321a647c691b0cff3b9d7a39c8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/05/2020
ms.locfileid: "93397904"
---
<a name="troubleshoot-backend-health-issues-in-application-gateway"></a>Устранение проблем с работоспособностью серверной части в Шлюзе приложений
==================================================

<a name="overview"></a>Обзор
--------

По умолчанию Шлюз приложений Azure использует пробы для проверки состояния работоспособности внутренних серверов, чтобы определить, готовы ли они к обработке запросов. Пользователи также могут создать пользовательские пробы, указав имя узла, путь для проверки и принимаемые коды состояния, которые указывают работоспособность. Всякий раз, когда внутренний сервер перестает успешно отвечать, Шлюз приложений помечает его как неработоспособный и останавливает пересылку запросов на этот сервер. Когда сервер вновь начинает успешно отвечать, Шлюз приложений возобновляет пересылку запросов на него.

### <a name="how-to-check-backend-health"></a>Как проверить работоспособность серверной части

Чтобы проверить работоспособность серверного пула, можно использовать страницу **Оценка работоспособности серверной части** на портале Azure. Можно также использовать [Azure PowerShell](/powershell/module/az.network/get-azapplicationgatewaybackendhealth?view=azps-2.6.0), [интерфейс командной строки](/cli/azure/network/application-gateway?view=azure-cli-latest#az-network-application-gateway-show-backend-health) или [REST API](/rest/api/application-gateway/applicationgateways/backendhealth).

Состояние, полученное любым из этих методов, может быть одним из следующих:

- Healthy;

- Unhealthy;

- Unknown.

Если состояние работоспособности серверной части — Healthy, это означает, что Шлюз приложений будет отправлять запросы на этот сервер. Но если работоспособность серверной части для всех серверов в серверном пуле — Unhealthy или Unknown, то при попытке доступа к приложениям могут возникнуть проблемы. В этой статье описаны признаки, причины и способы устранения для каждой из отображаемых ошибок.

<a name="backend-health-status-unhealthy"></a>Состояние работоспособности серверной части: Unhealthy
-------------------------------

Если состояние работоспособности серверной части — Unhealthy, то портал будет выглядеть как на снимке экрана ниже.

![Состояние работоспособности серверной части Шлюза приложений — Unhealthy](./media/application-gateway-backend-health-troubleshooting/appgwunhealthy.png)

Если вы используете Azure PowerShell, интерфейс командной строки или запрос Azure REST API, то вы получите ответ, похожий на приведенный ниже.
```azurepowershell
PS C:\Users\testuser\> Get-AzApplicationGatewayBackendHealth -Name "appgw1" -ResourceGroupName "rgOne"
BackendAddressPools :
{Microsoft.Azure.Commands.Network.Models.PSApplicationGatewayBackendHealthPool}
BackendAddressPoolsText : [
{
                              "BackendAddressPool": {
                                "Id": "/subscriptions/536d30b8-665b-40fc-bd7e-68c65f816365/resourceGroups/rgOne/providers/Microsoft.Network/applicationGateways/appgw1/b
                          ackendAddressPools/appGatewayBackendPool"
                              },
                              "BackendHttpSettingsCollection": [
                                {
                                  "BackendHttpSettings": {
                                    "TrustedRootCertificates": [],
                                    "Id": "/subscriptions/536d30b8-665b-40fc-bd7e-68c65f816365/resourceGroups/rgOne/providers/Microsoft.Network/applicationGateways/appg
                          w1/backendHttpSettingsCollection/appGatewayBackendHttpSettings"
                                  },
                                  "Servers": [
                                    {
                                      "Address": "10.0.0.5",
                                      "Health": "Healthy"
                                    },
                                    {
                                      "Address": "10.0.0.6",
                                      "Health": "Unhealthy"
                                    }
                                  ]
                                }
                              ]
                            }
                        ]
```
После получения состояния работоспособности внутреннего сервера Unhealthy для всех серверов в серверном пуле запросы перестают отправляться на эти серверы, а Шлюз приложений возвращает запрашивающему клиенту ошибку "Недопустимый шлюз (502)". Чтобы устранить эту проблему, просмотрите столбец **Сведения** на вкладке **Оценка работоспособности серверной части**.

Сообщение, отображаемое в столбце **Сведения** , содержит более подробную информацию о данной проблеме, и вы можете приступить к устранению проблемы, исходя из нее.

> [!NOTE]
> Запрос проверки по умолчанию отправляется в формате \<protocol\> ://127.0.0.1: \<port\> /. Например, для пробы HTTP на порте 80 используется запрос http://127.0.0.1:80. Только коды состояния HTTP от 200 до 399 соответствуют работоспособному состоянию. Протокол и порт назначения наследуются от параметров HTTP. Если требуется, чтобы Шлюз приложений выполнял пробу для другого протокола, имени узла или пути и определял другой код состояния как работоспособный, настройте пользовательскую пробу и свяжите ее с параметрами HTTP.

<a name="error-messages"></a>Сообщения об ошибках
------------------------
#### <a name="backend-server-timeout"></a>Время ожидания внутреннего сервера

**Сообщение**. Время, затраченное серверной частью на реагирование на пробу работоспособности Шлюза приложений, превышает пороговое время ожидания в параметре пробы.

**Причина.** После того как Шлюз приложений отправляет HTTP(S)-запрос пробы на внутренний сервер, он ждет ответ от внутреннего сервера в течение заданного периода времени. Если внутренний сервер не отвечает в течение этого периода (значение времени ожидания), он помечается как неработоспособный, пока не начнет отвечать в течение заданного периода ожидания.

**Решение.** Проверьте, почему внутренний сервер или приложение не отвечает в течение заданного периода ожидания, а также проверьте зависимости приложения. Например, проверьте, есть ли у базы данных проблемы, которые могут вызвать задержку ответа. Если вам известно о запрограммированном поведении приложения и оно должно отвечать только по истечении времени ожидания, увеличьте значение времени ожидания в параметрах пользовательской пробы. Изменить значение времени ожидания можно только в пользовательской пробе. Сведения о настройке пользовательской пробы см. [на странице документации](./application-gateway-create-probe-portal.md).

Чтобы увеличить значение времени ожидания, выполните следующие действия.

1.  Обратитесь напрямую к внутреннему серверу и проверьте время, затраченное им на ответ на эту страницу. Для обращения к внутреннему серверу можно использовать любой инструмент, включая браузер со средствами разработчика.

1.  Определив время ответа приложения, выберите вкладку **Зонды работоспособности** , а затем выберите пробу, связанную с параметрами HTTP.

1.  Введите любое значение времени ожидания, превышающее время ответа приложения, в секундах.

1.  Сохраните параметры пользовательской пробы и проверьте, отображается ли теперь состояние работоспособности серверной части как Healthy.

#### <a name="dns-resolution-error"></a>Ошибка разрешения DNS

**Сообщение**. Шлюзу приложений не удалось создать пробу для этой серверной части. Обычно это происходит, когда полное доменное имя внутренней службы введено неправильно. 

**Причина.** Если серверный пул использует IP-адрес, FQDN или службу приложений, то Шлюз приложений разрешает IP-адрес полного доменного имени, введенного с помощью службы доменных имен (DNS) (пользовательской или используемой по умолчанию в Azure), и пытается подключиться к серверу по TCP-порту, указанному в параметрах HTTP. Но если это сообщение отображается, это означает, что Шлюзу приложений не удалось успешно разрешить IP-адрес указанного полного доменного имени.

**Решение.**

1.  Убедитесь, что полное доменное имя в серверном пуле указано правильно и является общедоступным доменом, а затем попробуйте разрешить его с локального компьютера.

1.  Если вы можете разрешить IP-адрес, возможно, в виртуальной сети возникли проблемы с конфигурацией DNS.

1.  Проверьте, настроен ли для виртуальной сети настраиваемый DNS-сервер. Если это так, проверьте DNS-сервер на предмет того, почему он не может разрешить IP-адрес указанного полного доменного имени.

1.  Если вы используете DNS по умолчанию Azure, обратитесь к регистратору доменных имен, чтобы узнать, завершено ли сопоставление соответствующих записей A или записей CNAME.

1.  Если домен является частным или внутренним, попробуйте разрешить его имя из виртуальной машины в той же виртуальной сети. Если вам это удалось, перезапустите Шлюз приложений и проверьте наличие проблемы. Чтобы перезапустить Шлюз приложений, его необходимо [отключить](/powershell/module/azurerm.network/stop-azurermapplicationgateway?view=azurermps-6.13.0) и [запустить](/powershell/module/azurerm.network/start-azurermapplicationgateway?view=azurermps-6.13.0) с помощью команд PowerShell, которые описаны в приведенных связанных ресурсах.

#### <a name="tcp-connect-error"></a>Ошибка TCP-подключения

**Сообщение**. Шлюзу приложений не удалось подключиться к серверной части.
Убедитесь, что серверная часть отвечает на порту, используемому для пробы.
Также проверьте, блокирует ли какая-либо группа безопасности сети, определяемый пользователем маршрут или брандмауэр доступ к IP-адресу и порту этой серверной части.

**Причина.** После этапа разрешения DNS Шлюз приложений пытается подключиться к внутреннему серверу через TCP-порт, настроенный в параметрах HTTP. Если Шлюзу приложений не удается установить сеанс TCP на указанном порту, то проба возвращает состояние Unhealthy в этом сообщении.

**Решение**. Если возникла эта ошибка, выполните следующие действия.

1.  Проверьте, можно ли подключиться к внутреннему серверу через порт, указанный в параметрах HTTP, с помощью браузера или PowerShell. Например, выполните следующую команду: `Test-NetConnection -ComputerName
    www.bing.com -Port 443`

1.  Если указанный порт не является требуемым портом, введите правильный номер порта для подключения Шлюза приложений к внутреннему серверу.

1.  Если не удается подключиться к порту и с локального компьютера, выполните следующие действия.

    а.  Проверьте параметры группы безопасности сети (NSG) сетевого адаптера и подсети внутреннего сервера и убедитесь, что разрешены входящие подключения к настроенному порту. Если это не так, создайте новое правило, разрешающее эти подключения. Чтобы узнать, как создавать правила NSG, перейдите на [страницу документации](../virtual-network/tutorial-filter-network-traffic.md#create-security-rules).

    b.  Проверьте, допускают ли параметры NSG подсети Шлюза приложений исходящий общий и частный трафик, чтобы можно было установить подключение. Дополнительные сведения о создании правил NSG см. на странице документации, приведенной в действии 3a.
    ```azurepowershell
            $vnet = Get-AzVirtualNetwork -Name "vnetName" -ResourceGroupName "rgName"
            Get-AzVirtualNetworkSubnetConfig -Name appGwSubnet -VirtualNetwork $vnet
    ```

    c.  Проверьте параметры определяемых пользователем маршрутов (UDR) Шлюза приложений и подсети внутреннего сервера на наличие каких-либо аномалий маршрутизации. Убедитесь, что UDR не направляет трафик из внутренней подсети. Например, проверьте маршруты к виртуальным сетевым устройствам или маршруты по умолчанию, объявляемые в подсети Шлюза приложений через Azure ExpressRoute и (или) VPN.

    d.  Чтобы проверить действующие маршруты и правила для сетевого адаптера, можно использовать приведенные ниже команды PowerShell.
    ```azurepowershell
            Get-AzEffectiveNetworkSecurityGroup -NetworkInterfaceName "nic1" -ResourceGroupName "testrg"
            Get-AzEffectiveRouteTable -NetworkInterfaceName "nic1" -ResourceGroupName "testrg"
    ```
1.  Если проблемы с NSG или UDR не обнаружены, проверьте наличие проблем с приложением на внутреннем сервере, которые не позволяют клиентам устанавливать сеанс TCP на настроенных портах. Вот что следует проверить.

    а.  Откройте командную строку (Win+R-\> cmd), введите `netstat` и нажмите клавишу ВВОД.

    b.  Проверьте, ожидает ли сервер передачи данных через порт, который настроен. Пример:
    ```
            Proto Local Address Foreign Address State PID
            TCP 0.0.0.0:80 0.0.0.0:0 LISTENING 4
    ```
    c.  Если он не ожидает данных через настроенный порт, проверьте параметры своего веб-сервера. Например: привязки сайтов в IIS, блокирование сервера в NGINX и виртуальный узел в Apache.

    d.  Проверьте параметры брандмауэра ОС, чтобы убедиться, что входящий трафик к порту разрешен.

#### <a name="http-status-code-mismatch"></a>Несоответствие кода состояния HTTP

**Сообщение**. Код состояния HTTP-ответа серверной части не соответствует параметру пробы. Expected:{HTTPStatusCode0} Received:{HTTPStatusCode1}.

**Причина.** После установки TCP-подключения и выполнения подтверждения TLS (если включен протокол TLS) Шлюз приложений отправляет пробу в виде HTTP-запроса GET на внутренний сервер. Как было сказано ранее, проба по умолчанию будет \<protocol\> ://127.0.0.1: \<port\> /и считает коды состояния ответа в Rage 200 – 399 как работоспособные. Если сервер возвращает любой другой код состояния, он будет помечен как Unhealthy с помощью этого сообщения.

**Решение**. В зависимости от кода ответа внутреннего сервера можно выполнить следующие действия. Ниже перечислены некоторые распространенные коды состояний.

| **Error** | **Действия** |
| --- | --- |
| Несоответствие кода состояния пробы: Отображается ошибка 401 | Проверьте, требуется ли для внутреннего сервера аутентификация. Зонды шлюза приложений не могут передавать учетные данные для проверки подлинности. Либо разрешите код \"HTTP 401\" для состояния пробы, либо отправляйте пробу по пути, в котором сервер не требует аутентификации. | |
| Несоответствие кода состояния пробы: Отображается ошибка "403: | доступ запрещен". Проверьте, разрешен ли доступ к пути на внутреннем сервере | |
| Несоответствие кода состояния пробы: Отображается ошибка "404: | страница не найдена". Проверьте, доступен ли путь к имени узла на внутреннем сервере. Измените имя узла или параметр пути, указав доступное значение. | |
| Несоответствие кода состояния пробы: Отображается ошибка 405 | В запросах пробы для Шлюза приложений используется метод HTTP GET. Проверьте, разрешает ли сервер этот метод. | |
| Несоответствие кода состояния пробы: Отображается ошибка 500 | Внутренняя ошибка сервера. Проверьте работоспособность внутреннего сервера и убедитесь, что службы работают. | |
| Несоответствие кода состояния пробы: Отображается ошибка 503 | Служба недоступна. Проверьте работоспособность внутреннего сервера и убедитесь, что службы работают. | |

Или, если вы считаете, что ответ является допустимым, и хотите, чтобы Шлюз приложений принимал другие коды как соответствующие работоспособному состоянию, можно создать пользовательскую пробу. Этот подход удобен в ситуациях, когда веб-сайт внутреннего сервера требует аутентификацию. Так как запросы пробы не содержат учетные данные пользователя, они завершатся ошибкой, а внутренний сервер вернет код состояния HTTP 401.

Чтобы создать пользовательскую пробу, выполните [эти действия](./application-gateway-create-probe-portal.md).

#### <a name="http-response-body-mismatch"></a>Несоответствие текста HTTP-ответа

**Сообщение**. Текст HTTP-ответа внутренней службы не соответствует параметру пробы. Полученный текст ответа не содержит {строка}.

**Причина.** При создании пользовательской пробы можно пометить внутренний сервер как Healthy, сопоставив строку из текста ответа. Например, можно настроить Шлюз приложений таким образом, чтобы он принимал "unauthorized" в качестве строки для сопоставления. Если ответ внутреннего сервера на запрос пробы содержит строку **unauthorized** , он будет помечен как Healthy. В противном случае он будет помечен как Unhealthy с помощью этого сообщения.

**Решение**. Проблему можно устранить следующим способом.

1.  Обратитесь к внутреннему серверу локально или с клиентского компьютера по пути пробы и проверьте текст ответа.

1.  Убедитесь, что текст ответа в пользовательской пробе Шлюза приложений совпадает с настроенной строкой.

1.  Если он не совпадает, измените конфигурацию пробы, чтобы она принимала правильное строковое значение.

Узнайте больше [сопоставлении пробы Шлюза приложений](./application-gateway-probe-overview.md#probe-matching).

>[!NOTE]
> Чтобы изучить все сообщения об ошибках, связанные с TLS, и узнать больше о реакции SNI на событие, а также различиях между номерами SKU версий 1 и 2, перейдите на страницу [общих сведений о TLS](ssl-overview.md).


#### <a name="backend-server-certificate-invalid-ca"></a>Недопустимый ЦС сертификата внутреннего сервера

**Сообщение**. Сертификат сервера, используемый внутренним сервером, не подписан известным центром сертификации (ЦС). Разрешите серверную часть шлюза приложений, загружая корневой сертификат сертификата сервера, используемого серверной частью.

**Причина.** Сквозной протокол SSL со Шлюзом приложений версии 2 требует проверки сертификата внутреннего сервера, чтобы он считался работоспособным сервером (Healthy).
Чтобы TLS/SSL-сертификат считался доверенным, он должен быть выдан внутреннему серверу центром сертификации, который входит в доверенное хранилище Шлюза приложений. Если сертификат не был выдан доверенным центром сертификации (например, если использован самозаверяющий сертификат), то пользователи должны передать сертификат издателя в Шлюз приложений.

**Решение**. Выполните приведенные ниже действия, чтобы экспортировать и передать доверенный корневой сертификат в Шлюз приложений. (Эти действия предназначены для клиентов Windows.)

1.  Войдите на компьютер, на котором размещено ваше приложение.

1.  Нажмите клавиши Win+R или щелкните правой кнопкой мыши кнопку **Пуск** , а затем выберите **Запустить**.

1.  Введите `certmgr.msc` и нажмите клавишу ВВОД. Можно также выполнить поиск диспетчера сертификатов в меню **Пуск**.

1.  Выберите сертификат (обычно он находится в `\Certificates - Current User\\Personal\\Certificates\`) и откройте его.

1.  Выберите корневой сертификат, а затем выберите **Просмотр сертификата**.

1.  В окне свойств сертификата перейдите на вкладку **Сведения**.

1.  На вкладке **Сведения** выберите параметр **Копировать в файл** и сохраните сертификат как CER-файл в формате Base-64 с шифрованием X.509.

1.  Откройте страницу **параметров HTTP** Шлюза приложений на портале Azure.

1. Откройте параметры HTTP, выберите **Добавить сертификат** и укажите только что сохраненный файл сертификата.

1. Нажмите кнопку **Сохранить** , чтобы сохранить параметры HTTP.

Кроме того, можно экспортировать корневой сертификат с клиентского компьютера, напрямую обратившись к серверу (минуя Шлюз приложений) через браузер и экспортировав корневой сертификат.

Дополнительные сведения о том, как извлечь и передать доверенные корневые сертификаты в Шлюз приложений, см. в разделе [Экспорт доверенного корневого сертификата (для SKU версии 2)](./certificates-for-backend-authentication.md#export-trusted-root-certificate-for-v2-sku).

#### <a name="trusted-root-certificate-mismatch"></a>Несоответствие доверенного корневого сертификата

**Сообщение**. Корневой сертификат сертификата сервера, используемого внутренним сервером, не соответствует доверенному корневому сертификату, добавленному в шлюз приложений. Убедитесь, что вы добавили правильный корневой сертификат, чтобы добавить серверную часть в список разрешений.

**Причина.** Сквозной протокол SSL со Шлюзом приложений версии 2 требует проверки сертификата внутреннего сервера, чтобы он считался работоспособным сервером (Healthy).
Чтобы TLS/SSL-сертификат считался доверенным, он должен быть выдан внутреннему серверу центром сертификации, который входит в доверенное хранилище Шлюза приложений. Если сертификат не был выдан доверенным центром сертификации (например, если был использован самозаверяющий сертификат), то пользователи должны передать сертификат издателя в Шлюз приложений.

Сертификат, который был передан в параметры HTTP Шлюза приложений, должен соответствовать корневому сертификату сертификата внутреннего сервера.

**Решение**. Если получено это сообщение об ошибке, то сертификат, который был передан в Шлюз приложений, не соответствует сертификату, переданному на внутренний сервер.

Выполните шаги 1–11 в предыдущем методе, чтобы передать правильный доверенный корневой сертификат в Шлюз приложений.

Дополнительные сведения о том, как извлечь и передать доверенные корневые сертификаты в Шлюз приложений, см. в разделе [Экспорт доверенного корневого сертификата (для SKU версии 2)](./certificates-for-backend-authentication.md#export-trusted-root-certificate-for-v2-sku).
> [!NOTE]
> Эта ошибка также может возникнуть, если внутренний сервер не выполняет обмен цепочки сертификатов (корневой, промежуточный (если применимо) и конечный) во время подтверждения TLS. Чтобы проверить это, можно выполнить команды OpenSSL на любом клиенте и подключиться к внутреннему серверу с помощью параметров, настроенных в пробе Шлюза приложений.

Пример:
```
OpenSSL> s_client -connect 10.0.0.4:443 -servername www.example.com -showcerts
```
Если в выходных данных не отображается полная цепочка возвращаемого сертификата, экспортируйте сертификат повторно с помощью полной цепочки, включив в нее корневой сертификат. Настройте этот сертификат на внутреннем сервере. 

```
  CONNECTED(00000188)\
  depth=0 OU = Domain Control Validated, CN = \*.example.com\
  verify error:num=20:unable to get local issuer certificate\
  verify return:1\
  depth=0 OU = Domain Control Validated, CN = \*.example.com\
  verify error:num=21:unable to verify the first certificate\
  verify return:1\
  \-\-\-\
  Certificate chain\
   0 s:/OU=Domain Control Validated/CN=*.example.com\
     i:/C=US/ST=Arizona/L=Scottsdale/O=GoDaddy.com, Inc./OU=http://certs.godaddy.com/repository//CN=Go Daddy Secure Certificate Authority - G2\
  \-----BEGIN CERTIFICATE-----\
  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\
  \-----END CERTIFICATE-----
```

#### <a name="backend-certificate-invalid-common-name-cn"></a>Недействительное общее имя сертификата внутреннего сервера

**Сообщение**. Общее имя (CN) сертификата внутреннего сервера не соответствует заголовку узла в пробе.

**Причина.** Шлюз приложений проверяет, соответствует ли имя узла, указанное в параметрах HTTP серверной части, общему имени, представленному TLS/SSL-сертификатом внутреннего сервера. Этот режим используется для номеров SKU Standard_v2 и WAF_v2 (версии 2). Для номеров SKU ценовой категории "Стандартный" и WAF (версии 1) в качестве полного доменного имени в адресе серверного пула задается указание имени сервера (SNI). Дополнительные сведения о поведении SNI и различиях между номерами SKU версий 1 и 2 см. в разделе [Общие сведения о завершении TSL и сквозном подключении с помощью шлюза приложений](ssl-overview.md).

Если в номере SKU версии 2 используется проба по умолчанию (не настроена и не привязана пользовательская проба), то значение SNI будет установлено по имени узла, указанного в параметрах HTTP. Если же в параметрах HTTP указан параметр "Имя узла, выбранное в наборе серверных адресов" и серверный пул адресов содержит допустимое полное доменное имя, то применяется этот параметр.

Если с параметрами HTTP связана пользовательская проба, то значение SNI будет установлено по имени узла, указанного в конфигурации пользовательской пробы. Если в пользовательской пробе выбран параметр **Выбрать имя узла в наборе серверных параметров HTTP** , то значение SNI будет задано по имени узла, указанного в параметрах HTTP.

Если в параметрах HTTP задан параметр **Имя узла, выбранное в наборе серверных адресов** , то серверный пул адресов должен содержать допустимое полное доменное имя.

Если вы видите это сообщение об ошибке, это означает, что общее имя сертификата внутреннего сервера не соответствует имени узла, настроенному в пользовательской пробе или параметрах HTTP (в случае выбора параметра **Выбрать имя узла в наборе серверных параметров HTTP** ). Если используется проба по умолчанию, будет задано имя узла **127.0.0.1**. Если это значение вам не подходит, следует создать пользовательскую пробу и связать ее с параметрами HTTP.

**Решение**.

Устранить проблему можно так.

Для Windows:

1.  Войдите на компьютер, на котором размещено ваше приложение.

1.  Нажмите клавиши Win+R или щелкните правой кнопкой мыши кнопку **Пуск** , а затем выберите **Запустить**.

1.  Введите **certmgr.msc** и нажмите клавишу ВВОД. Можно также выполнить поиск диспетчера сертификатов в меню **Пуск**.

1.  Выберите сертификат (обычно он находится в `\Certificates - Current User\\Personal\\Certificates`) и откройте его.

1.  На вкладке **Сведения** проверьте значение **Subject** (Субъект) сертификата.

1.  Проверьте общее имя сертификата и введите его в поле имени узла пользовательской пробы или в параметрах HTTP (если выбран параметр **Выбрать имя узла в наборе серверных параметров HTTP** ). Если это не требуемое имя узла для вашего веб-сайта, необходимо получить сертификат для этого домена либо ввести правильное имя узла в конфигурации пользовательской пробы или параметрах HTTP.

В Linux с помощью OpenSSL сделайте следующее.

1.  Выполните приведенную ниже команду в OpenSSL.
    ```
    openssl x509 -in certificate.crt -text -noout
    ```

2.  В отображенных свойствах найдите общее имя сертификата и введите его в поле имени узла в параметрах HTTP. Если это не требуемое имя узла для вашего веб-сайта, необходимо получить сертификат для этого домена либо ввести правильное имя узла в конфигурации пользовательской пробы или параметрах HTTP.

#### <a name="backend-certificate-is-invalid"></a>Сертификат внутреннего сервера является недопустимым

**Сообщение**. сертификат внутреннего сервера является недопустимым. Текущая дата находится вне диапазона \"Действителен с\" и \"Действителен до\" для сертификата.

**Причина.** Каждый сертификат имеет срок действия, и HTTPS-подключение будет безопасным, только если TLS/SSL-сертификат сервера действителен. Текущие данные должны находиться в диапазоне **Действителен с** и **Действителен до**. Если это не так, сертификат считается недействительным и создает ошибку безопасности, ввиду чего Шлюз приложений помечает внутренний сервер как Unhealthy.

**Решение**. Если срок действия TLS/SSL-сертификата истек, продлите действие сертификата у поставщика и обновите параметры сервера с помощью нового сертификата. Если это самозаверяющий сертификат, необходимо создать действительный сертификат и передать корневой сертификат в параметры HTTP Шлюза приложений. Для этого выполните следующие действия:

1.  Откройте параметры HTTP Шлюза приложений на портале.

1.  Выберите параметр с просроченным сертификатом, выберите **Добавить сертификат** и откройте новый файл сертификата.

1.  Удалите старый сертификат с помощью значка **Удалить** рядом с сертификатом, а затем выберите **Сохранить**.

#### <a name="certificate-verification-failed"></a>Неудачная проверка сертификата

**Сообщение**. Не удалось проверить действительность сертификата внутреннего сервера. Чтобы узнать причину, проверьте данные диагностики OpenSSL на наличие сообщения, связанного с кодом ошибки {код_ошибки}.

**Причина.** Эта ошибка возникает, когда Шлюз приложений не может проверить действительность сертификата.

**Решение**. Чтобы устранить эту проблему, убедитесь, что сертификат на сервере был создан правильно. Например, вы можете использовать [OpenSSL](https://www.openssl.org/docs/man1.0.2/man1/verify.html) для проверки сертификата и его свойств, а также попытаться повторно передать сертификат в параметры HTTP Шлюза приложений.

<a name="backend-health-status-unknown"></a>Состояние работоспособности серверной части: Unknown
-------------------------------
Если состояние работоспособности серверной части — Unknown, то портал будет выглядеть как на снимке экрана ниже.

![Состояние работоспособности серверной части Шлюза приложений — Unknown](./media/application-gateway-backend-health-troubleshooting/appgwunknown.png)

Эта реакция на событие может возникать по одной или нескольким из следующих причин.

1.  Группа безопасности сети в подсети Шлюза приложений блокирует входящий доступ из Интернета к портам 65503–65534 (номер SKU версии 1) или 65200–65535 (SKU версии 2).
1.  Для UDR в подсети Шлюза приложений задан маршрут по умолчанию (0.0.0.0/0), а для следующего прыжка не указано значение "Internet" (Интернет).
1.  Маршрут по умолчанию объявляется подключением ExpressRoute или VPN к виртуальной сети по протоколу BGP.
1.  Пользовательский DNS-сервер настроен в виртуальной сети, которая не может разрешать общедоступные доменные имена.
1.  Шлюз приложения находится в состоянии Unhealthy.

**Решение**.

1.  Проверьте, не блокирует ли группа безопасности сети доступ из **Интернета** к портам 65503–65534 (номер SKU версии 1) или 65200–65535 (SKU версии 2).

    а.  На вкладке **Обзор** Шлюза приложений выберите ссылку **Виртуальная сеть и подсеть**.

    b.  На вкладке **Подсети** виртуальной сети выберите подсеть, в которой развернут Шлюз приложений.

    c.  Проверьте, настроены ли какие-либо группы безопасности сети.

    d.  Если группа безопасности сети настроена, найдите ее ресурс на вкладке **Поиск** или в разделе **Все ресурсы**.

    д)  В разделе **Inbound Rules** (Правила для входящего трафика) добавьте правило для входящего трафика, чтобы разрешить диапазон портов назначения 65503–65534 (для SKU версии 1) или 65200–65535 (для SKU версии 2), задав для параметра **Source** (Источник) значение **Any** (Любой) или **Internet** (Интернет).

    е)  Выберите **Сохранить** и убедитесь, что серверная часть отображается в состоянии Healthy. Кроме того, это можно сделать с помощью [PowerShell или интерфейса командной строки](../virtual-network/manage-network-security-group.md).

1.  Проверьте, задал ли для UDR маршрут по умолчанию (0.0.0.0/0) со следующим прыжком, отличным от **Internet** (Интернет).
    
    а.  Выполните шаги 1a и 1b, чтобы определить подсеть.

    b.  Проверьте, настроены ли UDR. Если это так, выполните поиск соответствующего ресурса на панели поиска или в разделе **Все ресурсы**.

    c.  Проверьте наличие маршрутов по умолчанию (0.0.0.0/0) со следующим прыжком, отличным от **Internet** (Интернет). Если параметр имеет значение **Virtual Appliance** (Виртуальное устройство) или **Virtual Network Gateway** (Шлюз виртуальной сети), необходимо убедиться, что виртуальное устройство или локальное устройство может правильно переслать пакет обратно в назначение в Интернете, не изменяя этот пакет.

    d.  В противном случае измените следующий прыжок на **Internet** (Интернет), выберите **Сохранить** и проверьте работоспособность серверной части.

1.  Маршрут по умолчанию объявляется подключением ExpressRoute или VPN к виртуальной сети по протоколу BGP.

    а.  При наличии подключения ExpressRoute или VPN к виртуальной сети по протоколу BGP и объявлении маршрута по умолчанию необходимо убедиться, что пакет пересылается обратно в Интернет и не изменяется. Проверить это можно с помощью параметра **Устранение неполадок с подключением** на портале Шлюза приложений.

    b.  Выберите назначение вручную, указав любой IP-адрес, поддерживающий маршрутизацию в Интернете, например 1.1.1.1. Задайте любой порт назначения и проверьте подключение.

    c.  Если следующим прыжком является шлюз виртуальной сети, то может существовать маршрут по умолчанию, объявленный через подключение ExpressRoute или VPN.

1.  Если в виртуальной сети задан настраиваемый DNS-сервер, убедитесь, что этот сервер (или серверы) может разрешать общедоступные домены. Разрешение общедоступных доменных имен может потребоваться в случаях, когда Шлюз приложений должен взаимодействовать с внешними доменами, например серверами OCSP, или проверять состояние отзыва сертификата

1.  Чтобы убедиться, что Шлюз приложений работоспособен и выполняется, перейдите к параметру **Работоспособность ресурсов** на портале проверьте, отображается ли состояние **Работоспособное**. Если вы видите состояние **Неработоспособно** или **Снижение производительности** , [обратитесь в службу поддержки](https://azure.microsoft.com/support/options/).

<a name="next-steps"></a>Дальнейшие действия
----------

Узнайте больше о [диагностике и ведении журнала для Шлюза приложений](./application-gateway-diagnostics.md).