---
title: Устранение проблем сходства сеансов
titleSuffix: Azure Application Gateway
description: В этой статье содержатся сведения об устранении проблем сходства сеансов в шлюзе приложений Azure.
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
ms.date: 11/14/2019
ms.author: absha
ms.openlocfilehash: 9f14521c15c3497bed4ffbeba44cb5d78ee4df7b
ms.sourcegitcommit: b1a8f3ab79c605684336c6e9a45ef2334200844b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/13/2019
ms.locfileid: "74047987"
---
# <a name="troubleshoot-azure-application-gateway-session-affinity-issues"></a>Устранение проблем с сходством сеансов шлюза приложений Azure

Узнайте, как диагностировать и устранять проблемы сходства сеансов с шлюзом приложений Azure.


[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="overview"></a>Обзор

Функция сходства сеансов на основе файлов cookie удобна, если нужно, чтобы сеанс пользователя выполнялся на одном и том же сервере. Используя управляемые шлюзом файлы cookie, шлюз приложений может направлять последующий трафик из сеанса пользователя на тот же сервер для обработки. Эта функция важна, когда состояние сеанса сохраняется локально на сервере для сеанса пользователя.

## <a name="possible-problem-causes"></a>Возможные причины проблем

Проблема поддержания сходства сеансов на основе файлов cookie может быть вызвана следующими основными причинами.

- Параметр "сходство на основе файлов cookie" не включен
- Приложение не может управлять сходством на основе файлов cookie
- Приложение использует сходство на основе файлов cookie, но запросы по-прежнему возступают между внутренними серверами

### <a name="check-whether-the-cookie-based-affinity-setting-is-enabled"></a>Проверьте, включен ли параметр "сходство на основе файлов cookie"

Иногда проблемы сходства сеансов могут возникнуть, если вы забыли включить параметр "сходство на основе файлов cookie". Чтобы определить, включен ли параметр "сходство на основе файлов cookie" на вкладке "Параметры HTTP" портал Azure, следуйте инструкциям:

1. Войдите на [портал Azure](https://portal.azure.com/).

2. В области **навигации слева** щелкните **все ресурсы**. Щелкните имя шлюза приложений в колонке все ресурсы. Если выбранная подписка уже содержит несколько ресурсов, можно ввести имя шлюза приложений в поле **Фильтр по имени...** чтобы быстро получить доступ к необходимому шлюзу приложений.

3. Выберите вкладку **Параметры HTTP** в разделе **Параметры**.

   ![Устранение неполадок — проблемы с сходством сеансов — 1](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-1.png)

4. Щелкните **appGatewayBackendHttpSettings** справа, чтобы проверить, выбрано ли для сопоставления **на основе** файлов cookie.

   ![Устранение неполадок с сходством сеансов и проблем — 2](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-2.jpg)



Также можно проверить, что для параметра "**кукиебаседаффинити**" в разделе "**баккендхттпсеттингсколлектион**" задано значение " *включено*" с помощью одного из следующих методов:

- Выполнение [Get-азаппликатионгатевайбаккендхттпсеттинг](https://docs.microsoft.com/powershell/module/az.network/get-azapplicationgatewaybackendhttpsetting) в PowerShell
- Просмотр JSON-файла с помощью шаблона Azure Resource Manager

```
"cookieBasedAffinity": "Enabled", 
```

### <a name="the-application-cannot-handle-cookie-based-affinity"></a>Приложение не может управлять сходством на основе файлов cookie

#### <a name="cause"></a>Причина:

Шлюз приложений может выполнять сходство на основе сеанса только с помощью файла cookie.

#### <a name="workaround"></a>Возможное решение

Если приложение не может управлять сходством на основе файлов cookie, необходимо использовать внешнюю или внутреннюю подсистему балансировки нагрузки Azure или другое стороннее решение.

### <a name="application-is-using-cookie-based-affinity-but-requests-still-bouncing-between-back-end-servers"></a>Приложение использует сходство на основе файлов cookie, но запросы по-прежнему возступают между внутренними серверами

#### <a name="symptom"></a>Симптом

Вы включили параметр сходства на основе файлов cookie. при доступе к шлюзу приложений с помощью URL-адреса короткого имени в Internet Explorer, например: [http://website](http://website/) , запрос по-прежнему перемещается между внутренними серверами.

Чтобы найти эту ошибку, следуйте инструкциям:

1. Выполните трассировку веб-отладчика на "клиенте", который подключается к приложению за шлюзом приложений (в этом примере мы используем Fiddler).
    **Совет** Если вы не умеете использовать Fiddler, установите флажок "**я хочу получать сетевой трафик и проанализировать его с помощью веб-отладчика**" внизу.

2. Проверьте и Проанализируйте журналы сеансов, чтобы определить, имеют ли файлы cookie, предоставленные клиентом, сведения о Арраффинити. Если вы не нашли сведения о Арраффинити, например "**арраффинити =** *арраффинитивалуе*" в наборе файлов cookie, это означает, что клиент не отвечает на файл cookie Арра, который предоставляется шлюзом приложений.
    Например,

    ![Устранение неполадок с сходством сеансов и проблем-3](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-3.png)

    ![Устранение неполадок с сходством сеансов и проблем — 4](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-4.png)

Приложение по-своему пытается задать файл cookie для каждого запроса, пока он не получит ответ.

#### <a name="cause"></a>Причина:

Эта проблема возникает из-за того, что Internet Explorer и другие браузеры могут не хранить или использовать файл cookie с кратким именем.

#### <a name="resolution"></a>Способы устранения:

Чтобы устранить эту проблему, для доступа к Шлюзу приложений следует использовать полное доменное имя. Например, используйте [http://website.com](https://website.com/) или [http://appgw.website.com](http://appgw.website.com/) .

## <a name="additional-logs-to-troubleshoot"></a>Дополнительные журналы для устранения неполадок

Вы можете получить дополнительные журналы и проанализировать их, чтобы устранить проблемы, связанные с сходством сеансов на основе файлов cookie.

### <a name="analyze-application-gateway-logs"></a>Анализ журналов шлюза приложений

Чтобы получить журналы шлюза приложений, следуйте инструкциям:

Включение ведения журнала на портале Azure

1. В [портал Azure](https://portal.azure.com/)найдите ресурс, а затем щелкните **журналы диагностики**.

   Для шлюза приложений доступны три журнала: журнал доступа, журнал производительности, журнал брандмауэра.

2. Чтобы начать получать данные, щелкните **включить диагностику**.

   ![Устранение неполадок с сходством сеансов и проблем — 5](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-5.png)

3. В колонке **Параметры диагностики** представлены параметры журналов диагностики. В этом примере для хранения журналов используется Log Analytics. Щелкните **настроить** в разделе **log Analytics** , чтобы задать рабочую область. хранения журналов диагностики можно также использовать концентраторы событий и учетную запись хранения.

   ![Устранение неполадок-сеанс-сходств-проблемы — 6](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-6.png)

4. Подтвердите параметры и нажмите кнопку **сохранить**.

   ![Устранение неполадок с сходством сеансов и проблем — 7](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-7.png)

#### <a name="view-and-analyze-the-application-gateway-access-logs"></a>Просмотр и анализ журналов доступа к шлюзу приложений

1. В портал Azure в представлении ресурсов шлюза приложений в разделе **мониторинг** выберите **журналы диагностики** .

   ![Устранение неполадок с сходством сеансов и проблем — 8](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-8.png)

2. В правой части выберите "**ApplicationGatewayAccessLog**" в раскрывающемся списке **категории журналов.**  

   ![Устранение неполадок с сходством сеансов и проблем — 9](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-9.png)

3. В списке журнал доступа к шлюзу приложений выберите журнал, который нужно проанализировать и экспортировать, а затем экспортируйте файл JSON.

4. Преобразуйте JSON-файл, экспортированный в шаге 3, в CSV-файл и просмотрите его в Excel, Power BI или любом другом средстве визуализации данных.

5. Проверьте следующие данные:

- **ClientIP**— это IP-адрес клиента из подключающегося клиента.
- **Клиентпорт** — это исходный порт от клиента, подключающегося к запросу.
- **Рекуесткуери** — указывает сервер назначения, которому был получен запрос.
- **Сервер направлен**: экземпляр пула внутренних серверов, который получает запрос.
- **X-AzureApplicationGateway-LOG-ID** — идентификатор корреляции, используемый для запроса. Он может использоваться для устранения неполадок с трафиком на внутренних серверах. Например: X-AzureApplicationGateway-CACHE-ПОПАДАНИе = 0 & SERVER-ROUTEd = 10.0.2.4.

  - **SERVER-STATUS** — код отклика HTTP, полученный шлюзом приложений из серверной части.

  ![Устранение неполадок с сходством сеансов и проблем — 11](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-11.png)

Если вы видите два элемента из одного и того же ClientIP и клиентского порта, и они отправляются на тот же сервер, это означает, что шлюз приложений настроен правильно.

Если вы видите два элемента из одного и того же ClientIP и клиентского порта и они отправляются на различные внутренние серверы, это означает, что запрос перемещается между внутренними серверами, выберите "**приложение использует сходство на основе файлов cookie, но запросы, по-прежнему возвращающие данные между внутренними серверами**" в нижней части, чтобы устранить проблему.

### <a name="use-web-debugger-to-capture-and-analyze-the-http-or-https-traffics"></a>Использование веб-отладчика для сбора и анализа трафика HTTP или HTTPS

Средства веб-отладки, такие как Fiddler, могут помочь в отладке веб-приложений путем сбора сетевого трафика между Интернетом и тестовыми компьютерами. Эти средства позволяют проверять входящие и исходящие данные по мере их получения и отправки браузером. В этом примере в Fiddler есть параметр воспроизведения HTTP, который может помочь в устранении неполадок на стороне клиента в веб-приложениях, особенно для проверки подлинности.

Используйте веб-отладчик по своему усмотрению. В этом примере мы будем использовать Fiddler для сбора и анализа трафика HTTP или HTTPS, следуя инструкциям:

1. Загрузите средство Fiddler по адресу <https://www.telerik.com/download/fiddler>.

    > [!NOTE]
    > Выберите Fiddler4, если на компьютере для записи установлен .NET 4. В противном случае выберите Fiddler2.

2. Щелкните исполняемый файл программы установки правой кнопкой мыши и выполните команду от имени администратора для установки.

    ![Устранение неполадок — проблемы с сходством-сеансы — 12](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-12.png)

3. При открытии Fiddler должна автоматически запускаться запись трафика (Обратите внимание на запись в левом нижнем углу). Нажмите клавишу F12, чтобы запустить или отключить запись трафика.

    ![Устранение неполадок с сходством сеансов-проблемы — 13](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-13.png)

4. Скорее всего, вы захотите расшифровать трафик HTTPS, а также включить расшифровку HTTPS, выбрав **инструменты** > **Параметры Fiddler**и установив флажок " **расшифровать HTTPS трафик**".

    ![Устранение неполадок — проблемы с сходством-сеансы — 14](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-14.png)

5. Вы можете удалить предыдущие несвязанные сеансы, прежде чем воспроизвести ошибку, нажав кнопку **X** (значок) > **удалить все** как на снимке экрана ниже. 

    ![Устранение неполадок — проблемы с сходством-сеансы — 15](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-15.png)

6. Когда вы воссоздаете ошибку, сохраните файл для проверки, выбрав **файл** > **сохранить** > **все сеансы..** . 

    ![Устранение неполадок-сеанс-сходств-проблемы — 16](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-16.png)

7. Проверьте и Проанализируйте журналы сеансов, чтобы определить причину проблемы.

    Примеры приведены ниже.

- **Пример а.** Вы обнаружите журнал сеансов, который отправляет запрос от клиента, и переходите к общедоступному IP-адресу шлюза приложений, щелкните этот журнал, чтобы просмотреть сведения.  С правой стороны данные в нижнем поле — это то, что шлюз приложений возвращает клиенту. Выберите вкладку "необработанный" и определите, получает ли клиент "**Set-Cookie: арраффинити =** *арраффинитивалуе*". Если файл cookie отсутствует, сходство сеансов не задано или шлюз приложений не применяет файл cookie обратно к клиенту.

   > [!NOTE]
   > Это значение Арраффинити — это идентификатор файла cookie, который шлюз приложений задает клиенту для отправки на определенный сервер.

   ![Устранение неполадок-сеанс-сходств-проблемы — 17](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-17.png)

- **Пример б.** Следующий журнал сеанса, за которым следует предыдущий, — клиент, реагирующий обратно в шлюз приложений, который установил параметр АРРААФФИНИТИ. Если идентификатор cookie Арраффинити соответствует, пакет должен быть отправлен на тот же сервер, который использовался ранее. Проверьте следующие несколько строк связи HTTP, чтобы узнать, изменился ли файл cookie Арраффинити клиента.

   ![Устранение неполадок — проблемы с сходством-сеансы — 18](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-18.png)

> [!NOTE]
> Для одного и того же сеанса связи файл cookie не должен изменяться. Установите флажок в верхнем поле справа, выберите вкладку "cookies", чтобы узнать, использует ли клиент файл cookie и отправляете его обратно в шлюз приложений. В противном случае браузер клиента не сохраняет и не использует файл cookie для диалогов. Иногда клиент может находиться в.

 

## <a name="next-steps"></a>Дополнительная информация

Если описанные выше шаги не устранят проблему, отправьте [запрос в службу поддержки](https://azure.microsoft.com/support/options/).
