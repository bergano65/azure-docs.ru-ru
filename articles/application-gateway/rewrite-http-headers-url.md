---
title: Перезапись HTTP-заголовков и URL-адреса с помощью шлюза приложений Azure | Документация Майкрософт
description: В этой статье приведены общие сведения о перезаписи заголовков HTTP и URL-адресов в шлюзе приложений Azure.
services: application-gateway
author: surajmb
ms.service: application-gateway
ms.topic: conceptual
ms.date: 07/16/2020
ms.author: surmb
ms.openlocfilehash: 46cb4d0d099cd21db3ce51c337d3b059206bb425
ms.sourcegitcommit: 3d79f737ff34708b48dd2ae45100e2516af9ed78
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "87100364"
---
# <a name="rewrite-http-headers-and-url-with-application-gateway"></a>Перезапись заголовков HTTP и URL-адреса с помощью шлюза приложений

 Шлюз приложений позволяет перезаписывать выделенное содержимое запросов и ответов. С помощью этой функции можно транслировать URL-адреса, параметры строки запроса, а также заголовки запросов и ответов на изменение. Он также позволяет добавлять условия для того, чтобы URL-адрес или указанные заголовки перезаписывались только при соблюдении определенных условий. Эти условия основываются на сведениях о запросе и ответе.

>[!NOTE]
>Функции перезаписи заголовка HTTP и URL-адреса доступны только для [SKU шлюза приложений версии 2](application-gateway-autoscaling-zone-redundant.md)

## <a name="rewrite-types-supported"></a>Поддерживаемые типы перезаписи

### <a name="request-and-response-headers"></a>Заголовки запросов и ответов

Заголовки HTTP позволяют клиенту и серверу передавать дополнительные сведения с помощью запроса или ответа. Переписав эти заголовки, вы можете выполнять важные задачи, такие как добавление полей заголовка, связанных с безопасностью, таких как HSTS/X-XSS-Protection, удаление полей заголовка ответа, которые могут раскрывать конфиденциальную информацию, и удаление сведений о портах из перенаправляемых по оси X для заголовков.

Шлюз приложений поддерживает возможность добавления, удаления и обновления заголовков запросов и ответов HTTP, пока пакеты запросов и ответов перемещаются между клиентским и внутренним пулами.

Дополнительные сведения о перезаписи заголовков запросов и ответов с помощью шлюза приложений с использованием портал Azure см. [здесь](rewrite-url-portal.md).

![img](./media/rewrite-http-headers-url/header-rewrite-overview.png)


**Поддерживаемые заголовки**

Вы можете переписать все заголовки в запросах и ответах, за исключением соединения и заголовков обновления. Шлюз приложений также можно использовать для создания пользовательских заголовков и их добавления к запросам и ответам, направляемым через него.

### <a name="url-path-and-query-string-preview"></a>URL-путь и строка запроса (Предварительная версия)

Возможность переопределения URL-адресов в шлюзе приложений позволяет:

* Перезапись имени узла, пути и строки запроса URL-адреса запроса 

* Выберите перезапись URL-адреса всех запросов на прослушивателе или только те запросы, которые соответствуют одному или нескольким заданным условиям. Эти условия основаны на свойствах запроса и ответа (запрос, заголовок, заголовок ответа и переменные сервера).

* Выберите маршрутизацию запроса (выберите внутренний пул) на основе исходного URL-адреса или перезаписанного URL-адреса.

Чтобы узнать, как переписать URL-адрес с помощью шлюза приложений, используя портал Azure, см. [здесь](rewrite-url-portal.md).

![img](./media/rewrite-http-headers-url/url-rewrite-overview.png)

>[!NOTE]
> Функция переопределения URL-адресов доступна в предварительной версии и доступна только для Standard_v2 и WAF_v2 SKU шлюза приложений. Не рекомендуется использовать в рабочей среде. Дополнительные сведения о предварительных версиях см. в [статье условия использования](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

## <a name="rewrite-actions"></a>Действия перезаписи

Используйте действия перезаписи для указания URL-адреса, заголовков запроса или заголовков ответа, которые требуется перезаписать, и нового значения, в которое предполагается переписать их. Значение URL-адреса или нового или существующего заголовка может быть задано для следующих типов значений:

* Text
* Заголовок запроса. Чтобы указать заголовок запроса, необходимо использовать синтаксис {http_req_*хеадернаме*}
* Заголовок ответа. Чтобы указать заголовок ответа, необходимо использовать синтаксис {http_resp_*хеадернаме*}
* Переменная сервера. Чтобы указать переменную сервера, необходимо использовать синтаксис {var_*сервервариабле*}. См. список поддерживаемых серверных переменных.
* Сочетание текста, заголовка запроса, заголовка ответа и переменной сервера. 

## <a name="rewrite-conditions"></a>Условия перезаписи

Можно использовать условия перезаписи, необязательную конфигурацию, чтобы оценить содержимое запросов и ответов HTTP (S) и выполнить перезапись только при выполнении одного или нескольких условий. Шлюз приложений использует эти типы переменных для вычисления содержимого запросов и ответов.

* Заголовки HTTP в запросе
* Заголовки HTTP в ответе
* Переменные сервера шлюза приложений

Можно использовать условие, чтобы определить, существует ли указанная переменная, соответствует ли указанная переменная конкретному значению, или же указанная переменная будет соответствовать определенному шаблону. 


### <a name="pattern-matching"></a>Сопоставление шаблонов 

Шлюз приложений использует регулярные выражения для сопоставления шаблонов в условии. Для настройки сопоставления шаблона регулярного выражения в условиях можно использовать [библиотеку совместимых регулярных выражений (PCRE) с Perl](https://www.pcre.org/) . Дополнительные сведения о синтаксисе регулярных выражений см. на [странице Главная страница регулярных выражений Perl](https://perldoc.perl.org/perlre.html).

### <a name="capturing"></a>Захватываемая

Чтобы записать подстроку для последующего использования, заключите вложенный шаблон в круглые скобки, которые соответствуют ему в определении регулярного выражения условия. Первая пара скобок хранит свою подстроку в 1, вторую пару в 2 и т. д. Вы можете использовать столько круглых скобок, сколько вам нравится. Perl просто позволяет определить больше числовых переменных для представления этих захваченных строк. Некоторые примеры из [ссылки](https://docstore.mik.ua/orelly/perl/prog3/ch05_07.htm): 

*  /(\d) (\d)/# соответствует двум цифрам, записывая их в группы 1 и 2 

* /(\d +)/# совпадение с одной или несколькими цифрами, записывая их в группу 1 

* /(\d) +/# совпадение с цифрой один или более раз, запись последней в группу 1

После записи вы можете ссылаться на них в наборе действий, используя следующий формат:

* Для записи заголовка запроса необходимо использовать {http_req_headerName_groupNumber}. Например, {http_req_User-Agent_1} или {http_req_User-Agent_2}
* Для записи заголовка ответа необходимо использовать {http_resp_headerName_groupNumber}. Например, {http_resp_Location_1} или {http_resp_Location_2}
* Для серверной переменной необходимо использовать {var_serverVariableName_groupNumber}. Например, {var_uri_path_1} или {var_uri_path_2}

Если вы хотите использовать целое значение, не следует упоминание этого числа. Просто используйте формат {http_req_headerName} и т. д. без Граупнумбер.

## <a name="server-variables"></a>Переменные сервера

Шлюз приложений использует переменные сервера для хранения полезной информации о сервере, подключении к клиенту и текущем запросе к соединению. Примеры хранимых сведений включают IP-адрес клиента и тип веб-браузера. Переменные сервера изменяются динамически, например при загрузке новой страницы или при публикации формы. Эти переменные можно использовать для вычисления условий перезаписи и перезаписи заголовков. Чтобы использовать значения переменных сервера для перезаписи заголовков, необходимо указать эти переменные в синтаксисе {var_*сервервариабленаме*}.

Шлюз приложений поддерживает следующие переменные сервера:

|   Имя переменной    |                   Описание                                           |
| ------------------------- | ------------------------------------------------------------ |
| add_x_forwarded_for_proxy | Поле заголовка X-Forwarded — для запроса клиента с `client_ip` переменной (см. описание далее в этой таблице) добавляется к ней в формате IP1, IP2, IP3 и т. д. Если в заголовке запроса клиента нет поля X-Forwardd-for, `add_x_forwarded_for_proxy` переменная будет равна `$client_ip` переменной.   Эта переменная особенно полезна при необходимости перезаписи заголовка X-Forwardd-for, установленного шлюзом приложений, чтобы заголовок содержал только IP-адрес без сведений о порте. |
| ciphers_supported         | Список шифров, поддерживаемых клиентом.               |
| ciphers_used              | Строка шифров, используемых для установленного подключения TLS. |
| client_ip                 | IP-адрес клиента, от которого шлюз приложений получил запрос. Если перед шлюзом приложений и исходным клиентом есть обратный прокси-сервер, *Client_IP* возвратит IP-адрес обратного прокси-сервера. |
| client_port               | Порт клиента.                                             |
| client_tcp_rtt            | Сведения о TCP-подключении клиента. Доступно в системах, поддерживающих параметр сокета TCP_INFO. |
| client_user               | При использовании проверки подлинности HTTP имя пользователя, передаваемое для проверки подлинности. |
| узел                      | В порядке приоритета: имя узла из строки запроса, имя узла из поля заголовка запроса узла или имя сервера, соответствующее запросу. Пример. в запросе *http://contoso.com:8080/article.aspx?id=123&title=fabrikam* значение узла будет равно *contoso.com* . |
| *имя* cookie_             | *Имя* файла cookie.                                           |
| http_method               | Метод, используемый для выполнения запроса URL-адреса. Например, GET или POST. |
| http_status               | Состояние сеанса. Например, 200, 400 или 403.           |
| http_version              | Протокол запроса. Обычно HTTP/1.0, HTTP/1.1 или HTTP/2.0. |
| query_string              | Список пар "переменная-значение", следующий за "?" в запрошенном URL-адресе. Пример. в запросе *http://contoso.com:8080/article.aspx?id=123&title=fabrikam* QUERY_STRING значение будет *ID = 123&Title = Fabrikam* . |
| received_bytes            | Длина запроса (включая строку запроса, заголовок и текст запроса). |
| request_query             | Аргументы в строке запроса.                           |
| request_scheme            | Схема запроса: HTTP или HTTPS.                           |
| request_uri               | Полный URI исходного запроса (с аргументами). Пример. в запросе *http://contoso.com:8080/article.aspx?id=123&title=fabrikam* REQUEST_URI значение будет */артикле.аспкс? ID = 123&Title = Fabrikam* |
| sent_bytes                | Число байтов, отправленных клиенту.                        |
| server_port               | Порт сервера, который принял запрос.              |
| ssl_connection_protocol   | Протокол установленного подключения TLS.               |
| ssl_enabled               | "On", если соединение работает в режиме TLS. В противном случае — пустая строка. |
| uri_path                  | Определяет конкретный ресурс на узле, к которому требуется доступ веб-клиент. Это часть URI запроса без аргументов. Пример. в запросе *http://contoso.com:8080/article.aspx?id=123&title=fabrikam* uri_path значение будет равно */артикле.аспкс* . |

 

## <a name="rewrite-configuration"></a>Перезапись конфигурации

Чтобы настроить правило перезаписи, необходимо создать набор правил перезаписи и добавить в него конфигурацию правила перезаписи.

Набор правил перезаписи содержит:

* **Сопоставление правил маршрутизации запросов:** Конфигурация перезаписи связана с прослушивателем источника с помощью правила маршрутизации. При использовании базового правила маршрутизации конфигурация перезаписи связана с прослушивателем источника и перезаписывается глобальным заголовком. При использовании правила маршрутизации на основе пути конфигурация перезаписи определяется на карте URL-пути. В этом случае он применяется только к определенной области пути сайта. Можно создать несколько наборов перезаписи и применить каждый набор перезаписи к нескольким прослушивателям. Но для конкретного прослушивателя можно применить только один набор перезаписи.

* **Условие перезаписи**: это необязательная конфигурация. Условия перезаписи оценивают содержимое запросов и ответов HTTP (S). Действие перезаписи будет выполнено, если запрос HTTP (S) или ответ соответствует условию перезаписи. При связывании более одного условия с действием действие выполняется только при соблюдении всех условий. Иными словами, операция является логической операцией и.

* **Тип перезаписи**: доступны три типа перезаписи:
   * Перезапись заголовков запросов 
   * Перезапись заголовков ответа.
   * Перезапись URL-адреса: тип переопределения URL-адреса имеет 3 компонента
      * **URL-путь**: значение, в которое следует перезаписывать путь. 
      * **Строка запроса URL-адреса**: значение, в которое должна быть перезаписана строка запроса. 
      * **Повторная оценка схемы пути**. используется, чтобы определить, следует ли повторно вычислить карту URL-пути. Если флажок не установлен, исходный URL-адрес будет использоваться для сопоставления шаблона пути на карте URL-пути. Если задано значение true, сопоставление пути URL-адреса будет перечислено для проверки соответствия с перезаписанным путем. Включение этого параметра помогает в маршрутизации запроса к другому внутреннему пулу, перезаписанному после перезаписи.

### <a name="common-scenarios-for-header-rewrite"></a>Распространенные сценарии для перезаписи заголовков

#### <a name="remove-port-information-from-the-x-forwarded-for-header"></a>Удаление сведений о портах из заголовка X-Forwardd-for

Шлюз приложений вставляет заголовок X-Forwardd-for во все запросы, прежде чем перенаправит запросы в серверную часть. Этот заголовок представляет собой разделенный запятыми список IP-портов. Могут существовать сценарии, в которых серверным серверам требуются только заголовки для хранения IP-адресов. Можно использовать перезапись заголовка для удаления сведений о портах из заголовка X-Forwardd-for. Один из способов сделать это — задать в качестве заголовка переменную сервера add_x_forwarded_for_proxy. Кроме того, можно использовать переменную client_ip:

![Удалить порт](./media/rewrite-http-headers-url/remove-port.png)


#### <a name="modify-a-redirection-url"></a>Изменение URL-адреса перенаправления

Когда серверное приложение отправляет ответ перенаправления, может потребоваться перенаправить клиента на URL-адрес, отличный от того, который указан в серверном приложении. Например, это может потребоваться, если служба приложений размещена за шлюзом приложений и требует от клиента перенаправления к относительному пути. (Например, перенаправление с contoso.azurewebsites.net/path1 на contoso.azurewebsites.net/path2.)

Так как служба приложений является многоклиентской службой, она использует заголовок узла в запросе для маршрутизации запроса в правильную конечную точку. Службы приложений имеют доменное имя по умолчанию *. azurewebsites.net (скажем, contoso.azurewebsites.net), которое отличается от доменного имени шлюза приложений (скажем, contoso.com). Поскольку исходный запрос клиента имеет доменное имя шлюза приложений (contoso.com) в качестве имени узла, шлюз приложений изменяет имя узла на contoso.azurewebsites.net. Он делает это изменение, чтобы служба приложений могла направить запрос в правильную конечную точку.

Когда служба приложений отправляет ответ перенаправления, она использует то же имя узла в заголовке Location своего ответа, что и в запросе, полученном от шлюза приложений. Поэтому клиент сделает запрос напрямую contoso.azurewebsites.net/path2, а не через шлюз приложений (contoso.com/path2). Обход шлюза приложений нежелательно.

Эту проблему можно устранить, задав имя узла в заголовке Location в качестве доменного имени шлюза приложений.

Ниже приведены действия по замене имени узла.

1. Создайте правило перезаписи с условием, которое оценивает, содержит ли заголовок Location в ответе azurewebsites.net. Введите шаблон `(https?):\/\/.*azurewebsites\.net(.*)$` .
2. Выполните действие, чтобы перезаписать заголовок Location так, чтобы в нем было указано имя узла шлюза приложений. Для этого введите в `{http_resp_Location_1}://contoso.com{http_resp_Location_2}` качестве значения заголовка. Кроме того, можно также использовать переменную сервера, `host` чтобы задать имя узла в соответствии с исходным запросом.

![Изменить заголовок расположения](./media/rewrite-http-headers-url/app-service-redirection.png)

#### <a name="implement-security-http-headers-to-prevent-vulnerabilities"></a>Реализация заголовков HTTP безопасности для предотвращения уязвимостей

Можно устранить несколько уязвимостей системы безопасности, реализовав необходимые заголовки в ответе приложения. К этим заголовкам относятся: X-XSS-Protection, долгосрочный-Transport-Security и Content-Security-Policy. Вы можете использовать шлюз приложений, чтобы задать эти заголовки для всех ответов.

![Заголовок безопасности](./media/rewrite-http-headers-url/security-header.png)

### <a name="delete-unwanted-headers"></a>Удалить ненужные заголовки

Может потребоваться удалить заголовки, которые раскрывают конфиденциальную информацию из HTTP-ответа. Например, может потребоваться удалить такие сведения, как имя сервера, сведения об операционной системе или библиотеке. Для удаления этих заголовков можно использовать шлюз приложений:

![Удаление заголовка](./media/rewrite-http-headers-url/remove-headers.png)

#### <a name="check-for-the-presence-of-a-header"></a>Проверка наличия заголовка

Можно оценить HTTP-запрос или заголовок ответа на наличие заголовка или серверной переменной. Эта оценка полезна, если требуется выполнить перезапись заголовка только при наличии определенного заголовка.

![Проверка наличия заголовка](./media/rewrite-http-headers-url/check-presence.png)

### <a name="common-scenarios-for-url-rewrite"></a>Распространенные сценарии для переопределения URL-адресов

#### <a name="parameter-based-path-selection"></a>Выбор пути на основе параметров

Для выполнения сценариев, в которых необходимо выбрать серверный пул на основе значения заголовка, части URL-адреса или строки запроса в запросе, можно использовать сочетание возможностей переопределения URL-адресов и маршрутизации на основе пути.  Например, если у вас есть веб-сайт для покупок, а категория продуктов передается в качестве строки запроса в URL-адресе и вы хотите направить запрос на серверную часть на основе строки запроса, то:

**Шаг 1:**  Создайте карту пути, как показано на рисунке ниже.

:::image type="content" source="./media/rewrite-http-headers-url/url-scenario1-1.png" alt-text="Сценарий перезаписи URL-адресов 1-1.":::

**Шаг 2 (a):** Создайте набор перезаписи, который содержит 3 правила перезаписи: 

* Первое правило имеет условие, которое проверяет переменную *QUERY_STRING* для *Category = обувь* и имеет действие, которое перезаписывает путь URL-адреса в/*listing1* и **повторно вычисляет карту пути** .

* Второе правило имеет условие, которое проверяет переменную *QUERY_STRING* для *Category* и имеет действие, которое перезаписывает путь URL-адреса в/*listing2* и **повторно вычисляет карту пути** .

* Третье правило имеет условие, которое проверяет переменную *QUERY_STRING* для *Category = аксессуары* и имеет действие, которое переписывает путь URL-адреса в/*listing3* и **повторно вычисляет карту пути** .

:::image type="content" source="./media/rewrite-http-headers-url/url-scenario1-2.png" alt-text="Сценарий перезаписи URL-адресов 1-2.":::

 

**Шаг 2 (b):** Свяжите этот набор перезаписи с путем по умолчанию для приведенного выше правила на основе пути.

:::image type="content" source="./media/rewrite-http-headers-url/url-scenario1-3.png" alt-text="Сценарий перезаписи URL-адресов 1-3.":::

Теперь, если пользователь запрашивает *contoso.com/Listing?Category=Any*, он будет сопоставлен с путем по умолчанию, так как ни один из шаблонов путей в карте пути (/listing1,/listing2,/listing3) не будет совпадать. Так как вы состроили приведенный выше набор перезаписи с этим путем, этот набор перезаписи будет оценен. Так как строка запроса не будет соответствовать условию ни в одном из трех правил перезаписи в этом наборе перезаписи, действие перезаписи не выполняется и, следовательно, запрос будет маршрутизироваться без изменений в серверную часть, связанную с путем по умолчанию ( *женериклист*).

 Если пользователь запрашивает *contoso.com/Listing?Category=Shoes,* то снова будет найден путь по умолчанию. Однако в этом случае условие в первом правиле будет сопоставлено и, следовательно, будет выполнено действие, связанное с условием, которое перезапишет путь URL-адреса в/*listing1* и выполнит повторное вычисление пути. При повторном вычислении сопоставления пути запрос будет соответствовать пути, связанному с шаблоном */listing1* , и запрос будет направлен на серверную часть, связанную с этим шаблоном, то есть шоеслистбаккендпул

>[!NOTE]
>Этот сценарий может быть расширен до любого значения заголовка или файла cookie, пути URL-адреса, строки запроса или серверных переменных на основе определенного условия и, по сути, позволяет маршрутизировать запросы на основе этих условий.

#### <a name="rewrite-query-string-parameters-based-on-the-url"></a>Переписать параметры строки запроса на основе URL-адреса

Рассмотрим сценарий веб-сайта для покупок, где видимая пользователю ссылка должна быть простой и удобочитаемой, но на внутреннем сервере требуются параметры строки запроса для отображения правильного содержимого.

В этом случае шлюз приложений может записывать параметры из URL-адреса и добавлять пары "ключ-значение" строки запроса из URL-адреса. Например, предположим, что пользователю требуется переписать, https://www.contoso.com/fashion/shirts чтобы https://www.contoso.com/buy.aspx?category=fashion&product=shirts его можно было получить с помощью следующей конфигурации переопределения URL-адреса.

**Условие** — если переменная сервера `uri_path` равна шаблону`/(.+)/(.+)`

:::image type="content" source="./media/rewrite-http-headers-url/url-scenario2-1.png" alt-text="Сценарий перезаписи URL-адресов 2-1.":::

**Действие** — задать URL-путь к `buy.aspx` строке запроса и`category={var_uri_path_1}&product={var_uri_path_2}`

:::image type="content" source="./media/rewrite-http-headers-url/url-scenario2-2.png" alt-text="Сценарий перезаписи URL-адресов 2-2.":::

Пошаговые инструкции по выполнению описанного выше сценария см. в статье [Перезапись URL-адреса с помощью шлюза приложений портал Azure](rewrite-url-portal.md)

### <a name="url-rewrite-vs-url-redirect"></a>Переопределение URL-адреса и перенаправление URL-адреса

В случае перезаписи URL-адреса шлюз приложений переписывает URL-адрес перед отправкой запроса в серверную часть. Это не изменит, какие пользователи видят в браузере, поскольку изменения скрыты от пользователя.

В случае перенаправления URL-адреса шлюз приложений отправляет клиенту ответ перенаправления с новым URL-адресом. Это, в свою очередь, требует, чтобы клиент повторно отправлял свой запрос на новый URL-адрес, указанный в перенаправлении. URL-адрес, отображаемый пользователем в браузере, будет обновлен до нового URL-адреса

:::image type="content" source="./media/rewrite-http-headers-url/url-rewrite-vs-redirect.png" alt-text="Перезапись и перенаправление.":::

## <a name="limitations"></a>Ограничения

- Если в ответе несколько заголовков с одним и тем же именем, то перезапись значения одного из этих заголовков приведет к удалению других заголовков в ответе. Обычно это происходит с заголовком Set-cookie, так как в ответе может быть несколько заголовков Set-cookie. Одним из таких сценариев является ситуация, когда вы используете службу приложений с шлюзом приложений и настроили сходство сеансов на основе файлов cookie в шлюзе приложений. В этом случае ответ будет содержать два заголовка Set-Cookie: один используется службой приложений, например: `Set-Cookie: ARRAffinity=ba127f1caf6ac822b2347cc18bba0364d699ca1ad44d20e0ec01ea80cda2a735;Path=/;HttpOnly;Domain=sitename.azurewebsites.net` и другой для сходства шлюза приложений, например `Set-Cookie: ApplicationGatewayAffinity=c1a2bd51lfd396387f96bl9cc3d2c516; Path=/` . Перезапись одного из заголовков Set-cookie в этом сценарии может привести к удалению другого заголовка Set-cookie из ответа.
- Перезапись не поддерживается, если шлюз приложений настроен для перенаправления запросов или для отображения настраиваемой страницы ошибок.
- Имена заголовков могут содержать любые буквенно-цифровые символы и специальные символы, как определено в [RFC 7230](https://tools.ietf.org/html/rfc7230#page-27). В настоящее время не поддерживается специальный символ подчеркивания (_) в именах заголовков.
- Не удается перезазаписать заголовки подключения и обновления

## <a name="next-steps"></a>Дальнейшие действия

- [Узнайте, как переписать заголовки HTTP с помощью шлюза приложений, используя портал Azure](rewrite-http-headers-portal.md)
- [Узнайте, как переписать URL-адрес с помощью шлюза приложений, используя портал Azure](rewrite-url-portal.md)
