---
title: Конфигурация инфраструктуры шлюза приложений Azure
description: В этой статье описывается настройка инфраструктуры шлюза приложений Azure.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: conceptual
ms.date: 09/09/2020
ms.author: surmb
ms.openlocfilehash: cd1dc953c35233010250bf7f959c94d1de50fe4a
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91319798"
---
# <a name="application-gateway-infrastructure-configuration"></a>Конфигурация инфраструктуры шлюза приложений

Инфраструктура шлюза приложений включает в себя виртуальную сеть, подсети, группы безопасности сети и определяемые пользователем маршруты.

## <a name="virtual-network-and-dedicated-subnet"></a>Виртуальная сеть и выделенная подсеть

Шлюз приложений — это выделенное развертывание в виртуальной сети. В виртуальной сети для шлюза приложений требуется выделенная подсеть. В подсети может быть несколько экземпляров заданного развертывания шлюза приложений. Кроме того, в подсети можно развернуть другие шлюзы приложений. Но вы не можете развернуть другие ресурсы в подсети шлюза приложений. Вы не можете смешивать Standard_v2 и стандартный шлюз приложений Azure в одной подсети.

> [!NOTE]
> [Политики конечных точек служб для виртуальной сети](../virtual-network/virtual-network-service-endpoint-policies-overview.md) в настоящее время не поддерживаются в подсети Шлюза приложений.

### <a name="size-of-the-subnet"></a>Размер подсети

Шлюз приложений использует по одному частному IP-адресу для каждого экземпляра, а другой частный IP-адрес — в случае настройки частного внешнего IP-адреса.

Azure также резервирует пять IP-адресов в каждой подсети для внутреннего использования: первые четыре и последние IP-адреса. Например, рассмотрим 15 экземпляров шлюза приложений без частного внешнего IP-адреса. Для этой подсети требуется по крайней мере 20 IP-адресов: пять для внутреннего использования и 15 для экземпляров шлюза приложений.

Рассмотрим подсеть с 27 экземплярами шлюза приложений и IP-адресом частного IP-адреса внешнего интерфейса. В этом случае вам потребуется 33 IP-адресов: 27 для экземпляров шлюза приложений, один для частного внешнего интерфейса и пять для внутреннего использования.

SKU шлюза приложений (Standard или WAF) может поддерживать до 32 экземпляров (32 IP-адресов экземпляра + 1 частный интерфейсный IP-адрес + 5 Azure зарезервирован), поэтому рекомендуется использовать минимальный размер подсети/26.

Шлюз приложений (Standard_v2 или WAF_v2 SKU) может поддерживать до 125 экземпляров (125 IP-адресов экземпляра + 1 частный интерфейсный IP-адрес + 5 Azure зарезервирован), поэтому рекомендуется использовать минимальный размер подсети/24.

## <a name="network-security-groups"></a>Группы безопасности сети

Группы безопасности сети (группы безопасности сети) поддерживаются в шлюзе приложений. Но существуют некоторые ограничения.

- Необходимо разрешить входящий трафик Интернета через TCP-порты 65503–65534 для номера SKU шлюза приложений версии 1, а также через TCP-порты 65200–65535 для номера SKU версии 2 с целевой подсетью **Любая** и источником **GatewayManager** (тег службы источника). Такой диапазон портов требуется для обмена данными в рамках инфраструктуры Azure. Эти порты защищены (заблокированы) сертификатами Azure. Внешние сущности, включая клиентов этих шлюзов, не могут обмениваться данными с этими конечными точками.

- Исходящее подключение к Интернету не может быть заблокировано. Правила исходящего трафика по умолчанию в NSG разрешают подключение к Интернету. Мы рекомендуем следующее:

  - Не удаляйте правила исходящего трафика по умолчанию.
  - Не создавайте другие правила исходящего трафика, которые запрещают исходящие подключения.

- **Должен быть** разрешен трафик из тега **AzureLoadBalancer** с конечной подсетью.

### <a name="allow-access-to-a-few-source-ips"></a>Разрешить доступ к некоторым исходным IP-адресам

В этом сценарии используйте группы безопасности сети в подсети шлюза приложений. Установите следующие ограничения для подсети в следующем порядке приоритета:

1. Разрешите входящий трафик из исходного IP-адреса или диапазона IP-адресов с назначением в качестве целого диапазона адреса подсети шлюза приложений и порта назначения в качестве порта входящего доступа, например порт 80 для доступа по протоколу HTTP.
2. Разрешите входящие запросы от источника в качестве тега службы **гатевайманажер** и назначения в качестве **любых** портов назначения, а также порты назначений 65503-65534 для SKU шлюза приложений версии 1 и порты 65200-65535 для SKU v2 для [обмена данными о состоянии работоспособности серверной](https://docs.microsoft.com/azure/application-gateway/application-gateway-diagnostics)части. Такой диапазон портов требуется для обмена данными в рамках инфраструктуры Azure. Эти порты защищены (заблокированы) сертификатами Azure. Без соответствующих сертификатов на месте внешние сущности не могут инициировать изменения на этих конечных точках.
3. Разрешите входящие проверки Azure Load Balancer (тег*AzureLoadBalancer* ) и входящий трафик виртуальной сети (тег*VirtualNetwork* ) в [группе безопасности сети](https://docs.microsoft.com/azure/virtual-network/security-overview).
4. Блокировать весь остальной входящий трафик с помощью правила "запретить все".
5. Разрешите исходящий трафик в Интернет для всех назначений.

## <a name="supported-user-defined-routes"></a>Поддерживаемые определяемые пользователем маршруты 

> [!IMPORTANT]
> Использование определяемые пользователем маршруты в подсети шлюза приложений может привести к тому, что состояние работоспособности в [представлении работоспособности серверной](https://docs.microsoft.com/azure/application-gateway/application-gateway-diagnostics#back-end-health) части будет отображаться как **неизвестное**. Это также может привести к сбою при создании журналов и метрик шлюза приложений. Рекомендуется не использовать определяемые пользователем маршруты в подсети шлюза приложений, чтобы можно было просматривать сведения о работоспособности, журналах и метриках серверной части.

- **Версия 1**

   Для SKU версии 1 определяемые пользователем маршруты (определяемые пользователем маршруты) поддерживаются в подсети шлюза приложений, если они не меняют сквозную связь между запросами и ответами. Например, можно настроить UDR в подсети шлюза приложений, чтобы она указывала на устройство брандмауэра для проверки пакетов. Но необходимо убедиться, что пакет может достичь предполагаемого назначения после проверки. Несоблюдение этого действия может привести к неправильному поведению проверки работоспособности или маршрутизации трафика. Сюда входят полученные маршруты или маршруты 0.0.0.0/0 по умолчанию, распространяемые Azure ExpressRoute или VPN-шлюзы в виртуальной сети. Любой сценарий, в котором 0.0.0.0/0 должен перенаправляться локально (принудительное туннелирование), не поддерживается для v1.

- **Версия 2**

   Для SKU версии 2 поддерживаются и неподдерживаемые сценарии:

   **Поддерживаемые сценарии v2**
   > [!WARNING]
   > Неправильная конфигурация таблицы маршрутов может привести к появлению асимметричной маршрутизации в шлюзе приложений версии 2. Убедитесь, что весь трафик плоскости управления и управления отправляется непосредственно в Интернет, а не через виртуальное устройство. Также могут быть затронуты журналы и метрики.


  **Сценарий 1**. UDR. Отключение распространения маршрута протокол BGP (BGP) к подсети шлюза приложений

   Иногда маршрут шлюза по умолчанию (0.0.0.0/0) объявляется через шлюзы ExpressRoute или VPN, связанные с виртуальной сетью шлюза приложений. Это приводит к разрыву трафика плоскости управления, для которого требуется прямой путь к Интернету. В таких случаях для отключения распространения маршрутов BGP можно использовать UDR. 

   Чтобы отключить распространение маршрутов BGP, выполните следующие действия.

   1. Создайте ресурс таблицы маршрутов в Azure.
   2. Отключите параметр **распространения маршрута шлюза виртуальной сети** . 
   3. Свяжите таблицу маршрутов с соответствующей подсетью. 

   Включение UDR для этого сценария не должно привести к нарушению существующих настроек.

  **Сценарий 2**. UDR to Direct 0.0.0.0/0 в Интернете

   Вы можете создать UDR для отправки трафика 0.0.0.0/0 непосредственно в Интернет. 

  **Сценарий 3**. UDR для службы Kubernetes Azure с кубенет

  Если вы используете кубенет со службой Kubernetes Azure (AKS) и контроллером входящего трафика шлюза приложений (АГИК), вам потребуется Таблица маршрутов, чтобы разрешить маршрутизацию трафика, отправляемого в модули Pod из шлюза приложений, на правильный узел. Это не потребуется, если вы используете Azure CNI. 

  Чтобы использовать таблицу маршрутов для кубенет работы, выполните следующие действия:

  1. Перейдите к группе ресурсов, созданной с помощью AKS (имя группы ресурсов должно начинаться с "MC_").
  2. Найдите таблицу маршрутов, созданную с помощью AKS в этой группе ресурсов. Таблица маршрутов должна быть заполнена следующими сведениями:
     - Префикс адреса должен быть IP-диапазоном модулей Pod, которые вы хотите получить в AKS. 
     - Тип следующего прыжка должен быть виртуальным устройством. 
     - Адресом следующего прыжка должен быть IP-адрес узла, на котором размещаются модули.
  3. Свяжите эту таблицу маршрутов с подсетью шлюза приложений. 
    
  **версии 2 Неподдерживаемые сценарии**

  **Сценарий 1**. UDR для виртуальных устройств

  Любой сценарий, в котором 0.0.0.0/0 должен перенаправляться через любое виртуальное устройство, виртуальную сеть, периферийную или локальную (принудительное туннелирование), не поддерживается для версии 2.

## <a name="next-steps"></a>Дальнейшие шаги

- [Сведения о конфигурации интерфейсных IP-адресов](configuration-front-end-ip.md).