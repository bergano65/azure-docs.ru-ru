---
title: Контрольный список для обеспечения масштабируемости и производительности для Хранилища очередей в службе хранилища Azure
description: Контрольный список проверенных методов для работы с Хранилищем очередей при разработке высокопроизводительных приложений.
services: storage
author: tamram
ms.service: storage
ms.topic: overview
ms.date: 10/10/2019
ms.author: tamram
ms.subservice: queues
ms.openlocfilehash: 8ab4cb6b06f0f023a8f6368dac633a97afe29fd4
ms.sourcegitcommit: bb65043d5e49b8af94bba0e96c36796987f5a2be
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2019
ms.locfileid: "72390024"
---
# <a name="performance-and-scalability-checklist-for-queue-storage"></a>Контрольный список для обеспечения масштабируемости и производительности для Хранилища очередей

Корпорация Майкрософт разработала ряд проверенных методик для разработки высокопроизводительных приложений для работы с Хранилищем очередей. Этот контрольный список определяет основные методики, которые помогут разработчикам оптимизировать производительность. Учитывайте эти рекомендации при проектировании приложения и на протяжении всего процесса разработки.

Служба хранилища Azure имеет целевые показатели по масштабируемости и производительности, выраженные в объемах, скорости транзакций и пропускной способности. Дополнительные сведения о целевых показателях масштабируемости для службы хранилища Azure см. в [этой статье](../common/storage-scalability-targets.md?toc=%2fazure%2fstorage%2fqueues%2ftoc.json).

## <a name="checklist"></a>Контрольный список

В этой статье проверенные методы повышения производительности собраны в контрольный список, который поможет вам разрабатывать приложения для работы с Хранилищем очередей.

| Готово | Категория | Рекомендации по проектированию |
| --- | --- | --- |
| &nbsp; |Целевые показатели масштабируемости |[Можно ли спроектировать приложение так, чтобы количество используемых учетных записей хранения не превышало максимальное значение?](#maximum-number-of-storage-accounts) |
| &nbsp; |Целевые показатели масштабируемости |[Удастся ли вам избежать приближения к предельным значениям емкости и количеству транзакций?](#capacity-and-transaction-targets) |
| &nbsp; |Сеть |[Имеют ли клиентские устройства достаточно высокую пропускную способность и достаточно низкую задержку для достижения необходимой производительности?](#throughput) |
| &nbsp; |Сеть |[Имеют ли клиентские устройства достаточно высокое качество связи?](#link-quality) |
| &nbsp; |Сеть |[Размещено ли клиентское приложение в том же регионе, что и учетная запись хранения?](#location) |
| &nbsp; |Прямой клиентский доступ |[Используются ли подписанные URL-адреса (SAS) и общий доступ к ресурсам независимо от источника (CORS) для организации прямого доступа к службе хранилища Azure?](#sas-and-cors) |
| &nbsp; |Конфигурация .NET |[Используется ли .NET Core 2.1 или более поздней версии, чтобы обеспечить оптимальную производительность?](#use-net-core) |
| &nbsp; |Конфигурация .NET |[Вы настроили свой клиент на использование достаточного количества одновременных подключений?](#increase-default-connection-limit) |
| &nbsp; |Конфигурация .NET |[Настроено ли для приложений .NET использование достаточного количества потоков?](#increase-minimum-number-of-threads) |
| &nbsp; |Parallelism |[Ограничен ли параллелизм достаточным образом, чтобы нагрузка не превышала возможности клиента и не приближалась к целевым показателям масштабируемости?](#unbounded-parallelism) |
| &nbsp; |Средства |[Используются ли последние версии клиентских библиотек и инструментов, предоставленных корпорацией Майкрософт?](#client-libraries-and-tools) |
| &nbsp; |Повторы |[Используется ли политика повтора с экспоненциальной задержкой для ошибок регулирования и превышения времени ожидания?](#timeout-and-server-busy-errors) |
| &nbsp; |Повторы |[Ваше приложение избегает повторов неповторяемых ошибок?](#non-retryable-errors) |
| &nbsp; |Конфигурация |[Отключен ли алгоритм Nagle для повышения производительности небольших запросов?](#disable-nagle) |
| &nbsp; |Размер сообщения |[Ваши сообщения сжаты для повышения производительности очереди?](#message-size) |
| &nbsp; |Массовое получение |[Получает ли одна операция GET сразу несколько сообщений?](#batch-retrieval) |
| &nbsp; |Частота опроса |[Частота опроса достаточна для уменьшения наблюдаемой задержки приложения?](#queue-polling-interval) |
| &nbsp; |Сообщение об обновлении |[Используется ли операция Update Message для мониторинга обработки сообщений, чтобы избежать повторной обработки всего сообщения при возникновении ошибки?](#use-update-message) |
| &nbsp; |Архитектура |[Используете ли вы очереди для того, чтобы сделать все приложение более масштабируемым, не допуская длительных рабочих нагрузок на критическом пути и масштабируя их самостоятельно?](#application-architecture) |

## <a name="scalability-targets"></a>Целевые показатели масштабируемости

Если приложение достигает одного из целевых показателей масштабируемости или превышает его, оно может столкнуться с увеличением задержки транзакций или запуском механизма регулировки количества запросов. Когда служба хранилища Azure применяет регулирование для приложения, она начинает возвращать коды ошибки 503 — Server busy (сервер занят) или 500 — Operation timeout (время ожидания операции истекло). Этих ошибок можно избежать, строго соблюдая ограничения для целевых показателей масштабируемости. Это важная часть стратегии по повышению производительности приложения.

См. сведения о [целевых показателях масштабируемости службы хранилища Azure для Службы очередей](/azure/storage/common/storage-scalability-targets?toc=%2fazure%2fstorage%2fqueues%2ftoc.json#azure-queue-storage-scale-targets).

### <a name="maximum-number-of-storage-accounts"></a>Максимальное количество учетных записей хранения

Если количество учетных записей хранения приближается к максимальному разрешенному количеству для вашего сочетания подписки и региона, используете ли вы несколько учетных записей хранения на каждый сегмент, чтобы повысить скорость приема, передачи, количество операций ввода-вывода в секунду (IOPS) или емкость хранилища? Для такого сценария корпорация Майкрософт рекомендует увеличить ограничения на количество учетных записей хранения (если это возможно), чтобы сократить количество учетных записей хранения для рабочей нагрузки. Запрос на увеличение ограничений на количество учетных записей хранения следует направлять в [службу поддержки Azure](https://azure.microsoft.com/support/options/). Дополнительные сведения см. в [объявлении об учетных записях хранения большего размера и большего масштаба](https://azure.microsoft.com/blog/announcing-larger-higher-scale-storage-accounts/).

### <a name="capacity-and-transaction-targets"></a>Целевые показатели емкости и транзакций

Если приложение достигает целевых показателей масштабируемости, когда речь идет об одной учетной записи хранения, рассмотрите вопрос об использовании одного из следующих подходов:  

- Если для вашего приложения этих целевых показателей недостаточно, создайте несколько очередей и распределите сообщения между ними.
- Пересмотрите рабочую нагрузку, которая приводит к достижению приложением целевого показателя масштабируемости или его превышению. Вы можете спроектировать его по-другому, чтобы использовать меньшую полосу пропускания или производительность, или меньшее количество транзакций?
- Если приложение должно превышать какой-то из целевых показателей масштабируемости, создайте несколько учетных записей хранения и сегментируйте между ними данные приложения. При использовании этого подхода необходимо разработать приложение таким образом, чтобы в будущем для балансировки нагрузки в него можно было добавлять другие учетные записи хранения. Плата взимается только за потребление, то есть объем хранимых и передаваемых данных и совершенные транзакции, но не за сами учетные записи хранения.
- Если приложение приближается к целевым показателям пропускной способности, попробуйте применить сжатие данных на стороне клиента, чтобы снизить пропускную способность, требуемую для отправки данных в службу хранилища Azure.
    Этот способ снижает нагрузку на пропускную способность и повышает производительность сети, но может ухудшать общую производительность. Оцените, как дополнительная работа по сжатию и распаковке данных на стороне клиента влияет на производительность. Не забывайте также, что хранение данных в сжатом виде может усложнить устранение неполадок, так как затрудняет просмотр данных с помощью стандартных инструментов.
- Если приложение достигает целевых показателей масштабируемости, обязательно примените экспоненциальную задержку для повторов. Лучше всего сделать так, чтобы приложение не приближалось к целевым показателям масштабируемости. Для этого примените описанные в этой статье рекомендации. Если же потребуется выполнить регулирование, экспоненциальная задержка позволит избежать слишком частых повторов, которые только ухудшают ситуацию. Дополнительные сведения см. в разделе о [превышении времени ожидания и ошибках занятости сервера](#timeout-and-server-busy-errors).

## <a name="networking"></a>Сеть

Физические ограничения сети, в которой работает приложение, оказывают существенное влияние на производительность. В следующих разделах описаны некоторые ограничения, с которыми могут столкнуться пользователи.  

### <a name="client-network-capability"></a>Возможности клиентской сети

Пропускная способность и качество сетевого подключения являются важными факторами, влияющими на производительность приложения, как описано в следующих разделах.

#### <a name="throughput"></a>Пропускная способность

Что касается полосы пропускания, частой проблемой являются возможности клиента. Очень крупные экземпляры Azure имеют сетевые карты, обладающие большими возможностями, поэтому если необходимы более высокие сетевые ограничения от одной машины, следует рассмотреть возможность использования более крупного экземпляра или большего количества виртуальных машин. Если локальное приложение будет обращаться к службе хранилища Azure, примените ту же стратегию. Оцените сетевые возможности клиентского устройства и подключения к расположению службы хранилища Azure, а затем увеличьте их до необходимого уровня или учтите эти ограничения при проектировании приложения.

#### <a name="link-quality"></a>Качество связи

Помните, что состояние любой используемой сети, приводящее к ошибкам и потере пакетов, снижает эффективную пропускную способность.  Использование инструмента WireShark или NetMon может помочь в диагностике этой проблемы.  

### <a name="location"></a>Location

В любой распределенной среде наилучшее быстродействие достигается при нахождении клиента рядом с сервером. Для доступа к хранилищу Azure с наименьшей задержкой лучшим местом для клиента будет его нахождение в том же регионе Azure. Например, если ваше веб-приложение Azure использует службу хранилища Azure, обе службы лучше разместить в пределах одного региона (западная часть США, Юго-Восточная Азия и т. д.). Совместное размещение ресурсов уменьшает задержку и снижает стоимость, так как трафик в пределах одного региона остается бесплатным.  

Если же клиентские приложения, которые используют службу хранилища Azure, не размещены в Azure (например, приложения для мобильных устройств или локальные корпоративные службы), учетную запись хранения следует разместить в регионе, максимально приближенном к этим клиентам, так как это может снизить задержку. Если клиенты разбросаны по всему миру (например, часть в Северной Америке, а остальные в Европе), обдумайте вариант с несколькими учетными записями хранения, по одной в каждом регионе. Такой подход легче реализовать, если данные, которые хранят приложения, предназначены для отдельных пользователей, и не требуют репликации между учетными записями хранения.

## <a name="sas-and-cors"></a>SAS и CORS

Предположим, что вам нужно создать код JavaScript, который выполняется в веб-браузере пользователя или приложении на мобильном телефоне и обращается к данным в службе хранилища Azure. Один из вариантов — создать приложение-службу, которое выполнит роль прокси-сервера. Устройство пользователя проходит проверку подлинности в этой службе, которая, в свою очередь, предоставляет доступ к ресурсам службы хранилища Azure. Таким образом, на небезопасных устройствах можно не сообщать ключи своей учетной записи хранения. Но такой подход создает значительную нагрузку на приложение-службу, через которое проходят все данные, передаваемые между пользовательским устройством и службой хранилища Azure.

Вы можете обойтись без приложения-службы прокси-сервера, обращаясь к службе хранилища Azure с использованием подписанных URL-адресов (SAS). С технологией SAS вы можете разрешить пользовательскому устройству напрямую обращаться к службе хранилища Azure с маркером ограниченного доступа. Например, если пользователь хочет отправить фотографию в приложение, приложение-служба создаст SAS и отправит его на устройство пользователя. Маркер SAS может предоставлять разрешение на запись в ресурс службы хранилища Azure в течение указанного интервала времени. По истечении этого времени маркер SAS становится недействительным. Дополнительные сведения о подписанных URL-адресах см. в статье об [использование подписанных URL-адресов SAS в службе хранилища Azure](../common/storage-sas-overview.md).  

Обычно браузер не разрешает выполнять в коде JavaScript некоторые операции, например запись данных, в домене, отличном от домена размещения страницы с этим кодом. Эта политика использования одного источника не позволяет вредоносному коду с любой веб-страницы получить доступ к данным, размещенным на другой странице. Но при создании облачного решения политика использования одного источника становится неудобным ограничением. Реализуемая на уровне браузера технология CORS (общий доступ к ресурсам независимо от источника) позволяет целевому домену сообщать браузеру, что он доверяет запросам, поступающим из определенных исходных доменов.

Предположим, что выполняемое в Azure веб-приложение обращается к ресурсу в учетной записи хранения Azure. В этом сценарии веб-приложение выполняет роль исходного домена, а учетная запись хранения является целевым доменом. Вы можете настроить CORS для любой из служб хранилища Azure, чтобы она сообщала веб-браузеру о том, что служба хранилища Azure доверяет запросам, поступающим из исходного домена. Дополнительные сведения о технологии CORS см. в статье [Cross-Origin Resource Sharing (CORS) support for Azure Storage](/rest/api/storageservices/Cross-Origin-Resource-Sharing--CORS--Support-for-the-Azure-Storage-Services) (Поддержка общего доступа к ресурсам независимо от источника (CORS) для службы хранилища Azure).  
  
Технологии SAS и CORS помогают избавиться от лишней нагрузки на веб-приложения.  

## <a name="net-configuration"></a>Конфигурация .NET

В данном разделе перечислены несколько быстрых параметров конфигурации, которые можно использовать для значительного повышения производительности при использовании платформы .NET Framework.  При использовании других языков проверьте, применяются ли в выбранном языке подобные концепции.  

### <a name="use-net-core"></a>Использование .NET Core

Для разработки приложений, взаимодействующих со службой хранилища Azure, используйте .NET Core 2.1 или более поздних версий, в которых реализованы некоторые улучшения производительности. Мы рекомендуем использовать .NET Core 3.x всегда, когда это возможно.

Дополнительные сведения о повышении производительности в .NET Core вы можете получить в следующих записях блога:

- [о повышении производительности в .NET Core 3.0](https://devblogs.microsoft.com/dotnet/performance-improvements-in-net-core-3-0/);
- [о повышении производительности в .NET Core 2.1](https://devblogs.microsoft.com/dotnet/performance-improvements-in-net-core-2-1/).

### <a name="increase-default-connection-limit"></a>Увеличение стандартного ограничения на количество подключений

В языке .NET указанный ниже код увеличивает ограничение количества подключений по умолчанию (которое обычно соответствует 2 в клиентской среде или 10 в серверной среде) до 100. В обычном случае следует установить значение, приблизительно соответствующее количеству потоков, используемых приложением.  

```csharp
ServicePointManager.DefaultConnectionLimit = 100; //(Or More)  
```

Ограничение количества подключений должно быть установлено до открытия каких-либо подключений.  

Что касается других языков программирования, то для определения механизма установки ограничения числа подключений см. документацию по соответствующему языку.  

Дополнительные сведения см. в записи блога [Web Services: Concurrent Connections ](https://blogs.msdn.microsoft.com/darrenj/2005/03/07/web-services-concurrent-connections/) (Веб-службы: параллельные подключения).  

### <a name="increase-minimum-number-of-threads"></a>Увеличение минимального количества потоков

Если вы используете синхронные вызовы с асинхронными задачами, есть смысл увеличить количество потоков в пуле потоков:

```csharp
ThreadPool.SetMinThreads(100,100); //(Determine the right number for your application)  
```

См. описание метода [ThreadPool.SetMinThreads](/dotnet/api/system.threading.threadpool.setminthreads).  

## <a name="unbounded-parallelism"></a>Неограниченный параллелизм

Параллелизм часто очень полезен для повышения производительности, но следует с настороженностью относиться к неограниченному параллелизму, то есть к отсутствию ограничений на количество потоков или параллельных запросов. Обязательно ограничьте количество параллельных запросов на отправку или скачивание данных, на доступ к нескольким секциям в одной учетной записи хранения и на доступ к нескольким элементам в одной секции. При неограниченном параллелизме приложение сможет превысить возможности клиентского устройства или целевые показатели масштабируемости для учетных записей хранения, что приведет к увеличению задержек и применению регулирования.  

## <a name="client-libraries-and-tools"></a>Клиентские библиотеки и средства

Для повышения производительности всегда используйте самые последние версии клиентских библиотек и средств, предоставляемых корпорацией Майкрософт. Клиентские библиотеки службы хранилища Azure доступны для многих языков. Обозреватель службы хранилища также поддерживает PowerShell и Azure CLI. Корпорация Майкрософт активно развивает эти клиентские библиотеки и средства, оптимизируя их производительность, поддерживая их согласованность с последними версиями служб и реализуя внутреннюю поддержку для многих проверенных методов повышения производительности. Дополнительные сведения см. в [документации по службе хранилища Azure](/azure/storage/#reference).

## <a name="handle-service-errors"></a>Обработка ошибок службы

Служба хранилища Azure возвращает ошибку, если ей не удается обработать запрос. Понимание ошибок, которые возвращает служба хранилища Azure, и соответствующих сценариев, помогает оптимизировать производительность.

### <a name="timeout-and-server-busy-errors"></a>Ошибки времени ожидания и занятости сервера

Служба хранилища Azure может применять регулирование к приложению, когда его загрузка приближается к ограничениям масштабируемости. В некоторых случаях служба хранилища Azure не может обработать запрос из-за некоторого временного состояния. В обоих случаях служба может вернуть ошибку 503 — Server Busy (сервер занят) или 500 — Timeout (время ожидания истекло). Эти же ошибки могут возникать, когда служба перераспределяет сегменты данных для повышения пропускной способности. В большинстве случаев при получении таких ошибок приложению следует повторить операцию, которая их вызвала. Но если служба хранилища Azure применяет к приложению регулирование из-за превышения целевых показателей масштабируемости или по другим причинам, долго не позволяющим службе обработать запрос, агрессивная стратегия повторов только усугубит проблему. Мы рекомендуем использовать экспоненциальную задержку для политики повтора. Во всех клиентских библиотеках именно такое поведение является вариантом по умолчанию. Например, приложение может повторить действие через 2 секунды, затем через 4 секунды, затем через 10 секунд, затем через 30 секунд, а затем полностью отказаться от повторения. Это позволяет приложению значительно снизить нагрузку на службу и не усугублять проблемы, связанные с регулированием.  

Ошибки подключения могут вызывать немедленные повторы, так как они не являются результатом регулирования количества запросов и, как ожидается, будут временными.  

### <a name="non-retryable-errors"></a>Ошибки без возможности повтора

Клиентские библиотеки обрабатывают повторы с учетом того, допускает ли ошибка возможность повтора. Но если вы напрямую обращаетесь к REST API службы хранилища Azure, учитывайте ограничение на повтор для некоторых ошибок. Например, ошибка 400 — Bad Request (ошибка запроса) означает, что отправленный клиентским приложением запрос имеет неправильный формат и его невозможно обработать. Повторная отправка такого запроса каждый раз будет возвращать тот же ответ, и в таком повторе нет смысла. Если вы напрямую вызываете REST API службы хранилища Azure, учитывайте возможные варианты ошибок и применимость повторов для них.

Дополнительные сведения о кодах ошибок в службе хранилища Azure вы найдете в статье [Status and Error Codes](/rest/api/storageservices/status-and-error-codes2) (Коды ошибок и состояний).

## <a name="disable-nagle"></a>Отключение алгоритма Нейгла

Алгоритм Нейгла широко применяется во всех TCP/IP-сетях в качестве средства повышения производительности сети. Тем не менее он не является оптимальным во всех случаях (включая высокоинтерактивные среды). Алгоритм Нейгла оказывает негативное влияние на производительность запросов к службе таблиц Azure, поэтому при возможности его следует отключать.

## <a name="message-size"></a>Размер сообщения

Производительность и масштабируемость очередей уменьшается по мере увеличения размера сообщений. Размещайте в сообщении только ту информацию, которая необходима получателю.  

## <a name="batch-retrieval"></a>Пакетное извлечение

В одной операции из очереди можно извлечь до 32 сообщений. Это поможет уменьшить количество запросов из клиентского приложения, что особенно полезно в средах с большой задержкой, например при работе с мобильными устройствами.  

## <a name="queue-polling-interval"></a>Интервал опроса очереди

Большинство приложений опрашивают сообщения из такой очереди, которая может быть одним из самых крупных источников транзакций для этих приложений. Выбирайте интервал опроса тщательно: слишком высокая частота опросов может привести к тому, что будет достигнуто целевое значений масштабируемости очереди. Но при тарифе 0,01 долларов США за 200 000 транзакций (во время записи) опрос одного процессора с интервалом один раз в секунду будет стоить меньше 15 центов в месяц, поэтому стоимость обычно не влияет на выбор интервала опроса.  

Актуальные сведения о стоимости см. на странице [Цены на хранилища Azure](https://azure.microsoft.com/pricing/details/storage/).  

## <a name="use-update-message"></a>Использование сообщения об обновлении

Чтобы увеличить время ожидания невидимости или обновить информацию о состоянии сообщения, можно использовать операцию **Update Message**. Использование **Update Message** может быть более эффективным, чем создание рабочего процесса для передачи задания из одной очереди в другую по мере завершения этапов этого задания. Приложение сможет сохранять состояние задания в сообщении и продолжать свою работу вместо того, чтобы повторно размещать сообщение в очереди после завершения каждого шага. Но не забывайте, что каждая операция **Update Message** учитывается при подсчете целевого показателя масштабируемости.

## <a name="application-architecture"></a>Архитектура приложения

Чтобы сделать архитектуру приложения масштабируемой, используйте очереди. Ниже перечислены некоторые способы использования очередей для того, чтобы сделать приложение более масштабируемым:  

- Очереди можно использовать для инициации отставания от работы, необходимого для обработки и сглаживания рабочих нагрузок в приложении. Например, запросы от пользователей можно поместить в очередь, чтобы позволить процессору выполнить трудоемкую работу, такую как изменение размера загружаемых изображений.
- Очереди можно использовать, чтобы отделить части приложения для их независимого масштабирования. Например, клиент веб-интерфейса может разместить результаты опроса пользователей в очередь для последующего анализа и хранения. По мере необходимости для обработки данных очереди можно добавлять экземпляры роли worker.  

## <a name="next-steps"></a>Дополнительная информация

- [Azure Storage scalability and performance targets for storage accounts](../common/storage-scalability-targets.md?toc=%2fazure%2fstorage%2fqueues%2ftoc.json) (Целевые показатели масштабируемости и производительности службы хранилища Azure для учетных записей хранения)
- [Коды состояний и ошибок](/rest/api/storageservices/Status-and-Error-Codes2)
