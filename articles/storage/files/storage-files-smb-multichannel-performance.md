---
title: Производительность многоканальных SMB-файлов Azure
description: Сведения о производительности многоканального SMB.
author: gunjanj
ms.service: storage
ms.topic: conceptual
ms.date: 11/16/2020
ms.author: gunjanj
ms.subservice: files
ms.openlocfilehash: ee3d1335de1b2bb3096e88c4d04cd03daaa665f5
ms.sourcegitcommit: 8e7316bd4c4991de62ea485adca30065e5b86c67
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2020
ms.locfileid: "96014106"
---
# <a name="smb-multichannel-performance"></a>Производительность SMB Multichannel

Служба файлов Azure для нескольких каналов (Предварительная версия) позволяет клиенту SMB 3. x устанавливать несколько сетевых подключений к файловым ресурсам уровня "Премиум" в учетной записи Филестораже. Протокол SMB 3,0 представил многоканальный компонент SMB в клиентах Windows Server 2012 и Windows 8. По этой причине любой клиент SMB 3. x в службе файлов Azure, поддерживающий многоканальный SMB, может воспользоваться преимуществами этой функции для общих файловых ресурсов Azure уровня "Премиум". Дополнительная плата за включение многоканального SMB в учетной записи хранения не взимается.

## <a name="benefits"></a>Преимущества

Использование многоканального протокола SMB для файлов Azure позволяет клиентам использовать несколько сетевых подключений, обеспечивающих повышенную производительность при снижении стоимости владения. Повышение производительности достигается за счет агрегирования пропускной способности нескольких сетевых карт и использования поддержки масштабирования на стороне приема (RSS) для сетевых карт для распределения нагрузки ввода-вывода между несколькими процессорами.

- **Повышенная пропускная способность**. несколько подключений позволяют передавать данные по нескольким путям параллельно и, таким образом, значительно повысить рабочую нагрузку, в которой используются файлы большего размера с большими размерами операций ввода-вывода, и требовать высокой пропускной способности для одной виртуальной машины или меньшего набора виртуальных машин. К некоторым из этих рабочих нагрузок относятся носители и развлекательные развлечения для создания содержимого, а также анализа рисков по созданию и перекодированию, Genomics и финансовым службам.
- **Большие операции ввода-вывода**: возможность использования RSS NIC позволяет эффективно распределять нагрузку между несколькими процессорами с несколькими подключениями. Это позволяет повысить скорость операций ввода-вывода в секунду и эффективно задействовать ЦП виртуальных машин. Это полезно для рабочих нагрузок, имеющих небольшие размеры операций ввода-вывода, например приложения баз данных.
- **Отказоустойчивость сети**. несколько подключений снижают риск нарушения работы, так как клиенты больше не используют отдельное подключение.
- **Автоматическая настройка**. Если многоканальный протокол SMB включен на клиентах и в учетных записях хранения, он обеспечивает динамическое обнаружение существующих подключений и может при необходимости создавать дополнительные пути подключения.
- **Оптимизация затрат**. рабочие нагрузки могут повысить масштаб с одной виртуальной машины или небольшой набор виртуальных машин при подключении к общим ресурсам Premium. Это может снизить совокупную стоимость владения за счет сокращения числа виртуальных машин, необходимых для выполнения рабочей нагрузки и управления ею.

Дополнительные сведения о канале SMB см. в документации по [Windows](/azure-stack/hci/manage/manage-smb-multichannel).

Эта функция обеспечивает более высокую производительность многопоточных приложений, но обычно не помогает многопоточным приложениям. Дополнительные сведения см. в разделе [Сравнение производительности](#performance-comparison) .

## <a name="limitations"></a>Ограничения

[!INCLUDE [storage-files-smb-multi-channel-restrictions](../../../includes/storage-files-smb-multi-channel-restrictions.md)]

### <a name="regional-availability"></a>Доступность по регионам

[!INCLUDE [storage-files-smb-multi-channel-regions](../../../includes/storage-files-smb-multi-channel-regions.md)]

## <a name="configuration"></a>Конфигурация

Многоканальный SMB работает только в том случае, если эта функция включена как на стороне клиента, так и на стороне службы (ваша учетная запись хранения Azure).

В клиентах Windows многоканальный SMB включен по умолчанию. Вы можете проверить конфигурацию, выполнив следующую команду PowerShell: 

`Get-smbClientConfiguration | select EnableMultichannel`.
 
В учетной записи хранения Azure необходимо включить многоканальный SMB. См. раздел [Включение многоканального протокола SMB (Предварительная версия)](storage-files-enable-smb-multichannel.md).

### <a name="disable-smb-multichannel"></a>Отключить многоканальный SMB
В большинстве сценариев, в частности многопоточных рабочих нагрузок, клиенты должны видеть улучшенную производительность с помощью многоканального SMB. Однако в некоторых сценариях, таких как однопотоковые рабочие нагрузки или в целях тестирования, может потребоваться отключить многоканальный протокол SMB. Дополнительные сведения см. в разделе [Сравнение производительности](#performance-comparison) .

## <a name="verify-smb-multichannel-is-configured-correctly"></a>Проверьте, правильно ли настроен многоканальный протокол SMB.

1. Создайте файловый ресурс Premium или используйте существующий.
1. Убедитесь, что клиент поддерживает многоканальный протокол SMB (для одного или нескольких сетевых адаптеров включено масштабирование на стороне приема). Дополнительные сведения см. в [документации по Windows](/azure-stack/hci/manage/manage-smb-multichannel) .
1. Подключите общую папку к клиенту.
1. Создайте нагрузку с приложением.
    Для создания нагрузки можно использовать средство копирования, например Robocopy/MT, или любое средство повышения производительности, например Diskspd для чтения и записи файлов.
1. Откройте PowerShell с правами администратора и используйте следующую команду: `Get-SmbMultichannelConnection |fl`
1. Поиск свойств **максчаннелс** и **куррентчаннелс**

:::image type="content" source="media/storage-files-smb-multichannel-performance/files-smb-multi-channel-connection.PNG" alt-text="Снимок экрана с результатами Get-смбмултичаннелконнектион." lightbox="media/storage-files-smb-multichannel-performance/files-smb-multi-channel-connection.PNG":::

## <a name="performance-comparison"></a>Сравнение производительности

Существует две категории шаблонов рабочих нагрузок для чтения и записи — однопотоковые и многопоточные. Большинство рабочих нагрузок используют несколько файлов, но в некоторых случаях Рабочая нагрузка работает с одним файлом в общей папке. В этом разделе рассматриваются различные варианты использования и влияние на производительность каждого из них. Как правило, большинство рабочих нагрузок являются многопоточными и распределяют рабочую нагрузку по нескольким файлам, чтобы они могли значительно повысить производительность при использовании многоканального SMB.

- **Многопоточные или несколько файлов**. в зависимости от шаблона рабочей нагрузки вы должны заметно улучшить производительность при чтении и записи в iOS по нескольким каналам. Выигрыш в производительности различается в пределах от 2 до 4X с точки зрения операций ввода-вывода, пропускной способности и задержки. Для этой категории многоканальный SMB должен быть включен для наилучшей производительности.
- **Многопоточный/отдельный файл**. для большинства вариантов использования в этой категории рабочие нагрузки будут использовать многоканальный протокол SMB, особенно если у рабочей нагрузки средний размер ввода-вывода > ~ 16 КБ. Несколько примеров сценариев, в которых преимущество многоканального протокола SMB заключается в резервном копировании или восстановлении одного большого файла. Исключением может потребоваться отключить многоканальный протокол SMB, если Рабочая нагрузка имеет малый объем IOs. В этом случае может возникнуть небольшая утрата производительности в ~ 10%. В зависимости от варианта использования рассмотрите возможность распределения нагрузки по нескольким файлам или отключения этой функции. Дополнительные сведения см. в разделе [конфигурации](#configuration) .
- Однопотоковый **/несколько файлов или один файл**. для большинства однопотоковых рабочих нагрузок существует минимальный выигрыш в производительности из-за отсутствия параллелизма, обычно при включении многоканального SMB на 10% снижается производительность. В этом случае лучше отключить многоканальный SMB, за одним исключением. Если однопотоковая Рабочая нагрузка может распределять нагрузку между несколькими файлами и использует средний размер ввода-вывода (> ~ 16 КБ), то в многоканальном SMB должно быть небольшое снижение производительности.

### <a name="performance-test-configuration"></a>Конфигурация теста производительности

Для диаграмм, приведенных в этой статье, использовалась следующая конфигурация: одна стандартная виртуальная машина D32s v3 с одним сетевым адаптером с поддержкой RSS с четырьмя каналами. Загрузка была создана с помощью diskspd.exe, нескольких потоков с глубиной ввода-вывода в 10 и случайных IOs с различными размерами ввода-вывода.

| Размер | vCPU | Память: ГиБ | Временное хранилище (SSD): ГиБ | Максимальное число дисков данных | Максимальная пропускная способность кэшированного и временного хранилища: операций ввода-вывода в секунду (размер кэша в гиб) | Максимальная пропускная способность дисков без кэширования: операций ввода-вывода в секунду / МБит/с | Максимальное число сетевых адаптеров|Ожидаемая пропускная способность сети (Мбит/с) |
|---|---|---|---|---|---|---|---|---|
| [Standard_D32s_v3](../../virtual-machines/dv3-dsv3-series.md) | 32 | 128 | 256 | 32 | 64000/512 (800)    | 51200/768  | 8|16000 |

:::image type="content" source="media/storage-files-smb-multichannel-performance/files-smb-multi-channel-nic-settings-all-nics.PNG" alt-text="Снимок экрана с результатами Get-смбмултичаннелконнектион." lightbox="media/storage-files-smb-multichannel-performance/files-smb-multi-channel-nic-settings-all-nics.PNG":::

### <a name="mutli-threadedmultiple-files-with-smb-multichannel"></a>Подвергнуты-threadd/Multiple Files с многоканальным SMB

Нагрузка создана для 10 файлов с различными размерами ввода-вывода. Результаты тестов с увеличением масштаба показали значительные улучшения в результатах тестирования операций ввода-вывода и пропускной способности с включенным многоканальным SMB. На следующих диаграммах показаны результаты:

:::image type="content" source="media/storage-files-smb-multichannel-performance/diagram-smb-multi-channel-multiple-files-compared-to-single-channel-iops-performance.png" alt-text="Схема производительности" lightbox="media/storage-files-smb-multichannel-performance/diagram-smb-multi-channel-multiple-files-compared-to-single-channel-iops-performance.png":::

:::image type="content" source="media/storage-files-smb-multichannel-performance/diagram-smb-multi-channel-multiple-files-compared-to-single-channel-throughput-performance.png" alt-text="Схема производительности пропускной способности." lightbox="media/storage-files-smb-multichannel-performance/diagram-smb-multi-channel-multiple-files-compared-to-single-channel-throughput-performance.png":::

- На одном сетевом адаптере для операций чтения было замечено увеличение производительности 2x-3 раза, а для записи — 3 раза-4X с точки зрения операций ввода-вывода и пропускной способности.
- Многоканальное количество операций ввода-вывода в секунду и пропускная способность для доступа к ограничениям виртуальных машин, даже с одним сетевым интерфейсом и четырьмя каналами.
- Поскольку исходящий трафик (или операции чтения в хранилище) не измеряется, пропускная способность чтения могла превысить лимит опубликованной виртуальной машины 16 000 Мбит/с (2 гиб/с). Тест достигнут >2,7 гиб/с. Входящий трафик (или запись в хранилище) по-прежнему подвержен ограничениям виртуальных машин.
- Распределение нагрузки по нескольким файлам может значительно улучшиться.

Пример команды, которая использовалась в этом тестировании: 

`diskspd.exe -W300 -C5 -r -w100 -b4k -t8 -o8 -Sh -d60 -L -c2G -Z1G z:\write0.dat z:\write1.dat z:\write2.dat z:\write3.dat z:\write4.dat z:\write5.dat z:\write6.dat z:\write7.dat z:\write8.dat z:\write9.dat `.

### <a name="multi-threadedsingle-file-workloads-with-smb-multichannel"></a>Многопотоковые и одиночные рабочие нагрузки с несколькими каналами SMB

Загрузка была создана для одного файла гиб 128. При включении многоканального протокола SMB в большинстве случаев было продемонстрировано улучшение тестирования с многопоточными и отдельными файлами. На следующих диаграммах показаны результаты:

:::image type="content" source="media/storage-files-smb-multichannel-performance/diagram-smb-multi-channel-single-file-compared-to-single-channel-iops-performance.png" alt-text="Схема производительности операций ввода-вывода в секунду." lightbox="media/storage-files-smb-multichannel-performance/diagram-smb-multi-channel-single-file-compared-to-single-channel-iops-performance.png":::

:::image type="content" source="media/storage-files-smb-multichannel-performance/diagram-smb-multi-channel-single-file-compared-to-single-channel-throughput-performance.png" alt-text="Диаграмма производительности с одной пропускной способностью одного файла." lightbox="media/storage-files-smb-multichannel-performance/diagram-smb-multi-channel-single-file-compared-to-single-channel-throughput-performance.png":::

- На одном сетевом адаптере с большим средним размером ввода-вывода (> ~ 16 КБ) были внесены значительные улучшения в операции чтения и записи.
- Для меньших размеров ввода-вывода при включении многоканального протокола SMB было незначительным влиянием примерно 10% на производительность. Это можно уменьшить за счет распределения нагрузки по нескольким файлам или отключения функции.
- Производительность по-прежнему ограничена  [одними ограничениями на отдельные файлы](storage-files-scale-targets.md#file-level-limits).

## <a name="optimizing-performance"></a>Оптимизация производительности

Следующие советы помогут вам оптимизировать производительность.

- Убедитесь, что ваша учетная запись хранения и клиент находятся в одном регионе Azure, чтобы снизить задержку в сети.
- Используйте многопоточные приложения и Распределите нагрузку между несколькими файлами.
- Преимущества повышения производительности для многоканального увеличения нагрузки SMB с учетом количества файлов, распределяемых при распределении.
- Производительность общего ресурса уровня "Премиум" ограничивается подготовленным размером общего ресурса (число операций ввода-вывода в секунду/исходящий трафик/входящий трафик) и ограничением для одного файла. Дополнительные сведения см. в разделе [Основные сведения о подготовке общих файловых ресурсов](storage-files-planning.md#understanding-provisioning-for-premium-file-shares)уровня "Премиум".
- Максимальная производительность одного клиента виртуальной машины по-прежнему привязана к ограничениям виртуальной машины. Например, [Standard_D32s_v3](../../virtual-machines/dv3-dsv3-series.md) может поддерживать максимальную пропускную способность 16 000 Мбит/с (или 2Gbps), исходящий трафик из виртуальной машины (запись в хранилище) измеряется, входящий (чтение из хранилища). Производительность общего файлового ресурса зависит от ограничений сети компьютера, ЦП, внутренней доступной памяти сети, объема операций ввода-вывода, параллелизма, а также других факторов.
- Первоначальный тест обычно является прогревом, отбросить его результаты и повторите тест.
- Если производительность ограничена одним клиентом, а Рабочая нагрузка по-прежнему ниже подготовленных пределов общего ресурса, более высокая производительность может быть достигнута за счет распределения нагрузки по нескольким клиентам.

### <a name="the-relationship-between-iops-throughput-and-io-sizes"></a>Отношение количества операций ввода-вывода, пропускной способности и размеров операций ввода-вывода

**Пропускная способность = объем операций ввода-вывода ***

Более высокие размеры операций ввода-вывода повышают пропускную способность и имеют более высокие задержки, что приводит к снижению числа операций ввода-вывода в секунду. Меньшие размеры ввода-вывода повышают скорость операций ввода-вывода, но при этом снижается пропускная способность и задержка.

## <a name="next-steps"></a>Следующие шаги

- [Включение многоканального SMB в учетной записи Филестораже (Предварительная версия)](storage-files-enable-smb-multichannel.md)
- Дополнительные сведения о многоканальном SMB см. в [документации по Windows](/azure-stack/hci/manage/manage-smb-multichannel) .
