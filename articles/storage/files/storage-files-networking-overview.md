---
title: Рекомендации по работе с сетями службы "Файлы Azure" | Документация Майкрософт
description: Общие сведения о параметрах сети службы "Файлы Azure".
author: roygara
ms.service: storage
ms.topic: overview
ms.date: 02/22/2020
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: 7164c3dd5c98544f3cb2944cb33cfd0e9703e36d
ms.sourcegitcommit: 6e1124fc25c3ddb3053b482b0ed33900f46464b3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/15/2020
ms.locfileid: "90563341"
---
# <a name="azure-files-networking-considerations"></a>Рекомендации по работе с сетями службы "Файлы Azure" 
Подключиться к общей папке Azure можно двумя способами:

- Доступ к общей папке осуществляется непосредственно по протоколу SMB, NFS (предварительная версия) или FileREST. Этот шаблон доступа в основном используется, когда необходимо исключить максимально возможное количество локальных серверов.
- Создание кэша общей папки Azure на локальном сервере (или в виртуальной машине Azure) со службой "Синхронизация файлов Azure" и осуществление доступа к данным общей папки с локального сервера по выбранному вами протоколу (SMB, NFS, FTPS и т. д.) для вашего варианта использования. Этот шаблон доступа удобен, так как представляет собой лучшее сочетание производительности, характерной для локальных сред, масштабируемости облачных служб и бессерверных присоединяемых служб, например Azure Backup.

Эта статья посвящена настройке сети в тех случаях, когда необходим доступ к общей папке Azure напрямую, а не с помощью службы "Синхронизация файлов Azure". Дополнительные сведения о рекомендациях по работе с сетями для развертывания службы "Синхронизация файлов Azure" см. в статье [Рекомендации по сети для Синхронизации файлов Azure](storage-sync-files-networking-overview.md).

Сетевая конфигурация для общих папок Azure настраивается в учетной записи хранения Azure. Учетная запись хранения — это конструкция управления, представляющая собой общий пул носителей, который можно использовать для развертывания нескольких общих папок и других ресурсов хранения, например контейнеров больших двоичных объектов или очередей. Учетные записи хранения предоставляют несколько параметров для защиты сетевого доступа к общим папкам, а именно: конечные точки сети, параметры брандмауэра учетной записи хранения и шифрование при передаче. 

Перед выполнением инструкций из этой статьи рекомендуется прочесть статью [Планирование развертывания службы "Файлы Azure"](storage-files-planning.md).

## <a name="accessing-your-azure-file-shares"></a>Доступ к общим папкам Azure
При развертывании общей папки Azure в учетной записи хранения к ней немедленно открывается доступ через общедоступную конечную точку учетной записи хранения. Это обеспечивает безопасную отправку запросов с проверкой подлинности (например, с авторизацией по идентификатору входа пользователя) изнутри или извне Azure. 

Во многих клиентских средах первая попытка подключения общей папки Azure на локальной рабочей станции завершится сбоем, хотя подключения с виртуальных машин Azure проходят успешно. Причина в том, что многие организации и поставщики услуг Интернета (ISP) блокируют порт 445, используемый для обмена данными по протоколу SMB. При использовании общих папок NFS такая проблема не возникает. Такой запрет основан на рекомендациях по защите от устаревших и нерекомендуемых версий протокола SMB. Современная версия SMB 3.0 обеспечивает безопасную работу в Интернете. Но старые версии SMB, особенно SMB 1.0, такой уровень безопасности не предоставляли. Доступ к общим папкам Azure извне можно получить только по протоколам SMB 3.0 и FileREST (который также безопасен для использования в Интернете) через общедоступную конечную точку.

Так как для доступа к общей папке SMB в Azure из локальной среды проще всего открыть в локальной сети порт 445 (порт для SMB), корпорация Майкрософт рекомендует выполнить следующие действия, чтобы удалить из локальной среды протокол SMB 1.0:

1. Убедитесь, что протокол SMB 1.0 удален или отключен на устройствах вашей организации. Все поддерживаемые версии Windows и Windows Server поддерживают удаление и отключение протокола SMB 1.0. Кроме того, начиная с Windows 10 версии 1709 протокол SMB 1.0 по умолчанию не установлен в Windows. Дополнительные сведения об отключении протокола SMB 1.0 см. на страницах со сведениями о конкретной ОС:
    - [Обеспечение безопасности Windows или Windows Server](storage-how-to-use-files-windows.md#securing-windowswindows-server).
    - [Обеспечение безопасности Linux](storage-how-to-use-files-linux.md#securing-linux).
1. Убедитесь, что ни для одного из продуктов в вашей организации не требуется протокол SMB 1.0, и удалите те из них, для которых он требуется. Мы поддерживаем [расчетную палату продуктов SMB1](https://aka.ms/stillneedssmb1), которая содержит все собственные продукты корпорации Майкрософт и сторонние продукты, известные корпорации Майкрософт, для которых требуется SMB 1.0. 
1. (Необязательно.) Настройте брандмауэр стороннего производителя в локальной сети организации, чтобы предотвратить выход трафика по протоколу SMB 1.0 за пределы сети организации.

Если в вашей организации действуют политики или нормативы, требующие блокировать порт 445 или использовать детерминированный путь к ресурсам Azure, вы можете туннелировать трафик к общим папкам Azure через VPN-шлюз Azure или ExpressRoute. При использовании общих папок NFS не нужно применять такие подходы, так как для них не требуется порт 445.

> [!Important]  
> Даже если вы предпочтете альтернативный метод для доступа к общим папкам Azure, корпорация Майкрософт рекомендует удалить SMB 1.0 из локальной среды.

### <a name="tunneling-traffic-over-a-virtual-private-network-or-expressroute"></a>Туннелирование трафика через виртуальную частную сеть или ExpressRoute
Создавая сетевой туннель между локальной сетью и Azure, вы устанавливаете пиринг между локальной сетью и одной или несколькими виртуальными сетями в Azure. [Виртуальная сеть](../../virtual-network/virtual-networks-overview.md) похожа на обычную сеть, которая работает в локальной среде. Как и в случае с учетной записью хранения Azure или виртуальной машиной Azure, виртуальная сеть — это ресурс Azure, развернутый в группе ресурсов. 

Служба "Файлы Azure" поддерживает следующие механизмы для туннелирования трафика между локальными рабочими станциями, серверами и общими папками SMB или NFS в Azure:

- VPN-шлюз — это особый тип шлюза виртуальной сети, используемый для отправки зашифрованного трафика между виртуальной сетью Azure и альтернативным расположением (например, в локальной среде) через Интернет. VPN-шлюз Azure — это ресурс Azure, который можно развернуть в группе ресурсов вместе с учетной записью хранения или другими ресурсами Azure. VPN-шлюзы предоставляют два разных типа подключений:
    - Подключения шлюза [VPN "точка — сеть" (P2S)](../../vpn-gateway/point-to-site-about.md), которые являются VPN-подключениями между Azure и отдельным клиентом. Это решение в первую очередь полезно для устройств, которые не являются частью локальной сети организации, например для сотрудников, которым требуется возможность подключать свои общие папки Azure из дома, кафе или отеля, находясь в дороге. Чтобы использовать VPN-подключение P2S к службе "Файлы Azure", необходимо настроить это подключение для каждого клиента, которому требуется подключиться. Сведения, позволяющие упростить развертывание VPN-подключения P2S, вы найдете в статье [Настройка VPN-подключения "точка — сеть" (P2S) в Windows для использования с файлами Azure](storage-files-configure-p2s-vpn-windows.md) и [Настройка VPN-подключения "точка — сеть" (P2S) в Linux для использования с Файлами Azure](storage-files-configure-p2s-vpn-linux.md).
    - [VPN "сеть — сеть" (S2S)](../../vpn-gateway/design.md#s2smulti), которые являются VPN-подключениями между Azure и сетью вашей организации. VPN-подключение S2S позволяет настроить VPN-подключение один раз для VPN-сервера или устройства, размещенного в сети организации, а не настраивать каждое клиентское устройство, которому требуется доступ к общей папке Azure. Чтобы упростить развертывание подключения S2S VPN, воспользуйтесь статьей [Настройка VPN-подключения "сеть — сеть" для использования с Файлами Azure](storage-files-configure-s2s-vpn.md).
- [ExpressRoute](../../expressroute/expressroute-introduction.md), который позволяет создать определенный маршрут между Azure и локальной сетью, которая не проходит через Интернет. Так как ExpressRoute предоставляет выделенный путь между локальным центром обработки данных и Azure, ExpressRoute может быть полезен там, где производительность сети имеет значение. ExpressRoute также является хорошим вариантом, если политика или нормативные требования вашей организации предполагают детерминированный путь к ресурсам в облаке.

Независимо от метода туннелирования, выбранного для доступа к общим папкам Azure, вам потребуется механизм, гарантирующий передачу трафика в учетную запись хранения через туннель, а не по обычному Интернет-подключению. Технически возможно маршрутизировать трафик к общедоступной конечной точке учетной записи хранения. Но для этого придется включить в правила все IP-адреса кластеров службы хранилища Azure в вашем регионе, так как учетные записи хранения могут быть перемещены между кластерами хранения в любое время. Кроме того, придется постоянно обновлять сопоставления IP-адресов, так как постоянно добавляются новые кластеры.

Рекомендуем не вносить IP-адреса учетных записей хранения напрямую в правила маршрутизации VPN, а использовать частные конечные точки, которые предоставляют для учетной записи хранения IP-адрес из адресного пространства виртуальной сети Azure. Так как туннель к Azure обеспечивает пиринг между локальной сетью и одной или несколькими виртуальными сетями, маршрутизация будет правильной и устойчивой.

### <a name="private-endpoints"></a>Частные конечные точки
В дополнение к общедоступной конечной точке, которая создается по умолчанию для учетной записи хранения, Файлы Azure позволяют по желанию создать одну или несколько частных конечных точек. Частная конечная точка доступна только в пределах виртуальной сети Azure. Когда вы создаете частную конечную точку для учетной записи хранения, эта учетная запись хранения получает частный IP-адрес из адресного пространства виртуальной сети. Это аналогично тому,как локальный файловый сервер или устройство NAS получает IP-адрес из адресного пространства, выделенного для вашей локальной сети. 

Каждая частная конечная точка сопоставляется с определенной подсетью виртуальной сети Azure. У учетной записи хранения могут быть частные конечные точки в нескольких виртуальных сетях.

Использование частных конечных точек для службы "Файлы Azure" предоставляет следующие возможности:
- Безопасное подключение к общим папкам Azure из локальных сетей через VPN или ExpressRoute с частным пирингом.
- Защита общих папок Azure путем настройки брандмауэра учетной записи хранения на блокировку всех подключений к общедоступной конечной точке. По умолчанию при создании частной конечной точки подключение к общедоступной конечной точке не блокируется.
- Повышение уровня безопасности виртуальной сети благодаря предотвращению утечки данных через границы виртуальной сети (и пиринга).

Сведения о создании частной конечной точки см. в статье [Настройка частных конечных точек для службы "Файлы Azure"](storage-files-networking-endpoints.md).

### <a name="private-endpoints-and-dns"></a>Частные конечные точки и DNS
При создании частной конечной точки по умолчанию также создается (или обновляется, если она уже существует) частная зона DNS, соответствующая поддомену `privatelink`. Строго говоря, для использования частной конечной точки создавать частную зону DNS не требуется. Но мы настоятельно рекомендуем создавать ее в любом случае. Это обязательно требуется при подключении общей папки Azure с помощью участника-пользователя Active Directory или при доступе к ней через API FileREST.

> [!Note]  
> В этой статье используется DNS-суффикс учетной записи хранения `core.windows.net`, выделенный для общедоступных регионов Azure. Этот комментарий применим и к национальным облакам Azure, таким как облако Azure для государственных организаций США и облако Azure для Китая. Вам придется лишь заменить суффиксы на другие, соответствующие вашей среде. 

В этой частной зоне DNS мы создадим запись A для `storageaccount.privatelink.file.core.windows.net` и запись CNAME для обычного имени учетной записи хранения, которое имеет формат `storageaccount.file.core.windows.net`. Так как частная зона DNS Azure подключается к виртуальной сети, которая содержит частную конечную точку, при вызове командлета `Resolve-DnsName` из PowerShell на виртуальной машине Azure (или `nslookup` в Windows и Linux) вы получите следующую конфигурацию DNS:

```powershell
Resolve-DnsName -Name "storageaccount.file.core.windows.net"
```

В нашем примере учетная запись хранения `storageaccount.file.core.windows.net` разрешается в частный IP-адрес частной конечной точки, то есть `192.168.0.4`.

```Output
Name                              Type   TTL   Section    NameHost
----                              ----   ---   -------    --------
storageaccount.file.core.windows. CNAME  29    Answer     csostoracct.privatelink.file.core.windows.net
net

Name       : storageaccount.privatelink.file.core.windows.net
QueryType  : A
TTL        : 1769
Section    : Answer
IP4Address : 192.168.0.4


Name                   : privatelink.file.core.windows.net
QueryType              : SOA
TTL                    : 269
Section                : Authority
NameAdministrator      : azureprivatedns-host.microsoft.com
SerialNumber           : 1
TimeToZoneRefresh      : 3600
TimeToZoneFailureRetry : 300
TimeToExpiration       : 2419200
DefaultTTL             : 300
```

Если вы выполните такую же команду в локальной среде, это же имя учетной записи хранения будет разрешаться в общедоступный IP-адрес этой учетной записи хранения. `storageaccount.file.core.windows.net` имеет запись CNAME `storageaccount.privatelink.file.core.windows.net`, которое, в свою очередь, сопоставляется с кластером хранения Azure, где размещена учетная запись хранения.

```Output
Name                              Type   TTL   Section    NameHost
----                              ----   ---   -------    --------
storageaccount.file.core.windows. CNAME  60    Answer     storageaccount.privatelink.file.core.windows.net
net
storageaccount.privatelink.file.c CNAME  60    Answer     file.par20prdstr01a.store.core.windows.net
ore.windows.net

Name       : file.par20prdstr01a.store.core.windows.net
QueryType  : A
TTL        : 60
Section    : Answer
IP4Address : 52.239.194.40
```

Такая конфигурация отражает тот факт, что учетная запись хранения может одновременно предоставлять общедоступную конечную точку и одну или несколько частных конечных точек. Чтобы имя учетной записи хранения гарантированно разрешалось в частный IP-адрес частной конечной точки, необходимо изменить конфигурацию на локальных DNS-серверах. Это можно сделать несколькими способами.

- Измените файл hosts на всех клиентах, чтобы `storageaccount.file.core.windows.net` разрешалась в нужный частный IP-адрес частной конечной точки. Мы крайне не рекомендуем использовать этот вариант в рабочей среде, так как эти изменения придется вносить на всех клиентах, откуда будут подключаться общие папки Azure. В таком случае вам не удастся автоматизировать распространение изменений, вносимых в параметры учетной записи хранения или частной конечной точки.
- Создание записи A для `storageaccount.file.core.windows.net` на локальных DNS-серверах. Этот вариант более предпочтителен тем, что клиенты в локальной среде смогут автоматически разрешать адреса учетной записи хранения без индивидуальной настройки каждого клиента. Но это решение так же ненадежно, как изменение файла hosts, так как изменения не распространяются автоматически. Но для некоторых сред такое решение будет оптимальным.
- Переадресация зоны `core.windows.net` с локальных DNS-серверов в частную зону DNS Azure. Частный DNS-узел Azure доступен по специальному IP-адресу `168.63.129.16`, который имеет видимость только внутри виртуальных сетей, связанных с частной зоной DNS Azure. Чтобы обойти это ограничение, можно создать в виртуальной сети дополнительные DNS-серверы для переадресации `core.windows.net` в частную зону DNS Azure. Чтобы упростить создание этой архитектуры, мы подготовили командлеты PowerShell для автоматического развертывания DNS-серверов в виртуальной сети Azure и их настройки в соответствии с вашими потребностями. Сведения о настройке перенаправления DNS для службы "Файлы Azure" см. в [этой статье](storage-files-networking-dns.md).

## <a name="storage-account-firewall-settings"></a>Параметры брандмауэра учетной записи хранения
Брандмауэр — это политика сети, определяющая для запросов разрешения на доступ к общедоступной конечной точке в учетной записи хранения. Используя брандмауэр учетной записи хранения, вы можете ограничить доступ определенным набором или диапазоном IP-адресов либо определенной виртуальной сетью. Как правило, большинство политик брандмауэра учетной записи хранения разрешают сетевой доступ из одной или нескольких виртуальных сетей. 

Вы можете использовать два подхода к ограничению доступа к учетной записи хранения из виртуальных сетей.
- Создайте одну или несколько частных конечных точек для учетной записи хранения и запретите любой доступ к общедоступной конечной точке. Так вы будете уверены, что доступ к общим папкам Azure в этой учетной записи хранения возможен только для запросов, создаваемых внутри настроенных виртуальных сетей.
- Ограничьте доступ к общедоступной конечной точке одной или несколькими виртуальными сетями. Это достигается за счет возможности виртуальной сети под названием *конечная точка службы*. Ограничивая трафик к учетной записи хранения путем использования конечной точки службы, вы сохраняете доступ через общедоступный IP-адрес.

> [!NOTE]
> У общих папок NFS нет доступа к общедоступной конечной точке учетной записи хранения по общедоступному IP-адресу. Они могут получить доступ к общедоступной конечной точке учетной записи хранения только с помощью виртуальных сетей. Кроме того, общие папки NFS могут получить доступ к учетной записи хранения с использованием частных конечных точек.

Дополнительные сведения о том, как настраивать брандмауэр учетной записи хранения, см. в статье [Configure Azure Storage firewalls and virtual networks](../common/storage-network-security.md?toc=%2fazure%2fstorage%2ffiles%2ftoc.json) (Настройка брандмауэров и виртуальных сетей службы хранилища Azure).

## <a name="encryption-in-transit"></a>Шифрование при передаче

> [!IMPORTANT]
> В этом разделе описано шифрование при передаче для общих папок SMB. Дополнительные сведения о шифровании при передаче с использованием общих папок NFS см. в разделе [Безопасность](storage-files-compare-protocols.md#security).

По умолчанию для всех учетных записей хранения Azure включено шифрование при передаче. Это означает, что при подключении общей папки по протоколу SMB или доступе к ней по протоколу FileREST (например, с помощью портала Azure, PowerShell, CLI или пакетов SDK Azure) служба "Файлы Azure" разрешит подключение, только если оно установлено по протоколу SMB версии 3.0 или более поздней с шифрованием или по HTTPS. Клиенты, не поддерживающие SMB 3.0, или клиенты, поддерживающие SMB 3.0, но без шифрования SMB, не смогут подключать общую папку Azure, если включено шифрование при передаче. Дополнительные сведения о том, какие операционные системы поддерживают SMB 3.0 с шифрованием, см. в подробной документации по [Windows](storage-how-to-use-files-windows.md), [macOS](storage-how-to-use-files-mac.md) и [Linux](storage-how-to-use-files-linux.md). Все текущие версии PowerShell, CLI и пакетов SDK поддерживают протокол HTTPS.  

В учетной записи хранения Azure шифрование при передаче можно отключить. Если шифрование отключено, служба "Файлы Azure" также разрешает подключение по протоколу SMB 2.1, SMB 3.0 без шифрования и незашифрованные вызовы API FileREST по протоколу HTTP. Основная причина отключения шифрования при передаче заключается в поддержке устаревшего приложения, которое должно выполняться в более старой версии операционной системы, например Windows Server 2008 R2 или более старой версии Linux. Служба "Файлы Azure" разрешает только подключения по протоколу SMB 2.1 в том же регионе Azure, что и общая папка Azure. Клиент SMB 2.1 за пределами региона Azure общей папки Azure, например в локальной среде или в другом регионе Azure, не сможет получить доступ к общей папке.

Дополнительные сведения о шифровании при передаче см. в статье [Require secure transfer in Azure Storage](../common/storage-require-secure-transfer.md?toc=%2fazure%2fstorage%2ffiles%2ftoc.json) (Требование безопасной передачи в службе хранилища Azure).

## <a name="see-also"></a>См. также раздел
- [Общие сведения о Файлах Azure](storage-files-introduction.md)
- [Планирование развертывания службы файлов Azure](storage-files-planning.md)