---
title: 'Обзор: авторизация на основе удостоверений в службе файлов Azure'
description: Служба файлов Azure поддерживает проверку подлинности на основе удостоверений через SMB (блок сообщений сервера) через Azure Active Directory доменные службы (AD DS) и Active Directory. В результате присоединенные к домену виртуальные машины Windows будут иметь доступ к файловым ресурсам Azure с помощью учетных данных Azure AD.
author: roygara
ms.service: storage
ms.subservice: files
ms.topic: conceptual
ms.date: 05/29/2020
ms.author: rogarana
ms.openlocfilehash: be308a91b5b583f96406f10675344ab263150a81
ms.sourcegitcommit: eb6bef1274b9e6390c7a77ff69bf6a3b94e827fc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/05/2020
ms.locfileid: "91716075"
---
# <a name="overview-of-azure-files-identity-based-authentication-options-for-smb-access"></a>Обзор параметров проверки подлинности на основе удостоверений службы файлов Azure для доступа к SMB
[!INCLUDE [storage-files-aad-auth-include](../../../includes/storage-files-aad-auth-include.md)]

Сведения о том, как включить проверку подлинности локальных служб домен Active Directory Services для файловых ресурсов Azure, см. в статье [Включение проверки подлинности локальных домен Active Directory служб по протоколу SMB для файловых ресурсов Azure](storage-files-identity-auth-active-directory-enable.md).

Сведения о том, как включить аутентификацию Azure AD DS для файловых ресурсов Azure, см. в статье [Включение проверки подлинности доменных служб Azure Active Directory в службе файлов Azure](storage-files-identity-auth-active-directory-domain-service-enable.md).

## <a name="glossary"></a>Глоссарий 
Полезно понимать некоторые ключевые термины, связанные с проверкой подлинности службы домена Azure AD по протоколу SMB для файловых ресурсов Azure:

-   **Проверка подлинности Kerberos**

    Kerberos — это протокол проверки подлинности, который используется для проверки удостоверения пользователя или узла. Дополнительные сведения о протоколе Kerberos см. в разделе [Обзор проверки подлинности Kerberos](https://docs.microsoft.com/windows-server/security/kerberos/kerberos-authentication-overview).

-  **Протокол SMB (Server Message Block)**

    SMB — это стандартный протокол обмена файлами по сети. SMB также называется Common Internet File System, или CIFS. Дополнительные сведения о SMB см. в разделе [Протокол SMB Майкрософт и обзор протокола CIFS](https://docs.microsoft.com/windows/desktop/FileIO/microsoft-smb-protocol-and-cifs-protocol-overview).

-   **Azure Active Directory (Azure AD)**

    Azure Active Directory (Azure AD) — это облачный каталог и служба управления удостоверениями Майкрософт, основанная на нескольких клиентах. Azure AD объединяет в себе базовые службы каталогов, функции управления доступом к приложениям и защиту удостоверений. Виртуальные машины Windows, присоединенные к Azure AD, могут получить доступ к файловым ресурсам Azure с помощью учетных данных Azure AD. Дополнительные сведения см. в статье [Что такое Azure Active Directory](../../active-directory/fundamentals/active-directory-whatis.md).

-   **доменные службы Azure Active Directory (Azure AD DS);**

    Azure AD DS предоставляет управляемые доменные службы, такие как присоединение к домену, групповые политики, LDAP и проверка подлинности Kerberos/NTLM. Эти службы полностью совместимы со службами домен Active Directory. Дополнительные сведения см. в разделе [Azure Active Directory доменных служб](../../active-directory-domain-services/overview.md).

- **Локальные службы домен Active Directory (AD DS)**

    Интеграция локальных домен Active Directory служб (AD DS) с файлами Azure предоставляет методы для хранения данных каталога, делая их доступными для пользователей и администраторов сети. Безопасность интегрирована с AD DS путем проверки подлинности входа и управления доступом к объектам в каталоге. С одним сетевым входом администраторы могут управлять данными каталога и Организацией по всей сети, а полномочные пользователи сети могут получать доступ к ресурсам в любой точке сети. AD DS обычно применяются предприятиями в локальных средах, а AD DS учетные данные используются в качестве удостоверения для контроля доступа. Дополнительные сведения см. в разделе [Обзор служб домен Active Directory](https://docs.microsoft.com/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview).

-   **Управление доступом Azure на основе ролей (Azure RBAC)**

    Управление доступом на основе ролей в Azure (Azure RBAC) обеспечивает детальное управление доступом для Azure. С помощью Azure RBAC можно управлять доступом к ресурсам, предоставляя пользователям минимальные разрешения, необходимые для выполнения их заданий. Дополнительные сведения об Azure RBAC см. в статье [что такое управление доступом на основе ролей Azure (Azure RBAC)](../../role-based-access-control/overview.md).

## <a name="common-use-cases"></a>Распространенные варианты использования

Проверка подлинности на основе удостоверений и поддержка списков управления доступом Windows в службе файлов Azure лучше использовать в следующих случаях:

### <a name="replace-on-premises-file-servers"></a>Замена локальных файловых серверов

Нерекомендуемая и замена разбросанных локальных файловых серверов — это распространенная проблема, с которой каждое предприятие сталкивается в своем модернизациие ИТ. Файловые ресурсы Azure с локальной проверкой подлинности AD DS лучше подходят для переноса данных в службу файлов Azure. Полная миграция позволит вам воспользоваться преимуществами высокой доступности и масштабируемости, а также свести к минимуму изменения на стороне клиента. Он обеспечивает простую миграцию для конечных пользователей, поэтому они могут продолжать обращаться к своим данным с теми же учетными данными, используя существующие компьютеры, присоединенные к домену.

### <a name="lift-and-shift-applications-to-azure"></a>Перенос приложений в Azure

При переносе приложений в облако необходимо использовать ту же модель проверки подлинности для данных. Так как мы расширяем возможности управления доступом на основе удостоверений в файловые ресурсы Azure, это исключает необходимость изменения приложения на современные методы проверки подлинности и ускорения внедрения в облако. Файловые ресурсы Azure предоставляют возможность интеграции с AD DS Azure или локальным AD DS для проверки подлинности. Если ваш план должен быть 100% машинного облака и максимально упростить управление облачными инфраструктурами, AD DS Azure лучше подходит как полностью управляемая служба домена. Если вам необходима полная совместимость с возможностями AD DS, вам может потребоваться расширить среду AD DS в облако, используя контроллеры домена с самостоятельным размещением на виртуальных машинах. В любом случае мы предоставляем гибкость для выбора доменных служб, отвечающих потребностям вашего бизнеса.

### <a name="backup-and-disaster-recovery-dr"></a>Резервное копирование и аварийное восстановление (DR)

При хранении первичного хранилища файлов в локальной среде файловые ресурсы Azure могут служить идеальным хранилищем для резервного копирования или аварийного восстановления, чтобы повысить непрерывность бизнес-процессов. Файловые ресурсы Azure можно использовать для резервного копирования данных с существующих файловых серверов, сохраняя списки DACL Windows. В сценариях аварийного восстановления можно настроить параметр проверки подлинности для поддержки надлежащего применения контроля доступа при отработке отказа.

## <a name="supported-scenarios"></a>Поддерживаемые сценарии

В следующей таблице перечислены поддерживаемые сценарии проверки подлинности файловых ресурсов Azure для AD DS Azure и локальной AD DS. Мы рекомендуем выбрать службу домена, которую вы приняли в клиентской среде для интеграции с файлами Azure. Если AD DS уже настроена локально или в Azure, где устройства присоединены к домену AD, следует выбрать использование AD DS для проверки подлинности файловых ресурсов Azure. Аналогично, если вы уже приняли AD DS Azure, вы должны использовать его для проверки подлинности в файловых ресурсах Azure.


|Проверка подлинности AD DS Azure  | Локальная проверка подлинности AD DS  |
|---------|---------|
|Компьютеры Windows, присоединенные к AD DS Azure, могут получать доступ к файловым ресурсам Azure с помощью учетных данных Azure AD через SMB.     |Локальные AD DS или присоединенные к AD DSу компьютеры Windows могут получать доступ к файловым ресурсам Azure с локальными учетными данными Active Directory, которые синхронизируются с Azure AD через SMB. Ваш клиент должен иметь строку с подробными сведениями о AD DS.        |

### <a name="restrictions"></a>Ограничения

- AD DS Azure и локальная проверка подлинности AD DS не поддерживают проверку подлинности для учетных записей компьютеров. Вместо этого можно использовать учетную запись входа в службу.
- Ни проверка подлинности Azure AD DS, ни локальная AD DS аутентификация не поддерживается для устройств, присоединенных к Azure AD, или зарегистрированных устройств Azure AD.
- Файловые ресурсы Azure поддерживают проверку подлинности на основе удостоверений только для одной из следующих служб домена: [Azure Active Directory доменных служб (Azure AD DS)](#azure-ad-ds) или [локальных домен Active Directory служб (AD DS)](#ad-ds).
- Ни один из методов проверки подлинности на основе удостоверений не поддерживается для NFS, которая находится на этапе предварительной версии.

## <a name="advantages-of-identity-based-authentication"></a>Преимущества проверки подлинности на основе удостоверений
Проверка подлинности на основе удостоверений для файлов Azure обеспечивает несколько преимуществ при использовании проверки подлинности с использованием общего ключа:

-   **Расширьте традиционные возможности доступа к общей папке на основе удостоверений в облако с помощью локальных AD DS и Azure AD DS**  
    Если вы планируете переносить приложение в облако и заменили традиционные файловые серверы с помощью файловых ресурсов Azure, вам может потребоваться проверка подлинности приложения с помощью локальных AD DS или учетных данных Azure AD DS для доступа к данным файлов. Служба файлов Azure поддерживает использование локальных AD DS или учетных данных AD DS Azure для доступа к файловым ресурсам Azure через SMB из локальных AD DS или виртуальных машин Azure AD DS, присоединенных к домену.

-   **Принудительное применение детального контроля доступа для файловых ресурсов Azure**  
    Можно предоставить разрешения на доступ к определенному удостоверению на уровне общего ресурса, каталога или файла. Предположим, у вас есть несколько команд, использующих один файловый ресурс Azure для совместной работы над проектом. Вы можете предоставить всем командам доступ к каталогам с общедоступными данными, а доступ к каталогам с конфиденциальными финансовыми данными предоставить только финансовой группе. 

-   **Резервное копирование списков управления доступом Windows (также известных как NTFS) вместе с данными**  
    Вы можете использовать файловые ресурсы Azure для резервного копирования существующих локальных файловых ресурсов. Служба файлов Azure сохраняет списки ACL вместе с данными при резервном копировании общей папки в файловые ресурсы Azure через SMB.

## <a name="how-it-works"></a>Принцип работы

Файловые ресурсы Azure используют протокол Kerberos для проверки подлинности с помощью локальных AD DS или Azure AD DS. Когда удостоверение, связанное с пользователем или приложением, работающим на клиенте, пытается получить доступ к данным в общих файловых ресурсах Azure, запрос отправляется в службу домена AD DS или Azure AD DS для проверки подлинности удостоверения. Если проверка подлинности прошла успешно, она возвращает токен Kerberos. Клиент отправляет запрос, включающий маркер Kerberos, и файловые ресурсы Azure. Используйте этот маркер для авторизации запроса. Файловые ресурсы Azure получают только маркер Kerberos, а не доступ к учетным данным.

Перед включением проверки подлинности на основе удостоверений в файловых ресурсах Azure необходимо сначала настроить среду домена.

### <a name="ad-ds"></a>AD DS

Для локальной AD DS проверки подлинности необходимо настроить контроллеры домена AD и присоединять к ним компьютеры или виртуальные машины. Вы можете разместить контроллеры домена на виртуальных машинах Azure или локально. В любом случае клиенты, присоединенные к домену, должны иметь строку со сведениями о службе домена, поэтому они должны находиться в корпоративной сети или виртуальной сети (VNET) вашей службы домена.

На следующей схеме показана локальная проверка подлинности AD DS в файловых ресурсах Azure по протоколу SMB. Локальная AD DS должна быть синхронизирована с Azure AD с помощью Azure AD Connect Sync. Только гибридные пользователи, которые существуют как в локальной AD DS, так и в Azure AD, могут пройти проверку подлинности и авторизоваться для доступа к общей папке Azure. Это связано с тем, что разрешение уровня общего ресурса настраивается для удостоверения, представленного в Azure AD, где разрешение на уровне каталога или файлов применяется в AD DS. Убедитесь, что разрешения правильно настроены для одного и того же гибридного пользователя.

:::image type="content" source="media/storage-files-active-directory-overview/Files-on-premises-AD-DS-Diagram.png" alt-text="Схема":::

### <a name="azure-ad-ds"></a>Azure AD DS

Для проверки подлинности Azure AD DS необходимо включить доменные службы Azure AD и присоединить к домену виртуальные машины, из которых планируется получать доступ к данным файлов. Виртуальная машина, присоединенная к домену, должна находиться в той же виртуальной сети, что и AD DS Azure. 

На следующей схеме показан рабочий процесс для проверки подлинности Azure AD DS в файловых ресурсах Azure через SMB. Она соответствует аналогичному шаблону для локальной AD DS аутентификации в файловых ресурсах Azure. Существует два основных отличия:

- Сначала вам не нужно создавать удостоверение в Azure AD DS для представления учетной записи хранения. Это выполняется процессом включения в фоновом режиме.

- Во вторых, все пользователи, которые существуют в Azure AD, могут пройти проверку подлинности и авторизоваться. Пользователь может быть только облаком или гибридным. Синхронизация из Azure AD в Azure AD DS управляется платформой без необходимости настройки пользователя. Однако клиент должен быть присоединен к домену Azure AD DS, он не может быть присоединен или зарегистрирован в Azure AD. 

:::image type="content" source="media/storage-files-active-directory-overview/Files-Azure-AD-DS-Diagram.png" alt-text="Схема":::

### <a name="enable-identity-based-authentication"></a>Включить проверку подлинности на основе удостоверений

Вы можете включить проверку подлинности на основе удостоверений с помощью AD DS Azure или локальной AD DS для файловых ресурсов Azure в новых и существующих учетных записях хранения. Для проверки подлинности доступа к файлам в учетной записи хранения можно использовать только одну службу домена, которая применяется ко всем файловым ресурсам в учетной записи. Подробное руководство по настройке общих файловых ресурсов для проверки подлинности с помощью AD DS Azure. в статье Azure Active Directory включение проверки подлинности в [службах Azure](storage-files-identity-auth-active-directory-domain-service-enable.md) для локальных AD DS, а также проверка подлинности в локальной среде [домен Active Directory служб по протоколу SMB для файловых ресурсов Azure](storage-files-identity-auth-active-directory-enable.md).

### <a name="configure-share-level-permissions-for-azure-files"></a>Настройка разрешений на уровне общего ресурса для файлов Azure

После включения проверки подлинности Azure AD DS или локальной AD DS можно использовать встроенные роли Azure или настроить пользовательские роли для удостоверений Azure AD и назначить права доступа для всех файловых ресурсов в учетных записях хранения. Назначенное разрешение позволяет предоставленному удостоверению получить доступ только к общей папке, но не к корневому каталогу. Вам по-прежнему необходимо отдельно настроить разрешения на уровне каталога или файла для файловых ресурсов Azure.

### <a name="configure-directory-or-file-level-permissions-for-azure-files"></a>Настройка разрешений на уровне каталога или файлов для файлов Azure

Файловые ресурсы Azure обеспечивают стандартные разрешения для файлов Windows на уровне каталога и файлов, включая корневой каталог. Настройка разрешений на уровне каталогов или файлов поддерживается как для SMB, так и для остальных. Подключите целевой файловый ресурс из виртуальной машины и настройте разрешения с помощью проводника Windows File Explorer, Windows [icacls](https://docs.microsoft.com/windows-server/administration/windows-commands/icacls)или команды [Set-ACL](https://docs.microsoft.com/powershell/module/microsoft.powershell.security/get-acl?view=powershell-6) .

### <a name="use-the-storage-account-key-for-superuser-permissions"></a>Использование ключа учетной записи хранения для разрешений суперпользователя

Пользователь с ключом учетной записи хранения может получить доступ к файловым ресурсам Azure с разрешениями суперпользователя. Разрешения суперпользователя обходят все ограничения управления доступом.

> [!IMPORTANT]
> Рекомендуемый подход к безопасности заключается в предотвращении совместного использования ключей учетной записи хранения и использовании проверки подлинности на основе удостоверений, когда это возможно.

### <a name="preserve-directory-and-file-acls-when-importing-data-to-azure-file-shares"></a>Сохранять списки ACL для каталогов и файлов при импорте данных в файловые ресурсы Azure

Служба "файлы Azure" поддерживает сохранение ACL на уровне каталогов или файлов при копировании данных в файловые ресурсы Azure. Списки ACL для каталога или файла можно скопировать в файловые ресурсы Azure с помощью Синхронизация файлов Azure или общих наборов средств перемещения файлов. Например, можно использовать [Robocopy](https://docs.microsoft.com/windows-server/administration/windows-commands/robocopy) с `/copy:s` флагом для копирования данных, а также списков ACL в файловый ресурс Azure. Списки ACL сохраняются по умолчанию, поэтому не требуется включать проверку подлинности на основе удостоверений в учетной записи хранения для сохранения списков управления доступом.

## <a name="pricing"></a>Цены
Для включения проверки подлинности на основе удостоверений через SMB в вашей учетной записи хранения дополнительная плата за обслуживание не взимается. Дополнительные сведения о ценах см. в статье цены на службу [файлов Azure](https://azure.microsoft.com/pricing/details/storage/files/) и [цены на доменные службы Azure AD](https://azure.microsoft.com/pricing/details/active-directory-ds/).

## <a name="next-steps"></a>Дальнейшие шаги
Дополнительные сведения о службе файлов Azure и аутентификации на основе удостоверений по протоколу SMB см. в следующих ресурсах:

- [Планирование развертывания Файлов Azure](storage-files-planning.md)
- [Включение проверки подлинности локальных служб домен Active Directory Services по протоколу SMB для файловых ресурсов Azure](storage-files-identity-auth-active-directory-enable.md)
- [Включение проверки подлинности доменных служб Azure Active Directory в службе файлов Azure](storage-files-identity-auth-active-directory-domain-service-enable.md)
- [Часто задаваемые вопросы](storage-files-faq.md)
