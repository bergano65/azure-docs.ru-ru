---
title: Запретить анонимный общий доступ на чтение к контейнерам и BLOB-объектам
titleSuffix: Azure Storage
description: Узнайте, как анализировать анонимные запросы к учетной записи хранения и как предотвратить анонимный доступ ко всей учетной записи хранения или к отдельному контейнеру.
services: storage
author: tamram
ms.service: storage
ms.topic: how-to
ms.date: 12/02/2020
ms.author: tamram
ms.reviewer: fryu
ms.subservice: blobs
ms.openlocfilehash: f12a899d3b6daa3b233e6a799871afca1e24d046
ms.sourcegitcommit: 5b93010b69895f146b5afd637a42f17d780c165b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/02/2020
ms.locfileid: "96533759"
---
# <a name="prevent-anonymous-public-read-access-to-containers-and-blobs"></a>Запретить анонимный общий доступ на чтение к контейнерам и BLOB-объектам

Анонимный общий доступ на чтение к контейнерам и большим двоичным объектам в службе хранилища Azure — это удобный способ обмена данными, однако он также может представлять угрозу безопасности. Важно управлять анонимным доступом с осторожностью и понять, как оценивать анонимный доступ к данным. Сложность работы, человеческий сбой или вредоносная атака на данные, которые являются общедоступными, могут привести к незначительным нарушениям данных. Корпорация Майкрософт рекомендует включить анонимный доступ только при необходимости в сценарии приложения.

По умолчанию Открытый доступ к данным BLOB-объектов всегда запрещен. Однако конфигурация по умолчанию для учетной записи хранения позволяет пользователю с соответствующими разрешениями настроить общий доступ к контейнерам и BLOB-объектам в учетной записи хранения. Для повышения безопасности можно запретить общий доступ к учетной записи хранения независимо от общедоступного параметра для отдельного контейнера. Если запретить пользователю общий доступ к учетной записи хранения, он не сможет разрешить общий доступ к контейнеру в этой учетной записи. Корпорация Майкрософт рекомендует запретить общий доступ к учетной записи хранения, если он не требуется для вашего сценария. Запрет общего доступа помогает предотвратить утечки данных, вызванные нежелательным анонимным доступом.

Если вы запретили доступ к общедоступному BLOB-объекту для учетной записи хранения, служба хранилища Azure отклоняет все анонимные запросы к этой учетной записи. После того как общий доступ запрещен для учетной записи, контейнеры в этой учетной записи не могут быть настроены для общего доступа. Все контейнеры, которые уже настроены для общего доступа, больше не принимают анонимные запросы. Дополнительные сведения см. в статье [Настройка анонимного общего доступа на чтение для контейнеров и больших двоичных объектов](anonymous-read-access-configure.md).

В этой статье описывается, как использовать платформу ПЕРЕТАСКИВАНИя (обнаружение-исправление — аудит-управление) для постоянного управления общедоступными учетными записями хранения.

## <a name="detect-anonymous-requests-from-client-applications"></a>Обнаружение анонимных запросов из клиентских приложений

Если запретить общий доступ на чтение для учетной записи хранения, вы рискуете отклонять запросы к контейнерам и BLOB-объектам, которые в настоящее время настроены для общего доступа. Запрет общего доступа для учетной записи хранения переопределяет параметры общего доступа для отдельных контейнеров в этой учетной записи хранения. Если общий доступ запрещен для учетной записи хранения, все будущие анонимные запросы к этой учетной записи завершатся ошибкой.

Чтобы понять, как запрет общего доступа может повлиять на клиентские приложения, корпорация Майкрософт рекомендует включить ведение журнала и метрики для этой учетной записи и проанализировать шаблоны анонимных запросов за определенный промежуток времени. Используйте метрики, чтобы определить количество анонимных запросов к учетной записи хранения, и используйте журналы, чтобы определить, к каким контейнерам осуществляется анонимный доступ.

### <a name="monitor-anonymous-requests-with-metrics-explorer"></a>Мониторинг анонимных запросов с помощью обозреватель метрик

Чтобы отслеживание анонимных запросов к учетной записи хранения, используйте обозреватель метрик Azure в портал Azure. Дополнительные сведения о обозреватель метрик см. в статье [Приступая к работе с Azure обозреватель метрик](../../azure-monitor/platform/metrics-getting-started.md).

Чтобы создать метрику, которая отслеживает анонимные запросы, выполните следующие действия.

1. Войдите в свою учетную запись хранения на портале Azure. В разделе **мониторинг** выберите **метрики**.
1. Выберите **Добавить метрику**. В диалоговом окне **Метрика** укажите следующие значения:
    1. В поле область оставьте значение имя учетной записи хранения.
    1. Задайте **пространство имен метрики** *BLOB*. Эта метрика будет сообщать только о запросах к хранилищу BLOB-объектов.
    1. Задайте для поля **Метрика** значение *транзакции*.
    1. Задайте для поля **агрегирование** значение *Sum*.

    Новая метрика будет отображать сумму количества транзакций в хранилище BLOB-объектов за определенный промежуток времени. Результирующая метрика отображается, как показано на следующем рисунке:

    :::image type="content" source="media/anonymous-read-access-prevent/configure-metric-blob-transactions.png" alt-text="Снимок экрана, показывающий, как настроить метрику для суммирования транзакций BLOB-объектов":::

1. Затем нажмите кнопку **Добавить фильтр** , чтобы создать фильтр для метрики для анонимных запросов.
1. В диалоговом окне **Фильтр** укажите следующие значения:
    1. Задайте для **Свойства** значение *Проверка подлинности*.
    1. Задайте для поля **оператор** знак равенства (=).
    1. Задайте для поля **значения** значение *анонимно*.
1. В правом верхнем углу выберите интервал времени, по которому необходимо просмотреть метрику. Можно также указать, насколько детализирована Статистическая обработка запросов, указав интервалы в диапазоне от 1 минуты до 1 месяца.

После настройки метрики на диаграмме будут отображаться анонимные запросы. На следующем рисунке показаны анонимные запросы, агрегированные за последние тридцати минут.

:::image type="content" source="media/anonymous-read-access-prevent/metric-anonymous-blob-requests.png" alt-text="Снимок экрана, показывающий агрегированные анонимные запросы к хранилищу BLOB-объектов":::

Вы также можете настроить правило оповещения, чтобы уведомлять вас о том, что для учетной записи хранения выполняется определенное число анонимных запросов. Дополнительные сведения см. в статье [Создание и просмотр оповещений метрик, а также управление ими с помощью Azure Monitor](../../azure-monitor/platform/alerts-metric.md).

### <a name="analyze-logs-to-identify-containers-receiving-anonymous-requests"></a>Анализ журналов для выявления контейнеров, принимающих анонимные запросы

Журналы службы хранилища Azure записывают сведения о запросах к учетной записи хранения, в том числе о том, как был выполнен запрос. Можно проанализировать журналы, чтобы определить, какие контейнеры получают анонимные запросы.

Чтобы проверить анонимные запросы в учетной записи хранения Azure, можно использовать ведение журнала службы хранилища Azure Azure Monitor (Предварительная версия). Дополнительные сведения см. в статье [мониторинг службы хранилища Azure](./monitor-blob-storage.md).

Ведение журнала службы хранилища Azure в Azure Monitor поддерживает использование запросов журналов для анализа данных журнала. Для запроса журналов можно использовать рабочую область Azure Log Analytics. Дополнительные сведения о запросах журналов см. в разделе [учебник. Начало работы с log Analytics запросами](../../azure-monitor/log-query/log-analytics-tutorial.md).

> [!NOTE]
> Предварительная версия ведения журнала службы хранилища Azure в Azure Monitor поддерживается только в общедоступном облаке Azure. Государственные облака не поддерживают ведение журналов для службы хранилища Azure с Azure Monitor.

#### <a name="create-a-diagnostic-setting-in-the-azure-portal"></a>Создайте параметр диагностики в портал Azure

Чтобы записывать данные службы хранилища Azure с Azure Monitor и анализировать их с помощью Log Analytics Azure, необходимо сначала создать параметр диагностики, который указывает, какие типы запросов и какие услуги хранилища будут записывать данные. Чтобы создать параметр диагностики в портал Azure, выполните следующие действия.

1. Зарегистрируйтесь в [журнале службы хранилища Azure в Azure Monitor предварительной версии](https://forms.microsoft.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbRxW65f1VQyNCuBHMIMBV8qlUM0E0MFdPRFpOVTRYVklDSE1WUTcyTVAwOC4u).
1. Создайте новую рабочую область Log Analytics в подписке, которая содержит вашу учетную запись хранения Azure. После настройки ведения журнала для учетной записи хранения журналы будут доступны в рабочей области Log Analytics. Дополнительные сведения см. в статье [Create a Log Analytics workspace in the Azure portal](../../azure-monitor/learn/quick-create-workspace.md) (Создание рабочей области Log Analytics на портале Azure).
1. Войдите в свою учетную запись хранения на портале Azure.
1. В разделе Мониторинг выберите **параметры диагностики (Предварительная версия)**.
1. Выберите **большой двоичный объект** для регистрации запросов к хранилищу BLOB-объектов.
1. Выберите **Добавить параметр диагностики**.
1. Укажите имя для параметра диагностики.
1. В разделе **сведения о категории** раздела **Журнал** выберите типы запросов для записи. Все анонимные запросы будут считаться запросами на чтение, поэтому выберите **сторажереад** для записи анонимных запросов.
1. В разделе **сведения о назначении** выберите **Отправить log Analytics**. Выберите подписку и созданную ранее рабочую область Log Analytics, как показано на следующем рисунке.

    :::image type="content" source="media/anonymous-read-access-prevent/create-diagnostic-setting-logs.png" alt-text="Снимок экрана, показывающий, как создать параметр диагностики для запросов ведения журнала":::

После создания параметра диагностики запросы к учетной записи хранения затем регистрируются в соответствии с этим параметром. Дополнительные сведения см. в статье [Создание параметров диагностики для сбора журналов ресурсов и метрик в Azure](../../azure-monitor/platform/diagnostic-settings.md).

Ссылки на поля, доступные в журналах службы хранилища Azure в Azure Monitor, см. в разделе [журналы ресурсов (Предварительная версия)](./monitor-blob-storage-reference.md#resource-logs-preview).

#### <a name="query-logs-for-anonymous-requests"></a>Журналы запросов для анонимных запросов

Журналы службы хранилища Azure в Azure Monitor включают тип авторизации, который использовался для выполнения запроса к учетной записи хранения. В запросе журнала выполните фильтрацию по свойству **AuthenticationType** для просмотра анонимных запросов.

Чтобы получить журналы за последние семь дней для анонимных запросов к хранилищу BLOB-объектов, откройте рабочую область Log Analytics. Затем вставьте следующий запрос в новый запрос к журналу и запустите его:

```kusto
StorageBlobLogs
| where TimeGenerated > ago(7d) and AuthenticationType == "Anonymous"
| project TimeGenerated, AccountName, AuthenticationType, Uri
```

Вы также можете настроить правило генерации оповещений на основе этого запроса, чтобы уведомить вас об анонимных запросах. Дополнительные сведения см. в статье [Создание, просмотр и Управление оповещениями журнала с помощью Azure Monitor](../../azure-monitor/platform/alerts-log.md).

## <a name="remediate-anonymous-public-access"></a>Исправлять анонимный открытый доступ

После оценки анонимных запросов к контейнерам и BLOB-объектам в учетной записи хранения можно предпринять действия по ограничению или предотвращению общего доступа. Если некоторым контейнерам в вашей учетной записи хранения может потребоваться доступ для общего доступа, можно настроить параметр общего доступа для каждого контейнера в учетной записи хранения. Этот параметр обеспечивает наиболее детализированный контроль над открытым доступом. Дополнительные сведения см. [в разделе Установка общего уровня доступа для контейнера](anonymous-read-access-configure.md#set-the-public-access-level-for-a-container).

Для повышения безопасности можно запретить общий доступ для всей учетной записи хранения. Параметр общего доступа для учетной записи хранения переопределяет отдельные параметры для контейнеров в этой учетной записи. Если запретить общий доступ для учетной записи хранения, все контейнеры, настроенные для разрешения общего доступа, больше не будут доступны анонимно. Дополнительные сведения см. [в разделе разрешение или запрет общего доступа на чтение для учетной записи хранения](anonymous-read-access-configure.md#allow-or-disallow-public-read-access-for-a-storage-account).

Если в сценарии требуется, чтобы определенные контейнеры были доступны для общего доступа, рекомендуется переместить эти контейнеры и их большие двоичные объекты в учетные записи хранения, зарезервированные для общего доступа. Затем можно запретить общий доступ для других учетных записей хранения.

### <a name="verify-that-public-access-to-a-blob-is-not-permitted"></a>Убедитесь, что общий доступ к большому двоичному объекту запрещен

Чтобы убедиться в том, что общий доступ к конкретному большому двоичному объекту запрещен, можно попытаться скачать большой двоичный объект с помощью его URL-адреса. Если загрузка прошла, большой двоичный объект остается общедоступным. Если большой двоичный объект не является общедоступным, так как общий доступ запрещен для учетной записи хранения, вы увидите сообщение об ошибке, указывающее, что для этой учетной записи хранения общий доступ запрещен.

В следующем примере показано, как использовать PowerShell, чтобы попытаться скачать большой двоичный объект с помощью его URL-адреса. Не забудьте заменить значения заполнителей в квадратных скобках собственными значениями:

```powershell
$url = "<absolute-url-to-blob>"
$downloadTo = "<file-path-for-download>"
Invoke-WebRequest -Uri $url -OutFile $downloadTo -ErrorAction Stop
```

### <a name="verify-that-modifying-the-containers-public-access-setting-is-not-permitted"></a>Убедитесь, что изменение параметра общего доступа контейнера не разрешено

Чтобы убедиться, что параметр общего доступа к контейнеру нельзя изменить после того, как общий доступ запрещен для учетной записи хранения, можно попытаться изменить этот параметр. Изменение параметра общего доступа к контейнеру завершится ошибкой, если для учетной записи хранения не разрешен общий доступ.

В следующем примере показано, как использовать PowerShell, чтобы попытаться изменить параметр общего доступа контейнера. Не забудьте заменить значения заполнителей в квадратных скобках собственными значениями:

```powershell
$rgName = "<resource-group>"
$accountName = "<storage-account>"
$containerName = "<container-name>"

$storageAccount = Get-AzStorageAccount -ResourceGroupName $rgName -Name $accountName
$ctx = $storageAccount.Context

Set-AzStorageContainerAcl -Context $ctx -Container $containerName -Permission Blob
```

### <a name="verify-that-creating-a-container-with-public-access-enabled-is-not-permitted"></a>Убедитесь, что создание контейнера с включенным общим доступом не разрешено

Если общий доступ запрещен для учетной записи хранения, вы не сможете создать новый контейнер с включенным общедоступным доступом. Для проверки можно попытаться создать контейнер с включенным общедоступным доступом.

В следующем примере показано, как использовать PowerShell, чтобы попытаться создать контейнер с включенным общедоступным доступом. Не забудьте заменить значения заполнителей в квадратных скобках собственными значениями:

```powershell
$rgName = "<resource-group>"
$accountName = "<storage-account>"
$containerName = "<container-name>"

$storageAccount = Get-AzStorageAccount -ResourceGroupName $rgName -Name $accountName
$ctx = $storageAccount.Context

New-AzStorageContainer -Name $containerName -Permission Blob -Context $ctx
```

### <a name="check-the-public-access-setting-for-multiple-accounts"></a>Проверка общего доступа для нескольких учетных записей

Чтобы проверить настройку общего доступа в наборе учетных записей хранения с оптимальной производительностью, можно использовать обозреватель графа ресурсов Azure в портал Azure. Дополнительные сведения об использовании обозревателя графа ресурсов см. в статье [Краткое руководство. выполнение первого запроса Graph в Azure с помощью обозревателя Graph](../../governance/resource-graph/first-query-portal.md).

Свойство **алловблобпубликакцесс** не задано для учетной записи хранения по умолчанию и не возвращает значение, пока оно не будет явно задано. Учетная запись хранения разрешает общий доступ, если свойство имеет значение **null** или **true**.

Выполнение следующего запроса в обозревателе графа ресурсов возвращает список учетных записей хранения и отображает параметр общего доступа для каждой учетной записи:

```kusto
resources
| where type =~ 'Microsoft.Storage/storageAccounts'
| extend allowBlobPublicAccess = parse_json(properties).allowBlobPublicAccess
| project subscriptionId, resourceGroup, name, allowBlobPublicAccess
```

На следующем рисунке показаны результаты запроса в подписке. Обратите внимание, что для учетных записей хранения, в которых свойство **алловблобпубликакцесс** было явно задано, оно отображается в результатах как **true** или **false**. Если для учетной записи хранения не было задано свойство **алловблобпубликакцесс** , оно отображается в результатах запроса как пустое (или null).

:::image type="content" source="media/anonymous-read-access-prevent/check-public-access-setting-accounts.png" alt-text="Снимок экрана с результатами запроса для параметра общего доступа между учетными записями хранения":::

## <a name="use-azure-policy-to-audit-for-compliance"></a>Использование политики Azure для аудита соответствия

При наличии большого количества учетных записей хранения может потребоваться выполнить аудит, чтобы убедиться, что эти учетные записи настроены для предотвращения общего доступа. Чтобы выполнить аудит набора учетных записей хранения для их соответствия, используйте политику Azure. Политика Azure — это служба, которую можно использовать для создания, назначения и управления политиками, которые применяют правила к ресурсам Azure. Политика Azure помогает защитить эти ресурсы в соответствии с корпоративными стандартами и соглашениями об уровне обслуживания. Дополнительные сведения см. в статье [Что такое служба "Политика Azure"?](../../governance/policy/overview.md).

### <a name="create-a-policy-with-an-audit-effect"></a>Создание политики с помощью действия аудита

Политика Azure поддерживает эффекты, которые определяют, что происходит при оценке правила политики для ресурса. В результате аудита создается предупреждение, если ресурс не соответствует требованиям, но не останавливает запрос. Дополнительные сведения о влиянии см. в статье об [эффектах политики Azure](../../governance/policy/concepts/effects.md).

Чтобы создать политику с действием аудита для параметра общего доступа для учетной записи хранения с портал Azure, выполните следующие действия.

1. В портал Azure перейдите к службе "политика Azure".
1. В разделе " **Разработка** " выберите **определения**.
1. Выберите **Добавить определение политики** , чтобы создать новое определение политики.
1. В поле **Расположение определения** нажмите кнопку **Дополнительно** , чтобы указать, где находится ресурс политики аудита.
1. Укажите имя политики. При необходимости можно указать описание и категорию.
1. В разделе **правило политики** добавьте следующее определение политики в раздел **класс policyrule** .

    ```json
    {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Storage/storageAccounts"
          },
          {
            "not": {
              "field":"Microsoft.Storage/storageAccounts/allowBlobPublicAccess",
              "equals": "false"
            }
          }
        ]
      },
      "then": {
        "effect": "audit"
      }
    }
    ```

1. Сохраните политику.

### <a name="assign-the-policy"></a>Назначение политики

Затем назначьте политику для ресурса. Область политики соответствует этому ресурсу и всем его ресурсам под ним. Дополнительные сведения о назначении политики см. в разделе [Структура назначения политики Azure](../../governance/policy/concepts/assignment-structure.md).

Чтобы назначить политику с портал Azure, выполните следующие действия.

1. В портал Azure перейдите к службе "политика Azure".
1. В разделе " **Разработка** " выберите **назначения**.
1. Выберите **назначить политику** , чтобы создать новое назначение политики.
1. В поле **область** выберите область назначения политики.
1. В поле **Определение политики** нажмите кнопку **Дополнительно** , а затем выберите политику, определенную в предыдущем разделе, из списка.
1. Укажите имя для назначения политики. Описание является необязательным.
1. Оставьте *включенным* **принудительное применение политики** . Этот параметр не влияет на политику аудита.
1. Выберите **проверить и создать** , чтобы создать назначение.

### <a name="view-compliance-report"></a>Просмотр отчета о соответствии

После назначения политики можно просмотреть отчет о соответствии. Отчет о соответствии для политики аудита содержит сведения о том, какие учетные записи хранения не соответствуют политике. Дополнительные сведения см. в статье [Получение данных о соответствии политики](../../governance/policy/how-to/get-compliance-data.md).

После создания назначения политики может потребоваться несколько минут, чтобы отчет о соответствии стал доступным.

Чтобы просмотреть отчет о соответствии в портал Azure, выполните следующие действия.

1. В портал Azure перейдите к службе "политика Azure".
1. Выберите **соответствие**.
1. Отфильтруйте результаты для имени назначения политики, созданного на предыдущем шаге. Отчет показывает, сколько ресурсов не соответствует политике.
1. Вы можете детализировать отчет для получения дополнительных сведений, включая список учетных записей хранения, которые не соответствуют требованиям.

    :::image type="content" source="media/anonymous-read-access-prevent/compliance-report-policy-portal.png" alt-text="Снимок экрана с отчетом о соответствии для политики аудита для общего доступа к BLOB-объектам":::

## <a name="use-azure-policy-to-enforce-authorized-access"></a>Использование политики Azure для принудительного доступа

Политика Azure поддерживает управление облаком, гарантируя, что ресурсы Azure соответствуют требованиям и стандартам. Чтобы гарантировать, что учетные записи хранения в организации разрешают только авторизованные запросы, можно создать политику, запрещающую создание новой учетной записи хранения с параметром общего доступа, который разрешает анонимные запросы. Эта политика также предотвратит все изменения конфигурации существующей учетной записи, если параметр общего доступа для этой учетной записи не соответствует политике.

Политика принудительного применения использует действие Deny, чтобы предотвратить запрос, который создает или изменяет учетную запись хранения, чтобы разрешить общий доступ. Дополнительные сведения о влиянии см. в статье об [эффектах политики Azure](../../governance/policy/concepts/effects.md).

Чтобы создать политику с нерекомендуемым действием для общедоступного параметра доступа, который разрешает анонимные запросы, выполните те же действия, которые описаны в статье [Использование политики Azure для аудита соответствия](#use-azure-policy-to-audit-for-compliance), но предоставьте следующий код JSON в разделе **класс policyrule** определения политики:

```json
{
  "if": {
    "allOf": [
      {
        "field": "type",
        "equals": "Microsoft.Storage/storageAccounts"
      },
      {
        "not": {
          "field":"Microsoft.Storage/storageAccounts/allowBlobPublicAccess",
          "equals": "false"
        }
      }
    ]
  },
  "then": {
    "effect": "deny"
  }
}
```

После создания политики с действием Deny и назначения ее области пользователь не сможет создать учетную запись хранения, которая разрешает общий доступ. Кроме того, пользователь не может вносить какие-либо изменения в конфигурацию существующей учетной записи хранения, которая в настоящее время разрешает общий доступ. Попытка сделать это приведет к ошибке. Параметр общего доступа для учетной записи хранения должен иметь значение **false** , чтобы продолжить создание или настройку учетной записи.

На следующем рисунке показана ошибка, возникающая при попытке создать учетную запись хранения, которая разрешает общий доступ (по умолчанию для новой учетной записи), если политика с включенным действием требует, чтобы общий доступ запрещен.

:::image type="content" source="media/anonymous-read-access-prevent/deny-policy-error.png" alt-text="Снимок экрана, показывающий ошибку, возникающую при создании учетной записи хранения с нарушением политики":::

## <a name="next-steps"></a>Дальнейшие действия

- [Настройка анонимного общего доступа на чтение для контейнеров и больших двоичных объектов](anonymous-read-access-configure.md)
- [Анонимный доступ к открытым контейнерам и BLOB-объектам с помощью .NET](anonymous-read-access-client.md)