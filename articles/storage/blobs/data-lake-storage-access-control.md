---
title: Обзор управления доступом в Azure Data Lake Storage 2-го поколения | Документация Майкрософт
description: Основные принципы управления доступом в Azure Data Lake Storage 2-го поколения
author: normesta
ms.subservice: data-lake-storage-gen2
ms.service: storage
ms.topic: conceptual
ms.date: 04/23/2019
ms.author: normesta
ms.reviewer: jamesbak
ms.openlocfilehash: a35cf935d990dbb61f440d2592d59d21f33a2ae8
ms.sourcegitcommit: 49cf9786d3134517727ff1e656c4d8531bbbd332
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/13/2019
ms.locfileid: "74037244"
---
# <a name="access-control-in-azure-data-lake-storage-gen2"></a>Управление доступом в Azure Data Lake Storage 2-го поколения

Azure Data Lake Storage 2-го поколения реализует модель управления доступом, которая поддерживает как управление доступом на основе ролей (RBAC), так и POSIX-подобные списки управления доступом (ACL). В этой статье приведены общие сведения о модели управления доступом в Data Lake Storage 2-го поколения.

<a id="azure-role-based-access-control-rbac" />

## <a name="role-based-access-control"></a>Контроль доступа на основе ролей

RBAC использует назначения ролей для эффективного применения наборов разрешений к *субъектам безопасности*. *Участник безопасности* — это объект, представляющий пользователя, группу, субъект-службу или управляемое удостоверение, определенное в Azure Active Directory (AD), которое запрашивает доступ к ресурсам Azure.

Как правило, ресурсы Azure ограничены ресурсами верхнего уровня (например, учетными записями хранения Azure). В случае с хранилищем Azure и, следовательно, Azure Data Lake Storage 2-го поколения этот механизм был расширен до ресурса контейнера (файловой системы).

Сведения о назначении ролей субъектам безопасности в области действия учетной записи хранения см. в разделе [предоставление доступа к данным BLOB-объектов и очередей Azure с помощью RBAC в портал Azure](https://docs.microsoft.com/azure/storage/common/storage-auth-aad-rbac-portal?toc=%2fazure%2fstorage%2fblobs%2ftoc.json).

### <a name="the-impact-of-role-assignments-on-file-and-directory-level-access-control-lists"></a>Влияние назначений ролей на уровне файлов и каталогов в списках управления доступом

Использование назначений ролей RBAC является мощным механизмом управления разрешениями на доступ. это очень грубый механизм относительно списков ACL. Наименьшая степень гранулярности для RBAC — на уровне контейнера, и она будет оцениваться с более высоким приоритетом, чем списки ACL. Таким образом, если назначить роль субъекту безопасности в области контейнера, то этот субъект безопасности будет иметь уровень авторизации, связанный с этой ролью, для всех каталогов и файлов в этом контейнере, независимо от назначений ACL.

Когда субъекту безопасности предоставляются разрешения на доступ к данным RBAC через [встроенную роль](https://docs.microsoft.com/azure/storage/common/storage-auth-aad?toc=%2fazure%2fstorage%2fblobs%2ftoc.json#built-in-rbac-roles-for-blobs-and-queues)или пользовательская роль, эти разрешения оцениваются первыми при авторизации запроса. Если запрошенная операция авторизована назначениями RBAC субъекта безопасности, авторизация немедленно разрешается и никакие дополнительные проверки списка ACL не выполняются. Кроме того, если у субъекта безопасности нет назначения RBAC или операция запроса не соответствует назначенному разрешению, то выполняется проверка списка управления доступом, чтобы определить, имеет ли субъект безопасности разрешение на выполнение запрошенной операции.

> [!NOTE]
> Если участнику безопасности назначено назначение роли "владелец данных BLOB-объекта хранилища", то субъект безопасности считается *суперпользователем-пользователем* и получает полный доступ ко всем операциям изменения, включая задание владельца каталога или файла, а также списков ACL для каталогов и файлов, для которых они не являются владельцами. Доступ суперпользователя — единственный разрешенный способ изменить владельца ресурса.

## <a name="shared-key-and-shared-access-signature-sas-authentication"></a>Аутентификация общего ключа и подписанного URL-доступа (SAS)

Azure Data Lake Storage 2-го поколения поддерживает общие ключи и методы SAS для проверки подлинности. Характеристика этих методов проверки подлинности заключается в том, что с вызывающим объектом не связано удостоверение, поэтому не удается выполнить авторизацию на основе разрешений субъекта безопасности.

В случае общего ключа вызывающая сторона фактически получает доступ суперпользователя, то есть полный доступ ко всем операциям над всеми ресурсами, включая указание владельца и изменение списков ACL.

Маркеры SAS включают в себя допустимые разрешения. Разрешения, включенные в маркер SAS, эффективно применяются ко всем решениям об авторизации, но без дополнительных проверок списков ACL.

## <a name="access-control-lists-on-files-and-directories"></a>Списки управления доступом для файлов и каталогов

Субъект безопасности можно связать с уровнем доступа для файлов и каталогов. Эти ассоциации фиксируются в *списке управления доступом (ACL)* . Каждый файл и каталог в вашей учетной записи хранения имеют список управления доступом.

Если роль участника безопасности назначена на уровне учетной записи хранения, можно использовать списки управления доступом, чтобы предоставить субъекту безопасности повышенный доступ к конкретным файлам и каталогам.

Списки управления доступом нельзя использовать для предоставления уровня доступа меньше уровня, предоставленного назначением роли. Например, если назначить роль [участника данных BLOB-объекта хранилища](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-contributor) участнику безопасности, то нельзя будет использовать списки управления доступом, чтобы предотвратить запись субъекта безопасности в каталог.

### <a name="set-file-and-directory-level-permissions-by-using-access-control-lists"></a>Установка разрешений на уровне файлов и каталогов с помощью списков управления доступом

Сведения о задании разрешений на уровне файлов и каталогов см. в следующих статьях:

|Если вы хотите использовать это средство:    |См. следующую статью:    |
|--------|-----------|
|обозреватель хранилища Azure    |[Установка разрешений на уровне файлов и каталогов в Azure Data Lake Storage 2-го поколения с помощью Обозревателя службы хранилища Azure](https://docs.microsoft.com/azure/storage/blobs/data-lake-storage-how-to-set-permissions-storage-explorer)|
|Интерфейс REST API    |[Путь — обновление](https://docs.microsoft.com/rest/api/storageservices/datalakestoragegen2/path/update)|

> [!IMPORTANT]
> Если участник безопасности является субъектом- *службой* , важно использовать идентификатор объекта субъекта-службы, а не идентификатор объекта для регистрации соответствующего приложения. Чтобы получить идентификатор объекта субъекта-службы, откройте Azure CLI, а затем используйте следующую команду: `az ad sp show --id <Your App ID> --query objectId`. Обязательно замените заполнитель `<Your App ID>` ИДЕНТИФИКАТОРом приложения для регистрации приложения.

### <a name="types-of-access-control-lists"></a>Типы списков управления доступом

Существует два вида списков управления доступом: ACL для *доступа* и *ACL по умолчанию*.

Списки ACL для доступа управляют доступом к тому или иному объекту. Они позволяют управлять доступом как к файлам, так и к каталогам.

Списки ACL по умолчанию — это шаблоны списков управления доступом, связанные с каталогом, который определяет списки ACL для доступа к любым дочерним элементам, созданным в этом каталоге. У файлов нет списков ACL по умолчанию.

Как ACL для доступа, так и ACL по умолчанию имеют одинаковую структуру.

> [!NOTE]
> Изменение списка ACL по умолчанию для родительского объекта не оказывает влияния на список ACL для доступа или список ACL по умолчанию для уже существующих дочерних элементов.

### <a name="levels-of-permission"></a>Уровни разрешений

Разрешения на доступ к объекту-контейнеру доступны для **чтения**, **записи**и **выполнения**, и их можно использовать для файлов и каталогов, как показано в следующей таблице.

|            |    Файл     |   каталог. |
|------------|-------------|----------|
| **Разрешение на чтение (R)** | Чтение содержимого файла | Для просмотра содержимого каталога требуются **разрешения на чтение** и **выполнение** |
| **Разрешение на запись (W)** | Запись или добавление данных в файл | Для создания дочерних элементов в каталоге требуются **разрешения на запись** и **выполнение** |
| **Разрешение на выполнение (X)** | Не имеет значения в контексте Data Lake Storage 2-го поколения | Требуется для просмотра дочерних элементов каталога |

> [!NOTE]
> Если разрешения предоставляются только с помощью списков управления доступом (без RBAC), то для предоставления субъекту безопасности доступа на чтение или запись к файлу необходимо предоставить субъекту безопасности разрешения на **выполнение** для контейнера и в каждую папку в иерархии папок, которая ведет к файлу.

#### <a name="short-forms-for-permissions"></a>Сокращения для разрешений

**RWX** означает разрешения на **чтение, запись и выполнение**. Существует еще более краткая форма — цифровая, согласно которой **чтение = 4**, **запись = 2**, **выполнение = 1**, а их сумма выражает предоставленные разрешения. Ниже приводятся некоторые примеры.

| Цифровая форма | Краткая форма |      Значение     |
|--------------|------------|------------------------|
| 7            | `RWX`        | чтение, запись и выполнение |
| 5            | `R-X`        | Чтение + выполнение         |
| 4\.            | `R--`        | Чтение                   |
| 0            | `---`        | Нет разрешений         |

#### <a name="permissions-inheritance"></a>Наследование разрешений

В модели на основе POSIX, используемой в Data Lake Storage 2-го поколения, разрешения для элемента хранятся в самом элементе. Иными словами, разрешения для элемента не могут наследоваться от родительских элементов, если их разрешения заданы уже после того, как дочерний элемент создан. Разрешения наследуются только в том случае, если для родительских элементов были установлены разрешения по умолчанию до создания дочерних элементов.

### <a name="common-scenarios-related-to-permissions"></a>Типовые сценарии в зависимости от разрешений

В следующей таблице перечислены некоторые распространенные сценарии, которые помогут понять, какие разрешения необходимы для выполнения определенных операций с учетной записью хранения.

|    Операция             |    /    | Каталог Oregon/ | Portland/ | Data.txt     |
|--------------------------|---------|----------|-----------|--------------|
| Чтение файла Data.txt            |   `--X`   |   `--X`    |  `--X`      | `R--`          |
| Добавление в файл Data.txt       |   `--X`   |   `--X`    |  `--X`      | `RW-`          |
| Удаление файла Data.txt          |   `--X`   |   `--X`    |  `-WX`      | `---`          |
| Создание файла Data.txt          |   `--X`   |   `--X`    |  `-WX`      | `---`          |
| Перечисление /                   |   `R-X`   |   `---`    |  `---`      | `---`          |
| Перечисление для каталога /Oregon/           |   `--X`   |   `R-X`    |  `---`      | `---`          |
| Перечисление для каталога /Oregon/Portland/  |   `--X`   |   `--X`    |  `R-X`      | `---`          |

> [!NOTE]
> Для удаления файла разрешения на запись не требуются, пока выполняются два предыдущих условия.

### <a name="users-and-identities"></a>Пользователи и удостоверения

Каждый файл или каталог имеет отдельные разрешения для следующих удостоверений:

- Владелец
- группа владельцев;
- именованные пользователи;
- именованные группы;
- именованные субъекты-службы;
- Именованные управляемые удостоверения
- все остальные пользователи.

Удостоверения пользователей и групп являются удостоверениями Azure Active Directory (AAD). Поэтому, если не указано иное, *пользователь*в контексте Data Lake Storage 2-го поколения может ссылаться на пользователя Azure AD, субъекта-службы, управляемую идентификацию или группу безопасности.

#### <a name="the-owning-user"></a>Владелец

Пользователь, создавший элемент, автоматически становится владельцем элемента. Владелец может:

* изменять разрешения файла, владельцем которого он является;
* изменять группу владельцев файла, владельцем которого он является, если владелец файла одновременно является участником целевой группы.

> [!NOTE]
> Владелец *не может* изменить владельца другого файла или каталога. Изменить владельца файла или каталога может только суперпользователь.

#### <a name="the-owning-group"></a>группа владельцев;

В списках управления доступом POSIX каждый пользователь связан с *основной группой*. Например, пользователь «Мария» может принадлежать к группе «Finance». Алиса может также принадлежать к нескольким группам, но одна группа всегда назначается как основная группа. В интерфейсе POSIX, когда пользователь Aлиса создает файл, группа владельцев этого файла задается для основной группы этого пользователя, которой в данном случае является группа finance. В противном случае разрешения группы владельцев будут аналогичны разрешениям, назначенным другим пользователям или группам.

##### <a name="assigning-the-owning-group-for-a-new-file-or-directory"></a>Назначение группы владельцев для нового файла или каталога

* **Вариант 1**. корневой каталог "/". Этот каталог создается при создании контейнера Data Lake Storage 2-го поколения. В этом случае для группы-владельца задается пользователь, создавший контейнер, если он был выполнен с помощью OAuth. Если контейнер создается с использованием общего ключа, SAS учетной записи или SAS службы, то владельцем и группой владельцев присваивается значение **$superuser**.
* **Вариант 2** (все остальные случаи). при создании нового элемента Группа владельцев копируется из родительского каталога.

##### <a name="changing-the-owning-group"></a>Изменение группы владельцев

Группа владельцев может быть изменена:
* одним из суперпользователей;
* владельцем, если он является участником целевой группы.

> [!NOTE]
> Группа владельцев не может изменить списки ACL для файла или каталога.  Хотя группа-владелец настроена для пользователя, создавшего учетную запись в случае с корневым каталогом, **вариант 1** выше, одна учетная запись пользователя не является допустимой для предоставления разрешений через группу-владелец. Разрешение можно назначить допустимой группе пользователей, если это применимо.

### <a name="access-check-algorithm"></a>Алгоритм проверки доступа

Следующий псевдокод представляет алгоритм проверки доступа для учетных записей хранения.

```
def access_check( user, desired_perms, path ) : 
  # access_check returns true if user has the desired permissions on the path, false otherwise
  # user is the identity that wants to perform an operation on path
  # desired_perms is a simple integer with values from 0 to 7 ( R=4, W=2, X=1). User desires these permissions
  # path is the file or directory
  # Note: the "sticky bit" isn't illustrated in this algorithm
  
# Handle super users.
  if (is_superuser(user)) :
    return True

# Handle the owning user. Note that mask isn't used.
entry = get_acl_entry( path, OWNER )
if (user == entry.identity)
    return ( (desired_perms & entry.permissions) == desired_perms )

# Handle the named users. Note that mask IS used.
entries = get_acl_entries( path, NAMED_USER )
for entry in entries:
    if (user == entry.identity ) :
        mask = get_mask( path )
        return ( (desired_perms & entry.permissions & mask) == desired_perms)

# Handle named groups and owning group
member_count = 0
perms = 0
entries = get_acl_entries( path, NAMED_GROUP | OWNING_GROUP )
for entry in entries:
if (user_is_member_of_group(user, entry.identity)) :
    member_count += 1
    perms | =  entry.permissions
if (member_count>0) :
return ((desired_perms & perms & mask ) == desired_perms)

# Handle other
perms = get_perms_for_other(path)
mask = get_mask( path )
return ( (desired_perms & perms & mask ) == desired_perms)
```

#### <a name="the-mask"></a>Маска

Как показано в разделе "Алгоритм проверки доступа", маска ограничивает доступ для именованных пользователей, группы владельцев и именованных групп.  

> [!NOTE]
> Для нового контейнера Data Lake Storage 2-го поколения маска для ACL доступа к корневому каталогу ("/") по умолчанию составляет 750 для каталогов и 640 для файлов. Файлы не получают бит X, так как он не имеет значения для файлов в системе, предусматривающей только хранение.
>
> Маску можно указать для каждого вызова. Это позволяет установить для разных потребляющих систем, например кластеров, разные действующие маски для файловых операций. Если маска указана в конкретном запросе, она полностью переопределяет маску по умолчанию.

#### <a name="the-sticky-bit"></a>Бит фиксации

Закрепление — более сложная функция контейнера POSIX. В контексте Data Lake Storage 2-го поколения потребность в использовании бита фиксации маловероятна. Вкратце, если в каталоге включен бит фиксации, дочерний элемент может удалить или переименовать только владелец дочернего элемента.

Бит крепления не отображается в портал Azure.

### <a name="default-permissions-on-new-files-and-directories"></a>Разрешения по умолчанию для новых файлов и каталогов

При создании нового файла или каталога в существующем каталоге список ACL по умолчанию для родительского каталога определяет:

- список ACL для доступа и список ACL по умолчанию для дочернего каталога;
- список ACL для доступа для дочернего файла (файлы не имеют списка ACL по умолчанию).

#### <a name="umask"></a>umask

Когда создается файл или каталог, значение umask используется для изменения того, как для дочернего элемента устанавливаются списки ACL по умолчанию. umask — это 9-битное значение для родительских каталогов, содержащее значение RWX для **владельца**, **группы владельцев** и **других пользователей**.

umask для Azure Data Lake Storage 2-го поколения является константой со значением 007. Это значение преобразуется в следующие формы:

| Компонент umask     | Цифровая форма | Краткая форма | Значение |
|---------------------|--------------|------------|---------|
| umask.owning_user   |    0         |   `---`      | Для владельца стандартный список ACL родительского элемента копируется в список ACL для доступа дочернего элемента. | 
| umask.owning_group  |    0         |   `---`      | Для группы владельцев стандартный список ACL родительского элемента копируется в список ACL для доступа дочернего элемента. | 
| umask.other         |    7         |   `RWX`      | Для других пользователей все разрешения в списке ACL для доступа дочернего элемента удаляются. |

Значение umask, используемое Azure Data Lake Storage 2-го поколения, фактически означает, что значение для **других пользователей** никогда не передается по умолчанию в новые дочерние элементы независимо от того, что указывает ACL по умолчанию. 

Следующий псевдокод показывает, как применяется umask при создании списков ACL для дочернего элемента.

```
def set_default_acls_for_new_child(parent, child):
    child.acls = []
    for entry in parent.acls :
        new_entry = None
        if (entry.type == OWNING_USER) :
            new_entry = entry.clone(perms = entry.perms & (~umask.owning_user))
        elif (entry.type == OWNING_GROUP) :
            new_entry = entry.clone(perms = entry.perms & (~umask.owning_group))
        elif (entry.type == OTHER) :
            new_entry = entry.clone(perms = entry.perms & (~umask.other))
        else :
            new_entry = entry.clone(perms = entry.perms )
        child_acls.add( new_entry )
```

## <a name="common-questions-about-acls-in-data-lake-storage-gen2"></a>Часто задаваемые вопросы о списках ACL в Data Lake Storage 2-го поколения

### <a name="do-i-have-to-enable-support-for-acls"></a>Нужно ли мне активировать поддержку ACL?

Нет. Управление доступом через списки ACL включается для учетной записи хранения, если включена функция иерархического пространства имен (HNS).

Если функция HNS выключена, будут по-прежнему применяться правила авторизации Azure RBAC.

### <a name="what-is-the-best-way-to-apply-acls"></a>Каким способом лучше всего применять списки ACL?

Всегда используйте группы безопасности Azure AD в качестве назначенного субъекта в списках ACL. Не назначайте напрямую отдельных пользователей или субъекты-службы. Использование этой структуры позволяет добавлять и удалять пользователей или субъекты-службы без необходимости повторно применять списки ACL ко всей структуре каталогов. Вместо этого нужно просто добавить их в соответствующую группу безопасности Azure AD или удалить их из нее. Имейте в виду, что списки ACL не наследуются, поэтому повторное применение списков ACL требует обновления списка ACL для каждого файле и подкаталога. 

### <a name="which-permissions-are-required-to-recursively-delete-a-directory-and-its-contents"></a>Какие разрешения требуются для рекурсивного удаления каталога и его содержимого?

- Наличие у вызывающей стороны разрешений суперпользователя.

Или

- Для родительского каталога требуются разрешения на запись и выполнение.
- Чтобы удалить каталог и все вложенные в него каталоги, требуются разрешения на чтение, запись и выполнение.

> [!NOTE]
> Для удаления файлов в каталогах не требуются разрешения на запись. Кроме того, корневой каталог "/" удалить невозможно.

### <a name="who-is-the-owner-of-a-file-or-directory"></a>Кто назначается владельцем файла или каталога?

Создатель файла или каталога становится его владельцем. В случае с корневым каталогом это идентификатор пользователя, создавшего контейнер.

### <a name="which-group-is-set-as-the-owning-group-of-a-file-or-directory-at-creation"></a>Как назначается группа владельцев файла или каталога при его создании?

Группа владельцев копируется из родительского каталога, в котором создан файл или каталог.

### <a name="i-am-the-owning-user-of-a-file-but-i-dont-have-the-rwx-permissions-i-need-what-do-i-do"></a>Я являюсь владельцем файла, но у меня нет необходимых разрешений RWX. Что делать?

Владелец может изменить разрешения на доступ к файлу на любое из требуемых RWX-разрешений.

### <a name="why-do-i-sometimes-see-guids-in-acls"></a>Почему в списках ACL иногда отображаются идентификаторы GUID?

Идентификатор GUID отображается, если запись представляет пользователя, которого больше не существует в Azure AD. Как правило, это происходит, если пользователь уволился или его учетная запись удалена из AAD. Кроме того, субъекты-службы и группы безопасности не имеют имени участника-пользователя (UPN) для их идентификации и поэтому они представлены атрибутом идентификатора объекта (идентификатором GUID).

### <a name="how-do-i-set-acls-correctly-for-a-service-principal"></a>Правильно ли Разделы справки задать списки ACL для субъекта-службы?

При определении списков управления доступом для субъектов-служб важно использовать идентификатор объекта (OID) *субъекта-службы* для созданной регистрации приложения. Важно отметить, что зарегистрированные приложения имеют отдельный субъект-службу в определенном клиенте Azure AD. Зарегистрированные приложения имеют идентификатор объекта, видимый в портал Azure, но у *субъекта-службы* другой OID (другой).

Чтобы получить идентификатор объекта субъекта-службы, соответствующий регистрации приложения, можно использовать команду `az ad sp show`. Укажите идентификатор приложения в качестве параметра. Ниже приведен пример получения идентификатора OID для субъекта-службы, соответствующего регистрации приложения с ИДЕНТИФИКАТОРом приложения 18218b12-1895-43e9-AD80-6e8fc1ea88ce. Выполните следующую команду в Azure CLI.

```
$ az ad sp show --id 18218b12-1895-43e9-ad80-6e8fc1ea88ce --query objectId
<<OID will be displayed>>
```

Если у субъекта-службы правильный идентификатор объекта, перейдите на страницу Обозреватель службы хранилища **Управление доступом** , чтобы добавить OID и назначить соответствующие разрешения для OID. Убедитесь, что выбран параметр **сохранить**.

### <a name="does-data-lake-storage-gen2-support-inheritance-of-acls"></a>Поддерживает ли Data Lake Storage 2-го поколения наследование списков ACL?

Назначения Azure RBAC наследуются. Потоки назначений от ресурсов подписки, группы ресурсов и учетной записи хранения до ресурса контейнера.

Списки ACL не наследуются. Однако с помощью списков ACL по умолчанию можно задать списки ACL для дочерних вложенных каталогов и файлов, создаваемых в родительском каталоге. 

### <a name="where-can-i-learn-more-about-posix-access-control-model"></a>Где можно получить дополнительную информацию о модели контроля доступа POSIX?

* [POSIX Access Control Lists on Linux](https://www.linux.com/news/posix-acls-linux) (Списки управления доступом POSIX для Linux)
* [HDFS Permission Guide](https://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html) (Руководство по разрешениям в HDFS)
* [POSIX FAQ (POSIX: вопросы и ответы)](https://www.opengroup.org/austin/papers/posix_faq.html)
* [POSIX 1003.1 2008](https://standards.ieee.org/findstds/standard/1003.1-2008.html)
* [POSIX 1003.1 2013](https://pubs.opengroup.org/onlinepubs/9699919799.2013edition/)
* [POSIX 1003.1 2016](https://pubs.opengroup.org/onlinepubs/9699919799.2016edition/)
* [POSIX ACL on Ubuntu](https://help.ubuntu.com/community/FilePermissionsACLs) (POSIX ACL для Ubuntu)
* [ACL: Using Access Control Lists on Linux](https://bencane.com/2012/05/27/acl-using-access-control-lists-on-linux/) (ACL: использование списков управления доступом в Linux)

## <a name="see-also"></a>См. также

* [Общие сведения об Azure Data Lake Storage 2-го поколения](../blobs/data-lake-storage-introduction.md)
