---
title: Обзор управления доступом в Azure Data Lake Storage 2-го поколения | Документация Майкрософт
description: Основные принципы управления доступом в Azure Data Lake Storage 2-го поколения
services: storage
author: jamesbak
ms.subservice: data-lake-storage-gen2
ms.service: storage
ms.topic: conceptual
ms.date: 12/06/2018
ms.author: jamesbak
ms.openlocfilehash: 4ba8977180e33256bfdc6652811495a02a9ef19c
ms.sourcegitcommit: 3341598aebf02bf45a2393c06b136f8627c2a7b8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/01/2019
ms.locfileid: "58802967"
---
# <a name="access-control-in-azure-data-lake-storage-gen2"></a>Управление доступом в Azure Data Lake Storage 2-го поколения

В Azure Data Lake Storage 2-го поколения реализована модель управления доступом, которая поддерживает как управление доступом на основе ролей в Azure (RBAC), так и POSIX-подобные списки управления доступом (ACL). В этой статье приведены общие сведения о модели управления доступом в Data Lake Storage 2-го поколения. 

## <a name="azure-role-based-access-control-rbac"></a>Управление доступом на основе ролей в Azure (RBAC)

Управление доступом на основе ролей в Azure (RBAC) предусматривает использование назначений ролей для эффективного применения наборов разрешений к пользователям, группам и субъектам-службам для ресурсов Azure. Как правило, эти ресурсы Azure ограничены ресурсами верхнего уровня (*например*, учетными записями хранения Azure). В случае службы хранилища Azure и, следовательно, Azure Data Lake Storage 2-го поколения, этот механизм расширен до ресурса файловой системы.

Хотя назначения ролей RBAC представляют собой мощный механизм для управления разрешениями пользователей, этот механизм обеспечивает весьма грубую детализацию в отношении ACL. Наименьший уровень детализации для RBAC — уровень файловой системы, который оценивается с более высоким приоритетом, чем списки управления доступом. Таким образом, если назначить разрешения RBAC в файловой системе, соответствующий пользователь или субъект-служба получат авторизацию для ВСЕХ каталогов и файлов в этой файловой системе, независимо от назначений списков ACL.

Служба хранилища Azure предоставляет три встроенные роли RBAC для хранилища BLOB-объектов: 

- [владелец данных BLOB-объектов хранилища](../../role-based-access-control/built-in-roles.md#storage-blob-data-owner);
- [участник данных BLOB-объектов хранилища](../../role-based-access-control/built-in-roles.md#storage-blob-data-contributor);
- [читатель данных больших двоичных объектов хранилища](../../role-based-access-control/built-in-roles.md#storage-blob-data-reader).

Когда пользователю или субъекту-службе предоставляются разрешения RBAC для данных через одну из этих встроенных ролей или настраиваемую роль, сначала выполняется оценка этих разрешений при авторизации запроса. Если запрашиваемая операция авторизована назначениями RBAC вызывающей стороны, то авторизация немедленно разрешается и дополнительные проверки списков ACL не выполняются. В ином случае, если у вызывающей стороны нет назначения RBAC или операция запроса не соответствует назначенному разрешению, выполняются проверки ACL, чтобы определить, авторизована ли вызывающая сторона для выполнения запрашиваемой операции.

Следует особо отметить встроенную роль владельца данных BLOB-объектов хранилища. Если у вызывающей стороны есть это назначение RBAC, этот пользователь считается *суперпользователем* и ему предоставляется полный доступ ко всем операциям изменения, включая указание владельца каталога или файла, а также настройку списков ACL для каталогов и файлов, владельцем которых он не является. Доступ суперпользователя — единственный разрешенный способ изменить владельца ресурса.

## <a name="shared-key-and-shared-access-signature-authentication"></a>Проверка подлинности с помощью общего ключа и подписанного URL-адреса

В Azure Data Lake Storage 2-го поколения поддерживается проверка подлинности с помощью общего ключа и подписанного URL-адреса. Характерная особенность этих способов проверки подлинности заключается в том, что с вызывающей стороной не связано удостоверение, и поэтому авторизацию на основе разрешений пользователя выполнить нельзя.

В случае общего ключа вызывающая сторона фактически получает доступ суперпользователя, то есть полный доступ ко всем операциям над всеми ресурсами, включая указание владельца и изменение списков ACL.

Маркеры SAS включают в себя допустимые разрешения. Разрешения, включенные в маркер SAS, эффективно применяются ко всем решениям об авторизации, но без дополнительных проверок списков ACL.

## <a name="access-control-lists-on-files-and-directories"></a>Списки управления доступом для файлов и каталогов

Существует два типа списков управления доступом (ACL): ACL для доступа и ACL по умолчанию.

* **ACL для доступа**. Списки ACL для доступа управляют доступом к тому или иному объекту. Они позволяют управлять доступом как к файлам, так и к каталогам.

* **ACL по умолчанию**. Шаблон списков управления доступом, связанных с каталогом, определяющий списки ACL для доступа к любому дочернему элементу, созданному в этом каталоге. У файлов нет списков ACL по умолчанию.

Как ACL для доступа, так и ACL по умолчанию имеют одинаковую структуру.

> [!NOTE]
> Изменение списка ACL по умолчанию для родительского объекта не оказывает влияния на список ACL для доступа или список ACL по умолчанию для уже существующих дочерних элементов.

## <a name="permissions"></a>Разрешения

Разрешения для объекта файловой системы делятся на **разрешения на чтение**, **разрешения на запись** и **разрешения на выполнение**. Разрешения применяются к файлам и каталогам, как показано в таблице ниже.

|            |    Файл     |   Каталог |
|------------|-------------|----------|
| **Разрешение на чтение (R)** | Чтение содержимого файла | Для просмотра содержимого каталога требуются **разрешения на чтение** и **выполнение** |
| **Разрешение на запись (W)** | Запись или добавление данных в файл | Для создания дочерних элементов в каталоге требуются **разрешения на запись** и **выполнение** |
| **Разрешение на выполнение (X)** | Не имеет значения в контексте Data Lake Storage 2-го поколения | Требуется для просмотра дочерних элементов каталога |

### <a name="short-forms-for-permissions"></a>Сокращения для разрешений

**RWX** означает разрешения на **чтение, запись и выполнение**. Существует еще более краткая форма — цифровая, согласно которой **чтение = 4**, **запись = 2**, **выполнение = 1**, а их сумма выражает предоставленные разрешения. Ниже приводятся некоторые примеры.

| Цифровая форма | Краткая форма |      Значение     |
|--------------|------------|------------------------|
| 7            | `RWX`        | чтение, запись и выполнение |
| 5            | `R-X`        | Чтение + выполнение         |
| 4.            | `R--`        | чтение                   |
| 0            | `---`        | Нет разрешений         |

### <a name="permissions-inheritance"></a>Наследование разрешений

В модели на основе POSIX, используемой в Data Lake Storage 2-го поколения, разрешения для элемента хранятся в самом элементе. Иными словами, разрешения для элемента не могут наследоваться от родительских элементов, если их разрешения заданы уже после того, как дочерний элемент создан. Разрешения наследуются только в том случае, если для родительских элементов были установлены разрешения по умолчанию до создания дочерних элементов.

## <a name="common-scenarios-related-to-permissions"></a>Типовые сценарии в зависимости от разрешений

В следующей таблице показано несколько типовых сценариев для наглядного представления того, какие разрешения требуются для выполнения отдельных операций в учетной записи Data Lake Storage 2-го поколения.

|    Операция             |    /    | Каталог Oregon/ | Portland/ | Data.txt     |
|--------------------------|---------|----------|-----------|--------------|
| Чтение файла Data.txt            |   `--X`   |   `--X`    |  `--X`      | `R--`          |
| Добавление в файл Data.txt       |   `--X`   |   `--X`    |  `--X`      | `RW-`          |
| Удаление файла Data.txt          |   `--X`   |   `--X`    |  `-WX`      | `---`          |
| Создание файла Data.txt          |   `--X`   |   `--X`    |  `-WX`      | `---`          |
| Перечисление /                   |   `R-X`   |   `---`    |  `---`      | `---`          |
| Перечисление для каталога /Oregon/           |   `--X`   |   `R-X`    |  `---`      | `---`          |
| Перечисление для каталога /Oregon/Portland/  |   `--X`   |   `--X`    |  `R-X`      | `---`          |


> [!NOTE]
> Для удаления файла разрешения на запись не требуются, пока выполняются два предыдущих условия.
>
>

## <a name="users-and-identities"></a>Пользователи и удостоверения

Каждый файл или каталог имеет отдельные разрешения для следующих удостоверений:

- Владелец
- группа владельцев;
- именованные пользователи;
- именованные группы;
- именованные субъекты-службы;
- все остальные пользователи.

Удостоверения пользователей и групп являются удостоверениями Azure Active Directory (AAD). Таким образом, если не указано иное, *пользователь* в контексте Data Lake Storage 2-го поколения может означать пользователя Azure AD, субъект-службу или группу безопасности.

### <a name="the-owning-user"></a>Владелец

Пользователь, создавший элемент, автоматически становится владельцем элемента. Владелец может:

* изменять разрешения файла, владельцем которого он является;
* изменять группу владельцев файла, владельцем которого он является, если владелец файла одновременно является участником целевой группы.

> [!NOTE]
> Владелец *не может* изменить владельца другого файла или каталога. Изменить владельца файла или каталога может только суперпользователь.

### <a name="the-owning-group"></a>группа владельцев;

В списках управления доступом POSIX каждый пользователь связан с *основной группой*. Например, пользователь Алиса принадлежит к группе finance. Пользователь Aлиса может принадлежать к нескольким группам, но одна из них всегда назначается как основная. В интерфейсе POSIX, когда пользователь Aлиса создает файл, группа владельцев этого файла задается для основной группы этого пользователя, которой в данном случае является группа finance. В противном случае разрешения группы владельцев будут аналогичны разрешениям, назначенным другим пользователям или группам.

#### <a name="assigning-the-owning-group-for-a-new-file-or-directory"></a>Назначение группы владельцев для нового файла или каталога

* **Тип 1.** Корневой каталог "/". Этот каталог создается при создании файловой системы Data Lake Storage 2-го поколения. В данном случае группа владельцев закрепляется за пользователем, создавшим файловую систему, если это было сделано с помощью OAuth. Если файловая система создана с помощью общего ключа, SAS учетной записи или SAS службы, то владелец и группа владельцев устанавливаются как **$superuser**.
* **Тип 2** (во всех остальных случаях). При создании элемента группа владельцев копируется из родительского каталога.

#### <a name="changing-the-owning-group"></a>Изменение группы владельцев

Группа владельцев может быть изменена:
* одним из суперпользователей;
* владельцем, если он является участником целевой группы.

> [!NOTE]
> Группа владельцев не может изменить списки ACL для файла или каталога.  Если группа владельцев закрепляется за пользователем, который создал учетную запись с корневым каталогом (**тип 1** выше), одна учетная запись пользователя не может предоставлять разрешения группе владельцев. Разрешение можно назначить допустимой группе пользователей, если это применимо.

## <a name="access-check-algorithm"></a>Алгоритм проверки доступа

В следующем псевдокоде показан алгоритм проверки доступа к учетным записям Data Lake Storage 2-го поколения.

```
def access_check( user, desired_perms, path ) : 
  # access_check returns true if user has the desired permissions on the path, false otherwise
  # user is the identity that wants to perform an operation on path
  # desired_perms is a simple integer with values from 0 to 7 ( R=4, W=2, X=1). User desires these permissions
  # path is the file or directory
  # Note: the "sticky bit" is not illustrated in this algorithm
  
# Handle super users.
  if (is_superuser(user)) :
    return True

# Handle the owning user. Note that mask IS NOT used.
entry = get_acl_entry( path, OWNER )
if (user == entry.identity)
    return ( (desired_perms & entry.permissions) == desired_perms )

# Handle the named users. Note that mask IS used.
entries = get_acl_entries( path, NAMED_USER )
for entry in entries:
    if (user == entry.identity ) :
        mask = get_mask( path )
        return ( (desired_perms & entry.permissions & mask) == desired_perms)

# Handle named groups and owning group
member_count = 0
perms = 0
entries = get_acl_entries( path, NAMED_GROUP | OWNING_GROUP )
for entry in entries:
if (user_is_member_of_group(user, entry.identity)) :
    member_count += 1
    perms | =  entry.permissions
if (member_count>0) :
return ((desired_perms & perms & mask ) == desired_perms)

# Handle other
perms = get_perms_for_other(path)
mask = get_mask( path )
return ( (desired_perms & perms & mask ) == desired_perms)
```

### <a name="the-mask"></a>Маска

Как показано в разделе "Алгоритм проверки доступа", маска ограничивает доступ для именованных пользователей, группы владельцев и именованных групп.  

> [!NOTE]
> Для новой файловой системы Data Lake Storage 2-го поколения маска для списка ACL корневого каталога ("/") по умолчанию имеет значение 750 для каталогов и 640 для файлов. Файлы не получают бит X, так как он не имеет значения для файлов в системе, предусматривающей только хранение.
>
> Маску можно указать для каждого вызова. Это позволяет установить для разных потребляющих систем, например кластеров, разные действующие маски для файловых операций. Если маска указана в конкретном запросе, она полностью переопределяет маску по умолчанию.

### <a name="the-sticky-bit"></a>Бит фиксации

Бит фиксации является расширенной функцией файловой системы POSIX. В контексте Data Lake Storage 2-го поколения потребность в использовании бита фиксации маловероятна. Вкратце, если в каталоге включен бит фиксации, дочерний элемент может удалить или переименовать только владелец дочернего элемента.

Бит фиксации не отображается на портале Azure.

## <a name="default-permissions-on-new-files-and-directories"></a>Разрешения по умолчанию для новых файлов и каталогов

При создании нового файла или каталога в существующем каталоге список ACL по умолчанию для родительского каталога определяет:

- список ACL для доступа и список ACL по умолчанию для дочернего каталога;
- список ACL для доступа для дочернего файла (файлы не имеют списка ACL по умолчанию).

### <a name="umask"></a>umask

Когда создается файл или каталог, значение umask используется для изменения того, как для дочернего элемента устанавливаются списки ACL по умолчанию. umask — это 9-битное значение для родительских каталогов, содержащее значение RWX для **владельца**, **группы владельцев** и **других пользователей**.

umask для Azure Data Lake Storage 2-го поколения является константой со значением 007. Это значение преобразуется в следующие формы:

| Компонент umask     | Цифровая форма | Краткая форма | Значение |
|---------------------|--------------|------------|---------|
| umask.owning_user   |    0         |   `---`      | Для владельца стандартный список ACL родительского элемента копируется в список ACL для доступа дочернего элемента. | 
| umask.owning_group  |    0         |   `---`      | Для группы владельцев стандартный список ACL родительского элемента копируется в список ACL для доступа дочернего элемента. | 
| umask.other         |    7         |   `RWX`      | Для других пользователей все разрешения в списке ACL для доступа дочернего элемента удаляются. |

Значение umask, используемое Azure Data Lake Storage 2-го поколения, фактически означает, что значение для **других пользователей** никогда не передается по умолчанию в новые дочерние элементы независимо от того, что указывает ACL по умолчанию. 

Следующий псевдокод показывает, как применяется umask при создании списков ACL для дочернего элемента.

```
def set_default_acls_for_new_child(parent, child):
    child.acls = []
    for entry in parent.acls :
        new_entry = None
        if (entry.type == OWNING_USER) :
            new_entry = entry.clone(perms = entry.perms & (~umask.owning_user))
        elif (entry.type == OWNING_GROUP) :
            new_entry = entry.clone(perms = entry.perms & (~umask.owning_group))
        elif (entry.type == OTHER) :
            new_entry = entry.clone(perms = entry.perms & (~umask.other))
        else :
            new_entry = entry.clone(perms = entry.perms )
        child_acls.add( new_entry )
```

## <a name="common-questions-about-acls-in-data-lake-storage-gen2"></a>Часто задаваемые вопросы о списках ACL в Data Lake Storage 2-го поколения

### <a name="do-i-have-to-enable-support-for-acls"></a>Нужно ли мне активировать поддержку ACL?

№ Управление доступом с помощью списков ACL включено для учетной записи Data Lake Storage 2-го поколения, если включена функция "Иерархическое пространство имен" (HNS).

Если функция HNS выключена, будут по-прежнему применяться правила авторизации Azure RBAC.

### <a name="what-is-the-best-way-to-apply-acls"></a>Каким способом лучше всего применять списки ACL?

Всегда используйте группы безопасности Azure AD в качестве назначенного субъекта в списках ACL. Не назначайте напрямую отдельных пользователей или субъекты-службы. Использование этой структуры позволяет добавлять и удалять пользователей или субъекты-службы без необходимости повторно применять списки ACL ко всей структуре каталогов. Вместо этого нужно просто добавить их в соответствующую группу безопасности Azure AD или удалить их из нее. Имейте в виду, что списки ACL не наследуются, поэтому повторное применение списков ACL требует обновления списка ACL для каждого файле и подкаталога. 

### <a name="which-permissions-are-required-to-recursively-delete-a-directory-and-its-contents"></a>Какие разрешения требуются для рекурсивного удаления каталога и его содержимого?

- Наличие у вызывающей стороны разрешений суперпользователя.

или

- Для родительского каталога требуются разрешения на запись и выполнение.
- Чтобы удалить каталог и все вложенные в него каталоги, требуются разрешения на чтение, запись и выполнение.

> [!NOTE]
> Для удаления файлов в каталогах не требуются разрешения на запись. Кроме того, корневой каталог "/" удалить невозможно.

### <a name="who-is-the-owner-of-a-file-or-directory"></a>Кто назначается владельцем файла или каталога?

Создатель файла или каталога становится его владельцем. В случае корневого каталога это удостоверение пользователя, создавшего файловую систему.

### <a name="which-group-is-set-as-the-owning-group-of-a-file-or-directory-at-creation"></a>Как назначается группа владельцев файла или каталога при его создании?

Группа владельцев копируется из родительского каталога, в котором создан файл или каталог.

### <a name="i-am-the-owning-user-of-a-file-but-i-dont-have-the-rwx-permissions-i-need-what-do-i-do"></a>Я являюсь владельцем файла, но у меня нет необходимых разрешений RWX. Что делать?

Владелец может изменить разрешения на доступ к файлу на любое из требуемых RWX-разрешений.

### <a name="why-do-i-sometimes-see-guids-in-acls"></a>Почему в списках ACL иногда отображаются идентификаторы GUID?

Идентификатор GUID отображается, если запись представляет пользователя, которого больше не существует в Azure AD. Как правило, это происходит, если пользователь уволился или его учетная запись удалена из AAD. Кроме того, субъекты-службы и группы безопасности не имеют имени участника-пользователя (UPN) для их идентификации и поэтому они представлены атрибутом идентификатора объекта (идентификатором GUID).

### <a name="how-do-i-set-acls-correctly-for-a-service-principal"></a>Как задать списки управления доступом правильно для службы субъекта?

При определении списки ACL для субъектов-служб, очень важно использовать идентификатор объекта (OID) из *субъекта-службы* для регистрации приложения, который вы создали. Это важно отметить, что зарегистрированные приложения имеют отдельных субъектов в конкретный клиент Azure AD. Зарегистрированные приложения имеют OID, отображается на портале Azure, но *субъекта-службы* имеет другой идентификатор Объекта (другой).

Чтобы получить идентификатор Объекта для субъекта-службы, соответствующий регистрацию приложения, можно использовать `az ad sp show` команды. Укажите идентификатор приложения в качестве параметра. Ниже приведен пример на получение идентификатора Объекта субъекта-службы, соответствующий для регистрации приложения с ИД приложения = 18218b12-1895-43e9-ad80-6e8fc1ea88ce. Выполните следующую команду в Azure CLI.

`az ad sp show --id 18218b12-1895-43e9-ad80-6e8fc1ea88ce --query objectId
<<OID will be displayed>>`

Если у вас есть правильный идентификатор Объекта субъекта-службы, перейдите в обозреватель хранилища **управление доступом** страницу, чтобы добавить идентификатор Объекта и назначить соответствующие разрешения для идентификатора Объекта. Обязательно выберите **Сохранить**.

### <a name="does-data-lake-storage-gen2-support-inheritance-of-acls"></a>Поддерживает ли Data Lake Storage 2-го поколения наследование списков ACL?

Назначения Azure RBAC наследуются. Назначения передаются из подписки, группы ресурсов и ресурсов учетных записей хранения в ресурс файловой системы.

Списки ACL не наследуются. Однако с помощью списков ACL по умолчанию можно задать списки ACL для дочерних вложенных каталогов и файлов, создаваемых в родительском каталоге. 

### <a name="where-can-i-learn-more-about-posix-access-control-model"></a>Где можно получить дополнительную информацию о модели контроля доступа POSIX?

* [POSIX Access Control Lists on Linux](https://www.linux.com/news/posix-acls-linux) (Списки управления доступом POSIX для Linux)
* [HDFS Permission Guide](https://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html) (Руководство по разрешениям в HDFS)
* [POSIX FAQ (POSIX: вопросы и ответы)](https://www.opengroup.org/austin/papers/posix_faq.html)
* [POSIX 1003.1 2008](https://standards.ieee.org/findstds/standard/1003.1-2008.html)
* [POSIX 1003.1 2013](https://pubs.opengroup.org/onlinepubs/9699919799.2013edition/)
* [POSIX 1003.1 2016](https://pubs.opengroup.org/onlinepubs/9699919799.2016edition/)
* [POSIX ACL on Ubuntu](https://help.ubuntu.com/community/FilePermissionsACLs) (POSIX ACL для Ubuntu)
* [ACL: Using Access Control Lists on Linux](https://bencane.com/2012/05/27/acl-using-access-control-lists-on-linux/) (ACL: использование списков управления доступом в Linux)

## <a name="see-also"></a>См. также

* [Общие сведения об Azure Data Lake Storage 2-го поколения](../blobs/data-lake-storage-introduction.md)
