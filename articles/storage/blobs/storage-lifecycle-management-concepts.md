---
title: Управление жизненным циклом хранилища Azure
description: Узнайте, как создать правила для политики жизненного цикла, чтобы перевести данные из горячего уровня доступа на холодный и архивный.
services: storage
author: yzheng-msft
ms.service: storage
ms.topic: conceptual
ms.date: 3/20/2019
ms.author: yzheng
ms.subservice: common
ms.openlocfilehash: fe5e4b6a4f6a3da851b6e27419bff265758a1ba1
ms.sourcegitcommit: 6da4959d3a1ffcd8a781b709578668471ec6bf1b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2019
ms.locfileid: "58522219"
---
# <a name="manage-the-azure-blob-storage-lifecycle"></a>Управление хранилищем BLOB-объектов Azure жизненного цикла

Для каждого набора данных существуют уникальные требования к жизненному циклу. На ранних этапах жизненного цикла данных обращение к ним происходит часто. Но по мере устаревания данных потребность в доступе снижается очень быстро. Некоторые данные хранятся в облаке почти без использования, и после сохранения к ним обращаются крайне редко. Некоторые данные устаревают через несколько дней или месяцев после их создания, а другие наборы данных активно считываются и изменяются на протяжении всего времени существования. Управление жизненным циклом хранилища Azure BLOB-объектов предлагает широкие возможности, основанные на правилах политики для учетных записей хранения GPv2 и больших двоичных объектов. Эти политики позволяют переводить данные на новые уровни доступа и удалять их по завершении жизненного цикла.

Политика управления жизненным циклом поддерживает следующие возможности.

- Перемещение больших двоичных объектов на более холодный уровень доступа (с горячего на холодный, с горячего на архивный, с холодного на архивный) для оптимального баланса производительности и стоимости.
- Удаление больших двоичных объектов в конце их жизненных циклов.
- Определение правил, выполняемых раз в день, на уровне учетной записи хранения.
- Применение правил к контейнерам или подмножествам больших двоичных объектов (с префиксами в качестве фильтров).

В качестве примера давайте рассмотрим набор данных, доступ к которому осуществляется очень часто на ранних этапах жизненного цикла, но по истечении двух недель становится эпизодическим. Данные, которые хранятся больше месяца, запрашиваются крайне редко. В этом сценарии для ранних этапов лучше всего выбрать горячий уровень хранилища. Для нерегулярного доступа можно переместить данные на холодный уровень, а через месяц лучше всего воспользоваться архивным уровнем доступа. Выбирая уровни хранилища в зависимости от возраста данных, вы сможете создать наиболее экономичный вариант хранилища для конкретных потребностей. Чтобы достичь перемещения данных на более холодные уровни, можно использовать правила политики управления жизненным циклом.

## <a name="storage-account-support"></a>Поддержка учетных записей хранения

Политика управления жизненным циклом поддерживает учетные записи GPv2 (общего назначения, версия 2) и учетные записи хранилища BLOB-объектов. На портале Azure вы можете преобразовать существующую учетную запись GPv1 в учетную записью GPv2, запустив простой процесс одним щелчком мыши. Дополнительные сведения об учетных записях хранения см. в статье [Общие сведения об учетной записи хранения](../common/storage-account-overview.md).  

## <a name="pricing"></a>Цены 

Компонент управления жизненным циклом предоставляется бесплатно. Клиенты оплачивают только обычную стоимость вызовов API [Отображение BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/list-blobs) и [Установка уровня BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/set-blob-tier). Операция удаления предоставляется бесплатно. Дополнительные сведения см. на странице [цен на блочные BLOB-объекты](https://azure.microsoft.com/pricing/details/storage/blobs/).

## <a name="regional-availability"></a>Доступ по регионам 
Компонент управления жизненным циклом доступна во всех общедоступных регионах Azure. 


## <a name="add-or-remove-a-policy"></a>Добавление или удаление политики 

Можно добавить, изменить или удалить политику с помощью портала Azure, [Azure PowerShell](https://github.com/Azure/azure-powershell/releases), Azure CLI, REST API или клиентское средство. В этой статье показано, как управлять политикой с помощью портала и методы PowerShell.  

> [!NOTE]
> Если вы настроили для учетной записи хранения правила брандмауэра, запросы на управление жизненным циклом могут быть заблокированы. Их можно разблокировать, настроив исключения. Дополнительные сведения см. в разделе об исключениях в статье [Настройка брандмауэров службы хранилища Azure и виртуальных сетей](https://docs.microsoft.com/azure/storage/common/storage-network-security#exceptions).

### <a name="azure-portal"></a>Портал Azure

1. Войдите на [портале Azure](https://portal.azure.com).

2. Выберите **все ресурсы** и выберите свою учетную запись хранения.

3. В разделе **службы BLOB-объектов**выберите **управление жизненным циклом** для просмотра или изменения политики.

### <a name="powershell"></a>PowerShell

```powershell
#Install the latest module
Install-Module -Name Az -Repository PSGallery 

#Create a new action object

$action = Add-AzStorageAccountManagementPolicyAction -BaseBlobAction Delete -daysAfterModificationGreaterThan 2555
$action = Add-AzStorageAccountManagementPolicyAction -InputObject $action -BaseBlobAction TierToArchive -daysAfterModificationGreaterThan 90
$action = Add-AzStorageAccountManagementPolicyAction -InputObject $action -BaseBlobAction TierToCool -daysAfterModificationGreaterThan 30
$action = Add-AzStorageAccountManagementPolicyAction -InputObject $action -SnapshotAction Delete -daysAfterCreationGreaterThan 90

# Create a new filter object
# PowerShell automatically sets BlobType as “blockblob” because it is the only available option currently
$filter = New-AzStorageAccountManagementPolicyFilter -PrefixMatch ab,cd 

#Create a new fule object
#PowerShell automatically sets Type as “Lifecycle” because it is the only available option currently
$rule1 = New-AzStorageAccountManagementPolicyRule -Name Test -Action $action -Filter $filter

#Set the policy 
$policy = Set-AzStorageAccountManagementPolicy -ResourceGroupName $rgname -StorageAccountName $accountName -Rule $rule1

```


## <a name="policy"></a>Политика

Политика управления жизненным циклом представляет собой набор правил, оформленный в виде документа JSON.

```json
{
  "rules": [
    {
      "name": "rule1",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {...}
    },
    {
      "name": "rule2",
      "type": "Lifecycle",
      "definition": {...}
    }
  ]
}
```


Политика — это коллекция правил:

| Имя параметра | Тип параметра | Примечания |
|----------------|----------------|-------|
| правила          | Массив объектов правил | Требуется по крайней мере одно правило в политике. Можно определить до 100 правил в политике.|

Каждое правило в рамках политики есть несколько параметров:

| Имя параметра | Тип параметра | Примечания | Обязательно для заполнения |
|----------------|----------------|-------|----------|
| name           | Строка |Имя правила может содержать до 256 буквенно-цифровые символы. В именах правил учитывается регистр.  Имя должно быть уникальным в пределах политики. | Истина |
| Включено | Логическое | Необязательное логическое значение, разрешающее правило для временного отключена. Значение по умолчанию имеет значение true, если оно не задано. | Ложь | 
| Тип           | Значение перечисления | Текущий тип допустимым является `Lifecycle`. | Истина |
| Определение     | Объект, который определяет правило жизненного цикла | Каждое определение состоит из набора фильтров и набора действий. | Истина |

## <a name="rules"></a>Правила

Каждое определение правила состоит из набора фильтров и набора действий. [Набор фильтров](#rule-filters) ограничивает действие правила определенным набором объектов в контейнере или имен объектов. [Набор операций](#rule-actions) вводит в действие уровень или удаляет действия в отфильтрованном наборе объектов.

### <a name="sample-rule"></a>Пример правила
Следующий пример правила фильтрует учетной записи для выполнения действия с объектами, которые существуют в `container1` **AND** начинаются с `foo`.  

- установить для BLOB-объекта холодный уровень доступа через 30 дней после последнего изменения;
- установить для BLOB-объекта архивный уровень доступа через 90 дней после последнего изменения;
- удалить BLOB-объект спустя 2555 дней (7 лет) после последнего изменения;
- удалить моментальный снимок BLOB-объекта через 90 дней после создания моментального снимка.

```json
{
  "rules": [
    {
      "name": "ruleFoo",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ],
          "prefixMatch": [ "container1/foo" ]
        },
        "actions": {
          "baseBlob": {
            "tierToCool": { "daysAfterModificationGreaterThan": 30 },
            "tierToArchive": { "daysAfterModificationGreaterThan": 90 },
            "delete": { "daysAfterModificationGreaterThan": 2555 }
          },
          "snapshot": {
            "delete": { "daysAfterCreationGreaterThan": 90 }
          }
        }
      }
    }
  ]
}

```

### <a name="rule-filters"></a>Фильтры правила

Фильтры ограничивают действие правила определенным подмножеством BLOB-объектов в учетной записи хранения. Если определено несколько фильтров, для всех фильтров применяется логическая операция `AND`.

Допустимые фильтры используется следующее:

| Имя фильтра | Тип фильтра | Примечания | Обязательный |
|-------------|-------------|-------|-------------|
| blobTypes   | Массив предустановленных значений перечисления. | В текущем выпуске поддерживается `blockBlob`. | Yes |
| prefixMatch | Массив строк, по которым выполняется сопоставление префиксов. Каждое правило можно определить до 10 префиксы. Строка префикса должно начинаться с имени контейнера. Например, если вы хотите применить правило ко всем большим двоичным объектам в разделе "https://myaccount.blob.core.windows.net/container1/foo/...", укажите для prefixMatch значение `container1/foo`. | Если вы не определили prefixMatch, правило применяется для всех больших двоичных объектов в учетной записи хранения.  | Нет  |

### <a name="rule-actions"></a>Действия правила

Действия применяются к фильтрованных больших двоичных объектов, когда выполняется условие выполнения.

Управление жизненным циклом поддерживает распределение по уровням и удаление больших двоичных объектов и удаление моментальных снимков больших двоичных объектов. Определите в каждом правиле хотя бы одно действие для BLOB-объектов или моментальных снимков BLOB-объектов.

| Действие        | Базовый BLOB-объект                                   | Снимок      |
|---------------|---------------------------------------------|---------------|
| tierToCool    | Поддержка BLOB-объектов, размещенных на горячем уровне доступа         | Не поддерживается |
| tierToArchive | Поддержка BLOB-объектов, размещенных на горячем или холодном уровне доступа | Не поддерживается |
| удалить        | Поддерживаются                                   | Поддерживаются     |

>[!NOTE] 
>Если для одного BLOB-объекта определено более одного действия, управление жизненным циклом применяет к нему более дешевое из этих действий. Например, действие `delete` дешевле, чем действие `tierToArchive`; а действие `tierToArchive` дешевле, чем действие `tierToCool`.

Срок действия зависит от выполнения условий. Возраст для базового BLOB-объекта определяется по времени последнего изменения, а для моментального снимка BLOB-объекта — по времени создания.

| Запуск условие действия | Значение условия | ОПИСАНИЕ |
|----------------------------|-----------------|-------------|
| daysAfterModificationGreaterThan | Целочисленное значение, указывающее возраст в днях | Допустимое условие для действий с базовым BLOB-объектом |
| daysAfterCreationGreaterThan     | Целочисленное значение, указывающее возраст в днях | Допустимое условие для действий с моментальным снимком BLOB-объекта | 

## <a name="examples"></a>Примеры
Следующие примеры демонстрируют несколько типичных сценариев для правил политики жизненного цикла.

### <a name="move-aging-data-to-a-cooler-tier"></a>Перемещение старых данных на более холодный уровень

В следующем примере показано перемещение блочных BLOB-объектов с префиксом имени `container1/foo` или `container2/bar`. Эта политика перемещает BLOB-объекты, которые не изменялись более 30 дней, на холодный уровень, а которые не изменялись в течение 90 дней — на архивный уровень:

```json
{
  "rules": [
    {
      "name": "agingRule",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ],
          "prefixMatch": [ "container1/foo", "container2/bar" ]
        },
        "actions": {
          "baseBlob": {
            "tierToCool": { "daysAfterModificationGreaterThan": 30 },
            "tierToArchive": { "daysAfterModificationGreaterThan": 90 }
          }
        }
      }
    }
  ]
}
```

### <a name="archive-data-at-ingest"></a>Архивация данных при поступлении 

Некоторые данные хранятся в облаке почти без использования. Следующая политика жизненного цикла настроен для архивации данных, после их приема. В этом примере, переходы блочных BLOB-объектов в учетной записи хранения в контейнере `archivecontainer` в архивный уровень. Переход выполняется путем использования больших двоичных объектов 0 дней после последнего изменения:

```json
{
  "rules": [
    {
      "name": "archiveRule",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ],
          "prefixMatch": [ "archivecontainer" ]
        },
        "actions": {
          "baseBlob": {
              "tierToArchive": { "daysAfterModificationGreaterThan": 0 }
          }
        }
      }
    }
  ]
}

```

### <a name="expire-data-based-on-age"></a>Устаревание данных на основе возраста

Некоторые данные нужно удалять через определенное число дней или месяцев после их создания, чтобы снизить затраты на хранение или выполнить требования законодательства. Вы можете настроить политику управления жизненным циклом, чтобы удалять устаревшие данные при достижении определенного возраста. В следующем примере представлена политика, которая удаляет все BLOB-объекты (префикс не указан) старше 365 дней.

```json
{
  "rules": [
    {
      "name": "expirationRule",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ]
        },
        "actions": {
          "baseBlob": {
            "delete": { "daysAfterModificationGreaterThan": 365 }
          }
        }
      }
    }
  ]
}
```

### <a name="delete-old-snapshots"></a>Удаление старых моментальных снимков

Для данных, которые часто изменяются и используются на протяжении их существования, часто используются моментальные снимки для отслеживания ранних версий данных. Вы можете создать политику, которая удаляет старые моментальные снимки при достижении определенного возраста. Возраст моментального снимка определяется от момента создания моментального снимка. Это правило политики удаляет моментальные снимки BLOB-объектов в пределах контейнера `activedata`, с момента создания которых прошло 90 или более дней.

```json
{
  "rules": [
    {
      "name": "snapshotRule",
      "enabled": true,
      "type": "Lifecycle",      
    "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ],
          "prefixMatch": [ "activedata" ]
        },
        "actions": {
          "snapshot": {
            "delete": { "daysAfterCreationGreaterThan": 90 }
          }
        }
      }
    }
  ]
}
```
## <a name="faq---i-created-a-new-policy-why-are-the-actions-not-run-immediately"></a>Вопрос. Мною создана политика, но указанные действия не выполняются немедленно. Почему? 

Платформа выполняет политики жизненного цикла один раз в день. После настройки политики для запуска в первый раз может занять до 24 часов для некоторых действий (например, распределение по уровням и удаления).  

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как восстанавливать данные после случайного удаления:

- [Обратимое удаление больших двоичных объектов службы хранилища Azure](../blobs/storage-blob-soft-delete.md)
