---
title: Управление жизненным циклом службы хранилища Azure
description: Узнайте, как создать правила для политики жизненного цикла, чтобы перевести данные из горячего уровня доступа на холодный и архивный.
author: mhopkins-msft
ms.author: mhopkins
ms.date: 05/21/2019
ms.service: storage
ms.subservice: common
ms.topic: conceptual
ms.reviewer: yzheng
ms.openlocfilehash: f5578d00d633b4b1ccce41236526e1696744f59f
ms.sourcegitcommit: c38a1f55bed721aea4355a6d9289897a4ac769d2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/05/2019
ms.locfileid: "74851780"
---
# <a name="manage-the-azure-blob-storage-lifecycle"></a>Управление жизненным циклом хранилища BLOB-объектов Azure

Для каждого набора данных существуют уникальные требования к жизненному циклу. На ранних этапах жизненного цикла данных обращение к ним происходит часто. Но по мере устаревания данных потребность в доступе снижается очень быстро. Некоторые данные хранятся в облаке почти без использования, и после сохранения к ним обращаются крайне редко. Некоторые данные устаревают через несколько дней или месяцев после их создания, а другие наборы данных активно считываются и изменяются на протяжении всего времени существования. Управление жизненным циклом хранилища BLOB-объектов Azure предлагает обширную политику на основе правил для учетных записей GPv2 и хранилища BLOB-объектов. Эти политики позволяют переводить данные на новые уровни доступа и удалять их по завершении жизненного цикла.

Политика управления жизненным циклом поддерживает следующие возможности.

- Перемещение больших двоичных объектов на более холодный уровень доступа (с горячего на холодный, с горячего на архивный, с холодного на архивный) для оптимального баланса производительности и стоимости.
- Удаление больших двоичных объектов в конце их жизненных циклов.
- Определение правил, выполняемых раз в день, на уровне учетной записи хранения.
- Применение правил к контейнерам или подмножествам больших двоичных объектов (с префиксами в качестве фильтров).

Рассмотрим ситуацию, когда данные часто обращаются на ранних стадиях жизненного цикла, но иногда через две недели. Данные, которые хранятся больше месяца, запрашиваются крайне редко. В этом сценарии для ранних этапов лучше всего выбрать горячий уровень хранилища. Для случайного доступа наиболее подходящим является наиболее подходящее хранилище. Архивное хранилище — это лучший вариант уровня по истечении возраста данных в течение месяца. Выбирая уровни хранилища в зависимости от возраста данных, вы сможете создать наиболее экономичный вариант хранилища для конкретных потребностей. Чтобы достичь перемещения данных на более холодные уровни, можно использовать правила политики управления жизненным циклом.

[!INCLUDE [storage-multi-protocol-access-preview](../../../includes/storage-multi-protocol-access-preview.md)]

## <a name="storage-account-support"></a>Поддержка учетных записей хранения

Политика управления жизненным циклом доступна для учетных записей общего назначения v2 (GPv2), учетных записей хранения BLOB-объектов и учетных записей хранения блочных BLOB-объектов уровня "Премиум" В портал Azure можно обновить существующую учетную запись общего назначения (GPv1) до учетной записи GPv2. Дополнительные сведения об учетных записях хранения см. в статье [Общие сведения об учетной записи хранения](../common/storage-account-overview.md).  

## <a name="pricing"></a>Стоимость

Функция управления жизненным циклом не взимается. Клиенты оплачивают только обычную стоимость вызовов API [Отображение BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/list-blobs) и [Установка уровня BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/set-blob-tier). Операция удаления бесплатна. Дополнительные сведения см. на странице [цен на блочные BLOB-объекты](https://azure.microsoft.com/pricing/details/storage/blobs/).

## <a name="regional-availability"></a>Доступность по регионам

Функция управления жизненным циклом доступна во всех регионах Azure.

## <a name="add-or-remove-a-policy"></a>Добавление или удаление политики

Добавить, изменить или удалить политику можно с помощью любого из следующих методов.

* [Портал Azure](https://portal.azure.com)
* [Azure PowerShell](https://github.com/Azure/azure-powershell/releases)
* [Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli)
* [Интерфейсы REST API](https://docs.microsoft.com/rest/api/storagerp/managementpolicies)

Политику можно прочитать или записать полностью. Частичные обновления не поддерживаются. 

> [!NOTE]
> Если вы настроили для учетной записи хранения правила брандмауэра, запросы на управление жизненным циклом могут быть заблокированы. Вы можете разблокировать эти запросы, предоставив исключения для доверенных служб Майкрософт. Дополнительные сведения см. в разделе об исключениях в статье [Настройка брандмауэров службы хранилища Azure и виртуальных сетей](https://docs.microsoft.com/azure/storage/common/storage-network-security#exceptions).

В этой статье показано, как управлять политикой с помощью портала и методов PowerShell.  

# <a name="portaltabazure-portal"></a>[Microsoft Azure](#tab/azure-portal)

Существует два способа добавления политики с помощью портал Azure. 

* [Представление списка портал Azure](#azure-portal-list-view)
* [Представление кода портал Azure](#azure-portal-code-view)

#### <a name="azure-portal-list-view"></a>Представление списка портал Azure

1. Войдите на [портале Azure](https://portal.azure.com).

2. Выберите **все ресурсы** , а затем выберите свою учетную запись хранения.

3. В разделе **Служба BLOB-объектов**выберите **Управление жизненным циклом** , чтобы просмотреть или изменить правила.

4. Перейдите на вкладку **представление списка** .

5. Выберите **Добавить правило** , а затем заполните поля формы **набор действий** . В следующем примере большие двоичные объекты перемещаются в очень удобном хранилище, если они не были изменены в течение 30 дней.

   ![Страница набора действий по управлению жизненным циклом в портал Azure](media/storage-lifecycle-management-concepts/lifecycle-management-action-set.png)

6. Выберите **фильтр установить** , чтобы добавить необязательный фильтр. Затем нажмите кнопку **Обзор** , чтобы указать контейнер и папку для фильтрации.

   ![Страница "набор фильтров управления жизненным циклом" в портал Azure](media/storage-lifecycle-management-concepts/lifecycle-management-filter-set-browse.png)

8. Выберите **проверить и добавить** , чтобы проверить параметры политики.

9. Нажмите кнопку **Добавить** , чтобы добавить новую политику.

#### <a name="azure-portal-code-view"></a>Представление кода портал Azure
1. Войдите на [портале Azure](https://portal.azure.com).

2. Выберите **все ресурсы** , а затем выберите свою учетную запись хранения.

3. В разделе **Служба BLOB-объектов**выберите **Управление жизненным циклом** , чтобы просмотреть или изменить политику.

4. Следующий JSON является примером политики, которую можно вставлять на вкладку **представление кода** .

   ```json
   {
     "rules": [
       {
         "name": "ruleFoo",
         "enabled": true,
         "type": "Lifecycle",
         "definition": {
           "filters": {
             "blobTypes": [ "blockBlob" ],
             "prefixMatch": [ "container1/foo" ]
           },
           "actions": {
             "baseBlob": {
               "tierToCool": { "daysAfterModificationGreaterThan": 30 },
               "tierToArchive": { "daysAfterModificationGreaterThan": 90 },
               "delete": { "daysAfterModificationGreaterThan": 2555 }
             },
             "snapshot": {
               "delete": { "daysAfterCreationGreaterThan": 90 }
             }
           }
         }
       }
     ]
   }
   ```

5. Щелкните **Сохранить**.

6. Дополнительные сведения об этом примере JSON см. в разделах [Политика](#policy) и [правила](#rules) .

# <a name="powershelltabazure-powershell"></a>[PowerShell](#tab/azure-powershell)

Следующий скрипт PowerShell можно использовать для добавления политики в учетную запись хранения. Переменная `$rgname` должна быть инициализирована с именем группы ресурсов. Переменная `$accountName` должна быть инициализирована с помощью имени учетной записи хранения.

```powershell
#Install the latest module
Install-Module -Name Az -Repository PSGallery

#Initialize the following with your resource group and storage account names
$rgname = ""
$accountName = ""

#Create a new action object
$action = Add-AzStorageAccountManagementPolicyAction -BaseBlobAction Delete -daysAfterModificationGreaterThan 2555
$action = Add-AzStorageAccountManagementPolicyAction -InputObject $action -BaseBlobAction TierToArchive -daysAfterModificationGreaterThan 90
$action = Add-AzStorageAccountManagementPolicyAction -InputObject $action -BaseBlobAction TierToCool -daysAfterModificationGreaterThan 30
$action = Add-AzStorageAccountManagementPolicyAction -InputObject $action -SnapshotAction Delete -daysAfterCreationGreaterThan 90

# Create a new filter object
# PowerShell automatically sets BlobType as “blockblob” because it is the only available option currently
$filter = New-AzStorageAccountManagementPolicyFilter -PrefixMatch ab,cd

#Create a new rule object
#PowerShell automatically sets Type as “Lifecycle” because it is the only available option currently
$rule1 = New-AzStorageAccountManagementPolicyRule -Name Test -Action $action -Filter $filter

#Set the policy
$policy = Set-AzStorageAccountManagementPolicy -ResourceGroupName $rgname -StorageAccountName $accountName -Rule $rule1
```

# <a name="templatetabtemplate"></a>[Шаблон](#tab/template)

Управление жизненным циклом можно определить с помощью шаблонов Azure Resource Manager. Ниже приведен пример шаблона для развертывания учетной записи хранения RA-GRS GPv2 с политикой управления жизненным циклом.

```json
{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {},
  "variables": {
    "storageAccountName": "[uniqueString(resourceGroup().id)]"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('storageAccountName')]",
      "location": "[resourceGroup().location]",
      "apiVersion": "2019-04-01",
      "sku": {
        "name": "Standard_RAGRS"
      },
      "kind": "StorageV2",
      "properties": {
        "networkAcls": {}
      }
    },
    {
      "name": "[concat(variables('storageAccountName'), '/default')]",
      "type": "Microsoft.Storage/storageAccounts/managementPolicies",
      "apiVersion": "2019-04-01",
      "dependsOn": [
        "[variables('storageAccountName')]"
      ],
      "properties": {
        "policy": {...}
      }
    }
  ],
  "outputs": {}
}
```

---

## <a name="policy"></a>Политика

Политика управления жизненным циклом представляет собой набор правил, оформленный в виде документа JSON.

```json
{
  "rules": [
    {
      "name": "rule1",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {...}
    },
    {
      "name": "rule2",
      "type": "Lifecycle",
      "definition": {...}
    }
  ]
}
```

Политика — это набор правил.

| Имя параметра | Тип параметра | Заметки |
|----------------|----------------|-------|
| `rules`        | Массив объектов правил | В политике требуется по крайней мере одно правило. В политике можно определить до 100 правил.|

Каждое правило в политике имеет несколько параметров:

| Имя параметра | Тип параметра | Заметки | Обязательно для заполнения |
|----------------|----------------|-------|----------|
| `name`         | Строка |Имя правила может включать до 256 буквенно-цифровых символов. В именах правил учитывается регистр.  Имя должно быть уникальным в пределах политики. | Да |
| `enabled`      | Логический | Необязательное логическое значение, которое позволяет временно отключить правило. Значение по умолчанию — true, если оно не задано. | Нет | 
| `type`         | Значение перечисления | Текущий допустимый тип — `Lifecycle`. | Да |
| `definition`   | Объект, который определяет правило жизненного цикла | Каждое определение состоит из набора фильтров и набора действий. | Да |

## <a name="rules"></a>Правила

Каждое определение правила состоит из набора фильтров и набора действий. [Набор фильтров](#rule-filters) ограничивает действие правила определенным набором объектов в контейнере или имен объектов. [Набор операций](#rule-actions) вводит в действие уровень или удаляет действия в отфильтрованном наборе объектов.

### <a name="sample-rule"></a>Пример правила

В следующем примере правила выполняется фильтрация учетной записи для выполнения действий с объектами, которые существуют в `container1` и начинаются с `foo`.  

- установить для BLOB-объекта холодный уровень доступа через 30 дней после последнего изменения;
- установить для BLOB-объекта архивный уровень доступа через 90 дней после последнего изменения;
- удалить BLOB-объект спустя 2555 дней (7 лет) после последнего изменения;
- удалить моментальный снимок BLOB-объекта через 90 дней после создания моментального снимка.

```json
{
  "rules": [
    {
      "name": "ruleFoo",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ],
          "prefixMatch": [ "container1/foo" ]
        },
        "actions": {
          "baseBlob": {
            "tierToCool": { "daysAfterModificationGreaterThan": 30 },
            "tierToArchive": { "daysAfterModificationGreaterThan": 90 },
            "delete": { "daysAfterModificationGreaterThan": 2555 }
          },
          "snapshot": {
            "delete": { "daysAfterCreationGreaterThan": 90 }
          }
        }
      }
    }
  ]
}
```

### <a name="rule-filters"></a>Фильтры правила

Фильтры ограничивают действие правила определенным подмножеством BLOB-объектов в учетной записи хранения. Если определено несколько фильтров, для всех фильтров применяется логическая операция `AND`.

Доступны следующие фильтры:

| Имя фильтра | Тип фильтра | Заметки | Обязательный |
|-------------|-------------|-------|-------------|
| blobTypes   | Массив предустановленных значений перечисления. | Текущий выпуск поддерживает `blockBlob`. | ДА |
| prefixMatch | Массив строк, по которым выполняется сопоставление префиксов. Каждое правило может определять до 10 префиксов. Строка префикса должно начинаться с имени контейнера. Например, если нужно сопоставить все большие двоичные объекты в `https://myaccount.blob.core.windows.net/container1/foo/...` правила, Префиксматч будет `container1/foo`. | Если не определить Префиксматч, правило применяется ко всем BLOB-объектам в учетной записи хранения.  | Нет |

### <a name="rule-actions"></a>Действия правила

Действия применяются к отфильтрованным BLOB-объектам при выполнении условия выполнения.

Управление жизненным циклом поддерживает распределение и удаление больших двоичных объектов и удаление моментальных снимков больших двоичных объектов. Определите в каждом правиле хотя бы одно действие для BLOB-объектов или моментальных снимков BLOB-объектов.

| Действия        | Базовый BLOB-объект                                   | Моментальный снимок      |
|---------------|---------------------------------------------|---------------|
| tierToCool    | Поддержка BLOB-объектов, размещенных на горячем уровне доступа         | Не поддерживается |
| tierToArchive | Поддержка BLOB-объектов, размещенных на горячем или холодном уровне доступа | Не поддерживается |
| удалить        | Поддерживается                                   | Поддерживается     |

>[!NOTE]
>Если для одного BLOB-объекта определено более одного действия, управление жизненным циклом применяет к нему более дешевое из этих действий. Например, действие `delete` дешевле, чем действие `tierToArchive`; а действие `tierToArchive` дешевле, чем действие `tierToCool`.

Условия выполнения основаны на возраст. Возраст для базового BLOB-объекта определяется по времени последнего изменения, а для моментального снимка BLOB-объекта — по времени создания.

| Условие выполнения действия             | Значение условия                          | Описание                             |
|----------------------------------|------------------------------------------|-----------------------------------------|
| daysAfterModificationGreaterThan | Целочисленное значение, указывающее возраст в днях | Условие для действий базового большого двоичного объекта     |
| daysAfterCreationGreaterThan     | Целочисленное значение, указывающее возраст в днях | Условие для действий моментальных снимков BLOB-объектов |

## <a name="examples"></a>Примеры

Следующие примеры демонстрируют несколько типичных сценариев для правил политики жизненного цикла.

### <a name="move-aging-data-to-a-cooler-tier"></a>Перемещение старых данных на более холодный уровень

В следующем примере показано перемещение блочных BLOB-объектов с префиксом имени `container1/foo` или `container2/bar`. Эта политика перемещает BLOB-объекты, которые не изменялись более 30 дней, на холодный уровень, а которые не изменялись в течение 90 дней — на архивный уровень:

```json
{
  "rules": [
    {
      "name": "agingRule",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ],
          "prefixMatch": [ "container1/foo", "container2/bar" ]
        },
        "actions": {
          "baseBlob": {
            "tierToCool": { "daysAfterModificationGreaterThan": 30 },
            "tierToArchive": { "daysAfterModificationGreaterThan": 90 }
          }
        }
      }
    }
  ]
}
```

### <a name="archive-data-at-ingest"></a>Архивация данных при поступлении

Некоторые данные хранятся в облаке почти без использования. Следующая политика жизненного цикла настраивается для архивации данных после их приема. В этом примере выполняется перевод блочных BLOB-объектов в учетной записи хранения в контейнере `archivecontainer` в архивный уровень. Переход выполняется с помощью больших двоичных объектов за 0 дней после последнего изменения:

> [!NOTE] 
> Рекомендуется передать большие двоичные объекты непосредственно на уровне архива, чтобы повысить эффективность. Вы можете использовать заголовок x-MS-ACE-Tier для [PutBlob](https://docs.microsoft.com/rest/api/storageservices/put-blob) или [PutBlockList](https://docs.microsoft.com/rest/api/storageservices/put-block-list) с оставшейся версией 2018-11-09 и более поздней или нашей последней клиентской библиотекой хранилища BLOB-объектов. 

```json
{
  "rules": [
    {
      "name": "archiveRule",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ],
          "prefixMatch": [ "archivecontainer" ]
        },
        "actions": {
          "baseBlob": {
              "tierToArchive": { "daysAfterModificationGreaterThan": 0 }
          }
        }
      }
    }
  ]
}

```

### <a name="expire-data-based-on-age"></a>Устаревание данных на основе возраста

Ожидается, что срок действия некоторых данных истекает в днях или месяцах после создания. Вы можете настроить политику управления жизненным циклом, чтобы удалять устаревшие данные при достижении определенного возраста. В следующем примере показана политика, которая удаляет все блочные BLOB-объекты старше 365 дней.

```json
{
  "rules": [
    {
      "name": "expirationRule",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ]
        },
        "actions": {
          "baseBlob": {
            "delete": { "daysAfterModificationGreaterThan": 365 }
          }
        }
      }
    }
  ]
}
```

### <a name="delete-old-snapshots"></a>Удаление старых моментальных снимков

Для данных, которые часто изменяются и используются на протяжении их существования, часто используются моментальные снимки для отслеживания ранних версий данных. Вы можете создать политику, которая удаляет старые моментальные снимки при достижении определенного возраста. Возраст моментального снимка определяется от момента создания моментального снимка. Это правило политики удаляет моментальные снимки BLOB-объектов в пределах контейнера `activedata`, с момента создания которых прошло 90 или более дней.

```json
{
  "rules": [
    {
      "name": "snapshotRule",
      "enabled": true,
      "type": "Lifecycle",
    "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ],
          "prefixMatch": [ "activedata" ]
        },
        "actions": {
          "snapshot": {
            "delete": { "daysAfterCreationGreaterThan": 90 }
          }
        }
      }
    }
  ]
}
```

## <a name="faq"></a>Вопросы и ответы

**Я создал новую политику, почему действия не выполняются немедленно?**  
Платформа выполняет политики жизненного цикла один раз в день. После настройки политики для первого выполнения некоторых действий может потребоваться до 24 часов.  

**Сколько времени требуется для выполнения действий при обновлении существующей политики?**  
Обновленная политика вступает в силу до 24 часов. Когда политика вступит в силу, выполнение действий может занять до 24 часов. Поэтому выполнение политики может занять до 48 часов.   

**Я вручную повторно занесли в архив большой двоичный объект, как предотвратить его временное перемещение на архивный уровень?**  
При перемещении большого двоичного объекта с одного уровня доступа на другой его время последнего изменения не изменяется. Если вы вручную восстанавливаете архивный BLOB-объект на "горячем" уровне, он перемещается обратно на уровень архива с помощью подсистемы управления жизненным циклом. Отключите правило, которое временно влияет на этот большой двоичный объект, чтобы предотвратить его архивацию. Повторно включите правило, когда большой двоичный объект можно безопасно переместить обратно на архивный уровень. Вы также можете скопировать большой двоичный объект в другое расположение, если он должен постоянно оставаться на активном или холодном уровне.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как восстанавливать данные после случайного удаления:

- [Soft delete for Azure Storage blobs](../blobs/storage-blob-soft-delete.md) (Обратимое удаление больших двоичных объектов службы хранилища Azure)
