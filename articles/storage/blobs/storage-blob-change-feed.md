---
title: Канал изменений в хранилище BLOB-объектов Azure (Предварительная версия) | Документация Майкрософт
description: Сведения о журналах веб-каналов изменений в хранилище BLOB-объектов Azure и их использовании.
author: normesta
ms.author: normesta
ms.date: 11/04/2019
ms.topic: conceptual
ms.service: storage
ms.subservice: blobs
ms.reviewer: sadodd
ms.openlocfilehash: 19a65e688d66738db0b6e4dcca383c6e4abed262
ms.sourcegitcommit: 5ab4f7a81d04a58f235071240718dfae3f1b370b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2019
ms.locfileid: "74974413"
---
# <a name="change-feed-support-in-azure-blob-storage-preview"></a>Поддержка канала изменений в хранилище BLOB-объектов Azure (Предварительная версия)

Веб-канал изменений предназначен для предоставления журналов транзакций всех изменений, происходящих в больших двоичных объектах и метаданных больших двоичных объектов в вашей учетной записи хранения. Веб-канал изменений предоставляет **упорядоченный**, **гарантированный**, **устойчивый**, **неизменяемый**журнал этих изменений, предназначенный **только для чтения** . Клиентские приложения могут считывать эти журналы в любое время либо в потоковой передаче, либо в пакетном режиме. Канал изменений позволяет создавать эффективные и масштабируемые решения, которые обрабатывают события изменения, происходящие в учетной записи хранения BLOB-объектов, с низкой стоимостью.

Веб-канал изменений хранится в виде [больших двоичных объектов](https://docs.microsoft.com/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs) в специальном контейнере в учетной записи хранения со стандартной ценой [ценообразования больших двоичных объектов](https://azure.microsoft.com/pricing/details/storage/blobs/) . Вы можете контролировать срок хранения этих файлов в соответствии с вашими требованиями (см. [условия](#conditions) текущего выпуска). События изменения добавляются в веб-канал изменений в виде записей в спецификации формата [Apache Avro](https://avro.apache.org/docs/1.8.2/spec.html) : компактный, быстрый двоичный формат, обеспечивающий широкие возможности структуры данных со встроенной схемой. Этот формат широко используется в экосистеме Hadoop, Stream Analytics и фабрике данных Azure.

Эти журналы можно обрабатывать асинхронно, постепенно или полностью. Любое количество клиентских приложений может независимо считывать канал изменений в параллельном режиме и в собственном темпе. Такие приложения аналитики, как [Apache детализиру](https://drill.apache.org/docs/querying-avro-files/) или [Apache Spark](https://spark.apache.org/docs/latest/sql-data-sources-avro.html) , могут использовать журналы непосредственно в качестве файлов Avro, что позволяет обрабатывать их с низкой стоимостью с высокой пропускной способностью и без необходимости писать пользовательское приложение.

Поддержка веб-канала изменений хорошо подходит для сценариев, обрабатывающих данные на основе измененных объектов. Например, приложения могут:

  - Обновление вторичного индекса, синхронизация с кэшем, поисковой системой или любыми другими сценариями управления содержимым.
  
  - Извлеките аналитические сведения и метрики бизнес-аналитики на основе изменений, происходящих с объектами, в потоковой или пакетном режиме.
  
  - Храните и анализируйте изменения в объектах в течение любого периода времени, чтобы обеспечить безопасность, соответствие или аналитику для управления корпоративными данными.

  - Создавайте решения для архивации, зеркального копирования или репликации состояния объектов в учетной записи для аварийного управления или обеспечения соответствия.

  - Создавайте подключенные конвейеры приложений, реагирующие на события изменения или запланируя выполнение на основе созданного или измененного объекта.

> [!NOTE]
> Веб-канал изменений предоставляет устойчивую упорядоченную модель журнала изменений, происходящих в большом двоичном объекте. Изменения записываются и становятся доступными в журнале веб-канала изменений в течение нескольких минут после изменения. Если приложение должно реагировать на события гораздо быстрее, попробуйте использовать [события хранилища BLOB-объектов](storage-blob-event-overview.md) . [События хранилища BLOB-объектов](storage-blob-event-overview.md) предоставляют одноразовые события в реальном времени, которые позволяют функциям и приложениям Azure быстро реагировать на изменения, происходящие в большом двоичном объекте. 

## <a name="enable-and-disable-the-change-feed"></a>Включение и отключение веб-канала изменений

Необходимо включить веб-канал изменений в учетной записи хранения, чтобы начать запись и запись изменений. Отключите веб-канал изменений для отмены записи изменений. Вы можете включать и отключать изменения с помощью шаблонов Azure Resource Manager на портале или PowerShell.

Ниже приведены некоторые моменты, которые следует учитывать при включении веб-канала изменений.

- Существует только один канал изменений для службы BLOB-объектов в каждой учетной записи хранения и он хранится в контейнере **$blobchangefeed** .

- Создание, обновление и удаление изменений фиксируются только на уровне службы BLOB-объектов.

- Веб-канал изменений фиксирует *все* изменения для всех доступных событий, происходящих в учетной записи. При необходимости клиентские приложения могут отфильтровывать типы событий. (См. [условия](#conditions) текущего выпуска).

- Включить веб-канал изменений могут только учетные записи хранилища GPv2 и BLOB-объектов. Учетные записи Premium Блоккблобстораже и иерархическое пространство имен с включенными учетными записями сейчас не поддерживаются. Учетные записи хранения GPv1 не поддерживаются, но их можно обновить до GPv2 без простоев. Дополнительные сведения см. в статье [обновление до учетной записи хранения GPv2](../common/storage-account-upgrade.md) .

> [!IMPORTANT]
> Веб-канал изменений находится в общедоступной предварительной версии и доступен в регионах **westcentralus** и **westus2** . См. раздел " [условия](#conditions) " этой статьи. Чтобы зарегистрироваться в предварительной версии, ознакомьтесь с разделом [регистрация подписки](#register) в этой статье. Необходимо зарегистрировать подписку перед включением веб-канала изменений в учетных записях хранения.

### <a name="portaltabazure-portal"></a>[Microsoft Azure](#tab/azure-portal)

Включите веб-канал изменений в учетной записи хранения с помощью портал Azure:

1. В [портал Azure](https://portal.azure.com/)выберите свою учетную запись хранения. 

2. Перейдите к параметру **Защита данных** в разделе **Служба BLOB-объектов**.

3. Щелкните **включено** в разделе **канал изменений BLOB-объекта** .

4. Нажмите кнопку " **сохранить** ", чтобы подтвердить параметры защиты данных

![](media/storage-blob-soft-delete/storage-blob-soft-delete-portal-configuration.png)

### <a name="powershelltabazure-powershell"></a>[PowerShell](#tab/azure-powershell)

Включите веб-канал изменений с помощью PowerShell:

1. Установите последнюю версию PowershellGet.

   ```powershell
   Install-Module PowerShellGet –Repository PSGallery –Force
   ```

2. Закройте, а затем снова откройте консоль PowerShell.

3. Установите модуль **AZ. Storage** Preview.

   ```powershell
   Install-Module Az.Storage –Repository PSGallery -RequiredVersion 1.8.1-preview –AllowPrerelease –AllowClobber –Force
   ```

4. Чтобы выполнить проверку подлинности, войдите в подписку Azure с помощью команды `Connect-AzAccount` и следуйте инструкциям на экране.

   ```powershell
   Connect-AzAccount
   ```

5. Включите веб-канал изменений для учетной записи хранения.

   ```powershell
   Update-AzStorageBlobServiceProperty -ResourceGroupName -StorageAccountName -EnableChangeFeed $true
   ```

### <a name="templatetabtemplate"></a>[Шаблон](#tab/template)
Используйте шаблон Azure Resource Manager, чтобы включить канал изменений в существующей учетной записи хранения с помощью портал Azure.

1. В портал Azure выберите **создать ресурс**.

2. В строке **Поиск в Marketplace** введите **развертывание шаблона** и нажмите клавишу **ВВОД**.

3. Выберите **[развернуть настраиваемый шаблон](https://portal.azure.com/#create/Microsoft.Template)** , а затем **в редакторе выберите создать собственный шаблон**.

4. В редакторе шаблонов вставьте следующий код JSON. Замените заполнитель `<accountName>` именем вашей учетной записи хранения.

   ```json
   {
       "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
       "contentVersion": "1.0.0.0",
       "parameters": {},
       "variables": {},
       "resources": [{
           "type": "Microsoft.Storage/storageAccounts/blobServices",
           "apiVersion": "2019-04-01",
           "name": "<accountName>/default",
           "properties": {
               "changeFeed": {
                   "enabled": true
               }
           } 
        }]
   }
   ```
    
5. Нажмите кнопку **сохранить** , укажите группу ресурсов учетной записи, а затем нажмите кнопку **приобрести** , чтобы развернуть шаблон и включить веб-канал изменений.

---

## <a name="consume-the-change-feed"></a>Использование веб-канала изменений

Веб-канал изменений создает несколько метаданных и файлов журналов. Эти файлы находятся в контейнере **$blobchangefeed** учетной записи хранения. 

> [!NOTE]
> В текущем выпуске контейнер **$blobchangefeed** не отображается в Обозреватель службы хранилища Azure или портал Azure. В настоящее время невозможно увидеть контейнер $blobchangefeed при вызове API ListContainers, но вы можете вызвать API ListBlobs непосредственно в контейнере для просмотра больших двоичных объектов.

Клиентские приложения могут использовать веб-канал изменений с помощью библиотеки обработчика канала изменения больших двоичных объектов, предоставляемой с помощью пакета SDK для обработчика веб-канала изменений. 

См. статью [Обработка журналов веб-канала изменений в хранилище BLOB-объектов Azure](storage-blob-change-feed-how-to.md).

## <a name="understand-change-feed-organization"></a>Общие сведения об организации веб-канала изменений

<a id="segment-index"></a>

### <a name="segments"></a>Сегменты

Веб-канал изменений — это журнал изменений, которые организованы в **почасовые** *сегменты* , но добавляются к и обновляются каждые несколько минут. Эти сегменты создаются только при наличии событий изменения большого двоичного объекта, происходящих за этот час. Это позволяет клиентскому приложению использовать изменения, происходящие в определенные диапазоны времени, без необходимости выполнять поиск по всему журналу. Дополнительные сведения см. в [спецификациях](#specifications).

Доступный ежечасный сегмент веб-канала изменений описывается в файле манифеста, который указывает пути к файлам веб-канала изменений для этого сегмента. В списке `$blobchangefeed/idx/segments/` виртуального каталога показаны сегменты, упорядоченные по времени. Путь сегмента описывает начало почасового диапазона времени, который представляет сегмент. Этот список можно использовать для фильтрации сегментов интересующих вас журналов.

```text
Name                                                                    Blob Type    Blob Tier      Length  Content Type    
----------------------------------------------------------------------  -----------  -----------  --------  ----------------
$blobchangefeed/idx/segments/1601/01/01/0000/meta.json                  BlockBlob                      584  application/json
$blobchangefeed/idx/segments/2019/02/22/1810/meta.json                  BlockBlob                      584  application/json
$blobchangefeed/idx/segments/2019/02/22/1910/meta.json                  BlockBlob                      584  application/json
$blobchangefeed/idx/segments/2019/02/23/0110/meta.json                  BlockBlob                      584  application/json
```

> [!NOTE]
> `$blobchangefeed/idx/segments/1601/01/01/0000/meta.json` автоматически создается при включении веб-канала изменений. Этот файл можно спокойно проигнорировать. Это всегда пустой файл инициализации. 

В файле манифеста сегмента (`meta.json`) показан путь к файлам веб-канала изменений для этого сегмента в свойстве `chunkFilePaths`. Ниже приведен пример файла манифеста сегмента.

```json
{
    "version": 0,
    "begin": "2019-02-22T18:10:00.000Z",
    "intervalSecs": 3600,
    "status": "Finalized",
    "config": {
        "version": 0,
        "configVersionEtag": "0x8d698f0fba563db",
        "numShards": 2,
        "recordsFormat": "avro",
        "formatSchemaVersion": 1,
        "shardDistFnVersion": 1
    },
    "chunkFilePaths": [
        "$blobchangefeed/log/00/2019/02/22/1810/",
        "$blobchangefeed/log/01/2019/02/22/1810/"
    ],
    "storageDiagnostics": {
        "version": 0,
        "lastModifiedTime": "2019-02-22T18:11:01.187Z",
        "data": {
            "aid": "55e507bf-8006-0000-00d9-ca346706b70c"
        }
    }
}
```

> [!NOTE]
> Контейнер `$blobchangefeed` отображается только после включения функции веб-канала изменений в учетной записи. После включения веб-канала изменений необходимо подождать несколько минут, прежде чем можно будет перечислить большие двоичные объекты в контейнере. 

<a id="log-files"></a>

### <a name="change-event-records"></a>Изменение записей событий

Файлы веб-канала изменений содержат ряд записей об изменениях событий. Каждая запись события изменения соответствует одному изменению на отдельный большой двоичный объект. Записи сериализуются и записываются в файл, используя спецификацию формата [Apache Avro](https://avro.apache.org/docs/1.8.2/spec.html) . Записи можно считывать с помощью спецификации формата файла Avro. Существует несколько библиотек, которые можно использовать для обработки файлов в этом формате.

Файлы веб-канала изменений хранятся в `$blobchangefeed/log/` виртуальном каталоге в качестве [добавочных BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs#about-append-blobs). Первый файл веб-канала изменений в каждом пути будет содержать `00000` в имени файла (например, `00000.avro`). Имя каждого последующего файла журнала, добавляемого к этому пути, увеличится на 1 (например, `00001.avro`).

Ниже приведен пример записи события Change из файла веб-канала изменений, преобразованного в JSON.

```json
{
     "schemaVersion": 1,
     "topic": "/subscriptions/dd40261b-437d-43d0-86cf-ef222b78fd15/resourceGroups/sadodd/providers/Microsoft.Storage/storageAccounts/mytestaccount",
     "subject": "/blobServices/default/containers/mytestcontainer/blobs/mytestblob",
     "eventType": "BlobCreated",
     "eventTime": "2019-02-22T18:12:01.079Z",
     "id": "55e5531f-8006-0000-00da-ca3467000000",
     "data": {
         "api": "PutBlob",
         "clientRequestId": "edf598f4-e501-4750-a3ba-9752bb22df39",
         "requestId": "00000000-0000-0000-0000-000000000000",
         "etag": "0x8D698F13DCB47F6",
         "contentType": "application/octet-stream",
         "contentLength": 128,
         "blobType": "BlockBlob",
         "url": "",
         "sequencer": "000000000000000100000000000000060000000000006d8a",
         "storageDiagnostics": {
             "bid": "11cda41c-13d8-49c9-b7b6-bc55c41b3e75",
             "seq": "(6,5614,28042,28038)",
             "sid": "591651bd-8eb3-c864-1001-fcd187be3efd"
         }
  }
}
```

Описание каждого свойства см. в статье [схема событий службы "Сетка событий Azure" для хранилища BLOB-объектов](https://docs.microsoft.com/azure/event-grid/event-schema-blob-storage?toc=%2fazure%2fstorage%2fblobs%2ftoc.json#event-properties).

> [!NOTE]
> Файлы веб-канала изменений для сегмента не сразу появляются после создания сегмента. Продолжительность задержки находится в пределах обычного интервала задержки публикации веб-канала изменений, который находится в течение нескольких минут после изменения.

<a id="specifications"></a>

## <a name="specifications"></a>Спецификации

- Записи о событиях изменения добавляются только в веб-канал изменений. После добавления этих записей они являются неизменяемыми, а запись на уровне записи является стабильной. Клиентские приложения могут поддерживать собственную контрольную точку в точке чтения веб-канала изменений.

- Записи о событиях изменения добавляются в течение нескольких минут после изменения. Клиентские приложения могут использовать записи по мере их добавления в потоковый доступ или в неполное время.

- Записи событий изменения упорядочиваются по порядку изменения **на большой двоичный объект**. Порядок изменений в больших двоичных объектах не определен в хранилище BLOB-объектов Azure. Все изменения в предыдущем сегменте предшествуют изменениям в последующих сегментах.

- Записи событий изменений сериализуются в файл журнала с помощью спецификации [Apache Avro 1.8.2](https://avro.apache.org/docs/1.8.2/spec.html) Format.

- Измените записи событий, в которых `eventType` имеет значение `Control` являются внутренними системными записями и не отображают изменения объектов в вашей учетной записи. Эти записи можно спокойно игнорировать.

- Значения в контейнере свойств `storageDiagnonstics` предназначены только для внутреннего использования и не предназначены для использования приложением. Приложения не должны иметь контрактную зависимость от этих данных. Эти свойства можно спокойно игнорировать.

- Время, представленное сегментом, **приблизительным** с учетом пределов в 15 минут. Таким образом, чтобы обеспечить потребление всех записей в течение заданного времени, следует использовать последовательный предыдущий и следующий час.

- Каждый сегмент может иметь различное количество `chunkFilePaths` из-за внутреннего секционирования потока журнала для управления пропускной способностью публикации. Файлы журналов в каждой `chunkFilePath` гарантированно содержат взаимоисключающие большие двоичные объекты, и их можно обрабатывать параллельно, не нарушая порядок изменений на большой двоичный объект во время итерации.

- Сегменты начинаются в `Publishing` состоянии. После завершения добавления записей в сегмент он будет `Finalized`. Файлы журнала в любом сегменте, который датирован после даты `LastConsumable` свойства в файле `$blobchangefeed/meta/Segments.json`, не должны использоваться приложением. Ниже приведен пример свойства `LastConsumable`в файле `$blobchangefeed/meta/Segments.json`.

```json
{
    "version": 0,
    "lastConsumable": "2019-02-23T01:10:00.000Z",
    "storageDiagnostics": {
        "version": 0,
        "lastModifiedTime": "2019-02-23T02:24:00.556Z",
        "data": {
            "aid": "55e551e3-8006-0000-00da-ca346706bfe4",
            "lfz": "2019-02-22T19:10:00.000Z"
        }
    }
}

```

<a id="register"></a>

## <a name="register-your-subscription-preview"></a>Регистрация подписки (Предварительная версия)

Так как веб-канал изменений доступен только в общедоступной предварительной версии, необходимо зарегистрировать подписку для использования этой функции.

### <a name="register-by-using-powershell"></a>Регистрация с помощью PowerShell

В консоли PowerShell выполните следующие команды:

```powershell
Register-AzProviderFeature -FeatureName Changefeed -ProviderNamespace Microsoft.Storage
Register-AzResourceProvider -ProviderNamespace Microsoft.Storage
```
   
### <a name="register-by-using-azure-cli"></a>Регистрация с помощью Azure CLI

В Azure Cloud Shell выполните следующие команды:

```cli
az feature register --namespace Microsoft.Storage --name Changefeed
az provider register --namespace 'Microsoft.Storage'
```

<a id="conditions"></a>

## <a name="conditions-and-known-issues-preview"></a>Условия и известные проблемы (Предварительная версия)

В этом разделе описаны известные проблемы и условия в текущей общедоступной предварительной версии веб-канала изменений. 
- Для предварительной версии необходимо сначала [зарегистрировать подписку](#register) , прежде чем включать канал изменений для учетной записи хранения в регионах westcentralus или westus2. 
- Веб-канал изменений фиксирует только операции создания, обновления, удаления и копирования. Обновления метаданных в настоящее время не записываются в предварительной версии.
- Изменения записей событий для любого отдельного изменения могут появиться в веб-канале изменений несколько раз.
- Вы пока не можете управлять временем существования файлов журнала веб-канала изменений, установив на них политику хранения на основе времени, и вы не сможете удалить большие двоичные объекты. 
- Свойство `url` файла журнала в настоящее время всегда пусто.
- Свойство `LastConsumable` файла Segments. JSON не содержит первый сегмент, который завершается веб-каналом изменений. Эта проблема возникает только после завершения первого сегмента. Все последующие сегменты после первого часа точно фиксируются в свойстве `LastConsumable`.
- В настоящее время невозможно увидеть контейнер **$blobchangefeed** при вызове API ListContainers, и контейнер не отображается в портал Azure или обозреватель службы хранилища
- В учетных записях хранения, которые ранее инициировали [отработку отказа учетной записи](../common/storage-disaster-recovery-guidance.md) , могут возникнуть проблемы с файлом журнала. Все последующие отработки отказа учетной записи также могут повлиять на файл журнала во время предварительной версии.

## <a name="faq"></a>Вопросы и ответы

### <a name="what-is-the-difference-between-change-feed-and-storage-analytics-logging"></a>В чем разница между веб-каналом изменений и ведением журнала Аналитика Службы хранилища?
Журналы аналитики содержат записи всех операций чтения, записи, списка и удаления с успешными и неудачными запросами во всех операциях. Журналы аналитики лучше подходят, и их порядок не гарантируется.

Веб-канал изменений — это решение, которое обеспечивает транзакционный журнал успешных изменений или изменения вашей учетной записи, таких как создание, изменение и удаление больших двоичных объектов. Веб-канал изменений гарантирует, что все события должны записываться и отображаться в порядке успешных изменений на большой двоичный объект, поэтому нет необходимости отфильтровать шум из огромного объема операций чтения или неудачных запросов. Веб-канал изменений фундаментально спроектирован и оптимизирован для разработки приложений, требующих определенных гарантий.

### <a name="should-i-use-change-feed-or-storage-events"></a>Следует ли использовать веб-канал изменений или события хранилища?
Обе эти функции можно использовать как веб-канал изменений, а [события хранилища BLOB-объектов](storage-blob-event-overview.md) предоставляют те же сведения, что и те же гарантии надежности доставки, но основное различие заключается в задержке, упорядочении и хранении записей событий. Веб-канал изменений публикует записи в журнале в течение нескольких минут после изменения, а также гарантирует порядок операций изменения на большой двоичный объект. События хранилища отправляются в режиме реального времени и могут быть не упорядочены. События веб-канала изменений хранятся в учетной записи хранения как стабильные журналы только для чтения с собственным заданным сроком хранения, а события хранилища являются временными для использования обработчиком событий, если они не сохранены явным образом. С помощью веб-канала изменений любое количество приложений может использовать журналы на своих собственных средствах, используя API больших двоичных объектов или пакеты SDK. 

## <a name="next-steps"></a>Дальнейшие действия

- См. Пример чтения веб-канала изменений с помощью клиентского приложения .NET. См. статью [Обработка журналов веб-канала изменений в хранилище BLOB-объектов Azure](storage-blob-change-feed-how-to.md).
- Узнайте, как реагировать на события в режиме реального времени. См. раздел [реагирование на события хранилища BLOB-объектов](storage-blob-event-overview.md) .
- Узнайте больше о подробных сведениях о ведении журнала для успешных и неудачных операций для всех запросов. См. раздел [ведение журнала аналитики хранилища Azure](../common/storage-analytics-logging.md) .
