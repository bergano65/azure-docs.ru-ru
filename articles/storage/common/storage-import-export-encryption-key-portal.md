---
title: Использование портала Azure для настройки управляемых клиентом ключей службы импорта и экспорта
description: Сведения об использовании портала Azure для настройки управляемых клиентом ключей с помощью Azure Key Vault для службы импорта и экспорта Azure. Управляемые клиентом ключи позволяют создавать, менять, отключать и отзывать элементы управления доступом.
services: storage
author: alkohli
ms.service: storage
ms.topic: how-to
ms.date: 05/06/2020
ms.author: alkohli
ms.subservice: common
ms.openlocfilehash: fb91a490083629101470565a630b659c090e071b
ms.sourcegitcommit: 0a9df8ec14ab332d939b49f7b72dea217c8b3e1e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2020
ms.locfileid: "94843372"
---
# <a name="use-customer-managed-keys-in-azure-key-vault-for-importexport-service"></a>Использование управляемых клиентом ключей в Azure Key Vault для службы импорта и экспорта

Служба импорта и экспорта Azure защищает ключи BitLocker, используемые для блокировки дисков с помощью ключа шифрования. По умолчанию ключи BitLocker шифруются с помощью ключей, управляемых корпорацией Майкрософт. Для дополнительного контроля над ключами шифрования можно также предоставить управляемые клиентом ключи.

Управляемые клиентом ключи должны быть созданы и сохранены в Azure Key Vault. Дополнительные сведения о хранилище ключей Azure см. в статье [Что такое хранилище ключей Azure?](../../key-vault/general/overview.md)

В этой статье показано, как использовать управляемые клиентом ключи для службы импорта и экспорта на [портале Azure](https://portal.azure.com/).

## <a name="prerequisites"></a>Предварительные требования

Перед тем как начать, убедитесь в следующем:

1. Вы создали задание импорта или экспорта согласно следующим инструкциям:

    - [Создание задания импорта для больших двоичных объектов](storage-import-export-data-to-blobs.md).
    - [Создание задания импорта для файлов](storage-import-export-data-to-files.md).
    - [Создание задания экспорта для больших двоичных объектов](storage-import-export-data-from-blobs.md).

2. У вас уже есть Azure Key Vault с ключом, который можно использовать для защиты ключа BitLocker. Сведения о создании хранилища ключей с помощью портал Azure см. в разделе [Краткое руководство. создание Azure Key Vault с помощью портал Azure](../../key-vault/general/quick-create-portal.md).

    - Функции **обратимого удаления** и **Do not purge** (Не очищать) установлены для существующего решения Key Vault. По умолчанию эти свойства отключены. Чтобы включить эти свойства, см. разделы **Включение обратимого удаления** и **Включение защиты от очистки** в одной из следующих статей:

        - [Как использовать обратимое удаление в Key Vault с помощью PowerShell](../../key-vault/general/key-vault-recovery.md).
        - [Как использовать обратимое удаление в Key Vault с помощью интерфейса командной строки](../../key-vault/general/key-vault-recovery.md).
    - Существующее хранилище Key Vault должно иметь ключ RSA размером 2048 бит или более. Дополнительные сведения о ключах см. в разделе [о ключах](../../key-vault/keys/about-keys.md).
    - Key Vault должно находиться в том же регионе, что и учетная запись хранения ваших данных.  
    - Вы можете создать встроенное решение Azure Key Vault, если его у вас нет, как описано в следующем разделе.

## <a name="enable-keys"></a>Включение ключей

Настройка управляемого клиентом ключа для службы импорта и экспорта является необязательной. По умолчанию служба импорта и экспорта использует ключ под управлением корпорации Майкрософт для защиты ключа BitLocker. Чтобы включить управляемый клиентом ключ на портале Azure, выполните следующие действия.

1. Перейдите к колонке **Обзор** для задания импорта.
2. В правой области выберите **Choose how your BitLocker keys are encrypted** (Выберите способ шифрования ключей BitLocker).

    ![Выбор параметра шифрования](./media/storage-import-export-encryption-key-portal/encryption-key-1.png)

3. В колонке **Шифрование** можно просмотреть и скопировать ключ BitLocker устройства. В разделе **Тип шифрования** можно выбрать способ защиты ключа BitLocker. По умолчанию используется ключ под управлением корпорации Майкрософт.

    ![Просмотр ключа BitLocker](./media/storage-import-export-encryption-key-portal/encryption-key-2.png)

4. Вы можете указать управляемый клиентом ключ. Выбрав управляемый клиентом ключ, щелкните **Выберите хранилище ключей и ключ**.

    ![Выбор управляемого клиентом ключа](./media/storage-import-export-encryption-key-portal/encryption-key-3.png)

5. В колонке **Select key from Azure Key Vault** (Выбор ключа из Azure Key Vault) подписка заполняется автоматически. Для поля **Хранилище ключей** можно выбрать существующее хранилище Key Vault из раскрывающегося списка.

    ![Выбор или создание Azure Key Vault](./media/storage-import-export-encryption-key-portal/encryption-key-4.png)

6. Чтобы создать Key Vault, можно также выбрать **Создать**. В колонке **Создать Key Vault** введите группу ресурсов и имя Key Vault. Примите все остальные значения по умолчанию. Выберите **Review + Create** (Просмотреть и создать).

    ![Создание Azure Key Vault](./media/storage-import-export-encryption-key-portal/encryption-key-5.png)

7. Проверьте сведения, связанные с Key Vault, и выберите **Создать**. Подождите несколько минут, пока не завершится создание Key Vault.

    ![Создание хранилища Azure Key Vault](./media/storage-import-export-encryption-key-portal/encryption-key-6.png)

8. В колонке **Select key from Azure Key Vault** (Выбор ключа из Azure Key Vault) можно выбрать ключ в существующем Key Vault.

9. После создания Key Vault выберите **Создать**, чтобы создать ключ. Размер ключа RSA может быть 2048 бит или больше.

    ![Создание ключа в Azure Key Vault](./media/storage-import-export-encryption-key-portal/encryption-key-7.png)

    Если при создании Key Vault отключена защита от обратимого удаления и очистки, Key Vault будет обновлено для включения этих функций.

10. Укажите имя ключа, примите остальные значения по умолчанию и нажмите кнопку **Создать**.

    ![Создание ключа](./media/storage-import-export-encryption-key-portal/encryption-key-8.png)

11. Выберите **версию** и нажмите кнопку **Выбрать**. Вы получите уведомление о том, что в Key Vault создан ключ.

    ![Ключ, созданный в Key Vault](./media/storage-import-export-encryption-key-portal/encryption-key-9.png)

В колонке **Шифрование** можно просмотреть Key Vault и ключ, выбранный для управляемого клиентом ключа.

> [!IMPORTANT]
> Вы можете отключить только ключи под управлением корпорации Майкрософт и перейти на управляемые клиентом ключи на любом этапе задания импорта и экспорта. Однако нельзя отключить управляемый клиентом ключ после его создания.

## <a name="troubleshoot-customer-managed-key-errors"></a>Устранение ошибок ключей, управляемых клиентом

Если вы получаете ошибки, связанные с управляемым клиентом ключом, воспользуйтесь следующей таблицей для устранения неполадок:

| Код ошибки     |Сведения     | Восстановимая    |
|----------------|------------|-----------------|
| CmkErrorAccessRevoked | Доступ к управляемому клиентом ключу отозван.                                                       | Да, убедитесь, что: <ol><li>В Key Vault по-прежнему есть MSI в политике доступа.</li><li>Политика доступа включает разрешения на получение, упаковку и распаковку.</li><li>Если Key Vault находится в виртуальной сети за брандмауэром, проверьте, включен ли параметр **Разрешить доверенные службы Майкрософт**.</li><li>Проверьте, установлено ли для MSI ресурса задания значение `None` с помощью интерфейсов API.<br>Если да, то снова установите значение `Identity = SystemAssigned`. Это повторно создаст удостоверение для ресурса задания.<br>После создания удостоверения включите для него разрешения `Get`, `Wrap` и `Unwrap` в политике доступа Key Vault.</li></ol>                                                                                            |
| CmkErrorKeyDisabled      | Управляемый клиентом ключ отключен.                                         | Да, включив версию ключа.     |
| CmkErrorKeyNotFound      | Не удается найти управляемый клиентом ключ. | Да, если ключ был удален, но все еще находится в пределах периода очистки, отмените [удаление ключа Key vault](/powershell/module/az.keyvault/undo-azkeyvaultkeyremoval).<br>Или: <ol><li>Да, если пользователь имеет резервную копию ключа и восстанавливает его.</li><li>Нет, в противном случае.</li></ol>
| CmkErrorVaultNotFound |Не удается найти Key Vault для управляемого клиентом ключа. |   Если Key Vault удалено:<ol><li>Да, если срок действия защиты от очистки не истек, выполните шаги, описанные в разделе [Восстановление хранилища ключей](../../key-vault/general/soft-delete-overview.md#key-vault-recovery).</li><li>Нет, если истек срок действия защиты от очистки.</li></ol><br>В противном случае, если Key Vault было перенесено на другой клиент, его можно восстановить, выполнив одно из следующих действий:<ol><li>Верните Key Vault обратно на старый клиент.</li><li>Установите значение `Identity = None`, а затем верните обратно значение `Identity = SystemAssigned`. Это приведет к удалению и повторному созданию удостоверения сразу же после создания удостоверения. Включите для нового удостоверения разрешения `Get`, `Wrap` и `Unwrap` в политике доступа Key Vault.</li></ol>|

## <a name="next-steps"></a>Дальнейшие действия

- [Об Azure Key Vault](../../key-vault/general/overview.md)