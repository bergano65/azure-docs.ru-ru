---
title: Изменение порядка репликации учетной записи хранения
titleSuffix: Azure Storage
description: Узнайте, как изменить репликацию данных в существующей учетной записи хранения.
services: storage
author: tamram
ms.service: storage
ms.topic: how-to
ms.date: 09/24/2020
ms.author: tamram
ms.reviewer: artek
ms.subservice: common
ms.custom: devx-track-azurecli, devx-track-azurepowershell
ms.openlocfilehash: 5f570f13fd39bd25b37c35a2c823e64eaa02fef5
ms.sourcegitcommit: 32c521a2ef396d121e71ba682e098092ac673b30
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2020
ms.locfileid: "91295402"
---
# <a name="change-how-a-storage-account-is-replicated"></a>Изменение порядка репликации учетной записи хранения

В службе хранилища Azure всегда хранится несколько копий данных для защиты от запланированных и незапланированных событий, включая временные сбои оборудования, сети или энергоснабжения, масштабные стихийные бедствия и т. д. Избыточность гарантирует соответствие учетной записи хранения [Соглашению об уровне обслуживания (SLA) для службы хранилища Azure](https://azure.microsoft.com/support/legal/sla/storage/) даже при сбоях.

Служба хранилища Azure предоставляет следующие типы репликации:

- локально избыточное хранилище (LRS);
- хранилище, избыточное между зонами (ZRS);
- Геоизбыточное хранилище (GRS) или геоизбыточное хранилище с доступом для чтения (RA-GRS)
- Хранилище, избыточное в геопоясе (ГЗРС) или геоизбыточное хранилище с доступом на чтение (RA-ГЗРС)

Общие сведения о каждом из этих вариантов см. в статье [избыточность службы хранилища Azure](storage-redundancy.md).

## <a name="switch-between-types-of-replication"></a>Переключение между типами репликации

Учетную запись хранения можно переключить с одного типа репликации на другой, но некоторые сценарии более просты, чем другие. Если вы хотите добавить или удалить георепликацию или доступ на чтение к дополнительному региону, можно использовать портал Azure, PowerShell или Azure CLI, чтобы обновить параметр репликации. Однако если вы хотите изменить способ репликации данных в основном регионе, переместив из LRS в ZRS или наоборот, необходимо выполнить миграцию вручную.

В следующей таблице приведены общие сведения о переключении с каждого типа репликации на другой.

| Коммутатор | ... LRS | ... GRS/RA-GRS | ... ZRS | ... ГЗРС/RA-ГЗРС |
|--------------------|----------------------------------------------------|---------------------------------------------------------------------|----------------------------------------------------|---------------------------------------------------------------------|
| <b>... из LRS</b> | Н/Д | Изменение параметра репликации<sup>1</sup> с помощью портал Azure, PowerShell или интерфейса командной строки | Выполнение миграции вручную <br /><br /> ИЛИ <br /><br /> Запрос динамической миграции | Выполнение миграции вручную <br /><br /> ИЛИ <br /><br /> Сначала перейдите в GRS/RA-GRS, а затем запросите динамическую миграцию<sup>1</sup> . |
| <b>... из GRS/RA-GRS</b> | Изменение параметра репликации с помощью портал Azure, PowerShell или интерфейса командной строки | Н/Д | Выполнение миграции вручную <br /><br /> ИЛИ <br /><br /> Сначала переключитесь на LRS, а затем запросите динамическую миграцию. | Выполнение миграции вручную <br /><br /> ИЛИ <br /><br /> Запрос динамической миграции |
| <b>... из ZRS</b> | Выполнение миграции вручную | Выполнение миграции вручную | Н/Д | Используйте портал Azure, PowerShell или CLI, чтобы изменить параметр репликации<sup>1, 2</sup> |
| <b>... из ГЗРС/RA-ГЗРС</b> | Выполнение миграции вручную | Выполнение миграции вручную | Изменение параметра репликации с помощью портал Azure, PowerShell или интерфейса командной строки | Н/Д |

<sup>1</sup> — одноразовая оплата.<br />
<sup>2</sup> преобразование из ZRS в ГЗРС/RA-гзрс или наоборот не поддерживается в следующих регионах: Восточная часть США 2, Восточная часть США, Западная Европа.

> [!CAUTION]
> Если вы выполнили [отработку отказа учетной](storage-disaster-recovery-guidance.md) записи (RA-) GRS или (RA-) гзрс, учетная запись будет локально избыточна в новом основном регионе после отработки отказа. Динамическая миграция в ZRS или ГЗРС для учетной записи LRS, полученной при отработке отказа, не поддерживается. Это справедливо даже в случае так называемых операций восстановления размещения. Например, если выполнить отработку отказа учетной записи из RA-ГЗРС в LRS в дополнительном регионе, а затем снова настроить службу RA-GRS и выполнить отработку отказа другой учетной записи в исходный основной регион, вы не сможете обратиться в службу поддержки для первоначальной динамической миграции в RA-ГЗРС в основном регионе. Вместо этого необходимо выполнить миграцию вручную в ZRS или ГЗРС.

## <a name="change-the-replication-setting"></a>Изменение параметра репликации

Вы можете использовать портал Azure, PowerShell или Azure CLI, чтобы изменить параметр репликации для учетной записи хранения, если вы не изменяете способ репликации данных в основном регионе. Если выполняется миграция из LRS в основном регионе в ZRS в основном регионе или наоборот, необходимо выполнить миграцию вручную или динамическую миграцию.

Изменение того, как выполняется репликация учетной записи хранения, не приводит к понижению времени работы приложений.

# <a name="portal"></a>[Портал](#tab/portal)

Чтобы изменить параметр избыточности для учетной записи хранения в портал Azure, выполните следующие действия.

1. Войдите в свою учетную запись хранения на портале Azure.
1. Выберите параметр **конфигурации** .
1. Обновите параметр **репликации** .

![Снимок экрана, показывающий, как изменить параметр репликации на портале](media/redundancy-migration/change-replication-option.png)

# <a name="powershell"></a>[PowerShell](#tab/powershell)

Чтобы изменить параметр избыточности для учетной записи хранения с помощью PowerShell, вызовите команду [Set-азсторажеаккаунт](/powershell/module/az.storage/set-azstorageaccount) и укажите `-SkuName` параметр:

```powershell
Set-AzStorageAccount -ResourceGroupName <resource_group> `
    -AccountName <storage_account> `
    -SkuName <sku>
```

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

Чтобы изменить параметр избыточности для учетной записи хранения с Azure CLI, вызовите команду [AZ Storage Account Update](/cli/azure/storage/account#az-storage-account-update) и укажите `--sku` параметр:

```azurecli-interactive
az storage account update \
    --name <storage-account>
    --resource-group <resource_group> \
    --sku <sku>
```

---

## <a name="perform-a-manual-migration-to-zrs-gzrs-or-ra-gzrs"></a>Выполнение миграции вручную в ZRS, ГЗРС или RA-ГЗРС

Если вы хотите изменить способ репликации данных в учетной записи хранения в основном регионе, переходите от LRS к ZRS или наоборот, вы можете выполнить миграцию вручную. Она обеспечивает большую гибкость, чем динамическая. Вы управляете временем миграции вручную, поэтому используйте этот параметр, если требуется, чтобы миграция была выполнена в определенный день.

При выполнении миграции вручную с LRS на ZRS в основном регионе или наоборот, Целевая учетная запись хранения может быть геоизбыточной и также может быть настроена для доступа на чтение к дополнительному региону. Например, можно перенести учетную запись LRS в учетную запись ГЗРС или RA-ГЗРС за один шаг.

Миграция вручную может вызвать простой приложения. Если приложению требуется высокий уровень доступности, корпорация Майкрософт также предоставляет возможность динамической миграции. Динамическая миграция — это миграция "на месте" без простоев.

При миграции вручную данные из существующей учетной записи хранения копируются в новую учетную запись хранения, которая использует ZRS в основном регионе. Чтобы выполнить миграцию вручную, можно использовать один из следующих вариантов.

- Копирование данных с помощью существующего средства, например AzCopy, одной из клиентских библиотек службы хранилища Azure или надежного стороннего средства.
- Если вы знакомы с Hadoop или HDInsight, вы можете присоединить учетную запись хранения исходной и целевой учетных записей хранения к кластеру. Затем выполните процесс копирования данных параллельно, используя такой инструмент, как DistCp.

## <a name="request-a-live-migration-to-zrs-gzrs-or-ra-gzrs"></a>Запрос динамической миграции в ZRS, ГЗРС или RA-ГЗРС

Если вам нужно перенести учетную запись хранения из LRS в ZRS в основном регионе без простоя приложений, можно запросить динамическую миграцию от Майкрософт. Чтобы выполнить миграцию с LRS на ГЗРС или RA-ГЗРС, сначала переключитесь на GRS или RA-GRS, а затем запросите динамическую миграцию. Аналогичным образом можно запросить динамическую миграцию из GRS или RA-GRS в ГЗРС или RA-ГЗРС. Чтобы выполнить миграцию из GRS или RA-GRS в ZRS, сначала переключитесь на LRS, а затем запросите динамическую миграцию.

Во время динамической миграции можно получить доступ к данным в учетной записи хранения без потери надежности или доступности. Соглашение об уровне обслуживания для службы хранилища Azure сохраняется в процессе миграции. Нет потерь данных, связанных с динамической миграцией. После миграции конечные точки служб, ключи доступа, подписи общего доступа и другие параметры учетной записи остаются без изменений.

ZRS поддерживает только учетные записи общего назначения версии 2, поэтому перед отправкой запроса на динамическую миграцию в ZRS обязательно обновите учетную запись хранения. Дополнительные сведения см. в статье [Обновление до учетной записи хранения общего назначения версии 2](storage-account-upgrade.md). Учетная запись хранения должна содержать данные, которые должны быть перенесены с помощью динамической миграции.

Динамическая миграция поддерживается только для учетных записей хранения, использующих репликацию LRS или GRS. Если учетная запись использует RA-GRS, прежде чем продолжить, необходимо изменить тип репликации учетной записи на LRS или GRS. Этот промежуточный шаг удаляет вторичную конечную точку только для чтения, предоставляемую RA-GRS перед миграцией.

Хотя корпорация Майкрософт незамедлительно отреагирует на запрос динамической миграции, нет никакой гарантии относительно времени ее завершения. Если вам нужны данные, перенесенные в ZRS, на определенную дату, корпорация Майкрософт вместо этого рекомендует выполнить миграцию вручную. Как правило, чем больше данных в вашей учетной записи, тем дольше будет выполняться их перенос.

Миграцию необходимо выполнить вручную, если:

- Вы хотите перенести данные в учетную запись хранения ZRS, которая находится в регионе, отличном от того, в котором находится исходная учетная запись.
- Ваша учетная запись хранения является страничным BLOB-объектом уровня Premium или учетной записью блочного BLOB.
- Вы хотите перенести данные из ZRS в LRS, GRS или RA-GRS.
- Ваша учетная запись хранения содержит данные на уровне архива.

Вы можете запросить динамическую миграцию через [портал поддержки Azure](https://ms.portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview). Выберите на портале учетную запись хранения, которую вы хотите преобразовать в ZRS.

1. Выберите **новый запрос в службу поддержки**
2. Заполните раздел **Основные сведения**, основываясь на информации об учетной записи. В разделе **Служба** выберите **Storage Account Management** (Управление учетными записями хранения) и ресурс, который необходимо преобразовать в ZRS.
3. Выберите **Далее**.
4. Укажите следующие значения в разделе **Проблема**:
    - **Серьезность**. Оставьте значение по умолчанию.
    - **Тип проблемы**. Выберите **Миграция данных**.
    - **Категория**: выберите **Миграция в ZRS**.
    - **Заголовок**. Введите описательный заголовок, например **Миграция учетной записи ZRS**.
    - **Сведения**: введите дополнительные сведения в поле **сведения** , например, я хочу перейти на ZRS из [LRS, GRS] в \_ \_ регионе.
5. Выберите **Далее**.
6. Проверьте правильность контактных данных в колонке **Контактные данные**.
7. Выберите **Создать**.

Специалист службы поддержки свяжется с вами и предоставит любую необходимую помощь.

> [!NOTE]
> Динамическая миграция в настоящее время не поддерживается для файловых ресурсов уровня "Премиум". Сейчас поддерживается только копирование и перемещение данных вручную.
>
> Учетные записи хранения ГЗРС в настоящее время не поддерживают уровень архива. Дополнительные сведения см. в статье [хранилище BLOB-объектов Azure: горячий, стильный и архивный уровни доступа](https://docs.microsoft.com/azure/storage/blobs/storage-blob-storage-tiers) .
>
> Управляемые диски доступны только для LRS и не могут быть перенесены в ZRS. Вы можете хранить моментальные снимки и образы для стандартных управляемых дисков SSD на стандартном жестком диске и [выбирать между LRS и ZRS](https://azure.microsoft.com/pricing/details/managed-disks/). Сведения об интеграции с группами доступности см. [в статье Введение в управляемые диски Azure](https://docs.microsoft.com/azure/virtual-machines/windows/managed-disks-overview#integration-with-availability-sets).

## <a name="switch-from-zrs-classic"></a>Переключение из классической модели ZRS

> [!IMPORTANT]
> Корпорация Майкрософт объявит нерекомендуемыми и перенесет классические учетные записи ZRS 31 марта 2021. Перед прекращением поддержки клиентам классического хранилища ZRS будут предоставлены дополнительные сведения.
>
> После того как ZRS станет общедоступным в данном регионе, клиенты больше не смогут создавать Классические учетные записи ZRS на основе портал Azure в этом регионе. Использование Microsoft PowerShell и Azure CLI для создания классических учетных записей ZRS является возможным, пока классическое хранилище ZRS не будет объявлено нерекомендуемым. Сведения о том, где доступна ZRS, см. в статье [избыточность службы хранилища Azure](storage-redundancy.md).

В классическом хранилище ZRS данные асинхронно реплицируются в центрах обработки данных в пределах одного или двух регионов. Реплицируемые данные недоступны, если корпорация Майкрософт не инициирует отработку отказа в дополнительном регионе. Классическую учетную запись ZRS невозможно преобразовать в учетную запись хранилища LRS, GRS или RA-GRS и наоборот. Кроме того, она не поддерживает использование метрик или ведение журналов.

Классическое хранилище ZRS доступно только для **блочных BLOB-объектов** в учетных записях хранения общего назначения версии 1 (GPv1). Дополнительные сведения об учетных записях хранения см. в статье [Общие сведения об учетной записи хранения](storage-account-overview.md).

Чтобы вручную перенести данные учетной записи ZRS в учетную запись LRS, GRS, RA-GRS или ZRS, используйте одно из следующих средств: AzCopy, Обозреватель службы хранилища Azure, PowerShell или Azure CLI. Можно также создавать собственные решения для миграции с использованием одной из клиентских библиотек службы хранилища Azure.

Вы также можете обновить классическую учетную запись хранения ZRS до ZRS с помощью портал Azure, PowerShell или Azure CLI в регионах, где доступна ZRS.

# <a name="portal"></a>[Портал](#tab/portal)

Чтобы выполнить обновление до ZRS в портал Azure, перейдите к параметрам **конфигурации** учетной записи и выберите **Обновить**.

![Обновление классической версии ZRS до ZRS на портале](media/redundancy-migration/portal-zrs-classic-upgrade.png)

# <a name="powershell"></a>[PowerShell](#tab/powershell)

Чтобы выполнить обновление до ZRS с помощью PowerShell, вызовите следующую команду:

```powershell
Set-AzStorageAccount -ResourceGroupName <resource_group> -AccountName <storage_account> -UpgradeToStorageV2
```

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

Чтобы выполнить обновление до ZRS с помощью Azure CLI, вызовите следующую команду:

```cli
az storage account update -g <resource_group> -n <storage_account> --set kind=StorageV2
```

---

## <a name="costs-associated-with-changing-how-data-is-replicated"></a>Затраты, связанные с изменением репликации данных

Затраты, связанные с изменением способа репликации данных, зависят от пути преобразования. При сортировке по крайней мере до наиболее дорогих предложений избыточности в службе хранилища Azure входят LRS, ZRS, GRS, RA-GRS, ГЗРС и RA-ГЗРС.

Например, при переходе *от* LRS к любому другому типу репликации будет взиматься дополнительная плата, так как вы переходите на более сложный уровень избыточности. При переходе *на* GRS или RA-GRS будет взиматься плата за пропускную способность, так как ваши данные (в основном регионе) реплицируются в удаленный дополнительный регион. Плата является одноразовой стоимостью при начальной настройке. После копирования данных не взимается дополнительная плата за миграцию. Сведения о стоимости пропускной способности см. на странице [цен на хранение блочных BLOB-объектов](https://azure.microsoft.com/pricing/details/storage/blobs/).

Если вы переносите учетную запись хранения из GRS в LRS, дополнительные затраты не взимается, но реплицированные данные удаляются из дополнительного расположения.

> [!IMPORTANT]
> Если вы переносите учетную запись хранения из RA-GRS в GRS или LRS, эта учетная запись оплачивается как RA-GRS за дополнительные 30 дней после преобразования.

## <a name="see-also"></a>См. также раздел

- [Репликация службы хранилища Azure](storage-redundancy.md)
- [Проверка свойства "Время последней синхронизации" для учетной записи хранения](last-sync-time-get.md)
- [Разработка высокодоступных приложений с геоизбыточностью](geo-redundant-design.md)
