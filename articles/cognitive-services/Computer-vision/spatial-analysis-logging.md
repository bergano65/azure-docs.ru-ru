---
title: Данные телеметрии и ведение журнала для контейнеров пространственного анализа
titleSuffix: Azure Cognitive Services
description: Пространственный анализ предоставляет каждый контейнер с общими аналитическими сведениями, ведением журнала и параметрами безопасности в платформе Configuration Framework.
services: cognitive-services
author: aahill
manager: nitinme
ms.service: cognitive-services
ms.subservice: computer-vision
ms.topic: conceptual
ms.date: 09/11/2020
ms.author: aahi
ms.openlocfilehash: f85a7e2acf911772ecc6562217918352e909fcbb
ms.sourcegitcommit: 32c521a2ef396d121e71ba682e098092ac673b30
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2020
ms.locfileid: "91254080"
---
# <a name="telemetry-and-troubleshooting"></a>Данные телеметрии и устранение неполадок

Пространственный анализ включает набор функций для мониторинга работоспособности системы и диагностики проблем.

## <a name="enable-visualizations"></a>Включение визуализаций

Чтобы включить визуализацию событий AI Insights в видеокадре, необходимо использовать `.debug` версию [операции пространственного анализа](spatial-analysis-operations.md). Доступны четыре операции отладки.

Измените [манифест развертывания](https://go.microsoft.com/fwlink/?linkid=2142179) , чтобы использовать правильное значение для `DISPLAY` переменной среды. Он должен соответствовать `$DISPLAY` переменной на главном компьютере. После обновления манифеста развертывания повторно разверните контейнер.

После завершения развертывания может потребоваться скопировать `.Xauthority` файл с главного компьютера в контейнер и перезапустить его. В приведенном ниже примере `peopleanalytics` — это имя контейнера на главном компьютере.

```bash
sudo docker cp $XAUTHORITY peopleanalytics:/root/.Xauthority
sudo docker stop peopleanalytics
sudo docker start peopleanalytics
xhost +
```


## <a name="collect-system-health-telemetry"></a>Сбор данных телеметрии работоспособности системы

Telegraf — это образ с открытым исходным кодом, который работает с пространственным анализом и доступен в реестре контейнеров Microsoft. Он принимает следующие входные данные и отправляет их в Azure Monitor. Модуль Telegraf может быть создан с помощью настраиваемых входных и выходных данных. Конфигурация модуля Telegraf в пространственном анализе является частью [манифеста развертывания](https://go.microsoft.com/fwlink/?linkid=2142179). Этот модуль является необязательным и может быть удален из манифеста, если он вам не нужен. 

Входные данные: 
1. Метрики пространственного анализа
2. Метрики диска
3. Метрики ЦП
4. Метрики DOCKER
5. Метрики GPU

Выходные данные:
1. Azure Monitor

Предоставленный модуль пространственного анализа Telegraf будет публиковать все данные телеметрии, порожденные контейнером пространственного анализа, в Azure Monitor. Сведения о добавлении Azure Monitor в подписку см. в [Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/overview) .

После настройки Azure Monitor необходимо создать учетные данные, позволяющие модулю отсылать телеметрию. Можно использовать портал Azure для создания нового субъекта-службы или использовать команду Azure CLI ниже, чтобы создать ее.

> [!NOTE] 
> Для этой команды необходимо иметь права владельца на подписку. 

```bash
# Find your Azure IoT Hub resource ID by running this command. The resource ID  should start with something like 
# "/subscriptions/b60d6458-1234-4be4-9885-c7e73af9ced8/resourceGroups/...”
az iot hub list

# Create a Service Principal with `Monitoring Metrics Publisher` role in the IoTHub resource:
# Save the output from this command. The values will be used in the deployment manifest. The password won't be shown again so make sure to write it down
az ad sp create-for-rbac --role="Monitoring Metrics Publisher" --name "<principal name>" --scopes="<resource ID of IoT Hub>"
```

В [манифесте развертывания](https://go.microsoft.com/fwlink/?linkid=2142179)найдите модуль *Telegraf* и замените следующие значения на сведения о субъекте-службе из предыдущего шага и выполните повторное развертывание.

```json

"telegraf": { 
  "settings": {
  "image":   "mcr.microsoft.com/azure-cognitive-services/vision/spatial-analysis/telegraf:1.0",
  "createOptions":   "{\"HostConfig\":{\"Runtime\":\"nvidia\",\"NetworkMode\":\"azure-iot-edge\",\"Memory\":33554432,\"Binds\":[\"/var/run/docker.sock:/var/run/docker.sock\"]}}"
},
"type": "docker",
"env": {
    "AZURE_TENANT_ID": {
        "value": "<Tenant Id>"
    },
    "AZURE_CLIENT_ID": {
        "value": "Application Id"
    },
    "AZURE_CLIENT_SECRET": {
        "value": "<Password>"
    },
    "region": {
        "value": "<Region>"
    },
    "resource_id": {
        "value": "/subscriptions/{subscriptionId}/resourceGroups/{resoureGroupName}/providers/Microsoft.Devices/IotHubs/{IotHub}"
    },
...
```

После развертывания модуля Telegraf можно получить доступ к полученным метрикам либо через службу Azure Monitor, **либо выбрав в** центре Интернета вещей на портал Azure.

:::image type="content" source="./media/spatial-analysis/iot-hub-telemetry.png" alt-text="Отчет о телеметрии Azure Monitor":::

### <a name="system-health-events"></a>События работоспособности системы

| Имя события | Описание|
|------|---------|
|archon_exit    |Посылается, когда пользователь изменяет состояние модуля пространственного анализа с " *работает* " на " *остановлено*".  |
|archon_error   |Отправляется при сбое любого из процессов в контейнере. Это критическая ошибка.  |
|инпутрате  |Скорость, с которой граф обрабатывает входные данные видео. Выводится каждые 5 минут. | 
|аутпутрате     |Скорость вывода данных AI Insights в графе. Выводится каждые 5 минут. |
|archon_allGraphsStarted | Посылается после завершения запуска всех графов. |
|archon_configchange    | Отправляется при изменении конфигурации графа. |
|archon_graphCreationFailed     |Посылается, когда не удается запустить граф с отчетом `graphId` . |
|archon_graphCreationSuccess    |Посылается, когда граф с отчетом `graphId` начинается успешно. |
|archon_graphCleanup    | Посылается, когда граф с отчетом `graphId` очистки и завершает работу. |
|archon_graphHeartbeat  |Периодические сигналы, отправляемые каждую минуту для каждого графа навыка. |
|archon_apiKeyAuthFail |Посылается, когда ключ ресурса Компьютерное зрение не проходит проверку подлинности контейнера более 24 часов по следующим причинам: недостаточно квоты, недопустима, находится в автономном режиме. |
|видеоинжестерхеартбеат     |Посылается каждый час, чтобы указать, что видео потоковая передача из источника видео с количеством ошибок за этот час. Отчет для каждого графа. |
|видеоинжестерстате | Отчеты *остановлены* или *запущены* для потоковой передачи видео.Отчет для каждого графа. |

##  <a name="troubleshooting-an-iot-edge-device"></a>Устранение неполадок устройства IoT Edge

`iotedge`Для проверки состояния и журналов выполняющихся модулей можно использовать программу командной строки. Пример:
* `iotedge list`: Сообщает список выполняющихся модулей. 
  Дополнительные сведения об ошибках можно проверить с помощью `iotedge logs edgeAgent` . Если `iotedge` он зависает, можно попробовать перезапустить его с помощью `iotedge restart edgeAgent`
* `iotedge logs <module-name>`
* `iotedge restart <module-name>` перезапуск определенного модуля 

## <a name="collect-log-files-with-the-diagnostics-container"></a>Получение файлов журналов с помощью контейнера диагностики

Пространственный анализ создает журналы отладки DOCKER, которые можно использовать для диагностики проблем во время выполнения или включения в билеты поддержки. Модуль диагностики пространственного анализа доступен в реестре контейнеров Майкрософт для загрузки. В [примере манифеста развертывания](https://go.microsoft.com/fwlink/?linkid=2142179)найдите модуль *Диагностика* .

В разделе "env" добавьте следующую конфигурацию:

```json
"diagnostics": {  
  "settings": {
  "image":   "mcr.microsoft.com/azure-cognitive-services/vision/spatial-analysis/diagnostics:1.0",
  "createOptions":   "{\"HostConfig\":{\"Mounts\":[{\"Target\":\"/usr/bin/docker\",\"Source\":\"/home/data/docker\",\"Type\":\"bind\"},{\"Target\":\"/var/run\",\"Source\":\"/run\",\"Type\":\"bind\"}],\"LogConfig\":{\"Config\":{\"max-size\":\"500m\"}}}}"
  }
```    

>[!NOTE]
> Если вы не работаете в среде ASE Kubernetes, замените параметры создания контейнера для модуля ведения журнала следующим образом:
>
>`"createOptions": "{\"HostConfig\": {\"Binds\": [\"/var/run/docker.sock:/var/run/docker.sock\",\"/usr/bin/docker:/usr/bin/docker\"],\"LogConfig\": {\"Config\": {\"max-size\": \"500m\"}}}}"`

Для оптимизации журналов, передаваемых в удаленную конечную точку, например в хранилище BLOB-объектов Azure, рекомендуется хранить небольшой размер файла. Сведения о рекомендуемой конфигурации журналов DOCKER см. в приведенном ниже примере.

```json
{
    "HostConfig": {
        "LogConfig": {
            "Config": {
                "max-size": "500m",
                "max-file": "1000"
            }
        }
    }
}
```

### <a name="configure-the-log-level"></a>Настройка уровня ведения журнала

Конфигурация уровня ведения журнала позволяет управлять уровнем детализации создаваемых журналов. Поддерживаемые уровни ведения журнала: `none` , `verbose` , `info` , `warning` и `error` . Уровень детализации журнала по умолчанию для обоих узлов и для платформы — `info` . 

Уровни журнала можно изменять глобально, присвоив `ARCHON_LOG_LEVEL` переменной среды одно из допустимых значений.
Его также можно задать в документе IoT Edge модуля двойника глобально, для всех развернутых навыков или для каждого конкретного навыка, задав значения для `platformLogLevel` и, `nodeLogLevel` как показано ниже.

```json
{
    "version": 1,
    "properties": {
        "desired": {
            "globalSettings": {
                "platformLogLevel": "verbose"
            },
            "graphs": {
                "samplegraph": {
                    "nodeLogLevel": "verbose",
                    "platformLogLevel": "verbose"
                }
            }
        }
    }
}
```

### <a name="collecting-logs"></a>сбор журналов

> [!NOTE]
> `diagnostics`Модуль не влияет на содержимое журнала, он помогает собирать, фильтровать и отправлять существующие журналы.
> Для использования этого модуля требуется API-интерфейс DOCKER версии 1,40 или более поздней.

[Пример файла манифеста развертывания](https://go.microsoft.com/fwlink/?linkid=2142179) включает модуль с именем `diagnostics` , который собирает и отправляет журналы. Этот модуль по умолчанию отключен, и его следует включить с помощью конфигурации модуля IoT Edge, если требуется доступ к журналам. 

`diagnostics`Коллекция выполняется по требованию и контролируется с помощью IOT Edge прямого метода и может отсылать журналы в хранилище BLOB-объектов Azure.

### <a name="configure-diagnostics-upload-targets"></a>Настройка целевых объектов для отправки диагностики

На портале IoT Edge выберите устройство, а затем модуль **диагностики** . В примере файла [*DeploymentManifest.jsв*](https://go.microsoft.com/fwlink/?linkid=2142179)найдите раздел **переменные среды** для диагностики с именем env и добавьте следующие сведения:

**Настройка отправки в хранилище BLOB-объектов Azure**

1. Создайте собственную учетную запись хранилища BLOB-объектов Azure, если вы еще этого не сделали.
2. Получите **строку подключения** для учетной записи хранения из портал Azure. Он будет находиться в **разделах ключи доступа**.
3. Журналы пространственных данных будут автоматически переданы в контейнер хранилища BLOB-объектов с именем *ртквлогс* в следующем формате имени файла: `{CONTAINER_NAME}/{START_TIME}-{END_TIME}-{QUERY_TIME}.log` .

```json
"env":{
    "IOTEDGE_WORKLOADURI":"fd://iotedge.socket",
    "AZURE_STORAGE_CONNECTION_STRING":"XXXXXX",   //from the Azure Blob Storage account
    "ARCHON_LOG_LEVEL":"info"
}
```

### <a name="uploading-spatial-analysis-logs"></a>Отправка журналов пространственных данных анализа

Журналы отправляются по запросу с помощью `getRTCVLogs` метода IOT EDGE в `diagnostics` модуле. 


1. Перейдите на страницу портала центра Интернета вещей, выберите **пограничные устройства**, затем выберите устройство и модуль диагностики. 
2. Перейдите на страницу сведений о модуле и перейдите на вкладку ***прямой метод*** .
3. Введите `getRTCVLogs` имя метода и строку формата JSON в полезных данных. Можно ввести `{}` , что является пустой полезной нагрузкой. 
4. Задайте соединение и время ожидания метода, а затем нажмите кнопку **вызвать метод**.
5. Выберите целевой контейнер и создайте строку JSON полезной нагрузки с помощью параметров, описанных в разделе о **синтаксисе ведения журнала** . Нажмите кнопку **вызвать метод** , чтобы выполнить запрос.

>[!NOTE]
> При вызове `getRTCVLogs` метода с пустыми полезными данными будет возвращен список всех контейнеров, развернутых на устройстве. Имя метода задается с учетом регистра. Если указано неправильное имя метода, будет выдана ошибка 501.

:::image type="content" source="./media/spatial-analysis/direct-log-collection.png" alt-text="Вызов метода Жетртквлогс ":::
![страница прямого метода Жетртквлогс](./media/spatial-analysis/direct-log-collection.png)

 
### <a name="logging-syntax"></a>Синтаксис ведения журнала

В таблице ниже перечислены параметры, которые можно использовать при выполнении запросов к журналам.

| Ключевое слово | Описание | Значение по умолчанию |
|--|--|--|
| StartTime | Время начала требуемого журнала (в миллисекундах). | `-1`, начало выполнения контейнера. Если `[-1.-1]` используется в качестве диапазона времени, API возвращает журналы за последний час.|
| EndTime | Время окончания требуемого журнала (в миллисекундах). | `-1`, текущее время. Если `[-1.-1]` используется диапазон времени, API возвращает журналы за последний час. |
| ContainerId | Целевой контейнер для выборки журналов.| `null`, если идентификатор контейнера отсутствует. API возвращает все доступные сведения о контейнерах с идентификаторами.|
| допост | Выполните операцию отправки. Если задано значение `false` , то она выполняет запрошенную операцию и возвращает размер отправки без выполнения отправки. Если задано значение `true` , будет инициирована асинхронная отправка выбранных журналов. | `false`, не отправлять.|
| Регулирование | Укажите, сколько строк журналов нужно отправить на пакет | `1000`, Используйте этот параметр, чтобы настроить скорость записи. |
| Фильтры | Фильтрует журналы для отправки | `null`, фильтры могут быть указаны в виде пар "ключ — значение" на основе структуры журналов пространственных анализов: `[UTC, LocalTime, LOGLEVEL,PID, CLASS, DATA]` . Например: `{"TimeFilter":[-1,1573255761112]}, {"TimeFilter":[-1,1573255761112]}, {"CLASS":["myNode"]`|

В следующей таблице перечислены атрибуты в ответе на запрос.

| Ключевое слово | Описание|
|--|--|
|допост| Либо *true* , либо *false*. Указывает, были ли отправлены журналы. Если вы решили не отправлять журналы, API возвращает сведения ***синхронно***. При выборе отправки журналов API возвращает значение 200, если запрос допустим, и начинает ***асинхронную***отправку журналов.|
|тимефилтер| Фильтр времени, примененный к журналам.|
|валуефилтерс| Фильтры ключевых слов применяются к журналам. |
|TimeStamp| Время начала выполнения метода. |
|ContainerId| Идентификатор целевого контейнера. |
|фетчкаунтер| Общее число строк журнала. |
|фетчсизеинбите| Общий объем данных журнала в байтах. |
|матчкаунтер| Допустимое число строк журнала. |
|матчсизеинбите| Допустимый объем данных журнала в байтах. |
|филтеркаунт| Общее число строк журнала после применения фильтра. |
|филтерсизеинбите| Общий объем данных журнала в байтах после применения фильтра. |
|фетчлогсдуратионинмилисек| Длительность операции выборки. |
|паселогсдуратионинмилисек| Длительность операции фильтрации. |
|постлогсдуратионинмилисек| Длительность операции POST. |

#### <a name="example-request"></a>Пример запроса 

```json
{
    "StartTime": -1,
    "EndTime": -1,
    "ContainerId": "5fa17e4d8056e8d16a5a998318716a77becc01b36fde25b3de9fde98a64bf29b",
    "DoPost": false,
    "Filters": null
}
```

#### <a name="example-response"></a>Пример ответа 

```json
{
    "status": 200,
    "payload": {
        "DoPost": false,
        "TimeFilter": [-1, 1581310339411],
        "ValueFilters": {},
        "Metas": {
            "TimeStamp": "2020-02-10T04:52:19.4365389+00:00",
            "ContainerId": "5fa17e4d8056e8d16a5a998318716a77becc01b36fde25b3de9fde98a64bf29b",
            "FetchCounter": 61,
            "FetchSizeInByte": 20470,
            "MatchCounter": 61,
            "MatchSizeInByte": 20470,
            "FilterCount": 61,
            "FilterSizeInByte": 20470,
            "FetchLogsDurationInMiliSec": 0,
            "PaseLogsDurationInMiliSec": 0,
            "PostLogsDurationInMiliSec": 0
        }
    }
}
```

Проверьте строки, время и размеры журнала выборки, если эти параметры выглядят нормально, замените ***допост*** на `true` , и это приведет к передаче журналов с одинаковыми фильтрами в назначения. 

Вы можете экспортировать журналы из хранилища BLOB-объектов Azure при устранении неполадок. 

## <a name="common-issues"></a>Распространенные проблемы

Если в журналах модуля отображается следующее сообщение, это может означать, что подписка Azure должна быть утверждена: 

"Контейнер находится в недопустимом состоянии. Сбой проверки подписки с состоянием "несоответствие". Ключ API не предназначен для данного типа контейнера. "

Дополнительные сведения см. в статье [запрос утверждения для запуска контейнера](spatial-analysis-container.md#request-approval-to-run-the-container).

## <a name="troubleshooting-the-azure-stack-edge-device"></a>Устранение неполадок устройства Azure Stack пограничных устройств

Следующий раздел предназначен для справки по отладке и проверке состояния устройства Azure Stack пограничной Организации.

### <a name="access-the-kubernetes-api-endpoint"></a>Доступ к конечной точке API Kubernetes. 

1. В локальном пользовательском интерфейсе устройства перейдите на страницу **устройства** . 
2. В разделе **конечные точки устройства**скопируйте конечную точку службы API Kubernetes. Эта конечная точка представляет собой строку в следующем формате: `https://compute..[device-IP-address]`.
3. Сохраните строку конечной точки. Он будет использоваться позже при настройке `kubectl` для доступа к кластеру Kubernetes.

### <a name="connect-to-powershell-interface"></a>Подключение к интерфейсу PowerShell

Удаленно, подключитесь из клиента Windows. После создания кластера Kubernetes вы можете управлять приложениями через этот кластер. Необходимо подключиться к интерфейсу PowerShell устройства. В зависимости от операционной системы клиента процедуры удаленного подключения к устройству могут отличаться. Для клиента Windows, на котором выполняется PowerShell, выполните следующие действия.

> [!TIP]
> * Прежде чем начать, убедитесь, что клиент Windows работает под управлением Windows PowerShell 5,0 или более поздней версии.
> * PowerShell также [доступен в Linux](https://docs.microsoft.com/powershell/scripting/install/installing-powershell-core-on-linux).

1. Запустите сеанс Windows PowerShell от имени администратора. 
    1. Убедитесь, что на вашем клиенте запущена служба служба удаленного управления Windows. В командной строке введите `winrm quickconfig`.

2. Назначьте переменную для IP-адреса устройства. Например, `$ip = "<device-ip-address>"`.

3. Используйте следующую команду, чтобы добавить IP-адрес устройства в список надежных узлов клиента. 

    ```powershell
    Set-Item WSMan:\localhost\Client\TrustedHosts $ip -Concatenate -Force
    ```
 
4. Запустите сеанс Windows PowerShell на устройстве. 

    ```powershell
    Enter-PSSession -ComputerName $ip -Credential $ip\EdgeUser -ConfigurationName Minishell
    ```

5. При появлении запроса введите пароль. Используйте тот же пароль, который используется для входа в локальный веб-интерфейс. По умолчанию пароль локального веб-интерфейса — `Password1` . 

### <a name="access-the-kubernetes-cluster"></a>Доступ к кластеру Kubernetes

После создания кластера Kubernetes можно использовать `kubectl` программу командной строки для доступа к кластеру.

1. Создайте новое пространство имен. 

    ```powershell
    New-HcsKubernetesNamespace -Namespace
    ```

2. Создайте пользователя и получите файл конфигурации. Эта команда выводит сведения о конфигурации для кластера Kubernetes. Скопируйте эти сведения и сохраните их в файл с именем *config*. Не сохраняйте файл расширение.
    
    ```powershell
    New-HcsKubernetesUser -UserName
    ```

3. Добавьте файл *конфигурации* в папку *. KUBE* в профиле пользователя на локальном компьютере.   

4. Свяжите пространство имен с созданным пользователем.

    ```powershell
    Grant-HcsKubernetesNamespaceAccess -Namespace -UserName
    ```

5. Установите `kubectl` на клиенте Windows, выполнив следующую команду:
    
    ```powershell
    curl https://storage.googleapis.com/kubernetesrelease/release/v1.15.2/bin/windows/amd64/kubectl.exe -O kubectl.exe
    ```

6. Добавьте запись DNS в файл hosts в системе. 
    1. Запустите Блокнот от имени администратора и откройте файл *hosts* , расположенный по адресу `C:\windows\system32\drivers\etc\hosts` . 
    2. Создайте запись в файле hosts с IP-адресом устройства и доменом DNS, полученным на странице **устройство** в локальном пользовательском интерфейсе. Конечная точка, которую следует использовать, будет выглядеть следующим образом: `https://compute.asedevice.microsoftdatabox.com/10.100.10.10` .

7. Убедитесь, что вы можете подключиться к Kubernetes Pod.

    ```powershell
    kubectl get pods -n "iotedge"
    ```

Чтобы получить журналы контейнеров, выполните следующую команду:

```powershell
kubectl logs <pod-name> -n <namespace> --all-containers
```

### <a name="useful-commands"></a>Полезные команды

|Команда  |Описание  |
|---------|---------|
|`Get-HcsKubernetesUserConfig -AseUser`     | Создает файл конфигурации Kubernetes. При использовании команды скопируйте данные в файл с именем *config*. Не сохраняйте файл с расширением.        |
| `Get-HcsApplianceInfo` | Возвращает сведения о вашем устройстве. |
| `Enable-HcsSupportAccess` | Создает учетные данные доступа для запуска сеанса поддержки. |

## <a name="next-steps"></a>Дальнейшие действия

* [Развертывание веб-приложения инвентаризации людей](spatial-analysis-web-app.md)
* [Настройка операций пространственного анализа](./spatial-analysis-operations.md)
* [Путеводитель по размещению камеры](spatial-analysis-camera-placement.md)
* [Рекомендации по размещению зон и строк](spatial-analysis-zone-line-placement.md)
