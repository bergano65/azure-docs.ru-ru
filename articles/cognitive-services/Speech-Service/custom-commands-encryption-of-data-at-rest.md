---
title: Шифрование неактивных данных в службе пользовательских команд
titleSuffix: Azure Cognitive Services
description: Пользовательские команды шифрование неактивных данных.
services: cognitive-services
author: singhsaumya
manager: yetian
ms.service: cognitive-services
ms.subservice: speech-service
ms.topic: conceptual
ms.date: 07/05/2020
ms.author: sausin
ms.openlocfilehash: 83b6e6be8764a86c41bd9156cc96f8a594dbe1e9
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "87294556"
---
# <a name="custom-commands-encryption-of-data-at-rest"></a>Пользовательские команды для шифрования неактивных данных

Пользовательские команды автоматически шифруют данные при их сохранении в облаке. Шифрование службы пользовательских команд защищает данные и помогает удовлетворить ваши обязательства по обеспечению безопасности и соответствия требованиям Организации.

> [!NOTE]
> Служба настраиваемых команд не включает автоматическое шифрование для ресурсов LUIS, связанных с вашим приложением. При необходимости необходимо включить шифрование для ресурса LUIS [отсюда](./../LUIS/luis-encryption-of-data-at-rest.md).

## <a name="about-cognitive-services-encryption"></a>Сведения о шифровании Cognitive Services
Данные шифруются и расшифровываются с помощью [fips 140-2](https://en.wikipedia.org/wiki/FIPS_140-2) , совместимого с [256-БИТНЫМ](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard) шифрованием AES. Шифрование и расшифровка прозрачны, то есть Управление шифрованием и доступом осуществляется за вас. Данные безопасны по умолчанию, и вам не нужно изменять код или приложения, чтобы воспользоваться преимуществами шифрования.

## <a name="about-encryption-key-management"></a>Об управлении ключами шифрования

При использовании пользовательских команд служба распознавания речи хранит следующие данные в облаке:
* Настройка JSON для приложения пользовательских команд
* LUIS создание и прогнозирование ключей

По умолчанию в подписке используются ключи шифрования, управляемые корпорацией Майкрософт. Однако вы также можете управлять подпиской с помощью собственных ключей шифрования. Управляемые клиентом ключи (CMK), которые также называются ключами BYOK, обеспечивают большую гибкость при создании, смене, отключении и отзыве контроля доступа. Они также дают возможность выполнять аудит ключей шифрования, используемых для защиты ваших данных.


> [!IMPORTANT]
> Ключи, управляемые клиентом, — это доступные ресурсы, созданные после 27 июня 2020 г. Чтобы использовать CMK с голосовыми службами, вам потребуется создать новый ресурс речи. После создания ресурса можно использовать Azure Key Vault для настройки управляемого удостоверения.

Чтобы запросить возможность использования ключей, управляемых клиентом, заполните и отправьте Customer-Managed форму запроса ключа. Для получения сведений о состоянии вашего запроса потребуется около 3-5 рабочих дней. В зависимости от спроса вы можете поместить в очередь и утвердить, как только пространство станет доступным. После утверждения для использования CMK с голосовыми службами необходимо создать новый речевой ресурс из портал Azure.
   > [!NOTE]
   > **Ключи, управляемые клиентом (CMK), поддерживаются только для пользовательских команд.**
   >
   >  **Пользовательское распознавание речи и пользовательское голосовое по все еще поддерживают только свое хранилище (BYOS).**  [Дополнительные сведения](speech-encryption-of-data-at-rest.md)
   >
   > Если вы используете заданный ресурс речи для доступа к этим службам, необходимо обеспечить соответствие требованиям, явно настроив BYOS.


## <a name="customer-managed-keys-with-azure-key-vault"></a>Управляемые клиентом ключи с использованием Azure Key Vault

Для хранения ключей, управляемых клиентом, необходимо использовать Azure Key Vault. Можно либо создать собственные ключи и хранить их в хранилище ключей, либо использовать API-интерфейсы Azure Key Vault для их генерации. Ресурс речи и хранилище ключей должны находиться в одном и том же регионе и в одном клиенте Azure Active Directory (Azure AD), но могут быть в разных подписках. Дополнительные сведения о Azure Key Vault см. в разделе [что такое Azure Key Vault?](https://docs.microsoft.com/azure/key-vault/key-vault-overview).

При создании нового и использовании для инициализации пользовательских команд, данные о распознавании речи всегда шифруются с помощью ключей, управляемых корпорацией Майкрософт. Невозможно включить управляемые клиентом ключи на момент создания ресурса. Ключи, управляемые клиентом, хранятся в Azure Key Vault, а хранилище ключей должно быть подготовлено с политиками доступа, которые предоставляют ключевые разрешения для управляемого удостоверения, связанного с ресурсом Cognitive Services. Управляемое удостоверение доступно только после создания ресурса с использованием ценовой категории, необходимой для CMK.

Включение управляемых ключей клиентов также позволит назначить [управляемое системой удостоверение](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview), компонент Azure AD. После включения управляемого удостоверения, назначенного системой, этот ресурс будет зарегистрирован в Azure Active Directory. После регистрации управляемому удостоверению будет предоставлен доступ к Key Vault, выбранному во время настройки управляемого ключа клиента. 

> [!IMPORTANT]
> При отключении управляемых удостоверений, назначенных системой, доступ к хранилищу ключей будет удален, а все данные, зашифрованные с помощью ключей клиента, станут недоступны. Все функции, зависящие от этих данных, перестанут работать.

> [!IMPORTANT]
> Сейчас управляемые удостоверения не поддерживаются в сценариях работы с разными каталогами. При настройке ключей, управляемых клиентом, в портал Azure управляемое удостоверение автоматически назначается в рамках. Если впоследствии вы перемещаете подписку, группу ресурсов или ресурс из одного каталога Azure AD в другой, управляемое удостоверение, связанное с ресурсом, не передается в новый клиент, поэтому управляемые клиентом ключи могут перестать работать. Дополнительные сведения см. в статье **Передача подписки между каталогами Azure AD** в [часто задаваемых вопросах и известных проблемах с управляемыми удостоверениями для ресурсов Azure](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/known-issues#transferring-a-subscription-between-azure-ad-directories).  

## <a name="configure-azure-key-vault"></a>Настройка Azure Key Vault

Для использования ключей, управляемых клиентом, необходимо, чтобы в хранилище ключей были установлены два свойства: **обратимое удаление** и **не очищать**. Эти свойства не включены по умолчанию, но их можно включить с помощью PowerShell или Azure CLI в новом или существующем хранилище ключей.

> [!IMPORTANT]
> Если вы не включили функции **обратимого удаления** **и не удаляют свойства,** а вы удалите ключ, вы не сможете восстановить данные в своем ресурсе службы.

Чтобы узнать, как включить эти свойства в имеющемся хранилище ключей, см. разделы **Включение обратимого удаления** и **Включение защиты от очистки** в одной из следующих статей:

- [Как использовать обратимое удаление в Key Vault с помощью PowerShell](https://docs.microsoft.com/azure/key-vault/key-vault-soft-delete-powershell).
- [Как использовать обратимое удаление в Key Vault с помощью интерфейса командной строки](https://docs.microsoft.com/azure/key-vault/key-vault-soft-delete-cli).

С шифрованием службы хранилища Azure поддерживаются только ключи RSA размером 2048. Дополнительные сведения о ключах см. в разделе **Key Vault Keys** раздела [о Azure Key Vault ключах, секретах и сертификатах](https://docs.microsoft.com/azure/key-vault/about-keys-secrets-and-certificates#key-vault-keys).

## <a name="enable-customer-managed-keys-for-your-speech-resource"></a>Включение управляемых клиентом ключей для вашего речевого ресурса

Чтобы включить управляемый клиентом ключ на портале Azure, выполните следующие действия.

1. Перейдите к своему речевому ресурсу.
1. В колонке **Параметры** для своего ресурса речи щелкните **Шифрование**. Выберите параметр **управляемые ключи клиента** , как показано на следующем рисунке.

 ![Снимок экрана, показывающий, как выбрать управляемые пользователем ключи](media/custom-commands/select-cmk.png)

## <a name="specify-a-key"></a>Укажите ключ

После включения ключей, управляемых клиентом, можно указать ключ, связываемый с ресурсом Cognitive Services.

### <a name="specify-a-key-as-a-uri"></a>Указание ключа в качестве URI

Чтобы указать ключ в качестве универсального кода ресурса (URI), выполните следующие действия.

1. Чтобы найти URI ключа в портал Azure, перейдите в хранилище ключей и выберите параметр **ключи** . Выберите нужный ключ, а затем щелкните ключ, чтобы просмотреть его версии. Выберите версию ключа, чтобы просмотреть параметры для этой версии.
1. Скопируйте значение поля **идентификатор ключа** , которое предоставляет универсальный код ресурса (URI).

    ![Снимок экрана, показывающий URI ключа хранилища ключей](../media/cognitive-services-encryption/key-uri-portal.png)

1. В параметрах **шифрования** для вашей службы речи выберите параметр **Введите URI ключа** .
1. Вставьте URI, скопированный в поле **ключа URI** .

1. Укажите подписку, которая содержит хранилище ключей.
1. Сохраните изменения.

### <a name="specify-a-key-from-a-key-vault"></a>Указание ключа из хранилища ключей

Чтобы указать ключ из хранилища ключей, сначала убедитесь, что у вас есть хранилище ключей, содержащее ключ. Чтобы указать ключ из хранилища ключей, выполните следующие действия.

1. Выберите параметр **Выбрать в Key Vault**.
1. Выберите хранилище ключей, содержащее ключ, который вы хотите использовать.
1. Выберите ключ из хранилища ключей.

   ![Снимок экрана с параметром ключа, управляемого клиентом](media/custom-commands/configure-cmk-fromKV.png)

1. Сохраните изменения.

## <a name="update-the-key-version"></a>Обновление версии ключа

При создании новой версии ключа обновите речевой ресурс, чтобы использовать новую версию. Выполните следующие действия.

1. Перейдите к своему речевому ресурсу и отобразите параметры **шифрования** .
1. Введите универсальный код ресурса (URI) для новой версии ключа. Кроме того, можно выбрать хранилище ключей и ключ еще раз, чтобы обновить версию.
1. Сохраните изменения.

## <a name="use-a-different-key"></a>Использовать другой ключ

Чтобы изменить ключ, используемый для шифрования, выполните следующие действия.

1. Перейдите к своему речевому ресурсу и отобразите параметры **шифрования** .
1. Введите универсальный код ресурса (URI) для нового ключа. Кроме того, можно выбрать хранилище ключей и выбрать новый ключ.
1. Сохраните изменения.

## <a name="rotate-customer-managed-keys"></a>Смена ключей, управляемых клиентом

Вы можете периодически сменять управляемый клиентом ключ в Azure Key Vault в соответствии с применяемыми политиками соответствия требованиям. При вращении ключа необходимо обновить ресурс речи, чтобы он использовал новый универсальный код ресурса (URI) ключа. Сведения о том, как обновить ресурс для использования новой версии ключа в портал Azure, см. в разделе [Обновление версии ключа](#update-the-key-version).

Вращение ключа не вызывает повторного шифрования данных в ресурсе. От пользователя не требуется предпринимать никаких действий.

## <a name="revoke-access-to-customer-managed-keys"></a>Отозвать доступ к ключам, управляемым клиентом

Чтобы отозвать доступ к ключам, управляемым клиентом, используйте PowerShell или Azure CLI. Дополнительные сведения см. в разделе [Azure Key Vault PowerShell](https://docs.microsoft.com/powershell/module/az.keyvault//) или [Azure Key Vault CLI](https://docs.microsoft.com/cli/azure/keyvault). Отзыв доступа позволяет блокировать доступ ко всем данным в Cognitive Services ресурсе, так как ключ шифрования недоступен для Cognitive Services.

## <a name="disable-customer-managed-keys"></a>Отключение ключей, управляемых клиентом

При отключении управляемых пользователем ключей ваш речевой ресурс шифруется с помощью ключей, управляемых корпорацией Майкрософт. Чтобы отключить управляемые клиентом ключи, выполните следующие действия.

1. Перейдите к своему речевому ресурсу и отобразите параметры **шифрования** .
1. Снимите флажок рядом с параметром **использовать собственный ключ** .

## <a name="next-steps"></a>Дальнейшие действия

* [Форма запроса ключа Customer-Managed речи](https://aka.ms/cogsvc-cmk)
* [Дополнительные сведения о Azure Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-overview)
* [Что такое управляемые удостоверения](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview)



