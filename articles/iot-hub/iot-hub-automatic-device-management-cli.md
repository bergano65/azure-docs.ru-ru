---
title: Автоматическое управление устройствами в масштабе с помощью центра Интернета вещей Azure (CLI) | Документация Майкрософт
description: Использование автоматической конфигурации центра Интернета вещей Azure для управления несколькими устройствами или модулями Интернета вещей
author: robinsh
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 12/13/2019
ms.author: robinsh
ms.openlocfilehash: 60d0ef30a1c7d948a9e837a8bc37c76ace415545
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "82024971"
---
# <a name="automatic-iot-device-and-module-management-using-the-azure-cli"></a>Автоматическое управление устройствами IoT и модулем с помощью Azure CLI

[!INCLUDE [iot-edge-how-to-deploy-monitor-selector](../../includes/iot-hub-auto-device-config-selector.md)]

Автоматическое управление устройствами в Центре Интернета вещей Azure позволяет автоматизировать многие повторяющиеся и сложные задачи управления для большого количества устройств. Благодаря автоматическому управлению устройствами вы можете выбрать набор устройств по определенным свойствам и выявить для них желаемую конфигурацию. Центр Интернета вещей будет сам обновлять выбранные устройства, которые становятся доступными для управления. Обновление выполняется с использованием _автоматической конфигурации устройства_ или _автоматической конфигурации модуля_, которая также позволяет вам подытожить завершение и соответствие требованиям, обрабатывать слияние и конфликты и развертывать конфигурации с помощью поэтапного подхода.

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Автоматическое управление устройствами работает путем обновления набора двойников устройств или модулей с указанием требуемых свойств и предоставляя сводку на основе сообщаемых свойств двойников.  В результате производится новый класс и документ JSON, называемый *Configuration*, который состоит из трех частей:

* **Целевое условие** определяет область обновляемых двойников устройств или модулей. Целевое условие задается как запрос в тегах двойников устройств или как сообщаемые свойства.

* **Целевое содержимое** определяет требуемые свойства, которые необходимо добавить или обновить в целевых двойниках устройств или модулей. Содержимое включает в себя путь к разделу требуемых свойств, которые необходимо изменить.

* **Метрики** определяют общее количество различных состояний конфигурации, таких как **Успешно**, **Выполняется** и **Ошибка**. Пользовательские метрики указываются как запросы в сообщаемых свойствах двойников.  Системные метрики — это метрики по умолчанию, которые измеряют состояние обновления двойника, например количество целевых двойников и количество двойников, которые были успешно обновлены.

В первый раз автоматические конфигурации запускаются вскоре после создания конфигурации, а затем с интервалом в пять минут. Запросы метрик выполняются при каждом запуске автоматической конфигурации.

## <a name="cli-prerequisites"></a>Технические условия CLI

* [Центр Интернета вещей](../iot-hub/iot-hub-create-using-cli.md) в подписке Azure. 

* [Интерфейс командной строки Azure](https://docs.microsoft.com/cli/azure/install-azure-cli) в вашей среде. Вам понадобится как минимум Azure CLI версии 2.0.70 или более поздней. Для проверки используйте `az –-version`. Эта версия поддерживает команды расширения az и представляет собой платформу команд Knack. 

* [Расширение Интернета вещей для Azure CLI](https://github.com/Azure/azure-cli).

[!INCLUDE [iot-hub-cli-version-info](../../includes/iot-hub-cli-version-info.md)]

## <a name="implement-twins"></a>Реализация двойников

Для автоматических конфигураций устройств требуется использовать двойники устройств, чтобы синхронизировать состояние между облаком и устройствами.  См. [общие сведения о двойниках устройств и их использовании в Центре Интернета вещей](iot-hub-devguide-device-twins.md).

Для автоматических конфигураций устройств требуется использовать двойники модулей, чтобы синхронизировать состояние между облаком и модулями. См. [общие сведения о двойниках модулей и их использовании в Центре Интернета вещей](iot-hub-devguide-module-twins.md).

## <a name="use-tags-to-target-twins"></a>Использование тегов для назначения двойников

Перед созданием конфигурации необходимо указать устройства и модули, на которые вы хотите повлиять. Центр Интернета вещей Azure идентифицирует устройства и использует теги для двойников устройств, а также определяет модули с помощью тегов в двойнике модуля. Каждое устройство или модуль может иметь несколько тегов. Их можно определить любым способом, который лучше всего подходит для вашего решения. Например, если вы управляете устройствами в разных расположениях, можно добавить следующие теги в двойник устройства:

```json
"tags": {
    "location": {
        "state": "Washington",
        "city": "Tacoma"
    }
},
```

## <a name="define-the-target-content-and-metrics"></a>Определение целевого содержимого и метрик

Целевые запросы содержимого и метрик указываются как документы JSON, описывающие требуемые свойства двойникаа устройства или модуля двойника для задания и сообщаемых свойств для измерения.  Чтобы создать автоматическую конфигурацию с помощью Azure CLI, сохраните целевое содержимое и метрики локально в виде файлов. txt. Пути к файлам можно использовать в следующем разделе при выполнении команды для применения конфигурации к устройству.

Ниже приведен пример базового целевого содержимого для автоматической настройки устройства.

```json
{
  "content": {
    "deviceContent": {
      "properties.desired.chillerWaterSettings": {
        "temperature": 38,
        "pressure": 78
      }
    }
}
```

Автоматические конфигурации модулей ведут себя точно так же, но `moduleContent` вместо нее нацеливание `deviceContent` .

```json
{
  "content": {
    "moduleContent": {
      "properties.desired.chillerWaterSettings": {
        "temperature": 38,
        "pressure": 78
      }
    }
}
```

Ниже приведены примеры запросов метрики.

```json
{
  "queries": {
    "Compliant": "select deviceId from devices where configurations.[[chillerdevicesettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='current'",
    "Error": "select deviceId from devices where configurations.[[chillerdevicesettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='error'",
    "Pending": "select deviceId from devices where configurations.[[chillerdevicesettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='pending'"
  }
}
```

Запросы метрик для модулей также похожи на запросы для устройств, но выбрано для `moduleId` из `devices.modules` . Пример: 

```json
{
  "queries": {
    "Compliant": "select deviceId, moduleId from devices.module where configurations.[[chillermodulesettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='current'"
  }
}
```

## <a name="create-a-configuration"></a>Создание конфигурации

Создавая конфигурацию, состоящую из целевого содержимого и метрик, вы настраиваете целевые устройства. 

Создайте конфигурацию с помощью следующей команды.

```azurecli
   az iot hub configuration create --config-id [configuration id] \
     --labels [labels] --content [file path] --hub-name [hub name] \
     --target-condition [target query] --priority [int] \
     --metrics [metric queries]
```

* --**config-id** — имя конфигурации, которая будет создана в центре IoT. Присвойте вашей конфигурации уникальное имя, содержащее до 128 букв в нижнем регистре. Не используйте пробелы и следующие недопустимые символы: `& ^ [ ] { } \ | " < > /`.

* --**labels** — добавление меток для облегчения отслеживания конфигураций. Метка представляет собой пару имя и значение, которые описывают развертывание. Например, `HostPlatform, Linux` или `Version, 3.0.1`.

* --**content** — встроенный JSON или путь к целевому содержимому, которому должны быть заданы двойные требуемые свойства. 

* --**hub-name** — имя центра IoT, в котором будет создана конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`

* --**Target — условие** — введите целевое условие, чтобы определить, какие устройства или модули будут нацелены на эту конфигурацию.Для автоматической настройки устройства условие основано на тегах двойникаа устройства или требуемых свойствах двойникаа устройства и должно соответствовать формату выражения.Например, `tags.environment='test'` или `properties.desired.devicemodel='4000x'`.Для автоматической настройки модуля это условие основано на тегах модуля двойника или требуемых свойствах модуля двойника. Например, `from devices.modules where tags.environment='test'` или `from devices.modules where properties.reported.chillerProperties.model='4000x'`.

* --**Priority** — положительное целое число. В случае, если две или более конфигурации нацелены на одно устройство или модуль, будет применяться конфигурация с наибольшим числовым значением приоритета.

* --**metrics** — путь к запросам метрик. Метрики предоставляют общее количество различных состояний, которые устройство или модуль может передавать после применения содержимого конфигурации. Например, вы можете создать метрику для ожидающих изменений параметров, метрики для ошибок и метрики для успешных изменений параметров. 

## <a name="monitor-a-configuration"></a>Мониторинг конфигурации

Чтобы отобразить содержимое конфигурации, используйте следующую команду.

```azurecli
az iot hub configuration show --config-id [configuration id] \
  --hub-name [hub name]
```

* --**config-id** — имя существующей конфигурации в центре IoT.

* --**hub-name** — имя центра IoT, в котором существует конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`

Проверьте конфигурацию в командном окне. Свойство **metrics** перечисляет количество каждой метрики, которое оценивается каждым центром.

* **таржетедкаунт** — системная метрика, указывающая число двойниковов устройств или двойников модуля в центре Интернета вещей, которые соответствуют условию нацеливания.

* **апплиедкаунт** — системная метрика указывает количество устройств или модулей, к которым применено целевое содержимое.

* **Настраиваемая метрика** — все определенные вами метрики являются метриками пользователей.

Список идентификаторов устройств, идентификаторов модулей или объектов для каждой из метрик можно просмотреть с помощью следующей команды:

```azurecli
az iot hub configuration show-metric --config-id [configuration id] \
   --metric-id [metric id] --hub-name [hub name] --metric-type [type] 
```

* --**config-id** — имя существующего развертывания в центре IoT.

* --**Metric-ID** — имя метрики, для которой необходимо просмотреть список идентификаторов устройств или идентификаторов модулей, например `appliedCount` .

* --**Hub-Name** — имя центра Интернета вещей, в котором существует развертывание. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`.

* --**metric-type** — возможные значения типа метрики: `system` или `user`.  Метрики систем: `targetedCount` и `appliedCount`. Все другие метрики — это пользовательские метрики.

## <a name="modify-a-configuration"></a>Изменение конфигурации

При изменении конфигурации изменения немедленно реплицируются во все целевые устройства. 

Если обновить целевое условие, произойдут следующие обновления:

* Если двойник не соответствует предыдущему условию назначения, однако соответствует новому и эта конфигурация имеет самый высокий приоритет для двойника, то она будет применена к двойнику. 

* Если двойник, работающий в настоящее время в этой конфигурации, больше не соответствует целевому условию, параметры из конфигурации будут удалены, а двойник будет изменен с помощью следующей конфигурации с наивысшим приоритетом. 

* Если двойник, работающий в настоящее время в этой конфигурации, больше не удовлетворяет целевому условию и не соответствует целевому условию любых других конфигураций, параметры из конфигурации будут удалены и никакие другие изменения не будут сделаны в двойнике. 

Обновите конфигурацию с помощью следующей команды.

```azurecli
az iot hub configuration update --config-id [configuration id] \
   --hub-name [hub name] --set [property1.property2='value']
```

* --**config-id** — имя существующей конфигурации в центре IoT.

* --**hub-name** — имя центра IoT, в котором существует конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`.

* --**set** — обновление свойства в конфигурации. Можно обновлять следующие свойства.

    * targetCondition — например `targetCondition=tags.location.state='Oregon'`

    * метки; 

    * priority

## <a name="delete-a-configuration"></a>Удаление конфигурации

При удалении конфигурации любой двойников устройства или модуль двойников принимает их следующую конфигурацию с наивысшим приоритетом. Если двойников не соответствует целевому состоянию какой бы то ни было другой конфигурации, другие параметры не применяются. 

Удалите конфигурацию с помощью следующей команды.

```azurecli
az iot hub configuration delete --config-id [configuration id] \
   --hub-name [hub name] 
```

* --**config-id** — имя существующей конфигурации в центре IoT.

* --**hub-name** — имя центра IoT, в котором существует конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`.

## <a name="next-steps"></a>Дальнейшие действия

В этой статье вы узнали, как настроить и отслеживать устройства Центра Интернета вещей в масштабе. Дополнительные сведения об управлении Центром Интернета вещей в Azure см. по следующим ссылкам:

* [Управление удостоверениями устройств Центра Интернета вещей в пакетном режиме](iot-hub-bulk-identity-mgmt.md)
* [Общие сведения о метриках Центра Интернета вещей](iot-hub-metrics.md)
* [Мониторинг операций](iot-hub-operations-monitoring.md)

Для дальнейшего изучения возможностей Центра Интернета вещей см. следующие статьи:

* [Руководство разработчика для Центра Интернета вещей](iot-hub-devguide.md)
* [Краткое руководство. Развертывание первого модуля IoT Edge на устройстве под управлением 64-разрядной ОС Linux](../iot-edge/tutorial-simulate-device-linux.md)

Узнайте, как использовать службу подготовки устройств для Центра Интернета вещей, чтобы включить автоматическую подготовку JIT, из следующей статьи: 

* [Служба подготовки устройств для Центра Интернета вещей Azure](/azure/iot-dps)
