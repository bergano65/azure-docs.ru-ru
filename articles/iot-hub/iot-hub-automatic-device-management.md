---
title: Автоматическое управление устройствами в большом масштабе с помощью центра Интернета вещей Azure | Документация Майкрософт
description: Использование автоматической конфигурации центра Интернета вещей Azure для управления несколькими устройствами и модулями Интернета вещей
author: robinsh
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 12/13/2019
ms.author: robinsh
ms.custom:
- 'Role: Cloud Development'
- 'Role: IoT Device'
ms.openlocfilehash: 6d3661128008c13e5d4d459f6f8e7925aa18a9a4
ms.sourcegitcommit: a76ff927bd57d2fcc122fa36f7cb21eb22154cfa
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/28/2020
ms.locfileid: "87322777"
---
# <a name="automatic-iot-device-and-module-management-using-the-azure-portal"></a>Автоматическое управление устройствами и модулями Интернета вещей с помощью портала Azure

[!INCLUDE [iot-edge-how-to-deploy-monitor-selector](../../includes/iot-hub-auto-device-config-selector.md)]

Автоматическое управление устройствами в Центре Интернета вещей Azure позволяет автоматизировать многие повторяющиеся и сложные задачи управления для большого количества устройств. Благодаря автоматическому управлению устройствами вы можете выбрать набор устройств по определенным свойствам и выявить для них желаемую конфигурацию. Центр Интернета вещей будет сам обновлять выбранные устройства, которые становятся доступными для управления. Обновление выполняется с использованием _автоматической конфигурации устройства_ или _автоматической конфигурации модуля_, которая также позволяет вам подытожить завершение и соответствие требованиям, обрабатывать слияние и конфликты и развертывать конфигурации с помощью поэтапного подхода.

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Автоматическое управление устройствами работает путем обновления набора двойников устройств или модулей с указанием требуемых свойств и предоставляя сводку на основе сообщаемых свойств двойников.  В результате производится новый класс и документ JSON, называемый *Configuration*, который состоит из трех частей:

* **Целевое условие** определяет область обновляемых двойников устройств или модулей. Целевое условие задается как запрос в тегах двойников или как сообщаемые свойства.

* **Целевое содержимое** определяет требуемые свойства, которые необходимо добавить или обновить в целевых двойниках устройств или модулей. Содержимое включает в себя путь к разделу требуемых свойств, которые необходимо изменить.

* **Метрики** определяют общее количество различных состояний конфигурации, таких как **Успешно**, **Выполняется** и **Ошибка**. Пользовательские метрики указываются как запросы в сообщаемых свойствах двойников.  Системные метрики — это метрики по умолчанию, которые измеряют состояние обновления двойника, например количество целевых двойников и количество двойников, которые были успешно обновлены.

В первый раз автоматические конфигурации запускаются вскоре после создания конфигурации, а затем с интервалом в пять минут. Запросы метрик выполняются при каждом запуске автоматической конфигурации.

## <a name="implement-twins"></a>Реализация двойников

Для автоматических конфигураций устройств требуется использовать двойники устройств, чтобы синхронизировать состояние между облаком и устройствами.  См. [общие сведения о двойниках устройств и их использовании в Центре Интернета вещей](iot-hub-devguide-device-twins.md).

Для автоматических конфигураций устройств требуется использовать двойники модулей, чтобы синхронизировать состояние между облаком и модулями. См. [общие сведения о двойниках модулей и их использовании в Центре Интернета вещей](iot-hub-devguide-module-twins.md).

## <a name="use-tags-to-target-twins"></a>Использование тегов для назначения двойников

Перед созданием конфигурации необходимо указать устройства и модули, на которые вы хотите повлиять. Центр Интернета вещей Azure идентифицирует устройства и использует теги для двойников устройств, а также определяет модули с помощью тегов в двойнике модуля. Каждое устройство или модуль может иметь несколько тегов. Их можно определить любым способом, который лучше всего подходит для вашего решения. Например, если вы управляете устройствами в разных расположениях, можно добавить следующие теги в двойник устройства:

```json
"tags": {
    "location": {
        "state": "Washington",
        "city": "Tacoma"
    }
},
```

## <a name="create-a-configuration"></a>Создание конфигурации

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com). 

2. Выберите **Конфигурация устройства Интернета вещей**.

3. Выберите **Добавить конфигурацию устройства** или **Добавить конфигурацию модуля**.

   ![Добавление конфигурации устройства или конфигурации модуля](./media/iot-hub-automatic-device-management/create-automatic-configuration.png)

Процедура создания конфигурации состоит из пяти шагов. В следующих разделах описан каждый из этих шагов. 

### <a name="name-and-label"></a>Имя и метка

1. Присвойте вашей конфигурации уникальное имя, содержащее до 128 букв в нижнем регистре. Не используйте пробелы и следующие недопустимые символы: `& ^ [ ] { } \ | " < > /`.

2. Добавьте метки для отслеживания конфигураций. Метки представляют собой пары **имени** и **значения**, которые описывают конфигурацию. Например, `HostPlatform, Linux` или `Version, 3.0.1`.

3. Чтобы перейти к следующему шагу, нажмите кнопку **Далее**. 

### <a name="specify-settings"></a>Указание параметров

В этом разделе определяется содержимое, устанавливаемое в целевом двойнике устройства или модуля. Для каждого набора параметров есть два вида входных данных. Первый — это путь к двойнику, который представляет собой путь к разделу JSON, где будут заданы два требуемых свойства.  Второй — это содержимое JSON, которое должно быть вставлено в этот раздел. 

Например, можно задать путь к двойнику `properties.desired.chiller-water`, а затем предоставить следующее содержимое JSON: 

```json
{
  "temperature": 66,
  "pressure": 28
}
```

![Указание пути к двойнику и содержимого](./media/iot-hub-automatic-device-management/module-config-twin-settings.png)


Можно также задать отдельные параметры, предоставив весь путь двойника и указав значение без квадратных скобок. Например, для пути `properties.desired.chiller-water.temperature` двойника задайте для содержимого значение `66`. Затем создайте новый параметр двойника для свойства pressure. 

Если две или несколько конфигураций указывают на один и тот же путь, то будет использоваться содержимое из конфигурации с наивысшим приоритетом (приоритет определяется на шаге 4).

Чтобы удалить существующее свойство, укажите для него значение `null`.

Дополнительные параметры можно добавить, выбрав **Добавить параметр двойника устройства** или **Добавить параметр двойника модуля**.

### <a name="specify-metrics-optional"></a>Указание метрик (необязательно)

Метрики предоставляют общее количество различных состояний, которые устройство или модуль может передавать после применения содержимого конфигурации. Например, вы можете создать метрику для ожидающих изменений параметров, метрики для ошибок и метрики для успешных изменений параметров.

Каждая конфигурация может иметь до пяти пользовательских метрик. 

1. Введите имя для параметра **Имя метрики**.

2. Введите запрос для параметра **Metric Criteria** (Критерии метрики).  Запрос основан на сообщаемых свойствах двойников устройств.  Метрика представляет количество строк, возвращаемых запросом.

Пример:

```sql
SELECT deviceId FROM devices 
  WHERE properties.reported.chillerWaterSettings.status='pending'
```

Предложение с указанием того, что конфигурация была применена, см. в примере. 

```sql
/* Include the double brackets. */
SELECT deviceId FROM devices 
  WHERE configurations.[[yourconfigname]].status='Applied'
```

Если вы создаете метрику для формирования отчета о настроенных модулях, выберите `moduleId` из `devices.modules`. Пример:

```sql
SELECT deviceId, moduleId FROM devices.modules
  WHERE properties.reported.lastDesiredStatus.code = 200
```

### <a name="target-devices"></a>Целевые устройства

С помощью свойств тегов ваших двойников можно назначить конкретные устройства или модули, к которым будет применяться эта конфигурация. Также можно указать на целевые устройства с помощью сообщаемых свойств двойника.

Автоматические конфигурации устройств могут указывать только на теги двойников устройств, а автоматические конфигурации модулей — только на теги двойников модулей. 

Так как несколько конфигураций могут предназначаться для одного устройства или модуля, каждой конфигурации необходимо присвоить номер приоритета. Если возникает конфликт, побеждает конфигурация с наивысшим приоритетом. 

1. Введите положительное целое число для **приоритета** конфигурации. Наивысшее числовое значение считается наивысшим приоритетом. Когда обе конфигурации имеют одинаковый номер приоритета, побеждает та, которая была создана недавно. 

2. Введите **условие назначения**, чтобы определить, для каких устройств иди модулей будет предназначена эта конфигурация. Условие основано на тегах двойника или его сообщаемых свойствах и должно соответствовать формату выражения. 

   Для автоматической настройки устройства можно указать только тег или сообщаемое свойство для целевого объекта. Например, `tags.environment='test'` или `properties.reported.chillerProperties.model='4000x'`. Вы можете выбрать `*` для всех устройств. 
   
   Для автоматической конфигурации модуля используйте запрос, чтобы указать теги или сообщаемые свойства из модулей, зарегистрированных в центре Интернета вещей. Например, `from devices.modules where tags.environment='test'` или `from devices.modules where properties.reported.chillerProperties.model='4000x'`. Невозможно использовать подстановочный знак для указания всех модулей. 

3. Нажмите кнопку **Далее**, чтобы перейти к последнему шагу.

### <a name="review-configuration"></a>Просмотр конфигурации

Просмотрите сведения о конфигурации, а затем выберите **Отправить**.

## <a name="monitor-a-configuration"></a>Мониторинг конфигурации

Чтобы просмотреть сведения о конфигурации и узнать, какое устройство ее использует, сделайте следующее:

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com). 

2. Выберите **Конфигурация устройства Интернета вещей**.

3. Проверьте список конфигураций. Для каждой конфигурации можно просмотреть следующие сведения:

   * **Идентификатор**. Имя конфигурации.

   * **Целевое условие**. Запрос, используемый для определения целевых устройств или модулей.

   * **Приоритет**. Номер приоритета, назначенный для конфигурации.

   * **Время создания**. Метка времени, когда была создана конфигурация. Метка времени используется, чтобы разорвать связи, если две конфигурации имеют одинаковый приоритет. 

   * **Системные метрики**. Метрики, которые вычисляются Центром Интернета вещей и не могут быть настроены разработчиками. Целевое условие указывает количество двойников устройств, которые соответствуют целевому состоянию. Применяет заданное количество двойников устройств, которые были изменены конфигурацией, а также могут содержать частичные изменения в случае, если они были сделаны отдельной конфигурацией с более высоким приоритетом. 

   * **Пользовательские метрики**. Метрики, заданные разработчиком в качестве запросов к сообщаемым свойствам двойников.  Для каждой конфигурации можно определить до пяти пользовательских метрик. 
   
4. Выберите конфигурацию, которую следует отслеживать.  

5. Проверьте сведения о конфигурации. С помощью вкладок можно просмотреть конкретные сведения об устройствах, к которым применена конфигурация.

   * **Целевое условие**. Устройства или модули, которые соответствуют целевому условию. 

   * **Метрики**. Список системных и пользовательских метрик.  Вы можете просмотреть список устройств или модулей для каждой метрики, выбрав метрику в раскрывающемся списке, а затем выбрав **Просмотреть устройства** или **Просмотреть модули**.

   * **Параметры двойника устройства** или **Параметры двойника модуля**. Параметры двойников, настроенные с помощью конфигурации. 

   * **Configuration Labels** (Метки конфигурации). Пары "ключ — значение", используемые для описания конфигурации.  Метки не влияют на функциональность. 

## <a name="modify-a-configuration"></a>Изменение конфигурации

При изменении конфигурации изменения немедленно реплицируются во все целевые устройства или модули. 

Если обновить целевое условие, произойдут следующие обновления:

* Если двойник не соответствует предыдущему условию назначения, однако соответствует новому и эта конфигурация имеет самый высокий приоритет для двойника, то она будет применена к двойнику. 

* Если двойник, работающий в настоящее время в этой конфигурации, больше не соответствует целевому условию, параметры из конфигурации будут удалены, а двойник будет изменен с помощью следующей конфигурации с наивысшим приоритетом. 

* Если двойник, работающий в настоящее время в этой конфигурации, больше не удовлетворяет целевому условию и не соответствует целевому условию любых других конфигураций, параметры из конфигурации будут удалены и никакие другие изменения не будут сделаны в двойнике. 

Чтобы изменить конфигурацию, сделайте следующее: 

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com). 

2. Выберите **Конфигурация устройства Интернета вещей**. 

3. Выберите конфигурацию, которую следует изменить. 

4. Внесите изменения в следующие поля: 

   * Условие назначения 
   * Метки 
   * Приоритет 
   * Метрики

4. Щелкните **Сохранить**.

5. Следуйте указаниям раздела [Мониторинг конфигурации](#monitor-a-configuration) для отслеживания выполнения изменений. 

## <a name="delete-a-configuration"></a>Удаление конфигурации

Когда вы удаляете конфигурацию, все двойники устройств принимают следующую конфигурацию с самым высоким приоритетом. Если двойники устройств не соответствуют целевому условию любой другой конфигурации, то другие параметры не применяются. 

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com). 

2. Выберите **Конфигурация устройства Интернета вещей**. 

3. Установите флажок, чтобы выбрать конфигурацию, которую необходимо удалить. 

4. Выберите команду **Удалить**.

5. Появится запрос на подтверждение.

## <a name="next-steps"></a>Дальнейшие действия

В этой статье вы узнали, как настроить и отслеживать устройства Центра Интернета вещей в масштабе. Дополнительные сведения об управлении Центром Интернета вещей в Azure см. по следующим ссылкам:

* [Управление удостоверениями устройств Центра Интернета вещей в пакетном режиме](iot-hub-bulk-identity-mgmt.md)
* [Общие сведения о метриках Центра Интернета вещей](iot-hub-metrics.md)
* [Мониторинг операций](iot-hub-operations-monitoring.md)

Для дальнейшего изучения возможностей Центра Интернета вещей см. следующие статьи:

* [Руководство разработчика для Центра Интернета вещей](iot-hub-devguide.md)
* [Краткое руководство. Развертывание первого модуля IoT Edge на устройстве под управлением 64-разрядной ОС Linux](../iot-edge/tutorial-simulate-device-linux.md)

Узнайте, как использовать службу подготовки устройств для Центра Интернета вещей, чтобы включить автоматическую подготовку JIT, из следующей статьи: 

* [Служба подготовки устройств для Центра Интернета вещей Azure](/azure/iot-dps)
