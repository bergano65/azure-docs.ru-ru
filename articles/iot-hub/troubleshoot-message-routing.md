---
title: Устранение неполадок с маршрутизацией сообщений Интернета вещей Azure
description: Как выполнить устранение неполадок с маршрутизацией сообщений Azure IoT
author: ash2017
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 05/06/2020
ms.author: asrastog
ms.openlocfilehash: 29127a9dff42c0f733e3721d1ea5fea7350e774e
ms.sourcegitcommit: d767156543e16e816fc8a0c3777f033d649ffd3c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/26/2020
ms.locfileid: "92547369"
---
# <a name="troubleshooting-message-routing"></a>Устранение неполадок маршрутизации сообщений

В этой статье приведены рекомендации по мониторингу и устранению неполадок, связанные с [маршрутизацией сообщений](iot-hub-devguide-messages-d2c.md)центра Интернета вещей.

## <a name="monitoring-message-routing"></a>Мониторинг маршрутизации сообщений

Мы рекомендуем отслеживать [метрики центра Интернета вещей, связанные с маршрутизацией сообщений и конечными точками](monitor-iot-hub-reference.md#routing-metrics) , чтобы получить общие сведения о отправленных сообщениях. Вы также можете создать параметр диагностики для отправки операций для [ **маршрутов** в журналах ресурсов центра Интернета вещей](monitor-iot-hub-reference.md#routes) , чтобы Azure Monitor журналы, концентраторы событий или хранилище Azure для пользовательской обработки. Дополнительные сведения об использовании метрик, журналов ресурсов и параметров диагностики см. в статье [мониторинг центра Интернета вещей](monitor-iot-hub.md). Руководство см. в статье [Настройка и использование метрик и журналов ресурсов с помощью центра Интернета вещей](tutorial-use-metrics-and-diags.md).

Также рекомендуется включить [резервный маршрут](iot-hub-devguide-messages-d2c.md#fallback-route) , если вы хотите поддерживать сообщения, которые не соответствуют запросу по любому из маршрутов. Они могут храниться во [встроенной конечной точке](iot-hub-devguide-messages-read-builtin.md) в течение заданного количества дней хранения.

## <a name="top-issues"></a>Наиболее важные проблемы

Ниже перечислены наиболее распространенные проблемы с маршрутизацией сообщений. Чтобы начать устранение неполадок, щелкните вопрос, чтобы получить подробные инструкции.

* [Сообщения с моих устройств не маршрутизируются должным образом](#messages-from-my-devices-are-not-being-routed-as-expected)
* [Я внезапно прекратил получать сообщения во встроенной конечной точке концентраторов событий](#i-suddenly-stopped-getting-messages-at-the-built-in-endpoint)

### <a name="messages-from-my-devices-are-not-being-routed-as-expected"></a>Сообщения с моих устройств не маршрутизируются должным образом

Чтобы устранить эту проблему, проанализируйте следующие вопросы.

#### <a name="the-routing-metrics-for-this-endpoint"></a>Метрики маршрутизации для этой конечной точки

Все [метрики центра Интернета вещей, связанные с маршрутизацией](monitor-iot-hub-reference.md#routing-metrics) , имеют префикс *маршрутизации* . Вы можете объединить данные из нескольких метрик, чтобы определить первопричину проблем. Например, используйте **попытки доставки с маршрутизацией** метрики, чтобы указать количество сообщений, которые были доставлены в конечную точку, или удалить, если они не совпали с запросами на любом из маршрутов и в резервном маршруте отключены. Проверьте метрику **задержки маршрутизации** , чтобы определить, является ли задержка для доставки сообщений стабильной или возрастающей. При растущей задержке может указываться проблема с определенной конечной точкой, поэтому рекомендуется проверить [работоспособность конечной точки](#the-health-of-the-endpoint). Эти метрики маршрутизации также имеют [измерения](monitor-iot-hub-reference.md#metric-dimensions) , которые предоставляют подробные сведения о метрике, такие как тип конечной точки, конкретное имя конечной точки и причина, по которой сообщение не было доставлено.

#### <a name="the-resource-logs-for-any-operational-issues"></a>Журналы ресурсов для любых проблем в работе

Просмотрите [журналы ресурсов **маршрутов**](monitor-iot-hub-reference.md#routes) , чтобы получить дополнительные сведения об [операциях](#operation-names) маршрутизации и конечной точки либо определить ошибки и соответствующий [код ошибки](#common-error-codes) , чтобы понять причину проблемы. Например, имя операции **раутивалуатионеррор** в журнале указывает, что маршрут не может быть вычислен из-за проблемы с форматом сообщения. Используйте советы, предоставленные для конкретных [имен операций](#operation-names) , чтобы устранить эту ошибку. Если событие регистрируется как ошибка, журнал также предоставляет дополнительные сведения о том, почему произошел сбой оценки. Например, если имя операции — **ендпоинтунхеалси** , [код ошибки](#common-error-codes) 403004 указывает на то, что в конечной точке закончилось свободное место.

#### <a name="the-health-of-the-endpoint"></a>Работоспособность конечной точки

Чтобы получить [состояние работоспособности](iot-hub-devguide-endpoints.md#custom-endpoints) конечных точек, используйте REST API [получить работоспособность конечной точки](/rest/api/iothub/iothubresource/getendpointhealth#iothubresource_getendpointhealth) . API *получения сведений о работоспособности конечной точки* также предоставляет сведения о последней успешной отправке сообщения в конечную точку, [последней известной ошибке](#last-known-errors-for-iot-hub-routing-endpoints), последней известной ошибке и времени последней попытки отправки для этой конечной точки. Используйте возможные способы устранения данной [последней известной ошибки](#last-known-errors-for-iot-hub-routing-endpoints).

### <a name="i-suddenly-stopped-getting-messages-at-the-built-in-endpoint"></a>Я внезапно прекратил получать сообщения во встроенной конечной точке

Чтобы устранить эту проблему, проанализируйте следующие вопросы.

#### <a name="was-a-new-route-created"></a>Был ли создан новый маршрут?

После создания маршрута данные перестают передаваться во встроенную конечную точку, если только маршрут не создан для этой конечной точки. Чтобы обеспечить передачу сообщений во встроенную конечную точку при добавлении нового маршрута, настройте маршрут к конечной точке *события* . 

#### <a name="was-the-fallback-route-disabled"></a>Отключен ли резервный маршрут?

Резервный маршрут отправляет все сообщения, которые не соответствуют условиям запроса, на любом из существующих маршрутов к [встроенным концентраторам событий](iot-hub-devguide-messages-read-builtin.md) (сообщениям и событиям), совместимым с [концентраторами событий](../event-hubs/index.yml). Если маршрутизация сообщений включена, вы можете включить возможность резервного маршрута. Если маршруты ко встроенной конечной точке отсутствуют и резервный маршрут включен, на встроенную конечную точку будут отправляться только те сообщения, которые не соответствуют каким-либо условиям запроса для маршрутов. Кроме того, если удалить имеющиеся маршруты, необходимо включить резервный маршрут, чтобы все данные поступали на встроенную конечную точку.

Вы можете включить или отключить резервный маршрут в колонке "портал Azure->маршрутизация сообщений". Вы также можете использовать Azure Resource Manager, чтобы свойства [FallbackRouteProperties](/rest/api/iothub/iothubresource/createorupdate#fallbackrouteproperties) использовали пользовательскую конечную точку для резервного маршрута.

## <a name="last-known-errors-for-iot-hub-routing-endpoints"></a>Последние известные ошибки для конечных точек маршрутизации центра Интернета вещей

<a id="last-known-errors"></a>
[!INCLUDE [iot-hub-include-last-known-errors](../../includes/iot-hub-include-last-known-errors.md)]

## <a name="routes-resource-logs"></a>Маршруты к журналам ресурсов

Ниже приведены имена операций и коды ошибок, регистрируемые в [журналах ресурсов маршрутов](monitor-iot-hub-reference.md#routes).

<a id="diagnostics-operation-names"></a>
### <a name="operation-names"></a>Имена операций

[!INCLUDE [iot-hub-diagnostics-operation-names](../../includes/iot-hub-diagnostics-operation-names.md)]

<a id="diagnostics-error-codes"></a>
### <a name="common-error-codes"></a>Коды распространенных ошибок

[!INCLUDE [iot-hub-diagnostics-error-codes](../../includes/iot-hub-diagnostics-error-codes.md)]

## <a name="next-steps"></a>Дальнейшие действия

Если вам потребуется дополнительная помощь, вы можете обратиться к экспертам по Azure на [форумах MSDN Azure и Stack Overflow](https://azure.microsoft.com/support/forums/). Кроме того, можно зарегистрировать обращение в службу поддержки Azure. Перейдите на [сайт поддержки Azure](https://azure.microsoft.com/support/options/) и щелкните **Получить поддержку** .