---
title: Потоки устройств Центра Интернета вещей (предварительная версия) | Документация Майкрософт
description: Обзор потоков устройств Центра Интернета вещей.
author: rezasherafat
manager: briz
services: iot-hub
ms.service: iot-hub
ms.topic: conceptual
ms.date: 01/15/2019
ms.author: rezas
ms.openlocfilehash: ea50902a557e8bd7aa18fbc03fca8fc4a99ac2e2
ms.sourcegitcommit: 415742227ba5c3b089f7909aa16e0d8d5418f7fd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2019
ms.locfileid: "55770794"
---
# <a name="iot-hub-device-streams-preview"></a>Потоки устройств Центра Интернета вещей (предварительная версия)

## <a name="overview"></a>Обзор
*Потоки устройств* Центра Интернета вещей Azure облегчают создание защищенных двусторонних туннелей TCP для различных сценариев взаимодействия между устройством и облаком. Поток устройства проходит через *конечную точку потоковой передачи* Центра Интернета вещей, которая действует в качестве прокси-сервера между вашим устройством и конечными точками службы. Эта конфигурация (показана на схеме ниже) особенно полезна, когда устройства находятся за сетевым брандмауэром или в частной сети. Таким образом, потоки устройств Центра Интернета вещей позволяют клиентам связываться с устройствами Центра Интернета вещей при использовании брандмауэра без необходимости открывать набор портов сетевого брандмауэра для входящего или исходящего трафика.

![Замещающий текст](./media/iot-hub-device-streams-overview/iot-hub-device-streams-overview.png "Обзор потоков устройств Центра Интернета вещей")


При использовании потоков устройств Центра Интернета вещей устройства остаются защищенными и на них всего лишь нужно открыть исходящие подключения TCP к конечной точке потоковой передачи Центра Интернета вещей через порт 443. После установки потоковой передачи приложения на стороне службы и устройства получат программный доступ к объекту клиента WebSocket для обмена необработанными байтами. Гарантии надежности и упорядоченности, предоставляемые этим туннелем, точно такие же, как и у протокола TCP.

## <a name="benefits"></a>Преимущества
Потоки устройств Центра Интернета вещей предоставляют следующие преимущества:
- **Безопасное подключение при использовании брандмауэра.** К устройствам Центра Интернета вещей можно получить доступ из конечных точек службы, не открывая порт входящего трафика брандмауэра на периметре устройства или сети (только исходящее подключение к Центру Интернета вещей должно осуществляться через порт 443).

- **Проверка подлинности:** И на устройстве, и в службе как сторонах туннеля требуется аутентификация в Центре Интернета вещей с использованием соответствующих учетных данных.

- **Шифрование.** По умолчанию потоки устройств Центра Интернета вещей используют TLS-подключения. Это гарантирует, что трафик всегда шифруется, независимо от того, использует ли приложение шифрование.

- **Простота подключения.** Во многих случаях благодаря потокам устройств устраняется необходимость в сложной установке виртуальных частных сетей для подключения к устройствам Интернета вещей.

- **Совместимость со стеком TCP/IP.** Потоки устройств Центра Интернета вещей вмещают трафик приложения по протоколу TCP/IP. Это означает, что эту функцию может использовать широкий диапазон запатентованных протоколов, а также протоколов, основанных на стандартах.

- **Простота в использовании при настройке частной сети.** Служба может подключиться к устройству по его идентификатору, а не по его IP-адресу. Это полезно в ситуациях, когда устройство находится в частной сети и имеет частный IP-адрес или когда IP-адрес назначается динамически и неизвестен на стороне службы.

## <a name="device-stream-workflows"></a>Рабочие процессы при использовании потоков устройств
Потоковая передача данных устройства инициируется в том случае, когда служба запрашивает подключение к устройству с указанием его идентификатора. Этот рабочий процесс особенно подходит для модели взаимодействия "клиент — сервер", в том числе с задействованием протоколов SSH и RDP, когда пользователь хочет удаленно подключиться к серверу SSH и RDP, выполняемому на устройстве, с помощью клиентской программы SSH и RDP.

Процесс создания потока устройства включает согласование между устройством, службой, основной конечной точкой и конечной точкой потоковой передачи Центра Интернета вещей. Хотя основная конечная точка Центра Интернета вещей организует создание потока устройства, конечная точка потоковой передачи обрабатывает трафик, который проходит между службой и устройством.

### <a name="device-stream-creation-flow"></a>Процесс создания потока устройства
Программное создание потока устройства с помощью пакета SDK состоит из приведенных ниже шагов, которые также показаны на рисунке ниже:

![Замещающий текст](./media/iot-hub-device-streams-overview/iot-hub-device-streams-handshake.png "Процесс подтверждения потока устройства")


1. Приложение устройства заранее регистрирует обратный вызов, чтобы получить уведомление при инициации подключения нового потока к устройству. Этот шаг обычно происходит, когда устройство загружается и подключается к Центру Интернета вещей.

2. Программа на стороне службы инициирует подключение потока устройства, когда это необходимо, предоставляя идентификатор устройства (_не_ IP-адрес).

3. Центр Интернета вещей уведомляет программу на стороне устройства, вызывая обратный вызов, зарегистрированный на шаге 1. Устройство может принять или отклонить запрос на инициацию потоковой передачи. Эта логика может отличаться в зависимости от конкретного сценария приложения. Если устройство отклоняет этот запрос потоковой передачи, Центр Интернета вещей уведомляет службу. В противном случае выполняются следующие действия.

4. Устройство создает защищенное исходящее подключение TCP к конечной точке потоковой передачи через порт 443 и преобразует его в подключение WebSocket. URL-адрес конечной точки потоковой передачи, а также учетные данные, используемые для аутентификации, предоставляются устройству с помощью Центра Интернета вещей как часть запроса, отправленного на шаге 3.

5. Служба уведомляется о результатах принятия потока устройством и устанавливает собственное подключение клиента WebSocket к конечной точке потоковой передачи. Аналогичным образом она получает URL-адрес конечной точки потоковой передачи и информацию об аутентификации из Центра Интернета вещей.

Во время описанного выше процесса подтверждения:
- Процесс подтверждения необходимо выполнить в течение 60 секунд (шаг 2–5), в противном случае подтверждение завершится ошибкой из-за истечения времени ожидания, а служба получит соответствующее уведомление.

- Когда поток будет создан, конечная точка потоковой передачи будет действовать в качестве прокси-сервера и будет передавать трафик между службой и устройством через соответствующие WebSocket-подключения.

- Устройству, как и службе, требуется исходящее подключение к основной конечной точке Центра Интернета вещей, а также к конечной точке потоковой передачи через порт 443. URL-адреса этих конечных точек доступны на вкладке *Обзор* на портале Центра Интернета вещей.

- Гарантии надежности и упорядоченности установленного потока точно такие же, как и предоставляемые TCP.

- Все подключения к Центру Интернета вещей и конечной точке потоковой передачи используют TLS и шифруются.

### <a name="termination-flow"></a>Завершение потока
Установленный поток завершается, когда любое из подключений по протоколу TCP к шлюзу отключается (службой или устройством). Это может произойти добровольно, если закрыть подключение WebSocket в программе устройства или службы, или недобровольно в случае истечения времени ожидания или сбоя процесса. После закрытия подключения устройства или службы к конечной точке потоковой передачи другое подключение TCP также будет принудительно разорвано. И служба, и устройство отвечают за повторное создание потока, если это необходимо.


## <a name="connectivity-requirements"></a>Требования к подключению

Как сторона устройства, так и сторона службы потока устройства должны иметь возможность устанавливать TLS-подключения к Центру Интернета вещей и его конечной точке потоковой передачи. Для этого требуется исходящее подключение к этим конечным точкам через порт 443. Имя узла, связанное с этими конечными точками, можно найти на вкладке *Обзор* Центра Интернета вещей, как показано на рисунке ниже: ![Замещающий текст](./media/iot-hub-device-streams-overview/device-stream-portal.png "Конечные точки потоков устройств")

Кроме того, информацию о конечных точках, в частности ключи `property.hostname` и `property.deviceStreams`, также можно получить с помощью Azure CLI в разделе свойств центра.

```azurecli-interactive
az iot hub devicestream show --name <YourIoTHubName>
```

Результат представляет собой объект JSON всех конечных точек, к которым службе и устройству центра необходимо подключаться для установки потока устройства.

```json
{
  "streamingEndpoints": [
    "https://<YourIoTHubName>.<region-stamp>.streams.azure-devices.net"
  ]
}
```

> [!NOTE]
> Убедитесь, что вы установили Azure CLI 2.0.57 или новее. Последнюю версию можно загрузить [здесь](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest).
> 

## <a name="whitelist-device-streaming-endpoints"></a>Добавление конечных точек потоковой передачи устройств в список разрешений

Как уже упоминалось [ранее](#Overview), устройство создает исходящее подключение к конечной точке потоковой передачи Центра Интернета вещей во время процесса запуска потоков устройств. Ваши брандмауэры устройства или сети должны разрешать исходящие подключения к шлюзу потоковой передачи через порт 443 (обратите внимание, что обмен данными осуществляется через подключение WebSocket, зашифрованное с помощью протокола TLS).

Имя узла конечной точки потоковой передачи устройства можно найти на портале Центра Интернета вещей Azure на вкладке "Обзор". ![Замещающий текст](./media/iot-hub-device-streams-overview/device-stream-portal.PNG "Конечные точки потоков устройств")

Кроме того, эти сведения можно найти с помощью Azure CLI:

```azurecli-interactive
az iot hub devicestream show --name <YourIoTHubName>
```

> [!NOTE]
> Убедитесь, что вы установили Azure CLI 2.0.57 или новее. Последнюю версию можно загрузить [здесь](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest).
> 

## <a name="troubleshoot-via-device-streams-activity-logs"></a>Устранение неполадок с использованием журналов действий потоков устройств

Вы можете настроить Azure Log Analytics собирать журнал действий потоков устройств в Центре Интернета вещей. Это может быть очень полезно в сценариях устранения неполадок.

Выполните следующие действия, чтобы настроить Azure Log Analytics для действий потоков устройств Центра Интернета вещей.

1. Перейдите на вкладку *Параметры диагностики* в Центре Интернета вещей и щелкните ссылку *Включить диагностику*.

  ![Замещающий текст](./media/iot-hub-device-streams-overview/device-streams-diagnostics-settings.PNG "Включение журналов диагностики")


2. Укажите имя для параметров диагностики и выберите параметр *Отправить в Log Analytics*. Вам будет предложено выбрать существующий ресурс Log Analytics или создать новый. Кроме того, установите флажок напротив *DeviceStreams* в списке.

    ![Замещающий текст](./media/iot-hub-device-streams-overview/device-streams-diagnostics.PNG "Включение журналов потоков устройств")

3. Теперь вы можете просматривать журналы потоков устройств на вкладке *Журналы* на портале Центра Интернета вещей. Журналы действий потоков устройств будут отображаться в таблице `AzureDiagnostics`, и для них установлено значение `Category=DeviceStreams`.

    <p>
Как показано ниже, идентификатор целевого устройства и результат операции также доступны в журналах.
    ![Замещающий текст](./media/iot-hub-device-streams-overview/device-streams-log-analytics.PNG "Доступ к журналам потоков устройств")


## <a name="regional-availability"></a>Доступ по регионам

Во время действия общедоступной предварительной версии потоки устройств Центра Интернета вещей доступны в регионах "Центральная часть США" и "Центральная часть США (EUAP)". Убедитесь, что центр создан в одном из этих регионов. 


## <a name="sdk-availability"></a>Доступность пакета SDK

Обе стороны каждого потока (на стороне устройства и службы) создают туннель, используя пакет SDK для Центра Интернета вещей. На этапе общедоступной предварительной версии клиенты могут выбрать пакет SDK для следующих языков:
- пакеты SDK для C и C# поддерживают потоки устройств на стороне устройства;

- пакеты SDK для NodeJS и C## поддерживают потоки устройств на стороне службы.


## <a name="iot-hub-device-stream-samples"></a>Примеры потоков устройств Центра Интернета вещей

Мы опубликовали два [примера для быстрого запуска](/azure/iot-hub), чтобы продемонстрировать использование потоков устройств приложениями.
* В примере *echo* демонстрируется программное использование потоков устройств (путем непосредственного вызова API пакета SDK).
* В примере с *локальным прокси-сервером* демонстрируется туннелирование трафика готовых клиентских и серверных приложений (например, SSH, RDP или веб) через потоки устройств.

Эти примеры более подробно описаны ниже.

### <a name="echo-sample"></a>Пример echo
В примере echo показано программное использование потоков устройства для отправки и получения байтов между службой и приложением устройства. Чтобы перейти к кратким руководствам, используйте приведенные ниже ссылки. Вы можете использовать программы службы и устройства на разных языках, например, программа устройства на языке C может работать со служебной программой на языке C#.

| SDK    | Служебная программа                                          | Программа устройства                                           |
|--------|----------------------------------------------------------|----------------------------------------------------------|
| C#     | [Ссылка](quickstart-device-streams-echo-csharp.md) | [Ссылка](quickstart-device-streams-echo-csharp.md) |
| Node.js | [Ссылка](quickstart-device-streams-echo-nodejs.md) | -                                                        |
| C      | -                                                        | [Ссылка](quickstart-device-streams-echo-c.md)      |

### <a name="local-proxy-sample-for-ssh-or-rdp"></a>Пример с локальным прокси-сервером (для SSH или RDP)
В примере с локальным прокси-сервером демонстрируется способ включить туннелирование существующего трафика приложения, к которому относится обмен данными между клиентом и программой сервера. Эта настройка работает для протоколов клиента и сервера, таких как SSH и RDP, в которых сторона службы выступает в качестве клиента (выполняя программы клиента SSH или RDP), а сторона устройства — в качестве сервера (выполняя управляющую программу SSH или программы сервера RDP). 

В этом разделе описывается использование потоков устройства для реализации сценариев SSH-подключения к устройству (случай с RDP или другими протоколами клиента или сервера аналогичен использованию соответствующего порта протокола).

В этой конфигурации используются две программы *локального прокси-сервера* (показаны на рисунке ниже), а именно: *локальный прокси-сервер устройства* и *локальный прокси-сервер службы*. Программы локального прокси-сервера отвечают за выполнение [подтверждения запуска потока устройства](#device-stream-creation-flow) с помощью Центра Интернета вещей и взаимодействуют с клиентом и управляющей программой SSH, используя обычные сокеты клиента и сервера.

![Замещающий текст](./media/iot-hub-device-streams-overview/iot-hub-device-streams-ssh.png "Настройка прокси-сервера потока устройства для SSH или RDP")

1. Пользователь выполняет локальный прокси-сервер службы для инициирования установки потока данных к устройству.

2. Локальный прокси-сервер устройства принимает запрос на инициацию потоковой передачи, а к конечной точке потоковой передачи Центра Интернета вещей устанавливается туннель (как обсуждалось выше).

3. Локальный прокси-сервер устройства подключается к конечной точке управляющей программы SSH, ожидая передачи данных к устройству через порт 22.

4. Локальный прокси-сервер службы ожидает передачи данных на указанный порт, в частности новых SSH-подключений от пользователя (в примере используется порт — 2222, но вы можете настроить любой доступный порт). Пользователь указывает клиент SSH на порте локального прокси-сервера в localhost.

### <a name="notes"></a>Примечания
- На описанных выше шагах создается сквозной туннель между клиентом SSH (справа) и управляющей программой SSH (слева). В рамках этого сквозного подключения выполняется отправка трафика в Центр Интернета вещей через поток устройства.

- Стрелки на рисунке указывают направление, в котором подключения устанавливаются между конечными точками. В частности, обратите внимание, что входящие подключения к устройству отсутствуют (часто блокируются брандмауэром).

- Использование порта 2222 в локальном прокси-сервере — произвольный выбор. Прокси-сервер можно настроить для использования любого другого доступного порта.

- Выбор порта зависит от протокола. Порт 22 в данном случае используется для протокола SSH. В случае с RDP необходимо использовать порт 3389. Это можно настроить в предоставленных примерах программ.

Воспользуйтесь ссылками ниже, чтобы узнать, как запустить программы локального прокси-сервера на выбранном языке. Аналогично [примеру echo](#echo-sample) можно запустить программы локальных прокси-серверов службы и устройства на разных языках, так как они полностью совместимы.

| SDK    | Локальный прокси-сервер службы                                       | Локальный прокси-сервер устройства                                |
|--------|-----------------------------------------------------------|---------------------------------------------------|
| C#     | [Ссылка](quickstart-device-streams-proxy-csharp.md)  | [Ссылка](quickstart-device-streams-proxy-csharp.md) |
| NodeJS | [Ссылка](quickstart-device-streams-proxy-nodejs.md)         | -                                                 |
| C      | -                                                         | [Ссылка](quickstart-device-streams-proxy-c.md)      |

## <a name="next-steps"></a>Дополнительная информация

По приведенным ниже ссылкам можно получить дополнительные сведения о потоках устройства:

> [!div class="nextstepaction"]
> [Видео о потоках устройств Интернета вещей (Channel 9)](https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fchannel9.msdn.com%2FShows%2FInternet-of-Things-Show%2FAzure-IoT-Hub-Device-Streams&data=02%7C01%7Crezas%40microsoft.com%7Cc3486254a89a43edea7c08d67a88bcea%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636831125031268909&sdata=S6u9qiehBN4tmgII637uJeVubUll0IZ4p2ddtG5pDBc%3D&reserved=0)
> [Краткое руководство по потокам устройств](/azure/iot-hub)
