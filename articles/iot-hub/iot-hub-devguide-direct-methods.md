---
title: Общие сведения о прямых методах Центра Интернета вещей Azure | Документация Майкрософт
description: Руководство разработчика. Использование прямых методов для вызова кода на устройствах из приложения-службы.
author: nberdy
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 07/17/2018
ms.author: rezas
ms.custom:
- amqp
- mqtt
- 'Role: Cloud Development'
- 'Role: IoT Device'
ms.openlocfilehash: 516b3bac5da2e078217d5c12f1efdf527b7c83a1
ms.sourcegitcommit: 3fc3457b5a6d5773323237f6a06ccfb6955bfb2d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/11/2020
ms.locfileid: "90029075"
---
# <a name="understand-and-invoke-direct-methods-from-iot-hub"></a>Общие сведения о прямых методах и информация о вызове этих методов из Центра Интернета вещей

Центр Интернета вещей дает возможность вызова прямых методов на устройствах из облака. Прямые методы представляют собой взаимодействие типа "запрос — ответ" с устройством, подобное вызову HTTP тем, что об успешном завершении или сбое становится известно немедленно (после указанного пользователем времени ожидания). Этот подход полезен для сценариев, в которых предпринимаемые немедленно действия различаются в зависимости от того, удалось ли устройству ответить.

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Каждый метод устройства предназначен для одного устройства. [Планирование заданий на нескольких устройствах](iot-hub-devguide-jobs.md) предоставляет способ вызова прямых методов на нескольких устройствах и планирование вызванных методов для отключенных устройств.

Любой пользователь с разрешениями на **подключение службы** в Центре Интернета вещей может вызвать метод на устройстве.

Прямые методы следуют шаблону "запрос и ответ" и предназначены для взаимодействия, требующего немедленного подтверждения результата. Например, для интерактивного управления устройством (включение вентилятора).

Чтобы принять решение об использовании требуемых свойств, прямых методов или сообщений, отправляемых из облака на устройство, см. сведения в [руководстве по обмену данными между облаком и устройством](iot-hub-devguide-c2d-guidance.md).

## <a name="method-lifecycle"></a>Жизненный цикл метода

Прямые методы реализуются на устройстве. Чтобы процесс создания экземпляра прошел удачно, может потребоваться указать входные данные в полезных данных метода или не указывать их. Вызов прямого метода осуществляется через обращенный к службе URI (`{iot hub}/twins/{device id}/methods/`). Устройство получает прямые методы через раздел MQTT для устройства (`$iothub/methods/POST/{method name}/`) или ссылки AMQP (свойств приложения `IoThub-methodname` и `IoThub-status`).

> [!NOTE]
> При вызове прямого метода на устройстве имена и значения свойств могут содержать только печатаемые буквенно-цифровые знаки US-ASCII, кроме любого из следующих: ``{'$', '(', ')', '<', '>', '@', ',', ';', ':', '\', '"', '/', '[', ']', '?', '=', '{', '}', SP, HT}``.
> 

Прямые методы являются синхронными и либо успешно, либо завершаются сбоем по истечении времени ожидания (по умолчанию — 30 секунд, устанавливаемое в интервале от 5 до 300 секунд). Они полезны в интерактивных сценариях, когда нужно, чтобы устройство отвечало, только если оно находится в сети и принимает команды, такие как включение света с помощью телефона. В этих случаях об успешном или неудачном выполнении нужно узнавать немедленно, чтобы облачная служба смогла как можно быстрее отреагировать с учетом результата. В результате выполнения метода устройство может возвратить некоторый текст сообщения. Однако это действие не является обязательным для метода. Упорядочивание или обеспечение какой-либо семантики параллелизма при вызове метода не гарантировано.

Прямые методы поддерживают только протокол HTTPS на стороне облака и MQTT, AMQP, MQTT через WebSockets или AMQP через WebSockets со стороны устройства.

Полезными данными для запросов и ответов метода является документ JSON объемом не более 128 КБ.

## <a name="invoke-a-direct-method-from-a-back-end-app"></a>Вызов прямого метода из серверного приложения

Теперь необходимо вызвать прямой метод из внутреннего приложения.

### <a name="method-invocation"></a>Вызов метода

Вызов прямого метода на устройстве является вызовом HTTPS, который состоит из следующих элементов:

* *URI перенаправления* конкретного устройства вместе с [версией API](https://docs.aws.amazon.com/cli/latest/reference/iot1click-devices/invoke-device-method.html):

    ```http
    https://fully-qualified-iothubname.azure-devices.net/twins/{deviceId}/methods?api-version=2018-06-30
    ```

* *метод* POST;

* *Заголовки* , которые содержат разрешения, идентификатор запроса, тип содержимого и кодировку содержимого.

* прозрачный *текст* JSON в следующем формате:

    ```json
    {
        "methodName": "reboot",
        "responseTimeoutInSeconds": 200,
        "payload": {
            "input1": "someInput",
            "input2": "anotherInput"
        }
    }
    ```

Значение, указанное `responseTimeoutInSeconds` в запросе, — это период времени, в течение которого служба центра Интернета вещей должна ожидать завершения прямого выполнения метода на устройстве. Установите это время ожидания как минимум до ожидаемого времени выполнения прямого метода на устройстве. Если параметр timeout не указан, используется значение по умолчанию, равное 30 секундам. Минимальное и максимальное значения для `responseTimeoutInSeconds` — 5 и 300 секунд соответственно.

Значение, указанное `connectTimeoutInSeconds` в запросе, — это время, необходимое для вызова прямого метода, который служба центра Интернета вещей должна ожидать, чтобы перевести отключенное устройство в режим «в сети». Значение по умолчанию — 0. Это означает, что устройства должны быть уже подключены к сети при вызове прямого метода. Максимальное значение для `connectTimeoutInSeconds` равно 300 секунд.

#### <a name="example"></a>Пример

Этот пример позволит безопасно инициировать запрос на вызов прямого метода на устройстве IoT, зарегистрированном в центре Интернета вещей Azure.

Для начала используйте [расширение Интернета вещей Microsoft Azure для Azure CLI](https://github.com/Azure/azure-iot-cli-extension) , чтобы создать SharedAccessSignature.

```bash
az iot hub generate-sas-token -n <iothubName> -du <duration>
```

Затем замените заголовок Authorization вновь созданным SharedAccessSignature, а затем измените `iothubName` `deviceId` `methodName` Параметры, и `payload` в соответствии с вашей реализацией в приведенной `curl` ниже команде example.  

```bash
curl -X POST \
  https://<iothubName>.azure-devices.net/twins/<deviceId>/methods?api-version=2018-06-30 \
  -H 'Authorization: SharedAccessSignature sr=iothubname.azure-devices.net&sig=x&se=x&skn=iothubowner' \
  -H 'Content-Type: application/json' \
  -d '{
    "methodName": "reboot",
    "responseTimeoutInSeconds": 200,
    "payload": {
        "input1": "someInput",
        "input2": "anotherInput"
    }
}'
```

Выполните измененную команду, чтобы вызвать указанный прямой метод. Успешные запросы будут возвращать код состояния HTTP 200.

> [!NOTE]
> В приведенном выше примере демонстрируется вызов прямого метода на устройстве.  Если вы хотите вызвать прямой метод в модуле IoT Edge, вам потребуется изменить запрос URL-адреса, как показано ниже:

```bash
https://<iothubName>.azure-devices.net/twins/<deviceId>/modules/<moduleName>/methods?api-version=2018-06-30
```
### <a name="response"></a>Ответ

Внутреннее приложение получает ответ, включающий в себя следующие элементы:

* *Код состояния HTTP*:
  * 200 означает успешное выполнение прямого метода;
  * 404 указывает, что идентификатор устройства является недопустимым или что устройство не было подключено к сети при вызове прямого метода, и в `connectTimeoutInSeconds` дальнейшем (используйте сопровождающее сообщение об ошибке, чтобы понять причину ошибки);
  * 504 означает, что время ожидания шлюза вызвано тем, что устройство не отвечает на вызов прямого метода в `responseTimeoutInSeconds` .

* *Заголовки* , содержащие eTag, идентификатор запроса, тип содержимого и кодировку содержимого.

* *текст* JSON в следующем формате:

    ```json
    {
        "status" : 201,
        "payload" : {...}
    }
    ```

    Значения `status` и `body` предоставляются устройством и используются для ответа, который содержит код состояния устройства и/или описание.

### <a name="method-invocation-for-iot-edge-modules"></a>Вызов метода для модулей IoT Edge

Вызов прямых методов с помощью идентификатора модуля поддерживается в [клиентском пакете SDK для службы Центра Интернета вещей для C#](https://www.nuget.org/packages/Microsoft.Azure.Devices/).

Для этой цели используйте метод `ServiceClient.InvokeDeviceMethodAsync()`, а затем передайте его в `deviceId` и `moduleId` в качестве параметров.

## <a name="handle-a-direct-method-on-a-device"></a>Обработка прямого метода на устройстве

Давайте рассмотрим, как обрабатывать прямой метод на устройстве Интернета вещей.

### <a name="mqtt"></a>MQTT

Следующий раздел касается протокола MQTT.

#### <a name="method-invocation"></a>Вызов метода

Устройства получают запросы на прямой метод в разделе MQTT: `$iothub/methods/POST/{method name}/?$rid={request id}`. Количество подписок на каждом устройстве ограничено 5. Поэтому рекомендуется не подписываться на каждый прямой метод по отдельности. Вместо этого рассмотрите возможность подписки на `$iothub/methods/POST/#` и отфильтруйте отправленные сообщения на имена необходимых методов.

Устройство получает текст следующего формата:

```json
{
    "input1": "someInput",
    "input2": "anotherInput"
}
```

Запросы метода имеют нулевой уровень качества обслуживания.

#### <a name="response"></a>Ответ

Устройство отправляет ответы в `$iothub/methods/res/{status}/?$rid={request id}`, где:

* свойство `status` — это состояние выполнения метода, которое поддерживает устройство;

* свойство `$rid` — это идентификатор запроса из вызова метода, полученного от Центра Интернета вещей.

Текст задает устройство. Он может находиться в любом состоянии.

### <a name="amqp"></a>AMQP

Следующий раздел касается протокола AMQP.

#### <a name="method-invocation"></a>Вызов метода

Устройство получает запросы на прямые методы путем создания ссылки для адреса `amqps://{hostname}:5671/devices/{deviceId}/methods/deviceBound`.

Сообщение AMQP приходит на ссылку приема, представляющую запрос метода. Он содержит следующие подразделы:

* свойство идентификатора корреляции, содержащее идентификатор запроса, который нужно передать обратно с соответствующим ответом метода;

* свойство приложения с именем `IoThub-methodname`, которое содержит имя вызываемого метода;

* текст сообщения AMQP с полезными данными метода в формате JSON.

#### <a name="response"></a>Ответ

Устройство создает ссылку на отправку для возврата ответа метода по адресу `amqps://{hostname}:5671/devices/{deviceId}/methods/deviceBound`.

Ответ метода возвращается на отправляющем канале и структурирован следующим образом:

* Свойство идентификатора корреляции, которое содержит идентификатор запроса, переданный в сообщении запроса метода.

* свойство приложения с именем `IoThub-status`, которое содержит состояние метода, указанное пользователем;

* содержание сообщения AMQP с ответом метода в формате JSON.

## <a name="additional-reference-material"></a>Дополнительные справочные материалы

Другие справочные статьи в руководстве разработчика для Центра Интернета вещей:

* В [справочнике по конечным точкам Центра Интернета вещей](iot-hub-devguide-endpoints.md) содержатся сведения о конечных точках, которые каждый центр Интернета вещей предоставляет для операций управления и среды выполнения.

* Статья [Руководство. Квоты и регулирование в Центре Интернета вещей](iot-hub-devguide-quotas-throttling.md) содержит сведения о применяемых квотах и ожидаемом поведении регулирования при использовании Центра Интернета вещей.

* В статье о [пакетах SDK для устройств и служб Azure IoT](iot-hub-devguide-sdks.md) указаны различные языковые пакеты SDK, которые можно использовать при разработке приложений для устройств и служб, взаимодействующих с Центром Интернета вещей.

* [Справочник по языку запросов Центра Интернета вещей для двойников устройств, заданий и маршрутизации сообщений](iot-hub-devguide-query-language.md) содержит сведения о языке запросов, который можно использовать для получения сведений о двойниках устройств и заданиях из Центра Интернета вещей.

* Статья [Взаимодействие с Центром Интернета вещей с помощью протокола MQTT](iot-hub-mqtt-support.md) содержит дополнительные сведения о поддержке протокола MQTT в Центре Интернета вещей.

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы узнали, как использовать прямые методы, вас может заинтересовать следующая статья в руководстве разработчика для Центра Интернета вещей:

* [Планирование заданий на нескольких устройствах](iot-hub-devguide-jobs.md)

Если вы хотели бы применить на практике некоторые основные понятия, описанные в этой статье, можно просмотреть следующее руководство по Центру Интернета вещей:

* [Использование прямых методов](quickstart-control-device-node.md)
* [Управление устройствами с помощью средств Azure IoT для VS Code](iot-hub-device-management-iot-toolkit.md)
