---
title: Визуализация данных центра Интернета вещей в режиме реального времени в веб-приложении
description: Используйте веб-приложение для визуализации данных о температуре и влажности, собираемых с датчика и отправляемых в центр Интернета вещей.
author: robinsh
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.tgt_pltfrm: arduino
ms.date: 05/31/2019
ms.author: robinsh
ms.openlocfilehash: 073a766662b2ead4b816276fa7fda6dc5e6caca7
ms.sourcegitcommit: 44c2a964fb8521f9961928f6f7457ae3ed362694
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/12/2019
ms.locfileid: "73954644"
---
# <a name="visualize-real-time-sensor-data-from-your-azure-iot-hub-in-a-web-application"></a>Визуализация данных датчика в реальном времени из центра Интернета вещей Azure в веб-приложении

![Сквозная схема](./media/iot-hub-live-data-visualization-in-web-apps/1_iot-hub-end-to-end-diagram.png)

[!INCLUDE [iot-hub-get-started-note](../../includes/iot-hub-get-started-note.md)]

## <a name="what-you-learn"></a>Что вы узнаете

В этом руководстве вы узнаете, как визуализировать данные датчика в реальном времени, получаемые центром Интернета вещей, с помощью веб-приложения Node. js, работающего на локальном компьютере. После локального запуска веб-приложения можно при необходимости выполнить действия по размещению веб-приложения в службе приложений Azure. Если вы хотите визуализировать данные, поступающие с датчиков в реальном времени, в Центре Интернета вещей с помощью Power BI, см. сведения в [этой статье](iot-hub-live-data-visualization-in-power-bi.md).

## <a name="what-you-do"></a>Что нужно сделать

* Добавление группы потребителей в центр Интернета вещей, которую веб-приложение будет использовать для чтения данных датчиков
* Скачивание кода веб-приложения из GitHub
* Изучение кода веб-приложения
* Настройка переменных среды для хранения артефактов центра Интернета вещей, необходимых веб-приложению
* Запуск веб-приложения на компьютере разработки
* Открытие веб-страницы для просмотра данных о температуре и влажности в реальном времени из центра Интернета вещей
* Используемых Использование Azure CLI для размещения веб-приложения в службе приложений Azure

## <a name="what-you-need"></a>Необходимые элементы

* Заполните учебник [Raspberry Pi Online Simulator](iot-hub-raspberry-pi-web-simulator-get-started.md) или одно из учебников по устройствам. Например, [Raspberry Pi с Node. js](iot-hub-raspberry-pi-kit-node-get-started.md). Они охватывают следующие требования.

  * активная подписка Azure;
  * Центр Интернета вещей в подписке;
  * клиентское приложение, которое отправляет сообщения в Центр Интернета вещей.

* [Скачайте Git](https://www.git-scm.com/downloads).

* Действия, описанные в этой статье, предполагают наличие компьютера, на котором выполняется разработка Windows. Однако эти действия можно легко выполнить в системе Linux в предпочтительной оболочке.

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

Выполните следующую команду, чтобы добавить расширение Интернета вещей Microsoft Azure для Azure CLI в экземпляр Cloud Shell. Расширение Интернета вещей добавляет в Azure CLI специальные команды Центра Интернета вещей, IoT Edge и службы подготовки устройств Интернета вещей (DPS).

```azurecli-interactive
az extension add --name azure-cli-iot-ext
```

## <a name="add-a-consumer-group-to-your-iot-hub"></a>Добавление группы потребителей в Центр Интернета вещей

[Группы потребителей](https://docs.microsoft.com/azure/event-hubs/event-hubs-features#event-consumers) предоставляют независимые представления в поток событий, позволяющие приложениям и службам Azure независимо потреблять данные из одной и той же конечной точки концентратора событий. В этом разделе вы добавите группу потребителей в встроенную конечную точку центра Интернета вещей, которую веб-приложение будет использовать для чтения данных.

Выполните следующую команду, чтобы добавить группу потребителей во встроенную конечную точку центра Интернета вещей:

```azurecli-interactive
az iot hub consumer-group create --hub-name YourIoTHubName --name YourConsumerGroupName
```

Запишите выбранное имя, оно понадобится позже в этом руководстве.

## <a name="get-a-service-connection-string-for-your-iot-hub"></a>Получение строки подключения службы для центра Интернета вещей

Центры Интернета вещей создаются с использованием нескольких политик доступа по умолчанию. Одна из таких политик — политика **службы** , которая предоставляет службе достаточные разрешения на чтение и запись конечных точек центра Интернета вещей. Выполните следующую команду, чтобы получить строку подключения для центра Интернета вещей, которая соответствует политике службы:

```azurecli-interactive
az iot hub show-connection-string --hub-name YourIotHub --policy-name service
```

Строка подключения должна выглядеть следующим образом:

```javascript
"HostName={YourIotHubName}.azure-devices.net;SharedAccessKeyName=service;SharedAccessKey={YourSharedAccessKey}"
```

Запишите строку подключения службы, она понадобится позже в этом руководстве.

## <a name="download-the-web-app-from-github"></a>Скачивание веб-приложения с сайта GitHub

Откройте командное окно и введите следующие команды, чтобы скачать пример из GitHub и перейти в каталог примеров:

```cmd
git clone https://github.com/Azure-Samples/web-apps-node-iot-hub-data-visualization.git
cd web-apps-node-iot-hub-data-visualization
```

## <a name="examine-the-web-app-code"></a>Изучение кода веб-приложения

В каталоге Web-Apps-node-IOT-Hub-Data-визуализация откройте веб-приложение в любимом редакторе. Ниже показана структура файла, отображаемая в VS Code.

![Структура файла веб-приложения](./media/iot-hub-live-data-visualization-in-web-apps/web-app-files.png)

Уделите время изучению следующих файлов:

* **Server. js** — это сценарий на стороне службы, который инициализирует веб-сокет и класс оболочки концентратора событий. Он обеспечивает обратный вызов класса оболочки концентратора событий, который используется классом для передачи входящих сообщений в веб-сокет.

* **Евент-ХУБ-Реадер. js** — это сценарий на стороне службы, который подключается к встроенной конечной точке центра Интернета вещей, используя указанную строку подключения и группу потребителей. Он извлекает DeviceId и EnqueuedTimeUtc из метаданных во входящих сообщениях, а затем передает сообщение с помощью метода обратного вызова, зарегистрированного Server. js.

* **Чарт-девице-Дата. js** — это клиентский сценарий, который прослушивает веб-сокет, отслеживает каждый DeviceID и сохраняет последние 50 точек входящих данных для каждого устройства. Затем он привязывает выбранные данные устройства к объекту диаграммы.

* **Index. HTML** обрабатывает макет пользовательского интерфейса для веб-страницы и ссылается на необходимые скрипты для логики на стороне клиента.

## <a name="configure-environment-variables-for-the-web-app"></a>Настройка переменных среды для веб-приложения

Для чтения данных из центра Интернета вещей веб-приложению требуется строка подключения центра Интернета вещей и имя группы потребителей, с которой она должна читаться. Они получают эти строки из среды процесса в следующих строках в Server. js:

```javascript
const iotHubConnectionString = process.env.IotHubConnectionString;
const eventHubConsumerGroup = process.env.EventHubConsumerGroup;
```

Задайте переменные среды в окне командной строки с помощью следующих команд. Замените значения заполнителей строкой подключения службы для центра Интернета вещей и именем созданной ранее группы потребителей. Не следует заключать в кавычки строки.

```cmd
set IotHubConnectionString=YourIoTHubConnectionString
set EventHubConsumerGroup=YourConsumerGroupName
```

## <a name="run-the-web-app"></a>Запуск веб-приложения

1. Убедитесь, что устройство работает и отправляет данные.

2. В командном окне выполните следующие строки, чтобы скачать и установить указанные на них пакеты и запустить веб-сайт:

   ```cmd
   npm install
   npm start
   ```

3. В консоли должны отобразиться выходные данные, указывающие, что веб-приложение успешно подключено к центру Интернета вещей и прослушивает порт 3000:

   ![Веб-приложение запущено в консоли](./media/iot-hub-live-data-visualization-in-web-apps/web-app-console-start.png)

## <a name="open-a-web-page-to-see-data-from-your-iot-hub"></a>Открытие веб-страницы для просмотра данных из центра Интернета вещей

Откройте браузер, чтобы `http://localhost:3000`.

В списке **выберите устройство** выберите устройство, чтобы просмотреть выполняющийся график последних 50 точек данных о температуре и влажности, отправленных устройством в центр Интернета вещей.

![Страница веб-приложения с данными о температуре и влажности, полученными в реальном времени](./media/iot-hub-live-data-visualization-in-web-apps/web-page-output.png)

Кроме того, в консоли отображаются выходные данные, которые показывают сообщения, которые веб-приложение передает клиенту браузера:  

![Выходные данные вещания веб-приложения на консоли](./media/iot-hub-live-data-visualization-in-web-apps/web-app-console-broadcast.png)

## <a name="host-the-web-app-in-app-service"></a>Размещение веб-приложения в службе приложений

[Функция веб-приложений службы приложений Azure](https://docs.microsoft.com/azure/app-service/overview) предоставляет платформу как услугу (PaaS) для размещения веб-приложений. Веб-приложения, размещенные в службе приложений Azure, могут использовать преимущества мощных функций Azure, таких как дополнительная безопасность, балансировка нагрузки и масштабируемость, а также решения Azure и партнерских DevOps решений, таких как непрерывное развертывание, Управление пакетами и т. д. Служба приложений Azure поддерживает веб-приложения, разработанные на многих популярных языках и развернутые в инфраструктуре Windows или Linux.

В этом разделе вы подготавливаете веб-приложение в службе приложений и развертываете свой код с помощью команд Azure CLI. Подробные сведения о командах, используемых в документации [AZ webapp](https://docs.microsoft.com/cli/azure/webapp?view=azure-cli-latest) , см. здесь. Прежде чем начать, убедитесь, что вы выполнили действия по [добавлению группы ресурсов в центр Интернета вещей](#add-a-consumer-group-to-your-iot-hub), [получите строку подключения службы для центра Интернета вещей](#get-a-service-connection-string-for-your-iot-hub)и [Скачайте веб-приложение с сайта GitHub](#download-the-web-app-from-github).

1. [План службы приложений](https://docs.microsoft.com/azure/app-service/overview-hosting-plans) определяет набор ресурсов вычислений для приложения, размещенного в службе приложений для запуска. В этом руководстве мы используем уровень разработчика и Free для размещения веб-приложения. На уровне Free веб-приложение работает на общих ресурсах Windows с другими приложениями службы приложений, включая приложения других клиентов. Azure также предлагает планы службы приложений для развертывания веб-приложений на базе ресурсов Linux. Этот шаг можно пропустить, если у вас уже есть план службы приложений, который вы хотите использовать.

   Чтобы создать план службы приложений с помощью уровня "бесплатный" Windows, выполните следующую команду. Используйте ту же группу ресурсов, в которой находится центр Интернета вещей. Имя плана службы может содержать прописные и строчные буквы, цифры и дефисы.

   ```azurecli-interactive
   az appservice plan create --name <app service plan name> --resource-group <your resource group name> --sku FREE
   ```

2. Теперь подготавливайте веб-приложение в плане службы приложений. Параметр `--deployment-local-git` позволяет отправлять и развертывать код веб-приложения из репозитория Git на локальном компьютере. Имя веб-приложения должно быть глобально уникальным и может содержать буквы верхнего и нижнего регистра, цифры и дефисы.

   ```azurecli-interactive
   az webapp create -n <your web app name> -g <your resource group name> -p <your app service plan name> --deployment-local-git
   ```

3. Теперь добавьте параметры приложения для переменных среды, которые указывают строку подключения центра Интернета вещей и группу потребителей концентратора событий. Отдельные параметры разделяются пробелами в параметре `-settings`. Используйте строку подключения службы для центра Интернета вещей и группу потребителей, созданную ранее в этом руководстве. Не заключайте значения в кавычки.

   ```azurecli-interactive
   az webapp config appsettings set -n <your web app name> -g <your resource group name> --settings EventHubConsumerGroup=<your consumer group> IotHubConnectionString=<your IoT hub connection string>
   ```

4. Включите протокол веб-сокетов для веб-приложения и настройте веб-приложение на получение только запросов HTTPS (HTTP-запросы перенаправляются на HTTPS).

   ```azurecli-interactive
   az webapp config set -n <your web app name> -g <your resource group name> --web-sockets-enabled true
   az webapp update -n <your web app name> -g <your resource group name> --https-only true
   ```

5. Чтобы развернуть код в службе приложений, вы будете использовать [учетные данные развертывания на уровне пользователя](https://docs.microsoft.com/azure/app-service/deploy-configure-credentials). Учетные данные развертывания на уровне пользователя отличаются от учетных данных Azure и используются для локальных и FTP-развертываний Git в приложении. После настройки они будут действительны во всех приложениях службы приложений во всех подписках в учетной записи Azure. Если вы ранее настроили учетные данные развертывания на уровне пользователя, их можно использовать.

   Если вы ранее не настроили учетные данные развертывания на уровне пользователя или забыли пароль, выполните следующую команду. Имя пользователя развертывания должно быть уникальным в пределах Azure и не должно содержать символ "@" для локальных push-уведомлений Git. При появлении запроса введите и подтвердите новый пароль. Пароль должен содержать не менее восьми символов и включать два из трех следующих элементов: буквы, цифры и символы.

   ```azurecli-interactive
   az webapp deployment user set --user-name <your deployment user name>
   ```

6. Получите URL-адрес Git, который будет использоваться для отправки кода в службу приложений.

   ```azurecli-interactive
   az webapp deployment source config-local-git -n <your web app name> -g <your resource group name>
   ```

7. Добавьте удаленный объект в клон, который ссылается на репозиторий Git для веб-приложения в службе приложений. Для \<URL-адреса клона Git\>используйте URL-адрес, возвращенный на предыдущем шаге. В окне командной строки выполните следующую команду.

   ```cmd
   git remote add webapp <Git clone URL>
   ```

8. Чтобы развернуть код в службе приложений, введите в командном окне следующую команду. При появлении запроса на ввод учетных данных введите учетные данные развертывания на уровне пользователя, созданные на шаге 5. Убедитесь, что вы отправитесь в главную ветвь службы приложений Remote.

    ```cmd
    git push webapp master:master
    ```

9. Ход выполнения развертывания будет обновлен в окне командной строки. Успешное развертывание завершается строками, аналогичными приведенным ниже.

    ```cmd
    remote:
    remote: Finished successfully.
    remote: Running post deployment command(s)...
    remote: Deployment successful.
    To https://contoso-web-app-3.scm.azurewebsites.net/contoso-web-app-3.git
    6b132dd..7cbc994  master -> master
    ```

10. Выполните следующую команду, чтобы запросить состояние веб-приложения и убедиться, что оно выполняется:

    ```azurecli-interactive
    az webapp show -n <your web app name> -g <your resource group name> --query state
    ```

11. Откройте браузер и перейдите по адресу `https://<your web app name>.azurewebsites.net`. Веб-страница, похожая на ту, которая была показана при локальном запуске веб-приложения. При условии, что устройство работает и отправляет данные, вы увидите график с 50 последними считываниями температуры и влажности, отправленными устройством.

## <a name="troubleshooting"></a>Устранение неполадок

При возникновении каких либо проблем с этим примером выполните действия, описанные в следующих разделах. Если у вас по-прежнему возникают проблемы, отправьте нам отзыв в конце этого раздела.

### <a name="client-issues"></a>Проблемы с клиентом

* Если устройство не отображается в списке или граф не рисуется, убедитесь, что на устройстве выполняется код устройства.

* В браузере откройте средства разработчика (во многих браузерах клавишей F12 откроется) и найдите консоль. Ищите все предупреждения или ошибки, напечатанные там.

* Сценарий на стороне клиента можно отладить в/ЖС/чат-девице-Дата.ЖС.

### <a name="local-website-issues"></a>Проблемы с локальным веб-сайтом

* Просмотрите выходные данные в окне, в котором был запущен узел для вывода консоли.

* Отладка серверного кода, в частности Server. js и/скриптс/Евент-ХУБ-Реадер.ЖС.

### <a name="azure-app-service-issues"></a>Проблемы со службой приложений Azure

* В портал Azure перейдите к веб-приложению. В разделе **мониторинг** на левой панели выберите **журналы службы приложений**. Включите **ведение журнала приложений (файловая система)** в значение Вкл., установите для параметра **уровень** значение ошибка, а затем нажмите кнопку **сохранить**. Затем откройте **поток журнала** (в разделе **мониторинг**).

* Из веб-приложения в портал Azure в разделе **средства разработки** выберите **консоль** и проверьте версии node и npm с `node -v` и `npm -v`.

* Если появится сообщение об ошибке "не удается найти пакет", то вы могли выполнить шаги в неопределенном порядке. При развертывании сайта (с `git push`) служба приложений запускается `npm install`, которая выполняется на основе текущей версии узла, которая была настроена. Если это позднее изменилось в конфигурации, необходимо внести небессмысленные изменения в код и отправить его снова.

## <a name="next-steps"></a>Дополнительная информация

Вы успешно использовали веб-приложение для визуализации данных датчика, полученных в реальном времени, из Центра Интернета вещей.

Еще один способ визуализации данных из центра Интернета вещей Azure см. [в статье использование Power BI для визуализации данных датчика в реальном времени из центра Интернета вещей](iot-hub-live-data-visualization-in-power-bi.md).

[!INCLUDE [iot-hub-get-started-next-steps](../../includes/iot-hub-get-started-next-steps.md)]
