---
title: Сведения о маршрутизации сообщений Центра Интернета вещей Azure | Документация Майкрософт
description: Руководство разработчика по использованию маршрутизации сообщений для отправки с устройства в облако. Эта статья содержит сведения об отправке данных телеметрии и других данных.
author: ash2017
manager: briz
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 05/15/2019
ms.author: asrastog
ms.openlocfilehash: e4f1797d600a226eb152a464efe4da8ddbdb6207
ms.sourcegitcommit: c62a68ed80289d0daada860b837c31625b0fa0f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/05/2019
ms.locfileid: "73606228"
---
# <a name="use-iot-hub-message-routing-to-send-device-to-cloud-messages-to-different-endpoints"></a>Использование маршрутизации сообщений центра Интернета вещей для отправки сообщений с устройства в облако в разные конечные точки

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-partial.md)]

Маршрутизация сообщений позволяет отправлять сообщения с устройств в облачные службы автоматическим, масштабируемым и надежным способом. Маршрутизацию сообщений можно использовать в следующих случаях. 

* **Отправка сообщений и событий телеметрии устройства**, а именно событий жизненного цикла устройства и событий изменения двойника устройства для встроенной и пользовательских конечных точек. Дополнительные сведения о [конечных точках маршрутизации](#routing-endpoints).

* **Фильтрация данных перед их отправкой по различным конечным точкам** путем применения полнофункциональных запросов. Маршрутизация сообщений позволяет запрашивать свойства сообщения, текст сообщения, теги и свойства двойников устройств. Дополнительные сведения об использовании [запросов для маршрутизации сообщений](iot-hub-devguide-routing-query-syntax.md).

Для маршрутизации сообщений Центру Интернета вещей требуется доступ на запись к этим конечным точкам служб. При настройке конечных точек через портал Azure необходимые разрешения добавляются автоматически. Настройте в службах поддержку ожидаемой пропускной способности. Например, если в качестве пользовательской конечной точки используются концентраторы событий, необходимо настроить **единицы пропускной способности** для этого концентратора событий, чтобы он мог управлять входящими событиями, которые планируется отправить через маршрутизацию сообщений центра Интернета вещей. Аналогично, при использовании очереди служебной шины в качестве конечной точки необходимо настроить **максимальный размер** , чтобы очередь могла вместить все входящий данных, пока она не будет егресседа потребителями. При первой настройке решения Интернета вещей может потребоваться отслеживать дополнительные конечные точки, а затем вносить необходимые изменения с учетом реальной нагрузки.

Центр Интернета вещей задает [общий формат](iot-hub-devguide-messages-construct.md) для всех случаев обмена сообщениями с устройства в облако для взаимодействия по различным протоколам. Если сообщение соответствует нескольким маршрутам, которые указывают на одну и ту же конечную точку, то Центр Интернета вещей доставляет сообщение в эту конечную точку только один раз. Таким образом, не требуется настраивать дедупликацию для очереди или раздела служебной шины. В секционированных очередях сопоставление секций гарантирует упорядочивание сообщений. В этом руководстве вы научитесь [настраивать маршрутизацию сообщений](tutorial-routing.md).

## <a name="routing-endpoints"></a>Конечные точки маршрутизации

В Центре Интернета вещей имеется встроенная конечная точка по умолчанию (**messages/events**), совместимая с Центрами событий. Вы можете создать [пользовательские конечные точки](iot-hub-devguide-endpoints.md#custom-endpoints) для маршрутизации сообщений, связав с Центром Интернета вещей другие службы в подписке. 

Каждое сообщение направляется всем конечным точкам, которым соответствуют запросы маршрутизации. Иными словами, сообщение может маршрутизироваться к нескольким конечным точкам.

Сейчас Центр Интернета вещей поддерживает следующие службы в качестве пользовательских конечных точек:

### <a name="built-in-endpoint"></a>Встроенная конечная точка

Вы можете использовать стандартную [интеграцию Центров событий и пакеты SDK](iot-hub-devguide-messages-read-builtin.md), чтобы отправлять сообщения с устройства в облако из встроенной конечной точки (**messages/events**). После создания маршрута данные перестают передаваться во встроенную конечную точку, если только маршрут не создан для этой конечной точки.

### <a name="azure-storage"></a>Хранилище Azure

Существует два центра Интернета вещей служб хранилища, которые могут маршрутизировать сообщения в [хранилище BLOB-объектов Azure](../storage/blobs/storage-blobs-introduction.md) и учетные записи [Azure Data Lake Storage 2-го поколения](../storage/blobs/data-lake-storage-introduction.md) (ADLS 2-го поколения). Учетные записи Azure Data Lake Storage являются иерархическими учетными записями хранения с поддержкой [пространств имен](../storage/blobs/data-lake-storage-namespace.md), созданными на основе хранилища BLOB-объектов. Оба они используют большие двоичные объекты для хранения.

Центр Интернета вещей поддерживает запись данных в службу хранилища Azure в формате [Apache Avro](https://avro.apache.org/) , а также в формате JSON. По умолчанию используется AVRO. Формат кодирования можно задать только при настройке конечной точки хранилища BLOB-объектов. Формат не может быть изменен для существующей конечной точки. При использовании кодировки JSON необходимо задать для contentType значение **Application/JSON** , а ContentEncoding **— UTF-8** в [свойствах системы](iot-hub-devguide-routing-query-syntax.md#system-properties)сообщений. Оба этих значения не учитывают регистр. Если кодировка содержимого не задана, центр Интернета вещей будет записывать сообщения в формате Base 64. Вы можете выбрать формат кодировки с помощью центра Интернета вещей создание или обновление REST API, в частности [раутингсторажеконтаинерпропертиес](https://docs.microsoft.com/rest/api/iothub/iothubresource/createorupdate#routingstoragecontainerproperties), портал Azure, [Azure CLI](https://docs.microsoft.com/cli/azure/iot/hub/routing-endpoint?view=azure-cli-latest)или [Azure PowerShell](https://docs.microsoft.com/powershell/module/az.iothub/add-aziothubroutingendpoint?view=azps-1.3.0). На следующей схеме показано, как выбрать формат кодировки в портал Azure.

![Кодирование конечной точки хранилища BLOB-объектов](./media/iot-hub-devguide-messages-d2c/blobencoding.png)

Центр Интернета вещей пакетно передает сообщения и записывает данные в хранилище каждый раз, когда пакет достигнет определенного размера или прошло определенное время. По умолчанию Центр Интернета вещей использует следующее соглашение об именовании файлов: 

```
{iothub}/{partition}/{YYYY}/{MM}/{DD}/{HH}/{mm}
```

Вы можете применять любое соглашение об именовании файлов, однако необходимо использовать все перечисленные токены. Центр Интернета вещей будет записывать пустой большой двоичный объект, если нет данных для записи.

Мы рекомендуем прикрепить контейнеры хранилища и затем перепроходить их, чтобы убедиться, что все контейнеры считаны без принятия каких либо предположений о секции. Диапазон секций может измениться в процессе [инициированной корпорацией Майкрософт отработки отказа](iot-hub-ha-dr.md#microsoft-initiated-failover) или при [переходе на другой ресурс вручную](iot-hub-ha-dr.md#manual-failover) с помощью Центра Интернета вещей. Для перечисления списка больших двоичных объектов можно использовать [API List blobs](https://docs.microsoft.com/rest/api/storageservices/list-blobs) . Ознакомьтесь со следующим примером в качестве руководства.

```csharp
public void ListBlobsInContainer(string containerName, string iothub)
{
    var storageAccount = CloudStorageAccount.Parse(this.blobConnectionString);
    var cloudBlobContainer = storageAccount.CreateCloudBlobClient().GetContainerReference(containerName);
    if (cloudBlobContainer.Exists())
    {
        var results = cloudBlobContainer.ListBlobs(prefix: $"{iothub}/");
        foreach (IListBlobItem item in results)
        {
            Console.WriteLine(item.Uri);
        }
    }
}
```

Чтобы создать учетную запись хранения Azure Data Lake, совместимую с Gen2, создайте новую учетную запись хранения v2 и выберите параметр *включена* в поле *Иерархическое пространство имен* на вкладке **Дополнительно** , как показано на следующем рисунке.

![Выберите хранилище Azure Date Lake Gen2](./media/iot-hub-devguide-messages-d2c/selectadls2storage.png)


### <a name="service-bus-queues-and-service-bus-topics"></a>Очереди и разделы служебной шины

Для очередей и разделов служебной шины, которые используются как конечные точки Центра Интернета вещей, **сеансы** или **поиск повторяющихся данных** должны быть выключены. Если один из этих параметров включен, конечная точка отображается как **недоступная** на портале Azure.

### <a name="event-hubs"></a>Центры событий

Помимо конечной точки, совместимой со встроенными Центрами событий, вы также можете направлять данные в пользовательские конечные точки типа Центров событий. 

## <a name="reading-data-that-has-been-routed"></a>Чтение маршрутизированных данных

Вы можете настроить маршрут, следуя инструкциям в [этом руководстве](tutorial-routing.md).

В следующих руководствах вы узнаете, как читать сообщения из конечной точки.

* Считывание данных из [встроенной конечной точки](quickstart-send-telemetry-node.md).

* Считывание данных из [хранилища BLOB-объектов](../storage/blobs/storage-blob-event-quickstart.md).

* Считывание данных из [Центров событий](../event-hubs/event-hubs-dotnet-standard-getstarted-send.md).

* Считывание данных из [очередей служебной шины](../service-bus-messaging/service-bus-dotnet-get-started-with-queues.md).

* Считывание данных из [разделов служебной шины](https://docs.microsoft.com/azure/service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions).

## <a name="fallback-route"></a>Резервный маршрут

Резервный маршрут позволяет отправить все сообщения, которые не соответствуют условиям запроса на любом из имеющихся маршрутов, ко встроенным Центрам событий ( **/messages/events**), совместимым со службой [Центры событий](/azure/event-hubs/). Если маршрутизация сообщений включена, вы можете включить возможность резервного маршрута. После создания маршрута данные перестают передаваться во встроенную конечную точку, если только маршрут не создан для этой конечной точки. Если маршруты ко встроенной конечной точке отсутствуют и резервный маршрут включен, на встроенную конечную точку будут отправляться только те сообщения, которые не соответствуют каким-либо условиям запроса для маршрутов. Кроме того, если удалить имеющиеся маршруты, необходимо включить резервный маршрут, чтобы все данные поступали на встроенную конечную точку.

Вы можете включить или отключить резервный маршрут в колонке "портал Azure-> маршрутизация сообщений". Вы также можете использовать Azure Resource Manager, чтобы свойства [FallbackRouteProperties](/rest/api/iothub/iothubresource/createorupdate#fallbackrouteproperties) использовали пользовательскую конечную точку для резервного маршрута.

## <a name="non-telemetry-events"></a>События без использования телеметрии

Кроме телеметрии устройств, маршрутизация сообщений также позволяет отправлять события изменения двойникаа устройства, события жизненного цикла устройства и события изменения цифровых двойника (в общедоступной предварительной версии). Например, при создании маршрута с источником данных со значением **события изменения двойников устройства** Центр Интернета вещей отправляет сообщения на конечную точку, содержащую изменения двойника устройства. Аналогично, если маршрут создается с источником данных **событиями жизненного цикла устройства**, центр Интернета вещей отправляет сообщение, указывающее, было ли устройство удалено или создано. Наконец, в рамках [общедоступной предварительной версии центра Интернета вещей Plug and Play](../iot-pnp/overview-iot-plug-and-play.md)разработчик может создавать маршруты с набором источников данных для **событий изменения цифровых двойника** , а центр Интернета вещей отправляет сообщения при установке или изменении [Свойства](../iot-pnp/iot-plug-and-play-glossary.md) двойника, [цифровой двойника ](../iot-pnp/iot-plug-and-play-glossary.md)заменяется или при наступлении события изменения для базового двойникаа устройства.

[Центр Интернета вещей также интегрируется со службой "Сетка событий Azure](iot-hub-event-grid.md) " для публикации событий устройств для поддержки интеграции и автоматизации рабочих процессов в режиме реального времени на основе этих событий. Ознакомьтесь с основными различиями [между маршрутизацией сообщений и Сеткой событий](iot-hub-event-grid-routing-comparison.md), чтобы узнать, какой вариант подходит вам больше.

## <a name="testing-routes"></a>Тестирование маршрутов

При создании маршрута или изменении имеющегося маршрута необходимо проверить запрос маршрута, отправив пример сообщения. Вы можете протестировать отдельные маршруты или проверить все маршруты за один раз и не отправлять сообщения на конечные точки во время теста. Для тестирования можно использовать портал Azure, Azure Resource Manager, Azure PowerShell и Azure CLI. Результаты помогают определить, соответствует ли образец сообщения запросу, сообщение не совпало с запросом, или тест не удалось выполнить, так как образец сообщения или синтаксис запроса неверны. Дополнительные сведения см. в статьях о [проверке маршрута](/rest/api/iothub/iothubresource/testroute) и [проверке всех маршрутов](/rest/api/iothub/iothubresource/testallroutes).

## <a name="ordering-guarantees-with-at-least-once-delivery"></a>Упорядочение гарантирует по крайней мере одну доставку

Маршрутизация сообщений центра Интернета вещей гарантирует упорядоченность и хотя бы одну доставку сообщений конечным точкам. Это означает, что могут существовать дублирующиеся сообщения, а последовательность сообщений может быть повторно передаваться с учетом исходного порядка сообщений. Например, если исходный порядок сообщений — [1, 2, 3, 4], можно получить последовательность сообщений, например [1, 2, 1, 2, 3, 1, 2, 3, 4]. Гарантийная Сортировка заключается в том, что если вы получаете сообщение [1], за ним всегда будет следовать [2, 3, 4].

Для обработки дубликатов сообщений рекомендуется пометить уникальный идентификатор в свойствах приложения сообщения в точке происхождения, которая обычно является устройством или модулем. Служба, использующая сообщения, может управлять повторяющимися сообщениями с помощью этого идентификатора.

## <a name="latency"></a>Latency

При маршрутизации сообщений телеметрии, передаваемой с устройства в облако с помощью встроенных конечных точек наблюдается небольшое увеличение общей задержки после создания первого маршрута.

В большинстве случаев среднее увеличение задержки составляет менее 500 мс. Вы можете отслеживать задержки с помощью метрики Центра Интернета вещей **Routing: message latency for messages/events** (Маршрутизация: задержка сообщений для messages/events) или **d2c.endpoints.latency.builtIn.events**. Последующее создание или удаление любого маршрута не влияет на общую задержку.

## <a name="monitoring-and-troubleshooting"></a>Мониторинг и устранение неполадок

Центр Интернета вещей предоставляет несколько метрик, связанных с маршрутизацией и конечными точками, которые позволяют получить представление о работоспособности центра и отправленных сообщений. Вы можете объединить данные из нескольких метрик, чтобы определить первопричину проблем. Например, используйте **маршрутизацию метрики: сообщения телеметрии, удаленные** или **D2C. телеметрии. Исходящие. удаляется** для указания количества сообщений, которые были удалены, если они не совпали с запросами на любом из маршрутов и резервном маршруте. В [этой статье](iot-hub-metrics.md) представлены все метрики, включенные по умолчанию для Центра Интернета вещей.

Для получения [состояния работоспособности](iot-hub-devguide-endpoints.md#custom-endpoints) конечных точек можно использовать REST API [получить работоспособность конечной точки](https://docs.microsoft.com/rest/api/iothub/iothubresource/getendpointhealth#iothubresource_getendpointhealth) . Мы рекомендуем использовать [метрики центра Интернета вещей](iot-hub-metrics.md) , связанные с задержкой сообщений маршрутизации, чтобы выявление и отладка ошибок при неработоспособности или неисправности конечной точки. Например, для концентраторов событий типа конечной точки можно отслеживать **D2C. Endpoints. задержка. eventHubs**. Состояние неработоспособной конечной точки будет обновлено до работоспособного, если центр Интернета вещей установил состояние работоспособности в конечном итоге.

Используя журналы диагностики **маршрутов** в Azure Monitor [параметры диагностики](../iot-hub/iot-hub-monitor-resource-health.md), можно отвести наблюдение за ошибками, возникающими во время оценки запроса маршрутизации и работоспособности конечной точки, как показано в центре Интернета вещей, например, когда конечная точка недоступна. Эти журналы диагностики можно отправлять в журналы Azure Monitor, концентраторы событий или службу хранилища Azure для пользовательской обработки.

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о создании маршрутов сообщений см. в статье [Руководство. Настройка маршрутизации сообщений с Центром Интернета вещей](tutorial-routing.md).

* [Краткое руководство. Отправка данных телеметрии с устройства в Центр Интернета вещей и чтение данных телеметрии из центра с помощью внутреннего приложения (Node.js)](quickstart-send-telemetry-node.md)

* Дополнительные сведения о пакетах SDK, которые можно использовать для отправки сообщений с устройства в облако, см. в статье, посвященной [пакетам SDK для Azure IoT](iot-hub-devguide-sdks.md).
