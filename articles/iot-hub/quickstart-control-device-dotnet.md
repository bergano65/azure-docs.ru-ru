---
title: Краткое руководство по управлению устройством из Центра Интернета вещей (.NET) | Документация Майкрософт
description: 'В этом кратком руководстве описано, как запустить два примера приложений C#: приложение-служба, которое может удаленно управлять подключенными к центру устройствами; приложение, которое имитирует подключенное к центру устройство, которым можно управлять удаленно.'
author: robinsh
manager: philmea
ms.author: robinsh
ms.service: iot-hub
services: iot-hub
ms.devlang: csharp
ms.topic: quickstart
ms.custom:
- mvc
- mqtt
- 'Role: Cloud Development'
- devx-track-azurecli
ms.date: 03/04/2020
ms.openlocfilehash: 39cfa64b756ef6bf20f8cbf3d6e8f8a25e81c674
ms.sourcegitcommit: 5db975ced62cd095be587d99da01949222fc69a3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2020
ms.locfileid: "97092896"
---
# <a name="quickstart-control-a-device-connected-to-an-iot-hub-net"></a>Краткое руководство. Управление подключенным к центру Интернета вещей устройством (.NET)

[!INCLUDE [iot-hub-quickstarts-2-selector](../../includes/iot-hub-quickstarts-2-selector.md)]

Центр Интернета вещей — это служба Azure, которая позволяет управлять устройствами Интернета вещей из облака и принимать большие объемы телеметрии с устройств в облако для хранения или обработки. В этом кратком руководстве управление имитированным устройством, подключенным к Центру Интернета вещей, осуществляется с помощью *прямого метода*. Этот метод позволяет удаленно изменить поведение подключенного к Центру Интернета вещей устройства.

В этом кратком руководстве используются два предварительно созданных приложения .NET:

* Приложение имитированного устройства, реагирующее на прямые методы, вызванные из приложения-службы. Чтобы получать вызовы прямого метода, это приложение подключается к конечной точке конкретного устройства в Центре Интернета вещей.

* Приложение-служба, вызывающее прямые методы на имитированном устройстве. Чтобы вызвать прямой метод в устройстве, это приложение подключается к конечной точке на стороне службы в Центре Интернета вещей.

[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

## <a name="prerequisites"></a>Предварительные требования

* Примеры приложений, запускаемые в рамках этого краткого руководства, написаны на языке C#. На компьютере для разработки необходимо установить пакет SDK для .NET Core версии 3.1 или более поздней.

    Пакет SDK для .NET Core, предназначенный для нескольких платформ, можно загрузить из [.NET](https://www.microsoft.com/net/download/all).

    Текущую версию C# на компьютере, на котором ведется разработка, можно проверить, используя следующую команду:

    ```cmd/sh
    dotnet --version
    ```
* Если вы это еще не сделали, скачайте примеры Azure IoT на C# по ссылке https://github.com/Azure-Samples/azure-iot-samples-csharp/archive/master.zip и извлеките ZIP-архив.

* Убедитесь, что в брандмауэре открыт порт 8883. Пример устройства в этом кратком руководстве использует протокол MQTT, который передает данные через порт 8883. В некоторых корпоративных и академических сетях этот порт может быть заблокирован. Дополнительные сведения и способы устранения этой проблемы см. в разделе о [подключении к Центру Интернета вещей по протоколу MQTT](iot-hub-mqtt-support.md#connecting-to-iot-hub).

[!INCLUDE [azure-cli-prepare-your-environment.md](../../includes/azure-cli-prepare-your-environment-no-header.md)]

[!INCLUDE [iot-hub-cli-version-info](../../includes/iot-hub-cli-version-info.md)]

## <a name="create-an-iot-hub"></a>Создание Центра Интернета вещей

Если вы закончили работу с предыдущим [руководством по отправке данных телеметрии с устройства в Центр Интернета вещей](quickstart-send-telemetry-dotnet.md), этот шаг можно пропустить.

[!INCLUDE [iot-hub-include-create-hub](../../includes/iot-hub-include-create-hub.md)]

## <a name="register-a-device"></a>Регистрация устройства

Если вы закончили работу с предыдущим [руководством по отправке данных телеметрии с устройства в Центр Интернета вещей](quickstart-send-telemetry-dotnet.md), этот шаг можно пропустить.

Устройство должно быть зарегистрировано в Центре Интернета вещей, прежде чем оно сможет подключиться. В этом кратком руководстве для регистрации имитируемого устройства используется Azure Cloud Shell.

1. Выполните приведенные ниже команды в Azure Cloud Shell, чтобы создать удостоверение устройства.

   **YourIoTHubName**. Замените этот заполнитель именем вашего центра Интернета вещей.

   **MyDotnetDevice**. Это имя регистрируемого устройства. Рекомендуется использовать **MyDotnetDevice**, как показано ниже. Если вы выбрали другое имя для устройства, используйте его при работе с этим руководством и обновите имя устройства в примерах приложений перед их запуском.

    ```azurecli-interactive
    az iot hub device-identity create \
      --hub-name {YourIoTHubName} --device-id MyDotnetDevice
    ```

2. Выполните следующую команду в Azure Cloud Shell, чтобы получить _строку подключения_ зарегистрированного устройства:

   **YourIoTHubName**. Замените этот заполнитель именем вашего центра Интернета вещей.

    ```azurecli-interactive
    az iot hub device-identity show-connection-string \
      --hub-name {YourIoTHubName} \
      --device-id MyDotnetDevice \
      --output table
    ```

    Запишите строку подключения устройства, которая выглядит так:

   `HostName={YourIoTHubName}.azure-devices.net;DeviceId=MyNodeDevice;SharedAccessKey={YourSharedAccessKey}`

    Это значение понадобится позже в рамках этого краткого руководства.

## <a name="retrieve-the-service-connection-string"></a>Получение строки подключения к службе

Чтобы разрешить приложению-службе подключаться к центру Интернета вещей и получать сообщения, требуется _строка подключения к службе_. Следующая команда извлекает строку подключения службы для Центра Интернета вещей:

```azurecli-interactive
az iot hub show-connection-string --policy-name service --name {YourIoTHubName} --output table
```

Запишите строку подключения к службе, которая выглядит так:

   `HostName={YourIoTHubName}.azure-devices.net;SharedAccessKeyName=service;SharedAccessKey={YourSharedAccessKey}`

Это значение понадобится позже в рамках этого краткого руководства. Строка подключения к службе отличается от строки подключения к устройству из предыдущего шага.

## <a name="listen-for-direct-method-calls"></a>Ожидание передачи данных при вызове прямого метода

Приложение имитированного устройства подключается к конечной точке конкретного устройства в Центре Интернета вещей, отправляет имитированные данные телеметрии и ожидает передачи данных при вызове прямого метода из центра. В рамках этого краткого руководства вызов прямого метода из центра инициирует изменение интервала, с которым устройство отправляет данные телеметрии. После выполнения прямого метода имитированное устройство отправляет подтверждение в центр.

1. В окне терминала на локальном компьютере перейдите в корневую папку примера проекта C#. Затем перейдите в папку **iot-hub\Quickstarts\SimulatedDeviceWithCommand**.

2. Установите необходимые пакеты приложения имитированного устройства, выполнив в окне терминала на локальном компьютере следующие команды:

    ```cmd/sh
    dotnet restore
    ```

3. Скомпилируйте и запустите приложение имитированного устройства, выполнив в окне терминала на локальном компьютере следующую команду, при этом замените `{DeviceConnectionString}` строкой подключения устройства, которую вы записали ранее.

    ```cmd/sh
    dotnet run -- {DeviceConnectionString}
    ```

    На следующем снимке экрана показан пример выходных данных, когда приложение имитированного устройства отправляет данные телеметрии в Центр Интернета вещей:

    ![Запуск виртуального устройства](./media/quickstart-control-device-dotnet/SimulatedDevice-1.png)

## <a name="call-the-direct-method"></a>Вызов прямого метода

Приложение-служба подключается к конечной точке на стороне службы в Центре Интернета вещей. Приложение выполняет вызовы прямых методов к устройству через Центр Интернета вещей и ожидает подтверждений. Приложение-служба Центра Интернета вещей обычно работает в облаке.

1. В другом окне терминала на локальном компьютере перейдите в корневую папку примера проекта C#. Затем перейдите в папку **iot-hub\Quickstarts\InvokeDeviceMethod**.

2. Установите необходимые библиотеки приложения-службы, выполнив в окне терминала на локальном компьютере следующие команды:

    ```cmd/sh
    dotnet restore
    ```

3. Скомпилируйте и запустите приложение-службу, выполнив в окне терминала на локальном компьютере следующие команды и заменив `{ServiceConnectionString}` строкой подключения службы, которую вы записали ранее.

    ```cmd/sh
    dotnet run -- {ServiceConnectionString}
    ```

    На следующем снимке экрана показан пример выходных данных, когда приложение выполняет вызов прямого метода к устройству и получает подтверждение:

    ![Запуск приложения-службы](./media/quickstart-control-device-dotnet/BackEndApplication.png)

    После запуска приложения-службы в окне консоли, в котором выполняется имитированное устройство, отобразится сообщение и изменится интервал, с которым это приложение отправляет сообщения:

    ![Изменения в имитированном клиенте](./media/quickstart-control-device-dotnet/SimulatedDevice-2.png)

## <a name="clean-up-resources"></a>Очистка ресурсов

[!INCLUDE [iot-hub-quickstarts-clean-up-resources](../../includes/iot-hub-quickstarts-clean-up-resources.md)]

## <a name="next-steps"></a>Дальнейшие действия

С помощью этого краткого руководства вы вызвали прямой метод на устройстве из приложения-службы, а также ответили на этот вызов в приложении имитированного устройства.

Чтобы узнать, как маршрутизировать сообщения с устройства в облако в разные расположения в облаке, перейдите к следующему руководству.

> [!div class="nextstepaction"]
> [Руководство. Маршрутизация телеметрии в разные конечные точки для обработки](tutorial-routing.md)
