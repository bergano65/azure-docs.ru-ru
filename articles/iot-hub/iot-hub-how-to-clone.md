---
title: Клонирование центра Интернета вещей Azure
description: Клонирование центра Интернета вещей Azure
author: robinsh
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 12/09/2019
ms.author: robinsh
ms.openlocfilehash: 6e4d110221c7f360e8177505de2a7789f9616d51
ms.sourcegitcommit: 5ab4f7a81d04a58f235071240718dfae3f1b370b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2019
ms.locfileid: "74976151"
---
# <a name="how-to-clone-an-azure-iot-hub-to-another-region"></a>Клонирование центра Интернета вещей Azure в другой регион

В этой статье рассматриваются способы клонирования центра Интернета вещей и приведены некоторые вопросы, которые необходимо ответить перед началом работы. Ниже приведены несколько причин, по которым может потребоваться клонировать центр Интернета вещей:
 
* Вы перемещаете компанию из одного региона в другой, например из Европы, в Северная Америка (или наоборот) и хотите, чтобы ваши ресурсы и данные были географически близки к новому расположению, поэтому необходимо переместить центр.

* Вы настраиваете центр для разработки и рабочей среды.

* Необходимо выполнить пользовательскую реализацию высокого уровня доступности для нескольких концентраторов. Дополнительные сведения см. в [разделе как добиться высокой доступности и аварийного восстановления в центре Интернета вещей в разных регионах](iot-hub-ha-dr.md#achieve-cross-region-ha).

* Необходимо увеличить количество [секций](iot-hub-scaling.md#partitions) , настроенных для центра. Это значение задается при первом создании концентратора и не может быть изменено. Вы можете использовать сведения в этой статье для клонирования центра и при создании клона увеличить число секций.

Для клонирования центра требуется подписка с административным доступом к исходному концентратору. Новый центр можно разместить в новой группе ресурсов и регионе в той же подписке, что и исходный концентратор, или даже в новой подписке. Нельзя использовать то же имя, так как имя концентратора должно быть глобально уникальным.

> [!NOTE]
> В настоящее время не существует функции первого класса для клонирования центра Интернета вещей. В основном это процесс, выполняемый вручную, и, таким образом, весьма подвержен ошибкам. Сложность клонирования концентратора прямо пропорциональна сложности концентратора. Например, клонирование центра Интернета вещей без маршрутизации сообщений довольно просто. Если вы добавляете маршрутизацию сообщений только по одной сложности, клонирование концентратора по крайней мере более сложное. Если также переместить ресурсы, используемые для конечных точек маршрутизации, это еще один порядок, магнитуре более сложным. 

## <a name="things-to-consider"></a>Полезная информация

Перед клонированием центра Интернета вещей необходимо учесть несколько моментов.

* Убедитесь, что все компоненты, доступные в исходном расположении, также доступны в новом расположении. Некоторые службы доступны в предварительной версии, а не все функции доступны везде.

* Не удаляйте исходные ресурсы перед созданием и проверкой клонированной версии. После удаления концентратора остается бессрочной, и вы не можете восстановить его, чтобы проверить параметры или данные, чтобы убедиться, что концентратор реплицируется правильно.

* Для многих ресурсов требуются глобальные уникальные имена, поэтому для клонированных версий необходимо использовать разные имена. Кроме того, следует использовать другое имя для группы ресурсов, к которой принадлежит клонированный концентратор. 

* Данные для исходного центра Интернета вещей не переносятся. Сюда входят сообщения телеметрии, команды из облака на устройство (C2D) и связанные с заданием сведения, такие как расписания и журнал. Метрики и результаты ведения журнала также не переносятся. 

* Для данных или сообщений, направляемых в службу хранилища Azure, можно оставить данные в исходной учетной записи хранения, передать их в новую учетную запись хранения в новом регионе или оставить старые данные на месте и создать новую учетную запись хранения в новом расположении для новых данных. Дополнительные сведения о перемещении данных в хранилище BLOB-объектов см. в статье Начало [работы с AzCopy](../storage/common/storage-use-azcopy-v10.md).

* Данные для концентраторов событий и разделов и очередей служебной шины нельзя перенести. Это данные на момент времени, которые не сохраняются после обработки сообщений.

* Необходимо запланировать время простоя для миграции. Клонирование устройств в новый центр занимает время. Если вы используете метод импорта и экспорта, тестирование производительности показало, что для перемещения устройств 500 000 и на четыре часа для перемещения миллионов устройств может потребоваться около двух часов. 

* Вы можете скопировать устройства в новый центр без выключения или изменения устройств. 

    * Если устройства изначально были подготовлены с помощью DPS, их повторная подготовка обновляет сведения о подключении, хранящиеся на каждом устройстве. 
    
    * В противном случае для перемещения устройств необходимо использовать метод импорта и экспорта, после чего устройства должны быть изменены для использования нового концентратора. Например, можно настроить устройство для использования имени узла центра Интернета вещей из требуемых свойств двойника. Устройство будет принимать имя узла центра Интернета вещей, отключать устройство от старого концентратора и подключать его к новому.
    
* Необходимо обновить все сертификаты, которые вы используете, чтобы их можно было использовать с новыми ресурсами. Кроме того, вы, вероятно, используете концентратор, определенный в таблице DNS, и вам потребуется обновить сведения о DNS.

## <a name="methodology"></a>Методика

Это общий метод, который мы рекомендуем использовать для перемещения центра Интернета вещей из одного региона в другой. Для маршрутизации сообщений предполагается, что ресурсы не перемещаются в новый регион. Дополнительные сведения см. в [разделе Маршрутизация сообщений](#how-to-handle-message-routing).

   1. Экспортируйте центр и его параметры в шаблон диспетчер ресурсов. 
   
   1. Внесите необходимые изменения в шаблон, например обновление всех вхождений имени и расположения клонированного концентратора. Для всех ресурсов в шаблоне, используемых для конечных точек маршрутизации сообщений, обновите ключ в шаблоне для этого ресурса.
   
   1. Импортируйте шаблон в новую группу ресурсов в новом расположении. При этом создается клон.

   1. Отладка по мере необходимости. 
   
   1. Добавьте все, что не было экспортировано в шаблон. 
   
       Например, группы потребителей не экспортируются в шаблон. Группы потребителей необходимо добавить в шаблон вручную или использовать [портал Azure](https://portal.azure.com) после создания концентратора. Пример добавления одной группы потребителей в шаблон в статье [Использование шаблона Azure Resource Manager для настройки маршрутизации сообщений центра Интернета вещей](tutorial-routing-config-message-routing-rm-template.md).
       
   1. Скопируйте устройства из исходного концентратора в клон. Это описано в разделе [Управление устройствами, зарегистрированными в центре Интернета вещей](#managing-the-devices-registered-to-the-iot-hub).

## <a name="how-to-handle-message-routing"></a>Как управлять маршрутизацией сообщений

Если в центре используется [Настраиваемая маршрутизация](iot-hub-devguide-messages-read-custom.md), Экспорт шаблона для центра включает в себя конфигурацию маршрутизации, но не включает сами ресурсы. Необходимо выбрать, следует ли переместить ресурсы маршрутизации в новое расположение или оставить их на месте и продолжить использовать их "как есть". 

Например, предположим, что у вас есть центр в западной части США, который перенаправляет сообщения в учетную запись хранения (также в западной части США) и хотите переместить концентратор в Восточная часть США. Вы можете переместить центр, чтобы он по-прежнему направлял сообщения в учетную запись хранения в западной части США, или переместить центр, а также переместить учетную запись хранения. При маршрутизации сообщений конечных точек в другом регионе может возникнуть небольшая производительность.

Вы можете переместить концентратор, который использует маршрутизацию сообщений, довольно просто, если не переместить ресурсы, используемые для конечных точек маршрутизации. 

Если в концентраторе используется маршрутизация сообщений, у вас есть два варианта. 

1. Переместите ресурсы, используемые для конечных точек маршрутизации, в новое расположение.

    * Новые ресурсы необходимо создавать вручную в [портал Azure](https://portal.azure.com) или с помощью шаблонов диспетчер ресурсов. 

    * Необходимо переименовать все ресурсы при их создании в новом расположении, так как они имеют глобально уникальные имена. 
     
    * Перед созданием нового концентратора необходимо обновить имена ресурсов и ключи ресурсов в шаблоне нового концентратора. Ресурсы должны присутствовать при создании нового концентратора.

1. Не переносите ресурсы, используемые для конечных точек маршрутизации. Используйте их «на месте».

   * На шаге редактирования шаблона необходимо получить ключи для каждого ресурса маршрутизации и разместить их в шаблоне перед созданием нового концентратора. 

   * Концентратор по-прежнему ссылается на исходные ресурсы маршрутизации и направляет сообщения в них в соответствии с настройками.

   * У вас будет небольшое снижение производительности, так как центр и ресурсы конечной точки маршрутизации находятся в разных расположениях.

## <a name="prepare-to-migrate-the-hub-to-another-region"></a>Подготовка к переносу концентратора в другой регион

В этом разделе приведены конкретные инструкции по миграции концентратора.

### <a name="find-the-original-hub-and-export-it-to-a-resource-template"></a>Найдите исходный центр и экспортируйте его в шаблон ресурсов.

1. Войдите на [портал Azure](https://portal.azure.com). 

1. Перейдите в раздел **группы ресурсов** и выберите группу ресурсов, содержащую концентратор, который требуется переместить. Вы также можете выбрать **ресурсы** и найти центр. Выберите центр.

1. Выберите **Экспорт шаблона** из списка свойств и параметров для центра. 

   ![Снимок экрана, показывающий команду для экспорта шаблона для центра Интернета вещей.](./media/iot-hub-how-to-clone/iot-hub-export-template.png)

1. Щелкните **скачать** , чтобы скачать шаблон. Сохраните файл, где его можно будет найти. 

   ![Снимок экрана, показывающий команду загрузки шаблона для центра Интернета вещей.](./media/iot-hub-how-to-clone/iot-hub-download-template.png)

### <a name="view-the-template"></a>Просмотрите шаблон 

1. Перейдите в папку Downloads (или в любую папку, которая использовалась при экспорте шаблона) и найдите ZIP-файл. Откройте ZIP-файл и найдите файл с именем `template.json`. Выберите его, а затем нажмите клавиши CTRL + C, чтобы скопировать шаблон. Перейдите в другую папку, которая не находится в ZIP-файле, и вставьте файл (Ctrl + V). Теперь ее можно изменить.
 
    Следующий пример предназначен для универсального концентратора без настройки маршрутизации. Это центр уровня S1 (с 1 единицей) под названием **ContosoTestHub29358** в регионе **westus**. Вот экспортированный шаблон.

    ``` json
    {
        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
        "contentVersion": "1.0.0.0",
        "parameters": {
            "IotHubs_ContosoTestHub29358_name": {
                "defaultValue": "ContosoTestHub29358",
                "type": "String"
            }
        },
        "variables": {},
        "resources": [
            {
                "type": "Microsoft.Devices/IotHubs",
                "apiVersion": "2018-04-01",
                "name": "[parameters('IotHubs_ContosoTestHub29358_name')]",
                "location": "westus",
                "sku": {
                    "name": "S1",
                    "tier": "Standard",
                    "capacity": 1
                },
                "properties": {
                    "operationsMonitoringProperties": {
                        "events": {
                            "None": "None",
                            "Connections": "None",
                            "DeviceTelemetry": "None",
                            "C2DCommands": "None",
                            "DeviceIdentityOperations": "None",
                            "FileUploadOperations": "None",
                            "Routes": "None"
                        }
                    },
                    "ipFilterRules": [],
                    "eventHubEndpoints": {
                        "events": {
                            "retentionTimeInDays": 1,
                            "partitionCount": 2,
                            "partitionIds": [
                                "0",
                                "1"
                            ],
                            "path": "contosotesthub29358",
                            "endpoint": "sb://iothub-ns-contosotes-2227755-92aefc8b73.servicebus.windows.net/"
                        },
                        "operationsMonitoringEvents": {
                            "retentionTimeInDays": 1,
                            "partitionCount": 2,
                            "partitionIds": [
                                "0",
                                "1"
                            ],
                            "path": "contosotesthub29358-operationmonitoring",
                            "endpoint": "sb://iothub-ns-contosotes-2227755-92aefc8b73.servicebus.windows.net/"
                        }
                    },
                    "routing": {
                        "endpoints": {
                            "serviceBusQueues": [],
                            "serviceBusTopics": [],
                            "eventHubs": [],
                            "storageContainers": []
                        },
                        "routes": [],
                        "fallbackRoute": {
                            "name": "$fallback",
                            "source": "DeviceMessages",
                            "condition": "true",
                            "endpointNames": [
                                "events"
                            ],
                            "isEnabled": true
                        }
                    },
                    "storageEndpoints": {
                        "$default": {
                            "sasTtlAsIso8601": "PT1H",
                            "connectionString": "",
                            "containerName": ""
                        }
                    },
                    "messagingEndpoints": {
                        "fileNotifications": {
                            "lockDurationAsIso8601": "PT1M",
                            "ttlAsIso8601": "PT1H",
                            "maxDeliveryCount": 10
                        }
                    },
                    "enableFileUploadNotifications": false,
                    "cloudToDevice": {
                        "maxDeliveryCount": 10,
                        "defaultTtlAsIso8601": "PT1H",
                        "feedback": {
                            "lockDurationAsIso8601": "PT1M",
                            "ttlAsIso8601": "PT1H",
                            "maxDeliveryCount": 10
                        }
                    },
                    "features": "None"
                }
            }
        ]
    }
    ```

### <a name="edit-the-template"></a>Изменение шаблона 

Необходимо внести некоторые изменения, прежде чем можно будет использовать шаблон для создания нового концентратора в новом регионе. Для редактирования шаблона используйте [VS Code](https://code.visualstudio.com) или текстовый редактор.

#### <a name="edit-the-hub-name-and-location"></a>Изменение имени и расположения концентратора

1. Удалить раздел Parameters вверху — гораздо проще использовать имя концентратора, так как у нас не будет нескольких параметров. 

    ``` json
        "parameters": {
            "IotHubs_ContosoTestHub29358_name": {
                "defaultValue": "ContosoTestHub29358",
                "type": "String"
            }
        },
    ```

1. Измените имя, чтобы использовать фактическое (новое) имя, а не извлекать его из параметра (который был удален на предыдущем шаге). 

    Для нового концентратора используйте имя исходного концентратора и строковый *клон* , чтобы создать новое имя. Начните с очистки имени и расположения концентратора.
    
    Старая версия:

    ``` json 
    "name": "[parameters('IotHubs_ContosoTestHub29358_name')]",
    "location": "westus",
    ```
    
    Новая версия: 

    ``` json 
    "name": "ContosoTestHub29358clone",
    "location": "eastus",
    ```

    Далее вы обнаружите, что значения для **path** содержат старое имя концентратора. Измените их для использования новой. Это значения пути в **евенсубендпоинтс** с именем **Events** и **оператионсмониторинжевентс**.

    Когда все будет готово, раздел конечных точек концентратора событий должен выглядеть следующим образом:

    ``` json
    "eventHubEndpoints": {
        "events": {
            "retentionTimeInDays": 1,
            "partitionCount": 2,
            "partitionIds": [
                "0",
                "1"
            ],
            "path": "contosotesthub29358clone",
            "endpoint": "sb://iothub-ns-contosotes-2227755-92aefc8b73.servicebus.windows.net/"
        },
        "operationsMonitoringEvents": {
            "retentionTimeInDays": 1,
            "partitionCount": 2,
            "partitionIds": [
                "0",
                "1"
            ],
            "path": "contosotesthub29358clone-operationmonitoring",
            "endpoint": "sb://iothub-ns-contosotes-2227755-92aefc8b73.servicebus.windows.net/"
        }
    ```

#### <a name="update-the-keys-for-the-routing-resources-that-are-not-being-moved"></a>Обновите ключи для ресурсов маршрутизации, которые не перемещаются

При экспорте шаблона диспетчер ресурсов для концентратора, для которого настроена маршрутизация, вы увидите, что ключи для этих ресурсов не указаны в экспортированном шаблоне — их размещение отмечается звездочками. Их необходимо заполнить, перейдя к этим ресурсам на портале и извлекая ключи **перед** импортом шаблона нового концентратора и создания центра. 

1. Получите ключи, необходимые для любого из ресурсов маршрутизации, и вставьте их в шаблон. Ключи можно получить из ресурса в [портал Azure](https://portal.azure.com). 

   Например, при маршрутизации сообщений в контейнер хранилища найдите учетную запись хранения на портале. В разделе Параметры выберите **ключи доступа**, а затем скопируйте один из ключей. Вот как выглядит ключ при первом экспорте шаблона:

   ```json
   "connectionString": "DefaultEndpointsProtocol=https;
   AccountName=fabrikamstorage1234;AccountKey=****",
   "containerName": "fabrikamresults",
   ```

1. После получения ключа учетной записи хранения поместите его в шаблон в предложении `AccountKey=****` в конце звездочек. 

1. Для очередей служебной шины получите ключ общего доступа, соответствующий SharedAccessKeyName. Ниже приведен ключ и `SharedAccessKeyName` в JSON:

   ```json
   "connectionString": "Endpoint=sb://fabrikamsbnamespace1234.servicebus.windows.net:5671/;
   SharedAccessKeyName=iothubroutes_FabrikamResources;
   SharedAccessKey=****;
   EntityPath=fabrikamsbqueue1234",
   ```

1. То же самое относится к разделам служебной шины и подключениям концентратора событий.

#### <a name="create-the-new-routing-resources-in-the-new-location"></a>Создание новых ресурсов маршрутизации в новом расположении

Этот раздел применяется только при перемещении ресурсов, используемых центром для конечных точек маршрутизации.

Если требуется переместить ресурсы маршрутизации, необходимо вручную настроить ресурсы в новом расположении. Можно создать ресурсы маршрутизации с помощью [портал Azure](https://portal.azure.com)или экспортировать шаблон диспетчер ресурсов для каждого из ресурсов, используемых маршрутизацией сообщений, изменить их и импортировать. После настройки ресурсов можно импортировать шаблон концентратора (который включает в себя конфигурацию маршрутизации).

1. Создайте каждый ресурс, используемый маршрутизацией. Это можно сделать вручную с помощью [портал Azure](https://portal.azure.com)или создать ресурсы с помощью шаблонов диспетчер ресурсов. Если вы хотите использовать шаблоны, выполните следующие действия.

    1. Для каждого ресурса, используемого маршрутизацией, экспортируйте его в шаблон диспетчер ресурсов.
    
    1. Обновите имя и расположение ресурса. 

    1. Обновление перекрестных ссылок между ресурсами. Например, при создании шаблона для новой учетной записи хранения необходимо обновить имя учетной записи хранения в этом шаблоне и другом шаблоне, который ссылается на него. В большинстве случаев раздел маршрутизации в шаблоне для центра является единственным другим шаблоном, который ссылается на ресурс. 

    1. Импортируйте каждый из шаблонов, который развертывает каждый ресурс.

    После настройки и запуска ресурсов, используемых маршрутизацией, можно продолжить.

1. В шаблоне для центра Интернета вещей измените имя каждого из ресурсов маршрутизации на новое имя и при необходимости обновите расположение. 

Теперь у вас есть шаблон, который создаст новый центр, который будет выглядеть почти так же, как старый концентратор, в зависимости от того, как вы решили управлять маршрутизацией.

## <a name="move----create-the-new-hub-in-the-new-region-by-loading-the-template"></a>Move — создание нового концентратора в новом регионе путем загрузки шаблона

Создайте новый центр в новом расположении с помощью шаблона. При наличии ресурсов маршрутизации, которые планируется переместить, ресурсы должны быть настроены в новом расположении, а ссылки в шаблоне обновлены для сопоставления. Если вы не перемещаете ресурсы маршрутизации, они должны находиться в шаблоне с обновленными ключами.

1. Войдите на [портал Azure](https://portal.azure.com).

1. Выберите **Создать ресурс**. 

1. В поле поиска введите "развертывание шаблона" и нажмите клавишу ВВОД.

1. Выберите **Развертывание шаблона (развертывание с помощью пользовательских шаблонов)** . Откроется экран для Шаблоны развертывания. Нажмите кнопку **Создать**. Появляется следующий экран:

   ![Снимок экрана, показывающий команду для создания собственного шаблона](./media/iot-hub-how-to-clone/iot-hub-custom-deployment.png)

1. **В редакторе выберите создать собственный шаблон**, который позволит отправить шаблон из файла. 

1. Выберите **загрузить файл**. 

   ![Снимок экрана, показывающий команду для отправки файла шаблона](./media/iot-hub-how-to-clone/iot-hub-upload-file.png)

1. Найдите новый шаблон, который вы редактировали, и выберите его, а затем нажмите кнопку **Открыть**. Шаблон загружается в окно редактирования. Щелкните **Сохранить**. 

   ![Снимок экрана, показывающий загрузку шаблона](./media/iot-hub-how-to-clone/iot-hub-loading-template.png)

1. Заполните следующие поля.

   **Подписка**. Выберите используемую подписку.

   **Группа ресурсов**. Создайте новую группу ресурсов в новом расположении. Если у вас уже есть новый набор, его можно выбрать вместо создания нового.

   **Расположение**. Если выбрана существующая группа ресурсов, она будет заполнена для соответствия расположению группы ресурсов. Если вы создали новую группу ресурсов, это будет расположение.

   **Флажок "я принимаю"** . по сути говорится, что вы соглашаетесь платить за создаваемые ресурсы.

1. Нажмите кнопку **Приобрести**.

Теперь портал проверяет шаблон и развертывает клонированный центр. Если данные конфигурации маршрутизации настроены, они будут добавлены в новый центр, но будут указывать на ресурсы в предыдущем расположении.

## <a name="managing-the-devices-registered-to-the-iot-hub"></a>Управление устройствами, зарегистрированными в центре Интернета вещей

Теперь, когда клонирование выполняется, необходимо скопировать все устройства из исходного концентратора в клон. 

Это можно сделать несколькими способами. Вы изначально использовали [службу подготовки устройств (DPS)](/azure/iot-dps/about-iot-dps)для подготовки устройств, или это не так. Если вы сделали это, это не сложно. Если это не так, это может быть очень сложно. 

Если вы не использовали службу DPS для подготовки устройств, можно пропустить следующий раздел и начать с [использования функции импорта и экспорта для перемещения устройств в новый центр](#using-import-export-to-move-the-devices-to-the-new-hub).

## <a name="using-dps-to-re-provision-the-devices-in-the-new-hub"></a>Использование политики DPS для повторной подготовки устройств в новом концентраторе

Сведения о перемещении устройств в новое расположение с помощью политики DPS см. в статье [о повторной подготовке устройств](../iot-dps/how-to-reprovision.md). По завершении можно просмотреть устройства в [портал Azure](https://portal.azure.com) и убедиться в том, что они находятся в новом расположении.

Перейдите к новому концентратору с помощью [портал Azure](https://portal.azure.com). Выберите центр, а затем выберите **устройства IOT**. Вы увидите устройства, которые были повторно подготовлены для клонированного концентратора. Можно также просмотреть свойства клонированного концентратора. 

Если вы реализовали маршрутизацию, проверьте и убедитесь, что сообщения правильно направлены в ресурсы.

### <a name="committing-the-changes-after-using-dps"></a>Фиксация изменений после использования DPS

Это изменение зафиксировано службой DPS.

### <a name="rolling-back-the-changes-after-using-dps"></a>Откат изменений после использования DPS. 

Если вы хотите откатить изменения, повторно выполните повторную инициализацию устройств из нового концентратора в старый.

Теперь вы завершили миграцию центра и его устройств. Можно перейти к [очистке](#clean-up).

## <a name="using-import-export-to-move-the-devices-to-the-new-hub"></a>Использование функции импорта и экспорта для перемещения устройств в новый центр

Приложение предназначено для .NET Core, поэтому его можно запустить как в Windows, так и в Linux. Вы можете скачать пример, получить строки подключения, задать флаги, для которых требуется запустить, и запустить его. Это можно сделать, не открывая код.

### <a name="downloading-the-sample"></a>Скачивание примера

1. Используйте примеры IoT C# на этой странице: [примеры Azure IOT для C# ](https://azure.microsoft.com/resources/samples/azure-iot-samples-csharp/). Скачайте ZIP-файл и распакуйте его на компьютере. 

1. Соответствующий код находится в./ИОТ-ХУБ/самплес/сервице/импортекспортдевицессампле. Для запуска приложения не нужно просматривать или изменять код.

1. Чтобы запустить приложение, укажите три строки подключения и пять параметров. Эти данные передаются в виде аргументов командной строки или используются в переменных среды или используют сочетание этих двух параметров. Мы будем передавать параметры в виде аргументов командной строки, а строки подключения — в виде переменных среды. 

   Причина этого заключается в том, что строки подключения слишком длинные и вряд ли меняются, но, возможно, потребуется изменить параметры и запустить приложение несколько раз. Чтобы изменить значение переменной среды, необходимо закрыть командное окно и Visual Studio или VS Code, в зависимости от того, какое приложение используется. 

### <a name="options"></a>Параметры

Ниже приведены пять параметров, которые указываются при запуске приложения. Эти данные будут размещены в командной строке через минуту.

*   **адддевицес** (аргумент 1) — задайте значение true, если вы хотите добавить виртуальные устройства, созданные автоматически. Они добавляются в исходный центр. Кроме того, задайте **нумтоадд** (аргумент 2), чтобы указать, сколько устройств нужно добавить. Максимальное число устройств, которые можно зарегистрировать в центре, — 1 000 000. Этот параметр предназначен для тестирования — вы можете создать определенное количество устройств, а затем скопировать их в другой центр.

*   **копидевицес** (аргумент 3) — установите значение true, чтобы скопировать устройства из одного концентратора в другой. 

*   **делетесаурцедевицес** (аргумент 4) — установите значение true, чтобы удалить все устройства, зарегистрированные в исходном концентраторе. Перед выполнением этого действия рекомендуется подождать, пока не будут переданы все устройства. После удаления устройства их нельзя вернуть.

*   **делетедестдевицес** (аргумент 5) — установите значение true, чтобы удалить все устройства, зарегистрированные в целевом концентраторе (клоне). Это может потребоваться, если вы хотите скопировать устройства несколько раз. 

Основная команда будет выполняться с помощью команды *DotNet* . Это означает, что .NET создаст локальный файл csproj и запустит его. Перед запуском аргументы командной строки добавляются в конец. 

Ваша Командная строка будет выглядеть, как в следующих примерах:

``` console 
    // Format: dotnet run add-devices num-to-add copy-devices delete-source-devices delete-destination-devices

    // Add 1000 devices, don't copy them to the other hub, or delete them. 
    // The first argument is true, numToAdd is 50, and the other arguments are false.
    dotnet run true 1000 false false false 

    // Copy the devices you just added to the other hub; don't delete anything.
    // The first argument is false, numToAdd is 0, copy-devices is true, and the delete arguments are both false
    dotnet run false 0 true false false 
```

### <a name="using-environment-variables-for-the-connection-strings"></a>Использование переменных среды для строк подключения

1. Чтобы запустить пример, необходимо, чтобы строки подключения были в старом и новом центрах Интернета вещей, а также в учетную запись хранения, которую можно использовать для временных рабочих файлов. Эти значения будут храниться в переменных среды.

1. Чтобы получить значения строки подключения, войдите в [портал Azure](https://portal.azure.com). 

1. Разместите строки подключения в любом месте, например в блокноте. Если скопировать следующий текст, строки подключения можно вставить непосредственно там, где они находятся. Не добавляйте пробелы вокруг знака равенства или изменяет имя переменной. Кроме того, не требуется использовать двойные кавычки для строк подключения. Если заключить в кавычки строку подключения к учетной записи хранения, она не будет работать.

   Для Windows можно задать переменные среды.

   ``` console  
   SET IOTHUB_CONN_STRING=<put connection string to original IoT Hub here>
   SET DEST_IOTHUB_CONN_STRING=<put connection string to destination or clone IoT Hub here>
   SET STORAGE_ACCT_CONN_STRING=<put connection string to the storage account here>
   ```
 
   Для Linux это то, как вы определяете переменные среды:

   ``` console  
   export IOTHUB_CONN_STRING="<put connection string to original IoT Hub here>"
   export DEST_IOTHUB_CONN_STRING="<put connection string to destination or clone IoT Hub here>"
   export STORAGE_ACCT_CONN_STRING="<put connection string to the storage account here>"
   ```

1. Для строк подключения центра Интернета вещей перейдите в каждый центр на портале. Вы можете выполнять поиск в **ресурсах** центра. Если вы знакомы с группой ресурсов, перейдите в раздел **группы ресурсов**, выберите группу ресурсов, а затем выберите концентратор из списка ресурсов в этой группе ресурсов. 

1. Выберите **политики общего доступа** в параметрах для центра, а затем выберите **iothubowner** и скопируйте одну из строк подключения. Сделайте то же самое для целевого концентратора. Добавьте их в соответствующие команды SET.

1. В строке подключения к учетной записи хранения найдите учетную запись хранения в разделе **ресурсы** или в ее **группе ресурсов** и откройте ее. 
   
1. В разделе Параметры выберите **ключи доступа** и скопируйте одну из строк подключения. Вставьте строку подключения в текстовый файл для соответствующей команды SET. 

Теперь у вас есть переменные среды в файле с командами SET, и вы знакомы с аргументами командной строки. Давайте запустим пример.

### <a name="running-the-sample-application-and-using-command-line-arguments"></a>Запуск примера приложения и использование аргументов командной строки

1. Откройте окно командной строки. Выберите Windows и введите `command prompt`, чтобы открыть окно командной строки.

1. Скопируйте команды, которые задают переменные среды, по одной за раз, а затем вставьте их в окно командной строки и нажмите клавишу ВВОД. По завершении введите `SET` в окне командной строки, чтобы просмотреть переменные среды и их значения. После копирования этих данных в окно командной строки их не нужно копировать, если не открыть новое окно командной строки.

1. В окне командной строки перейдите в каталог, пока не появится/Импортекспортдевицессампле (где существует файл Импортекспортдевицессампле. csproj). Затем введите следующую команду и укажите аргументы командной строки.

    ``` console
    // Format: dotnet run add-devices num-to-add copy-devices delete-source-devices delete-destination-devices
    dotnet run arg1 arg2 arg3 arg4 arg5
    ```

    Команда DotNet создает и запускает приложение. Так как вы передаете параметры при запуске приложения, их значения можно изменять при каждом запуске приложения. Например, может потребоваться запустить его один раз и создать новые устройства, затем снова запустить его и скопировать эти устройства в новый центр и т. д. Вы также можете выполнять все шаги в одном и том же запуске, хотя мы рекомендуем не удалять устройства, пока вы не убедитесь, что вы завершили клонирование. Ниже приведен пример, в котором создаются устройства 1000, а затем они копируются в другой центр.

    ``` console
    // Format: dotnet run add-devices num-to-add copy-devices delete-source-devices delete-destination-devices

    // Add 1000 devices, don't copy them to the other hub or delete them. 
    dotnet run true 1000 false false false 

    // Do not add any devices. Copy the ones you just created to the other hub; don't delete anything.
    dotnet run false 0 true false false 
    ```

    Убедившись, что устройства успешно скопированы, можно удалить устройства из исходного концентратора следующим образом:

   ``` console
   // Format: dotnet run add-devices num-to-add copy-devices delete-source-devices delete-destination-devices
   // Delete the devices from the source hub.
   dotnet run false 0 false true false 
   ```

### <a name="running-the-sample-application-using-visual-studio"></a>Запуск примера приложения с помощью Visual Studio

1. Если вы хотите запустить приложение в Visual Studio, измените текущий каталог на папку, в которой находится файл Иосубсервицесамплес. sln. Затем выполните эту команду в окне командной строки, чтобы открыть решение в Visual Studio. Это необходимо сделать в том же командном окне, где заданы переменные среды, чтобы эти переменные были известны.

   ``` console       
   IoTHubServiceSamples.sln
   ```
    
1. Щелкните проект *импортекспортдевицессампле* правой кнопкой мыши и выберите команду **Назначить запускаемым проектом**.    
    
1. Задайте переменные в верхней части Program.cs в папке Импортекспортдевицессампле для пяти параметров.

   ``` csharp
   // Add randomly created devices to the source hub.
   private static bool addDevices = true;
   //If you ask to add devices, this will be the number added.
   private static int numToAdd = 0; 
   // Copy the devices from the source hub to the destination hub.
   private static bool copyDevices = false;
   // Delete all of the devices from the source hub. (It uses the IoTHubConnectionString).
   private static bool deleteSourceDevices = false;
   // Delete all of the devices from the destination hub. (Uses the DestIotHubConnectionString).
   private static bool deleteDestDevices = false;
   ```

1. Нажмите клавишу F5, чтобы запустить приложение. После завершения работы можно просмотреть результаты.

### <a name="view-the-results"></a>Просмотр результатов 

Вы можете просмотреть устройства в [портал Azure](https://portal.azure.com) и убедиться в том, что они находятся в новом расположении.

1. Перейдите к новому концентратору с помощью [портал Azure](https://portal.azure.com). Выберите центр, а затем выберите **устройства IOT**. Вы увидите только что скопированные устройства из старого концентратора в клонированный концентратор. Можно также просмотреть свойства клонированного концентратора. 

1. Проверьте наличие ошибок импорта и экспорта, перейдя в учетную запись хранения Azure в [портал Azure](https://portal.azure.com) и просмотрев контейнер `devicefiles` для `ImportErrors.log`. Если этот файл пуст (размер равен 0), ошибки отсутствуют. Если вы попытаетесь импортировать одно устройство несколько раз, оно отклоняет устройство второй раз и добавляет сообщение об ошибке в файл журнала.

### <a name="committing-the-changes"></a>Фиксация изменений 

На этом этапе вы скопировали концентратор в новое расположение и перенесли устройства в новый клон. Теперь необходимо внести изменения, чтобы устройства работали с клонированным концентратором.

Чтобы зафиксировать изменения, необходимо выполнить следующие действия. 

* Обновите каждое устройство, чтобы изменить имя узла центра Интернета вещей, чтобы оно указывало на новый концентратор. Это следует делать с помощью того же метода, который использовался при предварительной подготовке устройства.

* Измените все приложения, которые относятся к старому концентратору, чтобы он указывал на новый концентратор.

* После завершения работы новый концентратор должен быть готов к работе. Старый концентратор не должен иметь активных устройств и находиться в отключенном состоянии. 

### <a name="rolling-back-the-changes"></a>Откат изменений

Если вы решили выполнить откат изменений, выполните следующие действия.

* Обновите каждое устройство, чтобы изменить имя узла центра Интернета вещей, чтобы оно указывало имя узла центра Интернета вещей для старого концентратора. Это следует делать с помощью того же метода, который использовался при предварительной подготовке устройства.

* Измените все приложения, которые относятся к новому концентратору, чтобы он указывал на старый концентратор. Например, если вы используете Azure Analytics, может потребоваться перенастроить [входные данные Azure Stream Analytics](../stream-analytics/stream-analytics-define-inputs.md#stream-data-from-iot-hub).

* Удалите новый концентратор. 

* При наличии ресурсов маршрутизации конфигурация старого концентратора должна указывать на правильную конфигурацию маршрутизации и должна работать с этими ресурсами после перезапуска концентратора.

### <a name="checking-the-results"></a>Проверка результатов 

Чтобы проверить результаты, измените решение IoT так, чтобы оно указывало на центр в новом расположении и выполняло его. Иными словами, выполните те же действия с новым концентратором, который вы выполнили с предыдущим концентратором, и убедитесь, что они работают правильно. 

Если вы реализовали маршрутизацию, проверьте и убедитесь, что сообщения правильно направлены в ресурсы.

## <a name="clean-up"></a>Очистка

Не выполняя очистку, пока вы не убедитесь, что новый концентратор работает и устройства работают правильно. Также обязательно протестируйте маршрутизацию, если используете эту функцию. Когда вы будете готовы, очистите старые ресурсы, выполнив следующие действия:

* Если вы еще не сделали этого, удалите старый концентратор. Это приведет к удалению всех активных устройств из концентратора.

* При наличии ресурсов маршрутизации, перемещенных в новое расположение, можно удалить старые ресурсы маршрутизации.

## <a name="next-steps"></a>Дальнейшие действия

Вы выполнили клонирование центра Интернета вещей в новый центр в новом регионе с устройствами. Дополнительные сведения о выполнении массовых операций с реестром удостоверений в центре Интернета вещей см. [в статье Импорт и экспорт удостоверений устройств центра Интернета вещей в групповой](iot-hub-bulk-identity-mgmt.md)операции.

Дополнительные сведения о центре Интернета вещей и разработке для центра см. в следующих статьях.

* [Руководством разработчика для центра Интернета вещей](iot-hub-devguide.md)

* [Руководство по маршрутизации центра Интернета вещей](tutorial-routing.md)

* [Общие сведения об управлении устройствами в центре Интернета вещей](iot-hub-device-management-overview.md)

* Если вы хотите развернуть пример приложения, ознакомьтесь с [развернутым приложением .NET Core](https://docs.microsoft.com/dotnet/core/deploying/index).