---
title: Установка локального шлюза данных
description: Чтобы получить доступ к данным в локальной среде из Azure Logic Apps, нужно скачать и установить локальный шлюз данных.
services: logic-apps
ms.suite: integration
ms.reviewer: arthii, logicappspm
ms.topic: article
ms.date: 05/15/2020
ms.openlocfilehash: a36b9d20fa20df56ec53e090976ea86e689ac74b
ms.sourcegitcommit: 32c521a2ef396d121e71ba682e098092ac673b30
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2020
ms.locfileid: "91322518"
---
# <a name="install-on-premises-data-gateway-for-azure-logic-apps"></a>Установка локального шлюза данных для Azure Logic Apps

Прежде чем [подключиться к локальным источникам данных из Azure Logic Apps](../logic-apps/logic-apps-gateway-connection.md), необходимо скачать и установить [локальный шлюз данных](https://aka.ms/on-premises-data-gateway-installer) на локальный компьютер. Этот шлюз действует в качестве моста для шифрования и быстрой передачи данных между локальными источниками данных и приложениями логики. Установка шлюза может успешно работать с такими облачными службами, как Power BI, Power Automate, Power Apps и Azure Analysis Services. Сведения о том, как использовать шлюз с этими службами, см. в следующих статьях:

* [Локальный шлюз данных Microsoft Power Automate](/power-automate/gateway-reference)
* [Локальный шлюз данных](/power-bi/service-gateway-onprem)
* [Локальный шлюз данных Microsoft Power Apps](/powerapps/maker/canvas-apps/gateway-reference)
* [Локальный шлюз данных](../analysis-services/analysis-services-gateway.md)

В этой статье показано, как скачать, установить и настроить локальный шлюз данных, чтобы обращаться к локальным источникам данных из Azure Logic Apps. Вы можете узнать больше о том, [как работает шлюз данных](#gateway-cloud-service), далее в этом разделе. Дополнительные сведения о шлюзе см. в разделе [Что такое локальный шлюз данных?](/data-integration/gateway/service-gateway-onprem) Чтобы автоматизировать установку шлюза и задачи управления, посетите коллекцию PowerShell, чтобы ознакомиться с [командлетами PowerShell для шлюза данных](https://www.powershellgallery.com/packages/DataGateway/3000.15.15).

<a name="requirements"></a>

## <a name="prerequisites"></a>Предварительные требования

* Учетная запись и подписка Azure. Если у вас нет учетной записи Azure с подпиской, [зарегистрируйтесь для получения бесплатной учетной записи Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).

  * Ваша учетная запись Azure должна быть рабочей или учебной учетной записью, которая выглядит как `username@contoso.com` . Невозможно использовать учетные записи Azure B2B (гостевые) или личные учетные записи Майкрософт, например @hotmail.com или @outlook.com.

    > [!NOTE]
    > Если вы зарегистрировались для предложения Microsoft 365 и не представити свой рабочий адрес электронной почты, ваш адрес может выглядеть так `username@domain.onmicrosoft.com` . Ваша учетная запись хранится в клиенте Azure AD. В большинстве случаев имя участника-пользователя (UPN) для учетной записи Azure совпадает с адресом электронной почты.

    Чтобы использовать [стандартную подписку Visual Studio](https://visualstudio.microsoft.com/vs/pricing/) , связанную с учетная запись Майкрософт, сначала [Создайте клиент Azure AD](../active-directory/develop/quickstart-create-new-tenant.md) или используйте каталог по умолчанию. Добавьте в каталог пользователя с паролем, а затем предоставьте этому пользователю доступ к своей подписке Azure. Затем вы можете войти в систему во время установки шлюза, используя эти имя пользователя и пароль.

  * Учетная запись Azure должна принадлежать только к одному [клиенту или каталогу Azure Active Directory (Azure AD)](../active-directory/fundamentals/active-directory-whatis.md#terminology). Для установки и администрирования шлюза на локальном компьютере необходимо использовать одну и ту же учетную запись Azure.

  * При установке шлюза вы входите с помощью учетной записи Azure, которая связывает установку шлюза с учетной записью Azure и только с этой учетной записью. Вы не можете связать одну установку шлюза с несколькими учетными записями Azure или клиентами Azure AD.

  * Далее в портал Azure необходимо использовать одну и ту же учетную запись Azure для создания ресурса шлюза Azure, который ссылается на установку шлюза. Вы можете связать между собой только одну установку шлюза и один ресурс шлюза Azure. Однако учетная запись Azure может ссылаться на разные установки шлюза, связанные с ресурсом шлюза Azure. Затем приложения логики смогут использовать этот ресурс шлюза в триггерах и действиях, которые могут получать доступ к локальным источникам данных.

* Требования для локального компьютера приведены ниже.

  **Минимальные требования**

  * .NET Framework 4.7.2.
  * 64-разрядная версия Windows 7 или Windows Server 2008 R2 (или более поздняя версия).

  **Рекомендуемые требования**

  * 8-ядерный ЦП.
  * 8 ГБ ОЗУ.
  * 64-разрядная версия Windows Server 2012 R2 (или более поздняя версия).
  * Хранилище на твердотельных накопителях (SSD) для буферизации.

  > [!NOTE]
  > Шлюз не поддерживает Windows Server Core.

* **Сопутствующие рекомендации**

  * Локальный шлюз данных должен быть установлен только на локальном компьютере, который не является контроллером домена. Не нужно устанавливать шлюз на компьютере, на котором размещен источник данных. Для всех источников данных потребуется только один шлюз, поэтому нет необходимости устанавливать шлюз для каждого источника данных.

    > [!TIP]
    > Чтобы свести к минимуму задержки, шлюз можно установить как можно ближе к источнику данных или даже на том же компьютере, если только у вас есть соответствующие разрешения.

  * Установите шлюз на локальный компьютер в проводной сети, подключенной к Интернету, который всегда включен и не переходит в спящий режим. В противном случае шлюз не будет функционировать и может наблюдаться снижение производительности при использовании беспроводной сети.

  * Если вы планируете использовать проверку подлинности Windows, убедитесь, что шлюз установлен на компьютере, который является членом той же среды Active Directory, что и источники данных.

  * Регион, выбранный для установки шлюза, необходимо будет выбрать при последующем создании ресурса шлюза Azure для приложения логики. По умолчанию этот регион совпадает с расположением арендатора Azure AD, который управляет учетной записью Azure. Однако это расположение можно изменить во время установки шлюза.

  * При обновлении установки шлюза сначала удалите текущий шлюз, чтобы снизить вероятность ошибок.

    Рекомендуется убедиться, что используется поддерживаемая версия. Корпорация Майкрософт выпускает обновление для локального шлюза данных каждый месяц и в настоящее время поддерживает только последние шесть выпусков локального шлюза данных. При возникновении проблем с версией, которую вы используете, попробуйте выполнить [обновление до последней версии](https://aka.ms/on-premises-data-gateway-installer), так как проблема может быть устранена в последней версии.

  * Шлюз поддерживает два режима: стандартный режим и персональный режим, который применяется только для Power BI. На одном компьютере невозможно запустить несколько шлюзов в одном режиме.

  * Azure Logic Apps поддерживает операции чтения и записи через шлюз. Однако эти операции имеют [ограничения для размера полезных данных](/data-integration/gateway/service-gateway-onprem#considerations).

<a name="install-gateway"></a>

## <a name="install-data-gateway"></a>Установка шлюза данных

1. [Скачайте и запустите установщик шлюза на локальном компьютере](https://aka.ms/on-premises-data-gateway-installer).

1. Просмотрите минимальные требования, оставьте путь установки по умолчанию, примите условия использования, а затем выберите **Установить**.

   ![Проверка требований и принятие условий использования](./media/logic-apps-gateway-install/review-and-accept-terms-of-use.png)

1. После успешной установки шлюза укажите адрес электронной почты учетной записи Azure и выберите **Вход**, как показано ниже.

   ![Выполнение входа в рабочую или учебную учетную запись](./media/logic-apps-gateway-install/sign-in-gateway-install.png)

   Установку шлюза можно связать только с одной учетной записью Azure.

1. Выберите **Регистрация нового шлюза на этом компьютере** > **Далее**. Установка шлюза будет зарегистрирована в [облачной службе шлюза](#gateway-cloud-service).

   ![Регистрация шлюза на локальном компьютере](./media/logic-apps-gateway-install/register-gateway-local-computer.png)

1. Для установки шлюза необходимо указать следующие сведения.

   * Имя шлюза, уникальное в арендаторе Azure AD.
   * Ключ восстановления, длина которого должна быть не менее восьми знаков.
   * Подтверждение ключа восстановления

   ![Для установки шлюза необходимо указать следующие сведения.](./media/logic-apps-gateway-install/gateway-name-recovery-key.png)

   > [!IMPORTANT]
   > Сохраните и держите ключ восстановления в безопасном месте. Этот ключ потребуется, если возникнет необходимость изменить расположение установки шлюза, переместить, восстановить ее или взять над ней управление.

   Обратите внимание на параметр **Добавить в существующий кластер шлюза**, который можно выбрать при установке дополнительных шлюзов для [реализации высокого уровня доступности](#high-availability).

1. Проверьте регион облачной службы шлюза и [экземпляра обмена сообщениями служебной шины Azure](../service-bus-messaging/service-bus-messaging-overview.md) , которые используются при установке шлюза. По умолчанию этот регион совпадает с расположением арендатора Azure AD для вашей учетной записи Azure.

   ![Подтверждение региона для службы шлюза и служебной шины](./media/logic-apps-gateway-install/confirm-gateway-region.png)

1. Чтобы принять регион по умолчанию, выберите **Настроить**. Однако если регион по умолчанию не является ближайшим к вам, можно выбрать другой регион.

   *Причины изменения региона установки шлюза.*

   Например, чтобы уменьшить задержку, можно изменить регион своего шлюза на тот регион, что и в приложении логики. Или можно выбрать регион, который находится ближе всего к локальному источнику данных. *Ресурс шлюза в Azure* и приложение логики могут размещаться в разных расположениях.

   1. Рядом с текущим регионом выберите **Изменить регион**.

      ![Изменение текущего региона шлюза](./media/logic-apps-gateway-install/change-gateway-service-region.png)

   1. На следующей странице откройте список **Выбрать регион**, выберите требуемый регион и нажмите кнопку **Готово**.

      ![Выбор другого региона для службы шлюза](./media/logic-apps-gateway-install/select-region-gateway-install.png)

1. Проверьте сведения в окне окончательного подтверждения. В этом примере одна и та же учетная запись используется для Logic Apps, Power BI, Power Apps и Power Automate, поэтому шлюз доступен для всех этих служб. Когда будете готовы, нажмите кнопку **Закрыть**.

   ![Подтверждение сведений о шлюзе данных](./media/logic-apps-gateway-install/finished-gateway-default-location.png)

1. Теперь [создайте ресурс Azure для установки шлюза](../logic-apps/logic-apps-gateway-connection.md).

## <a name="check-or-adjust-communication-settings"></a>Проверка или настройка параметров подключения

Локальный шлюз данных зависит от [обмена сообщениями служебной шины Azure](../service-bus-messaging/service-bus-messaging-overview.md) для подключения к облаку и устанавливает соответствующие исходящие подключения к соответствующему региону Azure шлюза. Если ваша рабочая среда требует, чтобы трафик проработал через прокси-сервер или брандмауэр для доступа к Интернету, это ограничение может препятствовать подключению локального шлюза данных к облачной службе шлюза и обмену сообщениями служебной шины Azure. Шлюз имеет несколько параметров подключения, которые можно настроить. Дополнительные сведения см. в следующих статьях:

* [Настройка параметров подключения для локального шлюза данных](/data-integration/gateway/service-gateway-communication)
* [Настройка параметров прокси-сервера для локального шлюза данных](/data-integration/gateway/service-gateway-proxy)

<a name="high-availability"></a>

## <a name="high-availability-support"></a>Поддержка высокой доступности

Чтобы избежать создания единых точек отказа для доступа к локальным данным, можно установить несколько шлюзов (только в стандартном режиме) на разных компьютерах и настроить их как кластер или группу. Таким образом, если основной шлюз окажется недоступен, то запросы данных будут перенаправляться на второй шлюз, и т. д. Так как на компьютер можно установить только один шлюз в стандартном режиме, все дополнительные шлюзы в кластере необходимо установить на отдельных компьютерах. Все соединители, работающие с локальным шлюзом данных, поддерживают высокий уровень доступности.

* У вас уже должна быть хотя бы одна установка шлюза для учетной записи Azure, с которой связан основной шлюз, и ключ восстановления для этой установки.

* На основном шлюзе должны быть установлены обновления от ноября 2017 г. или более ранние.

Настроив основной шлюз, перейдите к установке другого шлюза и выберите **Добавить в существующий кластер шлюза**, выберите основной шлюз, который является первым установленным вами шлюзом, и укажите ключ восстановления для него. Дополнительные сведения см. в разделе [Кластеры с высоким уровнем доступности для локальных шлюзов данных](/data-integration/gateway/service-gateway-install#add-another-gateway-to-create-a-cluster).

<a name="update-gateway-installation"></a>

## <a name="change-location-migrate-restore-or-take-over-existing-gateway"></a>Изменение расположения, миграции, восстановления или перехват имеющегося шлюза

Если необходимо изменить расположение шлюза, переместить установку шлюза на новый компьютер, восстановить поврежденный шлюз или использовать владельца существующего шлюза, вам потребуется ключ восстановления, предоставленный во время установки шлюза.

> [!NOTE]
> Прежде чем восстанавливать шлюз на компьютере с исходной установкой шлюза, необходимо сначала удалить шлюз на этом компьютере. С помощью этого действия исходный шлюз будет отключен.
> Если вы удалите кластер шлюза для какой-либо облачной службы, то вы не сможете восстановить этот кластер.

1. Запустите установщик шлюза на компьютере со шлюзом.

1. После открытия установщика войдите с рабочей или учебной учетной записью Azure, которая использовалась при установке шлюза.

1. Выберите **Перемещение, восстановление существующего шлюза или получение права владения им** > **Далее**, как показано ниже.

   ![Выберите "Перенос, восстановление или перехват имеющегося шлюза"](./media/logic-apps-gateway-install/migrate-recover-take-over-gateway.png)

1. Выберите кластер и шлюз из списков доступных кластеров и шлюзов и введите ключ восстановления для выбранного шлюза, как показано ниже.

   ![Выбор шлюза и ввод ключа восстановления](./media/logic-apps-gateway-install/select-existing-gateway.png)

1. Чтобы изменить регион, выберите **Изменить регион**, а затем выберите новый регион.

1. Когда будете готовы, выберите **Настроить**, чтобы завершить процедуру.

## <a name="tenant-level-administration"></a>Администрирование на уровне арендатора

Чтобы увидеть все локальные шлюзы данных в арендаторе Azure AD, глобальные администраторы в этом арендаторе могут войти в [центр администрирования Power Platform](https://powerplatform.microsoft.com) в качестве администратора арендатора и выбрать параметр **Шлюзы данных**. Дополнительные сведения см. в разделе [Предварительная версия: управление локальным шлюзом данных](/data-integration/gateway/service-gateway-tenant-level-admin).

<a name="restart-gateway"></a>

## <a name="restart-gateway"></a>Перезапуск шлюза

По умолчанию установка шлюза на локальном компьютере выполняется как учетная запись службы Windows, которая называется "Служба локального шлюза данных". Однако установка шлюза использует имя `NT SERVICE\PBIEgwService` для учетной записи в поле "Использовать для входа" и имеет разрешения "Вход в качестве службы".

> [!NOTE]
> Учетная запись службы Windows отличается от учетной записи, которая использовалась для подключения к локальным источникам данных, и от учетной записи Azure, которая использовалась для входа в облачные службы.

Как и любая другая служба Windows, шлюз может быть запущен и остановлен различными способами. Дополнительные сведения см. в разделе [Перезапуск локального шлюза данных](/data-integration/gateway/service-gateway-restart).

<a name="gateway-cloud-service"></a>

## <a name="how-the-gateway-works"></a>Как работает шлюз

Пользователи в вашей организации могут обращаться к локальным данным, доступ к которым им уже разрешен. Тем не менее, чтобы эти пользователи могли подключаться к локальному источнику данных, необходимо установить и настроить локальный шлюз данных. Как правило, устанавливает и настраивает шлюз администратор. Для этих действий могут потребоваться разрешения администратора сервера или специальные знания о локальных серверах.

Шлюз обеспечивает более быстрый и безопасный обмен данными в фоновом режиме. Эти данные передаются между пользователем в облаке, облачной службой шлюза и локальным источником данных. Облачная служба шлюза шифрует и хранит учетные данные источников данных и сведения о шлюзах. Эта служба также перенаправляет запросы и их результаты между пользователем, шлюзом и локальным источником данных.

Шлюз работает с брандмауэрами и использует только исходящие соединения. Весь трафик поступает как безопасный исходящий трафик от агента шлюза. Шлюз отправляет данные из локальных источников в зашифрованные каналы через [Обмен сообщениями через служебную шину Azure](../service-bus-messaging/service-bus-messaging-overview.md). Служебная шина создает канал между шлюзом и службой вызовов, при этом она не хранит никаких данных. Шифруются все данные, которые передаются через шлюз.

![Архитектура локального шлюза данных](./media/logic-apps-gateway-install/how-on-premises-data-gateway-works-flow-diagram.png)

> [!NOTE]
> В зависимости от облачной службы может потребоваться настроить источник данных для шлюза.

В инструкциях ниже описывается, что происходит, когда пользователь в облаке взаимодействует с элементом, подключенным к локальному источнику данных.

1. Облачная служба создает запрос с зашифрованными учетными данными для источника данных. Затем служба отправляет запрос и учетные данные в очередь шлюза для обработки.

1. Облачная служба шлюза анализирует запрос и отправляет запрос в службу обмена сообщениями служебной шины Azure.

1. Служба обмена сообщениями служебной шины Azure отправляет в шлюз ожидающие запросы.

1. Шлюз получает запрос, расшифровывает учетные данные и подключается к одному или нескольким источникам данных, используя эти учетные данные.

1. Затем шлюз отправляет запрос к источнику данных для выполнения.

1. Результаты отправляются из источника данных обратно в шлюз, а затем — в облачную службу шлюза. Затем облачная служба шлюза использует эти результаты.

### <a name="authentication-to-on-premises-data-sources"></a>Аутентификация в локальных источниках данных

Сохраненные учетные данные используются для подключения шлюза к локальным источникам данных. Вне зависимости от того, какой пользователь отправил запрос, шлюз для подключения использует сохраненные учетные данные. Могут возникнуть исключения аутентификации для определенных служб, например DirectQuery и LiveConnect для Analysis Services в Power BI.

### <a name="azure-active-directory-azure-ad"></a>Azure Active Directory (Azure AD)

Облачные службы Майкрософт используют [Azure AD](../active-directory/fundamentals/active-directory-whatis.md) для аутентификации пользователей. Арендатор Azure AD содержит имена пользователей и группы безопасности. Как правило, адрес электронной почты, используемый для входа, совпадает с именем участника-пользователя для учетной записи.

### <a name="what-is-my-upn"></a>Какое у меня имя участника-пользователя?

Если вы не являетесь администратором домена, то вы можете не знать свое имя участника-пользователя. Чтобы найти имя участника-пользователя для своей учетной записи, выполните команду `whoami /upn` на рабочей станции. Хотя результат выглядит как адрес электронной почты, это имя участника-пользователя для учетной записи локального домена.

### <a name="synchronize-an-on-premises-active-directory-with-azure-ad"></a>Синхронизация локальной службы Active Directory с Azure AD

Имя участника-пользователя для локальных учетных записей Active Directory и учетных записей Azure AD должно быть одинаковым. Убедитесь, что имена локальной учетной записи Active Directory и учетной записи Azure AD совпадают. Облачные службы знают только об учетных записях в Azure AD. Поэтому не нужно добавлять учетную запись в локальную службу Active Directory. Если учетная запись не существует в Azure AD, то эту учетную запись использовать невозможно.

Ниже описывается, как разными способами можно сопоставить локальные учетные записи Active Directory с Azure AD.

* Вручную добавьте учетные записи в Azure AD.

  Создайте учетную запись на портале Azure или в центре администрирования Microsoft 365. Убедитесь, что имя этой учетной записи совпадает с именем участника-пользователя локальной учетной записи Active Directory.

* Синхронизируйте локальные учетные записи с арендатором Azure AD с помощью инструмента Azure Active Directory Connect.

  Инструмент Azure AD Connect предоставляет возможность настройки синхронизации каталогов и аутентификации. Можно настроить синхронизацию хэша паролей, сквозную аутентификацию и федерацию. Если вы не являетесь администратором арендатора или администратором локального домена, обратитесь к администратору ИТ для настройки Azure AD Connect. Azure AD Connect обеспечит соответствие имени участника-пользователя Azure AD и имени участника-пользователя локальной службы Active Directory. Это соответствие удобно использовать для активных подключений Analysis Services с использованием Power BI или единого входа (SSO).

  > [!NOTE]
  > При синхронизации учетных записей с помощью инструмента Azure AD Connect создаются новые учетные записи в арендаторе Azure AD.

<a name="faq"></a>

## <a name="faq-and-troubleshooting"></a>Часто задаваемые вопросы и устранение неполадок

* [Вопросы и ответы о локальном шлюзе данных](/data-integration/gateway/service-gateway-onprem-faq)
* [Устранение неполадок с локальным шлюзом данных](/data-integration/gateway/service-gateway-tshoot)
* [Мониторинг и оптимизация производительности шлюза](/data-integration/gateway/service-gateway-performance)

## <a name="next-steps"></a>Дальнейшие действия

* [Подключение к локальным данным из приложений логики](../logic-apps/logic-apps-gateway-connection.md)
* [Возможности интеграции Enterprise](../logic-apps/logic-apps-enterprise-integration-overview.md)
* [Список соединителей](../connectors/apis-list.md)
