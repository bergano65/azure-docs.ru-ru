---
title: Блокировать подключения для конкретных соединителей API
description: Ограничение создания и использования подключений API в Azure Logic Apps
services: logic-apps
ms.suite: integration
ms.reviewer: deli, logicappspm
ms.topic: conceptual
ms.date: 06/19/2020
ms.openlocfilehash: 6563f3e263867387332940db58abff62e085cded
ms.sourcegitcommit: ec682dcc0a67eabe4bfe242fce4a7019f0a8c405
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2020
ms.locfileid: "86187699"
---
# <a name="block-connections-created-by-connectors-in-azure-logic-apps"></a>Блокировать подключения, созданные соединителями, в Azure Logic Apps

Если ваша организация не позволяет подключаться к ограниченным или неодобренным ресурсам с помощью соединителей в Azure Logic Apps, можно заблокировать возможность создания и использования этих подключений в рабочих процессах приложения логики. С помощью [политики Azure](../governance/policy/overview.md)можно определять и применять [политики](../governance/policy/overview.md#policy-definition) , предотвращающие создание или использование подключений для соединителей, которые требуется заблокировать. Например, в целях безопасности может потребоваться блокировать подключения к конкретным платформам социальных сетей или другим службам и системам.

В этом разделе показано, как настроить политику, которая блокирует определенные подключения с помощью портал Azure, но вы можете создавать определения политик другими способами, например с помощью шаблонов Azure REST API, Azure PowerShell, Azure CLI и Azure Resource Manager. Дополнительные сведения см. [в разделе Учебник. Создание политик и управление ими для обеспечения соответствия](../governance/policy/tutorials/create-and-manage.md).

## <a name="prerequisites"></a>Обязательные условия

* Подписка Azure. Если у вас нет подписки, [Создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/) перед началом работы.

* Идентификатор ссылки для соединителя, который необходимо заблокировать. Дополнительные сведения см. [в разделе Поиск идентификатора ссылки на соединитель](#connector-reference-ID).

<a name="connector-reference-ID"></a>

## <a name="find-connector-reference-id"></a>Поиск идентификатора ссылки на соединитель

Если у вас уже есть приложение логики с подключением, которое необходимо заблокировать, выполните [действия для портал Azure](#connector-ID-portal). В противном случае выполните следующие действия.

1. Посетите [список соединителей Logic Apps](https://docs.microsoft.com/connectors/connector-reference/connector-reference-logicapps-connectors).

1. Найдите страницу ссылки для соединителя, который требуется заблокировать.

   Например, если вы хотите заблокировать соединитель Instagram, перейдите на эту страницу: 
   
   `https://docs.microsoft.com/connectors/instagram/`

1. В URL-адресе страницы скопируйте и сохраните идентификатор ссылки соединителя в конце без косой черты ( `/` ), например `instagram` .

   Позднее при создании определения политики этот идентификатор используется в операторе условия определения, например:

   `"like": "*managedApis/instagram"`

<a name="connector-ID-portal"></a>

### <a name="azure-portal"></a>Портал Azure

1. В [портал Azure](https://portal.azure.com)найдите и откройте приложение логики.

1. В меню приложение логики выберите **представление кода приложения** логики, чтобы можно было просмотреть определение JSON приложения логики.

   ![Откройте окно "представление кода приложения логики", чтобы найти идентификатор соединителя.](./media/block-connections-connectors/code-view-connector-id.png)

1. Найдите `parameters` объект, содержащий `$connections` объект, который содержит `{connection-name}` объект для каждого подключения в приложении логики и задает сведения об этом соединении:

   ```json
   {
      "parameters": {
         "$connections": {
            "value" : {
               "{connection-name}": {
                  "connectionId": "/subscriptions/{Azure-subscription-ID}/resourceGroups/{Azure-resource-group-name}/providers/Microsoft.Web/connections/{connection-name}",
                  "connectionName": "{connection-name}",
                  "id": "/subscriptions/{Azure-subscription-ID}/providers/Microsoft.Web/locations/{Azure-region}/managedApis/{connection-name}"
               }
            }
         }
      }
   }
   ```

   Например, для соединителя Instagram найдите `instagram` объект, который определяет подключение Instagram:

   ```json
   {
      "parameters": {
         "$connections": {
            "value" : {
               "instagram": {
                  "connectionId": "/subscriptions/xxxxxXXXXXxxxxxXXXXXxxxxxXXXXX/resourceGroups/MyLogicApp-RG/providers/Microsoft.Web/connections/instagram",
                  "connectionName": "instagram",
                  "id": "/subscriptions/xxxxxXXXXXxxxxxXXXXXxxxxxXXXXX/providers/Microsoft.Web/locations/westus/managedApis/instagram"
               }
            }
         }
      }
   }
   ```

1. Для подключения, которое необходимо заблокировать, найдите `id` свойство и значение, которое следует в следующем формате: 

   `"id": "/subscriptions/{Azure-subscription-ID}/providers/Microsoft.Web/locations/{Azure-region}/managedApis/{connection-name}"`

   Например, вот `id` свойство и значение для подключения Instagram:

   `"id": "/subscriptions/xxxxxXXXXXxxxxxXXXXXxxxxxXXXXX/providers/Microsoft.Web/locations/westus/managedApis/instagram"`

1. Из `id` значения свойства скопируйте и сохраните идентификатор ссылки соединителя в конце, например `instagram` .

   Позднее при создании определения политики этот идентификатор используется в операторе условия определения, например:

   `"like": "*managedApis/instagram"`

<a name="create-policy-connections"></a>

## <a name="create-policy-to-block-creating-connections"></a>Создать политику для блокировки создания подключений

Чтобы полностью заблокировать создание подключения в приложении логики, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com). В поле поиска на портале введите `policy` и выберите **Политика**.

   ![В портал Azure найдите и выберите "политика".](./media/block-connections-connectors/find-select-azure-policy.png)

1. В меню **Политика** в разделе **Создание**выберите **определения**  >  **и определение политики**.

   ![Выберите "определения" > "+ определение политики"](./media/block-connections-connectors/add-new-policy-definition.png)

1. В разделе **Определение политики**укажите сведения для определения политики на основе свойств, описанных в примере.

   ![Свойства определения политики](./media/block-connections-connectors/policy-definition-create-connections-1.png)

   | Property (Свойство) | Обязательно | Значение | Описание |
   |----------|----------|-------|-------------|
   | **Расположение определения** | Да | <*Azure-subscription-name*> | Подписка Azure, используемая для определения политики. <p><p>1. чтобы найти подписку, нажмите кнопку с многоточием (**...**). <br>2. в списке **Подписка** найдите и выберите свою подписку. <br>3. по завершении нажмите **кнопку Выбрать**. |
   | **Имя** | Да | <*Политика-определение-имя*> | Имя, используемое для определения политики |
   | **Описание** | Нет | <*Политика-определение-имя*> | Описание определения политики |
   | **Категория** | Да | **Приложения логики** | Имя существующей категории или новой категории для определения политики |
   | **Принудительное применение политик** | Да | **Включено** | Этот параметр указывает, следует ли включать или отключать определение политики при сохранении работы. |
   ||||

1. В разделе **правило политики**поле ввода JSON предварительно заполнено шаблоном определения политики. Замените этот шаблон [определением политики](../governance/policy/concepts/definition-structure.md) на основе свойств, описанных в таблице ниже, и с помощью следующего синтаксиса:

   ```json
   {
      "mode": "All",
      "policyRule": {
         "if": {
            "field": "Microsoft.Web/connections/api.id",
            "like": "*managedApis/{connector-name}"
         },
         "then": {
            "effect": "deny"
         }
      },
      "parameters": {}
    }
    ```

   | Property (Свойство) | Применение | Описание |
   |----------|-------|-------------|
   | `mode` | `All` | Режим, определяющий типы ресурсов, которые оценивает политика. <p><p>Этот сценарий задает `mode` для значение `All` , которое применяет политику к группам ресурсов, подпискам и типам ресурсов Azure. <p><p>Дополнительные сведения см. в статье [Определение политики — режим структуры](../governance/policy/concepts/definition-structure.md#mode). |
   | `if` | `{condition-to-evaluate}` | Условие, определяющее, когда следует применять правило политики <p><p>В этом сценарии объект `{condition-to-evaluate}` определяет, соответствует ли `api.id` значение в параметре `Microsoft.Web/connections/api.id` `*managedApis/{connector-name}` , которое указывает подстановочное значение (*). <p><p>Дополнительные сведения см. в разделе [Определение политики структура — правило политики](../governance/policy/concepts/definition-structure.md#policy-rule). |
   | `field` | `Microsoft.Web/connections/api.id` | `field`Значение для сравнения с условием <p><p>В этом сценарии `field` компонент использует [*псевдоним*](../governance/policy/concepts/definition-structure.md#aliases), `Microsoft.Web/connections/api.id` для доступа к значению в свойстве соединителя `api.id` . |
   | `like` | `*managedApis/{connector-name}` | Логический оператор и значение, используемые для сравнения `field` значения <p><p>В этом сценарии `like` оператор и символ-шаблон (*) позволяют убедиться, что правило работает независимо от региона, а строка, `*managedApis/{connector-name}` , — это значение, которое должно соответствовать, где `{connector-name}` — это идентификатор соединителя, который требуется заблокировать. <p><p>Например, предположим, что вы хотите заблокировать создание подключений к платформам или базам данных социальных сетей: <p><p>Сайте`twitter` <br>Instagram`instagram` <br>Facebook`facebook` <br>Pinterest`pinterest` <br>-SQL Server или Azure SQL:`sql` <p><p>Чтобы найти эти идентификаторы соединителей, ознакомьтесь с разделом [Поиск идентификатора ссылки соединителя](#connector-reference-ID) ранее в этом разделе. |
   | `then` | `{effect-to-apply}` | Результат, применяемый при `if` выполнении условия <p><p>В этом сценарии компонент `{effect-to-apply}` предназначен для блокировки и сбоя запроса или операции, которые не соответствуют политике. <p><p>Дополнительные сведения см. в разделе [Определение политики структура — правило политики](../governance/policy/concepts/definition-structure.md#policy-rule). |
   | `effect` | `deny` | `effect`— Блокировка запроса, который создает указанное соединение. <p><p>Дополнительные сведения см. в статье сведения о [влиянии политики Azure — Deny](../governance/policy/concepts/effects.md#deny). |
   ||||

   Например, предположим, что необходимо заблокировать создание подключений с помощью соединителя Instagram. Ниже приведено определение политики, которое можно использовать.

   ```json
   {
      "mode": "All",
      "policyRule": {
         "if": {
            "field": "Microsoft.Web/connections/api.id",
            "like": "*managedApis/instagram"
         },
         "then": {
            "effect": "deny"
         }
      },
      "parameters": {}
   }
   ```

   Вот как выглядит поле **правила политики** :

   ![Правило для определения политики](./media/block-connections-connectors/policy-definition-create-connections-2.png)

   Для нескольких соединителей можно добавить дополнительные условия, например:

   ```json
   {
      "mode": "All",
      "policyRule": {
         "if": {
            "anyOf": [
               {
                  "field": "Microsoft.Web/connections/api.id",
                  "like": "*managedApis/instagram"
               },
               {
                  "field": "Microsoft.Web/connections/api.id",
                  "like": "*managedApis/twitter"
               },
               {
                  "field": "Microsoft.Web/connections/api.id",
                  "like": "*managedApis/facebook"
               },
               {
                  "field": "Microsoft.Web/connections/api.id",
                  "like": "*managedApis/pinterest"
               }
            ]
         },
         "then": {
            "effect": "deny"
         }
      },
      "parameters": {}
    }
    ```

1. Когда все будет готово, нажмите кнопку **Сохранить**. После сохранения определения политики Azure создает и добавляет в определение политики дополнительные значения свойств.

1. Далее, чтобы назначить определение политики, в котором необходимо применить политику, [Создайте назначение политики](#create-policy-assignment).

Дополнительные сведения об определениях политик Azure см. в следующих разделах:

* [Определение структуры политики](../governance/policy/concepts/definition-structure.md)
* [Руководство по Создание политик и управление ими для обеспечения соответствия требованиям](../governance/policy/tutorials/create-and-manage.md)
* [Встроенные определения политик в Политике Azure для Azure Logic Apps](../logic-apps/policy-samples.md)

<a name="create-policy-connector-usage"></a>

## <a name="create-policy-to-block-using-connections"></a>Создание политики для блокировки с помощью подключений

При создании подключения внутри приложения логики это подключение существует как отдельный ресурс Azure. Если удалить только приложение логики, подключение не будет автоматически удалено и будет существовать до удаления. Возможно, имеется сценарий, в котором соединение уже существует или необходимо создать подключение для использования вне приложения логики. Вы по-прежнему можете заблокировать возможность использования существующего подключения в приложении логики, создав политику, запрещающую сохранение приложений логики с ограниченным или неодобренным подключением.

1. Войдите на [портал Azure](https://portal.azure.com). В поле поиска на портале введите `policy` и выберите **Политика**.

   ![В портал Azure найдите и выберите "политика".](./media/block-connections-connectors/find-select-azure-policy.png)

1. В меню **Политика** в разделе **Создание**выберите **определения**  >  **и определение политики**.

   ![Выберите "определения" > "+ определение политики"](./media/block-connections-connectors/add-new-policy-definition.png)

1. В разделе **Определение политики**укажите сведения для определения политики на основе свойств, описанных в примере, и продолжите с помощью Instagram в качестве примера:

   ![Свойства определения политики](./media/block-connections-connectors/policy-definition-using-connections-1.png)

   | Property (Свойство) | Обязательно | Значение | Описание: |
   |----------|----------|-------|-------------|
   | **Расположение определения** | Да | <*Azure-subscription-name*> | Подписка Azure, используемая для определения политики. <p><p>1. чтобы найти подписку, нажмите кнопку с многоточием (**...**). <br>2. в списке **Подписка** найдите и выберите свою подписку. <br>3. по завершении нажмите **кнопку Выбрать**. |
   | **Имя** | Да | <*Политика-определение-имя*> | Имя, используемое для определения политики |
   | **Описание** | Нет | <*Политика-определение-имя*> | Описание определения политики |
   | **Категория** | Да | **Приложения логики** | Имя существующей категории или новой категории для определения политики |
   | **Принудительное применение политик** | Да | **Включено** | Этот параметр указывает, следует ли включать или отключать определение политики при сохранении работы. |
   ||||

1. В разделе **правило политики**поле ввода JSON предварительно заполнено шаблоном определения политики. Замените этот шаблон [определением политики](../governance/policy/concepts/definition-structure.md) на основе свойств, описанных в таблице ниже, и с помощью следующего синтаксиса:

   ```json
   {
      "mode": "All",
      "policyRule": {
         "if": {
            "value": "[string(field('Microsoft.Logic/workflows/parameters'))]",
            "contains": "{connector-name}"
         },
         "then": {
            "effect": "deny"
         }
      },
      "parameters": {}
    }
    ```

   | Property (Свойство) | Применение | Описание: |
   |----------|-------|-------------|
   | `mode` | `All` | Режим, определяющий типы ресурсов, которые оценивает политика. <p><p>Этот сценарий задает `mode` для значение `All` , которое применяет политику к группам ресурсов, подпискам и типам ресурсов Azure. <p><p>Дополнительные сведения см. в статье [Определение политики — режим структуры](../governance/policy/concepts/definition-structure.md#mode). |
   | `if` | `{condition-to-evaluate}` | Условие, определяющее, когда следует применять правило политики <p><p>В этом сценарии определяет, `{condition-to-evaluate}` содержит ли строковый выход из строку `[string(field('Microsoft.Logic/workflows/parameters'))]` , `{connector-name}` . <p><p>Дополнительные сведения см. в разделе [Определение политики структура — правило политики](../governance/policy/concepts/definition-structure.md#policy-rule). |
   | `value` | `[string(field('Microsoft.Logic/workflows/parameters'))]` | Значение для сравнения с условием <p><p>В этом сценарии `value` — это строка выходных данных из `[string(field('Microsoft.Logic/workflows/parameters'))]` , которая преобразует `$connectors` объект внутри `Microsoft.Logic/workflows/parameters` объекта в строку. |
   | `contains` | `{connector-name}` | Логический оператор и значение, используемые для сравнения со `value` свойством <p><p>В этом сценарии Оператор гарантирует `contains` , что правило работает независимо от того `{connector-name}` , где отображается, где строка, `{connector-name}` — это идентификатор соединителя, который необходимо ограничить или заблокировать. <p><p>Например, предположим, что вы хотите блокировать использование подключений к платформам или базам данных социальных сетей: <p><p>Сайте`twitter` <br>Instagram`instagram` <br>Facebook`facebook` <br>Pinterest`pinterest` <br>-SQL Server или Azure SQL:`sql` <p><p>Чтобы найти эти идентификаторы соединителей, ознакомьтесь с разделом [Поиск идентификатора ссылки соединителя](#connector-reference-ID) ранее в этом разделе. |
   | `then` | `{effect-to-apply}` | Результат, применяемый при `if` выполнении условия <p><p>В этом сценарии компонент `{effect-to-apply}` предназначен для блокировки и неудачного выполнения запроса или операции, который не соответствует политике. <p><p>Дополнительные сведения см. в разделе [Определение политики структура — правило политики](../governance/policy/concepts/definition-structure.md#policy-rule). |
   | `effect` | `deny` | `effect`— `deny` Или блокирует запрос на сохранение приложения логики, использующего указанное соединение. <p><p>Дополнительные сведения см. в статье сведения о [влиянии политики Azure — Deny](../governance/policy/concepts/effects.md#deny). |
   ||||

   Например, предположим, что вы хотите заблокировать сохранение приложений логики, использующих подключения Instagram. Ниже приведено определение политики, которое можно использовать.

   ```json
   {
      "mode": "All",
      "policyRule": {
         "if": {
            "value": "[string(field('Microsoft.Logic/workflows/parameters'))]",
            "contains": "instagram"
         },
         "then": {
            "effect": "deny"
         }
      },
      "parameters": {}
    }
    ```

   Вот как выглядит поле **правила политики** :

   ![Правило для определения политики](./media/block-connections-connectors/policy-definition-using-connections-2.png)

1. Когда все будет готово, нажмите кнопку **Сохранить**. После сохранения определения политики Azure создает и добавляет в определение политики дополнительные значения свойств.

1. Далее, чтобы назначить определение политики, в котором необходимо применить политику, [Создайте назначение политики](#create-policy-assignment).

Дополнительные сведения об определениях политик Azure см. в следующих разделах:

* [Определение структуры политики](../governance/policy/concepts/definition-structure.md)
* [Руководство по Создание политик и управление ими для обеспечения соответствия требованиям](../governance/policy/tutorials/create-and-manage.md)
* [Встроенные определения политик в Политике Azure для Azure Logic Apps](../logic-apps/policy-samples.md)

<a name="create-policy-assignment"></a>

## <a name="create-policy-assignment"></a>Создание назначения политики

Далее необходимо назначить определение политики, в которой необходимо принудительно применить политику, например, к одной группе ресурсов, нескольким группам ресурсов, Azure Active Directory клиенту (Azure AD) или подписке Azure. Для выполнения этой задачи выполните следующие действия, чтобы создать назначение политики.

1. Если вы вышли из нее, войдите в [портал Azure](https://portal.azure.com). В поле поиска на портале введите `policy` и выберите **Политика**.

   ![В портал Azure найдите и выберите "политика".](./media/block-connections-connectors/find-select-azure-policy.png)

1. В меню **Политика** в разделе **Разработка**выберите **назначения**  >  **назначить политику**.

   ![Выберите "назначения" > "назначить"](./media/block-connections-connectors/add-new-policy-assignment.png)

1. В разделе **основные**сведения укажите эту информацию для назначения политики.

   | Property (Свойство) | Обязательно | Описание |
   |----------|----------|-------------|
   | **Область действия** | Да | Ресурсы, для которых необходимо применить назначение политики. <p><p>1. рядом с полем **область** нажмите кнопку с многоточием (**...**). <br>2. в списке **Подписка** выберите подписку Azure. <br>3. при необходимости выберите группу ресурсов в списке **Группа ресурсов** . <br>4. по завершении нажмите **кнопку Выбрать**. |
   | **Исключения** | Нет | Все ресурсы Azure, которые необходимо исключить из назначения политики. <p><p>1. рядом с полем **исключения** нажмите кнопку с многоточием (**...**). <br>2. в списке **ресурсов** выберите ресурс > **Добавить в выбранную область**. <br>3. по завершении нажмите кнопку **сохранить**. |
   | **Определение политики** | Да | Имя определения политики, которое необходимо назначить и применить. Этот пример продолжится с примером Instagram политики "блокировать Instagram подключения". <p><p>1. рядом с полем **определения политики** нажмите кнопку с многоточием (**...**). <br>2. Найдите и выберите определение политики с помощью фильтра по **типу** или поля **поиска** . <br>3. по завершении нажмите **кнопку Выбрать**. |
   | **Имя назначения** | Да | Имя, используемое для назначения политики, если оно отличается от определения политики |
   | **Идентификатор назначения** | Да | Автоматически созданный идентификатор для назначения политики |
   | **Описание** | Нет | Описание назначения политики |
   | **Принудительное применение политик** | Да | Параметр, который включает или отключает назначение политики. |
   | **Кем назначено** | Нет | Имя пользователя, который создал и применил назначение политики |
   ||||

   Например, чтобы назначить политику группе ресурсов Azure с помощью примера Instagram, выполните следующие действия.

   ![Свойства назначения политики](./media/block-connections-connectors/policy-assignment-basics.png)

1. Когда все будет готово, выберите **Просмотр и создание**.

   После создания политики может потребоваться подождать до 15 минут, прежде чем политика вступит в силу. Изменения также могут иметь аналогичные отложенные эффекты.

1. После того, как политика вступит в силу, можно [протестировать политику](#test-policy).

Дополнительные сведения см. [в разделе Краткое руководство. Создание назначения политики для обнаружения ресурсов, которые не соответствуют требованиям](../governance/policy/assign-policy-portal.md).

<a name="test-policy"></a>

## <a name="test-the-policy"></a>Проверка политики

Чтобы проверить политику, приступите к созданию подключения с помощью соединителя с ограниченным доступом в конструкторе приложений логики. Если продолжить работу с примером Instagram, то при входе в Instagram появляется сообщение об ошибке, которое приложение логики не смогло создать подключение:

![Сбой подключения из-за примененной политики](./media/block-connections-connectors/connection-failure-message.png)

Сообщение содержит следующие сведения:

| Описание | Содержимое |
|---|---|
| Причина сбоя | `"Resource 'instagram' was disallowed by policy."` |
| Имя назначения | `"Block Instagram connections"` |
| Идентификатор назначения | `"/subscriptions/xxxxxXXXXXxxxxxXXXXXxxxxxXXXXX/resourceGroups/MyLogicApp-RG/providers/Microsoft.Authorization/policyAssignments/4231890fc3bd4352acb0b673"` |
| Идентификатор определения политики | `"/subscriptions/xxxxxXXXXXxxxxxXXXXXxxxxxXXXXX/providers/Microsoft.Authorization/policyDefinitions/b5ddcfec-1b24-4cac-a353-360846a59f24"` |
|||

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о [политике Azure](../governance/policy/overview.md)