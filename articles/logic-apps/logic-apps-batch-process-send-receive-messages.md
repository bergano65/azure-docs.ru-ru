---
title: Пакетная обработка сообщений в виде группы
description: Отправка и получение сообщений в группах между рабочими процессами с помощью пакетной обработки в Azure Logic Apps
services: logic-apps
ms.suite: integration
author: divyaswarnkar
ms.author: divswa
ms.reviewer: estfan, jonfan, logicappspm
ms.topic: article
ms.date: 07/31/2020
ms.openlocfilehash: 0985afe3ddfd0d9de3c36ad6b030b6f259708c88
ms.sourcegitcommit: f988fc0f13266cea6e86ce618f2b511ce69bbb96
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/31/2020
ms.locfileid: "87458357"
---
# <a name="send-receive-and-batch-process-messages-in-azure-logic-apps"></a>Отправка, получение и пакетная обработка сообщений в Azure Logic Apps

Для отправки и обработки сообщений конкретным способом групп можно создать решение для пакетной обработки. Это решение собирает сообщения в *пакет* и ожидает, пока заданные условия не будут выполнены перед освобождением и обработкой пакетных сообщений. Пакетная обработка помогает снизить частоту обработки сообщений в приложении логики.

В этой статье показано, как создать решение для пакетной обработки, создав два приложения логики в рамках одной подписки Azure, региона Azure и в следующем порядке:

1. Приложение логики для [получения пакета](#batch-receiver) ("получатель"), которое принимает и собирает сообщения в пакет до тех пор, пока не будут выполнены определенные условия для отправки и обработки этих сообщений. Обязательно создайте этот приемник пакетной службы, чтобы позже можно было выбрать назначение пакета при создании отправителя пакета.

1. Одно или несколько приложений логики для [отправки пакетов](#batch-sender) ("отправители"), которые отправляют сообщения ранее созданному получателю пакетов.

   Вы также можете указать уникальный ключ, например номер клиента, чтобы *секционировать* (разделить) по этому ключу целевой пакет на подмножества. Это позволит получающему приложению получать все элементы с одинаковыми значениями ключа и обрабатывать их одновременно.

Получатель пакета и отправитель пакета должны использовать одну и ту же подписку Azure *и* регион Azure. В противном случае при создании отправителя пакетов вы не сможете выбрать получателя пакетов, так как они не видны друг другу.

## <a name="prerequisites"></a>Предварительные требования

* Учетная запись и подписка Azure. Если у вас нет подписки, вы можете [начать с бесплатной учетной записи Azure](https://azure.microsoft.com/free/). Или [зарегистрируйтесь для получения подписки с оплатой по мере использования](https://azure.microsoft.com/pricing/purchase-options/).

* Учетная запись электронной почты любого [поставщика электронной почты, поддерживаемого Azure Logic Apps](../connectors/apis-list.md).

  > [!IMPORTANT]
  > Только учетные записи для бизнеса G-Suite могут использовать соединитель Gmail без ограничений в приложениях логики. Если у вас есть учетная запись потребителя Gmail, вы можете использовать этот соединитель только с определенными утвержденными Google службами. Кроме того, вы можете [создать клиентское приложение Google, которое будет использоваться для проверки подлинности в соединителе Gmail](/connectors/gmail/#authentication-and-bring-your-own-application). Дополнительные сведения см. в статье [Политики безопасности и конфиденциальности данных для соединителей Google в Azure Logic Apps](../connectors/connectors-google-data-security-privacy-policy.md).

* Базовые знания [создания приложений логики](../logic-apps/quickstart-create-first-logic-app-workflow.md).

* Чтобы использовать Visual Studio вместо портал Azure, убедитесь, что вы [настроили Visual Studio для работы с Logic Apps](../logic-apps/quickstart-create-logic-apps-with-visual-studio.md).

<a name="batch-receiver"></a>

## <a name="create-batch-receiver"></a>Создание получателя пакетов

Прежде чем вы сможете отправлять сообщения в пакет, такой пакет должен существовать как назначение для отправки. Поэтому сначала необходимо создать приложение логики для получения пакета, которое запускает триггер **Пакет**. Тогда при создании приложения логики для отправки пакетов вы сможете выбрать это приложение логики для получения пакетов. Получатель пакетов продолжает собирать сообщения до тех пор, пока не будут выполнены определенные условия для отправки и обработки этих сообщений. Получателям пакетов не требуются сведения об отправителях пакетов, но отправители должны знать параметры назначения для отправки сообщений.

1. В [портал Azure](https://portal.azure.com) или Visual Studio создайте приложение логики с таким именем:`BatchReceiver`

1. В конструкторе приложений логики добавьте триггер **пакетной** службы, который запускает рабочий процесс приложения логики. В поле поиска введите `batch` и выберите этот триггер: **пакетные сообщения** .

   ![Добавление триггера "Пакетные сообщения"](./media/logic-apps-batch-process-send-receive-messages/add-batch-receiver-trigger.png)

1. Задайте эти свойства для получения пакетов:

   | Свойство | Описание |
   |----------|-------------|
   | **Пакетный режим** | - **Встроенный** — позволяет определить условия отправки прямо в триггере пакета. <br>- **Учетная запись интеграции** — позволяет определить несколько конфигураций для условий отправки с помощью [учетной записи интеграции](../logic-apps/logic-apps-enterprise-integration-create-integration-account.md). Благодаря учетной записи интеграции эти конфигурации можно сохранять в одном расположении, а не в отдельных приложениях логики. |
   | **Имя пакета** | В нашем примере пакет имеет имя TestBatch. Этот параметр применяется только к **встроенному** пакетному режиму. |
   | **Условия отправки** | Применяется только ко **встроенному** пакетному режиму и определяет критерии, которые должны выполняться для обработки каждого пакета: <p>- **Количество сообщений на основе**: освобождение пакета на основе количества сообщений, собранных пакетом. <br>- **На основе размера**: выпустите пакет на основе общего размера в байтах для всех сообщений, собираемых этим пакетом. <br>- **Расписание**: Освободите пакет на основе расписания повторений, которое указывает интервал и частоту. В дополнительных параметрах можно также выбрать часовой пояс и указать дату начала и время. <br>- **Выбрать все**. Задает использование всех настроенных условий. |
   | **Количество сообщений** | Определяет, сколько сообщений нужно собрать в одном пакете (например, 10). Ограничение пакета — 8000 сообщений. |
   | **Размер пакета** | Общий размер в байтах для сбора в пакете (например, 10 МБ). Ограничение размера пакета — 80 МБ. |
   | **Расписание** | Определяет интервал и частоту отправки пакетов (например, 10 минут). Минимальное значение повторов составляет 60 секунд (1 минута). Дробные значения минут округляются до 1 минуты. Чтобы указать часовой пояс или дату и время начала, откройте список **Добавить новый параметр** и выберите соответствующие свойства. |
   |||

   > [!NOTE]
   >
   > Если вы изменяете условие выпуска, когда в триггере еще есть пакетные неотправленные сообщения, триггер использует обновленные критерии выпуска для обработки неотправленных сообщений.

   В этом примере показаны все условия, но в своих тестах попробуйте выполнить только один критерий:

   ![Ввод сведений для триггера "Пакет"](./media/logic-apps-batch-process-send-receive-messages/batch-receiver-criteria.png)

1. Теперь добавьте одно или несколько действий для обработки каждого пакета.

   В нашем примере добавляется действие, которое отправляет сообщение электронной почты, когда срабатывает триггер "Пакет". Этот триггер запускается и отправляет сообщение электронной почты, когда в пакете собирается 10 сообщений, их общий размер достигает 10 МБ или проходит 10 минут.

   1. В разделе триггера пакетной службы выберите **новый шаг**.

   1. В поле поиска введите `send email` в качестве фильтра. Выберите соединитель электронной почты в зависимости от своего поставщика электронной почты.

      Например, если у вас есть рабочая или учебная учетная запись, например @fabrikam.com или @fabrikam.onmicrosoft.com , выберите соединитель **Outlook Microsoft 365** . Если у вас есть личная учетная запись, например @outlook.com или @hotmail.com , выберите соединитель **Outlook.com** . В этом примере используется соединитель Microsoft 365 Outlook.

   1. Выберите действие "отправить электронное письмо" для поставщика, например:

      ![Выбор действия "Отправить электронное письмо" для поставщика электронной почты](./media/logic-apps-batch-process-send-receive-messages/batch-receiver-send-email-action.png)

1. Если отобразится запрос на вход в учетную запись электронной почты, выполните его.

1. Задайте свойства для добавленного действия.

   * В поле **Кому** введите адрес электронной почты получателя. Для тестировании можете использовать свой собственный адрес.

   * В поле **Тема**, когда отобразится список динамического содержимого, выберите поле **Имя секции**.

     ![Выбор значения "Имя секции" в списке "Динамическое содержимое"](./media/logic-apps-batch-process-send-receive-messages/send-email-action-details.png)

     В следующем отправителе пакетов можно указать уникальный ключ секции, который разделит целевой пакет на логические наборы, в которые затем можно отправлять сообщения. Каждый набор имеет уникальный номер, который создается приложением логики, отправляющим пакеты. Эта функция позволяет использовать один пакет с несколькими подмножествами и определить каждое подмножество с помощью задаваемого имени.

     > [!IMPORTANT]
     > Раздел имеет ограничение в 5000 сообщений или 80 МБ. Если выполняется любое из этих условий, Logic Apps отправит очередной пакет даже без соблюдения условия отправки.

   * В поле **Текст**, когда отобразится список динамического содержимого, выберите поле **Идентификатор сообщения**.

     Конструктор приложений логики автоматически добавляет цикл **for each** вокруг действия Отправить сообщение, так как это действие рассматривает выходные данные предыдущего действия в виде коллекции, а не пакета.

     ![Выбор значения "Идентификатор сообщения" для поля "Текст"](./media/logic-apps-batch-process-send-receive-messages/send-email-action-details-for-each.png)

1. Сохраните приложение логики. Итак, вы создали получатель пакетов.

    ![Сохранение приложения логики](./media/logic-apps-batch-process-send-receive-messages/save-batch-receiver-logic-app.png)

   > [!IMPORTANT]
   > Если вы используете Visual Studio, перед тем как перейти к следующему разделу, убедитесь, что вы сначала [ *развернете* приложение логики получателя пакета в Azure](../logic-apps/quickstart-create-logic-apps-with-visual-studio.md#deploy-logic-app-to-azure). В противном случае вы не сможете выбрать этот получатель пакетов при создании отправителя пакетов.

<a name="batch-sender"></a>

## <a name="create-batch-sender"></a>Создание отправителя пакетов

Теперь создайте одно или несколько приложений логики, которые отправляют пакеты сообщений в приложение логики для получения пакетов. В каждом отправителе пакетов укажите получатель пакетов, имя пакета, содержимое сообщения и другие параметры. При необходимости можно указать уникальный ключ раздела, чтобы разделить пакет на логические подмножества для сбора сообщений с помощью этого ключа.

* Убедитесь, что вы ранее [создали и развернули свой пакет пакета](#batch-receiver) , поэтому при создании отправителя пакетной службы можно выбрать существующий получатель пакета в качестве целевого пакета. Получателям пакетов не требуются сведения об отправителях пакетов, но отправители должны знать параметры назначения для отправки сообщений.

* Убедитесь, что получатель пакетной службы и отправитель пакетной службы совместно используют один и тот же регион Azure *и* подписку Azure. В противном случае при создании отправителя пакетов вы не сможете выбрать получателя пакетов, так как они не видны друг другу.

1. Создайте другое приложение логики с таким именем:`BatchSender`

   1. В поле поиска введите `recurrence` в качестве фильтра. В списке триггеров выберите триггер: **Периодичность**

      ![Добавление триггера повторения](./media/logic-apps-batch-process-send-receive-messages/add-schedule-trigger-batch-sender.png)

   1. Задайте интервал и частоту запуска приложения логики отправителя каждую минуту.

      ![Задать частоту и интервал для триггера повторения](./media/logic-apps-batch-process-send-receive-messages/recurrence-trigger-batch-sender-details.png)

1. Добавьте новое действие для отправки сообщений в пакет.

   1. В разделе триггер **повторения** выберите **новый шаг**.

   1. В поле поиска введите `batch` Фильтр и выберите это действие: **Выбор рабочего процесса Logic Apps с помощью пакетного триггера** .

      ![Выбор действия "Выберите рабочий процесс Logic Apps с триггером пакета"](./media/logic-apps-batch-process-send-receive-messages/send-messages-batch-action.png)

      Появится список, в котором отображаются только те приложения логики, которые имеют триггеры пакетной службы и существуют в том же регионе Azure и в подписке Azure, что *и* приложение логики отправителя пакета.

   1. В списке Logic Apps (приложения логики) выберите созданное ранее приложение логики приемника пакетов.

      ![Выбор приложения логики получателя пакета](./media/logic-apps-batch-process-send-receive-messages/batch-sender-select-batch-receiver.png)

      > [!IMPORTANT]
      > Если вы используете Visual Studio и вы не видите никаких получателей пакетов для выбора, убедитесь, что вы ранее создали и развернули свой пакет в Azure. Если вы этого не сделали, Узнайте, [как развернуть приложение логики получателя пакета в Azure](../logic-apps/quickstart-create-logic-apps-with-visual-studio.md#deploy-logic-app-to-azure).

   1. В списке действия выберите это действие: **Batch_messages-<*свое-Logic-App-Name* > ** .

      ![Выбор действия "Batch_messages (Пакетировать сообщения) — <приложение_логики>"](./media/logic-apps-batch-process-send-receive-messages/batch-sender-select-batch.png)

1. Задайте свойства для отправителя пакетов.

   | Свойство | Описание |
   |----------|-------------|
   | **Имя пакета** | Имя пакета, определяемое приложением логики получателя, которое `TestBatch` в этом примере <p>**Важно**! Имя пакета проверяется во время выполнения. Оно должно совпадать с именем, указанным в принимающем приложении логики. Изменение имени пакета приводит к сбою в работе приложения логики для отправки пакета. |
   | **Содержимое сообщения** | Содержимое сообщения, которое вы хотите отправить |
   |||

   > [!NOTE]
   > Значения **имени триггера** и свойства **рабочего процесса** автоматически заполняются выбранным приложением логики.

   В нашем примере добавляется следующее выражение, которое вставляет текущую дату и время в сообщение, отправляемое в пакет:

   1. Щелкните в любом месте поля **Содержимое сообщения**.

   1. Когда отобразится список динамического содержимого, выберите **выражение**.

   1. Введите выражение `utcnow()` и нажмите кнопку **ОК**.

      ![В окне "содержимое сообщения" выберите "выражение", введите "UtcNow ()" и нажмите кнопку "ОК".](./media/logic-apps-batch-process-send-receive-messages/batch-sender-details.png)

1. Теперь настройте для пакета секцию. В `BatchReceiver` действии откройте список **Добавить новый параметр** и выберите следующие свойства:

   | Свойство | Описание |
   |----------|-------------|
   | **Имя секции** | Необязательный уникальный ключ раздела для разбивки отправляемых пакетов на логические подмножества и сбора сообщений с учетом этого ключа. |
   | **Идентификатор сообщения** | Необязательный идентификатор сообщения. Если значение не указано, автоматически генерируется глобально уникальный идентификатор (GUID). |
   |||

   В нашем примере добавьте в поле **Имя раздела** выражение, которое генерирует случайное число от 1 до 5. Оставьте пустым поле **Идентификатор сообщения**.

   1. Щелкните внутри поля **Имя раздела**, чтобы отобразить динамический список содержимого.

   1. В списке динамического содержимого выберите **Выражение**.

   1. Введите выражение `rand(1,6)` и нажмите кнопку **ОК**.

      ![Настройка секции для целевого пакета](./media/logic-apps-batch-process-send-receive-messages/batch-sender-partition-advanced-options.png)

      Эта функция **rand** генерирует число от 1 до 5. То есть пакет разделяется на пять нумерованных секций, которые динамически задаются этим выражением.

1. Сохраните приложение логики. Теперь ваше отправляющее приложение логики выглядит примерно так:

   ![Сохранение отправляющего приложения логики](./media/logic-apps-batch-process-send-receive-messages/batch-sender-finished.png)

## <a name="test-your-logic-apps"></a>Тестирование приложений логики

Чтобы проверить решение пакетной обработки, запустите приложения логики и дайте им поработать несколько минут. Скоро вы начнете получать сообщения электронной почты группами по пять сообщений. Все они будут иметь один ключ секции.

Приложение логики для отправки пакетов запускается каждую минуту, генерирует случайное число в диапазоне от 1 до 5 и использует это число в качестве ключа секции для целевого пакета, в который отправляются сообщения. Когда в пакете собирается пять элементов с одинаковым ключом секции, приложение логики для получения пакетов активируется и отправляет сообщения электронной почты для каждого элемента.

> [!IMPORTANT]
> После завершения тестирования отключите `BatchSender` приложение логики, чтобы оно не отправляло сообщения и не перегружать папку "Входящие".

## <a name="next-steps"></a>Дальнейшие действия

* [Пакетная обработка и отправка сообщений EDI](../logic-apps/logic-apps-scenario-edi-send-batch-messages.md)
* [Создание определений рабочих процессов для приложений логики с помощью JSON](../logic-apps/logic-apps-author-definitions.md)
* [Создание бессерверного приложения в Visual Studio с использованием приложений логики и функций](../logic-apps/logic-apps-serverless-get-started-vs.md)
* [Сценарий обработки исключений и ведения журнала ошибок для приложений логики](../logic-apps/logic-apps-scenario-error-and-exception-handling.md)
