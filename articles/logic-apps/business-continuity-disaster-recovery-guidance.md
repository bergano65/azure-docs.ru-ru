---
title: Непрерывность бизнес-процессов и аварийное восстановление
description: Разработайте стратегию защиты данных, быстро восстановите данные о критических событиях, изменяйте ресурсы, необходимые для важных бизнес-функций, и обеспечьте непрерывность бизнес-процессов для Azure Logic Apps
services: logic-apps
ms.suite: integration
ms.reviewer: klam, logicappspm
ms.topic: conceptual
ms.date: 03/31/2020
ms.openlocfilehash: 0a36cb468ebcb77c0614bffd0afc392df3655c20
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "89658209"
---
# <a name="business-continuity-and-disaster-recovery-for-azure-logic-apps"></a>Непрерывность бизнес-процессов и аварийное восстановление для Azure Logic Apps

Чтобы снизить влияние и влияние непредсказуемых событий на бизнес и клиентов, убедитесь, что имеется решение [ *аварийного восстановления* (Dr)](https://en.wikipedia.org/wiki/Disaster_recovery) , позволяющее защищать данные, быстро восстанавливать ресурсы, поддерживающие критически важные бизнес-функции, и поддерживать [ *непрерывность бизнес* -процессов (BC)](https://en.wikipedia.org/wiki/Business_continuity_planning). Например, нарушения могут включать сбои, потери в базовой инфраструктуре или компоненты, такие как хранилище, сеть или ресурсы, неустранимые сбои приложения или даже полную потерю центра обработки данных. Если решение непрерывности бизнес-процессов и аварийного восстановления (BCDR) готово, предприятие или организация могут быстрее реагировать на прерывания, запланированные или незапланированные, а также сократить время простоя для клиентов.

Эта статья содержит рекомендации и стратегии BCDR, которые можно применять при создании автоматизированных рабочих процессов с помощью [Azure Logic Apps](../logic-apps/logic-apps-overview.md). Рабочие процессы приложений логики упрощают интеграцию и управление данными между приложениями, облачными службами и локальными системами, уменьшая объем кода, который необходимо написать. При планировании BCDR убедитесь, что вы рассмотрите не только приложения логики, но и ресурсы Azure, которые вы используете в приложениях логики:

* [Подключения](../connectors/apis-list.md) , создаваемые из приложений логики для других приложений, служб и систем. Дополнительные сведения см. в подразделе [подключения к ресурсам](#resource-connections) далее в этой статье.

* [Локальные шлюзы данных](../logic-apps/logic-apps-gateway-connection.md) , которые являются ресурсами Azure, создаваемыми и используемыми в приложениях логики для доступа к данным в локальных системах. Каждый ресурс шлюза представляет собой отдельную [установку шлюза данных](../logic-apps/logic-apps-gateway-install.md) на локальном компьютере. Дополнительные сведения см. Далее в подразделе [локальные шлюзы данных](#on-premises-data-gateways) .

* [Учетные записи интеграции](../logic-apps/logic-apps-enterprise-integration-create-integration-account.md) , в которых вы определяете и сохраняете артефакты, используемые приложениями логики для сценариев [интеграции "бизнес — бизнес" (B2B)](../logic-apps/logic-apps-enterprise-integration-overview.md) . Например, можно [настроить аварийное восстановление в нескольких регионах для учетных записей интеграции](../logic-apps/logic-apps-enterprise-integration-b2b-business-continuity.md).

* [Среды службы интеграции (исес)](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md) , в которых создаются приложения логики, которые выполняются в изолированном экземпляре среды выполнения Logic Apps в виртуальной сети Azure. Затем эти приложения логики могут получить доступ к ресурсам, защищенным за брандмауэром в этой виртуальной сети.

<a name="primary-secondary-locations"></a>

## <a name="primary-and-secondary-locations"></a>Основное и дополнительное расположения

Каждое приложение логики должно указывать расположение, которое будет использоваться для развертывания. Это либо общедоступный регион в глобальной среде Azure с несколькими клиентами, например "Западная часть США", либо среда службы интеграции (ISE), которая ранее была создана и развернута в виртуальной сети Azure. Запуск приложений логики в интегрированной среде сценариев аналогичен запуску приложений логики в глобальном регионе Azure. Это означает, что Стратегия аварийного восстановления может применяться к обоим сценариям. Однако у Исес есть и другие соображения, такие как Настройка доступа к ресурсам, доступным только для Исес.

> [!NOTE]
> Если приложение логики работает с артефактами B2B, такими как торговые партнеры, соглашения, схемы, карты и сертификаты, которые хранятся в учетной записи интеграции, то как учетная запись интеграции, так и приложения логики должны указывать одно и то же расположение.

Эта стратегия аварийного восстановления посвящена настройке основного приложения логики для [*отработки отказа*](https://en.wikipedia.org/wiki/Failover) на резервное или резервное приложение логики в альтернативном расположении, где также доступна Azure Logic Apps. Таким образом, если основная реплика нарушает потери, перерывы или сбои, база данных-получатель может выполнить работу. Для этой стратегии требуется, чтобы вторичное приложение логики и зависимые ресурсы были развернуты и готовы в альтернативном расположении.

При соблюдении хорошего опыта DevOps вы уже используете [шаблоны Azure Resource Manager](../azure-resource-manager/management/overview.md) для определения и развертывания приложений логики и их зависимых ресурсов. Диспетчер ресурсов шаблоны предоставляют возможность использовать одно определение развертывания, а затем использовать файлы параметров для предоставления значений конфигурации, используемых для каждого назначения развертывания. Эта возможность означает, что вы можете развернуть одно и то же приложение логики в разных средах, например в разработке, тестировании и производстве. Вы также можете развернуть одно и то же приложение логики в разных регионах Azure или Исес, которое поддерживает стратегии аварийного восстановления, использующие [парные регионы](../best-practices-availability-paired-regions.md).

Для стратегии отработки отказа приложения логики и расположения должны соответствовать следующим требованиям:

* Вторичный экземпляр приложения логики имеет доступ к тем же приложениям, службам и системам, что и первичный экземпляр приложения логики.

* Оба экземпляра приложения логики имеют один и тот же тип узла. Таким образом, оба экземпляра развертываются в регионах в глобальном многоклиентской среде Azure, или оба экземпляра развертываются в Исес, что позволяет приложениям логики напрямую обращаться к ресурсам в виртуальной сети Azure. Рекомендации и дополнительные сведения о парных регионах для BCDR см. в разделе [непрерывность бизнес-процессов и аварийное восстановление (BCDR): Парные регионы Azure](../best-practices-availability-paired-regions.md).

  Например, первичное и вторичное расположения должны быть Исес, когда основное приложение логики работает в интегрированной среде сценариев и использует [соединители версии ISE](../connectors/apis-list.md#ise-connectors), действия HTTP для вызова ресурсов в виртуальной сети Azure или и того и другого. В этом случае вторичное приложение логики также должно иметь аналогичную настройку в дополнительном расположении в качестве основного приложения логики.

  > [!NOTE]
  > В более сложных сценариях вы можете смешивать одновременно несколько клиентов Azure и интегрированную среду сценариев в качестве расположений. Однако убедитесь, что вы понимаете [различия между запуском приложений логики в среде ISE и несколькими клиентами Azure](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md#difference).

* Если вы используете Исес, [Убедитесь, что они масштабируются или имеют достаточную емкость](../logic-apps/ise-manage-integration-service-environment.md#add-capacity) для выполнения нагрузки.

#### <a name="example-multi-tenant-azure"></a>Пример: несколько клиентов Azure

В этом примере показаны экземпляры основного и дополнительного приложений логики, которые развертываются в отдельных регионах в глобальном клиенте Azure для этого сценария. Один [шаблон диспетчер ресурсов](../logic-apps/logic-apps-azure-resource-manager-templates-overview.md) определяет как экземпляры приложения логики, так и зависимые ресурсы, необходимые для этих приложений логики. Отдельные файлы параметров указывают значения конфигурации, которые следует использовать для каждого расположения развертывания:

![Экземпляры основного и дополнительного приложений логики в отдельных расположениях](./media/business-continuity-disaster-recovery-guidance/primary-secondary-locations.png)

#### <a name="example-integration-service-environment"></a>Пример: среда службы интеграции

В этом примере показаны предыдущие экземпляры первичного и вторичного приложений логики, но они развертываются в отдельный Исес. Один шаблон диспетчер ресурсов определяет как экземпляры приложения логики, так и зависимые ресурсы, необходимые для этих приложений логики, а также Исес в качестве расположений развертывания. Отдельные файлы параметров определяют значения конфигурации, используемые для развертывания в каждом расположении:

![Первичные и вторичные приложения логики в разных местах](./media/business-continuity-disaster-recovery-guidance/primary-secondary-locations-ise.png)

<a name="resource-connections"></a>

## <a name="connections-to-resources"></a>Подключения к ресурсам

Azure Logic Apps предоставляет [встроенные триггеры и действия, а также сотни управляемых соединителей](../connectors/apis-list.md) , которые приложение логики может использовать для работы с другими приложениями, службами, системами и другими ресурсами, такими как учетные записи хранения Azure, SQL Server базы данных, рабочие или учебные учетные записи электронной почты и т. д. Если приложению логики требуется доступ к этим ресурсам, вы создадите подключения, которые проверяют доступ к этим ресурсам. Каждое подключение — это отдельный ресурс Azure, который существует в определенном расположении и не может использоваться ресурсами в других расположениях.

Для стратегии аварийного восстановления рассмотрите расположение, в котором существуют зависимые ресурсы относительно экземпляров приложения логики.

* Основной экземпляр и зависимые ресурсы находятся в разных расположениях. В этом случае экземпляр-получатель может подключаться к тем же зависимым ресурсам или конечным точкам. Однако подключения следует создавать специально для своего экземпляра-получателя. Таким образом, если основное расположение станет недоступным, то подключения к вторичной базе данных не затрагиваются.

  Например, предположим, что основное приложение логики подключается к внешней службе, например Salesforce. Как правило, доступность и расположение внешней службы не зависят от доступности приложения логики. В этом случае экземпляр-получатель может подключиться к той же службе, но должен иметь собственное соединение.

* Основной экземпляр и зависимые ресурсы находятся в одном расположении. В этом случае зависимые ресурсы должны иметь резервные копии или реплицированные версии в другом расположении, чтобы ваш экземпляр-получатель мог обращаться к этим ресурсам.

  Например, предположим, что основное приложение логики подключается к службе, которая находится в том же расположении или регионе, например в базе данных SQL Azure. Если весь регион становится недоступным, служба базы данных SQL Azure в этом регионе также, скорее всего, будет недоступна. В этом случае необходимо, чтобы экземпляр-получатель использовал реплицированную или резервную базу данных вместе с отдельным соединением с этой базой данных.

<a name="on-premises-data-gateways"></a>

## <a name="on-premises-data-gateways"></a>Локальные шлюзы данных

Если приложение логики работает в Azure с несколькими клиентами и ему требуется доступ к локальным ресурсам, таким как SQL Server базы данных, необходимо установить локальный [шлюз данных](../logic-apps/logic-apps-gateway-install.md) на локальном компьютере. Затем можно создать ресурс шлюза данных в портал Azure, чтобы приложение логики мог использовать шлюз при создании подключения к ресурсу.

Ресурс шлюза данных связан с расположением или регионом Azure, как и ресурс приложения логики. В стратегии аварийного восстановления убедитесь, что шлюз данных остается доступным для использования приложением логики. Вы можете [включить высокий уровень доступности для шлюза](../logic-apps/logic-apps-gateway-install.md#high-availability) при наличии нескольких установок шлюза.

> [!NOTE]
> Если приложение логики работает в среде службы интеграции (ISE) и использует только соединители версии ISE для локальных источников данных, шлюз данных не нужен, так как соединители ISE предоставляют прямой доступ к локальному ресурсу.
>
> Если для локального ресурса нет соединителя с версией ISE, приложение логики по-прежнему может создать подключение с помощью соединителя, не относящегося к ISE, который выполняется в глобальном клиенте Azure, а не в интегрированной среде сценариев. Однако для этого подключения требуется локальный шлюз данных.

<a name="roles"></a>

## <a name="active-active-versus-active-passive-roles"></a>Роли "активный — активный" и "активный — пассивный"

Вы можете настроить основное и дополнительное расположение, чтобы экземпляры приложения логики в этих расположениях могли играть следующие роли:

| Первичная — вторичная роль | Описание |
|------------------------|-------------|
| *Активный — активный* | Экземпляры основного и дополнительного приложений логики в обоих расположениях активно обработают запросы, используя любой из этих шаблонов: <p><p>- *Балансировка нагрузки*. при необходимости оба экземпляра могут ожидать передачи данных в конечную точку и балансировки нагрузки для каждого экземпляра. <p>- *Конкурирующие потребители*. Вы можете использовать оба экземпляра как конкурирующих потребителей, чтобы экземпляры конкурирулись за сообщениями из очереди. Если один экземпляр завершается сбоем, другой экземпляр принимает на себя рабочую нагрузку. |
| *Шаблон "активный — пассивный"* | Основной экземпляр приложения логики активно обрабатывает всю рабочую нагрузку, а вторичный экземпляр — пассивный (отключенный или неактивный). Получатель ожидает сигнала о том, что первичный объект недоступен или не работает из-за нарушения или сбоя, и переводит рабочую нагрузку в качестве активного экземпляра. |
| Сочетание | Некоторые приложения логики играют роль Active-Active, в то время как другие приложения логики играют роль Active-passive. |
|||

<a name="active-active-examples"></a>

### <a name="active-active-examples"></a>Примеры "активный — активный"

В этих примерах показана программа установки "активный — активный", в которой оба экземпляра приложения логики активно обработают запросы или сообщения. Некоторые другие системы или службы распространяют запросы или сообщения между экземплярами, например один из следующих вариантов:

* "Физический" балансировщик нагрузки, например часть оборудования, который маршрутизирует трафик.

* "Мягкую" подсистему балансировки нагрузки, например [Azure Load Balancer](../load-balancer/load-balancer-overview.md) или [Azure API Management](../api-management/api-management-key-concepts.md). С помощью управления API можно указать политики, определяющие балансировку нагрузки входящего трафика. Можно также использовать службу, поддерживающую отслеживание состояния, например [служебную шину Azure](../service-bus-messaging/service-bus-messaging-overview.md).

  Хотя в этом примере в основном показано Azure Load Balancer, можно использовать параметр, который лучше всего подходит для потребностей вашего сценария.

  ![Программа установки "Active-Active", использующая подсистему балансировки нагрузки или службу с отслеживанием состояния](./media/business-continuity-disaster-recovery-guidance/active-active-setup-load-balancer.png)

* Каждый экземпляр приложения логики выступает в качестве потребителя, и оба экземпляра конкурируют за сообщения из очереди:

  ![Программа установки "активный — активный", использующая "конкурирующие потребители"](./media/business-continuity-disaster-recovery-guidance/active-active-competing-consumers-pattern.png)

<a name="active-passive-examples"></a>

### <a name="active-passive-examples"></a>Примеры "активный — пассивный"

В этом примере показана Активная — пассивная Настройка, в которой основной экземпляр приложения логики активен в одном расположении, а экземпляр-получатель остается неактивным в другом расположении. В случае сбоя или неудачи у вас может быть оператор, выполняющий сценарий, который активирует вторичный сервер для выполнения рабочей нагрузки.

![Программа установки "активный-пассивный", использующая "конкурирующих потребителей"](./media/business-continuity-disaster-recovery-guidance/active-passive-setup.png)

<a name="active-active-active-passive-examples"></a>

### <a name="combination-with-active-active-and-active-passive"></a>Сочетание с режимом "активный — активный" и "активный — пассивный"

В этом примере показана Объединенная Настройка, в которой основное расположение содержит активные экземпляры приложения логики, а в дополнительном расположении — активные и пассивные экземпляры приложения логики. Если в основном расположении возникает сбой или прерывание, активное приложение логики в дополнительном расположении, которое уже обрабатывает частичную рабочую нагрузку, может принимать всю рабочую нагрузку.

* В первичном расположении активное приложение логики прослушивает очередь служебной шины Azure на предмет сообщений, в то время как другое активное приложение логики проверяет сообщения электронной почты с помощью триггера опроса Office 365 Outlook.

* В дополнительном расположении активное приложение логики работает с приложением логики в основном расположении, прослушивая и конкурирующим за сообщения из одной и той же очереди служебной шины. В то же время пассивное неактивное приложение логики ожидает, если основное расположение становится недоступным, но *отключено* , чтобы избежать повторного считывания сообщений электронной почты.

![Сочетание "активный-пассивный" и "активный-пассивный", использующее триггеры повторения](./media/business-continuity-disaster-recovery-guidance/combo-active-active-active-passive-setup.png)

<a name="state-history"></a>

## <a name="logic-app-state-and-history"></a>Состояние и журнал приложения логики

Когда приложение логики запускается и начинает выполняться, состояние приложения сохраняется в том же расположении, в котором приложение запущено и не передается в другое расположение. В случае сбоя или прерывания все выполняющиеся экземпляры рабочих процессов отказываются. При настройке основного и дополнительного расположений новые экземпляры рабочих процессов начинают работать в дополнительном расположении.

<a name="reduce-abandoned-in-progress"></a>

### <a name="reduce-abandoned-in-progress-instances"></a>Уменьшение числа отброшенных выполняющихся экземпляров

Чтобы максимально ограничить количество отброшенных выполняющихся экземпляров рабочего процесса, можно выбрать один из различных шаблонов сообщений, которые можно реализовать, например:

* [Шаблон фиксированного маршрутного маршрута](/biztalk/esb-toolkit/message-routing-patterns#routing-slip)

  Этот шаблон корпоративного сообщения разделяет бизнес-процесс на небольшие этапы. Для каждого этапа необходимо настроить приложение логики, которое будет обрабатывать рабочую нагрузку для этого этапа. Для взаимодействия друг с другом приложения логики используют протокол асинхронного обмена сообщениями, например очереди или разделы служебной шины Azure. При разделении процесса на небольшие этапы уменьшается количество бизнес-процессов, которые могут задержаться на неудачном экземпляре приложения логики. Дополнительные общие сведения об этом шаблоне см. в разделе [Шаблоны интеграции Enterprise — маршрутная книга](https://www.enterpriseintegrationpatterns.com/patterns/messaging/RoutingTable.html).

  В этом примере показан шаблон маршрутной квитанции, где каждое приложение логики представляет стадию и использует очередь служебной шины для взаимодействия со следующим приложением логики в процессе.

  ![Разделите бизнес-процесс на этапы, представленные приложениями логики, которые взаимодействуют друг с другом с помощью очередей служебной шины Azure.](./media/business-continuity-disaster-recovery-guidance/fixed-routing-slip-pattern.png)

  Если экземпляры основного и дополнительного приложений логики следуют одному шаблону маршрута маршрутизации в их расположении, можно реализовать [шаблон конкурирующих потребителей](/azure/architecture/patterns/competing-consumers) , настроив [роли Active-Active](#roles) для этих экземпляров.

* [Шаблон диспетчера процессов (Broker)](https://www.enterpriseintegrationpatterns.com/patterns/messaging/ProcessManager.html)

* [Просмотр-блокировка без шаблона времени ожидания](https://social.technet.microsoft.com/wiki/contents/articles/50022.azure-service-bus-how-to-peek-lock-a-message-from-queue-using-azure-logic-apps.aspx)

<a name="access-trigger-runs-history"></a>

### <a name="access-to-trigger-and-runs-history"></a>Доступ к журналу триггеров и запусков

Чтобы получить дополнительные сведения о выполнении предыдущих рабочих процессов приложения логики, можно просмотреть журнал триггеров и запусков приложения. Журнал выполнения журнала приложения логики хранится в том же расположении или регионе, где запущено приложение логики. Это означает, что вы не можете перенести этот журнал в другое расположение. Если основной экземпляр отработки отказа на дополнительный экземпляр, можно получить доступ только к триггеру каждого экземпляра и выполнить журнал в соответствующих местах, где выполнялись эти экземпляры. Тем не менее, вы можете получить независимые от расположения сведения о журнале приложения логики, настроив приложения логики для отправки диагностических событий в рабочую область Azure Log Analytics. Затем можно просматривать работоспособность и историю в приложениях логики, которые выполняются в нескольких расположениях.

<a name="trigger-types-guidance"></a>

## <a name="trigger-type-guidance"></a>Руководство по типам триггеров

Тип триггера, используемый в приложениях логики, определяет параметры, позволяющие настроить приложения логики в различных расположениях в стратегии аварийного восстановления. Ниже приведены доступные типы триггеров, которые можно использовать в приложениях логики.

* [Триггер повторения](#recurrence-trigger)
* [Опрашивающий триггер](#polling-trigger)
* [Триггер запросов](#request-trigger)
* [Триггер веб-перехватчика](#webhook-trigger)

<a name="recurrence-trigger"></a>

### <a name="recurrence-trigger"></a>Триггер повторения

Триггер **повторения** не зависит от конкретной службы или конечной точки и срабатывает исключительно на основе указанного расписания, а не других критериев, например:

* Фиксированная частота и интервал, например каждые 10 минут.
* Более расширенное расписание, например последний понедельник каждого месяца в 5:00 PM.

Когда приложение логики запускается с помощью триггера повторения, необходимо настроить основные и вторичные экземпляры приложения логики с активными и [пассивными ролями](#roles). Чтобы уменьшить целевое *время восстановления* (RTO), которое относится к целевой длительности восстановления бизнес-процесса после сбоя или аварии, можно настроить экземпляры приложения логики с помощью сочетания [ролей "активный — пассивный](#roles) " и " [пассивные активные роли](#roles)". В этой настройке вы разбиваете расписание по расположениям.

Например, предположим, что у вас есть приложение логики, которое должно выполняться каждые 10 минут. Вы можете настроить приложения логики и расположения, чтобы в случае недоступности основного расположения в дополнительном расположении можно было выполнить следующие действия.

![Сочетание "активный-пассивный" и "пассивный активный", использующее триггеры повторения](./media/business-continuity-disaster-recovery-guidance/combo-active-passive-passive-active-setup.png)

* В основном расположении настройте [активные и пассивные роли](#roles) для этих приложений логики:

  * Для *активного* включенного приложения логики задайте триггер повторения в начале часа и повторите каждые 20 минут, например 9:00 am, 9:20 AM и т. д.

  * Для *пассивно* отключенного приложения логики задайте для триггера повторения одно и то же расписание, но Начните с 10 минут после часа и повторите каждые 20 минут, например 9:10 am, 9:30 am и т. д.

* В дополнительном расположении настройте [пассивный активный](#roles) для этих приложений логики:

  * Для *пассивно* отключенного приложения логики задайте для триггера повторения то же расписание, что и активное приложение логики в основном расположении, которое находится в начале часа и повторяется каждые 20 минут, например 9:00 am, 9:10 AM и т. д.

  * Для *активного* включенного приложения логики задайте для триггера повторения то же расписание, что и пассивное приложение логики в основном расположении, которое начинается с 10 минут после часа и повторяется каждые 20 минут, например 9:10 am, 9:20 AM и т. д.

Теперь, если в основном расположении произошло нарушение события, активируйте пассивное приложение логики в альтернативном расположении. Таким образом, если при обнаружении сбоя уходит время, эта установка ограничивает количество пропущенных повторений в течение этой задержки.

<a name="polling-trigger"></a>

### <a name="polling-trigger"></a>Опрашивающий триггер

Чтобы регулярно проверять, доступны ли новые данные для обработки из определенной службы или конечной точки, приложение логики может использовать триггер *опроса* , который многократно вызывает службу или конечную точку на основе фиксированного расписания повторения. Данные, предоставляемые службой или конечной точкой, могут иметь один из следующих типов:

* Статические данные, описывающие данные, которые всегда доступны для чтения
* Временные данные, описывающие данные, которые больше не доступны после чтения

Чтобы избежать многократного считывания одних и тех же данных, приложение логики должно помнить, какие данные были ранее считаны, сохраняя состояние на стороне клиента или на стороне сервера, службы или системы.

* Приложения логики, работающие с состоянием на стороне клиента, используют триггеры, которые могут поддерживать состояние.

  Например, триггер, считывающий новое сообщение из папки "Входящие" электронной почты, требует, чтобы триггер мог запомнить Последнее прочитанное сообщение. Таким образом, триггер запускает приложение логики только при получении следующего непрочитанного сообщения.

* Приложения логики, работающие с сервером, службой или системным состоянием, используют значения или параметры свойств, которые находятся на стороне сервера, службы или системы.

  Например, триггер на основе запроса, считывающий строку из базы данных, требует, чтобы в строке был `isRead` столбец со значением `FALSE` . Каждый раз, когда триггер считывает строку, приложение логики обновляет эту строку, изменяя `isRead` столбец с `FALSE` на `TRUE` .

  Этот подход на стороне сервера работает аналогично очередям или разделам служебной шины, которые имеют семантику очереди, где триггер может считывать и блокировать сообщение, пока приложение логики обрабатывает сообщение. Когда приложение логики завершает обработку, триггер удаляет сообщение из очереди или раздела.

С точки зрения аварийного восстановления при настройке основного и дополнительного экземпляров приложения логики убедитесь, что вы учитываете эти поведения в зависимости от того, отслеживает ли приложение логики состояние на стороне клиента или на стороне сервера:

* Для приложения логики, работающего с состоянием на стороне клиента, убедитесь, что приложение логики не считывает одно и то же сообщение более одного раза. Только одно расположение может иметь активный экземпляр приложения логики в любое заданное время. Убедитесь, что экземпляр приложения логики в альтернативном расположении неактивен или отключен, пока первичный экземпляр не отключается в альтернативное расположение.

  Например, триггер Office 365 Outlook поддерживает состояние на стороне клиента и отслеживает отметку времени последнего прочитанного сообщения, чтобы избежать дублирования.

* Для приложения логики, которое работает с состоянием на стороне сервера, можно настроить экземпляры приложения логики для воспроизведения [активных ролей](#roles) , где они работают как конкурирующие потребители или [активные пассивные роли](#roles) , в которых альтернативный экземпляр ждет перехода основного экземпляра в альтернативное расположение.

  Например, чтение из очереди сообщений, например очереди служебной шины Azure, использует состояние на стороне сервера, так как служба очереди хранит блокировки сообщений, чтобы другие клиенты не читали одни и те же сообщения.

  > [!NOTE]
  > Если приложение логики должно считывать сообщения в определенном порядке, например из очереди служебной шины, можно использовать шаблон конкурирующих потребителей, но только в сочетании с сеансами служебной шины, которые также называют [ *последовательным* шаблоном сопровождение](/azure/architecture/patterns/sequential-convoy). В противном случае вы должны настроить экземпляры приложения логики с помощью ролей "активный — пассивный".

<a name="request-trigger"></a>

### <a name="request-trigger"></a>Триггер запросов

Триггер **запроса** делает приложение логики доступным из других приложений, служб и систем и обычно используется для предоставления следующих возможностей:

* Прямой REST API для приложения логики, к которому могут обращаться другие пользователи

  Например, используйте триггер запроса, чтобы запустить приложение логики, чтобы другие приложения логики могли вызывать триггер с помощью действия " **вызов рабочего процесса — Logic Apps** ".

* [Веб-перехватчик](#webhook-trigger) или механизм обратного вызова для приложения логики

* С помощью скрипта PowerShell, выполняющего определенную задачу, можно вручную запускать пользовательские операции или процедуры для вызова приложения логики.

С точки зрения аварийного восстановления триггер запроса является пассивным получателем, так как приложение логики не выполняет никаких действий и ожидает, пока какая-либо другая служба или система явно не вызовет триггер. В качестве пассивной конечной точки можно настроить первичный и вторичный экземпляры следующим образом:

* [Активный — активный](#roles): оба экземпляра активно обработают запросы или вызовы. Вызывающий объект или маршрутизатор распределяет трафик между этими экземплярами.

* [Активный-пассивный](#roles): активен только основной экземпляр и обрабатывает всю работу, в то время как сервер-получатель ожидает, пока основной сбой не завершится. Вызывающий объект или маршрутизатор определяет, когда следует вызывать вторичный экземпляр.

В качестве рекомендуемой архитектуры можно использовать службу управления API Azure в качестве прокси-сервера для приложений логики, использующих триггеры запросов. Управление API обеспечивает [встроенную устойчивость к различным регионам и возможность маршрутизации трафика между несколькими конечными точками](../api-management/api-management-howto-deploy-multi-region.md).

<a name="webhook-trigger"></a>

### <a name="webhook-trigger"></a>Триггер веб-перехватчика

Триггер веб- *перехватчика* позволяет приложению логики подписываться на службу, передавая *URL-адрес обратного вызова* этой службе. Приложение логики может прослушивать и ожидать возникновения определенного события в конечной точке службы. Когда событие происходит, служба вызывает триггер веб-перехватчика, используя URL обратного вызова, который затем запускает приложение логики. Если этот параметр включен, триггер веб-перехватчика подписывается на службу. При отключении триггер отменяет подписывание от службы.

С точки зрения аварийного восстановления Настройте основной и дополнительный экземпляры, которые используют триггеры веб-перехватчика для воспроизведения активных и пассивных ролей, так как только один экземпляр должен получить события или сообщения от подписанной конечной точки.

## <a name="assess-primary-instance-health"></a>Оценка работоспособности основного экземпляра

Чтобы Стратегия аварийного восстановления работала, решение должно выполнять следующие задачи:

* [Проверка доступности основного экземпляра](#check-primary-availability)
* [Мониторинг работоспособности основного экземпляра](#monitor-primary-health)
* [Активация экземпляра-получателя](#activate-secondary)

В этом разделе описывается одно решение, которое можно использовать в качестве основы для разработки. Ниже приведен высокоуровневый визуальный обзор этого решения.

![Создание приложения логики наблюдения, которое отслеживает приложение логики проверки работоспособности в основном расположении](./media/business-continuity-disaster-recovery-guidance/check-location-health-watchdog.png)

<a name="check-primary-availability"></a>

### <a name="check-primary-instance-availability"></a>Проверка доступности основного экземпляра

Чтобы определить, доступен ли первичный экземпляр, его запуск и возможность работать, можно создать приложение логики "Проверка работоспособности" в том же расположении, что и первичный экземпляр. Затем можно вызвать это приложение проверки работоспособности из альтернативного расположения. Если приложение проверки работоспособности успешно отвечает, то базовая инфраструктура для службы Azure Logic Apps в этом регионе доступна и работает. Если приложение проверки работоспособности не отвечает, можно предположить, что расположение больше не является работоспособным.

Для этой задачи Создайте базовое приложение логики проверки работоспособности, которое выполняет следующие задачи:

1. Получает вызов из приложения наблюдения с помощью триггера запроса.

1. Ответ с состоянием, указывающим, работает ли проверенное приложение логики с помощью действия ответа.

   > [!IMPORTANT]
   > Приложение логики проверки работоспособности должно использовать действие ответа, чтобы приложение отвечало синхронно, а не асинхронно.

1. Кроме того, чтобы дополнительно определить работоспособность основного расположения, можно отнестись к работоспособности любых других служб, взаимодействующих с целевым приложением логики в этом расположении. Просто разверните приложение логики проверка работоспособности, чтобы оценить работоспособность этих других служб.

<a name="monitor-primary-health"></a>

### <a name="create-a-watchdog-logic-app"></a>Создание контрольного приложения логики

Чтобы отслеживать работоспособность основного экземпляра и вызывать приложение логики проверки работоспособности, создайте приложение логики наблюдения в *альтернативном расположении*. Например, можно настроить приложение логики наблюдения таким образом, чтобы при сбое вызова логики проверки работоспособности устройство наблюдения может отправить оповещение команде эксплуатации, чтобы они могли исследовать сбой и почему основной экземпляр не отвечает.

> [!IMPORTANT]
> Убедитесь, что ваше приложение логики наблюдения находится в *расположении, которое отличается от основного расположения*. Если служба Logic Apps в основном расположении испытывает проблемы, приложение логики наблюдения может не запуститься.

Для этой задачи в дополнительном расположении создайте контрольное приложение логики, которое выполняет следующие задачи:

1. Выполнение на основе фиксированного или запланированного повторения с помощью триггера повторения.

   Можно задать для периодичности значение, которое ниже уровня допуска для целевого значения времени восстановления (RTO).

1. Вызовите приложение логики проверки работоспособности в основном расположении, используя действие HTTP, например:

<a name="activate-secondary"></a>

### <a name="activate-your-secondary-instance"></a>Активация экземпляра-получателя

Чтобы автоматически активировать вторичный экземпляр, можно создать приложение логики, которое вызывает API управления, например [соединитель Azure Resource Manager](/connectors/arm/) , для активации соответствующих приложений логики в дополнительном расположении. Вы можете развернуть устройство наблюдения, чтобы вызвать это приложение логики активации после определенного числа сбоев.

<a name="collect-diagnostic-data"></a>

## <a name="collect-diagnostic-data"></a>Сбор диагностических сведений

Вы можете настроить ведение журнала для запуска приложения логики и отправить полученные данные диагностики в службы, такие как служба хранилища Azure, концентраторы событий Azure и Log Analytics Azure для дальнейшей обработки и обработки.

* Если вы хотите использовать эти данные в Azure Log Analytics, можно сделать эти данные доступными как для основного, так и для дополнительного расположения, настроив **параметры диагностики** приложения логики и отправляя данные в несколько рабочих областей log Analytics. Дополнительные сведения см. в разделе [Настройка журналов Azure Monitor и получение диагностических данных для Azure Logic Apps](../logic-apps/monitor-logic-apps-log-analytics.md).

* Если вы хотите отправить данные в службу хранилища Azure или концентраторы событий Azure, можно сделать эти данные доступными как для основного, так и для дополнительного расположения, настроив геоизбыточность. Дополнительные сведения вы найдете в следующих статьях:<p>

  * [Аварийное восстановление и отказоустойчивость учетных записей в хранилище BLOB-объектов Azure](../storage/common/storage-disaster-recovery-guidance.md)
  * [Географическое аварийное восстановление концентраторов событий Azure](../event-hubs/event-hubs-geo-dr.md)

## <a name="next-steps"></a>Дальнейшие шаги

* [Общие сведения о устойчивости для Azure](/azure/architecture/framework/resiliency/overview)
* [Контрольный список для обеспечения устойчивости конкретных служб Azure](/azure/architecture/checklist/resiliency-per-service)
* [Управление данными для обеспечения устойчивости в Azure](/azure/architecture/framework/resiliency/data-management)
* [Резервное копирование и аварийное восстановление для приложений Azure](/azure/architecture/framework/resiliency/backup-and-recovery)
* [Восстановление после прерывания работы служб во всем регионе](/azure/architecture/resiliency/recovery-loss-azure-region)
* [Соглашения об уровне обслуживания (SLA) для служб Azure](https://azure.microsoft.com/support/legal/sla/)
