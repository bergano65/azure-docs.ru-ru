---
title: Добавление циклов, которые повторяют действия или обрабатывают массивы в Azure Logic Apps | Документация Майкрософт
description: Способ создания циклов, которые повторяют действия рабочих процессов или обрабатывают массивы в Azure Logic Apps
services: logic-apps
ms.service: logic-apps
ms.suite: integration
author: ecfan
ms.author: estfan
ms.reviewer: klam, LADocs
manager: jeconnoc
ms.date: 01/05/2019
ms.topic: article
ms.openlocfilehash: c37e41bce481fff5e172687907cce527c10ae006
ms.sourcegitcommit: 12d67f9e4956bb30e7ca55209dd15d51a692d4f6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2019
ms.locfileid: "58225014"
---
# <a name="create-loops-that-repeat-workflow-actions-or-process-arrays-in-azure-logic-apps"></a>Создание циклов, которые повторяют действия рабочих процессов или обрабатывают массивы в Azure Logic Apps

Чтобы обработать массив в приложении логики, можно создать [цикл for each](#foreach-loop). Этот цикл повторяет одно или несколько действий для каждого элемента в массиве. Ограничения количества элементов массива, которое циклы for each позволяют обработать, см. в статье [Ограничения и сведения о конфигурации для Azure Logic Apps](../logic-apps/logic-apps-limits-and-config.md). 

Чтобы повторять действия, пока не будет выполнено условие или состояние не изменится, можно создать [цикл until](#until-loop). Приложение логики запускает все действия в цикле, а затем проверяет условие или состояние. Если условие выполнено, цикл прекращается. В противном случае он повторяется. Ограничения количества циклов until в одном выполнении приложения логики см. в статье [Ограничения и сведения о конфигурации для Azure Logic Apps](../logic-apps/logic-apps-limits-and-config.md). 

> [!TIP]
> Если есть триггер, который получает массив, и нужно запустить рабочий процесс для каждого элемента массива, вы можете выполнить *индивидуальную обработку* этого массива с помощью [свойства **SplitOn** триггера](../logic-apps/logic-apps-workflow-actions-triggers.md#split-on-debatch). 

## <a name="prerequisites"></a>Технические условия

* Подписка Azure. Если у вас нет ее, вы можете [зарегистрироваться для получения бесплатной учетной записи Azure](https://azure.microsoft.com/free/). 

* Базовые знания [создания приложений логики](../logic-apps/quickstart-create-first-logic-app-workflow.md).

<a name="foreach-loop"></a>

## <a name="foreach-loop"></a>Цикл for each

Цикл for each повторяет одно или несколько действий для каждого элемента массива и работает только с массивами. Итерации в цикле for each выполняются параллельно. Однако можно выполнять итерации по одной за раз, настроив [последовательный цикл for each](#sequential-foreach-loop). 

Вот некоторые рекомендации при использовании цикла for each.

* Во вложенных циклах итерации всегда выполняются последовательно, а не в параллельном режиме. Чтобы запустить выполнение операций в параллельном режиме для элементов вложенного цикла, создайте и [вызовите дочернее приложение логики](../logic-apps/logic-apps-http-endpoint.md).

* Чтобы получать предсказуемые результаты операций над переменными в каждой итерации цикла, выполняйте циклы последовательно. Например, когда одновременно выполняющийся цикл завершается, операции приращения, уменьшения и добавления к переменным возвращают предсказуемые результаты. Однако во время каждой итерации в параллельно выполняющемся цикле эти операции могут возвращать непредсказуемые результаты. 

* Действия в цикле for each используют выражение [`@item()`](../logic-apps/workflow-definition-language-functions-reference.md#item), 
чтобы ссылаться на каждый элемент массива и обрабатывать его. Если указать данные, которых нет в массиве, рабочий процесс приложения логики завершится ошибкой. 

Этот пример приложения логики отправляет ежедневную сводку для RSS-канала веб-сайта. Приложение использует цикл for each, который отправляет сообщение электронной почты для каждого нового элемента.

1. [Создайте этот пример приложения логики](../logic-apps/quickstart-create-first-logic-app-workflow.md), используя учетную запись Outlook.com или Office 365 Outlook.

2. Добавьте цикл for each между триггером RSS и действием отправки сообщения. 

   1. Чтобы добавить цикл между шагами, переместите указатель на стрелку между этими шагами. 
   Щелкните появившийся **знак плюс** (**+**), затем выберите **Добавить действие**.

      ![Выбор команды "Добавить действие"](media/logic-apps-control-flow-loops/add-for-each-loop.png)

   1. Под полем поиска выберите **Все**. В поле поиска введите for each в качестве условия фильтрации. В списке действий выберите действие **For each — Control** (for each — управление).

      ![Добавление цикла for each](media/logic-apps-control-flow-loops/select-for-each.png)

3. Теперь создайте цикл. В поле **Выберите выходные данные из предыдущих шагов**, когда отобразится список **Добавить динамическое содержимое**, выберите массив **Ссылки веб-канала**, который представляет выходные данные триггера RSS. 

   ![Выбор из списка динамического содержимого](media/logic-apps-control-flow-loops/for-each-loop-dynamic-content-list.png)

   > [!NOTE] 
   > Можно выбрать *только* выходные данные массива из предыдущего шага.

   Отобразится выбранный массив, как показано ниже:

   ![Выбор массива](media/logic-apps-control-flow-loops/for-each-loop-select-array.png)

4. Чтобы запустить действие с каждым элементом массива, перетащите действие **Отправить электронное письмо** в цикл. 

   Ваше приложения логики может выглядеть так:

   ![Добавление шагов в цикл for each](media/logic-apps-control-flow-loops/for-each-loop-with-step.png)

5. Сохраните приложение логики. Чтобы вручную проверить приложение логики, на панели инструментов конструктора щелкните **Запустить**.

<a name="for-each-json"></a>

## <a name="foreach-loop-definition-json"></a>Определение цикла for each (JSON)

При работе в представлении кода для приложения логики вы можете в качестве альтернативы определить цикл `Foreach` в определении JSON приложения логики, как показано ниже.

``` json
"actions": {
   "myForEachLoopName": {
      "type": "Foreach",
      "actions": {
         "Send_an_email": {
            "type": "ApiConnection",
            "inputs": {
               "body": {
                  "Body": "@{item()}",
                  "Subject": "New CNN post @{triggerBody()?['publishDate']}",
                  "To": "me@contoso.com"
               },
               "host": {
                  "api": {
                     "runtimeUrl": "https://logic-apis-westus.azure-apim.net/apim/office365"
                  },
                  "connection": {
                     "name": "@parameters('$connections')['office365']['connectionId']"
                  }
               },
               "method": "post",
               "path": "/Mail"
            },
            "runAfter": {}
         }
      },
      "foreach": "@triggerBody()?['links']",
      "runAfter": {}
   }
}
```

<a name="sequential-foreach-loop"></a>

## <a name="foreach-loop-sequential"></a>Цикл for each. Последовательный

По умолчанию в цикле for each итерации выполняются параллельно. Чтобы все операции выполнялись последовательно, установите для цикла параметр **Последовательный**. Циклы for each нужно выполнять последовательно, если есть вложенные циклы или переменные внутри циклов, которые должны содержать предсказуемые результаты. 

1. В правом верхнем углу области цикла выберите **многоточие** (**...**) > **Параметры**.

   ![Выбор "..." > "Параметры" в области цикла for each](media/logic-apps-control-flow-loops/for-each-loop-settings.png)

1. В разделе **Управление параллелизмом** для поля **Управление параллелизмом** задайте значение **Включено**. Перетащите ползунок **Степень параллелизма** до цифры **1** и выберите **Готово**.

   ![Включение режима управления параллелизмом](media/logic-apps-control-flow-loops/for-each-loop-sequential-setting.png)

При работе с определением JSON приложения логики можно использовать параметр `Sequential`, добавив его в `operationOptions`, например:

``` json
"actions": {
   "myForEachLoopName": {
      "type": "Foreach",
      "actions": {
         "Send_an_email": { }
      },
      "foreach": "@triggerBody()?['links']",
      "runAfter": {},
      "operationOptions": "Sequential"
   }
}
```

<a name="until-loop"></a>

## <a name="until-loop"></a>Цикл until
  
Чтобы повторять действия, пока не будет выполнено условие или состояние не изменится, добавьте эти действия в цикл until. Вот несколько распространенных сценариев использования цикла until:

* Вызов конечной точки до получения нужного ответа.

* Создание записи в базе данных. Подождите, пока определенное поле этой записи не будет утверждено. Продолжайте обработку. 

Каждый день в 8:00 пример этого приложения логики увеличивает значение переменной, пока оно не станет равно 10. Затем приложение логики отправляет сообщение электронной почты с подтверждением текущего значения. 

> [!NOTE]
> В этом руководстве используется Office 365 Outlook, однако можно использовать любой поставщик электронной почты, который поддерживает Logic Apps. 
> [Список соединителей можно просмотреть здесь](https://docs.microsoft.com/connectors/). Если используется другая учетная запись электронной почты, общие шаги остаются неизменными, однако интерфейс может выглядеть несколько иначе. 

1. Создание пустого приложения логики. В конструкторе приложений логики под полем поиска выберите **Все**. В поле поиска введите recurrence. 
   В списке триггеров выберите триггер: **Recurrence — Schedule** (Повторение — запланированное).

   ![Добавление триггера Recurrence — Schedule (Повторение — запланированное).](./media/logic-apps-control-flow-loops/do-until-loop-add-trigger.png)

1. Укажите, когда должен срабатывать этот триггер, задав интервал, частоту и час дня. Чтобы указать час выберите **Показать дополнительные параметры**.

   ![Настройка графика повторения](./media/logic-apps-control-flow-loops/do-until-loop-set-trigger-properties.png)

   | Свойство | Значение |
   | -------- | ----- |
   | **Интервал** | 1 | 
   | **Frequency** | День |
   | **В эти часы** | 8 |
   ||| 

1. В разделе триггера выберите **Добавить шаг**. 
   Выполните поиск по слову variables и выберите действие **Initialize variable — Variables** (Инициализация переменной — переменные)

   ![Добавление действия Initialize variable — Variables (Инициализация переменной — переменные).](./media/logic-apps-control-flow-loops/do-until-loop-add-variable.png)

1. Задайте для переменной следующие значения:

   ![Определение свойств переменной](./media/logic-apps-control-flow-loops/do-until-loop-set-variable-properties.png)

   | Свойство | Значение | ОПИСАНИЕ |
   | -------- | ----- | ----------- |
   | **Имя** | Ограничение | Имя переменной | 
   | **Тип** | Целое число  | Тип данных переменной | 
   | **Значение** | 0 | Начальное значение переменной | 
   |||| 

1. В разделе действия **Инициализировать переменную** выберите **Новый шаг**. 

1. Под полем поиска выберите **Все**. Выполните поиск по слову until и выберите действие **Until — Control** (До — Управление).

   ![Добавление цикла until](./media/logic-apps-control-flow-loops/do-until-loop-add-until-loop.png)

1. Создайте условие выхода из цикла. Для этого выберите переменную **Limit** и оператор **is equal**. 
   Введите **10** в качестве значения для сравнения.

   ![Создание условия выхода для завершения цикла](./media/logic-apps-control-flow-loops/do-until-loop-settings.png)

1. В цикле выберите **Добавить действие**. 

1. Под полем поиска выберите **Все**. Выполните поиск по слову variables и выберите действие **Increment variable — Variables** (Увеличение переменной — переменные).

   ![Добавление действия для увеличения значения переменной](./media/logic-apps-control-flow-loops/do-until-loop-increment-variable.png)

1. В поле **Имя** выберите переменную **Limit**. В поле **Значение** введите 1. 

     ![Увеличение значения переменной Limit на 1](./media/logic-apps-control-flow-loops/do-until-loop-increment-variable-settings.png)

1. За пределами, а также под циклом выберите **Новый шаг**. 

1. Под полем поиска выберите **Все**. 
     Найдите и добавьте действие, которое отправляет электронные уведомления, например: 

     ![Добавления действия, которое отправляет сообщение](media/logic-apps-control-flow-loops/do-until-loop-send-email.png)

1. Если отобразится запрос на вход в учетную запись электронной почты, выполните его.

1. Задайте свойства для действия отправки сообщения электронной почты. Добавьте переменную **Limit** в поле темы. Таким образом, вы сможете убедиться в том, что текущее значение переменной соответствует заданному условию, как в этом примере:

      ![Настройка свойств для сообщения электронной почты](./media/logic-apps-control-flow-loops/do-until-loop-send-email-settings.png)

      | Свойство | Значение | ОПИСАНИЕ |
      | -------- | ----- | ----------- | 
      | **To** | *< адрес электронной почты\@домена >* | Адрес электронной почты получателя. Для тестировании используйте свой адрес электронной почты. | 
      | **Тема** | Текущее значение для переменной Limit — это **Limit**. | Укажите тему сообщения. Для этого примера обязательно добавьте переменную **Limit**. | 
      | **Текст** | <*email-content*> | Укажите содержимое сообщения, которое требуется отправить. Для этого примера введите любой текст. | 
      |||| 

1. Сохраните приложение логики. Чтобы вручную проверить приложение логики, на панели инструментов конструктора щелкните **Запустить**.

      После запуска приложения логики вы получите сообщение с содержимым, которое указали:

      ![Полученное сообщение](./media/logic-apps-control-flow-loops/do-until-loop-sent-email.png)

## <a name="prevent-endless-loops"></a>Предотвращение бесконечных циклов

Цикл until имеет ограничения по умолчанию, которые останавливают выполнение при любом из этих условий:

| Свойство | Значение по умолчанию | ОПИСАНИЕ | 
| -------- | ------------- | ----------- | 
| **Count** | 60 | Максимальное количество итераций, выполняемых до выхода из цикла. Значение по умолчанию — 60 повторяемых операций. | 
| **Время ожидания** | PT1H | Максимальное время выполнения цикла до выхода из него. Значение по умолчанию составляет один час и указывается в формате ISO 8601. <p>Значение времени ожидания вычисляется для каждой повторяющейся операции цикла. Если любое действие в цикле выполняется дольше предела времени ожидания, текущий цикл не останавливается. Тем не менее следующий цикл не начнется, потому что предельное условие не выполнено. | 
|||| 

Чтобы изменить эти ограничения по умолчанию, выберите **Показать дополнительные параметры** в области действия цикла.

<a name="until-json"></a>

## <a name="until-definition-json"></a>Определение цикла until (JSON)

При работе в представлении кода для приложения логики вы можете в качестве альтернативы определить цикл `Until` в определении JSON приложения логики, как показано ниже.

``` json
"actions": {
   "Initialize_variable": {
      // Definition for initialize variable action
   },
   "Send_an_email": {
      // Definition for send email action
   },
   "Until": {
      "type": "Until",
      "actions": {
         "Increment_variable": {
            "type": "IncrementVariable",
            "inputs": {
               "name": "Limit",
               "value": 1
            },
            "runAfter": {}
         }
      },
      "expression": "@equals(variables('Limit'), 10)",
      // To prevent endless loops, an "Until" loop 
      // includes these default limits that stop the loop. 
      "limit": { 
         "count": 60,
         "timeout": "PT1H"
      },
      "runAfter": {
         "Initialize_variable": [
            "Succeeded"
         ]
      }
   }
}
```

В этом примере цикл until вызывает конечную точку HTTP, которая создает ресурс. Цикл останавливается, когда HTTP-ответ возвращается с состоянием `Completed` в тексте. Чтобы предотвратить бесконечные циклы, выполнение цикла останавливается при любом из этих условий:

* Цикл выполнялся 10 раз, как указано в атрибуте `count`. Значение по умолчанию — 60 раз. 

* Цикл выполнялся в течение двух часов, как указано в атрибуте `timeout` в формате ISO 8601. Значение по умолчанию — 1 час.
  
``` json
"actions": {
   "myUntilLoopName": {
      "type": "Until",
      "actions": {
         "Create_new_resource": {
            "type": "Http",
            "inputs": {
               "body": {
                  "resourceId": "@triggerBody()"
               },
               "url": "https://domain.com/provisionResource/create-resource",
               "body": {
                  "resourceId": "@triggerBody()"
               }
            },
            "runAfter": {},
            "type": "ApiConnection"
         }
      },
      "expression": "@equals(triggerBody(), 'Completed')",
      "limit": {
         "count": 10,
         "timeout": "PT2H"
      },
      "runAfter": {}
   }
}
```

## <a name="get-support"></a>Получение поддержки

* Если у вас возникли вопросы, то посетите [форум Azure Logic Apps](https://social.msdn.microsoft.com/Forums/en-US/home?forum=azurelogicapps).
* Оставить предложения по функциям или проголосовать за них вы можете на [сайте отзывов пользователей Azure Logic Apps](https://aka.ms/logicapps-wish).

## <a name="next-steps"></a>Дальнейшие действия

* [Conditional statements: Run steps based on a condition in logic apps](../logic-apps/logic-apps-control-flow-conditional-statement.md) (Условные операторы. Выполнение шагов на основе условия в приложениях логики)
* [Операторы switch. Выполнение различных шагов на основе различных значений в приложениях логики](../logic-apps/logic-apps-control-flow-switch-statement.md)
* [Create or join parallel branches in your logic app](../logic-apps/logic-apps-control-flow-branches.md) (Создание или присоединение параллельных ветвей в приложении логики)
* [Области. Выполнение шагов на основе состояния группы в приложениях логики](../logic-apps/logic-apps-control-flow-run-steps-group-scopes.md)
