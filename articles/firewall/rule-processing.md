---
title: Логика обработки правил Брандмауэра Azure
description: В Брандмауэре Azure есть правила преобразования сетевых адресов (NAT), правила сети и правила приложений. Каждое из них обрабатывается в соответствии с типом.
services: firewall
author: vhorne
ms.service: firewall
ms.topic: article
ms.date: 11/18/2020
ms.author: victorh
ms.openlocfilehash: 01f7aa61d3bfb3c712320bbf138160a7ff8197c7
ms.sourcegitcommit: b8eba4e733ace4eb6d33cc2c59456f550218b234
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/23/2020
ms.locfileid: "95502199"
---
# <a name="configure-azure-firewall-rules"></a>Настройка правил брандмауэра Azure
Правила NAT, сетевые правила и правила приложений можно настроить в брандмауэре Azure. Коллекции правил обрабатываются в соответствии с типом правила в порядке приоритета, а более низкие числа — от 100 до 65 000. Имя коллекции правил может содержать только буквы, цифры, символы подчеркивания, точки или дефисы. Оно должно начинаться с буквы или цифры, заканчиваться буквой, цифрой или символом подчеркивания. Максимальная длина имени — 80 символов.

Рекомендуется первоначально разместить номера приоритетов наборов правил с шагом 100 (100, 200, 300 и т. д.), чтобы при необходимости можно было добавлять дополнительные коллекции правил.

> [!NOTE]
> Если включена фильтрация на основе аналитики угроз, эти правила имеют наивысший приоритет и всегда обрабатываются первыми. Фильтрация с использованием логики операций с угрозами может отклонять трафик перед обработкой настроенных правил. Дополнительные сведения см. в статье [Фильтрация на основе интеллектуального анализа угроз в Azure](threat-intel.md).

## <a name="outbound-connectivity"></a>Исходящее подключение

### <a name="network-rules-and-applications-rules"></a>Правила сети и правила приложений

При настройке правил сети и правил приложения правила сети применяются в порядке приоритета перед правилами приложения. Затем выполнение правил завершается. Поэтому при обнаружении совпадения в сетевом правиле никакие другие правила не обрабатываются.  Если правила сети не совпадают, а протоколом является HTTP, HTTPS или MSSQL, пакет затем оценивается правилами приложения в порядке приоритета. Если совпадений не найдено, пакет оценивается по [коллекции правил инфраструктуры](infrastructure-fqdns.md). Если совпадений нет, пакет по умолчанию отклоняется.

#### <a name="network-rule-protocol"></a>Протокол сетевого правила

Сетевые правила можно настроить для протокола **TCP**, **UDP**, **ICMP** или **любой** IP-протокол. Любой IP-протокол включает все IP-протоколы, как указано в документе [номера протоколов IANA (Internet Assigned Numbers Authority)](https://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml) . Если порт назначения настроен явно, то правило преобразуется в правило TCP + UDP.

До 9 ноября 2020 **любой** означал **протокол TCP**, **UDP** или **ICMP**. Итак, вы могли настроить правило до этой даты с помощью протокола = any и портов назначения = ' * '. Если вы не планируете разрешить любой IP-протокол, как определено в настоящее время, измените правило, чтобы явно настроить нужные протоколы (TCP, UDP или ICMP).

## <a name="inbound-connectivity"></a>Входящее подключение

### <a name="nat-rules"></a>Правила преобразования сетевых адресов

Входящее подключение к Интернету можно включить, настроив преобразование сетевых адресов назначения (ДНАТ), как описано в разделе [руководство. Фильтрация входящего трафика с помощью ДНаТ брандмауэра Azure с использованием портал Azure](tutorial-firewall-dnat.md). Правила NAT применяются по приоритету перед правилами сети. Если совпадение найдено, добавляется неявно соответствующее правило сети, чтобы разрешить преобразованный трафик. Чтобы переопределить эту реакцию, явно добавьте коллекцию правил сети с запрещающими правилами, которые соответствуют преобразованному трафику.

Правила приложения не применяются к входящим подключениям. Поэтому, если требуется отфильтровать входящий трафик HTTP/S, следует использовать брандмауэр веб-приложения (WAF). Дополнительные сведения см. в статье [что такое брандмауэр веб-приложения Azure?](../web-application-firewall/overview.md)

## <a name="examples"></a>Примеры

В следующих примерах показаны результаты некоторых из этих сочетаний правил.

### <a name="example-1"></a>Пример 1

Подключение к google.com разрешено из-за соответствующего правила сети.

**Правило сети**

- Действие: Allow


|name  |Протокол  |Тип исходного значения  |Источник  |Тип назначения  |Адрес назначения  |Конечные порты|
|---------|---------|---------|---------|----------|----------|--------|
|Разрешить — Интернет     |TCP|IP-адрес|*|IP-адрес|*|80, 443

**Правило приложения**

- Действие: Deny

|name  |Тип исходного значения  |Источник  |Протокол:порт|Целевые полные доменные имена|
|---------|---------|---------|---------|----------|----------|
|Deny — Google     |IP-адрес|*|http: 80, HTTPS: 443|google.com

**Результат**

Подключение к google.com разрешено, так как пакет соответствует правилу *разрешенных веб* -сетей. На этом этапе обработка правил останавливается.

### <a name="example-2"></a>Пример 2

Трафик SSH запрещен, так как он блокирует коллекцию *правил сети с* более высоким приоритетом.

**Коллекция правил сети 1**

- Имя: Allow-Collection
- Приоритет: 200
- Действие: Allow

|name  |Протокол  |Тип исходного значения  |Источник  |Тип назначения  |Адрес назначения  |Конечные порты|
|---------|---------|---------|---------|----------|----------|--------|
|Allow-SSH     |TCP|IP-адрес|*|IP-адрес|*|22

**Коллекция правил сети 2**

- Имя: Deny-Collection.
- Приоритет. 100
- Действие: Deny

|name  |Протокол  |Тип исходного значения  |Источник  |Тип назначения  |Адрес назначения  |Конечные порты|
|---------|---------|---------|---------|----------|----------|--------|
|Deny-SSH     |TCP|IP-адрес|*|IP-адрес|*|22

**Результат**

SSH-подключения запрещены, так как коллекция сетевых правил с более высоким приоритетом блокирует его. На этом этапе обработка правил останавливается.

## <a name="rule-changes"></a>Изменения правил

Если изменить правило, чтобы запретить ранее разрешенный трафик, все соответствующие существующие сеансы будут удалены.

## <a name="next-steps"></a>Следующие шаги

- Узнайте, как [развернуть и настроить брандмауэр Azure](tutorial-firewall-deploy-portal.md).