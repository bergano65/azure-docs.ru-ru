---
title: Подключение к SQL Server, базе данных SQL Azure или Управляемый экземпляр SQL Azure
description: Автоматизируйте задачи для баз данных SQL в локальной среде или в облаке с помощью Azure Logic Apps.
services: logic-apps
ms.suite: integration
ms.reviewer: estfan, jonfan, logicappspm
ms.topic: conceptual
ms.date: 06/06/2020
tags: connectors
ms.openlocfilehash: a50a171536d7f81de42da415960398d31ec64827
ms.sourcegitcommit: 32c521a2ef396d121e71ba682e098092ac673b30
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2020
ms.locfileid: "91326785"
---
# <a name="automate-workflows-for-a-sql-database-by-using-azure-logic-apps"></a>Автоматизация рабочих процессов для базы данных SQL с помощью Azure Logic Apps

В этой статье описано, как получить доступ к данным в базе данных SQL из приложения логики с помощью соединителя SQL Server. Так вы можете автоматизировать задачи, процессы или рабочие процессы, которые управляют данными и ресурсами SQL, создав приложения логики. Соединитель SQL Server работает для [SQL Server](/sql/sql-server/sql-server-technical-documentation) , а также для [базы данных sql Azure](../azure-sql/database/sql-database-paas-overview.md) и [управляемый экземпляр Azure SQL](../azure-sql/managed-instance/sql-managed-instance-paas-overview.md).

Вы можете создавать приложения логики, которые активируются событиями в базе данных SQL или в других системах, таких как Dynamics CRM Online. Приложения логики могут получать, вставлять или удалять данные, а также выполнять хранимые процедуры и SQL-запросы. Например, вы можете создать приложение логики, которое автоматически проверяет наличие новых записей в Dynamics CRM Online, добавляет элементы в Базу данных SQL для новых записей, а затем отправляет оповещения по электронной почте о добавленных элементах.

Если вы не знакомы с приложениями логики, ознакомьтесь со статьями [Что такое Azure Logic Apps](../logic-apps/logic-apps-overview.md) и [Краткое руководство. Создание первого автоматизированного рабочего процесса с помощью Azure Logic Apps на портале Azure](../logic-apps/quickstart-create-first-logic-app-workflow.md). Технические сведения о соединителях, их ограничениях и известных проблемах доступны на странице [справочных материалов по соединителям SQL Server](/connectors/sql/).

## <a name="prerequisites"></a>Предварительные требования

* Подписка Azure. Если у вас нет ее, вы можете [зарегистрироваться для получения бесплатной учетной записи Azure](https://azure.microsoft.com/free/).

* [База данных SQL Server](/sql/relational-databases/databases/create-a-database), [база данных SQL Azure](../azure-sql/database/single-database-create-quickstart.md)или [управляемый экземпляр SQL Azure](../azure-sql/managed-instance/instance-create-quickstart.md).

  Чтобы при вызове операций приложение логики могло вернуть результаты, таблицы должны содержать данные. При использовании базы данных SQL Azure можно использовать образцы баз данных, которые включены в.

* Имя сервера SQL, имя базы данных, а также имя пользователя и пароль. Эти учетные данные используются для авторизации приложения логики и получения доступа к серверу SQL.

  * Для локальных SQL Server эти сведения можно найти в строке подключения:

    `Server={your-server-address};Database={your-database-name};User Id={your-user-name};Password={your-password};`

  * Для базы данных SQL Azure эти сведения можно найти в строке подключения.
  
    Например, чтобы найти эту строку в портал Azure, откройте базу данных. В меню База данных выберите пункт **строки подключения** или **свойства**.

    `Server=tcp:{your-server-name}.database.windows.net,1433;Initial Catalog={your-database-name};Persist Security Info=False;User ID={your-user-name};Password={your-password};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;`

<a name="multi-tenant-or-ise"></a>

* В зависимости от того, будут ли приложения логики выполняться в глобальном, многоклиентном Azure или [среде службы интеграции (ISE)](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md), ниже приведены другие требования для подключения к локальной SQL Server.

  * Для приложений логики в глобальном, многоклиентном Azure, которое подключается к локальным SQL Server, необходимо установить локальный [шлюз данных](../logic-apps/logic-apps-gateway-install.md) на локальном компьютере и [ресурс шлюза данных, который уже создан в Azure](../logic-apps/logic-apps-gateway-connection.md).

  * Для приложений логики в интегрированной среде сценариев, которая подключается к локальным SQL Server и используют проверку подлинности Windows, соединитель SQL Server с ИНТЕГРИРОВАНной поддержкой версий не поддерживает проверку подлинности Windows. Поэтому вам по-прежнему нужно использовать шлюз данных и соединитель SQL Server, не связанный с ISE. Для других типов проверки подлинности не требуется использовать шлюз данных и может использоваться соединитель с версией ISE.

* Приложения логики с возможностью доступа к базе данных SQL. Чтобы запустить приложение логики с помощью триггера SQL, требуется [пустое приложение логики](../logic-apps/quickstart-create-first-logic-app-workflow.md).

<a name="create-connection"></a>

## <a name="connect-to-your-database"></a>Подключение к базе данных

[!INCLUDE [Create connection general intro](../../includes/connectors-create-connection-general-intro.md)]

Теперь выполните следующие действия.

* [Подключение к облачной базе данных SQL Azure или Управляемый экземпляр](#connect-azure-sql-db)
* [Подключение к локальной SQL Server](#connect-sql-server)

<a name="connect-azure-sql-db"></a>

### <a name="connect-to-azure-sql-database-or-managed-instance"></a>Подключение к базе данных SQL Azure или Управляемый экземпляр

При первом добавлении [триггера SQL](#add-sql-trigger) или [действия SQL](#add-sql-action), но ранее не было создано подключение к базе данных, вам будет предложено выполнить следующие действия:

1. В поле **тип проверки подлинности**выберите необходимую проверку подлинности и включите ее в базе данных SQL azure или управляемый экземпляр SQL Azure:

   | Аутентификация | Описание |
   |----------------|-------------|
   | [**Интегрированная служба Azure AD**](../azure-sql/database/authentication-aad-overview.md) | — Поддерживает как сторонние, так и ИНТЕГРИРОВАНные в среду SQL Server соединители. <p><p>— Требуется действительное удостоверение в Azure Active Directory (Azure AD), которое имеет доступ к базе данных. <p>Дополнительные сведения см. в следующих статьях: <p>- [Общие сведения о безопасности SQL Azure — проверка подлинности](../azure-sql/database/security-overview.md#authentication) <br>- [Авторизация доступа к базе данных в Azure SQL — проверка подлинности и авторизация](../azure-sql/database/logins-create-manage.md#authentication-and-authorization) <br>- [Azure SQL — встроенная проверка подлинности Azure AD](../azure-sql/database/authentication-aad-overview.md) |
   | [**Проверка подлинности SQL Server**](/sql/relational-databases/security/choose-an-authentication-mode#connecting-through-sql-server-authentication) | — Поддерживает как сторонние, так и ИНТЕГРИРОВАНные в среду SQL Server соединители. <p><p>— Требуется допустимое имя пользователя и надежный пароль, которые создаются и хранятся в базе данных. <p>Дополнительные сведения см. в следующих статьях: <p>- [Общие сведения о безопасности SQL Azure — проверка подлинности](../azure-sql/database/security-overview.md#authentication) <br>- [Авторизация доступа к базе данных в Azure SQL — проверка подлинности и авторизация](../azure-sql/database/logins-create-manage.md#authentication-and-authorization) |
   |||

   Этот пример продолжит работать с **интегрированной службой Azure AD**:

   ![Снимок экрана, на котором показано окно подключения "SQL Server" с открытым списком "тип проверки подлинности" и выбранным параметром "Интеграция с Azure AD".](./media/connectors-create-api-sqlazure/select-azure-ad-authentication.png)

1. Выбрав **интегрированная служба Azure AD**, выберите **Вход**. В зависимости от того, используется ли база данных SQL Azure или Azure SQL Управляемый экземпляр, выберите учетные данные пользователя для проверки подлинности.

1. Выберите следующие значения для базы данных:

   | Свойство | Обязательно | Описание |
   |----------|----------|-------------|
   | **Имя сервера** | Да | Адрес для SQL Server, например `Fabrikam-Azure-SQL.database.windows.net` |
   | **Имя базы данных** | Да | Имя базы данных SQL, например `Fabrikam-Azure-SQL-DB` |
   | **Имя таблицы** | Да | Таблица, которую необходимо использовать, например `SalesLT.Customer` |
   ||||

   > [!TIP]
   > Эти сведения можно найти в строке подключения базы данных. Например, в портал Azure найдите и откройте свою базу данных. В меню База данных выберите **строки подключения** или **свойства** , в которых можно найти следующую строку:
   >
   > `Server=tcp:{your-server-address}.database.windows.net,1433;Initial Catalog={your-database-name};Persist Security Info=False;User ID={your-user-name};Password={your-password};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;`

   В этом примере показано, как могут выглядеть эти значения:

   ![Создание подключения к базе данных SQL](./media/connectors-create-api-sqlazure/azure-sql-database-create-connection.png)

1. Теперь выполните действия, которые еще не были выполнены, в разделе [Добавление триггера SQL](#add-sql-trigger) или [Добавление действия SQL](#add-sql-action).

<a name="connect-sql-server"></a>

### <a name="connect-to-on-premises-sql-server"></a>Подключение к локальной SQL Server

При первом добавлении [триггера SQL](#add-sql-trigger) или [действия SQL](#add-sql-action), но ранее не было создано подключение к базе данных, вам будет предложено выполнить следующие действия:

1. Для подключения к локальному серверу SQL Server, для которого требуется локальный шлюз данных, убедитесь, что [выполнены все необходимые условия](#multi-tenant-or-ise).

   В противном случае ресурс шлюза данных не будет отображаться в списке **шлюза подключения** при создании подключения.

1. В поле **тип проверки подлинности**выберите требуемую и включенную проверку подлинности для SQL Server:

   | Аутентификация | Описание |
   |----------------|-------------|
   | [**Проверка подлинности Windows**](/sql/relational-databases/security/choose-an-authentication-mode#connecting-through-windows-authentication) | — Поддерживает только соединитель SQL Server, не связанный с ISE, для которого требуется ресурс шлюза данных, созданный ранее в Azure для вашего подключения, независимо от того, используете ли вы Azure или интегрированную среду сценариев (Multi-клиент). <p><p>— Требуется допустимое имя пользователя Windows и пароль для подтверждения личности с помощью учетной записи Windows. <p>Дополнительные сведения см. в статье [Проверка подлинности Windows](/sql/relational-databases/security/choose-an-authentication-mode#connecting-through-windows-authentication) . |
   | [**Проверка подлинности SQL Server**](/sql/relational-databases/security/choose-an-authentication-mode#connecting-through-sql-server-authentication) | — Поддерживает как сторонние, так и ИНТЕГРИРОВАНные в среду SQL Server соединители. <p><p>— Требуется допустимое имя пользователя и надежный пароль, которые создаются и сохраняются в SQL Server. <p>Дополнительные сведения см. в разделе [SQL Serverная проверка подлинности](/sql/relational-databases/security/choose-an-authentication-mode#connecting-through-sql-server-authentication). |
   |||

   Этот пример продолжит **проверку подлинности Windows**:

   ![Выберите тип проверки подлинности для использования](./media/connectors-create-api-sqlazure/select-windows-authentication.png)

1. Выберите или укажите следующие значения для базы данных SQL:

   | Свойство | Обязательно | Описание |
   |----------|----------|-------------|
   | **Имя SQL Server** | Да | Адрес для SQL Server, например `Fabrikam-Azure-SQL.database.windows.net` |
   | **Имя базы данных SQL** | Да | Имя базы данных SQL Server, например `Fabrikam-Azure-SQL-DB` |
   | **Имя пользователя** | Да | Имя пользователя для SQL Server и базы данных |
   | **Пароль** | Да | Пароль для SQL Server и базы данных |
   | **Подписка** |  Да, для проверки подлинности Windows | Подписка Azure для ресурса шлюза данных, созданного ранее в Azure |
   | **Шлюз подключения** | Да, для проверки подлинности Windows | Имя ресурса шлюза данных, созданного ранее в Azure <p><p>**Совет**. Если шлюз не отображается в списке, проверьте правильность [настройки шлюза](../logic-apps/logic-apps-gateway-connection.md). |
   |||

   > [!TIP]
   > Эти сведения можно найти в строке подключения базы данных:
   > 
   > * `Server={your-server-address}`
   > * `Database={your-database-name}`
   > * `User ID={your-user-name}`
   > * `Password={your-password}`

   В этом примере показано, как могут выглядеть эти значения:

   ![Создание подключения SQL Server завершено](./media/connectors-create-api-sqlazure/sql-server-create-connection-complete.png)

1. Когда будете готовы, нажмите **Создать**.

1. Теперь выполните действия, которые еще не были выполнены, в разделе [Добавление триггера SQL](#add-sql-trigger) или [Добавление действия SQL](#add-sql-action).

<a name="add-sql-trigger"></a>

## <a name="add-a-sql-trigger"></a>Добавление триггера SQL

1. В [портал Azure](https://portal.azure.com) или в Visual Studio создайте пустое приложение логики, которое открывает Конструктор приложений логики. Этот пример продолжится с портал Azure.

1. В конструкторе в поле поиска введите `sql server` . В списке триггеров выберите нужный триггер SQL. В этом примере используется триггер **при создании элемента** .

   ![Выбор триггера "При создании элемента"](./media/connectors-create-api-sqlazure/select-sql-server-trigger.png)

1. Если вы впервые подключаетесь к базе данных SQL, вам будет предложено [создать подключение к базе данных SQL](#create-connection). После создания этого подключения можно перейти к следующему шагу.

1. В триггере укажите интервал и частоту, с которой триггер проверяет таблицу.

1. Чтобы добавить другие доступные свойства для этого триггера, откройте список **Добавить новый параметр** .

   Этот триггер возвращает только одну строку из выбранной таблицы и ничего другого. Чтобы выполнить другие задачи, добавьте [действие соединителя SQL](#add-sql-action) или [другое действие](../connectors/apis-list.md) , которое будет выполнять следующую задачу в рабочем процессе приложения логики.
   
   Например, чтобы просмотреть данные в этой строке, можно добавить другие действия, которые создают файл, содержащий поля из возвращенной строки, а затем отправляют оповещения по электронной почте. Дополнительные сведения о других доступных действиях для этого соединителя см. на странице [справочных материалов по соединителю](/connectors/sql/).

1. На панели инструментов конструктора щелкните **Сохранить**.

   Хотя этот шаг автоматически включает и публикует приложение логики в Azure, единственное действие, выполняемое приложением логики, — проверка базы данных в соответствии с заданным интервалом и частотой.

<a name="add-sql-action"></a>

## <a name="add-a-sql-action"></a>Добавление действия SQL

В этом примере приложение логики запускается при срабатывании [триггера повторения](../connectors/connectors-native-recurrence.md). Оно вызывает действие, которое получает строку из базы данных SQL.

1. В [портал Azure](https://portal.azure.com) или в Visual Studio откройте приложение логики в конструкторе приложений логики. В этом примере выполняется продолжение портал Azure.

1. Для триггера или действия, в которое вы хотите добавить действие SQL, выберите **Создать шаг**.

   ![Добавление действия в приложение логики](./media/connectors-create-api-sqlazure/select-new-step-logic-app.png)

   Чтобы добавить действие между существующими шагами, наведите указатель мыши на стрелку соединения. Нажмите появившийся знак "плюс" ( **+** ), а затем выберите **Добавить действие**.

1. В разделе **Выберите действие**, введите в поле поиска `sql server`. Из списка действий выберите соответствующее действие SQL. В этом примере используется действие **Получить строку**, которое получает одну запись.

   ![Выбор действия "получить строку" SQL](./media/connectors-create-api-sqlazure/select-sql-get-row-action.png)

1. Если вы впервые подключаетесь к базе данных SQL, вам будет предложено [создать подключение к базе данных SQL](#create-connection). После создания этого подключения можно перейти к следующему шагу.

1. Выберите **имя таблицы** `SalesLT.Customer` в этом примере. Введите **идентификатор строки** для нужной записи.

   ![Выберите имя таблицы и укажите идентификатор строки](./media/connectors-create-api-sqlazure/specify-table-row-id.png)

   Это действие возвращает только одну строку из выбранной таблицы. Таким образом, для просмотра данных в этой строке можно добавить другие действия, которые создают файл, включающий поля из возвращенной строки, и сохраняют этот файл в облачной учетной записи хранения. Дополнительные сведения о других доступных действиях для этого соединителя см. на странице [справочных материалов по соединителю](/connectors/sql/).

1. По завершении нажмите кнопку **Сохранить** на панели инструментов конструктора.

   Этот шаг автоматически включает и публикует приложение логики в Azure в реальном времени.

## <a name="handle-bulk-data"></a>Обработка больших данных

Иногда требуется оперировать такими большими результирующими наборами, что соединитель не может вернуть все результаты одновременно, либо требуется контролировать размер и структуру результирующих наборов. Ниже приведено несколько способов, помогающих справиться с большими результирующими наборами.

* Чтобы упростить управление результатами в виде небольших наборов, включите *разбиение на страницы*. Дополнительные сведения см. в разделе [Получение дополнительных данных, элементов или записей с помощью разбиения на страницы в Azure Logic Apps](../logic-apps/logic-apps-exceed-default-page-size-with-pagination.md).

* Создайте хранимую процедуру, которая упорядочивает результаты подходящим вам способом.

  При получении или вставке нескольких строк приложение логики может выполнять их итерацию с помощью [*цикла UNTIL*](../logic-apps/logic-apps-control-flow-loops.md#until-loop) с учетом этих [ограничений](../logic-apps/logic-apps-limits-and-config.md). Но иногда приложение логики должно работать с настолько большими наборами данных, например с тысячами или миллионами строк, что целесообразно сократить расходы на вызовы к базе данных.

  Чтобы упорядочить результаты подходящим вам способом, можно создать [*хранимую процедуру*](/sql/relational-databases/stored-procedures/stored-procedures-database-engine), которая выполняется в экземпляре SQL и использует инструкцию **SELECT - ORDER BY**. Это решение позволяет управлять размером и структурой полученных результатов. Приложение логики вызывает хранимую процедуру с помощью действия **выполнения хранимой процедуры** соединителя SQL Server.

  Дополнительные сведения о решении:

  * [Разбиение на страницы в SQL для массовой передачи данных с помощью Logic Apps](https://social.technet.microsoft.com/wiki/contents/articles/40060.sql-pagination-for-bulk-data-transfer-with-logic-apps.aspx)

  * [Предложение SELECT - ORDER BY](/sql/t-sql/queries/select-order-by-clause-transact-sql)

### <a name="handle-dynamic-bulk-data"></a>Обработка динамических больших данных

При вызове хранимой процедуры с помощью соединителя SQL Server возвращаемые выходные данные иногда являются динамическими. В этом случае выполните следующее.

1. Откройте приложение логики в конструкторе приложений логики на [портале Azure](https://portal.azure.com).

1. Просмотрите формат выходных данных, выполнив тестовый запуск. Скопируйте и сохраните пример выходных данных.

1. В конструкторе в действии, в котором вызывается хранимая процедура, выберите **Новый шаг**.

1. В разделе **Выбор действия**найдите и выберите действие [**анализ JSON**](../logic-apps/logic-apps-perform-data-operations.md#parse-json-action) .

1. В действии **Анализ JSON** выберите **Использовать образец полезных данных для создания схемы**.

1. В поле **введите или вставьте образец полезных данных JSON** вставьте пример выходных данных и нажмите кнопку **Готово**.

   > [!NOTE]
   > Если появится сообщение о том, что Logic Apps не удается создать схему, проверьте правильность формата синтаксиса примера выходных данных. Если вы по-прежнему не можете создать схему, в поле **схема** введите схему вручную.

1. На панели инструментов конструктора щелкните **Сохранить**.

1. Чтобы создать ссылку на свойства содержимого JSON, щелкните внутри полей редактирования, в которых необходимо создать ссылку на эти свойства, чтобы появился список динамического содержимого. В списке под заголовком [**анализ JSON**](../logic-apps/logic-apps-perform-data-operations.md#parse-json-action) выберите нужные маркеры данных для свойств содержимого JSON.

## <a name="connector-specific-details"></a>Сведения о соединителях

Технические сведения о триггерах, действиях и ограничениях этого соединителя см. на [странице справочника по соединителю](/connectors/sql/), которая создается из описания Swagger.

## <a name="next-steps"></a>Дальнейшие действия

* Узнайте больше о других [соединителях для Azure Logic Apps](../connectors/apis-list.md).

