---
title: Руководство. Использование сеансов отладки для исправления наборов навыков
titleSuffix: Azure Cognitive Search
description: Сеансы отладки (предварительная версия) — это средство на портале Azure, используемое для поиска, диагностики и устранения проблем в наборе навыков.
author: HeidiSteen
ms.author: heidist
manager: nitinme
ms.service: cognitive-search
ms.topic: tutorial
ms.date: 02/02/2021
ms.openlocfilehash: ed988baec46152d55cf63aec09fce7a298157212
ms.sourcegitcommit: b85ce02785edc13d7fb8eba29ea8027e614c52a2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "99509155"
---
# <a name="tutorial-debug-a-skillset-using-debug-sessions"></a>Руководство. Отладка набора навыков с помощью сеансов отладки

Набор навыков управляет серией действий, которые анализируют или преобразуют содержимое, используя выходные данные одного навыка в качестве входных данных другого. Если входные данные зависят от выходных, ошибки в определениях набора навыков и связываниях полей могут привести к отсутствию операций и данных.

В разделе **Сеансы отладки** на портале Azure представлена комплексная визуализация набора навыков. С помощью этого средства вы можете перейти к определенным шагам и определить, где возникает ошибка.

При работе с этой статьей вы будете использовать **сеансы отладки** для поиска и устранения проблем с отсутствующими входными данными и сопоставлениями полей выходных данных. Это руководство включает все необходимое для работы. В нем предоставлены данные для индексирования (данные клинических исследований), коллекция Postman, которая создает объекты, и инструкции по использованию **сеансов отладки** для поиска и устранения проблем в наборе навыков.

> [!Important]
> Сеансы отладки — это функция в предварительной версии, которая предоставляется без соглашения об уровне обслуживания, поэтому использовать ее в рабочей среде не рекомендуется. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).
>

## <a name="prerequisites"></a>Предварительные требования

Прежде чем приступить к работе, подготовьте указанные ниже необходимые компоненты:

+ Учетная запись Azure с активной подпиской. [Создайте учетную запись](https://azure.microsoft.com/free/) бесплатно.

+ Служба "Когнитивный поиск Azure". [Создайте службу](search-create-service-portal.md) или [найдите имеющуюся службу](https://ms.portal.azure.com/#blade/HubsExtension/BrowseResourceBlade/resourceType/Microsoft.Search%2FsearchServices) в рамках текущей подписки. Вы можете использовать бесплатную службу для выполнения инструкций, описанных в этом кратком руководстве. 

+ Учетная запись хранения Azure с [Хранилищем BLOB-объектов](../storage/blobs/index.yml), используемым для размещения примеров данных, а также для хранения временных данных, которые создаются во время сеанса отладки.

+ [Классическое приложение Postman](https://www.getpostman.com/) и [коллекция Postman](https://github.com/Azure-Samples/azure-search-postman-samples/tree/master/Debug-sessions) для создания объектов с помощью REST API.

+ [Пример данных (клинические исследования).](https://github.com/Azure-Samples/azure-search-sample-data/tree/master/clinical-trials-pdf-19)

> [!NOTE]
> В этом кратком руководстве также используется [Azure Cognitive Services](https://azure.microsoft.com/services/cognitive-services/) для искусственного интеллекта. Так как рабочая нагрузка мала, Cognitive Services работает в фоновом режиме, чтобы обеспечить бесплатную обработку до 20 транзакций. Это означает, что вы можете выполнить это упражнение без создания дополнительного ресурса Cognitive Services.

## <a name="set-up-your-data"></a>Настройка данных

С помощью инструкций из этого раздела вы создадите пример набора данных в Хранилище BLOB-объектов Azure, с которыми будут работать индексатор и набор навыков.

1. [Скачайте пример данных (clinical-trials-pdf-19)](https://github.com/Azure-Samples/azure-search-sample-data/tree/master/clinical-trials-pdf-19), состоящий из 19 файлов.

1. [Создайте учетную запись хранения Azure](../storage/common/storage-account-create.md?tabs=azure-portal) или [найдите имеющуюся учетную запись](https://ms.portal.azure.com/#blade/HubsExtension/BrowseResourceBlade/resourceType/Microsoft.Storage%2storageAccounts/). 

   + Выберите регион, в котором размещается Когнитивный поиск Azure, чтобы не оплачивать трафик.

   + Выберите тип учетной записи StorageV2 (общего назначения версии 2).

1. Перейдите к страницам служб хранилища Azure на портале и создайте контейнер больших двоичных объектов. Рекомендуется указать уровень доступа "частный". Присвойте контейнеру имя `clinicaltrialdataset`.

1. В контейнере щелкните **Отправить**, чтобы отправить примеры файлов, скачанных и распакованных на первом шаге.

1. На портале получите и сохраните строку подключения к службе хранилища Azure. Она понадобится вам для вызовов REST API, которые индексируют данные. Вы можете получить строку подключения, выбрав **Параметры** > **Ключи доступа** на портале.

## <a name="get-a-key-and-url"></a>Получение ключа и URL-адреса

Вызовам REST требуется URL-адрес службы и ключ доступа при каждом запросе. Служба поиска создана с обоими элементами, поэтому если вы добавили службу "Когнитивный поиск Azure" в подписку, выполните следующие действия для получения необходимых сведений:

1. [Войдите на портал Azure](https://portal.azure.com/) и на странице **обзора** службы поиска получите URL-адрес. Пример конечной точки может выглядеть так: `https://mydemo.search.windows.net`.

1. В разделе **Параметры** > **Ключи** получите ключ администратора, чтобы обрести полные права на службу. Существуют два взаимозаменяемых ключа администратора, предназначенных для обеспечения непрерывности бизнес-процессов на случай, если вам потребуется сменить один из них. Вы можете использовать первичный или вторичный ключ для выполнения запросов на добавление, изменение и удаление объектов.

   :::image type="content" source="media/search-get-started-rest/get-url-key.png" alt-text="Получение конечной точки HTTP и ключа доступа" border="false":::

Для выполнения любого запроса к службе требуется использование ключа API. Если есть действительный ключ, для каждого запроса устанавливаются отношения доверия между приложением, которое отправляет запрос, и службой, которая его обрабатывает.

## <a name="create-data-source-skillset-index-and-indexer"></a>Создание источника данных, набора навыков, индекса и индексатора

В этом разделе для создания источника данных, набора навыков, набора навыков, индекса и индексатора Когнитивного поиска используются Postman и предоставленная коллекция. Если вы не знакомы с Postman, см. [это краткое руководство](search-get-started-rest.md).

Для выполнения этой задачи из руководства вам понадобится [коллекция Postman](https://github.com/Azure-Samples/azure-search-postman-samples/tree/master/Debug-sessions). 

1. Запустите Postman и импортируйте коллекцию. Последовательно выберите **Files** > **New** (Файлы > Создать) и выберите коллекцию для импорта.
1. После импорта коллекции разверните список действий (...).
1. Нажмите кнопку **Изменить**.
1. В разделе "Текущее значение" введите имя своей службы `searchService` (например, если используется конечная точка `https://mydemo.search.windows.net`, именем службы будет `mydemo`).
1. Введите для `apiKey` первичный или вторичный ключ службы поиска.
1. Введите `storageConnectionString` со страницы ключа учетной записи хранения Azure.
1. Введите имя `containerName` для контейнера, созданного в учетной записи хранения, а затем щелкните **Обновить**.

   :::image type="content" source="media/cognitive-search-debug/postman-enter-variables.png" alt-text="Изменение переменных в Postman":::

Коллекция содержит четыре разных вызова REST, которые используются при создании объектов для работы с этим руководством.

Первый вызов создает источник данных `clinical-trials-ds`. Второй — набор навыков `clinical-trials-ss`. Третий — индекс `clinical-trials`. Четвертый и последний — индексатор `clinical-trials-idxr`.

+ Поочередно откройте каждый запрос и щелкните **Отправить**, чтобы отправить каждый запрос службе поиска. 

После выполнения всех вызовов в коллекции закройте Postman и вернитесь на портал Azure.

## <a name="check-results-in-the-portal"></a>Просмотр результатов на портале

Пример кода специально создает индекс с ошибками, как следствие проблем, возникших во время выполнения набора навыков. Проблемой являются отсутствующие данные. 

1. На портале Azure на странице "Общие сведения" службы поиска откройте вкладку **Индексы**. 
1. Выберите индекс `clinical-trials`.
1. Введите строку запроса `$select=metadata_storage_path, organizations, locations&$count=true`, чтобы вернуть поля для определенных документов (определяются уникальным полем `metadata_storage_path`).
1. Щелкните **Поиск**, чтобы выполнить запрос и вернуть все 19 документов, которые отображают пустые значения для organizations и locations.

Эти поля должны быть заполнены с помощью [навыка распознавания сущностей](cognitive-search-skill-entity-recognition.md) в наборе навыков, который используется для поиска организаций и расположений в содержимом больших двоичных объектов. В следующем упражнении показано, как использовать сеанс отладки для определения причины.

Ошибки и предупреждения также можно изучить на портале Azure.

1. Откройте вкладку **Индексаторы** и выберите `clinical-trials-idxr`.
1. Обратите внимание, что хотя задание индексатора было выполнено успешно, отобразилось 57 предупреждений.
1. Щелкните **Успешно**, чтобы просмотреть предупреждения (если задание выполнено преимущественно с ошибками, ссылка на сведения будет отображаться как **Ошибка**). Вы увидите длинный список с каждым предупреждением, выданным индексатором.

   :::image type="content" source="media/cognitive-search-debug/portal-indexer-errors-warnings.png" alt-text="Просмотр предупреждений":::

## <a name="start-your-debug-session"></a>Запуск сеанса отладки

:::image type="content" source="media/cognitive-search-debug/new-debug-session-screen-required.png" alt-text="Запуск нового сеанса отладки":::

1. На странице с общими сведениями о службе поиска откройте вкладку **Сеансы отладки**.
1. Выберите **+ Запустить новый сеанс отладки**.
1. Присвойте сеансу имя. 
1. Подключите сеанс к учетной записи хранения. 
1. В шаблоне индексатора укажите имя индексатора. Индексатор содержит ссылки на источник данных, набор навыков и индекс.
1. Примите выбор документа по умолчанию для первого документа в коллекции. 
1. **Сохраните** сеанс. Сохранение сеанса инициирует конвейер обогащения с помощью ИИ, как определено в наборе навыков.

> [!Important]
> Сеанс отладки работает только с одним документом. Вы можете выбрать документ для отладки или открыть первый.

<!-- > :::image type="content" source="media/cognitive-search-debug/debug-execution-complete1.png" alt-text="New debug session started"::: -->

Когда сеанс отладки завершит инициализацию, по умолчанию откроется вкладка **Обогащение ИИ**, на которой будет выделен **граф навыков**. На графе навыков представлена иерархия набора навыков и указан порядок выполнения последовательным и параллельным способами.

## <a name="find-issues-with-the-skillset"></a>Поиск проблем с набором навыков

Все проблемы, о которых сообщает индексатор, можно найти на соседней вкладке **Ошибки и предупреждения**. 

Учтите, что список на вкладке **Ошибки и предупреждения** значительно короче того, который отобразился ранее, так как в нем содержатся только сведения об ошибках для одного документа. Как и в списке, отображаемом индексатором, здесь можно щелкнуть сообщение с предупреждением и просмотреть для него подробные сведения.

Выберите **Ошибки и предупреждения**, чтобы просмотреть уведомления. Должны отобразиться три таких уведомления:

   + Could not map output field 'locations' to search index. Could not map output field 'locations' to search index. Missing value '/document/merged_content/locations'. (Не удалось сопоставить поле выходных данных locations с индексом поиска. Проверьте свойство outputFieldMappings индексатора.
Отсутствует значение /document/merged_content/locations.)

   + Could not map output field 'organizations' to search index. Check the 'outputFieldMappings' property of your indexer. Missing value '/document/merged_content/organizations'. (Не удалось сопоставить поле выходных данных organizations с индексом поиска. Проверьте свойство outputFieldMappings индексатора.
Отсутствует значение /document/merged_content/organizations.)

   + Skill executed but may have unexpected results because one or more skill inputs was invalid. Optional skill input is missing. Name: 'languageCode', Source: '/document/languageCode'. Expression language parsing issues: Missing value '/document/languageCode'.
(Навык выполнен, но может привести к непредвиденным результатам, так как некоторые входные данные навыка недопустимы. Отсутствуют дополнительные входные данные навыка. Имя: languageCode; источник: /document/languageCode. Проблемы с анализом языка выражения: отсутствует значение /document/languageCode.)

   У многих навыков есть параметр languageCode. Проверив операцию, вы увидите, что эти входные данные кода отсутствуют в `Enrichment.NerSkillV2.#1`, который является тем же навыком распознавания сущностей с проблемами в выходных данных locations и organizations. 

Так как все три уведомления относятся к этому навыку, на следующем шаге вам нужно выполнить его отладку. При возможности начните с решения проблем с входными данными, прежде чем приступать к устранению проблем с outputFieldMapping.

 :::image type="content" source="media/cognitive-search-debug/debug-session-errors-warnings.png" alt-text="Запущен новый сеанс отладки":::

<!-- + The Skill Graph provides a visual hierarchy of the skillset and its order of execution from top to bottom. Skills that are side by side in the graph are executed in parallel. Color coding of skills in the graph indicate the types of skills that are being executed in the skillset. In the example, the green skills are text and the red skill is vision. Clicking on an individual skill in the graph will display the details of that instance of the skill in the right pane of the session window. The skill settings, a JSON editor, execution details, and errors/warnings are all available for review and editing.

+ The Enriched Data Structure details the nodes in the enrichment tree generated by the skills from the source document's contents. -->

## <a name="fix-missing-skill-input-value"></a>Исправление ошибок из-за отсутствия входного значения навыка

На вкладке **Ошибки и предупреждения** указана ошибка для операции с пометкой `Enrichment.NerSkillV2.#1`. В сведениях об этой ошибке объясняется, что возникла проблема со входным значением навыка "/document/languageCode". 

1. Вернитесь на вкладку **Обогащение ИИ**.
1. Щелкните **Граф навыков**.
1. Щелкните навык, помеченный как **№ 1**, чтобы в области справа для него отобразились подробные сведения.
1. Найдите входное значение для "languageCode".
1. Выберите символ в начале строки **</>** и откройте вычислитель выражений.
1. Нажмите кнопку **Вычислить** и убедитесь, что это выражение приводит к ошибке. Это подтвердит, что свойство "languageCode" не является допустимым входным значением.

   :::image type="content" source="media/cognitive-search-debug/expression-evaluator-language.png" alt-text="Вычислитель выражений":::

Эту ошибку в сеансе можно изучить двумя способами. Первый — посмотреть, откуда поступают входные данные. Какой навык в иерархии предположительно выдает такой результат? На вкладке "Число выполнений" в области сведений о навыках должен отображаться источник входных данных. Если источник отсутствует, это указывает на ошибку сопоставления полей.

1. Перейдите на вкладку **Число выполнений**.
1. Найдите свойство "ВХОДНЫЕ ДАННЫЕ" и "languageCode". Источник для этого входного значения не указан. 
1. В области слева перейдите на вкладку "Обогащенная структура данных". Сопоставленный путь, соответствующий "languageCode", отсутствует.

   :::image type="content" source="media/cognitive-search-debug/enriched-data-structure-language.png" alt-text="Вкладка &quot;Обогащенная структура данных&quot;":::

При этом существует сопоставленный путь для "language". Таким образом, в параметрах навыка допущена опечатка. Чтобы исправить это выражение в навыке № 1, необходимо обновить /document/language.

1. Откройте вычислитель выражений **</>** для пути "language".
1. Скопируйте выражение. Закройте окно.
1. Перейдите к параметрам навыка № 1 и откройте вычислитель выражений **</>** для входного значения "languageCode".
1. Вставьте новое значение "/document/language" в поле выражение и нажмите кнопку **Вычислить**.
1. Должно отобразиться правильное входное значение "en". Чтобы обновить выражение, нажмите кнопку "Применить".
1. Щелкните **Сохранить** справа. Откроется область сведений о навыках.
1. Щелкните **Выполнить** в меню окна сеанса. Это приведет к другому запуску набора навыков с использованием документа. 

После завершения сеанса отладки перейдите на вкладку "Ошибки и предупреждения" и убедитесь, что ошибка, помеченная как "Enrichment.NerSkillV2.#1", исчезла. Однако остались два предупреждения о том, что служба не может сопоставлять выходные поля для организаций и расположений с индексом поиска. Отсутствуют значения: "/document/merged_content/organizations" и "/document/merged_content/locations".

## <a name="fix-missing-skill-output-values"></a>Исправление ошибок из-за отсутствия выходного значения навыка

:::image type="content" source="media/cognitive-search-debug/warnings-missing-value-locations-organizations.png" alt-text="Ошибки и предупреждения":::

Для навыка отсутствуют выходные значения. Чтобы определить навык с ошибкой, перейдите на вкладку "Обогащенная структура данных", найдите имя значения и посмотрите на источник его происхождения. При отсутствии значений organizations и locations, данные об организациях и расположениях выводятся из навыка № 1. При открытии вычислителя выражений </> для каждого пути будут, соответственно, отображены выражения указанные в виде "/document/content/organizations" и "/document/content/locations".

:::image type="content" source="media/cognitive-search-debug/expression-eval-missing-value-locations-organizations.png" alt-text="Сущность organizations в вычислителе выражений":::

Выходные данные для этих сущностей пусты, а так быть не должно. Какие входные данные приводят к такому результату?

1. Перейдите на вкладку **Граф навыков** и выберите навык № 1.
1. Перейдите на вкладку **Число выполнений** в области сведений о навыках справа.
1. Откройте вычислитель выражений **</>** для входного значения "text".

   :::image type="content" source="media/cognitive-search-debug/input-skill-missing-value-locations-organizations.png" alt-text="Входные данные для навыка &quot;текст&quot;":::

Отображаемый результат для этих входных данных не похож на текстовое входное значение. Похоже, что это изображение, окруженное новыми строками. Из-за отсутствия текста сущность идентифицировать невозможно. Если посмотреть на иерархию набора навыков, можно заметить, что содержимое сначала обрабатывается навыком № 6 (OCR), а затем передается в навык № 5 (слияние). 

1. Выберите навык № 5 (слияние) на **графе навыков**.
1. Перейдите на вкладку **Число выполнений** в области сведений о навыках справа и откройте вычислитель выражений **</>** для свойства "ВЫХОДНЫЕ ДАННЫЕ" mergedText.

   :::image type="content" source="media/cognitive-search-debug/merge-output-detail-missing-value-locations-organizations.png" alt-text="Выходные данные для навыка слияния":::

Здесь текст связан с изображением. Если взглянуть на выражение "/document/merged_content", можно заметить ошибку в путях "organizations" и "locations" для навыка № 1. Вместо выражения "/document/content" для входных данных "text" следует использовать "/document/merged_content".

1. Скопируйте выражение для выходных данных "mergedText" и закройте окно вычислителя выражений.
1. Выберите навык № 1 на **графе навыков**.
1. Перейдите на вкладку **Параметры навыков** в области сведений о навыках справа.
1. Откройте вычислитель выражений **</>** для входного значения "text".
1. Вставьте новое выражение в поле. Нажмите кнопку **Вычислить**.
1. Должны отобразиться правильные входные данные с добавленным текстом. Чтобы обновить параметры навыков, нажмите кнопку **Применить**.
1. Щелкните **Сохранить** справа. Откроется область сведений о навыках.
1. Щелкните **Выполнить** в меню окна сеанса. Это приведет к другому запуску набора навыков с использованием документа.

После завершения выполнения индексатора ошибки все еще остались. Вернитесь к навыку № 1 и изучите проблему. Входные данные для навыка были исправлены с "content" на "merged_content". Каковы выходные данные для этих сущностей в навыке?

1. Перейдите на вкладку **AI Enrichments** (Обогащение ИИ).
1. Выберите **Граф навыков** и щелкните навык № 1.
1. Перейдите на вкладку **Параметры навыков**, чтобы найти выходные данные.
1. Откройте вычислитель выражений **</>** для сущности "organizations".

   :::image type="content" source="media/cognitive-search-debug/skill-output-detail-missing-value-locations-organizations.png" alt-text="Выходные данные для сущности &quot;organizations&quot;":::

Вычисление результата выражения даст правильный результат. Навык работает, определяя правильное значение для сущности "organizations". Однако сопоставление выходных данных в пути сущности по-прежнему приводит к ошибке. При сравнении пути к выходным данным в навыке с путем к выходным данным в сообщении об ошибке можно увидеть, что навык устанавливает родительские связи с выходными данными (organizations и locations) в узле /document/content. Однако сопоставление выходных полей предполагает, что результаты должны быть связаны родительской связью в узле /document/merged_content. На предыдущем шаге входные данные изменились с "/document/content" на "/document/merged_content". Чтобы обеспечить создание выходных данных с правильным контекстом, необходимо изменить контекст в параметрах навыка.

1. Перейдите на вкладку **AI Enrichments** (Обогащение ИИ).
1. Выберите **Граф навыков** и щелкните навык № 1.
1. Перейдите на вкладку **Параметры навыков**, чтобы найти контекст.
1. Дважды щелкните параметр "context" и измените его на "/document/merged_content".
1. Щелкните **Сохранить** справа. Откроется область сведений о навыках.
1. Щелкните **Выполнить** в меню окна сеанса. Это приведет к другому запуску набора навыков с использованием документа.

   :::image type="content" source="media/cognitive-search-debug/skill-setting-context-correction-missing-value-locations-organizations.png" alt-text="Исправление контекста в параметрах навыка":::

Все ошибки устранены.

## <a name="commit-changes-to-the-skillset"></a>Фиксация изменений в наборе навыков

При запуске сеанса отладки служба "Поиск" создала копию набора навыков. Это сделано для защиты исходного набора навыков в вашей службе поиска. Завершив отладку набора навыков, вы можете зафиксировать исправления (перезаписав исходный набор навыков). 

Кроме того, если вы не готовы зафиксировать изменения, вы можете сохранить сеанс отладки и открыть его позже.

1. Щелкните **Зафиксировать изменения** в главном меню сеансов отладки.
1. Нажмите кнопку **ОК**, чтобы подтвердить обновление набора навыков.
1. Закройте сеанс отладки и перейдите на вкладку **Индексаторы**.
1. Откройте "clinical-trials-idxr".
1. Выберите **Сбросить**.
1. Нажмите кнопку **Запустить**. Нажмите кнопку **ОК** для подтверждения.

После завершения работы индексатора на вкладке **История выполнений** должна появиться зеленая галочка и отобразиться состояние "Успешно" рядом с меткой времени последнего запуска. Убедитесь, что изменения применены, выполнив следующие действия.

1. На странице "Обзор" откройте вкладку **Индексы**.
1. Откройте индекс clinical-trials и во вкладке обозревателя "Поиск" введите строку запроса `$select=metadata_storage_path, organizations, locations&$count=true`, чтобы вернуть поля для определенных документов (определяются уникальным полем `metadata_storage_path`).
1. Нажмите кнопку **Поиск**.

В результатах должно быть указано, что сущности organizations и locations теперь заполнены ожидаемыми значениями.

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы работаете в своей подписке, по окончании проекта рекомендуем решить, нужны ли вам созданные ресурсы. Работающие ресурсы могут означать лишние затраты. Можно удалить отдельные ресурсы или удалить группу ресурсов, что позволит удалить весь набор ресурсов.

Просматривать ресурсы и управлять ими можно на портале с помощью ссылок **Все ресурсы** или **Группы ресурсов** на панели навигации слева.

При работе с бесплатной версией службы помните о том, что вам доступно максимум три индекса, индексатора и источника данных. Вы можете удалить отдельные элементы на портале, чтобы не превысить лимит. 

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве рассмотрены разные аспекты, касающиеся определения набора навыков и его обработки. Чтобы узнать больше о понятиях и рабочих процессах, ознакомьтесь со следующими статьями:

+ [Сопоставление выходных полей набора навыков с полями в индексе поиска](cognitive-search-output-field-mapping.md)

+ [Наборы навыков в Когнитивном поиске Azure](cognitive-search-working-with-skillsets.md)

+ [Настройка кэширования добавочного обогащения](cognitive-search-incremental-indexing-conceptual.md)