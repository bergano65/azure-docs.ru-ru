---
title: Синтаксис выражений OData для предложений фильтрации и упорядочивания в службе "Поиск Azure"
description: Синтаксис OData для выражений фильтрации и упорядочивания для запросов в службе "Поиск Azure".
ms.date: 01/31/2019
services: search
ms.service: search
ms.topic: conceptual
author: Brjohnstmsft
ms.author: brjohnst
ms.manager: cgronlun
translation.priority.mt:
- de-de
- es-es
- fr-fr
- it-it
- ja-jp
- ko-kr
- pt-br
- ru-ru
- zh-cn
- zh-tw
ms.openlocfilehash: f0fd93af7cba3057ad4c2224aa1298a221505645
ms.sourcegitcommit: cf971fe82e9ee70db9209bb196ddf36614d39d10
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2019
ms.locfileid: "58541066"
---
# <a name="odata-expression-syntax-for-filters-and-order-by-clauses-in-azure-search"></a>Синтаксис выражений OData для предложений фильтрации и упорядочивания в службе "Поиск Azure"

Поиск Azure поддерживает подмножество синтаксиса выражений OData для выражений **$filter** и **$orderby**. Выражения для фильтрации вычисляются при синтаксическом анализе запроса. Они ограничивают поиск конкретными полями или добавляют критерии соответствия, используемые во время обработки индекса. Выражения упорядочивания — это шаг постобработки набора результатов. Оба выражения (фильтрации и упорядочивания) включаются в запрос с соблюдением синтаксиса OData, независимого от синтаксиса запроса ([простой](query-simple-syntax.md) или [полный](query-lucene-syntax.md)) в параметре **search**. В этой статье содержатся справочные материалы по выражениям OData, используемым в выражениях фильтрации и сортировки.

## <a name="filter-syntax"></a>Синтаксис выражений фильтрации

Выражение **$filter** можно выполнить изолировано как полностью выраженный запрос или использовать, чтобы уточнить запрос с дополнительными параметрами. В следующих примерах показано несколько ключевых сценариев. В первом примере фильтр является сущностью запроса.


```POST
POST /indexes/hotels/docs/search?api-version=2017-11-11
    {
      "filter": "(baseRate ge 60 and baseRate lt 300) or hotelName eq 'Fancy Stay'"
    }
```

Другим распространенным вариантом использования являются фильтры, комбинированные с аспектами, где фильтр сокращает контактную зону запроса на основе выборки по пользовательскому аспекту:

```POST
POST /indexes/hotels/docs/search?api-version=2017-11-11
    {
      "search": "test",
      "facets": [ "tags", "baseRate,values:80|150|220" ],
      "filter": "rating eq 3 and category eq 'Motel'"
    }
```

### <a name="filter-operators"></a>Операторы фильтрации  

- Логические операторы (AND, OR, NOT).  

- Выражения сравнения (`eq, ne, gt, lt, ge, le`). При сравнении строк учитывается регистр.  

- Константы поддерживаемых типов [модели EDM](https://docs.microsoft.com/dotnet/framework/data/adonet/entity-data-model) (список поддерживаемых типов данных для службы "Поиск Azure" см. в [этой статье](https://docs.microsoft.com/rest/api/searchservice/supported-data-types)). Константы типов коллекций не поддерживаются.  

- Ссылки на имена полей. В выражениях фильтрации могут использоваться только поля `filterable`.  

- `any` без параметров. Этот оператор проверяет, содержит ли поле типа `Collection(Edm.String)` какой-нибудь элемент.  

- `any` и `all` с ограниченной поддержкой лямбда-выражений. 
    
  -   `any/all` поддерживаются для полей типа `Collection(Edm.String)`. 
    
  -   `any` может использоваться только с простыми выражениями равенства или с функцией `search.in`. Простые выражения состоят из сравнения одного поля с литеральным значением, например `Title eq 'Magna Carta'`.
    
  -   `all` может использоваться только с простыми выражениями равенства или с `not search.in`.   

- Геопространственные функции `geo.distance` и `geo.intersects`. Функция `geo.distance` возвращает расстояния в километрах между двумя точками, одна из которых представляет из себя поле, а другая — константу, переданную как часть фильтра. Функция `geo.intersects` возвращает значение true, если заданная точка находится в пределах указанного многоугольника, где точка представляет из себя поле, а многоугольник указывается в качестве константы, переданной как часть фильтра.  

  Многоугольник — это двумерная поверхность, которая хранится в виде последовательности точек, определяющих ограничивающее кольцо (см. пример ниже). Многоугольник должен быть замкнут, то есть первая и конечная точки должны совпадать. [Точки многоугольника должны наноситься в порядке против часовой стрелки](https://docs.microsoft.com/rest/api/searchservice/supported-data-types#Anchor_1).

  `geo.distance` возвращает расстояние в километрах в службе "Поиск Azure". Другие службы, которые поддерживают геопространственные операции OData, обычно возвращают расстояние в метрах.  

  > [!NOTE]  
  >  При использовании функции geo.distance в фильтре необходимо сравнить расстояние, возвращаемое функцией, с константой с помощью операторов `lt`, `le`, `gt` или `ge`. Операторы `eq` и `ne` не предназначены для сравнения расстояний. В следующем примере показано правильное использование функции geo.distance: `$filter=geo.distance(location, geography'POINT(-122.131577 47.678581)') le 5`.  

- Функция `search.in` проверяет, является ли указанное строковое поле равным указанному списку значений. Ее также можно использовать для сравнения одного значения поля коллекции строк с указанным списком значений. При проверке на равенство между полем и каждым значением списка учитывается регистр, так же как и для оператора `eq`. Следовательно, выражение, подобное `search.in(myfield, 'a, b, c')`, эквивалентно выражению `myfield eq 'a' or myfield eq 'b' or myfield eq 'c'`, за исключением того, что функция `search.in` выполняется намного быстрее. 

  Первый параметр функции `search.in` — это ссылка на строковое поле (или переменную диапазона для поля коллекции строк в том случае, если `search.in` используется внутри выражения `any` или `all`). Второй параметр является строкой, содержащей список значений, разделенных пробелами и/или запятыми. Если необходимо использовать другие разделители (например, если эти знаки входят в ваши значения), можно указать необязательный третий параметр для функции `search.in`. 

  Этим параметром является строка, в которой каждый знак или подмножество знаков обрабатывается как разделитель при анализе списка значений во втором параметре.

  > [!NOTE]   
  > В некоторых сценариях требуется сравнение поля с большим количеством константных значений. Например, при реализации фильтрации по ролям безопасности с помощью фильтров может потребоваться сравнение поля идентификатора документа со списком идентификаторов, к которым запрашивающему пользователю предоставлен доступ на чтение. В подобных сценариях мы настоятельно рекомендуем использовать функцию `search.in` вместо более сложного логического сложения выражений равенства. Например, используйте функцию `search.in(Id, '123, 456, ...')` вместо `Id eq 123 or Id eq 456 or ....`. 
  >
  > При использовании `search.in` время отклика будет менее секунды, если второй параметр содержит список из сотен или тысяч значений. Обратите внимание, что нет явного ограничения на количество элементов, которое можно передать в `search.in`, хотя по-прежнему есть ограничение на максимальный размер запроса. Однако задержка растет по мере увеличения количества значений.

- Функция `search.ismatch` вычисляет поисковый запрос как часть выражения фильтрации. Документы, соответствующие поисковому запросу, будут возвращены в результирующем наборе. Доступны следующие перегрузки этой функции:
  - `search.ismatch(search)`
  - `search.ismatch(search, searchFields)`
  - `search.ismatch(search, searchFields, queryType, searchMode)`

  где: 
  
  - `search` — поисковый запрос в любом синтаксисе ([простом](query-simple-syntax.md) или [полном](query-lucene-syntax.md)). 
  - `queryType` — simple или full. По умолчанию: simple. Указывает, какой язык запроса использовался в параметре `search`.
  - `searchFields` — разделенный запятыми список полей для поиска. По умолчанию: все поля в индексе, допускающие возможность поиска.    
  - `searchMode` — "any" или "all". По умолчанию: "any". Указывает, необходимо ли совпадение по всем условиям или по любому из них, чтобы документ был возвращен в числе результатов.

  Все вышеперечисленные параметры эквивалентны соответствующим [параметрам поискового запроса](https://docs.microsoft.com/rest/api/searchservice/search-documents).

- Функция `search.ismatchscoring`, как и функция `search.ismatch`, возвращает значение true, если документ соответствует поисковому запросу, переданному в параметре. Разница между ними заключается в том, что оценка релевантности документов, соответствующих запросу функции `search.ismatchscoring`, будет влиять на общую оценку документа, а в случае функции `search.ismatch` оценка документа не будет изменена. Следующие перегрузки этой функции доступны с параметрами, идентичными параметрам функции `search.ismatch`:
  - `search.ismatchscoring(search)`
  - `search.ismatchscoring(search, searchFields)`
  - `search.ismatchscoring(search, searchFields, queryType, searchMode)`

  Функции `search.ismatch` и `search.ismatchscoring` полностью независимы друг от друга и от остальной части алгебры фильтров. Это означает, что обе функции можно использовать в одном выражении фильтра. 

### <a name="geospatial-queries-and-polygons-spanning-the-180th-meridian"></a>Геопространственные запросы и многоугольники, охватывающие 180-й меридиан  
 Для многих библиотек геопространственных запросов формирование запроса, включающего 180-й меридиан (около линии дат), либо запрещено, либо требует обходного пути, такого как разделение многоугольника на два, по одному на каждую сторону меридиана.  

 В Поиске Azure геопространственные запросы, включающие долготу в 180 градусов, будут работать надлежащим образом, если форма запроса является прямоугольной, а ваши координаты выровнены с макетом сетки по долготе и широте (например, `geo.intersects(location, geography'POLYGON((179 65,179 66,-179 66,-179 65,179 65))'`). В противном случае для непрямоугольных или невыровненных фигур используйте подход с разделенным многоугольником.  

<a name="bkmk_limits"></a>

## <a name="filter-size-limitations"></a>Ограничения на размер выражений фильтрации 

 Существуют ограничения на размер и сложность выражений фильтрации, которые можно отправлять в Поиск Azure. Ограничения ориентировочно основаны на количестве предложений в выражении фильтрации. Хорошее проверенное правило: если у вас есть сотни предложений, вы рискуете превысить лимит. Мы рекомендуем разрабатывать приложение таким образом, чтобы оно не создавало фильтры неограниченного размера.  


## <a name="filter-examples"></a>Примеры выражений фильтрации  

 Найти все гостиницы с базовой меньше 200 долл. США, рейтингом равна или превышает 4:  

```
$filter=baseRate lt 200.0 and rating ge 4
```

 Найти все отели, кроме "Roach Motel" с ремонтом 2010 года и более поздним:  

```
$filter=hotelName ne 'Roach Motel' and lastRenovationDate ge 2010-01-01T00:00:00Z
```

 Найти все гостиницы с базовой меньше, чем 200 долл. США, отремонтированные после 2010 со литерал даты-времени, включающий сведения о часовом поясе стандартное тихоокеанское время:  

```
$filter=baseRate lt 200 and lastRenovationDate ge 2010-01-01T00:00:00-08:00
```

 Найти все отели, в которых есть парковка и запрещено курить:  

```
$filter=parkingIncluded and not smokingAllowed
```

 \- или -  

```
$filter=parkingIncluded eq true and smokingAllowed eq false
```

 Найти все отели класса люкс или отели с рейтингом 5, в которых есть парковка:  

```
$filter=(category eq 'Luxury' or parkingIncluded eq true) and rating eq 5
```

 Найти все отели с тегом "wifi" (будут проверяться все отели, содержащие теги, хранящиеся в поле Collection(EDM.String)):  

```
$filter=tags/any(t: t eq 'wifi')
```

 Найти все отели без тега "motel":  

```
$filter=tags/all(t: t ne 'motel')
```

 Найти все отели, содержащие любые теги:  

```
$filter=tags/any()
```

Найти все гостиницы, у которых нет тегов:  

```
$filter=not tags/any()
```


 Найти все отели в пределах 10 километров от заданного ориентира (где location — это поле типа Edm.GeographyPoint):  

```
$filter=geo.distance(location, geography'POINT(-122.131577 47.678581)') le 10
```

 Найти все отели в заданном окне просмотра, описанном как многоугольник (где location — это поле типа Edm.GeographyPoint): Обратите внимание, что многоугольник замкнут (первая и последняя точки должны совпадать, и [точки должны быть нанесены в порядке против часовой стрелки](https://docs.microsoft.com/rest/api/searchservice/supported-data-types#Anchor_1)).

```
$filter=geo.intersects(location, geography'POLYGON((-122.031577 47.578581, -122.031577 47.678581, -122.131577 47.678581, -122.031577 47.578581))')
```

 Найти все отели, которые либо не имеют значения в поле "description", либо для него явно задано значение null:  

```
$filter=description eq null
```

Найти все отели с именем Roach motel или Budget hotel:  

```
$filter=search.in(name, 'Roach motel,Budget hotel', ',')
```

Найти все отели с именем Roach motel или Budget hotel, имена разделены знаком "|":  

```
$filter=search.in(name, 'Roach motel|Budget hotel', '|')
```

Найти все отели с тегом wifi или pool:  

```
$filter=tags/any(t: search.in(t, 'wifi, pool'))
```

Найти все отели без тегов motel и cabin:  

```
$filter=tags/all(t: not search.in(t, 'motel, cabin'))
```

Найти документы со словом waterfront. Этот запрос фильтрации идентичен [поисковому запросу](https://docs.microsoft.com/rest/api/searchservice/search-documents) с `search=waterfront`:

```
$filter=search.ismatchscoring('waterfront')
```

Найти документы со словом hostel и рейтингом, большим или равным 4, или документы со словом motel и рейтингом 5. Обратите внимание, что этот запрос невозможно составить без функции `search.ismatchscoring`.

```
$filter=search.ismatchscoring('hostel') and rating ge 4 or search.ismatchscoring('motel') and rating eq 5
```

Найти документы без слова luxury.

```
$filter=not search.ismatch('luxury') 
```

Найти документы с фразой "ocean view" или рейтингом 5. Запрос `search.ismatchscoring` будет выполняться только по отношению к полям `hotelName` и `description`.
Обратите внимание, документы, которые соответствуют только второму предложению логического сложения, также будут возвращены — отели с рейтингом 5. В целях ясности документы, которые не соответствуют ни одному элементу выражения, будут возвращены с нулевой оценкой.

```
$filter=search.ismatchscoring('"ocean view"', 'description,hotelName') or rating eq 5
```

Найти документы, в которых термины hotel и airport находятся в пределах 5 слов друг от друга в описании отеля и в которых курение запрещено. В этом запросе используется [полный язык запросов Lucene](query-lucene-syntax.md).

```
$filter=search.ismatch('"hotel airport"~5', 'description', 'full', 'any') and not smokingAllowed 
```

## <a name="order-by-syntax"></a>Синтаксис предложения упорядочивания

Параметр **$orderby** принимает разделенный запятыми список выражений (до 32) формата `sort-criteria [asc|desc]`. Критерием сортировки может быть либо имя поля `sortable`, либо вызов функции `geo.distance` или `search.score`. Для указания порядка сортировки можно использовать `asc` или `desc`. По умолчанию значения сортируются по возрастанию.

Если несколько документов имеют одинаковые критерии сортировки и функция `search.score` не используется (например, если вы сортируете по числовому полю `rating` и все три документа имеют оценку 4), результаты будут отсортированы по оценке документов в убывающем порядке. Если оценки документов одинаковы (например, если в запросе не указан полнотекстовый поиск), относительный порядок связанных документов не определен.
 
Вы можете определить несколько условий сортировки. Порядок выражений определяет окончательный порядок сортировки. Например, для сортировки по убыванию оценки, а затем по значению рейтинга синтаксис будет таким: `$orderby=search.score() desc,rating desc`.

Синтаксис для `geo.distance` в **$orderby** такой же, как и в **$filter**. При использовании функции `geo.distance` в **$orderby** поле, к которому она применяется, должно быть сортируемым (`sortable`) и иметь тип `Edm.GeographyPoint`.  

Синтаксис для `search.score` в **$orderby** — `search.score()`. Функция `search.score` не принимает параметров.  
 

## <a name="order-by-examples"></a>Примеры выражений упорядочивания

Сортировать отели по возрастанию базового тарифа:

```
$orderby=baseRate asc
```

Сортировать отели по убыванию рейтинга, а затем по возрастанию базового тарифа (помните, что по умолчанию сортировка происходит по возрастанию):

```
$orderby=rating desc,baseRate
```

Сортировать отели по убыванию рейтинга, а затем по возрастанию расстояния от заданных координат:

```
$orderby=rating desc,geo.distance(location, geography'POINT(-122.131577 47.678581)') asc
```

Сортировать отели в порядке убывания результатов функции search.score и рейтингу, а затем в порядке возрастания расстояния от заданных координат так, чтобы между двумя отелями с одинаковым рейтингом сначала отображался ближайший:

```
$orderby=search.score() desc,rating desc,geo.distance(location, geography'POINT(-122.131577 47.678581)') asc
```
<a name="bkmk_unsupported"></a>

## <a name="unsupported-odata-syntax"></a>Неподдерживаемый синтаксис OData

-   Арифметические выражения  

-   Функции (за исключением геопространственных функций расстояния и объединения по пересечению).  

-   `any/all` с произвольными лямбда-выражениями.  

## <a name="see-also"></a>См. также  

+ [Фасетная навигация в службе поиска Azure](search-faceted-navigation.md) 
+ [Фильтры в службе "Поиск Azure"](search-filters.md) 
+ [Search Documents (Azure Search Service REST API)](https://docs.microsoft.com/rest/api/searchservice/Search-Documents) (Поиск по документам (REST API службы "Поиск Azure")) 
+ [Синтаксис запросов Lucene](query-lucene-syntax.md)
+ [Простой синтаксис запросов в службе "Поиск Azure"](query-simple-syntax.md)   
