---
title: Настройка кэша и добавочного обогащения (Предварительная версия)
titleSuffix: Azure Cognitive Search
description: Включите кэширование и сохраните состояние расширенного содержимого для управляемой обработки в наборе автонавыков. Эта функция сейчас доступна в виде общедоступной предварительной версии.
author: vkurpad
manager: eladz
ms.author: vikurpad
ms.service: cognitive-search
ms.devlang: rest-api
ms.topic: conceptual
ms.date: 01/06/2020
ms.openlocfilehash: a1b317b651b0e17c07eb17dbdb8a7c6657d39564
ms.sourcegitcommit: bdd5c76457b0f0504f4f679a316b959dcfabf1ef
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/22/2020
ms.locfileid: "90971608"
---
# <a name="how-to-configure-caching-for-incremental-enrichment-in-azure-cognitive-search"></a>Настройка кэширования для добавочного дополнения в Azure Когнитивный поиск

> [!IMPORTANT] 
> Добавочное углубление в настоящее время находится в общедоступной предварительной версии. Эта предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для использования рабочей среде. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/). 
> Эта функция доступна в [предварительных версиях REST API](search-api-preview.md) . В настоящее время отсутствует поддержка портала или пакета SDK для .NET.

В этой статье показано, как добавить кэширование в конвейер обогащения, чтобы можно было постепенно изменять шаги без необходимости перестроения каждый раз. По умолчанию набор умений не имеет состояния, а изменение любой части его композиции требует полного повторного запуска индексатора. С помощью добавочного уточнения индексатор может определить, какие части дерева документов необходимо обновить на основе изменений, обнаруженных в определениях набора навыков или индексатора. Существующие обработанные выходные данные сохраняются и повторно используются везде, где это возможно. 

Кэшированное содержимое помещается в хранилище Azure с помощью предоставленных сведений об учетной записи. Контейнер с именем `ms-az-search-indexercache-<alpha-numerc-string>` создается при запуске индексатора. Он должен рассматриваться как внутренний компонент, управляемый службой поиска, и не должен изменяться.

Если вы не знакомы с настройкой индексаторов, начните с [обзора индексатора](search-indexer-overview.md) , а затем перейдите к [навыков](cognitive-search-working-with-skillsets.md) , чтобы узнать о конвейерах обогащения. Дополнительные сведения о ключевых понятиях см. в разделе [добавочное углубление](cognitive-search-incremental-indexing-conceptual.md).

## <a name="enable-caching-on-an-existing-indexer"></a>Включение кэширования для существующего индексатора

Если у вас уже есть индексатор, имеющий набор навыков, выполните действия, описанные в этом разделе, чтобы добавить кэширование. В качестве однократной операции для вступления в силу добавочной обработки потребуется сбросить и повторно запустить индексатор полностью.

> [!TIP]
> В качестве эксперимента вы можете воспользоваться кратким руководством по этому [порталу](cognitive-search-quickstart-blob.md) , чтобы создать необходимые объекты, а затем использовать POST или портал для внесения обновлений. Вам может потребоваться подключить ресурс Cognitive Services для оплаты. При многократном выполнении индексатора будет исчерпано свободное ежедневное выделение, прежде чем вы сможете выполнить все действия.

### <a name="step-1-get-the-indexer-definition"></a>Шаг 1. Получение определения индексатора

Начните с допустимого существующего индексатора, который содержит следующие компоненты: источник данных, набор умений, индекс. Ваш индексатор должен быть готов к запуску. 

С помощью клиента API создайте [запрос индексатора Get](/rest/api/searchservice/get-indexer) , чтобы получить текущую конфигурацию индексатора. При использовании предварительной версии API для получения индексатора в `cache` определениях добавляется свойство со значением NULL.

```http
GET https://[YOUR-SEARCH-SERVICE].search.windows.net/indexers/[YOUR-INDEXER-NAME]?api-version=2020-06-30-Preview
Content-Type: application/json
api-key: [YOUR-ADMIN-KEY]
```

Скопируйте определение индексатора из ответа.

### <a name="step-2-modify-the-cache-property-in-the-indexer-definition"></a>Шаг 2. изменение свойства Cache в определении индексатора

По умолчанию `cache` свойство имеет значение null. Используйте клиент API для настройки конфигурации кэша (портал не поддерживает это обновление партикулате). 

Измените объект кэша, включив в него следующие обязательные и необязательные свойства: 

+ Параметр `storageConnectionString` является обязательным и его необходимо задать в строке подключения к службе хранилища Azure. 
+ `enableReprocessing`Логическое свойство является необязательным ( `true` по умолчанию) и указывает на то, что добавочное углубление включено. При необходимости можно задать для этого параметра значение, `false` чтобы приостановить добавочную обработку, в то время как другие ресурсоемкие операции, такие как индексирование новых документов, выполняются, а затем переворачивают их обратно `true` .

```json
{
    "name": "<YOUR-INDEXER-NAME>",
    "targetIndexName": "<YOUR-INDEX-NAME>",
    "dataSourceName": "<YOUR-DATASOURCE-NAME>",
    "skillsetName": "<YOUR-SKILLSET-NAME>",
    "cache" : {
        "storageConnectionString" : "<YOUR-STORAGE-ACCOUNT-CONNECTION-STRING>",
        "enableReprocessing": true
    },
    "fieldMappings" : [],
    "outputFieldMappings": [],
    "parameters": []
}
```

### <a name="step-3-reset-the-indexer"></a>Шаг 3. Сброс индексатора

Сброс индексатора требуется при настройке добавочного уточнения для существующих индексаторов, чтобы гарантировать, что все документы находятся в стабильном состоянии. Для этой задачи можно использовать портал или клиент API и функцию [сброса индексатора REST API](/rest/api/searchservice/reset-indexer) .

```http
POST https://[YOUR-SEARCH-SERVICE].search.windows.net/indexers/[YOUR-INDEXER-NAME]/reset?api-version=2020-06-30-Preview
Content-Type: application/json
api-key: [YOUR-ADMIN-KEY]
```

### <a name="step-4-save-the-updated-definition"></a>Шаг 4. Сохранение обновленного определения

[Обновление индексатора](/rest/api/searchservice/preview-api/update-indexer) с помощью запроса на размещение. тело запроса должно содержать обновленное определение индексатора со свойством Cache. Если вы получаете 400, проверьте определение индексатора, чтобы убедиться, что выполнены все требования (источник данных, навык, индекс).

```http
PUT https://[YOUR-SEARCH-SERVICE].search.windows.net/indexers/[YOUR-INDEXER-NAME]?api-version=2020-06-30-Preview
Content-Type: application/json
api-key: [YOUR-ADMIN-KEY]
{
    "name" : "<YOUR-INDEXER-NAME>",
    ...
    "cache": {
        "storageConnectionString": "<YOUR-STORAGE-ACCOUNT-CONNECTION-STRING>",
        "enableReprocessing": true
    }
}
```

Если теперь вы выдаете другой запрос GET для индексатора, ответ службы будет включать `ID` свойство в объект Cache. К имени контейнера, содержащего все кэшированные результаты и промежуточное состояние каждого документа, обрабатываемого этим индексатором, добавляется буквенно-цифровая строка. Идентификатор будет использоваться для уникального имени кэша в хранилище BLOB-объектов.

```http
    "cache": {
        "ID": "<ALPHA-NUMERIC STRING>",
        "enableReprocessing": true,
        "storageConnectionString": "DefaultEndpointsProtocol=https;AccountName=<YOUR-STORAGE-ACCOUNT>;AccountKey=<YOUR-STORAGE-KEY>;EndpointSuffix=core.windows.net"
    }
```

### <a name="step-5-run-the-indexer"></a>Шаг 5. Запуск индексатора

Для запуска индексатора можно использовать портал или API. На портале в списке индексаторы выберите индексатор и нажмите кнопку **выполнить**. Одним из преимуществ использования портала является возможность наблюдения за состоянием индексатора, заметка длительности задания и количества обрабатываемых документов. Страницы портала обновляются каждые несколько минут.

Кроме того, для [запуска индексатора](/rest/api/searchservice/run-indexer)можно использовать команду "оставшаяся".

```http
POST https://[YOUR-SEARCH-SERVICE].search.windows.net/indexers/[YOUR-INDEXER-NAME]/run?api-version=2020-06-30-Preview
Content-Type: application/json
api-key: [YOUR-ADMIN-KEY]
```

После выполнения индексатора можно найти кэш в хранилище BLOB-объектов Azure. Имя контейнера имеет следующий формат: `ms-az-search-indexercache-<YOUR-CACHE-ID>`

> [!NOTE]
> Сброс и повторный запуск индексатора приводят к полному перестроению, чтобы содержимое можно было кэшировать. Все неудачные обогащения будут перезапущены во всех документах.
>

### <a name="step-6-modify-a-skillset-and-confirm-incremental-enrichment"></a>Шаг 6. изменение набора навыков и подтверждение добавочного обогащения

Для изменения набора навыков можно использовать портал или API. Например, при использовании перевода текста достаточно простого встроенного изменения с `en` на `es` или другого языка для проверки концепции добавочного углубления.

Снова запустите индексатор. Обновляются только части обогащенного дерева документов. Если вы использовали быстрый запуск на [портале](cognitive-search-quickstart-blob.md) в качестве эксперимента, изменив уровень навыка перевода текста на "ES", вы заметите, что вместо первоначального 14 документов обновляется только 8. Файлы изображений, не затронутые процессом перевода, повторно используются из кэша.

## <a name="enable-caching-on-new-indexers"></a>Включить кэширование для новых индексаторов

Чтобы настроить добавочное углубление для нового индексатора, достаточно включить `cache` свойство в полезные данные определения индексатора при вызове [CREATE индексатора (2020-06-30-Preview)](/rest/api/searchservice/preview-api/create-indexer). 


```json
{
    "name": "<YOUR-INDEXER-NAME>",
    "targetIndexName": "<YOUR-INDEX-NAME>",
    "dataSourceName": "<YOUR-DATASOURCE-NAME>",
    "skillsetName": "<YOUR-SKILLSET-NAME>",
    "cache" : {
        "storageConnectionString" : "<YOUR-STORAGE-ACCOUNT-CONNECTION-STRING>",
        "enableReprocessing": true
    },
    "fieldMappings" : [],
    "outputFieldMappings": [],
    "parameters": []
    }
}
```

## <a name="checking-for-cached-output"></a>Проверка кэшированных выходных данных

Кэш создается, используется и управляется индексатором, и его содержимое не представлено в формате, читаемом человеком. Лучший способ определить, используется ли кэш, — это запустить индексатор и сравнить метрики «до» и «после» для времени выполнения и количества документов. 

Например, предположим, что набор навыков начинается с анализа изображений и оптического распознавания символов (OCR) отсканированных документов, за которым следует нисходящий анализ полученного текста. При изменении навыка подчиненного текста индексатор может извлечь все ранее обработанные изображения и содержимое OCR из кэша, обновить и обработать только те изменения, которые относятся к тексту, указанным в результате изменений. Вы можете увидеть меньше документов в количестве документов (например, 8/8, а не 14/14 в исходном исполнении), сократить время выполнения и снизить расходы на счет.

## <a name="working-with-the-cache"></a>Работа с кэшем

Когда кэш будет работать, индексаторы проверяют кэш всякий раз, когда вызывается [индексатор запуска](/rest/api/searchservice/run-indexer) , чтобы увидеть, какие части существующих выходных данных можно использовать. 

В следующей таблице перечислены различные интерфейсы API, связанные с кэшем.

| API           | Влияние кэша     |
|---------------|------------------|
| [Создание индексатора (2020-06-30-Preview)](/rest/api/searchservice/preview-api/create-indexer) | Создает и запускает индексатор при первом использовании, включая создание кэша, если определение индексатора указывает его. |
| [Запуск индексатора](/rest/api/searchservice/run-indexer) | Выполняет конвейер обогащения по запросу. Этот API считывает из кэша, если он существует, или создает кэш, если вы добавили кэширование в обновленное определение индексатора. При запуске индексатора, для которого включено кэширование, индексатор пропускает шаги, если можно использовать кэшированные выходные данные. Вы можете использовать общедоступный или предварительный просмотр версии API этого API.|
| [Сброс индексатора](/rest/api/searchservice/reset-indexer)| Очищает индексатор всех данных добавочного индексирования. Следующий запуск индексатора (по требованию или по расписанию) полностью переобрабатывается с нуля, включая повторное выполнение всех навыков и перестроение кэша. Он функционально эквивалентен удалению индексатора и его повторному созданию. Вы можете использовать общедоступный или предварительный просмотр версии API этого API.|
| [Сброс навыков](/rest/api/searchservice/preview-api/reset-skills) | Указывает, какие навыки должны повторно выполняться при следующем выполнении индексатора, даже если вы не изменили свои навыки. Кэш соответствующим образом обновляется. Выходные данные, такие как хранилище знаний или индекс поиска, обновляются с помощью повторно используемых данных из кэша и нового содержимого в соответствии с обновленным навыком. |

Дополнительные сведения об управлении тем, что происходит с кэшем, см. в разделе [Управление кэшем](cognitive-search-incremental-indexing-conceptual.md#cache-management).

## <a name="next-steps"></a>Дальнейшие действия

Добавочное углубление применяется к индексаторам, содержащим навыков. В качестве следующего шага посетите документацию по набору навыков, чтобы понять концепцию и композицию. 

Кроме того, после включения кэша необходимо узнать о параметрах и API-интерфейсах, которые делятся на кэширование, в том числе о переопределении или принудительном использовании определенных поведений. Дополнительные сведения см. по следующим ссылкам.

+ [Концепции и композиция набора навыков](cognitive-search-working-with-skillsets.md)
+ [Создание набора навыков](cognitive-search-defining-skillset.md)
+ [Общие сведения о добавочном обогащении и кэшировании](cognitive-search-incremental-indexing-conceptual.md)