---
title: Фильтры аспектов для навигации по поиску в приложениях
titleSuffix: Azure Cognitive Search
description: Критерии фильтрации по идентификатору безопасности пользователя, географическому расположению или числовым значениям для сокращения результатов поиска по запросам в Когнитивный поиск Azure, размещенной облачной службе поиска на Microsoft Azure.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 10/05/2020
ms.custom: devx-track-csharp
ms.openlocfilehash: 9360fc000e01e1c52561cbaa3e2f2968e67e2fa2
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91740876"
---
# <a name="how-to-build-a-facet-filter-in-azure-cognitive-search"></a>Как создать фильтр аспекта в Azure Когнитивный поиск 

Многонаправленная Навигация используется для автоматической фильтрации результатов запроса в приложении поиска, где приложение предлагает элементы управления пользовательского интерфейса для поиска групп документов (например, категорий или торговых марок), а Azure Когнитивный поиск предоставляет структуру данных для обратной работы. В этой статье кратко рассматриваются основные шаги для создания структуры фасетной навигации с возможностями поиска, которые вы хотите предоставить. 

> [!div class="checklist"]
> * Выбор полей для фильтрации и фасетизации
> * Указание атрибутов поля
> * Построение индекса и загрузка данных
> * Добавление фильтров аспектов в запрос
> * Обработка результатов

Аспекты являются динамическими и возвращаются в запросе. В ответах поиска приводятся фасетные категории, используемые для навигации по результатам. Если вы не знакомы с аспектами, ниже приведен пример структуры фасетной навигации.

:::image type="complex" source="media/search-filters-facets/facet-nav.png" alt-text="отфильтрованные результаты поиска&quot;:::
&quot;Изображение, показывающее диалоговое окно поиска с отфильтрованными результатами поиска, сгруппированными по бизнес-наименованиям. Стрелка указывает, что результаты представляют собой аспекты, отображаемые в структуре навигации аспекта " :::image-end:::

Хотите подробнее узнать о фасетной навигации? См. статью [как реализовать аспектную навигацию в Azure когнитивный Поиск](search-faceted-navigation.md).

## <a name="choose-fields"></a>Выбор полей

Аспекты могут быть вычислены для отдельных полей значений, а также для коллекций. Поля, которые лучше всего работают в аспектной навигации, имеют низкую кратность: небольшое количество уникальных значений, повторяемых в документах в совокупности поиска (например, список цветов, стран или регионов или названий торговых марок). 

При создании индекса аспекты включаются в зависимости от каждого поля, присвоив `facetable` атрибуту значение `true` . Как правило, атрибут должен быть задан `filterable` `true` для таких полей, чтобы приложение поиска может фильтровать по этим полям на основе аспектов, выбранных конечным пользователем. 

При создании индекса с помощью REST API любой [тип поля](/rest/api/searchservice/supported-data-types) , который может быть использован в аспектной навигации, помечается как по `facetable` умолчанию:

+ `Edm.String`
+ `Edm.DateTimeOffset`
+ `Edm.Boolean`
+ Числовые типы полей: `Edm.Int32` , `Edm.Int64` , `Edm.Double`
+ Коллекции приведенных выше типов (например, `Collection(Edm.String)` или `Collection(Edm.Double)` )

`Edm.GeographyPoint` `Collection(Edm.GeographyPoint)` В аспектной навигации нельзя использовать поля или. Аспекты лучше подходят для полей с низкой кратностью. Из-за разрешения географических координат редко бывает, что все два набора координат будут равны в данном наборе данных. Таким образом аспекты не поддерживаются для географических координат. Вам понадобится поле города или региона для поиска по местоположению с использованием фасетизации.

## <a name="set-attributes"></a>Определение атрибутов

Атрибуты индекса, которые управляют использованием поля, добавляются к отдельным определениям полей в индексе. В следующем примере поля с малой кратностью, полезные для аспектов, состоят из следующих элементов: `category` (Гостиницы, Motel, общежития), `tags` и `rating` . `filterable` `facetable` Для наглядности эти поля имеют явно заданные атрибуты и в следующем примере. 

> [!Tip]
> Для оптимизации производительности и хранения отключите фасетизацию для полей, которые никогда не должны использоваться в качестве аспектов. В частности, строковые поля для уникальных значений, например идентификатор или название продукта, должны быть установлены в значение, `"facetable": false` чтобы предотвратить их случайное (и неэффективное) использование в аспектной навигации.


```json
{
  "name": "hotels",  
  "fields": [
    { "name": "hotelId", "type": "Edm.String", "key": true, "searchable": false, "sortable": false, "facetable": false },
    { "name": "baseRate", "type": "Edm.Double" },
    { "name": "description", "type": "Edm.String", "filterable": false, "sortable": false, "facetable": false },
    { "name": "description_fr", "type": "Edm.String", "filterable": false, "sortable": false, "facetable": false, "analyzer": "fr.lucene" },
    { "name": "hotelName", "type": "Edm.String", "facetable": false },
    { "name": "category", "type": "Edm.String", "filterable": true, "facetable": true },
    { "name": "tags", "type": "Collection(Edm.String)", "filterable": true, "facetable": true },
    { "name": "parkingIncluded", "type": "Edm.Boolean",  "filterable": true, "facetable": true, "sortable": false },
    { "name": "smokingAllowed", "type": "Edm.Boolean", "filterable": true, "facetable": true, "sortable": false },
    { "name": "lastRenovationDate", "type": "Edm.DateTimeOffset" },
    { "name": "rating", "type": "Edm.Int32", "filterable": true, "facetable": true },
    { "name": "location", "type": "Edm.GeographyPoint" }
  ]
}
```

> [!Note]
> Это определение индекса копируется из [создания индекса когнитивный Поиск Azure с помощью REST API](./search-get-started-powershell.md). Оно идентично, за исключением поверхностных различий в определениях полей. `filterable`Атрибуты и `facetable` явно добавляются в `category` поля, `tags` , `parkingIncluded` , `smokingAllowed` и `rating` . На практике `filterable` и будут `facetable` включены по умолчанию для этих полей при использовании REST API. При использовании пакета SDK для .NET эти атрибуты должны быть включены явным образом.

## <a name="build-and-load-an-index"></a>Построение и загрузка индекса

Промежуточным (и, возможно, очевидным) шагом является [сборка и заполнение индекса](./search-get-started-dotnet.md#1---create-an-index) перед формулировкой запроса. Здесь мы упомянем этот шаг для полноты картины. Один из способов определить доступность индекса — это проверить список индексов на [портале](https://portal.azure.com).

## <a name="add-facet-filters-to-a-query"></a>Добавление фильтров аспектов в запрос

В коде приложения создайте запрос, который определяет все части допустимого запроса, включая выражения поиска, фасеты, фильтры, профили оценки — все, что используется для формулировки запроса. В следующем примере создается запрос, применяемый для фасетной навигации с использованием фасетов размещения, рейтинга и других удобств.

```csharp
var sp = new SearchParameters()
{
    ...
    // Add facets
    Facets = new[] { "category", "rating", "parkingIncluded", "smokingAllowed" }.ToList()
};
```

### <a name="return-filtered-results-on-click-events"></a>Возврат отфильтрованных результатов при событии щелчка

Когда пользователь щелкает значение аспекта, обработчик события щелчка должен использовать критерий фильтра, чтобы реализовать намерение пользователя. `category`При выборе аспекта Категория "Motel" реализуется с помощью `$filter` выражения, которое выбирает размещений этого типа. Когда пользователь щелкает "Motel", указывая, что должен отображаться только мотелей, следующий запрос, отправляемый приложением, включает в себя `$filter=category eq 'motel'` .

Следующий фрагмент кода добавляет категорию в фильтр, если пользователь выбирает значение из фасета категории.

```csharp
if (!String.IsNullOrEmpty(categoryFacet))
    filter = $"category eq '{categoryFacet}'";
```

Если пользователь щелкает значение аспекта для поля коллекции `tags` , например, значение "пул", приложение должно использовать следующий синтаксис фильтра: `$filter=tags/any(t: t eq 'pool')`

## <a name="tips-and-workarounds"></a>Советы и обходные решения

### <a name="initialize-a-page-with-facets-in-place"></a>Инициализация страницы с помощью фасетов

Если требуется инициализировать страницу с помощью фасетов, вы можете отправить запрос как часть инициализации страницы, чтобы заполнить страницу исходной структурой фасета.

### <a name="preserve-a-facet-navigation-structure-asynchronously-of-filtered-results"></a>Асинхронное сохранение структуры фасетной навигации отфильтрованных результатов

Одной из проблем с навигацией по аспектам в Azure Когнитивный поиск является то, что аспекты существуют только для текущих результатов. На практике обычно сохраняется статический набор фасетов, чтобы пользователь мог перемещаться в обратном направлении, проходя по поисковому содержимому для поиска альтернативных путей. 

Хотя это распространенный вариант использования, структура фасетной навигации в настоящее время не предоставляет этого изначально. Разработчики, которым требуются статические аспекты, обычно обходят ограничение, выполняя два отфильтрованных запроса: один в пределах результатов, а другой для создания статического списка аспектов для навигации.

## <a name="see-also"></a>См. также

+ [Фильтры в Когнитивный поиск Azure](search-filters.md)
+ [Create Index (Azure Search Service REST API)](/rest/api/searchservice/create-index) (Создание индексов (REST API службы "Поиск Azure")).
+ [Поиск документов REST API](/rest/api/searchservice/search-documents)