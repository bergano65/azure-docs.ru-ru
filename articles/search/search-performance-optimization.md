---
title: Масштабирование для производительности
titleSuffix: Azure Cognitive Search
description: Узнайте о методах и рекомендациях по настройке производительности Azure Когнитивный поиск и настройке оптимального масштаба.
manager: nitinme
author: LiamCavanagh
ms.author: liamca
ms.devlang: rest-api
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 02/14/2020
ms.openlocfilehash: 5fd949466978714fe1dc0c4ccc67a3cb8f993314
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "88934962"
---
# <a name="scale-for-performance-on-azure-cognitive-search"></a>Масштабирование для производительности Когнитивный поиск Azure

В этой статье описываются рекомендации по расширенным сценариям с помощью сложных требований к масштабируемости и доступности.

## <a name="start-with-baseline-numbers"></a>Начать с базовых номеров

Прежде чем выполнять больше усилий по развертыванию, убедитесь, что вы знаете, как выглядит Обычная нагрузка запроса. Приведенные ниже рекомендации могут помочь при получении номеров базовых запросов.

1. Выберите целевую задержку (или максимальное количество времени), которая типична для выполнения запроса на поиск.

1. Создайте и протестируйте реальную рабочую нагрузку в службе поиска с реалистичным набором данных для измерения этих ставок задержки.

1. Начните с небольшого количества запросов в секунду (QPS), а затем постепенно увеличивайте число, выполняемое в тесте, пока задержка запроса не станет ниже предопределенного целевого объекта. Это важный тест производительности, который поможет спланировать масштабирование приложения по мере того, как оно будет охватывать все больше пользователей.

1. По возможности повторно используйте подключения HTTP. При использовании пакета SDK Azure Когнитивный поиск .NET это означает, что следует повторно использовать экземпляр или экземпляр [SearchIndexClient](/dotnet/api/microsoft.azure.search.searchindexclient) , а если используется REST API, следует повторно использовать один HttpClient.

1. Изменяйте вещество запросов запросов, чтобы поиск произносится по разным частям индекса. Вариант важен, поскольку если вы постоянно выполняете те же поисковые запросы, кэширование данных начнет повысить производительность, чем может быть более разнородным набором запросов.

1. Изменяйте структуру запросов запросов, чтобы получать различные типы запросов. Не все поисковые запросы выполняются на одном уровне. Например, Поиск документа или предложение поиска обычно выполняется быстрее, чем запрос с большим количеством аспектов и фильтров. Тестовая композиция должна включать различные запросы в примерно те же соотношения, что и в рабочей среде.  

При создании этих тестовых рабочих нагрузок необходимо помнить о некоторых характеристиках Когнитивный поиск Azure:

+ Вы можете перегрузить службу, помещая слишком много поисковых запросов за один раз. В этом случае вы увидите коды ответов HTTP 503. Чтобы избежать 503 во время тестирования, начните с различных диапазонов запросов поиска, чтобы увидеть разницу в скорости задержки по мере добавления дополнительных запросов поиска.

+ Azure Когнитивный поиск не выполняет задачи индексирования в фоновом режиме. Если служба обрабатывает рабочие нагрузки запросов и индексирования параллельно, примите это во внимание, поставляя задания индексирования в тесты запросов, или изучите варианты выполнения заданий индексации в часы пиковой нагрузки.

> [!Tip]
> Вы можете имитировать реалистичную загрузку запросов с помощью средств нагрузочного тестирования. Попробуйте выполнить [нагрузочное тестирование с помощью Azure DevOps](/azure/devops/test/load-test/get-started-simple-cloud-load-test?view=azure-devops) или воспользуйтесь одним из этих [вариантов](/azure/devops/test/load-test/overview?view=azure-devops#alternatives).

## <a name="scale-for-high-query-volume"></a>Масштабирование для большого объема запросов

Служба перегружена, когда запросы занимают слишком много времени или когда служба начинает удалять запросы. В этом случае можно решить проблему одним из двух способов:

+ **Добавление реплик**  

  Каждая реплика является копией данных, что позволяет службе загружать запросы на распределение по нескольким копиям.  Все балансировка нагрузки и репликация данных управляются с помощью Azure Когнитивный поиск и вы можете изменить количество реплик, выделенных для службы в любое время. Можно выделить до 12 реплик для службы поиска уровня "Стандартный" и до 3 реплик для службы поиска уровня "Базовый". Реплики можно изменить на [портале Azure](search-create-service-portal.md) или в [PowerShell](search-manage-powershell.md).

+ **Создание новой службы на более высоком уровне**  

  Когнитивный поиск Azure поставляется на [нескольких](https://azure.microsoft.com/pricing/details/search/) уровнях, и каждая из них обеспечивает различные уровни производительности. В некоторых случаях может быть настолько много запросов, что уровень, на котором вы используете, не может обеспечить достаточный объем, даже если реплики израсходован. В этом случае рассмотрите возможность перехода на более высокий уровень, такой как стандартный уровень S3, предназначенный для сценариев с большим количеством документов и чрезвычайно высокой рабочей нагрузкой запросов.

## <a name="scale-for-slow-individual-queries"></a>Масштабирование для отдельных запросов

Другая причина для высокой скорости задержки — выполнение одного запроса занимает слишком много времени. В этом случае добавление реплик не поможет. Ниже приведены два возможных параметра, которые могут оказаться полезными.

+ **Увеличение секций**

  Секция разделяет данные между дополнительными вычислительными ресурсами. Две секции разбивают данные на половину, третья секция разделяет их на третьи и т. д. Один из положительных побочных эффектов заключается в том, что медленные запросы иногда выполняются быстрее из-за параллельных вычислений. Мы отметили параллелизм по запросам с низким уровнем избирательности, например запросам, которые соответствуют многим документам, или аспектам, предоставляющим подсчеты в большом количестве документов. Поскольку значительные вычисления необходимы для оценки релевантности документов или для подсчета количества документов, добавление дополнительных секций позволяет ускорить выполнение запросов.  
   
  В стандартной службе поиска может быть не более 12 секций и 1 Секция в основной службе поиска. Секции можно изменить на [портале Azure](search-create-service-portal.md) или в [PowerShell](search-manage-powershell.md).

+ **Ограничить большие поля кратности**

  Большое поле кратности состоит из поля с аспектом или фильтруемым полем, которое имеет значительное количество уникальных значений, и в результате потребляет значительные ресурсы при вычислении результатов. Например, задание идентификатора продукта или поля описания в качестве аспекта или фильтрации будет считаться большим количеством элементов, так как большинство значений из документа в документ являются уникальными. По возможности ограничивайте число полей с высокой кратностью.

+ **Повышение уровня поиска**  

  Переход на более высокий уровень Когнитивный поиск Azure может быть другим способом повышения производительности медленных запросов. Каждый более высокий уровень обеспечивает более быстрые процессоры и больше памяти, что оказывает положительное воздействие на производительность запросов.

## <a name="scale-for-availability"></a>Масштабирование для доступности

Реплики не только снижают задержку запросов, но и могут обеспечить высокий уровень доступности. При использовании одной реплики следует ожидать периодических простоев из-за перезагрузки сервера после обновления программного обеспечения или других операций технического обслуживания. Поэтому важно определить, требуется ли приложению высокий уровень доступности операций поиска (запросов) и записи (событий индексирования). Azure Когнитивный поиск предлагает варианты соглашения об уровне обслуживания для всех платных предложений поиска со следующими атрибутами:

+ Две реплики для обеспечения высокой доступности рабочих нагрузок для чтения (запросов).

+ Три или более реплики для обеспечения высокой доступности рабочих нагрузок чтения и записи (запросы и индексирование)

Дополнительные сведения см. в [Соглашение об уровне обслуживания когнитивный Поиск Azure](https://azure.microsoft.com/support/legal/sla/search/v1_0/).

Так как реплики являются копиями данных, наличие нескольких реплик позволяет Когнитивный поиск Azure выполнять перезагрузку и обслуживание машин в одной реплике, в то время как выполнение запроса продолжится на других репликах. И наоборот, если вы принимаете реплики, вы получаете снижение производительности запросов, предполагая, что эти реплики были недостаточно загружены.

## <a name="scale-for-geo-distributed-workloads-and-geo-redundancy"></a>Масштабирование для геораспределенных рабочих нагрузок и геоизбыточности

Для геораспределенных рабочих нагрузок пользователи, расположенные далеко от центра обработки данных, будут иметь более высокую частоту задержки. Одним из способов устранения этой проблемы является предоставление нескольких служб поиска в регионах с более близкой стороной к этим пользователям.

Azure Когнитивный поиск в настоящее время не предоставляет автоматизированный способ георепликации индексов Azure Когнитивный поиск в регионах, но существуют некоторые методы, которые могут упростить процесс реализации этого процесса и управления им. Они описаны в нескольких следующих разделах.

Целью геораспределенного набора служб поиска является наличие двух или более индексов, доступных в двух или более регионах, где пользователь направляется в службу Когнитивный поиск Azure, которая обеспечивает наименьшую задержку, как показано в этом примере:

   ![Перекрестные запросы к службам по региону][1]

### <a name="keep-data-synchronized-across-multiple-services"></a>Синхронизация данных в нескольких службах

Существует два варианта поддержания синхронизации распределенных служб поиска, которые состоят из использования [индексатора когнитивный Поиск Azure](search-indexer-overview.md) или API push-уведомлений (также называемого [Когнитивный поиском Azure REST API](/rest/api/searchservice/)).  

### <a name="use-indexers-for-updating-content-on-multiple-services"></a>Использование индексаторов для обновления содержимого в нескольких службах

Если вы уже используете индексатор в одной службе, можно настроить второй индексатор во второй службе для использования одного и того же объекта источника данных, получая данные из одного и того же расположения. Каждая служба в каждом регионе имеет собственный индексатор и целевой индекс (индекс поиска не является общим, а это означает, что данные дублируются), но каждый индексатор ссылается на один и тот же источник данных.

Ниже приведен высокоуровневый визуальный элемент того, как будет выглядеть архитектура.

   ![Один источник данных с сочетаниями распределенного индексатора и службы][2]

### <a name="use-rest-apis-for-pushing-content-updates-on-multiple-services"></a>Использование интерфейсов API RESTFUL для отправки обновлений содержимого в несколько служб

Если вы используете REST API Когнитивный поиск Azure для [отправки содержимого в индекс когнитивный Поиск Azure](/rest/api/searchservice/update-index), вы можете синхронизировать различные службы поиска, отправляя изменения во все службы поиска каждый раз, когда потребуется обновление. Убедитесь, что в коде выполняются ситуации, когда обновление одной службы поиска завершается сбоем, но для других служб поиска выполняется успешно.

## <a name="leverage-azure-traffic-manager"></a>Использование диспетчера трафика Azure

[Диспетчер трафика Azure](../traffic-manager/traffic-manager-overview.md) позволяет маршрутизировать запросы к нескольким географически размещенным веб-сайтам, которые затем поддерживаются несколькими службами поиска. Одно из преимуществ диспетчера трафика заключается в том, что он может проверить Когнитивный поиск Azure, чтобы убедиться, что он доступен, и направить пользователей в другие службы поиска в случае простоя. Кроме того, при маршрутизации запросов поиска через веб-сайты Azure диспетчер трафика Azure позволяет выполнять балансировку нагрузки, когда веб-сайт работает, но не Когнитивный поиск Azure. Ниже приведен пример архитектуры, использующей диспетчер трафика.

   ![Перекрестные запросы к службам по региону с использованием диспетчера трафика][3]

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о ценовых категориях и службах для каждого из них см. в разделе [ограничения служб](search-limits-quotas-capacity.md). Дополнительные сведения о комбинациях секций и реплик см. в разделе [планирование емкости](search-capacity-planning.md) .

Для обсуждения производительности и демонстраций методик, описанных в этой статье, просмотрите следующее видео:

> [!VIDEO https://channel9.msdn.com/Events/Microsoft-Azure/AzureCon-2015/ACON319/player]
> 

<!--Image references-->
[1]: ./media/search-performance-optimization/geo-redundancy.png
[2]: ./media/search-performance-optimization/scale-indexers.png
[3]: ./media/search-performance-optimization/geo-search-traffic-mgr.png