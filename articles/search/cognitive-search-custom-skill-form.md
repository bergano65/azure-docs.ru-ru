---
title: Пользовательский навык распознавателя форм (C#)
titleSuffix: Azure Cognitive Search
description: Узнайте, как создать пользовательский навык распознавания форм с помощью C# и Visual Studio.
manager: nitinme
author: PatrickFarley
ms.author: pafarley
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 01/21/2020
ms.openlocfilehash: 58f1c2621165a7074c04752832c6560b2fd3e423
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "88935438"
---
# <a name="example-create-a-form-recognizer-custom-skill"></a>Пример. Создание пользовательского навыка распознавателя форм

В этом примере опыта работы с Azure Когнитивный поиск вы узнаете, как создать пользовательский навык распознавания форм с помощью C# и Visual Studio. Распознаватель форм анализирует документы и извлекает пары "ключ-значение" и данные таблицы. Расводя распознаватель форм в [Пользовательский интерфейс квалификации](cognitive-search-custom-skill-interface.md), вы можете добавить эту возможность как шаг в сквозном конвейере обогащения. Затем конвейер может загрузить документы и выполнить другие преобразования.

## <a name="prerequisites"></a>Предварительные требования

- [Visual Studio 2019](https://visualstudio.microsoft.com/downloads/) (любой выпуск).
- По крайней мере пять форм одного типа. Вы можете использовать образцы данных, предоставляемые вместе с этим руководством.

## <a name="create-a-form-recognizer-resource"></a>Создание ресурса Распознавателя документов

[!INCLUDE [create resource](../cognitive-services/form-recognizer/includes/create-resource.md)]

## <a name="train-your-model"></a>Обучение модели

Прежде чем использовать этот навык, необходимо обучить модель распознавателя форм в формах ввода. Чтобы узнать, как обучить модель, следуйте инструкциям из [краткого руководства по фигурам](../cognitive-services/form-recognizer/quickstarts/curl-train-extract.md) . Можно использовать образцы форм, предоставляемые в этом кратком руководстве, или использовать собственные данные. После обучения модели скопируйте ее значение идентификатора в безопасное расположение.

## <a name="set-up-the-custom-skill"></a>Настройка пользовательского навыка

В этом руководстве используется проект [анализеформ](https://github.com/Azure-Samples/azure-search-power-skills/tree/master/Vision/AnalyzeForm) в репозитории [Azure Search Skills](https://github.com/Azure-Samples/azure-search-power-skills) в GitHub. Клонировать этот репозиторий на локальный компьютер и перейти в **представление "концепция" или "анализеформ/** " для доступа к проекту. Затем откройте _анализеформ. csproj_ в Visual Studio. Этот проект создает ресурс функции Azure, который выполняет [Пользовательский интерфейс квалификации](cognitive-search-custom-skill-interface.md) и может использоваться для обогащения когнитивный Поиск Azure. Она принимает документы в качестве входных данных и выводит (в виде текста) заданные пары "ключ-значение".

Сначала добавьте переменные среды на уровне проекта. В левой области выберите проект **анализеформ** , щелкните его правой кнопкой мыши и выберите пункт **свойства**. В окне **Свойства** перейдите на вкладку **Отладка** и найдите поле **переменные среды** . Нажмите кнопку **Добавить** , чтобы добавить следующие переменные:
* `FORMS_RECOGNIZER_ENDPOINT_URL` со значением, заданным для URL-адреса конечной точки.
* `FORMS_RECOGNIZER_API_KEY` со значением, заданным для ключа подписки.
* `FORMS_RECOGNIZER_MODEL_ID` со значением, равным ИДЕНТИФИКАТОРу модели, которую вы обучили.
* `FORMS_RECOGNIZER_RETRY_DELAY` со значением 1000. Это значение представляет собой время в миллисекундах, в течение которого программа будет ожидать перед повторным выполнением запроса.
* `FORMS_RECOGNIZER_MAX_ATTEMPTS` со значением 100. Это количество раз, которое программа будет запрашивать службу при попытке получить успешный ответ.

Затем откройте _AnalyzeForm.CS_ и найдите `fieldMappings` переменную, которая ссылается на *field-mappings.js* файла. Этот файл (и переменная, ссылающаяся на него) определяет список ключей, которые необходимо извлечь из форм, и пользовательскую метку для каждого ключа. Например, значение `{ "Address:", "address" }, { "Invoice For:", "recipient" }` означает, что скрипт сохранит только значения для обнаруженных `Address:` полей и и `Invoice For:` получит метки для этих значений с помощью `"address"` и `"recipient"` соответственно.

Наконец, обратите внимание на `contentType` переменную. Этот скрипт выполняет данную модель распознавателя форм в удаленных документах, на которые ссылается URL-адрес, поэтому тип содержимого — `application/json` . Если требуется проанализировать локальные файлы, включив в HTTP-запросы потоки байтов, необходимо изменить соответствующий `contentType` [тип MIME](https://developer.mozilla.org/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Complete_list_of_MIME_types) для файла.

## <a name="test-the-function-from-visual-studio"></a>Тестирование функции из Visual Studio

После редактирования проекта сохраните его и задайте проект **анализеформ** в качестве запускаемого проекта в Visual Studio (если он еще не установлен). Затем нажмите клавишу **F5** , чтобы запустить функцию в локальной среде. Используйте службу RESTFUL, например [POST](https://www.postman.com/) , для вызова функции.

### <a name="http-request"></a>HTTP-запрос

Вы выполните следующий запрос для вызова функции.

```HTTP
POST https://localhost:7071/api/analyze-form
```

### <a name="request-body"></a>Тело запроса

Начните с шаблона текста запроса ниже.

```json
{
    "values": [
        {
            "recordId": "record1",
            "data": { 
                "formUrl": "<your-form-url>",
                "formSasToken": "<your-sas-token>"
            }
        }
    ]
}
```

Здесь необходимо указать URL-адрес формы, имеющей тот же тип, что и для форм, с которыми вы выполнили обучение. В целях тестирования можно использовать одну из учебных форм. Если вы соберете краткое руководство, ваши формы будут находиться в учетной записи хранилища BLOB-объектов Azure. Откройте Обозреватель службы хранилища Azure, выберите файл формы, щелкните его правой кнопкой мыши и выберите **получить подпись общего доступа**. В следующем диалоговом окне будет предоставлен URL-адрес и маркер SAS. Введите эти строки в `"formUrl"` поля и в `"formSasToken"` тексте запроса соответственно.

> [!div class="mx-imgBorder"]
> ![Обозреватель службы хранилища Azure; выбран PDF-документ](media/cognitive-search-skill-form/form-sas.png)

Если вы хотите проанализировать удаленный документ, который не находится в хранилище BLOB-объектов Azure, вставьте его URL в `"formUrl"` поле и оставьте `"formSasToken"` поле пустым.

> [!NOTE]
> При интеграции навыка в набор навыков URL-адрес и маркер будут предоставлены Когнитивный поиск.

### <a name="response"></a>Ответ

Вы должны увидеть отклик, аналогичный следующему примеру:

```json
{
    "values": [
        {
            "recordId": "record1",
            "data": {
                "address": "1111 8th st. Bellevue, WA 99501 ",
                "recipient": "Southridge Video 1060 Main St. Atlanta, GA 65024 "
            },
            "errors": null,
            "warnings": null
        }
    ]
}
```

## <a name="publish-the-function-to-azure"></a>Публикация функции в Azure

Когда поведение функции будет удовлетворено, его можно опубликовать.

1. В **Обозреватель решений** в Visual Studio щелкните проект правой кнопкой мыши и выберите **опубликовать**. Выберите **создать**  >  **опубликовать**.
1. Если вы еще не подключили Visual Studio к учетной записи Azure, выберите **Добавить учетную запись...**
1. Следуйте инструкциям на экране. Укажите уникальное имя для службы приложений, подписку Azure, группу ресурсов, план размещения и учетную запись хранения, которую вы хотите использовать. Вы можете создать новую группу ресурсов, новый план размещения и новую учетную запись хранения, если у вас ее еще нет. По завершении нажмите кнопку **Создать**.
1. После завершения развертывания обратите внимание на URL-адрес сайта. Этот URL-адрес является адресом приложения-функции в Azure. Сохраните его во временном расположении.
1. В [портал Azure](https://portal.azure.com)перейдите к группе ресурсов и найдите `AnalyzeForm` опубликованную функцию. В разделе **Управление** должны отображаться ключи узла. Скопируйте ключ узла *по умолчанию* и сохраните его во временном расположении.

## <a name="connect-to-your-pipeline"></a>Подключение к конвейеру

Чтобы использовать этот навык в Когнитивный поиск конвейере, необходимо добавить определение навыка в набор навыков. Следующий блок JSON является примером определения навыка (необходимо обновить входные и выходные данные в соответствии с конкретным сценарием и средой навыков). Замените на `AzureFunctionEndpointUrl` URL-адрес функции и замените на `AzureFunctionDefaultHostKey` ключ узла.

```json
{ 
  "description":"Skillset that invokes the Form Recognizer custom skill",
  "skills":[ 
    "[... your existing skills go here]",
    { 
      "@odata.type":"#Microsoft.Skills.Custom.WebApiSkill",
      "name":"formrecognizer",
      "description":"Extracts fields from a form using a pre-trained form recognition model",
      "uri":"[AzureFunctionEndpointUrl]/api/analyze-form?code=[AzureFunctionDefaultHostKey]",
      "httpMethod":"POST",
      "timeout":"PT30S",
      "context":"/document",
      "batchSize":1,
      "inputs":[ 
        { 
          "name":"formUrl",
          "source":"/document/metadata_storage_path"
        },
        { 
          "name":"formSasToken",
          "source":"/document/metadata_storage_sas_token"
        }
      ],
      "outputs":[ 
        { 
          "name":"address",
          "targetName":"address"
        },
        { 
          "name":"recipient",
          "targetName":"recipient"
        }
      ]
    }
  ]
}
```

## <a name="next-steps"></a>Дальнейшие действия

В этом пошаговом окне вы создали пользовательский навык из службы распознавателя форм Azure. Дополнительные сведения о пользовательских навыках см. в следующих ресурсах. 

* [Навыки работы с поиском Azure: репозиторий пользовательских навыков](https://github.com/Azure-Samples/azure-search-power-skills)
* [Добавление пользовательского навыка в конвейер обогащения искусственного интеллекта](cognitive-search-custom-skill-interface.md)
* [Определение набора навыков](cognitive-search-defining-skillset.md)
* [Создание набора навыков (остальное)](/rest/api/searchservice/create-skillset)
* [Соотнесение обогащенных полей](cognitive-search-output-field-mapping.md)