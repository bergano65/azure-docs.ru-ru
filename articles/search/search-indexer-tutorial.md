---
title: Руководство по Индексирование данных из баз данных SQL Azure в примере кода C# — Поиск Azure
description: В примере кода C# описано, как подключить базу данных SQL Azure, извлечь доступные для поиска данные и отправить их в индекс в службе "Поиск Azure".
author: HeidiSteen
manager: cgronlun
services: search
ms.service: search
ms.devlang: na
ms.topic: tutorial
ms.date: 04/08/2019
ms.author: heidist
ms.custom: seodec2018
ms.openlocfilehash: 401ad90f1ae4ffb4915a0b51aea41430e7045aa9
ms.sourcegitcommit: 62d3a040280e83946d1a9548f352da83ef852085
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2019
ms.locfileid: "59270473"
---
# <a name="tutorial-in-c-crawl-an-azure-sql-database-using-azure-search-indexers"></a>Учебник на C#. Сканирование базы данных Azure SQL с помощью индексаторов в службе "Поиск Azure"

Вы узнаете, как настроить индексатор для извлечения доступных для поиска данных из примера базы данных SQL Azure. [Индексатор](search-indexer-overview.md) — это компонент службы "Поиск Azure", который сканирует внешние источники данных и заполняет [индекс поиска](search-what-is-an-index.md) содержимым. Чаще всего используется индексатор для Базы данных SQL Azure. 

Разбираться в конфигурации индексатора очень полезно. Это позволяет сократить объем кода, который необходимо писать и поддерживать. Вместо подготовки и публикации набора совместимых со схемой данных JSON можно подключить к источнику данных индексатор. Он извлечет данные и вставит их в индекс. При необходимости вы можете запустить индексатор по расписанию, чтобы учитывались изменения в базовом источнике.

В рамках этого руководстве используйте [клиентские библиотеки .NET службы "Поиск Azure"](https://aka.ms/search-sdk) и консольное приложение .NET Core для выполнения следующих задач:

> [!div class="checklist"]
> * добавление сведений о службе поиска в параметры приложения;
> * подготовка внешнего набора данных в базе данных Azure SQL; 
> * изучение определений индекса и индексатора в примере кода;
> * выполнение кода индексатора для импорта данных;
> * поиск по индексу;
> * просмотр конфигурации индексатора на портале.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования

В этом кратком руководстве используются приведенные ниже службы, инструменты и данные. 

[Создайте службу "Поиск Azure"](search-create-service-portal.md) или [найдите имеющуюся службу](https://ms.portal.azure.com/#blade/HubsExtension/BrowseResourceBlade/resourceType/Microsoft.Search%2FsearchServices) в рамках текущей подписки. Вы можете использовать бесплатную службу для выполнения инструкций, описанных в этом учебнике.

В [Базе данных Azure SQL](https://azure.microsoft.com/services/sql-database/) хранится источник внешних данных, используемый индексатором. В примере решения предоставляется файл данных SQL для создания таблицы. В этом учебнике приведены шаги по созданию службы и базы данных.

Любую версию [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) можно использовать для запуска примера решения. Пример кода и инструкции были протестированы с помощью бесплатного выпуска Community Edition.

На странице [Azure-Samples/search-dotnet-getting-started](https://github.com/Azure-Samples/search-dotnet-getting-started) приводится пример решения, расположенный в примерах Azure в репозитории GitHub. Скачайте и извлеките решение. По умолчанию решения доступны только для чтения. Щелкните решение правой кнопкой мыши и снимите атрибут только для чтения таким образом, чтобы файлы можно было изменить.

> [!Note]
> В бесплатной версии службы "Поиск Azure" вы можете использовать не более трех индексов, трех индексаторов и трех источников данных. В этом руководстве создается по одному объекту из каждой категории. Убедитесь, что у вас достаточно места, чтобы служба могла принять новые ресурсы.

## <a name="get-a-key-and-url"></a>Получение ключа и URL-адреса

Вызовам REST требуется URL-адрес службы и ключ доступа при каждом запросе. Служба поиска создана с обоими элементами, поэтому если вы добавили службу "Поиск Azure" в подписку, выполните следующие действия для получения необходимых сведений:

1. [Войдите на портал Azure](https://portal.azure.com/) и на странице **обзора** службы поиска получите URL-адрес. Пример конечной точки может выглядеть так: `https://mydemo.search.windows.net`.

1. В разделе **Параметры** > **Ключи** получите ключ администратора, чтобы обрести полные права на службу. Существуют два взаимозаменяемых ключа администратора, предназначенных для обеспечения непрерывности бизнес-процессов на случай, если вам потребуется сменить один из них. Вы можете использовать первичный или вторичный ключ для выполнения запросов на добавление, изменение и удаление объектов.

![Получение конечной точки HTTP и ключа доступа](media/search-fiddler/get-url-key.png "Получение конечной точки HTTP и ключа доступа")

Для выполнения любого запроса к службе требуется использование ключа API. Если есть действительный ключ, для каждого запроса устанавливаются отношения доверия между приложением, которое отправляет запрос, и службой, которая его обрабатывает.

## <a name="set-up-connections"></a>Настройка подключений
Сведения о подключении к требуемым службам указывается в файле решения **appsettings.json**. 

1. В Visual Studio откройте файл **DotNetHowToIndexers.sln**.

1. В обозревателе решений откройте файл **appsettings.json**, чтобы указать каждый параметр.  

Первые две записи можно заполнить прямо сейчас с помощью ключей администратора и URL-адреса для службы "Поиск Azure". Учитывая конечную точку сайта `https://mydemo.search.windows.net`, следует указать имя службы `mydemo`.

```json
{
  "SearchServiceName": "Put your search service name here",
  "SearchServiceAdminApiKey": "Put your primary or secondary API key here",
  "AzureSqlConnectionString": "Put your Azure SQL database connection string here",
}
```

Последняя запись требует существование базы данных. Вы создадите ее на следующем шаге.

## <a name="prepare-sample-data"></a>Подготовка примера данных

На этом этапе создается внешний источник данных, который может сканироваться индексатором. Чтобы создать набор данных в базе данных Azure SQL, вы можете использовать портал Azure и файл *hotels.sql*. В службе "Поиск Azure" используются плоские наборы строк. Такие наборы обычно создаются на основе представления или запроса. При помощи файла SQL в примере решения создается и заполняется одна таблица.

В следующем упражнении предполагается, что сервер и база данных не существуют. Поэтому здесь рекомендуется создать их на шаге 2. Если у вас уже есть необходимый ресурс, можно добавить в него таблицу отелей и начать с шага 4.

1. Войдите на [портале Azure](https://portal.azure.com/). 

2. Найдите или создайте **Базу данных SQL Azure**, чтобы создать базу данных, сервер и группу ресурсов. Вы можете использовать значения по умолчанию и самую низкую ценовую категорию. Одним из преимуществ создания сервера является то, что вы можете указать имя пользователя и пароль администратора, которые потребуются для создания и загрузки таблиц в дальнейшем.

   ![Страница создания базы данных](./media/search-indexer-tutorial/indexer-new-sqldb.png)

3. Нажмите **Создать**, чтобы развернуть новый сервер и базу данных. Дождитесь, пока завершится развертывание сервера и базы данных.

4. Откройте страницу базы данных SQL для создания базы данных, если она еще не открыта. Должно быть указано имя ресурса *База данных SQL*, а не *SQL Server*.

   ![Страница базы данных SQL](./media/search-indexer-tutorial/hotels-db.png)

4. На панели команд последовательно выберите **Средства** > **Редактор запросов**.

5. Нажмите **Вход**, а затем введите имя пользователя и пароль администратора сервера.

6. Выберите **Открыть запрос** и перейдите к расположению *hotels.sql*. 

7. Выберите файл и нажмите **Открыть**. Скрипт должен выглядеть, как на следующем снимке экрана:

   ![Скрипт SQL](./media/search-indexer-tutorial/sql-script.png)

8. Нажмите **Выполнить** для выполнения запроса. В области результатов появится сообщение об успешном выполнении запроса для 3 строк.

9. Чтобы получить набор строк из этой таблицы, можно выполнить следующий запрос для проверки:

    ```sql
    SELECT HotelId, HotelName, Tags FROM Hotels
    ```
    Классический запрос `SELECT * FROM Hotels` не работает в редакторе запросов. Пример данных содержит географические координаты в поле "Расположение". Такие данные не обрабатываются в текущей версии редактора. Список других столбцов для запроса вы можете вывести при помощи инструкции: `SELECT * FROM sys.columns WHERE object_id = OBJECT_ID('dbo.Hotels')`

10. Теперь, когда у вас есть внешний набор данных, скопируйте строку подключения ADO.NET для базы данных. На странице базы данных SQL последовательно выберите **Параметры** > **Строки подключения** и скопируйте строку подключения ADO.NET.
 
    Строки подключения ADO.NET выглядят приблизительно как в приведенном ниже примере. Они изменены для использования допустимого имени базы данных, имени пользователя и пароля.

    ```sql
    Server=tcp:hotels-db.database.windows.net,1433;Initial Catalog=hotels-db;Persist Security Info=False;User ID={your_username};Password={your_password};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;
    ```
11. Вставьте строку подключения в AzureSqlConnectionString в качестве третьей записи файла **appsettings.json** в Visual Studio.

    ```json
    {
      "SearchServiceName": "<placeholder-Azure-Search-service-name>",
      "SearchServiceAdminApiKey": "<placeholder-admin-key-for-Azure-Search>",
      "AzureSqlConnectionString": "Server=tcp:hotels-db.database.windows.net,1433;Initial Catalog=hotels-db;Persist Security  Info=False;User ID={your_username};Password={your_password};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;",
    }
    ```

## <a name="understand-the-code"></a>Изучение кода

Теперь ваш код готов к сборке и выполнению. Но перед этим рекомендуем изучить определения индекса и индексатора для примера. Соответствующий код находится в двух файлах:

  + **hotel.cs** — содержит схему, которая определяет индекс;
  + **Program.cs** — содержит функции для создания структур и управления ими в службе.

### <a name="in-hotelcs"></a>hotell.cs

Схема индексов определяет коллекцию полей, включая атрибуты, в которых указаны разрешенные операции. Например, в них указывается, поддерживает ли схема полнотекстовый поиск, фильтрацию или сортировку, как в представленном ниже определении для HotelName. 

```csharp
. . . 
[IsSearchable, IsFilterable, IsSortable]
public string HotelName { get; set; }
. . .
```

Кроме того, схема может включать профили повышения для оценки результатов поиска, пользовательские анализаторы и другие конструкции. Но для наших целей схема определена не так подробно. Она содержит только поля, обнаруженные в примерах наборов данных.

В этом руководстве индексаторы извлекают данные из одного источника. На практике вы можете подключить несколько индексаторов к одному индексу и создать из нескольких источников данных и индексаторов объединенный индекс с поддержкой поиска. Можно использовать одну и ту же пару, состоящую из индекса и индексатора, изменяя только источники данных, или один индекс с различными сочетаниями индексаторов и источников. Это зависит от требуемого уровня гибкости.

### <a name="in-programcs"></a>Program.cs

Основная программа содержит функции для всех трех репрезентативных источников данных. Если рассматривать только базу данных SQL Azure, следует обратить внимание на такие объекты:

  ```csharp
  private const string IndexName = "hotels";
  private const string AzureSqlHighWaterMarkColumnName = "RowVersion";
  private const string AzureSqlDataSourceName = "azure-sql";
  private const string AzureSqlIndexerName = "azure-sql-indexer";
  ```

Индексы, индексаторы и источники данных в службе "Поиск Azure" (*hotels*, *azure-sql-indexer* и *azure-sql* соответственно), которые можно независимо просмотреть, настроить или удалить. 

Отдельно стоит остановиться на столбце *AzureSqlHighWaterMarkColumnName*. В нем содержатся сведения об обнаружении изменений, при помощи которых индексатор определяет, была ли строка изменена с момента последней рабочей нагрузки индексирования. [Политики обнаружения изменений](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md) поддерживаются только в индексаторах и зависят от источника данных. Для базы данных SQL Azure можно выбрать одну из двух политик, руководствуясь требованиями базы данных.

В приведенном ниже коде показаны методы в файле Program.cs, которые используются для создания источника данных и индексатора. При помощи этого кода проверяется наличие ресурсов с таким же именем. При обнаружении такие ресурсы удаляются, так как есть вероятность, что вы будете запускать эту программу несколько раз.

  ```csharp
  private static string SetupAzureSqlIndexer(SearchServiceClient serviceClient, IConfigurationRoot configuration)
  {
    Console.WriteLine("Deleting Azure SQL data source if it exists...");
    DeleteDataSourceIfExists(serviceClient, AzureSqlDataSourceName);

    Console.WriteLine("Creating Azure SQL data source...");
    DataSource azureSqlDataSource = CreateAzureSqlDataSource(serviceClient, configuration);

    Console.WriteLine("Deleting Azure SQL indexer if it exists...");
    DeleteIndexerIfExists(serviceClient, AzureSqlIndexerName);

    Console.WriteLine("Creating Azure SQL indexer...");
    Indexer azureSqlIndexer = CreateIndexer(serviceClient, AzureSqlDataSourceName, AzureSqlIndexerName);

    return azureSqlIndexer.Name;
  }
  ```

Обратите внимание, что вызовы API индексатора не зависят от платформы, за исключением [DataSourceType](https://docs.microsoft.com/dotnet/api/microsoft.azure.search.models.datasourcetype?view=azure-dotnet), в котором указан тип поискового модуля для вызова.

## <a name="run-the-indexer"></a>Запуск индексатора

На этом шаге мы скомпилируем и запустим программу. 

1. В обозревателе решений щелкните правой кнопкой мыши **DotNetHowToIndexers** и выберите **Собрать**.
2. Еще раз щелкните правой кнопкой мыши **DotNetHowToIndexers**, а затем последовательно выберите **Отладка** > **Запустить новый экземпляр**.

Программа выполняется в режиме отладки. В окне консоли отображаются сведения о состоянии каждой операции.

  ![Скрипт SQL](./media/search-indexer-tutorial/console-output.png)

Код локально выполняется в Visual Studio. Устанавливается подключение к службе поиска в Azure, которая, в свою очередь, подключается к базе данных SQL Azure при помощи строки подключения, чтобы получить набор данных. С таким большим количеством операций есть несколько потенциальных точек сбоя. Если поступает сообщение об ошибке, прежде всего проверьте следующее:

+ Сведения о подключении для службы поиска, которые следует указать, ограничены именем службы в этом руководстве. Если вы ввели полный URL-адрес, когда создается индекс, выполнение операций прекращается и отображается сообщение о сбое подключения.

+ Сведения о подключении к базе данных в **appsettings.json**. Это должна быть строка подключения ADO.NET, полученная на портале, в которую добавлены допустимые для базы данных имя пользователя и пароль. Учетная запись пользователя должна предоставлять разрешение на получение данных.

+ Ограничения ресурсов. Помните, что для общедоступной (бесплатной) службы действуют ограничения в три индекса, индексатора и источника данных. В службе с максимальным количеством объектов нельзя создавать новые.

## <a name="search-the-index"></a>Поиск по индексу 

В верхней части страницы обзора для службы поиска на портале Azure щелкните **Проводник поиска**, чтобы отправить несколько запросов на новый индекс.

1. В верхней части окна щелкните **Изменить индекс** и выберите индекс *hotels*.

2. Нажмите кнопку **Поиск**, чтобы инициировать поиск без запроса. 

   В индексе возвращаются три записи в виде документов JSON. Проводник поиска возвращает документы в формате JSON, чтобы можно было просматривать всю структуру.

3. Затем введите строку поиска `search=river&$count=true`. 

   При помощи этого запроса вызывается полнотекстовый поиск по слову `river`. В результате выводится количество соответствующих документов. Количество соответствующих документов полезно знать при тестировании, когда используется большой индекс с тысячами или миллионами документов. В этом случае только один документ соответствует запросу.

4. Наконец, введите строку поиска, которая ограничивает выходные данные JSON до требуемых полей: `search=river&$count=true&$select=hotelId, baseRate, description`. 

   Ответ на запрос сокращается до выбранных полей, обеспечивая более точный результат.

## <a name="view-indexer-configuration"></a>Просмотр конфигурации индексатора

Все индексаторы, включая только что созданный программными средствами, отображаются на портале. Вы можете открыть определение индексатора и просмотреть его источник данных или настроить расписание обновления, чтобы применялись новые и измененные строки.

1. Откройте страницу обзора в службе "Поиск Azure".
2. Прокрутите вниз, чтобы найти плитки для **индексаторов** и **источников данных**.
3. Щелкните плитку, чтобы открыть список для каждого ресурса. Чтобы просмотреть или изменить параметры конфигурации, вы можете выбрать отдельные индексаторы или источники данных.

   ![Плитки для индексаторов и источников данных](./media/search-indexer-tutorial/tiles-portal.png)


## <a name="clean-up-resources"></a>Очистка ресурсов

Самый быстрый способ очистки по завершении работы с руководством — удалить группу ресурсов, содержащую службу "Поиск Azure". Теперь можно удалить группу ресурсов вместе со всем ее содержимым без возможности восстановления. На портале имя группы ресурсов находится на странице "Обзор" службы "Поиск Azure".

## <a name="next-steps"></a>Дополнительная информация

Управляемые ИИ алгоритмы можно включить в конвейер индексатора. Дальнейшие действия см. в следующем руководстве.

> [!div class="nextstepaction"]
> [Индексирование документов в хранилище BLOB-объектов Azure](search-howto-indexing-azure-blob-storage.md)