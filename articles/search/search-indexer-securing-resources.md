---
title: Доступ индексатора к защищенным ресурсам
titleSuffix: Azure Cognitive Search
description: Общие сведения о параметрах безопасности на уровне сети для доступа к данным Azure индексаторов в Azure Когнитивный поиск.
manager: nitinme
author: arv100kri
ms.author: arjagann
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 10/14/2020
ms.openlocfilehash: 2fb94faacc2bc7d6c3b1e166e617f3f675594cef
ms.sourcegitcommit: ae6e7057a00d95ed7b828fc8846e3a6281859d40
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2020
ms.locfileid: "92101262"
---
# <a name="indexer-access-to-content-protected-by-azure-network-security-features-azure-cognitive-search"></a>Доступ индексатора к содержимому, защищенному с помощью функций безопасности сети Azure (Когнитивный поиск Azure)

Индексаторы Когнитивный поиск Azure могут выполнять исходящие вызовы различных ресурсов Azure во время выполнения. В этой статье объясняются принципы доступа индексатора к содержимому, защищенному брандмауэрами IP, частными конечными точками или другими механизмами безопасности на уровне сети Azure. Индексатор выполняет исходящие вызовы в двух ситуациях: подключение к источникам данных во время индексирования и подключение к инкапсулированному коду через набор навыков. Список всех возможных типов ресурсов, к которым может получить доступ индексатор в типичном запуске, приведен в таблице ниже.

| Ресурс | Назначение в индексаторе выполнение |
| --- | --- |
| Служба хранилища Azure (большие двоичные объекты, таблицы, ADLS Gen 2) | Источник данных |
| Хранилище Azure (большие двоичные объекты, таблицы) | Навыков (кэширование обогащенных документов и сохранение проекций хранилища знаний) |
| Azure Cosmos DB (различные API) | Источник данных |
| База данных SQL Azure | Источник данных |
| SQL Server в виртуальных машинах Azure | Источник данных |
| Управляемый экземпляр SQL | Источник данных |
| Функции Azure | Узел для настраиваемых навыков работы с веб-API |
| Cognitive Services | Прикрепляется к набору навыков, который будет использоваться для выставления счетов за пределами 20 бесплатных документов |

> [!NOTE]
> Ресурс «обогащенная служба», присоединенный к набору навыков, используется для выставления счетов в зависимости от дополнений, выполненных и записанных в индекс поиска. Он не используется для доступа к API-интерфейсы Cognitive Services. Доступ из конвейера обогащения индексатора в API-интерфейсы Cognitive Services происходит через внутренний защищенный канал связи, где данные строго шифруются при передаче и никогда не хранятся в неактивных данных.

Клиенты могут защищать эти ресурсы с помощью нескольких механизмов сетевой изоляции, предлагаемых Azure. За исключением служебного ресурса, индексаторы имеют ограниченную возможность доступа ко всем остальным ресурсам, даже если они изолированы от сети, описанные в таблице ниже.

| Ресурс | Ограничение IP-адресов | Частная конечная точка |
| --- | --- | ---- |
| Служба хранилища Azure (большие двоичные объекты, таблицы, ADLS Gen 2) | Поддерживается, только если учетная запись хранения и служба поиска находятся в разных регионах. | Поддерживаются: |
| API Azure Cosmos DB-SQL | Поддерживается | Поддерживается |
| API Azure Cosmos DB-Cassandra, Mongo и Gremlin | Поддерживается | Не поддерживается |
| База данных SQL Azure | Поддерживается | Поддерживается |
| SQL Server в виртуальных машинах Azure | Поддерживаются: | Недоступно |
| Управляемый экземпляр SQL | Поддерживаются: | Недоступно |
| Функции Azure | Поддерживаются: | Поддерживается, только для определенных уровней функций Azure |

> [!NOTE]
> В дополнение к указанным выше параметрам для учетных записей хранения Azure, защищенных с помощью сети, клиенты могут использовать тот факт, что Azure Когнитивный поиск является [доверенной службой Майкрософт](../storage/common/storage-network-security.md#trusted-microsoft-services). Это означает, что конкретная служба поиска может обходить ограничения виртуальной сети или IP-адресов в учетной записи хранения и иметь доступ к данным в учетной записи хранения, если в учетной записи хранения включен соответствующий контроль доступа на основе ролей. Дополнительные сведения см. [в разделе подключения индексатора с помощью исключения доверенной службы](search-indexer-howto-access-trusted-service-exception.md). Этот параметр можно использовать вместо маршрута ограничения IP-адресов, если учетная запись хранения или служба поиска не могут быть перемещены в другой регион.

При выборе механизма безопасного доступа, который должен использовать индексатор, учитывайте следующие ограничения.

- Индексатор не может подключиться к [конечной точке службы виртуальной сети](../virtual-network/virtual-network-service-endpoints-overview.md). Для соединений индексатора поддерживаются общедоступные конечные точки с учетными данными, частные конечные точки, Доверенные службы и IP-адресация.
- Службу поиска невозможно подготовить в определенной виртуальной сети, которая работает на виртуальной машине в собственном режиме. Эта функция не будет предложена Azure Когнитивный поиск.
- Если индексаторы используют закрытые конечные точки для доступа к ресурсам, может [взиматься дополнительная плата за использование частной связи](https://azure.microsoft.com/pricing/details/search/) .

## <a name="indexer-execution-environment"></a>Среда выполнения индексатора

Индексаторы Когнитивный поиск Azure способны эффективно извлекать содержимое из источников данных, добавлять дополнения к извлеченному содержимому, при необходимости создавая проекции перед записью результатов в индекс поиска. В зависимости от количества обязанностей, назначенных индексатору, оно может выполняться в одной из двух сред:

- Частная среда для определенной службы поиска. Индексаторы, работающие в таких средах, совместно используют ресурсы с другими рабочими нагрузками (например, с помощью других инициированных клиентом индексов или рабочих нагрузок, выполняющих запросы). Как правило, в этой среде выполняются только индексаторы, выполняющие индексирование на основе текста (например, не использовать набор навыков).
- Многоклиентская среда, в которой размещены индексаторы, интенсивно использующие ресурсы, например навыков. Эта среда используется для разгрузки вычислительно-ресурсоемких операций, в результате чего ресурсы, зависящие от службы, доступны для выполнения подпрограмм. Эта многоклиентская среда управляется и защищена корпорацией Майкрософт и не требует дополнительных затрат на клиента.

Для любого выполнения индексатора Когнитивный поиск Azure определяет наилучшую среду, в которой будет выполняться индексатор. Если вы используете брандмауэр IP для управления доступом к ресурсам Azure, знание сред выполнения поможет настроить диапазон IP-адресов, включающий оба.

## <a name="granting-access-to-indexer-ip-ranges"></a>Предоставление доступа к диапазонам IP-адресов индексатора

Если ресурс, к которому пытается обратиться индексатор, ограничен только определенным набором диапазонов IP-адресов, необходимо расширить набор, включив в него возможные диапазоны IP-адресов, из которых может поступать запрос индексатора. Как упоминалось выше, существуют две возможные среды, в которых индексаторы работают и откуда могут исходить запросы на доступ. Необходимо добавить IP-адреса **обеих** сред для доступа индексатора к работе.

- Чтобы получить IP-адрес частного окружения службы поиска, `nslookup` (или) полное `ping` доменное имя (FQDN) службы поиска. Например, полное доменное имя службы поиска в общедоступном облаке будет иметь вид `<service-name>.search.windows.net` . Эти сведения доступны на портал Azure.
- IP-адреса для сред с несколькими клиентами доступны через `AzureCognitiveSearch` тег службы. [Теги служб Azure](../virtual-network/service-tags-overview.md) имеют опубликованный диапазон IP-адресов для каждой службы. он доступен через [API обнаружения (Предварительная версия)](../virtual-network/service-tags-overview.md#use-the-service-tag-discovery-api-public-preview) или [загружаемый файл JSON](../virtual-network/service-tags-overview.md#discover-service-tags-by-using-downloadable-json-files). В любом случае диапазоны IP-адресов разбиваются по регионам. Вы можете выбрать диапазоны IP-адресов, назначенные для региона, в котором была подготовлена служба поиска.

Для некоторых источников данных можно напрямую использовать тег службы вместо перечисления списка диапазонов IP-адресов (IP-адрес службы поиска по-прежнему должен использоваться явно). Эти источники данных ограничивают доступ посредством настройки [правила группы безопасности сети](../virtual-network/network-security-groups-overview.md), которое изначально поддерживает добавление тега службы, в отличие от правил IP, таких как служба хранилища Azure, Cosmos DB, Azure SQL и т. д. Ниже перечислены источники данных, которые поддерживают возможность использования `AzureCognitiveSearch` тега службы непосредственно в дополнение к IP-адресу службы поиска.

- [SQL Server на виртуальных машинах Azure](./search-howto-connecting-azure-sql-iaas-to-azure-search-using-indexers.md#restrict-access-to-the-azure-cognitive-search)

- [Управляемые экземпляры SQL](./search-howto-connecting-azure-sql-mi-to-azure-search-using-indexers.md#verify-nsg-rules)

Дополнительные сведения об этом варианте подключения см. в разделе [подключения индексатора через БРАНДМАУЭР IP](search-indexer-howto-access-ip-restricted.md).

## <a name="granting-access-via-private-endpoints"></a>Предоставление доступа через частные конечные точки

Индексаторы могут использовать [частные конечные точки](../private-link/private-endpoint-overview.md) для доступа к ресурсам, доступ к которым заблокирован либо для выбора виртуальных сетей, либо для отсутствия включенного общего доступа.
Эта функция доступна только в службах поиска с оплатой и ограничивает количество создаваемых частных конечных точек. Дополнительные сведения см. в разделе [ограничения службы](search-limits-quotas-capacity.md#shared-private-link-resource-limits).

### <a name="step-1-create-a-private-endpoint-to-the-secure-resource"></a>Шаг 1. Создание частной конечной точки для защищенного ресурса

Клиенты должны вызвать операцию управления поиском, [CREATEORUPDATE API](/rest/api/searchmanagement/sharedprivatelinkresources/createorupdate) на **общем ресурсе частной связи**, чтобы создать подключение к частной конечной точке к защищенному ресурсу (например, учетной записи хранения). Трафик, который проходит через это (исходящее) подключение к частной конечной точке, будет создан только из виртуальной сети, которая находится в среде выполнения индексатора "Private", зависящей от службы поиска.

Azure Когнитивный поиск проверит, что вызывающие объекты этого API имеют разрешения RBAC для утверждения запросов на подключение частной конечной точки к защищенному ресурсу. Например, если вы запрашиваете подключение к частной конечной точке к учетной записи хранения с разрешениями только для чтения, этот вызов будет отклонен.

### <a name="step-2-approve-the-private-endpoint-connection"></a>Шаг 2. Утверждение подключения к частной конечной точке

Когда асинхронная операция, создающая общий ресурс закрытой ссылки, завершается, подключение к частной конечной точке будет создано в состоянии "ожидание". Трафик еще не проходит через подключение.
Затем клиент должен располагать этот запрос на своем защищенном ресурсе и одобрить его. Как правило, это можно сделать либо с помощью портал Azure, либо с помощью [REST API](/rest/api/virtualnetwork/privatelinkservices/updateprivateendpointconnection).

### <a name="step-3-force-indexers-to-run-in-the-private-environment"></a>Шаг 3. принудительное выполнение индексаторов в "частной" среде

Утвержденная частная конечная точка разрешает исходящие вызовы от службы поиска к ресурсу, который имеет некоторую форму ограничений доступа на уровне сети (например, источник данных учетной записи хранения, настроенный на доступ только из определенных виртуальных сетей) для выполнения.
Это означает, что любой индексатор, который может подключиться к такому источнику данных через закрытую конечную точку, будет выполнен.
Если частная конечная точка не утверждена или если индексатор не использует подключение к частной конечной точке, то выполнение индексатора будет завершено в `transientFailure` .

Чтобы разрешить индексаторам доступ к ресурсам через частные конечные точки, необходимо задать для `executionEnvironment` индексатора значение, `"Private"` чтобы гарантировать, что все запущенные индексаторы смогут использовать закрытую конечную точку. Это связано с тем, что частные конечные точки подготавливаются в среде с закрытой службой поиска.

```json
    {
      "name" : "myindexer",
      ... other indexer properties
      "parameters" : {
          ... other parameters
          "configuration" : {
            ... other configuration properties
            "executionEnvironment": "Private"
          }
        }
    }
```

Эти действия более подробно описаны в разделе [подключения индексатора через закрытую конечную точку](search-indexer-howto-access-private.md).
После получения утвержденной частной конечной точки для ресурса индексаторы, которые задаются как *частные* , пытаются получить доступ через подключение к частной конечной точке.

### <a name="limits"></a>Ограничения

Чтобы обеспечить оптимальную производительность и стабильность службы поиска, ограничения накладываются (по уровню службы поиска) по следующим измерениям:

- Типы индексаторов, которые могут быть заданы как *закрытые*.
- Число общих ресурсов частной ссылки, которые могут быть созданы.
- Число уникальных типов ресурсов, для которых могут быть созданы общие ресурсы частной связи.

Эти ограничения описаны в статье [ограничения службы](search-limits-quotas-capacity.md).

## <a name="next-steps"></a>Дальнейшие действия

- [Подключение индексатора через IP-брандмауэры](search-indexer-howto-access-ip-restricted.md)
- [Подключения индексатора с помощью исключения доверенной службы](search-indexer-howto-access-trusted-service-exception.md)
- [Подключение индексатора к частной конечной точке](search-indexer-howto-access-private.md)