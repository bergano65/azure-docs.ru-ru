---
title: Получение данных журнала
titleSuffix: Azure Cognitive Search
description: Собирайте и анализируйте данные журнала, включив параметр диагностики, а затем используйте язык запросов Kusto для просмотра результатов.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 06/30/2020
ms.openlocfilehash: 52230d6b13c4210e0ff8e85d0a3efe39af55f6e2
ms.sourcegitcommit: 62e1884457b64fd798da8ada59dbf623ef27fe97
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2020
ms.locfileid: "88935064"
---
# <a name="collect-and-analyze-log-data-for-azure-cognitive-search"></a>Собирайте и анализируйте данные журналов для Когнитивный поиск Azure

Журнал диагностики или операционные журналы предоставляют подробные сведения об операциях Azure Когнитивный поиск и полезны для мониторинга процессов обслуживания и рабочих нагрузок. На внутреннем уровне некоторые системные сведения существуют на серверной части в течение короткого периода времени, достаточно для изучения и анализа, если вы захотите получить запрос в службу поддержки. Однако, если требуется самостоятельное управление данными, следует настроить параметр диагностики, чтобы указать, где собираются данные журнала.

Ведение журнала диагностики включено с помощью интеграции с [Azure Monitor](../azure-monitor/index.yml). 

При настройке ведения журнала диагностики Вам будет предложено указать механизм хранения. В следующей таблице перечисляются параметры для сбора и сохранения данных.

| Ресурс | Используется для |
|----------|----------|
| [Отправка в рабочую область Log Analytics](../azure-monitor/learn/tutorial-resource-logs.md) | События и метрики отправляются в рабочую область Log Analytics, которая может быть запрошена на портале для получения подробных сведений. Общие сведения см. в статье Начало [работы с журналами Azure Monitor](../azure-monitor/log-query/get-started-portal.md) . |
| [Архив с хранилищем BLOB-объектов](../storage/blobs/storage-blobs-overview.md) | События и метрики архивируются в контейнер больших двоичных объектов и хранятся в JSON-файлах. Журналы могут быть достаточно детализированы (час в минуту), что полезно для повторного поиска конкретного инцидента, но не для исследования с открытым окончанием. Используйте редактор JSON для просмотра необработанного файла журнала или Power BI для агрегирования и визуализации данных журнала.|
| [Поток в концентратор событий](../event-hubs/index.yml) | События и метрики передаются в поток в службе концентраторов событий Azure. Выберите этот вариант в качестве альтернативной службы сбора данных для очень больших журналов. |

## <a name="prerequisites"></a>Предварительные требования

Создавайте ресурсы заранее, чтобы при настройке ведения журнала диагностики можно было выбрать один или несколько ресурсов.

+ [Создание рабочей области log Analytics](../azure-monitor/learn/quick-create-workspace.md)

+ [создать учетную запись хранения;](../storage/common/storage-account-create.md)

+ [Создание концентратора событий](../event-hubs/event-hubs-create.md)

## <a name="enable-data-collection"></a>Включение сбора данных

Параметры диагностики указывают, как собираются события и метрики, регистрируемые в журнале.

1. В разделе **Мониторинг** выберите **Параметры диагностики**.

   ![Параметры диагностики](./media/search-monitor-usage/diagnostic-settings.png "Параметры диагностики")

1. Выберите **+ Добавить параметр диагностики**

1. Проверьте **log Analytics**, выберите рабочую область и выберите **OperationLogs** и **аллметрикс**.

   ![Настройка сбора данных](./media/search-monitor-usage/configure-storage.png "Настройка сбора данных")

1. Сохраните параметр.

1. После включения ведения журнала используйте службу поиска, чтобы начать создавать журналы и метрики. Это займет некоторое время до того, как будут доступны зарегистрированные события и метрики.

Для Log Analytics до тех пор, пока данные будут доступны через несколько минут, после чего можно будет выполнять запросы Kusto для возврата данных. Дополнительные сведения см. в разделе [мониторинг запросов запросов](search-monitor-logs.md).

Для хранилища BLOB-объектов требуется один час, прежде чем контейнеры будут отображаться в хранилище BLOB-объектов. Для каждого часа и каждого контейнера создается один большой двоичный объект. Контейнеры создаются только при наличии действия для записи в журнал или измерения. При копировании в учетную запись хранения данные представляются в формате JSON и размещаются в двух контейнерах:

+ insights-logs-operationlogs: для поиска журналов трафика
+ insights-metrics-pt1m: для метрик

## <a name="query-log-information"></a>Сведения о журнале запросов

Две таблицы содержат журналы и метрики для Azure Когнитивный поиск: **AzureDiagnostics** и **азуреметрикс**.

1. В разделе **мониторинг**выберите **журналы**.

1. В окне запроса введите **азуреметрикс** . Выполните этот простой запрос, чтобы познакомиться с данными, собранными в этой таблице. Прокрутите таблицу, чтобы просмотреть метрики и значения. Обратите внимание на счетчик записей в верхней части, и если ваша служба собрала метрики в течение определенного времени, может потребоваться изменить временной интервал, чтобы получить управляемый набор данных.

   ![Таблица Азуреметрикс](./media/search-monitor-usage/azuremetrics-table.png "Таблица Азуреметрикс")

1. Введите следующий запрос для возврата табличного результирующего набора.

   ```
   AzureMetrics
    | project MetricName, Total, Count, Maximum, Minimum, Average
   ```

1. Повторите предыдущие шаги, начиная с **AzureDiagnostics** , чтобы вернуть все столбцы для информационных целей, а затем — селективный запрос, который извлекает более интересные сведения.

   ```
   AzureDiagnostics
   | project OperationName, resultSignature_d, DurationMs, Query_s, Documents_d, IndexName_s
   | where OperationName == "Query.Search" 
   ```

   ![Таблица AzureDiagnostics](./media/search-monitor-usage/azurediagnostics-table.png "Таблица AzureDiagnostics")

## <a name="kusto-query-examples"></a>Примеры запросов Kusto

Если включено ведение журнала диагностики, можно запросить **AzureDiagnostics** , чтобы получить список операций, которые выполнялись в службе и в каких случаях. Можно также сопоставить действие для исследования изменений производительности.

#### <a name="example-list-operations"></a>Пример. Вывод списка операций 

Возвращает список операций и количество каждого из них.

```
AzureDiagnostics
| summarize count() by OperationName
```

#### <a name="example-correlate-operations"></a>Пример: корреляция операций

Сопоставьте запрос с операциями индексирования и визуализируйте точки данных на диаграмме времени, чтобы увидеть совпадающие операции.

```
AzureDiagnostics
| summarize OperationName, Count=count()
| where OperationName in ('Query.Search', 'Indexing.Index')
| summarize Count=count(), AvgLatency=avg(DurationMs) by bin(TimeGenerated, 1h), OperationName
| render timechart
```

## <a name="logged-operations"></a>Записанные операции

Записанные в журнал события, записанные Azure Monitor, включают связанные с индексированием и запросами. Таблица **AzureDiagnostics** в log Analytics собирает операционные данные, связанные с запросами и индексацией.

| OperationName | Description |
|---------------|-------------|
| сервицестатс | Эта операция является обычным вызовом для [получения статистики службы](/rest/api/searchservice/get-service-statistics), которая вызывается напрямую или неявно для заполнения страницы обзора портала при ее загрузке или обновлении. |
| Запрос. Поиск |  Запросы к индексу см. в разделе [мониторинг запросов](search-monitor-queries.md) на наличие сведений о зарегистрированных запросах.|
| Индексирование. индекс  | Эта операция является вызовом для [добавления, обновления или удаления документов](/rest/api/searchservice/addupdate-or-delete-documents). |
| индексирует. Эскиз | Это индекс, созданный мастером импорта данных. |
| Индексаторы. Create | Явное или неявное создание индексатора с помощью мастера импорта данных. |
| Индексаторы. Get | Возвращает имя индексатора при каждом запуске индексатора. |
| Индексаторы. состояние | Возвращает состояние индексатора при каждом запуске индексатора. |
| Источники данных. Get | Возвращает имя источника данных при каждом запуске индексатора.|
| Индексы. Get | Возвращает имя индекса при каждом запуске индексатора. |

## <a name="log-schema"></a>Схема журнала

При создании пользовательских отчетов структуры данных, содержащие данные журнала Когнитивный поиск Azure, соответствуют приведенной ниже схеме. Для хранилища BLOB-объектов у каждого большого двоичного объекта есть один корневой объект, именуемый **записями** , содержащими массив объектов журнала. Каждый большой двоичный объект содержит записи о всех операциях, которые выполнялась в течение одного часа.

В следующей таблице приведен неполный список полей, общих для ведения журнала ресурсов.

| Имя | Тип | Пример | Примечания |
| --- | --- | --- | --- |
| timeGenerated |DATETIME |"2018-12-07T00:00:43.6872559Z" |Метка времени операции |
| resourceId |строка |"/SUBSCRIPTIONS/11111111-1111-1111-1111-111111111111/<br/>RESOURCEGROUPS/DEFAULT/PROVIDERS/<br/>  MICROSOFT.SEARCH/SEARCHSERVICES/SEARCHSERVICE" |Идентификатор вашего ресурса |
| operationName |строка |"Query.Search" |Имя операции |
| operationVersion |строка |"2020-06-30" |Используемая версия API |
| категория |строка |"OperationLogs" |constant |
| resultType |строка |Success |Возможные значения: Success или Failure |
| resultSignature |INT |200 |Код результата HTTP |
| durationMS |INT |50 |Время выполнения операции в миллисекундах |
| properties |объект |См. следующую таблицу |Объект, содержащий данные об операции |

### <a name="properties-schema"></a>Схема свойств

Ниже перечислены свойства, характерные для Azure Когнитивный поиск.

| Имя | Тип | Пример | Примечания |
| --- | --- | --- | --- |
| Description_s |строка |"GET /indexes('content')/docs" |Конечная точка операции |
| Documents_d |INT |42 |Количество обработанных документов |
| IndexName_s |строка |"Test-index" |Имя индекса, связанного с операцией |
| Query_s |строка |"? Поиск = AzureSearch&$count = true&API-Version = 2020-06-30" |Параметры запроса |

## <a name="metrics-schema"></a>Схема метрик

Метрики записываются для запросов запросов и измеряются через одну минуту. Каждая метрика отражает минимальное, максимальное и среднее значения за минуту. Дополнительные сведения см. в разделе [мониторинг запросов запросов](search-monitor-queries.md).

| Имя | Тип | Пример | Примечания |
| --- | --- | --- | --- |
| resourceId |строка |"/SUBSCRIPTIONS/11111111-1111-1111-1111-111111111111/<br/>RESOURCEGROUPS/DEFAULT/PROVIDERS/<br/> MICROSOFT.SEARCH/SEARCHSERVICES/SEARCHSERVICE" |Идентификатор ресурса |
| metricName |строка |"Latency" |имя метрики |
| time |DATETIME |"2018-12-07T00:00:43.6872559Z" |метка времени операции |
| average |INT |64 |Среднее значение необработанных выборок в интервале времени метрики, единицах в секундах или процентах, в зависимости от метрики. |
| minimum |INT |37 |Минимальное значение необработанных выборок в интервале времени метрики, единицах в секундах. |
| maximum |INT |78 |Максимальное значение необработанных выборок в интервале времени метрики, единицах в секундах.  |
| total |INT |258 |Общее значение необработанных образцов в интервале времени метрики, единицах в секундах.  |
| count |INT |4 |Количество метрик, выдаваемых из узла в журнал в течение интервала в одну минуту.  |
| timegrain |строка |"PT1M" |Гран времени метрики в ISO 8601. |

Обычно запросы выполняются в миллисекундах, поэтому в метриках, таких как QPS, отображаются только запросы, измеряющие секунды.

Для метрики **поисковых запросов в секунду** минимальное значение является наименьшим значением для поисковых запросов в секунду, зарегистрированных в течение этой минуты. То же относится и к максимальному значению. Средним является совокупное значение за всю минуту. Например, в течение одной минуты у вас может быть один из следующих шаблонов: одна секунда высокой нагрузки, которая является максимальным значением для SearchQueriesPerSecond, за которой следует 58 секунд средней нагрузки и, наконец, одна секунда только с одним запросом, который является минимальным значением.

Для **регулируемых запросов поиска в процентах**, минимуме, максимуме, среднем и общем значении все имеют одинаковое значение: процент запросов поиска, которые были отрегулированы, от общего числа поисковых запросов в течение одной минуты.

## <a name="view-raw-log-files"></a>Просмотр необработанных файлов журнала

Хранилище BLOB-объектов используется для архивирования файлов журналов. Для просмотра файла журнала можно использовать любой редактор JSON. Если у вас его нет, мы рекомендуем [Visual Studio Code](https://code.visualstudio.com/download).

1. Откройте колонку "Учетная запись хранения" на портале Azure. 

2. В области навигации слева щелкните **Большие двоичные объекты**. Должны отобразиться контейнеры **insights-logs-operationlogs** и **insights-metrics-pt1m**. Эти контейнеры создаются Когнитивный поиск Azure при экспорте данных журнала в хранилище BLOB-объектов.

3. Разворачивайте иерархию папок, пока не достигнете JSON-файла.  Используйте контекстное меню для скачивания файла.

Откройте скачанный файл в редакторе JSON, чтобы просмотреть содержимое.

## <a name="next-steps"></a>Дальнейшие действия

Если вы еще не сделали этого, ознакомьтесь с основами мониторинга службы поиска, чтобы узнать о полном диапазоне возможностей.

> [!div class="nextstepaction"]
> [Мониторинг операций и действий в Azure Когнитивный поиск](search-monitor-usage.md)