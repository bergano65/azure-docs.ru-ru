---
title: Мониторинг запросов
titleSuffix: Azure Cognitive Search
description: Отслеживайте метрики запросов для производительности и пропускной способности. Собирайте и анализируйте входные данные строки запроса в журналах ресурсов.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 02/18/2020
ms.openlocfilehash: a5589a46a63437fb395db280222f8a9e84775df3
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "88935081"
---
# <a name="monitor-query-requests-in-azure-cognitive-search"></a>Наблюдение за запросами запросов в Azure Когнитивный поиск

В этой статье объясняется, как измерять производительность запросов и тома с помощью метрик и ведения журнала ресурсов. Здесь также объясняется, как собираются входные термины, используемые в запросах. необходимые сведения необходимо для оценки служебной программы и эффективности поиска совокупности.

Исторические данные, которые веб-каналы поступают в метрики, сохраняются в течение 30 дней. Для более длительного хранения данных или для отчетов по рабочим данным и строкам запросов обязательно включите [параметр диагностики](search-monitor-logs.md) , указывающий вариант хранения для сохранения зарегистрированных событий и метрик.

Условия, которые обеспечивают максимальную целостность измерения данных, включают:

+ Используйте оплачиваемую службу (службу, созданную на уровне Basic или Standard). Бесплатная служба совместно используется несколькими подписчиками, что приводит к определению определенного объема изменчивости при смене нагрузки.

+ По возможности используйте одну реплику и секцию, чтобы создать автономную и изолированную среду. При использовании нескольких реплик метрики запроса вычисляются в среднем на нескольких узлах, что может снизить точность результатов. Аналогичным образом, несколько секций означают, что данные разделены, при этом некоторые секции могут иметь разные данные, если индексирование также выполняется. При настройке производительности запросов один узел и раздел предоставляют более стабильную среду для тестирования.

> [!Tip]
> С помощью дополнительного кода на стороне клиента и Application Insights вы также можете собирать данные с дополнительной информацией, чтобы получить более подробные сведения о том, что аттрактс интерес пользователей приложения. Дополнительные сведения см. в статье [Что такое аналитика поискового трафика?](search-traffic-analytics.md)

## <a name="query-volume-qps"></a>Объем запросов (QPS)

Том измеряется как количество **поисковых запросов в секунду** (QPS), встроенная метрика, которую можно сообщить как среднее значение, число, минимальное или максимальное значение для запросов, выполняемых в течение одной минуты. Интервал в 1 минуту (TimeGrain = "PT1M") для метрик фиксируется в системе.

Обычно запросы выполняются в миллисекундах, поэтому в метриках будут отображаться только запросы, измеряющие секунды.

| Тип статистической обработки | Описание |
|------------------|-------------|
| Среднее | Среднее число секунд в течение минуты, в течение которых произошло выполнение запроса.|
| Count | Число метрик, переданных в журнал в течение интервала в один минуту. |
| Максимум | Максимальное число поисковых запросов в секунду, зарегистрированных в течение минуты. |
| Минимальные | Наименьшее количество поисковых запросов в секунду, зарегистрированных в течение минуты.  |
| SUM | Сумма всех запросов, выполненных в течение минуты.  |

Например, в течение одной минуты у вас может быть один из следующих шаблонов: одна секунда высокой нагрузки, которая является максимальным значением для SearchQueriesPerSecond, за которой следует 58 секунд средней нагрузки и, наконец, одна секунда только с одним запросом, который является минимальным значением.

Еще один пример: Если узел порождает метрики 100, где значение каждой метрики равно 40, то "Count" равно 100, "Sum" — 4000, "Average" — 40, а "Max" — 40.

## <a name="query-performance"></a>Производительность запросов

В масштабе всей службы производительность запросов измеряется как задержка поиска (продолжительность выполнения запроса) и регулируемые запросы, которые были удалены в результате состязаний за ресурсы.

### <a name="search-latency"></a>Задержка поиска

| Тип статистической обработки | Задержка | 
|------------------|---------|
| Среднее | Средняя длительность запроса в миллисекундах. | 
| Count | Число метрик, переданных в журнал в течение интервала в один минуту. |
| Максимум | Наиболее длительный запрос в образце. | 
| Минимальные | Кратчайший запуск запроса в примере.  | 
| Итог | Общее время выполнения всех запросов в примере, выполненных в течение интервала (одна минута).  |

Рассмотрим следующий пример метрик **задержки поиска** : 86 запросов с выборкой и средней длительностью 23,26 миллисекунд. Минимальное значение, равное 0, означает, что некоторые запросы были удалены. Выполнение самого длинного запроса заняло 1000 миллисекунд. Общее время выполнения составило 2 секунды.

![Агрегаты задержки](./media/search-monitor-usage/metrics-latency.png "Агрегаты задержки")

### <a name="throttled-queries"></a>Регулируемые запросы

Регулируемые запросы относятся к запросам, которые отбрасываются вместо обработки. В большинстве случаев регулирование является нормальной частью работы службы.  Это не обязательно означает, что что-то не так.

Регулирование происходит, когда количество запросов, обработанных в данный момент, превышает доступные ресурсы. Вы можете столкнуться с увеличением регулируемых запросов, когда реплика выводится из вращения или во время индексирования. Запросы запросов и индексирования обрабатываются одним и тем же набором ресурсов.

Служба определяет, следует ли удалить запросы на основе потребления ресурсов. Процент ресурсов, потребляемых в памяти, ЦП и дисковых операциях ввода-вывода, вычисляется за определенный период времени. Если этот процент превышает пороговое значение, все запросы к индексу будут регулироваться до тех пор, пока объем запросов не будет уменьшен. 

В зависимости от клиента регулируемый запрос может быть указан следующими способами:

+ Служба возвращает ошибку "вы отправляете слишком много запросов. Повторите попытку позже". 
+ Служба возвращает код ошибки 503, указывающий, что служба в данный момент недоступна. 
+ Если вы используете портал (например, обозреватель поиска), запрос удаляется автоматически, и вам потребуется нажать кнопку "повторить поиск".

Чтобы подтвердить регулируемые запросы, используйте показатель **регулируемых запросов поиска** . Вы можете просмотреть метрики на портале или создать метрику предупреждения, как описано в этой статье. Для запросов, которые были удалены в течение интервала выборки, используйте *Total* , чтобы получить процент запросов, которые не выполнялись.

| Тип статистической обработки | Регулирование |
|------------------|-----------|
| Среднее | Процент запросов, отбрасываемых в пределах интервала. |
| Count | Число метрик, переданных в журнал в течение интервала в один минуту. |
| Максимум | Процент запросов, отбрасываемых в пределах интервала.|
| Минимальные | Процент запросов, отбрасываемых в пределах интервала. |
| Итог | Процент запросов, отбрасываемых в пределах интервала. |

Для **регулируемых запросов поиска в процентах**, минимуме, максимуме, среднем и общем значении все имеют одинаковое значение: процент запросов поиска, которые были отрегулированы, от общего числа поисковых запросов в течение одной минуты.

На следующем снимке экрана первым числом является количество (или количество метрик, отправленных в журнал). Дополнительные агрегаты, которые отображаются вверху или при наведении указателя мыши на метрику, включают средние, максимальные и итоги. В этом примере запросы не были удалены.

![Регулируемые агрегаты](./media/search-monitor-usage/metrics-throttle.png "Регулируемые агрегаты")

## <a name="explore-metrics-in-the-portal"></a>Просмотр метрик на портале

Для быстрого просмотра текущих чисел на вкладке " **мониторинг** " на странице "Обзор службы" отображаются три метрики (**Задержка поиска**, **поисковые запросы за секунду (на единицу поиска)** и **регулируемые запросы поиска в процентах**) через фиксированные интервалы, измеряемые в часах, днях и неделях, с возможностью изменения типа статистической обработки.

Для более глубокого изучения откройте обозреватель метрик из меню **мониторинг** , чтобы можно было послойировать, увеличить и визуализировать данные для изучения тенденций и аномалий. Дополнительные сведения об обозревателе метрик см. в этом [руководстве по созданию диаграммы метрик](../azure-monitor/learn/tutorial-metrics-explorer.md).

1. В разделе Мониторинг выберите **метрики** , чтобы открыть обозреватель метрик с областью, заданной для службы поиска.

1. В разделе метрика выберите один из раскрывающегося списка и изучите список доступных агрегатов для предпочтительного типа. Статистическая обработка определяет, как собранные значения будут выдаваться с помощью выборки за каждый интервал времени.

   ![Обозреватель метрик для метрики QPS](./media/search-monitor-usage/metrics-explorer-qps.png "Обозреватель метрик для метрики QPS")

1. В правом верхнем углу задайте интервал времени.

1. Выберите визуализацию. Значение по умолчанию — график.

1. Дополнительные агрегаты слоев, выбрав **Добавить метрику** и выбрав другие агрегаты.

1. Увеличить область интересов на графике. Установите указатель мыши на начальную точку диапазона, щелкните и удерживайте левую кнопку мыши, перетащите указатель до противоположной стороны диапазона и отпустите кнопку. Масштаб диаграммы изменится так, чтобы она отображала выбранный диапазон времени.

## <a name="identify-strings-used-in-queries"></a>Выявление строк, используемых в запросах

При включении ведения журнала ресурсов система фиксирует запросы в таблице **AzureDiagnostics** . В качестве необходимого компонента необходимо уже включить [ведение журнала ресурсов](search-monitor-logs.md), указав рабочую область log Analytics или другой вариант хранения.

1. В разделе Мониторинг выберите **журналы** , чтобы открыть пустое окно запроса в log Analytics.

1. Выполните следующее выражение для поиска по запросу. поисковые операции, возвращая табличный результирующий набор, состоящий из имени операции, строки запроса, запрошенного индекса и числа найденных документов. Последние две инструкции исключают строки запроса, состоящие из пустого или неуказанного поиска, через пример индекса, который вырезает шум в результатах.

   ```
   AzureDiagnostics
   | project OperationName, Query_s, IndexName_s, Documents_d
   | where OperationName == "Query.Search"
   | where Query_s != "?api-version=2020-06-30&search=*"
   | where IndexName_s != "realestate-us-sample-index"
   ```

1. При необходимости задайте фильтр столбца на *Query_s* для поиска по определенному синтаксису или строке. Например, можно выполнить фильтрацию по *равной* `?api-version=2020-06-30&search=*&%24filter=HotelName` .

   ![Зарегистрированные строки запросов](./media/search-monitor-usage/log-query-strings.png "Зарегистрированные строки запросов")

Хотя этот метод работает для нерегламентированного исследования, создание отчета позволяет консолидировать и представлять строки запросов в макете более пригодного для анализа.

## <a name="identify-long-running-queries"></a>Выявление долго выполняющихся запросов

Добавьте столбец Duration (длительность), чтобы получить номера всех запросов, а не только тех, которые выбраны в качестве метрики. Сортировка этих данных показывает, какие запросы выполняются дольше всего.

1. В разделе Мониторинг выберите **журналы** для запроса сведений о журнале.

1. Выполните следующий запрос, чтобы возвратить запросы, отсортированные по длительности в миллисекундах. Наиболее длительные запросы находятся вверху.

   ```
   AzureDiagnostics
   | project OperationName, resultSignature_d, DurationMs, Query_s, Documents_d, IndexName_s
   | where OperationName == "Query.Search"
   | sort by DurationMs
   ```

   ![Сортировка запросов по продолжительности](./media/search-monitor-usage/azurediagnostics-table-sortby-duration.png "Сортировка запросов по продолжительности")

## <a name="create-a-metric-alert"></a>Создание оповещения для метрики

Оповещение метрики устанавливает пороговое значение, при котором вы получите уведомление или активируете корректирующее действие, которое вы задаете заранее. 

Для службы поиска обычно создается оповещение метрики для задержки поиска и регулирования запросов. Если вы узнаете, когда отбрасываются запросы, можно найти способы их устранения, которые снижают нагрузку или увеличивают емкость. Например, если регулируемые запросы увеличиваются во время индексирования, их можно отложить до вложенной стороны действия запроса.

При отправке ограничений конкретной конфигурации раздела реплики также полезно настроить предупреждения для пороговых значений для запросов (QPS).

1. В разделе Мониторинг выберите **оповещения** , а затем — **+ новое правило генерации оповещений**. Убедитесь, что в качестве ресурса выбрана служба поиска.

1. В разделе условие нажмите кнопку **Добавить**.

1. Настройка логики сигнала. В поле Тип сигнала выберите **метрики** , а затем выберите сигнал.

1. После выбора сигнала можно использовать диаграмму для визуализации исторических данных для информированного решения о том, как продолжить настройку условий.

1. Затем прокрутите вниз до пункта логика предупреждений. Для подтверждения концепции можно указать искусственно низкое значение для целей тестирования.

   ![Логика оповещений](./media/search-monitor-usage/alert-logic-qps.png "Логика оповещений")

1. Затем укажите или создайте группу действий. Это ответ, вызываемый при достижении порогового значения. Это может быть push-уведомление или автоматический ответ.

1. Наконец, укажите сведения о предупреждении. Назовите и опишите оповещение, присвойте значение серьезности и укажите, следует ли создавать правило в включенном или отключенном состоянии.

   ![Сведения об оповещении](./media/search-monitor-usage/alert-details.png "Сведения об оповещении")

Если вы указали уведомление по электронной почте, вы получите сообщение электронной почты от "Microsoft Azure" со строкой темы "Azure: Activated Severity: 3 `<your rule name>` ".

<!-- ## Report query data

Power BI is an analytical reporting tool useful for visualizing data, including log information. If you are collecting data in Blob storage, a Power BI template makes it easy to spot anomalies or trends. Use this link to download the template. -->

## <a name="next-steps"></a>Дальнейшие действия

Если вы еще не сделали этого, ознакомьтесь с основами мониторинга службы поиска, чтобы узнать о полном диапазоне возможностей.

> [!div class="nextstepaction"]
> [Мониторинг операций и действий в Azure Когнитивный поиск](search-monitor-usage.md)