---
title: Работа с результатами поиска
titleSuffix: Azure Cognitive Search
description: Структурирование и сортировка результатов поиска, получение числа документов и Навигация по содержимому в результатах поиска в Azure Когнитивный поиск.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 12/09/2020
ms.openlocfilehash: 182ec758a8764a959b39296163e63e800cf5108c
ms.sourcegitcommit: 273c04022b0145aeab68eb6695b99944ac923465
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2020
ms.locfileid: "97008491"
---
# <a name="how-to-work-with-search-results-in-azure-cognitive-search"></a>Работа с результатами поиска в Azure Когнитивный поиск

В этой статье объясняется, как сформулировать ответ запроса в Azure Когнитивный поиск. Структура ответа определяется параметрами в документе запрос: [Поиск](/rest/api/searchservice/Search-Documents) в REST API или [классе SearchResults](/dotnet/api/azure.search.documents.models.searchresults-1) в пакете SDK для .NET. Параметры запроса можно использовать для структурирования результирующего набора одним из следующих способов.

+ Ограничение или пакетирование количества документов в результатах (по умолчанию 50)
+ Выбор полей для включения в результаты
+ Упорядочить результаты
+ Выделение совпадающего целого или частичного термина в тексте результатов поиска

## <a name="result-composition"></a>Композиция результатов

Хотя документ поиска может состоять из большого количества полей, обычно для представления каждого документа в результирующем наборе требуется лишь несколько. В запросе добавьте `$select=<field list>` к параметру, чтобы указать, какие поля отображаются в ответе. Для включения в результат поле должно быть в индексе как доступное для **получения** . 

Поля, которые лучше подходят, включают в себя те, которые отличаются друг от друга и различают в документах, предоставляя достаточно информации для приглашения отклика «щелчок» для части пользователя. На сайте электронной коммерции может быть название продукта, описание, фирменная символика, цвет, размер, Цена и рейтинг. Для встроенного образца "Отели-Sample-index" это могут быть поля в следующем примере:

```http
POST /indexes/hotels-sample-index/docs/search?api-version=2020-06-30 
    {  
      "search": "sandy beaches",
      "select": "HotelId, HotelName, Description, Rating, Address/City"
      "count": true
    }
```

> [!NOTE]
> Если требуется включить в результат файлы изображений, например фотографию или логотип продукта, храните их за пределами Azure Когнитивный поиск, но включите поле в индекс для ссылки на URL-адрес изображения в документе поиска. Примеры индексов, поддерживающих изображения в результатах, включают демонстрационную версию **Realestate-Sample-US** , которая описывается в этом [кратком руководстве](search-create-app-portal.md), и [демонстрационное приложение Нью-Йорка City](https://aka.ms/azjobsdemo).

### <a name="tips-for-unexpected-results"></a>Советы по непредвиденным результатам

В некоторых случаях непредвиденным является содержимое, а не структура результатов. Если результаты запроса непредвиденны, можно попробовать внести эти изменения в запрос, чтобы узнать, улучшаются ли результаты:

+ Измените значение **`searchMode=any`** (по умолчанию) на, **`searchMode=all`** чтобы требовать совпадения по всем критериям, а не к любому из критериев. Это особенно важно, если запрос содержит логические операторы.

+ Поэкспериментируйте с различными лексическими анализаторами или пользовательскими анализаторами, чтобы узнать, изменились ли результаты запроса. Анализатор по умолчанию нарушает перенос слов и сокращает слова до корневых форм, что обычно повышает надежность ответа на запрос. Однако, если необходимо сохранить дефисы или если строки содержат специальные символы, может потребоваться настроить пользовательские анализаторы, чтобы убедиться, что индекс содержит маркеры в правильном формате. Дополнительные сведения см. в разделе [частичный Поиск терминов и шаблоны со специальными символами (дефисы, подстановочный знак, регулярное выражение, шаблоны)](search-query-partial-matching.md).

## <a name="paging-results"></a>Разбиение результатов по страницам

По умолчанию поисковая система возвращает до первых 50 совпадений, как определено в показателе поиска, если запрос является полнотекстовым поиском, или в произвольном порядке для запросов точного соответствия.

Чтобы получить другое количество соответствующих документов, добавьте в `$top` `$skip` запрос запрос и параметры. В следующем списке описывается логика.

+ Добавить `$count=true` , чтобы получить общее число соответствующих документов в индексе.

+ Возвращает первый набор из 15 соответствующих документов, а также общее число совпадений: `GET /indexes/<INDEX-NAME>/docs?search=<QUERY STRING>&$top=15&$skip=0&$count=true`

+ Возвращает второй набор, пропуская первые 15 для получения следующего 15: `$top=15&$skip=15` . Сделайте то же самое для третьего набора из 15: `$top=15&$skip=30`

При изменении базового индекса не гарантируется стабильность результатов запросов с разбивкой на страницы. Разбиение по страницам изменяет значение `$skip` для каждой страницы, но каждый запрос является независимым и работает с текущим представлением данных в том виде, в каком они существуют в индексе во время запроса (иными словами, кэширование или моментальный снимок результатов отсутствует, например, в базе данных общего назначения).
 
Ниже приведен пример того, как можно получить дубликаты. Предположим, что индекс имеет четыре документа:

```text
{ "id": "1", "rating": 5 }
{ "id": "2", "rating": 3 }
{ "id": "3", "rating": 2 }
{ "id": "4", "rating": 1 }
```
 
Теперь предположим, что вы хотите, чтобы результаты возвращались два раза в один раз, упорядоченные по рейтингу. Этот запрос будет выполнен для получения первой страницы результатов: `$top=2&$skip=0&$orderby=rating desc` , что приведет к следующим результатам:

```text
{ "id": "1", "rating": 5 }
{ "id": "2", "rating": 3 }
```
 
В службе Предположим, что в индекс между вызовами запроса добавляется пятый документ: `{ "id": "5", "rating": 4 }` .  Вскоре после этого вы выполните запрос для получения второй страницы: `$top=2&$skip=2&$orderby=rating desc` и получите следующие результаты:

```text
{ "id": "2", "rating": 3 }
{ "id": "3", "rating": 2 }
```
 
Обратите внимание, что документ 2 извлекается дважды. Это связано с тем, что новый документ 5 имеет большее значение для оценки, поэтому он сортирует перед документом 2 и на первой странице. Хотя такое поведение может быть неожиданным, обычно это характерно для поведения поисковой системы.

## <a name="ordering-results"></a>Упорядочение результатов

Для запросов полнотекстового поиска результаты автоматически ранжированы по показателю поиска, вычисляемому на основе частоты терминов и сходства в документе (производном от [TF-IDF](https://en.wikipedia.org/wiki/Tf%E2%80%93idf)), с более высокими показателями, которые будут искать документы, имеющие больше или более надежных совпадений в поисковом выражении. 

Поисковые баллы дают общее представление о релевантности, отражающее интенсивность совпадений относительно других документов в том же результирующем наборе. Но оценка не всегда согласована с одним запросом, поэтому при работе с запросами вы можете заметить небольшие несоответствия в порядке упорядочения документов поиска. Существует несколько объяснений, почему это может произойти.

| Причина | Описание |
|-----------|-------------|
| Изменчивости данных | Содержимое индекса зависит от того, как вы добавляете, изменяете или удаляете документы. Частота терминов изменяется при обработке обновлений индекса с течением времени, что влияет на результаты поиска соответствующих документов. |
| Несколько реплик | Для служб, использующих несколько реплик, запросы к каждой реплике выдаются параллельно. Статистика индекса, используемая для вычисления оценки результатов поиска, вычисляется отдельно для каждой реплики, а результаты объединяются и упорядочиваются в ответе на запрос. Реплики в основном являются зеркалами друг друга, но статистика может отличаться из-за небольших различий в состоянии. Например, одна реплика могла удалить документы, участвующие в статистике, которые были объединены из других реплик. Как правило, различия в статистике за каждую реплику более заметны в небольших индексах. |
| Идентичные результаты | Если несколько документов имеют одинаковый рейтинг, то один из них может быть первым.  |

### <a name="how-to-get-consistent-ordering"></a>Как получить последовательный порядок

Если последовательный порядок является требованием приложения, можно явно определить выражение [ **`$orderby`** ] (Query-OData-Filter-OrderBy-Syntax.md) для поля. **`sortable`** Для упорядочивания результатов можно использовать только поля, индексируемые как. Поля, обычно используемые в **`$orderby`** полях включить оценку, дату и расположение, если указать значение **`orderby`** параметра, чтобы включить имена полей и вызовы [**`geo.distance()` функции**](query-odata-filter-orderby-syntax.md) для геопространственных значений.

Другой подход, который способствует согласованности, использует [Пользовательский профиль оценки](index-add-scoring-profiles.md). Профили оценки обеспечивают более полный контроль ранжирования элементов в результатах поиска с возможностью увеличения соответствий, найденных в конкретных полях. Дополнительная логика оценки может помочь переопределить незначительные различия между репликами, так как оценки поиска для каждого документа находятся далеко друг от друга. Для этого подхода рекомендуется использовать [алгоритм ранжирования](index-ranking-similarity.md) .

## <a name="hit-highlighting"></a>Выделение совпадений

Выделение совпадений означает форматирование текста (например, выделение полужирным или желтым цветом), применяемое для сопоставления терминов в результате, что позволяет легко обнаружить совпадение. Инструкции по выделению совпадений предоставляются в [запросе](/rest/api/searchservice/search-documents). 

Чтобы включить выделение вхождений, добавьте, `highlight=[comma-delimited list of string fields]` чтобы указать, какие поля будут использовать выделение. Выделение полезно для более длинных полей содержимого, таких как поле описания, где совпадение не очевидно сразу. Только определения полей, помеченные как уточняющие **запрос** для выделения совпадений.

По умолчанию Когнитивный поиск Azure возвращает до пяти подсветов на каждое поле. Это число можно изменить, добавив к полю тире, за которым следует целое число. Например, `highlight=Description-10` возвращает до 10 выделений для соответствующего содержимого в поле Описание.

Форматирование применяется к запросам целых терминов. Тип форматирования определяется тегами, и `highlightPreTag` `highlightPostTag` код обрабатывает ответ (например, применение полужирного шрифта или желтого фона).

В следующем примере термины "рыже-", "песок", "пляжах", "пляже" в поле описания отмечены для выделения. Запросы, которые активируют расширение запросов в механизме, например поиск нечетких и подстановочных знаков, имеют ограниченную поддержку выделения совпадений.

```http
GET /indexes/hotels-sample-index/docs/search=sandy beaches&highlight=Description?api-version=2020-06-30 
```

```http
POST /indexes/hotels-sample-index/docs/search?api-version=2020-06-30 
    {  
      "search": "sandy beaches",  
      "highlight": "Description"
    }
```

### <a name="new-behavior-starting-july-15"></a>Новое поведение (начиная с 15 июля)

Службы, созданные после 15 июля 2020, обеспечивают различные возможности выделения. Службы, созданные до этой даты, не изменятся в соответствии с их поведением при выделении. 

С новым поведением:

* Будут возвращены только фразы, соответствующие запросу полной фразы. Запрос "Super миску" возвратит примерно такие элементы:

    ```html
    '<em>super bowl</em> is super awesome with a bowl of chips'
    ```
  Обратите внимание, что термин *миску микросхем* не имеет выделения, так как он не соответствует полной фразе.

При написании кода клиента, который реализует выделение совпадений, учитывайте это изменение. Обратите внимание, что это не повлияет на вас, пока не будет создана совершенно новая служба поиска.

## <a name="next-steps"></a>Следующие шаги

Чтобы быстро создать страницу поиска для клиента, рассмотрите следующие варианты:

+ [Генератор приложений](search-create-app-portal.md)на портале создает HTML-страницу с панелью поиска, структурной навигацией и областью результатов, включающей изображения.
+ [Создание первого приложения на C#](tutorial-csharp-create-first-app.md) — это руководство, которое создает функциональный клиент. Пример кода демонстрирует запросы с разбивкой на страницы, выделение совпадений и сортировку.

В состав нескольких примеров кода входит интерфейс веб-интерфейса, который можно найти по следующему адресу: учебное [приложение в Нью-Йорке](https://aka.ms/azjobsdemo), [пример кода JavaScript с демонстрационным веб-узлом](https://github.com/liamca/azure-search-javascript-samples)и [когнитивесеарчфронтенд](https://github.com/LuisCabrer/CognitiveSearchFrontEnd).