---
title: Мониторинг использования ресурсов и метрик запросов для службы поиска с помощью Поиска Azure
description: Включение ведения журнала, получение метрик действий для запросов, данных об использовании ресурсов и других системных данных из службы "Поиск Azure".
author: HeidiSteen
manager: cgronlun
tags: azure-portal
services: search
ms.service: search
ms.devlang: na
ms.topic: conceptual
ms.date: 04/04/2019
ms.author: heidist
ms.custom: seodec2018
ms.openlocfilehash: f4a0cba18f27c9cabfc03d1934469e6899c5cd18
ms.sourcegitcommit: c174d408a5522b58160e17a87d2b6ef4482a6694
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2019
ms.locfileid: "59010419"
---
# <a name="monitor-resource-consumption-and-query-activity-in-azure-search"></a>Мониторинг использования ресурсов и обработки запросов в Поиске Azure

На странице "Обзор" службы "Поиск Azure" можно просмотреть системные данные об использовании ресурсов, метриках запросов и доступных квотах для создания дополнительных индексов, индексаторов и источников данных. Крое того, с помощью портала можно настроить Log Analytics или другой ресурс для постоянного хранения коллекции данных. 

Настройка журналов удобна для самостоятельной диагностики и сохранения журнала операций. На внутреннем уровне журналы существуют в серверной части короткое время, достаточное для наблюдения и анализа на случай обращения в службу поддержки. Если требуется контроль над данными журналов и доступ к ним, следует установить одно из решений, описанных в этой статье.

В этой статье вы узнаете о возможностях мониторинга, о том, как включить ведение журнала и хранилище журналов, а также о том, как просмотреть содержимое журнала.

## <a name="metrics-at-a-glance"></a>Краткий обзор метрик

В разделах **Использование** и **Мониторинг**, встроенных в страницу "Обзор", содержатся сведения об использовании ресурсов и метриках выполнения запросов. Эта информация становится доступной, как только вы начинаете использовать службу, и не требует каких-либо настроек. Эта страница обновляется каждые несколько минут. Если вы принимаете решения о том, [какой уровень выбрать для производственных рабочих нагрузок](search-sku-tier.md), или о том, следует ли [изменить число активных реплик и секций](search-capacity-planning.md), эти метрики помогут вам, так как они показывают, насколько быстро используются ресурсы и насколько хорошо текущая конфигурация справляется с текущей нагрузкой.

На вкладке **Использование** отображается доступность ресурсов в соответствии с текущими [ограничениями](search-limits-quotas-capacity.md). На следующем рисунке показана служба ценовой категории "Бесплатный", которая ограничена 3 объектами каждого типа и 50 МБ памяти. Службы ценовых категории "Базовый" и "Стандартный" обеспечивают больше ресурсов, а при увеличении числа секций максимальный размер хранилища пропорционально возрастает.

![Данные об использовании относительно действующих ограничений](./media/search-monitor-usage/usage-tab.png
 "Данные об использовании относительно действующих ограничений")

## <a name="queries-per-second-qps-and-other-metrics"></a>Число запросов в секунду (QPS) и другие метрики

На вкладке **Мониторинг** показаны значения скользящего среднего для метрик, например *числа запросов в секунду* (QPS) для поиска, объединенные по минутам. 
*Задержка поиска*: время, потребовавшееся службе поиска для обработки запросов поиска (данные объединяются по минутам). *Процент регулируемых поисковых запросов* (метрика не показана): процент отрегулированных запросов поиска (данные также объединяются по минутам).

Эти числа являются приблизительными и дают общее представление о том, насколько хорошо система обслуживает запросы. Фактическое значение QPS может быть выше или ниже, чем число, показанное на портале.

![Действие "Число запросов в секунду"](./media/search-monitor-usage/monitoring-tab.png "Действие \"Число запросов в секунду\"")

## <a name="activity-logs"></a>Журналы действий

В **журнал действий** записываются сведения из Azure Resource Manager. Например, в журнале действий можно найти сведения о создании или удалении службы, обновлении группы ресурсов, проверке доступности имени или получении ключа доступа к службе для обработки запроса. 

Вы можете получить доступ к **журналу действий** из области навигации слева, с помощью уведомления на панели команд в верхнем окне или на странице **Диагностика и решение проблем**.

Для внутренних задач службы, таких как создание индекса или удаление источника данных, для каждого запроса отображаются универсальные уведомления, например "Get Admin Key" (Получение ключа администратора), но не само действие. Чтобы получить сведения такого уровня, необходимо включить надстройку решения для мониторинга.

## <a name="add-on-monitoring-solutions"></a>Надстройки для мониторинга

Поиск Azure не хранит данные, не относящиеся к управляемым им объектам. Это означает, данные журнала нужно хранить во внешнем хранилище. Если вы хотите хранить данные журнала, то можете настроить любой из приведенных ниже ресурсов. 

В следующей таблице сравниваются варианты хранения журналов и добавления глубокого мониторинга операций службы и рабочих нагрузок запросов с помощью Application Insights.

| Ресурс | Область использования |
|----------|----------|
| [Application Insights](https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview) | Зарегистрированные события и метрики запросов, на основе схем ниже соотносятся с событиями пользователя в приложении. Это единственное решение, которое учитывает действия пользователя или сигналы, сопоставляя события поиска, инициированного пользователем, в отличие от фильтра запросов, отправляемого кодом приложения. Чтобы использовать этот подход, скопируйте и вставьте код инструментирования в исходные файлы, чтобы передавать сведения о запросах в Application Insights. Дополнительные сведения см. в статье [Что такое аналитика поискового трафика?](search-traffic-analytics.md) |
| [Журналы Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/log-query/log-query-overview) | Зарегистрированные события и метрики запросов, на указанные ниже схемы в основе. События записываются в рабочую область Log Analytics. Можно выполнять запросы к рабочей области, чтобы получить подробные сведения из журнала. Дополнительные сведения см. в разделе [приступить к работе с журналами Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-viewdata) |
| [Хранилище BLOB-объектов](https://docs.microsoft.com/azure/storage/blobs/storage-blobs-overview) | Зарегистрированные события и метрики запросов, на указанные ниже схемы в основе. События записываются в контейнер больших двоичных объектов и хранятся в JSON-файлах. Используйте редактор JSON, чтобы просмотреть содержимое такого файла.|
| [Концентратор событий](https://docs.microsoft.com/azure/event-hubs/) | Зарегистрированные события и метрики запросов в соответствии со схемами, описанными в этой статье. Выберите этот вариант в качестве альтернативной службы сбора данных для очень больших журналов. |

Журналы Azure Monitor и хранилище BLOB-объектов доступны как бесплатные Общая служба, таким образом, чтобы его можно опробовать бесплатно в течение времени существования подписки Azure. Вы можете бесплатно зарегистрироваться в Application Insights и использовать это решение до тех пор, пока размер данных приложения находится в заданных пределах (чтобы узнать больше, перейдите на [страницу цен](https://azure.microsoft.com/pricing/details/monitor/)).

Следующий раздел содержит пошаговые инструкции по включению и использованию хранилища BLOB-объектов Azure для сбора данных журнала, созданных операциями Поиска Azure, и обращения к этим данным.

## <a name="enable-logging"></a>Включение ведения журналов

Ведение журнала для индексирования и рабочих нагрузок запросов по умолчанию отключено и зависит от установленных надстроек для инфраструктуры ведения журнала и долгосрочного внешнего хранилища. В службе "Поиск Azure" хранятся только данные объектов, которые она создает и которыми она управляет, поэтому журналы должны храниться в другом месте.

В этом разделе вы узнаете, как использовать хранилище BLOB-объектов для хранения записанных в журнал событий и данных метрик.

1. Если у вас еще нет учетной записи хранения, [создайте ее](https://docs.microsoft.com/azure/storage/common/storage-quickstart-create-account). Ее можно поместить в ту же группу ресурсов, что и Поиск Azure, чтобы упростить очистку, если вы захотите удалить все ресурсы, используемые в этом упражнении.

2. Откройте страницу "Обзор" для службы поиска. Прокрутите вниз область навигации слева до раздела **Мониторинг** и щелкните **Включить мониторинг**.

   ![Включение мониторинга](./media/search-monitor-usage/enable-monitoring.png "Включение мониторинга")

3. Выберите данные для экспорта: журналы, метрики или оба варианта. Можно скопировать его в учетную запись хранения, отправить его в концентратор событий или экспортировать его в Azure Monitor журналы.

   Для архивации данных в хранилище BLOB-объектов должна существовать только учетная записи хранения. Контейнеры и большие двоичные объекты будут создаваться при экспорте данных журнала.

   ![Настройка архивного хранилища BLOB-объектов](./media/search-monitor-usage/configure-blob-storage-archive.png "Настройка архивного хранилища BLOB-объектов")

4. Сохраните профиль.

5. Протестируйте ведение журнала, создавая или удаляя объекты (при этом создаются события журнала) и отправляя запросы (они создают данные метрик). 

Ведение журнала будет включено после сохранения профиля. Контейнеры создаются только при наличии действия для записи в журнал или измерения. При копировании в учетную запись хранения данные представляются в формате JSON и размещаются в двух контейнерах:

* insights-logs-operationlogs: для поиска журналов трафика
* insights-metrics-pt1m: для метрик

**Он принимает один час, прежде чем контейнеры будут отображаться в хранилище BLOB-объектов. Имеется один большой двоичный объект, в час, каждый контейнер.**

Для просмотра этих файлов можно использовать [Visual Studio Code](#download-and-open-in-visual-studio-code) или другой редактор JSON. 

### <a name="example-path"></a>Пример пути

```
resourceId=/subscriptions/<subscriptionID>/resourcegroups/<resourceGroupName>/providers/microsoft.search/searchservices/<searchServiceName>/y=2018/m=12/d=25/h=01/m=00/name=PT1H.json
```

## <a name="log-schema"></a>Схема журнала
Структура больших двоичных объектов, содержащих журналы трафика службы поиска, описана в этом разделе. Каждый большой двоичный объект имеет один корневой объект под названием **records**, который содержит массив объектов журнала. Каждый большой двоичный объект содержит записи о всех операциях, которые выполнялась в течение одного часа.

| ИМЯ | type | Пример | Примечания |
| --- | --- | --- | --- |
| Twitter в режиме реального |Datetime |"2018-12-07T00:00:43.6872559Z" |Метка времени операции |
| ResourceId |строка |"/SUBSCRIPTIONS/11111111-1111-1111-1111-111111111111/<br/>RESOURCEGROUPS/DEFAULT/PROVIDERS/<br/>  MICROSOFT.SEARCH/SEARCHSERVICES/SEARCHSERVICE" |Идентификатор вашего ресурса |
| operationName |строка |"Query.Search" |Имя операции |
| operationVersion |строка |"2017-11-11" |Используемая версия API |
| category |строка |"OperationLogs" |константа |
| resultType |строка |Success |Возможные значения: Success или Failure |
| resultSignature |int |200 |Код результата HTTP |
| durationMS |int |50 |Время выполнения операции в миллисекундах |
| properties |object |См. следующую таблицу |Объект, содержащий данные об операции |

**Схема свойств**

| ИМЯ | type | Пример | Примечания |
| --- | --- | --- | --- |
| ОПИСАНИЕ |строка |"GET /indexes('content')/docs" |Конечная точка операции |
| Запрос |строка |"?search=AzureSearch&$count=true&api-version=2017-11-11" |Параметры запроса |
| Документы |int |42 |Количество обработанных документов |
| IndexName |строка |"testindex" |Имя индекса, связанного с операцией |

## <a name="metrics-schema"></a>Схема метрик

Метрики записываются для запросов.

| ИМЯ | type | Пример | Примечания |
| --- | --- | --- | --- |
| ResourceId |строка |"/SUBSCRIPTIONS/11111111-1111-1111-1111-111111111111/<br/>RESOURCEGROUPS/DEFAULT/PROVIDERS/<br/> MICROSOFT.SEARCH/SEARCHSERVICES/SEARCHSERVICE" |Идентификатор вашего ресурса |
| metricName |строка |"Latency" |имя метрики |
| time |Datetime |"2018-12-07T00:00:43.6872559Z" |метка времени операции |
| average |int |64 |Среднее количество необработанных выборок в течение интервала времени метрики |
| minimum |int |37 |Минимальное количество необработанных выборок в течение интервала времени метрики |
| maximum |int |78 |Максимальное количество необработанных выборок в течение интервала времени метрики |
| total |int |258 |Общее количество необработанных выборок в течение интервала времени метрики |
| count |int |4. |Количество необработанных выборок, использованных для создания метрики |
| timegrain |строка |"PT1M" |Интервал времени в формате метрики ISO 8601 |

Все метрики передают данные с интервалом в одну минуту. Каждая метрика отражает минимальное, максимальное и среднее значения за минуту.

Для метрики SearchQueriesPerSecond минимальным является наименьшее значение числа поисковых запросов в секунду, которое было зарегистрировано за эту минуту. То же относится и к максимальному значению. Средним является совокупное значение за всю минуту.
Представьте такой сценарий: в течение одной минуты может быть одна секунда высокой загрузки, определяющая максимальное значение для SearchQueriesPerSecond, за которой следует 58 секунд средней загрузки, и наконец — одна секунда всего с одним запросом, который определяет минимальное значение.

Для ThrottledSearchQueriesPercentage минимальное, максимальное, среднее и общее значения одинаковы, так как это процент запросов поиска, которые были отрегулированы, от общего числа запросов поиска за одну минуту.

## <a name="download-and-open-in-visual-studio-code"></a>Скачивание и открытие в Visual Studio Code

Для просмотра файла журнала можно использовать любой редактор JSON. Если у вас его нет, мы рекомендуем [Visual Studio Code](https://code.visualstudio.com/download).

1. Откройте колонку "Учетная запись хранения" на портале Azure. 

2. В области навигации слева щелкните **Большие двоичные объекты**. Должны отобразиться контейнеры **insights-logs-operationlogs** и **insights-metrics-pt1m**. Эти контейнеры созданы Поиском Azure при экспорте данных журнала в хранилище BLOB-объектов.

3. Разворачивайте иерархию папок, пока не достигнете JSON-файла.  Используйте контекстное меню для скачивания файла.

Откройте скачанный файл в редакторе JSON, чтобы просмотреть содержимое.

## <a name="use-system-apis"></a>Использование системных API
REST API Поиска Azure и пакет SDK для .NET Поиска Azure обеспечивают программный доступ к метрикам служб, данным индекса и индексаторов, а также количеству документов.

* [Получение статистики службы](/rest/api/searchservice/get-service-statistics)
* [Получение статистики индексов](/rest/api/searchservice/get-index-statistics)
* [Подсчет документов](/rest/api/searchservice/count-documents)
* [Получение состояния индексатора](/rest/api/searchservice/get-indexer-status)

Сведения о включении мониторинга с помощью PowerShell или Azure CLI см. в документации [здесь](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs#how-to-enable-collection-of-diagnostic-logs).

## <a name="next-steps"></a>Дальнейшие действия

Более подробные сведения об администрировании службы поиска приведены в статье [Администрирование службы поиска Azure на портале Azure](search-manage.md), а рекомендации по настройке — в статье [Рекомендации по производительности и оптимизации Поиска Azure](search-performance-optimization.md).