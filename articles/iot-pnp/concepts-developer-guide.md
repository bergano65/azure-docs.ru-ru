---
title: Руководством для разработчиков. Предварительная версия IoT Plug and Play | Документация Майкрософт
description: Описание моделирования устройств для разработчиков IoT Plug and Play
author: dominicbetts
ms.author: dobett
ms.date: 07/05/2019
ms.topic: conceptual
ms.service: iot-pnp
services: iot-pnp
ms.openlocfilehash: 6d5247454fe65e5539a2401330192f1db9a65114
ms.sourcegitcommit: b3bad696c2b776d018d9f06b6e27bffaa3c0d9c3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2019
ms.locfileid: "69880570"
---
# <a name="iot-plug-and-play-preview-modeling-developer-guide"></a>Руководством для разработчиков для предварительной версии Plug and Play IoT

Предварительная версия IoT Plug and Play позволяет создавать устройства, которые объявляют свои возможности для приложений Azure IoT. Устройства IoT Plug and Play не нуждаются в ручной настройке, когда клиент подключает их к приложениям с поддержкой Интернета вещей Plug and Play. IoT Central является примером приложения с поддержкой Plug and Play IoT.

Для создания устройства Plug and Play IoT необходимо создать описание устройства. Описание выполняется с помощью простого языка определения, именуемого Digital двойников Definition Language (ДТДЛ).

## <a name="device-capability-model"></a>Модель возможностей устройства

С помощью ДТДЛ вы создадите _модель возможностей устройства_ для описания частей устройства. Типичное устройство Интернета вещей состоит из:

- Пользовательские части — это вещи, которые делают устройство уникальным.
- Стандартные части — это вещи, общие для всех устройств.

Эти части называются _интерфейсами_ в модели возможностей устройства. Интерфейсы определяют сведения о каждой части, реализуемой устройством.

В следующем примере показана модель возможностей устройства для устройства термостата:

```json
{
  "@id": "urn:example:Thermostat_T_1000:1",
  "@type": "CapabilityModel",
  "implements": [
    {
      "name": "thermostat",
      "schema": "urn:example:Thermostat:1"
    },
    {
      "name": "urn_azureiot_deviceManagement_DeviceInformation",
      "schema": "urn:azureiot:deviceManagement:DeviceInformation:1"
    }
  ],
  "@context": "http://azureiot.com/v1/contexts/CapabilityModel.json"
}
```

Модель возможностей содержит некоторые обязательные поля:

- `@id`: уникальный идентификатор в виде простого универсального имени ресурса.
- `@type`: объявляет, что этот объект является моделью возможностей.
- `@context`: указывает версию ДТДЛ, используемую для модели возможностей.
- `implements`: перечисляет интерфейсы, реализуемые устройством.

Каждая запись в списке интерфейсов в разделе Implements имеет:

- `name`: Программное имя интерфейса.
- `schema`: интерфейс, реализуемый моделью возможностей.

Существуют дополнительные необязательные поля, которые можно использовать для добавления дополнительных сведений в модель возможностей, например отображаемое имя и описание. Интерфейсы, объявляемые в модели возможностей, можно рассматривать как компоненты устройства. В общедоступной предварительной версии список интерфейсов может иметь только одну запись на схему.

## <a name="interface"></a>Интерфейс

С ДТДЛ вы описываете возможности устройства с помощью интерфейсов. Интерфейсы описывают _Свойства_, телеметрию и _команды_ , которые компонент реализует:

- `Properties`. Свойства — это поля данных, которые представляют состояние устройства. Используйте свойства, чтобы представить устойчивое состояние устройства, например состояние кулант насоса. Свойства могут также представлять базовые свойства устройства, такие как версия встроенного по устройства. Можно объявить свойства только для чтения или для записи.
- `Telemetry`. Поля телеметрии представляют измерения датчиков. Когда устройство принимает измерения датчика, оно должно отправить событие телеметрии, содержащее данные датчика.
- `Commands`. Команды представляют методы, которые пользователи устройства могут выполнять на устройстве. Например, команда reset или команда для переключения вентилятора.

В следующем примере показан интерфейс для устройства термостата:

```json
{
  "@id": "urn:example:Thermostat:1",
  "@type": "Interface",
  "contents": [
    {
      "@type": "Telemetry",
      "name": "temperature",
      "schema": "double"
    }
  ],
  "@context": "http://azureiot.com/v1/contexts/Interface.json"
}
```

У интерфейса есть несколько обязательных полей:

- `@id`: уникальный идентификатор в виде простого универсального имени ресурса.
- `@type`: объявляет, что этот объект является интерфейсом.
- `@context`: указывает версию ДТДЛ, используемую для интерфейса.
- `contents`: перечисляет свойства, данные телеметрии и команды, составляющие устройство.

В этом простом примере имеется только одно поле телеметрии. Минимальное описание поля имеет:

- `@type`: указывает тип возможности: `Telemetry`, `Property`или `Command`.
- `name`: предоставляет имя значения телеметрии.
- `schema`: указывает тип данных для телеметрии. Это значение может быть примитивным типом, например Double, Integer, Boolean или String. Также поддерживаются сложные типы объектов, массивы и карты.

Другие необязательные поля, такие как отображаемое имя и описание, позволяют добавлять дополнительные сведения в интерфейс и возможности.

### <a name="properties"></a>Свойства

По умолчанию свойства доступны только для чтения. Свойства только для чтения означают, что устройство сообщает значение свойства в центре Интернета вещей. Центр Интернета вещей не может установить значение свойства, доступного только для чтения.

Можно также пометить свойство как записываемое в интерфейсе. Устройство может получить обновление для записываемого свойства из центра Интернета вещей, а также для отчетов об обновлениях значений свойств в центре.

Устройства не обязательно должны быть подключены для задания значений свойств. Обновленные значения передаются при следующем подключении устройства к концентратору. Это поведение применимо как к свойствам только для чтения, так и к записываемым.

Не используйте свойства для отправки данных телеметрии с устройства. Например, свойство ReadOnly, например `temperatureSetting=80` , должно означать, что для температуры устройства установлено значение 80, а устройство пытается получить или остаться в этой температуре.

Для свойств, доступных для записи, приложение устройства возвращает код состояния требуемого состояния, версию и описание, чтобы указать, получил ли он значение свойства и применял его.

### <a name="telemetry"></a>Телеметрия

По умолчанию центр Интернета вещей направляет все сообщения телеметрии с устройств во [встроенную конечную точку службы (**сообщения или события**)](../iot-hub/iot-hub-devguide-messages-read-builtin.md) , совместимую с [концентраторами событий](https://azure.microsoft.com/documentation/services/event-hubs/).

Вы можете использовать [пользовательские конечные точки и правила маршрутизации центра Интернета вещей](../iot-hub/iot-hub-devguide-messages-d2c.md) для отправки данных телеметрии в другие назначения, такие как хранилище BLOB-объектов или другие концентраторы событий. Правила маршрутизации используют свойства сообщений для выбора сообщений.

### <a name="commands"></a>Команды

Команды синхронные или асинхронные. По умолчанию Синхронная команда должна выполняться в течение 30 секунд, а при получении команды устройство должно быть подключено. Если устройство отвечает вовремя или устройство не подключено, команда завершается ошибкой.

Используйте асинхронные команды для выполнения длительных операций. Устройство отправляет сведения о ходе выполнения с помощью сообщений телеметрии. Эти сообщения о ходе выполнения имеют следующие свойства заголовка:

- `iothub-command-name`— имя команды, `UpdateFirmware`например.
- `iothub-command-request-id`: идентификатор запроса, созданный на стороне сервера и отправленный на устройство при первом вызове.
- `iothub-interface-id`.  Идентификатор интерфейса, в котором определена эта команда, `urn:example:AssetTracker:1`например.
 `iothub-interface-name`— имя экземпляра этого интерфейса, например `myAssetTracker`.
- `iothub-command-statuscode`— код состояния, возвращенный с устройства, например `202`.

## <a name="register-a-device"></a>Регистрация устройства

Plug and Play IoT упрощает объявление возможностей устройства. После подключения устройства к центру Интернета вещей с помощью Plug and Play IoT необходимо зарегистрировать модель возможностей устройства. Регистрация позволяет клиентам использовать возможности Plug and Play Интернета вещей на вашем устройстве.

В этом руководство показано, как зарегистрировать устройство с помощью пакета SDK для устройств Azure IoT для C.

Для каждого интерфейса, реализуемого устройством, необходимо создать интерфейс и подключить его к реализации.

Для интерфейса термостата, показанного ранее, с помощью пакета SDK для C вы создадите интерфейс термостата и подключится к его реализации:

```c
DIGITALTWIN_INTERFACE_HANDLE thermostatInterfaceHandle;

DIGITALTWIN_CLIENT_RESULT result = DigitalTwin_InterfaceClient_Create(
    "thermostat",
    "urn:example:Thermostat:1",
    null, null,
    &thermostatInterfaceHandle);

result = DigitalTwin_Interface_SetCommandsCallbacks(
    thermostatInterfaceHandle,
    commandsCallbackTable);

result = DigitalTwin_Interface_SetPropertiesUpdatedCallbacks(
    thermostatInterfaceHandle,
    propertiesCallbackTable);

```

Повторите этот код для каждого интерфейса, реализуемого устройством.

После создания интерфейса Зарегистрируйте модель возможностей устройства и интерфейсы с помощью центра Интернета вещей:

```c
DIGITALTWIN_INTERFACE_CLIENT_HANDLE interfaces[2];
interfaces[0] = thermostatInterfaceHandle;
interfaces[1] = deviceInfoInterfaceHandle;

result = DigitalTwin_DeviceClient_RegisterInterfacesAsync(
    digitalTwinClientHandle, // The handle for the connection to Azure IoT
    "urn:example:Thermostat_T_1000:1",
    interfaceHandleList, 2,
    null, null);
```

## <a name="use-a-device"></a>Использование устройства

Plug and Play IoT позволяет использовать устройства, которые зарегистрировали свои возможности в центре Интернета вещей. Например, можно напрямую обращаться к свойствам и командам устройства.

Чтобы использовать устройство IoT Plug and Play, подключенное к центру Интернета вещей, используйте центр Интернета вещей REST API или один из пакетов SDK для языка Интернета вещей. В следующих примерах используется центр Интернета вещей REST API.

Чтобы получить значение свойства устройства, например версия встроенного по (`fwVersion`) `DeviceInformation` в интерфейсе термостата, используется цифровая двойников REST API.

При вызове `t-123`устройства термостата Вы получаете все свойства, реализованные устройством, с помощью вызова REST API Get:

```REST
GET /digitalTwins/t-123/interfaces
```

Как правило, доступ ко всем свойствам осуществляется с помощью этого `{device-id}` шаблона REST API, где — это идентификатор устройства:

```REST
GET /digitalTwins/{device-id}/interfaces
```

Если известно имя интерфейса и требуется получить свойства для этого интерфейса, запросите его по имени.

```REST
GET /digitalTwins/t-123/interfaces/info
```

Как правило, доступ к свойствам определенного интерфейса можно получить с помощью этого шаблона REST API `device-id` , где — это идентификатор устройства, `{interface-name}` а — имя интерфейса:

```REST
GET /digitalTwins/{device-id}/interfaces/{interface-name}
```

Вы можете напрямую вызывать команды для устройств IoT Plug and Play. Если в `t-123` `restart` интерфейсе устройства имеется команда, ее можно вызвать с помощью вызова REST API POST: `Thermostat`

```REST
POST /digitalTwins/t-123/interfaces/thermostat/commands/restart
```

В общем случае команды можно вызывать с помощью этого шаблона REST API:

- `device-id`— идентификатор устройства.
- `interface-name`: имя интерфейса из раздела Implements модели возможностей устройства.
- `command-name`: имя команды.

```REST
/digitalTwins/{device-id}/interfaces/{interface-name}/commands/{command-name}
```

## <a name="next-steps"></a>Следующие шаги

Теперь, когда вы узнали о моделировании устройств, ниже приведены некоторые дополнительные ресурсы.

- [Язык определения цифровых двойника (ДТДЛ)](https://aka.ms/DTDL)
- [Пакет SDK для устройства C](https://docs.microsoft.com/azure/iot-hub/iot-c-sdk-ref/)
- [REST API IoT](https://docs.microsoft.com/rest/api/iothub/device)
