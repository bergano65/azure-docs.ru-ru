---
title: Использование службы "Аналитика временных рядов Azure" для хранения и анализа данных телеметрии устройств Azure IoT Plug and Play
description: Настройка среды службы "Аналитика временных рядов" и подключение центра Интернета вещей для просмотра и анализа данных телеметрии устройств IoT Plug and Play.
author: lyrana
ms.author: lyhughes
ms.date: 10/14/2020
ms.topic: tutorial
ms.service: iot-pnp
services: iot-pnp
ms.openlocfilehash: 5491df61a1198e8eee4ba4701ccfc56154ec75eb
ms.sourcegitcommit: 80c1056113a9d65b6db69c06ca79fa531b9e3a00
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/09/2020
ms.locfileid: "96905102"
---
# <a name="preview-tutorial-create-and-configure-a-time-series-insights-gen2-environment"></a>Руководство по работе с предварительной версией. Создание и настройка среды "Аналитика временных рядов" 2-го поколения

Из этого руководства вы узнаете, как создать и настроить среду службы ["Аналитика временных рядов Azure" 2-го поколения](../time-series-insights/overview-what-is-tsi.md) для интеграции с решением IoT Plug and Play. Аналитика временных рядов позволяет собирать, обрабатывать, хранить, запрашивать и визуализировать данные временных рядов в масштабе Интернета вещей.

Сначала вы подготовите среду службы "Аналитика временных рядов" и подключите центр Интернета вещей в качестве источника событий с потоковой передачей данных. Затем вы выполните синхронизацию модели, чтобы создать [модель временных рядов](../time-series-insights/concepts-model-overview.md). Вы примените файлы с примерами на [языке определения цифровых двойников (DTD)](https://github.com/Azure/opendigitaltwins-dtdl), которые использовались для устройств контроллера температуры и термостата.

> [!NOTE]
> Интеграция между Аналитикой временных рядов и IoT Plug and Play предоставляется в предварительной версии. Метод сопоставления моделей устройств DTDL с моделями Аналитики временных рядов в будущем может измениться. 

## <a name="prerequisites"></a>Предварительные требования

[!INCLUDE [iot-pnp-prerequisites](../../includes/iot-pnp-prerequisites.md)]

На этом этапе у вас есть следующее:

* Центр интернета вещей Azure.
* Экземпляр Службы подготовки устройств к добавлению в Центр Интернета вещей, связанный с центром Интернета вещей. В экземпляре Службы подготовки устройств к добавлению в Центр Интернета вещей должна существовать индивидуальная регистрация для устройства IoT Plug and Play.
* Подключение однокомпонентного или многокомпонентного устройства, которое имитирует потоковые данные, к центру Интернета вещей.

Чтобы не устанавливать Azure CLI локально, можно использовать Azure Cloud Shell для настройки облачных служб.

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

## <a name="prepare-your-event-source"></a>Подготовка источника событий

Центр Интернета вещей, который вы создали ранее, будет выполнять роль [источника событий](../time-series-insights/concepts-streaming-ingestion-event-sources.md) в среде службы "Аналитика временных рядов".

> [!IMPORTANT]
> Отключите все существующие маршруты Центра Интернета вещей. Существует известная проблема с использованием центра Интернета вещей при настроенной [маршрутизации](../iot-hub/iot-hub-devguide-messages-d2c.md#routing-endpoints). Временно отключите все конечные точки маршрутизации. Когда центр Интернета вещей будет подключен к службе "Аналитика временных рядов", можно будет снова включить конечные точки маршрутизации.

Создайте в центре Интернета вещей уникальную группу потребителей, которую будет использовать Аналитика временных рядов. В следующем примере замените значение `my-pnp-hub` именем использованного ранее центра Интернета вещей:

```azurecli-interactive
az iot hub consumer-group create --hub-name my-pnp-hub --name tsi-consumer-group
```

## <a name="choose-a-time-series-id"></a>Выбор идентификатора временных рядов

При подготовке среды службы "Аналитика временных рядов" вам нужно выбрать *идентификатор временного ряда*. Важно сразу выбрать правильный идентификатор временного ряда. Это свойство является неизменяемым, то есть вы не сможете изменить его после установки. Идентификатор временного ряда аналогичен ключу секции базы данных. Он выполняет роль первичного ключа для модели временных рядов. Дополнительные сведения см. в статье [Лучшие методики при выборе идентификатора временного ряда](../time-series-insights/how-to-select-tsid.md).

Пользователю IoT Plug and Play в качестве идентификатора временного ряда следует указывать _составной ключ_, который включает `iothub-connection-device-id` и `dt-subject`. Центр Интернета вещей добавляет эти системные свойства, которые содержат идентификатор устройства IoT Plug and Play и имена компонентов устройств, соответственно.

Даже если в ваших моделях устройств IoT Plug and Play сейчас не используются компоненты, укажите `dt-subject` как часть составного ключа, чтобы можно было использовать компоненты в будущем. Так как идентификатор временного ряда является неизменяемым, корпорация Майкрософт рекомендует включить этот параметр, так как он может понадобится в будущем.

> [!NOTE]
> Примеры в этой статье предназначены для устройств `TemperatureController` с несколькими компонентами. Но основные концепции остаются неизменными и для устройств `Thermostat` без компонентов.

## <a name="provision-your-time-series-insights-environment"></a>Подготовка среды службы "Аналитика временных рядов"

В этом разделе описано, как подготовить среду службы "Аналитика временных рядов Azure" 2-го поколения к работе.

С помощью приведенной ниже команды выполните следующие действия:

* Создание учетной записи хранения Azure для [холодного хранилища ](../time-series-insights/concepts-storage.md#cold-store) в вашей среде. Эта учетная запись предназначена для долгосрочного хранения и анализа исторических данных.
  * Замените в коде значение `mytsicoldstore` уникальным именем учетной записи для холодного хранилища.
* Создание среды 2-го поколения службы "Аналитика временных рядов Azure". Среда будет создана с теплым хранилищем, для которого задан срок хранения семь дней. Также добавляется учетная запись холодного хранилища для неограниченно долгого хранения.
  * Замените в коде значение `my-tsi-env` уникальным именем среды службы "Аналитика временных рядов".
  * Замените в коде значение `my-pnp-resourcegroup` именем группы ресурсов, которую вы указали во время настройки.
  * Для идентификатора временного ряда используется свойство `iothub-connection-device-id, dt-subject`.

```azurecli-interactive
storage=mytsicoldstore
rg=my-pnp-resourcegroup
az storage account create -g $rg -n $storage --https-only
key=$(az storage account keys list -g $rg -n $storage --query [0].value --output tsv)
az timeseriesinsights environment longterm create --name my-tsi-env --resource-group $rg --time-series-id-properties iothub-connection-device-id, dt-subject --sku-name L1 --sku-capacity 1 --data-retention 7 --storage-account-name $storage --storage-management-key $key --location eastus2
```

Подключите источник событий Центра Интернета вещей. Замените значения `my-pnp-resourcegroup`, `my-pnp-hub` и `my-tsi-env` выбранными значениями. Следующая команда ссылается на созданную ранее группу потребителей для Аналитики временных рядов:

```azurecli-interactive
rg=my-pnp-resourcegroup
iothub=my-pnp-hub
env=my-tsi-env
es_resource_id=$(az iot hub create -g $rg -n $iothub --query id --output tsv)
shared_access_key=$(az iot hub policy list -g $rg --hub-name $iothub --query "[?keyName=='service'].primaryKey" --output tsv)
az timeseriesinsights event-source iothub create -g $rg --environment-name $env -n iot-hub-event-source --consumer-group-name tsi-consumer-group  --key-name iothubowner --shared-access-key $shared_access_key --event-source-resource-id $es_resource_id
```

Перейдите к группе ресурсов на [портале Azure](https://portal.azure.com) и выберите новую среду службы "Аналитика временных рядов". Откройте **URL-адрес Обозревателя Аналитики временных рядов**, который отображается на странице обзора экземпляра:

![Снимок экрана со страницей обзора на портале.](./media/tutorial-configure-tsi/view-environment.png)

В Обозревателе вы увидите три экземпляра:

* &lt;идентификатор вашего устройства pnp&gt; — thermostat1;
* &lt;идентификатор вашего устройства pnp&gt; — thermostat2;
* &lt;идентификатор вашего устройства pnp&gt; — `null`.

> [!NOTE]
> Третий тег представляет данные телеметрии от `TemperatureController`, например рабочий набор памяти устройства. Так как это свойство верхнего уровня, имя компонента будет иметь значение NULL. На следующем шаге вы сделаете это имя более понятным для пользователя.

![Снимок экрана с тремя экземплярами в Обозревателе.](./media/tutorial-configure-tsi/tsi-env-first-view.png)

## <a name="configure-model-translation"></a>Настройка преобразования модели

Далее вы преобразуете модель устройства DTDL в модель активов в службе "Аналитика временных рядов Azure". В службе "Аналитика временных рядов" моделью временного ряда называется средство семантического моделирования для контекстуализации данных. Эта модель содержит три основных компонента.

* [Экземпляры модели временных рядов](../time-series-insights/concepts-model-overview.md#time-series-model-instances) — это виртуальные представления самих временных рядов. Экземпляры принадлежат к временному ряду с уникальным идентификатором.
* [Иерархии модели временных рядов](../time-series-insights/concepts-model-overview.md#time-series-model-hierarchies) позволяют упорядочить экземпляры, определяя имена свойств и связи между ними.
* [Типы модели временных рядов](../time-series-insights/concepts-model-overview.md#time-series-model-types) помогают определить [переменные](../time-series-insights/concepts-variables.md) или формулы для вычислений. Типы связаны с конкретным экземпляром.

### <a name="define-your-types"></a>Определение типов

Вы можете начать прием данных в службе "Аналитика временных рядов Azure" 2-го поколения без предварительно определенной модели. При поступлении данных телеметрии Аналитика временных рядов попытается автоматически разрешить экземпляры временных рядов на основе значений идентификатора временного ряда. Всем экземплярам будет назначен *тип по умолчанию*. Вам потребуется вручную создать новый тип для корректной классификации экземпляров. 

Ниже приведены сведения о самом простом методе для синхронизации ваших моделей устройств DTDL с типами модели временных рядов:

* Идентификатор модели цифрового двойника будет вашим идентификатором типа.
* Именем типа может быть либо имя модели, либо отображаемое имя.
* Описание модели преобразуется в описание типа.
* Для каждой телеметрии с числовой схемой создается по крайней мере одна переменная типа.
  * Для переменных можно использовать только числовые типы данных, но если значение отправляется как элемент другого типа, который может быть преобразован (например, `"0"`), вы можете использовать функцию [преобразования](/rest/api/time-series-insights/reference-time-series-expression-syntax#conversion-functions) (например, `toDouble`).
* Именем переменной может быть либо имя телеметрии, либо отображаемое имя.
* При определении переменной для выражения временного ряда следует использовать имя телеметрии в сети и тип данных.

| JSON DTDL | JSON для типа модели временных рядов | Пример значения |
|-----------|------------------|-------------|
| `@id` | `id` | `dtmi:com:example:TemperatureController;1` |
| `displayName`    | `name`   |   `Temperature Controller`  |
| `description`  |  `description`  |  `Device with two thermostats and remote reboot.` |  
|`contents` (массив)| `variables` (объект)  | См. следующий пример.

![Снимок экрана: значение DTDL для типа модели временных рядов](./media/tutorial-configure-tsi/DTDL-to-TSM-Type.png)

> [!NOTE]
> В этом примере приведены три переменные, но каждый тип может иметь до 100 переменных. Разные переменные могут ссылаться на одно и то же значение телеметрии, что позволяет выполнять с ними разные вычисления. Полный список фильтров, статистических выражений и скалярных функций см. в статье о [синтаксисе выражения временного ряда службы "Аналитика временных рядов" 2-го поколения](/rest/api/time-series-insights/reference-time-series-expression-syntax).

Откройте текстовый редактор и сохраните следующий файл JSON на локальном диске:

```JSON
{
  "put": [
    {
      "id": "dtmi:com:example:TemperatureController;1",
      "name": "Temperature Controller",
      "description": "Device with two thermostats and remote reboot.",
      "variables": {
        "workingSet": {
          "kind": "numeric",
          "value": {
            "tsx": "coalesce($event.workingSet.Long, toLong($event.workingSet.Double))"
          }, 
          "aggregation": {
            "tsx": "avg($value)"
          }
        },
        "temperature": {
          "kind": "numeric",
          "value": {
            "tsx": "coalesce($event.temperature.Long, toLong($event.temperature.Double))"
          },
          "aggregation": {
            "tsx": "avg($value)"
          }
        },
        "eventCount": {
          "kind": "aggregate",
          "aggregation": {
            "tsx": "count()"
          }
        }
      }
    }
  ]
}
```

В Обозревателе Аналитики временных рядов щелкните значок модели слева, чтобы открыть вкладку **Модель**. Выберите **Типы** и нажмите кнопку **Отправить JSON**:

![Снимок экрана: отправка JSON.](./media/tutorial-configure-tsi/upload-type.png)

Щелкните **Выбрать файл**, затем выберите сохраненный ранее файл JSON и щелкните **Отправить**.

Вы увидите только что определенный тип **Temperature Controller**.

### <a name="create-a-hierarchy"></a>Создание иерархии

Создайте иерархию, чтобы упорядочить теги, связанные с родительским элементом `TemperatureController`. Следующий простой пример включает один уровень, но решения Интернета вещей обычно имеют несколько уровней вложенности для поддержания контекста тегов в рамках физической и семантической позиций в организации.

Щелкните **Иерархии** и выберите действие **Добавить иерархию**. В поле "Имя" введите *Парк устройств*. Создайте один уровень с именем *Имя устройства*. Затем выберите **Сохранить**.

![Снимок экрана: добавление иерархии.](./media/tutorial-configure-tsi/add-hierarchy.png)

### <a name="assign-your-instances-to-the-correct-type"></a>Присвойте экземплярам правильный тип

Затем измените тип экземпляров и поместите их в иерархию.

Выберите вкладку **Экземпляры**. Найдите экземпляр, представляющий рабочий набор устройства, и щелкните значок **Изменить** на правом краю страницы.

![Снимок экрана: изменение экземпляра.](./media/tutorial-configure-tsi/edit-instance.png)

Откройте раскрывающееся меню **Тип** и выберите значение **Temperature Controller** (Контроллер температуры). Введите *defaultComponent, <your device name>* , чтобы обновить имя экземпляра, представляющего все теги верхнего уровня, которые связаны с вашим устройством.

![Снимок экрана: изменение типа экземпляра.](./media/tutorial-configure-tsi/change-type.png)

Прежде чем нажать **Сохранить**, откройте вкладку **Поля экземпляра** и выберите **Парк устройств**. Чтобы сгруппировать данные телеметрии, введите строку *\<your device name> - Temp Controller*. Затем выберите **Сохранить**.

![Снимок экрана: назначение экземпляра в иерархию](./media/tutorial-configure-tsi/assign-to-hierarchy.png)

Повторите предыдущие шаги, чтобы назначить тегам термостата соответствующий тип и иерархию.

## <a name="view-your-data"></a>Просмотр данных

Вернитесь к панели диаграмм и разверните узел **Парк устройств**, затем выберите свое устройство. Щелкните **thermostat1**, выберите переменную **Temperature** и нажмите кнопку **Добавить**, чтобы внести значение в диаграмму. Повторите эти же действия для **thermostat2** и компонента **defaultComponent** со значением **workingSet**.

![Снимок экрана: изменение типа экземпляра для thermostat2.](./media/tutorial-configure-tsi/charting-values.png)

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о параметрах построения диаграмм, включая размер интервала и элементы управления оси Y, см. в статье [Обозреватель Аналитики временных рядов Azure](../time-series-insights/concepts-ux-panels.md).

* Подробные сведения о модели временных рядов для среды см. в статье [Модель временных рядов в службе "Аналитика временных рядов Azure" 2-го поколения](../time-series-insights/concepts-model-overview.md).

* Чтобы узнать больше об интерфейсах API запросов и синтаксисе выражений временного ряда, см. статью [API запросов Аналитики временных рядов Azure 2-го поколения](/rest/api/time-series-insights/reference-query-apis).
