---
title: Устранение неполадок выделения облачной службы (классическая модель) | Документация Майкрософт
description: Устранение ошибок выделения при развертывании облачных служб Azure. Узнайте, как работает выделение памяти и почему выделение может завершиться ошибкой.
ms.topic: article
ms.service: cloud-services
ms.date: 10/14/2020
ms.author: tagore
author: tanmaygore
ms.reviewer: mimckitt
ms.custom: ''
ms.openlocfilehash: 0c172add9aa49b2ca64d2fb2281d326256e3aec7
ms.sourcegitcommit: 6272bc01d8bdb833d43c56375bab1841a9c380a5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2021
ms.locfileid: "98741593"
---
# <a name="troubleshooting-allocation-failure-when-you-deploy-cloud-services-classic-in-azure"></a>Устранение ошибок выделения при развертывании облачных служб (классическая модель) в Azure

> [!IMPORTANT]
> [Облачные службы Azure (Расширенная поддержка)](../cloud-services-extended-support/overview.md) — это новая модель развертывания на основе Azure Resource Manager для продукта облачных служб Azure.После этого изменения облачные службы Azure, работающие в модели развертывания на основе Service Manager Azure, были переименованы как облачные службы (классические), и все новые развертывания должны использовать [облачные службы (Расширенная поддержка)](../cloud-services-extended-support/overview.md).

## <a name="summary"></a>Сводка
При развертывании экземпляров в облачной службе или добавлении новых экземпляров веб-узлов или рабочих ролей Microsoft Azure выделяет вычислительные ресурсы. Иногда во время выполнения этих операций могут возникать ошибки, даже если еще не достигнуты ограничения подписки Azure. В этой статье объясняются причины возникновения некоторых распространенных ошибок выделения, а также представлены возможные способы их устранения. Эта информация также может быть полезна при планировании развертывания служб.

[!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]

### <a name="background--how-allocation-works"></a>Общая информация — принцип выделения ресурсов
Серверы в центрах обработки данных Azure разделены на кластеры. Запрос о выделении новой облачной службы отправляется в несколько кластеров. Когда первый экземпляр развертывается в облачной службе (в тестовой или рабочей области), эта облачная служба прикрепляется к кластеру. Все последующие развертывания облачной службы выполняются в том же кластере. В этой статье мы будем называть этот процесс прикреплением к кластеру. На приведенной ниже схеме 1 показано, как обычно происходит выделение при попытке выполнения в нескольких кластерах. На схеме 2 показано выделение ресурсов, прикрепленное к кластеру 2, так как в нем размещена существующая облачная служба CS_1.

![Схема выделения ресурсов](./media/cloud-services-allocation-failure/Allocation1.png)

### <a name="why-allocation-failure-happens"></a>Причины возникновения ошибок выделения ресурсов
Если запрос на выделение прикреплен к одному кластеру, возрастает вероятность того, что не удастся найти свободные ресурсы, так как пул доступных ресурсов ограничен размером кластера. Кроме того, если запрос на выделение прикреплен к одному кластеру, а тип запрошенного ресурса не поддерживается, запрос завершится ошибкой, даже если в кластере есть свободные ресурсы. На схеме 3 ниже показан случай, когда ошибка выделения прикрепленных ресурсов произошла из-за отсутствия свободных ресурсов в единственном подходящем кластере. На схеме 4 показан случай, когда ошибка выделения прикрепленных ресурсов произошла потому, что единственный подходящий кластер не поддерживает запрошенный размер виртуальной машины, несмотря на наличие свободных ресурсов в кластере.

![Ошибка выделения прикрепленных ресурсов](./media/cloud-services-allocation-failure/Allocation2.png)

## <a name="troubleshooting-allocation-failure-for-cloud-services"></a>Устранение ошибок выделения для облачных служб
### <a name="error-message"></a>Сообщение об ошибке
Вы можете получить следующее сообщение об ошибке:

> "Операция Azure" {Operation ID} "завершилась ошибкой с кодом COMPUTE. Констраинедаллокатионфаилед. Сведения: сбой при выделении; не удалось удовлетворить ограничения в запросе. Запрошенное новое развертывание службы привязано к территориальной группе, предназначено для выполнения в виртуальной сети, или в этой размещенной службе уже существует развертывание. Любое из этих условий ограничивает новое развертывание использованием определенных ресурсов Azure. Повторите попытку позже или попробуйте уменьшить размер виртуальной машины или количество экземпляров ролей. Кроме того, по возможности удалите вышеупомянутые ограничения или попробуйте выполнить развертывание в другом регионе".

### <a name="common-issues"></a>Распространенные проблемы
В этом разделе описаны распространенные сценарии выделения ресурсов, вызывающие прикрепление запросов о распределении к отдельному кластеру.

* Развертывание в промежуточном слоте. Если в одном из слотов облачной службы имеется развертывание, вся облачная служба прикрепляется к определенному кластеру.  Это означает, что если развертывание уже существует в рабочей области, то новое промежуточное развертывание может быть выделено только в том же кластере, что и рабочая область. Если кластер близок к заполнению, запрос может завершиться ошибкой.
* Масштабирование. Для добавления новых экземпляров в существующую облачную службу требуется выделение ресурсов в том же кластере.  Для мелких запросов масштабирования ресурсы обычно выделяются, но это происходит не всегда. Если кластер близок к заполнению, запрос может завершиться ошибкой.
* Территориальная группа. Если облачная служба не прикреплена ни к какой территориальной группе, структура может распределить новое развертывание в пустую облачную службу в любом кластере соответствующего региона. По возможности развертывания в одну и ту же территориальную группу будут выполняться в одном и том же кластере. Если кластер близок к заполнению, запрос может завершиться ошибкой.
* Территориальная группа vNet. Раньше виртуальные сети привязывались не к регионам, а к территориальным группам, а облачные службы в этих виртуальных сетях — к кластеру территориальной группы. По возможности развертывания в виртуальную сеть такого типа будут выполняться в связанном кластере. Если кластер близок к заполнению, запрос может завершиться ошибкой.

## <a name="solutions"></a>Решения
1. Повторное развертывание в новую облачную службу. Данное решение, как правило, является самым удачным, поскольку позволяет платформе выбрать все кластеры в соответствующем регионе.

   * Разверните рабочую нагрузку в новую облачную службу.  
   * Обновите запись CNAME или A таким образом, чтобы она направляла трафик в новую облачную службу.
   * После того как трафик, направляемый на старый сайт, станет нулевым, старую облачную службу можно будет удалить. В этом случае время простоя должно быть нулевым.
2. Удалите рабочий и промежуточный слоты. Данное решение позволяет сохранить существующее имя DNS, но вызывает простой приложения.

   * Удалите рабочий и промежуточный слоты существующей облачной службы, чтобы облачная служба стала пустой.
   * Создайте в существующей облачной службе новое развертывание. Оно попытается заново распределить все кластеры в регионе. Убедитесь, что облачная служба не привязана к территориальной группе.
3. Зарезервированный IP-адрес. Это решение позволит сохранить существующий IP-адрес, но вызовет простой приложения.  

   * Создайте адрес ReservedIP для существующего развертывания с помощью Powershell.

     ```
     New-AzureReservedIP -ReservedIPName {new reserved IP name} -Location {location} -ServiceName {existing service name}
     ```
   * Выполните описанный выше пункт 2 и убедитесь, что в CSCFG службы указан новый адрес ReservedIP.
4. Удалите территориальную группу для новых развертываний. Использовать территориальные группы больше не рекомендуются. Выполните описанный выше пункт 1, чтобы развернуть новую облачную службу. Убедитесь, что облачная служба не входит в территориальную группу.
5. Сведения о выполнении преобразования в региональную виртуальную сеть см. в статье [Переход от территориальных групп к региональной виртуальной сети](/previous-versions/azure/virtual-network/virtual-networks-migrate-to-regional-vnet).