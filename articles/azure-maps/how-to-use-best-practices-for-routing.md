---
title: Рекомендации для Azure Maps Служба построения маршрутов | Карты Microsoft Azure
description: Узнайте, как эффективно маршрутизировать с помощью Служба построения маршрутов из карт Microsoft Azure.
author: philmea
ms.author: philmea
ms.date: 03/11/2020
ms.topic: conceptual
ms.service: azure-maps
services: azure-maps
manager: philmea
ms.openlocfilehash: 85ce29d088b8fbd110988db67776d89346215e5a
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "80335420"
---
# <a name="best-practices-for-azure-maps-route-service"></a>Рекомендации для службы маршрутов Azure Maps

В Azure Maps [Служба построения маршрутов](https://docs.microsoft.com/rest/api/maps/route) можно использовать направления маршрутов и API-интерфейсы матриц маршрута, чтобы вычислить предполагаемое время прибытия (ЕТАС) для каждого запрошенного маршрута. API-интерфейсы маршрутов рассматривайте такие факторы, как данные о трафике в реальном времени и исторические данные, например типичные скорости дорожек в запрошенный день недели и время суток. API-интерфейсы возвращают самые короткие или самые быстрые маршруты, доступные для нескольких назначений во время последовательности или в оптимизированном порядке, в зависимости от времени или расстояния. Пользователи также могут запрашивать специализированные маршруты и сведения для пошаговых средств, велосипедистов и коммерческих средств, таких как грузовики. В этой статье мы предоставим рекомендации по вызову Azure Maps [Служба построения маршрутов](https://docs.microsoft.com/rest/api/maps/route), и вы узнаете, как это сделать.

* Выбор интерфейсов API маршрутов маршрутизации
* Запрос с предысторией и прогнозируемым временем поездки на основе данных в реальном времени и истории трафика
* Сведения о маршруте запроса, например время и расстояние, для всего маршрута и каждого его участка
* Запрос маршрута для коммерческого транспортного средства, например грузовика
* Запрос сведений о трафике по маршруту, например ДТП и платный сбор данных
* Запрос маршрута, состоящего из одной или более остановок (вайпоинтс)
* Оптимизируйте маршрут одной или нескольких остановок, чтобы получить наилучший порядок посещения каждой остановки (пункт маршрута)
* Оптимизируйте альтернативные маршруты с помощью вспомогательных точек. Например, вы предлагаете альтернативные маршруты, которые проходят станцию зарядки электрических транспортных средств.
* Использование [Служба построения маршрутов](https://docs.microsoft.com/rest/api/maps/route) с веб-пакетом SDK для Azure Maps

## <a name="prerequisites"></a>Предварительные условия

Чтобы вызвать API Azure Maps, требуется учетная запись Azure Maps и ключ. Дополнительные сведения см. в разделе [Создание учетной записи](quick-demo-map-app.md#create-an-account-with-azure-maps) и [Получение первичного ключа](quick-demo-map-app.md#get-the-primary-key-for-your-account). Первичный ключ также называется первичным ключом подписки или ключом подписки.

Сведения о проверке подлинности в Azure Maps см. [в разделе Управление проверкой подлинности в Azure Maps](./how-to-manage-authentication.md). Дополнительные сведения о покрытии Служба построения маршрутов см. в разделе [покрытие маршрутизации](routing-coverage.md).

В этой статье используется [приложение POST](https://www.postman.com/downloads/) для создания вызовов RESTful, но можно выбрать любую среду разработки API.

## <a name="choose-between-route-directions-and-matrix-routing"></a>Выбор между маршрутами и маршрутизацией матрицы

API направления маршрута возвращают инструкции, включая время поездки и координаты пути маршрута. API матрицы маршрутов позволяет вычислить время поездки и расстояния для набора маршрутов, определяемых исходным и целевым расположениями. Для каждого заданного происхождения API матрицы вычисляет стоимость (время поездки и расстояние) маршрутизации от этого источника к каждому заданному назначению. Все эти API позволяют указать такие параметры, как время отправления, время прибытия и тип автомобиля, например автомобиль или грузовик. Для получения наиболее оптимальных маршрутов все они используют данные в режиме реального времени или прогнозы трафика.

Рассмотрите возможность вызова API направлений маршрутов, если ваш сценарий состоит из следующих действий:

* Запросите самый короткий или самый быстрый маршрут, управляющий двумя или более известными расположениями, чтобы получить точное время прибытия для транспортных средств доставки.
* Запрос подробных руководств по маршрутам, включая геометрию маршрута, для визуализации маршрутов на карте
* Учитывая список расположений клиентов, вычислите кратчайшие возможные маршруты, чтобы посетить каждое местонахождение клиента и вернуться к источнику. Этот сценарий обычно называют Salesman Problem проблемой. В одном запросе можно передать до 150 вайпоинтс (остановка).
* Отправка пакетов запросов в API пакетной службы маршрутов с помощью всего одного вызова API.

Рассмотрите возможность вызова API маршрутизации матрицы, если ваш сценарий:

* Вычислите время поездки или расстояние между набором источников и назначений. Например, у вас есть 12 драйверов, и вам нужно найти ближайший доступный драйвер, чтобы выбрать доставку пищи из ресторана.
* Сортировка потенциальных маршрутов по фактическому расстоянию или времени поездки. API матрицы возвращает только время и расстояния для каждого сочетания источника и назначения.
* Данные кластера на основе времени поездки или расстояний. Например, у вашей компании 50 сотрудников, вы найдете всех сотрудников, проживающих в течение 20 минут с вашего офиса.

Ниже приведено сравнение, в котором показаны некоторые возможности направлений маршрута и API матрицы:

| Azure Maps API | Максимальное число запросов в запросе | Избегайте областей | Маршрутизация грузовика и электрический автомобиля | Оптимизация вайпоинтс и поездки Salesman Problem | Вспомогательные точки |
| :--------------: |  :--------------: |  :--------------: | :--------------: | :--------------: | :--------------: |
| Route — Get Route Directions (Маршрут — получение направлений маршрута) | 1 | | X | X | |
| Опубликовать направления маршрутов | 1 | X | X | X | X |
| Отправка пакетов маршрутов | 700 | | X | X | |
| Route — Post Route Matrix Preview (Маршрут — предварительная версия запроса Post матрицы маршрута) | 700 | | X | | |

Дополнительные сведения о возможностях маршрутизации электрических транспортных средств см. в нашем руководстве по [маршрутизации электрических транспортных средств с помощью Azure Notebooks с Python](tutorial-ev-routing.md).

## <a name="request-historic-and-real-time-data"></a>Запрос данных с предысторией и данными в режиме реального времени

По умолчанию служба маршрутов предполагает, что в режиме поездки используется автомобиль, а время отправления —. Он возвращает маршрут на основе условий трафика в режиме реального времени, если в запросе на вычисление маршрута не указано иное. Фиксированные ограничения трафика, зависящие от времени, такие как "Left" не разрешены от 4:00 до 6:00 PM, фиксируются и будут рассматриваться механизмом маршрутизации. Кроме того, будут учитываться дорожные замыкания, например роадворкс, если только вы не запрашиваете маршрут, который игнорирует текущий динамический трафик. Чтобы проигнорировать текущий трафик, задайте `traffic` для `false` параметра значение в запросе API.

Значение **травелтимеинсекондс** вычисления маршрута включает задержку из-за трафика. Он создается путем использования текущих и прошлых данных поездок, когда для параметра время отправления установлено значение Now. Если время отправления задано в будущем, интерфейсы API возвращают прогнозируемое время поездки на основе исторических данных.

Если включить в запрос параметр **компутетравелтимефор = ALL** , то элемент Summary в ответе будет иметь следующие дополнительные поля, включая исторические условия трафика:

| Элемент | Описание|
| :--- | :--- |
| нотраффиктравелтимеинсекондс | Предполагаемое время поездки вычисляется так, как если бы на маршруте не было задержки из-за условий трафика, например из-за перегрузки |
| хисториктраффиктравелтимеинсекондс | Предполагаемое время поездки, вычисленное с использованием данных о трафике, зависящих от времени |
| ливетраффиЦинЦидентстравелтимеинсекондс | Предполагаемое время поездки, вычисленное с использованием данных о скорости в реальном времени |

В следующих разделах показано, как выполнять вызовы интерфейсов API маршрута с помощью обсуждаемых параметров.

### <a name="sample-query"></a>Пример запроса

В первом примере ниже время отправления задается в будущем на момент написания статьи.

```http
https://atlas.microsoft.com/route/directions/json?subscription-key=<Your-Azure-Maps-Primary-Subscription-Key>&api-version=1.0&query=51.368752,-0.118332:51.385426,-0.128929&travelMode=car&traffic=true&departAt=2025-03-29T08:00:20&computeTravelTimeFor=all
```

Ответ содержит элемент Summary, аналогичный показанному ниже. Так как время отправления задается в будущем, значение **траффикделайинсекондс** равно нулю. Значение **травелтимеинсекондс** вычисляется с использованием данных о трафике, зависящих от времени. Таким образом, в данном случае значение **травелтимеинсекондс** равно значению **хисториктраффиктравелтимеинсекондс** .

```json
"summary": {
    "lengthInMeters": 2131,
    "travelTimeInSeconds": 248,
    "trafficDelayInSeconds": 0,
    "departureTime": "2025-03-29T08:00:20Z",
    "arrivalTime": "2025-03-29T08:04:28Z",
    "noTrafficTravelTimeInSeconds": 225,
    "historicTrafficTravelTimeInSeconds": 248,
    "liveTrafficIncidentsTravelTimeInSeconds": 248
},
```

### <a name="sample-query"></a>Пример запроса

Во втором примере ниже у нас есть запрос на маршрутизацию в режиме реального времени, где время отправления теперь равно. Он не указывается явным образом в URL-адресе, так как это значение по умолчанию.

```http
https://atlas.microsoft.com/route/directions/json?subscription-key=<Your-Azure-Maps-Primary-Subscription-Key>&api-version=1.0&query=47.6422356,-122.1389797:47.6641142,-122.3011268&travelMode=car&traffic=true&computeTravelTimeFor=all
```

Ответ содержит сводку, как показано ниже. Из-за перегрузок значение **траффикделайсинсекондс** больше нуля. Он также больше, чем **хисториктраффиктравелтимеинсекондс**.

```json
"summary": {
    "lengthInMeters": 16637, 
    "travelTimeInSeconds": 2905, 
    "trafficDelayInSeconds": 1604, 
    "departureTime": "2020-02-28T01:00:20+00:00",
    "arrivalTime": "2020-02-28T01:48:45+00:00", 
    "noTrafficTravelTimeInSeconds": 872, 
    "historicTrafficTravelTimeInSeconds": 1976, 
    "liveTrafficIncidentsTravelTimeInSeconds": 2905 
},
```

## <a name="request-route-and-leg-details"></a>Запрос маршрута и сведения о подучастках

По умолчанию служба маршрутов возвращает массив координат. Ответ будет содержать координаты, составляющие путь в списке с именем `points`. Ответ маршрута также включает расстояние от начала маршрута до предполагаемого затраченного времени. Эти значения можно использовать для вычисления средней скорости для всего маршрута.

На следующем рисунке показан `points` элемент.

<center>

![Список точек](media/how-to-use-best-practices-for-routing/points-list-is-hidden-img.png)

</center>

Разверните `point` элемент, чтобы просмотреть список координат для пути:

<center>

![Список точек](media/how-to-use-best-practices-for-routing/points-list-img.png)

</center>

API направления маршрутов поддерживают различные форматы инструкций, которые можно использовать, указав параметр **инструктионстипе** . Чтобы отформатировать инструкции для упрощения обработки компьютеров, используйте **инструктионстипе = coded**. Используйте **инструктионстипе = Tagged** , чтобы отобразить инструкции в виде текста для пользователя. Кроме того, инструкции можно отформатировать как текст, в котором отмечены некоторые элементы инструкций, а инструкции — с особым форматированием. Дополнительные сведения см. в [списке поддерживаемых типов инструкций](https://docs.microsoft.com/rest/api/maps/route/postroutedirections#routeinstructionstype).

При запросе инструкций ответ возвращает новый элемент с именем `guidance`. `guidance` Элемент содержит два фрагмента информации: пошаговое руководство и обобщенные инструкции.

<center>

![Тип инструкций](media/how-to-use-best-practices-for-routing/instructions-type-img.png)

</center>

`instructions` Элемент содержит пошаговые инструкции по перенаправлениям для поездки, а также `instructionGroups` содержит обобщенную инструкцию. Каждая инструкция охватывает сегмент поездки, который может охватывать несколько дорог. API-интерфейсы могут возвращать сведения о разделах маршрута. Например, диапазон координат застревания трафика или текущая скорость трафика.

<center>

![Включение инструкций](media/how-to-use-best-practices-for-routing/instructions-turn-by-turn-img.png)

</center>

<center>

![Обобщенные инструкции](media/how-to-use-best-practices-for-routing/instructions-summary-img.png)

</center>

## <a name="request-a-route-for-a-commercial-vehicle"></a>Запрос маршрута для коммерческого автомобиля

Интерфейсы API маршрутизации Azure Maps поддерживают коммерческую маршрутизацию, охватывающую коммерческие грузовики. Интерфейсы API учитывают указанные ограничения. Например, высота и вес транспортного средства, а также, если автомобиль продает вред. Например, если машина выполняет фламмабле, механизм маршрутизации позволяет избежать определенных туннелей, наявляющихся ближайшими к частным областям.

### <a name="sample-query"></a>Пример запроса

Пример запроса ниже запрашивает маршрут для коммерческого грузовика. Грузовик занимает опасные материалы класса 1.

```http
https://atlas.microsoft.com/route/directions/json?subscription-key=<Your-Azure-Maps-Primary-Subscription-Key>&api-version=1.0&vehicleWidth=2&vehicleHeight=2&vehicleCommercial=true&vehicleLoadType=USHazmatClass1&travelMode=truck&instructionsType=text&query=51.368752,-0.118332:41.385426,-0.128929
```

API маршрута возвращает направления, которые охватывают размеры грузовика и опасные отходы. Вы можете прочитать инструкции маршрута, развернув `guidance` элемент.

<center>

![Грузовик с классом 1 хазвасте](media/how-to-use-best-practices-for-routing/truck-with-hazwaste-img.png)

</center>

### <a name="sample-query"></a>Пример запроса

Изменение класса US Хазмат в приведенном выше запросе приведет к появлению другого маршрута для размещения этого изменения.

```http
https://atlas.microsoft.com/route/directions/json?subscription-key=<Your-Azure-Maps-Primary-Subscription-Key>&api-version=1.0&vehicleWidth=2&vehicleHeight=2&vehicleCommercial=true&vehicleLoadType=USHazmatClass9&travelMode=truck&instructionsType=text&query=51.368752,-0.118332:41.385426,-0.128929
```

Приведенный ниже ответ предназначен для грузовика с опасным материалом класса 9, который менее опасн, чем опасный материал класса 1. При развертывании `guidance` элемента для чтения направлений можно заметить, что направления не совпадают. Для «грузовика» с опасным материалом класса 1 существуют дополнительные инструкции маршрута.

<center>

![Грузовик с классом 9 хазвасте](media/how-to-use-best-practices-for-routing/truck-with-hazwaste9-img.png)

</center>

## <a name="request-traffic-information-along-a-route"></a>Запрос сведений о трафике вдоль маршрута

С помощью Azure Maps интерфейсов API направления маршрута разработчики могут запрашивать сведения для каждого типа раздела, `sectionType` включая параметр в запросе. Например, можно запросить сведения о скорости для каждого сегмента застревания трафика. Сведения о различных деталях, которые можно запросить, см. в [списке значений для ключа сектионтипе](https://docs.microsoft.com/rest/api/maps/route/getroutedirections#sectiontype) .

### <a name="sample-query"></a>Пример запроса

Следующий запрос задает для `sectionType` `traffic`значение. Он запрашивает разделы, содержащие сведения о трафике из Сиэтле в Сан Диего.

```http
https://atlas.microsoft.com/route/directions/json?subscription-key=<Your-Azure-Maps-Primary-Subscription-Key>&api-version=1.0&sectionType=traffic&query=47.6062,-122.3321:32.7157,-117.1611
```

Ответ содержит разделы, которые подходят для трафика по заданным координатам.

<center>

![разделы трафика](media/how-to-use-best-practices-for-routing/traffic-section-type-img.png)

</center>

Этот параметр можно использовать для выделения цветом разделов при подготовке к просмотру, как показано на рисунке ниже. 

<center>

![разделы трафика](media/how-to-use-best-practices-for-routing/show-traffic-sections-img.png)

</center>

## <a name="calculate-and-optimize-a-multi-stop-route"></a>Вычисление и оптимизация нескольких маршрутов

Azure Maps в настоящее время предоставляет две формы оптимизации маршрутов:

* Оптимизации на основе запрошенного типа маршрута без изменения порядка вайпоинтс. [Поддерживаемые типы маршрутов](https://docs.microsoft.com/rest/api/maps/route/postroutedirections#routetype) можно найти здесь.

* Salesman Problem оптимизация, которая изменяет порядок вайпоинтс, чтобы получить наилучший порядок посещения каждого из них.

Для маршрутизации с несколькими остановкой в одном запросе маршрута можно указать до 150 вайпоинтс. Начальное и конечное положение координат может быть одинаковым, как в случае с круговой поездку. Но необходимо предоставить по крайней мере один дополнительный пункт маршрута, чтобы выполнить вычисление маршрута. Вайпоинтс можно добавить в запрос между исходной и конечной координатами.

Если вы хотите оптимизировать наилучший порядок для посещения заданного вайпоинтс, необходимо указать **компутебестордер = true**. Этот сценарий также известен как проблема с оптимизацией Salesman Problem.

### <a name="sample-query"></a>Пример запроса

Следующий запрос запрашивает путь для шести вайпоинтс, параметр которого `computeBestOrder` имеет значение. `false` Это также значение по умолчанию для `computeBestOrder` параметра.

```http
https://atlas.microsoft.com/route/directions/json?api-version=1.0&subscription-key=<Your-Azure-Maps-Primary-Subscription-Key>&computeBestOrder=false&query=47.606544,-122.336502:47.759892,-122.204821:47.670682,-122.120415:47.480133,-122.213369:47.615556,-122.193689:47.676508,-122.206054:47.495472,-122.360861
```

В ответе описывается длина пути, равная 140 851 м, и это может занять 9 991 секунд для перемещения этого пути.

<center>

![Неоптимизированный ответ](media/how-to-use-best-practices-for-routing/non-optimized-response-img.png)

</center>

На рисунке ниже показан путь, полученный в результате выполнения запроса. Этот путь является одним из возможных маршрутов. Это не оптимальный путь в зависимости от времени или расстояния.

<center>

![Неоптимизированное изображение](media/how-to-use-best-practices-for-routing/non-optimized-image-img.png)

</center>

Этот маршрут пункт маршрута порядок: 0, 1, 2, 3, 4, 5 и 6.

### <a name="sample-query"></a>Пример запроса

Следующий запрос запрашивает путь для тех же шести вайпоинтс, как в приведенном выше примере. На этот раз для `computeBestOrder` `true` параметра задано значение (Salesman Problem оптимизация в поездках).

```http
https://atlas.microsoft.com/route/directions/json?api-version=1.0&subscription-key=<Your-Azure-Maps-Primary-Subscription-Key>&computeBestOrder=true&query=47.606544,-122.336502:47.759892,-122.204821:47.670682,-122.120415:47.480133,-122.213369:47.615556,-122.193689:47.676508,-122.206054:47.495472,-122.360861
```

В ответе описывается длина пути, равная 91 814 м, и это может занять 7 797 секунд для перемещения этого пути. Расстояние и время командировки ниже, так как API вернул оптимизированный маршрут.

<center>

![Неоптимизированный ответ](media/how-to-use-best-practices-for-routing/optimized-response-img.png)

</center>

На рисунке ниже показан путь, полученный в результате выполнения запроса.

<center>

![Неоптимизированное изображение](media/how-to-use-best-practices-for-routing/optimized-image-img.png)

</center>

Оптимальный маршрут имеет следующий пункт маршрута порядок: 0, 5, 1, 2, 4, 3 и 6.

>[!TIP]
> Оптимизированные сведения о заказе пункт маршрута из службы Routing Service предоставляет набор индексов. Они исключают исходные и целевые индексы. Необходимо увеличить эти значения на 1, чтобы учитывать происхождение. Затем добавьте назначение в конец, чтобы получить полный упорядоченный список пункт маршрута.

## <a name="calculate-and-bias-alternative-routes-using-supporting-points"></a>Вычисление альтернативных маршрутов и их смещение с помощью вспомогательных точек

Могут возникнуть ситуации, когда необходимо перестроить маршрут, чтобы вычислить ноль или более альтернативных маршрутов для ссылочного маршрута. Например, вы можете показывать клиентам альтернативные маршруты, которые проходят розничный магазин. В этом случае необходимо заместить расположение с помощью вспомогательных точек. Ниже приведены шаги для смещения расположения.

1. Вычислите маршрут как есть и получите путь из ответа маршрута.
2. Используйте путь маршрута, чтобы найти нужные расположения вдоль пути маршрута или рядом с ним. Например, можно использовать [API Azure Maps точки](https://docs.microsoft.com/rest/api/maps/search/getsearchpoi) или запрашивать данные в базе данных.  
3. Упорядочивание расположений в зависимости от расстояния от начала маршрута
4. Добавьте эти расположения в качестве вспомогательных точек в новый запрос маршрута к [API направления маршрутов POST](https://docs.microsoft.com/rest/api/maps/route/postroutedirections). Дополнительные сведения о вспомогательных точках см. в [документации по API публикации маршрутов](https://docs.microsoft.com/rest/api/maps/route/postroutedirections#supportingpoints). 

При вызове [API отправки направлений маршрута](https://docs.microsoft.com/rest/api/maps/route/postroutedirections)можно задать минимальное время отклонения или ограничения расстояния, а также вспомогательные точки. Используйте эти параметры, если вы хотите предложить альтернативные маршруты, но также хотите ограничить время поездки. При использовании этих ограничений альтернативные маршруты будут следовать маршруту ссылки от исходной точки к заданному времени или расстоянию. Иными словами, другие маршруты расходят от ссылочного маршрута на основе заданных ограничений.

На приведенном ниже рисунке показан пример отображения альтернативных маршрутов с заданными ограничениями отклонения для времени и расстояния.

<center>

![Альтернативные маршруты](media/how-to-use-best-practices-for-routing/alternative-routes-img.png)

</center>

## <a name="use-the-routing-service-in-a-web-app"></a>Использование службы Routing Service в веб-приложении

Веб-пакет SDK для Azure Maps предоставляет [модуль службы](https://docs.microsoft.com/javascript/api/azure-maps-rest/?view=azure-maps-typescript-latest). Этот модуль представляет собой вспомогательную библиотеку, которая упрощает использование Azure Maps интерфейсов API-интерфейса RESTFUL в приложениях Web или Node. js с помощью JavaScript или TypeScript. Модуль службы можно использовать для отображения возвращаемых маршрутов на карте. Модуль автоматически определяет, какой API следует использовать с запросами GET и POST.

## <a name="next-steps"></a>Дальнейшие шаги

Дополнительные сведения см. в следующих статьях:

> [!div class="nextstepaction"]
> [Служба маршрутов Azure Maps](https://docs.microsoft.com/rest/api/maps/route)

> [!div class="nextstepaction"]
> [Использование модуля службы](https://docs.microsoft.com/azure/azure-maps/how-to-use-services-module)

> [!div class="nextstepaction"]
> [Отображение маршрута на карте](https://docs.microsoft.com/azure/azure-maps/map-route)

> [!div class="nextstepaction"]
> [Azure Maps пакет NPM](https://www.npmjs.com/package/azure-maps-rest  )
