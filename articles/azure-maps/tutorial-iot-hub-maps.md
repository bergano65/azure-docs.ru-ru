---
title: Реализация пространственной аналитики Интернета вещей с помощью Azure Maps | Документация Майкрософт
description: Интеграция Центра Интернета вещей с API-интерфейсами службы Azure Maps.
author: walsehgal
ms.author: v-musehg
ms.date: 08/13/2019
ms.topic: tutorial
ms.service: azure-maps
services: azure-maps
manager: philmea
ms.custom: mvc
ms.openlocfilehash: 5345bbf2514c8b06ab80d4563227725a398f9407
ms.sourcegitcommit: d3dced0ff3ba8e78d003060d9dafb56763184d69
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/22/2019
ms.locfileid: "69898339"
---
# <a name="implement-iot-spatial-analytics-using-azure-maps"></a>Реализация пространственной аналитики Интернета вещей с помощью Azure Maps

Отслеживание и сбор важных событий по определенному пространству и времени является типичным сценарием для Интернета вещей. Примеры таких сценариев: управление автопарком, отслеживание ресурсов, приложения мобильности и умного города. В этом руководстве описывается шаблон решения, в котором API-интерфейсы Azure Maps применяются для важных событий, собранных в Центре Интернета вещей, на основе модели подписки на события в службе "Сетка событий".

Изучив данный учебник, вы научитесь:

> [!div class="checklist"]
> * Создайте Центр Интернета вещей.
> * Передача данных о геозоне в службу данных Azure Maps с помощью API отправки данных.
> * Создавать функции в Функциях Azure, которая реализует бизнес-логику на основе пространственной аналитики Azure Maps.
> * Подписываться на события телеметрии устройств Интернета вещей из функции Azure через службу "Сетка событий".
> * Фильтровать события телеметрии с помощью маршрутизации сообщений, предоставляемой Центром Интернета вещей.
> * Создавать учетные записи хранения для важных данных о событиях.
> * Имитировать устройства Интернета вещей, устанавливаемого в транспортном средстве.
    

## <a name="use-case"></a>Вариант использования

Мы создадим пример решения, которое позволит компании, предоставляющей автомобили в аренду, отслеживать и регистрировать события для арендованных автомобилей. Компании, предоставляющие автомобили в аренду, часто ограничивают допустимый регион их использования и хотят следить за местонахождением арендованных автомобилей. Любое событие, включающее выезд автомобиля за пределы указанного географического региона, должно быть зарегистрировано, чтобы правильно применять политики аренды, штрафы и другие бизнес-механизмы.

В нашем примере арендованного автомобили оснащаются устройствами Интернета вещей, которые регулярно отправляют данные телеметрии в Центр Интернета вещей Azure. Данные телеметрии содержат текущее расположение и сведения о том, работает ли двигатель автомобиля. Схема расположения устройств соответствует схеме [IoT Plug and Play для геопространственных данных.](https://github.com/Azure/IoTPlugandPlay/blob/master/Schemas/geospatial.md) Схема телеметрии устройства для арендованного автомобиля выглядит примерно так:

```JSON
{
    "data": {
         "properties": {
            "Engine": "ON"
         },
         "systemProperties": {
            "iothub-content-type": "application/json",
            "iothub-content-encoding": "utf-8",
            "iothub-connection-device-id": "ContosoRentalDevice",
            "iothub-connection-auth-method": "{\"scope\":\"device\",\"type\":\"sas\",\"issuer\":\"iothub\",\"acceptingIpFilterRule\":null}",
            "iothub-connection-auth-generation-id": "636959817064335548",
            "iothub-enqueuedtime": "2019-06-18T00:17:20.608Z",
            "iothub-message-source": "Telemetry"
         },
         "body": { 
                    "location": { 
                        "type": "Point",
                        "coordinates": [ -77.025988698005662, 38.9015330523316 ]
                     } 
                 } 
    }
}
```

Для решения этой задачи можно использовать телеметрию с устройства, установленного в автомобиле. Мы намерены применить правила геозон и отслеживать все события, обозначающие перемещения автомобилей. Для этого мы создадим подписку на события телеметрии устройств в Центре Интернета вещей через службу "Сетка событий", чтобы правильно применять бизнес-логику взаимодействий с клиентами. Существует несколько способов создать подписку в службе "Сетка событий". В этом руководстве мы применим Функции Azure. Функции Azure реагируют на события, опубликованные в службе "Сетка событий", и реализуют бизнес-логику на основе пространственной аналитики Azure Maps. Функция Azure проверяет, покинул ли автомобиль пределы геозоны, и собирает дополнительные сведения о таких событиях, например адрес, связанный с текущим расположением. Также эта функция реализует логику сохранения понятных данных о событиях в хранилище BLOB-объектов, что поможет создавать точные описания обстоятельств для предоставления аналитикам компании и клиентам.

На следующей схеме представлено обобщенное описание всей системы.

 
  <center>

  ![Обзор системы](./media/tutorial-iot-hub-maps/system-diagram.png)</center>

На рисунке ниже территория геозоны выделена синим цветом, а маршрут арендованного автомобиля обозначен зеленой линией.

  ![Маршрут по геозоне](./media/tutorial-iot-hub-maps/geofence-route.png)


## <a name="prerequisites"></a>Предварительные требования 

### <a name="create-a-resource-group"></a>Создание группы ресурсов

Чтобы выполнить действия, описанные в этом руководстве, сначала необходимо создать группу ресурсов на портале Azure. Чтобы создать группу ресурсов, выполните действия ниже.

1. Войдите на [портал Azure](https://portal.azure.com).

2. Выберите **Группы ресурсов**.
    
   ![Группы ресурсов](./media/tutorial-iot-hub-maps/resource-group.png)

3. В разделе "Группы ресурсов" выберите **Добавить**.
    
   ![Добавление группы ресурсов](./media/tutorial-iot-hub-maps/add-resource-group.png) 

4. Введите значения для следующих свойств:
    * **Подписка**: Укажите подписку Azure.
    * **Группа ресурсов**. Укажите ContosoRental в качестве имени группы ресурсов.
    * **Регион**: Выберите регион для группы ресурсов.  

    ![Сведения о группе ресурсов](./media/tutorial-iot-hub-maps/resource-details.png)

    Щелкните **Проверить и создать**, затем выберите **Создать** на следующей странице.

### <a name="create-an-azure-maps-account"></a>создание учетной записи службы "Карты Azure"; 

Чтобы реализовать бизнес-логику на основе пространственной аналитики Azure Maps, нам потребуется учетная запись Azure Maps в созданной ранее группе ресурсов. Следуйте инструкциям [по управлению учетной записью](https://docs.microsoft.com/azure/azure-maps/how-to-manage-account-keys), чтобы создать подписку на учетную запись Azure Maps с ценовой категорией S1, а на странице [сведений о проверке подлинности](https://docs.microsoft.com/azure/azure-maps/how-to-manage-authentication#view-authentication-details) узнайте, как получить ключ подписки.


### <a name="create-a-storage-account"></a>Создание учетной записи хранения

Чтобы сохранять данные событий, мы создадим в группе ресурсов ContosoRental учетную запись общего назначения **v2storage** для хранения данных в формате больших двоичных объектов. Инструкции по созданию учетной записи хранения представлены в [этой статье](https://docs.microsoft.com/azure/storage/common/storage-quickstart-create-account?toc=%2Fazure%2Fstorage%2Fblobs%2Ftoc.json&tabs=azure-portal). Теперь нам нужно создать контейнер для хранения больших двоичных объектов. Для этого выполните описанные ниже шаги.

1. В учетной записи хранения перейдите к элементу "Большие двоичные объекты"

    ![BLOB-объекты](./media/tutorial-iot-hub-maps/blobs.png)

2. Нажмите кнопку "Контейнер" в верхнем левом углу и присвойте контейнеру имя contoso-rental-logs, затем нажмите кнопку "ОК".

    ![Контейнер BLOB-объектов](./media/tutorial-iot-hub-maps/blob-container.png)

3. Откройте колонку **Ключи доступа** в учетной записи хранения и скопируйте имя учетной записи и ключ доступа, которые мы применим позже.

    ![Ключи доступа](./media/tutorial-iot-hub-maps/access-keys.png)


Теперь у нас есть учетная запись хранения и контейнер для хранения данных событий, а далее мы создадим центр Интернета вещей.

### <a name="create-an-iot-hub"></a>Создание центра Интернета вещей

Центр Интернета вещей представляет собой облачную управляемую службу, которая выполняет роль центра сообщений для двусторонней связи между приложением Интернета вещей и устройствами, которыми оно управляет. Чтобы направить сообщения телеметрии устройства в службу "Сетка событий", мы создадим центр Интернета вещей в группе ресурсов ContosoRental и настроим интеграцию маршрутов сообщений для фильтрации сообщений по состоянию работы двигателя и отправки данных телеметрии устройства в службу "Сетка событий" при каждом перемещении автомобиля. 

> [!Note] 
> Функция публикации событий телеметрии устройства в службу "Сетка событий" доступна в Центре Интернета вещей в режиме общедоступной предварительной версии. Функции общедоступной предварительной версии доступны во всех регионах, кроме следующих: **Восточная часть США, Западная часть США, Западная Европа, Azure для государственных организаций, Azure для Китая 21Vianet** и **Azure для Германии**. 

Создайте центр Интернета вещей, выполнив действия из [этого раздела](https://docs.microsoft.com/azure/iot-hub/quickstart-send-telemetry-dotnet#create-an-iot-hub).


### <a name="register-a-device"></a>Регистрация устройства 

Чтобы подключаться к Центру Интернета вещей, устройство должно быть в нем зарегистрировано. Чтобы зарегистрировать устройство в Центре Интернета вещей, выполните указанные ниже шаги.

1. В Центре Интернета вещей щелкните колонку "Устройства IoT" и выберите действие "Создать".

    ![Добавление устройства](./media/tutorial-iot-hub-maps/add-device.png)

2. На странице создания устройства присвойте ему имя и щелкните "Сохранить".
    
    ![Регистрация устройства](./media/tutorial-iot-hub-maps/register-device.png)


## <a name="upload-geofence"></a>Отправка геозоны

Чтобы [отправить данные о геозоне](https://docs.microsoft.com/azure/azure-maps/geofence-geojson) в службу Azure Maps, мы воспользуемся [приложением Postman](https://www.getpostman.com). Это позволит регистрировать любое событие, связанное с выездом автомобиля за пределы этой геозоны.

Откройте приложение Postman и выполните приведенные ниже инструкции, чтобы отправить данные о геозоне через API отправки данных Azure Maps.  

1. В приложении Postman щелкните New (Новый), Create new (Создать) и выберите Request (Запрос). Введите имя запроса, чтобы отправить данные о геозоне, выберите коллекцию или папку, в которую нужно их сохранить, и щелкните Save (Сохранить).

    ![Отправка данных о геозоне с помощью Postman](./media/tutorial-iot-hub-maps/postman-new.png)

2. Выберите метод POST HTTP на вкладке конструктора и введите следующий URL-адрес для выполнения запроса POST.

    ```HTTP
    https://atlas.microsoft.com/mapData/upload?subscription-key={subscription-key}&api-version=1.0&dataFormat=geojson
    ```
    
    Значение geojson для параметра `dataFormat` в пути URL-адреса определяет формат отправляемых данных.

3. Щелкните **Params** (Параметры) и введите следующие пары "ключ — значение" для URL-адреса запроса POST. Замените значение ключа подписки своим ключом подписки на Azure Maps.
   
    ![Пары "ключ — значение" на вкладке параметров приложения Postman](./media/tutorial-iot-hub-maps/postman-key-vals.png)

4. Перейдите на вкладку **Body** (Текст) и выберите формат входных данных **raw** (необработанный), а затем в раскрывающемся списке выберите формат входных данных **JSON (application/text)** . Откройте [этот](https://raw.githubusercontent.com/Azure-Samples/iothub-to-azure-maps-geofencing/master/src/Data/geofence.json?token=AKD25BYJYKDJBJ55PT62N4C5LRNN4) файл данных JSON и скопируйте код JSON в раздел текста для отправляемых данных в приложении Postman и щелкните **Отправить**.
    
    ![Отправка данных](./media/tutorial-iot-hub-maps/post-json-data.png)
    
5. Изучите заголовки ответа. Если запрос выполнен успешно, заголовок **Location** будет содержать URI для проверки текущего состояния запроса на отправку. URI состояния имеет следующий формат. 

   ```HTTP
   https://atlas.microsoft.com/mapData/{uploadStatusId}/status?api-version=1.0
   ```

6. Скопируйте полученный URI состояния и добавьте в него параметр `subscription-key`, значением которого является ключ подписки учетной записи Azure Maps. URI состояния должен иметь примерно такой формат:

   ```HTTP
   https://atlas.microsoft.com/mapData/{uploadStatusId}/status?api-version=1.0&subscription-key={Subscription-key}
   ```

7. Чтобы получить `udId`, откройте новую вкладку в приложении Postman, выберите "GET HTTP method " (Метод HTTP GET) на вкладке построителя запросов и выполните запрос GET по URI состояния. Если передача данных прошла успешно, вы получите в тексте ответа значение udId. Скопируйте этот udId для последующего использования.

   ```JSON
   {
    "udid" : "{udId}"
   }
   ```


Теперь мы создадим функцию Azure в группе ресурсов ContosoRental и настроим маршрут для сообщений в Центре Интернета вещей, чтобы фильтровать сообщения телеметрии от устройств.


## <a name="create-an-azure-function-and-add-an-event-grid-subscription"></a>Создание функции в службе "Функции Azure" и добавление подписки на службу "Сетка событий"

Функции Azure — это бессерверная служба вычислений, которая позволяет выполнять код по требованию без необходимости явно подготавливать или администрировать вычислительную инфраструктуру. Дополнительные сведения о Функциях Azure см. в [этой документации](https://docs.microsoft.com/azure/azure-functions/functions-overview). Реализованная в этой функции логика позволяет оценить состояние геозоны по данным о расположении, полученным в телеметрии от устройства, установленного в автомобиле. Если некоторый автомобиль выходит за пределы геозоны, функция соберет дополнительные сведения о нем, например адрес расположения с помощью [API обратного поиска по адресу](https://docs.microsoft.com/rest/api/maps/search/getsearchaddressreverse), который преобразует координаты расположения в понятный для человека адрес улицы. Все сведения о событии затем сохраняются в хранилище больших двоичных объектов. В приведенном ниже шаге 5 демонстрируется исполняемый код, в котором реализована такая логика. Выполните следующие шаги, чтобы создать функцию Azure для отправки данных журнала в контейнер больших двоичных объектов, размещенный в учетной записи хранения, с указанием сведений о подписке службы "Сетка событий".

1. На панели мониторинга портала Azure щелкните "Создать ресурс". В списке доступных типов ресурсов выберите пункт **Вычислительные** и укажите вариант **Приложение-функция**.

    ![Создание ресурса](./media/tutorial-iot-hub-maps/create-resource.png)

2. На странице создания приложения-функции укажите для него имя, затем в разделе **Группа ресурсов** выберите вариант **Использовать существующую** и укажите ContosoRental в соответствующем раскрывающемся списке. Выберите .NET Core в качестве стека среды выполнения, затем для параметра **Хранилище** выберите вариант **Использовать существующее** и укажите contosorentaldata в раскрывающемся списке, после чего щелкните **Создать**.
    
    ![Создание приложения](./media/tutorial-iot-hub-maps/rental-app.png)

3. Завершив создание приложения, мы добавим в него функцию. Перейдите к созданному приложению-функции и щелкните **Создать функцию**, чтобы добавить новую функцию, выберите среду разработки **На портале** и щелкните **Продолжить**.

    ![Создание функции](./media/tutorial-iot-hub-maps/function.png)

4. Выберите **Дополнительные шаблоны** и щелкните **Завершить и просмотреть шаблоны**. 

5. Выберите шаблон с **триггером Сетки событий Azure**. Установите расширения, если появится такой запрос, и присвойте функции имя, а затем щелкните **Создать**.

    ![Шаблон функции](./media/tutorial-iot-hub-maps/eventgrid-funct.png)

6. Скопируйте [код C#](https://github.com/Azure-Samples/iothub-to-azure-maps-geofencing/blob/master/src/Azure%20Function/run.csx) в функцию и щелкните **Сохранить**.
 
7. В скрипте C# замените следующие параметры.
    * Замените значение **SUBSCRIPTION_KEY** реальным ключом подписки Azure Maps.
    * Замените значение **UDID** идентификатором отправленной ранее геозоны. 
    * Функция **CreateBlobAsync** в скрипте создает большой двоичный объект для каждого события в учетной записи хранения данных. Замените значения **ACCESS_KEY**, **ACCOUNT_NAME** и **STORAGE_CONTAINER_NAME** ключом доступа к учетной записи хранения, именем учетной записи и контейнером хранилища данных.

10. Щелкните **Добавить подписку Сетки событий**.
    
    ![Добавление Сетки событий](./media/tutorial-iot-hub-maps/add-egs.png)

11. Заполните сведения о подписке, в разделе **Сведения о подписке на события** укажите имя подписки и в качестве схемы событий выберите "Схема сетки событий". В разделе **Сведения о разделе** выберите "Тип раздела" — "Учетные записи Центра Интернета вещей Azure", затем выберите ту же подписку, что и для создания группы ресурсов, в качестве группы ресурсов — ContosoRental и в параметре "Ресурс" — созданный ранее Центр Интернета вещей. В качестве "Типа события" укажите **Телеметрия устройства**. Завершив выбор параметров, вы увидите, что "Тип раздела" автоматически изменится на "Центр Интернета вещей".

    ![Подписка службы "Сетка событий"](./media/tutorial-iot-hub-maps/af-egs.png)
 

## <a name="filter-events-using-iot-hub-message-routing"></a>Фильтрация событий с помощью маршрутизации сообщений, предоставляемой Центром Интернета вещей

Добавив подписку службы "Сетка событий" в функцию Azure, вы увидите маршрут по умолчанию, по которому отправляются сообщения в Сетку событий, в колонке **Маршрутизация сообщений** для Центра Интернета вещей. Маршрутизация сообщений позволяет вам перенаправлять в разные конечные точки разные типы данных, например сообщения телеметрии устройств, события жизненного цикла устройств и события изменения двойников устройств. Дополнительные сведения о маршрутизации сообщений с помощью Центра Интернета вещей вы найдете [здесь](https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-messages-d2c).

![Пример маршрута на концентраторе](./media/tutorial-iot-hub-maps/hub-route.png)

В нашем примере будут отфильтроваться все сообщения, полученные при перемещении арендованного автомобиля. Чтобы публиковать в сетку событий такие события телеметрии устройств, мы с помощью запроса маршрутизации будем фильтровать события, у которых свойство `Engine` имеет значение **ON**. Существует много способов выполнять запросы по сообщениям Интернета вещей, отправляемых с устройства в облако. Дополнительные сведения о синтаксисе маршрутизации сообщений вы найдете в [этой статье](https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-routing-query-syntax). Чтобы создать запрос маршрутизации, щелкните маршрут **RouteToEventGrid** и замените значение **Запрос маршрутизации** на строку **"Engine='ON'"** , а затем щелкните **Сохранить**. Теперь Центр Интернета вещей будет публиковать только те события телеметрии устройств, в которых параметр Engine имеет значение ON.

![Пример фильтра на концентраторе](./media/tutorial-iot-hub-maps/hub-filter.png)


## <a name="send-telemetry-data-to-iot-hub"></a>Отправка данных телеметрии в Центр Интернета вещей

Теперь, когда функция Azure полностью готова и работает, мы отправим данные телеметрии в Центр Интернета вещей, который передаст их в Сетку событий. Мы будем использовать приложение C# для имитации данных о местоположении, получаемых с устройства в арендованном автомобиле. Чтобы запустить это приложение, на компьютере разработки необходимо установить пакет SDK для .NET Core версии 2.1.0 или более поздней. Выполните следующие действия, чтобы отправить имитированные данные телеметрии в Центр Интернета вещей.

1. Скачайте проект C# [rentalCarSimulation](https://github.com/Azure-Samples/iothub-to-azure-maps-geofencing/tree/master/src/rentalCarSimulation). 

2. Откройте файл simulatedCar.cs в любом текстовом редакторе и замените в нем значение `connectionString` тем, которое вы сохранили при регистрации устройства, затем сохраните изменения в файле.
 
3. В локальном окне терминала перейдите к корневой папке проекта C# и выполните следующие команды, чтобы установить необходимые пакеты для приложения имитированного устройства.
    
    ```cmd/sh
    dotnet restore
    ```

4. В том же окне терминала выполните команды, которые компилируют и запускают приложение имитации устройства в арендованном автомобиле:

    ```cmd/sh
    dotnet run
    ```

  Теперь окно терминала должно содержать примерно такие данные:

  ![Выходные данные терминала](./media/tutorial-iot-hub-maps/terminal.png)

Теперь вы можете открыть контейнер хранилища BLOB-объектов и убедиться, что в нем созданы четыре двоичных объекта для расположений, в которых автомобиль находится за пределами геозоны.

![Ввод имени большого двоичного объекта](./media/tutorial-iot-hub-maps/blob.png)

На приведенной ниже карте показаны четыре точки, в которых транспортное средство находилось за пределами геозоны и данные о которых отправлялись через регулярные интервалы времени.

![Карта нарушений](./media/tutorial-iot-hub-maps/violation-map.png)

## <a name="next-steps"></a>Дополнительная информация

Для изучения API-интерфейсов Azure Maps, используемых в этом руководстве, прочтите следующие статьи.

* [Получение обратного адреса поиска](https://docs.microsoft.com/rest/api/maps/search/getsearchaddressreverse)
* [Получение геозоны](https://docs.microsoft.com/rest/api/maps/spatial/getgeofence)

Полный список API-интерфейсов Azure Maps вы найдете здесь:

* [Интерфейсы REST API для Azure Maps](https://docs.microsoft.com/rest/api/maps/spatial/getgeofence)

Дополнительные сведения см. в

* статье об [IoT Plug and Play](https://docs.microsoft.com/azure/iot-pnp).

Список устройств, сертифицированных для работы с Интернетом вещей в Azure, размещен на этой странице:

* [Сертифицированные для Azure устройства](https://catalog.azureiotsolutions.com/)

Дополнительные сведения о том, как отправлять данные телеметрии с устройства в облако или обратно, см. здесь:

* [Отправка данных телеметрии с устройства](https://docs.microsoft.com/azure/iot-hub/quickstart-send-telemetry-dotnet)
