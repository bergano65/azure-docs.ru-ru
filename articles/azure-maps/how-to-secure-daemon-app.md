---
title: Как защитить управляющую программу
titleSuffix: Azure Maps
description: Используйте портал Azure для управления проверкой подлинности, чтобы настроить доверенное приложение-управляющее.
author: philmea
ms.author: philmea
ms.date: 06/12/2020
ms.topic: conceptual
ms.service: azure-maps
services: azure-maps
manager: timlt
ms.openlocfilehash: 4fa3492b0cd71e61900dc4be150cd0f0169379ac
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "84988479"
---
# <a name="secure-a-daemon-application"></a>Защита управляющего приложения

Следующее руководством предназначено для фоновых процессов, таймеров и заданий, размещенных в надежной и защищенной среде. К примерам относятся веб-задания Azure, приложения функций Azure, службы Windows и любая другая надежная фоновая служба.

> [!Tip]
> Корпорация Майкрософт рекомендует реализовать Azure Active Directory (Azure AD) и управление доступом на основе ролей (RBAC) для рабочих приложений. Общие сведения об основных понятиях см. в разделе [Azure Mapsная проверка подлинности](./azure-maps-authentication.md).

[!INCLUDE [authentication details](./includes/view-authentication-details.md)]

## <a name="scenario-shared-key-authentication"></a>Сценарий: проверка подлинности с помощью общего ключа

После создания учетной записи Azure Maps создаются первичный и вторичный ключи. Рекомендуется использовать первичный ключ в качестве ключа подписки при [использовании проверки подлинности с общим ключом для вызова Azure Maps](https://docs.microsoft.com/azure/azure-maps/azure-maps-authentication#shared-key-authentication). Вторичный ключ можно использовать в таких сценариях, как изменение ключевых изменений. Дополнительные сведения см. [в разделе Проверка подлинности в Azure Maps](https://aka.ms/amauth).

### <a name="securely-store-shared-key"></a>Безопасное хранение общего ключа

Первичный и вторичный ключи разрешают авторизацию для всех API-интерфейсов для учетной записи Maps. Приложения должны хранить ключи в безопасном хранилище, например Azure Key Vault. Приложение должно получить общий ключ как секрет Azure Key Vault, чтобы избежать сохранения общего ключа в виде обычного текста в конфигурации приложения. Сведения о настройке Azure Key Vault см. в разделе [Руководство разработчика Azure Key Vault](https://docs.microsoft.com/azure/key-vault/general/developers-guide).

Этот процесс описан в следующих шагах.

1. Создайте хранилище ключей Azure.
2. Создание субъекта-службы Azure AD путем создания регистрации приложения или управляемого удостоверения, созданный участник несет ответственность за доступ к Azure Key Vault.
3. Назначьте субъекту-службе разрешение на доступ к секретам Azure Key Secret `Get` .
4. Временно назначьте доступ для секретных `Set` прав для вас как разработчика.
5. Задайте общий ключ в Key Vault секреты и укажите секретный код в качестве конфигурации управляющего приложения и удалите разрешение на секреты `Set` .
6. Реализуйте аутентификацию Azure AD в управляющем приложении, чтобы получить секрет общего ключа из Azure Key Vault.
7. Создайте Azure Maps REST API запрос с общим ключом.

> [!Tip]
> Если приложение размещено в среде Azure, следует реализовать управляемое удостоверение, чтобы снизить затраты и сложность управления секретом для проверки подлинности в Azure Key Vault. [Чтобы подключиться через управляемое удостоверение](https://docs.microsoft.com/azure/key-vault/general/tutorial-net-create-vault-azure-web-app), ознакомьтесь со следующим руководством Azure Key Vault.

Управляющее приложение отвечает за получение общего ключа из защищенного хранилища. Для реализации с Azure Key Vault требуется проверка подлинности в Azure AD для доступа к секрету. Вместо этого мы рекомендуем напрямую использовать проверку подлинности RBAC Azure AD, чтобы Azure Maps в результате дополнительных сложностей и эксплуатационных требований для использования проверки подлинности с использованием общего ключа.

> [!IMPORTANT]
> Чтобы упростить повторное создание ключей, мы рекомендуем использовать по одному ключу за раз. Затем приложения могут повторно создать неиспользуемый ключ и развернуть новый повторно созданный ключ в безопасном хранилище секретов, например Azure Key Vault.

## <a name="scenario-azure-ad-role-based-access-control"></a>Сценарий: Управление доступом на основе ролей в Azure AD

После создания учетной записи Azure Maps на `x-ms-client-id` странице сведений о проверке подлинности портал Azure отображается значение Azure Maps. Это значение представляет учетную запись, которая будет использоваться для запросов REST API. Это значение должно храниться в конфигурации приложения и извлекаться перед выполнением HTTP-запросов. Цель сценария заключается в том, чтобы позволить управляющему приложению проходить проверку подлинности в Azure AD и вызывать Azure Maps API-интерфейсы RESTFUL.

> [!Tip]
> Мы рекомендуем размещать виртуальные машины Azure, масштабируемые наборы виртуальных машин или службы приложений, чтобы обеспечить преимущества управляемых компонентов идентификации.

### <a name="daemon-hosted-on-azure-resources"></a>Управляющая программа, размещенная на ресурсах Azure

При работе в ресурсах Azure настройте управляемые удостоверения Azure для обеспечения низкой стоимости, минимальных усилий по управлению учетными данными. 

См. раздел [Обзор управляемых удостоверений](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview) , чтобы предоставить приложению доступ к управляемому удостоверению.

Преимущества управляемого удостоверения:

* Аутентификация шифрования открытого ключа сертификата X509, управляемого системой Azure.
* Безопасность Azure AD с сертификатами X509 вместо секретов клиента.
* Azure управляет и обновляет все сертификаты, связанные с управляемым ресурсом идентификации.
* Упрощенное управление учетными данными путем удаления любой необходимости в защищенной службе хранилища секретов, например Azure Key Vault. 

### <a name="daemon-hosted-on-non-azure-resources"></a>Управляющая программа размещена на ресурсах, не связанных с Azure

При запуске в среде, отличной от среды Azure, управляемые удостоверения недоступны. Поэтому необходимо настроить субъект-службу с помощью регистрации приложения Azure AD для управляющего приложения.

1. В портал Azure в списке служб Azure выберите **Azure Active Directory**  >  **Регистрация приложений**  >  **Новая регистрация**.  

    > [!div class="mx-imgBorder"]
    > ![Интеграция приложений с Azure Active Directory](./media/how-to-manage-authentication/app-registration.png)

2. Если вы уже зарегистрировали приложение, перейдите к следующему шагу. Если вы не зарегистрировали приложение, введите **имя**, выберите **тип учетной записи поддержки**и нажмите кнопку **зарегистрировать**.  

    > [!div class="mx-imgBorder"]
    > ![Сведения о регистрации приложения](./media/how-to-manage-authentication/app-create.png)

3. Чтобы назначить разрешения делегированного API для Azure Maps, перейдите в приложение. Затем в разделе **Регистрация приложений**выберите **разрешения API**  >  **Добавить разрешение**. В разделе API, которые **использует Моя организация**, найдите и выберите **Azure Maps**.

    > [!div class="mx-imgBorder"]
    > ![Добавить разрешения API приложения](./media/how-to-manage-authentication/app-permissions.png)

4. Установите флажок для **доступа к Azure Maps**, а затем выберите **Добавить разрешения**.

    > [!div class="mx-imgBorder"]
    > ![Выбор разрешений API приложения](./media/how-to-manage-authentication/select-app-permissions.png)

5. Выполните следующие действия, чтобы создать секрет клиента или настроить сертификат.

    * Если приложение использует проверку подлинности сервера или приложения, то на странице регистрации приложения перейдите в раздел **сертификаты & секреты**. Затем либо отправьте сертификат открытого ключа, либо создайте пароль, выбрав **новый секрет клиента**.

        > [!div class="mx-imgBorder"]
        > ![Создание секрета клиента](./media/how-to-manage-authentication/app-keys.png)

    * После нажатия **Добавить**скопируйте секрет и сохраните его в службе, например Azure Key Vault. Ознакомьтесь с [руководством по Azure Key Vault разработчиков](https://docs.microsoft.com/azure/key-vault/general/developers-guide) для безопасного хранения сертификата или секрета. Вы будете использовать этот секрет для получения маркеров из Azure AD.

        > [!div class="mx-imgBorder"]
        > ![Добавление секрета клиента](./media/how-to-manage-authentication/add-key.png)

### <a name="grant-role-based-access-for-the-daemon-application-to-azure-maps"></a>Предоставление управляющей программы доступа на основе ролей для Azure Maps

Вы предоставляете *Управление доступом на основе ролей* (RBAC), назначив созданное управляемое удостоверение или субъект-службу одному или нескольким определениям ролей управления доступом Azure Maps. Чтобы просмотреть определения ролей RBAC, доступные для Azure Maps, перейдите в раздел **Управление доступом (IAM)**. Выберите **роли**, а затем найдите роли, которые начинаются с *Azure Maps*. Эти Azure Maps роли являются ролями, к которым можно предоставить доступ.

> [!div class="mx-imgBorder"]
> ![Просмотр доступных ролей](./media/how-to-manage-authentication/how-to-view-avail-roles.png)

1. Перейдите к **учетной записи Azure Maps**. Выберите назначения ролей **управления доступом (IAM)**  >  **Role assignments**.

    > [!div class="mx-imgBorder"]
    > ![Предоставление RBAC](./media/how-to-manage-authentication/how-to-grant-rbac.png)

2. На вкладке **назначения ролей** **добавьте** назначение ролей. 
    
    > [!div class="mx-imgBorder"]
    > ![Добавление назначения роли](./media/how-to-manage-authentication/add-role-assignment.png)

3. Выберите встроенное определение роли Azure Maps, например **Azure Maps модуль чтения данных** или **участник данных Azure Maps**. В разделе **назначить доступ к**выберите **пользователь Azure AD, группа или субъект-служба** или управляемое удостоверение с назначенным пользователем управляемым удостоверением назначенная система **управляемого удостоверения**  /  **System assigned Managed identity**. Выберите участника. Затем нажмите кнопку **Save** (Сохранить).

    > [!div class="mx-imgBorder"]
    > ![Добавление назначения роли](./media/how-to-manage-authentication/how-to-add-role-assignment.png)

4. Вы можете подтвердить, что назначение роли было применено на вкладке Назначение ролей.

## <a name="request-token-with-managed-identity"></a>Маркер запроса с управляемым удостоверением

После настройки управляемого удостоверения для ресурса размещения используйте пакет Azure SDK или REST API, чтобы получить маркер для Azure Maps, см. сведения о [получении маркера доступа](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/how-to-use-vm-token). В соответствии с руководством, ожидание заключается в том, что будет возвращен маркер доступа, который может использоваться в запросах REST API.

## <a name="request-token-with-application-registration"></a>Маркер запроса с регистрацией приложения

После регистрации приложения и связывания его с Azure Maps можно запросить маркеры доступа.

* Идентификатор ресурса Azure AD`https://atlas.microsoft.com/`
* Идентификатор приложения Azure AD
* Идентификатор клиента Azure AD
* Секрет клиента регистрации Azure AD App

Запрос:

```http
POST /<Azure AD Tenant ID>/oauth2/token HTTP/1.1
Host: login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

client_id=<Azure AD App ID>&resource=https://atlas.microsoft.com/&client_secret=<client secret>&grant_type=client_credentials
```

Ответ:

```json
{
    "token_type": "Bearer",
    "expires_in": "...",
    "ext_expires_in": "...",
    "expires_on": "...",
    "not_before": "...",
    "resource": "https://atlas.microsoft.com/",
    "access_token": "ey...gw"
}
```

Более подробные примеры см. в статье [сценарии проверки подлинности в Azure AD](https://docs.microsoft.com/azure/active-directory/develop/authentication-scenarios).

## <a name="next-steps"></a>Дальнейшие шаги

Найдите метрики использования API для учетной записи Azure Maps:
> [!div class="nextstepaction"]
> [Просмотр метрик использования](how-to-view-api-usage.md)

Просмотрите примеры, демонстрирующие интеграцию Azure AD с Azure Maps:
> [!div class="nextstepaction"]
> [Примеры Azure Maps](https://github.com/Azure-Samples/Azure-Maps-AzureAD-Samples)
