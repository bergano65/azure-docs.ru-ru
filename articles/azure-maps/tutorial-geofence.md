---
title: Создание геозоны с помощью Azure Maps | Документация Майкрософт
description: Настройка геозоны с использованием Azure Maps.
author: walsehgal
ms.author: v-musehg
ms.date: 02/14/2019
ms.topic: tutorial
ms.service: azure-maps
services: azure-maps
manager: timlt
ms.custom: mvc
ms.openlocfilehash: 55dc0fa31398bcc04d9793c8cffc9258dc29e4c7
ms.sourcegitcommit: b3d74ce0a4acea922eadd96abfb7710ae79356e0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2019
ms.locfileid: "56244459"
---
# <a name="set-up-a-geofence-by-using-azure-maps"></a>Настройка геозоны с использованием Azure Maps

Этот руководство поможет выполнить основные действия по настройке геозоны с помощью Azure Maps. Сценарий, который мы рассмотрим в этом руководстве — помощь начальству строительной площадки в отслеживании перемещения потенциально опасного оборудования за пределы установленных границ строительного участка. Строительство предусматривает использование дорогостоящего оборудования и соблюдение разнообразных нормативов. Обычно существует требование о том, чтобы строительное оборудование находилось на строительной площадке и не вывозилось за ее пределы без разрешения.

Мы будем использовать API отправки данных Azure Maps для сохранения данных о геозоне и API геозоны Azure Maps для проверки расположения оборудования относительно геозоны. Сетка событий Azure будет выполнять потоковую передачу результатов геозоны и на их основе создавать уведомления.
Дополнительные сведения о Сетке событий Azure см. в статье [Что такое служба "Сетка событий Azure"?](https://docs.microsoft.com/azure/event-grid/overview)
Задачи, рассматриваемые в этом руководстве:

> [!div class="checklist"]
* Передача данных о геозоне в службу данных Azure Maps с помощью API отправки данных.
*   Настройка Сетки событий для обработки событий геозоны.
*   Настройка обработчика событий геозоны.
*   Настройка оповещений на основе событий геозоны с помощью Logic Apps.
*   Проверка нахождения оборудования на строительной площадке с помощью API службы геозоны Azure Maps.


## <a name="prerequisites"></a>Предварительные требования

### <a name="create-an-azure-maps-account"></a>создание учетной записи службы "Карты Azure"; 

Для выполнения заданий из этого руководства вам сначала необходимо узнать, как [управлять учетной записью и ключами](how-to-manage-account-keys.md), чтобы создать учетную запись Azure Maps ценовой категории S1.

## <a name="upload-geofences"></a>Отправка данных о геозоне

Чтобы отправить данные о геозоне строительной площадки с помощью API отправки данных, мы воспользуемся приложением Postman. В этом руководстве предполагается, что существует некая строительная площадка, и находящееся на ней строительное оборудование категорически запрещено вывозить за ее пределы. Нарушение этого требования является серьезным происшествием, о котором необходимо доложить руководителю работ. Для отслеживания выполнения работ согласно графику на отдельных участках строительной площадки можно использовать оптимизированный набор дополнительных геозон. Предполагается, что для основной геозоны subsite1 задан срок действия, по истечении которого она не будет отслеживаться. В основной геозоне вы можете создать вложенные геозоны в соответствии с вашими требованиями. Например, геозона subsite1 может быть назначена участку, на котором работы выполняются с 1-й по 4-ю неделю, а геозона subsite2 — участку с работами с 5-й по 7-ю недели. Все эти геозоны можно добавить как один набор данных в начале проекта и использовать для отслеживания правил на основе времени и места. Дополнительные сведения о формате данных геозоны см. в статье о [геоданных в формате JSON](https://docs.microsoft.com/azure/azure-maps/geofence-geojson). Дополнительные сведения о загрузке данных в службу Azure Maps см. в статье об [API отправки данных](https://docs.microsoft.com/rest/api/maps/data/uploadpreview).

Откройте приложение Postman и следуйте дальнейшим инструкциям по отправке данных о геозоне строительной площадки с использованием Azure Maps и API отправки данных.

1. Откройте приложение Postman и в раскрывающемся списке New (Создать) щелкните Create New (Создать) и выберите Request (Запрос). Введите имя запроса, чтобы отправить данные о геозоне, выберите коллекцию или папку, в которую нужно их сохранить, и щелкните Save (Сохранить).

    ![Отправка данных о геозоне с помощью Postman](./media/tutorial-geofence/postman-new.png)

2. Выберите метод POST HTTP на вкладке конструктора и введите следующий URL-адрес для выполнения запроса POST.

    ```HTTP
    https://atlas.microsoft.com/mapData/upload?subscription-key={subscription-key}&api-version=1.0&dataFormat=geojson
    ```
    
    Параметр GEOJSON в пути URL-адреса определяет формат отправляемых данных.

3. Щелкните **Params** (Параметры) и введите следующие пары "ключ — значение" для URL-адреса запроса POST. Замените значение ключа подписки своим ключом подписки на Azure Maps.
   
    ![Пары "ключ — значение" на вкладке параметров приложения Postman](./media/tutorial-geofence/postman-key-vals.png)

4. Перейдите на вкладку **Body** (Текст) и выберите необработанный формат входных данных, а затем, в раскрывающемся списке — JSON в качестве формата входных данных. Введите следующие данные для отправки в формате JSON:

   ```JSON
   {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  -122.13393688201903,
                  47.63829579223815
                ],
                [
                  -122.13389128446579,
                  47.63782047131512
                ],
                [
                  -122.13240802288054,
                  47.63783312249837
                ],
                [
                  -122.13238388299942,
                  47.63829037035086
                ],
                [
                  -122.13393688201903,
                  47.63829579223815
                ]
              ]
            ]
          },
          "properties": {
            "geometryId": "1"
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  -122.13374376296996,
                  47.63784758098976
                ],
                [
                  -122.13277012109755,
                  47.63784577367854
                ],
                [
                  -122.13314831256866,
                  47.6382813338708
                ],
                [
                  -122.1334782242775,
                  47.63827591198201
                ],
                [
                  -122.13374376296996,
                  47.63784758098976
                ]
              ]
            ]
          },
          "properties": {
            "geometryId": "2",
            "validityTime": {
              "expiredTime": "2019-01-15T00:00:00",
              "validityPeriod": [
                {
                  "startTime": "2019-01-08T01:00:00",
                  "endTime": "2019-01-08T17:00:00",
                  "recurrenceType": "Daily",
                  "recurrenceFrequency": 1,
                  "businessDayOnly": true
                }
              ]
            }
          }
        }
      ]
   }
   ```

5. Отправьте данные и проверьте заголовок ответа. Заголовок со сведениями о расположении будет содержать URI для доступа к данным или их отправки впоследствии. Он также будет включать уникальное значение `udId` для отправленных данных.

  ```HTTP
  https://atlas.microsoft.com/mapData/{udId}/status?api-version=1.0&subscription-key={Subscription-key}
  ```

## <a name="set-up-an-event-handler"></a>Настройка обработчика событий

Для извещения руководителя работ о пересечении строительным оборудованием границ геозоны необходимо создать обработчик событий, получающий уведомления.

Мы создадим две службы [Logic Apps](https://docs.microsoft.com/azure/event-grid/event-handlers#logic-apps) для обработки событий, связанных с пересечением оборудованием границ геозоны. В Logic Apps мы также создадим триггеры событий, активируемые этими событиями. Задача в том, чтобы отправлять оповещения руководителю работ, в нашем случае по электронной почте, всякий раз, когда оборудование пересекает границу строительной площадки. Снимок экрана демонстрирует создание приложения логики для геозоны, которое контролирует поступление оборудования. Аналогичным образом можно создать приложение, которое контролирует перемещение оборудования за пределы геозоны.
Дополнительные сведения см. в статье [Обработчики событий в службе "Сетка событий Azure"](https://docs.microsoft.com/azure/event-grid/event-handlers).

1. Создайте приложение логики на портале Azure.

  ![Создание приложения логики](./media/tutorial-geofence/logic-app.png)

2. Выберите триггер HTTP-запроса, а затем — "Отправить сообщение" в соединителе Outlook.
  
  ![Схема приложения логики](./media/tutorial-geofence/logic-app-schema.png)

3. Сохраните приложение логики, чтобы создать конечную точку URL-адреса HTTP и скопируйте URL-адрес HTTP.

  ![Конечная точка приложения логики](./media/tutorial-geofence/logic-app-endpoint.png)


## <a name="create-an-azure-maps-events-subscription"></a>Создайте подписку на события Azure Maps.

Azure Maps поддерживает три типа событий. Сведения о типах событий, поддерживаемых Azure Maps, см. [в этой статье](https://docs.microsoft.com/azure/event-grid/event-schema-azure-maps). Мы создадим две подписки: одну для событий поступления оборудования на строительную площадку, вторую для событий, когда оно ее покидает.

Выполните следующие действия, чтобы создать подписку на события поступления оборудования в геозону. Создать подписку на события вывоза оборудования можно таким же образом.

1. Перейдите к своей учетной записи Azure Maps по [этой ссылке](https://ms.portal.azure.com/#@microsoft.onmicrosoft.com/dashboard/) и откройте вкладку событий.

   ![События Azure Maps](./media/tutorial-geofence/events-tab.png)

2. Чтобы создать подписку на события, выберите "Подписка на события" на странице событий.

   ![Подписка на события Azure Maps](./media/tutorial-geofence/create-event-subscription.png)

3. Задайте имя подписке на события и подпишитесь на событие поступления оборудования. Для параметра "Тип конечной точки" задайте вариант "Веб-перехватчик" и скопируйте конечную точку URL-адреса HTTP своего приложения логики в поле "Конечная точка".

   ![Подписка на события](./media/tutorial-geofence/events-subscription.png)


## <a name="use-geofence-api"></a>Использование API геозоны

С помощью API геозоны можно проверять, находится ли **устройство** (которым может быть и оборудование ) в пределах или за пределами геозоны. Запрос GET к API для получения данных о геозоне выполняется для того, чтобы получить данные из тех мест, где периодически происходит перемещение определенного оборудования. На следующем рисунке в хронологическом порядке показаны пять расположений определенного строительного оборудования с уникальным **идентификатором устройства**. Каждое из этих расположений оценивается для проверки того, находится ли устройство в пределах или за пределами геозоны. Если происходит изменение состояния, служба геозоны активирует событие, которое направляется в приложение логики Сеткой событий. В итоге руководитель работ получает сообщение по электронной почте о соответствующем событии.

> [!Note]
> Этот сценарий и механизм основаны на оценке одного **идентификатора устройства**, расположение которого фиксировалось в пяти разных местах, как показано на рисунке.

![Схема геозоны](./media/tutorial-geofence/geofence.png)

В приложении Postman откройте новую вкладку в ранее созданной коллекции. Выберите метод GET HTTP на вкладке конструктора.

Ниже показаны пять запросов HTTP GET к API геозоны с различными соответствующими координатами расположения оборудования в хронологическом порядке. Каждый запрос сопровождается текстом ответа.
 
1. Расположение 1
    
  ```HTTP
  https://atlas.microsoft.com/spatial/geofence/json?subscription-key={subscription-key}&api-version=1.0&deviceId=device_01&udId={udId}&lat=47.638237&lon=-122.1324831&searchBuffer=5&isAsync=True&mode=EnterAndExit
  ```
  ![Первый запрос данных о геозоне](./media/tutorial-geofence/geofence-query1.png)

  В приведенном выше ответе отрицательное значение расстояния от основной геозоны означает, что оборудование находится в пределах геозоны, а положительное значение из дочерней геозоны означает, что оборудование покинуло ее. 

2. Расположение 2 
   
  ```HTTP
  https://atlas.microsoft.com/spatial/geofence/json?subscription-key={subscription-key}&api-version=1.0&deviceId=device_01&udId={udId}&lat=47.63800&lon=-122.132531&searchBuffer=5&isAsync=True&mode=EnterAndExit
  ```
    
  ![Второй запрос данных о геозоне](./media/tutorial-geofence/geofence-query2.png)

  Из приведенного выше ответа в формате JSON следует, что оборудование находится за пределами дочерней геозоны, но в границах основной геозоны. Это обстоятельство не инициирует событие и сообщение электронной почты не отправляется.

3. Расположение 3 
  
  ```HTTP
  https://atlas.microsoft.com/spatial/geofence/json?subscription-key={subscription-key}&api-version=1.0&deviceId=device_01&udId={udId}&lat=47.63810783315048&lon=-122.13336020708084&searchBuffer=5&isAsync=True&mode=EnterAndExit
  ```

  ![Третий запрос данных о геозоне](./media/tutorial-geofence/geofence-query3.png)

  Произошло изменение состояния, и оборудование теперь находится как в основной, так и в дочерней геозоне. Это обстоятельство активирует событие и уведомления о нем направляется руководителю работ по электронной почте.

4. Расположение 4 

  ```HTTP
  https://atlas.microsoft.com/spatial/geofence/json?subscription-key={subscription-key}&api-version=1.0&deviceId=device_01&udId={udId}&lat=47.637988&lon=-122.1338344&searchBuffer=5&isAsync=True&mode=EnterAndExit
  ```
  
  ![Четвертый запрос данных о геозоне](./media/tutorial-geofence/geofence-query4.png)

   Из ответа видно, что, хотя оборудование и покинуло дочернюю геозону, событие не было инициировано. Если обратить внимание на указанное пользователем время в запросе GET, видно, что срок действия геозоны истек к этому времени, а оборудование по-прежнему находится в основной геозоне. В строке ответа `expiredGeofenceGeometryId` также можно увидеть идентификатор геометрии дочерней геозоны.


5. Расположение 5
      
  ```HTTP
  https://atlas.microsoft.com/spatial/geofence/json?subscription-key={subscription-key}&api-version=1.0&deviceId=device_01&udId={udId}&lat=47.63799&lon=-122.134505&userTime=2019-01-16&searchBuffer=5&isAsync=True&mode=EnterAndExit
  ```

  ![Пятый запрос данных о геозоне](./media/tutorial-geofence/geofence-query5.png)

  Видно, что оборудование покинуло основную геозону строительной площадки. Инициируется событие, свидетельствующее о серьезном нарушении, и руководителю работ направляется электронное сообщение с пометкой о его важности.

## <a name="next-steps"></a>Дополнительная информация

Из этого руководстве вы узнали, как настраивать геозону, передав ее данные в службу данных Azure Maps с помощью API отправки данных. Вы также научились подписываться на события геозоны и обрабатывать их в Сетке событий Azure Maps. 

* Сведения о создании более сложной логики с помощью Logic Apps и данных в формате JSON см. в статье [Обработка типов содержимого в Azure Logic Apps](https://docs.microsoft.com/azure/logic-apps/logic-apps-content-type).
* Дополнительные сведения об обработчиках событий в службе "Сетка событий" см. в статье [Обработчики событий в службе "Сетка событий Azure"](https://docs.microsoft.com/azure/event-grid/event-handlers).
