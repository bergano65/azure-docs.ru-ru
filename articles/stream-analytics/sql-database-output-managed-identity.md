---
title: Использование управляемых удостоверений для доступа к базе данных SQL Azure или Azure синапсе Analytics — Azure Stream Analytics
description: В этой статье описывается, как использовать управляемые удостоверения для проверки подлинности задания Azure Stream Analytics в базе данных SQL Azure или на выходе Azure синапсе Analytics.
author: mamccrea
ms.author: mamccrea
ms.service: stream-analytics
ms.topic: how-to
ms.date: 11/30/2020
ms.openlocfilehash: ee617b50d85f611e130ec5533239c8924efecc6b
ms.sourcegitcommit: 9eda79ea41c60d58a4ceab63d424d6866b38b82d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/30/2020
ms.locfileid: "96352190"
---
# <a name="use-managed-identities-to-access-azure-sql-database-or-azure-synapse-analytics-from-an-azure-stream-analytics-job-preview"></a>Использование управляемых удостоверений для доступа к базе данных SQL Azure или Azure синапсе Analytics из задания Azure Stream Analytics (Предварительная версия)

Azure Stream Analytics поддерживает [проверку подлинности управляемого удостоверения](../active-directory/managed-identities-azure-resources/overview.md) для базы данных SQL Azure и приемников вывода аналитики Azure синапсе. Управляемые удостоверения устраняют ограничения методов проверки подлинности на основе пользователя, например, необходимость повторной проверки подлинности в связи с изменением пароля или истечением срока действия пользовательского токена, которое происходит каждые 90 дней. При устранении необходимости в ручной проверке подлинности ваши развертывания Stream Analytics можно полностью автоматизировать.

Управляемое удостоверение — это зарегистрированное в Azure Active Directory управляемое приложение, представляющее данное задание Stream Analytics. Управляемое приложение используется для проверки подлинности в целевом ресурсе. В этой статье показано, как включить управляемое удостоверение для базы данных SQL Azure или выходные данные аналитики Azure синапсе для задания Stream Analytics с помощью портал Azure.

## <a name="prerequisites"></a>Предварительные требования

#### <a name="azure-sql-database"></a>[База данных SQL Azure](#tab/azure-sql)

Для использования этой функции необходимо следующее:

- Задание Azure Stream Analytics.

- Ресурс для Базы данных SQL Azure.

#### <a name="azure-synapse-analytics"></a>[Azure Synapse Analytics](#tab/azure-synapse)

Для использования этой функции необходимо следующее:

- Задание Azure Stream Analytics.

- Пул SQL Azure синапсе Analytics.

- Учетная запись хранения Azure, [настроенная для задания Stream Analytics](azure-synapse-analytics-output.md).

---

## <a name="create-a-managed-identity"></a>Создание управляемого удостоверения

Сначала вы создадите управляемое удостоверение для задания Azure Stream Analytics.

1. На [портале Azure](https://portal.azure.com) откройте задание Stream Analytics.

1. В меню навигации слева в разделе **Настройка** щелкните **Управляемое удостоверение**. Затем установите флажок **Использовать управляемое удостоверение, назначаемое системой** и нажмите кнопку **Сохранить**.

   ![Выбор управляемого удостоверения, назначаемого системой](./media/sql-db-output-managed-identity/system-assigned-managed-identity.png)

   Субъект-служба для удостоверения задания Stream Analytics создается в Azure Active Directory. Жизненным циклом нового удостоверения будет управлять Azure. При удалении задания Stream Analytics Azure автоматически удаляет связанное удостоверение (то есть субъект-службу).

1. Если конфигурация сохраняется, идентификатор объекта (OID) субъекта-службы отображается в качестве идентификатора субъекта, как показано ниже: 

   ![Идентификатор объекта, отображаемый в качестве идентификатора субъекта](./media/sql-db-output-managed-identity/principal-id.png)

   Субъект-служба имеет то же имя, что и задание Stream Analytics. Например, если имя задания — *MyASAJob*, имя созданного субъекта-службы будет также *MyASAJob*.

## <a name="select-an-active-directory-admin"></a>Выбор администратора Active Directory

После создания управляемого удостоверения необходимо выбрать администратора Active Directory.

1. Перейдите к базе данных SQL Azure или ресурсу Azure синапсе Analytics и выберите SQL Server, в которой находится база данных. Имя SQL Server можно найти рядом с разделом *Имя сервера* на странице обзора ресурсов.

1. Выберите **Администратор Active Directory** в разделе **Параметры**. Затем выберите **Задать администратора**.

   ![Страница администрирования Active Directory](./media/sql-db-output-managed-identity/active-directory-admin-page.png)

1. На странице администрирования Active Directory выберите пользователя (или группу), чтобы назначить его администратором SQL Server, и нажмите кнопку **Выбрать**.

   ![Добавление администратора Active Directory](./media/sql-db-output-managed-identity/add-admin.png)

   На странице "Администратор Active Directory" отобразятся все участники и группы Active Directory. Пользователи или группы, которые недоступны, не могут быть выбраны, так как они не поддерживаются как администраторы Azure Active Directory. Список поддерживаемых администраторов см. в разделе **Azure Active Directory функции и ограничения**   статьи [использование проверки подлинности Azure Active Directory для проверки подлинности с помощью базы данных SQL или Azure синапсе](../azure-sql/database/authentication-aad-overview.md#azure-ad-features-and-limitations). Управление доступом на основе ролей Azure (Azure RBAC) применяется только к порталу и не распространяется на SQL Server. Кроме того, выбранный пользователь или выбранная группа могут создать **пользователя автономной базы данных** в следующем разделе.

1. На странице **Администратор Active Directory** нажмите кнопку **Сохранить**. Процесс смены администратора занимает несколько минут.

   При настройке администратора Azure Active Directory новое имя администратора (пользователя или группы) не может присутствовать в виртуальной базе данных-источнике в качестве пользователя проверки подлинности SQL Server. Если этот параметр присутствует, то Установка администратора Azure Active Directory завершится сбоем и будет выполнена откат, что означает, что администратор (имя) уже существует. Так как пользователь SQL Server проверки подлинности не является частью Azure Active Directory, все усилия по подключению к серверу с использованием проверки подлинности Azure Active Directory в случае сбоя этого пользователя. 

## <a name="create-a-contained-database-user"></a>Создание пользователя автономной базы данных

Далее вы создадите пользователя автономной базы данных в базе данных SQL Azure или Azure синапсе, которая сопоставлена с удостоверением Azure Active Directory. У пользователя автономной базы данных нет имени входа для базы данных-источника, но оно сопоставляется с удостоверением в каталоге, связанном с базой данных. Удостоверением Azure AD может быть учетная запись отдельного пользователя или группы. В этом случае необходимо создать пользователя автономной базы данных для задания Stream Analytics. 

1. Подключитесь к базе данных Azure SQL или Azure синапсе с помощью SQL Server Management Studio. В качестве **имени пользователя** укажите пользователь Azure Active Directory с разрешением **ALTER ANY USER**. Примером может быть администратор, заданный в SQL Server. Используйте универсальную проверку подлинности **Azure Active Directory с MFA**. 

   ![Подключение к SQL Server](./media/sql-db-output-managed-identity/connect-sql-server.png)

   Имя сервера `<SQL Server name>.database.windows.net` может отличаться в разных регионах. Например, в регионе Китая используйте `<SQL Server name>.database.chinacloudapi.cn`.
 
   Вы можете указать определенную базу данных SQL Azure или Azure синапсе, выбрав **параметры > свойства соединения > подключиться к базе данных**.  

   ![Свойства подключения SQL Server](./media/sql-db-output-managed-identity/sql-server-connection-properties.png)

1. При первом подключении может появиться следующее окно:

   ![Окно нового правила брандмауэра](./media/sql-db-output-managed-identity/new-firewall-rule.png)

   1. В этом случае перейдите к ресурсу SQL Server на портале Azure. В разделе **Безопасность** откройте страницу **Брандмауэры и виртуальная сеть**. 
   1. Добавьте новое правило с любым именем.
   1. Используйте IP-адрес *Из* в окне **Новое правило брандмауэра** для параметра *Начальный IP-адрес*.
   1. Используйте IP-адрес *К* в окне **Новое правило брандмауэра** для параметра *Конечный IP-адрес*. 
   1. Нажмите кнопку **Сохранить** и повторите попытку подключения из SQL Server Management Studio. 

1. После подключения создайте пользователя автономной базы данных. Следующая команда SQL создает пользователя автономной базы данных с тем же именем, что и у задания Stream Analytics. Не забудьте добавить квадратные скобки вокруг *ASA_JOB_NAME*. Используйте следующий синтаксис T-SQL и выполните запрос. 

   ```sql
   CREATE USER [ASA_JOB_NAME] FROM EXTERNAL PROVIDER; 
   ```

1. Чтобы с помощью Microsoft Azure Active Directory можно было проверить, имеет ли задание Stream Analytics доступ к базе данных SQL, необходимо предоставить Azure Active Directory разрешение на взаимодействие с базой данных. Для этого перейдите на страницу "брандмауэры и виртуальная сеть" в портал Azure снова и включите "разрешить службам Azure и ресурсам доступ к серверу". 

   ![Брандмауэр и виртуальная сеть](./media/sql-db-output-managed-identity/allow-access.png)

## <a name="grant-stream-analytics-job-permissions"></a>Предоставление разрешений заданию Stream Analytics

#### <a name="azure-sql-database"></a>[База данных SQL Azure](#tab/azure-sql)

После создания пользователя автономной базы данных и получения доступа к службам Azure на портале, как описано в предыдущем разделе, у задания Stream Analytics есть разрешение на **Подключение** к ресурсу базы данных SQL Azure через управляемое удостоверение с помощью управляемого удостоверения. Рекомендуется предоставить заданию Stream Analytics разрешения SELECT и INSERT, так как они понадобятся позже в рабочем процессе Stream Analytics. Разрешение **SELECT** позволяет заданию проверить подключение к таблице в базе данных SQL Azure. Разрешение **INSERT** позволяет проводить сквозное тестирование Stream Analytics запросов после настройки входных данных и выходного файла SQL Azure.

#### <a name="azure-synapse-analytics"></a>[Azure Synapse Analytics](#tab/azure-synapse)

После создания пользователя автономной базы данных и получения доступа к службам Azure на портале, как описано в предыдущем разделе, ваше задание Stream Analytics имеет разрешение от управляемого удостоверения для **подключения** к ресурсу базы данных Azure синапсе через управляемое удостоверение. Рекомендуется дополнительно предоставить заданиям Stream Analytics, INSERT и АДМИНИСТРировать групповые операции базы данных, так как они понадобятся позже в рабочем процессе Stream Analytics. Разрешение **SELECT** позволяет заданию проверить подключение к таблице в базе данных синапсе Azure. Разрешения на **вставку** и **Администрирование для операций с массовыми базами данных** позволяют выполнять тестирование сквозных Stream Analytics запросов после настройки входных данных и выходного файла синапсе в Azure.

Чтобы предоставить разрешение на управление МАССОВЫми ОПЕРАЦИЯми базы данных, необходимо предоставить всем разрешениям, которые помечены как **элементы управления** , [подразумеваемые разрешением базы данных](/sql/t-sql/statements/grant-database-permissions-transact-sql?view=azure-sqldw-latest#remarks) для задания Stream Analytics. Это разрешение необходимо, так как задание Stream Analytics выполняет инструкцию COPY, для которой требуется [Администрирование операций с массовыми БАЗАМИ данных и вставки](/sql/t-sql/statements/copy-into-transact-sql).

---

Эти разрешения можно предоставить заданию Stream Analytics с помощью среды SQL Server Management Studio. Дополнительные сведения см. в справочнике по работе с командой GRANT (Transact-SQL).

Чтобы предоставить разрешение только для определенной таблицы или объекта в базе данных, используйте следующий синтаксис T-SQL и выполните запрос. 

#### <a name="azure-sql-database"></a>[База данных SQL Azure](#tab/azure-sql)

```sql
GRANT SELECT, INSERT ON OBJECT::TABLE_NAME TO ASA_JOB_NAME;
```

#### <a name="azure-synapse-analytics"></a>[Azure Synapse Analytics](#tab/azure-synapse)

```sql
GRANT [PERMISSION NAME] OBJECT::TABLE_NAME TO ASA_JOB_NAME;
```

---

Кроме того, можно щелкнуть правой кнопкой мыши базу данных SQL Azure или Azure синапсе в SQL Server Management Studio и выбрать **свойства > разрешения**. В меню разрешения можно просмотреть задание Stream Analytics, добавленное ранее, а затем по своему усмотрению вручную предоставить или отменить разрешения.

## <a name="create-an-azure-sql-database-or-azure-synapse-output"></a>Создание базы данных SQL Azure или Azure синапсе Output

#### <a name="azure-sql-database"></a>[База данных SQL Azure](#tab/azure-sql)

Теперь, когда вы настроили управляемое удостоверение, вы можете добавить в задание Stream Analytics базу данных SQL Azure или выходные данные Azure синапсе.

Таблицу в базе данных SQL необходимо создавать с соответствующей выходной схемой. Имя этой таблицы — одно из обязательных свойств, которые должны быть заполнены при добавлении выходных данных базы данных SQL в задание Stream Analytics. Кроме того, для проверки подключения и выполнения запросов Stream Analytics заданию необходимо предоставить разрешения **SELECT** и **INSERT**. Если вы еще не сделали этого, ознакомьтесь с разделом [Предоставление разрешений заданию Stream Analytics](#grant-stream-analytics-job-permissions). 

1. Вернитесь к заданию Stream Analytics и перейдите на страницу **Выходные данные** в разделе **Топология задания**. 

1. Щелкните **Добавить > База данных SQL**. В окне свойств выходных данных приемника Базы данных SQL выберите **Управляемое удостоверение** из раскрывающегося списка режима проверки подлинности.

1. Укажите остальные свойства. Дополнительные сведения о создании выходных данных для Базы данных SQL см. в разделе [База данных SQL](sql-database-output.md). По завершении нажмите кнопку **Сохранить**.

#### <a name="azure-synapse-analytics"></a>[Azure Synapse Analytics](#tab/azure-synapse)

Теперь, когда вы настроили управляемое удостоверение и учетную запись хранения, вы можете добавить в задание Stream Analytics базу данных SQL Azure или выходные данные Azure синапсе.

Убедитесь, что вы создали в базе данных Azure синапсе таблицу с соответствующей выходной схемой. Имя этой таблицы является одним из обязательных свойств, которые необходимо заполнить при добавлении выходных данных Azure синапсе в задание Stream Analytics. Кроме того, для проверки подключения и выполнения запросов Stream Analytics заданию необходимо предоставить разрешения **SELECT** и **INSERT**. Если вы еще не сделали этого, ознакомьтесь с разделом [Предоставление разрешений заданию Stream Analytics](#grant-stream-analytics-job-permissions).

1. Вернитесь к заданию Stream Analytics и перейдите на страницу **Выходные данные** в разделе **Топология задания**.

1. Выберите **добавить > Azure синапсе Analytics**. В окне свойств выходных данных приемника Базы данных SQL выберите **Управляемое удостоверение** из раскрывающегося списка режима проверки подлинности.

1. Укажите остальные свойства. Дополнительные сведения о создании выходных данных Azure синапсе см. в статье [Azure синапсе Analytics from Azure Stream Analytics](azure-synapse-analytics-output.md). По завершении нажмите кнопку **Сохранить**.

---

## <a name="remove-managed-identity"></a>Удалить управляемое удостоверение

Управляемое удостоверение, созданное для задания Stream Analytics, удаляется только при удалении задания. Невозможно удалить управляемое удостоверение, не удаляя задание. Если вы больше не хотите использовать управляемое удостоверение, можно изменить метод проверки подлинности для выходных данных. Управляемое удостоверение будет продолжать существовать до тех пор, пока задание не будет удалено, и будет использоваться при повторном использовании проверки подлинности с управляемым удостоверением.

## <a name="next-steps"></a>Дальнейшие действия

* [Описание выходных данных из Azure Stream Analytics](stream-analytics-define-outputs.md)
* [Вывод данных Azure Stream Analytics в базу данных SQL Azure](stream-analytics-sql-output-perf.md)
* [Выходные данные аналитики Azure синапсе из Azure Stream Analytics](azure-synapse-analytics-output.md)
