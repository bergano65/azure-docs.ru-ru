---
title: Запуск Azure Stream Analytics на Azure Stack (Предварительная версия)
description: Создайте Azure Stream Analytics задание ребра и разверните его в центре Azure Stack с помощью IoT Edge среды выполнения.
ms.service: stream-analytics
author: raan
ms.author: raan
ms.reviewer: mamccrea
ms.topic: how-to
ms.date: 08/21/2020
ms.custom: seodec18
ms.openlocfilehash: 21cf432576829b575d70a94227f28df373a4d899
ms.sourcegitcommit: 857859267e0820d0c555f5438dc415fc861d9a6b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2020
ms.locfileid: "93126164"
---
# <a name="run-azure-stream-analytics-on-azure-stack-preview"></a>Запуск Azure Stream Analytics на Azure Stack (Предварительная версия)

> [!IMPORTANT]
> Эта возможность доступна в предварительной версии и не рекомендуется для использования в рабочей среде.

Вы можете запустить Azure Stream Analytics в центре Azure Stack как модуль IoT Edge. В модуль IoT Edge были добавлены конфигурации, позволяющие взаимодействовать с хранилищем BLOB-объектов, концентраторами событий и центрами Интернета вещей, работающими в подписке на центр Azure Stack, разрешая использовать в каждом занятии центра Azure Stack адреса URL.

С Stream Analytics на Azure Stack можно создать действительно гибридные архитектуры для потоковой обработки в собственном частном, автономном облаке, которое можно подключить или отключить с помощью собственных облачных приложений, используя одинаковые службы Azure в локальной среде. 

В этой статье показано, как выполнить потоковую передачу данных из центра Интернета вещей или концентратора событий в другой концентратор событий или хранилище BLOB-объектов в подписке Azure Stack HUB и обработать ее с помощью Stream Analytics.

## <a name="set-up-environments"></a>Настройка окружений

Azure Stream Analytics является гибридной службой в центре Azure Stack. Это модуль IoT Edge, который настроен в Azure, но его можно запустить в центре Azure Stack.  

Если вы не знакомы с Azure Stack HUB или IoT Edge, следуйте приведенным ниже инструкциям, чтобы настроить среды.

### <a name="prepare-the-azure-stack-hub-environment"></a>Подготовка среды центра Azure Stack

Создайте подписку центра Azure Stack. Дополнительные сведения см [. в руководстве по созданию подписки на центр Azure Stack.](/azure-stack/user/azure-stack-subscribe-services/)

Если вы хотите оценить центр Azure Stack на своем сервере, можно использовать Пакет средств разработки Azure Stack (ASDK).  Дополнительные сведения о ASDK см. в [обзоре ASDK](/azure-stack/asdk/).

### <a name="install-the-iot-edge-runtime"></a>Установка среды выполнения IoT Edge

Для запуска Azure Stream Analytics в центре Azure Stack на устройстве должна быть установлена среда выполнения IoT Edge и сетевое подключение к концентратору Azure Stack или виртуальная машина, работающая в центре Azure Stack. Среда выполнения IoT Edge позволяет выполнять задания пограничных Stream Analytics для интеграции с хранилищем Azure и концентраторами событий Azure, которые выполняются в центре Azure Stack. Дополнительные сведения см. в разделе [Azure Stream Analytics на IOT Edge](stream-analytics-edge.md) 

Помимо сетевого доступа к ресурсам центра Azure Stack, устройству IoT Edge (или виртуальной машине) требуется доступ к центру Интернета вещей Azure в общедоступном облаке Azure для настройки модуля Stream Analytics. 

В следующих руководствах показано, как настроить среду выполнения IoT Edge на устройстве или виртуальной машине.

* [Установка среды выполнения Azure IoT Edge в Windows](../iot-edge/how-to-install-iot-edge.md)
* [Установка среды выполнения Azure IoT Edge в системах Linux на основе Debian](../iot-edge/how-to-install-iot-edge.md)


## <a name="create-an-azure-stream-analytics-edge-job"></a>Создание задания пограничной Azure Stream Analytics

Задания Edge ASA выполняются в контейнерах, развернутых на устройствах Azure IoT Edge. Они состоят из двух частей:
* Облачная часть, которая отвечает за определение задания: пользователи определяют входы и выходы, запросы и другие параметры (неупорядоченные события и т. д.) в облаке.
* Модуль, выполняющийся на устройствах IoT Edge. Он содержит механизм обработки ASA и получает определение задания из облака.

### <a name="create-a-storage-account"></a>Создание учетной записи хранения

Когда вы создаете задание Azure Stream Analytics для запуска на устройстве IoT Edge, его необходимо сохранить таким образом, чтобы его можно было вызывать с устройства. Вы можете использовать существующую учетную запись хранения Azure или создать новую.
1. В портал Azure перейдите к разделу **Создание ресурса > хранилище > учетная запись хранения — BLOB-объект, файл, таблица, очередь** .
2. Чтобы создать учетную запись хранения, введите следующие значения:

   | Поле | Значение |
   | --- | --- |
   | Имя | Введите уникальное имя учетной записи хранения. |
   | Расположение | Выберите расположение рядом с вами.|
   | Подписка | Выберите ту же подписку, к которой относится Центр Интернета вещей.|
   | Группа ресурсов | Мы рекомендуем использовать одну группу ресурсов для всех тестовых ресурсов, создаваемых во время [IOT Edge кратких](../iot-edge/quickstart.md) руководств и учебников. Например, **IoTEdgeResources** . |

3. Для других полей используйте значения по умолчанию и выберите **Создать** .


### <a name="create-a-new-job"></a>Создание задания

1. В портал Azure перейдите к разделу **Создание ресурса > "Интернет вещей" > Stream Analytics** .
2. Чтобы создать учетную запись хранения, введите следующие значения:

   | Поле | Значение |
   | --- | --- |
   | Имя задания | Укажите имя задания. Например, **IoTEdgeJob** . |
   | Подписка | Выберите ту же подписку, к которой относится Центр Интернета вещей.|
   | Группа ресурсов | Мы рекомендуем использовать одну группу ресурсов для всех тестовых ресурсов, создаваемых во время [IOT Edge кратких](../iot-edge/quickstart.md) руководств и учебников. Например, **IoTEdgeResources** . |
   | Расположение | Выберите расположение рядом с вами. |
   | Среда размещения | Выберите **Edge** . |

3. Нажмите кнопку **создания** .

### <a name="configure-your-job"></a>Настройка задания

После создания задания Stream Analytics на портале Azure вы можете настроить его с помощью входных, выходных данных и запроса для выполнения в соответствующих данных. Вы можете вручную указать входные данные из центра Интернета вещей или концентратора событий в подписке Azure Stack Hub.

1. Перейдите в задание Stream Analytics на портале Azure.
2. В разделе **Настройка** выберите **Параметры учетной записи хранения** и выберите учетную запись хранения, созданную на предыдущем шаге.
   > [!div class="mx-imgBorder"]
   > [![Параметр ](media/on-azure-stack/storage-account-settings.png) учетной записи хранения задания](media/on-azure-stack/storage-account-settings.png#lightbox)
3. В разделе **топология задания** выберите **входные** данные и **добавьте потоковый вход.**
4. Выберите **центр Интернета вещей** , **концентратор событий** или **концентратор ребра** из раскрывающегося списка. 
5. Если входные данные являются концентратором событий или центром Интернета вещей в подписке Azure Stack Hub, укажите сведения вручную, как показано ниже.

   #### <a name="event-hub"></a>Концентратор событий

   | Поле | Значение |
   | --- | --- |
   | Псевдоним входных данных | Понятное имя, используемое в запросах задания для ссылки на эти входные данные. |
   | Пространство имен служебной шины | Пространство имен — это контейнер для набора сущностей обмена сообщениями. При создании нового концентратора событий также создается пространство имен. (Пример: *SB:// <Event Hub Name> . eventhub.Shanghai.azurestack.Corp.Microsoft.com* ) |
   | имя концентратора событий; | Имя концентратора событий для использования в качестве источника входных данных. |
   | Имя политики концентратора событий | Политика общего доступа, которая предоставляет доступ к концентратору событий. Каждой политике общего доступа присваивается имя, а также для нее задаются разрешения и ключи доступа. Этот параметр автоматически заполняется, если только не указан параметр "Указать настройки концентратора событий вручную". |
   | Ключ политики концентратора событий | Ключ общего доступа, используемый для авторизации доступа к концентратору событий. Этот параметр автоматически заполняется, если только не будет указан вариант ручной настройки параметров концентратора событий. Его можно найти в параметрах концентратора событий. |
   | Группа потребителей концентратора событий (необязательно) | Для каждого задания Stream Analytics настоятельно рекомендуется использовать отдельную группу получателей. Эта строка указывает группу получателей, принимающих данные из концентратора событий. Если группа получателей не указана, задание Stream Analytics использует группу получателей "$Default". |
   | Число секций | Число секций — это количество секций в концентраторе событий. |

   > [!div class="mx-imgBorder"]
   > [![Входные данные ](media/on-azure-stack/event-hub-input.png) концентратора событий](media/on-azure-stack/event-hub-input.png#lightbox)

   #### <a name="iot-hub"></a>Центр Интернета вещей

   | Поле | Значение |
   | --- | --- |
   | Псевдоним входных данных | Понятное имя, используемое в запросах задания для ссылки на эти входные данные. |
   | Центр Интернета вещей | Имя Центра Интернета вещей для использования в качестве источника входных данных. (Пример: *<IoT Hub Name> . Shanghai.azurestack.Corp.Microsoft.com* ) |
   | имя политики общего доступа; | Политика общего доступа, которая предоставляет доступ к Центру Интернета вещей. Каждой политике общего доступа присваивается имя, а также для нее задаются разрешения и ключи доступа. |
   | Ключ политики общего доступа | Ключ общего доступа, используемый для авторизации доступа к Центру Интернета вещей. Этот параметр автоматически заполняется, если только не будет указан вариант ручной настройки параметров Центра Интернета вещей. |
   | Группа потребителей (необязательно) | Для каждого задания Stream Analytics настоятельно рекомендуется использовать отдельную группу получателей. Группа получателей используется для принимающих данных из Центра Интернета вещей. Stream Analytics использует группу получателей "$Default", если не указано иное. |
   | Число секций | Число секций — это количество секций в концентраторе событий. |

   > [!div class="mx-imgBorder"]
   > [![Входные данные ](media/on-azure-stack/iot-hub-input.png) центра Интернета вещей](media/on-azure-stack/iot-hub-input.png#lightbox)

6. Сохраните значения по умолчанию для других полей и нажмите Сохранить.
7. В разделе Топология задания откройте Выходные данные, а затем выберите Добавить.
8. В раскрывающемся списке выберите хранилище BLOB-объектов, концентратор событий или концентратор ребра.
9. Если выходные данные являются концентратором событий или хранилищем BLOB-объектов в подписке Azure Stack Hub, укажите сведения вручную, как показано ниже.

   #### <a name="event-hub"></a>Концентратор событий

   | Поле | Значение |
   | --- | --- |
   | Псевдоним выходных данных | Понятное имя, которое используется в запросах для направления выходных данных запроса в концентратор событий. |
   | Пространство имен служебной шины | Контейнер для набора сущностей обмена сообщениями. При создании нового концентратора событий вы также создали пространство имен служебной шины. (Пример: *SB:// <Event Hub Name> . eventhub.Shanghai.azurestack.Corp.Microsoft.com* ) |
   | имя концентратора событий; | Имя выходных данных концентратора событий. |
   | Имя политики концентратора событий | Политика общего доступа, которую можно создать на вкладке Настройка концентратора событий. Каждой политике общего доступа присваивается имя, а также для нее задаются разрешения и ключи доступа. |
   | Ключ политики концентратора событий | Ключ общего доступа, используемый для аутентификации доступа к пространству имен концентратора событий. |

   > [!div class="mx-imgBorder"]
   > [![Выходные данные ](media/on-azure-stack/event-hub-output.png) концентратора событий](media/on-azure-stack/event-hub-output.png#lightbox)

   #### <a name="blob-storage"></a>Хранилище BLOB-объектов 

   | Поле | Значение |
   | --- | --- |
   | Псевдоним выходных данных | Понятное имя, которое используется в запросах для направления выходных данных запроса в хранилище BLOB-объектов. |
   | Учетная запись хранения | Имя учетной записи хранения, куда отправляются выходные данные. (Пример: *<Storage Account Name> . BLOB.Shanghai.azurestack.Corp.Microsoft.com* ) |
   | Ключ учетной записи хранения | Секретный ключ, связанный с учетной записью хранения. Этот параметр автоматически заполняется, если только не будет указан вариант ручной настройки параметров хранилища больших двоичных объектов. |

> [!NOTE]
> Формат Parquet не поддерживается для заданий пограничных устройств в центре Azure Stack. Для минимума строк и максимального времени используйте значение 0 или оставьте их пустыми.


## <a name="deploy-stream-analytics-on-a-vm-or-device-connected-to-azure-stack"></a>Развертывание Stream Analytics на виртуальной машине или устройстве, подключенном к Azure Stack

1. В портал Azure откройте центр Интернета вещей. Перейдите к **IOT Edge** и щелкните устройство (виртуальная машина), которое нужно выбрать для этого развертывания.
2. Щелкните **Set modules** (Настроить модули). Затем выберите **+ Добавить** и выберите **Azure Stream Analytics модуль** . 
3. Выберите подписку и созданное задание ребра Steam Analytics. Нажмите кнопку **сохранить** и выберите **Далее: Маршруты** .

   > [!div class="mx-imgBorder"]
   > [![Добавить модули ](media/on-azure-stack/edge-modules.png)](media/on-azure-stack/edge-modules.png#lightbox)

4. Щелкните **Проверка + создать >** .
5. На шаге **Проверка и создание** выберите **создать** . 
   > [!div class="mx-imgBorder"]
   > [![Манифест ](media/on-azure-stack/module-content.png)](media/on-azure-stack/module-content.png#lightbox)
6. Убедитесь, что модуль добавлен в список.
   > [!div class="mx-imgBorder"]
   > [Страница "развертывание" ![ ](media/on-azure-stack/edge-deployment.png)](media/on-azure-stack/edge-deployment.png#lightbox)

## <a name="next-steps"></a>Дальнейшие действия
- [Azure Stream Analytics в IoT Edge](./stream-analytics-edge.md)
- [Разработка заданий Stream Analytics пограничных приложений](/stream-analytics-query/stream-analytics-query-language-reference)