---
title: Устранение неполадок с входными подключениями для Azure Stream Analytics
description: В этой статье описаны методы устранения неполадок с входными подключениями в заданиях Azure Stream Analytics.
author: sidram
ms.author: sidram
ms.reviewer: mamccrea
ms.service: stream-analytics
ms.topic: troubleshooting
ms.date: 05/01/2020
ms.custom: seodec18
ms.openlocfilehash: f4f79a28dbe8a49e608ca6fae1781a1e19646619
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "87448872"
---
# <a name="troubleshoot-input-connections"></a>Устранение неполадок с входными подключениями

В этой статье описаны распространенные проблемы, возникающие c входными подключениями Azure Stream Analytics, способы диагностики и устранения этих проблем. Для многих действий по устранению неполадок должны быть включены журналы ресурсов для задания Stream Analytics. Если журналы ресурсов еще не включены, воспользуйтесь статьей [Устранение неполадок в Azure Stream Analytics с помощью журналов ресурсов](stream-analytics-job-diagnostic-logs.md).

## <a name="input-events-not-received-by-job"></a>Входные события, не полученные заданием 

1.  Проверка входных и выходных подключений. Проверьте подключение к портам ввода и вывода с помощью кнопки **Проверить подключение** для всех входных и выходных данных.

2.  Проверьте входные данные.

    1. Нажмите кнопку [**Образцы данных**](stream-analytics-sample-data-input.md) для всех входных данных. Скачайте примеры входных данных.
        
    1. Проверьте эти примеры данных, чтобы определить схему и [типы данных](https://docs.microsoft.com/stream-analytics-query/data-types-azure-stream-analytics).
    
    1. Проверьте [Метрики концентратора событий](../event-hubs/event-hubs-metrics-azure-monitor.md), чтобы убедиться, что события отправляются. Метрики сообщений должны быть больше нуля, если служба "Центры событий" получает сообщения.

3.  Убедитесь, что на панели просмотра входных данных выбран временной диапазон. Щелкните **Выбор диапазона времени** и введите длительность выборки перед тестированием запроса.

## <a name="malformed-input-events-causes-deserialization-errors"></a>Неправильный формат входных событий, который приводит к ошибкам десериализации 

Если входной поток задания Stream Analytics содержит сообщения неправильного формата, возникают проблемы десериализации. Например, сообщение может иметь неправильный формат из-за отсутствия круглых или фигурных скобок в объекте JSON или неверного формата метки времени в соответствующем поле. 
 
Когда задание Stream Analytics получает сообщение неправильного формата из входного набора данных, это сообщение отклоняется, а пользователь получает предупреждение. На плитке **Входные данные** задания Stream Analytics отображается символ предупреждения. Следующий символ предупреждения отображается, пока задание находится в состоянии выполнения:

![Плитка "Входные данные" Azure Stream Analytics](media/stream-analytics-malformed-events/stream-analytics-inputs-tile.png)

Включите журналы ресурсов для просмотра сведений об ошибке и сообщения (полезных данных), которое вызвало ошибку. Ошибки десериализации могут возникать по различным причинам. Сведения о диагностике некоторых ошибок десериализации можно найти в разделе [Ошибки входных данных](data-errors.md#input-data-errors). Если журналы ресурсов не включены, на портале Azure отображается краткое уведомление.

![Уведомление с предупреждением о входных данных](media/stream-analytics-malformed-events/warning-message-with-offset.png)

Если полезные данные сообщения превышают размер 32 КБ или имеют двоичный формат, запустите файл кода CheckMalformedEvents.cs, который доступен в [репозитории примеров GitHub](https://github.com/Azure/azure-stream-analytics/tree/master/Samples/CheckMalformedEventsEH). При помощи этого кода считываются идентификатор раздела и смещение, а затем выводятся данные для этого смещения. 

## <a name="job-exceeds-maximum-event-hub-receivers"></a>Задание превышает максимальное количество приемников концентратора событий

Мы рекомендуем использовать службу "Центры событий" с несколькими группами потребителей, чтобы поддерживать масштабируемость задания. Число модулей чтения в задании Stream Analytics для определенных входных данных влияет на число модулей чтения в одной группе потребителей. Точное число приемников зависит от сведений о внутренней реализации логики топологии развертывания и не предоставляется извне. Число модулей чтения можно изменить во время запуска или обновления задания.

Следующие сообщения об ошибках отображаются, когда число получателей превышает максимально допустимое. В это сообщение включен список существующих подключений к концентратору событий в соответствующей группе потребителей. Тег `AzureStreamAnalytics` указывает, что подключения относятся к службе потоковой передачи Azure.

```
The streaming job failed: Stream Analytics job has validation errors: Job will exceed the maximum amount of Event Hub Receivers.

The following information may be helpful in identifying the connected receivers: Exceeded the maximum number of allowed receivers per partition in a consumer group which is 5. List of connected receivers – 
AzureStreamAnalytics_c4b65e4a-f572-4cfc-b4e2-cf237f43c6f0_1, 
AzureStreamAnalytics_c4b65e4a-f572-4cfc-b4e2-cf237f43c6f0_1, 
AzureStreamAnalytics_c4b65e4a-f572-4cfc-b4e2-cf237f43c6f0_1, 
AzureStreamAnalytics_c4b65e4a-f572-4cfc-b4e2-cf237f43c6f0_1, 
AzureStreamAnalytics_c4b65e4a-f572-4cfc-b4e2-cf237f43c6f0_1.
```

> [!NOTE]
> При изменении числа модулей чтения во время обновления задания временные предупреждения записываются в журналы аудита. Задания Stream Analytics восстанавливаются от этих временных сбоев автоматически.

### <a name="add-a-consumer-group-in-event-hubs"></a>Добавление группы потребителей в Центры событий

Чтобы добавить новую группу потребителей в экземпляр Центра событий, сделайте следующее.

1. Войдите на портал Azure.

2. Найдите концентратор событий.

3. Выберите **Центры событий** под заголовком **Сущности**.

4. Выберите имя концентратора событий.

5. На странице **Экземпляр Центров событий** под заголовком **Сущности** установите флажок **Группы потребителей**. Указана группа потребителей с именем **$Default**.

6. Выберите **+Группа потребителей**, чтобы добавить новую группу потребителей. 

   ![Добавление группы потребителей в Центры событий](media/stream-analytics-event-hub-consumer-groups/new-eh-consumer-group.png)

7. Вы указали группу потребителей, когда создавали входные данные в задании Stream Analytics для концентратора событий. Имя **$Default** используется, если группа не указана. После создания группы потребителей измените входные данные концентратора событий в задании Stream Analytics и укажите имя новой группы потребителей.

## <a name="readers-per-partition-exceeds-event-hubs-limit"></a>Превышение предельно допустимого числа модулей чтения каждого раздела для Центров событий

Если синтаксис запроса потоковой передачи ссылается на один и тот же входной ресурс концентратора событий несколько раз, обработчик заданий может использовать несколько читателей для каждого запроса из этой же группы потребителей. При наличии слишком большого количества ссылок в одной и той же группе потребителей задание может превысить установленный предел (пять ссылок) и вызвать ошибку. В таких случаях можно выполнять разделение с помощью нескольких групп входных данных в нескольких группах потребителей, используя решения, описанные в следующем разделе. 

Ниже представлены сценарии, в которых число модулей чтения каждого раздела превышает предельно допустимое число для Центров событий (пять).

* Несколько инструкций SELECT. При использовании нескольких инструкций SELECT, ссылающихся на **один** набор входных данных концентратора событий, каждая из них создает по приемнику.

* UNION. При использовании UNION несколько наборов входных данных могут ссылаться на **один** концентратор событий и на одну группу потребителей.

* SELF JOIN. При использовании операции SELF JOIN можно создать несколько ссылок на **один** концентратор событий.

Следующие рекомендации могут помочь справиться со сценариями, в которых число модулей чтения каждого раздела превышает предельно допустимое число для Центров событий (пять).

### <a name="split-your-query-into-multiple-steps-by-using-a-with-clause"></a>Разбиение запроса на несколько шагов с помощью предложения WITH

Предложение WITH задает временный именованный результирующий набор, на который можно создать ссылку в предложении FROM в запросе. Предложение WITH определяется в области выполнения одной инструкции SELECT.

Например, вместо этого запроса:

```SQL
SELECT foo 
INTO output1
FROM inputEventHub

SELECT bar
INTO output2
FROM inputEventHub 
…
```

Используйте этот:

```SQL
WITH data AS (
   SELECT * FROM inputEventHub
)

SELECT foo
INTO output1
FROM data

SELECT bar
INTO output2
FROM data
…
```

### <a name="ensure-that-inputs-bind-to-different-consumer-groups"></a>Привязка входных данных к разным группам потребителей

Создайте отдельные группы потребителей для запросов, в которых три или более наборов входных данных подключены к одной группе потребителей Центров событий. Для этого нужно создать дополнительные наборы входных данных Stream Analytics.

### <a name="create-separate-inputs-with-different-consumer-groups"></a>Создание отдельных входных данных с разными группами потребителей

Можно создать отдельные входные данные с разными группами потребителей для одного концентратора событий. Следующий запрос UNION является примером того, где *инпутоне* и *инпуттво* относятся к одному источнику концентратора событий. Любой запрос может иметь отдельные входные данные с разными группами потребителей. Запрос UNION — это только один пример.

```sql
WITH 
DataOne AS 
(
SELECT * FROM InputOne 
),

DataTwo AS 
(
SELECT * FROM InputTwo 
),

SELECT foo FROM DataOne
UNION 
SELECT foo FROM DataTwo

```

## <a name="readers-per-partition-exceeds-iot-hub-limit"></a>Число читателей на секцию превышает ограничение центра Интернета вещей

Для подключения и чтения событий из центра Интернета вещей Stream Analytics задания используют встроенную [конечную точку, совместимую с концентратором событий](../iot-hub/iot-hub-devguide-messages-read-builtin.md) . Если количество ресурсов для чтения на раздел превышает пределы центра Интернета вещей, для его устранения можно воспользоваться [решением для концентратора событий](#readers-per-partition-exceeds-event-hubs-limit) . Вы можете создать группу потребителей для встроенной конечной точки с помощью сеанса конечной точки портала центра Интернета вещей или с помощью [пакета SDK для центра Интернета вещей](https://docs.microsoft.com/rest/api/iothub/IotHubResource/CreateEventHubConsumerGroup).

## <a name="get-help"></a>Получить справку

Для получения дополнительной помощи воспользуйтесь [страницей вопросов и ответов по Azure Stream Analytics на сайте Майкрософт](https://docs.microsoft.com/answers/topics/azure-stream-analytics.html).

## <a name="next-steps"></a>Дальнейшие действия

* [Введение в Azure Stream Analytics](stream-analytics-introduction.md)
* [Приступая к работе с Azure Stream Analytics](stream-analytics-real-time-fraud-detection.md)
* [Масштабирование заданий в службе Azure Stream Analytics](stream-analytics-scale-jobs.md)
* [Справочник по языку запросов Azure Stream Analytics](https://docs.microsoft.com/stream-analytics-query/stream-analytics-query-language-reference)
* [Справочник по API-интерфейсу REST управления Stream Analytics](https://msdn.microsoft.com/library/azure/dn835031.aspx)
