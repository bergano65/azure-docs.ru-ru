---
title: Настройка политик упорядочивания событий для Azure Stream Analytics
description: В этой статье описывается, как настроить параметры четных заказов в Stream Analytics
author: sidram
ms.author: sidram
ms.reviewer: mamccrea
ms.service: stream-analytics
ms.topic: how-to
ms.date: 08/06/2020
ms.openlocfilehash: b4e34befbf28de2b985ff49ce17a87a25842015e
ms.sourcegitcommit: 4e5560887b8f10539d7564eedaff4316adb27e2c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/06/2020
ms.locfileid: "87901697"
---
# <a name="configuring-event-ordering-policies-for-azure-stream-analytics"></a>Настройка политик упорядочивания событий для Azure Stream Analytics

В этой статье описывается, как настроить и использовать последние и неупорядоченные политики событий в Azure Stream Analytics. Эти политики применяются только в том случае, если в запросе используется предложение [timestamp by](https://docs.microsoft.com/stream-analytics-query/timestamp-by-azure-stream-analytics) , и они применяются только к облачным источникам входных данных.

## <a name="event-time-and-arrival-time"></a>Время события и время прибытия

Задание Stream Analytics может обрабатывать события на основе *времени события* или *времени прибытия*. **Время события или приложения** — это метка времени, которая содержится в полезных данных события (при создании события). **Время прибытия** — это отметка времени, когда событие было получено во входном источнике (концентраторы событий, центр Интернета вещей или хранилище BLOB-объектов). 

По умолчанию Stream Analytics обрабатывает события по *времени прибытия*, но вы можете обрабатывать события по *времени события* с помощью предложения [timestamp by](https://docs.microsoft.com/stream-analytics-query/timestamp-by-azure-stream-analytics) в запросе. Отложенные и неупорядоченные политики применяются только в том случае, если обработка событий выполняется по времени события. Настраивать эти параметры следует в соответствии с требованиями к задержке и правильности для вашего сценария. 

## <a name="what-is-late-arrival-policy"></a>What is late arrival policy? (Что собой представляет политика для событий, сведения о которых поступают с задержкой?)

Иногда события прибывают опозданием по различным причинам. Например, событие, которое прибывает 40 секунд с опозданием, будет иметь время события = 00:10:00 и время прибытия = 00:10:40. Если задать для политики позднего прибытия значение 15 секунд, то любое событие, поступающие позже 15 секунд, будет либо удалено (не обработано Stream Analytics), либо настроено время события. В приведенном выше примере, так как событие приступило на 40 секунд с опозданием (больше, чем набор политик), время события будет изменено до максимальной политики с поздним прибытием 00:10:25 (время прибытия — значение политики с опозданием). Политика позднего прибытия по умолчанию — 5 секунд.

## <a name="what-is-out-of-order-policy"></a>Что такое неупорядоченная политика? 

Также может приступать к порядку событий. После изменения времени события на основе политики с опозданием можно также выбрать автоматическое удаление или корректировка неупорядоченных событий. Если для этой политики задано значение 8 секунд, то все события, которые поступают в неупорядоченном виде, но в течение 8-секундного окна переупорядочиваются по времени события. События, поступающие позже, будут либо удалены, либо скорректированы до значения максимальной неупорядоченной политики. Политика по умолчанию не по заказу составляет 0 секунд. 

## <a name="adjust-or-drop-events"></a>Корректировка или удаление событий

Если события прибывают поздними или неупорядоченными на основе настроенных политик, можно либо удалить такие события (не обрабатываются Stream Analytics), либо настроить время события.

Давайте посмотрим пример этих политик в действии.
<br> **Политика позднего прибытия:** 15 секунд
<br> **Неупорядоченная политика:** 8 секунд

| Номер события | Время события | Время получения | System.Timestamp | Описание |
| --- | --- | --- | --- | --- |
| **1** | 00:10:00  | 00:10:40  | 00:10:25  | Событие приступило к просроченному и внешнему уровню отклонения. Так что время события настраивается в соответствии с максимальным отклонением в конце поступления.  |
| **2** | 00:10:30 | 00:10:41  | 00:10:30  | Событие приступило к опозданию, но находится в пределах допустимого уровня. Так что время события не изменяется.  |
| **3** | 00:10:42 | 00:10:42 | 00:10:42 | Событие приступило вовремя. Корректировка не требуется.  |
| **4** | 00:10:38  | 00:10:43  | 00:10:38 | Событие приступило к порядку в пределах 8 секунд. Таким образом, время события не изменяется. В целях аналитики это событие будет рассматриваться как предшествующее событие с номером 4.  |
| **5** | 00:10:35 | 00:10:45  | 00:10:37 | Событие было доставлено не по порядку и не допускают 8 секунд. Таким образом, время события корректируется до максимально допустимого значения. |

## <a name="can-these-settings-delay-output-of-my-job"></a>Могут ли эти параметры откладывать выходные данные задания? 

Да. По умолчанию для политики неупорядоченности задано значение 0 (00 минут и 00 секунд). При изменении значения по умолчанию первый вывод задания задерживается этим значением (или выше). 

Если одна из разделов входных данных не получает события, следует рассчитывать, что выходные данные будут отложены значением политики позднего прибытия. Чтобы узнать причину, ознакомьтесь с разделом Инпутпартитион Error ниже. 

## <a name="i-see-lateinputevents-messages-in-my-activity-log"></a>Я вижу сообщения Латеинпутевентс в моем журнале действий

Эти сообщения показывают, что события были получены опозданием и либо удалены, либо скорректированы в соответствии с конфигурацией. Вы можете проигнорировать эти сообщения, если политика с опозданием настроена соответствующим образом. 

Пример этого сообщения: <br>
<code>
{"message Time":"2019-02-04 17:11:52Z","error":null,
"message":"First Occurred: 02/04/2019 17:11:48 | Resource Name: ASAjob | Message: Source 'ASAjob' had 24 data errors of kind 'LateInputEvent' between processing times '2019-02-04T17:10:49.7250696Z' and '2019-02-04T17:11:48.7563961Z'. Input event with application timestamp '2019-02-04T17:05:51.6050000' and arrival time '2019-02-04T17:10:44.3090000' was sent later than configured tolerance.","type":"DiagnosticMessage","correlation ID":"49efa148-4asd-4fe0-869d-a40ba4d7ef3b"} 
</code>

## <a name="i-see-inputpartitionnotprogressing-in-my-activity-log"></a>Я вижу Инпутпартитионнотпрогрессинг в моем журнале действий

Источник входных данных (концентратор событий или центр Интернета вещей), вероятно, имеет несколько разделов. Azure Stream Analytics выдает выходные данные для метки времени T1 только после того, как все объединяемые секции будут по крайней мере в течение времени T1. Например, предположим, что запрос выполняет чтение из секции концентратора событий с двумя разделами. В одном из разделов, P1, есть события до времени t1. В одном из разделов, P2, есть события до времени t1 + x. В таком случае выходные данные выводятся до времени t1. Однако, если явно указано предложение разделения по PartitionId, оба раздела работают независимо друг от друга. 

Если несколько секций из одного входного потока объединены, допустимость поступления с задержкой — это максимальное время, в течение которого каждая секция ожидает новые данные. Если в концентраторе событий имеется одна секция или если центр Интернета вещей не получает входные данные, временная шкала для этого раздела не выполняется, пока не достигнет порогового значения допуска позднего поступления. При этом выходные данные заменяются пороговой погрешностью задержки поступления. В таких случаях может появиться следующее сообщение:
<br><code>
{"message Time":"2/3/2019 8:54:16 PM UTC","message":"Input Partition [2] does not have additional data for more than [5] minute(s). Partition will not progress until either events arrive or late arrival threshold is met.","type":"InputPartitionNotProgressing","correlation ID":"2328d411-52c7-4100-ba01-1e860c757fc2"} 
</code><br><br>
Это сообщение о том, что по крайней мере одна секция в входных данных пуста и будет откладывать выходные данные на пороговое значение позднего поступления. Чтобы преодолеть это, рекомендуется выполнить одно из следующих действий.  
1. Убедитесь, что все разделы концентратора событий или центра Интернета вещей получают входные данные. 
2. Используйте предложение PARTITION BY PartitionID в запросе. 

## <a name="why-do-i-see-a-delay-of-5-seconds-even-when-my-late-arrival-policy-is-set-to-0"></a>Почему я вижу задержку 5 секунд, даже если политика с опозданием имеет значение 0?
Это происходит при наличии входной секции, которая никогда не получала никаких входных данных. Чтобы проверить это поведение, можно проверить входные метрики по разделу. 

Если в секции отсутствуют данные, превышающие заданное пороговое значение позднего поступления, Stream Analytics увеличивает отметку времени приложения, как описано в разделе рекомендации по упорядочиванию событий. Для этого требуется предполагаемое время прибытия. Если в секции никогда не было данных, Stream Analytics оценивает время прибытия как местное время, равное *5 секундам*. Из-за таких секций, в которых никогда не было данных, может отображаться задержка в виде водяного знака (5 секунд).  

## <a name="next-steps"></a>Дальнейшие действия
* [Рекомендации по распределению времени](stream-analytics-time-handling.md)
* [Метрики, доступные в Stream Analytics](https://docs.microsoft.com/azure/stream-analytics/stream-analytics-monitoring#metrics-available-for-stream-analytics)
