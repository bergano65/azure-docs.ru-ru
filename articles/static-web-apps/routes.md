---
title: Маршруты в Статических веб-приложениях Azure
description: Сведения о правилах внутренней маршрутизации и защите маршрутов с помощью ролей.
services: static-web-apps
author: craigshoemaker
ms.service: static-web-apps
ms.topic: conceptual
ms.date: 05/08/2020
ms.author: cshoe
ms.openlocfilehash: 8abbe575e855347714c19c40155d890af484d5d6
ms.sourcegitcommit: d2222681e14700bdd65baef97de223fa91c22c55
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/07/2020
ms.locfileid: "91822326"
---
# <a name="routes-in-azure-static-web-apps-preview"></a>Маршруты в предварительной версии Статических веб-приложений Azure

Маршрутизация в статических веб-приложениях Azure определяет правила маршрутизации серверной части и поведение авторизации как для статического содержимого, так и для интерфейсов API<sup>1</sup>. Правила определяются в виде массива правил в файле _routes.json_.

- Файл _routes.json_ должен существовать в корне папки артефактов сборки приложения.
- Правила выполняются в том порядке, в котором они отображаются в массиве `routes`.
- Оценка правила останавливается при первом совпадении. Правила маршрутизации не объединены в цепочку.
- Роли определяются в файле _routes.json_, а пользователи связываются с ними через [приглашения](authentication-authorization.md).
- Вы полностью контролируете имена ролей.

Тема маршрутизации во многом связана с основными понятиями проверки подлинности и авторизации. При изучении этой статьи обязательно ознакомьтесь также с руководством по [проверке подлинности и авторизации](authentication-authorization.md).

Дополнительные сведения см. в [примере файла маршрута](#example-route-file) .

## <a name="location"></a>Расположение

Файл _routes.json_ должен существовать в корне папки артефактов сборки приложения. Если веб-приложение содержит шаг сборки, на котором файлы сборки копируются из конкретной папки в папку артефактов сборки, файл _routes.json_ должен быть помещен в эту конкретную папку.

В следующей таблице перечислены необходимые расположения для размещения _routes.jsв_ файле для ряда платформ и библиотек внешнего интерфейса.

|Платформа или библиотека | Расположение  |
|---------|----------|
| Angular | _assets_   |
| React   | _public_  |
| Svelte  | _public_   |
| Vue     | _public_ |
| Blazor  | _wwwroot_ |

Приведенная выше таблица предназначена только для нескольких платформ и библиотек, совместимых со статическими веб-приложениями Azure. Дополнительные сведения см. в статье [Настройка интерфейсных платформ и библиотек](./front-end-frameworks.md) .

## <a name="defining-routes"></a>Определение маршрутов

Маршруты определяются в файле _routes.json_ в виде массива правил маршрутизации в свойстве `routes`. Каждое правило состоит из шаблона маршрута, а также одного или нескольких необязательных свойств правила. Примеры использования см. в [примере файла маршрута](#example-route-file).

| Свойство правила  | Обязательно | Значение по умолчанию | Комментарий                                                      |
| -------------- | -------- | ------------- | ------------------------------------------------------------ |
| `route`        | Да      | Недоступно          | Шаблон маршрута, запрошенный вызывающим объектом.<ul><li>В конце путей маршрутов можно указывать [подстановочные знаки](#wildcards). Например, маршрут _admin/\*_ соответствует любому маршруту по пути _admin_.<li>Файл по умолчанию для маршрута — _index.html_.</ul>|
| `serve`        | нет       | Недоступно          | Определяет файл или путь, возвращенные из запроса. Путь к файлу и его имя могут отличаться от запрошенного пути. Если `serve` значение не определено, то используется запрошенный путь. Параметры QueryString не поддерживаются; `serve` значения должны указывать на фактические файлы.  |
| `allowedRoles` | нет       | anonymous     | Массив имен ролей. <ul><li>Допустимые символы: `a-z`, `A-Z`, `0-9` и `_`.<li>Встроенная роль `anonymous` применяется ко всем не прошедшим проверку подлинности пользователям.<li>Встроенная роль `authenticated` применяется к любому пользователю, вошедшему в систему.<li>Пользователи должны принадлежать по крайней мере к одной роли.<li>Роли сопоставляются с использованием логического оператора _ИЛИ_. Если пользователю присвоена одна из перечисленных ролей, то доступ предоставляется.<li>Отдельные пользователи связываются с ролями с помощью [приглашений](authentication-authorization.md).</ul> |
| `statusCode`   | нет       | 200           | Ответ [Код состояния HTTP](https://wikipedia.org/wiki/List_of_HTTP_status_codes) для запроса. |

## <a name="securing-routes-with-roles"></a>Защита маршрутов с помощью ролей

Маршруты защищаются путем добавления одного или нескольких имен ролей в массив `allowedRoles` правила. Примеры использования см. в [примере файла маршрута](#example-route-file).

По умолчанию каждый пользователь принадлежит к встроенной роли `anonymous`, а все вошедшие в систему пользователи являются членами роли `authenticated`. Например, чтобы ограничить маршрут только пользователями, прошедшими проверку подлинности, добавьте встроенную роль `authenticated` в массив `allowedRoles`.

```json
{
  "route": "/profile",
  "allowedRoles": ["authenticated"]
}
```

При необходимости в массиве `allowedRoles` можно создать новые роли. Чтобы ограничить маршрут только администраторами, можно определить роль `administrator` в массиве `allowedRoles`.

```json
{
  "route": "/admin",
  "allowedRoles": ["administrator"]
}
```

- Вы полностью контролируете имена ролей. Какой-либо главный список, которому должны соответствовать ваши роли, отсутствует.
- Отдельные пользователи связываются с ролями с помощью [приглашений](authentication-authorization.md).

## <a name="wildcards"></a>Подстановочные знаки

Правила с подстановочными знаками соответствуют всем запросам с заданным шаблоном маршрута. Если в правиле определено значение `serve`, ответом будет обработка названного файла или пути.

Например, для реализации маршрутов приложения "Календарь" можно сопоставить все URL-адреса, расположенные по маршруту _calendar_, чтобы обрабатывался только один файл.

```json
{
  "route": "/calendar/*",
  "serve": "/calendar.html"
}
```

Тогда файл _calendar.html_ может использовать маршрутизацию на стороне клиента для предоставления разных представлений для различных вариантов URL-адресов, например `/calendar/january/1`, `/calendar/2020` и `/calendar/overview`.

Кроме того, с помощью подстановочных знаков можно защитить маршруты. В следующем примере любому файлу, запрошенному по пути _admin_, требуется прошедший проверку подлинности пользователь, который является членом роли _administrator_.

```json
{
  "route": "/admin/*",
  "allowedRoles": ["administrator"]
}
```

> [!NOTE]
> Запросы файлов, на которые ссылается обрабатываемый файл, оцениваются только для проверки подлинности. Например, запросы файла каскадных таблиц стилей (CSS) по пути с подстановочным знаком обрабатывают файл CSS, а не файл, определенный как файл `serve`. Файл CSS обрабатывается при условии, что пользователь отвечает требованиям проверки подлинности.

## <a name="fallback-routes"></a>Резервные маршруты

Одностраничные приложения, независимо от того, используете ли они клиентские платформы JavaScript или библиотеки или платформы веб-сборки, такие как Блазор, часто используют маршрутизацию на стороне клиента для навигации в Web App. Эти правила маршрутизации на стороне клиента обновляют расположение окна в браузере без отправки обратных запросов на сервер. При обновлении страницы или переходе непосредственно к расположениям, созданным правилами маршрутизации на стороне клиента, для обработки соответствующей HTML-страницы требуется резервный маршрут на стороне сервера.

В следующем примере показан типичный резервный маршрут.

```json
{
  "routes": [
    {
      "route": "/*",
      "serve": "/index.html",
      "statusCode": 200
    }
  ]
}
```

Резервный маршрут должен быть указан последним в правилах маршрутизации, так как он перехватывает все запросы, не перехваченные ранее определенными правилами.

## <a name="redirects"></a>Перенаправления

Для перенаправления запросов с одного маршрута на другой можно использовать коды состояния HTTP [301](https://en.wikipedia.org/wiki/HTTP_301) и [302](https://en.wikipedia.org/wiki/HTTP_302).

Например, следующее правило создает перенаправление 301 с _old-page.html_ на _new-page.html_.

```json
{
  "route": "/old-page.html",
  "serve": "/new-page.html",
  "statusCode": 301
}
```

Операции перенаправления также работают с путями, которые не определяют отдельные файлы.

```json
{
  "route": "/about-us",
  "serve": "/about",
  "statusCode": 301
}
```

## <a name="custom-error-pages"></a>Пользовательские страницы ошибок

В некоторых ситуациях пользователи могут сталкиваться с ошибками. С помощью массива `platformErrorOverrides` можно предоставить пользовательский интерфейс для реагирования на эти ошибки. Сведения о размещении массива в файле _routes.json_ см. в [примере файла маршрута](#example-route-file).

> [!NOTE]
> После того как запрос превращается в уровень переопределения платформы, правила маршрутов не запускаются повторно.

В следующей таблице перечислены доступные переопределения ошибок платформы:

| Тип ошибки  | HTTP status code (Код состояния HTTP) | Описание |
|---------|---------|---------|
| `NotFound` | 404  | Страница не найдена на сервере. |
| `Unauthenticated` | 401 | Пользователь не вошел в систему с помощью [поставщика проверки подлинности](authentication-authorization.md). |
| `Unauthorized_InsufficientUserInformation` | 401 | Учетная запись пользователя в поставщике проверки подлинности не настроена для предоставления необходимых данных. Эта ошибка, например, может происходить в ситуациях, когда приложение запрашивает у поставщика проверки подлинности адрес электронной почты пользователя, но пользователь решил ограничить доступ к этим данным. |
| `Unauthorized_InvalidInvitationLink` | 401 | Срок действия приглашения истек, или пользователь перешел по пригласительной ссылке для другого получателя.  |
| `Unauthorized_MissingRoles` | 401 | Пользователь не является членом требуемой роли. |
| `Unauthorized_TooManyUsers` | 401 | На сайте достигнуто максимальное число пользователей, и сервер ограничивает дальнейшие их добавление. Эта ошибка выводится клиенту, поскольку количество [приглашений](authentication-authorization.md), которые можно создать, не ограничено, так что некоторые пользователи не смогут их принять.|
| `Unauthorized_Unknown` | 401 | Неизвестная ошибка при попытке проверки подлинности пользователя. Одной из причин этой ошибки может быть то, что пользователь не распознается, так как не дал согласие приложению.|

## <a name="custom-mime-types"></a>Пользовательские типы MIME

`mimeTypes`Объект, перечисленный на том же уровне, что и `routes` массив, позволяет связывать [типы MIME](https://developer.mozilla.org/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types) с расширениями файлов.

```json
{
    "routes": [],
    "mimeTypes": {
        "custom": "text/html"
    }
}
```

В приведенном выше примере все файлы с `.custom` расширением обслуживаются с помощью `text/html` типа MIME.

При работе с типами MIME важно учитывать следующие моменты.

- Ключи не могут быть пустыми или иметь значение null или содержать более 50 символов
- Значения не могут быть пустыми или иметь значение null или содержать более 1000 символов

> [!NOTE]
> Статические веб-приложения понимают приложения Блазор и ожидаемые типы MIME для файлов ВАСМ и DLL, для них не нужно добавлять сопоставления.

## <a name="default-headers"></a>Заголовки по умолчанию

`defaultHeaders`Объект, перечисленный на том же уровне, что и `routes` массив, позволяет добавлять, изменять и удалять [заголовки ответа](https://developer.mozilla.org/docs/Web/HTTP/Headers).

Указание значения для заголовка либо добавляет, либо изменяет заголовок. Предоставляя пустое значение, удаляет заголовок из обслуживания клиента.

```json
{
    "routes": [],
    "defaultHeaders": {
      "content-security-policy": "default-src https: 'unsafe-eval' 'unsafe-inline'; object-src 'none'",
      "cache-control": "must-revalidate, max-age=6000",
      "x-dns-prefetch-control": ""
    }
}
```

В приведенном выше примере `content-security-policy` добавляется новый заголовок, который `cache-control` изменяет значение сервера по умолчанию, а `x-dns-prefectch-control` заголовок удаляется.

При работе с заголовками важно учитывать следующие моменты.

- Ключи не могут быть пустыми или иметь значение null.
- Значение null или пустые значения удаляют заголовок из обработки.
- Длина ключей или значений не может превышать 8 000 символов.
- Определенные заголовки обслуживаются всеми запросами.
- Заголовки, определенные в _routes.js_ , применяются только к статическому содержимому. Вы можете настроить заголовки ответа конечной точки API в коде функции.

## <a name="example-route-file"></a>Пример файла маршрута

В следующем примере показано, как создать правила маршрутизации для статического содержимого и API-интерфейсов в файле _routes.json_. В некоторых маршрутах используется [системная папка _/.auth_](authentication-authorization.md) с доступом к конечным точкам, связанным с проверкой подлинности.

```json
{
  "routes": [
    {
      "route": "/profile",
      "allowedRoles": ["authenticated"]
    },
    {
      "route": "/admin/*",
      "allowedRoles": ["administrator"]
    },
    {
      "route": "/api/admin",
      "allowedRoles": ["administrator"]
    },
    {
      "route": "/customers/contoso",
      "allowedRoles": ["administrator", "customers_contoso"]
    },
    {
      "route": "/login",
      "serve": "/.auth/login/github"
    },
    {
      "route": "/.auth/login/twitter",
      "statusCode": "404"
    },
    {
      "route": "/logout",
      "serve": "/.auth/logout"
    },
    {
      "route": "/calendar/*",
      "serve": "/calendar.html"
    },
    {
      "route": "/specials",
      "serve": "/deals",
      "statusCode": 301
    }
  ],
  "platformErrorOverrides": [
    {
      "errorType": "NotFound",
      "serve": "/custom-404.html"
    },
    {
      "errorType": "Unauthenticated",
      "statusCode": "302",
      "serve": "/login"
    }
  ],
  "defaultHeaders": {
    "content-security-policy": "default-src https: 'unsafe-eval' 'unsafe-inline'; object-src 'none'"
  },
  "mimeTypes": {
      "custom": "text/html"
  }
}
```

В следующих примерах описывается, что происходит в случае соответствия запроса правилу.

| Запрашиваемая папка | Результат |
|--|--|--|
| _/profile_ | Для пользователей, прошедших проверку подлинности, выполняется обработка файла _/profile/index.html_. Пользователи, не прошедшие проверку подлинности, перенаправляются в папку _/login_. |
| _/admin/reports_ | Для пользователей, прошедших проверку подлинности в роли _administrators_, выполняется обработка файла _/admin/reports/index.html_. Пользователям, прошедшим проверку подлинности, не в роли " _Администраторы_ ", выдается ошибка 401<sup>2</sup>. Пользователи, не прошедшие проверку подлинности, перенаправляются в папку _/login_. |
| _/api/admin_ | Запросы от пользователей, прошедших проверку подлинности в роли _administrators_, отправляются в API. Пользователи, прошедшие проверку подлинности, но не зарегистрированные в роли _administrators_, а также пользователи не прошедшие проверку подлинности, получают ошибку 401. |
| _/customers/contoso_ | Прошедшие проверку подлинности пользователи, которые принадлежат к роли " _Администраторы_ " или " _клиенты \_ contoso_ ", обслуживаются с помощью _/кустомерс/Контосо/index.html_ file<sup>2</sup>. Пользователи, прошедшие проверку подлинности, но не зарегистрированные в роли _administrators_ или _customers\_contoso_, получают ошибку 401. Пользователи, не прошедшие проверку подлинности, перенаправляются в папку _/login_. |
| _/login_ | Пользователям, не прошедшим проверку подлинности, предлагается сделать это с помощью GitHub. |
| _/.auth/login/twitter_ | Авторизация в Twitter отключена. Сервер возвращает ошибку 404. |
| _/logout_ | Пользователи вышли из какого-либо поставщика проверки подлинности. |
| _/calendar/2020/01_ | В браузере обрабатывается файл _/calendar.html_. |
| _/specials_ | В браузере выполняется перенаправление в папку _/deals_. |
| _/unknown-folder_ | Обрабатывается файл _/custom-404.html_. |
| Файлы с `.custom` расширением | Обслуживаются с `text/html` типом MIME |

Все ответы включают `content-security-policy` заголовки со значением `default-src https: 'unsafe-eval' 'unsafe-inline'; object-src 'none'` .

<sup>1</sup> правила маршрутов для функций API поддерживают только [Перенаправление](#redirects) и [защиту маршрутов с помощью ролей](#securing-routes-with-roles).

<sup>2</sup> можно предоставить настраиваемую страницу ошибки, определив `Unauthorized_MissingRoles` правило в `platformErrorOverrides` массиве.

## <a name="restrictions"></a>Ограничения

- Размер файла _routes.json_ не должен превышать 100 КБ.
- Файл _routes.json_ поддерживает не более 50 различных ролей.

Общие ограничения и ограничения см. в [статье о квотах](quotas.md) .

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Настройка проверки подлинности и авторизации](authentication-authorization.md)
