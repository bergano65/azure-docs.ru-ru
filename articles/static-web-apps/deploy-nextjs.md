---
title: Руководство по развертыванию веб-сайтов Next.js с рендерингом на стороне сервера в Статических веб-приложениях Azure
description: Создавайте и развертывайте динамические сайты Next.js с помощью Статических веб-приложений Azure.
services: static-web-apps
author: christiannwamba
ms.service: static-web-apps
ms.topic: tutorial
ms.date: 05/08/2020
ms.author: chnwamba
ms.openlocfilehash: fe139921cb73ee0e224c995e2dd5eb5fc50f3979
ms.sourcegitcommit: bb0afd0df5563cc53f76a642fd8fc709e366568b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/19/2020
ms.locfileid: "83593811"
---
# <a name="deploy-server-rendered-nextjs-websites-on-azure-static-web-apps-preview"></a>Развертывание веб-сайтов Next.js с рендерингом на стороне сервера в Статических веб-приложениях Azure (предварительная версия)

Из этого учебника вы узнаете, как развернуть созданный статический веб-сайт [Next.js](https://nextjs.org) в [Статических веб-приложениях Azure](overview.md). Для начала вы узнаете, как установить, настроить и развернуть приложение Next.js. В ходе этого процесса вы также научитесь решать распространенные проблемы, которые часто возникают при создании статических страниц с помощью Next.js.

## <a name="prerequisites"></a>Предварительные требования

- Учетная запись Azure с активной подпиской. [Создайте учетную запись](https://azure.microsoft.com/free/) бесплатно.
- Учетная запись GitHub. [Создайте учетную запись](https://github.com/join) бесплатно.
- Установленный компонент [Node.js](https://nodejs.org).

## <a name="set-up-a-nextjs-app"></a>Настройка приложения Next.js

Вместо использования интерфейса командной строки Next.js для создания приложения можно воспользоваться начальным репозиторием, который включает в себя имеющееся приложение Next.js. В этом репозитории реализовано приложение Next.js с динамическими маршрутами, которые выявляют общую проблему развертывания. Для динамических маршрутов требуется дополнительная настройка развертывания, о которой вы узнаете позже.

Для начала создайте репозиторий в учетной записи GitHub из репозитория шаблонов. 

1. Перейдите на страницу <http://github.com/staticwebdev/nextjs-starter/generate>.
1. Присвойте репозиторию имя **nextjs-starter**
1. Затем клонируйте новый репозиторий на компьютер. Обязательно замените `<YOUR_GITHUB_ACCOUNT_NAME>` именем своей учетной записи.

    ```bash
    git clone http://github.com/<YOUR_GITHUB_ACCOUNT_NAME>/nextjs-starter
    ```

1. Перейдите к только что клонированному приложению Next.js:

   ```bash
   cd nextjs-starter
   ```

1. Установите зависимости:

    ```bash
    npm install
    ```

1. Запустите разработку приложения Next.js:

    ```bash
    npm run dev
    ```

Чтобы открыть приложение, перейдите по адресу <http://localhost:3000>. В предпочтительном браузере должен отобразиться следующий веб-сайт:

:::image type="content" source="media/deploy-nextjs/start-nextjs-app.png" alt-text="Запуск приложения Next.js":::

Щелкнув платформу или библиотеку, вы увидите страницу со сведениями о выбранном элементе:

:::image type="content" source="media/deploy-nextjs/start-nextjs-details.png" alt-text="Страница сведений":::

## <a name="generate-a-static-website-from-nextjs-build"></a>Создание статического веб-сайта из сборки Next.js

При создании сайта Next.js с помощью `npm run build` приложение создается как традиционное веб-приложение, а не как статический сайт. Чтобы создать статический сайт, используйте следующую конфигурацию приложения.

1. Чтобы настроить статические маршруты, создайте файл с именем _next.config.js_ в корне проекта и добавьте следующий код.

    ```javascript
    module.exports = {
      exportTrailingSlash: true,
      exportPathMap: function() {
        return {
          '/': { page: '/' }
        };
      }
    };
    ```
    
      Эта конфигурация сопоставляет `/` со страницей Next.js, которая предназначена для корня `/` и является файлом страницы _pages/index.js_.

1. Обновите скрипт сборки _package.json_, чтобы после сборки создать также статический сайт с помощью команды `next export`. Команда `export` создает статический сайт.

    ```json
    "scripts": {
      "dev": "next dev",
      "build": "next build && next export",
    },
    ```

    После выполнения этой команды Статические веб-приложения будут запускать сценарий `build` каждый раз при отправке фиксации.

1. Создайте статический сайт.

    ```bash
    npm run build
    ```

    Статический сайт создается и копируется в папку _out_ в корне рабочей папки.

    > [!NOTE]
    > Эта папка указана в файле _.gitignore_, так как она должна создаваться с помощью CI/CD при развертывании.

## <a name="push-your-static-website-to-github"></a>Отправка статического веб-сайта в GitHub

Статические веб-приложения Azure развертывают ваше приложение из репозитория GitHub и продолжают развертывать каждую отправленную фиксацию в указанную ветвь. Выполните следующие команды, чтобы синхронизировать изменения с GitHub.

1. Подготовьте все измененные файлы, выполнив следующую команду:

    ```bash
    git add .
    ```

1. Зафиксируйте все изменения, выполнив следующую команду:

    ```bash
    git commit -m "Update build config"
    ```

1. Отправьте изменения в GitHub, выполнив следующую команду:

    ```bash
    git push origin master
    ```

## <a name="deploy-your-static-website"></a>Развертывание статического веб-сайта

Следующие действия демонстрируют, как связать приложение, отправленное в GitHub, со статическими веб-приложениями Azure. В Azure вы можете развернуть приложение в рабочей среде.

### <a name="create-a-static-app"></a>Создание статического приложения

1. Перейдите на [портал Azure](https://portal.azure.com).
1. Щелкните **Создать ресурс**.
1. Выполните поиск по запросу **Статические веб-приложения**.
1. Выберите **Статические веб-приложения (предварительная версия)** .
1. Нажмите кнопку **Создать**.

1. Выберите *подписку* из раскрывающегося списка или используйте значение по умолчанию.
1. Щелкните ссылку **Создать** под раскрывающимся списком *Группа ресурсов*. В поле *Имя новой группы ресурсов* введите **mystaticsite** и нажмите кнопку **OK**.
1. В текстовом поле **Имя** укажите глобально уникальное имя для приложения. Допустимые символы: `a-z`, `A-Z`, `0-9` и `-`. Это значение используется в качестве префикса URL-адреса для статического приложения в формате `https://<APP_NAME>.azurestaticapps.net`.
1. В раскрывающемся списке *Регион* выберите ближайший к вам регион.
1. Из раскрывающегося списка номеров SKU выберите **Бесплатный**.

   :::image type="content" source="media/deploy-nextjs/create-static-web-app.png" alt-text="Создание статического веб-приложения":::

### <a name="add-a-github-repository"></a>Добавление репозитория GitHub

Новой учетной записи для статических веб-приложений нужен доступ к репозиторию с приложением Next.js, чтобы автоматически развернуть фиксации.

1. Нажмите кнопку **Войти по учетным данным GitHub**.
1. В поле **Организация** выберите ту, в которой был создан репозиторий для проекта Next.js (это может быть имя пользователя GitHub).
1. Найдите и выберите имя созданного ранее репозитория.
1. Выберите **master** в качестве ветви в раскрывающемся списке *Ветвь*.

   :::image type="content" source="media/deploy-nextjs/connect-github.png" alt-text="Подключение GitHub":::

### <a name="configure-the-build-process"></a>Настройка процесса сборки

Служба "Статические веб-приложения Azure" создана для автоматического выполнения стандартных задач, таких как установка модулей npm и запуска `npm run build` во время каждого развертывания. Однако несколько параметров, например исходную папку приложения и папку назначения сборки, необходимо настроить вручную.

1. Щелкните вкладку **Сборка**, чтобы настроить статическую выходную папку.

   :::image type="content" source="media/deploy-nextjs/build-tab.png" alt-text="Вкладка "Сборка"":::

2. Введите **out** в текстовом поле *App artifact location* (Расположение артефакта приложения).

### <a name="review-and-create"></a>Просмотр и создание

1. Нажмите кнопку **Просмотр и создание** и убедитесь, что вы указали правильные сведения.
1. Щелкните **Создать**, чтобы начать создание ресурса, а также подготовить GitHub Action к развертыванию.
1. Когда развертывание будет завершено, выберите **Перейти к ресурсу**.
1. В окне _Обзор_ щелкните ссылку на *URL-адрес*, чтобы открыть развернутое приложение. 

Если веб-сайт сразу не загрузится, значит фоновый рабочий процесс GitHub Actions все еще выполняется. После завершения рабочего процесса можно нажать кнопку обновления браузера, чтобы просмотреть веб-приложение.
Если веб-сайт сразу не загрузится, значит фоновый рабочий процесс GitHub Actions все еще выполняется. После завершения рабочего процесса можно нажать кнопку обновления браузера, чтобы просмотреть веб-приложение.

Вы можете проверить состояние рабочих процессов Actions, перейдя к ним в своем репозитории.

```url
https://github.com/<YOUR_GITHUB_USERNAME>/nextjs-starter/actions
```

### <a name="sync-changes"></a>Синхронизация изменений

При создании приложения служба "Статические веб-приложения Azure" создала файл рабочего процесса GitHub Actions в вашем репозитории. Этот файл необходимо перенести в локальный репозиторий для синхронизации журнала Git.

Вернитесь в терминал и выполните команду `git pull origin master`.

## <a name="configure-dynamic-routes"></a>Настройка динамических маршрутов

Перейдите к только что развернутому сайту и щелкните один из логотипов платформы или библиотеки. Вместо страницы сведений вы получаете страницу с ошибкой 404.

:::image type="content" source="media/deploy-nextjs/404-in-production.png" alt-text="Ошибка 404 для динамических маршрутов":::

Причина этой ошибки заключается в том, что Next.js создает только домашнюю страницу на основе конфигурации приложения.

## <a name="generate-static-pages-from-dynamic-routes"></a>Создание статических страниц на основе динамических маршрутов

1. Обновите файл _next.config.js_, чтобы приложение Next.js использовало список всех доступных данных для создания статических страниц для каждой платформы или библиотеки:

   ```javascript
   const data = require('./utils/projectsData');

   module.exports = {
     exportTrailingSlash: true,
     exportPathMap: async function () {
       const { projects } = data;
       const paths = {
         '/': { page: '/' },
       };
  
       projects.forEach((project) => {
         paths[`/project/${project.slug}`] = {
           page: '/project/[path]',
           query: { path: project.slug },
         };
       });
  
       return paths;
     },
   };
   ```

   > [!NOTE]
   > Функция `exportPathMap` асинхронна, поэтому в ней вы можете выполнить запрос к API и использовать возвращаемый список для создания путей.

2. Отправьте новые изменения в репозиторий GitHub и подождите несколько минут, пока GitHub Actions еще раз выполнит сборку сайта. По завершении сборки ошибка 404 исчезнет.

   :::image type="content" source="media/deploy-nextjs/404-in-production-fixed.png" alt-text="Ошибка 404 для динамических маршрутов устранена":::

> [!div class="nextstepaction"]
> [Настройка личного домена](custom-domain.md)
