---
title: Переместить Azure Analysis Services в другой регион | Документация Майкрософт
description: Описывает, как переместить ресурс Azure Analysis Services в другой регион.
author: minewiskan
ms.service: azure-analysis-services
ms.topic: how-to
ms.date: 06/09/2020
ms.author: owend
ms.reviewer: minewiskan
ms.openlocfilehash: ff012dc78f3981b6fb5fdbd8a5bde45083dd997b
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "84699436"
---
# <a name="move-analysis-services-to-a-different-region"></a>Переместить Analysis Services в другой регион

В этой статье описывается, как переместить ресурс сервера Analysis Services в другой регион Azure. Вы можете переместить сервер в другой регион по ряду причин, например, чтобы воспользоваться преимуществом региона Azure ближе к пользователям, использовать планы обслуживания, поддерживаемые только в конкретных регионах, или удовлетворить внутренние требования к политике и управлению. 

В этой и связанных связанных статьях вы научитесь:

> [!div class="checklist"]
> 
> * Резервное копирование базы данных модели исходного сервера в [хранилище BLOB-объектов](../storage/blobs/storage-blobs-introduction.md).
> * Экспорт [шаблона ресурсов](../azure-resource-manager/templates/overview.md)исходного сервера.
> * Получите [подписанный URL-адрес хранилища (SAS)](../storage/common/storage-sas-overview.md).
> * Измените шаблон ресурса.
> * Разверните шаблон, чтобы создать новый целевой сервер.
> * Восстановите базу данных модели на новом целевом сервере.
> * Проверьте новый целевой сервер и базу данных.
> * Удалите исходный сервер.

В этой статье описывается использование шаблона ресурса для переноса одного Analysis Services сервера с **базовой конфигурацией** в другой регион *и* группу ресурсов в той же подписке. Использование шаблона позволяет хранить настроенные свойства сервера, гарантируя, что на целевом сервере настроены те же свойства, кроме региона и группы ресурсов, что и на исходном сервере. В этой статье не описывается перемещение связанных ресурсов, которые могут входить в одну группу ресурсов, например источник данных, хранилище и ресурсы шлюза. 

Перед перемещением сервера в другой регион рекомендуется создать подробный план. Примите во внимание дополнительные ресурсы, такие как шлюзы и хранилище, которые также может потребоваться переместить. При использовании любого плана важно выполнить одну или несколько пробных операций перемещения с помощью тестовых серверов до перемещения рабочего сервера.

> [!IMPORTANT]
> Клиентские приложения и строки подключения подключаются к Analysis Services с помощью полного имени сервера, которое представляет собой универсальный код ресурса (URI), включающий регион, в котором находится сервер. Например, `asazure://westcentralus.asazure.windows.net/advworks01`. При перемещении сервера в другой регион вы фактически создаете новый ресурс сервера в другом регионе, который будет иметь другой регион в URI имени сервера. Клиентские приложения и строки подключения, используемые в скриптах, должны подключаться к новому серверу, используя новый универсальный код ресурса (URI) имени сервера. Использование [псевдонима имени сервера](analysis-services-server-alias.md) может уменьшить число мест, в которых URI имени сервера должен быть изменен, но перед перемещением региона его необходимо реализовать.

> [!IMPORTANT]
> Регионы Azure используют разные диапазоны IP-адресов. Если у вас есть исключения брандмауэра, настроенные для региона, в котором находится сервер или учетная запись хранения, может потребоваться настроить другой диапазон IP-адресов. Дополнительные сведения см. в разделе [часто задаваемые вопросы о Analysis Services сетевом подключении](analysis-services-network-faq.md).

> [!NOTE]
> В этой статье описывается восстановление резервной копии базы данных на целевом сервере из контейнера хранилища в регионе исходного сервера. В некоторых случаях восстановление резервных копий из другого региона может привести к снижению производительности, особенно для больших баз данных. Для лучшей производительности при восстановлении базы данных перенесите или создайте новый контейнер хранилища в регионе целевого сервера. Перед восстановлением базы данных на целевой сервер скопируйте ABF файлы резервных копий из контейнера хранилища исходного региона в контейнер хранилища целевого региона. В некоторых случаях, в частности с очень большими базами данных, создание сценариев для базы данных с исходного сервера, повторное формирование, а затем обработка на целевом сервере для загрузки данных базы данных может оказаться более экономичной, чем использование резервного копирования и восстановления.

> [!NOTE]
> При использовании локального шлюза данных для подключения к источникам данных необходимо также переместить ресурс шлюза в регион целевого сервера. Дополнительные сведения см. в статье [Установка и настройка локального шлюза данных](analysis-services-gateway-install.md).

## <a name="prerequisites"></a>Предварительные условия

- **Учетная запись хранения Azure**: требуется для хранения ABF файла резервной копии.
- **SQL Server Management Studio (SSMS)**: требуется для резервного копирования и восстановления баз данных модели.
- **Azure PowerShell**. Требуется только в том случае, если вы решили выполнить эту задачу с помощью PowerShell.

## <a name="prepare"></a>Подготовка.

### <a name="backup-model-databases"></a>Резервное копирование баз данных

Если **Параметры хранилища** еще не настроены для исходного сервера, выполните действия, описанные в разделе [Настройка параметров хранилища](analysis-services-backup.md#configure-storage-settings).

После настройки параметров хранилища выполните действия, описанные в разделе [резервное копирование](analysis-services-backup.md#backup) , чтобы создать модель Database. ABF-резервная копия в контейнере хранилища. Позже вы восстановите ABF резервную копию на новом целевом сервере.


### <a name="export-template"></a>Экспорт шаблона

Шаблон содержит свойства конфигурации исходного сервера.

# <a name="portal"></a>[Портал](#tab/azure-portal)

Чтобы экспортировать шаблон с помощью портала Azure:

1. Войдите на [портал Azure](https://portal.azure.com).

2. Выберите **все ресурсы**, а затем выберите сервер Analysis Services.

3. Выберите **Параметры**>  >  **Экспорт шаблона**.

4. Выберите **скачать** в колонке **Экспорт шаблона** .

5. Найдите ZIP-файл, скачанный с портала, а затем распакуйте его в папку.

   ZIP-файл содержит JSON-файлы, составляющие шаблон, и параметры, необходимые для развертывания нового сервера.


# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

Чтобы экспортировать шаблон с помощью PowerShell, выполните следующие действия.

1. С помощью команды [Connect-AzAccount](https://docs.microsoft.com/powershell/module/az.accounts/connect-azaccount?view=azps-2.5.0) войдите в подписку Azure и следуйте инструкциям на экране:

   ```azurepowershell-interactive
   Connect-AzAccount
   ```
2. Если ваше удостоверение связано с более чем одной подпиской, установите активную подписку на подписку ресурса сервера, который требуется переместить.

   ```azurepowershell-interactive
   $context = Get-AzSubscription -SubscriptionId <subscription-id>
   Set-AzContext $context
   ```

3. Экспортируйте шаблон исходного сервера. Эти команды сохраняют шаблон JSON с именем файла ResourceGroupName в текущем каталоге.

   ```azurepowershell-interactive
   $resource = Get-AzResource `
     -ResourceGroupName <resource-group-name> `
     -ResourceName <server-account-name> `
     -ResourceType Microsoft.AnalysisServices/servers
   Export-AzResourceGroup `
     -ResourceGroupName <resource-group-name> `
     -Resource $resource.ResourceId
   ```
---

### <a name="get-storage-shared-access-signature-sas"></a>Получить подпись общего доступа к хранилищу (SAS)

При развертывании целевого сервера из шаблона для указания контейнера хранилища, содержащего резервную копию базы данных, требуется маркер SAS делегирования безопасности (в виде URI).

# <a name="portal"></a>[Портал](#tab/azure-portal)

Чтобы получить подписанный URL-доступ с помощью портала, выполните следующие действия.

1. На портале выберите учетную запись хранения, используемую для резервного копирования базы данных сервера.

2. Выберите **Обозреватель службы хранилища**, а затем — **контейнеры больших двоичных объектов**. 

3. Щелкните правой кнопкой мыши контейнер хранилища и выберите **получить подпись общего доступа**.

    :::image type="content" source="media/move-between-regions/get-sas.png" alt-text="Получение SAS":::

4. В **подписанном**URL, выберите **создать**. По умолчанию срок действия SAS истекает через 24 часа.

5. Скопируйте и сохраните **URI**. 

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

Чтобы получить подписанный URL-адрес с помощью PowerShell, выполните действия, описанные в статье [Создание SAS делегирования пользователя для контейнера или большого двоичного объекта с использованием PowerShell](../storage/blobs/storage-blob-user-delegation-sas-create-powershell.md#create-a-user-delegation-sas-for-a-blob).

---

### <a name="modify-the-template"></a>Изменение шаблона

Используйте текстовый редактор, чтобы изменить template.jsэкспортированного файла, изменив свойства области и контейнера больших двоичных объектов. 

Чтобы изменить шаблон, выполните следующие действия.

1. В текстовом редакторе в свойстве **Расположение** укажите новый целевой регион. В свойстве **баккупблобконтаинерури** вставьте URI контейнера хранилища с ключом SAS. 

    В следующем примере задается целевой регион для сервера advworks1 `South Central US` и указывается URI контейнера хранилища с подписью общего доступа: 

    ```json
    "resources": [
        {
            "type": "Microsoft.AnalysisServices/servers",
            "apiVersion": "2017-08-01",
            "name": "[parameters('servers_advworks1_name')]",
            "location": "South Central US",
            "sku": {
                "name": "S1",
                "tier": "Standard",
                "capacity": 1
            },
            "properties": {
                "asAdministrators": {
                    "members": [
                        "asadmins@adventure-works.com"
                    ]
                },
                "backupBlobContainerUri": "https://storagenorthcentralus.blob.core.windows.net/backup?sp=rl&st=2020-06-01T19:30:42Z&se=2020-06-02T19:30:42Z&sv=2019-10-10&sr=c&sig=PCQ4s9RujJkxu89gO4tiDTbE3%2BFECx6zAdcv8x0cVUQ%3D",
                "querypoolConnectionMode": "All"
            }
        }
    ]         
    ```
2. при сохранении шаблона;

#### <a name="regions"></a>Регионы

Чтобы получить регионы Azure, см. раздел [расположения Azure](https://azure.microsoft.com/global-infrastructure/locations/). Чтобы получить регионы с помощью PowerShell, выполните команду [Get-азлокатион](https://docs.microsoft.com/powershell/module/az.resources/get-azlocation?view=azps-1.8.0) .

```azurepowershell-interactive
   Get-AzLocation | format-table 
```

## <a name="move"></a>Переместить

Чтобы развернуть новый ресурс сервера в другом регионе, вы будете использовать **template.jsв** файле, который вы экспортировали и изменили в предыдущих разделах.

# <a name="portal"></a>[Портал](#tab/azure-portal)

1. На портале выберите **создать ресурс**.

2. В **поле Поиск в Marketplace**введите **шаблон развертывание**и нажмите клавишу **Ввод**.

3. Выберите **шаблоны развертывания**.

4. Выберите **Создать**.

5. Выберите **создать собственный шаблон в редакторе**.

6. Выберите **загрузить файл**и следуйте инструкциям, чтобы загрузить **template.jsв** файл, который вы экспортировали и изменили.

7. Убедитесь, что в редакторе шаблонов отображаются правильные свойства нового целевого сервера.

8. Нажмите кнопку **Сохранить**.

9. Введите или выберите значения свойств:

    - **Подписка**— выберите подписку Azure.
    
    - **Группа ресурсов**. Выберите **создать**и введите имя группы ресурсов. Можно выбрать имеющуюся группу ресурсов, если она еще не содержит сервер Analysis Services с тем же именем.
    
    - **Расположение**. Выберите тот же регион, который вы указали в шаблоне.

10. Выберите **Проверка и создать**.

11. Просмотрите термины и основные принципы, а затем щелкните **создать**.

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

Используйте следующие команды для развертывания шаблона:

```azurepowershell-interactive
   $resourceGroupName = Read-Host -Prompt "Enter the Resource Group name"
   $location = Read-Host -Prompt "Enter the location (i.e. South Central US)"

   New-AzResourceGroup -Name $resourceGroupName -Location "$location"
   New-AzResourceGroupDeployment -ResourceGroupName $resourceGroupName -TemplateUri "<local template file>"  
   ```
---

### <a name="get-target-server-uri"></a>Получение URI целевого сервера

Чтобы подключиться к новому целевому серверу из среды SSMS для восстановления базы данных модели, необходимо получить новый универсальный код ресурса (URI) целевого сервера.

# <a name="portal"></a>[Портал](#tab/azure-portal)

Чтобы получить универсальный код ресурса (URI) сервера на портале, выполните следующие действия.

1. На портале перейдите к новому ресурсу целевого сервера.

2. На странице **Обзор** скопируйте URI **имени сервера** .

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

Чтобы получить универсальный код ресурса (URI) сервера с помощью PowerShell, выполните следующие команды:

```azurepowershell-interactive
   $resourceGroupName = Read-Host -Prompt "Enter the Resource Group name"
   $serverName = Read-Host -Prompt "Enter the server name (i.e. advworks2)"

   Get-AzAnalysisServicesServer -ResourceGroupName $resourceGroupName -Name "$serverName"
```
Скопируйте **серверфуллнаме** из выходных данных.

---

### <a name="restore-model-database"></a>Восстановление базы данных модели

Выполните действия, описанные в разделе [Восстановление](analysis-services-backup.md#restore) , чтобы восстановить резервную копию модели Database. ABF на новом целевом сервере.

Необязательно. После восстановления базы данных модели обработайте модель и таблицы для обновления данных из источников данных. Для обработки модели и таблицы с помощью SSMS:

1. В среде SSMS щелкните правой кнопкой мыши базу данных модели > **Обработка базы данных**.

2. Разверните узел **таблицы**, щелкните правой кнопкой мыши таблицу. В списке **обработка таблиц**выберите все таблицы, а затем нажмите кнопку **ОК**.

## <a name="verify"></a>Проверка

1. На портале перейдите к новому целевому серверу.

2. На странице Обзор в разделе **модели на Analysis Services сервере**убедитесь, что отображаются восстановленные модели.

3. Используйте клиентское приложение, например Power BI или Excel, для подключения к модели на новом сервере. Проверьте, отображаются ли такие объекты модели, как таблицы, меры и иерархии. 

4. Запустите любые скрипты автоматизации. Убедитесь, что они выполнены успешно.

Необязательно. [набор ALM Toolkit](http://alm-toolkit.com/) — это инструмент с *открытым исходным кодом* для сравнения и управления Power BI наборами данных *и* Analysis Services табличными моделями. Используйте набор средств для подключения к базам данных исходного и целевого сервера и сравнения. Если миграция базы данных прошла успешно, объекты модели будут иметь то же определение. 

:::image type="content" source="media/move-between-regions/alm-toolkit.png" alt-text="Набор средств ALM":::

## <a name="clean-up-resources"></a>Очистка ресурсов

После проверки того, что клиентские приложения могут подключаться к новому серверу и какие скрипты автоматизации выполняются правильно, удалите исходный сервер. 

# <a name="portal"></a>[Портал](#tab/azure-portal)

Чтобы удалить исходный сервер с портала, выполните следующие действия.

На странице **Обзор** исходного сервера выберите **Удалить**.

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

Чтобы удалить исходный сервер с помощью PowerShell, используйте команду Remove-Азаналисиссервицессервер.

```azurepowershell-interactive
Remove-AzAnalysisServicesServer -Name "myserver" -ResourceGroupName "myResourceGroup"
```

---

> [!NOTE]
> После завершения перемещения региона рекомендуется, чтобы новый целевой сервер использовал контейнер хранилища в том же регионе для резервных копий, а не контейнер хранилища в регионе исходного сервера. 
