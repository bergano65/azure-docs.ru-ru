---
title: Настройка брандмауэра веб-приложения (WAF) для передней дверцы Azure
description: В этой статье вы узнаете, как настроить WAF для работы в передней дверце.
services: web-application-firewall
author: mohitkusecurity
ms.service: web-application-firewall
ms.topic: conceptual
ms.date: 12/11/2020
ms.author: mohitku
ms.reviewer: tyao
ms.openlocfilehash: a24f9e78de34b17977a1876cbefb473cc2610db0
ms.sourcegitcommit: c95e2d89a5a3cf5e2983ffcc206f056a7992df7d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/24/2020
ms.locfileid: "95550051"
---
# <a name="tuning-web-application-firewall-waf-for-azure-front-door"></a>Настройка брандмауэра веб-приложения (WAF) для передней дверцы Azure
 
Набор правил по умолчанию, управляемый Azure, основан на [наборе правил OWASP Core (CR)](https://github.com/SpiderLabs/owasp-modsecurity-crs/tree/v3.1/dev) и предназначен для более тщательного использования. Часто ожидается, что правила WAF должны быть настроены в соответствии с конкретными потребностями приложения или организации с помощью WAF. Обычно это достигается путем определения исключений правил, создания настраиваемых правил и даже для отключения правил, которые могут вызывать проблемы или ложные срабатывания. Существует несколько действий, которые можно выполнить, если запросы, которые должны пройти через брандмауэр веб-приложения (WAF), заблокированы.

Сначала убедитесь, что вы прочитали [Обзор WAF для передней дверцы](afds-overview.md) и [политику WAF для документов с передней дверцей](waf-front-door-create-portal.md) . Кроме того, убедитесь, что вы включили [мониторинг и ведение журнала WAF](waf-front-door-monitor.md). В этих статьях объясняется, как работают функции WAF, как наборы правил WAF и как получить доступ к журналам WAF.
 
## <a name="understanding-waf-logs"></a>Основные сведения о журналах WAF
 
Журналы WAF предназначены для отображения всех запросов, соответствующих или заблокированных WAF. Это коллекция всех проверенных запросов, которые сопоставлены или заблокированы. Если вы заметили, что WAF блокирует запрос, который не должен (ложный положительный результат), можно выполнить несколько действий. Сначала Ограничьте и найдите конкретный запрос. При необходимости можно [настроить пользовательское ответное сообщение](./waf-front-door-configure-custom-response-code.md) , включив поле, `trackingReference` чтобы легко определить событие и выполнить запрос к журналу по определенному значению. Просмотрите журналы, чтобы найти конкретный URI, метку времени или клиентский IP-адрес запроса. При обнаружении связанных записей журнала можно начать действовать с ложными срабатываниями. 
 
Например, предположим, что у вас есть допустимый трафик, содержащий строку `1=1` , которую вы хотите передать через WAF. Вот как выглядит запрос:

```
POST http://afdwafdemosite.azurefd.net/api/Feedbacks HTTP/1.1
Host: afdwafdemosite.azurefd.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 55

UserId=20&captchaId=7&captchaId=15&comment="1=1"&rating=3
```

При попытке выполнить запрос WAF блокирует трафик, содержащий строку *1 = 1* , в любом параметре или поле. Это строка, часто связанная с атакой путем внедрения кода SQL. Можно просмотреть журналы и просмотреть отметку времени запроса и правила, которые были заблокированы или сопоставлены.
 
В следующем примере рассматривается `FrontdoorWebApplicationFirewallLog` журнал, сформированный из-за соответствия правилу.
 
В поле "requestUri" можно увидеть, что запрос выполнен в `/api/Feedbacks/` конкретном случае. Далее мы найдем идентификатор правила `942110` в поле "ruleName". Зная идентификатор правила, можно переходить к [официальному репозиторию набора правил OWASP ModSecurity Core](https://github.com/coreruleset/coreruleset) и искать его по [идентификатору правила](https://github.com/coreruleset/coreruleset/blob/v3.1/dev/rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf) , чтобы просмотреть его код и понять, что именно соответствует этому правилу. 
 
Затем, установив флажок в `action` поле, мы видим, что для этого правила задано блокирование запросов после сопоставления, и мы подтверждаем, что запрос на самом деле заблокирован WAF, поскольку `policyMode` имеет значение `prevention` . 
 
Теперь давайте проверим информацию в `details` поле. Здесь можно увидеть `matchVariableName` и `matchVariableValue` сведения. Мы познакомимся, что это правило было активировано, так как кто-то приходился к вводу *1 = 1* в `comment` поле приложения.
 
```json
{
    "time": "2020-09-24T16:43:04.5422943Z",
    "resourceId": "/SUBSCRIPTIONS/<Subscription ID>/RESOURCEGROUPS/<Resource Group Name>/PROVIDERS/MICROSOFT.NETWORK/FRONTDOORS/AFDWAFDEMOSITE",
    "category": "FrontdoorWebApplicationFirewallLog",
    "operationName": "Microsoft.Network/FrontDoor/WebApplicationFirewallLog/Write",
    "properties": {
        "clientIP": "1.1.1.1",
        "clientPort": "53566",
        "socketIP": "1.1.1.1",
        "requestUri": "http://afdwafdemosite.azurefd.net:80/api/Feedbacks/",
        "ruleName": "DefaultRuleSet-1.0-SQLI-942110",
        "policy": "AFDWAFDemoPolicy",
        "action": "Block",
        "host": "afdwafdemosite.azurefd.net",
        "trackingReference": "0mMxsXwAAAABEalekYeI4S55qpi5R7R0/V1NURURHRTA4MTIAZGI4NGQzZDgtNWQ5Ny00ZWRkLTg2ZGYtZDJjNThlMzI2N2I4",
        "policyMode": "prevention",
        "details": {
            "matches": [
                {
                    "matchVariableName": "PostParamValue:comment",
                    "matchVariableValue": "\"1=1\""
                }
            ],
            "msg": "SQL Injection Attack: Common Injection Testing Detected",
            "data": "Matched Data: \"1=1\" found within PostParamValue:comment: \"1=1\""
        }
    }
}
```
 
Также имеется значение в статье Проверка журналов доступа для расширения знаний о заданном событии WAF. Ниже мы рассмотрим `FrontdoorAccessLog` журнал, который был создан как ответ на событие выше.
 
Можно увидеть, что это связанные журналы, основанные на `trackingReference` значении. В разных полях, предоставляющих общий аналитический анализ, например `userAgent` и `clientIP` , мы вызываем внимание на `httpStatusCode` `httpStatusDetails` поля и. Здесь мы можем убедиться, что клиент получил ответ HTTP 403, который абсолютно подтверждает, что запрос был отклонен и заблокирован. 
 
```json
{
    "time": "2020-09-24T16:43:04.5430764Z",
    "resourceId": "/SUBSCRIPTIONS/<Subscription ID>/RESOURCEGROUPS/<Resource Group Name>/PROVIDERS/MICROSOFT.NETWORK/FRONTDOORS/AFDWAFDEMOSITE",
    "category": "FrontdoorAccessLog",
    "operationName": "Microsoft.Network/FrontDoor/AccessLog/Write",
    "properties": {
        "trackingReference": "0mMxsXwAAAABEalekYeI4S55qpi5R7R0/V1NURURHRTA4MTIAZGI4NGQzZDgtNWQ5Ny00ZWRkLTg2ZGYtZDJjNThlMzI2N2I4",
        "httpMethod": "POST",
        "httpVersion": "1.1",
        "requestUri": "http://afdwafdemosite.azurefd.net:80/api/Feedbacks/",
        "requestBytes": "2160",
        "responseBytes": "324",
        "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36",
        "clientIp": "1.1.1.1",
        "socketIp": "1.1.1.1",
        "clientPort": "53566",
        "timeToFirstByte": "0.01",
        "timeTaken": "0.011",
        "securityProtocol": "",
        "routingRuleName": "DemoBERoutingRule",
        "rulesEngineMatchNames": [],
        "backendHostname": "13.88.65.130:3000",
        "isReceivedFromClient": true,
        "httpStatusCode": "403",
        "httpStatusDetails": "403",
        "pop": "WST",
        "cacheStatus": "CONFIG_NOCACHE"
    }
}
```

## <a name="resolving-false-positives"></a>Разрешение ложных срабатываний
 
Чтобы принять обоснованное решение об обработке ложного срабатывания, важно ознакомиться с технологиями, используемыми приложением. Например, предположим, что в вашем технологическом стеке нет SQL Server, и вы получаете ложные срабатывания, связанные с этими правилами. Отключение этих правил не обязательно приводит к ослаблению безопасности. 

С этой информацией и знанием правила 942110, которое соответствует `1=1` строке в нашем примере, мы можем выполнить несколько действий, чтобы предотвратить блокирование этого допустимого запроса:
 
* Использовать списки исключений
  * Дополнительные сведения о списках исключений см. [в разделе брандмауэр веб-приложения (WAF) со списком исключений службы Front дверь](waf-front-door-exclusion.md) . 
* Изменить действия WAF
  * Дополнительные сведения о действиях, которые могут быть выполнены, когда запрос соответствует условиям правила, см. в разделе [WAF Actions](afds-overview.md#waf-actions) .
* Использование настраиваемых правил
  * Дополнительные сведения о настраиваемых правилах см. [в статье пользовательские правила для брандмауэра веб-приложения с помощью передней дверцы Azure](waf-front-door-custom-rules.md) .
* Отключение правил 

> [!TIP]
> При выборе подхода, разрешающего допустимые запросы через WAF, попробуйте сделать это как можно более узким. Например, лучше использовать список исключений, чем полностью отключить правило.

### <a name="using-exclusion-lists"></a>Использование списков исключений

Одним из преимуществ использования списка исключений является то, что только выбранная для исключения переменная сопоставления больше не будет проверяться для данного запроса. То есть можно выбирать между конкретными заголовками запроса, файлами Cookie запроса, аргументами строки запроса или аргументами отправки текста запроса, которые будут исключены при выполнении определенного условия, а не исключая проверку всего запроса. Другие неуказанные переменные запроса по-прежнему будут проверяться в обычном режиме.
 
Важно учитывать, что исключения являются глобальными настройками. Это означает, что настроенное исключение будет применяться ко всему трафику, проходящему через WAF, а не только к конкретному веб-приложению или URI. Например, это может быть проблемой, если *1 = 1* является допустимым запросом в тексте для определенного веб-приложения, но не для других в рамках той же политики WAF. Если имеет смысл использовать разные списки исключений для разных приложений, рассмотрите возможность использования различных политик WAF для каждого приложения и применения их к интерфейсному внешнему приложению.
 
При настройке списков исключений для управляемых правил можно исключить все правила в наборе правил, все правила в группе правил или отдельное правило. Список исключений можно настроить с помощью [PowerShell](https://docs.microsoft.com/powershell/module/az.frontdoor/New-AzFrontDoorWafManagedRuleExclusionObject?view=azps-4.7.0&viewFallbackFrom=azps-3.5.0), [Azure CLI](https://docs.microsoft.com/cli/azure/ext/front-door/network/front-door/waf-policy/managed-rules/exclusion?view=azure-cli-latest#ext_front_door_az_network_front_door_waf_policy_managed_rules_exclusion_add), [API-интерфейса RESTful](https://docs.microsoft.com/rest/api/frontdoorservice/webapplicationfirewall/policies/createorupdate)или портал Azure.

* Исключения на уровне правила
  * Применение исключений на уровне правила означает, что указанные исключения не будут анализироваться только по этому отдельному правилу, а все еще будут анализироваться по всем остальным правилам набора правил. Это наиболее детализированный уровень исключений. его можно использовать для точной настройки набора управляемых правил на основе сведений, найденных в журналах WAF при устранении неполадок с событием.
* Исключения на уровне группы правил
  * Применение исключений на уровне группы правил означает, что указанные исключения не будут анализироваться по определенному набору типов правил. Например, выбор *скрытых* в качестве исключенной группы правил указывает, что определенные исключения запросов не будут проверены ни одним из правил, характерных для скрытых, но все равно будут проверяться правилами в других группах, таких как *PHP*, *RFI* или *XSS*. Этот тип исключения может быть полезен, если мы уверены, что приложение не подвержено атакам конкретного типа. Например, приложение, у которого нет баз данных SQL, может исключить все правила *скрытых* без ухудшения его уровня безопасности.
* Исключения на уровне набора правил 
  * Применение исключений на уровне набора правил означает, что указанные исключения не будут анализироваться по любому из правил безопасности, доступных в этом наборе правил. Это комплексное исключение, поэтому его следует использовать аккуратно.

В этом примере мы выполним исключение на наиболее детализированном уровне (применение исключения к одному правилу), и мы хотим исключить из **тела запроса** с переменной Match имя, которое содержит `comment` . Это очевидно, поскольку в журнале брандмауэра можно просмотреть сведения о переменной Match: `"matchVariableName": "PostParamValue:comment"` . Атрибут имеет значение `comment`. Кроме того, имя этого атрибута можно найти несколькими другими способами. см. раздел [Поиск имен атрибутов запросов](#finding-request-attribute-names).

![Правила исключения](../media/waf-front-door-tuning/exclusion-rules.png)

![Исключение правила для конкретного правила](../media/waf-front-door-tuning/exclusion-rule.png)

Иногда бывают случаи, когда определенные параметры передаются в WAF способом, который не может быть интуитивно понятным. Например, существует токен, который передается при проверке подлинности с помощью Azure Active Directory. Этот маркер, `__RequestVerificationToken` как правило, передается в качестве файла Cookie запроса. Однако в некоторых случаях, когда файлы cookie отключены, этот маркер также передается в качестве аргумента запроса POST. По этой причине для устранения ложных срабатываний маркера Azure AD необходимо убедиться, что `__RequestVerificationToken` добавлен в список исключений для `RequestCookieNames` и `RequestBodyPostArgsNames` .

Исключения в имени поля (*selector*) означают, что значение больше не будет оцениваться WAF. Однако само имя поля по-своему будет оцениваться и в редких случаях оно может соответствовать правилу WAF и запускать действие.

![Исключение правила для набора правил](../media/waf-front-door-tuning/exclusion-rule-selector.png)

### <a name="changing-waf-actions"></a>Изменение действий WAF

Другим способом обработки поведения правил WAF является выбор действия, которое он будет выполнять, когда запрос соответствует условиям правила. Доступные действия: [разрешение, блокировка, журнал и перенаправление](afds-overview.md#waf-actions).

В этом примере мы изменили *блок* действия по умолчанию на действие *log* в правиле 942110. Это приведет к тому, что WAF зарегистрирует запрос и продолжит оценивать тот же запрос относительно остальных правил с низким приоритетом.

![Действия WAF](../media/waf-front-door-tuning/actions.png)

После выполнения одного и того же запроса мы можем вернуться к журналам, и мы увидим, что этот запрос был совпадением с ИДЕНТИФИКАТОРом 942110, а `action_s` поле теперь указывает *Журнал* , а не *блок*. Затем мы развернули запрос журнала для включения `trackingReference_s` информации и посмотрим, что еще произошло с этим запросом.

![Журнал, отображающий несколько совпадений правил](../media/waf-front-door-tuning/actions-log.png)

Интересно, что после обработки идентификатора правила 942110 в миллисекундах будет соблюдаться другое соответствие правилу скрытых. Тот же запрос соответствует ИДЕНТИФИКАТОРу правила 942310, а на этот раз был активирован *блок* действий по умолчанию.

Еще одно преимущество использования действия *log* во время настройки или устранения неполадок в WAF заключается в том, что можно выяснить, совпадают ли несколько правил в определенной группе правил и блокируя заданный запрос. Затем можно создать исключения на соответствующем уровне, т. е. на уровне правила или группы правил. 

### <a name="using-custom-rules"></a>Использование настраиваемых правил

После определения того, что вызывает сопоставление правила WAF, можно использовать пользовательские правила, чтобы настроить реакцию WAF на событие. Пользовательские правила обрабатываются до управляемых правил, они могут содержать более одного условия, а их действия могут быть [разрешены, запрещены, заноситься в журнал или перенаправление](afds-overview.md#waf-actions). При совпадении правил подсистема WAF прекращает обработку. Это означает, что другие настраиваемые правила с более низким приоритетом и управляемыми правилами больше не выполняются.

В приведенном ниже примере мы создали пользовательское правило с двумя условиями. Первое условие ищет `comment` значение в тексте запроса. Второе условие ищет `/api/Feedbacks/` значение в URI запроса.

Использование настраиваемого правила позволяет наиболее детально выполнять точную настройку правил WAF и для работы с ложными срабатываниями. В этом случае мы не будем предпринимать никаких действий на основе `comment` значения текста запроса, которое может существовать на нескольких сайтах или в приложениях с одной и той же ПОЛИТИКОЙ WAF. Если включить другое условие для сопоставления с определенным URI запроса, то `/api/Feedbacks/` это пользовательское правило действительно применимо к этому явному варианту использования, который мы проверены. Это гарантирует, что та же атака, выполняемая для различных условий, будет по-прежнему проверяться и предотвращаться ядром WAF.

![Журнал](../media/waf-front-door-tuning/custom-rule.png)

При просмотре журнала можно увидеть, что `ruleName_s` поле содержит имя, присвоенное настраиваемому правилу, которое мы создали: `redirectcomment` . В `action_s` этом поле можно увидеть, что действие *перенаправления* было выполнено для этого события. В этом `details_matches_s` поле можно увидеть, что данные обоих условий совпадают.

### <a name="disabling-rules"></a>Отключение правил

Еще один способ обойти ложное срабатывание — отключить правило, совпадающее с входными данными, на которые WAF считался злоумышленник. Так как вы проанализировали журналы WAF и изменили правило до 942110, вы можете отключить его в портал Azure. См. раздел [Настройка правил брандмауэра веб-приложения с помощью портал Azure](../ag/application-gateway-customize-waf-rules-portal.md#disable-rule-groups-and-rules).
 
Отключение правила является преимуществом, если вы уверены, что все запросы, отвечающие определенному условию, находятся на самом деле, или если вы уверены, что правило не применяется к вашей среде (например, отключая правило внедрения кода SQL, так как у вас нет серверных интерфейсов, отличных от SQL). 
 
Однако отключение правила — это глобальный параметр, который применяется ко всем интерфейсным узлам, связанным с политикой WAF. При отключении правила, возможно, вы оставите уязвимости без защиты или обнаружения каких-либо других интерфейсных узлов, связанных с политикой WAF.
 
Если вы хотите использовать Azure PowerShell для отключения управляемого правила, см [`PSAzureManagedRuleOverride`](https://docs.microsoft.com/powershell/module/az.frontdoor/new-azfrontdoorwafmanagedruleoverrideobject?view=azps-4.7.0&preserve-view=true) . документацию по объектам. Если вы хотите использовать Azure CLI, см [`az network front-door waf-policy managed-rules override`](https://docs.microsoft.com/cli/azure/ext/front-door/network/front-door/waf-policy/managed-rules/override?view=azure-cli-latest&preserve-view=true) . документацию.

![Правила WAF](../media/waf-front-door-tuning/waf-rules.png)

## <a name="finding-request-fields"></a>Поиск полей запроса

Используя прокси-сервер браузера, например [Fiddler](https://www.telerik.com/fiddler), можно проверять отдельные запросы и определять, какие именно поля веб-страницы вызываются. Это полезно, когда нам нужно исключить определенные поля из проверки с помощью списков исключений в WAF.

### <a name="finding-request-attribute-names"></a>Поиск имен атрибутов запроса
 
В этом примере можно увидеть поле, в котором `1=1` была введена строка `comment` . Эти данные переданы в тексте запроса POST.

![Запрос Fiddler, показывающий текст](../media/waf-front-door-tuning/fiddler-request-attribute-name.png)

Это поле, которое можно исключить. Дополнительные сведения о списках исключений см. в разделе [списки исключений брандмауэра веб-приложения](./waf-front-door-exclusion.md). Вы можете исключить оценку в этом случае, настроив следующие исключения:

![Правило исключения](../media/waf-front-door-tuning/fiddler-request-attribute-name-exclusion.png)

Вы также можете просмотреть журналы брандмауэра, чтобы получить сведения, необходимые для добавления в список исключений. Сведения о включении ведения журнала см. [в статье мониторинг метрик и журналов в передней дверце Azure](./waf-front-door-monitor.md).

Просмотрите журнал брандмауэра в файле в `PT1H.json` течение часа, в течение которого был получен запрос, который требуется проверить. `PT1H.json` файлы доступны в контейнерах учетной записи хранения, где `FrontDoorWebApplicationFirewallLog` `FrontDoorAccessLog` хранятся журналы диагностики и.

В этом примере можно увидеть правило, которое заблокировало запрос (с той же ссылкой на транзакцию) и произошло в то же время:

```json
{
    "time": "2020-09-24T16:43:04.5422943Z",
    "resourceId": "/SUBSCRIPTIONS/<Subscription ID>/RESOURCEGROUPS/<Resource Group Name>/PROVIDERS/MICROSOFT.NETWORK/FRONTDOORS/AFDWAFDEMOSITE",
    "category": "FrontdoorWebApplicationFirewallLog",
    "operationName": "Microsoft.Network/FrontDoor/WebApplicationFirewallLog/Write",
    "properties": {
        "clientIP": "1.1.1.1",
        "clientPort": "53566",
        "socketIP": "1.1.1.1",
        "requestUri": "http://afdwafdemosite.azurefd.net:80/api/Feedbacks/",
        "ruleName": "DefaultRuleSet-1.0-SQLI-942110",
        "policy": "AFDWAFDemoPolicy",
        "action": "Block",
        "host": "afdwafdemosite.azurefd.net",
        "trackingReference": "0mMxsXwAAAABEalekYeI4S55qpi5R7R0/V1NURURHRTA4MTIAZGI4NGQzZDgtNWQ5Ny00ZWRkLTg2ZGYtZDJjNThlMzI2N2I4",
        "policyMode": "prevention",
        "details": {
            "matches": [
                {
                    "matchVariableName": "PostParamValue:comment",
                    "matchVariableValue": "\"1=1\""
                }
            ],
            "msg": "SQL Injection Attack: Common Injection Testing Detected",
            "data": "Matched Data: \"1=1\" found within PostParamValue:comment: \"1=1\""
        }
    }
}
```

Зная, как работают наборы правил, управляемые Azure (см. раздел [брандмауэр веб-приложения на передней дверце Azure](afds-overview.md)), вы узнаете, что правило с свойством *Action: Block* блокируется на основе данных, совпадающих в тексте запроса. В сведениях, найденных в шаблоне (), можно увидеть, что `1=1` поле имеет имя `comment` . Выполните те же предыдущие действия, чтобы исключить имя сообщения POST аргументов, содержащее `comment` .

### <a name="finding-request-header-names"></a>Поиск имен заголовков запросов

Fiddler — это удобное средство для поиска имен заголовков запросов. На следующем снимке экрана показаны заголовки для этого запроса GET, которые включают тип содержимого, агент пользователя и т. д. Заголовки запросов также можно использовать для создания исключений и настраиваемых правил в WAF.

![Запрос Fiddler, показывающий заголовок](../media/waf-front-door-tuning/fiddler-request-header-name.png)

Другим способом просмотра заголовков запросов и ответов является поиск в средствах разработчика браузера, таких как ребро или Chrome. Можно нажать клавишу F12 или щелкнуть правой кнопкой мыши > **проверить**  ->  **средства для разработчиков** и выбрать вкладку **сеть** . Загрузите веб-страницу и щелкните запрос, который требуется проверить.

![Запрос инспектора сети](../media/waf-front-door-tuning/network-inspector-request.png)

### <a name="finding-request-cookie-names"></a>Поиск имен файлов Cookie запроса

Если запрос содержит файлы cookie, можно выбрать вкладку "файлы cookie", чтобы просмотреть их в Fiddler. Сведения о файлах cookie можно также использовать для создания исключений или настраиваемых правил в WAF.

## <a name="next-steps"></a>Дальнейшие действия

- Сведения о [Брандмауэр веб-приложения Azure](../overview.md).
- Дополнительные сведения о [создании Front Door](../../frontdoor/quickstart-create-front-door.md).
