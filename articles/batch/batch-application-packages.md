---
title: Развертывание пакетов приложений на вычислительных узлах
description: Пакеты приложений пакетной службы Azure позволяют легко управлять несколькими приложениями и их версиями для установки на вычислительные узлы пакетной службы.
ms.topic: how-to
ms.date: 09/24/2020
ms.custom:
- H1Hack27Feb2017
- devx-track-csharp
- contperfq1
ms.openlocfilehash: 1bacb0c71c05aeb983bfa9ebf71873a22fea39a1
ms.sourcegitcommit: 4b76c284eb3d2b81b103430371a10abb912a83f4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/01/2020
ms.locfileid: "91277705"
---
# <a name="deploy-applications-to-compute-nodes-with-batch-application-packages"></a>Развертывание приложений на вычислительных узлах с помощью пакетов приложений пакетной службы

Пакеты приложений могут упростить код в решении пакетной службы Azure и упростить управление приложениями, выполняемыми задачами. С помощью пакетов приложений можно отправлять и управлять несколькими версиями приложений, выполняемыми задачами, включая вспомогательные файлы. а затем автоматически развернуть одно или несколько таких приложений на вычислительных узлах в пуле.

API-интерфейсы для создания пакетов приложений и управления ими входят в библиотеку [.NET для управления пакетной службой](/dotnet/api/overview/azure/batch/management). API-интерфейсы для установки пакетов приложений в вычислительном узле входят в библиотеку [.NET для пакетной службы](/dotnet/api/overview/azure/batch/client). Схожие функции находятся в доступных API-интерфейсах пакетной службы для других языков.

В этой статье объясняется, как отправлять пакеты приложений и управлять ими в портал Azure. В нем также показано, как установить их на расчетные узлы пула с помощью библиотеки [.NET пакетной](/dotnet/api/overview/azure/batch/client) службы.

## <a name="application-package-requirements"></a>Требования к пакетам приложений

Чтобы использовать пакеты приложений, необходимо [связать учетную запись хранения Azure](#link-a-storage-account) с учетной записью пакетной службы.

Существуют ограничения на количество приложений и пакетов приложений в учетной записи пакетной службы, а также на максимальный размер пакета. Дополнительные сведения см. [в статье квоты и ограничения для пакетной службы Azure](batch-quota-limit.md).

> [!NOTE]
> Пулы пакетной службы, созданные до 5 июля, 2017 не поддерживают пакеты приложений (если они не были созданы после 10 марта 2016 с использованием конфигурации облачных служб). Компонент "Пакеты приложений", описываемый в этой статье, заменяет компонент "Приложения пакетной службы", доступный в предыдущих версиях службы.

## <a name="understand-applications-and-application-packages"></a>Общие сведения о приложениях и пакетах приложений

В пакетной службе Azure *приложение* ссылается на набор двоичных файлов с возможностью управления версиями, которые могут автоматически скачиваться на вычислительные узлы в пуле. Приложение содержит один или несколько *пакетов приложений* , которые представляют различные версии приложения.

Каждый *пакет приложения* — это ZIP-файл, содержащий двоичные файлы приложения и все вспомогательные файлы. Поддерживается только формат ZIP.

:::image type="content" source="media/batch-application-packages/app_pkg_01.png" alt-text="Схема, на которой показано высокоуровневое представление приложений и пакетов приложений.":::

Пакеты приложений можно указать на уровне пула или задачи.

- **Пакеты приложений уровня пула** развертываются на каждом узле в пуле. Развертывание приложений осуществляется во время присоединения узла к пулу, а также когда узел перезагружается или для него пересоздается образ.
  
    Пакеты приложений пула подходят, когда все узлы в пуле будут выполнять задачи задания. При создании пула можно указать один или несколько пакетов приложений для развертывания. Можно также добавить или обновить пакеты существующего пула. Чтобы установить новый пакет в существующий пул, необходимо перезапустить его узлы.

- **Пакеты приложений уровня задач** развертываются только на вычислительных узлах, на которых запланировано выполнение задач. Развертывание осуществляется перед выполнением командной строки задачи. Если в узле уже развернут указанный пакет приложений и настроена версия, повторное развертывание не инициируется и используется имеющийся пакет.
  
    Пакеты приложений задач полезны в средах общего пула, где разные задания выполняются в одном пуле, а пул не удаляется после завершения задания. Если в задании меньше задач по сравнению с узлами в пуле, пакеты приложений задач могут сократить объем данных, так как приложение развертывается только на узлах, где выполняются задачи.
  
    Мы также рекомендуем использовать пакеты приложений уровня задач для выполнения небольшого количества задач в сценариях с большими приложениями. Например, приложения задач могут быть полезны для высокопроизводительного этапа предварительной обработки или задачи слияния.

При использовании пакетов приложений задача запуска пула не должна указывать длинный список отдельных файлов ресурсов для установки на узлах. Кроме того, вам не нужно вручную управлять несколькими версиями этих файлов приложения в службе хранилища Azure или на узлах, И вам не нужно беспокоиться о создании [URL-адресов SAS](../storage/common/storage-sas-overview.md) для предоставления доступа к файлам в вашей учетной записи хранения. Пакетная служба работает со службой хранилища Azure в фоновом режиме, обеспечивая хранение пакетов приложений и их развертывание на вычислительных узлах.

> [!NOTE]
> Общий размер задачи запуска не должен превышать 32 768 символов, включая файлы ресурсов и переменные среды. Если задача запуска превышает это ограничение, использование пакетов приложений является еще одним вариантом. Вы также можете создать ZIP-файл, содержащий файлы ресурсов, передать его в службу хранилища Azure в виде большого двоичного объекта, а затем извлечь из командной строки задачи запуска.

## <a name="upload-and-manage-applications"></a>Передача приложений и управление ими

Управление пакетами приложений в учетной записи пакетной службы осуществляется на [портале Azure](https://portal.azure.com) или с помощью API-интерфейсов для управления пакетной службой. В следующих разделах объясняется, как связать учетную запись хранения, а также как добавлять приложения и пакеты приложений и управлять ими в портал Azure.

### <a name="link-a-storage-account"></a>Связывание учетной записи хранения

Чтобы использовать пакеты приложений, необходимо связать [учетную запись хранения Azure](accounts.md#azure-storage-accounts) с учетной записью пакетной службы. Пакетная служба будет использовать связанную учетную запись хранения для хранения пакетов приложений. Рекомендуется создать учетную запись хранения специально для использования с учетной записью пакетной службы.

Если вы еще не настроили учетную запись хранения, портал Azure выводит предупреждение при первом выборе **приложения** в учетной записи пакетной службы. Чтобы связать учетную запись хранения с учетной записью пакетной службы, выберите **учетная запись хранения** в окне **предупреждения** , а затем снова выберите **учетная запись хранения** .

Когда вы свяжете две учетные записи, пакетная служба сможет автоматически развертывать на вычислительных узлах пакеты, хранимые в связанной учетной записи хранения.

> [!IMPORTANT]
> Вы не можете использовать пакеты приложений с учетными записями хранения Azure, настроенными с помощью [правил брандмауэра](../storage/common/storage-network-security.md), или если для **иерархического пространства имен** задано значение **включено** .

Пакетная служба использует службу хранилища Azure для хранения пакетов приложений в виде блочных BLOB-объектов. С вас [взимается обычная плата](https://azure.microsoft.com/pricing/details/storage/) за данные блочных BLOB-объектов, и размер каждого пакета не может превышать максимальный размер блочного BLOB-объекта. Дополнительные сведения см. в разделе [Целевые показатели масштабируемости и производительности службы хранилища Azure для учетных записей хранения](../storage/blobs/scalability-targets.md). Для снижения затрат следует учитывать размер и количество пакетов приложений, а также периодически удалять устаревшие пакеты.

### <a name="view-current-applications"></a>Просмотр текущих приложений

Чтобы просмотреть приложения в учетной записи пакетной службы, в меню навигации слева выберите **приложения** .

:::image type="content" source="media/batch-application-packages/app_pkg_02.png" alt-text="Схема, на которой показано высокоуровневое представление приложений и пакетов приложений.":::

При выборе этого пункта меню открывается окно **приложения** . В этом окне выводится идентификатор каждого приложения в вашей учетной записи, а также следующие свойства:

- **Пакеты** . Количество версий, связанных с этим приложением.
- **Версия по умолчанию** : если применимо, версия приложения, которая будет установлена, если при развертывании приложения не указана версия.
- **Разрешить обновления** : указывает, разрешено ли обновление и удаление пакетов.

Чтобы просмотреть [структуру файлов](files-and-directories.md) пакета приложения на кластерном узле, перейдите к учетной записи пакетной службы в портал Azure. Выберите **Пулы** . затем выберите пул, содержащий узел вычислений. Выберите узел вычислений, на котором установлен пакет приложения, и откройте папку **приложения** .

### <a name="view-application-details"></a>Просмотр сведений о приложении

Чтобы просмотреть сведения о приложении, выберите его в окне **приложения** . Можно настроить следующие параметры для приложения.

- **Разрешить обновления** : указывает, можно ли [Обновить или удалить](#update-or-delete-an-application-package)пакеты приложений. По умолчанию используется значение **Да** . Если задано значение **нет** , существующие пакеты приложений не могут быть обновлены или удалены, но новые версии пакетов приложений по-прежнему могут быть добавлены.
- **Версия по умолчанию** : пакет приложения по умолчанию, используемый при развертывании приложения, если версия не указана.
- **Отображаемое имя** : понятное имя, которое может использоваться решением пакетной службы при отображении сведений о приложении. Например, это имя можно использовать в пользовательском интерфейсе службы, которую вы предоставляете клиентам через пакетную службу.

### <a name="add-a-new-application"></a>Добавление нового приложения

Чтобы создать новое приложение, добавьте пакет приложения и укажите уникальный идентификатор приложения.

В учетной записи пакетной службы выберите **приложения** и нажмите кнопку **Добавить** .

:::image type="content" source="media/batch-application-packages/app_pkg_05.png" alt-text="Схема, на которой показано высокоуровневое представление приложений и пакетов приложений.":::

Введите следующие сведения:

- **Идентификатор приложения** — идентификатор нового приложения.
- **Версия** : версия пакета приложения, который вы отправляете.
- **Пакет приложения** . это ZIP-файл, содержащий двоичные файлы приложения и вспомогательных файлов, необходимых для выполнения приложения.

**Идентификатор приложения** и его **версия** , которые вы вводите, должны соответствовать следующим требованиям:

- На узлах Windows идентификатор может содержать любое сочетание буквенно-цифровых знаков, дефисов и символов подчеркивания. На узлах Linux допускаются только буквенно-цифровые знаки и символы подчеркивания.
- Не может содержать более 64 символов.
- Должен быть уникальным в рамках учетной записи пакетной службы.
- Идентификаторы являются сохранением регистра и без учета регистра.

Когда будете готовы, нажмите кнопку **Отправить** . После отправки Zip-файла в учетную запись хранения Azure на портале отобразится уведомление. Это может занять некоторое время в зависимости от размера загружаемого файла и скорости сетевого подключения.

### <a name="add-a-new-application-package"></a>Добавление нового пакета приложения

Чтобы добавить версию пакета приложения для существующего приложения, выберите приложение в разделе " **приложения** " учетной записи пакетной службы, а затем нажмите кнопку **Добавить** .

Как и для нового приложения, укажите **версию** нового пакета, отправьте ZIP-файл в поле **пакет приложения** , а затем нажмите кнопку **Отправить** .

### <a name="update-or-delete-an-application-package"></a>Обновление или удаление пакета приложения

Чтобы обновить или удалить существующий пакет приложения, выберите приложение в разделе " **приложения** " учетной записи пакетной службы. Щелкните многоточие в строке пакета приложения, который необходимо изменить, а затем выберите действие, которое требуется выполнить.

:::image type="content" source="media/batch-application-packages/app_pkg_07.png" alt-text="Схема, на которой показано высокоуровневое представление приложений и пакетов приложений.":::

При выборе **обновления** вы сможете отправить новый ZIP-файл. При этом предыдущий ZIP-файл, отправленный для этой версии, будет заменен.

При выборе параметра **Удалить** будет предложено подтвердить удаление этой версии. После нажатия **кнопки ОК** Пакетная служба удалит ZIP-файл из учетной записи хранения Azure. При удалении версии приложения по умолчанию для этого приложения удаляется параметр **версии по умолчанию** .

## <a name="install-applications-on-compute-nodes"></a>Установка приложений на вычислительных узлах

Теперь, когда вы узнали, как управлять пакетами приложений в портал Azure, мы можем обсудить их развертывание на расчетных узлах и их запуск с помощью пакетных задач.

### <a name="install-pool-application-packages"></a>Установка пакетов приложений уровня пула

Чтобы установить пакет приложения на все вычислительные узлы в пуле, укажите ссылки на один или несколько пакетов приложений для пула. Пакеты приложений, указываемые для пула, устанавливаются на каждом кластерном узле, который присоединяется к пулу, а также на любом перезагруженном узле или переобразе.

В пакетной среде .NET укажите один или несколько [CloudPool. ApplicationPackageReferences](/dotnet/api/microsoft.azure.batch.cloudpool.applicationpackagereferences) при создании нового пула или для существующего пула. Класс [ApplicationPackageReference](/dotnet/api/microsoft.azure.batch.applicationpackagereference) определяет идентификатор приложения и версию для установки на вычислительные узлы пула.

```csharp
// Create the unbound CloudPool
CloudPool myCloudPool =
    batchClient.PoolOperations.CreatePool(
        poolId: "myPool",
        targetDedicatedComputeNodes: 1,
        virtualMachineSize: "standard_d1_v2",
        cloudServiceConfiguration: new CloudServiceConfiguration(osFamily: "5"));

// Specify the application and version to install on the compute nodes
myCloudPool.ApplicationPackageReferences = new List<ApplicationPackageReference>
{
    new ApplicationPackageReference {
        ApplicationId = "litware",
        Version = "1.1001.2b" }
};

// Commit the pool so that it's created in the Batch service. As the nodes join
// the pool, the specified application package is installed on each.
await myCloudPool.CommitAsync();
```

> [!IMPORTANT]
> Если развертывание пакета приложения завершается сбоем, пакетная служба помечает узел как [непригодный для использования](/dotnet/api/microsoft.azure.batch.computenode.state)и не планирует выполнение задач на этом узле. В этом случае перезапустите узел, чтобы повторно запустить развертывание пакета. Перезапуск узла также возобновляет планирование задач на узле.

### <a name="install-task-application-packages"></a>Установка пакетов приложений уровня задач

Как и для пакетов уровня пула, укажите ссылки на один или несколько пакетов приложений для задачи. Если на узле запланировано выполнение задачи, скачивание и извлечение пакета осуществляется непосредственно перед выполнением командной строки задачи. Если в пуле уже установлен указанный пакет и настроена версия, скачивание не инициируется и используется имеющийся пакет.

Чтобы установить пакет приложения задачи, настройте свойство [CloudTask. ApplicationPackageReferences](/dotnet/api/microsoft.azure.batch.cloudtask.applicationpackagereferences) задачи:

```csharp
CloudTask task =
    new CloudTask(
        "litwaretask001",
        "cmd /c %AZ_BATCH_APP_PACKAGE_LITWARE%\\litware.exe -args -here");

task.ApplicationPackageReferences = new List<ApplicationPackageReference>
{
    new ApplicationPackageReference
    {
        ApplicationId = "litware",
        Version = "1.1001.2b"
    }
};
```

## <a name="execute-the-installed-applications"></a>Выполнение установленных приложений

Пакеты, указанные для уровня пула или задач, скачиваются и извлекаются в указанный каталог `AZ_BATCH_ROOT_DIR` на узле. Пакетная служба также создает переменную среды, содержащую путь к указанному каталогу. Командные строки задачи будут использовать эту переменную среды, ссылаясь на приложение в узле.

На узлах Windows переменная имеет следующий формат:

```
Windows:
AZ_BATCH_APP_PACKAGE_APPLICATIONID#version
```

На узлах Linux формат немного отличается. Точки (.), дефисы (-) и символы решетки (#) в переменной среды преобразовываются в символы подчеркивания. Кроме того, обратите внимание, что регистр идентификатора приложения сохраняется. Пример:

```
Linux:
AZ_BATCH_APP_PACKAGE_applicationid_version
```

Свойства `APPLICATIONID` и `version` — это значения, соответствующие версии пакета и приложения, указанных при развертывании. Например, если вы выбираете установку приложения *blender* версии 2.7 на узлах Windows, то командные строки задачи будут использовать переменную среды для получения доступа к его файлам:

```
Windows:
AZ_BATCH_APP_PACKAGE_BLENDER#2.7
```

На узлах Linux укажите переменную среды в таком формате. Преобразуйте точки (.), дефисы (-) и знаки номера (#) в нижние подчеркивания и соблюдайте регистр идентификатора приложения:

```
Linux:
AZ_BATCH_APP_PACKAGE_blender_2_7
```

При передаче пакета приложения можно указать версию по умолчанию для развертывания на вычислительных узлах. Если для приложения указана версия по умолчанию, то на это приложение можно ссылаться без суффикса версии. Версию приложения по умолчанию можно указать на портале Azure в окне **Приложения** , как показано в разделе [Передача приложений и управление ими](#upload-and-manage-applications).

Например, если для приложения *blender* в качестве версии по умолчанию указана версия 2.7 и задачи ссылаются на следующую переменную среды, то узлы Windows будут выполнять версию 2.7:

`AZ_BATCH_APP_PACKAGE_BLENDER`

В следующем фрагменте кода показан образец командной строки задачи, используемый для запуска версии приложения *blender* по умолчанию.

```csharp
string taskId = "blendertask01";
string commandLine =
    @"cmd /c %AZ_BATCH_APP_PACKAGE_BLENDER%\blender.exe -args -here";
CloudTask blenderTask = new CloudTask(taskId, commandLine);
```

> [!TIP]
> Дополнительные сведения о параметрах среды вычислительных узлов см. в разделе [Параметры среды для задач](jobs-and-tasks.md#environment-settings-for-tasks).

## <a name="update-a-pools-application-packages"></a>Обновление пакетов приложений пула

Если для существующего пула уже выполнена настройка пакета приложения, вы можете указать новый пакет для пула. Это означает следующее:

- Пакетная служба устанавливает новый указанный пакет на все новые узлы, присоединенные к пулу, и на все имеющиеся узлы, которые были перезагружены или для которых был повторно создан образ.
- Новый пакет приложения не будет автоматически установлен на вычислительные узлы, которые во время обновления ссылки на пакет уже существовали в пуле. Для получения нового пакета их необходимо перезагрузить либо заново создать для них образ.
- Переменные среды, создаваемые при развертывании нового пакета, отражают новые ссылки на пакеты приложения.

В этом примере существующий пул имеет версию 2,7 приложения для *наложения* , настроенную как один из его [CloudPool. ApplicationPackageReferences](/dotnet/api/microsoft.azure.batch.cloudpool.applicationpackagereferences). Чтобы обновить узлы в пуле, используя версию 2.76b, укажите новое свойство [ApplicationPackageReference](/dotnet/api/microsoft.azure.batch.applicationpackagereference) с новой версией, а затем подтвердите изменения.

```csharp
string newVersion = "2.76b";
CloudPool boundPool = await batchClient.PoolOperations.GetPoolAsync("myPool");
boundPool.ApplicationPackageReferences = new List<ApplicationPackageReference>
{
    new ApplicationPackageReference {
        ApplicationId = "blender",
        Version = newVersion }
};
await boundPool.CommitAsync();
```

После настройки новой версии пакетная служба устанавливает версию 2.76b на всех новых узлах, присоединенных к пулу. Чтобы установить версию 2.76b на все узлы, уже имеющиеся в пуле, перезагрузите их или создайте для них новый образ. Обратите внимание, что перезагруженные узлы сомещают файлы из предыдущих развертываний пакетов.

## <a name="list-the-applications-in-a-batch-account"></a>Список приложений в учетной записи пакетной службы

Вы можете перечислить приложения и их пакеты в учетной записи пакетной службы с помощью метода [метода applicationoperations. ListApplicationSummaries](/dotnet/api/microsoft.azure.batch.applicationoperations.listapplicationsummaries) .

```csharp
// List the applications and their application packages in the Batch account.
List<ApplicationSummary> applications = await batchClient.ApplicationOperations.ListApplicationSummaries().ToListAsync();
foreach (ApplicationSummary app in applications)
{
    Console.WriteLine("ID: {0} | Display Name: {1}", app.Id, app.DisplayName);

    foreach (string version in app.Versions)
    {
        Console.WriteLine("  {0}", version);
    }
}
```

## <a name="next-steps"></a>Дальнейшие действия

- [REST API пакетной службы](/rest/api/batchservice) также поддерживает работу с пакетами приложения. Например, см. элемент [applicationPackageReferences](/rest/api/batchservice/pool/add#applicationpackagereference) для указания устанавливаемых пакетов и [приложений](/rest/api/batchservice/application) для получения сведений о приложении.
- Узнайте больше о программном [управлении квотами и учетными записями пакетной службы Azure с помощью библиотеки .NET для управления пакетной службой](batch-management-dotnet.md). С помощью [библиотеки .NET для управления пакетной службой](/dotnet/api/overview/azure/batch/management) можно включить функции создания и удаления учетной записи для пакетной службы или приложения.
