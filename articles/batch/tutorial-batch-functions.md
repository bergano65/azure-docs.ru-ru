---
title: Активация пакетного задания с использованием Функций Azure
description: Учебник. Применение распознавания текста к отсканированным документам при добавлении их в хранилище BLOB-объектов
services: batch
author: laurenhughes
manager: jeconnoc
ms.assetid: ''
ms.service: batch
ms.devlang: dotnet
ms.topic: tutorial
ms.date: 05/30/2019
ms.author: peshultz
ms.custom: mvc
ms.openlocfilehash: d5a5197227ff62ca0c610e2c4e269480690d3faf
ms.sourcegitcommit: a12b2c2599134e32a910921861d4805e21320159
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/24/2019
ms.locfileid: "67343085"
---
# <a name="tutorial-trigger-a-batch-job-using-azure-functions"></a>Руководство по активации пакетного задания с использованием Функций Azure

В этом учебнике вы узнаете, как запускать пакетное задание с помощью Функций Azure. Мы рассмотрим пример, в котором к документам, добавленным в контейнер хранилища BLOB-объектов Azure, применяется оптическое распознавание символов (OCR) с помощью пакетной службы Azure. Чтобы упростить обработку распознавания, мы настроим функцию Azure, которая запускает пакетное задание распознавания текста при каждом добавлении файла в контейнер больших двоичных объектов.

## <a name="prerequisites"></a>Предварительные требования

* Подписка Azure. Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free/), прежде чем начать работу.
* учетная запись пакетной службы Azure и связанная учетная запись службы хранилища Azure. Дополнительные сведения о том, как создать и связать учетные записи, см. в разделе [Создание учетной записи Пакетной службы](quick-create-portal.md#create-a-batch-account).
* [Batch Explorer](https://azure.github.io/BatchExplorer/)
* [Azure Storage Explorer;](https://azure.microsoft.com/features/storage-explorer/)

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на [портале Azure](https://portal.azure.com).

## <a name="create-a-batch-pool-and-batch-job-using-batch-explorer"></a>Создание пула пакетной службы и пакетного задания с помощью Batch Explorer

В этом разделе описано, как использовать Batch Explorer для создания пула пакетной службы и пакетного задания, которое будет запускать задачи распознавания текста. 

### <a name="create-a-pool"></a>Создание пула

1. Войдите в Batch Explorer, используя свои учетные данные Azure.
1. Создайте пул, выбрав **Пулы** на левой боковой панели, а затем нажав кнопку **Добавить** над формой поиска. 
    1. Выберите идентификатор и отображаемое имя. В этом примере мы используем имя `ocr-pool`.
    1. Установите тип масштаба **Фиксированный размер** и задайте количество выделенных узлов равным 3.
    1. Выберите **Ubuntu 18.04-LTS** в качестве операционной системы.
    1. Выберите размер виртуальной машины `Standard_f2s_v2`.
    1. Включите задачу запуска и добавьте команду `/bin/bash -c "sudo update-locale LC_ALL=C.UTF-8 LANG=C.UTF-8; sudo apt-get update; sudo apt-get -y install ocrmypdf"`. Обязательно установите для пользователя удостоверение как **пользователь задач по умолчанию (администратор)** , что позволит запускать задачи, включая команды с `sudo`.
    1. Нажмите кнопку **ОК**.
### <a name="create-a-job"></a>создать задание;

1. Создайте задание в пуле, выбрав **Задания** на левой боковой панели, а затем нажав кнопку **Добавить** над формой поиска. 
    1. Выберите идентификатор и отображаемое имя. В этом примере мы используем имя `ocr-job`.
    1. Задайте для пула имя `ocr-pool` или любое другое выбранное имя.
    1. Нажмите кнопку **ОК**.


## <a name="create-blob-containers"></a>Создание контейнеров больших двоичных объектов

Здесь вы создадите контейнеры больших двоичных объектов, в которых будут храниться ваши входные и выходные файлы для пакетного задания распознавания текста.

1. Войдите в Обозреватель службы хранилища с помощью своих учетных данных Azure.
1. Используя учетную запись хранения, связанную с вашей учетной записью Пакетной службы, создайте два контейнера больших двоичных объектов (один для входных файлов, а другой для выходных), выполнив шаги, описанные в разделе о [создании контейнера больших двоичных объектов](https://docs.microsoft.com/azure/vs-azure-tools-storage-explorer-blobs#create-a-blob-container).

В этом примере входной контейнер называется `input`. Сюда изначально загружаются для обработки все документы без распознавания текста. Выходной контейнер называется `output`. Именно туда пакетное задание записывает документы, обработанные с помощью распознавания текста.  
    * В этом примере мы будем вызывать наш входной (`input`) и выходной (`output`) контейнеры.  
    * Входной контейнер — это расположение, куда изначально загружаются все документы без распознавания текста.  
    * Выходной контейнер — это расположение, куда пакетное задание записывает документы, обработанные с помощью распознавания текста.  

Создайте подписанный URL-адрес для вашего выходного контейнера в Обозревателе службы хранилища. Для этого щелкните выходной контейнер правой кнопкой мыши и выберите **Get Shared Access Signature...** (Получение подписанного URL-адреса...). В разделе **Разрешения** установите флажок **Запись**. Никаких других разрешений не требуется.  

## <a name="create-an-azure-function"></a>Создание функции Azure

В этом разделе вы создадите функцию Azure, которая запускает пакетное задание распознавания текста при каждой передаче файла в ваш входной контейнер.

1. Для создания функции выполните действия, описанные в статье [Создание функции, активируемой хранилищем BLOB-объектов Azure](https://docs.microsoft.com/azure/azure-functions/functions-create-storage-blob-triggered-function).
    1. Когда будет предложено указать учетную запись хранения, используйте ту же учетную запись хранения, которую вы связали с учетной записью пакетной службы.
    1. Для **стека среды выполнения** выберите .NET. Мы напишем нашу функцию на C#, чтобы использовать пакет SDK пакетной службы для .NET.
1. После создания функции, запускаемой большими двоичными объектами, используйте файлы [`run.csx`](https://github.com/Azure-Samples/batch-functions-tutorial/blob/master/run.csx) и [`function.proj`](https://github.com/Azure-Samples/batch-functions-tutorial/blob/master/function.proj), размещенные на сайте GitHub для функции.
    * `run.csx` запускается, когда новый большой двоичный объект добавляется в ваш входной контейнер больших двоичных объектов.
    * `function.proj` перечисляет внешние библиотеки в коде вашей функции, например, пакет SDK пакетной службы для .NET.
1. Измените значения заполнителей переменных в функции `Run()` файла `run.csx`, чтобы они соответствовали вашим учетным данным для пакетной службы и хранилища. Учетные данные учетных записей пакетной службы и службы хранилища можно найти на портале Azure в разделе **Ключи** вашей учетной записи пакетной службы.
    * Извлеките учетные данные учетных записей пакетной службы и службы хранилища на портале Azure в разделе **Ключи** вашей учетной записи пакетной службы. 

## <a name="trigger-the-function-and-retrieve-results"></a>Активация функции и получение результатов

Передайте любой или все отсканированные файлы из каталога [`input_files`](https://github.com/Azure-Samples/batch-functions-tutorial/tree/master/input_files) на сайте GitHub в свой входной контейнер. В Batch Explorer отслеживайте, что задача добавляется в пул `ocr-pool` для каждого файла. Через несколько секунд файл с примененным распознаванием текста добавляется в выходной контейнер. После этого файл будет отображаться в Обозревателе службы хранилища, и его можно будет извлечь оттуда.

Кроме того, вы можете просмотреть файл журналов в нижней части окна веб-редактора Функций Azure, где вы увидите сообщения, подобные приведенным ниже, для каждого файла, переданного во входной контейнер:

```
2019-05-29T19:45:25.846 [Information] Creating job...
2019-05-29T19:45:25.847 [Information] Accessing input container <inputContainer>...
2019-05-29T19:45:25.847 [Information] Adding <fileName> as a resource file...
2019-06-21T20:02:35.129 [Information] Name of output text file: <outputTxtFile>
2019-06-21T20:02:35.130 [Information] Name of output PDF file: <outputPdfFile>
2019-05-29T19:45:26.200 [Information] Adding OCR task <taskID> for <fileName> <size of fileName>...
```

Чтобы скачать выходные файлы из Обозревателя службы хранилища на локальный компьютер, сначала выберите нужные файлы, а затем щелкните **Скачать** на верхней ленте. 

> [!TIP]
> Скачанные файлы доступны для поиска в программе для чтения PDF-файлов.

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как выполнять такие задачи: 

> [!div class="checklist"]
> * Использование Batch Explorer для создания пулов и заданий.
> * Использование Batch Explorer для создания контейнеров больших двоичных объектов и подписанного URL-адреса (SAS).
> * Создание функции Azure, активируемой большим двоичным объектом.
> * Передача входных файлов в хранилище.
> * Мониторинг выполнения задач.
> * Извлечение выходных файлов

* Дополнительные примеры использования программного интерфейса .NET для планирования и обработки рабочих нагрузок пакетной службы см. в [примерах на сайте GitHub](https://github.com/Azure-Samples/azure-batch-samples/tree/master/CSharp). 

* Чтобы просмотреть другие триггеры Функций Azure, которые можно использовать для запуска рабочих нагрузок пакетной службы, ознакомьтесь с [документацией по Функциям Azure](https://docs.microsoft.com/azure/azure-functions/functions-triggers-bindings).
