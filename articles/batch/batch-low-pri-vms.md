---
title: Выполняйте большие объемы работы на высокоэффективных низкоприоритетных виртуальных машинах
description: Узнайте, как подготовить низкоприоритетные виртуальные машины для сокращения затрат на рабочие нагрузки пакетной службы Azure.
author: mscurrell
ms.topic: how-to
ms.date: 02/02/2021
ms.custom: seodec18
ms.openlocfilehash: 9214ef83ec9b8bef4fb7bc7489aa0ab388f67c0d
ms.sourcegitcommit: b85ce02785edc13d7fb8eba29ea8027e614c52a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "99507284"
---
# <a name="use-low-priority-vms-with-batch"></a>Использование низкоприоритетных виртуальных машин в пакетной службе

Пакетная служба Azure предлагает низкоприоритетные виртуальные машины для сокращения затрат на рабочие нагрузки пакетной службы. Виртуальные машины с низким приоритетом позволяют использовать новые типы рабочих нагрузок пакетной службы, предоставляя большой объем вычислительных ресурсов по очень низкой цене.

Низкоприоритетные виртуальные машины используют избыточные ресурсы в Azure. При указании низкоприоритетных виртуальных машин в пулах пакетная служба Azure может использовать этот избыток при его наличии.

Компромисс использования виртуальных машин с низким приоритетом заключается в том, что эти виртуальные машины могут быть не всегда доступны для выделения или могут быть вытеснены в любое время в зависимости от доступной емкости. По этой причине виртуальные машины с низким приоритетом наиболее подходят для рабочих нагрузок пакетной и асинхронной обработки, где время завершения задания является гибким, а работа распределяется по нескольким виртуальным машинам.

Низкоприоритетные виртуальные машины предлагаются по более низкой цене по сравнению с выделенными виртуальными машинами. Сведения о ценах на пакетную службу см. [здесь](https://azure.microsoft.com/pricing/details/batch/).

> [!NOTE]
> [Точечные виртуальные машины](https://azure.microsoft.com/pricing/spot/) теперь доступны как для [виртуальных машин в одном экземпляре](../virtual-machines/spot-vms.md), так и для [масштабируемых наборов](../virtual-machine-scale-sets/use-spot.md). Точечные виртуальные машины являются эволюцией виртуальных машин с низким приоритетом, но они отличаются по ценам. При выделении точечной виртуальной машины также может быть задана необязательная максимальная цена.
>
> Поддержка точечных виртуальных машин в пулах пакетной службы Microsoft Azure будет введена в течение нескольких месяцев после их входа в общий доступ. Новые версии [API пакетной службы и инструментария](./batch-apis-tools.md) также будут доступны. После введения поддержки точечных виртуальных машин низкоприоритетные виртуальные машины будут считаться устаревшими. Их поддержка через интерфейсы API и инструментарий будет продолжаться в течение года, чтобы предоставить достаточно времени для перехода на новые виртуальные машины.
>
> Точечные виртуальные машины не будут поддерживаться в [пулах конфигурации облачной службы](/rest/api/batchservice/pool/add#cloudserviceconfiguration). Для использования точечных виртуальных машин пулы облачных служб потребуется перенести в пулы [конфигурации виртуальных машин](/rest/api/batchservice/pool/add#virtualmachineconfiguration).

## <a name="batch-support-for-low-priority-vms"></a>Поддержка пакетной службы для виртуальных машин с низким приоритетом

Пакетная служба Azure предоставляет несколько возможностей, которые упрощают использование виртуальных машин с низким приоритетом и позволяют воспользоваться их преимуществами:

- Пулы пакетной службы могут содержать выделенные и низкоприоритетные виртуальные машины. Число виртуальных машин любого типа можно указать при создании пула или изменить в любое время для имеющегося пула, используя операцию явного изменения размера или автоматическое масштабирование. Отправка заданий и задач не изменяется независимо от типа виртуальной машины в пуле. Вы можете настроить пул так, чтобы он в основном использовал виртуальные машины с низким приоритетом для выполнения заданий как можно дешевле и развертывал выделенные виртуальные машины, если значение емкости падает ниже заданного порогового значения, чтобы выполнение заданий продолжалось.
- Пулы пакетной службы автоматически ищут целевое количество виртуальных машин с низким приоритетом. Если виртуальные машины прерываются или недоступны, пакетная службы пытается заменить потерянную емкость и вернуться к целевой.
- После прерывания задач пакетная служба обнаруживает и автоматически помещает в очередь задания для повторного запуска.
- Низкоприоритетные виртуальные машины имеют отдельную квоту на виртуальные ЦП, которая отличается от квоты выделенных виртуальных машин. Квота для низкоприоритетных виртуальных машин выше, чем для выделенных виртуальных машин, так как они меньше стоят. Дополнительные сведения см. в разделе о [квотах и ограничениях пакетной службы](batch-quota-limit.md#resource-quotas).

> [!NOTE]
> Сейчас виртуальные машины с низким приоритетом не поддерживаются для учетных записей пакетной службы, созданных в [режиме подписки пользователя](accounts.md).

## <a name="considerations-and-use-cases"></a>Рекомендации и варианты использования

Многие рабочие нагрузки пакетной службы подходят для виртуальных машин с низким приоритетом. Их рекомендуется использовать, когда задания разбиваются на множество параллельных задач, или если имеется много заданий, масштабируемых и распределенных по нескольким виртуальным машинам.

Ниже перечислены некоторые примеры случаев использования пакетной обработки, подходящих для виртуальных машин с низким приоритетом.

- **Разработка и тестирование**: при разработке крупномасштабных решений (в частности) можно существенно сэкономить средства. Преимущества доступны для всех видов тестирования, но лучше всего подходит крупномасштабное нагрузочное тестирование и тестирование регрессии.
- **Дополнительная емкость по запросу**. виртуальные машины с низким приоритетом можно использовать для дополнения обычных выделенных виртуальных машин. При наличии задания могут масштабироваться и, следовательно, выполнять их быстрее для снижения затрат; Если этот параметр недоступен, базовые показатели выделенных виртуальных машин остаются доступными.
- **Гибкое время выполнения задания**: если время выполнения задания можно скорректировать, допускается возможное сокращение емкости. Тем не менее при добавлении виртуальных машин с низким приоритетом задания выполняются быстрее за более низкую цену.

Пулы пакетной службы можно настроить для использования виртуальных машин с низким приоритетом несколькими способами.

- Пул может использовать только виртуальные машины с низким приоритетом. При этом пакетная служба будет просто восстанавливать замещенные ресурсы, когда они станут доступными. Эта конфигурация является самым дешевым способом выполнения заданий.
- Низкоприоритетные виртуальные машины можно использовать в сочетании с фиксированными базовыми выделенными виртуальными машинами. Фиксированное число выделенных виртуальных машин обеспечивает наличие ресурсов для выполнения задания.
- Пул может использовать динамический набор выделенных и младших виртуальных машин, чтобы более низкие виртуальные машины с низким приоритетом использовались только при наличии, но при необходимости масштабируется выделенные виртуальные машины с полной ценой. чтобы обеспечить минимальную емкость для выполнения заданий.

При планировании использования виртуальных машин с низким приоритетом учитывайте следующее.

- Чтобы использовать избыточные ресурсы в Azure по максимуму, вы можете горизонтально увеличить масштаб подходящих заданий.
- Иногда виртуальные машины недоступны или замещаются, что приводит к сокращению емкости для заданий и может привести к прерыванию и повторному запуску задач.
- Задачи с более коротким временем выполнения обычно лучше всего работают с виртуальными машинами с низким приоритетом. Прерывание заданий с более продолжительными задачами может привести к более серьезным последствиям. Если длительные задачи реализуют контрольные точки для сохранения хода выполнения по мере их выполнения, это воздействие может снизиться. 
- Длительные задания MPI, использующие несколько виртуальных машин, невыгодно выполнять на низкоприоритетных виртуальных машинах, так как замещение одной виртуальной машины, скорее всего приведет к перезапуску программы.
- Узлы с низким приоритетом могут быть помечены как непригодные для использования, если [правила группы безопасности сети (NSG)](batch-virtual-network.md#network-security-groups-specifying-subnet-level-rules) настроены неправильно.

## <a name="create-and-manage-pools-with-low-priority-vms"></a>Создание пулов и управление ими с помощью виртуальных машин с низким приоритетом

Пул пакетной службы может содержать выделенные и низкоприоритетные виртуальные машины (вычислительные узлы). Вы можете задать целевое количество вычислительных узлов и для тех, и для других виртуальных машин. Оно указывает на количество виртуальных машин, которые должны находиться в пуле.

Например, чтобы создать пул с помощью виртуальных машин Azure (в этом случае виртуальные машины Linux) с целью 5 выделенных виртуальных машин и 20 виртуальными машинами с низким приоритетом:

```csharp
ImageReference imageRef = new ImageReference(
    publisher: "Canonical",
    offer: "UbuntuServer",
    sku: "16.04-LTS",
    version: "latest");

// Create the pool
VirtualMachineConfiguration virtualMachineConfiguration =
    new VirtualMachineConfiguration("batch.node.ubuntu 16.04", imageRef);

pool = batchClient.PoolOperations.CreatePool(
    poolId: "vmpool",
    targetDedicatedComputeNodes: 5,
    targetLowPriorityComputeNodes: 20,
    virtualMachineSize: "Standard_D2_v2",
    virtualMachineConfiguration: virtualMachineConfiguration);
```

Вы можете получить текущее количество узлов для выделенных и низкоприоритетных виртуальных машин:

```csharp
int? numDedicated = pool1.CurrentDedicatedComputeNodes;
int? numLowPri = pool1.CurrentLowPriorityComputeNodes;
```

В узлах пула есть свойство, указывающее на принадлежность узла (выделенная или низкоприоритетная виртуальная машина):

```csharp
bool? isNodeDedicated = poolNode.IsDedicated;
```

Иногда виртуальные машины могут быть вытеснены. В этом случае задачи, запущенные на виртуальных машинах с вытесненным узлом, снова помещаются в очередь и выполняются снова.

Для пулов конфигурации виртуальных машин Пакетная службы также выполняет следующие действия:

- Для замещенных виртуальных машин устанавливается состояние **Замещено**. 
- Виртуальная машина удаляется, что приводит к потере всех ее локальных данных в хранилище.
- Операция со списком узлов в пуле будет по-прежнему возвращать вытесненные узлы.
- Пул постоянно будет пытаться подключиться к целевым доступным низкоприоритетным узлам. При обнаружении замены идентификаторы узлов сохраняются, но узлы повторно инициализируются и их состояние меняется на **Создание** и **Запуск** перед тем, как они станут доступными для планирования задач.
- Счетчики замещения доступны в качестве метрики на портале Azure.

## <a name="scale-pools-containing-low-priority-vms"></a>Масштабируемые пулы, содержащие виртуальные машины с низким приоритетом

Как и пулы, состоящие исключительно из выделенных виртуальных машин, можно масштабировать пулы низкоприоритетных виртуальных машин, вызвав метод "Изменить размер" или использовав автомасштабирование.

Операция изменения размера пула принимает второй необязательный параметр, обновляющий значение **targetLowPriorityNodes**:

```csharp
pool.Resize(targetDedicatedComputeNodes: 0, targetLowPriorityComputeNodes: 25);
```

Формула автомасштабирования пула реализует поддержку низкоприоритетных виртуальных машин следующим образом:

- Вы можете получить или задать значение переменной, определяемой службой ( **$TargetLowPriorityNodes**).
- Вы можете получить значение переменной, определяемой службой ( **$CurrentLowPriorityNodes**).
- Вы можете получить значение переменной, определяемой службой ( **$PreemptedNodeCount**). Эта переменная возвращает количество узлов в состоянии "Отложено" и позволяет масштабировать число выделенных узлов в зависимости от числа недоступных замещенных узлов.

## <a name="configure-jobs-and-tasks"></a>Настройка заданий и задач

Заданиям и задачам требуется небольшая дополнительная настройка узлов с низким приоритетом. Необходимо учитывать следующее:

- Свойство JobManagerTask задания имеет свойство **алловловприоритиноде** . Если это свойство имеет значение true, задачу диспетчера заданий можно запланировать на выделенном или низкоприоритетном узле. Если это значение равно false, задача диспетчера заданий запланирована только на выделенный узел.
- [Переменная среды](batch-compute-node-environment-variables.md) AZ_BATCH_NODE_IS_DEDICATED доступна для приложения задачи, чтобы она могла определить, работает ли она с низким приоритетом или на выделенном узле.

## <a name="view-metrics-for-low-priority-vms"></a>Просмотр метрик для виртуальных машин с низким приоритетом

На [портале Azure](https://portal.azure.com) доступны новые метрики для узлов с низким приоритетом. Это такие метрики:

- Low-Priority Node Count
- Low-Priority Core Count;
- Preempted Node Count

Чтобы просмотреть эти метрики в портал Azure

1. Войдите в свою учетную запись пакетной службы на портале Azure.
2. В разделе **Мониторинг** щелкните **Метрики**.
3. Выберите нужные метрики из списка **метрик** .

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте подробнее о [рабочем процессе и основных ресурсах пакетной службы](batch-service-workflow-features.md), таких как пулы, узлы, задания и задачи.
- См. дополнительные сведения об [API-интерфейсах и средствах пакетной службы](batch-apis-tools.md) для сборки решений пакетной службы.
- Начните планировать переход с низкоприоритетных виртуальных машин на точечные виртуальные машины. Если вы используете виртуальные машины с низким приоритетом с пулами **конфигурации облачной службы** , запланируйте миграцию в [Пулы **конфигурации виртуальных машин**](nodes-and-pools.md#configurations) .
