---
title: Проверка на наличие ошибок в пуле и узле с помощью пакетной службы Azure
description: Проверяемые ошибки и способы их избежания при создании пулов и узлов.
services: batch
ms.service: batch
author: mscurrell
ms.author: markscu
ms.date: 08/23/2019
ms.topic: conceptual
ms.openlocfilehash: 3c8e189e84e0a467125995b3e2d633c285eb7367
ms.sourcegitcommit: 7f6d986a60eff2c170172bd8bcb834302bb41f71
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71350064"
---
# <a name="check-for-pool-and-node-errors"></a>Проверка на наличие ошибок в пуле и узле

При создании и управлении пулами пакетной службы Azure некоторые операции выполняются немедленно. Однако некоторые операции выполняются асинхронно и выполняются в фоновом режиме, что занимает несколько минут.

Процесс обнаружения ошибок для операций, которые выполняются немедленно, довольно прост, так как все ошибки сразу возвращаются через API, интерфейс командной строки или пользовательский интерфейс.

В этой статье рассматриваются фоновые операции, которые могут выполняться для пулов и узлов пулов. Здесь указано, каким образом можно их обнаружить и избежать сбоев.

## <a name="pool-errors"></a>Ошибки пула

### <a name="resize-timeout-or-failure"></a>Время ожидания изменения размера или сбой

При создании пула или изменении размера имеющегося пула вы указываете целевое количество узлов.  Операция создания или изменения размера завершается немедленно, но фактическое выделение новых узлов или удаление существующих узлов может занять несколько минут.  Время ожидания изменения размера указывается в API [создания](https://docs.microsoft.com/rest/api/batchservice/pool/add) или [изменения размера](https://docs.microsoft.com/rest/api/batchservice/pool/resize). Если пакет не может получить целевое количество узлов в течение периода ожидания изменения размера, пул переходит в устойчивое состояние и сообщает об ошибках изменения размера.

Свойство [ресизиррор](https://docs.microsoft.com/rest/api/batchservice/pool/get#resizeerror) для последней оценки содержит список произошедших ошибок.

Ниже приведены распространенные причины ошибок изменения размера.

- Слишком короткое время ожидания изменения размера.
  - В большинстве случаев время ожидания по умолчанию в 15 минут достаточно для выделения или удаления узлов пула.
  - Если вы выделяете большое количество узлов, рекомендуется установить время ожидания изменения размера на 30 минут. Например, при изменении размера более 1000 узлов из образа Azure Marketplace или более 300 узлов из пользовательского образа виртуальной машины.
- Недостаточная квота ядер.
  - Учетная запись пакетной службы ограничена количеством ядер, которые можно выделить во всех пулах. После достижения данной квоты пакетная служба прекращает выделять узлы. Вы [можете увеличить](https://docs.microsoft.com/azure/batch/batch-quota-limit) квоту ядер, чтобы пакет мог выделить больше узлов.
- Недостаточно IP-адресов подсети, когда [пул находится в виртуальной сети](https://docs.microsoft.com/azure/batch/batch-virtual-network).
  - В подсети виртуальной сети должно быть достаточно неназначенных IP-адресов для выделения каждому запрошенному узлу пула. В противном случае узлы не могут быть созданы.
- Недостаточно ресурсов, когда [пул находится в виртуальной сети](https://docs.microsoft.com/azure/batch/batch-virtual-network).
  - Вы можете создавать ресурсы, такие как балансировщики нагрузки, общедоступные IP-адреса и группы безопасности сети, в той же подписке, что и учетная запись пакетной службы. Убедитесь, что квоты подписки достаточны для этих ресурсов.
- Большие пулы с пользовательскими образами виртуальных машин
  - Для выделения больших пулов, использующих пользовательские образы виртуальных машин, может потребоваться больше времени, из-за чего время ожидания может истечь.  Рекомендации по ограничениям и конфигурации см. в статье [Создание пула с помощью общей коллекции образов](batch-sig-images.md) .

### <a name="automatic-scaling-failures"></a>Сбои автоматического масштабирования

Вы также можете настроить пакетную службу Azure для автоматического масштабирования количества узлов в пуле. Вы определяете параметры для [формулы автоматического масштабирования для пула](https://docs.microsoft.com/azure/batch/batch-automatic-scaling). Пакетная служба использует формулу для периодической оценки количества узлов в пуле и установки нового целевого количества. Возможны следующие проблемы.

- Сбой оценки автоматического масштабирования.
- Итоговая операция изменения размера завершается ошибкой и истечением времени ожидания.
- Проблема с формулой автоматического масштабирования приводит к неверным целевым значениям узла. Изменение размера работает, или истекает время ожидания.

Сведения о последней оценке автоматического масштабирования можно получить с помощью свойства [autoScaleRun](https://docs.microsoft.com/rest/api/batchservice/pool/get#autoscalerun). Это свойство сообщает время оценки, значения и результат, а также все ошибки производительности.

Сведения обо всех оценках автоматически фиксируются в [событии завершения изменения размера пула](https://docs.microsoft.com/azure/batch/batch-pool-resize-complete-event).

### <a name="delete"></a>Оператор delete

При удалении пула, содержащего узлы, первый пакет удаляет узлы. Затем он удаляет сам объект пула. Удаление узлов пула может занять несколько минут.

В процессе удаления в качестве [состояния пула](https://docs.microsoft.com/rest/api/batchservice/pool/get#poolstate) пакетная служба указывает значение **deleting** (Удаление). Вызывающее приложение может обнаружить слишком долгое время удаления пула на основе свойств **state** и **stateTransitionTime**.

## <a name="pool-compute-node-errors"></a>Ошибки вычислительных узлов в пуле

Даже если пакетная службы успешно выделяет узлы в пуле, различные проблемы могут привести к неработоспособности некоторых узлов, а также к невозможности выполнения задач. На эти узлы по-прежнему взимается плата, поэтому важно обнаружить проблемы, чтобы избежать оплаты за узлы, которые нельзя использовать. В дополнение к распространенным ошибкам узлов, знание текущего [состояния задания](https://docs.microsoft.com/rest/api/batchservice/job/get#jobstate) полезно для устранения неполадок.

### <a name="start-task-failures"></a>Сбои при запуске задач

Возможно, вы захотите указать необязательную [задачу запуска](https://docs.microsoft.com/rest/api/batchservice/pool/add#starttask) для пула. Как и в любой задаче, вы можете использовать командную строку и файлы ресурсов для загрузки из хранилища. Задача запуска выполняется для каждого узла после его запуска. Свойство **waitForSuccess** указывает, будет ли пакетная служба ждать успешного завершения задачи запуска, прежде чем планировать какие-либо задачи для узла.

Что делать, если вы настроили узел на ожидание успешного завершения задачи запуска, но задача запуска завершилась сбоем? В этом случае узел не будет использоваться, но по-прежнему будет взиматься плата.

Сбои выполнения задачи запуска можно обнаружить с помощью свойств [result](https://docs.microsoft.com/rest/api/batchservice/computenode/get#taskexecutionresult) и [failureInfo](https://docs.microsoft.com/rest/api/batchservice/computenode/get#taskfailureinformation) свойства узла верхнего уровня [startTaskInfo](https://docs.microsoft.com/rest/api/batchservice/computenode/get#starttaskinformation).

Задача "сбой запуска" также заставляет пакетной службы установить [состояние](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodestate) узла **старттаскфаилед** , если для **ваитфорсукцесс** задано **значение true**.

Как и в любой задаче, может быть множество причин сбоя задачи запуска.  Для устранения неполадок следует проверить файлы журнала stdout, stderr и другие файлы журнала для конкретных задач.

Задачи запуска должны быть повторно разрешены, так как задача запуска может выполняться несколько раз на одном узле. Задача запуска выполняется при повторном создании образа или перезагрузке узла. В редких случаях задача запуска будет выполняться после того, как событие привело к перезагрузке узла, когда одна из операционных систем или временных дисков была переобразна, а другая — нет. Так как задачи запуска пакета (например, все задачи пакетной службы) запускаются с временного диска, это обычно не является проблемой, но в некоторых случаях, когда задача запуска устанавливает приложение на диск операционной системы и сохраняет другие данные на временном диске, это может привести к проблемы из-за несинхронизированного действия. Если вы используете оба диска, защитите приложение соответствующим образом.

### <a name="application-package-download-failure"></a>Не удалось скачать пакет приложения

Вы можете указать один или несколько пакетов приложений для пула. Пакетная программа загружает указанные файлы пакетов на каждый узел и распаковывает файлы после запуска узла, но до планирования задач. Обычно используется командная строка запуска задачи совместно с пакетами приложений. Например, чтобы скопировать файлы в другое место или запустить программу установки.

Свойство [ошибки](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodeerror) узла сообщает об ошибке при скачивании и отмене сжатия пакета приложения. состояние узла установлено в **непригодное для использования**.

### <a name="container-download-failure"></a>Сбой скачивания контейнера

В пуле можно указать одну или несколько ссылок на контейнеры. Пакетная обработка загружает указанные контейнеры на каждый узел. Свойство " [ошибки](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodeerror) узла" сообщает о сбое загрузки контейнера и задает для узла состояние " **непригодный для использования**".

### <a name="node-in-unusable-state"></a>Узел с состоянием unusable (Непригоден)

Пакетная служба Azure может установить [состояние узла](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodestate) на **unusable** (Непригоден) по многим причинам. Если состояние узла установлено на **unusable** (Непригоден), задачи для узла не могут быть запланированы, но плата по-прежнему взимается.

Узлы в **непригодном для использования** состоянии, но без [ошибок](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodeerror) означает, что пакет не может связаться с виртуальной машиной. В этом случае пакетная программа всегда пытается восстановить виртуальную машину. Пакетная функция не будет автоматически пытаться восстановить виртуальные машины, на которых не удалось установить пакеты приложений или контейнеры, даже если их состояние **непригодно для использования**.

Если пакетная служба может определить причину, свойство узла [errors](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodeerror) сообщает об этом.

Ниже приведены дополнительные примеры возможных причин возникновения состояния узлов **unusable** (Непригоден).

- Образ виртуальной машины является недопустимым. Например, образ подготовлено неправильно.

- Виртуальная машина перемещена из-за сбоя инфраструктуры или обновления нижнего уровня. Пакетная служба восстанавливает узел.

- Образ виртуальной машины был развернут на оборудовании, который его не поддерживает. Например, при попытке запустить образ HPC CentOS на виртуальной машине [Standard_D1_v2](../virtual-machines/linux/sizes-general.md#dv2-series) .

- Виртуальные машины находятся в [виртуальной сети Azure](batch-virtual-network.md), а трафик заблокирован на ключевые порты.

- Виртуальные машины находятся в виртуальной сети, но исходящий трафик в хранилище Azure заблокирован.

- Виртуальные машины находятся в виртуальной сети с конфигурацией DNS клиента, и DNS-серверу не удается разрешить службу хранилища Azure.

### <a name="node-agent-log-files"></a>Файлы журнала агента узла

Процесс агента пакетной службы, который выполняется на каждом узле пула, может содержать файлы журналов, которые могут оказаться полезными, если необходимо обратиться в службу поддержки о проблемах узла пула. Файлы журнала для узла можно отправить с помощью портала Azure, Batch Explorer или [API](https://docs.microsoft.com/rest/api/batchservice/computenode/uploadbatchservicelogs). Это полезно, когда нужно отправить и сохранить файлы журнала. После этого можно удалить узел или пул, чтобы сэкономить на стоимости работающих узлов.

### <a name="node-disk-full"></a>Диск узла полон

Временный диск для виртуальной машины узла пула используется пакетом для файлов заданий, файлов задач и общих файлов.

- Файлы пакетов приложения
- Файлы ресурсов для задач
- Файлы конкретного приложения, загруженные в одну из папок пакетной службы
- Файлы stdout и stderr для выполнения каждого приложения задачи
- Выходные файлы конкретного приложения

Некоторые из этих файлов записываются только один раз при создании узлов пула, таких как пакеты приложений пула или файлы ресурсов задачи запуска пула. Даже если они записываются только один раз при создании узла, если эти файлы слишком велики, они могут заполнить временный диск.

Другие файлы записываются для каждой задачи, выполняемой на узле, например stdout и stderr. Если большое количество задач выполняется на одном узле, а файлы задач слишком велики, они могут заполнить временный диск.

Размер временного диска зависит от размера виртуальной машины. Одним из соображений при выборе размера виртуальной машины является обеспечение достаточного места на временном диске.

- В портал Azure при добавлении пула можно отобразить полный список размеров виртуальных машин, а также столбец "размер диска ресурсов".
- В статьях, описывающих все размеры виртуальных машин, есть таблицы со столбцом "Temp Storage"; Например, [размер виртуальных машин, оптимизированных для вычислений](https://docs.microsoft.com/azure/virtual-machines/windows/sizes-compute)

Для файлов, записываемых каждой задачей, можно указать время хранения для каждой задачи, которая определяет, как долго хранятся файлы задач, прежде чем они будут автоматически очищены. Время хранения можно уменьшить, чтобы снизить требования к хранилищу.

Если временное место на диске заполнено, то в настоящее время узел перестанет выполнять задачи. В будущем будет выведено [сообщение об ошибке узла](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodeerror) .


## <a name="next-steps"></a>Следующие шаги

Убедитесь, что в вашем приложении реализована комплексная проверка ошибок, особенно для асинхронных операций. Очень важно своевременно обнаруживать и диагностировать неполадки.
