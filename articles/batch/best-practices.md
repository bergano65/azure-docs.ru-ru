---
title: Рекомендации по пакетной службе Azure
description: Ознакомьтесь с рекомендациями и полезными советами по разработке решения пакетной службы Azure.
author: laurenhughes
ms.author: lahugh
ms.date: 11/22/2019
ms.service: batch
ms.topic: article
manager: gwallace
ms.openlocfilehash: 19c5b6acaeddb915af49cf62a884da0678075f15
ms.sourcegitcommit: 85e7fccf814269c9816b540e4539645ddc153e6e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/26/2019
ms.locfileid: "74535669"
---
# <a name="azure-batch-best-practices"></a>Рекомендации по пакетной службе Azure

В этой статье рассматривается набор рекомендаций по эффективному и эффективному использованию пакетной службы Azure. Эти рекомендации являются производными от нашего опыта работы с пакетной службой и опытом работы с клиентами пакетной службы. Важно понимать эту статью, чтобы избежать ошибок проектирования, потенциальных проблем с производительностью и защиты от шаблонов при разработке приложений для и использования пакетной службы.

Из этой статьи вы узнаете следующее.

> [!div class="checklist"]
> - Рекомендации
> - Зачем использовать рекомендации
> - Что может случиться, если не следовать рекомендациям
> - Как следовать рекомендациям

## <a name="pools"></a>Пулы

Пулы пакетной службы — это ресурсы вычислений для выполнения заданий в пакетной службе. В следующих разделах приводятся рекомендации по началу работы с пулами пакетной службы.

### <a name="pool-configuration-and-naming"></a>Конфигурация и именование пула

- **Режим распределения пула**  
    При создании учетной записи пакетной службы можно выбрать один из двух режимов распределения пула: **Пакетная служба** или **Пользовательская подписка**. В большинстве случаев следует использовать режим пакетной службы по умолчанию, в котором пулы распределяются за сценой в управляемых пакетах подписок. В альтернативном режиме "Пользовательская подписка" виртуальные машины пакетной службы и другие ресурсы создаются непосредственно в подписке пользователя при создании пула. Учетные записи подписки пользователя в основном используются для обеспечения важного, но небольшого подмножества сценариев. Дополнительные сведения о пользовательском режиме подписки см. в статье [Дополнительная настройка для режима пользовательской подписки](batch-account-create-portal.md#additional-configuration-for-user-subscription-mode).

- **Учитывайте время выполнения задания и задачи при определении сопоставления заданий и пулов.**  
    Если у вас есть задания, которые выполняются в основном из-за кратковременных задач, а ожидаемые суммарные числа задач невелики, то общее ожидаемое время выполнения задания не будет выделять новый пул для каждого задания. Время выделения узлов уменьшает время выполнения задания.

- **Пулы должны иметь более одного вычислений.**  
    Доступ к отдельным узлам всегда не гарантируется. В редких случаях сбои оборудования, обновления операционной системы и другие проблемы могут привести к отключению отдельных узлов. Если для рабочей нагрузки пакетной службы требуется детерминированный, гарантированный ход выполнения, необходимо выделить пулы с несколькими узлами.

- **Не используйте повторно имена ресурсов.**  
    Ресурсы пакетной службы (задания, пулы и т. д.) часто бывают и выходят со временем. Например, вы можете создать пул в понедельник, удалить его во вторник, а затем создать другой пул в четверг. Каждому новому создаваемому ресурсу следует присвоить уникальное имя, которое раньше не использовалось. Это можно сделать, используя идентификатор GUID (как полное имя ресурса или как часть его части) или внедрить время создания ресурса в имени ресурса. Пакетная функция поддерживает [DisplayName](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.jobspecification.displayname?view=azure-dotnet), которую можно использовать для предоставления ресурсу понятного имени, даже если фактический идентификатор ресурса не является понятным для человека. Использование уникальных имен упрощает различение определенного ресурса в журналах и метриках. Это также устраняет неоднозначность, если вам когда-либо придется заменять обращение в службу поддержки для ресурса.

- **Непрерывность при обслуживании и сбое пула.**  
    Лучше использовать пулы динамически. Если задания используют один и тот же пул для всех, существует вероятность того, что задания не будут выполняться, если что-то пойдет из строя пула. Это особенно важно для рабочих нагрузок с учетом времени. Чтобы устранить эту проблему, выберите или создайте пул динамически при планировании каждого задания или укажите способ переопределения имени пула, чтобы можно было обойти неработоспособный пул.

- **Непрерывность бизнес-процессов во время обслуживания и сбоя пула**  
    Существует множество возможных причин, которые могут препятствовать росту пула до требуемого размера, например внутренних ошибок, ограничений емкости и т. д. По этой причине вы должны быть готовы к перенаправлению заданий в другой пул (возможно, с другим размером виртуальной машины — пакет поддерживает это через [упдатежоб](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.protocol.joboperationsextensions.update?view=azure-dotnet)) при необходимости. Избегайте использования идентификатора статического пула с предположением, что он никогда не будет удален и никогда не изменится.

### <a name="pool-lifetime-and-billing"></a>Время существования пула и выставление счетов

Время существования пула может различаться в зависимости от метода выделения и параметров, применяемых к конфигурации пула. Пулы могут иметь произвольное время существования и разное количество вычислений в пуле в любой момент времени. Вы отвечаете за управление вычисленными узлами в пуле явным образом или через функции, предоставляемые службой (Автомасштабирование или автопул).

- **Обеспечьте актуальность пулов.**  
    Необходимо изменить размер пулов на ноль каждые несколько месяцев, чтобы получить последние обновления агента узла и исправления ошибок. Пул не будет принимать обновления агента узла, если он не будет создан повторно или не будет изменен на 0 вычислений. Перед воссозданием или изменением размера пула рекомендуется скачать все журналы агентов узлов для отладки, как описано в разделе [узлы](#nodes) .

- **Повторное создание пула**  
    В подобной заметке не рекомендуется ежедневно удалять и повторно создавать пулы. Вместо этого создайте пул, обновите существующие задания, чтобы они указывали на новый пул. Когда все задачи будут перемещены в новый пул, удалите старый пул.

- **Эффективность и выставление счетов за использование пула**  
    Сам пакет не требует дополнительной оплаты, но плата за использование ресурсов вычислений взимается. Плата взимается за каждый кластерный узел в пуле независимо от состояния, в котором он находится. Сюда входят все расходы, необходимые для выполнения узла, такие как затраты на хранение и сеть. Дополнительные рекомендации см. в статье [анализ затрат и бюджеты для пакетной службы Azure](budget.md).

### <a name="pool-allocation-failures"></a>Сбои при выделении пула

Сбои при выделении пула могут происходить в любой момент во время первого выделения памяти или при последующих изменениях размеров. Это может быть вызвано нехваткой временной емкости в регионе или сбоях в других службах Azure, на которые полагается Пакетная служба. Ваша базовая квота не является гарантией, а ограничением.

### <a name="unplanned-downtime"></a>Незапланированный простой

Пулы пакетной службы могут работать с событиями простоя в Azure. Это важно помнить при планировании и разработке сценария или рабочего процесса для пакетной службы.

В случае сбоя узла Пакетная службы автоматически пытается восстановить эти вычисловые узлы от вашего имени. Это может вызвать перепланирование любой выполняемой задачи на восстанавливаемом узле. Дополнительные сведения о прерванных задачах см. в разделе [Разработка для повторных попыток](#designing-for-retries-and-re-execution) .

- **Зависимость региона Azure**  
    Рекомендуется не зависеть от одного региона Azure, если есть рабочая нагрузка с учетом времени или рабочей нагрузки. В редких случаях возникают проблемы, которые могут повлиять на весь регион. Например, если обработка должна начаться в определенное время, рассмотрите возможность масштабирования пула в основном регионе *до времени начала*. Если масштаб пула завершается сбоем, можно вернуться к масштабированию пула в регионе резервного копирования (или регионах). Пулы в нескольких учетных записях в разных регионах обеспечивают готовую и легко доступную резервную копию, если что-то пошло не так с другим пулом. Дополнительные сведения см. в статье [проектирование приложения для обеспечения высокой доступности](high-availability-disaster-recovery.md).

## <a name="jobs"></a>Задания

Задание — это контейнер, предназначенный для хранения сотен, тысяч или даже миллионов задач.

- **Добавление нескольких задач в задание**  
    Использование задания для выполнения одной задачи является неэффективным. Например, более эффективно использовать одно задание, содержащее 1000 задач, вместо создания 100 заданий, содержащих 10 задач. Выполнение заданий 1000 с одной задачей — это наименее эффективный, медленный и наиболее ресурсоемкий подход.  

    Не следует проектировать пакетное решение, для которого требуются тысячи одновременно активных заданий. Для задач не предусмотрена квота, поэтому выполнение как можно больше задач с минимально возможным количеством заданий использует [квоты задания и расписания задания](batch-quota-limit.md#resource-quotas).

- **Время существования задания**  
    Пакетное задание имеет неопределенное время существования до тех пор, пока оно не будет удалено из системы. Состояние задания определяет, может ли он принимать больше задач для планирования или нет. Задание не переходит автоматически в завершенное состояние, пока не завершено явно. Это можно автоматически запустить с помощью свойства [onAllTasksComplete](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.common.onalltaskscomplete?view=azure-dotnet) или [maxWallClockTime](https://docs.microsoft.com/rest/api/batchservice/job/add#jobconstraints).

Существует [Квота активного задания и расписания задания](batch-quota-limit.md#resource-quotas)по умолчанию. Задания и расписания заданий в завершенном состоянии не учитываются в этой квоте.

## <a name="tasks"></a>Задачи

Задачи — это отдельные единицы работы, составляющие задание. Задачи отправляются пользователем и планируются пакетной службой на вычисление узлов. При создании и выполнении задач необходимо учитывать несколько аспектов проектирования. В следующих разделах описываются распространенные сценарии и способы проектирования задач для решения проблем и эффективного выполнения.

- **Сохранение данных задачи в рамках задачи.**  
    Расчетные узлы по своей природе являются временными. Существует множество функций в пакетной службе, таких как автопул и Автомасштабирование, которые упрощают узлы. Когда узлы оставляют пул (из-за изменения размера или удаления пула), все файлы на этих узлах также удаляются. В связи с этим рекомендуется перед завершением задачи переместить выходные данные с узла, на котором она выполняется, и в долговременное хранилище. Аналогично, если задача завершается сбоем, необходимо перенести журналы, необходимые для диагностики сбоя в надежном хранилище. Пакетная служба поддерживает службу хранилища Azure для передачи данных через [OutputFiles](batch-task-output-files.md), а также разнообразные общие файловые системы или вы можете выполнить отправку самостоятельно в своих задачах.

### <a name="task-lifetime"></a>Срок действия задачи

- **Удаление задач после их завершения.**  
    Удалите задачи, когда они больше не нужны, или задайте ограничение задачи [retentionTime](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskconstraints.retentiontime?view=azure-dotnet) . Если задано `retentionTime`, пакетная службы автоматически очищает дисковое пространство, используемое задачей при истечении срока действия `retentionTime`.  

    При удалении задач выполняются два действия. Это гарантирует, что в задании не будут создаваться задачи, что сделает запрос или поиск нужной задачи труднее (так как вам нужно будет отфильтровать завершенные задачи). Он также очищает соответствующие данные задачи на узле (предоставленный `retentionTime` еще не был достигнут). Это гарантирует, что узлы не заполняют данные задачи и не занимают место на диске.

### <a name="task-submission"></a>Отправка задачи

- **Отправка большого количества задач в коллекции.**  
    Задачи могут отправляться отдельно или в коллекциях. Отправляйте задачи в [коллекциях](https://docs.microsoft.com/rest/api/batchservice/task/addcollection) размером до 100 в один момент времени при выполнении групповой отправки задач, чтобы сократить затраты и время отправки.

### <a name="task-execution"></a>Выполнение задачи

- **Выбор максимального числа задач для каждого узла**  
    Пакетная служба поддерживает переписку задач на узлах (выполнение большего числа задач, чем у узла, имеющего ядра). Вам нужно убедиться, что ваши задачи соответствуют узлам в пуле. Например, у вас может возникнуть снижение производительности при планировании восьми задач, каждый из которых потребляет 25% загрузки ЦП на один узел (в пуле с `maxTasksPerNode = 8`).

### <a name="designing-for-retries-and-re-execution"></a>Разработка для повторных попыток и повторного выполнения

Задачи могут автоматически повторяться пакетной службой. Существует два типа повторных попыток: управляемый пользователем и внутренний. Повторные попытки, управляемые пользователем, задаются [maxTaskRetryCount](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskconstraints.maxtaskretrycount?view=azure-dotnet)задачи. Когда программа, указанная в задаче, завершается с ненулевым кодом выхода, задача повторяется до значения `maxTaskRetryCount`.

Несмотря на то, что задача может быть повторно выполнена внутренним образом из-за сбоев на кластерном узле, например, не может обновлять внутреннее состояние или сбой на узле во время выполнения задачи. Задача будет повторена на том же кластерном узле, если это возможно, до внутреннего ограничения перед тем, как приступить к задаче и отложить перепланирование задачи по пакетной службе, потенциально на другом кластерном узле.

- **Создание устойчивых задач**  
    Задачи должны быть рассчитаны на сбой и обеспечить повторную попытку. Это особенно важно для выполнения длительных задач. Для этого убедитесь, что задачи формируют один и тот же результат, даже если они выполняются более одного раза. Один из способов добиться этого — сделать задачи "Поиск решения". Другой способ — убедиться в том, что задачи идемпотентными (задачи будут иметь тот же результат, независимо от того, сколько раз они выполняются).

    Распространенным примером является задача копирования файлов на узел вычислений. Простой подход — это задача, которая копирует все указанные файлы при каждом запуске, что неэффективно и не встроено в сбой. Вместо этого создайте задачу, чтобы убедиться, что файлы находятся на узле вычислений. задача, которая не копирует уже существующие файлы. Таким образом, задача берет, откуда она была прервана.

- **Узлы с низким приоритетом**  
    При выполнении задач на узлах с низким приоритетом или узлов с низкой важностью нет различий в проектировании. Если задача заменяется при выполнении на узле с низким приоритетом или прервана из-за сбоя на выделенном узле, то обе ситуации снижают опасность, так как задача выдает сбой.

- **Время выполнения задачи**  
    Избегайте задач с коротким временем выполнения. Задачи, которые выполняются только в течение одной или двух секунд, не идеально подходят. Следует попытаться выполнить значительный объем работы в отдельной задаче (не менее 10 секунд, в течение которых будет выполняться до нескольких часов или дней). Если каждая задача выполнялась в течение одной минуты (или более), то затраты на планирование в качестве доли общего времени вычислений невелики.

## <a name="nodes"></a>Nodes

- **Задачи запуска должны быть идемпотентными**  
    Как и в случае с другими задачами, задача запуска узла должна быть идемпотентными, так как она будет перезапущена при каждом запуске узла. Задача идемпотентными — это просто одна из них, которая создает единообразный результат при многократном выполнении.

- **Управление долгосрочными службами с помощью интерфейса служб операционной системы.**  
    Иногда требуется запустить другой агент вместе с агентом пакетной службы в узле, например, для сбора данных с узла и его отчета. Рекомендуется развертывать эти агенты как службы операционной системы, такие как служба Windows или служба `systemd` Linux.  

    При выполнении этих служб они не должны принимать блокировки файлов для файлов в каталогах, управляемых пакетом управления на узле, так как в противном случае пакетная служба не сможет удалить эти каталоги из-за блокировки файлов. Например, при установке службы Windows в задаче запуска вместо запуска службы непосредственно из рабочего каталога "Запуск задачи" скопируйте файлы в другое место (если файлы только пропускают копию). Установите службу из этого расположения. Когда Пакетная задача повторно выполняет задачу запуска, она удаляет рабочий каталог Start Task и создает его снова. Это работает потому, что служба имеет блокировки файлов в другом каталоге, а не в рабочем каталоге задачи запуска.

- **Избегайте создания соединений каталогов в Windows**  
    Соединения каталогов, иногда называемые жесткими связями каталогов, трудно устранять при выполнении задач и очистки заданий. Используйте символических ссылок (Soft-Links), а не жесткие связи.

- **Собирайте журналы агента пакетной службы, если возникла ошибка**  
    Если обнаруживается проблема, связанная с поведением узла или задач, выполняемых на узле, рекомендуется собираются журналы пакетного агента до освобождения узлов. Журналы агента пакетной службы можно собирать с помощью API отправки пакетных журналов Service Batch. Эти журналы могут предоставляться в корпорацию Майкрософт как часть запроса в службу поддержки, что поможет устранить неполадки и решить проблемы.

## <a name="security"></a>Безопасность

### <a name="security-isolation"></a>Защита путем изоляции

В целях изоляции, если в сценарии требуется изолировать задания друг от друга, следует изолировать эти задания в отдельных пулах. Пул — это граница изоляции безопасности в пакетной службе, и по умолчанию два пула не видны и не могут взаимодействовать друг с другом. Избегайте использования отдельных учетных записей пакетной службы в качестве средства изоляции.
