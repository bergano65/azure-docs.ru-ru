---
title: Параллельное выполнение задач для эффективного использования вычислительных узлов пакетной службы
description: Увеличение эффективности и снижение затрат за счет использования меньшего количества вычислений и параллельных задач на каждом узле в пуле пакетной службы Azure
ms.topic: how-to
ms.date: 10/08/2020
ms.custom: H1Hack27Feb2017, devx-track-csharp
ms.openlocfilehash: 8bc9f03f05d52df6e400be5c57033ab2a38fa8eb
ms.sourcegitcommit: ae6e7057a00d95ed7b828fc8846e3a6281859d40
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2020
ms.locfileid: "92102971"
---
# <a name="run-tasks-concurrently-to-maximize-usage-of-batch-compute-nodes"></a>Параллельное выполнение задач для эффективного использования вычислительных узлов пакетной службы

Можно максимально увеличить использование ресурсов на меньшем количестве вычислений в пуле, запустив несколько задач одновременно на каждом узле.

Хотя некоторые сценарии лучше всего подходят для всех ресурсов узла, выделенных для одной задачи, некоторые рабочие нагрузки могут уменьшить время выполнения заданий и снизить затраты, если несколько задач совместно используют эти ресурсы.

- **Сократите объем данных** для задач, которые могут обмениваться данными. Можно значительно сократить расходы на передачу данных, скопировав общие данные на меньшее количество узлов, а затем параллельно выполняя задачи на каждом узле. Это особенно актуально, если данные, которые копируются на каждый узел, необходимо передавать между географическими регионами.
- **Максимальное использование памяти** для задач, требующих большого объема памяти, но только в течение коротких периодов времени и при переменном времени выполнения. Для эффективной обработки таких нагрузок можно использовать меньшее число более крупных вычислительных узлов с большим объемом памяти. Эти узлы могли бы иметь параллельные задачи, которые выполняются на каждом узле, но каждая задача использовала бы большой объем памяти узлов в разное время.
- **Устранение ограничений числа узлов** , если в пуле требуется обмен данными между узлами. Сейчас существует ограничение в 50 вычислительных узлов для пулов, в которых настроен обмен данными между узлами. Поэтому если каждый узел в таком пуле будет выполнять задачи параллельно, можно будет выполнять больше задач одновременно.
- **Репликация локального кластера вычислений**, например при первом перемещении среды вычислений в Azure. Увеличение максимального числа задач на узле позволит точнее скопировать существующую физическую конфигурацию, если текущее локальное решение позволяет выполнять несколько задач на каждом вычислительном узле.

## <a name="example-scenario"></a>Пример сценария

В качестве примера представьте себе приложение задачи с требованиями к ЦП и памяти, что достаточно для [стандартных узлов \_ D1](../cloud-services/cloud-services-sizes-specs.md) . Однако, чтобы завершить задание в необходимое время, необходимо 1 000 из этих узлов.

Вместо узлов размера Standard\_D1, каждый из которых содержит одно ядро ЦП, вы можете использовать 16-ядерные узлы [Standard\_D14](../cloud-services/cloud-services-sizes-specs.md), включив на них параллельное выполнение задач. Это означает, что можно использовать *16 раз меньше узлов* , а не 1 000 узлов, потребуется только 63. Если для каждого узла требуются большие файлы приложения или эталонные данные, длительность задания и эффективность снова улучшаются, так как данные копируются только на 63 узлах.

## <a name="enable-parallel-task-execution"></a>Включение параллельного выполнения задач

Настройка параллельного выполнения задач для вычислительных узлов выполняется на уровне пула. При создании пула с помощью библиотеки .NET для пакетной службы задайте свойство [CloudPool. таскслотсперноде](/dotnet/api/microsoft.azure.batch.cloudpool) . Если вы используете пакетную REST API, задайте элемент [таскслотсперноде](/rest/api/batchservice/pool/add) в тексте запроса во время создания пула.

> [!NOTE]
> `taskSlotsPerNode`Элемент и свойство [таскслотсперноде](/dotnet/api/microsoft.azure.batch.cloudpool) можно задать только во время создания пула. Их нельзя изменить после того, как пул уже создан.

Пакетная служба Azure позволяет устанавливать слоты задач на каждый узел вплоть до (4X) количества ядер узлов. Например, если для пула настроены узлы размера "Большой" (четыре ядра), для параметра `taskSlotsPerNode` можно задать значение 16. Однако независимо от того, сколько ядер имеет узел, у вас не может быть более 256 слотов задач на каждый узел. Сведения о количестве ядер для каждого узла см. в статье [Размеры для облачных служб](../cloud-services/cloud-services-sizes-specs.md). Дополнительные сведения об ограничениях службы см. в статье [Квоты и ограничения пакетной службы Azure](batch-quota-limit.md).

> [!TIP]
> Обязательно учитывайте значение параметра `taskSlotsPerNode` при создании [формулы автомасштабирования](/rest/api/batchservice/pool/enableautoscale) для пула. Например, если в формуле учитывается параметр `$RunningTasks`, изменение количества задач существенно повлияет на результат ее применения. Дополнительные сведения см. [в статье Автоматическое масштабирование вычислений узлов в пуле пакетной службы Azure](batch-automatic-scaling.md).

## <a name="specify-task-distribution"></a>Указание распределения задач

При включении параллельных задач важно указать способ распределения задач по узлам в пуле.

С помощью свойства [CloudPool.TaskSchedulingPolicy](/dotnet/api/microsoft.azure.batch.cloudpool) можно указать, что задачи должны назначаться ("распространяться") равномерно по всем узлам в кластере. Или можно указать, что перед переходом к следующему узлу необходимо назначить максимальное количество задач текущему узлу ("упаковка").

В качестве примера рассмотрим пул [стандартных узлов \_ D14](../cloud-services/cloud-services-sizes-specs.md) (в примере выше), для которого настроено значение [CloudPool. таскслотсперноде](/dotnet/api/microsoft.azure.batch.cloudpool) , равное 16. Если [CloudPool. TaskSchedulingPolicy](/dotnet/api/microsoft.azure.batch.cloudpool) настроен с [компутенодефиллтипе](/dotnet/api/microsoft.azure.batch.common.computenodefilltype) *Pack*, он будет максимально использовать все 16 ядер каждого узла и позволить [пулу автомасштабирования](batch-automatic-scaling.md) удалить неиспользуемые узлы (узлы без назначенных задач) из пула. Это снизит использование ресурсов и расходы на них.

## <a name="define-variable-slots-per-task"></a>Определение слотов переменных для задачи

Задачу можно определить с помощью свойства [CloudTask. рекуиредслотс](/dotnet/api/microsoft.azure.batch.cloudtask.requiredslots) , указав, сколько слотов требуется для выполнения на кластерном узле. Значение по умолчанию равно 1. Можно задать переменные слоты задач, если задачи имеют разные весовые коэффициенты в отношении использования ресурсов на кластерном узле. Это позволяет каждому вычислительному узлу иметь разумное количество параллельно выполняемых задач без переполнения системных ресурсов, таких как ЦП или память.

Например, для пула с свойством `taskSlotsPerNode = 8` можно отправить многоядерные задачи, требующие интенсивного использования ЦП, с помощью `requiredSlots = 8` , а для других задач можно задать значение `requiredSlots = 1` . При планировании этой смешанной рабочей нагрузки задачи с интенсивным использованием ЦП будут выполняться исключительно на вычислительных узлах, а другие задачи могут выполняться одновременно (до восьми задач одновременно) на других узлах. Это помогает сбалансировать рабочую нагрузку на разных компьютерах вычислений и повысить эффективность использования ресурсов.

> [!TIP]
> При использовании переменных слотов задач возможно, что большие задачи с большим количеством слотов можно временно не планировать, так как недостаточное количество слотов доступно на любом кластерном узле, даже если на некоторых узлах остались свободные слоты. Вы можете увеличить приоритет задания для этих задач, чтобы повысить вероятность того, что они будут конкурировать за доступные слоты на узлах.
>
> Пакетная служба выдает [тасксчедулефаилевент](batch-task-schedule-fail-event.md) , когда не удается запланировать выполнение задачи и повторяет попытку планирования, пока не станут доступны нужные слоты. Вы можете прослушать это событие, чтобы выявить потенциальные проблемы планирования задач и соответствующим образом устранить их.

> [!NOTE]
> Не указывайте значение задачи, превышающее `requiredSlots` значение в пуле `taskSlotsPerNode` . Это приведет к тому, что задача никогда не сможет выполняться. Пакетная служба в настоящее время не проверяет этот конфликт при отправке задач, так как в задании не может быть привязан пул во время отправки или он может быть изменен на другой пул путем отключения или повторного включения.

## <a name="batch-net-example"></a>Пример использования компонента .NET пакетной службы

В следующих фрагментах кода API [.NET пакетной](/dotnet/api/microsoft.azure.batch) службы показано, как создать пул с несколькими слотами задач на узел и как отправить задачу с нужными слотами.

### <a name="create-a-pool-with-multiple-task-slots-per-node"></a>Создание пула с несколькими слотами задач на узел

В этом фрагменте кода показан запрос на создание пула, содержащего четыре узла, для каждого узла разрешено четыре слота задач. Он задает политику планирования задач, при которой каждому узлу назначается максимальное количество задач перед переходом к следующему узлу пула.

Дополнительные сведения о добавлении пулов с использованием API .NET пакетной службы см. в описании метода [BatchClient.PoolOperations.CreatePool](/dotnet/api/microsoft.azure.batch.pooloperations).

```csharp
CloudPool pool =
    batchClient.PoolOperations.CreatePool(
        poolId: "mypool",
        targetDedicatedComputeNodes: 4
        virtualMachineSize: "standard_d1_v2",
        cloudServiceConfiguration: new CloudServiceConfiguration(osFamily: "5"));

pool.TaskSlotsPerNode = 4;
pool.TaskSchedulingPolicy = new TaskSchedulingPolicy(ComputeNodeFillType.Pack);
pool.Commit();
```

### <a name="create-a-task-with-required-slots"></a>Создание задачи с необходимыми слотами

Этот фрагмент кода создает задачу со значением, отличным от значения по умолчанию `requiredSlots` . Эта задача будет выполняться только при наличии достаточного количества свободных слотов на кластерном узле.

```csharp
CloudTask task = new CloudTask(taskId, taskCommandLine)
{
    RequiredSlots = 2
};
```

### <a name="list-compute-nodes-with-counts-for-running-tasks-and-slots"></a>Вывод списка расчетных узлов с учетом количества выполняемых задач и слотов

Этот фрагмент кода перечисляет все расчетные узлы в пуле и выводит счетчики для выполняемых задач и слотов задач на каждом узле.

```csharp
ODATADetailLevel nodeDetail = new ODATADetailLevel(selectClause: "id,runningTasksCount,runningTaskSlotsCount");
IPagedEnumerable<ComputeNode> nodes = batchClient.PoolOperations.ListComputeNodes(poolId, nodeDetail);

await nodes.ForEachAsync(node =>
{
    Console.WriteLine(node.Id + " :");
    Console.WriteLine($"RunningTasks = {node.RunningTasksCount}, RunningTaskSlots = {node.RunningTaskSlotsCount}");

}).ConfigureAwait(continueOnCapturedContext: false);
```

### <a name="list-task-counts-for-the-job"></a>Перечисление количества задач для задания

Этот фрагмент кода возвращает количество задач для задания, которое включает задачи и количество слотов задач для состояния задачи.

```csharp
TaskCountsResult result = await batchClient.JobOperations.GetJobTaskCountsAsync(jobId);

Console.WriteLine("\t\tActive\tRunning\tCompleted");
Console.WriteLine($"TaskCounts:\t{result.TaskCounts.Active}\t{result.TaskCounts.Running}\t{result.TaskCounts.Completed}");
Console.WriteLine($"TaskSlotCounts:\t{result.TaskSlotCounts.Active}\t{result.TaskSlotCounts.Running}\t{result.TaskSlotCounts.Completed}");
```

## <a name="batch-rest-example"></a>Пример интерфейса REST API пакетной службы

В следующих фрагментах кода API-интерфейса для [пакетной](/rest/api/batchservice/) службы. показано, как создать пул с несколькими слотами задач на узел и как отправить задачу с нужными слотами.

### <a name="create-a-pool-with-multiple-task-slots-per-node"></a>Создание пула с несколькими слотами задач на узел

В этом фрагменте кода показан запрос на создание пула, который содержит два крупных узла с максимум четырьмя задачами на один узел.

Дополнительные сведения о добавлении пулов с помощью REST API см. в статье [Добавление пула к учетной записи](/rest/api/batchservice/pool/add).

```json
{
  "odata.metadata":"https://myaccount.myregion.batch.azure.com/$metadata#pools/@Element",
  "id":"mypool",
  "vmSize":"large",
  "cloudServiceConfiguration": {
    "osFamily":"4",
    "targetOSVersion":"*",
  },
  "targetDedicatedComputeNodes":2,
  "taskSlotsPerNode":4,
  "enableInterNodeCommunication":true,
}
```

### <a name="create-a-task-with-required-slots"></a>Создание задачи с необходимыми слотами

В этом фрагменте кода показан запрос на добавление задачи со значением, отличным от значения по умолчанию `requiredSlots` . Эта задача будет выполняться только при наличии достаточного количества свободных слотов на кластерном узле.

```json
{
  "id": "taskId",
  "commandLine": "bash -c 'echo hello'",
  "userIdentity": {
    "autoUser": {
      "scope": "task",
      "elevationLevel": "nonadmin"
    }
  },
  "requiredSLots": 2
}
```

## <a name="code-sample-on-github"></a>Пример кода на GitHub

Проект [ParallelTasks](https://github.com/Azure/azure-batch-samples/tree/master/CSharp/ArticleProjects/ParallelTasks) на сайте GitHub иллюстрирует использование свойства [CloudPool. таскслотсперноде](/dotnet/api/microsoft.azure.batch.cloudpool) .

Это консольное приложение C# использует библиотеку [.NET пакетной службы](/dotnet/api/microsoft.azure.batch) для создания пула с одним или несколькими вычислительными узлами. Он выполняет настраиваемое количество задач на этих узлах для имитации загрузки переменной. Выходные данные приложения показывают, какие узлы выполняли каждую задачу. Приложение также предоставляет сводку параметров задания и времени его выполнения.

Например, ниже приведена сводная часть выходных данных двух различных запусков примера приложения ParallelTasks. Показанные здесь длительности заданий не включают время создания пула, так как каждое задание было отправлено в ранее созданный пул, в котором узлы вычислений находились в состоянии *простоя* во время отправки.

Первый запуск примера приложения показывает, что с одним узлом в пуле и с одной задачей на узел (настройка по умолчанию) на выполнение задания потребовалось более 30 минут.

```
Nodes: 1
Node size: large
Task slots per node: 1
Max slots per task: 1
Tasks: 32
Duration: 00:30:01.4638023
```

Второй запуск примера показывает значительное уменьшение времени выполнения задания. Это обусловлено тем, что для пула настроено четыре задачи на узел, что позволяет параллельному выполнению задач завершить задание почти в квартал времени.

```
Nodes: 1
Node size: large
Task slots per node: 4
Max slots per task: 1
Tasks: 32
Duration: 00:08:48.2423500
```

## <a name="next-steps"></a>Дальнейшие действия

- Попробуйте [Batch Explorer](https://azure.github.io/BatchExplorer/) тепловой карте. Batch Explorer — это бесплатный автономный клиентский инструмент с множеством функций для создания, отладки и мониторинга приложений пакетной службы Azure. При выполнении примера Batch Explorer приложения [ParallelTasks](https://github.com/Azure/azure-batch-samples/tree/master/CSharp/ArticleProjects/ParallelTasks) функция тепловой карт позволяет легко визуализировать выполнение параллельных задач на каждом узле.
- Ознакомьтесь [с примерами пакетной службы Azure на сайте GitHub](https://github.com/Azure/azure-batch-samples).
- Дополнительные сведения о [зависимостях пакетной задачи](batch-task-dependencies.md).
