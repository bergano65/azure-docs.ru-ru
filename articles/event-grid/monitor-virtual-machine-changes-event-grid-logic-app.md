---
title: Отслеживание изменений виртуальных машин с помощью Azure Logic Apps и службы "Сетка событий Azure"
description: Проверка наличия изменений в виртуальных машинах с помощью службы "Сетка событий Azure" и Logic Apps
services: logic-apps
ms.service: logic-apps
ms.suite: integration
author: ecfan
ms.author: estfan
ms.reviewer: klam, LADocs
ms.topic: tutorial
ms.date: 10/11/2019
ms.openlocfilehash: 5d852378812d8e69480ceb2c5dcea95f1d5f3770
ms.sourcegitcommit: c22327552d62f88aeaa321189f9b9a631525027c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2019
ms.locfileid: "73488613"
---
# <a name="tutorial-monitor-virtual-machine-changes-by-using-azure-event-grid-and-logic-apps"></a>Руководство по отслеживанию изменений виртуальной машины с помощью Azure Logic Apps и службы "Сетка событий Azure"

Чтобы отслеживать определенные события, которые происходят в ресурсах Azure или сторонних ресурсах, и реагировать на них, вы можете автоматизировать и запускать задачи в виде рабочего процесса, создав [приложение логики](../logic-apps/logic-apps-overview.md), которое использует минимальный код. Эти ресурсы могут публиковать события в службу [Сетка событий Azure](../event-grid/overview.md). В свою очередь, служба "Сетка событий" передает эти события подписчикам, использующим очереди, веб-привязки или [концентраторы событий](../event-hubs/event-hubs-what-is-event-hubs.md) в качестве конечных точек. В качестве подписчика приложение логики может ожидать эти события из службы "Сетка событий" перед запуском автоматических рабочих процессов для выполнения задач.

Для примера ниже приведено несколько событий, которые издатели могут отправлять подписчикам через службу "Сетка событий Azure".

* Создание, чтение, обновление или удаление ресурса. Например, можно отслеживать изменения, за которые может взиматься плата по подписке Azure и которые могут отразиться на вашем счете.

* Добавление или удаление пользователя в подписке Azure.

* Ваше приложение выполняет определенное действие.

* В очереди появляется новое сообщение.

В этом руководстве описывается создание приложения логики, которое отслеживает изменения в виртуальной машине и отправляет сообщения электронной почты об этих изменениях. При создании приложения логики с подпиской на события ресурса Azure события передаются из этого ресурса в приложение логики с помощью службы "Сетка событий". В этом руководстве описывается создание приложения логики:

![Обзор: отслеживание виртуальной машины с помощью службы "Сетка событий" и приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/monitor-virtual-machine-event-grid-logic-app-overview.png)

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание приложения логики, отслеживающего события с помощью службы "Сетка событий".
> * Добавление условия, проверяющего наличие изменений виртуальной машины.
> * Отправка электронного сообщения при изменении виртуальной машины.

## <a name="prerequisites"></a>Предварительные требования

* Подписка Azure. Если у вас еще нет подписки Azure, [зарегистрируйтесь для получения бесплатной учетной записи Azure](https://azure.microsoft.com/free/).

* Учетная запись электронной почты поставщика электронной почты, поддерживаемого Logic Apps, для отправки уведомлений, например Office 365 Outlook, Outlook.com или Gmail. Сведения о дополнительных поставщиках см. в [списке соединителей](/connectors/).

  В этом руководстве используется учетная запись Office 365 Outlook. Если используется другая учетная запись электронной почты, общие шаги остаются неизменными, однако интерфейс может выглядеть несколько иначе.

* [Виртуальная машина](https://azure.microsoft.com/services/virtual-machines), которая находится отдельно в собственной группе ресурсов Azure. Создайте виртуальную машину, используя [сведения из учебника по созданию виртуальной машины](../virtual-machines/windows/quick-create-portal.md), если вы еще не сделали этого. Чтобы настроить виртуальную машину для публикации событий, [не нужны никакие дополнительные действия](../event-grid/overview.md).

## <a name="create-blank-logic-app"></a>Создание пустого приложения логики

1. Войдите на [портал Azure](https://portal.azure.com) с помощью учетных данных учетной записи Azure.

1. В главном меню на портале Azure последовательно выберите **Создать ресурс** > **Интеграция** > **Приложение логики**.

   ![Создание приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/azure-portal-create-logic-app.png)

1. В разделе **Приложение логики** укажите сведения о своем ресурсе приложения логики. Когда все будет готово, выберите **Создать**.

   ![Ввод данных приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/create-logic-app-for-event-grid.png)

   | Свойство | Обязательно | Value | ОПИСАНИЕ |
   |----------|----------|-------|-------------|
   | **Имя** | Yes | <*logic-app-name*> | Укажите уникальное имя для приложения логики. |
   | **подписка** | Yes | <*Azure-subscription-name*> | Выберите одну подписку Azure для всех служб в этом учебнике. |
   | **группа ресурсов** | Yes | <*Azure-resource-group*> | Имя группы ресурсов Azure для приложения логики, которое вы можете выбрать для всех служб в этом учебнике. |
   | **Местоположение.** | Yes | <*Azure-region*> | Выберите один регион для всех служб в этом руководстве. |
   |||

1. После развертывания приложения логики в Azure в конструкторе Logic Apps отображается страница с вводным видео и часто используемыми триггерами. Прокрутите видео и триггеры.

1. В разделе **Шаблоны** выберите **Пустое приложение логики**.

   ![Выбор шаблона приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/choose-logic-app-template.png)

   Теперь в конструкторе Logic Apps отображаются [*триггеры*](../logic-apps/logic-apps-overview.md#logic-app-concepts), которые можно использовать для запуска приложения логики. Каждое приложение логики должно запускаться по триггеру, который активируется, когда происходит определенное событие или если выполняются заданные условия. При каждой активации триггера Azure Logic Apps создает экземпляр рабочего процесса для выполнения приложения логики.

## <a name="add-an-event-grid-trigger"></a>Добавление триггера Сетки событий

Теперь добавьте триггер Сетки событий, который будет использоваться для отслеживания группы ресурсов для виртуальной машины.

1. В конструкторе в поле поиска введите `event grid` в качестве фильтра. В списке триггеров выберите **При возникновении события ресурса**.

   ![Выберите триггер При возникновении события ресурса](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-event-grid-trigger.png)

1. При появлении запроса войдите в Сетку событий Azure, используя учетные данные учетной записи Azure. Убедитесь, что в списке **клиентов** с клиентом Azure Active Directory, связанным с вашей подпиской Azure, отображается правильный клиент, например:

   ![Вход с помощью учетных данных Azure](./media/monitor-virtual-machine-changes-event-grid-logic-app/sign-in-event-grid.png)

   > [!NOTE]
   > Если вы вошли с помощью личной учетной записи Майкрософт, например @outlook.com или @hotmail.com, триггер службы "Сетка событий" может отображаться неправильно. Чтобы избежать этого, выберите [Подключиться к субъекту-службе](../active-directory/develop/howto-create-service-principal-portal.md) или выполните проверку подлинности в качестве участника Azure Active Directory, связанного с подпиской Azure, например *имя_пользователя*@emailoutlook.onmicrosoft.com.

1. Теперь подпишите приложение логики на события издателя. Укажите сведения о подписке на события, как указано в следующей таблице, например:

   ![Ввод сведений подписки на события](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-event-grid-trigger-details.png)

   | Свойство | Обязательно | Value | ОПИСАНИЕ |
   | -------- | -------- | ----- | ----------- |
   | **подписка** | Yes | <*event-publisher-Azure-subscription-name*> | Выберите имя для подписки Azure, связанной с *издателем событий*. Для работы с этим руководством выберите для виртуальной машины имя подписки Azure. |
   | **Тип ресурса** | Yes | <*event-publisher-Azure-resource-type*> | Выберите тип ресурса Azure для издателя событий. Дополнительные сведения о типах ресурсов Azure см. в статье [Поставщики и типы ресурсов Azure](../azure-resource-manager/resource-manager-supported-services.md). Для работы с этим учебником выберите значение `Microsoft.Resources.ResourceGroups`, чтобы отслеживать группы ресурсов Azure. |
   | **Имя ресурса** |  Yes | <*event-publisher-Azure-resource-name*> | Выберите имя ресурса Azure для издателя событий. Этот список зависит от выбранного типа ресурса. Для работы с этим учебником выберите имя группы ресурсов Azure, содержащей виртуальную машину. |
   | **Элемент типа события** |  Нет | <*event-types*> | Выберите один или несколько определенных типов событий для фильтрации и отправки в сетку событий. Например, при желании вы можете добавить эти типы событий, чтобы определить удаление и изменение ресурсов: <p><p>- `Microsoft.Resources.ResourceActionSuccess` <br>- `Microsoft.Resources.ResourceDeleteSuccess` <br>- `Microsoft.Resources.ResourceWriteSuccess` <p>Дополнительные сведения см. в следующих статьях: <p><p>- [Azure Event Grid event schema for resource groups](../event-grid/event-schema-resource-groups.md) (Схема событий Сетки событий Azure для групп ресурсов) <br>- [Understand event filtering for Event Grid subscriptions](../event-grid/event-filtering.md) (Сведения о фильтрации событий для подписок Сетки событий) <br>- [Filter events for Event Grid](../event-grid/how-to-filter-events.md) (Фильтрация событий для Сетки событий) |
   | Чтобы добавить необязательные свойства, щелкните **Добавить новый параметр**, а затем выберите необходимые свойства. | Нет | {просмотрите описания} | * **Фильтр префиксов**. В целях этого руководства оставьте это свойство пустым. Фильтр по умолчанию соответствует всем значениям. Тем не менее можно указать строку префикса в качестве фильтра, например путь и параметр для определенного ресурса. <p>* **Фильтр префиксов**. В целях этого руководства оставьте это свойство пустым. Фильтр по умолчанию соответствует всем значениям. Тем не менее можно указать строку суффикса в качестве фильтра, например расширение имени файла, если вас интересуют только определенные типы файлов. <p>* **Имя подписки**. Для этого учебника вы можете указать уникальное имя подписки на события. |
   |||

1. Сохраните приложение логики. На панели инструментов конструктора щелкните **Сохранить**. Чтобы свернуть и скрыть сведения о действии в приложении логики, выберите заголовок окна действия.

   ![Сохранение приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-event-grid-save.png)

   При сохранении приложения логики с триггером службы "Сетка событий" Azure автоматически создает подписку на события для приложения логики выбранного ресурса. Таким образом, когда ресурс публикует событие в службе "Сетка событий", она автоматически отправляет это событие в приложение логики. Это событие активирует приложение логики, а затем создает и запускает экземпляр рабочего процесса, который определяется на следующих шагах.

Теперь приложение логики активно и ожидает передачи данных событий службы "Сетка событий". Оно не будет выполнять никаких действий, пока они не будут добавлены в рабочий процесс.

## <a name="add-a-condition"></a>Добавить условие

Чтобы запускать приложение логики только в том случае, когда происходит определенное событие или выполняется определенная операция, добавьте условие, проверяющее наличие операции `Microsoft.Compute/virtualMachines/write`. Если это условие имеет значение true, приложение логики отправляет вам электронное сообщение со сведениями об обновленной виртуальной машине.

1. В конструкторе Logic Apps для триггера Сетки событий выберите **Новый шаг**.

   ![Выбор параметра "Новый шаг"](./media/monitor-virtual-machine-changes-event-grid-logic-app/choose-new-step-condition.png)

1. В разделе **Выберите действие** введите фильтр `condition` в поле поиска. В списке действий выберите действие **Условие**.

   ![Добавить условие](./media/monitor-virtual-machine-changes-event-grid-logic-app/select-condition.png)

   Конструктор Logic Apps добавляет пустое условие в рабочий процесс, включая пути действий для выполнения согласно значениям условия True и False.

   ![Отображается пустое условие](./media/monitor-virtual-machine-changes-event-grid-logic-app/empty-condition.png)

1. Измените заголовок условия на `If a virtual machine in your resource group has changed`. В строке заголовка условия нажмите кнопку многоточия ( **…** ) и выберите **Переименовать**.

   ![Изменение условия](./media/monitor-virtual-machine-changes-event-grid-logic-app/rename-condition.png)

1. Создайте условие, которое проверяет событие `body` на наличие объекта `data`, у которого свойство `operationName` соответствует операции `Microsoft.Compute/virtualMachines/write`. Узнайте больше о [схеме событий службы "Сетка событий"](../event-grid/event-schema.md).

   1. В первой строке в разделе **И** щелкните поле слева. Когда отобразится список динамического содержимого, выберите **Выражение**.

      ![Выбор параметра "Выражение" для открытия редактора выражений](./media/monitor-virtual-machine-changes-event-grid-logic-app/condition-choose-expression.png)

   1. В редакторе выражений введите это выражение, которое возвращает имя операции из триггера, а затем нажмите кнопку **ОК**:

      `triggerBody()?['data']['operationName']`

      Например:

      ![Ввод выражения для извлечения имени операции](./media/monitor-virtual-machine-changes-event-grid-logic-app/condition-add-data-operation-name.png)

   1. В среднем поле укажите для оператора значение **равно**.

   1. В поле справа введите это значение, которое является конкретной операцией для отслеживания:

      `Microsoft.Compute/virtualMachines/write`

   По завершении условие будет выглядеть следующим образом:

   ![Завершенное условие, которое сравнивает операцию](./media/monitor-virtual-machine-changes-event-grid-logic-app/complete-condition.png)

   При переключении из представления конструктора в представление кода и обратно выражение, указанное в условии, преобразуется в токен **data.operationName**:

   ![Разрешенные токены в условии](./media/monitor-virtual-machine-changes-event-grid-logic-app/resolved-condition.png)

1. Сохраните приложение логики.

## <a name="send-email-notifications"></a>Отправка уведомлений по электронной почте

Теперь добавьте [*действие*](../logic-apps/logic-apps-overview.md#logic-app-concepts), чтобы вы могли получать электронное сообщение, когда заданное условие имеет значение true.

1. В поле условия **Если истинно** выберите **Добавить действие**.

   ![Добавление действия для условия со значением true](./media/monitor-virtual-machine-changes-event-grid-logic-app/condition-true-add-action.png)

1. В разделе **Выберите действие** введите фильтр `send an email` в поле поиска. Найдите и выберите соединитель, соответствующий поставщику услуг электронной почты. Затем выберите действие "отправить сообщение" для соединителя. Например:

   * Если у вас рабочая или учебная учетная запись, то выберите соединитель Office 365 Outlook.

   * Для личных учетных записей Майкрософт выберите соединитель Outlook.com.

   * Для учетных записей Gmail выберите соединитель Gmail.

   В рамках этого руководства используется соединитель Office 365 Outlook. Если вы используете другой поставщик, то действия будут аналогичными, но пользовательский интерфейс может немного отличаться.

   ![Выбор действия "отправить сообщение"](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-send-email.png)

1. Если подключение к вашему поставщику услуг электронной почты не установлено, войдите в учетную запись электронной почты в ответ на запрос аутентификации.

1. Измените имя действия отправки письма на следующее: `Send email when virtual machine updated`.

1. Введите данные электронной почты, как показано в указанной ниже таблице:

   ![Предоставление сведений о действии электронной почты](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-empty-email-action.png)

   > [!TIP]
   > Чтобы выбрать выходные данные предыдущих шагов в рабочем процессе, щелкните в поле ввода, чтобы открыть список динамического содержимого, или выберите **Добавить динамическое содержимое**. Выберите **Дополнительно** для каждого раздела в списке, чтобы отобразить дополнительные результаты. Чтобы закрыть список динамического содержимого, снова выберите **Добавить динамическое содержимое**.

   | Свойство | Обязательно | Value | ОПИСАНИЕ |
   | -------- | -------- | ----- | ----------- |
   | **To** | Yes | <*recipient\@domain*> | Введите электронный адрес получателя. Для тестировании можете использовать свой собственный адрес. |
   | **Тема** | Yes | `Resource updated:` **Тема** | Введите содержимое темы электронного сообщения. В рамках этого руководства введите указанный текст и выберите поле события **Тема**. Здесь тема электронного сообщения содержит имя обновленного ресурса (виртуальная машина). |
   | **Текст** | Yes | `Resource:` **Раздел** <p>`Event type:` **Тип события**<p>`Event ID:` **Идентификатор**<p>`Time:` **Время события** | Введите содержимое текста сообщения электронной почты. Для этого учебника введите указанный текст и выберите поля **Раздел**, **Тип события**, **Идентификатор** и **Время события**, чтобы электронное сообщение содержало ресурс, запустивший событие, тип, метку времени и идентификатор события для обновления. В рамках этого учебника ресурсом является группа ресурсов Azure, выбранная в триггере. <p>Чтобы добавить пустые строки в содержимое, нажмите Shift + ВВОД. |
   ||||

   > [!NOTE]
   > Если выбрать поле, которое представляет массив, конструктор автоматически добавит цикл **For each** для действия, которое ссылается на массив. Таким образом приложение логики будет выполнять это действие для каждого элемента массива.

   Теперь действие отправки электронного сообщения может выглядеть следующим образом.

   ![Выбор выходных данных для включения в электронное сообщение](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-send-email-details.png)

   Готовое приложение логики может выглядеть следующим образом:

   ![Готовое приложение логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-completed.png)

1. Сохраните приложение логики. Чтобы свернуть и скрыть сведения о каждом действии в приложении логики, выберите заголовок окна действия.

   Теперь приложение логики активно, но ожидает изменений в виртуальной машине, прежде чем что-либо выполнить. Чтобы проверить приложение логики, перейдите следующему разделу.

## <a name="test-your-logic-app-workflow"></a>Проверка рабочего процесса приложения логики

1. Чтобы проверить, получает ли приложение логики указанные события, обновите виртуальную машину.

   Например, можно изменить размер виртуальной машины на портале Azure или [с помощью Azure PowerShell](../virtual-machines/windows/resize-vm.md).

   Через несколько секунд вы должны получить электронное сообщение. Например:

   ![Электронное сообщение об обновлении виртуальной машины](./media/monitor-virtual-machine-changes-event-grid-logic-app/email.png)

1. Чтобы просмотреть журнал триггера и выполнения приложения логики, в меню приложения выберите **Обзор**. Чтобы просмотреть дополнительные сведения о выполнении, выберите строку для этого выполнения.

   ![Журнал выполнения приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-run-history.png)

1. Чтобы просмотреть входные и выходные данные каждого действия, разверните действие, которое необходимо просмотреть. Эти сведения помогут вам диагностировать и устранить проблемы в приложении логики.

   ![Информация журнала выполнения приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-run-history-details.png)

Поздравляем! Вы создали и запустили приложение логики, которое отслеживает события ресурса с помощью службы "Сетка событий" и отправляет вам электронные сообщения при возникновении этих событий. Вы также узнали, как можно легко создать рабочие процессы, позволяющие автоматизировать и интегрировать системы и облачные службы.

Можно отслеживать другие изменения в конфигурации с помощью сеток событий и приложений логики, например:

* виртуальная машина получает права доступа RBAC (управление доступом на основе ролей);
* вносятся изменения в группу безопасности сети (NSG) сетевого интерфейса;
* добавляются или удаляются диски виртуальной машины;
* сетевому адаптеру виртуальной машины назначается общедоступный IP-адрес.

## <a name="clean-up-resources"></a>Очистка ресурсов

В этом руководстве используются ресурсы и выполняются действия, подлежащие оплате по подписке Azure. Завершив проверку и работу с руководством, обязательно отключите или удалите все ресурсы, за использование которых не имеете намерения платить.

* Чтобы остановить работу приложения логики, не удаляя данные, отключите приложение. В меню приложения логики выберите **Обзор**. На панели инструментов нажмите кнопку **Отключить**.

  ![Отключение приложения логики.](./media/monitor-virtual-machine-changes-event-grid-logic-app/turn-off-disable-logic-app.png)

  > [!TIP]
  > Если меню приложения логики не отображается, попробуйте вернуться к панели мониторинга Azure и повторно откройте приложение логики.

* Чтобы удалить приложение логики без возможности восстановления, в меню приложения логики выберите **Обзор**. На панели инструментов нажмите кнопку **Удалить**. Подтвердите удаление приложения логики и выберите **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

* [Создание и перенаправление пользовательского события при помощи службы "Сетка событий"](../event-grid/custom-event-quickstart.md)
