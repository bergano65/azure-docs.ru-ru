---
title: Учебник по использованию событий Центра Интернета вещей для активации Azure Logic Apps
description: В этом учебнике показано, как использовать службу маршрутизации событий Сетки событий Azure, создавать автоматизированные процессы для выполнения действий Azure Logic Apps на основе событий в Центре Интернета вещей.
services: iot-hub, event-grid
author: philmea
ms.service: iot-hub
ms.topic: tutorial
ms.date: 09/14/2020
ms.author: philmea
ms.custom: devx-track-azurecli
ms.openlocfilehash: 857ae8d824443e9a8abdac7c4a66e2b014be2be0
ms.sourcegitcommit: 04fb3a2b272d4bbc43de5b4dbceda9d4c9701310
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/12/2020
ms.locfileid: "94566356"
---
# <a name="tutorial-send-email-notifications-about-azure-iot-hub-events-using-event-grid-and-logic-apps"></a>Руководство по отправке уведомлений электронной почты о событиях в Центре Интернета вещей Azure с помощью Сетки событий и Logic Apps

Сетка событий Azure позволяет реагировать на события в Центре Интернета вещей путем запуска действий в подчиненных бизнес-приложениях.

В этой статье рассматривается пример конфигурации, в котором используется Центр Интернета вещей и Сетка событий. По завершении работы с этим учебником у вас будет приложение логики Azure, настроенное на отправку уведомлений электронной почты при каждом подключении устройства к центру Интернета вещей или отключении от него. Сетку событий можно использовать для своевременного получения уведомлений о том, что критические устройства отключаются. Отображение метрик и диагностик в журналах или оповещениях может занять несколько (например, 20 или более) минут. Это может быть неприемлемым для критически важной инфраструктуры.

[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

## <a name="prerequisites"></a>Предварительные требования

* Учетная запись электронной почты любого поставщика услуг электронной почты, поддерживаемого Azure Logic Apps, например Office 365 Outlook или Outlook.com. Такая учетная запись используется для отправки уведомлений о событиях.

[!INCLUDE [azure-cli-prepare-your-environment.md](../../includes/azure-cli-prepare-your-environment-no-header.md)]

## <a name="create-an-iot-hub"></a>Создание центра Интернета вещей

Вы можете быстро создать центр Интернета вещей с помощью терминала Azure Cloud Shell на портале.

1. Войдите на [портал Azure](https://portal.azure.com). 

1. В правом верхнем углу страницы нажмите кнопку Cloud Shell.

   ![Кнопка Cloud Shell](./media/publish-iot-hub-events-to-logic-apps/portal-cloud-shell.png)

1. Выполните следующую команду, чтобы создать новую группу ресурсов:

   ```azurecli
   az group create --name {your resource group name} --location westus
   ```
    
1. Выполните следующую команду, чтобы создать центр Интернета вещей:

   ```azurecli
   az iot hub create --name {your iot hub name} --resource-group {your resource group name} --sku S1 
   ```

1. Сверните терминал Cloud Shell. Вы вернетесь к оболочке позже при прохождении этого учебника.

## <a name="create-a-logic-app"></a>Создание приложения логики

Затем создайте приложение логики и добавьте триггер сетки событий HTTP, который обрабатывает запросы из центра Интернета вещей. 

### <a name="create-a-logic-app-resource"></a>Создание ресурса приложения логики

1. На [портале Azure](https://portal.azure.com) выберите **Создать ресурс**, а затем в поле поиска введите "приложение логики" и нажмите клавишу ВВОД. Выберите **Приложение логики** в списке результатов.

   ![Создание приложения логики](./media/publish-iot-hub-events-to-logic-apps/select-logic-app.png)

1. На следующем экране выберите **Создать**. 

1. Присвойте уникальное в вашей подписке имя приложению логики и выберите ту же подписку, группу ресурсов и расположение, которые используются для Центра Интернета вещей. 

   ![Поля для создания приложения логики](./media/publish-iot-hub-events-to-logic-apps/create-logic-app-fields.png)

1. Выберите **Review + create** (Просмотреть и создать).

1. Проверьте параметры и нажмите кнопку **Создать**.

1. Создав новый ресурс, выберите **Перейти к ресурсу**. 

1. В конструкторе Logic Apps прокрутите страницу вниз до раздела **Шаблоны**. Выберите **Пустое приложение логики**. Это позволит создать приложение логики с нуля.

### <a name="select-a-trigger"></a>Выбор триггера

Триггер представляет собой определенное событие, которое запускает приложение логики. В этом руководстве триггер, который инициирует рабочий процесс, получает запрос через HTTP.  

1. На панели поиска триггеров и соединителей введите **HTTP**.

1. Прокрутите результаты и выберите в качестве триггера вариант **Запрос — при получении HTTP-запроса**. 

   ![Выбор триггера запроса HTTP](./media/publish-iot-hub-events-to-logic-apps/http-request-trigger.png)

1. Выберите **Использовать пример полезной нагрузки, чтобы создать схему**. 

   ![Использование примера полезных данных](./media/publish-iot-hub-events-to-logic-apps/sample-payload.png)

1. Вставьте в текстовое поле JSON-файл *схемы события подключения устройства*, а затем нажмите **Готово**.

   ```json
     [{  
      "id": "f6bbf8f4-d365-520d-a878-17bf7238abd8",
      "topic": "/SUBSCRIPTIONS/<subscription ID>/RESOURCEGROUPS/<resource group name>/PROVIDERS/MICROSOFT.DEVICES/IOTHUBS/<hub name>",
      "subject": "devices/LogicAppTestDevice",
      "eventType": "Microsoft.Devices.DeviceConnected",
      "eventTime": "2018-06-02T19:17:44.4383997Z",
      "data": {
          "deviceConnectionStateEventInfo": {
            "sequenceNumber":
              "000000000000000001D4132452F67CE200000002000000000000000000000001"
          },
        "hubName": "egtesthub1",
        "deviceId": "LogicAppTestDevice",
        "moduleId" : "DeviceModuleID"
      }, 
      "dataVersion": "1",
      "metadataVersion": "1"
    }]
   ```

   Это событие публикуется при подключении устройства к центру Интернета вещей.

> [!NOTE]
> Вы можете получить всплывающее уведомление: **Не забудьте включить заголовок Content-Type со значением application/json в запросе.** Можно спокойно проигнорировать это уведомление и перейти к следующему разделу. 

### <a name="create-an-action"></a>Создание действия

Действия представляют собой любые шаги, которые выполняются после запуска триггером рабочего процесса приложения логики. В этом руководстве действием является отправка уведомления электронной почты с помощью поставщика электронной почты. 

1. Выберите **Новый шаг**. Откроется окно **Выберите действие**.

1. Найдите **Outlook**.

1. Найдите и выберите соединитель, соответствующий поставщику услуг электронной почты. В этом руководстве используется **Outlook.com**. Шаги для других поставщиков услуг электронной почты схожи. 

   ![Выбор соединителя поставщика услуг электронной почты](./media/publish-iot-hub-events-to-logic-apps/outlook-step.png)

1. Выберите действие **Отправка электронной почты (V2)**. 

1. Выберите **Войти** и войдите в свою учетную запись электронной почты. Выберите **Да**, чтобы разрешить приложению доступ к вашим сведениям.

1. Создайте шаблон сообщения электронной почты. 

   * **Кому**. Введите адрес электронной почты для получения уведомлений по электронной почте. В этом уроке используйте учетную запись электронной почты, к которой у вас есть доступ для тестирования. 

   * **Субъект**: Введите текст для темы. Если щелкнуть текстовое поле "Тема", можно выбрать динамическое содержимое, которое будет добавлено. Например, в этом учебнике используется `IoT Hub alert: {eventType}`. Если динамическое содержимое не отображается, выберите гиперссылку **Добавить динамическое содержимое**. Этот элемент включает и выключает окно динамического содержимого.

   * **Текст**: Введите текст сообщения электронной почты. В инструменте выбора щелкните свойства JSON для включения динамического содержимого на основе данных событий. Если динамическое содержимое не отображается, выберите гиперссылку **Добавить динамическое содержимое** в текстовом поле **Текст**. Если нужные поля не отображаются, щелкните *Дополнительно* на экране динамического содержимого, чтобы включить поля из предыдущего действия.

   Ваш шаблон электронной почты может выглядеть следующим образом:

   ![Заполнение сведений для сообщения электронной почты](./media/publish-iot-hub-events-to-logic-apps/email-content.png)

1. В конструкторе Logic Apps выберите **Сохранить**.  

### <a name="copy-the-http-url"></a>Копирование URL-адреса HTTP

Скопируйте для триггера URL-адрес, который прослушивают приложения логики, а затем закройте конструктор Logic Apps. Этот URL-адрес вы используете для настройки сетки событий. 

1. Щелкните поле конфигурации триггера **При получении HTTP-запроса**, чтобы развернуть его. 

1. Скопируйте значение **URL-адрес HTTP POST**, нажав кнопку копирования рядом с этим параметром. 

   ![Копирование URL-адреса HTTP POST](./media/publish-iot-hub-events-to-logic-apps/copy-url.png)

1. Сохраните этот URL-адрес, чтобы использовать его в следующем разделе. 

## <a name="configure-subscription-for-iot-hub-events"></a>Настройка подписки на события Центра Интернета вещей

В этом разделе вы настроите Центр Интернета вещей для публикации событий по мере их появления. 

1. Найдите нужный Центр Интернета вещей на портале Azure. Это можно сделать, выбрав **Группы ресурсов**. Затем выберите группу ресурсов для этого учебника, а после этого — центр Интернета вещей в списке ресурсов.

1. Выберите **События**.

   ![Открытие сведений сетки событий](./media/publish-iot-hub-events-to-logic-apps/event-grid.png)

1. Выберите **Подписка на события**. 

   ![Создание подписки на события](./media/publish-iot-hub-events-to-logic-apps/event-subscription.png)

1. Создайте подписку на события со следующими значениями: 

   1. В разделе **СВЕДЕНИЯ О ПОДПИСКЕ НА СОБЫТИЯ**:
      1. Укажите **имя** подписки на события. 
      2. Для пункта **Схема событий** выберите **Схема сетки событий**. 
   2. В разделе **СВЕДЕНИЯ О РАЗДЕЛЕ**:
      1. Убедитесь, что для **типа раздела** задано значение **Центр Интернета вещей**. 
      2. Убедитесь, что имя центра Интернета вещей задано в качестве значения поля **Исходный ресурс**. 
      3. Введите имя **системного раздела**, который будет создан. См. [общие сведения о системных разделах](system-topics.md).
   3. В разделе **ТИПЫ СОБЫТИЙ**:
      1. Выберите раскрывающийся список **Filter to Event Types** (Фильтровать по типам событий).
      1. Снимите флажки с полей **Устройство создано** и **Устройство удалено**, в результате чего выбранными останутся только поля **Устройство подключено** и **Устройство отключено**.

         ![выбор типов событий подписки](./media/publish-iot-hub-events-to-logic-apps/subscription-event-types.png)
   
   4. В разделе **СВЕДЕНИЯ О КОНЕЧНОЙ ТОЧКЕ**: 
       1. Выберите **веб-перехватчик** в качестве **типа конечной точки**.
       2. Нажмите **Выбрать конечную точку**, вставьте URL-адрес, скопированный из приложения логики, и подтвердите выбор.

         ![Выбор URL-адреса конечной точки](./media/publish-iot-hub-events-to-logic-apps/endpoint-webhook.png)

         По завершении панель должна выглядеть следующим образом: 

         ![Пример формы подписки на события](./media/publish-iot-hub-events-to-logic-apps/subscription-form.png)

1.  Нажмите кнопку **создания**.

## <a name="simulate-a-new-device-connecting-and-sending-telemetry"></a>Имитация подключения нового устройства и отправки с него телеметрии

Протестируйте приложение логики, быстро сымитировав подключение устройства с помощью Azure CLI. 

1. Нажмите кнопку Cloud Shell, чтобы снова открыть терминал.

1. Выполните приведенную ниже команду, чтобы создать удостоверение имитированного устройства:
    
     ```azurecli 
    az iot hub device-identity create --device-id simDevice --hub-name {YourIoTHubName}
    ```

1. Выполните следующую команду, чтобы имитировать подключение устройства к Центру Интернета вещей и отправку данных телеметрии:

    ```azurecli
    az iot device simulate -d simDevice -n {YourIoTHubName}
    ```

1. При подключении имитированного устройства к Центру Интернета вещей вы получите сообщение электронной почты с уведомлением о событии "DeviceConnected".

1. После завершения имитации вы получите сообщение электронной почты с уведомлением о событии "DeviceDisconnected". 

    ![Пример сообщения электронной почты с оповещением](./media/publish-iot-hub-events-to-logic-apps/alert-mail.png)

## <a name="clean-up-resources"></a>Очистка ресурсов

В этом руководстве используются ресурсы, за которые в подписке Azure предусмотрена плата. По завершении работы с этим учебником и тестирования результатов отключите или удалите ресурсы, которые больше не нужны. 

Чтобы удалить все ресурсы, которые были созданы в этом учебнике, удалите группу ресурсов. 

1. Выберите **Группы ресурсов**, а затем созданную для этого учебника группу ресурсов.

2. На панели группы ресурсов выберите **Удалить группу ресурсов**. Вам будет предложено ввести имя группы ресурсов, после чего его можно будет удалить. Все содержащиеся там ресурсы также будут удалены.

## <a name="next-steps"></a>Дальнейшие действия

* Узнайте больше о [реагировании на события в Центре Интернета вещей, используя службу "Cетка событий" для запуска действий](../iot-hub/iot-hub-event-grid.md).
* См. дополнительные сведения об [упорядочении событий подключения и отключения устройств](../iot-hub/iot-hub-how-to-order-connection-state-events.md).
* Узнайте о дополнительных возможностях службы [Сетка событий](overview.md).

Полный список поддерживаемых соединителей для приложения логики см. в статье [Соединители](/connectors/).
