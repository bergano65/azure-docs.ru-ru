---
title: Как работает настройка кластера для Azure Dev Spaces
services: azure-dev-spaces
ms.date: 03/24/2020
ms.topic: conceptual
description: Узнайте, как работает настройка кластера Службы Azure Kubernetes для Azure Dev Spaces
keywords: Azure Dev Spaces, Dev Spaces, Docker, Kubernetes, Azure, AKS, Служба Azure Kubernetes, контейнеры
ms.openlocfilehash: 841e67b96e95aa251fa5bf1ef469b68de30f54d9
ms.sourcegitcommit: d103a93e7ef2dde1298f04e307920378a87e982a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/13/2020
ms.locfileid: "91972685"
---
# <a name="how-setting-up-a-cluster-for-azure-dev-spaces-works"></a>Как работает настройка кластера для Azure Dev Spaces

[!INCLUDE [Azure Dev Spaces deprecation](../../includes/dev-spaces-deprecation.md)]

Azure Dev Spaces предоставляет несколько способов быстро перебора и отладки приложений Kubernetes, а также совместной работы в кластере Службы Azure Kubernetes (AKS). Один из этих способов — включить Azure Dev Spaces для кластера AKS, чтобы [выполнять службы непосредственно в кластере][how-it-works-up] и [использовать дополнительные возможности сети и маршрутизации][how-it-works-routing]. В этой статье описывается, что происходит при подготовке кластера и включении Azure Dev Spaces.

## <a name="prepare-your-aks-cluster"></a>Подготовка кластера AKS

Чтобы подготовить кластер AKS для Dev Spaces, такой кластер AKS должен находиться в [поддерживаемом для Azure Dev Spaces регионе][supported-regions] и работать под управлением Kubernetes 1.10.3 или более поздней версии. Вы можете включить Azure Dev Spaces из Azure CLI, выполнив `az aks use-dev-spaces` .

При включении Azure Dev Spaces в кластере AKS устанавливается контроллер для кластера. Этот контроллер находится за пределами кластера AKS. Он управляет поведением средств на стороне клиента и их взаимодействием с кластером AKS. После включения контроллера вы сможете взаимодействовать с ним, используя клиентские средства.

Этот контроллер выполняет следующие действия:

* управляет созданием и выбором пространства разработки;
* устанавливает чарт Helm для приложения и создает объекты Kubernetes;
* создает образ контейнера для приложения;
* развертывает приложение в AKS;
* выполняет добавочные сборки и перезапускается при изменении исходного кода;
* управляет журналами и трассировками HTTP;
* перенаправляет выводы stdout и stderr на клиентские средства;
* настраивает маршрутизацию для приложений в пределах пространства, а также между родительскими и дочерними пространствами.

Контроллер — это отдельный ресурс Azure, который располагается за пределами кластера и выполняет следующие действия для ресурсов в кластере:

* создает или назначает пространство имен Kubernetes для использования в качестве пространства разработки;
* удаляет существующее пространство имен Kubernetes с именем *azds*, если оно есть, и создает новое;
* развертывает конфигурацию веб-перехватчиков для Kubernetes;
* развертывает сервер допуска веб-перехватчиков.

Он использует тот же субъект-службу, что и кластер AKS, чтобы выполнять вызовы служб к другим компонентам Azure Dev Spaces.

![Подготовка кластера для Azure Dev Spaces](media/how-dev-spaces-works/prepare-cluster.svg)

Чтобы использовать Azure Dev Spaces, нужно иметь хотя бы одно пространство разработки. Azure Dev Spaces использует для пространств разработки пространства имен Kubernetes в кластере AKS. При установке контроллера система предлагает создать новое пространство имен Kubernetes или выбрать существующее. Оно будет использоваться в качестве первого пространства разработки. По умолчанию контроллер предлагает обновить существующее пространство имен Kubernetes *default*, назначив его первым пространством разработки.

После назначения одного из пространств имен пространством разработки контроллер добавляет к нему метку *azds.io/space=true*, чтобы обозначить его как пространство разработки. Начальное пространство разработки, которое вы создаете или назначаете, выбирается по умолчанию после подготовки кластера. Выбранное пространство используется службой Azure Dev Spaces для создания новых рабочих нагрузок.

С помощью клиентских средств вы можете создавать новые пространства разработки и удалять существующие. Из-за ограничений, действующих в Kubernetes, пространство разработки *default* удалить невозможно. Контроллер также удаляет существующие пространства имен Kubernetes с именем *azds*, чтобы не возникало конфликтов с командой `azds`, которую используют клиентские средства.

Сервер допуска веб-перехватчиков Kubernetes используется для вставки в группы pod во время развертывания трех контейнеров для инструментирования: devspaces-proxy, devspaces-proxy-init и devspaces-build. **Все три эти контейнера работают в кластере AKS с правами root.** Также они используют тот же субъект-службу, что и кластер AKS, чтобы выполнять вызовы служб к другим компонентам Azure Dev Spaces.

![Сервера допуска веб-перехватчиков Kubernetes для Azure Dev Spaces](media/how-dev-spaces-works/kubernetes-webhook-admission-server.svg)

Контейнер расширения devspaces-proxy обрабатывает весь входящий и исходящий трафик TCP для контейнера приложения, а также помогает организовать маршрутизацию. Этот контейнер перенаправляет сообщения HTTP, когда используются определенные пространства. Например, он может поддерживать передачу HTTP-сообщений между приложениями, размещенными в родительском и дочернем пространствах. Трафик других протоколов, кроме HTTP, проходит через devspaces-proxy без изменений. Контейнер devspaces-proxy также регистрирует все входящие и исходящие HTTP-сообщения и отправляет их в клиентские средства в формате трассировок. Разработчик может просматривать эти трассировки, чтобы проверить работу приложения.

Контейнер devspaces-proxy-init выполняет роль [контейнера инициализации](https://kubernetes.io/docs/concepts/workloads/pods/init-containers/), который добавляет в контейнер приложения дополнительные правила маршрутизации на основе иерархии пространств. Для добавления правил маршрутизации он перед запуском обновляет файл */etc/resolv.conf* в контейнере приложений и конфигурацию iptables. Обновления в */etc/resolv.conf* требуются, чтобы включить разрешение имен DNS для служб в родительских пространствах. Обновления конфигурации iptables гарантируют, что весь входящий и исходящий TCP-трафик контейнера приложения направляется через devspaces-proxy. Все обновления, вносимые из devspaces-proxy-init, являются дополнениями к правилам, которые добавляет служба Kubernetes.

Контейнер devspaces-build также является контейнером инициализации. Он имеет доступ к исходному коду проекта и сокету Docker. Благодаря этому pod может самостоятельно создавать контейнер приложения.

> [!NOTE]
> Azure Dev Spaces использует один и тот же узел для создания и запуска контейнера приложения. В итоге для Azure Dev Spaces не требуется внешний реестр контейнеров для сборки и запуска приложения.

Сервер допуска веб-перехватчиков Kubernetes прослушивает все новые pod, создаваемые в кластере AKS. Если в каком-либо пространстве имен развертывается группа pod с меткой *azds.io/space=true*, он внедряет в нее дополнительные контейнеры. Контейнер devspaces-build внедряется, только если контейнер приложения выполняется с использованием клиентских средств.

После подготовки кластера AKS вы сможете использовать клиентские средства для подготовки и выполнения кода в пространстве разработки.

## <a name="client-side-tooling"></a>Клиентские средства

Клиентские средства позволяют пользователю выполнять следующее:
* создавать Dockerfile, чарт Helm и файл конфигурации Azure Dev Spaces для приложения;
* создавать родительские и дочерние пространства разработки;
* сообщать контроллеру о необходимости собрать и запустить приложение.

Кроме того, пока приложение работает, клиентские средства выполняют следующее:
* получают и отображают выводы stdout и stderr от приложения, работающего в AKS;
* используют [перенаправление портов](https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/), чтобы поддерживать доступ к приложению из браузера по адресу http:\//localhost;
* присоединяют отладчик к приложению, выполняющемуся в AKS;
* синхронизируют исходный код с пространством разработки, когда обнаруживаются изменения для добавочных сборок, что позволяет быстро выполнять итерации разработки;
* поддерживают подключение компьютера разработчика напрямую к кластеру AKS.

Клиентские средства можно выполнять из командной строки в составе команды `azds`. Также клиентские средства можно использовать в сочетании со следующими платформами:

* Visual Studio Code с расширением [Azure Dev Spaces](https://marketplace.visualstudio.com/items?itemName=azuredevspaces.azds);
* Visual Studio с рабочей нагрузкой разработки для Azure.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об использовании клиентских средств для подготовки и выполнения кода в пространстве разработки см. в статье [Как готовится проект для Azure Dev Spaces][how-it-works-prep].


[how-it-works-prep]: how-dev-spaces-works-prep.md
[how-it-works-routing]: how-dev-spaces-works-routing.md
[how-it-works-up]: how-dev-spaces-works-up.md
[supported-regions]: https://azure.microsoft.com/global-infrastructure/services/?products=kubernetes-service