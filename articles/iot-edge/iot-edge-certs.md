---
title: Сертификаты для безопасности устройств в Azure IoT Edge | Документация Майкрософт
description: Azure IoT Edge использует сертификаты для проверки устройств, модулей и конечных устройств, а также для создания безопасных соединений между ними.
author: stevebus
manager: philmea
ms.author: stevebus
ms.date: 09/13/2018
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 91cde6965f3635d6d2acfaf581f570779020f8ff
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "60445321"
---
# <a name="azure-iot-edge-certificate-usage-detail"></a>Сведения об использовании сертификатов Azure IoT Edge

Сертификаты IoT Edge используются модулями и нижестоящими устройствами Интернета вещей для проверки подлинности и законности модуля среды выполнения [центра IoT Edge](iot-edge-runtime.md#iot-edge-hub), к которому они подключаются. Эта проверка позволяет устанавливать безопасные соединения TLS между средой выполнения, модулями и устройствами Интернета вещей. Так же как и сам центр Интернета вещей, служба IoT Edge требует безопасных и зашифрованных подключений со стороны нижестоящих (конечных) устройств Интернета вещей и модулей IoT Edge. Для установления безопасного TLS-подключения модуль центра IoT Edge представляет подключающимся клиентам цепочку сертификатов сервера, чтобы они могли проверить его удостоверение.

В этой статье объясняется, как сертификаты IoT Edge могут работать в сценариях в рабочей среде, а также в сценариях разработки и тестирования. Хотя скрипты для Linux и Windows разные (PowerShell и bash), принципы их действия одинаковы.

## <a name="iot-edge-certificates"></a>Сертификаты IoT Edge

Производители обычно не являются пользователями устройства IoT Edge. Иногда единственное отношение между ними — когда пользователь (оператор) приобретает универсальное устройство, изготовленное производителем. В других случаях изготовитель создает пользовательское устройство по заказу оператора. При проектировании сертификатов IoT Edge учитывались оба сценария.

На рисунке ниже иллюстрируется использование сертификатов в IoT Edge. Между сертификатом корневого ЦС и сертификатом ЦС устройства может быть ноль, один или несколько промежуточных сертификатов для подписи, в зависимости от количества связанных сущностей. Здесь мы покажем один вариант.

![Схема типичных связей между сертификатами](./media/iot-edge-certs/edgeCerts-general.png)

### <a name="certificate-authority"></a>Центр сертификации

Центр сертификации (ЦС) — это организация, выдающая цифровые сертификаты. Он выступает в роли надежной третьей стороны между владельцем и получателем сертификата. Цифровой сертификат удостоверяет принадлежность открытого ключа получателю сертификата. Цепочка доверия сертификатов начинается с первоначальной выдачи корневого сертификата, который является основой доверия ко всем сертификатам, выдаваемым центром. В дальнейшем владелец может использовать корневой сертификат для выдачи дополнительных промежуточных сертификатов.

### <a name="root-ca-certificate"></a>Корневой сертификат ЦС

Корневой сертификат ЦС является основой доверия в рамках всего процесса. В рабочих сценариях этот сертификат ЦС обычно приобретается в надежном коммерческом центре сертификации, например Baltimore, Verisign или DigiCert. Если вам нужен полный контроль над устройствами, подключающимися к вашим устройствам IoT Edge, можно использовать центр сертификации корпоративного уровня. В любом случае вся цепочка сертификатов из центра IoT Edge сводится к нему, поэтому конечные устройства Интернета вещей должны доверять корневому сертификату. Корневой сертификат ЦС можно либо хранить в надежном хранилище корневого центра сертификации, либо предоставлять сведения о нем в коде приложения.

### <a name="intermediate-certificates"></a>Промежуточные сертификаты

При изготовлении защищенных устройств корневые центры ЦС редко используются напрямую, в первую очередь из-за риска утечки или нарушения безопасности. Корневой сертификат ЦС создает и подписывает один или несколько промежуточных сертификатов ЦС. Промежуточный сертификат может быть один, либо они могут составлять цепочку. Цепочка промежуточных сертификатов может потребоваться в следующих ситуациях:

* иерархия отделов в компании-производителе;

* в изготовлении устройства последовательно участвуют несколько компаний;

* клиент покупает корневой сертификат ЦС и получает на его основе сертификат для подписи, с помощью которого изготовитель подписывает устройства, создаваемые по заказу этого клиента.

В любом случае изготовитель использует промежуточный сертификат ЦС в конце этой цепочки для подписи сертификата ЦС устройства, размещаемого на конечном устройстве. Как правило, эти промежуточные сертификаты тщательно охраняются на заводе-изготовителе. Их использование строго контролируется с помощью физических и электронных процессов.

### <a name="device-ca-certificate"></a>Сертификат ЦС устройства

Сертификат ЦС устройства создается на основе последнего промежуточного сертификата ЦС в цепочке и подписывается с его помощью. Он устанавливается на самом устройстве IoT Edge, как правило, в безопасном хранилище, например в аппаратном модуле безопасности (HSM). Кроме того, сертификат ЦС устройства уникальным образом идентифицирует устройство IoT Edge. Для IoT Edge сертификат ЦС устройства может выдавать другие сертификаты. Например, сертификат ЦС устройства выдает сертификаты конечных устройств, которые служат для проверки подлинности устройств в [Службе подготовки устройств к добавлению в Центр Интернета вещей Azure](../iot-dps/about-iot-dps.md).

### <a name="iot-edge-workload-ca"></a>Сертификат ЦС рабочей нагрузки IoT Edge

[Диспетчер безопасности IoT Edge](iot-edge-security-manager.md) создает сертификат ЦС рабочей нагрузки, являющийся первым на стороне оператора при первом запуске IoT Edge. Он создается на основе сертификата ЦС устройства и подписывается с его помощью. Этот сертификат, являющийся одним из промежуточных сертификатов для подписи, служит для создания и подписи всех остальных сертификатов, используемых средой выполнения IoT Edge. На настоящий момент именно этому сертификату сервера центра IoT Edge посвящен следующий раздел, однако в будущем к нему могут добавиться другие сертификаты, служащие для проверки подлинности компонентов IoT Edge.

### <a name="iot-edge-hub-server-certificate"></a>Сертификат сервера центра IoT Edge

Сертификат сервера центра IoT Edge — это тот сертификат, который предоставляется конечным устройствам и модулям для проверки удостоверения во время установления TLS-подключения, которое требуется IoT Edge. В этом сертификате представлена полная цепочка сертификатов для подписи, с помощью которой он создается, вплоть до корневого сертификата ЦС, которому должны доверять конечные устройства Интернета вещей. При создании с помощью диспетчера безопасности IoT Edge в качестве общего имени (CN) этого сертификата центра IoT Edge задается свойство hostname в файле config.yaml после преобразования в нижний регистр. Из-за этого в IoT Edge часто возникает путаница.

## <a name="production-implications"></a>Применение в рабочей среде

Может возникнуть резонный вопрос: "Зачем в IoT Edge нужен дополнительный сертификат ЦС рабочей нагрузки? Разве нельзя использовать сертификат ЦС устройства, чтобы напрямую создать сертификат сервера центра IoT Edge?" С технической точки зрения можно. Однако назначение этого промежуточного сертификата рабочей нагрузки в том, чтобы разделить функции изготовителя и оператора устройства. Представьте себе ситуацию, когда устройство IoT Edge продается или передается одним клиентом другому. Скорее всего, нужно, чтобы сертификат ЦС устройства, предоставленный изготовителем, оставался неизменным. Однако сертификаты рабочей нагрузки, связанные с эксплуатацией устройства, должны быть очищены и созданы повторно для новой среды.

Так как процессы производства и работы разделены, рассмотрите следующие последствия при подготовке устройств для рабочей среды:

* Так же как и в рамках любого процесса на основе сертификатов, корневой сертификат ЦС и все промежуточные сертификаты ЦС должны защищаться и отслеживаться в течение всего процесса развертывания устройства IoT Edge. Изготовитель устройства IoT Edge должен реализовать надлежащие процессы для безопасного хранения и использования своих промежуточных сертификатов. Кроме того, сертификат ЦС устройства должен храниться в максимально безопасном хранилище на самом устройстве, желательно в аппаратном модуле безопасности.

* Сертификат сервера центра IoT Edge предоставляется центром IoT Edge подключающимся клиентским устройствам и модулям. Общее имя (CN) сертификата ЦС устройства **не должно** совпадать со значением "hostname" в файле config.yaml на устройстве IoT Edge. Имя, используемое клиентами для подключения к IoT Edge (например, с помощью параметра GatewayHostName в строке подключения или команды CONNECT в MQTT), **не может** совпадать с общим именем в сертификате ЦС устройства. Ограничение в том, что центр IoT Edge предоставляет всю цепочку сертификатов на проверку клиентам. Если сертификат сервера центра IoT Edge и сертификат ЦС устройства имеет одинаковое общее имя, проверка зацикливается и сертификат становится недействительным.

* Так как сертификат ЦС устройства используется управляющей программой безопасности IoT Edge для создания окончательных сертификатов IoT Edge, он сам должен являться сертификатом для подписи, то есть иметь возможность подписывать другие сертификаты. Примените параметр "V3 Basic constraints CA:True". В результате будут автоматически настроены необходимые основные свойства использования.

>[!Tip]
> Если вы уже настроили IoT Edge в качестве прозрачного шлюза в сценарии разработки или тестирования с помощью вспомогательных скриптов (см. следующий раздел) и использовали при создании сертификата ЦС устройства то же имя узла, что и для свойства hostname в файле config.yaml, вам может быть интересно узнать, почему не возникло проблем. Чтобы упростить работу разработчиков, вспомогательные скрипты добавляют ".ca" в конце передаваемого в них имени. Например, если вы использовали строку "mygateway" в качестве имени устройства в скриптах и значения свойства hostname в файле config.yaml, имя устройства будет преобразовано в "mygateway.ca" перед использованием в качестве общего имени в сертификате ЦС устройства.

## <a name="devtest-implications"></a>Применение в среде разработки или тестирования

Чтобы упростить разработку и тестирование, корпорация Майкрософт предоставляет набор [вспомогательных скриптов](https://github.com/Azure/azure-iot-sdk-c/tree/master/tools/CACertificates) для создания сертификатов, не предназначенных для рабочей среды. Они подходят для IoT Edge в сценарии прозрачного шлюза. Чтобы узнать, как работают эти сценарии, ознакомьтесь с примерами в статье [Configure an IoT Edge device to act as a transparent gateway](how-to-create-transparent-gateway.md) (Настройка устройства IoT Edge для использования в качестве прозрачного шлюза).

Эти скрипты создают сертификаты с соблюдением структуры цепочки сертификатов, описанной в этой статье. Следующие команды создают корневой сертификат ЦС и один промежуточный сертификат ЦС:

```bash
./certGen.sh create_root_and_intermediate 
```

```Powershell
New-CACertsCertChain rsa 
```

Аналогичным образом, эти команды создают сертификат ЦС устройства:

```bash
./certGen.sh create_edge_device_certificate "<gateway device name>"
```

```Powershell
New-CACertsEdgeDevice "<gateway device name>"
```

* **\<Имя устройства шлюза\>** , передаваемое в эти скрипты, **не должно** совпадать со значением параметра hostname в файле config.yaml. Чтобы помочь вам избежать проблем, скрипты добавляют строку ".ca" к **\<имени устройства шлюза\>** . Это позволяет предотвратить конфликт имен, когда при настройке IoT Edge пользователь указывает одно и то же имя в обоих местах. Однако все же рекомендуется не использовать одинаковые имена.

>[!Tip]
> Чтобы подключить конечные устройства и приложения Интернета вещей, использующие наш пакет SDK для устройств Интернета вещей, к IoT Edge, необходимо добавить дополнительный параметр GatewayHostName в конце строки подключения устройства. При создании сертификата сервера центра Edge используется значение свойства hostname из файла config.yaml, преобразованное в нижний регистр. Поэтому, чтобы имена совпадали и проверка TLS-сертификата завершилась успешно, значение параметра GatewayHostName следует вводить в нижнем регистре.

## <a name="example-of-iot-edge-certificate-hierarchy"></a>Пример иерархии сертификатов IoT Edge

Ниже представлен пример рабочего устройства IoT Edge, настроенного в качестве прозрачного шлюза, который иллюстрирует цепочку сертификатов. Для подключения к центру IoT Edge, проверки сертификатов и их выгрузки используется протокол OpenSSL.

![Снимок экрана иерархии сертификатов на каждом уровне](./media/iot-edge-certs/iotedge-cert-chain.png)

На этом снимке экрана представлена полная иерархия сертификатов:

| Корневой сертификат ЦС         | Сертификат ЦС центра Интернета вещей Azure только для тестирования                                                                           |
|-----------------------------|-----------------------------------------------------------------------------------------------------------|
| Промежуточный сертификат ЦС | Промежуточный сертификат центра Интернета вещей Azure только для тестирования                                                                 |
| Сертификат ЦС устройства       | iotgateway.ca (строка "iotgateway" была передана во вспомогательные скрипты в качестве имени узла шлюза)      |
| Сертификат ЦС рабочей нагрузки     | iotedge workload ca                                                                                       |
| Сертификат сервера центра IoT Edge | iotedgegw.local (соответствует значению свойства hostname в файле config.yaml)                                                |

## <a name="next-steps"></a>Дальнейшие действия

[Общие сведения о модулях IoT Edge Azure](iot-edge-modules.md)

[Настройка устройства IoT Edge для использования в качестве прозрачного шлюза](how-to-create-transparent-gateway.md)