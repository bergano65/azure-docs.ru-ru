---
title: Руководство по отправке данных устройства через прозрачный шлюз — Машинное обучение в Azure IoT Edge
description: В этом учебнике показано, как можно использовать свой компьютер для разработки в качестве имитированного устройства IoT Edge, чтобы отправлять данные в Центр Интернета вещей через устройство, настроенное в качестве прозрачного шлюза.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 11/12/2019
ms.topic: tutorial
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 50f339b257110f0a5dc0ac08b9f40043ee384afb
ms.sourcegitcommit: c69c8c5c783db26c19e885f10b94d77ad625d8b4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/03/2019
ms.locfileid: "74706910"
---
# <a name="tutorial-send-data-via-transparent-gateway"></a>Руководство по отправке данных через прозрачный шлюз

> [!NOTE]
> Эта статья входит в серию учебников по использованию Машинного обучения Azure в IoT Edge. Если вы перешли на эту статью по прямой ссылке, для оптимальных результатов мы рекомендуем начать с изучения [первой статьи](tutorial-machine-learning-edge-01-intro.md) этой серии.

В этой статье мы снова используем компьютер для разработки в качестве имитированного устройства, но вместо отправки данных непосредственно в Центр Интернета вещей устройство отправляет данные на устройство IoT Edge, настроенное в качестве прозрачного шлюза.

Пока имитированное устройство отправляет данные, мы отслеживаем работу устройства IoT Edge. По завершении работы устройства мы изучаем данные в вашей учетной записи хранения, чтобы убедиться, что все работает должным образом.

Этот шаг обычно выполняет разработчик облака или устройства.

## <a name="review-device-harness"></a>Просмотр окружения устройства

Повторно воспользуйтесь [проектом DeviceHarness](tutorial-machine-learning-edge-03-generate-data.md), чтобы сымитировать подчиненное (или конечное) устройство. Для подключения к прозрачному шлюзу требуется два дополнительных действия:

* Зарегистрируйте сертификат, чтобы подчиненное устройство (в данном случае наш компьютер для разработки) доверяло центру сертификации, который используется средой выполнения IoT Edge.
* Добавьте полное доменное имя (FQDN) пограничного шлюза в строку подключения устройства.

Взгляните на код, чтобы увидеть, как реализованы эти два элемента.

1. Откройте Visual Studio Code на компьютере для разработки.

2. Выберите **Файл** > **Открыть папку...** , чтобы открыть C:\\source\\IoTEdgeAndMlSample\\DeviceHarness.

3. Рассмотрим метод InstallCertificate() в файле Program.cs.

4. Обратите внимание, что если код находит путь к сертификату, он вызывает метод CertificateManager.InstallCACert для установки сертификата на компьютере.

5. Теперь рассмотрим метод GetIotHubDevice класса TurbofanDevice.

6. Когда пользователь указывает FQDN шлюза с помощью параметра "-g", значение передается в этот метод как параметр gatewayFqdn, который добавляется в строку подключения устройства.

   ```csharp
   connectionString = $"{connectionString};GatewayHostName={gatewayFqdn.ToLower()}";
   ```

## <a name="build-and-run-leaf-device"></a>Сборка и запуск конечного устройства

1. Оставив открытым проект DeviceHarness в Visual Studio Code, создайте проект (Ctrl + Shift + B или **Терминал** > **Выполнить задачу сборки...** ) и выберите **Сборка** в диалоговом окне.

2. Найдите FQDN для пограничного шлюза, перейдя к виртуальной машине устройства IoT Edge на портале и скопировав значение для параметра **DNS-имя** из обзора.

3. Откройте терминал Visual Studio Code (**Терминал** > **Новый терминал**) и выполните следующую команду, заменив `<edge_device_fqdn>` DNS-именем, скопированным из виртуальной машины:

   ```cmd
   dotnet run -- --gateway-host-name "<edge_device_fqdn>" --certificate C:\edgecertificates\certs\azure-iot-test-only.root.ca.cert.pem --max-devices 1
   ```

4. Приложение попытается установить сертификат на компьютере для разработки. Когда это произойдет, примите предупреждение системы безопасности.

5. При появлении запроса на строку подключения Центра Интернета вещей нажмите кнопку с многоточием ( **...** ) на панели устройств Центра Интернета вещей Azure и выберите **Copy IoT Hub Connection String** (Копировать строку подключения Центра Интернета вещей). Вставьте значение в терминал.

6. Результат должен выглядеть так:

   ```output
   Found existing device: Client_001
   Using device connection string: HostName=<your hub>.azure-devices.net;DeviceId=Client_001;SharedAccessKey=xxxxxxx; GatewayHostName=iotedge-xxxxxx.<region>.cloudapp.azure.com
   Device: 1 Message count: 50
   Device: 1 Message count: 100
   Device: 1 Message count: 150
   Device: 1 Message count: 200
   Device: 1 Message count: 250
   ```

   Обратите внимание на добавление элемента "GatewayHostName" в строку подключения устройства, что приводит к взаимодействию устройства через Центр Интернета вещей через прозрачный шлюз IoT Edge.

## <a name="check-output"></a>Проверка выходных данных

### <a name="iot-edge-device-output"></a>Выходные данные устройства IoT Edge

Выходные данные из модуля avroFileWriter можно легко увидеть на устройстве IoT Edge.

1. Подключитесь к виртуальной машине IoT Edge по протоколу SSH.

2. Найдите файлы, записанные на диск.

   ```bash
   find /data/avrofiles -type f
   ```

3. Выходные данные команды будет выглядеть, как в следующем примере.

   ```output
   /data/avrofiles/2019/4/18/22/10.avro
   ```

   У вас может быть несколько файлов в зависимости от времени выполнения.

4. Обратите внимание на метки времени. Модуль avroFileWriter передаст файлы в облако, как только после последнего изменения пройдет более 10 минут (см. MODIFIED\_FILE\_ в файле uploader.py в модуле avroFileWriter).

5. После истечения 10 минут модуль должен передать файлы. Если передача завершена успешно, он удаляет файлы с диска.

### <a name="azure-storage"></a>Хранилище Azure

Мы можем просмотреть результаты того, как наше конечное устройство отправляет данные, проверив учетные записи хранения, в которые должны быть перенаправлены данные.

1. Откройте Visual Studio Code на компьютере для разработки.

2. На панели "Хранилище Azure" в окне "Просмотр" перейдите по дереву, чтобы найти свою учетную запись хранения.

3. Разверните узел **Контейнеры**.

4. Выполнив работу, проделанную нами в предыдущей части учебника, мы ожидаем, что в контейнере **ruldata** должны содержаться сообщения с оставшимся сроком полезного использования. Разверните узел **ruldata**.

5. Вы увидите один или несколько файлов больших двоичных объектов с таким именем, как: `<IoT Hub Name>/<partition>/<year>/<month>/<day>/<hour>/<minute>`.

6. Щелкните один из файлов правой кнопкой мыши и выберите **Download Blob** (Скачать большой двоичный объект), чтобы сохранить файл на свой компьютер для разработки.

7. Далее разверните узел **uploadturbofanfiles**. В предыдущей статье мы задали это расположение в качестве целевого для файлов, переданных модулем avroFileWriter.

8. Щелкните файлы правой кнопкой и выберите **Download Blob** (Скачать большой двоичный объект), чтобы сохранить его на свой компьютер для разработки.

### <a name="read-avro-file-contents"></a>Чтение содержимого файла Avro

Мы включили простую программу командной строки для считывания файла Avro и возврата строки JSON сообщений в файле. В этом разделе мы установим и запустим его.

1. Откройте терминал в Visual Studio Code (**Терминал** > **Новый терминал**).

2. Установите hubavroreader.

   ```cmd
   pip install c:\source\IoTEdgeAndMlSample\HubAvroReader
   ```

3. Используйте hubavroreader для чтения файла Avro, скачанного из **ruldata**.

   ```cmd
   hubavroreader <avro file with ath> | more
   ```

4. Обратите внимание на то, что текст сообщения выглядит так, как мы предполагали с удостоверением устройства и прогнозируемым оставшимся сроком полезного использования.

   ```json
   {
       "Body": {
           "ConnectionDeviceId": "Client_001",
           "CorrelationId": "3d0bc256-b996-455c-8930-99d89d351987",
           "CycleTime": 1.0,
           "PredictedRul": 170.1723693909444
       },
       "EnqueuedTimeUtc": "<time>",
       "Properties": {
           "ConnectionDeviceId": "Client_001",
           "CorrelationId": "3d0bc256-b996-455c-8930-99d89d351987",
           "CreationTimeUtc": "01/01/0001 00:00:00",
           "EnqueuedTimeUtc": "01/01/0001 00:00:00"
       },
       "SystemProperties": {
           "connectionAuthMethod": "{\"scope\":\"module\",\"type\":\"sas\",\"issuer\":\"iothub\",\"acceptingIpFilterRule\":null}",
           "connectionDeviceGenerationId": "636857841798304970",
           "connectionDeviceId": "aaTurbofanEdgeDevice",
           "connectionModuleId": "turbofanRouter",
           "contentEncoding": "utf-8",
           "contentType": "application/json",
           "correlationId": "3d0bc256-b996-455c-8930-99d89d351987",
           "enqueuedTime": "<time>",
           "iotHubName": "mledgeiotwalkthroughhub"
       }
   }
   ```

5. Выполните ту же команду, передав файл Avro, скачанный из **uploadturbofanfiles**.

6. Как и ожидалось, эти сообщения содержат данные датчиков и операционные данные из исходного сообщения. Эти данные могут использоваться для улучшения модели оставшегося срока полезного использования на нашем пограничном устройстве.

   ```json
   {
       "Body": {
           "CycleTime": 1.0,
           "OperationalSetting1": -0.0005000000237487257,
           "OperationalSetting2": 0.00039999998989515007,
           "OperationalSetting3": 100.0,
           "PredictedRul": 170.17236328125,
           "Sensor1": 518.6699829101562,
           "Sensor10": 1.2999999523162842,
           "Sensor11": 47.29999923706055,
           "Sensor12": 522.3099975585938,
           "Sensor13": 2388.010009765625,
           "Sensor14": 8145.31982421875,
           "Sensor15": 8.424599647521973,
           "Sensor16": 0.029999999329447746,
           "Sensor17": 391.0,
           "Sensor18": 2388.0,
           "Sensor19": 100.0,
           "Sensor2": 642.3599853515625,
           "Sensor20": 39.11000061035156,
           "Sensor21": 23.353700637817383,
           "Sensor3": 1583.22998046875,
           "Sensor4": 1396.8399658203125,
           "Sensor5": 14.619999885559082,
           "Sensor6": 21.610000610351562,
           "Sensor7": 553.969970703125,
           "Sensor8": 2387.9599609375,
           "Sensor9": 9062.169921875
       },
           "ConnectionDeviceId": "Client_001",
           "CorrelationId": "70df0c98-0958-4c8f-a422-77c2a599594f",
           "CreationTimeUtc": "0001-01-01T00:00:00+00:00",
           "EnqueuedTimeUtc": "<time>"
   }
   ```

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы планируете изучить ресурсы, используемые в этом комплексном учебнике, подождите до завершения, чтобы очистить созданные вами ресурсы. Если вы не планируете продолжать работу, следуйте инструкциям ниже, чтобы удалить их.

1. Удалите группы ресурсов, созданные для хранения виртуальной машины разработки, виртуальной машины IoT Edge, Центра Интернета вещей, учетной записи хранения, службы рабочей области машинного обучения (и созданные ресурсы: реестр контейнеров, Application Insights, хранилище ключей, учетная запись хранения).

2. Удалите проект машинного обучения в [записных книжках Azure](https://notebooks.azure.com).

3. Если вы клонировали репозиторий локально, закройте какие-либо окна PowerShell или VS Code, ссылающиеся на локальный репозиторий, а затем удалите каталог репозитория.

4. Если вы создали сертификаты локально, удалите папку c:\\edgeCertificates.

## <a name="next-steps"></a>Дополнительная информация

В этой статье мы использовали компьютер для разработки для имитации отправки данных датчика и операционных данных с конечного устройства на пограничное устройство. Мы убедились, что модули на устройстве перенаправили, классифицировали, сохранили и передали данные, сперва проверив работу пограничного устройства в режиме реального времени, а затем просмотрев файлы, переданные в учетную запись хранения.

Дополнительные сведения вы найдете в следующих статьях.

* [Connect a downstream device to an Azure IoT Edge gateway](how-to-connect-downstream-device.md) (Подключение подчиненного устройства к шлюзу Azure IoT Edge)
* [Store data at the edge with Azure Blob Storage on IoT Edge (preview)](how-to-store-data-blob.md) (Хранение данных на границе с помощью хранилища BLOB-объектов Azure в IoT Edge (предварительная версия))
