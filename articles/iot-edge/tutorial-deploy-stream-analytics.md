---
title: Руководство по Stream Analytics на граничной системе (Azure IoT Edge)
description: В этом руководстве Azure Stream Analytics развертывается в качестве модуля на устройстве IoT Edge.
author: kgremban
ms.author: kgremban
ms.date: 11/11/2019
ms.topic: tutorial
ms.service: iot-edge
ms.custom: mvc, seodec18
ms.openlocfilehash: fcb272a6161ecae99f969fbf6689944ea85a1384
ms.sourcegitcommit: 598c5a280a002036b1a76aa6712f79d30110b98d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/15/2019
ms.locfileid: "74114023"
---
# <a name="tutorial-deploy-azure-stream-analytics-as-an-iot-edge-module"></a>Руководство по Развертывание Azure Stream Analytics в качестве модуля IoT Edge

Многие решения Интернета вещей используют службы аналитики, чтобы получать аналитические сведения о данных по мере того, как они попадают в облако с устройств Интернета вещей. С помощью Azure IoT Edge можно переместить логику [Azure Stream Analytics](https://docs.microsoft.com/azure/stream-analytics/) на само устройство. Обрабатывая потоки данных телеметрии в Edge, можно сократить объем отправленных данных и время, необходимое для реагирования на полезные аналитические сведения.

Azure IoT Edge и Azure Stream Analytics интегрированы, поэтому вы можете создать задание Azure Stream Analytics на портале Azure и затем развернуть его в качестве модуля IoT Edge без дополнительного кода.  

Azure Stream Analytics предоставляет расширенный синтаксис структурированных запросов для анализа данных как в облаке, так и на устройствах IoT Edge. Дополнительные сведения см. в [документации по Azure Stream Analytics](../stream-analytics/stream-analytics-edge.md).

В этом руководстве модуль Stream Analytics вычисляет среднюю температуру в течение скользящего 30-секундного окна. Когда это значение достигает 70, модуль отправляет предупреждение, чтобы устройство выполнило действие. В этом случае действие заключается в сбросе имитируемого датчика температуры. В рабочей среде вы можете использовать эту функцию для выключения компьютера или принятия профилактических мер, когда температура достигает опасных уровней. 

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание задания Azure Stream Analytics для обработки пограничных данных.
> * Подключение нового задания Azure Stream Analytics с другими модулями IoT Edge.
> * Развертывание задания Azure Stream Analytics на устройстве IoT Edge с портала Azure.

<center>

![Схема рассматриваемой в руководстве архитектуры, а также размещение и развертывание задания ASA](./media/tutorial-deploy-stream-analytics/asa-architecture.png)
</center>


[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

## <a name="prerequisites"></a>Предварительные требования

Устройство Azure IoT Edge.

* В качестве устройства IoT Edge можно использовать виртуальную машину Azure. Для этого выполните действия, описанные в кратком руководстве для устройства [Linux](quickstart-linux.md) или [Windows](quickstart.md).

Облачные ресурсы.

* [Центр Интернета вещей](../iot-hub/iot-hub-create-through-portal.md) ценовой категории "Бесплатный" или "Стандартный" в Azure. 


## <a name="create-an-azure-stream-analytics-job"></a>Создание задания Azure Stream Analytics

В этом разделе будет создано задание Azure Stream Analytics, которое выполняет следующие шаги:
* получение данных с устройства IoT Edge;
* запрос значений, выходящих за пределы заданного диапазона, из данных телеметрии;
* выполнение действий на устройстве IoT Edge на основе результатов запроса. 

### <a name="create-a-storage-account"></a>Создание учетной записи хранения

Когда вы создаете задание Azure Stream Analytics для запуска на устройстве IoT Edge, его необходимо сохранить таким образом, чтобы его можно было вызывать с устройства. Вы можете использовать имеющуюся учетную запись хранения Azure или создать ее. 

1. На портале Azure последовательно выберите **Создать ресурс** > **Хранилище** > **Учетная запись хранения**. 

1. Чтобы создать учетную запись хранения, введите следующие значения:

   | Поле | Значение |
   | ----- | ----- |
   | Subscription | Выберите ту же подписку, к которой относится Центр Интернета вещей. |
   | группа ресурсов. | Мы рекомендуем использовать одну группу ресурсов для всех тестовых ресурсов, которые вы создаете во время работы с краткими руководствами по IoT Edge. Например, **IoTEdgeResources**. |
   | ИМЯ | Введите уникальное имя учетной записи хранения. | 
   | Location | Выберите расположение рядом с вами. |


1. Для других полей используйте значения по умолчанию и выберите **Просмотреть и создать**.

1. Проверьте параметры и щелкните **Создать**.

### <a name="create-a-new-job"></a>Создание задания

1. На портале Azure последовательно выберите **Создать ресурс** > **Интернет вещей** > **Задание Stream Analytics**.

1. Чтобы создать задание, введите следующие значения:

   | Поле | Значение |
   | ----- | ----- |
   | Имя задания | Укажите имя задания. Например, **IoTEdgeJob**. | 
   | Subscription | Выберите ту же подписку, к которой относится Центр Интернета вещей. |
   | группа ресурсов. | Мы рекомендуем использовать одну группу ресурсов для всех тестовых ресурсов, которые вы создаете во время работы с краткими руководствами по IoT Edge. Например, **IoTEdgeResources**. |
   | Location | Выберите расположение рядом с вами. | 
   | Среда размещения | Выберите **Edge**. |
 
1. Нажмите кнопку **Создать**.

### <a name="configure-your-job"></a>Настройка задания

После создания задания Stream Analytics на портале Azure вы можете настроить его с помощью входных, выходных данных и запроса для выполнения в соответствующих данных. 

С помощью трех элементов — входных, выходных данных и запроса — в этом разделе создается задание, которое принимает данные температуры от устройства IoT Edge. Оно анализирует эти данные в течение скользящего 30-секундного окна. Если средняя температура в течение этого окна превышает 70 градусов, тогда на устройство IoT Edge отправляется оповещение. В следующем разделе при развертывании задания вы точно укажете, откуда и куда поступают данные.  

1. Перейдите в задание Stream Analytics на портале Azure. 

1. В разделе **Топология задания** выберите **Входные данные**, а затем **Add stream input** (Добавить потоковый вход).

   ![Добавление входных данных Azure Stream Analytics](./media/tutorial-deploy-stream-analytics/asa-input.png)

1. В раскрывающемся списке выберите **Центр Edge**.

1. На панели **Новые входные данные** введите **temperature** как псевдоним входных данных. 

1. Для других полей используйте значения по умолчанию и нажмите кнопку **Сохранить**.

1. В разделе **Топология задания** откройте **Выходные данные**, а затем выберите **Добавить**.

   ![Добавление выходных данных Azure Stream Analytics](./media/tutorial-deploy-stream-analytics/asa-output.png)

1. В раскрывающемся списке выберите **Центр Edge**.

1. На панели **Новые выходные данные** введите **alert** как псевдоним выходных данных. 

1. Для других полей используйте значения по умолчанию и нажмите кнопку **Сохранить**.

1. В разделе **Топология задания** выберите **Запрос**.

1. Замените текст по умолчанию следующим запросом. Код SQL отправляет команду сброса на вывод оповещения, если средняя температура компьютера в течение 30-секундного окна достигает 70 градусов. Команда сброса предварительно запрограммирована в датчике как действие, которое можно предпринять. 

    ```sql
    SELECT  
        'reset' AS command 
    INTO 
       alert 
    FROM 
       temperature TIMESTAMP BY timeCreated 
    GROUP BY TumblingWindow(second,30) 
    HAVING Avg(machine.temperature) > 70
    ```

1. Щелкните **Сохранить**.

### <a name="configure-iot-edge-settings"></a>Настройка параметров IoT Edge

Чтобы подготовить задание Stream Analytics для развертывания на устройстве IoT Edge, вам необходимо связать задание с контейнером в учетной записи хранения. Когда вы перейдете к развертыванию задания, определение задания экспортируется в контейнер хранилища. 

1. В разделе **Настройка** выберите пункт **Параметры учетной записи хранения** и щелкните **Добавить учетную запись хранения**. 

   ![Добавление учетной записи хранения для Azure Stream Analytics](./media/tutorial-deploy-stream-analytics/add-storage-account.png)

1. Выберите из раскрывающегося меню **учетную запись хранения**, которую вы создали в начале этого учебника.

1. Для поля **Контейнер** выберите **Создать новый** и укажите имя для контейнера хранилища. 

1. Щелкните **Сохранить**. 

## <a name="deploy-the-job"></a>Развертывание задания

Теперь вы готовы к развертыванию задания Azure Stream Analytics на своем устройстве IoT Edge. 

В этом разделе для создания *манифеста развертывания* вы используете мастер **настройки модулей** на портале Azure. Манифест развертывания — это JSON-файл, описывающий все модули, которые будут развернуты на устройство, регистры контейнера, хранящие образы модулей, сведения об управлении модулями и их взаимодействии друг с другом. Ваше устройство IoT Edge извлекает манифест развертывания из Центра Интернета вещей, а затем использует информацию в нем для развертывания и настройки всех назначенных ему модулей. 

В рамках работы с этим руководством вы развернете два модуля. Первый — это модуль **SimulatedTemperatureSensor**, имитирующий датчик температуры и влажности. Второй модуль — задание Stream Analytics. Модуль датчика предоставляет поток данных, который будет анализировать запрос задания. 

1. Найдите нужный Центр Интернета вещей на портале Azure.

1. Перейдите к **IoT Edge**, а затем откройте страницу сведений об устройстве IoT Edge.

1. Щелкните **Set modules** (Настроить модули).  

1. Если вы уже развертывали модуль SimulatedTemperatureSensor на этом устройстве, его параметры могут заполниться автоматически. Если же он не установлен, добавьте модуль следующим образом.

   1. Щелкните **Добавить** и выберите **Модуль IoT Edge**.
   1. В поле имени введите **SimulatedTemperatureSensor**.
   1. В качестве универсального кода ресурса (URI) образа введите **mcr.microsoft.com/azureiotedge-simulated-temperature-sensor:1.0**. 
   1. Оставьте без изменений другие параметры и выберите **Сохранить**.

1. Добавьте задание Azure Stream Analytics Edge, выполнив следующие шаги:

   1. Нажмите кнопку **Добавить** и выберите модуль **Azure Stream Analytics**.
   1. Выберите свою подписку и созданное задание Edge Azure Stream Analytics. 
   1. Щелкните **Сохранить**.

   Когда вы сохраните изменения, сведения о задании Stream Analytics публикуются в созданном контейнере хранилища. 

1. Когда модуль Stream Analytics появится в списке модулей, щелкните **Настроить** и изучите его структуру. 

   Универсальный код ресурса (URI) образа указывает на стандартный образ Azure Stream Analytics. Это тот же образ, который используется для каждого модуля Stream Analytics, развертываемого на устройство IoT Edge. 

   Двойник модуля настраивается с помощью нужного свойства с именем **ASAJobInfo**. Значение этого свойства указывает на определение задания в контейнере хранилища. Это свойство определяет настройку образа Stream Analytics по конкретным параметрам задания. 

   По умолчанию модуль Stream Analytics получает то же имя, что и базовое задание для него. Вы можете изменить имя модуля на этой странице, но это не обязательно. 

1. Закройте страницу настройки модуля.

1. Запишите имя модуля Stream Analytics, так как оно понадобится вам на следующем шаге, а затем нажмите кнопку **Далее**, чтобы продолжить.

1. Замените значение по умолчанию во вкладке **Маршруты** на код, приведенный ниже. Обновите все три экземпляра _{moduleName}_ с помощью имени своего модуля Azure Stream Analytics. 

    ```json
    {
        "routes": {
            "telemetryToCloud": "FROM /messages/modules/SimulatedTemperatureSensor/* INTO $upstream",
            "alertsToCloud": "FROM /messages/modules/{moduleName}/* INTO $upstream",
            "alertsToReset": "FROM /messages/modules/{moduleName}/* INTO BrokeredEndpoint(\"/modules/SimulatedTemperatureSensor/inputs/control\")",
            "telemetryToAsa": "FROM /messages/modules/SimulatedTemperatureSensor/* INTO BrokeredEndpoint(\"/modules/{moduleName}/inputs/temperature\")"
        }
    }
    ```

   Маршруты, объявляемые здесь, определяют поток данных через устройство IoT Edge. Данные телеметрии от устройства SimulatedTemperatureSensor направляются в Центр Интернета вещей на вход **данных о температуре**, который мы настроили для задания Stream Analytics. Выходные сообщения **предупреждения** отправляются в Центр Интернета вещей и в модуль SimulatedTemperatureSensor для активации команды перезапуска. 

1. Щелкните **Далее**.

1. На шаге **Обзор развертывания** можно увидеть, как предоставленные в мастере данные, преобразуются в манифест развертывания JSON. Завершив просмотр манифеста, щелкните **Отправить**.

1. Вернитесь на страницу сведений об устройстве и выберите **Refresh** (Обновить).  

    Вы увидите новый модуль Stream Analytics, который работает вместе с модулями агента IoT Edge и концентратора IoT Edge. Может потребоваться несколько минут, пока информация поступит на устройство IoT Edge и запустятся новые модули. Если вы не сразу увидите здесь модули, обновите страницу еще несколько раз.

    ![SimulatedTemperatureSensor и модуль ASA, сообщаемые устройством](./media/tutorial-deploy-stream-analytics/module-output2.png)

## <a name="view-data"></a>Просмотр данных

Теперь вы можете зайти на устройство IoT Edge и проверить взаимодействие между модулем Azure Stream Analytics и модулем SimulatedTemperatureSensor.

1. Проверьте выполнение всех модулей в Docker.

   ```cmd/sh
   iotedge list  
   ```
   <!--
   ![Docker output](./media/tutorial-deploy-stream-analytics/docker_output.png)
   -->
1. Просмотрите все системные журналы и данные метрик. Используйте имя модуля Stream Analytics.

   ```cmd/sh
   iotedge logs -f {moduleName}  
   ```

1. По журналам датчика проверьте, как команда перезагрузки влияет на модуль SimulatedTemperatureSensor.

   ```cmd/sh
   iotedge logs SimulatedTemperatureSensor
   ```

   Вы увидите, что температура компьютера постепенно повышается в течение 30 секунд, пока не достигнет 70 градусов. Затем модуль Stream Analytics активирует сброс, и температура компьютера уменьшается до 21 градуса. 

   ![Выходные данные команды сброса в журналах модуля](./media/tutorial-deploy-stream-analytics/docker_log.png)

## <a name="clean-up-resources"></a>Очистка ресурсов 

Если вы планируете перейти к следующей рекомендуемой статье, можно сохранить созданные и повторно используемые ресурсы и конфигурации. Это же устройство IoT Edge также можно использовать в качестве тестового устройства. 

В противном случае вы можете удалить локальные конфигурации и ресурсы Azure, созданные в рамках этой статьи, чтобы избежать расходов. 
 
[!INCLUDE [iot-edge-clean-up-cloud-resources](../../includes/iot-edge-clean-up-cloud-resources.md)]


## <a name="next-steps"></a>Дополнительная информация

В этом руководстве вы настроили задание Azure Streaming Analytics для анализа данных с устройства IoT Edge. Затем вы загрузили этот модуль Azure Stream Analytics на устройство IoT Edge, чтобы обрабатывать данные и реагировать на повышение температуры локально, а также отправлять агрегированный поток данных в облако. Вы можете перейти к изучению других руководств, чтобы узнать, как Azure IoT Edge может создавать решения для вашего бизнеса.

> [!div class="nextstepaction"] 
> [Руководство: развертывание службы "Машинное обучение Azure" в качестве модуля IoT Edge (предварительная версия)](tutorial-deploy-machine-learning.md)
