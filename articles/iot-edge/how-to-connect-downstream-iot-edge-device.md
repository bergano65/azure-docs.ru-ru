---
title: Подключение подчиненных IoT Edge устройств — Azure IoT Edge | Документация Майкрософт
description: Настройка устройства IoT Edge для подключения к устройствам шлюза Azure IoT Edge.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 11/10/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom:
- amqp
- mqtt
monikerRange: '>=iotedge-2020-11'
ms.openlocfilehash: d5da6576258d3e33296781bbc262494220140ddc
ms.sourcegitcommit: b4880683d23f5c91e9901eac22ea31f50a0f116f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/11/2020
ms.locfileid: "94489290"
---
# <a name="connect-a-downstream-iot-edge-device-to-an-azure-iot-edge-gateway-preview"></a>Подключение подчиненного IoT Edge устройства к шлюзу Azure IoT Edge (Предварительная версия)

В этой статье приводятся инструкции по установлению доверенного подключения между шлюзом IoT Edge и нижестоящим IoT Edge устройством.

>[!NOTE]
>Для этого компонента требуется IoT Edge версии 1,2, которая находится в общедоступной предварительной версией, в которой выполняются контейнеры Linux.

В сценарии шлюза устройство IoT Edge может быть как шлюзом, так и подчиненным устройством. Несколько шлюзов IoT Edge можно разслойировать, чтобы создать иерархию устройств. Подчиненные (или дочерние) устройства могут проходить проверку подлинности и отправлять и получать сообщения через их шлюз (или родительское устройство).

Существует две различные конфигурации для IoT Edge устройств в иерархии шлюза, и в этой статье рассматриваются оба. Первый — это **верхний уровень** IOT Edge устройства. Если несколько устройств IoT Edge подключаются друг к другу, любое устройство, которое не имеет родительского устройства, но подключается непосредственно к центру Интернета вещей, считается на верхнем уровне. Это устройство отвечает за обработку запросов со всех устройств, расположенных под ним. Другая конфигурация применяется к любому IoT Edge устройству в **более низком слое** иерархии. Эти устройства могут быть шлюзом для других нижестоящих устройств Интернета вещей и IoT Edge, но также необходимо маршрутизировать обмен данными через собственные родительские устройства.

Для некоторых сетевых архитектур требуется, чтобы только верхняя IoT Edge устройство в иерархии могла подключаться к облаку. В этой конфигурации все IoT Edge устройства в более низких слоях иерархии могут взаимодействовать только со своим шлюзом (или родительским устройством) и любыми нижестоящими (или дочерними) устройствами.

Все действия, описанные в этой статье, создаются в разделе [Настройка устройства IOT Edge для работы в качестве прозрачного шлюза](how-to-create-transparent-gateway.md), который настраивает IOT Edge устройство в качестве шлюза для подчиненных устройств Интернета вещей. Те же основные шаги применяются ко всем сценариям шлюза.

* **Проверка подлинности** : создание удостоверений центра Интернета вещей для всех устройств в иерархии шлюзов.
* **Авторизация**. Настройте отношения "родители-потомки" в центре Интернета вещей, чтобы разрешить дочерним устройствам подключаться к своему родительскому устройству, например к центру Интернета вещей.
* **Обнаружение шлюза**. Убедитесь, что дочернее устройство может найти свое родительское устройство в локальной сети.
* **Безопасное подключение**. Установите безопасное соединение с доверенными сертификатами, которые являются частью одной цепочки.

## <a name="prerequisites"></a>Предварительные требования

* Бесплатный или стандартный центр Интернета вещей.
* По крайней мере два **IOT Edge устройства** , одно из которых является устройством верхнего уровня и одним или несколькими устройствами более низкого уровня. Если у вас нет доступных IoT Edge устройств, можно [запустить Azure IOT EDGE на виртуальных машинах Ubuntu](how-to-install-iot-edge-ubuntuvm.md).
* Если вы используете Azure CLI для создания устройств и управления ими, установите Azure CLI v 2.3.1 с расширением Azure IoT v 0.10.6 или более поздней версии.

Эта статья содержит подробные инструкции и параметры, помогающие создать подходящую иерархию шлюза для вашего сценария. Пошаговые инструкции см. в статье [Создание иерархии IOT Edge устройств с помощью шлюзов](tutorial-nested-iot-edge.md).

## <a name="create-a-gateway-hierarchy"></a>Создание иерархии шлюза

Иерархию шлюза IoT Edge создается путем определения отношений "родители-потомки" для IoT Edge устройств в сценарии. Вы можете задать родительское устройство при создании нового удостоверения устройства или управлять родительскими и дочерними элементами существующего удостоверения устройства.

При настройке связей "родители-потомки" дочерние устройства разрешают подключаться к их родительскому устройству, например к центру Интернета вещей.

Только IoT Edge устройства могут быть родительскими устройствами, но устройства IoT Edge и IoT могут быть дочерними. У родителя может быть несколько дочерних элементов, но дочерний элемент может иметь только один родительский элемент. Иерархия шлюза создается путем объединения родительских и дочерних наборов, чтобы дочерний элемент одного устройства был родительским для другого.

<!-- TODO: graphic of gateway hierarchy -->

# <a name="portal"></a>[Портал](#tab/azure-portal)

В портал Azure можно управлять связью "родители-потомки" при создании новых удостоверений устройств или при редактировании существующих устройств.

При создании нового устройства IoT Edge можно выбрать родительские и дочерние устройства из списка существующих устройств IoT Edge в этом центре.

1. В [портал Azure](https://portal.azure.com)перейдите в центр Интернета вещей.
1. Выберите **IOT Edge** в меню навигации.
1. Выберите **Добавить устройство IoT Edge**.
1. Вместе с заданием идентификатора устройства и параметров проверки подлинности можно **задать родительское устройство** или **Выбрать дочерние устройства**.
1. Выберите устройство или устройства, которые должны быть родительскими или дочерними.

Вы также можете создавать и администрировать отношения "родители-потомки" для существующих устройств.

1. В [портал Azure](https://portal.azure.com)перейдите в центр Интернета вещей.
1. Выберите **IOT Edge** в меню навигации.
1. Выберите устройство, которым вы хотите управлять, из списка **устройств IOT Edge**.
1. Выберите **задать родительское устройство** или **управлять дочерними устройствами**.
1. Добавьте или удалите все родительские или дочерние устройства.

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

Расширение [Azure-IOT](/cli/azure/ext/azure-iot) для Azure CLI предоставляет команды для управления ресурсами Интернета вещей. Вы можете управлять связью "родители-потомки" для устройств IoT и IoT Edge при создании новых удостоверений устройств или при редактировании существующих устройств.

Набор команд [AZ IOT Hub Device-Identity](/cli/azure/ext/azure-iot/iot/hub/device-identity) позволяет управлять связями типа «родители-потомки» для конкретного устройства.

`create`Команда включает параметры для добавления дочерних устройств и настройки родительского устройства во время создания устройства.

Дополнительные команды идентификации устройства, включая `add-children` , `list-children` , и `remove-children` `get-parent` и `set-parent` , позволяют управлять связями типа «родители-потомки» для существующих устройств.

---

## <a name="prepare-certificates"></a>Подготовка сертификатов

Для установления безопасного взаимодействия между собой необходимо установить согласованную цепочку сертификатов на устройствах в одной иерархии шлюзов. Каждое устройство в иерархии, будь то IoT Edge устройство или конечное устройство IoT, должно иметь копию одного и того же корневого сертификата ЦС. Каждое устройство IoT Edge в иерархии использует этот сертификат корневого ЦС в качестве корневого для сертификата ЦС устройства.

При такой настройке каждое подчиненное устройство IoT Edge или конечное устройство IoT может проверить удостоверение своего родителя, убедившись, что edgeHub, к которым они подключаются, имеет сертификат сервера, подписанный сертификатом общего корневого ЦС.

<!-- TODO: certificate graphic -->

Создайте следующие сертификаты:

* **Сертификат корневого ЦС** , который является самым верхним общим сертификатом для всех устройств в данной иерархии шлюзов. Этот сертификат устанавливается на всех устройствах.
* Все **промежуточные сертификаты** , которые необходимо включить в цепочку корневых сертификатов.
* **Сертификат ЦС устройства** и его **закрытый ключ** , созданные корневым и промежуточным сертификатами. Для каждого устройства IoT Edge в иерархии шлюзов требуется один уникальный сертификат ЦС устройства.

>[!NOTE]
>В настоящее время ограничение в либиоссм предотвращает использование сертификатов, срок действия которых истекает 1 января 2038.

Вы можете использовать самозаверяющий центр сертификации или приобрести один из доверенных коммерческих центров сертификации, таких как Baltimore, VeriSign, DigiCert или Глобалсигн.

Если у вас нет собственных сертификатов для использования, можно [создать демонстрационные сертификаты для тестирования функций IOT Edge устройства](how-to-create-test-certificates.md). Выполните действия, описанные в этой статье, чтобы создать один набор корневых и промежуточных сертификатов, а затем создать IoT Edge сертификаты ЦС устройств для каждого устройства.

## <a name="configure-iot-edge-on-devices"></a>Настройка IoT Edge на устройствах

Действия по настройке IoT Edge в качестве шлюза очень похожи на шаги по настройке IoT Edge в качестве подчиненного устройства.

Чтобы включить обнаружение шлюза, каждое устройство шлюза IoT Edge должно быть настроено с **именем узла** , которое его дочерние устройства будут использовать для его поиска в локальной сети. Каждое подчиненное IoT Edge устройство должно быть настроено с **parent_hostname** для подключения к. Если одно устройство IoT Edge является родительским и дочерним, оно должно иметь оба параметра.

Чтобы включить безопасные подключения, каждое устройство IoT Edge в сценарии шлюза должно быть настроено с помощью уникального сертификата ЦС устройства и копии сертификата корневого ЦС, общего для всех устройств в иерархии шлюза.

На устройстве уже должны быть установлены IoT Edge. В противном случае выполните действия по [установке среды выполнения Azure IOT Edge](how-to-install-iot-edge.md) , а затем настройте устройство с проверкой подлинности с помощью [симметричного ключа](how-to-manual-provision-symmetric-key.md) или [сертификата X. 509](how-to-manual-provision-x509.md).

Действия, описанные в этом разделе, ссылаются на **сертификат корневого ЦС** и **сертификат ЦС устройства и закрытый ключ** , которые были рассмотрены ранее в этой статье. Если вы создали эти сертификаты на другом устройстве, они будут доступны на этом устройстве. Вы можете перемещать файлы физически, например с помощью USB-накопителя, со службой, например [Azure Key Vault](../key-vault/general/overview.md), или с помощью функции, такой как [безопасное копирование файлов](https://www.ssh.com/ssh/scp/).

Чтобы настроить IoT Edge на устройстве, выполните следующие действия.

В Linux убедитесь, что у пользователя **iotedge** есть разрешения на чтение каталога, содержащего сертификаты и ключи.

1. Установите **сертификат корневого ЦС** на этом IOT Edge устройстве.

   ```bash
   sudo cp <path>/<root ca certificate>.pem /usr/local/share/ca-certificates/<root ca certificate>.pem
   ```

1. Обновите хранилище сертификатов.

   ```bash
   sudo update-ca-certificates
   ```

   Эта команда должна вывести данные о том, что один сертификат был добавлен в/ЕТК/ССЛ/цертс.

1. Откройте файл конфигурации управляющей программы IoT Edge Security.

   ```bash
   sudo nano /etc/iotedge/config.yaml
   ```

1. Найдите раздел **Certificates** в файле config. YAML. Обновите три поля сертификата, чтобы они указывали на сертификаты. Укажите пути URI файла, которые имеют формат `file:///<path>/<filename>` .

   * **device_ca_cert** : путь URI файла к сертификату ЦС устройства, уникальный для этого устройства.
   * **device_ca_pk** : путь URI файла к закрытому ключу ЦС устройства, уникальный для этого устройства.
   * **trusted_ca_certs** : путь URI файла к корневому сертификату ЦС, который совместно используется всеми устройствами в иерархии шлюза.

1. Найдите параметр **HostName** в файле config. YAML. Обновите имя узла, чтобы оно было полным доменным именем (FQDN), или IP-адресом устройства IoT Edge.

   Значение этого параметра является тем, какие подчиненные устройства будут использовать для подключения к этому шлюзу. Имя узла по умолчанию принимает значение имени компьютера, но для подключения подчиненных устройств требуется FQDN или IP-адрес.

   Используйте имя узла короче 64 символов, что является предельным числом символов для общего имени сертификата сервера.

   Согласованность с шаблоном имени узла в иерархии шлюза. Используйте либо полные доменные имена, либо IP-адреса, но не оба.

1. **Если это устройство является дочерним** , найдите параметр **parent_hostname** . Обновите поле **parent_hostname** как полное доменное имя или IP-адрес родительского устройства, совпадающее с именем узла в файле config. YAML родителя.

1. Хотя эта функция доступна в общедоступной предварительной версии, необходимо настроить устройство IoT Edge, чтобы при запуске использовалась общедоступная Предварительная версия агента IoT Edge.

   Найдите раздел **Agent** YAML и обновите значение образа до образа общедоступной предварительной версии:

   ```yml
   agent:
     name: "edgeAgent"
     type: "docker"
     env: {}
     config:
       image: "mcr.microsoft.com/azureiotedge-agent:1.2.0-rc1"
       auth: {}
   ```

1. Сохраните ( `Ctrl+O` ) и закройте ( `Ctrl+X` ) файл config. YAML.

1. Если вы ранее использовали другие сертификаты для IoT Edge, удалите файлы в следующих двух каталогах, чтобы убедиться, что новые сертификаты будут применены:

   * `/var/lib/iotedge/hsm/certs`
   * `/var/lib/iotedge/hsm/cert_keys`

1. Перезапустите службу IoT Edge, чтобы применить изменения.

   ```bash
   sudo systemctl restart iotedge
   ```

1. Проверьте наличие ошибок в конфигурации.

   ```bash
   sudo iotedge check --verbose
   ```

   >[!TIP]
   >Средство проверки IoT Edge использует контейнер для выполнения некоторых проверок диагностики. Если вы хотите использовать это средство на нижестоящих IoT Edge устройствах, убедитесь, что у них есть доступ к `mcr.microsoft.com/azureiotedge-diagnostics:latest` образу контейнера в частном реестре контейнеров.

## <a name="configure-runtime-modules-for-public-preview"></a>Настройка модулей среды выполнения для общедоступной предварительной версии

Хотя эта функция доступна в общедоступной предварительной версии, необходимо настроить устройство IoT Edge для использования общедоступных предварительных версий модулей среды выполнения IoT Edge. В предыдущем разделе приведены шаги по настройке edgeAgent при запуске. Кроме того, необходимо настроить модули среды выполнения в развертываниях для устройства.

1. Настройте модуль edgeHub для использования образа общедоступной предварительной версии: `mcr.microsoft.com/azureiotedge-hub:1.2.0-rc1` .

1. Настройте следующие переменные среды для модуля edgeHub:

   | Имя | Значение |
   | - | - |
   | `experimentalFeatures__enabled` | `true` |
   | `experimentalFeatures__nestedEdgeEnabled` | `true` |

1. Настройте модуль edgeAgent для использования образа общедоступной предварительной версии: `mcr.microsoft.com/azureiotedge-hub:1.2.0-rc1` .

## <a name="network-isolate-downstream-devices"></a>Изоляция подчиненных устройств в сети

Действия, приведенные в этой статье, настроили IoT Edge устройства в качестве шлюза или подчиненного устройства и создают доверительное соединение между ними. Устройство шлюза обрабатывает взаимодействие между подчиненным устройством и центром Интернета вещей, включая проверку подлинности и маршрутизацию сообщений. Модули, развернутые на нижестоящих IoT Edge устройствах, по-прежнему могут создавать собственные подключения к облачным службам.

Некоторые сетевые архитектуры, например те, которые соответствуют стандарту ISA-95, ищут, чтобы максимально сокращать число подключений к Интернету. В этих сценариях можно настроить подчиненные IoT Edge устройства без прямого подключения к Интернету. Помимо маршрутизации обмена данными между центром Интернета вещей через устройство шлюза, нисходящие IoT Edge устройства могут полагаться на устройство шлюза для всех облачных подключений.

Для этой конфигурации сети требуется, чтобы только устройство IoT Edge на верхнем уровне иерархии шлюзов было иметь прямые подключения к облаку. IoT Edge устройства в нижних слоях могут взаимодействовать только со своими родительскими устройствами или дочерними устройствами. Этот сценарий включает специальные модули на устройствах шлюзов, включая:

* **Прокси-модуль API** требуется для любого шлюза IOT EDGE, который имеет другое IOT Edge устройство под ним. Это означает, что он должен находиться на *каждом уровне* иерархии шлюза, за исключением нижнего уровня. Этот модуль использует обратный прокси-сервер [nginx](https://nginx.org) для МАРШРУТИЗАЦИИ данных HTTP через сетевые слои через один порт. Его можно настроить с помощью двойникаов модулей и переменных среды, так что в соответствии со своими требованиями к сценариям шлюза.

* **Модуль реестра DOCKER** можно развернуть на шлюзе IOT EDGE на *верхнем уровне* иерархии шлюза. Этот модуль отвечает за извлечение и кэширование образов контейнеров от имени всех IoT Edge устройств на более низких уровнях. Альтернативой развертыванию этого модуля на верхнем уровне является использование локального реестра или ручная загрузка образов контейнеров на устройства и установка для политики извлечения по модулю значения **Never**.

* **Хранилище BLOB-объектов Azure на IOT Edge** можно развернуть на шлюзе IOT EDGE на *верхнем уровне* иерархии шлюза. Этот модуль отвечает за отправку больших двоичных объектов от имени всех IoT Edge устройств на более низких уровнях. Возможность отправки BLOB-объектов также позволяет использовать полезные функции устранения неполадок для IoT Edge устройств на более низких уровнях, таких как передача журнала модуля и отправка пакета поддержки.

### <a name="network-configuration"></a>Сетевая конфигурация

Для каждого устройства шлюза в верхнем слое операторы сети должны:

* Укажите статический IP-адрес или полное доменное имя (FQDN).
* Авторизуйте Исходящие коммуникации с этого IP-адреса на имя узла центра Интернета вещей Azure через порты 443 (HTTPS) и 5671 (AMQP).
* Авторизуйте исходящие подключения с этого IP-адреса к имени узла реестра контейнеров Azure через порт 443 (HTTPS).

  Модуль прокси API может одновременно управлять подключениями только к одному реестру контейнеров. Мы рекомендуем использовать все образы контейнеров, включая общедоступные образы, предоставляемые реестром контейнеров (mcr.microsoft.com) (Майкрософт), которые хранятся в частном реестре контейнеров.

Для каждого устройства шлюза на более низком уровне операторы сети должны:

* Укажите статический IP-адрес.
* Авторизуйте исходящие подключения с этого IP-адреса к IP-адресу родительского шлюза через порты 443 (HTTPS) и 5671 (AMQP).

### <a name="deploy-modules-to-top-layer-devices"></a>Развертывание модулей на устройствах верхнего уровня

Устройство IoT Edge на верхнем уровне иерархии шлюзов содержит набор обязательных модулей, которые должны быть развернуты в ней, а также любые модули рабочей нагрузки, которые могут быть запущены на устройстве.

Прокси-модуль API предназначен для настройки с целью решения большинства распространенных сценариев шлюза. В этой статье приведены примеры настройки модулей в базовой конфигурации. Более подробные сведения и примеры см. в разделе [Настройка модуля прокси-сервера API для иерархии шлюза](how-to-configure-api-proxy-module.md) .

1. В [портал Azure](https://portal.azure.com)перейдите в центр Интернета вещей.
1. Выберите **IOT Edge** в меню навигации.
1. Выберите устройство верхнего уровня, которое вы настраиваете, в списке **устройств IOT Edge**.
1. Щелкните **Set modules** (Настроить модули).
1. В разделе **модули IOT Edge** выберите **Добавить** , а затем — **модуль Marketplace**.
1. Найдите и выберите модуль **прокси-службы IOT Edge API** .
1. Выберите имя модуля прокси-сервера API из списка развернутых модулей и обновите следующие параметры модуля:
   1. На вкладке **переменные среды** измените значение **NGINX_DEFAULT_PORT** на `443` .
   1. На вкладке **Параметры создания контейнера** обновите привязки портов, чтобы они ссылались на порт 443.

      ```json
      {
        "HostConfig": {
          "PortBindings": {
            "443/tcp": [
              {
                "HostPort": "443"
              }
            ]
          }
        }
      }
      ```

   Эти изменения настраивают модуль прокси API для прослушивания порта 443. Чтобы предотвратить конфликты привязки портов, необходимо настроить модуль edgeHub так, чтобы он не прослушивает порт 443. Вместо этого модуль прокси-сервера API будет маршрутизировать любой edgeHub трафик через порт 443.

1. Выберите **Параметры среды выполнения** и найдите параметры создания модуля edgeHub. Удалите привязку портов для порта 443, полагая привязок для портов 5671 и 8883.

   ```json
   {
     "HostConfig": {
       "PortBindings": {
         "5671/tcp": [
           {
             "HostPort": "5671"
           }
         ],
         "8883/tcp": [
           {
             "HostPort": "8883"
           }
         ]
       }
     }
   }
   ```

1. Нажмите кнопку **сохранить** , чтобы сохранить изменения в параметрах среды выполнения.
1. Нажмите кнопку **Добавить** еще раз, а затем выберите **IOT Edge модуль**.
1. Укажите следующие значения, чтобы добавить модуль реестра DOCKER в развертывание:
   1. **Имя модуля IOT Edge** : `registry`
   1. На вкладке **Параметры модуля** **URI изображения** : `registry:latest`
   1. На вкладке **переменные среды** добавьте следующие переменные среды:

      * **Имя** : `REGISTRY_PROXY_REMOTEURL` **значение**. URL-адрес реестра контейнеров, к которому должен сопоставляться этот модуль реестра. Например, `https://myregistry.azurecr`.

        Модуль реестра может сопоставляться только с одним реестром контейнеров, поэтому мы рекомендуем использовать все образы контейнеров в одном частном реестре контейнеров.

      * **Имя** : `REGISTRY_PROXY_USERNAME` **значение** : username для проверки подлинности в реестре контейнеров.

      * **Имя** : `REGISTRY_PROXY_PASSWORD` **значение** : пароль для проверки подлинности в реестре контейнеров.

   1. На вкладке **Параметры создания контейнера** вставьте:

      ```json
      {
          "HostConfig": {
              "PortBindings": {
                  "5000/tcp": [
                      {
                          "HostPort": "5000"
                      }
                  ]
              }
          }
      }
      ```

1. Нажмите кнопку **Добавить** , чтобы добавить модуль в развертывание.
1. Нажмите кнопку **Далее: Маршруты** , чтобы перейти к следующему шагу.
1. Чтобы разрешить сообщения, отправляемые с устройства в облако, с подчиненных устройств в центр Интернета вещей, включите маршрут, передающий все сообщения в центр Интернета вещей. Пример:
    1. **Имя** : `Route`
    1. **Значение** : `FROM /messages/* INTO $upstream`
1. Выберите **Проверка + создать** , чтобы перейти к последнему шагу.
1. Выберите **создать** для развертывания на устройстве.

### <a name="deploy-modules-to-lower-layer-devices"></a>Развертывание модулей на устройствах более низкого уровня

IoT Edge устройства в более низких слоях иерархии шлюзов имеют один обязательный модуль, который должен быть развернут в них, в дополнение к любым модулям рабочей нагрузки, которые могут быть запущены на устройстве.

#### <a name="route-container-image-pulls"></a>Извлечение образа контейнера для маршрута

Прежде чем обсудить необходимый модуль прокси для устройств IoT Edge в иерархиях шлюзов, важно понять, как IoT Edge устройства на более низких уровнях получают образы модулей.

Если устройства низкого уровня не могут подключиться к облаку, но вы хотите, чтобы они запрашивают образы модулей как обычно, то устройство верхнего уровня в иерархии шлюзов должно быть настроено для обработки этих запросов. Устройство верхнего уровня должно запустить модуль **реестра** DOCKER, сопоставленный с реестром контейнеров. Затем настройте модуль прокси API для маршрутизации запросов к контейнеру. Эти сведения обсуждаются в предыдущих разделах этой статьи. В этой конфигурации устройства нижнего уровня не должны указывать на регистры облачных контейнеров, но в реестре, работающем на верхнем слое.

Например, вместо вызова `mcr.microsoft.com/azureiotedge-api-proxy:latest` более низкого уровня устройства должны вызывать `$upstream:443/azureiotedge-api-proxy:latest` .

Параметр **$upstream** указывает на родителя устройства более низкого уровня, поэтому запрос будет проходить по всем слоям до тех пор, пока не достигнет верхнего уровня, у которого есть запросы контейнера, перенаправляющие прокси-среду в модуль реестра. `:443`Порт в этом примере следует заменить на порт, прослушиваемый модулем прокси-сервера API на родительском устройстве.

Прокси-модуль API может маршрутизироваться только к одному модулю реестра, и каждый модуль реестра может сопоставляться только с одним реестром контейнеров. Таким образом, все образы, для которых требуется извлечь устройства более низкого уровня, должны храниться в одном реестре контейнеров.

Если вы не хотите, чтобы устройства более низкого уровня произделали запросы на вытягивание модулей через иерархию шлюза, можно также управлять локальным решением реестра. Либо перед созданием развертываний отправьте образы модулей на устройства, а затем установите для параметра **имажепуллполици** значение **Never**.

#### <a name="bootstrap-the-iot-edge-agent"></a>Начальная загрузка агента IoT Edge

Агент IoT Edge является первым компонентом среды выполнения для запуска на любом устройстве IoT Edge. Необходимо убедиться, что все подчиненные IoT Edge устройства могут получить доступ к образу модуля edgeAgent при запуске, а затем они смогут получать доступ к развертываниям и запускать остальные образы модулей.

При переходе в файл config. YAML на устройстве IoT Edge для предоставления сведений о проверке подлинности, сертификатах и родительском имени узла также следует обновить образ контейнера edgeAgent.

Если устройство шлюза верхнего уровня настроено для обработки запросов образа контейнера, замените на `mcr.microsoft.com` родительское имя узла и порт прослушивания прокси API. В манифесте развертывания можно использовать в `$upstream` качестве ярлыка, но для этого необходимо, чтобы модуль edgeHub обрабатывал маршрутизацию, и этот модуль не начал работу на этом этапе. Пример:

```yml
agent:
  name: "edgeAgent"
  type: "docker"
  env: {}
  config:
    image: "{Parent FQDN or IP}:443/azureiotedge-agent:1.2.0-rc1"
    auth: {}
```

Если вы используете локальный реестр контейнеров или предоставляете образы контейнеров вручную на устройстве, обновите файл config. YAML соответствующим образом.

#### <a name="configure-runtime-and-deploy-proxy-module"></a>Настройка среды выполнения и модуля развертывания прокси-сервера

**Прокси-модуль API** необходим для маршрутизации всех подключений между облаком и любыми нижестоящими IOT Edge устройствами. Устройство IoT Edge в нижнем слое иерархии без нижестоящих IoT Edge устройств не требует этого модуля.

Прокси-модуль API предназначен для настройки с целью решения большинства распространенных сценариев шлюза. В этой статье кратко рассматриваются действия по настройке модулей в базовой конфигурации. Более подробные сведения и примеры см. в разделе [Настройка модуля прокси-сервера API для иерархии шлюза](how-to-configure-api-proxy-module.md) .

1. В [портал Azure](https://portal.azure.com)перейдите в центр Интернета вещей.
1. Выберите **IOT Edge** в меню навигации.
1. Выберите устройство нижнего уровня, которое вы настраиваете, в списке **устройств IOT Edge**.
1. Щелкните **Set modules** (Настроить модули).
1. В разделе **модули IOT Edge** выберите **Добавить** , а затем — **модуль Marketplace**.
1. Найдите и выберите модуль **прокси-службы IOT Edge API** .
1. Выберите имя модуля прокси-сервера API из списка развернутых модулей и обновите следующие параметры модуля:
   1. На вкладке **Параметры модуля** обновите значение **URI изображения**. Замените `mcr.microsoft.com` на `$upstream:443`.
   1. На вкладке **переменные среды** измените значение **NGINX_DEFAULT_PORT** на `443` .
   1. На вкладке **Параметры создания контейнера** обновите привязки портов, чтобы они ссылались на порт 443.

      ```json
      {
        "HostConfig": {
          "PortBindings": {
            "443/tcp": [
              {
                "HostPort": "443"
              }
            ]
          }
        }
      }
      ```

   Эти изменения настраивают модуль прокси API для прослушивания порта 443. Чтобы предотвратить конфликты привязки портов, необходимо настроить модуль edgeHub так, чтобы он не прослушивает порт 443. Вместо этого модуль прокси-сервера API будет маршрутизировать любой edgeHub трафик через порт 443.

1. Выберите **Параметры среды выполнения**.
1. Обновите параметры модуля edgeHub:

   1. В поле **изображение** замените на `mcr.microsoft.com` `$upstream:443` .
   1. В поле **Создание параметров** Удалите привязку портов для порта 443, в результате чего привязок для портов 5671 и 8883.

   ```json
   {
     "HostConfig": {
       "PortBindings": {
         "5671/tcp": [
           {
             "HostPort": "5671"
           }
         ],
         "8883/tcp": [
           {
             "HostPort": "8883"
           }
         ]
       }
     }
   }
   ```

1. Обновите параметры модуля edgeAgent:
   1. В поле **изображение** замените на `mcr.microsoft.com` `$upstream:443` .

1. Нажмите кнопку **сохранить** , чтобы сохранить изменения в параметрах среды выполнения.
1. Нажмите кнопку **Далее: Маршруты** , чтобы перейти к следующему шагу.
1. Чтобы разрешить сообщения, отправляемые с устройства в облако, с подчиненных устройств в центр Интернета вещей, включите маршрут, передающий все сообщения `$upstream` . Вышестоящий параметр указывает на родительское устройство в случае более низких устройств. Пример:
    1. **Имя** : `Route`
    1. **Значение** : `FROM /messages/* INTO $upstream`
1. Выберите **Проверка + создать** , чтобы перейти к последнему шагу.
1. Выберите **создать** для развертывания на устройстве.

## <a name="next-steps"></a>Следующие шаги

[Использование устройства IoT Edge в качестве шлюза](iot-edge-as-gateway.md)

[Настройка модуля прокси API для сценария иерархии шлюза](how-to-configure-api-proxy-module.md)