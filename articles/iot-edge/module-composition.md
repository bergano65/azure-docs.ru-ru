---
title: Развертывание модулей и маршрутов с помощью манифестов развертывания — Azure IoT Edge
description: Узнайте, как в манифесте развертывания объявляются развертываемые модули и способы их развертывания и как создать маршруты для передачи сообщений между этими модулями.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 10/08/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 406420fcd517ceda8ea6eedfc955f54b15541f74
ms.sourcegitcommit: d4734bc680ea221ea80fdea67859d6d32241aefc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2021
ms.locfileid: "100366608"
---
# <a name="learn-how-to-deploy-modules-and-establish-routes-in-iot-edge"></a>Сведения о развертывании модулей и установлении маршрутов в IoT Edge

На каждом устройстве IoT Edge работают по меньшей мере два модуля – $edgeAgent и $edgeHub, входящие в среду выполнения IoT Edge. На любом устройстве IoT Edge можно запустить множество дополнительных модулей для выполнения любого числа процессов. Используйте манифест развертывания, чтобы сообщить устройству, какие модули нужно установить и как их нужно настроить для совместной работы.

*Манифест развертывания* — это документ JSON, который описывает:

* двойник модуля **агента IoT Edge**, который включает три компонента:
  * образ контейнера для каждого модуля, запущенного на устройстве;
  * учетные данные для доступа к закрытым реестрам контейнеров, содержащим образы модулей;
  * инструкции по созданию модулей и управлению каждым модулем;
* двойник модуля **центра IoT Edge**, которая описывает поток сообщений между модулями и в конечном итоге к Центру Интернета вещей;
* требуемые свойства дополнительных двойников модулей (необязательно).

Все устройства IoT Edge должны быть настроены с помощью манифеста развертывания. Недавно установленная среда выполнения IoT Edge будет сообщать код ошибки, пока не будет настроена с помощью допустимого манифеста.

В руководствах по Azure IoT Edge манифест развертывания создается с помощью мастера на портале Azure IoT Edge. Также с помощью REST или пакета SDK службы Центра Интернета вещей можно применить манифест развертывания программно. Дополнительные сведения см. в статье [Основные сведения о развертываниях IoT Edge для отдельных устройств или в требуемом масштабе](module-deployment-monitoring.md).

## <a name="create-a-deployment-manifest"></a>Создание манифеста развертывания

В общих чертах манифест развертывания представляет собой список двойников модулей, для которых настроены требуемые свойства. Манифест развертывания сообщает устройству IoT Edge (или группе устройств), какие модули нужно установить и как их нужно настроить. Манифесты развертывания содержат *требуемые свойства* для каждого двойника модуля. Устройства IoT Edge передают *сообщаемые свойства* от каждого модуля.

В каждый манифест должны быть включены два обязательных модуля: `$edgeAgent` и `$edgeHub`. Эти модули являются частью среды выполнения IoT Edge, которая управляет устройством IoT Edge и запущенными на нем модулями. См. дополнительные сведения о [среде выполнения Azure IoT Edge и ее архитектуре](iot-edge-runtime.md).

В дополнение к двум модулям среды выполнения можно добавить до 50 модулей для запуска на устройстве IoT Edge.

Манифест развертывания, который содержит только среду выполнения IoT Edge (модули edgeAgent и edgeHub), тоже считается допустимым.

Манифесты развертывания имеют такую структуру:

```json
{
  "modulesContent": {
    "$edgeAgent": { // required
      "properties.desired": {
        // desired properties of the IoT Edge agent
        // includes the image URIs of all deployed modules
        // includes container registry credentials
      }
    },
    "$edgeHub": { //required
      "properties.desired": {
        // desired properties of the IoT Edge hub
        // includes the routing information between modules, and to IoT Hub
      }
    },
    "module1": {  // optional
      "properties.desired": {
        // desired properties of module1
      }
    },
    "module2": {  // optional
      "properties.desired": {
        // desired properties of module2
      }
    }
  }
}
```

## <a name="configure-modules"></a>Настройка модулей

Определите, как среда выполнения IoT Edge устанавливает модули в развертывании. Агент IoT Edge — это компонент среды выполнения, который управляет установкой, обновлением и отчетами о состоянии для устройства IoT Edge. Таким образом, двойник модуля $edgeAgent содержит сведения по управлению и настройке для всех модулей. Сюда также входят параметры настройки самого агента IoT Edge.

Свойства $edgeAgent имеют такую структуру:

```json
{
  "modulesContent": {
    "$edgeAgent": {
      "properties.desired": {
        "schemaVersion": "1.1",
        "runtime": {
          "settings":{
            "registryCredentials":{
              // give the IoT Edge agent access to container images that aren't public
            }
          }
        },
        "systemModules": {
          "edgeAgent": {
            // configuration and management details
          },
          "edgeHub": {
            // configuration and management details
          }
        },
        "modules": {
          "module1": {
            // configuration and management details
          },
          "module2": {
            // configuration and management details
          }
        }
      }
    },
    "$edgeHub": { ... },
    "module1": { ... },
    "module2": { ... }
  }
}
```

Версия 1,1 схемы агента IoT Edge была выпущена вместе с IoT Edge версии 1.0.10 и включает порядок запуска модуля. Версия схемы 1,1 рекомендуется для любого IoT Edgeного развертывания с версией 1.0.10 или более поздней.

### <a name="module-configuration-and-management"></a>Настройка модуля и управление им

Список требуемых свойств агента IoT Edge — это место, где вы определяете, какие модули развертываются на IoT Edge устройстве и как они должны настраиваться и управлять ими.

Полный список требуемых свойств, которые можно или необходимо добавить, см. в разделе [Свойства агента IOT EDGE и центра IOT Edge](module-edgeagent-edgehub.md).

Пример:

```json
{
  "modulesContent": {
    "$edgeAgent": {
      "properties.desired": {
        "schemaVersion": "1.1",
        "runtime": { ... },
        "systemModules": {
          "edgeAgent": { ... },
          "edgeHub": { ... }
        },
        "modules": {
          "module1": {
            "version": "1.0",
            "type": "docker",
            "status": "running",
            "restartPolicy": "always",
            "startupOrder": 2,
            "settings": {
              "image": "myacr.azurecr.io/module1:latest",
              "createOptions": "{}"
            }
          },
          "module2": { ... }
        }
      }
    },
    "$edgeHub": { ... },
    "module1": { ... },
    "module2": { ... }
  }
}
```

У каждого модуля есть свойство **Settings** , которое содержит **образ** модуля, адрес образа контейнера в реестре контейнеров и любые **креатеоптионс** для настройки образа при запуске. Дополнительные сведения см. [в разделе Настройка параметров создания контейнера для модулей IOT Edge](how-to-use-create-options.md).

Модуль edgeHub и пользовательские модули также имеют три свойства, указывающие агенту IoT Edge, как управлять ими:

* **Состояние**: должен ли модуль запускаться или останавливаться при первом развертывании. Обязательный.
* **RestartPolicy**: когда и если агент IOT Edge должен перезапустить модуль в случае его остановки. Обязательный.
* **Стартупордер**: *введено в IOT Edge версии 1.0.10.* Порядок, в котором агент IoT Edge должен запускать модули при первом развертывании. Порядок объявлен с целыми числами, где модуль с заданным начальным значением 0 запускается первыми, а затем — с более высоким числом. Модуль edgeAgent не имеет значения запуска, так как всегда начинается первым. Необязательный элемент.

  Агент IoT Edge инициирует модули в порядке значения запуска, но не ждет завершения каждого модуля, прежде чем перейти к следующему.

  Порядок загрузки полезен, если некоторые модули зависят от других. Например, может потребоваться запустить модуль edgeHub, чтобы он был готов к маршрутизации сообщений при запуске других модулей. Или вы можете запустить модуль хранилища перед модулями, которые отправляют в него данные. Тем не менее следует всегда проектировать модули, чтобы обрабатывал сбои других модулей. Это характер контейнеров, которые могут останавливаться и перезапускаться в любое время и любое количество раз.

## <a name="declare-routes"></a>Объявление маршрутов

Центр IoT Edge управляет взаимодействием между модулями, Центром Интернета вещей и всеми конечными устройствами. Для этой цели двойник модуля $edgeHub содержит требуемое свойство с именем *routes*, в котором описываются правила передачи сообщений в конкретном развертывании. Один экземпляр развертывания может иметь несколько маршрутов.

Маршруты объявляются в требуемых свойствах **$edgeHub**. Синтаксис объявления следующий:

```json
{
  "modulesContent": {
    "$edgeAgent": { ... },
    "$edgeHub": {
      "properties.desired": {
        "schemaVersion": "1.1",
        "routes": {
          "route1": "FROM <source> WHERE <condition> INTO <sink>",
          "route2": {
            "route": "FROM <source> WHERE <condition> INTO <sink>",
            "priority": 0,
            "timeToLiveSecs": 86400
          }
        },
        "storeAndForwardConfiguration": {
          "timeToLiveSecs": 10
        }
      }
    },
    "module1": { ... },
    "module2": { ... }
  }
}
```

Схема концентратора IoT Edge версии 1,1 была выпущена вместе с IoT Edge версии 1.0.10 и включает определение приоритета маршрута и срок жизни. Версия схемы 1,1 рекомендуется для любого IoT Edgeного развертывания с версией 1.0.10 или более поздней.

Каждому маршруту нужен *источник* , откуда поступают сообщения, и *приемник* , куда попадают сообщения. *Условие* является необязательным элементом, который можно использовать для фильтрации сообщений.

Можно назначить *приоритеты* маршрутам, которые должны сначала обрабатывать свои сообщения. Эта функция полезна в сценариях, где вышестоящее соединение является ненадежным или ограниченным, и у вас есть важные данные, для которых необходимо задать приоритет над стандартными сообщениями телеметрии.

### <a name="source"></a>Источник

Исходная точка определяет то место, откуда поступают сообщения. IoT Edge может перенаправлять сообщения от модулей или конечных устройств.

С помощью пакетов SDK для IoT модули могут объявлять определенные очереди вывода для своих сообщений с помощью класса ModuleClient. Очереди вывода необязательны, однако они полезны для управления несколькими маршрутами. Конечные устройства могут использовать класс DeviceClient пакетов SDK для IoT для отправки сообщений на устройства шлюза IoT Edge так же, как они отправляют сообщения в Центр Интернета вещей. См. [общие сведения о пакетах SDK для Центра Интернета вещей Azure и их использовании](../iot-hub/iot-hub-devguide-sdks.md).

Свойство source может принимать любое из следующих значений:

| Источник | Описание |
| ------ | ----------- |
| `/*` | Все сообщения, отправляемые с устройства в облако, и уведомления об изменениях двойника из любого модуля или конечного устройства. |
| `/twinChangeNotifications` | Любые изменения двойника (сообщаемые свойства) из любого модуля или конечного устройства. |
| `/messages/*` | Все сообщения, отправляемые с устройства в облако модулем или конечным устройством с выходными данными или без них. |
| `/messages/modules/*` | Все сообщения с устройства в облако, отправленные модулем с некоторыми выходными данными или без них. |
| `/messages/modules/<moduleId>/*` | Все сообщения, отправляемые с устройства в облако конкретным модулем с выходными данными или без них. |
| `/messages/modules/<moduleId>/outputs/*` | Все сообщения, отправляемые с устройства в облако конкретным модулем с выходными данными или без них. |
| `/messages/modules/<moduleId>/outputs/<output>` | Все сообщения, отправляемые с устройства в облако конкретным модулем с выходными данными или без них. |

### <a name="condition"></a>Условие

Условие является необязательным при объявлении маршрута. Если нужно передать все сообщения из источника в приемник, просто не заполняйте предложение **WHERE**. Можно также воспользоваться [языком запросов Центра Интернета вещей](../iot-hub/iot-hub-devguide-routing-query-syntax.md) для фильтрации определенных сообщений или типов сообщений, удовлетворяющих заданному условию. Маршруты IoT Edge не поддерживает фильтрацию сообщений на основе тегов или свойств двойников.

Сообщения, которые проходят между модулями в IoT Edge, форматируются так же, как сообщения, которые проходят между вашими устройствами и Центром Интернета вещей. Все сообщения представлены в формате JSON с параметрами **systemProperties**, **appProperties** и **body**.

Запросы для всех трех параметров создаются с помощью следующего синтаксиса:

* свойства системы — `$<propertyName>` или `{$<propertyName>}`;
* свойства приложения — `<propertyName>`;
* свойства текста —`$body.<propertyName>`.

Примеры создания запросов к свойствам сообщений см. в разделе [Выражения запросов по маршрутам сообщений, отправляемых с устройства в облако](../iot-hub/iot-hub-devguide-routing-query-syntax.md).

Характерным примером для IoT Edge является ситуация, когда вам нужно выполнить фильтрацию для сообщений, поступивших на устройство шлюза с конечного устройства. Поступающие от модулей сообщения содержат системное свойство с именем **connectionModuleId**. Так что, если нужно направить сообщения от конечных устройств к Центру Интернета вещей, используйте следующий маршрут, чтобы исключить сообщения от модулей.

```query
FROM /messages/* WHERE NOT IS_DEFINED($connectionModuleId) INTO $upstream
```

### <a name="sink"></a>Приемник

Конечная точка определяет пункт назначения отправленных сообщений. Только модули и Центр Интернета вещей могут получать сообщения. Сообщения невозможно перенаправить на другие устройства. Для свойства приемника не поддерживаются подстановочные знаки.

Свойство sink может принимать любое из следующих значений:

| Приемник | Описание |
| ---- | ----------- |
| `$upstream` | Отправляет сообщение в Центр Интернета вещей. |
| `BrokeredEndpoint("/modules/<moduleId>/inputs/<input>")` | Отправка сообщений на определенный вход конкретного модуля |

IoT Edge предоставляет гарантии как минимум однократной доставки. Если маршрут не может доставить сообщение в назначенный приемник, центр IoT Edge сохраняет такое сообщение локально. Например, если центр IoT Edge не может подключиться к Центру Интернета вещей или не подключен целевой модуль.

Центр IoT Edge хранит сообщения до окончания срока хранения, указанного в свойстве `storeAndForwardConfiguration.timeToLiveSecs` [требуемых свойств концентратора Edge](module-edgeagent-edgehub.md).

### <a name="priority-and-time-to-live"></a>Приоритет и срок жизни

Маршруты могут быть объявлены либо просто строкой, определяющей маршрут, либо объектом, принимающим строку маршрута, целочисленным значением приоритета и целым числом времени жизни.

Вариант 1.

   ```json
   "route1": "FROM <source> WHERE <condition> INTO <sink>",
   ```

Вариант 2, введенный в IoT Edge версии 1.0.10 с схемой центра IoT Edge версии 1,1:

   ```json
   "route2": {
     "route": "FROM <source> WHERE <condition> INTO <sink>",
     "priority": 0,
     "timeToLiveSecs": 86400
   }
   ```

Значения **приоритета** могут быть 0-9 включительно, где 0 — наивысший приоритет. Сообщения помещаются в очередь на основе их конечных точек. Все сообщения с приоритетом 0, предназначенные для определенной конечной точки, будут обработаны до обработки всех сообщений с приоритетом 1, направленных на одну и ту же конечную точку, и вниз по линии. Если несколько маршрутов для одной конечной точки имеют одинаковый приоритет, их сообщения будут обрабатываться с учетом первых поступающих. Если приоритет не указан, маршруту назначается самый низкий приоритет.

Свойство **тиметоливесекс** наследует свое значение от **стореандфорвардконфигуратион** концентратора IOT EDGE, если только явно не задано. Значением может быть любое положительное целое число.

Подробные сведения об управлении очередями приоритетов см. на странице справки по [приоритету маршрута и сроку жизни](https://github.com/Azure/iotedge/blob/master/doc/Route_priority_and_TTL.md).

## <a name="define-or-update-desired-properties"></a>Определение или обновление требуемых свойств

Манифест развертывания определяет требуемые средства для каждого модуля, развернутого в устройстве IoT Edge. Требуемые свойства в манифесте развертывания переопределяют любые требуемые свойства, находящиеся на данный момент в двойнике модуля.

Если вы не укажете требуемые свойства двойника модуля в манифесте развертывания, Центр Интернета вещей не будет изменять двойник модуля. Вместо этого требуемые свойства можно задать программным способом.

Для изменения двойников модуля используются те же механизмы, что и для двойников устройства. Дополнительные сведения см. в статье [Общие сведения о двойниках модулей и их использование в Центре Интернета вещей](../iot-hub/iot-hub-devguide-module-twins.md).

## <a name="deployment-manifest-example"></a>Пример манифеста развертывания

Ниже демонстрируется пример допустимого документа с манифестом развертывания.

```json
{
  "modulesContent": {
    "$edgeAgent": {
      "properties.desired": {
        "schemaVersion": "1.1",
        "runtime": {
          "type": "docker",
          "settings": {
            "minDockerVersion": "v1.25",
            "loggingOptions": "",
            "registryCredentials": {
              "ContosoRegistry": {
                "username": "myacr",
                "password": "<password>",
                "address": "myacr.azurecr.io"
              }
            }
          }
        },
        "systemModules": {
          "edgeAgent": {
            "type": "docker",
            "settings": {
              "image": "mcr.microsoft.com/azureiotedge-agent:1.1",
              "createOptions": ""
            }
          },
          "edgeHub": {
            "type": "docker",
            "status": "running",
            "restartPolicy": "always",
            "startupOrder": 0,
            "settings": {
              "image": "mcr.microsoft.com/azureiotedge-hub:1.1",
              "createOptions": "{\"HostConfig\":{\"PortBindings\":{\"443/tcp\":[{\"HostPort\":\"443\"}],\"5671/tcp\":[{\"HostPort\":\"5671\"}],\"8883/tcp\":[{\"HostPort\":\"8883\"}]}}}"
            }
          }
        },
        "modules": {
          "SimulatedTemperatureSensor": {
            "version": "1.0",
            "type": "docker",
            "status": "running",
            "restartPolicy": "always",
            "startupOrder": 2,
            "settings": {
              "image": "mcr.microsoft.com/azureiotedge-simulated-temperature-sensor:1.0",
              "createOptions": "{}"
            }
          },
          "filtermodule": {
            "version": "1.0",
            "type": "docker",
            "status": "running",
            "restartPolicy": "always",
            "startupOrder": 1,
            "env": {
              "tempLimit": {"value": "100"}
            },
            "settings": {
              "image": "myacr.azurecr.io/filtermodule:latest",
              "createOptions": "{}"
            }
          }
        }
      }
    },
    "$edgeHub": {
      "properties.desired": {
        "schemaVersion": "1.1",
        "routes": {
          "sensorToFilter": {
            "route": "FROM /messages/modules/SimulatedTemperatureSensor/outputs/temperatureOutput INTO BrokeredEndpoint(\"/modules/filtermodule/inputs/input1\")",
            "priority": 0,
            "timeToLiveSecs": 1800
          },
          "filterToIoTHub": {
            "route": "FROM /messages/modules/filtermodule/outputs/output1 INTO $upstream",
            "priority": 1,
            "timeToLiveSecs": 1800
          }
        },
        "storeAndForwardConfiguration": {
          "timeToLiveSecs": 100
        }
      }
    }
  }
}
```

## <a name="next-steps"></a>Дальнейшие действия

* Полный список свойств, которые могут или должны быть у $edgeAgent и $edgeHub, см. в статье [Свойства агента IoT Edge и центра IoT Edge](module-edgeagent-edgehub.md).

* Теперь, когда вы знаете, как используются модули IoT Edge, ознакомьтесь со статьей [Сведения о требованиях и средствах разработки модулей IoT Edge](module-development.md).
