---
title: Сведения об управлении устройствами в среде выполнения — Azure IoT Edge | Документация Майкрософт
description: Узнайте, как среда выполнения IoT Edge управляет модулями, безопасностью, обменом данными и отчетами на устройствах.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 11/10/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: amqp, mqtt, devx-track-csharp
ms.openlocfilehash: c0c3a452c93b88483ac7027405665c26ceab8183
ms.sourcegitcommit: 1bdcaca5978c3a4929cccbc8dc42fc0c93ca7b30
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/13/2020
ms.locfileid: "97368517"
---
# <a name="understand-the-azure-iot-edge-runtime-and-its-architecture"></a>Общие сведения о среде выполнения Azure IoT Edge и ее архитектуре

Среда выполнения IoT Edge — это набор программ, превращающих устройство в устройство IoT Edge. В совокупности компоненты среды выполнения IoT Edge позволяют устройствам IoT Edge получать код для выполнения на границе и передавать результаты.

Среда выполнения IoT Edge отвечает за следующие функции на IoT Edge устройствах:

* Установка и обновление рабочих нагрузок на устройстве.

* Техническое обслуживание стандартов безопасности Azure IoT Edge на устройстве.

* Убедитесь, что [модули IOT Edge](iot-edge-modules.md) всегда работают.

* Передача данных о состоянии работоспособности модуля в облако для удаленного мониторинга.

* Управление связью между подчиненными устройствами и IoT Edge устройствами.

* Управление связью между модулями на IoT Edge устройстве.

* Управление связью между устройством IoT Edge и облаком.
<!-- 1.2.0 -->
::: moniker range=">=iotedge-2020-11"
* Управление связью между устройствами IoT Edge.
::: moniker-end

![Среда выполнения передает аналитические сведения и информацию о работоспособности модуля в Центр Интернета вещей](./media/iot-edge-runtime/Pipeline.png)

Обязанности среды выполнения IoT Edge делятся на две категории: обмен данными и управление модулями. Эти две роли выполняются двумя компонентами, которые являются частью среды выполнения IoT Edge. *Агент IOT Edge* развертывает и отслеживает модули, а *центр IOT Edge* отвечает за обмен данными.

Как агент IoT Edge, так и центр IoT Edge являются модулями, как и любой другой модуль, выполняющийся на IoT Edge устройстве. Иногда они называются *модулями среды выполнения*.

## <a name="iot-edge-agent"></a>Агент IoT Edge

Агент IoT Edge — это один из двух модулей, образующих среду выполнения Azure IoT Edge. Он отвечает за создание экземпляров модулей, обеспечивая их работу и сообщение о состоянии модулей обратно в Центр Интернета вещей. Эти данные конфигурации записываются как свойство модуля IoT Edge агента двойника.

[Управляющая программа безопасности IoT Edge](iot-edge-security-manager.md) запускает агент IoT Edge при запуске устройства. Агент получает свой двойник модуля из Центра Интернета вещей и проверяет манифест развертывания. Манифест развертывания — это файл JSON, который объявляет необходимые для запуска модули.

Каждый элемент в манифесте развертывания содержит определенные сведения о модуле и используется агентом IoT Edge для управления жизненным циклом модуля. Дополнительные сведения о свойствах, используемых агентом IoT Edge для управления модулями, см. в статье [Свойства агента IOT EDGE и IOT Edge модуля концентратора двойников](module-edgeagent-edgehub.md).

Агент IoT Edge отправляет ответ среды выполнения в центр Интернета вещей. Ниже перечислены возможные ответы:
  
* 200 – OK
* 400 — конфигурация развертывания имеет неправильный формат или недопустима.
* 417-у устройства нет набора конфигураций развертывания.
* 412 — версия схемы в конфигурации развертывания недопустима.
* 406 — устройство IoT Edge работает в автономном режиме или не отправляет отчеты о состоянии.
* 500 — в среде выполнения IoT Edge произошла ошибка.

Дополнительные сведения о создании манифестов развертывания см. в статьях о [развертывании модулей и установке маршрутов в IOT Edge](module-composition.md).

### <a name="security"></a>Безопасность

Агент IoT Edge играет важную роль в обеспечении безопасности устройства IoT Edge. Например, он выполняет такие действия, как проверка образа модуля перед его запуском.

Дополнительные сведения о Azure IoT Edgeной платформе безопасности см. в статье [Диспетчер безопасности IOT Edge](iot-edge-security-manager.md).

## <a name="iot-edge-hub"></a>Концентратор IoT Edge

Центр IoT Edge — это другой модуль, составляющий среду выполнения Azure IoT Edge. Он действует в качестве локального прокси-сервера для Центра Интернета вещей, предоставляя те же конечные точки протокола, что и Центр Интернета вещей. Такая согласованность означает, что клиенты могут подключаться к среде выполнения IoT Edge так же, как и к центру Интернета вещей.

Центр IoT Edge не является полной версией центра Интернета вещей, работающего локально. IoT Edge концентратор автоматически делегирует некоторые задачи в центр Интернета вещей. Например, центр IoT Edge автоматически скачивает сведения об авторизации из центра Интернета вещей при первом подключении, чтобы разрешить устройству подключаться. После установки первого соединения информация авторизации кэшируется локально IoT Edge центре. Будущие подключения с этого устройства авторизованы без необходимости повторного скачивания сведений об авторизации из облака.

### <a name="cloud-communication"></a>Взаимодействие с облаком

Чтобы уменьшить пропускную способность, используемую решением IoT Edge, центр IoT Edge оптимизирует количество фактических подключений к облаку. Концентратор IoT Edge принимает логические соединения от модулей или подчиненных устройств и объединяет их для одного физического подключения к облаку. Сведения об этом процессе прозрачны для остальной части решения. Клиенты думают, что имеют собственное подключение к облаку, несмотря на то что передача данных выполняется через одно подключение. Центр IoT Edge может использовать протокол AMQP или MQTT для обмена данными между потоками и облаком независимо от протоколов, используемых подчиненными устройствами. Однако в настоящее время центр IoT Edge поддерживает комбинирование логических соединений только в одно физическое подключение, используя AMQP в качестве вышестоящего протокола и его возможностей мультиплексирования. AMQP является вышестоящим протоколом по умолчанию.

![Центр IoT Edge — это шлюз между физическими устройствами и Центром Интернета вещей](./media/iot-edge-runtime/gateway-communication.png)

Центр IoT Edge может определить, подключен ли он к Центру Интернета вещей. Если подключение потеряно, центр IoT Edge сохранит сообщения или операции обновления двойников локально. Когда подключение будет снова установлено, он выполнит синхронизацию всех данных. Расположение, используемое для этого временного кэша, определяется свойством двойникаого модуля концентратора IoT Edge. Размер кэша не ограничен и будет увеличиваться, пока у устройства есть емкость хранилища. Дополнительные сведения см. в разделе [возможности автономного режима](offline-capabilities.md).

<!-- <1.1> -->
::: moniker range="iotedge-2018-06"

### <a name="module-communication"></a>Обмен данными между модулями

Центр IoT Edge облегчает обмен данными между модулями. Благодаря использованию центра IoT Edge в качестве брокера сообщений модули независимы друг от друга. Модулям необходимо указывать только те входы, на которые они принимают сообщения, и выходы, на которые они записывают сообщения. Разработчик решения может объединить эти входные и выходные данные вместе, чтобы модули обрабатывали данные в порядке, определенном для этого решения.

![Центр IoT Edge облегчает обмен данными между модулями](./media/iot-edge-runtime/module-endpoints.png)

Для отправки данных в центр IoT Edge модуль вызывает метод SendEventAsync. Первый аргумент указывает, в какой выход нужно отправить сообщение. Следующий псевдокод отправляет сообщение в **output1**:

   ```csharp
   ModuleClient client = await ModuleClient.CreateFromEnvironmentAsync(transportSettings);
   await client.OpenAsync();
   await client.SendEventAsync("output1", message);
   ```

Для получения сообщений зарегистрируйте обратный вызов, который обрабатывает сообщения, приходящие в определенный вход. Следующий псевдокод регистрирует функцию Мессажепроцессор, которая будет использоваться для обработки всех сообщений, полученных в **INPUT1**:

   ```csharp
   await client.SetInputMessageHandlerAsync("input1", messageProcessor, userContext);
   ```

Дополнительные сведения о классе модулеклиент и его методах связи см. в справочнике по API для вашего предпочтительного языка SDK: [C#](/dotnet/api/microsoft.azure.devices.client.moduleclient), [C](/azure/iot-hub/iot-c-sdk-ref/iothub-module-client-h), [Python](/python/api/azure-iot-device/azure.iot.device.iothubmoduleclient), [Java](/java/api/com.microsoft.azure.sdk.iot.device.moduleclient)или [Node.js](/javascript/api/azure-iot-device/moduleclient).

Разработчик решений отвечает за указание правил, определяющих, как центр IoT Edge передает сообщения между модулями. Правила маршрутизации определяются в облаке и передаются в IoT Edge Hub в своем модуле двойника. Тот же синтаксис для маршрутов Центра Интернета вещей используется при определении маршрутов между модулями в Azure IoT Edge. Подробную информацию см. в статье [Сведения о развертывании модулей и настройке маршрутов в IoT Edge](module-composition.md).

![Маршруты между модулями проходят через центр IoT Edge](./media/iot-edge-runtime/module-endpoints-routing.png)
::: moniker-end

<!-- <1.2> -->
::: moniker range=">=iotedge-2020-11"

### <a name="local-communication"></a>Локальная связь

Концентратор IoT Edge упрощает локальную связь. Это обеспечивает взаимодействие между устройством и модулем, взаимосвязь с устройством и устройством посредством брокера сообщений, чтобы устройства и модули оставались независимыми друг от друга.

>[!NOTE]
> Компонент MQTT Broker находится в общедоступной предварительной версии с IoT Edge версией 1,2. Его необходимо включить явным образом.

Концентратор IoT Edge поддерживает два механизма брокера:

1. [Функции маршрутизации сообщений, поддерживаемые центром Интернета вещей](../iot-hub/iot-hub-devguide-messages-d2c.md) ;
2. Брокер общего назначения MQTT, который соответствует [MQTT Standard v 3.1.1](https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html)

#### <a name="using-routing"></a>Использование маршрутизации

Первый механизм брокера использует те же функции маршрутизации, что и центр Интернета вещей, для указания способа передачи сообщений между устройствами или модулями. Первые устройства или модули указывают входные данные, на которых они принимают сообщения, и выходные данные, в которые они записывают сообщения. Затем разработчик решения может маршрутизировать сообщения между источником, например выходами и назначением, например входными данными, с потенциальными фильтрами.

![Маршруты между модулями проходят через центр IoT Edge](./media/iot-edge-runtime/module-endpoints-routing.png)

Маршрутизация может использоваться устройствами или модулями, созданными с помощью пакетов SDK для устройств Azure IoT, через протокол AMQP или MQTT. Все примитивы центра Интернета вещей, например данные телеметрии, прямые методы, C2D, двойников, поддерживаются, но обмен данными с пользовательскими разделами не поддерживается.

Дополнительные сведения о маршрутах см. в статьях о [развертывании модулей и установке маршрутов в IOT Edge](module-composition.md)

#### <a name="using-the-mqtt-broker"></a>Использование брокера MQTT

Второй механизм брокера основан на стандартном брокере MQTT. MQTT — это упрощенный протокол обмена сообщениями, который гарантирует оптимальную производительность на устройствах с ограниченными ресурсами и является популярным стандартом публикации и подписки. Устройства или модули подписываются на разделы для получения сообщений, опубликованных другими устройствами или модулями. Центр IoT Edge реализует собственный брокер MQTT, который соответствует [спецификациям MQTT версии 3.1.1](https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html).

Брокер MQTT обеспечивает два дополнительных шаблона связи по сравнению с маршрутизацией: локальная рассылка и обмен данными "точка — точка". Локальная трансляция полезна, когда одному устройству или модулю требуется локальное оповещение о нескольких других устройствах или модулях. Связь "точка — точка" позволяет двум IoT Edgeным устройствам или двум устройствам Интернета вещей взаимодействовать локально без обращения к облаку.

![Публикация и подписка в локальной среде с помощью центра IoT Edge](./media/iot-edge-runtime/local-communnication-mqtt-broker.png)

Брокер MQTT может использоваться устройствами или модулями, созданными с помощью пакетов SDK для устройств Azure IoT, которые взаимодействуют через протокол MQTT или любыми клиентами MQTT общего назначения. За исключением C2D всех типов центра Интернета вещей для обмена сообщениями, например телеметрии, прямые методы, двойников поддерживаются. Специальные разделы центра Интернета вещей, используемые примитивами центра Интернета вещей, поддерживаются, поэтому они являются пользовательскими разделами.
Этот раздел может быть специальным разделом центра Интернета вещей или определенным пользователем разделом.

В отличие от механизма маршрутизации, упорядочение сообщений является только наилучшим вариантом и не гарантируется, а фильтрация сообщений не поддерживается брокером. Недостаток этих функций, тем не менее, позволяет брокеру MQTT работать быстрее, чем маршрутизация.

Дополнительные сведения о MQTT Broker см. в статье [Публикация и подписка с помощью IOT Edge](how-to-publish-subscribe.md)

#### <a name="comparison-between-brokering-mechanisms"></a>Сравнение механизмов брокера

Ниже приведены функции, доступные для каждого механизма брокера:

|Компоненты  | Маршрутизация  | Брокер MQTT  |
|---------|---------|---------|
|D2C телеметрии    |     &#10004;    |         |
|Локальные данные телеметрии     |     &#10004;    |    &#10004;     |
|DirectMethods     |    &#10004;     |    &#10004;     |
|Двойника     |    &#10004;     |    &#10004;     |
|C2D для устройств     |   &#10004;      |         |
|Упорядочение     |    &#10004;     |         |
|Фильтрация     |     &#10004;    |         |
|Пользовательские разделы     |         |    &#10004;     |
|С устройства на устройство     |         |    &#10004;     |
|Локальная трансляция     |         |    &#10004;     |
|Производительность     |         |    &#10004;     |

### <a name="connecting-to-the-iot-edge-hub"></a>Подключение к концентратору IoT Edge

Центр IoT Edge принимает подключения от клиентов устройства или модуля либо по протоколу MQTT, либо по протоколу AMQP.

>[!NOTE]
> Центр IoT Edge поддерживает клиенты, подключающиеся с помощью MQTT или AMQP. Он не поддерживает клиенты, использующие HTTP.

Когда клиент подключается к концентратору IoT Edge, происходит следующее:

1. Если используется протокол TLS (рекомендуется), создается канал TLS, позволяющий установить зашифрованный обмен данными между клиентом и концентратором IoT Edge.
2. Сведения о проверке подлинности отправляются от клиента к концентратору IoT Edge, чтобы идентифицировать себя.
3. Центр IoT Edge разрешает или отклоняет подключение в соответствии с политикой авторизации.

#### <a name="secure-connections-tls"></a>Безопасные соединения (TLS)

По умолчанию центр IoT Edge принимает только подключения, защищенные с помощью протокола TLS, например зашифрованные соединения, которые третьим лицом не удается расшифровать.

Если клиент подключается через порт 8883 (МКТТС) или 5671 (AMQPS) к концентратору IoT Edge, должен быть построен TLS-канал. Во время подтверждения TLS центр IoT Edge отправляет свою цепочку сертификатов, которую клиент должен проверить. Чтобы проверить цепочку сертификатов, корневой сертификат концентратора IoT Edge должен быть установлен в качестве доверенного сертификата на клиенте. Если корневой сертификат не является доверенным, клиентская библиотека будет отклонена концентратором IoT Edge с ошибкой проверки сертификата.

Действия по установке этого корневого сертификата брокера на клиентах устройств описаны в разделе [прозрачный шлюз](how-to-create-transparent-gateway.md) и в документации [Подготовка подчиненного устройства](how-to-connect-downstream-device.md#prepare-a-downstream-device) . Модули могут использовать тот же корневой сертификат, что и центр IoT Edge, используя API управляющей программы IoT Edge.

#### <a name="authentication"></a>Проверка подлинности

Концентратор IoT Edge принимает только подключения от устройств или модулей, имеющих удостоверение центра Интернета вещей, например, которые были зарегистрированы в центре Интернета вещей и имеют один из трех методов проверки подлинности клиента, поддерживаемых центром Интернета вещей для подтверждения их подлинности: [симметричные ключи аутентификации](how-to-authenticate-downstream-device.md#symmetric-key-authentication), [самоподписанная аутентификация x. 509, самозаверяющий](how-to-authenticate-downstream-device.md#x509-self-signed-authentication)сертификат [x. 509](how-to-authenticate-downstream-device.md#x509-ca-signed-authentication).  Эти удостоверения центра Интернета вещей можно проверить локально в центре IoT Edge, чтобы подключения могли быть сделаны в автономном режиме.

Примечания.

* Модули IoT Edge в настоящее время поддерживают только проверку подлинности с симметричным ключом.
* MQTT клиенты, имеющие только локальные имя пользователя и пароли, не IoT Edge принимаются посредником MQTT Hub, они должны использовать удостоверения центра Интернета вещей.

#### <a name="authorization"></a>Авторизация

После проверки подлинности центр IoT Edge имеет два способа авторизации клиентских подключений:

* Проверка принадлежности клиента к набору доверенных клиентов, определенных в центре Интернета вещей. Набор доверенных клиентов указывается путем настройки отношений "родители-потомки" или "устройство/модуль" в центре Интернета вещей. При создании модуля в IoT Edge доверительные отношения автоматически устанавливаются между этим модулем и его IoT Edge устройством. Это единственная модель авторизации, поддерживаемая механизмом брокера маршрутизации.

* Путем настройки политики авторизации. Эта политика авторизации — это документ со списком всех авторизованных удостоверений клиентов, которые могут получать доступ к ресурсам в центре IoT Edge. Это основная модель авторизации, используемая брокером IoT Edge Hub MQTT, хотя отношения "родитель-потомок" и "устройство/модуль" также могут быть понятны в разделах MQTT Broker для центра Интернета вещей.

### <a name="remote-configuration"></a>Удаленная настройка

Центр IoT Edge полностью управляется облаком. Она получает конфигурацию из центра Интернета вещей через его [модуль двойника](iot-edge-modules.md#module-twins). Сюда входят:

* Конфигурация маршрутов
* Политики авторизации,
* Конфигурация моста MQTT

Кроме того, можно выполнить несколько конфигураций, настроив [переменные среды в центре IOT Edge](https://github.com/Azure/iotedge/blob/master/doc/EnvironmentVariables.md).
<!-- </1.2> -->
::: moniker-end

## <a name="runtime-quality-telemetry"></a>Данные телеметрии качества среды выполнения

IoT Edge собирает анонимные данные телеметрии из среды выполнения узла и системных модулей для улучшения качества продукта. Эти сведения называются телеметрии качества среды выполнения. Собранные данные телеметрии периодически отправляются в центр Интернета вещей из агента IoT Edge в качестве сообщений, отправляемых с устройства в облако. Эти сообщения не отображаются в обычных телеметрических данных клиента и не потребляют квоты на сообщения.

Агент IoT Edge и концентратор создают метрики, которые можно собираются для понимания производительности устройства. Подмножество этих метрик собирается агентом IoT Edge как часть телеметрии качества выполнения. Метрики, собранные для телеметрии качества выполнения, помечаются тегом `ms_telemetry` . Сведения обо всех доступных метриках см. в разделе [доступ к встроенным метрикам](how-to-access-built-in-metrics.md).

Любые личные или организационные сведения, такие как имена устройств и модулей, удаляются перед отправкой, чтобы обеспечить анонимную природу телеметрии качества среды выполнения.

Агент IoT Edge собирает данные телеметрии каждый час и отправляет одно сообщение в центр Интернета вещей каждые 24 часа.

Если вы хотите отказаться от отправки данных телеметрии среды выполнения с устройств, сделайте это двумя способами:

* Задайте `SendRuntimeQualityTelemetry` для переменной среды значение `false` for **edgeAgent** или
* Снимите флажок в портал Azure во время развертывания.

## <a name="next-steps"></a>Дальнейшие действия

* [Общие сведения о модулях Azure IoT Edge](iot-edge-modules.md)
* [Сведения о развертывании модулей и настройке маршрутов в IoT Edge](module-composition.md)
* [Сведения о публикации и подписываться на IoT Edge](how-to-publish-subscribe.md)
* [Дополнительные сведения о метриках среды выполнения IoT Edge](how-to-access-built-in-metrics.md)
