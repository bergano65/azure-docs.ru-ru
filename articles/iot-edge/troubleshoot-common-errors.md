---
title: Распространенные ошибки — Azure IoT Edge | Документация Майкрософт
description: Используйте эту статью для устранения распространенных проблем, возникающих при развертывании решения IoT Edge
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 04/27/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom:
- amqp
- mqtt
ms.openlocfilehash: ed93d24bc06a6622a8ace2b0ab6b44582da001c0
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "82783751"
---
# <a name="common-issues-and-resolutions-for-azure-iot-edge"></a>Распространенные проблемы и их решения для Azure IoT Edge

В этой статье содержатся инструкции по устранению распространенных проблем, которые могут возникнуть при развертывании решений IoT Edge. Сведения о том, как найти журналы и ошибки на устройстве IoT Edge, см. в разделе [Устранение неполадок устройства IOT Edge](troubleshoot.md).

## <a name="iot-edge-agent-stops-after-about-a-minute"></a>Агент IoT Edge останавливается через минуту

**Наблюдаемое поведение**

Модуль edgeAgent запускается и выполняется успешно в течение минуты, а затем останавливается. Журналы указывают, что агент IoT Edge пытается подключиться к центру Интернета вещей через AMQP, а затем пытается подключиться с помощью AMQP через WebSocket. В случае сбоя агент IoT Edge завершает работу.

Примеры журналов edgeAgent:

```output
2017-11-28 18:46:19 [INF] - Starting module management agent.
2017-11-28 18:46:19 [INF] - Version - 1.0.7516610 (03c94f85d0833a861a43c669842f0817924911d5)
2017-11-28 18:46:19 [INF] - Edge agent attempting to connect to IoT Hub via AMQP...
2017-11-28 18:46:49 [INF] - Edge agent attempting to connect to IoT Hub via AMQP over WebSocket...
```

**Основная причина:**

Сетевая конфигурация в сети узла не позволяет агенту IoT Edge достичь сети. Сначала агент пытается подключиться через AMQP (порт 5671). Если это не удается, он пытается подключиться через WebSocket (порт 443).

Среда выполнения IoT Edge настраивает сеть для всех модулей, с которыми нужно взаимодействовать. В Linux этой сетью является мостовая сеть. В Windows используется NAT. Эта проблема чаще всего встречается на устройствах с Windows, использующих контейнеры Windows с сетью NAT.

**Решение:**

Должен быть маршрут к Интернету для IP-адресов, назначенных этой мостовой сети или сети NAT. Иногда конфигурация VPN на узле переопределяет сеть IoT Edge.

## <a name="iot-edge-agent-cant-access-a-modules-image-403"></a>Агенту IoT Edge не удается получить доступ к образу модуля (403)

**Наблюдаемое поведение**

Не удается запустить контейнер, и в журналах edgeAgent отображается ошибка 403.

**Основная причина:**

Агент IoT Edge не имеет разрешений на доступ к образу модуля.

**Решение:**

Убедитесь, что учетные данные реестра правильно указаны в манифесте развертывания.

## <a name="edge-agent-module-reports-empty-config-file-and-no-modules-start-on-the-device"></a>Модуль агента пограничной стороны сообщает о пустом файле конфигурации и не запускает модули на устройстве

**Наблюдаемое поведение**

Устройству не удается запустить модули, определенные в развертывании. Только edgeAgent работает, но постоянно сообщает о пустом файле конфигурации....

**Основная причина:**

По умолчанию IoT Edge запускает модули в собственной изолированной сети контейнеров. Возможно, у устройства возникли проблемы с разрешением DNS-имен в этой частной сети.

**Решение:**

**Вариант 1. Настройка DNS-сервера в параметрах модуля контейнера**

Укажите DNS-сервер для среды в параметрах модуля контейнера, которые будут применяться ко всем модулям контейнеров, запущенным ядром. Создайте файл с именем `daemon.json` , указав DNS-сервер для использования. Пример:

```json
{
    "dns": ["1.1.1.1"]
}
```

В приведенном выше примере DNS-сервер задается для общедоступной службы DNS. Если пограничному устройству не удается получить доступ к этому IP-адресу из своей среды, замените его на доступный для сервера DNS-сервер.

Место `daemon.json` в правильном расположении для вашей платформы:

| Платформа | Расположение |
| --------- | -------- |
| Linux | `/etc/docker` |
| Узел Windows с контейнерами Windows | `C:\ProgramData\iotedge-moby\config` |

Если расположение уже содержит `daemon.json` файл, добавьте к нему ключ **DNS** и сохраните файл.

Перезапустите модуль контейнера, чтобы обновления вступили в силу.

| Платформа | Get-Help |
| --------- | -------- |
| Linux | `sudo systemctl restart docker` |
| Windows (административная оболочка PowerShell) | `Restart-Service iotedge-moby -Force` |

**Вариант 2. Настройка DNS-сервера при развертывании IoT Edge на модуль**

Вы можете задать DNS-сервер для каждого *креатеоптионс* модуля в развертывании IOT Edge. Пример:

```json
"createOptions": {
  "HostConfig": {
    "Dns": [
      "x.x.x.x"
    ]
  }
}
```

Обязательно задайте эту конфигурацию для модулей *edgeAgent* и *edgeHub* .

## <a name="iot-edge-hub-fails-to-start"></a>Не удается запустить центр IoT Edge

**Наблюдаемое поведение**

Не удается запустить модуль edgeHub. В журналах может появиться сообщение, такое как одна из следующих ошибок:

```output
One or more errors occurred.
(Docker API responded with status code=InternalServerError, response=
{\"message\":\"driver failed programming external connectivity on endpoint edgeHub (6a82e5e994bab5187939049684fb64efe07606d2bb8a4cc5655b2a9bad5f8c80):
Error starting userland proxy: Bind for 0.0.0.0:443 failed: port is already allocated\"}\n)
```

либо

```output
info: edgelet_docker::runtime -- Starting module edgeHub...
warn: edgelet_utils::logging -- Could not start module edgeHub
warn: edgelet_utils::logging --     caused by: failed to create endpoint edgeHub on network nat: hnsCall failed in Win32:  
        The process cannot access the file because it is being used by another process. (0x20)
```

**Основная причина:**

Другой процесс на хост-компьютере привязывает порт, который пытается привязать модуль edgeHub. Центр IoT Edge сопоставляет порты 443, 5671 и 8883 для использования в сценариях шлюза. Модуль не запускается, если один из этих портов уже привязан другим процессом.

**Решение:**

Эту проблему можно устранить двумя способами:

Если устройство IoT Edge работает как устройство шлюза, необходимо найти и прерывать процесс, использующий порт 443, 5671 или 8883. Ошибка порта 443 обычно означает, что другой процесс является веб-сервером.

Если вы не хотите использовать устройство IoT Edge в качестве шлюза, можно удалить привязки портов из модуля edgeHub Создание параметров. Параметры создания можно изменить в портал Azure или непосредственно в deployment.jsв файле.

На портале Azure выполните следующие действия.

1. Перейдите в центр Интернета вещей и выберите **IOT Edge**.

2. Выберите устройство IoT Edge, которое требуется обновить.

3. Выберите **задать модули**.

4. Выберите **Параметры среды выполнения**.

5. В параметрах модуля **концентратора ребра** удалите все данные из текстового поля **Создание параметров** .

6. Сохраните изменения и создайте развертывание.

В deployment.jsфайла:

1. Откройте deployment.jsфайла, который был применен к устройству IoT Edge.

2. Найдите `edgeHub` Параметры в разделе требуемые свойства edgeAgent:

   ```json
   "edgeHub": {
       "settings": {
           "image": "mcr.microsoft.com/azureiotedge-hub:1.0",
           "createOptions": "{\"HostConfig\":{\"PortBindings\":{\"8883/tcp\":[{\"HostPort\":\"8883\"}],\"443/tcp\":[{\"HostPort\":\"443\"}]}}}"
       },
       "type": "docker",
       "status": "running",
       "restartPolicy": "always"
   }
   ```

3. `createOptions`Перед строкой удалите строку и завершающую запятую в конце `image` строки:

   ```json
   "edgeHub": {
       "settings": {
           "image": "mcr.microsoft.com/azureiotedge-hub:1.0"
       },
       "type": "docker",
       "status": "running",
       "restartPolicy": "always"
   }
   ```

4. Сохраните файл и примените его к устройству IoT Edge.

## <a name="iot-edge-security-daemon-fails-with-an-invalid-hostname"></a>Сбой управляющей программы безопасности IoT Edge с недопустимым именем узла

**Наблюдаемое поведение**

Попытка [проверить журналы диспетчера безопасности IOT Edge](troubleshoot.md#check-the-status-of-the-iot-edge-security-manager-and-its-logs) завершается сбоем и выводит следующее сообщение:

```output
Error parsing user input data: invalid hostname. Hostname cannot be empty or greater than 64 characters
```

**Основная причина:**

Среда выполнения IoT Edge поддерживает только имена узлов, которые короче 64 символов. Физические компьютеры обычно не имеют длинных имен узлов. Эта ошибка более типична для виртуальных машин. Автоматически создаваемые имена узлов для виртуальных машин Windows, размещенных в Azure, часто бывают длинными.

**Решение:**

Эту ошибку можно устранить, настроив DNS-имя виртуальной машины, а затем задав DNS-имя в качестве имени узла в команде установки.

1. На портале Azure перейдите к странице обзора виртуальной машины.
2. Выберите **Настроить** под DNS-именем. Если для виртуальной машины уже настроено DNS-имя, настраивать новое не нужно.

   ![Настройка DNS-имени виртуальной машины](./media/troubleshoot/configure-dns.png)

3. Укажите значение в поле **Метка DNS-имени** и выберите **Сохранить**.
4. Скопируйте новое DNS-имя, которое должно быть в формате ** \<DNSnamelabel\> . \<vmlocation\> cloudapp.azure.com**.
5. В виртуальной машине используйте следующую команду для настройки среды выполнения IoT Edge с DNS-именем:

   * В Linux

      ```bash
      sudo nano /etc/iotedge/config.yaml
      ```

   * В Windows:

      ```cmd
      notepad C:\ProgramData\iotedge\config.yaml
      ```

## <a name="cant-get-the-iot-edge-daemon-logs-on-windows"></a>Не удается получить журналы управляющей программы IoT Edge в Windows

**Наблюдаемое поведение**

При использовании в Windows вы получаете Евентложексцептион `Get-WinEvent` .

**Основная причина:**

Используя запись реестра, команда PowerShell `Get-WinEvent` ищет журналы по определенному имени поставщика (`ProviderName`).

**Решение:**

Задайте запись реестра управляющей программы IoT Edge. Создайте файл **iotedge.reg** с указанным ниже содержимым и импортируйте его в реестр Windows. Для этого дважды щелкните этот файл или используйте команду `reg import iotedge.reg`.

```reg
Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\EventLog\Application\iotedged]
"CustomSource"=dword:00000001
"EventMessageFile"="C:\\ProgramData\\iotedge\\iotedged.exe"
"TypesSupported"=dword:00000007
```

## <a name="stability-issues-on-smaller-devices"></a>Проблемы стабильности на небольших устройствах

**Наблюдаемое поведение**

На устройствах с ограниченными ресурсами, таких как Raspberry Pi, могут возникать проблемы с стабильностью, особенно при использовании в качестве шлюза. Симптомы включают исключения нехватки памяти в модуле концентратора IoT Edge, подчиненные устройства не подключаются или устройство не отправляет сообщения телеметрии через несколько часов.

**Основная причина:**

Центр IoT Edge, который является частью среды выполнения IoT Edge, оптимизирован для повышения производительности по умолчанию и пытается выделить большие блоки памяти. Это не идеальный вариант для устройств IoT Edge с ограниченными ресурсами, где он может привести к нестабильной работе.

**Решение:**

Для центра IoT Edge задайте для переменной среды **оптимизефорперформанце** **значение false**. Существует два способа задания переменных среды.

На портале Azure выполните следующие действия.

В центре Интернета вещей выберите устройство IOT EDGE и на странице сведения об устройстве выберите **Set modules Runtime Settings (Настройка модулей**  >  **среды выполнения**). Создайте переменную среды для модуля IoT Edge концентратора с именем *оптимизефорперформанце* , для которого задано *значение false*.

![Задание значения false для имени OptimizeForPerformance](./media/troubleshoot/optimizeforperformance-false.png)

Через манифест развертывания.

```json
"edgeHub": {
  "type": "docker",
  "settings": {
    "image": "mcr.microsoft.com/azureiotedge-hub:1.0",
    "createOptions": <snipped>
  },
  "env": {
    "OptimizeForPerformance": {
      "value": "false"
    }
  },
```

## <a name="iot-edge-module-fails-to-send-a-message-to-edgehub-with-404-error"></a>Модулю IoT Edge не удается отправить сообщение в edgeHub с ошибкой 404

**Наблюдаемое поведение**

Пользовательскому модулю IoT Edge не удается отправить сообщение в центр IoT Edge с `Module not found` ошибкой 404. Управляющая программа IoT Edge выводит в журналы следующее сообщение:

```output
Error: Time:Thu Jun  4 19:44:58 2018 File:/usr/sdk/src/c/provisioning_client/adapters/hsm_client_http_edge.c Func:on_edge_hsm_http_recv Line:364 executing HTTP request fails, status=404, response_buffer={"message":"Module not found"}u, 04 )
```

**Основная причина:**

Управляющая программа IoT Edge по соображениям безопасности принудительно применяет идентификацию процесса для всех модулей, подключающихся к edgeHub. Таким образом проверяется, что все сообщения, которые отправляются модулем, поступают с идентификатора основного процесса модуля. Если сообщение отправляется модулем с идентификатора процесса, отличного от первоначально установленного, такие сообщения будут отклоняться управляющей программой с ошибкой 404.

**Решение:**

Начиная с версии 1.0.7, всем процессам модуля разрешено подключаться. Дополнительные сведения см. в [журнале изменений выпуска 1.0.7](https://github.com/Azure/iotedge/blob/master/CHANGELOG.md#iotedged-1).

Если обновление до 1.0.7 невозможно, выполните следующие действия. Убедитесь, что для отправки сообщений в edgeHub пользовательский модуль IoT Edge всегда использует один и тот же идентификатор процесса. Например, убедитесь, что `ENTRYPOINT` вместо `CMD` команды в файле DOCKER. `CMD`Команда ведет к одному идентификатору процесса для модуля и другому идентификатору процесса для команды bash, выполняющей основную программу, но `ENTRYPOINT` ведет к одному идентификатору процесса.

## <a name="iot-edge-module-deploys-successfully-then-disappears-from-device"></a>После этого развертывание модуля IoT Edge успешно исчезает с устройства

**Наблюдаемое поведение**

После настройки модулей для устройства IoT Edge модули развертываются успешно, но через несколько минут они исчезают с устройства и из сведений об устройстве в портал Azure. Другие модули, кроме определенных, могут также отображаться на устройстве.

**Основная причина:**

Если автоматическое развертывание предназначено для устройства, оно имеет приоритет над ручным заданием модулей для одного устройства. Функция **Set modules** в портал Azure или **Создание развертывания для функций одного устройства** в Visual Studio Code вступит в силу в течение некоторого времени. Вы увидите, что определенные модули запускаются на устройстве. Затем приоритет автоматического развертывания начинается и переписывает требуемые свойства устройства.

**Решение:**

Используйте только один тип механизма развертывания для каждого устройства: автоматическое развертывание или развертывание отдельных устройств. При наличии нескольких автоматических развертываний, предназначенных для устройства, можно изменить приоритет или целевые описания, чтобы убедиться, что к конкретному устройству применяется правильный. Вы также можете обновить двойника устройства, чтобы они больше не соответствовали целевому описанию автоматического развертывания.

Дополнительные сведения см. в статье [Общие сведения об автоматических развертываниях IoT Edge для отдельных устройств или в большом масштабе](module-deployment-monitoring.md).

## <a name="next-steps"></a>Дальнейшие действия

Считаете, что обнаружили ошибку в платформе IoT Edge? [Отправьте запрос](https://github.com/Azure/iotedge/issues), чтобы мы как можно скорее устранили неисправность.

Если у вас есть другие вопросы, создайте [запрос в службу поддержки](https://portal.azure.com/#create/Microsoft.Support) для получения справки.
