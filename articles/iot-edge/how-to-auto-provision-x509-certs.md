---
title: Автоматически подготавливать устройства с помощью DPS, используя сертификаты X. 509 — Azure IoT Edge | Документация Майкрософт
description: Использование сертификатов X. 509 для тестирования автоматической подготовки устройств для Azure IoT Edge с помощью службы подготовки устройств
author: kgremban
manager: philmea
ms.author: kgremban
ms.reviewer: kevindaw
ms.date: 04/09/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: ccd8d383db265826d8644ee89d7300128fc3a350
ms.sourcegitcommit: edccc241bc40b8b08f009baf29a5580bf53e220c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/24/2020
ms.locfileid: "82131309"
---
# <a name="create-and-provision-an-iot-edge-device-using-x509-certificates"></a>Создание и инициализация устройства IoT Edge с помощью сертификатов X. 509

[Служба подготовки устройств для центра Интернета вещей Azure (DPS)](../iot-dps/index.yml)позволяет автоматически подготавливать IOT Edge устройства с помощью сертификатов X. 509. При необходимости ознакомьтесь с [процессом автоматической подготовки](../iot-dps/concepts-auto-provisioning.md), прежде чем продолжить.

В этой статье показано, как создать регистрацию службы подготовки устройств с помощью сертификатов X. 509 на устройстве IoT Edge, выполнив следующие действия.

* Создание сертификатов и ключей.
* Создайте отдельную регистрацию для устройства или групповую регистрацию для набора устройств.
* Установите среду выполнения IoT Edge и зарегистрируйте устройство в центре Интернета вещей.

Применение сертификатов X.509 в качестве механизма аттестации позволяет легко масштабировать производство и упростить подготовку устройств к работе. Обычно сертификаты X. 509 упорядочиваются в цепочку доверенных сертификатов. Начиная с самозаверяющего или доверенного корневого сертификата, каждый сертификат в цепочке подписывает следующий более низкий сертификат. Этот шаблон создает делегированную цепочку доверия от корневого сертификата вниз по каждому промежуточному сертификату до окончательного "конечного" сертификата, установленного на устройстве.

## <a name="prerequisites"></a>Предварительные условия

* Действующий Центр Интернета вещей.
* Физическое или виртуальное устройство, которое должно быть устройством IoT Edge.
* Установлена последняя версия [Git](https://git-scm.com/download/) .
* Экземпляр службы подготовки устройств центра Интернета вещей в Azure, связанный с центром Интернета вещей.
  * Если у вас нет экземпляра службы подготовки устройств, следуйте инструкциям в разделе [Настройка DP центра Интернета вещей](../iot-dps/quick-setup-auto-provision.md).
  * После запуска Службы подготовки устройств к добавлению в Центр Интернета вещей скопируйте значение **Область идентификатора** на странице обзора. Это значение используется при настройке среды выполнения IoT Edge.

## <a name="generate-device-identity-certificates"></a>Создание сертификатов удостоверений устройств

Сертификат удостоверения устройства — это конечный сертификат, который подключается через цепочку доверенных сертификатов к сертификату центра сертификации X. 509. В сертификате удостоверения устройства должно быть задано общее имя (CN), равное ИДЕНТИФИКАТОРу устройства, которое должно иметь устройство в центре Интернета вещей.

Сертификаты удостоверений устройств используются только для подготовки устройства IoT Edge и проверки подлинности устройства в центре Интернета вещей Azure. Они не подписывает сертификаты, в отличие от сертификатов ЦС, которые устройство IoT Edge предоставляет модулям или конечным устройствам для проверки. Дополнительные сведения см. в разделе [Azure IOT Edge сертификата использование](iot-edge-certs.md).

После создания сертификата удостоверения устройства необходимо иметь два файла: CER или PEM, который содержит открытую часть сертификата, и файл CER или PEM с закрытым ключом сертификата. Если вы планируете использовать групповую регистрацию в DPS, вам также потребуется открытая часть промежуточного или корневого сертификата ЦС в той же цепочке сертификатов доверия.

Чтобы настроить автоматическую подготовку с помощью X. 509, вам потребуются следующие файлы:

* Сертификат удостоверения устройства и сертификат его закрытого ключа. Сертификат удостоверения устройства отправляется в службу DPS при создании отдельной регистрации. Закрытый ключ передается в среду выполнения IoT Edge.
* Полный сертификат цепочки, который должен иметь по крайней мере удостоверение устройства и промежуточные сертификаты. Полный сертификат цепочки передается в среду выполнения IoT Edge.
* Промежуточный или корневой сертификат ЦС из цепочки доверия сертификатов. Этот сертификат отправляется в службу DPS, если вы создаете групповую регистрацию.

### <a name="use-test-certificates"></a>Использование тестовых сертификатов

Если у вас нет доступного центра сертификации для создания новых сертификатов удостоверений и вы хотите испытать этот сценарий, Azure IoT Edge репозиторий Git содержит сценарии, которые можно использовать для создания тестовых сертификатов. Эти сертификаты предназначены только для тестирования разработки и не должны использоваться в рабочей среде.

Чтобы создать тестовые сертификаты, выполните действия, описанные в статье [создание демонстрационных сертификатов для тестирования IOT Edgeных функций устройства](how-to-create-test-certificates.md). Выполните два необходимых раздела, чтобы настроить скрипты создания сертификатов и создать сертификат корневого ЦС. Затем выполните действия по созданию сертификата удостоверения устройства. По завершении у вас должны быть следующие цепочки сертификатов и пары ключей:

Linux:

* `<WRKDIR>/certs/iot-edge-device-identity-<name>-full-chain.cert.pem`
* `<WRKDIR>/private/iot-edge-device-identity-<name>.key.pem`

Windows:

* `<WRKDIR>\certs\iot-edge-device-identity-<name>-full-chain.cert.pem`
* `<WRKDIR>\private\iot-edge-device-identity-<name>.key.pem`

Эти сертификаты необходимы на IoT Edge устройстве. Если вы собираетесь использовать отдельную регистрацию в DPS, то будете отправлять файл. PEM. Если вы собираетесь использовать групповую регистрацию в DPS, вам также потребуется промежуточный или корневой сертификат ЦС в той же цепочке сертификатов, которую можно передать. Если вы используете демонстрационные сертификаты, используйте `<WRKDIR>\certs\azure-iot-test-only.root.ca.cert.pem` сертификат для групповой регистрации.

## <a name="create-a-dps-individual-enrollment"></a>Создание индивидуальной регистрации DPS

Используйте созданные сертификаты и ключи для создания отдельной регистрации в DPS для одного IoT Edge устройства. Отдельные регистрации принимают открытую часть сертификата удостоверения устройства и сопоставляют его с сертификатом на устройстве.

Если вы хотите подготавливать несколько IoT Edge устройств, выполните действия, описанные в следующем разделе, чтобы [создать групповую регистрацию DPS](#create-a-dps-group-enrollment).

При регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей есть возможность объявить **Первоначальное состояние двойника устройства**. В двойнике устройства можно задать теги для группировки устройств по любой требуемой для решения метрике, например по региону, среде, расположению или типу устройства. Эти теги используются для создания [автоматических развертываний](how-to-deploy-at-scale.md).

Дополнительные сведения о регистрациях в службе подготовки устройств см. в разделе [Управление регистрацией устройств](../iot-dps/how-to-manage-enrollments.md).

   > [!TIP]
   > В Azure CLI можно создать [регистрацию](https://docs.microsoft.com/cli/azure/ext/azure-iot/iot/dps/enrollment) или [группу регистрации](https://docs.microsoft.com/cli/azure/ext/azure-iot/iot/dps/enrollment-group) и использовать флаг с **поддержкой границ** , чтобы указать, что устройство или группа устройств является устройством IOT Edge.

1. В [портал Azure](https://portal.azure.com)перейдите к своему экземпляру службы подготовки устройств для центра Интернета вещей.

1. В разделе **Параметры**выберите **Управление регистрациями**.

1. Выберите **Добавить отдельную регистрацию** и выполните следующие действия для настройки регистрации.  

   * **Механизм**: выберите **X. 509**.

   * **Файл первичного сертификата. PEM или. cer**: Отправьте открытый файл из сертификата удостоверения устройства. Если вы использовали сценарии для создания тестового сертификата, выберите следующий файл:

      `<WRKDIR>/certs/iot-edge-device-identity-<name>.cert.pem`

   * **Идентификатор устройства центра Интернета вещей**. Укажите идентификатор устройства, если хотите. Идентификаторы устройств можно использовать, чтобы указать отдельное устройство для развертывания модуля. Если не указать идентификатор устройства, используется общее имя (CN) в сертификате X. 509.

   * **IOT Edge устройство**: выберите **значение true** , чтобы объявить о регистрации для устройства IOT Edge.

   * **Выберите центры Интернета вещей, которым может быть назначено это устройство**: выберите связанный центр Интернета вещей, к которому вы хотите подключить устройство. Можно выбрать несколько концентраторов, и устройство будет назначено одному из них в соответствии с выбранной политикой распределения.

   * **Начальное состояние двойникаа устройства**: добавьте значение тега, добавляемое в двойника устройства, если хотите. Теги можно использовать для целевых групп устройств для автоматического развертывания. Пример:

      ```json
      {
         "tags": {
            "environment": "test"
         },
         "properties": {
            "desired": {}
         }
      }
      ```

1. Щелкните **Сохранить**.

Теперь, когда для этого устройства существует регистрация, среда выполнения IoT Edge может автоматически подготавливать устройство во время установки. Перейдите к разделу [Установка среды выполнения IOT Edge](#install-the-iot-edge-runtime) , чтобы настроить устройство IOT Edge.

## <a name="create-a-dps-group-enrollment"></a>Создание группы DPS с регистрацией

Используйте созданные сертификаты и ключи, чтобы создать групповую регистрацию в DPS для нескольких IoT Edge устройств. Для групповых регистраций используется промежуточный или корневой сертификат ЦС из цепочки сертификатов доверия, используемой для создания отдельных сертификатов удостоверений устройств.

Если вместо этого вы хотите подготавливать одно IoT Edge устройство, выполните действия, описанные в предыдущем разделе [Создание отдельной регистрации DPS](#create-a-dps-individual-enrollment).

При регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей есть возможность объявить **Первоначальное состояние двойника устройства**. В двойнике устройства можно задать теги для группировки устройств по любой требуемой для решения метрике, например по региону, среде, расположению или типу устройства. Эти теги используются для создания [автоматических развертываний](how-to-deploy-at-scale.md).

### <a name="verify-your-root-certificate"></a>Проверка корневого сертификата

При создании группы регистрации у вас есть возможность использовать проверенный сертификат. Вы можете проверить сертификат с помощью DPS, убедившись, что вы владеете корневым сертификатом. Дополнительные сведения см. [в разделе Проверка принадлежности к сертификатам ЦС X. 509](../iot-dps/how-to-verify-certificates.md).

1. В [портал Azure](https://portal.azure.com)перейдите к своему экземпляру службы подготовки устройств для центра Интернета вещей.

1. В меню слева выберите **Сертификаты** .

1. Нажмите кнопку **Добавить** , чтобы добавить новый сертификат.

1. Введите понятное имя для сертификата, а затем перейдите к CER-или PEM-файлу, который представляет открытую часть сертификата X. 509.

   Если вы используете демонстрационные сертификаты, отправьте `<wrkdir>/certs/azure-iot-test-only.root.ca.cert.pem` сертификат.

1. Щелкните **Сохранить**.

1. Теперь сертификат должен быть указан на странице **Сертификаты** . Выберите его, чтобы открыть сведения о сертификате.

1. Выберите **создать код проверки** и скопируйте созданный код.

1. Если вы предоставили свой собственный сертификат ЦС или используете демонстрационные сертификаты, вы можете воспользоваться средством проверки, предоставленным в репозитории IoT Edge, чтобы проверить подтверждение принадлежности. Средство проверки использует сертификат ЦС для подписывания нового сертификата с предоставленным кодом проверки в качестве имени субъекта.

   * Windows:

     ```powershell
     New-CACertsVerificationCert "<verification code>"
     ```

   * Linux:

     ```bash
     ./certGen.sh create_verification_certificate <verification code>
     ```

1. На той же странице сведений о сертификате в портал Azure отправьте только что созданный сертификат проверки.

1. Нажмите кнопку **Проверить**.

### <a name="create-enrollment-group"></a>Создать группу регистрации

Дополнительные сведения о регистрациях в службе подготовки устройств см. в разделе [Управление регистрацией устройств](../iot-dps/how-to-manage-enrollments.md).

1. В [портал Azure](https://portal.azure.com)перейдите к своему экземпляру службы подготовки устройств для центра Интернета вещей.

1. В разделе **Параметры**выберите **Управление регистрациями**.

1. Щелкните **Добавить группу регистрации** , а затем выполните следующие действия, чтобы настроить регистрацию.

   * **Имя группы**: укажите запоминающееся имя для этой группы регистрации.

   * **Тип аттестации**: выберите **сертификат**.

   * **IOT Edge устройство**: выберите **значение true**. Для групповой регистрации все устройства должны быть IoT Edge устройствами или ни одно из них не может быть.

   * **Тип сертификата**. Выберите **сертификат ЦС** , если у вас есть проверенный сертификат ЦС, хранящийся в DPS, или **промежуточный сертификат** , если вы хотите отправить новый файл только для этой регистрации.

   * **Основной сертификат**. Если вы выбрали сертификат ЦС в последнем разделе, выберите свой сертификат из раскрывающегося списка. Если вы выбрали промежуточный сертификат, отправьте открытый файл из сертификата ЦС в цепочке доверия сертификатов, которая использовалась для создания сертификатов удостоверений устройств.

   * **Выберите центры Интернета вещей, которым может быть назначено это устройство**: выберите связанный центр Интернета вещей, к которому вы хотите подключить устройство. Можно выбрать несколько концентраторов, и устройство будет назначено одному из них в соответствии с выбранной политикой распределения.

   * **Начальное состояние двойникаа устройства**: добавьте значение тега, добавляемое в двойника устройства, если хотите. Теги можно использовать для целевых групп устройств для автоматического развертывания. Пример:

      ```json
      {
         "tags": {
            "environment": "test"
         },
         "properties": {
            "desired": {}
         }
      }
      ```

1. Щелкните **Сохранить**.

Теперь, когда для этого устройства существует регистрация, среда выполнения IoT Edge может автоматически подготавливать устройство во время установки. Перейдите к следующему разделу, чтобы настроить устройство IoT Edge.

## <a name="install-the-iot-edge-runtime"></a>Установка среды выполнения IoT Edge

Среда выполнения IoT Edge развертывается на всех устройствах IoT Edge. Ее компоненты выполняются в контейнерах и позволяют развертывать дополнительные контейнеры на устройстве, чтобы обеспечить возможность выполнения кода в граничной системе.

509. подготовка с помощью DPS поддерживается только в IoT Edge версии 1.0.9 или более поздней.

При подготовке устройства вам потребуются следующие сведения:

* Значение **области идентификаторов** DPS. Это значение можно получить на странице обзора экземпляра DP в портал Azure.
* Файл цепочки сертификатов удостоверений устройств на устройстве.
* Файл ключа удостоверения устройства на устройстве.
* Необязательный идентификатор регистрации (извлекается из общего имени в сертификате удостоверения устройства, если оно не указано).

### <a name="linux-device"></a>Устройство Linux

Используйте следующую ссылку, чтобы установить среду выполнения Azure IoT Edge на устройстве, используя команды, соответствующие архитектуре устройства. Когда вы получите доступ к разделу о настройке управляющей программы безопасности, настройте среду выполнения IoT Edge для X. 509 автоматически, а не вручную. Необходимо иметь все необходимые сведения и файлы сертификатов после завершения предыдущих разделов этой статьи.

[Установка среды выполнения Azure IoT Edge в Linux](how-to-install-iot-edge-linux.md)

При добавлении сертификата X. 509 и сведений о ключе в файл config. YAML эти пути должны быть указаны в виде URI файлов. Пример:

* `file:///<path>/identity_certificate_chain.pem`
* `file:///<path>/identity_key.pem`

Раздел в файле конфигурации для автоматической подготовки X. 509 выглядит следующим образом:

```yaml
# DPS X.509 provisioning configuration
provisioning:
  source: "dps"
  global_endpoint: "https://global.azure-devices-provisioning.net"
  scope_id: "<SCOPE_ID>"
  attestation:
    method: "x509"
#   registration_id: "<OPTIONAL REGISTRATION ID. LEAVE COMMENTED OUT TO REGISTER WITH CN OF identity_cert>"
    identity_cert: "<REQUIRED URI TO DEVICE IDENTITY CERTIFICATE>"
    identity_pk: "<REQUIRED URI TO DEVICE IDENTITY PRIVATE KEY>"
```

Замените значения заполнителей для `scope_id`, `identity_cert`, `identity_pk` идентификатором области из экземпляра DP, а также URI для цепочки сертификатов и расположений файлов ключей на вашем устройстве. При необходимости `registration_id` укажите устройство для устройства или оставьте строку с комментарием, чтобы зарегистрировать устройство с именем CN сертификата удостоверения.

Всегда перезапускайте управляющую программу безопасности после обновления файла config. YAML.

```bash
sudo systemctl restart iotedge
```

### <a name="windows-device"></a>устройство с Windows;

Установите среду выполнения IoT Edge на устройстве, для которого была создана цепочка сертификатов удостоверений и ключ удостоверения. Вы настроите среду выполнения IoT Edge для автоматического, а не ручной подготовки.

Дополнительные сведения об установке IoT Edge в Windows, включая предварительные требования и инструкции для таких задач, как Управление контейнерами и обновление IoT Edge, см. в [статье Установка среды выполнения Azure IOT EDGE в Windows](how-to-install-iot-edge-windows.md).

1. Откройте окно PowerShell с правами администратора. Не забудьте использовать сеанс AMD64 PowerShell при установке IoT Edge, а не PowerShell (x86).

1. Команда **deploy-IoTEdge** проверяет, что компьютер Windows находится в поддерживаемой версии, включает функцию контейнеров, а затем загружает среду выполнения значок Кита и среду выполнения IOT Edge. Команда по умолчанию использует контейнеры Windows.

   ```powershell
   . {Invoke-WebRequest -useb https://aka.ms/iotedge-win} | Invoke-Expression; `
   Deploy-IoTEdge
   ```

1. На этом этапе устройства IoT Core могут перезапускаться автоматически. Другие устройства Windows 10 или Windows Server могут предложить перезагрузку. Если да, перезагрузите устройство прямо сейчас. Когда устройство будет готово, снова запустите PowerShell от имени администратора.

1. Команда **Initialize-IoTEdge** настраивает среду выполнения IoT Edge на вашем компьютере. Команда по умолчанию выполняется подготовка вручную, если не используется `-Dps` флаг для автоматической подготовки.

   Замените значения заполнителей для `{scope_id}`, `{identity cert chain path}`и `{identity key path}` соответствующими значениями из экземпляра DPS и путей к файлам на устройстве. Если вы хотите указать идентификатор регистрации, включите `-RegistrationId {registration_id}` его также, заменив заполнитель соответствующим образом.

   ```powershell
   . {Invoke-WebRequest -useb https://aka.ms/iotedge-win} | Invoke-Expression; `
   Initialize-IoTEdge -Dps -ScopeId {scope ID} -X509IdentityCertificate {identity cert chain path} -X509IdentityPrivateKey {identity key path}
   ```

   >[!TIP]
   >В файле config. YAML сертификат и сведения о ключе хранятся в виде URI файлов. Однако команда Initialize-IoTEdge обрабатывает этот шаг форматирования, чтобы можно было указать абсолютный путь к файлам сертификата и ключей на устройстве.

## <a name="verify-successful-installation"></a>Проверка установки

Если среда выполнения запущена успешно, можете перейти в Центр Интернета вещей и начать развертывание модулей IoT Edge на устройстве.

Вы можете проверить, была ли использована отдельная регистрация, созданная в службе подготовки устройств. Перейдите к экземпляру службы подготовки устройств в портал Azure. Откройте сведения о регистрации для созданной индивидуальной регистрации. Обратите внимание, что для регистрации **назначено** состояние и указан идентификатор устройства.

Чтобы убедиться, что среда выполнения установлена и запущена успешно, используйте следующие команды на устройстве:

### <a name="linux-device"></a>Устройство Linux

Проверьте состояние службы IoT Edge.

```cmd/sh
systemctl status iotedge
```

Проверьте журналы службы.

```cmd/sh
journalctl -u iotedge --no-pager --no-full
```

Просмотрите список запущенных модулей.

```cmd/sh
iotedge list
```

### <a name="windows-device"></a>устройство с Windows;

Проверьте состояние службы IoT Edge.

```powershell
Get-Service iotedge
```

Проверьте журналы службы.

```powershell
. {Invoke-WebRequest -useb aka.ms/iotedge-win} | Invoke-Expression; Get-IoTEdgeLog
```

Просмотрите список запущенных модулей.

```powershell
iotedge list
```

## <a name="next-steps"></a>Следующие шаги

Процесс регистрации Службы подготовки устройств к добавлению в Центр Интернета вещей позволяет задать идентификатор устройства и теги двойников устройств параллельно с подготовкой нового устройства. Эти значения можно использовать для указания отдельных устройств или групп устройств с помощью автоматического управления устройствами. Узнайте, как [развертывать и отслеживать модули IOT EDGE в масштабе с помощью портал Azure](how-to-deploy-at-scale.md) или [с помощью Azure CLI](how-to-deploy-cli-at-scale.md).
