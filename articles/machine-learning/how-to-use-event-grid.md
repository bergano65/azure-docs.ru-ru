---
title: Активация событий в рабочих процессах машинного обучения (Предварительная версия)
titleSuffix: Azure Machine Learning
description: Настройка управляемых событиями приложений, процессов или рабочих процессов CI/CD машинного обучения в службе "Машинное обучение Azure".
services: machine-learning
ms.service: machine-learning
ms.subservice: core
ms.topic: how-to
ms.author: shipatel
author: shivp950
ms.reviewer: larryfr
ms.date: 05/11/2020
ms.openlocfilehash: 5c4eae49b849b7dc5dbf7c27d50e241b2a4f36e4
ms.sourcegitcommit: e995f770a0182a93c4e664e60c025e5ba66d6a45
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/08/2020
ms.locfileid: "86135966"
---
# <a name="trigger-applications-processes-or-cicd-workflows-based-on-azure-machine-learning-events-preview"></a>Активация приложений, процессов или процессов CI/CD на основе событий Машинное обучение Azure (Предварительная версия)

В этой статье вы узнаете, как настраивать управляемые событиями приложения, процессы или рабочие процессы CI/CD на основе событий Машинного обучения Azure, таких как сообщения об ошибках или запуски конвейера машинного обучения, при обнаружении определенных условий [Сеткой событий Azure](https://docs.microsoft.com/azure/event-grid/). 

Машинное обучение Azure управляет всем жизненным циклом процесса машинного обучения, включая обучение модели, развертывание модели и мониторинг. Сетку событий можно использовать для реагирования на события Машинного обучения Azure события, такие как завершение обучающих запусков, регистрация и развертывание моделей, а также обнаружение смещения данных, с помощью современных бессерверных архитектур. Затем можно подписываться на такие события, как изменение состояния выполнения, завершение выполнения, регистрация модели, развертывание модели либо определение расхождения данных в рабочей области, и использовать эти события.

Когда следует использовать сетку событий для действий, управляемых событиями:
* отправка сообщений электронной почты при сбое выполнения и завершении выполнения;
* использование функции Azure после регистрации модели;
* потоковая передача событий от Машинного обучения Azure в различные конечные точки;
* запуск конвейера машинного обучения при обнаружении смещения.

> [!NOTE] 
> В настоящее время события runStatusChanged запускаются только в том случае, если состояние выполнения — **failed** (сбой).

## <a name="prerequisites"></a>Предварительные требования
Чтобы использовать Сетку событий, необходимо иметь доступ участника или владельца к рабочей области Машинного обучения Azure, для которой будут создаваться события.

## <a name="the-event-model--types"></a>Модель и типы событий

Служба "Сетка событий Azure" считывает события из таких источников, как Машинное обучение Azure и другие службы Azure. Затем эти события отправляются обработчикам событий, таким как концентраторы событий Azure, функции Azure, Logic Apps и другие. Обратите внимание: на этой схеме показано, как служба "Сетка событий" соединяет источники и обработчики, но здесь не предоставлен полный список поддерживаемых интеграций.

![Функциональная модель Сетки событий Azure](./media/concept-event-grid-integration/azure-event-grid-functional-model.png)

Дополнительные сведения об источниках событий и обработчиках событий см. в статье [Что такое сетка событий?](/azure/event-grid/overview).

### <a name="event-types-for-azure-machine-learning"></a>Типы событий для Машинного обучения Azure

Машинное обучение Azure предоставляет события в различных точках жизненного цикла машинного обучения: 

| Тип события | Описание |
| ---------- | ----------- |
| `Microsoft.MachineLearningServices.RunCompleted` | Вызывается после завершения эксперимента машинного обучения. |
| `Microsoft.MachineLearningServices.ModelRegistered` | Вызывается при регистрации модели машинного обучения в рабочей области. |
| `Microsoft.MachineLearningServices.ModelDeployed` | Вызывается при завершении развертывания службы вывода с одной или несколькими моделями. |
| `Microsoft.MachineLearningServices.DatasetDriftDetected` | Вызывается при завершении задания обнаружения смещения данных для двух наборов данных. |
| `Microsoft.MachineLearningServices.RunStatusChanged` | Вызывается при изменении состояния выполнения, в настоящий момент только в том случае, если состояние выполнения — "failed". |

### <a name="filter--subscribe-to-events"></a>Фильтр и подписка на события

Эти события публикуются с помощью Сетки событий Azure. С помощью портала Azure, PowerShell или Azure CLI клиенты могут легко подписываться на события, [указывая один или несколько типов событий, а также условия фильтрации](/azure/event-grid/event-filtering). 

При настройке событий можно применять фильтры только для запуска на конкретных данных событий. В приведенном ниже примере для событий изменения состояния выполнения можно выполнить фильтрацию по типам выполнения. Это событие активируется только при соблюдении условий. Сведения о данных событий, по которым можно выполнять фильтрацию, см. в статье [Схема сетки событий Машинного обучения Azure](/azure/event-grid/event-schema-machine-learning). 

Подписки на события Машинного обучения Azure событий защищаются с помощью управления доступом на основе ролей (RBAC). Создавать, обновлять и удалять подписки на события могут только [участники или владельцы](how-to-assign-roles.md#default-roles) рабочей области.  Фильтры могут применяться к подпискам на события во время [создания](/cli/azure/eventgrid/event-subscription?view=azure-cli-latest) подписки на событие или позже. 


1. Перейдите к порталу Azure, выберите там новую или существующую подписку. 

1. Выберите вкладку "Фильтры" и прокрутите вниз до пункта "Дополнительные фильтры". Для параметров **Ключ** и **Значение**укажите типы свойств, по которым требуется выполнить фильтрацию. Здесь можно увидеть, что событие будет запущено только тогда, когда тип запуска является запуском конвейера или запуском этапа конвейера.  

    :::image type="content" source="media/how-to-use-event-grid/select-event-filters.png" alt-text="события фильтра":::


+ **Фильтрация по типу события.** Подписка на события может указывать один или несколько типов событий Машинного обучения Azure.

+ **Фильтрация по теме события.** Сетка событий Azure поддерживает фильтры темы, работающие на основе совпадений __начинается с__ и __заканчивается на__, что позволяет доставлять подписчику события с соответствующей темой. Другие события машинного обучения имеют другой формат темы.

  | Тип события | Формат темы | Образец темы |
  | ---------- | ----------- | ----------- |
  | `Microsoft.MachineLearningServices.RunCompleted` | `experiments/{ExperimentId}/runs/{RunId}` | `experiments/b1d7966c-f73a-4c68-b846-992ace89551f/runs/my_exp1_1554835758_38dbaa94` |
  | `Microsoft.MachineLearningServices.ModelRegistered` | `models/{modelName}:{modelVersion}` | `models/sklearn_regression_model:3` |
  | `Microsoft.MachineLearningServices.ModelDeployed` | `endpoints/{serviceId}` | `endpoints/my_sklearn_aks` |
  | `Microsoft.MachineLearningServices.DatasetDriftDetected` | `datadrift/{data.DataDriftId}/run/{data.RunId}` | `datadrift/4e694bf5-712e-4e40-b06a-d2a2755212d4/run/my_driftrun1_1550564444_fbbcdc0f` |
  | `Microsoft.MachineLearningServices.RunStatusChanged` | `experiments/{ExperimentId}/runs/{RunId}` | `experiments/b1d7966c-f73a-4c68-b846-992ace89551f/runs/my_exp1_1554835758_38dbaa94` | 

+ **Расширенная фильтрация**. Сетка событий Azure также поддерживает расширенную фильтрацию на основе схемы опубликованных событий. Сведения о схеме событий Машинного обучение Azure можно найти в разделе [Схема событий службы "Сетка событий Azure" для Машинного обучение Azure](../event-grid/event-schema-machine-learning.md).  Ниже приведены некоторые примеры расширенных фильтров, которые можно применять.

  Для `Microsoft.MachineLearningServices.ModelRegistered` события, чтобы отфильтровать значение тега модели:

  ```
  --advanced-filter data.ModelTags.key1 StringIn ('value1')
  ```

  Дополнительные сведения о том, как применять фильтры, см. в разделе [Фильтрация событий для сетки событий](https://docs.microsoft.com/azure/event-grid/how-to-filter-events).

## <a name="consume-machine-learning-events"></a>Использование событий Машинного обучения

Приложения, которые обрабатывают события Машинного обучения, должны следовать нескольким рекомендациям.

> [!div class="checklist"]
> * Так как в один обработчик событий можно настроить маршрутизацию событий из нескольких подписок, не следует предполагать, что события поступают из определенного источника. Но необходимо проверять тему сообщения, чтобы убедиться, что оно поступает из ожидаемой рабочей области машинного обучения.
> * Подобным образом убедитесь, что вы готовы к обработке этого типа событий (eventType), а также не следует предполагать, что все получаемые события будут иметь ожидаемый тип.
> * Так как сообщения могут поступать не по порядку и после некоторой задержки, используйте поля ETag, чтобы понять, являются ли сведения об объектах актуальными.  Используйте поля sequencer для понимания последовательности событий для каждого отдельного объекта.
> * Игнорируйте поля, которые вам непонятны. Такой подход поможет обеспечить устойчивость к новым функциям, которые могут быть добавлены в будущем.
> * Операции Машинного обучения Azure, которые завершились сбоем или отменены, не активируют событие. Например, если развертывание модели завершается сбоем, Microsoft.MachineLearningServices.ModelDeployed не будет запущено. При проектировании приложений рекомендуется использовать такой режим сбоя. Вы всегда можете использовать пакет SDK, CLI или портал Машинного обучения Azure, чтобы проверить состояние операции и ознакомиться с подробными причинами сбоя.

Сетка событий Azure позволяет клиентам создавать несвязанные обработчики сообщений, которые могут запускаться событиями Машинного обучения Azure. Ниже приведены некоторые важные примеры обработчиков сообщений.
* Функции Azure
* Azure Logic Apps
* Центры событий Azure
* Конвейеры фабрики данных Azure
* Универсальные веб-перехватчики, которые могут размещаться на платформе Azure или в других местах

## <a name="set-up-in-azure-portal"></a>Настройка на портале Azure

1. Откройте [портал Azure](https://portal.azure.com) и перейдите к рабочей области Машинного обучения Azure.

1. На панели слева выберите __События__, а затем выберите **Подписки на события**. 

    ![select-events-in-workspace.png](./media/how-to-use-event-grid/select-event.png)

1. Выберите тип события для использования. Например, на следующем снимке экрана выбрано __Модель зарегистрирована__, __Модель развернута__, __Выполнение завершено__ и __Обнаружено смещение набора данных__.

    ![add-event-type](./media/how-to-use-event-grid/add-event-type-updated.png)

1. Выберите конечную точку, в которую будет опубликовано событие. На следующем снимке экрана __Концентратор событий__ является выбранной конечной точкой:

    ![select-event-handler](./media/how-to-use-event-grid/select-event-handler.png)

После подтверждения выбора щелкните __Создать__. После настройки эти события будут отправлены в конечную точку.


### <a name="set-up-with-the-cli"></a>Настройка с помощью CLI

Можно либо установить последнюю версию [Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest), либо использовать Azure Cloud Shell, предоставляемый в рамках подписки Azure.

Чтобы установить расширение Сетки событий, выполните следующую команду в CLI:

```azurecli-interactive
az add extension --name eventgrid
```

В следующем примере показано, как выбрать подписку Azure и создать новую подписку на события для Машинного обучения Azure:

```azurecli-interactive
# Select the Azure subscription that contains the workspace
az account set --subscription "<name or ID of the subscription>"

# Subscribe to the machine learning workspace. This example uses EventHub as a destination. 
az eventgrid event-subscription create --name {eventGridFilterName} \
  --source-resource-id /subscriptions/{subId}/resourceGroups/{RG}/providers/Microsoft.MachineLearningServices/workspaces/{wsName} \
  --endpoint-type eventhub \
  --endpoint /subscriptions/{SubID}/resourceGroups/TestRG/providers/Microsoft.EventHub/namespaces/n1/eventhubs/EH1 \
  --included-event-types Microsoft.MachineLearningServices.ModelRegistered \
  --subject-begins-with "models/mymodelname"
```

## <a name="examples"></a>Примеры

### <a name="example-send-email-alerts"></a>Пример Отправка оповещений по электронной почте

Используйте [Azure Logic Apps](https://docs.microsoft.com/azure/logic-apps/), чтобы настроить сообщения электронной почты для всех событий. Настройте условия и укажите получателей, чтобы обеспечить совместную работу и осведомленность в разных командах.

1. На портале Azure перейдите в рабочую область Машинного обучения Azure и выберите вкладку события на панели слева. Там выберите __Logic apps__. 

    ![select-logic-ap](./media/how-to-use-event-grid/select-logic-ap.png)

1. Войдите в пользовательский интерфейс приложения логики и выберите службу "Машинное обучение" в качестве типа темы. 

    ![select-topic-type](./media/how-to-use-event-grid/select-topic-type.png)

1. Выберите события, о которых хотите получать уведомления. Для примера посмотрите на снимок экрана __RunCompleted__.

    ![select-event-runcomplete](./media/how-to-use-event-grid/select-event-runcomplete.png)

1. Можно использовать метод фильтрации в приведенном выше разделе или добавить фильтры, чтобы активировать приложение логики только в ответ на подмножество типов событий. На следующем снимке экрана используется __фильтр префикса__ __/datadriftID/runs/__ .

    ![filter-events](./media/how-to-use-event-grid/filtering-events.png)

1. Затем добавьте шаг для использования этого события и выполните поиск по электронной почте. Существует несколько разных учетных записей почты, которые можно использовать для получения событий. Также можно настроить условия отправки оповещений по электронной почте.

    ![select-email-action](./media/how-to-use-event-grid/select-email-action.png)

1. Выберите __Отправить сообщение электронной почты__ и введите параметры. В теме можно указать __Тип события__ и __Тему__, чтобы упростить фильтрацию событий. Также можно включить ссылку на страницу рабочей области для выполнения в тексте сообщения. 

    ![configure-email-body](./media/how-to-use-event-grid/configure-email-body.png)

1. Чтобы сохранить это действие, выберите **Сохранить как** в левом углу страницы. На появившейся правой панели подтвердите создание этого действия.

    ![confirm-logic-app-create](./media/how-to-use-event-grid/confirm-logic-app-create.png)


### <a name="example-data-drift-triggers-retraining"></a>Пример Переобучение триггеров смещения данных

Модели со временем устаревают и становятся бесполезными в контексте, в котором они выполняются. Одним из способов определить, пора ли переучивать модель, является обнаружение смещения данных. 

В этом примере показано, как использовать Сетку событий с Azure Logic App для запуска переобучения. В этом примере конвейер Фабрики данных Azure активируется, когда происходит смещение данных между обучением модели и обслуживанием наборов данных.

Перед началом работы выполните следующие действия.

* Настройте монитор набора данных для [обнаружения смещения данных]( https://aka.ms/datadrift) в рабочей области.
* Создайте опубликованный [конвейер Фабрики данных Azure](https://docs.microsoft.com/azure/data-factory/).

В этом примере простой конвейер Фабрики данных используется для копирования файлов в хранилище BLOB-объектов и запуска опубликованного конвейера Машинного обучения. Дополнительные сведения об этом сценарии см. в [Этап Машинного обучения в Фабрике данных Azure.](https://docs.microsoft.com/azure/data-factory/transform-data-machine-learning-service)

![adf-mlpipeline-stage](./media/how-to-use-event-grid/adf-mlpipeline-stage.png)

1. Начните с создания приложения логики. Перейдите на [портал Azure](https://portal.azure.com), найдите Logic Apps и выберите "Создать".

    ![search-logic-app](./media/how-to-use-event-grid/search-for-logic-app.png)

1. Введите необходимую информацию. Чтобы упростить работу, используйте ту же подписку и группу ресурсов, что и конвейер Фабрики данных Azure, с рабочей областью Машинного обучения Azure.

    ![set-up-logic-app-for-adf](./media/how-to-use-event-grid/set-up-logic-app-for-adf.png)

1. После создания приложения логики выберите __При возникновении события ресурса Сетки событий__. 

    ![select-event-grid-trigger](./media/how-to-use-event-grid/select-event-grid-trigger.png)

1. Войдите и укажите сведения о событии. В разделе __Имя ресурса__  укажите имя рабочей области. В разделе __Тип события__  укажите __DatasetDriftDetected__.

    ![login-and-add-event](./media/how-to-use-event-grid/login-and-add-event.png)

1. Добавьте новый шаг и выполните поиск по __Фабрике данных Azure__. Выберите __Создание конвейера__. 

    ![create-adfpipeline-run](./media/how-to-use-event-grid/create-adfpipeline-run.png)

1. Войдите в систему и укажите опубликованный конвейер Фабрики данных Azure, который следует запустить.

    ![specify-adf-pipeline](./media/how-to-use-event-grid/specify-adf-pipeline.png)

1. Сохраните и создайте приложение логики с помощью кнопки **Сохранить** в верхнем левом углу страницы. Чтобы просмотреть приложение, перейдите в рабочую область [Портала Azure](https://portal.azure.com) и щелкните **События**.

    ![show-logic-app-webhook](./media/how-to-use-event-grid/show-logic-app-webhook.png)

Теперь конвейер Фабрики данных активируется при смещении данных. Сведения о вашем процессе смещения данных и конвейере машинного обучения можно найти на [новом портале рабочей области](https://ml.azure.com). 

![view-in-workspace](./media/how-to-use-event-grid/view-in-workspace.png)

### <a name="example-deploy-a-model-based-on-tags"></a>Пример Развертывание модели на основе тегов

Объект модели Машинного обучение Azure содержит параметры, на которых можно выполнить сведение развертываний, такие как имя модели, версия, тег и свойство. Событие регистрации модели может активировать конечную точку. Функцию Azure можно использовать для развертывания модели на основе значений этих параметров.

Например, загляните в репозиторий [https://github.com/Azure-Samples/MachineLearningSamples-NoCodeDeploymentTriggeredByEventGrid](https://github.com/Azure-Samples/MachineLearningSamples-NoCodeDeploymentTriggeredByEventGrid) и выполните действия, описанные в файле **readme**.

## <a name="next-steps"></a>Дальнейшие действия

Ознакомьтесь с дополнительными сведениями о Сетке событий и попробуйте использовать события Машинного обучения Microsoft Azure.

- [An introduction to Azure Event Grid](../event-grid/overview.md) (Общие сведения о службе "Сетка событий Azure")

- [Схема событий для Машинного обучения Azure](../event-grid/event-schema-machine-learning.md)

