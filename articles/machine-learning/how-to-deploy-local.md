---
title: Как запускать и развертывать локально
titleSuffix: Azure Machine Learning
description: В этой статье описывается, как использовать локальный компьютер в качестве целевого для обучения, отладки или развертывания моделей, созданных в Машинное обучение Azure.
services: machine-learning
ms.service: machine-learning
ms.subservice: core
ms.author: laobri
author: lobrien
ms.date: 11/20/2020
ms.topic: conceptual
ms.custom: how-to, deploy
ms.openlocfilehash: 71f393897dff266f1b0922a19eefd70cffea133d
ms.sourcegitcommit: c4246c2b986c6f53b20b94d4e75ccc49ec768a9a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/04/2020
ms.locfileid: "96600359"
---
# <a name="deploy-models-trained-with-azure-machine-learning-on-your-local-machines"></a>Развертывание моделей, обученных Машинное обучение Azure на локальных компьютерах 

В этой статье описывается, как использовать локальный компьютер в качестве целевого для обучения или развертывания моделей, созданных в Машинное обучение Azure. Машинное обучение Azure достаточно гибок для работы с большинством платформ машинного обучения Python. Как правило, решения машинного обучения имеют сложные зависимости, которые могут быть трудно дублировать. В этой статье показано, как сбалансировать общий контроль с простотой использования.

Ниже перечислены сценарии для локального развертывания.

* Быстрый перебор данных, скриптов и моделей на раннем этапе проекта.
* Отладка и устранение неполадок на последующих этапах.
* Окончательное развертывание на оборудовании, управляемом пользователем.

## <a name="prerequisites"></a>Предварительные требования

- Рабочая область машинного обучения Azure. Дополнительные сведения см. в статье [создание машинное обучение Azure рабочей области](how-to-manage-workspace.md).
- Модель и среда. Если у вас нет обученной модели, можно использовать модель и файлы зависимостей, предоставленные в [этом руководстве](tutorial-train-models-with-aml.md).
- [Пакет SDK для машинное обучение Azure для Python](/python/api/overview/azure/ml/intro?preserve-view=true&view=azure-ml-py).
- Conda Manager, например Anaconda или Miniconda, если требуется зеркальное отображение зависимостей пакетов Машинное обучение Azure.
- DOCKER, если вы хотите использовать контейнерную версию Машинное обучение Azure среды.

## <a name="prepare-your-local-machine"></a>Подготовка локального компьютера

Самым надежным способом локально запускать модель Машинное обучение Azure является образ DOCKER. Образ DOCKER предоставляет изолированный контейнерный интерфейс, который дублируется, за исключением проблем с оборудованием, средой выполнения Azure. Дополнительные сведения об установке и настройке DOCKER для сценариев разработки см. в статье [Обзор удаленной разработки DOCKER в Windows](/windows/dev-environment/docker/overview).

Можно подключить отладчик к процессу, выполняемому в DOCKER. (См. раздел [Подключение к выполняющемуся контейнеру](https://code.visualstudio.com/docs/remote/attach-container).) Но вы можете отлаживать и выполнять итерацию кода Python, не прибегая к DOCKER. В этом сценарии важно, чтобы на локальном компьютере использовались те же библиотеки, которые используются при запуске эксперимента в Машинное обучение Azure. Для управления зависимостями Python Azure использует [conda](https://docs.conda.io/). Среду можно повторно создать с помощью других диспетчеров пакетов, но установка и настройка conda на локальном компьютере — самый простой способ синхронизации. 

## <a name="prepare-your-entry-script"></a>Подготовка сценария записи

Даже если для управления моделью и зависимостями используется DOCKER, Скрипт оценки Python должен быть локальным. Сценарий должен иметь два метода:

- `init()`Метод, который не принимает аргументы и не возвращает ничего 
- `run()`Метод, принимающий строку в формате JSON и возвращающий объект, сериализуемый из JSON

Аргумент `run()` метода будет иметь следующий вид: 

```json
{
    "data": <model-specific-data-structure>
}
```

Объект, возвращаемый методом, `run()` должен реализовывать `toJSON() -> string` .

В следующем примере показано, как загрузить зарегистрированную модель scikit-учиться и оценить ее с помощью данных NumPy. Этот пример основан на модели и зависимостях [этого руководства](tutorial-train-models-with-aml.md).

```python
import json
import numpy as np
import os
import pickle
import joblib

def init():
    global model
    # AZUREML_MODEL_DIR is an environment variable created during deployment.
    # It's the path to the model folder (./azureml-models/$MODEL_NAME/$VERSION).
    # For multiple models, it points to the folder containing all deployed models (./azureml-models).
    model_path = os.path.join(os.getenv('AZUREML_MODEL_DIR'), 'sklearn_mnist_model.pkl')
    model = joblib.load(model_path)

def run(raw_data):
    data = np.array(json.loads(raw_data)['data'])
    # Make prediction.
    y_hat = model.predict(data)
    # You can return any data type as long as it's JSON-serializable.
    return y_hat.tolist()
```

Дополнительные примеры, включая автоматическое создание схемы Swagger и оценку двоичных данных (например, изображений), см. в разделе [Расширенная разработка сценариев ввода](how-to-deploy-advanced-entry-script.md). 

## <a name="deploy-as-a-local-web-service-by-using-docker"></a>Развертывание в качестве локальной веб-службы с помощью DOCKER

Самый простой способ репликации среды, используемой Машинное обучение Azure, — развертывание веб-службы с помощью DOCKER. Запустив DOCKER на локальном компьютере, вы выполните следующие действия:

1. Подключитесь к рабочей области Машинное обучение Azure, в которой зарегистрирована модель.
1. Создайте `Model` объект, представляющий модель.
1. Создайте `Environment` объект, который содержит зависимости и определяет программную среду, в которой будет выполняться код.
1. Создайте `InferenceConfig` объект, связывающий скрипт записи с `Environment` .
1. Создайте `DeploymentConfiguration` объект подкласса `LocalWebserviceDeploymentConfiguration` .
1. Используйте `Model.deploy()` для создания `Webservice` объекта. Этот метод скачивает образ DOCKER и связывает его с `Model` , `InferenceConfig` и `DeploymentConfiguration` .
1. Активируйте с `Webservice` помощью `Webservice.wait_for_deployment()` .

В следующем коде показаны следующие шаги.

```python
from azureml.core.webservice import Webservice
from azure.core.model import InferenceConfig
from azureml.core.environment import Environment
from azureml.core import Workspace
from azureml.core.model import Model

ws = Workspace.from_config()
model = Model(ws, 'sklearn_mnist')


myenv = Environment.get(workspace=ws, name="tutorial-env", version="1")
inference_config = InferenceConfig(entry_script="score.py", environment=myenv)

deployment_config = LocalWebservice.deploy_configuration(port=6789)

local_service = Model.deploy(workspace=ws, 
                       name='sklearn-mnist-local', 
                       models=[model], 
                       inference_config=inference_config, 
                       deployment_config = deployment_config)

local_service.wait_for_deployment(show_output=True)
print(f"Scoring URI is : {local_service.scoring_uri}")
```

Вызов `Model.deploy()` может занять несколько минут. После первоначального развертывания веб-службы более эффективно использовать `update()` метод, а не начинать с нуля. См. раздел [Обновление развернутой веб-службы](how-to-deploy-update-web-service.md).

### <a name="test-your-local-deployment"></a>Тестирование локального развертывания

При запуске предыдущего скрипта развертывания выводится универсальный код ресурса (URI), в который можно ОТПРАВЛЯТЬ данные для оценки (например, `http://localhost:6789/score` ). В следующем примере показан скрипт, оценивающий образец данных с помощью `"sklearn-mnist-local"` локально развернутой модели. Модель, при надлежащей обучении, выводит, что `normalized_pixel_values` должна интерпретироваться как «2». 

```python
import requests

normalized_pixel_values = "[\
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 0.5, 0.7, 1.0, 1.0, 0.6, 0.4, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.7, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.9, 0.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.7, 1.0, 1.0, 1.0, 0.8, 0.6, 0.7, 1.0, 1.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.2, 1.0, 1.0, 0.8, 0.1, 0.0, 0.0, 0.0, 0.8, 1.0, 0.5, 0.0, 0.0, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.3, 1.0, 0.8, 0.1, 0.0, 0.0, 0.0, 0.5, 1.0, 1.0, 0.3, 0.0, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.1, 0.1, 0.0, 0.0, 0.0, 0.0, 0.8, 1.0, 1.0, 0.3, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 1.0, 1.0, 0.8, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.3, 1.0, 1.0, 0.9, 0.2, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 1.0, 1.0, 0.6, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.7, 1.0, 1.0, 0.6, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.1, 0.9, 1.0, 0.9, 0.1, \
0.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.8, 1.0, 1.0, 0.6, \
0.6, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.3, 1.0, 1.0, 0.7, \
0.7, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.1, 0.8, 1.0, 1.0, \
1.0, 0.6, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 1.0, 1.0, \
1.0, 0.7, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, \
1.0, 1.0, 0.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, \
1.0, 1.0, 1.0, 0.2, 0.1, 0.1, 0.1, 0.1, 0.0, 0.0, 0.0, 0.1, 0.1, 0.1, 0.6, 0.6, 0.6, 0.6, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, \
0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.7, 0.6, 0.7, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, \
0.0, 0.0, 0.7, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.7, 0.5, 0.5, 0.2, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.5, 0.5, 0.5, 0.5, 0.7, 1.0, 1.0, 1.0, 0.6, 0.5, 0.5, 0.2, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, \
0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]"

input_data = "{\"data\": [" + normalized_pixel_values + "]}"

headers = {'Content-Type': 'application/json'}

scoring_uri = "http://localhost:6789/score"
resp = requests.post(scoring_uri, input_data, headers=headers)

print("Should be predicted as '2'")
print("prediction:", resp.text)
```

## <a name="download-and-run-your-model-directly"></a>Скачайте и запустите модель напрямую

Использование DOCKER для развертывания модели в качестве веб-службы является наиболее распространенным вариантом. Но вам может потребоваться выполнить код напрямую с помощью локальных скриптов Python. Вам потребуются два важных компонента: 

- Сама модель
- Зависимости, на основе которых зависит модель 

Вы можете скачать модель:  

- На портале перейдите на вкладку **модели** , выберите нужную модель и на странице **сведения** нажмите кнопку **скачать**.
- Из командной строки с помощью `az ml model download` . (См [. статью Загрузка модели.](/cli/azure/ext/azure-cli-ml/ml/model?view=azure-cli-latest#ext_azure_cli_ml_az_ml_model_download&preserve-view=false))
- С помощью метода Python SDK `Model.download()` . (См [. класс Model.](/python/api/azureml-core/azureml.core.model.model?view=azure-ml-py#download-target-dir------exist-ok-false--exists-ok-none-&preserve-view=false))

Модель Azure — это один или несколько сериализованных объектов Python, упакованных в файл выбора Python (расширение PKL). Содержимое файла выбора зависит от библиотеки машинного обучения или методики, используемой для обучения модели. Например, если вы используете модель из учебника, вы можете загрузить модель с помощью:

```python
import pickle

with open('sklearn_mnist_model.pkl', 'rb') as f : 
    logistic_model = pickle.load(f, encoding='latin1')
```

Зависимости всегда очень сложны, особенно в машинном обучении, где часто бывает диззинг веб-сайт конкретных требований к версии. Вы можете повторно создать Машинное обучение Azure среду на локальном компьютере как полную conda среду или как образ DOCKER с помощью `build_local()` метода `Environment` класса: 

```python
ws = Workspace.from_config()
myenv = Environment.get(workspace=ws, name="tutorial-env", version="1")
myenv.build_local(workspace=ws, useDocker=False) #Creates conda environment.
```

Если задать `build_local()` `useDocker` для аргумента значение `True` , функция создаст образ DOCKER, а не среду conda. Если требуется больший контроль, можно использовать `save_to_directory()` метод `Environment` , который записывает conda_dependencies. yml и azureml_environment.jsдля файлов определений, которые можно настроить и использовать в качестве основания для расширения. 

`Environment`Класс имеет ряд других методов для синхронизации сред в вычислительном оборудовании, рабочей области Azure и образах DOCKER. Дополнительные сведения см. в разделе [класс среды](/python/api/azureml-core/azureml.core.environment(class)).

После загрузки модели и разрешения ее зависимостей не существует ограничений, определенных в Azure, для выполнения оценки, точной настройки модели, использования перемещения и т. д. 

## <a name="upload-a-retrained-model-to-azure-machine-learning"></a>Отправка переученной модели в Машинное обучение Azure

Если у вас есть локально обученная или переученная модель, ее можно зарегистрировать в Azure. После регистрации вы можете продолжить его настройку с помощью Azure COMPUTE или развернуть с помощью таких средств Azure, как [Служба Kubernetes Azure](how-to-deploy-azure-kubernetes-service.md) или [сервер вывода Тритон (Предварительная версия)](how-to-deploy-with-triton.md).

Для использования с пакетом SDK для Машинное обучение Azure Python модель должна храниться в виде сериализованного объекта Python в формате выбора (файл PKL). Он также должен реализовать `predict(data)` метод, возвращающий объект, сериализуемый в формат JSON. Например, вы можете сохранить локально обученную модель scikit-Training диабета с помощью: 

```python
import joblib

from sklearn.datasets import load_diabetes
from sklearn.linear_model import Ridge

dataset_x, dataset_y = load_diabetes(return_X_y=True)

sk_model = Ridge().fit(dataset_x, dataset_y)

joblib.dump(sk_model, "sklearn_regression_model.pkl")
```

Чтобы сделать модель доступной в Azure, можно использовать `register()` метод `Model` класса:

```python
from azureml.core.model import Model

model = Model.register(model_path="sklearn_regression_model.pkl",
                       model_name="sklearn_regression_model",
                       tags={'area': "diabetes", 'type': "regression"},
                       description="Ridge regression model to predict diabetes",
                       workspace=ws)
```

После этого вы сможете найти новую зарегистрированную модель на вкладке Машинное обучение Azure **модель** :

:::image type="content" source="media/how-to-deploy-local/registered-model.png" alt-text="Снимок экрана вкладки &quot;модель Машинное обучение Azure&quot;, показывающий отправленную модель.":::

Дополнительные сведения об отправке и обновлении моделей и сред см. в статье [Регистрация модели и локальное развертывание с расширенными возможностями использования](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/deployment/deploy-to-local/register-model-deploy-local-advanced.ipynb).

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения об управлении средами см. [в разделе создание & использование программных сред в машинное обучение Azure](how-to-use-environments.md).
- Дополнительные сведения о доступе к данным из хранилища данных см. в статье [Подключение к службам хранилища в Azure](how-to-access-data.md).
