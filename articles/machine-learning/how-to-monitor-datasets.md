---
title: Анализ и отслеживание смещения данных в наборах (Предварительная версия)
titleSuffix: Azure Machine Learning
description: Создание Машинное обучение Azure наборов данных. мониторы (Предварительная версия), отслеживание смещения данных в наборах и Настройка оповещений.
services: machine-learning
ms.service: machine-learning
ms.subservice: core
ms.reviewer: sgilley
ms.author: copeters
author: lostmygithubaccount
ms.date: 06/25/2020
ms.topic: conceptual
ms.custom: how-to
ms.openlocfilehash: 8ee2280aba99606d9e31a0e565a67cd6202df3c2
ms.sourcegitcommit: 96918333d87f4029d4d6af7ac44635c833abb3da
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2020
ms.locfileid: "93317018"
---
# <a name="detect-data-drift-preview-on-datasets"></a>Обнаружение смещения данных (Предварительная версия) в наборах


> [!IMPORTANT]
> В настоящее время в общедоступной предварительной версии обнаружение данных о смещении в них не осуществляется.
> Предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для производственных рабочих нагрузок. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

Узнайте, как отслеживать смещение данных и задавать предупреждения при высоком смещении.  

С помощью мониторов Машинное обучение Azureного набора данных (Предварительная версия) можно:
* **Проанализируйте смещение данных** , чтобы понять, как оно изменяется с течением времени.
* **Отслеживайте данные модели** на предмет различий между обучающими и обслуживающими наборами данных.  Начните с [сбора данных модели из развернутых моделей](how-to-enable-data-collection.md).
* **Отслеживайте новые данные** на предмет различий между базовым и целевым наборами данных.
* **Функции профилирования в данных** для трассировки изменения статистических свойств с течением времени.
* **Настройте оповещения о смещении данных** для раннего предупреждения о потенциальных проблемах. 

Для создания монитора используется [набор данных машинного обучения Azure](how-to-create-register-datasets.md) . Набор данных должен включать столбец timestamp.

Метрики смещения данных можно просмотреть с помощью пакета SDK для Python или в Машинное обучение Azure Studio.  Другие метрики и аналитические сведения доступны в ресурсе [Azure Application Insights](../azure-monitor/app/app-insights-overview.md) , связанном с рабочей областью машинное обучение Azure.

## <a name="prerequisites"></a>Предварительные требования

Для создания мониторов набора данных и работы с ними требуются:
* Подписка Azure. Если у вас еще нет подписки Azure, создайте бесплатную учетную запись, прежде чем начинать работу. Опробуйте [бесплатную или платную версию Машинного обучения Azure](https://aka.ms/AMLFree) уже сегодня.
* [Рабочая область машинное обучение Azure](how-to-manage-workspace.md).
* [Установленный пакет SDK для машинное обучение Azure для Python](/python/api/overview/azure/ml/install?preserve-view=true&view=azure-ml-py), включающий пакет azureml-DataSets.
* Структурированные (табличные) данные с меткой времени, указанной в пути к файлу, имени файла или столбце в данных.

## <a name="what-is-data-drift"></a>Что такое смещение данных?

Смещение данных — одна из основных причин, по которой точность модели снижается со временем.  При работе с моделями машинного обучения смещение данных — это изменение входных данных модели, которое приводит к снижению производительности модели.  Смещение данных мониторинга помогает выявить эти проблемы с производительностью модели.

Причины смещения данных:

- Вышестоящее изменение процесса, например замена датчика, который изменяет единицы измерения с дюймов на сантиметры. 
- Проблемы с качеством данных, такие как неисправный датчик, всегда считывают 0.
- Естественное смещение данных, например среднее значение температуры, изменяющееся с сезонами.
- Измените отношение между компонентами или ковариаций Shift. 

Машинное обучение Azure упрощает определение смещений путем вычисления одной метрики, которая абстрагирует сложность сравниваемых наборов данных.  Эти наборы данных могут содержать сотни функций и десятки тысяч строк. После того как будет обнаружено смещение, вы детализируем углублением функции, которые вызывают смещение.  Затем вы просматриваете метрики на уровне компонентов, чтобы отлаживать и изолировать основную причину отклонения.

Этот подход позволяет легко отслеживать данные вместо традиционных методов на основе правил. Методы на основе правил, такие как допустимый диапазон данных или допустимые уникальные значения, могут занимать много времени и подвержены ошибкам.

В Машинное обучение Azure используются мониторы наборов данных для обнаружения и оповещения о смещении данных.
  
### <a name="dataset-monitors"></a>Мониторы набора данных 

С помощью монитора набора данных можно:

* Обнаружение и оповещение о смещении данных в новых данных в наборе данных.
* Анализ исторических данных для смещения.
* Проведите профилирование новых данных с течением времени.

Алгоритм смещения данных предоставляет общую меру изменения данных и указывает, какие функции отвечают за дальнейшее исследование. Мониторы наборов данных создают ряд других метрик путем профилирования новых данных в `timeseries` наборе данных. 

Пользовательское оповещение можно настроить во всех метриках, создаваемых монитором, с помощью [Azure Application Insights](../azure-monitor/app/app-insights-overview.md). Мониторы наборов данных можно использовать для быстрого перехвата проблем с данными и сокращения времени отладки проблемы путем выявления вероятных причин.  

Концептуально существует три основных сценария настройки мониторов набора данных в Машинное обучение Azure.

Сценарий | Описание
---|---
Мониторинг данных модели на предмет отклонения от обучающих данных | Результаты из этого сценария можно интерпретировать как мониторинг прокси-сервера для точности модели, так как точность модели снижается при отслеживании смещения данных из обучающих данных.
Мониторинг набора данных временных рядов для смещения за предыдущий период времени. | Этот сценарий является более общим и может использоваться для мониторинга наборов данных, участвующих в создании вышестоящего или переходящего в процессе создания модели.  Целевой набор данных должен иметь столбец timestamp. Базовый набор данных может быть любым табличным набором данных, в котором есть функции, общие с целевым набором данных.
Выполните анализ прошлых данных. | Этот сценарий можно использовать для понимания исторических данных и информирования решений о параметрах мониторов набора данных.

Мониторы наборов данных зависят от следующих служб Azure.

|Служба Azure  |Описание  |
|---------|---------|
| *Набор данных* | Для получения обучающих данных и сравнения данных для обучения модели в смещении используются Машинное обучение наборы.  Создание профиля данных используется для создания некоторых из сообщаемых метрик, таких как min, Max, distinct values и Distinct Count. |
| *Конвейер и вычисление Azureml* | Задание вычисления смещения размещается в конвейере azureml.  Задание активируется по требованию или по расписанию для выполнения в расчете, настроенном на момент создания монитора отклонения.
| *Application Insights*| Смещение выдает метрики Application Insights, принадлежащих рабочей области машинного обучения.
| *Хранилище BLOB-объектов Azure*| Смещение выдает метрики в формате JSON в хранилище BLOB-объектов Azure.

## <a name="how-dataset-monitors-data"></a>Как набор данных отслеживает данные

Используйте Машинное обучение наборы данных для отслеживания смещения. Укажите базовый набор данных — обычно обучающий набор данных для модели. Целевой набор данных (обычно входные данные модели) сравнивается со временем для базового набора данных. Это сравнение означает, что в целевом наборе данных должен быть указан столбец timestamp.

## <a name="create-target-dataset"></a>Создать целевой набор данных

Целевому набору данных требуется `timeseries` установить набор характеристик, указав столбец отметок времени из столбца в данных или виртуального столбца, производного от шаблона пути к файлам. Создайте набор данных с меткой времени с помощью [пакета SDK для Python](#sdk-dataset) или [машинное обучение Azure Studio](#studio-dataset). Необходимо указать столбец, представляющий метку времени, чтобы добавить признаки `timeseries` к набору данных. Если данные разделены на структуру папок со сведениями о времени, например "{гггг/мм/дд}", создайте виртуальный столбец с помощью параметра шаблона пути и задайте для него значение "метка времени секции", чтобы повысить важность функциональности временных рядов.

### <a name="python-sdk"></a><a name="sdk-dataset"></a>Пакет SDK для Python

[`Dataset`](/python/api/azureml-core/azureml.data.tabulardataset?preserve-view=true&view=azure-ml-py#&preserve-view=truewith-timestamp-columns-timestamp-none--partition-timestamp-none--validate-false----kwargs-)Метод класса [`with_timestamp_columns()`](/python/api/azureml-core/azureml.data.tabulardataset?preserve-view=true&view=azure-ml-py#&preserve-view=truewith-timestamp-columns-timestamp-none--partition-timestamp-none--validate-false----kwargs-) определяет столбец временной метки для набора данных.

```python 
from azureml.core import Workspace, Dataset, Datastore

# get workspace object
ws = Workspace.from_config()

# get datastore object 
dstore = Datastore.get(ws, 'your datastore name')

# specify datastore paths
dstore_paths = [(dstore, 'weather/*/*/*/*/data.parquet')]

# specify partition format
partition_format = 'weather/{state}/{date:yyyy/MM/dd}/data.parquet'

# create the Tabular dataset with 'state' and 'date' as virtual columns 
dset = Dataset.Tabular.from_parquet_files(path=dstore_paths, partition_format=partition_format)

# assign the timestamp attribute to a real or virtual column in the dataset
dset = dset.with_timestamp_columns('date')

# register the dataset as the target dataset
dset = dset.register(ws, 'target')
```

Полный пример использования `timeseries` наборов данных см. в [примере записной книжки](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/work-with-data/datasets-tutorial/timeseries-datasets/tabular-timeseries-dataset-filtering.ipynb) или в [документации по пакету SDK для наборов данных](/python/api/azureml-core/azureml.data.tabulardataset?preserve-view=true&view=azure-ml-py#&preserve-view=truewith-timestamp-columns-timestamp-none--partition-timestamp-none--validate-false----kwargs-).

### <a name="azure-machine-learning-studio"></a><a name="studio-dataset"></a>Машинное обучение Azure Studio

При создании набора данных с помощью Машинное обучение Azure Studio убедитесь, что путь к данным содержит сведения о метке времени, включает все вложенные папки с данными и задает формат раздела.

В следующем примере берется все данные из вложенной папки *ноааисдфлорида/2019* , а в формате секции указывается год, месяц и день метки времени.

[![Формат раздела](./media/how-to-monitor-datasets/partition-format.png)](media/how-to-monitor-datasets/partition-format-expand.png)

В параметрах **схемы** укажите столбец отметок времени из виртуального или вещественного столбца в указанном наборе данных:

:::image type="content" source="media/how-to-monitor-datasets/timestamp.png" alt-text="Задание метки времени":::

Если данные секционированы по датам, как в этом случае, можно также указать partition_timestamp.  Это позволяет более эффективно обрабатывать даты.

:::image type="content" source="media/how-to-monitor-datasets/timeseries-partitiontimestamp.png" alt-text="Отметка времени секции":::


## <a name="create-dataset-monitors"></a>Создание мониторов набора данных

Создание мониторов набора данных для обнаружения и оповещения о смещении данных в новом наборе данных.  Используйте либо [пакет SDK Python](#sdk-monitor) , либо [машинное обучение Azure Studio](#studio-monitor).

### <a name="python-sdk"></a><a name="sdk-monitor"></a>Пакет SDK для Python

Подробные сведения см. в [справочной документации по пакету SDK для Python о смещении данных](/python/api/azureml-datadrift/azureml.datadrift) . 

В следующем примере показано, как создать монитор набора данных с помощью пакета SDK для Python.

```python
from azureml.core import Workspace, Dataset
from azureml.datadrift import DataDriftDetector
from datetime import datetime

# get the workspace object
ws = Workspace.from_config()

# get the target dataset
dset = Dataset.get_by_name(ws, 'target')

# set the baseline dataset
baseline = target.time_before(datetime(2019, 2, 1))

# set up feature list
features = ['latitude', 'longitude', 'elevation', 'windAngle', 'windSpeed', 'temperature', 'snowDepth', 'stationName', 'countryOrRegion']

# set up data drift detector
monitor = DataDriftDetector.create_from_datasets(ws, 'drift-monitor', baseline, target, 
                                                      compute_target='cpu-cluster', 
                                                      frequency='Week', 
                                                      feature_list=None, 
                                                      drift_threshold=.6, 
                                                      latency=24)

# get data drift detector by name
monitor = DataDriftDetector.get_by_name(ws, 'drift-monitor')

# update data drift detector
monitor = monitor.update(feature_list=features)

# run a backfill for January through May
backfill1 = monitor.backfill(datetime(2019, 1, 1), datetime(2019, 5, 1))

# run a backfill for May through today
backfill1 = monitor.backfill(datetime(2019, 5, 1), datetime.today())

# disable the pipeline schedule for the data drift detector
monitor = monitor.disable_schedule()

# enable the pipeline schedule for the data drift detector
monitor = monitor.enable_schedule()
```

Полный пример настройки `timeseries` набора данных и средства обнаружения смещения данных см. в нашем [примере записной книжки](https://aka.ms/datadrift-notebook).

### <a name="azure-machine-learning-studio"></a><a name="studio-monitor"></a> Машинное обучение Azure Studio

1. Перейдите на [домашнюю страницу Studio](https://ml.azure.com).
1. Выберите вкладку **наборы данных** слева. 
1. Выберите **мониторы набора данных**.
   ![Список мониторов](./media/how-to-monitor-datasets/monitor-list.png)

1. Нажмите кнопку **+ Создать монитор** и продолжайте работу с мастером, нажав кнопку **Далее**.  

:::image type="content" source="media/how-to-monitor-datasets/wizard.png" alt-text="Мастер создания монитора":::

* **Выберите целевой набор данных**.  Целевой набор данных — это табличный набор данных с заданным столбцом timestamp, который будет проанализирован для смещения данных. Целевой набор данных должен иметь функции, общие с базовым набором данных, а также `timeseries` набор данных, к которому добавляются новые данные. Исторические данные в целевом наборе данных можно анализировать, а также отслеживать новые данные.

* **Выберите базовый набор данных.**  Выберите табличный набор данных, который будет использоваться в качестве базового для сравнения целевого набора данных с течением времени.  Базовый набор данных должен иметь функции, общие с целевым набором данных.  Выберите диапазон времени для использования среза целевого набора данных или укажите отдельный набор данных для использования в качестве базового.

* **Параметры монитора**.  Эти параметры предназначены для конвейера монитора запланированного набора данных, который будет создан. 

    | Параметр | Описание | Советы | Изменяемый | 
    | ------- | ----------- | ---- | ------- |
    | Имя | Имя монитора набора данных. | | Нет |
    | Компоненты | Список функций, которые будут анализироваться за смещение данных с течением времени. | Задайте функции вывода модели для измерения смещения концепции. Не включайте функции, которые естественным образом отменяют время (месяц, год, индекс и т. д.). После настройки списка функций можно выполнить обратную засыпку и существующий монитор рассмещения данных. | Да | 
    | Целевой объект вычисления | Целевой объект Машинное обучение Azure вычислений для запуска заданий монитора набора данных. | | Да | 
    | Включить | Включение или отключение расписания в конвейере монитора набора данных | Отключите расписание для анализа исторических данных с помощью параметра «обратная засыпку». Его можно включить после создания монитора набора данных. | Да | 
    | Частота | Частота, которая будет использоваться для планирования задания конвейера и анализа исторических данных при выполнении обратной передачи. Параметры включают ежедневное, еженедельное или ежемесячное. | Каждый запуск сравнивает данные в целевом наборе данных в соответствии с частотой: <li>Ежедневно: сравнение последнего полного дня в целевом наборе данных с базовыми показателями <li>Еженедельно. Сравнение последней последней недели (понедельник – воскресенье) в целевом наборе данных с базовым показателем <li>Ежемесячно: сравнение последнего завершенного месяца в целевом наборе данных с базовыми показателями | Нет | 
    | Задержка | Время в часах, затраченное на получение данных в наборе данных. Например, если для получения данных в базе данных SQL, которую инкапсулирует данные, требуется три дня, установите задержку 72. | Невозможно изменить после создания монитора набора данных | Нет | 
    | адреса электронной почты; | Адреса электронной почты для оповещений на основе нарушения порогового значения процента смещения данных. | Сообщения электронной почты отправляются через Azure Monitor. | Да | 
    | Порог | Пороговое значение смещения данных в процентах для предупреждений электронной почты. | Дополнительные оповещения и события можно задать во многих других метриках в связанном Application Insights ресурсе рабочей области. | Да |

После завершения работы мастера в списке появится монитор результирующего набора данных. Выберите его, чтобы открыть страницу сведений этого монитора.

## <a name="understand-data-drift-results"></a>Общие сведения о смещении данных

В этом разделе показаны результаты мониторинга набора данных, расположенного на странице « **Datasets**  /  **мониторы набора данных** » в Azure Studio.  Вы можете обновить параметры, а также проанализировать существующие данные за определенный период времени на этой странице.  

Начните с получения подробных сведений о величине смещения данных и о том, какие функции следует исследовать Подробнее.

:::image type="content" source="media/how-to-monitor-datasets/drift-overview.png" alt-text="Общие сведения о смещении":::


| Метрика | Описание | 
| ------ | ----------- | 
| Величина смещения данных | Процентная доля смещения между базовым и целевым наборами данных с течением времени. В диапазоне от 0 до 100, 0 указывает на идентичные наборы данных и 100 указывает, что Машинное обучение Azureная модель смещения может полностью отличить два набора данных друг от друга. Шум в выражении точного процента ожидается из-за методик машинного обучения, используемых для создания этой величины. | 
| Основные функции смещения | Показывает функции из набора данных, которые смещены от наибольшего к и, следовательно, способствуют наибольшему значению показателя смещения. Из-за ковариаций сдвига базовое распределение компонента не обязательно должно быть изменено, чтобы иметь относительно высокую важность функций. |
| Порог | Значение смещения данных за пределами порогового значения приведет к активации предупреждений. Это можно настроить в параметрах монитора. | 

### <a name="drift-magnitude-trend"></a>Тренд величины смещения

Узнайте, как набор данных отличается от целевого набора данных за указанный период времени.  Чем ближе к 100%, тем больше различаются два набора данных.

:::image type="content" source="media/how-to-monitor-datasets/drift-magnitude.png" alt-text="Тренд величины смещения":::

### <a name="drift-magnitude-by-features"></a>Величина смещения по функциям

В этом разделе содержатся подробные сведения об изменениях в распределении выбранного компонента, а также о других статистических функциях со временем.

Целевой набор данных также профилирован с течением времени. Статистическое расстояние между базовым распределением каждого компонента сравнивается со временем целевого набора данных.  По сути, это похоже на величину смещения данных.  Однако это статистическое расстояние предназначено для отдельных функций, а не для всех функций. Также доступны значения min, Max и среднее.

В Машинное обучение Azure Studio щелкните полосу на диаграмме, чтобы просмотреть сведения об уровне функций для этой даты. По умолчанию вы видите распределение базового набора данных и самое последнее распределение выполнения для одной и той же функции.

:::image type="content" source="media/how-to-monitor-datasets/drift-by-feature.gif" alt-text="Величина смещения по функциям":::

Эти метрики также можно получить в пакете SDK для Python с помощью `get_metrics()` метода для `DataDriftDetector` объекта.

### <a name="feature-details"></a>Сведения о функции

Наконец, прокрутите вниз, чтобы просмотреть сведения о каждой отдельной функции.  Используйте раскрывающиеся списки над диаграммой, чтобы выбрать функцию, и Дополнительно выберите метрику, которую нужно просмотреть.

:::image type="content" source="media/how-to-monitor-datasets/numeric-feature.gif" alt-text="Диаграмма числовых функций и сравнение":::

Метрики на диаграмме зависят от типа функции.

* Числовые функции

    | Метрика | Описание |  
    | ------ | ----------- |  
    | Dresdner расстояние | Минимальный объем работы для преобразования базового распределения в целевое распределение. |
    | Среднее значение | Среднее значение функции. |
    | Минимальное значение | Минимальное значение функции. |
    | Максимальное значение | Максимальное значение функции. |

* Функции категорий
    
    | Метрика | Описание |  
    | ------ | ----------- |  
    | Евклидовой расстояние     |  Вычислено для столбцов категорий. Евклидово расстояние вычисляются для двух векторов, созданных на основе многоресурсоемких распределений одного столбца категорий из двух наборов данных. 0 означает отсутствие разницы в многозначных дистрибутивах.  Чем больше оно отклоняется от 0, тем больше этот столбец смещен. Тренды можно рассматривать с помощью графика временных рядов этой метрики и могут оказаться полезными при обнаружении функции смещения.  |
    | Уникальные значения | Число уникальных значений функции (количество элементов). |

На этой диаграмме выберите одну дату для сравнения распределения компонентов между целевым объектом и этой датой для отображаемого компонента. Для числовых функций это показывает два распределения вероятностей.  Если функция является числовой, отображается линейчатая диаграмма.

:::image type="content" source="media/how-to-monitor-datasets/select-date-to-compare.gif" alt-text="Выберите дату для сравнения с целевым объектом":::

## <a name="metrics-alerts-and-events"></a>Метрики, оповещения и события

Вы можете запросить метрики в ресурсе [Azure Application Insights](../azure-monitor/app/app-insights-overview.md) , связанном с рабочей областью машинного обучения. У вас есть доступ ко всем функциям Application Insights, включая настройку настраиваемых правил оповещений и групп действий для запуска таких действий, как, электронная почта, SMS, Push/Voice или функция Azure. Дополнительные сведения см. в полной Application Insights документации. 

Чтобы приступить к работе, перейдите к [портал Azure](https://portal.azure.com) и выберите страницу **обзора** вашей рабочей области.  Связанный Application Insights ресурс находится в крайнем правом углу:

[![Обзор портала Azure](./media/how-to-monitor-datasets/ap-overview.png)](media/how-to-monitor-datasets/ap-overview-expanded.png)

Выберите журналы (аналитика) в разделе Мониторинг на левой панели:

![Обзор Application Insights](./media/how-to-monitor-datasets/ai-overview.png)

Метрики монитора набора данных хранятся в виде `customMetrics` . После настройки монитора набора данных для просмотра можно написать и выполнить запрос:

[![Запрос log Analytics](./media/how-to-monitor-datasets/simple-query.png)](media/how-to-monitor-datasets/simple-query-expanded.png)

Определив метрики, чтобы настроить правила оповещений, создайте новое правило генерации оповещений:

![Новое правило генерации оповещений](./media/how-to-monitor-datasets/alert-rule.png)

Можно использовать существующую группу действий или создать новую, чтобы определить действие, выполняемое при выполнении условий набора.

![Новая группа действий](./media/how-to-monitor-datasets/action-group.png)

## <a name="next-steps"></a>Дальнейшие действия

* Перейдите в [машинное обучение Azure Studio](https://ml.azure.com) или в [записную книжку Python](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/work-with-data/datadrift-tutorial/datadrift-tutorial.ipynb) , чтобы настроить монитор набора данных.
* См. раздел Настройка смещения данных для [моделей, развернутых в службе Azure Kubernetes](./how-to-enable-data-collection.md).
* Настройка мониторов смещения набора данных с помощью [сетки событий](how-to-use-event-grid.md). 
* При возникновении проблем ознакомьтесь с общими [советами по устранению неполадок](resource-known-issues.md#data-drift) .