---
title: 'Руководство по Обучение и развертывание моделей: VS Code (предварительная версия)'
titleSuffix: Azure Machine Learning
description: Узнайте о том, как обучать и развертывать модель классификации изображений с использованием TensorFlow и расширения Visual Studio Code для Машинного обучения Azure
services: machine-learning
ms.service: machine-learning
ms.subservice: core
ms.topic: tutorial
author: luisquintanilla
ms.author: luquinta
ms.date: 07/09/2020
ms.custom: contperf-fy20q4
ms.openlocfilehash: 9ad96bdb632e134cf3e3a0f82bb97f88c87e72e9
ms.sourcegitcommit: 3ea45bbda81be0a869274353e7f6a99e4b83afe2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2020
ms.locfileid: "97033448"
---
# <a name="train-and-deploy-an-image-classification-tensorflow-model-using-the-azure-machine-learning-visual-studio-code-extension-preview"></a>Обучение и развертывание модели TensorFlow для классификации изображений с использованием расширения Машинного обучения Azure для Visual Studio Code (предварительная версия)

Узнайте о том, как обучить и развернуть модель классификации изображений для распознавания рукописных чисел с использованием TensorFlow и расширения Visual Studio Code для Машинного обучения Azure.

В этом руководстве вы выполнили следующие задачи.

> [!div class="checklist"]
> * Изучение кода
> * Создание рабочей области
> * Создание эксперимента
> * Настройка целевых объектов вычислений
> * Выполнение файла конфигурации
> * Обучение модели
> * Регистрация модели
> * Развертывание модели

## <a name="prerequisites"></a>Предварительные требования

- Подписка Azure. Если у вас ее нет, зарегистрируйтесь для использования [бесплатной или платной версии службы "Машинное обучение Azure"](https://aka.ms/AMLFree)
- Установите простой кроссплатформенный редактор кода [Visual Studio Code](https://code.visualstudio.com/docs/setup/setup-overview).
- Расширение Visual Studio Code для Студии машинного обучения Azure См. руководство по [настройке Visual Studio Code для Машинного обучения Azure](./tutorial-setup-vscode-extension.md).

## <a name="understand-the-code"></a>Изучение кода

Код в этом руководстве с помощью TensorFlow обучает модель машинного обучения для классификации изображений, которая определяет рукописные цифры от 0 до 9. Это достигается путем создания нейронной сети, которая принимает в качестве входных данных значения пикселей от изображения размером 28 x 28 пикселей и выводит список из 10 оценок вероятности, по одной для каждой классифицируемой цифры. Ниже приводится пример таких данных.  

![Цифры MNIST](./media/tutorial-train-deploy-image-classification-model-vscode/digits.png)

Получите код для работы с этим руководством, скачав [средства VS Code для репозитория ИИ](https://github.com/microsoft/vscode-tools-for-ai/archive/master.zip) и развернув их в любом расположении на компьютере.

## <a name="create-a-workspace"></a>Создание рабочей области

Первое, что нужно сделать для создания приложения в Машинном обучении Azure, — это создать рабочую область. Рабочая область содержит ресурсы для обучения моделей, а также сами обученные модели. См. сведения о [рабочих областях](./concept-workspace.md). 

1. На панели действий Visual Studio Code щелкните значок **Azure**, чтобы открыть представление Машинного обучения Azure.
1. Щелкните правой кнопкой мыши подписку Azure и выберите **Create Workspace** (Создать рабочую область). 
    
    > [!div class="mx-imgBorder"]
    > ![Создание рабочей области](./media/tutorial-train-deploy-image-classification-model-vscode/create-workspace.png)

1. По умолчанию имя содержит значения даты и времени создания. В текстовом поле ввода измените имя на значение TeamWorkspace и нажмите клавишу **ВВОД**.
1. Выберите команду **Создать группу ресурсов**. 
1. Укажите имя TeamWorkspace-rg для группы ресурсов и нажмите клавишу **ВВОД**. 
1. Выберите расположение для рабочей области. Мы рекомендуем выбрать расположение, ближайшее к расположению развертывания модели. Например, "Западная часть США 2".
1. При появлении запроса на выбор типа рабочей области выберите **базовая**.

На этом этапе выполняется запрос к Azure для создания новой рабочей области в учетной записи. Через несколько минут в узле подписки появится новая рабочая область. 

## <a name="create-an-experiment"></a>Создание эксперимента

В рабочей области можно создать один или несколько экспериментов, чтобы отслеживать и анализировать отдельные запуски обучения моделей. Эти запуски можно выполнять в облаке Azure или на локальном компьютере.

1. На панели действий Visual Studio Code щелкните значок **Azure**. Откроется представление "Машинное обучение Azure".
1. Разверните узел подписки.
1. Разверните узел **TeamWorkspace**. 
1. Щелкните правой кнопкой мыши узел **Эксперименты**.
1. В контекстном меню выберите **Создать эксперимент**.

    > [!div class="mx-imgBorder"]
    > ![Создание эксперимента](./media/tutorial-train-deploy-image-classification-model-vscode/create-experiment.png)

1. Введите для эксперимента имя MNIST и нажмите клавишу **ВВОД**, чтобы создать эксперимент. 

Как и для рабочих областей, в Azure отправляется запрос на создание эксперимента с указанными конфигурациями. Через несколько минут новый эксперимент появится в узле *Эксперименты* в рабочей области. 

## <a name="configure-compute-targets"></a>Настройка целевых объектов вычислений

Целевым объектом вычислений называется вычислительный ресурс или среда, где выполняются скрипты и развертываются обученные модели. См. сведения в документации по [целевым объектам вычислений в Машинном обучении Azure.](./concept-compute-target.md)

Чтобы создать целевой объект вычислений, выполните следующие действия.

1. На панели действий Visual Studio Code щелкните значок **Azure**. Откроется представление "Машинное обучение Azure". 
1. Разверните узел подписки. 
1. Разверните узел **TeamWorkspace**. 
1. В узле рабочей области щелкните правой кнопкой мыши узел **Вычислительные кластеры** и выберите **Создать вычислительный ресурс**. 

    > [!div class="mx-imgBorder"]
    > ![Создание целевого объекта вычислений](./media/tutorial-train-deploy-image-classification-model-vscode/create-compute.png)

1. Щелкните **Вычислительная среда Машинного обучения Azure (AmlCompute)** . Вычислительная среда Машинного обучения Azure — это управляемая вычислительная инфраструктура, которая позволяет пользователю легко создавать одно- и многоузловые вычислительные среды для предоставления другим пользователям в вашей рабочей области.
1. Выберите размер виртуальной машины. Выберите **Standard_F2s_v2** в списке вариантов. Размер виртуальной машины влияет на то, сколько времени потребуется на обучение моделей. См. сведения о [размерах виртуальных машин Linux в Azure](../virtual-machines/sizes.md).
1. Введите для вычислительной среды имя TeamWkspc-com и нажмите клавишу **ВВОД**, чтобы создать вычислительную среду.

    В VS Code появится файл, содержимое которого выглядит примерно так:

    ```json
    {
        "location": "westus2",
        "tags": {},
        "properties": {
            "computeType": "AmlCompute",
            "description": "",
            "properties": {
                "vmSize": "Standard_F2s_v2",
                "vmPriority": "dedicated",
                "scaleSettings": {
                    "maxNodeCount": 4,
                    "minNodeCount": 0,
                    "nodeIdleTimeBeforeScaleDown": "PT120S"
                }
            }
        }
    }
    ```

1. Если конфигурация вас устраивает, откройте палитру команд, щелкнув **Представление > Палитра команд**.
1. Введите следующую команду на палитре команд, чтобы сохранить файл конфигурации запуска.

    ```text
    Azure ML: Save and Continue
    ```

Через несколько минут новый целевой объект вычислений появится в узле *Вычислительные кластеры* в рабочей области.

## <a name="create-a-run-configuration"></a>Создание конфигурации запуска

При отправке выполнения обучения в целевой объект вычислений также предоставляется конфигурация для выполнения обучающего задания. Например, это могут быть скрипт с кодом обучения и зависимости Python, необходимые для его выполнения.

Чтобы создать конфигурацию запуска, выполните следующие действия.

1. На панели действий Visual Studio Code щелкните значок **Azure**. Откроется представление "Машинное обучение Azure". 
1. Разверните узел подписки. 
1. Разверните узел **TeamWorkspace > Вычислительные кластеры**. 
1. Под этим узлом щелкните правой кнопкой мыши вычислительный узел **TeamWkspc-com** и выберите **Создание конфигурации запуска**.

    > [!div class="mx-imgBorder"]
    > ![Создание конфигурации запуска](./media/tutorial-train-deploy-image-classification-model-vscode/create-run-configuration.png)

1. Введите для конфигурации запуска имя MNIST-rc и нажмите клавишу **ВВОД**, чтобы создать конфигурацию запуска.
1. Выберите **Create new Azure ML Environment** (Новая среда машинного обучения Azure). Среды определяют зависимости, необходимые для выполнения скриптов.
1. Присвойте среде имя MNIST-env и нажмите клавишу **ВВОД**.
1. В списке выберите **файл зависимостей Conda**.
1. Нажмите **ВВОД**, чтобы просмотреть этот файл. В нашем примере это файл `env.yml` в каталоге `vscode-tools-for-ai/mnist-vscode-docs-sample`.

    В VS Code появится файл, содержимое которого выглядит примерно так:

    ```json
    {
        "name": "MNIST-env",
        "version": "1",
        "python": {
            "interpreterPath": "python",
            "userManagedDependencies": false,
            "condaDependencies": {
                "name": "vs-code-azure-ml-tutorial",
                "channels": [
                    "defaults"
                ],
                "dependencies": [
                    "python=3.6.2",
                    "tensorflow=1.15.0",
                    "pip",
                    {
                        "pip": [
                            "azureml-defaults"
                        ]
                    }
                ]
            },
            "baseCondaEnvironment": null
        },
        "environmentVariables": {},
        "docker": {
            "baseImage": "mcr.microsoft.com/azureml/base:intelmpi2018.3-ubuntu16.04",
            "baseDockerfile": null,
            "baseImageRegistry": {
                "address": null,
                "username": null,
                "password": null
            },
            "enabled": false,
            "arguments": []
        },
        "spark": {
            "repositories": [],
            "packages": [],
            "precachePackages": true
        },
        "inferencingStackVersion": null
    }
    ```

1. Если конфигурация вас устраивает, сохраните ее. Для этого откройте палитру команд и введите следующую команду.

    ```text
    Azure ML: Save and Continue
    ```

1. В этом примере не используется набор данных, зарегистрированный в Машинном обучении Azure. Вместо этого он загружается при запуске *train.py*. При появлении запроса на создание ссылки на данные для обучающего запуска введите "n" в командной строке и нажмите клавишу **ВВОД**.
1. Нажмите клавишу **ВВОД**, чтобы просмотреть файл скрипта для выполнения в вычислительной среде. В нашем примере для обучения модели используется файл скрипта `train.py` в каталоге `vscode-tools-for-ai/mnist-vscode-docs-sample`.

    В VS Code появится файл с именем `MNIST-rc.runconfig`, содержимое которого выглядит примерно так:

    ```json
    {
        "script": "train.py",
        "arguments": [],
        "framework": "Python",
        "communicator": "None",
        "target": "TeamWkspc-com",
        "environment": {
            "name": "MNIST-env",
            "version": "1",
            "python": {
                "interpreterPath": "python",
                "userManagedDependencies": false,
                "condaDependencies": {
                    "name": "vs-code-azure-ml-tutorial",
                    "channels": [
                        "defaults"
                    ],
                    "dependencies": [
                        "python=3.6.2",
                        "tensorflow=1.15.0",
                        "pip",
                        {
                            "pip": [
                                "azureml-defaults"
                            ]
                        }
                    ]
                },
                "baseCondaEnvironment": null
            },
            "environmentVariables": {},
            "docker": {
                "baseImage": "mcr.microsoft.com/azureml/base:intelmpi2018.3-ubuntu16.04",
                "baseDockerfile": null,
                "baseImageRegistry": {
                    "address": null,
                    "username": null,
                    "password": null
                },
                "enabled": false,
                "arguments": []
            },
            "spark": {
                "repositories": [],
                "packages": [],
                "precachePackages": true
            },
            "inferencingStackVersion": null
        },
        "history": {
            "outputCollection": true,
            "snapshotProject": false,
            "directoriesToWatch": [
                "logs"
            ]
        }
    }
    ```

1. Если конфигурация вас устраивает, сохраните ее. Для этого откройте палитру команд и введите следующую команду.

    ```text
    Azure ML: Save and Continue
    ```

Под вычислительным узлом *TeamWkspc-com* добавится конфигурация запуска `MNIST-rc`, а под узлом *Среды* — конфигурация среды `MNIST-env`.

## <a name="train-the-model"></a>Обучение модели

В процессе обучения создается модель TensorFlow путем обработки обучающих данных и шаблонов обучения, внедренных в нее, для каждой из классифицируемых цифр. 

Чтобы выполнить эксперимент машинного обучения Azure, выполните следующие действия.

1. На панели действий Visual Studio Code щелкните значок **Azure**. Откроется представление "Машинное обучение Azure". 
1. Разверните узел подписки. 
1. Разверните узел **TeamWorkspace > Эксперименты**. 
1. Щелкните правой кнопкой мыши эксперимент **MNIST**.
1. Щелкните **Run Experiment** (Выполнить эксперимент).

    > [!div class="mx-imgBorder"]
    > ![Выполнение эксперимента](./media/tutorial-train-deploy-image-classification-model-vscode/run-experiment.png)

1. Выберите целевой объект вычислений **TeamWkspc-com** из списка вариантов целевых объектов вычислений.
1. Теперь выберите конфигурацию запуска **MNIST-rc**.
1. На этом этапе в Azure отправляется запрос на запуск эксперимента на выбранном целевом объекте вычислений в вашей рабочей области. Этот процесс занимает несколько минут. Время выполнения задания обучения зависит от нескольких факторов, таких как тип вычислительной среды и объем данных для обучения. Чтобы отслеживать ход выполнения эксперимента, щелкните правой кнопкой мыши узел текущий запуск и выберите **Просмотреть выполнение на портале Azure**.
1. Когда откроется диалоговое окно с запросом на открытие внешнего веб-сайта, щелкните **Открыть**.

    > [!div class="mx-imgBorder"]
    > ![Отслеживание хода выполнения эксперимента](./media/tutorial-train-deploy-image-classification-model-vscode/track-experiment-progress.png)

Когда модель закончит обучение, рядом с узлом выполнения появится метка состояния "Завершено".

## <a name="register-the-model"></a>Регистрация модели

Итак, вы завершили обучение модели и можете зарегистрировать ее в рабочей области. 

Чтобы зарегистрировать модель, выполните следующие действия.

1. На панели действий Visual Studio Code щелкните значок **Azure**. Откроется представление "Машинное обучение Azure".
1. Разверните узел подписки. 
1. Разверните узел **TeamWorkspace > Эксперименты > MNIST**.
1. Получите выходные данные модели, созданных в ходе обучения этой модели. Щелкните правой кнопкой мыши узел выполнения **Запуск 1**, а затем выберите **Скачать выходные данные модели**. 

    > [!div class="mx-imgBorder"]
    > ![Скачивание выходных данных модели](./media/tutorial-train-deploy-image-classification-model-vscode/download-outputs.png)

1. Выберите каталог для сохранения скачанных выходных данных. По умолчанию выходные данные размещаются в каталог, который открыт в этот момент в Visual Studio Code.
1. Щелкните правой кнопкой мыши узел **Модели** и выберите **Зарегистрировать модель**.

    > [!div class="mx-imgBorder"]
    > ![Регистрация модели](./media/tutorial-train-deploy-image-classification-model-vscode/register-model.png)

1. Присвойте модели имя MNIST-TensorFlow-model и нажмите клавишу **ВВОД**.
1. Модель TensorFlow состоит из нескольких файлов. В списке вариантов выберите для пути к модели формат **Model folder** (Папка модели). 
1. Выберите каталог `azureml_outputs/Run_1/outputs/outputs/model`.

    В Visual Studio Code отобразится файл с конфигурацией модели, содержимое которого выглядит примерно так:

    ```json
    {
        "modelName": "MNIST-TensorFlow-model",
        "tags": {
            "": ""
        },
        "modelPath": "c:\\Dev\\vscode-tools-for-ai\\mnist-vscode-docs-sample\\azureml_outputs\\Run_1\\outputs\\outputs\\model",
        "description": ""
    }
    ```

1. Если конфигурация вас устраивает, сохраните ее. Для этого откройте палитру команд и введите следующую команду.

    ```text
    Azure ML: Save and Continue
    ```

Через несколько минут модель отобразится в узле *Модели*.

## <a name="deploy-the-model"></a>Развертывание модели

Вы можете с помощью Visual Studio Code развернуть модель в качестве веб-службы в следующих расположениях:

+ Экземпляры контейнеров Azure (ACI);
+ Служба Azure Kubernetes (AKS).

Контейнеры ACI для тестирования не нужно создавать заранее, так как они создаются по мере необходимости. Но кластеры AKS нужно настроить заранее. См. сведения о [вариантах размещения для развертывания моделей в Машинном обучении Azure](how-to-deploy-and-where.md).

Чтобы развернуть веб-службу в формате ACI, выполните следующие действия.

1. На панели действий Visual Studio Code щелкните значок **Azure**. Откроется представление "Машинное обучение Azure".
1. Разверните узел подписки. 
1. Разверните узел **TeamWorkspace > Модели**. 
1. Щелкните правой кнопкой мыши **MNIST-TensorFlow-model** и выберите **Развернуть службу из зарегистрированной модели**.

    > [!div class="mx-imgBorder"]
    > ![Развертывание модели](./media/tutorial-train-deploy-image-classification-model-vscode/deploy-model.png)

1. Выберите **Экземпляры контейнеров Azure**.
1. Присвойте этой службе имя mnist-tensorflow-svc и нажмите клавишу **ВВОД**.
1. Выберите скрипт для выполнения в контейнере, нажав клавишу **ВВОД** в поле ввода и перейдя к файлу `score.py` в каталоге `mnist-vscode-docs-sample`.
1. Предоставьте зависимости, которые нужны для выполнения скрипта, нажав клавишу **ВВОД** в поле ввода и перейдя к файлу `env.yml` в каталоге `mnist-vscode-docs-sample`.

    В Visual Studio Code отобразится файл с конфигурацией модели, содержимое которого выглядит примерно так:

    ```json
    {
        "name": "mnist-tensorflow-svc",
        "imageConfig": {
            "runtime": "python",
            "executionScript": "score.py",
            "dockerFile": null,
            "condaFile": "env.yml",
            "dependencies": [],
            "schemaFile": null,
            "enableGpu": false,
            "description": ""
        },
        "deploymentConfig": {
            "cpu_cores": 1,
            "memory_gb": 10,
            "tags": {
                "": ""
            },
            "description": ""
        },
        "deploymentType": "ACI",
        "modelIds": [
            "MNIST-TensorFlow-model:1"
        ]
    }
    ```

1. Если конфигурация вас устраивает, сохраните ее. Для этого откройте палитру команд и введите следующую команду.

    ```text
    Azure ML: Save and Continue
    ```

На этом этапе в Azure отправляется запрос на развертывание веб-службы. Этот процесс занимает несколько минут. После развертывания новая служба появится в узле *Конечные точки*.

## <a name="next-steps"></a>Дальнейшие действия

* См. инструкции по обучению с помощью Машинного обучения Azure без использования Visual Studio Code в [руководстве по обучению модели классификации изображений с помощью Службы машинного обучения Azure](tutorial-train-models-with-aml.md).
* См. инструкции по [редактированию, запуску и отладке кода Python на локальном компьютере](https://code.visualstudio.com/docs/Python/Python-tutorial).