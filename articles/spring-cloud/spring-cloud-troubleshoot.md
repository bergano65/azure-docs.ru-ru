---
title: Руководство по устранению неполадок для Azure Spring Cloud | Документация Майкрософт
description: Руководство по устранению неполадок для Azure Spring Cloud
author: jpconnock
ms.service: spring-cloud
ms.topic: troubleshooting
ms.date: 11/04/2019
ms.author: jeconnoc
ms.openlocfilehash: af3b0b6113833dfd36be8b604b6b3d3e7b33fe5f
ms.sourcegitcommit: 5cfe977783f02cd045023a1645ac42b8d82223bd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2019
ms.locfileid: "74151143"
---
# <a name="troubleshoot-common-azure-spring-cloud-issues"></a>Устранение распространенных проблем с пружинным облаком Azure

В этой статье приводятся инструкции по устранению проблем с облачным развертыванием Azure. Дополнительные сведения см. в статье [вопросы и ответы о пружинных облаках Azure](spring-cloud-faq.md).

## <a name="availability-performance-and-application-issues"></a>Проблемы с доступностью, производительностью и приложениями

### <a name="my-application-cant-start-for-example-the-endpoint-cant-be-connected-or-it-returns-a-502-after-a-few-retries"></a>Не удается запустить приложение (например, не удается подключиться к конечной точке или возвращается 502 после нескольких попыток)

Экспортируйте журналы в Azure Log Analytics. Таблица для журналов приложений с пружинами называется *аппплатформлогсфорспринг*. Дополнительные сведения см. в разделе [Анализ журналов и метрик с помощью параметров диагностики](diagnostic-services.md).

В журналах может появиться следующее сообщение об ошибке:

> "org. спрингфрамеворк. Context. Аппликатионконтекстексцептион: не удается запустить веб-сервер"

Это сообщение указывает на одну из двух вероятных проблем: 
* отсутствует один из компонентов или одна из его зависимостей;
* одно из свойств компонента отсутствует или недопустимо. В этом случае, скорее всего, будет отображаться «Java. lang. Иллегаларгументексцептион».

Привязки служб также могут вызвать сбои при запуске приложения. Чтобы запросить журналы, используйте ключевые слова, связанные со связанными службами. Например, предположим, что приложение имеет привязку к экземпляру MySQL, для которого задано локальное системное время. Если приложение не запускается, в журнале может появиться следующее сообщение об ошибке:

> "Java. SQL. SQLException: значение часового пояса сервера" в формате UTC "не распознано или представляет более одного часового пояса".

Чтобы устранить эту ошибку, перейдите к `server parameters` экземпляра MySQL и измените значение `time_zone` с " *система* " на " *+ 0:00*".


### <a name="my-application-crashes-or-throws-an-unexpected-error"></a>В приложении происходит сбой или возникает непредвиденная ошибка

При отладке сбоев приложений Начните с проверки состояния выполнения и обнаружения приложения. Для этого перейдите в раздел _Управление приложениями_ в портал Azure, чтобы убедиться в том, что все приложения выполняются _и_ _работают_ .

* Если состояние " _работает_ ", но состояние обнаружения не установлено _, перейдите_в раздел ["мое приложение не может быть зарегистрировано"](#my-application-cant-be-registered) .

* Если состояние обнаружения — " _работает", перейдите_к разделу метрики, чтобы проверить работоспособность приложения. Проверьте следующие метрики:


  - `TomcatErrorCount` (_Tomcat. Global. Error_). здесь учитываются все исключения пружинных приложений. Если это число велико, перейдите в Log Analytics Azure, чтобы проверить журналы приложений.

  - `AppMemoryMax` (_виртуальной машины Java. Memory. Max_): максимальный объем памяти, доступный приложению. Значение может быть не определено или со временем может измениться, если оно определено. Если он определен, объем используемой и выделенной памяти всегда меньше или равен Max. Однако выделение памяти может завершиться ошибкой с `OutOfMemoryError` сообщением, если распределение пытается увеличить используемую память таким, что *использовалась > зафиксирована*, даже если *используется < = Max* , по-прежнему истинно. В такой ситуации попробуйте увеличить максимальный размер кучи с помощью параметра `-Xmx`.

  - `AppMemoryUsed` (_виртуальной машины Java. Memory. used_): объем памяти в байтах, используемый приложением в данный момент. Для нормальной загрузки приложения Java эта серия метрик образует шаблон *савтус* , где использование памяти постоянно увеличивается и уменьшается с небольшим шагом, и внезапно удаляется множество, а затем шаблон повторяется. Эта серия метрик возникает из-за сборки мусора на виртуальной машине Java, где действия коллекции представляют собой падения на шаблоне савтус.
    
    Эта метрика важна для выявления проблем с памятью, например:
    * Развертывание памяти в самом начале.
    * Выделение памяти всплеска для конкретного пути логики.
    * Постепенное утечка памяти.

  Дополнительные сведения см. в разделе [метрики](spring-cloud-concept-metrics.md).

Дополнительные сведения об Azure Log Analytics см. [в статье Приступая к работе с log Analytics в Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/log-query/get-started-portal).

### <a name="my-application-experiences-high-cpu-usage-or-high-memory-usage"></a>В приложении наблюдается высокая загрузка ЦП или интенсивное потребление памяти

Если в приложении используется высокая загрузка ЦП или памяти, то выполняется одно из двух условий:
* Все экземпляры приложения имеют высокий уровень использования ЦП или памяти.
* Некоторые экземпляры приложения имеют высокую степень использования ЦП или памяти.

Чтобы определить, какая ситуация применима, выполните следующие действия.

1. Перейдите в раздел **метрики**и выберите **процент использования ЦП службы** или **используемая память службы**.
2. Добавьте **приложение =** Filter, чтобы указать, какое приложение следует отслеживать.
3. Разделите метрики по **экземпляру**.

Если *все экземпляры* испытывают высокую НАГРУЗКУ на ЦП или память, необходимо либо масштабировать приложение, либо увеличить использование ЦП или памяти. Дополнительные сведения см. [в разделе Учебник. масштабирование приложения в Azure веснного облака](spring-cloud-tutorial-scale-manual.md).

Если *некоторые экземпляры* испытывают высокую НАГРУЗКУ на ЦП или память, проверьте состояние экземпляра и состояние его обнаружения.

Дополнительные сведения см. в статье [метрики для Azure веснного облака](spring-cloud-concept-metrics.md).

Если все экземпляры работают и работают, перейдите в Azure Log Analytics, чтобы запросить журналы приложений и проверить логику кода. Это поможет понять, может ли любой из них повлиять на секционирование масштабирования. Дополнительные сведения см. [в разделе анализ журналов и метрик с помощью параметров диагностики](diagnostic-services.md).

Дополнительные сведения об Azure Log Analytics см. [в статье Приступая к работе с log Analytics в Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/log-query/get-started-portal). Запросите журналы с помощью [языка запросов Kusto](https://docs.microsoft.com/azure/kusto/query/).

### <a name="checklist-for-deploying-your-spring-application-to-azure-spring-cloud"></a>Контрольный список для развертывания пружинного приложения в Azure Веснного облака

Прежде чем приступить к подключению приложения, убедитесь, что оно соответствует следующим критериям.

* Приложение можно запустить локально с указанной версией среды выполнения Java.
* Конфигурация среды (ЦП, ОЗУ и экземпляры) соответствует минимальному набору требований поставщика приложений.
* Элементы конфигурации имеют ожидаемые значения. Дополнительные сведения см. в статье [Учебник по настройке сервера конфигурации Spring Cloud для вашей службы](spring-cloud-tutorial-config-server.md).
* Переменные среды имеют ожидаемые значения.
* Параметры ВИРТУАЛЬНОЙ машины Java имеют ожидаемые значения.
* Рекомендуется отключить или удалить внедренный _сервер конфигурации_ и службы _реестра пружинной службы_ из пакета приложения.
* Если к любым ресурсам Azure нужно применить _привязку службы_, убедитесь, что целевые ресурсы работают.

## <a name="configuration-and-management"></a>Настройка и управление

### <a name="i-encountered-a-problem-with-creating-an-azure-spring-cloud-service-instance"></a>Возникла проблема при создании экземпляра облачной службы Azure весны

Когда вы настраиваете экземпляр облачной службы Azure весны с помощью портал Azure, Azure Веснного облака выполняет проверку.

Но при попытке настроить экземпляр облачной службы Azure весны с помощью [Azure CLI](https://docs.microsoft.com/cli/azure/get-started-with-azure-cli) или [шаблона Azure Resource Manager](https://docs.microsoft.com/azure/azure-resource-manager/)убедитесь в том, что:

* подписка активна;
* Это расположение [поддерживается](spring-cloud-faq.md) в Azure веснного облака.
* группа ресурсов для экземпляра уже создана;
* имя ресурса соответствует правилу именования. Оно должно содержать только строчные буквы, цифры и дефисы. Первый символ должен быть буквой. Последний знак должен быть буквой или цифрой. Значение должно содержать от 2 до 32 символов.

Если вы хотите настроить экземпляр облачной службы Azure весны с помощью шаблона диспетчер ресурсов, сначала ознакомьтесь со [сведениями о структуре и синтаксисе шаблонов Azure Resource Manager](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-authoring-templates).

Имя экземпляра облачной службы Azure весны будет использоваться для запроса имени поддомена в разделе `azureapps.io`, поэтому установка завершится ошибкой, если имя конфликтует с существующим. Дополнительные сведения можно найти в журналах действий.

### <a name="i-cant-deploy-a-jar-package"></a>Не удается развернуть JAR-пакет

Невозможно отправить пакет/Source (JAR) файла архива Java с помощью портал Azure или шаблона диспетчер ресурсов.

При развертывании пакета приложения с помощью [Azure CLI](https://docs.microsoft.com/cli/azure/get-started-with-azure-cli)Azure CLI периодически опрашивает ход развертывания и в итоге отображает результат развертывания.

Если опрос будет прерван, вы сможете выполнить приведенную ниже команду для получения журналов развертывания.

`az spring-cloud app show-deploy-log -n <app-name>`

Убедитесь, что приложение упаковано в правильный [исполняемый формат JAR](https://docs.spring.io/spring-boot/docs/current/reference/html/executable-jar.html). Если пакет не упакован правильно, появится сообщение об ошибке следующего вида:

> "Ошибка: недопустимый или поврежденный jarfile/JAR/38bc8ea1-a6bb-4736-8e93-e8f3b52c8714"

### <a name="i-cant-deploy-a-source-package"></a>Не удается развернуть исходный пакет

Невозможно отправить пакет JAR/Source с помощью портал Azure или шаблона диспетчер ресурсов.

При развертывании пакета приложения с помощью [Azure CLI](https://docs.microsoft.com/cli/azure/get-started-with-azure-cli)Azure CLI периодически опрашивает ход развертывания и в итоге отображает результат развертывания.

Если опрос будет прерван, вы сможете выполнить приведенную ниже команду для получения сборки и журналов развертывания.

`az spring-cloud app show-deploy-log -n <app-name>`

Однако обратите внимание, что один экземпляр облачной службы Azure весны может одновременно запускать только одно задание сборки для одного исходного пакета. Дополнительные сведения см. в статьях [развертывание приложения](spring-cloud-quickstart-launch-app-portal.md) и [Настройка промежуточной среды в Azure веснного облака](spring-cloud-howto-staging-environment.md).

### <a name="my-application-cant-be-registered"></a>Не удается зарегистрировать приложение

В большинстве случаев такая ситуация возникает, когда *необходимые зависимости* и *Обнаружение служб* не настроены должным образом в файле объектной модели проекта (POM). После настройки встроенная конечная точка сервера реестра службы внедряется в качестве переменной среды приложения. Приложения регистрируются на сервере реестра службы и обнаруживают другие зависимые микрослужбы.

Подождите не менее двух минут, прежде чем вновь зарегистрированный экземпляр начнет получать трафик.

Если вы переносите существующее облачное решение на основе весны в Azure, убедитесь, что экземпляры _реестра_ и _сервера конфигурации_ нерегламентированных служб удалены (или отключены), чтобы избежать конфликтов с управляемыми экземплярами, предоставляемыми в Azure веснного облака.

Вы также можете проверить журналы клиента _реестра службы_ в log Analytics Azure. Дополнительные сведения см. в разделе [Анализ журналов и метрик с помощью параметров диагностики](diagnostic-services.md) .

Дополнительные сведения об Azure Log Analytics см. [в статье Приступая к работе с log Analytics в Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/log-query/get-started-portal). Запросите журналы с помощью [языка запросов Kusto](https://docs.microsoft.com/azure/kusto/query/).

### <a name="i-want-to-inspect-my-applications-environment-variables"></a>Я хочу проверить переменные среды моего приложения

Переменные среды сообщают о предварительной облачной платформе Azure, гарантируя, что Azure распознает, где и как настроить службы, составляющие приложение. Проверка правильности переменных среды является необходимым первым шагом при устранении потенциальных проблем.  Для просмотра переменных среды можно использовать конечную точку Spring Boot Actuator.  

> [!WARNING]
> Эта процедура предоставляет переменные среды с помощью конечной точки теста.  Не продолжайте, если тестовая конечная точка является общедоступной или если приложению назначено доменное имя.

1. Перейдите на сайт `https://<your application test endpoint>/actuator/health`.  
    - Ответ, аналогичный `{"status":"UP"}`, указывает, что конечная точка включена.
    - Если ответ отрицательный, включите следующую зависимость в файл *POM. XML* :

        ```xml
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-actuator</artifactId>
            </dependency>
        ```

1. Если конечная точка конечного загрузчика включена, перейдите в портал Azure и найдите страницу конфигурации приложения.  Добавьте переменную среды с именем `MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE` и значением `*`. 

1. Перезапустите приложение.

1. Перейдите к `https://<your application test endpoint>/actuator/env` и проверьте ответ.  Результат будет выглядеть так:

    ```json
    {
        "activeProfiles": [],
        "propertySources": {,
            "name": "server.ports",
            "properties": {
                "local.server.port": {
                    "value": 1025
                }
            }
        }
    }
    ```

Найдите дочерний узел с именем `systemEnvironment`.  Этот узел содержит переменные среды приложения.

> [!IMPORTANT]
> Не забудьте отменить раскрытие переменных среды перед тем, как сделать приложение общедоступным.  Перейдите в портал Azure, найдите страницу конфигурации приложения и удалите эту переменную среды: `MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE`.

### <a name="i-cant-find-metrics-or-logs-for-my-application"></a>Не удается найти метрики или журналы моего приложения

Перейдите в раздел **Управление приложениями** , чтобы убедиться в том, что состояния приложения _выполняются и_ _работают_ .

Если вы видите метрики из _виртуальной машины Java_ , но не метрики из _Tomcat_, проверьте, включена ли зависимость `spring-boot-actuator` в пакете приложения и что она успешно загружается.

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

Если журналы приложения можно архивировать в учетную запись хранения, но не отправляются в Azure Log Analytics, проверьте, правильно ли [настроена Рабочая область](https://docs.microsoft.com/azure/azure-monitor/learn/quick-create-workspace). Если вы используете бесплатный уровень Log Analytics Azure, обратите внимание, что [уровень Free не обеспечивает соглашения об уровне обслуживания (SLA)](https://azure.microsoft.com/support/legal/sla/log-analytics/v1_3/).
