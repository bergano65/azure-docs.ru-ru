---
title: Интеграция Центров событий Azure со службой "Приватный канал Azure"
description: Сведения об интеграции Центров событий Azure со службой "Приватный канал Azure"
ms.date: 06/23/2020
ms.topic: article
ms.openlocfilehash: bfed3f8e4c19463e10b721006d742726cf916900
ms.sourcegitcommit: 3543d3b4f6c6f496d22ea5f97d8cd2700ac9a481
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/20/2020
ms.locfileid: "86512267"
---
# <a name="integrate-azure-event-hubs-with-azure-private-link"></a>Интеграция Центров событий Azure с Приватным каналом Azure
Приватный канал Azure обеспечивает доступ к службам Azure (например, к Центрам событий Azure, службе хранилища Azure и Azure Cosmos DB), а также к размещенным в Azure службам клиентов или партнеров через **частную конечную точку** виртуальной сети.

Частная конечная точка — это сетевой интерфейс, который защищенно и надежно подключается к службе через Приватный канал Azure. Частная конечная точка использует частный IP-адрес из виртуальной сети, фактически передавая ее в виртуальную сеть. Весь трафик к службе может маршрутизироваться через частную конечную точку, поэтому шлюзы, устройства преобразования сетевых адресов (NAT), подключения ExpressRoute и VPN, а также общедоступные IP-адреса не требуются. Трафик между виртуальной сетью и службой проходит через магистральную сеть Майкрософт, что позволяет избежать рисков общедоступного Интернета. Вы можете подключиться к экземпляру ресурса Azure, обеспечивая наивысшую степень детализации в управлении доступом.

Дополнительные сведения см. в статье [Что такое Приватный канал Azure](../private-link/private-link-overview.md).

> [!IMPORTANT]
> Эта функция поддерживается как для **стандартных** , так и для **выделенных** уровней. 

>[!WARNING]
> Включение частных конечных точек может препятствовать взаимодействию других служб Azure с Центрами событий.
>
> Доверенные службы Майкрософт не поддерживаются при использовании виртуальных сетей.
>
> Распространенные сценарии Azure, которые не работают с виртуальными сетями (обратите внимание, что список **НЕ** является исчерпывающим):
> - Azure Monitor (параметр диагностики)
> - Azure Stream Analytics
> - Интеграция со службой "Сетка событий Azure".
> - Маршруты Центра Интернета вещей Azure.
> - Device Explorer Интернета вещей Azure.
>
> В виртуальной сети должны присутствовать следующие службы Майкрософт:
> - Веб-приложения Azure
> - Функции Azure

## <a name="add-a-private-endpoint-using-azure-portal"></a>Добавление частной конечной точки с помощью портала Azure

### <a name="prerequisites"></a>Предварительные требования

Чтобы интегрировать пространство имен Центров событий с Приватным каналом Azure, вам потребуются следующие сущности или разрешения.

- Пространство имен Центров событий.
- Виртуальная сеть Azure.
- Подсеть в виртуальной сети.
- Разрешения владельца или участника для пространства имен и виртуальной сети.

Частная конечная точка и виртуальная сеть должны находиться в одном регионе. При выборе региона для частной конечной точки с помощью портала будут автоматически фильтроваться только виртуальные сети в этом регионе. Пространство имен может находиться в другом регионе.

Частная конечная точка использует частный IP-адрес в виртуальной сети.

### <a name="steps"></a>Шаги
Если у вас уже есть пространство имен Центров событий, можно создать подключение Приватного канала к нему, выполнив следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com). 
2. В строке поиска введите **центры событий**.
3. Выберите **пространство имен** в списке, для которого необходимо добавить частную конечную точку.
4. Выберите вкладку **Сеть** в разделе **Параметры**.

    > [!NOTE]
    > Вкладка " **сеть** " отображается только для **стандартных** или **выделенных** пространств имен. 
1. Выберите вкладку **Подключения к частным конечным точкам** в верхней части страницы. 
1. Нажмите кнопку **+ Частная конечная точка** в верхней части страницы.

    :::image type="content" source="./media/private-link-service/private-link-service-3.png" alt-text="Страница "сеть" — Вкладка "подключения частной конечной точки" — Добавление ссылки на частную конечную точку":::
7. На странице **Базовые** выполните следующие действия. 
    1. Выберите **подписку Azure**, в которой нужно создать частную конечную точку. 
    2. Выберите **группу ресурсов** для ресурса частной конечной точки.
    3. Укажите **имя** частной конечной точки. 
    5. Выберите **регион** частной конечной точки. Частная конечная точка должна находиться в том же регионе, что и виртуальная сеть, но может находиться в разных регионах с ресурсом Приватного канала, к которому выполняется подключение. 
    6. По завершении выберите **Next: Ресурс >** в нижней части страницы.

        ![Создание частной конечной точки — страница "Базовые"](./media/private-link-service/create-private-endpoint-basics-page.png)
8. На странице **Ресурс** выполните следующие действия.
    1. Если для метода подключения вы выбираете **Подключиться к ресурсу Azure в моем каталоге**, выполните следующие действия. 
        1. Выберите **подписку Azure**, в которой существует **пространство имен Центров событий**. 
        2. Для параметра **Тип ресурса** выберите **Microsoft.EventHub/namespaces** в качестве **типа ресурса**.
        3. В качестве значения параметра **Ресурс** выберите пространство имен Центров событий в раскрывающемся списке. 
        4. Убедитесь, что для параметра **Целевой подресурс** задано **пространство имен**.
        5. По завершении выберите **Next: Конфигурация >**  в нижней части страницы. 
        
            ![Создание частной конечной точки — страница "Ресурсы"](./media/private-link-service/create-private-endpoint-resource-page.png)    
    2. Если вы выбрали **Подключиться к ресурсу Azure по идентификатору ресурса или псевдониму**, выполните следующие действия.
        1. Введите **идентификатор ресурса** и **псевдоним**. Это может быть идентификатор ресурса или псевдоним, к которому вам предоставили доступ. Самый простой способ получить идентификатор ресурса — перейти к пространству имен Центров событий на портале Azure и скопировать часть URI, начиная с `/subscriptions/`. См. следующее изображение в качестве примера. 
        2. Для параметра **Целевой подресурс** введите **пространство имен**. Это тип подресурса, к которому имеет доступ частная конечная точка.
        3. (необязательно) Введите **сообщение запроса**. Владелец ресурса видит это сообщение при управлении подключением к частной конечной точке.
        4. Затем щелкните **Далее. Конфигурация >** в нижней части страницы.

            ![Создание частной конечной точки — подключение с использованием идентификатора ресурса](./media/private-link-service/connect-resource-id.png)
9. На странице **Конфигурация** выберите подсеть в виртуальной сети, в которой требуется развернуть частную конечную точку. 
    1. Выберите **виртуальную сеть**. В раскрывающемся списке отображаются только виртуальные сети в выбранных сейчас подписке и расположении. 
    2. Выберите **подсеть** в выбранной виртуальной сети. 
    3. По завершении выберите **Next: Теги >** в нижней части страницы. 

        ![Частная конечная точка — страница "Конфигурация"](./media/private-link-service/create-private-endpoint-configuration-page.png)
10. На странице **Теги** создайте теги (имена и значения), которые нужно связать с ресурсом частной конечной точки. В нижней части страницы нажмите на кнопку **Просмотреть и создать**. 
11. На странице **Проверка и создание** проверьте все параметры и нажмите **Создать**, чтобы создать частную конечную точку.
    
    ![Создание частной конечной точки — страница "Проверка и создание"](./media/private-link-service/create-private-endpoint-review-create-page.png)
12. Убедитесь, что созданное подключение к частной конечной точке отображается в списке конечных точек. В этом примере частная конечная точка утверждается автоматически, так как вы подключились к ресурсу Azure в своем каталоге и имеете достаточные разрешения. 

    ![Частная конечная точка создана](./media/private-link-service/private-endpoint-created.png)

## <a name="add-a-private-endpoint-using-powershell"></a>Добавление частной конечной точки с помощью PowerShell
В следующем примере показано, как использовать Azure PowerShell для создания подключения частной конечной точки. Он не создает выделенный кластер. Чтобы создать выделенный кластер Центров событий, выполните действия, описанные в [этой статье](event-hubs-dedicated-cluster-create-portal.md). 

```azurepowershell-interactive
# create resource group

$rgName = "<RESOURCE GROUP NAME>"
$vnetlocation = "<VIRTUAL NETWORK LOCATION>"
$vnetName = "<VIRTUAL NETWORK NAME>"
$subnetName = "<SUBNET NAME>"
$namespaceLocation = "<NAMESPACE LOCATION>"
$namespaceName = "<NAMESPACE NAME>"
$peConnectionName = "<PRIVATE ENDPOINT CONNECTION NAME>"

# create virtual network
$virtualNetwork = New-AzVirtualNetwork `
                    -ResourceGroupName $rgName `
                    -Location $vnetlocation `
                    -Name $vnetName `
                    -AddressPrefix 10.0.0.0/16

# create subnet with endpoint network policy disabled
$subnetConfig = Add-AzVirtualNetworkSubnetConfig `
                    -Name $subnetName `
                    -AddressPrefix 10.0.0.0/24 `
                    -PrivateEndpointNetworkPoliciesFlag "Disabled" `
                    -VirtualNetwork $virtualNetwork

# update virtual network
$virtualNetwork | Set-AzVirtualNetwork

# create an event hubs namespace in a dedicated cluster
$namespaceResource = New-AzResource -Location $namespaceLocation `
                                    -ResourceName $namespaceName `
                                    -ResourceGroupName $rgName `
                                    -Sku @{name = "Standard"; capacity = 1} `
                                    -Properties @{clusterArmId = "/subscriptions/<SUBSCRIPTION ID>/resourceGroups/<RESOURCE GROUP NAME>/providers/Microsoft.EventHub/clusters/<EVENT HUBS CLUSTER NAME>"} `
                                    -ResourceType "Microsoft.EventHub/namespaces" -ApiVersion "2018-01-01-preview"

# create private endpoint connection
$privateEndpointConnection = New-AzPrivateLinkServiceConnection `
                                -Name $peConnectionName `
                                -PrivateLinkServiceId $namespaceResource.ResourceId `
                                -GroupId "namespace"

# get subnet object that you will use later
$virtualNetwork = Get-AzVirtualNetwork -ResourceGroupName  $rgName -Name $vnetName
$subnet = $virtualNetwork | Select -ExpandProperty subnets `
                                | Where-Object  {$_.Name -eq $subnetName}  
   
# create a private endpoint   
$privateEndpoint = New-AzPrivateEndpoint -ResourceGroupName $rgName  `
                                -Name $vnetName   `
                                -Location $vnetlocation `
                                -Subnet  $subnet   `
                                -PrivateLinkServiceConnection $privateEndpointConnection

(Get-AzResource -ResourceId $namespaceResource.ResourceId -ExpandProperties).Properties


```

### <a name="configure-the-private-dns-zone"></a>Настройка частной зоны DNS
Создайте частную зону DNS для домена Центров событий, а затем ссылку на связь с виртуальной сетью.

```azurepowershell-interactive
$zone = New-AzPrivateDnsZone -ResourceGroupName $rgName `
                            -Name "privatelink.servicebus.windows.net" 
 
$link  = New-AzPrivateDnsVirtualNetworkLink -ResourceGroupName $rgName `
                                            -ZoneName "privatelink.servicebus.windows.net" `
                                            -Name "mylink" `
                                            -VirtualNetworkId $virtualNetwork.Id  
 
$networkInterface = Get-AzResource -ResourceId $privateEndpoint.NetworkInterfaces[0].Id -ApiVersion "2019-04-01" 
 
foreach ($ipconfig in $networkInterface.properties.ipConfigurations) { 
    foreach ($fqdn in $ipconfig.properties.privateLinkConnectionProperties.fqdns) { 
        Write-Host "$($ipconfig.properties.privateIPAddress) $($fqdn)"  
        $recordName = $fqdn.split('.',2)[0] 
        $dnsZone = $fqdn.split('.',2)[1] 
        New-AzPrivateDnsRecordSet -Name $recordName -RecordType A -ZoneName "privatelink.servicebus.windows.net"  `
                                -ResourceGroupName $rgName -Ttl 600 `
                                -PrivateDnsRecords (New-AzPrivateDnsRecordConfig -IPv4Address $ipconfig.properties.privateIPAddress)  
    } 
}
```

## <a name="manage-private-endpoints-using-azure-portal"></a>Управление частными конечными точками с помощью портала Azure

При создании частной конечной точки подключение должно быть утверждено. Если ресурс, для которого создается частная конечная точка, находится в вашем каталоге, вы можете утвердить запрос на подключение, если у вас есть необходимые разрешения. При подключении к ресурсу Azure в другом каталоге необходимо дождаться, пока владелец этого ресурса утвердит запрос на подключение.

Существует четыре состояния подготовки:

| Действие в службе | Состояние частной конечной точки объекта-получателя службы | Описание |
|--|--|--|
| None | Ожидает | Подключение создается вручную и ожидает утверждения от владельца ресурса Приватного канала. |
| Утверждение | Approved | Подключение утверждено автоматически или вручную и готово к использованию. |
| Reject | Отклонено | Подключение отклонил владелец ресурса Приватного канала. |
| Удалить | Отключено | Подключение удалил владелец ресурса Приватного канала. Частная конечная точка станет информативной и подлежит удалению для очистки. |
 
###  <a name="approve-reject-or-remove-a-private-endpoint-connection"></a>Утверждение, отклонение или удаление подключения к частной конечной точке

1. Войдите на портал Azure.
2. В строке поиска введите **центры событий**.
3. Выберите **пространство имен** для управления.
4. Перейдите на вкладку **Сеть**.
5. Перейдите к соответствующему разделу в зависимости от операции, которую нужно выполнить: утвердить, отклонить или удалить.

### <a name="approve-a-private-endpoint-connection"></a>Утверждение подключения частной конечной точки
1. Если есть подключения в состоянии подготовки, вы увидите такое подключение в списке с состоянием **В ожидании**. 
2. Выберите **частную конечную точку**, которую вы хотите утвердить.
3. Нажмите кнопку **Утвердить**.

    ![Образ —](./media/private-link-service/approve-private-endpoint.png)
4. На странице **Утверждение подключения** добавьте комментарий (по желанию) и нажмите кнопку **Да**. Если выбрать **Нет**, ничего не произойдет. 
5. Вы увидите, что состояние подключения к частной конечной точке в списке изменилось на **Утверждено**. 

### <a name="reject-a-private-endpoint-connection"></a>Отклонение подключения к частной конечной точке

1. Если есть подключения к частным конечным точкам, которые вы хотите отклонить (для ожидающего запроса или существующего подключения), выберите подключение и нажмите кнопку **Отклонить**.

    ![Образ —](./media/private-link-service/private-endpoint-reject-button.png)
2. На странице **Отклонение подключения** введите комментарий (по желанию) и нажмите кнопку **Да**. Если выбрать **Нет**, ничего не произойдет. 
3. Вы увидите, что состояние подключения к частной конечной точке в списке изменилось на **Отклонено**. 

### <a name="remove-a-private-endpoint-connection"></a>Удаление подключения к частной конечной точке

1. Чтобы удалить подключение к частной конечной точке, выберите ее в списке и нажмите **Удалить** на панели инструментов.
2. На странице **Удаление подключения** нажмите **Да**, чтобы подтвердить удаление частной конечной точки. Если выбрать **Нет**, ничего не произойдет.
3. Вы увидите, что состояние изменилось на **Отключено**. Затем конечная точка исчезнет из списка.

## <a name="validate-that-the-private-link-connection-works"></a>Проверка работоспособности подключения Приватного канала

Необходимо убедиться, что ресурсы в одной подсети ресурса частной конечной точки подключаются к пространству имен Центров событий по частному IP-адресу и что они правильно интегрируются с частной зоной DNS.

Сначала создайте виртуальную машину, выполнив действия, описанные в статье [Краткое руководство. Создание виртуальной машины Windows на портале Azure](../virtual-machines/windows/quick-create-portal.md).

На вкладке **Сеть** выполните следующее. 

1. Укажите **виртуальную сеть** и **подсеть**. Необходимо выбрать виртуальную сеть, в которой развернута частная конечная точка.
2. Укажите ресурс **общедоступного IP-адреса**.
3. В списке **Группа безопасности сети сетевого адаптера** выберите **Нет**.
4. В поле **Балансировка нагрузки** выберите **Нет**.

Подключитесь к виртуальной машине, откройте командную строку и выполните следующую команду:

```console
nslookup <event-hubs-namespace-name>.servicebus.windows.net
```

Должен появиться следующий результат. 

```console
Non-authoritative answer:
Name:    <event-hubs-namespace-name>.privatelink.servicebus.windows.net
Address:  10.0.0.4 (private IP address associated with the private endpoint)
Aliases:  <event-hubs-namespace-name>.servicebus.windows.net
```

## <a name="limitations-and-design-considerations"></a>Проблемы и ограничения разработки

**Цены**. Сведения о ценах на службу "Приватный канал Azure" см. [здесь](https://azure.microsoft.com/pricing/details/private-link/).

**Ограничения**.  Эта возможность есть во всех общедоступных регионах Azure.

**Максимальное число частных конечных точек на пространство имен Центров событий**. 120.

Дополнительные сведения см. в разделе [Azure Private Link service: Limitations](../private-link/private-link-service-overview.md#limitations) (Служба "Приватный канал Azure". Ограничения)

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о службе [Приватный канал Azure](../private-link/private-link-service-overview.md)
- Дополнительная информация о [Центрах событий Azure](event-hubs-about.md)
