---
title: Настройка и настройка интеграции отчетов о затратах и использовании AWS с помощью службы "Управление затратами Azure"
description: В этой статье описывается настройка и настройка интеграции отчетов о затратах и использовании AWS с помощью службы "Управление затратами Azure".
services: cost-management
keywords: ''
author: bandersmsft
ms.author: banders
ms.date: 08/15/2019
ms.topic: conceptual
ms.service: cost-management
manager: ormaoz
ms.custom: ''
ms.openlocfilehash: 9664beca514abcbad4eca7c8f9dc1b494018802e
ms.sourcegitcommit: 040abc24f031ac9d4d44dbdd832e5d99b34a8c61
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/16/2019
ms.locfileid: "69535185"
---
# <a name="set-up-and-configure-aws-cost-and-usage-report-integration"></a>Настройка и настройка интеграции отчетов о затратах и использовании AWS

С помощью интеграции с Amazon Web Services (AWS) и отчетом об использовании (CUR) вы отслеживаете и контролируете затраты AWS в службе "Управление затратами Azure". Интеграция позволяет получить единое расположение в портал Azure, где вы отслеживаете и контролируете расходы для Azure и AWS. В этой статье объясняется, как настроить интеграцию и настроить ее, чтобы вы могли использовать функции управления затратами Azure для анализа затрат и оценки бюджетов.

Управление затратами обрабатывает AWS отчет о затратах и использовании, хранящийся в контейнере S3, с помощью учетных данных доступа AWS для получения определений отчетов и загрузки CSV-файлов отчета формата GZIP.

## <a name="create-a-cost-and-usage-report-in-aws"></a>Создание отчета о затратах и использовании в AWS

Использование отчета о затратах и использовании является AWSм способом получения и обработки AWS затрат. Дополнительные сведения см. в документации по [стоимости и использованию AWS](https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/billing-reports-costusage.html) .

Используйте страницу **отчеты по затратам на использование &** консоли управления выставлением счетов и затратами в AWS, чтобы создать отчет о затратах и использовании, выполнив следующие действия.

1. Войдите в консоль управления AWS и откройте [консоль управления выставлением счетов и затратами](https://console.aws.amazon.com/billing).
2. В области навигации выберите **затраты & отчеты об использовании**.
3. Выберите **создать отчет**.
4. В качестве **имени отчета**введите имя отчета.
5. В разделе **Дополнительные сведения о отчете**выберите **включить идентификаторы ресурсов**.
6. В поле **Параметры обновления данных**укажите, следует ли обновлять отчет о затратах и использовании AWS, если AWS применяет возмещения, кредиты или поддержку в учетную запись после завершения счета. При обновлении отчета в Amazon S3 загружается новый отчет. Рекомендуется оставить параметр выбранным.
7. Щелкните **Далее**.
8. Для **контейнера S3**щелкните **настроить**.
9. В диалоговом окне Настройка контейнера S3 выполните одну из следующих задач.
    1. Выберите существующий контейнер из раскрывающегося списка и нажмите кнопку **Далее**.
    2. Введите имя контейнера и регион, в котором нужно создать новый контейнер, и нажмите кнопку **Далее**.
10. Установите флажок **я подтвердил, что эта политика правильная**, а затем нажмите кнопку **сохранить**.
11. Используемых В поле префикс пути к отчету введите префикс пути к отчету, который необходимо добавить в начало имени отчета.
Если префикс не указан, то префиксом по умолчанию будет имя, указанное для отчета. Диапазон дат имеет `/report-name/date-range/` формат.
12. В качестве **единицы измерения времени**выберите **ежечасно**.
13. Для параметра **Управление версиями отчета**выберите, должна ли каждая из версий отчета перезаписать предыдущую версию, или, если требуются дополнительные новые отчеты.
14. Чтобы **включить интеграцию данных для**, выбор не требуется.
15. Для **сжатия**выберите **gzip**.
16. Щелкните **Далее**.
17. После просмотра параметров отчета выберите **Проверка и завершение**.

    Запишите имя отчета. Он будет использоваться в последующих шагах.

AWS доставки отчетов в контейнер Amazon S3 может занять до 24 часов. После начала доставки AWS обновляет файлы отчетов о затратах и использовании AWS по крайней мере один раз в день. Вы можете продолжить настройку среды AWS, не дожидаясь запуска доставки.

## <a name="create-a-role-and-policy-in-aws"></a>Создание роли и политики в AWS

Служба управления затратами Azure обращается к контейнеру S3, где отчет о затратах и использовании находился несколько раз в день. Службе требуется доступ к учетным данным для проверки новых данных. Вы создадите роль и политику в AWS, чтобы разрешить управление затратами на доступ к ней.

Чтобы включить доступ на основе ролей к учетной записи AWS в управлении затратами, роль создается в консоли AWS. Необходимо иметь _роль ARN_ и _External ID_ из консоли AWS. Позже они будут использоваться на странице **Создание СОЕДИНИТЕЛЯ AWS** в оснастке "Управление затратами".

Используйте мастер создания новой роли:

1. Войдите в консоль AWS и выберите **службы**.
2. В списке служб выберите **IAM**.
3. Выберите **роли** , а затем щелкните **создать роль**.
4. На следующей странице выберите **другую учетную запись AWS**.
5. В окне **идентификатор учетной записи**введите **432263259397**.
6. В разделе **Параметры**выберите **требовать внешний идентификатор (рекомендуется, когда третья сторона предложит эту роль)** .
7. В поле **внешний идентификатор**введите внешний идентификатор. Внешний идентификатор — это общий секретный код между ролью AWS и службой "Управление затратами Azure". Тот же внешний идентификатор также используется на новой странице **соединителя** в оснастке "Управление затратами". Например, внешний идентификатор напоминает _Companyname1234567890123_.

    > [!NOTE]
    > Не изменяйте выбор для **запроса MFA**. Он должен оставаться сброшенным.
8. По завершении выберите **Next: разрешения**.
9. Выберите **создать политику**. Откроется новая вкладка браузера. Здесь вы создадите политику.
10. Выберите **выбрать службу**.

Настройка разрешения для отчета о затратах и использовании:

1. Введите **отчет о затратах и использовании**.
2. Выберите **уровень** > доступа**Read** > **дескриберепортдефинитионс**. Этот шаг позволяет управлению затратами читать, какие отчеты определяются, и определять, соответствуют ли они необходимым условиям определения отчета.
3. Выберите **добавить дополнительные разрешения**.

Настройте разрешение для контейнеров и объектов S3:

1. Выберите **выбрать службу**.
2. Введите **S3**.
3. Выберите > **список**уровень > доступа**ListBucket**. Это действие получает список объектов в контейнере S3.
4. Выберите **уровень** > доступа**Read** > **GetObject**. Это действие позволяет скачивать файлы выставления счетов.
5. Выберите **ресурсы**.
6. Выберите **контейнер — добавить ARN**.
7. В поле **имя контейнера**введите контейнер, используемый для хранения файлов.
8. Выберите **объект — добавить ARN**.
9. В поле **имя контейнера**введите контейнер, используемый для хранения файлов.
10. В списке **имя объекта**выберите **любой**.
11. Выберите **добавить дополнительные разрешения**.

Разрешение на настройку для обозревателя затрат:

1. Выберите **выбрать службу**.
2. Введите **служба обозревателя затрат**.
3. Выберите **все действия службы обозревателя затрат (CE:\*)** . Это действие проверяет правильность сбора.
4. Выберите **добавить дополнительные разрешения**.

Добавление разрешения для AWS организаций:

1. Введите **Организации**.
2. Выберите > **список**уровень > доступа**листаккаунтс**. Это действие получает имена учетных записей.
3. В поле **Политика проверки**введите имя новой политики. Убедитесь, что введены правильные сведения, а затем нажмите кнопку **создать политику**.
4. Вернитесь на предыдущую вкладку и обновите веб-страницу браузера. На панели поиска найдите новую политику.
5. По завершении выберите **Next: Review** (Далее: проверка).
6. Введите имя для новой роли. Убедитесь, что введены правильные сведения, а затем нажмите кнопку **создать роль**.

    Обратите внимание на роль ARN и внешний идентификатор, который использовался на предыдущих шагах при создании роли. Они будут использоваться позже при настройке соединителя управления затратами Azure.

Формат JSON должен выглядеть следующим образом. Замените _bucketname_ именем контейнера S3.

```JSON
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
"organizations:ListAccounts",
            "ce:*",
            "cur:DescribeReportDefinitions"
            ],
            "Resource": "*"
        },
        {
            "Sid": "VisualEditor1",
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::bucketname",
                "arn:aws:s3:::bucketname/*"
            ]
        }
    ]
}
```

## <a name="set-up-a-new-aws-connector-in-azure"></a>Настройка нового соединителя AWS в Azure

Используйте следующие сведения, чтобы создать соединитель AWS и начать мониторинг затрат на AWS:

1. Войдите на [портале Azure](https://portal.azure.com).
2. Последовательно выберите **Управление затратами и** > **Управление затратами**на выставление счетов.
3. В разделе **Параметры**выберите **облачные соединители (Предварительная версия)** .  
    ![Пример, в котором показан параметр Cloud Connectors (](./media/aws-integration-setup-configure/cloud-connectors-preview01.png)Предварительная версия)).
4. Выберите **+ Добавить** в верхней части страницы, чтобы создать соединитель.
5. На странице **Создание СОЕДИНИТЕЛЯ AWS** в поле отображаемое **имя**введите имя соединителя.  
    ![Пример страницы для создания соединителя AWS](./media/aws-integration-setup-configure/create-aws-connector01.png)
6. При необходимости выберите группу управления по умолчанию. Будут сохранены все обнаруженные связанные учетные записи. Его можно настроить позже.
7. В разделе **выставление счетов** установите флажок автоматически платить за **1% при общей доступности** , если требуется обеспечить непрерывную работу по истечении срока действия предварительной версии. Если выбран параметр автоматически, необходимо выбрать подписку на выставление счетов.
8. В поле **ARN роли**введите значение, которое использовалось при настройке роли в AWS.
9. В поле **External ID (внешний идентификатор**) введите значение, которое использовалось при настройке роли в AWS.
10. В поле **имя отчета**введите имя, созданное в AWS.
11. Нажмите кнопку **Далее** , а затем выберите **создать**.

Для отображения новых областей AWS, консолидированной учетной записи AWS, AWS связанных учетных записей и данных о затратах может потребоваться несколько часов.

После создания соединителя рекомендуется назначить ему контроль доступа. Пользователям назначаются разрешения для вновь обнаруженных областей: Консолидированная учетная запись AWS и связанные учетные записи AWS. Пользователь, создающий соединитель, является владельцем соединителя, Объединенной учетной записью и всеми связанными учетными записями.

При назначении разрешений соединителя пользователям после обнаружения не назначаются разрешения для существующих областей AWS. Вместо этого разрешения назначаются только новым связанным учетным записям.

## <a name="take-additional-steps"></a>Выполнить дополнительные действия

- [Настройте группы управления](../governance/management-groups/index.md#initial-setup-of-management-groups), если это еще не сделано.
- Убедитесь, что в средство выбора области добавлены новые области. Выберите **Обновить** , чтобы просмотреть последние данные.
- На странице **соединители облака** выберите соединитель и выберите пункт **Переход к учетной записи выставления счетов** , чтобы назначить связанную учетную запись группам управления.

## <a name="manage-cloud-connectors"></a>Управление соединителями облака

При выборе соединителя на странице " **облачные соединители** " можно:

- Выберите **Перейти к учетной записи выставления счетов** , чтобы просмотреть сведения о консолидированной учетной записи AWS.
- Выберите **Управление доступом** , чтобы управлять назначением ролей для соединителя.
- Выберите **изменить** , чтобы обновить соединитель. Вы не можете изменить номер учетной записи AWS, так как он отображается в роли ARN. Но можно создать новый соединитель.
- Выберите **проверить** , чтобы повторно запустить проверочный тест, чтобы Управление затратами могли получать данные с помощью параметров соединителя.

![Пример списка созданных соединителей AWS](./media/aws-integration-setup-configure/list-aws-connectors.png)

## <a name="set-up-azure-management-groups"></a>Настройка групп управления Azure

Разместите подписки Azure и связанные учетные записи AWS в одной группе управления, чтобы создать единое расположение, где можно просмотреть сведения о поставщике в разных облаках. Если вы еще не настроили среду Azure с помощью групп управления, см. статью [Начальная настройка групп управления](../governance/management-groups/index.md#initial-setup-of-management-groups).

Если вы хотите разделить затраты, можно создать группу управления, которая содержит только AWS связанные учетные записи.

## <a name="set-up-an-aws-consolidated-account"></a>Настройка Объединенной учетной записи AWS

Консолидированная учетная запись AWS сочетает выставление счетов и оплату для нескольких учетных записей AWS. Она также выступает в качестве связанной учетной записи AWS.

![Пример сведений для консолидированной учетной записи AWS](./media/aws-integration-setup-configure/aws-consolidated-account01.png)

На странице можно выполнить следующие действия.

- Выберите **Обновить** , чтобы выполнить групповое обновление связи связанных учетных записей AWS с группой управления.
- Выберите **Управление доступом** , чтобы задать назначение роли для области.

### <a name="permissions-for-an-aws-consolidated-account"></a>Разрешения для консолидированной учетной записи AWS

По умолчанию разрешения для Объединенной учетной записи AWS задаются при создании учетной записи на основе разрешений соединителя AWS. Создатель соединителя является владельцем.

Управление уровнем доступа осуществляется с помощью страницы **уровень доступа** в консолидированной учетной записи AWS. Однако связанные учетные записи AWS не наследуют разрешения на консолидированную учетную запись AWS.

## <a name="set-up-an-aws-linked-account"></a>Настройка связанной учетной записи AWS

Связанная учетная запись AWS — это место, где создаются ресурсы AWS и управляются ими. Связанная учетная запись также выступает в качестве границы безопасности.

На этой странице можно выполнить следующие действия.

- Выберите **Обновить** , чтобы обновить связь связанной учетной записи AWS с группой управления.
- Выберите **Управление доступом** , чтобы задать назначение роли для области.

![Пример страницы связанной учетной записи AWS](./media/aws-integration-setup-configure/aws-linked-account01.png)

### <a name="permissions-for-an-aws-linked-account"></a>Разрешения для связанной учетной записи AWS

По умолчанию разрешения для связанной учетной записи AWS задаются при создании на основе разрешений соединителя AWS. Создатель соединителя является владельцем. Управление уровнем доступа осуществляется с помощью страницы **уровень доступа** связанной учетной записи AWS. Связанные учетные записи AWS не наследуют разрешения от консолидированной учетной записи AWS.

AWS связанные учетные записи всегда наследуют разрешения от группы управления, к которой они принадлежат.

## <a name="next-steps"></a>Следующие шаги

- Теперь, после настройки и настройки AWS интеграции отчетов о затратах и использовании, продолжайте [управлять затратами и использованием AWS](aws-integration-manage.md).
- Если вы не знакомы с анализом затрат, ознакомьтесь со статьей [изучение и анализ затрат с помощью](quick-acm-cost-analysis.md) краткого руководства по анализу затрат.
- Если вы не знакомы с бюджетами в Azure, см. статью [создание бюджетов Azure и управление ими](tutorial-acm-create-budgets.md).
