---
title: Поддержка службы подготовки устройств Интернета вещей Azure (DPS) для виртуальных сетей
description: Использование шаблона подключения к виртуальным сетям с помощью службы подготовки устройств Azure IoT (DPS)
services: iot-hub
author: wesmc7777
ms.service: iot-dps
ms.topic: conceptual
ms.date: 06/30/2020
ms.author: wesmc
ms.openlocfilehash: f1409a931195d236b2729e629e4603c606137593
ms.sourcegitcommit: cd9754373576d6767c06baccfd500ae88ea733e4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/20/2020
ms.locfileid: "94959787"
---
# <a name="azure-iot-hub-device-provisioning-service-dps-support-for-virtual-networks"></a>Поддержка службы подготовки устройств для центра Интернета вещей Azure (DPS) для виртуальных сетей

В этой статье представлен шаблон подключения к виртуальной сети (VNET) для устройств IoT, которые подключаются к центрам Интернета вещей с помощью DPS. Этот шаблон обеспечивает частное подключение между устройствами, DP и центром Интернета вещей в виртуальной сети Azure, принадлежащей заказчику. 

В большинстве случаев, когда служба DPS настроена для виртуальной сети, центр Интернета вещей также будет настроен в той же виртуальной сети. Дополнительные сведения о поддержке виртуальной сети и конфигурации для центров Интернета вещей см. в статье [Поддержка виртуальных сетей центра Интернета вещей](../iot-hub/virtual-network-support.md).



## <a name="introduction"></a>Введение

По умолчанию имена узлов DPS сопоставляются с общедоступной конечной точкой с общедоступным IP-адресом через Интернет. Эта общедоступная конечная точка видна всем клиентам. Доступ к общедоступной конечной точке можно выполнять с помощью устройств Интернета вещей в глобальных сетях, а также в локальных сетях.

По нескольким причинам клиентам может потребоваться ограничить возможности подключения к ресурсам Azure, например DPS. Некоторые из причин:

* Предотвращение раскрытия подключений через общедоступный Интернет. Раскрытие можно сократить, поставляя дополнительные уровни безопасности через изоляцию на уровне сети для центра Интернета вещей и ресурсов DP.

* Включение частного подключения от локальных сетевых ресурсов, гарантирующих передачу данных и трафика непосредственно в магистральную сеть Azure.

* Предотвращение атак, связанных с кражей данных из конфиденциальных локальных сетей. 

* Соблюдение шаблонов подключения, заданных на уровне Azure, с помощью [частных конечных точек](../private-link/private-endpoint-overview.md).

Распространенные подходы к ограничению подключения включают [правила IP-фильтра DPS](./iot-dps-ip-filtering.md) и виртуальные сети (vnet) с [частными конечными точками](../private-link/private-endpoint-overview.md). Цель этой статьи — описать подход к виртуальной сети для DPS с помощью частных конечных точек. 

Устройства, которые работают в локальных сетях, могут использовать [виртуальную частную сеть (VPN)](../vpn-gateway/vpn-gateway-about-vpngateways.md) или частный пиринг [ExpressRoute](https://azure.microsoft.com/services/expressroute/) для подключения к виртуальной сети в Azure и доступа к ресурсам DP через частные конечные точки. 

Частная конечная точка — это частный IP-адрес, выделенный внутри виртуальной сети клиента, с которой доступен ресурс Azure. Имея закрытую конечную точку для ресурса DPS, вы сможете разрешить устройствам, которые будут работать внутри виртуальной сети, запрашивать подготовку ресурса DPS, не разрешая трафик к общедоступной конечной точке.


## <a name="prerequisites"></a>Предварительные требования

Прежде чем продолжать, убедитесь, что выполняются следующие необходимые условия.

* Ваш ресурс DPS уже создан и связан с центрами Интернета вещей. Рекомендации по настройке нового ресурса DPS см. [в разделе Настройка службы подготовки устройств для центра Интернета вещей с помощью портал Azure](./quick-setup-auto-provision.md)

* Вы подготовили ВИРТУАЛЬную сеть Azure к подсети, в которой будет создана частная конечная точка. Дополнительные сведения см. в разделе [Создание виртуальной сети с помощью Azure CLI](../virtual-network/quick-create-cli.md).

* Для устройств, которые работают в локальных сетях, настройте частный пиринг [виртуальной частной сети (VPN)](../vpn-gateway/vpn-gateway-about-vpngateways.md) или частного пиринга [ExpressRoute](https://azure.microsoft.com/services/expressroute/) в виртуальной сети Azure.

## <a name="private-endpoint-limitations"></a>Ограничения частной конечной точки

Обратите внимание на следующие текущие ограничения для DPS при использовании частных конечных точек:

* Частные конечные точки не будут работать со службой DPS, если ресурс DPS и связанный концентратор находятся в разных облаках. Например, [Azure для государственных организаций и Global Azure](../azure-government/documentation-government-welcome.md).

* В настоящее время [пользовательские политики распределения с функциями Azure](how-to-use-custom-allocation-policies.md) для DPS не будут работать, если функция Azure заблокирована в виртуальной сети и закрытых конечных точках. 

* Текущая поддержка виртуальной сети DPS предназначена только для данных, входящих в службу DPS. Исходящие данные, которые являются трафиком из DPS в центр Интернета вещей, используют внутренний механизм "служба-служба", а не Выделенная виртуальная сеть. Поддержка полного блокировки исходящих данных на основе виртуальной сети между DPS и центром Интернета вещей в настоящее время недоступна.

* Политика выделения минимальной задержки используется для назначения устройства в центре Интернета вещей с наименьшей задержкой. Эта политика распределения не является надежной в среде виртуальной сети. 

## <a name="set-up-a-private-endpoint"></a>Настройка частной конечной точки

Чтобы настроить частную конечную точку, выполните следующие действия.

1. В [портал Azure](https://portal.azure.com/)Откройте ресурс DPS и перейдите на вкладку **сети** . Щелкните **частные подключения конечной точки** и **+ Частная конечная точка**.

    ![Добавление новой закрытой конечной точки для DPS](./media/virtual-network-support/networking-tab-add-private-endpoint.png)

2. На странице _создание основ закрытой конечной точки_ введите сведения, указанные в таблице ниже.

    ![Основные сведения о создании частных конечных точек](./media/virtual-network-support/create-private-endpoint-basics.png)

    | Поле | Значение |
    | :---- | :-----|
    | **Подписка** | Выберите нужную подписку Azure, которая будет содержать закрытую конечную точку.  |
    | **Группа ресурсов** | Выберите или создайте группу ресурсов для хранения частной конечной точки |
    | **Имя**       | Введите имя частной конечной точки |
    | **Регион**     | Выбранный регион должен совпадать с регионом, содержащим виртуальную сеть, но не обязательно должен совпадать с ресурсом DPS. |

    Нажмите кнопку **Далее: ресурс** , чтобы настроить ресурс, на который будет указываться частная конечная точка.

3. На странице _Создание ресурса частной конечной точки_ введите сведения, указанные в таблице ниже.

    ![Создание ресурса частной конечной точки](./media/virtual-network-support/create-private-endpoint-resource.png)

    | Поле | Значение |
    | :---- | :-----|
    | **Подписка**        | Выберите подписку Azure, которая содержит ресурс DPS, на который будет указывать ваша частная конечная точка.  |
    | **Тип ресурса**       | Выберите **Microsoft. Devices/iothubs**. |
    | **Ресурс**            | Выберите ресурс DPS, к которому будет сопоставляться частная конечная точка. |
    | **Целевой подресурс** | Выберите **DPS**. |

    > [!TIP]
    > Сведения о **подключении к ресурсу Azure по идентификатору ресурса или параметру псевдонима** приведены в разделе [запрос частной конечной точки](#request-a-private-endpoint) в этой статье.


    Нажмите кнопку **Далее: Конфигурация** , чтобы настроить виртуальную сеть для закрытой конечной точки.

4. На странице _Создание конфигурации частной конечной точки_ выберите виртуальную сеть и подсеть для создания частной конечной точки в.
 
    Нажмите кнопку **Далее: Теги** и при необходимости укажите теги для ресурса.

    ![Настройка частной конечной точки](./media/virtual-network-support/create-private-endpoint-configuration.png)

6. Щелкните **Просмотр + создать** , а затем **создать** , чтобы создать ресурс частной конечной точки.


## <a name="request-a-private-endpoint"></a>Запрос частной конечной точки

Закрытую конечную точку можно запросить по ИДЕНТИФИКАТОРу ресурса в ресурсе DPS. Чтобы сделать этот запрос, необходимо, чтобы владелец ресурса предоставил вам идентификатор ресурса. 

1. Идентификатор ресурса указывается на вкладке Свойства для ресурса DPS, как показано ниже.

    ![Вкладка «Свойства DPS»](./media/virtual-network-support/dps-properties.png)

    > [!CAUTION]
    > Имейте в виду, что идентификатор ресурса содержит идентификатор подписки. 

2. Получив идентификатор ресурса, выполните действия, описанные выше в разделе [Настройка частной конечной точки](#set-up-a-private-endpoint) на шаге 3 на странице _Создание ресурса частной конечной точки_ . Щелкните **подключиться к ресурсу Azure по идентификатору или псевдониму ресурса** и введите сведения в следующей таблице. 

    | Поле | Значение |
    | :---- | :-----|
    | **Идентификатор или псевдоним ресурса** | Введите идентификатор ресурса для ресурса DPS. |
    | **Целевой подресурс** | Введите **DPS** |
    | **Сообщение запроса** | Введите сообщение запроса для владельца ресурса DPS.<br>Например, <br>`Please approve this new private endpoint`<br>`for IoT devices in site 23 to access this DPS instance`  |

    Нажмите кнопку **Далее: Конфигурация** , чтобы настроить виртуальную сеть для закрытой конечной точки.

3. На странице _Создание конфигурации частной конечной точки_ выберите виртуальную сеть и подсеть для создания частной конечной точки в.
 
    Нажмите кнопку **Далее: Теги** и при необходимости укажите теги для ресурса.

4. Щелкните **Просмотр + создать** , а затем **создать** , чтобы создать запрос на закрытую конечную точку.

5. Владелец DPS увидит запрос на закрытую конечную точку в списке **подключений к частным конечным точкам** на вкладке Сеть диагностики. На этой странице владелец может **утвердить** или **отклонить** запрос на закрытую конечную точку, как показано ниже.

    ![Утверждение DPS](./media/virtual-network-support/approve-dps-private-endpoint.png)


## <a name="pricing-private-endpoints"></a>Частные конечные точки ценообразования

Дополнительные сведения о ценах см. на [странице цен на службу "Приватный канал" Azure](https://azure.microsoft.com/pricing/details/private-link).



## <a name="next-steps"></a>Следующие шаги

Воспользуйтесь приведенными ниже ссылками, чтобы узнать больше о функциях безопасности DPS:

* [Безопасность](./concepts-service.md#attestation-mechanism)
* [Поддержка TLS 1,2](tls-support.md)