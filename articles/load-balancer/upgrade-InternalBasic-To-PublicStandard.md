---
title: Обновление с базового общедоступного до уровня Standard Public-Azure Load Balancer
description: В этой статье показано, как обновить внутренний Load Balancer Azure Basic до уровня "Стандартный" общедоступного Load Balancer
services: load-balancer
author: irenehua
ms.service: load-balancer
ms.topic: how-to
ms.date: 01/23/2020
ms.author: irenehua
ms.openlocfilehash: 6b4d2a5cf441eb702bc33fc862fec9cc28a998b5
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "84809352"
---
# <a name="upgrade-azure-internal-load-balancer---outbound-connection-required"></a>Обновление внутренней Load Balancer Azure — требуется исходящее подключение
[Azure Load Balancer (цен. Категория "Стандартный")](load-balancer-overview.md) предлагает широкий набор функций и высокий уровень доступности через избыточность зоны. Дополнительные сведения о Load Balancer SKU см. в разделе [Таблица сравнения](https://docs.microsoft.com/azure/load-balancer/skus#skus). Так как стандартный внутренний Load Balancer не предоставляет исходящего подключения, мы предоставляем решение для создания стандартного общедоступного Load Balancer.

Обновление состоит из четырех этапов.

1. Перенос конфигурации в стандартные общедоступные Load Balancer
2. Добавление виртуальных машин в серверные пулы стандартных общедоступных Load Balancer
3. Настройка правил NSG для подсетей и виртуальных машин, которые следует отменять в Интернете

В этой статье рассматривается миграция конфигурации. Добавление виртуальных машин в серверные пулы может зависеть от конкретной среды. Однако некоторые общие рекомендации [предоставляются](#add-vms-to-backend-pools-of-standard-load-balancer)на высоком уровне.

## <a name="upgrade-overview"></a>Общие сведения об обновлении

Доступен сценарий Azure PowerShell, который выполняет следующие действия:

* Создание общедоступного Load Balancer SKU в группе ресурсов и указанном расположении.
* Без проблем копирует конфигурации базового SKU уровня "базовый" Load Balancer на новую общедоступную Load Balancer создания Standard.
* Создает правило исходящего трафика, которое разрешает исходящие подключения.

### <a name="caveatslimitations"></a>кавеатс\лимитатионс

* Скрипт поддерживает внутреннее Load Balancer обновление, когда требуется исходящее подключение. Если для какой-либо виртуальной машины не требуется исходящее подключение, используйте [эту страницу](upgrade-basicInternal-standard.md) для получения рекомендаций.
* Load Balancer (цен. категория "Стандартный") имеет новый общедоступный адрес. Невозможно переместить IP-адреса, связанные с существующим базовым внутренним Load Balancer, в стандартные общедоступные Load Balancer, так как они имеют разные номера SKU.
* Если стандартный балансировщик нагрузки создан в другом регионе, вы не сможете связать существующие виртуальные машины в старом регионе с вновь созданной Load Balancer (цен. категория "Стандартный"). Чтобы обойти это ограничение, обязательно создайте новую виртуальную машину в новом регионе.
* Если у Load Balancer нет внешней IP-конфигурации или серверного пула, то, скорее всего, будет обнаружена ошибка, которая вызвала бы выполнение скрипта.  Убедитесь, что они не пусты.

## <a name="download-the-script"></a>Скачивание скрипта

Скачайте скрипт миграции из [коллекция PowerShell](https://www.powershellgallery.com/packages/AzureLBUpgrade/2.0).
## <a name="use-the-script"></a>Использование скрипта

В зависимости от настроек и настроек локальной среды PowerShell существует два варианта.

* Если вы не установили модули Azure az или не хотите удалять модули Azure AZ, лучшим вариантом будет использование `Install-Script` параметра для запуска сценария.
* Если вам нужно разместить модули Azure AZ, лучше скачать сценарий и запустить его напрямую.

Чтобы определить, установлены ли модули Azure AZ, запустите `Get-InstalledModule -Name az` . Если вы не видите ни одного установленного модуля AZ, то можете использовать `Install-Script` метод.

### <a name="install-using-the-install-script-method"></a>Установка с помощью метода Install-Script

Чтобы использовать этот параметр, на компьютере не должны быть установлены модули Azure AZ. Если они установлены, следующая команда выводит сообщение об ошибке. Можно либо удалить модули Azure AZ, либо воспользоваться другим параметром, чтобы скачать скрипт вручную и запустить его.
  
Выполните скрипт с помощью следующей команды:

`Install-Script -Name AzurePublicLBUpgrade`

Эта команда также устанавливает необходимые модули AZ.  

### <a name="install-using-the-script-directly"></a>Установка непосредственно с помощью скрипта

Если у вас установлены некоторые модули Azure AZ и их невозможно удалить (или не хотите удалять их), можно вручную скачать скрипт, используя вкладку **Загрузка вручную** в ссылке Загрузить скрипт. Скрипт загружается как необработанный файл nupkg. Сведения об установке скрипта из этого файла nupkg см. в разделе [Загрузка пакета вручную](/powershell/scripting/gallery/how-to/working-with-packages/manual-download).

Выполните следующее, чтобы запустить этот сценарий.

1. Используйте `Connect-AzAccount` для подключения к Azure.

1. Используйте `Import-Module Az` для импорта модулей AZ.

1. Проверьте обязательные параметры:

   * **олдргнаме: [строка]: обязательно** — это группа ресурсов для существующих базовых Load Balancer, которые требуется обновить. Чтобы найти это строковое значение, перейдите к портал Azure, выберите основной источник Load Balancer и щелкните **Обзор** подсистемы балансировки нагрузки. Группа ресурсов находится на этой странице.
   * **олдлбнаме: [строка]: обязательно** — это имя существующего балансировщика базовой подсистемы, которую требуется обновить. 
   * **невргнаме: [строка]: обязательно** — это группа ресурсов, в которой будет создана Load Balancer (цен. Категория "Стандартный"). Это может быть новая группа ресурсов или существующая. При выборе существующей группы ресурсов Обратите внимание, что имя Load Balancer должно быть уникальным в пределах группы ресурсов. 
   * **newlocation: [строка]: required** — расположение, в котором будет создана Load Balancer (цен. Категория "Стандартный"). Мы рекомендуем наследовать то же расположение выбранного базового Load Balancer Load Balancer (цен. категория "Стандартный") для лучшего сопоставления с другими существующими ресурсами.
   * **невлбнаме: [строка]: required** — это имя создаваемого Load Balancer (цен. Категория "Стандартный").
1. Запустите скрипт, используя соответствующие параметры. Для завершения может потребоваться от 5 до семи минут.

    **Пример**

   ```azurepowershell
   AzurePublicLBUpgrade.ps1 -oldRgName "test_publicUpgrade_rg" -oldLBName "LBForPublic" -newrgName "test_userInput3_rg" -newlocation "centralus" -newLbName "LBForUpgrade"
   ```

### <a name="add-vms-to-backend-pools-of-standard-load-balancer"></a>Добавление виртуальных машин в серверные пулы Load Balancer (цен. категория "Стандартный")

Сначала убедитесь, что сценарий успешно создал новую стандартную общедоступную Load Balancer с точной конфигурацией, перенесенной из базового общедоступного Load Balancer. Это можно проверить в портал Azure.

Не забудьте отправить небольшой объем трафика через Load Balancer (цен. категория "Стандартный") в качестве ручного теста.
  
Ниже приведено несколько сценариев добавления виртуальных машин в серверные пулы вновь созданных стандартных общедоступных Load Balancer, а также рекомендации по каждому из них.

* **Перемещение существующих виртуальных машин из серверных пулов старых базовых Общедоступных Load Balancer в серверные пулы вновь созданных стандартных Общедоступных Load Balancer**.
    1. Для выполнения задач в этом кратком руководстве войдите на [портал Azure](https://portal.azure.com).
 
    1. Выберите **все ресурсы** в меню слева, а затем выберите **только что созданную Load Balancer (цен. Категория "Стандартный")** из списка ресурсов.
   
    1. В разделе **Параметры** выберите **Внутренние пулы**.
   
    1. Выберите внутренний пул, соответствующий внутреннему пулу базового Load Balancer, выберите следующее значение: 
      - **Виртуальная машина**: раскрывающийся список и выберите виртуальные машины из соответствующего серверного пула базовых Load Balancer.
    1. Нажмите кнопку **Сохранить**.
    >[!NOTE]
    >Для виртуальных машин, имеющих общедоступные IP-адреса, необходимо сначала создать стандартные, но не гарантируют, что IP-адрес не гарантируется. Отменяйте связь между виртуальными машинами и свяжите их с новыми стандартными IP-адресами. Затем вы сможете выполнить инструкции по добавлению виртуальных машин в серверный пул Load Balancer (цен. категория "Стандартный"). 

* **Создание новых виртуальных машин для добавления в серверные пулы вновь созданного стандартного Общедоступного Load Balancer**.
    * Дополнительные инструкции о том, как создать виртуальную машину и связать ее с Load Balancer (цен. категория "Стандартный"), можно найти [здесь](https://docs.microsoft.com/azure/load-balancer/quickstart-load-balancer-standard-public-portal#create-virtual-machines).

### <a name="create-an-outbound-rule-for-outbound-connection"></a>Создание правила исходящего трафика для исходящего подключения

Следуйте [инструкциям](https://docs.microsoft.com/azure/load-balancer/configure-load-balancer-outbound-portal#create-outbound-rule-configuration) , чтобы создать правило исходящего трафика, чтобы можно было
* Определение исходящего NAT с нуля.
* Масштабирование и Настройка поведения существующего исходящего NAT.

### <a name="create-nsg-rules-for-vms-which-to-refrain-communication-from-or-to-the-internet"></a>Создание правил NSG для виртуальных машин, которые отменяют связь между или Интернетом
Если вы хотите отдержать Интернет к виртуальным машинам, вы можете создать [правило NSG](https://docs.microsoft.com/azure/virtual-network/manage-network-security-group) для сетевого интерфейса виртуальных машин.

## <a name="common-questions"></a>Часто задаваемые вопросы

### <a name="are-there-any-limitations-with-the-azure-powershell-script-to-migrate-the-configuration-from-v1-to-v2"></a>Существуют ли какие либо ограничения в сценарии Azure PowerShell для переноса конфигурации с версии v1 на версию 2?

Да. См. раздел [предостережения/ограничения](#caveatslimitations).

### <a name="does-the-azure-powershell-script-also-switch-over-the-traffic-from-my-basic-load-balancer-to-the-newly-created-standard-load-balancer"></a>Также будет ли сценарий Azure PowerShell переключать трафик с базового Load Balancer на только что созданный Load Balancer (цен. категория "Стандартный")?

Нет. Сценарий Azure PowerShell только переносит конфигурацию. Фактический перенос трафика несет ответственность за ваш контроль.

### <a name="i-ran-into-some-issues-with-using-this-script-how-can-i-get-help"></a>При использовании этого сценария возникли проблемы. Как получить помощь?
  
Вы можете отправить сообщение электронной почты slbupgradesupport@microsoft.com , открыть обращение в службу поддержки Azure или выполнить оба действия.

## <a name="next-steps"></a>Дальнейшие шаги

[Дополнительные сведения о Load Balancer (цен. категория "Стандартный")](load-balancer-overview.md)
