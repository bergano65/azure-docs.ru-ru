---
title: Руководство. Создание внутренней подсистемы балансировки нагрузки на портале Azure
titleSuffix: Azure Load Balancer
description: В этом руководстве показано, как создать внутреннюю подсистему балансировки нагрузки уровня "Базовый" с помощью портала Azure.
services: load-balancer
documentationcenter: na
author: asudbring
manager: twooley
Customer intent: As an IT administrator, I want to create a load balancer that load balances incoming internal traffic to virtual machines within a specific zone in a region.
ms.service: load-balancer
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/27/2019
ms.author: allensu
ms.custom: seodec18
ms.openlocfilehash: 1b9d943f540a0132abc6a70eba888aa5f8f46093
ms.sourcegitcommit: d6b68b907e5158b451239e4c09bb55eccb5fef89
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/20/2019
ms.locfileid: "74225222"
---
# <a name="tutorial-balance-internal-traffic-load-with-a-basic-load-balancer-in-the-azure-portal"></a>Руководство. Балансировка нагрузки внутреннего трафика с помощью подсистемы балансировки нагрузки уровня "Базовый" на портале Azure

Балансировка нагрузки обеспечивает более высокий уровень доступности и масштабирования за счет распределения входящих запросов между виртуальными машинами. Вы можете использовать портал Azure для создания подсистемы балансировки нагрузки уровня "Базовый" и балансировки внутреннего трафика между виртуальными машинами. В этом руководстве показано, как создать и настроить внутреннюю подсистему балансировки нагрузки, внутренние серверы и сетевые ресурсы ценовой категории "Базовый".

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу. 

При желании эти действия можно выполнить с помощью [Azure CLI](load-balancer-get-started-ilb-arm-cli.md) или [Azure PowerShell](load-balancer-get-started-ilb-arm-ps.md) вместо портала.

Чтобы выполнить действия с помощью этого руководства, войдите на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com).

## <a name="create-a-vnet-back-end-servers-and-a-test-vm"></a>Создание виртуальной сети, внутренних серверов и тестовой виртуальной машины

Сначала создайте виртуальную сеть. В виртуальной сети создайте две виртуальные машины, которые будут использоваться для серверного пула вашей подсистемы балансировки нагрузки уровня "Базовый", и третью виртуальную машину, которая будет использоваться для тестирования подсистемы балансировки нагрузки. 

### <a name="create-a-virtual-network"></a>Создание виртуальной сети

1. Вверху с левой стороны портала выберите **Создать ресурс** > **Сети** > **Виртуальная сеть**.
   
1. На панели **Создание виртуальной сети** введите или выберите следующие значения:
   
   - **Имя**. Введите *MyVNet*.
   - **Группа ресурсов**: Выберите **Создать новую**, а затем введите *MyResourceGroupLB* и нажмите кнопку **ОК**. 
   - **Подсеть** > **Имя**. Введите *myBackendSubnet*.
   
1. Нажмите кнопку **Создать**.

   ![Создание виртуальной сети](./media/tutorial-load-balancer-basic-internal-portal/2-load-balancer-virtual-network.png)

### <a name="create-virtual-machines"></a>Создание виртуальных машин

1. В верхней левой части портала выберите **Создать ресурс** > **Вычисления** > **Windows Server 2016 Datacenter**. 
   
1. В разделе **Создание виртуальной машины** введите или выберите следующие значения на вкладке **Основные сведения**:
   - **Подписка** > **Группа ресурсов**. В раскрывающемся списке выберите **MyResourceGroupLB**.
   - **Сведения об экземпляре** > **Имя виртуальной машины**. Введите *MyVM1*.
   - **Сведения об экземпляре** > **Параметры доступности**. 
     1. Раскройте список и выберите **Группа доступности**. 
     2. Выберите **Создать новый**, введите *MyAvailabilitySet* и нажмите кнопку **ОК**.
   
1. Выберите вкладку **Сеть** или **Далее: диски**, затем **Далее: сеть**. 
   
   Выберите следующее:
   - **Виртуальная сеть**. **MyVNet**
   - **Подсеть**. **MyBackendSubnet**.
   
   В разделе **Группа безопасности сети**:
   1. Нажмите кнопку **Advanced** (Дополнительно). 
   1. Раскройте список **Настроить группу безопасности сети** и выберите **Отсутствует**. 
   
1. Выберите вкладку **Управление** или **Далее** > **Управление**. В разделе **Мониторинг** задайте **Выкл.** для параметра **Диагностика загрузки**.
   
1. Выберите **Review + create** (Просмотреть и создать).
   
1. Проверьте параметры, а затем нажмите кнопку **Создать**. 

1. Выполните действия, чтобы создать вторую виртуальную машину с именем *MyVM2* с такими же остальными параметрами, как у MyVM1. 

1. Выполните действия повторно, чтобы создать третью виртуальную машину с именем *MyTestVM*. 

## <a name="create-a-basic-load-balancer"></a>Создание подсистемы балансировки нагрузки уровня "Базовый"

Создайте внутреннюю подсистему балансировки нагрузки уровня "Базовый" с помощью портала. Имя и IP-адрес, созданный вами, автоматически настроен в качестве внешнего интерфейса подсистемы балансировки нагрузки.

1. На портале вверху слева последовательно выберите **Создать ресурс** > **Сети** > **Load Balancer**.
   
2. На вкладке **Основные сведения** страницы **Создание подсистемы балансировки нагрузки** введите или выберите следующие сведения, примите значения по умолчанию для остальных параметров и нажмите кнопку **Review + create** (Проверить и создать).

    | Параметр                 | Значение                                              |
    | ---                     | ---                                                |
    | Subscription               | Выберите свою подписку.    |    
    | группа ресурсов.         | Выберите **Создать** и введите *MyResourceGroupLB* в текстовом поле.|
    | ИМЯ                   | *myLoadBalancer*                                   |
    | Регион         | Выберите **Западная Европа**.                                        |
    | type          | Выберите **Внутренний**.                                        |
    | SKU           | Выберите **Базовый**.                          |
    | Виртуальная сеть           | Выберите *MyVNet*.                          |    
    | Назначение IP-адресов              | Выберите **Статический**.   |
    | Частный IP-адрес|Введите адрес, который находится в адресном пространстве виртуальной сети и подсети, например *10.3.0.7*.  |

3. На вкладке **Просмотр и создание** щелкните **Создать**. 
   

## <a name="create-basic-load-balancer-resources"></a>Создание ресурсов подсистемы балансировки нагрузки уровня "Базовый"

В этом разделе описано, как настроить параметры подсистемы балансировки нагрузки для серверного пула адресов и пробы работоспособности, а также указать правила подсистемы балансировки нагрузки.

### <a name="create-a-back-end-address-pool"></a>Создание серверного пула адресов

Для распределения трафика между виртуальными машинами подсистема балансировки нагрузки использует серверный пул адресов. Серверный пул адресов содержит IP-адреса виртуальных сетевых интерфейсов (сетевых карт), подключенных к подсистеме балансировки нагрузки. 

**Создание серверного пула адресов, включающего VM1 и VM2:**

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **MyLoadBalancer**.
   
1. В разделе **Параметры** выберите **Серверные пулы**, а затем щелкните **Добавить**.
   
1. На странице **Добавление серверного пула** введите или выберите следующие значения:
   
   - **Имя**. Введите *MyBackendPool*.
   - **Сопоставлено с**. Раскройте список и выберите **Группа доступности**.
   - **Группа доступности**. Выберите **MyAvailabilitySet**.
   
1. Выберите **Add a target network IP configuration** (Добавить целевую IP-конфигурацию сети). 
   1. Добавьте **MyVM1** и **MyVM2** в серверный пул.
   2. После добавления каждого компьютера раскройте список и выберите его **сетевую IP-конфигурацию**. 
   
   >[!NOTE]
   >Не добавляйте **MyTestVM** в пул. 
   
1. Нажмите кнопку **ОК**.
   
   ![Добавление серверного пула адресов](./media/tutorial-load-balancer-basic-internal-portal/3-load-balancer-backend-02.png)
   
1. На странице **Серверные пулы** разверните узел **MyBackendPool** и убедитесь, что там перечислены обе виртуальные машины (**VM1** и **VM2**).

### <a name="create-a-health-probe"></a>Создание пробы работоспособности

Чтобы подсистема балансировки нагрузки могла отслеживать состояние виртуальной машины, необходимо настроить пробу работоспособности. Проба работоспособности динамически добавляет или удаляет виртуальные машины из балансировщика нагрузки на основе их ответа на проверки работоспособности. 

**Создание пробы работоспособности для отслеживания работоспособности виртуальных машин:**

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **MyLoadBalancer**.
   
1. В разделе **Параметры** выберите **Зонды работоспособности**, а затем щелкните **Добавить**.
   
1. На странице **Add a health probe** (Добавление пробы работоспособности) введите или выберите следующие значения:
   
   - **Имя**. Введите *MyHealthProbe*.
   - **Протокол**. В раскрывающемся списке выберите **HTTP**. 
   - **Порт**. Введите *80*. 
   - **Путь**. Примите */* для универсального кода ресурса (URI) по умолчанию. Это значение можно заменить любым другим URI. 
   - **Интервал**. Введите *15*. Интервал — количество секунд между попытками выполнения пробы.
   - **Пороговое значение сбоя**. Введите *2*. Это значение количества последовательных сбоев пробы, которые произойдут, прежде чем виртуальная машина будет считаться неработоспособной.
   
1. Нажмите кнопку **ОК**.
   
   ![Добавление пробы](./media/tutorial-load-balancer-basic-internal-portal/4-load-balancer-probes.png)

### <a name="create-a-load-balancer-rule"></a>Создание правила балансировщика нагрузки

Правило подсистемы балансировки нагрузки определяет режим распределения трафика между виртуальными машинами. Правило определяет интерфейсную конфигурацию IP-адресов для входящего трафика и серверный пул IP-адресов для приема трафика, а также требуемый порт источника и назначения. 

Правило подсистемы балансировки нагрузки с именем **MyLoadBalancerRule** прослушивает порт 80 во внешнем интерфейсе **LoadBalancerFrontEnd**. Это правило перенаправляет трафик к серверному пулу адресов **MyBackendPool** (также на порт 80). 

**Создание правила подсистемы балансировки нагрузки:**

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **MyLoadBalancer**.
   
1. В разделе **Параметры** выберите **Правила балансировки нагрузки**, а затем щелкните **Добавить**.
   
1. На странице **Добавить правило балансировки нагрузки** введите или выберите следующие значения, если они отсутствуют:
   
   - **Имя**. Введите *MyLoadBalancerRule*.
   - **Интерфейсный IP-адрес**. Введите *LoadBalancerFrontEnd*, если этот параметр не указан.
   - **Протокол**. Выберите **TCP**.
   - **Порт**. Введите *80*.
   - **Серверный порт**. Введите *80*.
   - **Серверный пул**. Выберите **MyBackendPool**.
   - **Зонд работоспособности**. Выберите **MyHealthProbe**. 
   
1. Нажмите кнопку **ОК**.
   
   ![Добавление правила подсистемы балансировки нагрузки](./media/tutorial-load-balancer-basic-internal-portal/5-load-balancing-rules.png)

## <a name="test-the-load-balancer"></a>Тестирование подсистемы балансировки нагрузки

Установите Internet Information Services (IIS) на внутренних серверах, а затем с помощью MyTestVM протестируйте подсистему балансировки нагрузки, используя свой частный IP-адрес. Каждая серверная виртуальная машина служит другой версией веб-страницы IIS по умолчанию, на которой можно увидеть, как подсистема балансировки нагрузки распределяет запросы между двумя виртуальными машинами.

На портале на странице **Обзор** в разделе **Частный IP-адрес** найдите IP-адрес **MyLoadBalancer**. Наведите указатель на адрес и выберите значок **Копировать**, чтобы скопировать его. В нашем примере это **10.3.0.7**. 

### <a name="connect-to-the-vms-with-rdp"></a>Подключение к виртуальным машинам по протоколу RDP

Сначала подключитесь к трем виртуальным машинам с помощью удаленного рабочего стола (RDP). 

>[!NOTE]
>По умолчанию на виртуальных машинах уже открыт порт **RDP**, чтобы разрешить доступ к удаленному рабочему столу. 

**Подключение к виртуальной машине с помощью RDP:**

1. На портале в меню слева выберите **Все ресурсы**. В списке ресурсов выберите каждую виртуальную машину в группе ресурсов **MyResourceGroupLB**.
   
1. На странице **Обзор** выберите **Подключиться**, а затем — **Скачать RDP-файл**. 
   
1. Откройте скачанный RDP-файл и выберите **Подключиться**.
   
1. На экране безопасности Windows выберите **More choices** (Дополнительные варианты) и нажмите **Использовать другую учетную запись**. 
   
   Введите имя пользователя и пароль, а затем нажмите кнопку **ОК**.
   
1. Ответьте **Да** для любого запроса сертификата. 
   
   В новом окне откроется рабочий стол виртуальной машины. 

### <a name="install-iis-and-replace-the-default-iis-page-on-the-back-end-vms"></a>Установка служб IIS и замена страницы IIS по умолчанию на серверных виртуальных машинах

На каждом внутреннем сервере с помощью PowerShell установите IIS и замените веб-страницы IIS по умолчанию настроенной страницей.

>[!NOTE]
>Установить службы IIS можно также с помощью **мастера добавления ролей и компонентов** в **диспетчере сервера**. 

**Установка IIS и обновление веб-страницы по умолчанию с помощью PowerShell:**

1. На MyVM1 и MyVM2 запустите **Windows PowerShell** из меню **Пуск**. 

2. Выполните следующие команды, чтобы установить службы IIS и заменить веб-страницу IIS по умолчанию:
   
   ```powershell-interactive
    # Install IIS
      Install-WindowsFeature -name Web-Server -IncludeManagementTools
    
    # Remove default htm file
     remove-item  C:\inetpub\wwwroot\iisstart.htm
    
    #Add custom htm file
     Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from " + $env:computername)
    ```
1. Закройте подключения по протоколу RDP к MyVM1 и MyVM2, выбрав **Отключить**. Не выключайте виртуальные машины.

### <a name="test-the-load-balancer"></a>Тестирование подсистемы балансировки нагрузки

1. На MyTestVM откройте **Internet Explorer** и нажмите кнопку **ОК** в качестве ответа на любой запрос по настройке. 
   
1. Вставьте или введите частный IP-адрес подсистемы балансировки нагрузки (*10.3.0.7*) в адресную строку браузера. 
   
   В браузере появится настроенная страница веб-сервера IIS по умолчанию. Появится сообщение **Привет всем от MyVM1** или **Привет всем от MyVM2**.
   
1. Обновите браузер, чтобы увидеть, как подсистема балансировки нагрузки распределяет трафик между виртуальными машинами. Кроме того, может потребоваться очистить кэш браузера между попытками.

   Иногда отображается страница **MyVM1**, а в других случаях — **MyVM2**, так как подсистема балансировки нагрузки распределяет эти запросы к каждой серверной виртуальной машине. 

   ![Новая страница IIS по умолчанию](./media/tutorial-load-balancer-basic-internal-portal/9-load-balancer-test.png) 
   
## <a name="clean-up-resources"></a>Очистка ресурсов

Чтобы удалить подсистему балансировки нагрузки и все связанные ресурсы, если они больше не нужны, откройте группу ресурсов **MyResourceGroupLB** и выберите **Удалить группу ресурсов**.

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве вы создали внутреннюю подсистему балансировки нагрузки уровня "Базовый". Вы создали и настроили сетевые ресурсы, внутренние серверы, пробу работоспособности и правила для подсистемы балансировки нагрузки. Вы установили службы IIS на серверных виртуальных машинах и с помощью тестовой виртуальной машины протестировали подсистему балансировки нагрузки в браузере. 

Теперь вы можете ознакомиться со сведениями о балансировке нагрузки для виртуальных машин в разных зонах доступности.

> [!div class="nextstepaction"]
> [Распределение нагрузки виртуальных машин в пределах зон доступности](tutorial-load-balancer-standard-public-zone-redundant-portal.md)
