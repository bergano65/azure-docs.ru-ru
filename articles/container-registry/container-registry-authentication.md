---
title: Параметры проверки подлинности в реестре
description: Параметры проверки подлинности для закрытого реестра контейнеров Azure, включая вход с помощью удостоверения Azure Active Directory, использование субъектов-служб и использование необязательных учетных данных администратора.
ms.topic: article
ms.date: 01/30/2020
ms.openlocfilehash: 7c8176d0cdca5d74ed3201071f83ed1181d94b8d
ms.sourcegitcommit: f8d2ae6f91be1ab0bc91ee45c379811905185d07
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2020
ms.locfileid: "89657077"
---
# <a name="authenticate-with-an-azure-container-registry"></a>Аутентификация в реестре контейнеров Azure

Существует несколько способов аутентификации в реестре контейнеров Azure, каждый из которых подходит для одного или нескольких сценариев использования реестра.

Рекомендуется включить проверку подлинности в реестре напрямую через [отдельное имя входа](#individual-login-with-azure-ad), а приложения и управляющие контейнеры могут выполнять автоматическую или бездисплейную проверку подлинности с помощью [субъекта-службы](#service-principal)Azure Active Directory (Azure AD).

## <a name="authentication-options"></a>Параметры проверки подлинности

В следующей таблице перечислены доступные методы проверки подлинности и типичные сценарии. Дополнительные сведения см. в разделе связанное содержимое.

| Метод                               | Процедура проверки подлинности                                           | Сценарии                                                            | RBAC                             | Ограничения                                |
|---------------------------------------|-------------------------------------------------------|---------------------------------------------------------------------|----------------------------------|--------------------------------------------|
| [Индивидуальное удостоверение AD](#individual-login-with-azure-ad)                | `az acr login` в Azure CLI                             | Интерактивные push-уведомления, разработчики, тестировщики                                    | Да                              | Маркер AD должен обновляться каждые 3 часа     |
| [Субъект-служба AD](#service-principal)                  | `docker login`<br/><br/>`az acr login` в Azure CLI<br/><br/> Параметры входа в реестр в API или Инструментарий<br/><br/> [Секретный запрос Kubernetes](container-registry-auth-kubernetes.md)                                           | Автоматическая отправка из конвейера CI/CD<br/><br/> Автоматическое извлечение в Azure или внешние службы  | Да                              | Срок действия пароля SP по умолчанию — 1 год       |                                                           
| [Интеграция с AKS](../aks/cluster-container-registry-integration.md?toc=/azure/container-registry/toc.json&bc=/azure/container-registry/breadcrumb/toc.json)                    | Присоединение реестра при создании или обновлении кластера AKS  | Автоматическое извлечение в кластер AKS                                                  | Нет, только по запросу             | Доступно только в кластере AKS            |
| [Управляемое удостоверение для ресурсов Azure](container-registry-authentication-managed-identity.md)  | `docker login`<br/><br/> `az acr login` в Azure CLI                                       | Автоматическая отправка из конвейера Azure CI/CD<br/><br/> Автоматическое извлечение в службы Azure<br/><br/>   | Да                              | Используйте только службы Azure, которые [поддерживают управляемые удостоверения для ресурсов Azure](../active-directory/managed-identities-azure-resources/services-support-managed-identities.md#azure-services-that-support-managed-identities-for-azure-resources)              |
| [Пользователь с правами администратора](#admin-account)                            | `docker login`                                          | Интерактивное push-уведомление для отдельного разработчика или тестера<br/><br/>Развертывание образа из реестра в службу приложений Azure или служба "экземпляры контейнеров Azure" на портале                      | Нет, всегда вытягивание и принудительный доступ  | Одна учетная запись на реестр, не рекомендуется для нескольких пользователей         |
| [Маркер доступа с областью действия репозитория](container-registry-repository-scoped-permissions.md)               | `docker login`<br/><br/>`az acr login` в Azure CLI   | Интерактивная отправка и извлечение в репозиторий отдельным разработчиком или инженером-тестировщиком<br/><br/> Автоматическая отправка и извлечение в репозитории по отдельным системным или внешним устройствам                  | Да                              | В настоящее время не интегрировано с удостоверением AD  |

## <a name="individual-login-with-azure-ad"></a>Отдельный вход с помощью Azure AD

При непосредственной работе с реестром, например при извлечении изображений из рабочей станции разработки в созданный вами реестр, проверка подлинности выполняется с помощью индивидуального удостоверения Azure. Выполните команду [AZ запись контроля](/cli/azure/acr?view=azure-cli-latest#az-acr-login) доступа в [Azure CLI](/cli/azure/install-azure-cli):

```azurecli
az acr login --name <acrName>
```

При входе с помощью команды `az acr login` интерфейс командной строки использует маркер, созданный при выполнении команды [az login](/cli/azure/reference-index#az-login), чтобы прозрачно выполнить аутентификацию вашего сеанса в реестре. Чтобы завершить поток проверки подлинности, необходимо установить и запустить управляющую программу DOCKER CLI и DOCKER в вашей среде. `az acr login` использует клиент DOCKER для установки маркера Azure Active Directory в `docker.config` файле. После входа таким образом ваши учетные данные сохраняются в кэше, и при последующем выполнении команд `docker` в вашем сеансе не потребуется вводить имя пользователя или пароль.

> [!TIP]
> Также используйте `az acr login` для проверки подлинности отдельного удостоверения, если вы хотите передать артефакты, отличные от образов DOCKER, в реестр, например [артефакты OCI](container-registry-oci-artifacts.md).  

Для доступа к реестру маркер, используемый в, `az acr login` действителен в течение **3 часов**, поэтому рекомендуется всегда выполнять вход в реестр перед выполнением `docker` команды. Если срок действия маркера истекает, его можно обновить его с помощью команды `az acr login`, чтобы повторно пройти аутентификацию. 

Использование `az acr login` с удостоверениями Azure обеспечивает [Управление доступом на основе ролей в Azure (Azure RBAC)](../role-based-access-control/role-assignments-portal.md). В некоторых случаях может потребоваться войти в реестр с собственным удостоверением в Azure AD или настроить другие пользователи Azure с определенными [ролями и разрешениями Azure](container-registry-roles.md). Для сценариев перекрестных служб или для решения задач Рабочей группы или процесса разработки, где вы не хотите управлять отдельным доступом, вы также можете войти в систему с помощью [управляемого удостоверения для ресурсов Azure](container-registry-authentication-managed-identity.md).

### <a name="az-acr-login-with---expose-token"></a>AZ запись контроля доступа с помощью--раскрыть-Token

В некоторых случаях может потребоваться выполнить проверку подлинности, `az acr login` если управляющая программа DOCKER не запущена в вашей среде. Например, может потребоваться выполнить `az acr login` скрипт в Azure Cloud Shell, который предоставляет интерфейс командной строки DOCKER, но не запускает управляющую программу DOCKER.

Для этого сценария сначала выполните команду `az acr login` с `--expose-token` параметром. Этот параметр предоставляет маркер доступа вместо входа через интерфейс командной строки DOCKER.

```azurecli
az acr login --name <acrName> --expose-token
```

Выходные данные отображает маркер доступа, сокращенно:

```console
{
  "accessToken": "eyJhbGciOiJSUzI1NiIs[...]24V7wA",
  "loginServer": "myregistry.azurecr.io"
}
``` 

Затем выполните команду `docker login` , передав `00000000-0000-0000-0000-000000000000` имя пользователя и используя маркер доступа в качестве пароля:

```console
docker login myregistry.azurecr.io --username 00000000-0000-0000-0000-000000000000 --password eyJhbGciOiJSUzI1NiIs[...]24V7wA
```

## <a name="service-principal"></a>Субъект-служба

Если назначить [субъект-службу](../active-directory/develop/app-objects-and-service-principals.md) для реестра, приложение или служба сможет использовать его для автоматической аутентификации. Субъекты-службы позволяют [управлять доступом на основе ролей Azure (Azure RBAC)](../role-based-access-control/role-assignments-portal.md) в реестр, а в реестре можно назначить несколько субъектов-служб. Применение нескольких субъектов-служб позволяет определить разные права доступа для приложений.

Доступные роли для реестра контейнеров включают:

* **AcrPull**: извлечение

* **AcrPush**: извлечение и отправка

* **Владелец**: извлечение, отправка и назначение ролей другим пользователям.

Полный список ролей см. в статье, посвященной [ролям и разрешениям реестра контейнеров Azure](container-registry-roles.md).

Сведения о создании субъекта-службы для проверки подлинности в реестре контейнеров Azure с помощью сценариев CLI см. в статье [Проверка подлинности реестра контейнеров Azure с субъектами-службами](container-registry-auth-service-principal.md).

## <a name="admin-account"></a>Учетная запись администратора

Каждый реестр контейнеров содержит учетную запись администратора, которая отключена по умолчанию. Вы можете включить учетную запись администратора и управлять ее учетными данными на портале Azure или с помощью Azure CLI либо других средств Azure. Учетная запись администратора имеет полные разрешения на доступ к реестру.

В некоторых сценариях для развертывания образа из реестра контейнеров в определенных службах Azure требуется учетная запись администратора. Например, учетная запись администратора необходима при развертывании образа контейнера на портале непосредственно из реестра в [службе "экземпляры контейнеров Azure](../container-instances/container-instances-using-azure-container-registry.md#deploy-with-azure-portal) " или " [веб-приложения Azure для контейнеров](container-registry-tutorial-deploy-app.md)".

> [!IMPORTANT]
> Учетная запись администратора предоставляет доступ к реестру одному пользователю. Она предназначена, главным образом, для тестирования. Не рекомендуется совместно использовать учетные данные учетной записи администратора между несколькими пользователями. Все пользователи, выполняющие аутентификацию с учетной записью администратора, отображаются как один пользователь с возможностью извлечения данных из реестра и отправки данных в него. Изменив или отключив эту учетную запись, вы ограничите доступ к реестру для пользователей, использующих эти учетные данные. Для пользователей и субъектов-служб в сценариях автоматического входа рекомендуется использовать отдельные удостоверения.
>

Учетной записи администратора предоставляются два пароля, каждый из которых можно создать повторно. Благодаря этому вы можете подключаться к реестру, используя один пароль, пока второй создается повторно. Если учетная запись администратора включена, вы можете указать в команде `docker login` имя пользователя и пароль, когда будет предложено выполнить базовую аутентификацию в реестре. Пример:

```
docker login myregistry.azurecr.io 
```

Рекомендации по управлению учетными данными для входа см. в справочнике по командам [DOCKER login](https://docs.docker.com/engine/reference/commandline/login/) .

Чтобы включить учетную запись администратора для существующего реестра, можно использовать параметр `--admin-enabled` в команде [az acr update](/cli/azure/acr?view=azure-cli-latest#az-acr-update) в Azure CLI.

```azurecli
az acr update -n <acrName> --admin-enabled true
```

Чтобы включить учетную запись администратора на портале Azure, перейдите к реестру, выберите **Ключи доступа** в разделе **Параметры**, затем щелкните **Включить** в разделе **Пользователь-администратор**.

![Включение учетной записи администратора на портале Azure][auth-portal-01]

## <a name="next-steps"></a>Дальнейшие действия

* [Отправка первого образа с помощью Azure CLI](container-registry-get-started-azure-cli.md)

<!-- IMAGES -->
[auth-portal-01]: ./media/container-registry-authentication/auth-portal-01.png
