---
title: Обзор Задач ACR
description: Общие сведения о задачах записи контроля доступа — наборе функций в реестре контейнеров Azure, который обеспечивает безопасную автоматическую сборку, управление и исправление образов контейнеров в облаке.
ms.topic: article
ms.date: 01/22/2020
ms.openlocfilehash: 4fda57c1d7c866f2e6f72b04d75e53f91e995baf
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "79087289"
---
# <a name="automate-container-image-builds-and-maintenance-with-acr-tasks"></a>Автоматизация сборки и обслуживание образов контейнеров с помощью задач контроля доступа

Контейнеры предоставляют новые уровни виртуализации, изолируя зависимости приложения и разработчиков от требований в отношении инфраструктуры и эксплуатации. Тем не менее, остается необходимость решить, как управление виртуализацией приложений будет осуществляться в течение жизненного цикла контейнера.

## <a name="what-is-acr-tasks"></a>Что такое "Задачи ACR"?

**Задачи ACR** — это набор компонентов в Реестре контейнеров Azure. Он обеспечивает облачное создание образов контейнеров для [платформ](#image-platforms) , включая Linux, Windows и ARM, а также может автоматизировать [исправление ОС и платформы](#automate-os-and-framework-patching) для контейнеров DOCKER. Задачи записи контроля доступа расширяют цикл разработки "внутренний цикл" до облака с сборками образа контейнера по требованию, но также включают автоматические сборки, активируемые обновлениями исходного кода, обновлениями базового образа контейнера или таймерами. Например, с помощью триггеров обновления базовых образов можно автоматизировать рабочий процесс исправления операционной системы и платформы приложений, сохранив защищенные среды и применяя принципы неизменяемых контейнеров.

## <a name="task-scenarios"></a>Сценарии задач

Задачи записи контроля доступа поддерживают несколько сценариев для создания и обслуживания образов контейнеров и других артефактов. Дополнительные сведения см. в следующих разделах этой статьи.

* **[Быстрая задача](#quick-task)** — сборка и отправка одного образа контейнера в реестр контейнеров по требованию в Azure без необходимости установки локальной подсистемы DOCKER. Выполняйте `docker build` и `docker push` в облаке.
* **Автоматически активируемые задачи** . Включение одного или нескольких *триггеров* для создания образа:
  * **[Триггер при обновлении исходного кода](#trigger-task-on-source-code-update)** 
  * **[Триггер при обновлении базового образа](#automate-os-and-framework-patching)** 
  * **[Активация по расписанию](#schedule-a-task)** 
* **[Многоэтапная задача](#multi-step-tasks)** . Расширьте единое средство сборки и принудительной отправки задач записи контроля доступа с многошаговыми рабочими процессами, основанными на нескольких контейнерах. 

Каждая задача записи контроля доступа имеет связанный [контекст исходного кода](#context-locations) — расположение набора исходных файлов, используемых для построения образа контейнера или другого артефакта. Примеры контекстов включают репозиторий Git или локальную файловую систему.

Задачи также могут использовать преимущества [переменных запуска](container-registry-tasks-reference-yaml.md#run-variables), поэтому можно повторно использовать определения задач и стандартизировать теги для изображений и артефактов.

## <a name="quick-task"></a>Быстрая задача

Цикл разработки "внутреннего цикла" — это итеративный процесс написания кода, сборки и тестирования приложения перед фиксацией в системе управления версиями. Это лишь начало управления жизненным циклом контейнера.

Прежде чем зафиксировать первую строку кода, функция [Быстрая задача](container-registry-tutorial-quick-task.md) службы "Задачи ACR" может обеспечить интегрированный опыт разработки, разгружая сборки образов контейнера в Azure. С помощью быстрых задач можно проверить автоматические определения сборки и перехватывать потенциальные проблемы перед фиксацией кода.

Используя знакомый формат `docker build`, команда [az acr build][az-acr-build] в Azure CLI извлекает [контекст](#context-locations) (набор файлов для сборки), отправляет его в службу "Задачи ACR" и по умолчанию отправляет встроенный образ в его реестр после завершения.

Общие сведения см. в кратком руководстве по [созданию и запуску образа контейнера](container-registry-quickstart-task-cli.md) в реестре контейнеров Azure.  

Служба "Задачи ACR" разработана как примитив жизненного цикла контейнеров. К примеру, интегрируйте службу "Задачи ACR" в решение CI/CD. Выполнив команды [az login][az-login] с [субъектом-службой][az-login-service-principal], решение CI/CD может выдавать команды [az acr build][az-acr-build] для запуска сборок образов.

Узнайте, как использовать быстрые задачи из первого руководства по Задачам ACR: [Руководство. Создание образов контейнера в облаке с помощью службы "Задачи Реестра контейнеров Azure"](container-registry-tutorial-quick-task.md).

> [!TIP]
> Если вы хотите создать и отправить образ непосредственно из исходного кода, без Dockerfile, реестр контейнеров Azure предоставляет команду [AZ Pack Build][az-acr-pack-build] (Предварительная версия). Это средство создает и отправляет образ из исходного кода приложения с помощью [собственного облачного буилдпаккс](https://buildpacks.io/).

## <a name="trigger-task-on-source-code-update"></a>Активировать задачу при обновлении исходного кода

Активация сборки образа контейнера или многоэтапной задачи при фиксации кода или создании или обновлении запроса на включение внесенных изменений в общедоступный или частный репозиторий Git в GitHub или Azure DevOps. Например, настройте задачу сборки с помощью команды Azure CLI AZ запись [контроля доступа Create][az-acr-task-create] , указав репозиторий Git и, при необходимости, ветвь и Dockerfile. Когда команда обновляет код в репозитории, веб-перехватчик, созданный задачами записи контроля доступа, запускает сборку образа контейнера, определенного в репозитории. 

Задачи записи контроля доступа поддерживают следующие триггеры при настройке репозитория Git в качестве контекста задачи:

| Триггер | Включено по умолчанию |
| ------- | ------------------ |
| Commit | Да |
| Запрос на вытягивание | Нет |

Чтобы настроить триггер обновления исходного кода, необходимо предоставить задаче личный маркер доступа (PAT) для установки веб-перехватчика в общедоступном или частном репозитории GitHub или Azure DevOps.

> [!NOTE]
> Сейчас Задачи ACR не поддерживают триггеры фиксации или запроса на вытягивание в репозиториях GitHub Enterprise.

Узнайте, как активировать сборку при фиксации исходного кода из второго руководства по службе "Задачи ACR": [Руководство. Автоматизация сборок образов контейнера с помощью службы "Задачи Реестра контейнеров Azure"](container-registry-tutorial-build-task.md).

## <a name="automate-os-and-framework-patching"></a>Автоматизация установки исправлений ОС и платформы

Возможности задач контроля доступа, которые действительно улучшают рабочий процесс сборки контейнера, поступают от его способности обнаруживать обновление *базового образа*. Компонент большинства образов контейнеров — это родительский образ, на котором основано одно или несколько образов приложений. Базовые образы обычно содержат операционную систему, а иногда платформы приложений. 

Вы можете настроить задачу контроля учетных записей, чтобы откладывать зависимость от базового образа при сборке образа приложения. Когда обновленный базовый образ помещается в реестр или базовый образ обновляется в общедоступном репозитории, например в центре DOCKER, задачи записи контроля доступа могут автоматически создавать образы приложений на основе этого приложения.
Благодаря такому автоматическому обнаружению и повторному выполнению сборок служба "Задачи ACR" экономит время и усилия, необходимые для того, чтобы вручную отслеживать и обновлять каждый образ приложения, ссылающийся на обновленный базовый образ.

Дополнительные сведения о [триггерах обновления базовых образов](container-registry-tasks-base-images.md) для задач контроля доступа. И Узнайте, как активировать сборку образа при отправке базового образа в реестр контейнеров в руководстве [Автоматизация создания образа контейнера при обновлении базового образа в реестре контейнеров Azure](container-registry-tutorial-base-image-update.md) .

## <a name="schedule-a-task"></a>Планирование задачи

При необходимости Запланируйте задачу, настроив один или несколько *триггеров таймера* при создании или обновлении задачи. Планирование задачи полезно для выполнения рабочих нагрузок контейнера по определенному расписанию или для выполнения операций обслуживания или тестирования образов, которые регулярно помещаются в реестр. Дополнительные сведения см. [в разделе Запуск задачи записи контроля доступа по определенному расписанию](container-registry-tasks-scheduled.md).

## <a name="multi-step-tasks"></a>Многошаговые задачи

Функция Многошаговые задачи обеспечивает определение и выполнение задач на основе шага для создания, тестирования и исправления изображений контейнера в облаке. Шаги задач, определенные в [файле YAML](container-registry-tasks-reference-yaml.md) , указывают отдельные операции сборки и отправки для образов контейнеров или других артефактов. Они также могут определять выполнение одного или нескольких контейнеров, причем каждый шаг использует контейнер в качестве среды выполнения.

Например, можно создать многошаговую задачу, которая автоматизирует следующие операции:

1. Сборка образа веб-приложения.
1. Выполнение контейнера веб-приложения.
1. Сборка тестового образа веб-приложения.
1. Запустите тестовый контейнер веб-приложения, который выполняет тесты для контейнера запущенного приложения.
1. Если тесты проходят успешно, создайте пакет архива диаграмм Helm.
1. Выполнение команды `helm upgrade` с использованием нового пакета архива диаграмм Helm.

Многошаговые задачи позволяют разделить создание, выполнение и тестирование образов на большее количество составных шагов с поддержкой зависимостей между шагами. Благодаря многошаговым задачам в службе "Задачи ACR" у вас есть более детальный контроль над рабочими процессами создания и тестирования образа, а также исправления платформы и ОС.

Дополнительные сведения о многошаговых задачах см. в статье [Выполнение многошаговых задач сборки, тестирования и исправления в службе "Задачи ACR"](container-registry-tasks-multi-step.md).

## <a name="context-locations"></a>Расположения контекста

В следующей таблице приведено несколько примеров поддерживаемых расположений контекста для Задач ACR:

| Расположение контекста | Описание: | Пример |
| ---------------- | ----------- | ------- |
| Локальная файловая система | Файлы в каталоге в локальной файловой системе. | `/home/user/projects/myapp` |
| Главная ветвь GitHub | Файлы в главной (или другой) ветви общедоступного или закрытого репозитория GitHub.  | `https://github.com/gituser/myapp-repo.git` |
| Ветвь GitHub | Конкретная ветвь общедоступного или закрытого репозитория GitHub.| `https://github.com/gituser/myapp-repo.git#mybranch` |
| Вложенная папка GitHub | Файлы во вложенной папке в общедоступном или частном репозитории GitHub. В примере показано сочетание ветви и спецификации вложенных папок. | `https://github.com/gituser/myapp-repo.git#mybranch:myfolder` |
| Фиксация GitHub | Конкретная фиксация в общедоступном или частном репозитории GitHub. В примере показано сочетание хэша фиксации (SHA) и спецификации вложенных папок. | `https://github.com/gituser/myapp-repo.git#git-commit-hash:myfolder` |
| Вложенная папка DevOps для Azure | Файлы во вложенной папке в общедоступном или частном репозитории Azure. В примере показано сочетание спецификации ветвей и вложенных папок. | `https://dev.azure.com/user/myproject/_git/myapp-repo#mybranch:myfolder` |
| Удаленный архив Tarball | Файлы в сжатом архиве на удаленном веб-сервере. | `http://remoteserver/myapp.tar.gz` |

> [!NOTE]
> При использовании закрытого репозитория Git в качестве контекста для задачи необходимо предоставить личный маркер доступа (PAT).

## <a name="image-platforms"></a>Платформы изображений

По умолчанию задачи записи контроля доступа строят образы для ОС Linux и архитектуры AMD64. Укажите `--platform` тег для создания образов Windows или образов Linux для других архитектур. Укажите операционную систему и, при необходимости, поддерживаемую архитектуру в формате ОС/архитектуры (например, `--platform Linux/arm` ). Для архитектур ARM можно дополнительно указать вариант в формате OS/Architecture/Variant (например, `--platform Linux/arm64/v8` ):

| Операционная система | Architecture|
| --- | ------- | 
| Linux | amd64<br/>arm<br/>arm64<br/>386 |
| Windows | amd64 |

## <a name="view-task-output"></a>Просмотр выходных данных задачи

Каждое выполнение задачи создает выходные данные журнала, которые можно проверить, чтобы определить, успешно ли выполнялись шаги задачи. При запуске задачи вручную выходные данные журнала для выполнения задачи передаются в консоль, а также сохраняются для последующего извлечения. Если задача запускается автоматически, например при фиксации исходного кода или обновлении базового образа, журналы задач сохраняются. Просмотрите журналы выполнения в портал Azure или используйте команду [AZ контроля доступа к журналам задач](/cli/azure/acr/task#az-acr-task-logs) .

См. Дополнительные сведения о [просмотре журналов задач и управлении ими](container-registry-tasks-logs.md).

## <a name="next-steps"></a>Дальнейшие шаги

Когда вы будете готовы автоматизировать сборку и обслуживание образов контейнеров в облаке, см. [серию руководств по задачам записи контроля](container-registry-tutorial-quick-task.md)доступа.

При необходимости установите [расширение Docker для Visual Studio Code](https://code.visualstudio.com/docs/azure/docker) и расширение [учетной записи Azure](https://marketplace.visualstudio.com/items?itemName=ms-vscode.azure-account) для работы со своими реестрами контейнеров Azure. Извлекайте и отправляйте образы в реестр контейнеров Azure или запускайте Задачи ACR в Visual Studio Code.

<!-- LINKS - External -->
[base-alpine]: https://hub.docker.com/_/alpine/
[base-dotnet]: https://hub.docker.com/r/microsoft/dotnet/
[base-node]: https://hub.docker.com/_/node/
[base-windows]: https://hub.docker.com/r/microsoft/nanoserver/
[sample-archive]: https://github.com/Azure-Samples/acr-build-helloworld-node/archive/master.zip
[terms-of-use]: https://azure.microsoft.com/support/legal/preview-supplemental-terms/

<!-- LINKS - Internal -->
[azure-cli]: /cli/azure/install-azure-cli
[az-acr-build]: /cli/azure/acr#az-acr-build
[az-acr-pack-build]: /cli/azure/acr/pack#az-acr-pack-build
[az-acr-task]: /cli/azure/acr/task
[az-acr-task-create]: /cli/azure/acr/task#az-acr-task-create
[az-login]: /cli/azure/reference-index#az-login
[az-login-service-principal]: /cli/azure/authenticate-azure-cli

<!-- IMAGES -->
[quick-build-01-fork]: ./media/container-registry-tutorial-quick-build/quick-build-01-fork.png
[quick-build-02-browser]: ./media/container-registry-tutorial-quick-build/quick-build-02-browser.png
