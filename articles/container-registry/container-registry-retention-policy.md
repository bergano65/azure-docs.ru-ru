---
title: Политика хранения манифестов без тегов
description: Узнайте, как включить политику хранения в реестре контейнеров Azure для автоматического удаления манифестов без тегов после определенного периода.
ms.topic: article
ms.date: 10/02/2019
ms.openlocfilehash: 5dda85934bb10cf16fd90381539b892df4f5445c
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "83683459"
---
# <a name="set-a-retention-policy-for-untagged-manifests"></a>Настройка политики хранения для манифестов без тегов

Реестр контейнеров Azure позволяет задать *политику хранения* для сохраненных манифестов образов, у которых нет связанных тегов (*манифесты без тегов*). Если политика хранения включена, манифесты без тегов в реестре автоматически удаляются по истечении заданного количества дней. Эта функция предотвращает заполнение реестра ненужными артефактами и помогает сэкономить на хранении. Если атрибут `delete-enabled` манифеста без тегов имеет значение `false`, то манифест не может быть удален и политика хранения не применяется.

Для выполнения примеров команд в этой статье можно использовать Azure Cloud Shell или локальный экземпляр Azure CLI. Если вы хотите использовать его локально, требуется версия 2.0.74 или более поздняя. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][azure-cli].

Политика хранения — это компонент реестра контейнеров уровня **Премиум**. Сведения об уровнях служб реестра см. в статье [Уровни служб реестра контейнеров Azure](container-registry-skus.md).

> [!IMPORTANT]
> Сейчас эта функция доступна в предварительной версии, и применяются [некоторые ограничения](#preview-limitations). Предварительные версии предоставляются при условии, что вы принимаете [дополнительные условия использования][terms-of-use]. Некоторые аспекты этой функции могут быть изменены до выхода общедоступной версии.

> [!WARNING]
> Настраивайте политику хранения с осторожностью — удаленные данные образа НЕ ПОДЛЕЖАТ ВОССТАНОВЛЕНИЮ. Если у вас есть системы, которые получают образы с помощью дайджеста манифеста (а не по имени образа), не настраивайте политику хранения для манифестов без тегов. Удаление образов без тегов не позволит этим системам получать образы из реестра. Вместо получения с помощью манифеста попробуйте внедрить схему *уникальных тегов*, которая [рекомендуется в качестве лучшей методики](container-registry-image-tag-version.md).

## <a name="preview-limitations"></a>Ограничения предварительной версии

* Политику хранения можно задать только для манифестов без тегов.
* Политика хранения в настоящее время применяется только к манифестам, которые не помечаются тегами *после* включения политики. Политика не распространяется на существующие манифесты без тегов в реестре. Чтобы удалить существующие манифесты без тегов, см. примеры в разделе [Удаление образов контейнеров в реестре контейнеров Azure](container-registry-delete.md).

## <a name="about-the-retention-policy"></a>Сведения о политике хранения

Реестр контейнеров Azure выполняет подсчет ссылок для манифестов в реестре. Если манифест не помечен тегом, он проверяет политику хранения. Если политика хранения включена, операция удаления манифеста помещается в очередь с определенной датой в соответствии с числом дней, установленным в политике.

Отдельное задание управления очередями постоянно обрабатывает сообщения, выполняя масштабирование по мере необходимости. В качестве примера предположим, что вы создали два манифеста без тегов с интервалом в 1 час в реестре с политикой хранения 30 дней. Два сообщения помещаются в очередь. Затем, через 30 дней, с интервалом примерно в 1 час сообщения извлекаются из очереди и обрабатываются, если политика все еще действует.

## <a name="set-a-retention-policy---cli"></a>Настройка политики хранения — CLI

В следующем примере показано, как использовать Azure CLI, чтобы задать политику хранения для манифестов без тегов в реестре.

### <a name="enable-a-retention-policy"></a>Включение политики хранения

По умолчанию в реестре контейнеров не задана политика хранения. Чтобы задать или обновить политику хранения, выполните команду [az acr config retention update][az-acr-config-retention-update] в Azure CLI. Можно указать период хранения манифестов без тегов от 0 до 365 дней. Если не указать число дней, команда задает значение по умолчанию 7 дней. По истечении срока хранения все манифесты без тегов в реестре автоматически удаляются.

В следующем примере задается политика хранения манифестов без тегов течение 30 дней в реестре *myregistry*:

```azurecli
az acr config retention update --registry myregistry --status enabled --days 30 --type UntaggedManifests
```

В следующем примере задается политика удаления манифеста в реестре после удаления тегов. Создайте эту политику, задав период хранения 0 дней. 

```azurecli
az acr config retention update --registry myregistry --status enabled --days 0 --type UntaggedManifests
```

### <a name="validate-a-retention-policy"></a>Проверка политики хранения

При включении предыдущей политики с периодом хранения 0 дней можно быстро проверить удаление непомеченных манифестов:

1. Отправьте тестовый образ `hello-world:latest` в реестр или замените другой тестовый образ по выбору.
1. Удалить тег образа `hello-world:latest`, например с помощью команды [az acr repository untag][az-acr-repository-untag]. Манифест без тегов остается в реестре.
    ```azurecli
    az acr repository untag --name myregistry --image hello-world:latest
    ```
1. Через несколько секунд манифест без тегов удаляется. Чтобы проверить удаление, запросите список манифестов в репозитории, например с помощью команды [az acr repository show-manifests][az-acr-repository-show-manifests]. Если тестовый образ был единственным в репозитории, сам репозиторий удаляется.

### <a name="disable-a-retention-policy"></a>Отключение политики хранения

Чтобы просмотреть политику хранения, заданную в реестре, выполните команду [az acr config retention show][az-acr-config-retention-show]:

```azurecli
az acr config retention show --registry myregistry
```

Чтобы отключить политику хранения в реестре, выполните команду [az acr config retention update][az-acr-config-retention-update] и задайте `--status disabled`:

```azurecli
az acr config retention update --registry myregistry --status disabled --type UntaggedManifests
```

## <a name="set-a-retention-policy---portal"></a>Настройка политики хранения — портал

Можно также задать политику хранения реестра на [портале Azure](https://portal.azure.com). В следующем примере показано, как использовать портал, чтобы задать политику хранения для манифестов без тегов в реестре.

### <a name="enable-a-retention-policy"></a>Включение политики хранения

1. Перейдите в реестр контейнеров Azure. В разделе **Политики** выберите **Хранение** (предварительная версия).
1. Для параметра **Состояние** задайте значение **Включено**.
1. Выберите период хранения манифестов без тегов от 0 до 365 дней. Щелкните **Сохранить**.

![Включение политики хранения на портале Azure](media/container-registry-retention-policy/container-registry-retention-policy01.png)

### <a name="disable-a-retention-policy"></a>Отключение политики хранения

1. Перейдите в реестр контейнеров Azure. В разделе **Политики** выберите **Хранение** (предварительная версия).
1. Для параметра **Состояние** задайте значение **Отключено**. Щелкните **Сохранить**.

## <a name="next-steps"></a>Дальнейшие действия

* Узнайте больше о вариантах [удаления образов и репозиториев](container-registry-delete.md) в реестре контейнеров Azure

* Узнайте, как [автоматически очистить](container-registry-auto-purge.md) выбранные образы и манифесты из реестра.

* Узнайте больше о вариантах [блокировки образов и манифестов](container-registry-image-lock.md) в реестре

<!-- LINKS - external -->
[terms-of-use]: https://azure.microsoft.com/support/legal/preview-supplemental-terms/


<!-- LINKS - internal -->
[azure-cli]: /cli/azure/install-azure-cli
[az-acr-config-retention-update]: /cli/azure/acr/config/retention#az-acr-config-retention-update
[az-acr-config-retention-show]: /cli/azure/acr/config/retention#az-acr-config-retention-show
[az-acr-repository-untag]: /cli/azure/acr/repository#az-acr-repository-untag
[az-acr-repository-show-manifests]: /cli/azure/acr/repository#az-acr-repository-show-manifests
