---
title: Основы проверки подлинности Azure Key Vault
description: Узнайте, как работает модель проверки подлинности хранилища ключей
author: ShaneBala-keyvault
ms.author: sudbalas
ms.date: 09/25/2020
ms.service: key-vault
ms.subservice: general
ms.topic: conceptual
ms.openlocfilehash: 1e8f1d2964f42c480026d13bed59921dd3f07610
ms.sourcegitcommit: 7863fcea618b0342b7c91ae345aa099114205b03
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/03/2020
ms.locfileid: "93286226"
---
# <a name="key-vault-authentication-fundamentals"></a>Основы проверки подлинности в Key Vault

Azure Key Vault позволяет безопасно хранить учетные данные приложений, такие как секреты, ключи и сертификаты, в центральном и безопасном облачном репозитории, а также управлять ими. Key Vault исключает необходимость хранить учетные данные в приложениях. Приложения могут проходить проверку подлинности в Key Vault во время выполнения для получения учетных данных.

Администратор может жестко контролировать, какие пользователи и приложения могут получать доступ к хранилищу ключей, а также ограничивать и выполнять аудит выполняемых операций. В этом документе объясняются фундаментальные понятия модели доступа к хранилищу ключей. Он предоставит вам начальный уровень знаний и покажет, как можно проверить подлинность пользователя или приложения в хранилище ключей от начала до конца.

## <a name="required-knowledge"></a>Необходимые знания

В этом документе предполагается, что вы знакомы со следующими понятиями. Если вы не знакомы ни с одним из этих концепций, воспользуйтесь ссылками на справку, прежде чем продолжить.

* [Ссылка](../../active-directory/fundamentals/active-directory-whatis.md) на Azure Active Directory
* [Ссылка](./authentication.md#app-identity-and-security-principals) на субъекты безопасности

## <a name="key-vault-configuration-steps-summary"></a>Сводка шагов по настройке Key Vault

1. Зарегистрируйте пользователя или приложение в Azure Active Directory в качестве субъекта безопасности.
1. Настройте назначение ролей для субъекта безопасности в Azure Active Directory.
1. Настройка политик доступа к хранилищу ключей для субъекта безопасности.
1. Настройте Key Vault брандмауэре доступ к вашему хранилищу ключей (необязательно).
1. Проверьте возможность доступа субъекта безопасности к хранилищу ключей.

## <a name="register-a-user-or-application-in-azure-active-directory-as-a-security-principal"></a>Регистрация пользователя или приложения в Azure Active Directory в качестве субъекта безопасности

Когда пользователь или приложение выполняет запрос к хранилищу ключей, запрос должен сначала пройти проверку подлинности Azure Active Directory. Чтобы это работало, необходимо зарегистрировать пользователя или приложение в Azure Active Directory в качестве субъекта безопасности.

Чтобы узнать, как зарегистрировать пользователя или приложение в Azure Active Directory, следуйте приведенным ниже ссылкам на документацию.
**Убедитесь, что вы создали пароль для регистрации пользователя и секрет клиента или учетные данные сертификата клиента для приложений.**

* Регистрация пользователя в Azure Active Directory [ссылке](../../active-directory/fundamentals/add-users-azure-active-directory.md)
* Регистрация приложения в [ссылке](../../active-directory/develop/quickstart-register-app.md) Azure Active Directory

## <a name="assign-your-security-principal-a-role-in-azure-active-directory"></a>Назначение роли субъекта безопасности в Azure Active Directory

Azure Active Directory использует управление доступом на основе ролей (RBAC) для назначения разрешений субъектам безопасности. Эти разрешения называются назначениями ролей.

В контексте хранилища ключей эти назначения ролей определяют уровень доступа субъекта безопасности к плоскости управления (также известной как плоскость управления) хранилища ключей. Эти назначения ролей не предоставляют прямой доступ к секретам плоскости данных, но предоставляют доступ к управлению свойствами хранилища ключей. Например, пользователю или приложению, которому назначена **роль читателя** , запрещено вносить изменения в параметры брандмауэра хранилища ключей, тогда как пользователь или приложение, которым назначена **роль участника** , может вносить изменения. Ни одна из ролей не будет иметь прямой доступ к операциям с секретами, ключами и сертификатами, такими как создание или получение значения до тех пор, пока им не назначен доступ к плоскости данных хранилища ключей. Это рассматривается в следующем шаге.

>[!IMPORTANT]
> Хотя пользователи с ролью "участник" или "владелец" не имеют доступа для выполнения операций с секретами, хранящимися в хранилище ключей по умолчанию, роли "участник" и "владелец" предоставляют разрешения на добавление или удаление политик доступа к секретам, хранящимся в хранилище ключей. Поэтому пользователь с этими назначениями ролей может предоставлять себе доступ к секретам доступа в хранилище ключей. По этой причине рекомендуется, чтобы только администраторы имели доступ к ролям участника или владельца. Пользователям и приложениям, которым требуется только получать секреты из хранилища ключей, должна быть предоставлена роль читателя. **Дополнительные сведения см. в следующем разделе.**

>[!NOTE]
> При назначении пользователю назначения роли на уровне клиента Azure Active Directory этот набор разрешений будет тонкого до всех подписок, групп ресурсов и ресурсов в области назначения. Чтобы следовать за участником с минимальными правами, можно сделать это назначение роли более детализированным. Например, можно назначить пользователю роль читателя на уровне подписки и роль владельца для одного хранилища ключей. Перейдите к параметрам управления доступом удостоверений (IAM) подписки, ресурсов или хранилища ключей, чтобы назначить назначение ролей в более детализированной области.

* Дополнительные сведения о [ссылке](../../role-based-access-control/built-in-roles.md) на Azure Active Directory роли
* Дополнительные сведения о назначении или удалении [назначений ролей](../../role-based-access-control/role-assignments-portal.md)

## <a name="configure-key-vault-access-policies-for-your-security-principal"></a>Настройка политик доступа к хранилищу ключей для субъекта безопасности

Прежде чем предоставить доступ пользователям и приложениям к хранилищу ключей, важно понимать различные типы операций, которые можно выполнять в хранилище ключей. Существует два основных типа операций хранилища ключей: плоскость управления (также называемая плоскостью управления) и операции с плоскостью данных.

В этой таблице приведены несколько примеров различных операций, управляемых плоскостью управления и плоскостью данных. Операции, изменяющие свойства хранилища ключей, — это операции плоскости управления. Операции, которые изменяют или извлекают значения секретов, хранящихся в хранилище ключей, — это операции с плоскостью данных.

|Операции плоскости управления (примеры)|Операции с плоскостью данных (примеры)|
| --- | --- |
| Создание хранилища ключей | Создание ключа, секрета, сертификата
| Удалить Key Vault | Удаление ключа, секрета, сертификата
| Добавление или удаление назначений ролей Key Vault | Вывод списка и получение значений ключей, секретов, сертификатов
| Добавление и удаление политик доступа Key Vault | Ключи резервного копирования и восстановления, секреты, сертификаты
| Изменение параметров брандмауэра Key Vault | Обновление ключей, секретов, сертификатов
| Изменение параметров восстановления Key Vault | Очистка или восстановление обратимо удаленных ключей, секретов, сертификатов
| Изменение параметров журналов диагностики Key Vault

### <a name="management-plane-access--azure-active-directory-role-assignments"></a>& доступа к плоскости управления Azure Active Directory назначения ролей

Azure Active Directory назначения ролей предоставляют доступ для выполнения операций плоскости управления в хранилище ключей. Этот доступ обычно предоставляется пользователям, а не приложениям. Вы можете ограничить действия плоскости управления, которые может выполнять пользователь, изменив назначение роли пользователя.

Например, назначение пользователю роли "читатель Key Vault" для пользователя позволит им просматривать свойства хранилища ключей, такие как политики доступа, но не позволит им вносить какие-либо изменения. При назначении пользователя роль владельца будет предоставлять им полный доступ для изменения параметров плоскости управления хранилища ключей.

Назначение ролей контролируется в колонке управления доступом к хранилищу ключей (IAM). Если требуется, чтобы конкретный пользователь имел доступ к читателям или администратору нескольких ресурсов хранилища ключей, можно создать назначение роли на уровне хранилища, группы ресурсов или подписки, а назначение ролей будет добавлено ко всем ресурсам в области назначения.

Доступ к плоскости данных или доступ к операциям с ключами, секретами и сертификатами, хранящимися в хранилище ключей, можно добавить одним из двух способов.

### <a name="data-plane-access-option-1-classic-key-vault-access-policies"></a>Вариант доступа к плоскости данных 1: классические политики доступа Key Vault

Политики доступа к хранилищу ключей предоставляют пользователям и приложениям доступ для выполнения операций с плоскостью данных в хранилище ключей.

> [!NOTE]
> Эта модель доступа несовместима с хранилищем ключей RBAC (вариант 2), описанным ниже. Необходимо выбрать один из них. Вы сможете выбрать этот вариант, щелкнув вкладку Политика доступа в хранилище ключей.

Классические политики доступа являются детализированными, что означает возможность разрешения или запрета возможности каждого отдельного пользователя или приложения выполнять отдельные операции в хранилище ключей. Вот несколько примеров:

* Субъект безопасности 1 может выполнять любую операцию с ключом, но не может выполнять никаких операций с секретами или сертификатами.
* Субъект безопасности 2 может просматривать и читать все ключи, секреты и сертификаты, но не может выполнять операции создания, удаления или обновления.
* Субъект безопасности 3 может выполнять резервное копирование и восстановление всех секретов, но не может считывать значения самих секретов.

Однако классические политики доступа не разрешают разрешения на уровне объектов, а назначенные разрешения применяются к области действия отдельного хранилища ключей. Например, при предоставлении разрешения политики доступа "секретное получение" для субъекта безопасности в определенном хранилище ключей субъект безопасности может получить все секреты в этом хранилище ключей. Однако это разрешение "получение секрета" не будет автоматически распространяться на другие хранилища ключей и должно быть назначено явным образом.

> [!IMPORTANT]
> Классические политики доступа к хранилищу ключей и назначения ролей Azure Active Directory независимы друг от друга. Назначение субъекта безопасности роли "участник" на уровне подписки не позволит субъекту безопасности выполнять операции с плоскостью данных в каждом хранилище ключей в области подписки. Субъект безопасности по-прежнему должен быть предоставлен или предоставлять себе разрешения политики доступа для выполнения операций с плоскостью данных.

### <a name="data-plane-access-option-2--key-vault-rbac-preview"></a>Вариант доступа к плоскости данных 2: Key Vault RBAC (Предварительная версия)

Новый способ предоставления доступа к плоскости данных хранилища ключей — управление доступом на основе ролей хранилища ключей (RBAC).

> [!NOTE]
> Эта модель доступа несовместима с классическими политиками доступа к хранилищу ключей, показанными выше. Необходимо выбрать один из них. Вы сможете выбрать этот вариант, щелкнув вкладку Политика доступа в хранилище ключей.

Key Vault назначения ролей — это набор встроенных назначений ролей Azure, охватывающих общие наборы разрешений, используемых для доступа к ключам, секретам и сертификатам. Эта модель разрешений также включает дополнительные возможности, недоступные в классической модели политики доступа к хранилищу ключей.

* Разрешения RBAC можно управлять в масштабе, разрешая пользователям назначать эти роли в подписке, группе ресурсов или на уровне отдельных хранилищ ключей. Пользователь будет иметь разрешения плоскости данных для всех хранилищ ключей в области назначения RBAC. Это устраняет необходимость назначать индивидуальные разрешения политики доступа для каждого пользователя или приложения на хранилище ключей.

* Разрешения RBAC совместимы с управление привилегированными пользователями или PIM. Это позволяет настроить элементы управления JIT-доступом для привилегированных ролей, таких как Key Vault Administrator. Это Оптимальная методика обеспечения безопасности, которая следует за участником минимальных прав, исключая постоянный доступ к хранилищам ключей.

* Разрешения RBAC совместимы с детализированными разрешениями для каждого объекта, поэтому вы можете запретить пользователю выполнять операции только с некоторыми объектами хранилища ключей. Это позволяет нескольким приложениям совместно использовать одно хранилище ключей, при этом одновременно изолируя доступ между приложениями.

Дополнительные сведения о Key Vault RBAC см. в следующих документах:

* [Ссылка](./secure-your-key-vault.md#management-plane-and-azure-rbac) Azure Key Vault RBAC
* [Ссылка](../../role-based-access-control/built-in-roles.md#key-vault-administrator-preview) на Azure Key Vault роли RBAC (Предварительная версия)

## <a name="configure-key-vault-firewall"></a>Настройка брандмауэра Key Vault

По умолчанию хранилище ключей разрешает отправку трафика из общедоступного Интернета в хранилище ключей через общедоступную конечную точку. Для дополнительного уровня безопасности можно настроить брандмауэр Azure Key Vault, чтобы ограничить доступ к общедоступной конечной точке хранилища ключей.

Чтобы включить брандмауэр хранилища ключей, щелкните вкладку "сети" на портале хранилища ключей и выберите переключатель, чтобы разрешить доступ из: "Частная конечная точка и выбранные сети". Если вы решили включить брандмауэр хранилища ключей, можно разрешить трафик через брандмауэр хранилища ключей.

* Добавьте IPv4-адреса в список разрешений брандмауэра хранилища ключей. Этот вариант лучше подходит для приложений, имеющих статические IP-адреса.

* Добавьте виртуальную сеть в брандмауэр хранилища ключей. Этот вариант лучше подходит для ресурсов Azure, имеющих динамические IP-адреса, такие как виртуальные машины. Вы можете добавить ресурсы Azure в виртуальную сеть и добавить виртуальную сеть в список разрешений брандмауэра хранилища ключей. Этот параметр использует конечную точку службы, которая является частным IP-адресом в виртуальной сети. Это обеспечивает дополнительный уровень защиты, поэтому трафик между хранилищем ключей и виртуальной сетью направляется через общедоступный Интернет. Дополнительные сведения о конечной точке службы см. в следующей документации. [ссылку](./network-security.md)

* Добавьте подключение к частному каналу в хранилище ключей. При выборе этого варианта виртуальная сеть подключается к конкретному экземпляру хранилища ключей, что обеспечивает эффективное подключение хранилища ключей в виртуальной сети. Дополнительные сведения о настройке подключения к частной конечной точке к хранилищу ключей см. по следующей [ссылке](./private-link-service.md) .

## <a name="test-your-service-principals-ability-to-access-key-vault"></a>Тестирование возможности субъекта-службы в доступе к хранилищу ключей

После выполнения всех описанных выше действий вы сможете задать и получить секреты из хранилища ключей.

### <a name="authentication-process-for-users-examples"></a>Процесс проверки подлинности для пользователей (примеры)

* Пользователи могут войти в портал Azure для использования хранилища ключей. [Краткое руководство по Key Vault порталу](./quick-create-portal.md)

* Пользователь может использовать Azure CLI для использования хранилища ключей. [Краткое руководство по Key Vault Azure CLI](./quick-create-cli.md)

* Пользователь может использовать Azure PowerShell для использования хранилища ключей. [Краткое руководство по Key Vault Azure PowerShell](./quick-create-powershell.md)

### <a name="azure-active-directory-authentication-process-for-applications-or-services-examples"></a>Azure Active Directory процесса проверки подлинности для приложений или служб (примеры)

* Приложение предоставляет секрет клиента и идентификатор клиента в функции для получения токена Azure Active Directory. 

* Приложение предоставляет сертификат для получения маркера Azure Active Directory. 

* Ресурс Azure использует проверку подлинности MSI для получения токена Azure Active Directory. 

* Дополнительные сведения о [ссылке](../../active-directory/managed-identities-azure-resources/overview.md) проверки подлинности MSI

### <a name="authentication-process-for-application-python-example"></a>Процесс проверки подлинности для приложения (пример Python)

Используйте следующий пример кода, чтобы проверить, может ли приложение получить секрет из хранилища ключей с помощью настроенного субъекта-службы.

>[!NOTE]
>Этот пример предназначен только для демонстрационных и тестовых целей. **не использовать секретную проверку ПОдлинности клиента в рабочей среде** Это не является безопасной практикой разработки. Рекомендуется использовать сертификат клиента или проверку подлинности MSI.

```python
from azure.identity import ClientSecretCredential
from azure.keyvault.secrets import SecretClient

tenant_id = "{ENTER YOUR TENANT ID HERE}"                          ##ENTER AZURE TENANT ID
vault_url = "https://{ENTER YOUR VAULT NAME}.vault.azure.net/"     ##ENTER THE URL OF YOUR KEY VAULT
client_id = "{ENTER YOUR CLIENT ID HERE}"                          ##ENTER THE CLIENT ID OF YOUR SERVICE PRINCIPAL
cert_path = "{ENTER YOUR CLIEND SECRET HERE}"                      ##ENTER THE CLIENT SECRET OF YOUR SERVICE PRINCIPAL

def main():

    #AUTHENTICATION TO Azure Active Directory USING CLIENT ID AND CLIENT CERTIFICATE (GET Azure Active Directory TOKEN)
    token = ClientSecretCredential(tenant_id=tenant_id, client_id=client_id, client_secret=client_secret)

    #AUTHENTICATION TO KEY VAULT PRESENTING Azure Active Directory TOKEN
    client = SecretClient(vault_url=vault_url, credential=token)

    #CALL TO KEY VAULT TO GET SECRET
    #ENTER NAME OF A SECRET STORED IN KEY VAULT
    secret = client.get_secret('{SECRET_NAME}')

    #GET PLAINTEXT OF SECRET
    print(secret.value)

#CALL MAIN()
if __name__ == "__main__":
    main()
```

## <a name="next-steps"></a>Next Steps

Более подробные сведения о проверке подлинности хранилища ключей см. в следующем документе. [Аутентификация Key Vault](./authentication.md)