---
title: Azure Key Vault обратимого удаления | Документация Майкрософт
description: Обратимое удаление в Azure Key Vault позволяет восстанавливать удаленные хранилища ключей и объекты хранилища ключей, такие как ключи, секреты и сертификаты.
ms.service: key-vault
ms.subservice: general
ms.topic: conceptual
author: ShaneBala-keyvault
ms.author: sudbalas
ms.date: 12/15/2020
ms.openlocfilehash: 0f428954ac6ef74253e6e6e430977a85a3943f99
ms.sourcegitcommit: d2d1c90ec5218b93abb80b8f3ed49dcf4327f7f4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/16/2020
ms.locfileid: "97589990"
---
# <a name="azure-key-vault-soft-delete-overview"></a>Общие сведения об обратимом удалении в Azure Key Vault

> [!IMPORTANT]
> Вы должны немедленно включить обратимое удаление в хранилищах ключей. Возможность отказаться от обратимого удаления будет нерекомендуемой в ближайшее время. Ознакомьтесь с полными [сведениями](soft-delete-change.md)

Функция обратимого удаления Key Vault позволяет восстанавливать удаленные хранилища и удаленные объекты хранилища ключей (например, ключи, секреты, сертификаты), называемые обратимым удалением. В частности, мы будем решать следующие сценарии защиты:

- После удаления секрета, ключа, сертификата или хранилища ключей он останется восстанавливаемым в течение периода с интервалом от 7 до 90 календарных дней. Если значение не указано, период восстановления по умолчанию будет составлять 90 дней. Пользователи будут иметь достаточно времени, чтобы заметить случайное удаление секрета и устранить инцидент.
- Для окончательного удаления секрета необходимо выполнить две операции. Сначала пользователь должен удалить объект, который помещает его в обратимо Удаленное состояние. Во-вторых, пользователь должен очистить объект в состоянии обратимого удаления. Для операции очистки требуются дополнительные разрешения политики доступа. Эти дополнительные средства защиты снижают риск случайного или злонамеренного удаления пользователем секрета или хранилища ключей.  
- Чтобы очистить секрет в состоянии обратимого удаления, субъекту-службе необходимо предоставить дополнительное разрешение на "очистку" политики доступа. По умолчанию разрешение на очистку политики доступа не предоставляется ни одному из субъектов-служб, включая хранилище ключей и владельцев подписок, и должно быть намеренно задано. Если требуется разрешение политики доступа с повышенными правами для очистки обратимо удаляемого секрета, это уменьшает вероятность случайного удаления секрета.

## <a name="supporting-interfaces"></a>Поддержка интерфейсов

Функция обратимого удаления доступна через [REST API](/rest/api/keyvault/), [Azure CLI](./key-vault-recovery.md), [Azure PowerShell](./key-vault-recovery.md)и интерфейсы [.NET/C#](/dotnet/api/microsoft.azure.keyvault?view=azure-dotnet) , а также [шаблоны ARM](/azure/templates/microsoft.keyvault/2019-09-01/vaults).

## <a name="scenarios"></a>Сценарии

Azure Key Vault — это отслеживаемые ресурсы, управляемые Azure Resource Manager. Azure Resource Manager также задает четко определенное поведение для удаления, которое требует, чтобы после успешной операции удаления этот ресурс больше не был доступен. Функция обратимого восстановления восстанавливает удаленный объект независимо от того, было ли удаление случайным или преднамеренным.

1. В типичном сценарии пользователь может случайно удалить Key Vault или его объект. Если они будут доступны для восстановления в течение предопределенного периода, пользователь сможет отменить удаление и восстановить свои данные.

2. В другом сценарии несанкционированный пользователь может попытаться удалить Key Vault или его объект, например ключ в хранилище, чтобы нарушить работу компании. Разделение удаления Key Vault или его объектов и удаления базовых данных может использоваться как мера предосторожности, к примеру, для ограничения разрешений на удаление данных другой доверенной ролью. По существу, при таком подходе требуется кворум для операции, так как в противном случае может произойти немедленная потеря данных.

### <a name="soft-delete-behavior"></a>Поведение обратимого удаления

Если обратимое удаление включено, ресурсы, помеченные как удаленные ресурсы, сохраняются в течение указанного периода (по умолчанию 90 дней). Затем эта служба предоставляет механизм восстановления удаленного объекта, отменяющий удаление.

При создании нового хранилища ключей обратимое удаление включено по умолчанию. Вы можете создать хранилище ключей без обратимого удаления с помощью [Azure CLI](./key-vault-recovery.md) или [Azure PowerShell](./key-vault-recovery.md). После включения обратимого удаления в хранилище ключей его нельзя отключить.

Срок хранения по умолчанию составляет 90 дней, но во время создания хранилища ключей можно задать для интервала политики хранения значение от 7 до 90 дней после портал Azure. Для политики хранения защиты от очистки используется тот же интервал. После установки интервал политики хранения нельзя изменить.

Нельзя повторно использовать имя хранилища ключей, которое было обратимо удалено, пока не будет пройден срок хранения.

### <a name="purge-protection"></a>Очистка защиты

Очистка защиты — это необязательное поведение Key Vault и **не включено по умолчанию**. Защиту от очистки можно включить только после включения обратимого удаления.  Ее можно включить с помощью [интерфейса командной строки](./key-vault-recovery.md?tabs=azure-cli) или [PowerShell](./key-vault-recovery.md?tabs=azure-powershell).

Если включена защита от удаления, хранилище или объект в удаленном состоянии нельзя очистить до тех пор, пока не будет пройден срок хранения. Обратимо удаленные хранилища и объекты по-прежнему можно восстановить, убедившись, что политика хранения будет соблюдена.

По умолчанию срок хранения составляет 90 дней, но можно задать для интервала политики хранения значение от 7 до 90 дней после портал Azure. После установки и сохранения интервала политики хранения его нельзя изменить для этого хранилища.

### <a name="permitted-purge"></a>Разрешенная очистка

Окончательное удаление и очистку хранилища ключей можно выполнить с помощью операции POST на прокси-ресурсе. Это требует специальных привилегий. Как правило, только владелец подписки может очистить хранилище ключей. Операция POST активирует немедленное и необратимое удаление этого хранилища. 

Исключения:
- Если подписка Azure помечена как *неудаляемая*. В этом случае только служба может выполнить фактическое удаление в рамках запланированной процедуры. 
- Если параметр включен `--enable-purge-protection flag` в самом хранилище. В этом случае Key Vault будет ожидать 90 дней с момента, когда исходный объект секрета был помечен для удаления, прежде чем окончательно удалить объект.

Инструкции см. в статьях [использование Key Vault обратимого удаления с помощью интерфейса командной строки: очистка хранилища ключей](./key-vault-recovery.md?tabs=azure-cli#key-vault-cli) или [Использование Key Vault обратимого удаления с помощью PowerShell: очистка хранилища ключей](./key-vault-recovery.md?tabs=azure-powershell#key-vault-powershell).

### <a name="key-vault-recovery"></a>Восстановление Key Vault

Когда хранилище ключей будет удалено, служба создаст прокси-ресурс в рамках подписки, добавив достаточное количество метаданных для восстановления. Прокси-ресурс — это хранимый объект, доступный в том же месте, что и удаленное Key Vault. 

### <a name="key-vault-object-recovery"></a>Восстановление объектов Key Vault

После удаления объекта хранилища ключей, такого как ключ, служба поместит объект в удаленное состояние, делая его недоступным для любых операций получения. В этом состоянии объект хранилища ключей можно только внести в список, восстановить, а также принудительно или окончательно удалить. Для просмотра объектов используйте `az keyvault key list-deleted` команду Azure CLI (как описано в статье [Использование Key Vault обратимого удаления с помощью интерфейса командной строки](./key-vault-recovery.md)) или `-InRemovedState` параметра Azure PowerShell (как описано в статье [Использование Key Vault обратимого удаления с помощью PowerShell](./key-vault-recovery.md?tabs=azure-powershell#key-vault-powershell)).  

В то же время Key Vault запланирует удаление базовых данных удаленного Key Vault или его объекта, чтобы удалить их по истечении предопределенного интервала хранения. Запись DNS, соответствующая хранилищу, также сохраняется в течение этого интервала.

### <a name="soft-delete-retention-period"></a>Период хранения при обратимом удалении

Обратимо удаленные ресурсы хранятся в течение заданного периода времени, 90 дней. В течение интервала хранения применяются следующие условия:

- Вы можете вести список всех Key Vault и их объектов в состоянии обратимого удаления для вашей подписки, а также просматривать сведения об их удалении и восстановлении.
  - Только пользователи со специальными разрешениями могут вести список удаленных хранилищ. Мы советуем нашим пользователям создать настраиваемую роль с этими разрешениями для управления удаленными хранилищами.
- Хранилище ключей с тем же именем не может быть создано в том же расположении. Таким образом, объект хранилища ключей не может быть создан в заданном хранилище, если это хранилище ключей содержит объект с тем же именем и находится в удаленном состоянии.
- Только пользователь со специальными привилегиями может восстановить хранилище ключей или его объект, выполнив команду восстановления на соответствующем прокси-ресурсе.
  - Пользователь, участник настраиваемой роли, у которого есть привилегии создавать хранилище ключей в группе ресурсов, может восстановить хранилище.
- Только пользователь со специальными привилегиями может принудительно удалить хранилище ключей или его объект, выполнив команду удаления на соответствующем прокси-ресурсе.

Если хранилище ключей или его объект не будут восстановлены, служба выполнит очистку обратимо удаленного хранилища ключей или его объекта вместе с содержимым в конце периода хранения. Удаление ресурса нельзя запланировать повторно.

### <a name="billing-implications"></a>Процесс выставления счетов

В общем случае, когда объект (хранилище ключей, ключ или секрета) находится в состоянии удаления, возможны только две операции: очистка и восстановление. Все остальные операции завершатся ошибкой. Таким образом, хотя объект существует, операции выполнять нельзя, следовательно счета за использование не выставляются. Но есть и следующие исключения.

- Действия очистки и удаления будут считаться обычными операциями хранилища ключей, следовательно, они будут тарифицироваться.
- Если объект является ключом HSM, ежемесячная плата за версию каждого ключа с защитой HSM будет взиматься, если версия ключа использовалась в течение последних 30 дней. После этого, так как объект находится в состоянии удаления, операции с ним невозможны, плата не будет взиматься.

## <a name="next-steps"></a>Дальнейшие действия

Следующие два руководства содержат основные сценарии использования обратимого удаления.

- [Как использовать обратимое удаление в Key Vault с помощью PowerShell](./key-vault-recovery.md) 
- [Как использовать обратимое удаление в Key Vault с помощью интерфейса командной строки](./key-vault-recovery.md)
