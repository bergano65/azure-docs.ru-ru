---
title: Ведение журнала службы "Управляемое устройство HSM Azure"
description: Это руководство поможет вам приступить к работе с журналами службы "Управляемое устройство HSM".
services: key-vault
author: msmbaldwin
tags: azure-resource-manager
ms.service: key-vault
ms.subservice: managed-hsm
ms.topic: tutorial
ms.date: 09/15/2020
ms.author: mbaldwin
ms.openlocfilehash: 22abd38ead1257b49eeae98acfcd74349f563811
ms.sourcegitcommit: bdd5c76457b0f0504f4f679a316b959dcfabf1ef
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/22/2020
ms.locfileid: "90992297"
---
# <a name="managed-hsm-logging"></a>Ведение журнала в службе "Управляемое устройство HSM" 

Создав одно или несколько Управляемых устройств HSM, вы захотите отслеживать, кто, как и когда осуществлял доступ к этим HSM. Это можно сделать с помощью функции ведения журнала, которая сохраняет информацию в указанной учетной записи хранения Azure. Для указанной вами учетной записи автоматически создается контейнер с именем **insights-logs-auditevent**. Одну и ту же учетную запись можно использовать для сбора журналов нескольких управляемых устройств HSM.

Регистрируемые в журналах сведения становятся доступны не позднее чем через 10 минут после выполнения операции с управляемым устройством HSM. В большинстве случаев это будет еще быстрее.  Способ управления журналами в своей учетной записи хранения вы выбираете сами.

* Используйте стандартные методы контроля доступа, предоставляемые Azure, для защиты журналов путем ограничения доступа к ним.
* Удаляйте журналы, которые больше не нужно хранить в учетной записи хранения.

Это руководство поможет вам приступить к работе с журналами службы "Управляемое устройство HSM". Вы создадите учетную запись хранения, включите ведение журнала и проанализируете собранные данные журнала.  

> [!NOTE]
> В этом руководстве нет инструкций по созданию управляемых устройств HSM и ключей. В этой статье приведены инструкции по обновлению журнала ведения диагностики с помощью Azure CLI.

## <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить действия, описанные в этой статье, вам потребуется следующее:

* подписка на Microsoft Azure. Если у вас ее нет, зарегистрируйтесь, чтобы воспользоваться [бесплатной пробной версией](https://azure.microsoft.com/pricing/free-trial).
* Azure CLI 2.12.0 или более поздней версии. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI]( /cli/azure/install-azure-cli).
* Управляемое устройство HSM в подписке. См. [Краткое руководство. Подготовка и активация управляемого устройства HSM с помощью Azure CLI](quick-create-cli.md) для выполнения соответствующих действий.

[!INCLUDE [cloud-shell-try-it.md](../../../includes/cloud-shell-try-it.md)]

## <a name="connect-to-your-azure-subscription"></a>Подключение к подписке Azure

Для настройки ведения журнала ключей первым делом подключите Azure CLI к нужному управляемому устройству HSM.

```azurecli-interactive
az login
```

Дополнительные сведения о параметрах входа с помощью интерфейса командной строки см. в статье [Вход с помощью Azure CLI](/cli/azure/authenticate-azure-cli?view=azure-cli-latest&preserve-view=true).

Возможно, придется дополнительно указать ту подписку, в которой вы создали управляемое устройство HSM. Чтобы увидеть подписки для своей учетной записи, введите следующую команду:

## <a name="identify-the-managed-hsm-and-storage-account"></a>Определение управляемого устройства HSM и учетной записи хранения

```azurecli-interactive
hsmresource=$(az keyvault show --hsm-name ContosoMHSM --query id -o tsv)
storageresource=$(az storage account show --name ContosoMHSMLogs --query id -o tsv)
```

## <a name="enable-logging"></a>Включение ведения журналов

Чтобы включить ведение журнала для управляемого устройства HSM, выполните команду **az monitor diagnostic-settings create** с теми переменными, которые мы создали для новой учетной записи хранения и службы "Управляемое устройство HSM". Мы также установим для флага **-Enabled** значение **$true** и зададим категорию **AuditEvent** (единственная доступная категория для ведения журнала службы "Управляемое устройство HSM").

Эти выходные данные подтверждают, что для службы "Управляемое устройство HSM" включено ведение журнала и данные сохраняются в указанной учетной записи хранения.

При желании вы можете задать для журналов политику хранения, например для автоматического удаления старых журналов. Например, для политики хранения можно присвоить флагу **-RetentionEnabled** значение **$true**, а параметру **-RetentionInDays** — значение **90**, чтобы автоматически удалять журналы, которые хранятся более 90 дней.

```azurecli-interactive
az monitor diagnostic-settings create --name ContosoMHSM-Diagnostics --resource $hsmresource --logs '[{"category": "AuditEvent","enabled": true}]' --storage-account $storageresource
```

Регистрируются следующие данные:

* все прошедшие проверку подлинности запросы REST API, включая запросы, ставшие неудачными из-за определенных разрешений на доступ, системных ошибок или неправильных запросов;
* все операции с самим управляемым устройством HSM, включая создание, удаление и обновление атрибутов, например тегов;
* операции, связанные с доменом безопасности, включая инициализацию со скачиванием, инициализацию с восстановлением и загрузку;
* операции полного резервного копирования, полного и выборочного восстановления HSM;
* операции с ключами, в том числе следующие:
  * создание, изменение или удаление ключей;
  * подписывание, проверка, шифрование и расшифровка, упаковка и распаковка, получение списка ключей;
  * резервное копирование, восстановление и безвозвратное удаление ключей.
* непроверенные запросы, которые приводят к появлению ответа 401 (например, запросы без токена носителя, с недействительным токеном, а также запросы неправильного формата или просроченные запросы).  

## <a name="access-your-logs"></a>Доступ к журналам

Журналы службы "Управляемое устройство HSM" сохраняются в контейнере **insights-logs-auditevent** в указанной вами учетной записи хранения. Чтобы просмотреть эти журналы, скачайте большие двоичные объекты. Сведения о службе хранилища Azure см. в статье [Создание, скачивание и составление списка больших двоичных объектов с помощью Azure CLI](../../storage/blobs/storage-quickstart-blobs-cli.md).

Отдельные BLOB-объекты хранятся как текст в формате JSON. Давайте рассмотрим пример записи журнала. Ниже приводится пример записи в журнале, созданной при запросе к управляемому устройству HSM на создание полной резервной копии.

```json
[
  {
    "TenantId": "766eaf62-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "time": "2020-08-31T19:52:39.763Z",
    "resourceId": "/SUBSCRIPTIONS/A1BA9AAA-xxxx-xxxx-xxxx-xxxxxxxxxxxx/RESOURCEGROUPS/CONTOSORESOURCEGROUP/PROVIDERS/MICROSOFT.KEYVAULT/MANAGEDHSMS/CONTOSOMHSM",
    "operationName": "BackupCreate",
    "operationVersion": "7.0",
    "category": "AuditEvent",
    "resultType": "Success",
    "properties": {
        "PoolType": "M-HSM",
        "sku_Family": "B",
        "sku_Name": "Standard_B1"
    },
    "durationMs": 488,
    "callerIpAddress": "X.X.X.X",
    "identity": "{\"claim\":{\"appid\":\"04b07795-xxxx-xxxx-xxxx-xxxxxxxxxxxx\",\"http_schemas_microsoft_com_identity\":{\"claims\":{\"objectidentifier\":\"b1c52bf0-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"}},\"http_schemas_xmlsoap_org_ws_2005_05_identity\":{\"claims\":{\"upn\":\"admin@contoso.com\"}}}}",
    "clientInfo": "azsdk-python-core/1.7.0 Python/3.8.2 (Linux-4.19.84-microsoft-standard-x86_64-with-glibc2.29) azsdk-python-azure-keyvault/7.2",
    "correlationId": "8806614c-ebc3-11ea-9e9b-00155db778ad",
    "subnetId": "(unknown)",
    "httpStatusCode": 202,
    "PoolName": "mhsmdemo",
    "requestUri": "https://ContosoMHSM.managedhsm.azure.net/backup",
    "resourceGroup": "ContosoResourceGroup",
    "resourceProvider": "MICROSOFT.KEYVAULT",
    "resource": "ContosoMHSM",
    "resourceType": "managedHSMs"
  }
]
```

В следующей таблице перечислены имена и описания полей.

| Имя поля | Описание |
| --- | --- |
| **TenantId** | Идентификатор клиента Azure Active Directory для подписки, в которой создано управляемое устройство HSM. |
| **time** |Дата и время (в формате UTC). |
| **resourceId** |Идентификатор ресурса Azure Resource Manager. Для журналов управляемых устройств HSM он всегда имеет значение идентификатора ресурса этого управляемого устройства HSM. |
| **operationName** |Имя операции, как описано в следующей таблице. |
| **operationVersion** |Запрошенная клиентом версия REST API. |
| **category** |Тип результата. Для журналов управляемых устройств HSM единственным доступным значением является **AuditEvent**. |
| **resultType** |Результат запроса к REST API. |
| **properties** |Эта информация зависит от типа операции (**operationName**).|
| **resultSignature** |Состояние HTTP. |
| **resultDescription** |Дополнительное описание результата, если доступно. |
| **durationMs** |Время обслуживания запроса REST API в миллисекундах. Сюда не входит задержка сети, поэтому время, зарегистрированное на стороне клиента, может не соответствовать этому значению. |
| **callerIpAddress** |IP-адрес клиента, выполнившего запрос. |
| **correlationId** |Необязательный GUID, который клиент может передавать для сопоставления журналов на стороне клиента с журналами на стороне службы. |
| **identity** |Удостоверение из маркера, предоставляемое в запросе к REST API. Как правило, это "user" или "service principal". |
| **requestUri** | URI запроса к REST API. |
| **clientInfo** | 

## <a name="use-azure-monitor-logs"></a>Использование журналов Azure Monitor

Решение Key Vault в журналах Azure Monitor позволяет просматривать журналы **AuditEvent** для службы "Управляемое устройство HSM". В журналах Azure Monitor запросы по журналам используются для анализа данных и получения необходимых сведений. 

## <a name="next-steps"></a>Дальнейшие действия

- Изучите [рекомендации по подготовке и использованию управляемого устройства HSM](best-practices.md).
- Ознакомьтесь с процессами [резервного копирования и восстановления для управляемого устройства HSM](backup-restore.md).
