---
title: Как использовать обратимое удаление в Azure Key Vault с помощью PowerShell
description: Примеры использования обратимого удаления с фрагментами кода для PowerShell.
author: msmbaldwin
manager: barbkess
ms.service: key-vault
ms.topic: conceptual
ms.date: 03/19/2019
ms.author: mbaldwin
ms.openlocfilehash: d34ef1bb5bea6f5f099f7fa2a24ddec2362b44ea
ms.sourcegitcommit: 02d17ef9aff49423bef5b322a9315f7eab86d8ff
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/21/2019
ms.locfileid: "58336190"
---
# <a name="how-to-use-key-vault-soft-delete-with-powershell"></a>Как использовать обратимое удаление в Key Vault с помощью PowerShell

Функция обратимого удаления в Azure Key Vault позволяет восстанавливать удаленные хранилища и объекты хранилищ. В частности, обратимое удаление применяется в следующих сценариях:

- Поддержка восстанавливаемого удаления хранилища ключей
- Поддержка восстанавливаемого удаления объектов хранилища ключей (например, ключей, секретов и сертификатов).

## <a name="prerequisites"></a>Технические условия

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

- Azure PowerShell 1.0.0 или более поздней версии. Если этот инструмент у вас не установлен, чтобы установить его и связать с подпиской Azure, прочитайте [общие сведения об Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview). 

>[!NOTE]
> В вашу среду вместо правильной версии **может** загрузиться устаревшая версия хранилища ключей выходных данных файла форматирования PowerShell. Мы планируем обновить версию PowerShell і добавить в нее нужные исправления выходных данных файла форматирования. После этого мы обновим эту статью. Чтобы устранить эту проблему сейчас, сделайте следующее:
> - Если вы не видите, что свойство обратимого удаления (описанное в этом разделе) включено, используйте следующий запрос: `$vault = Get-AzKeyVault -VaultName myvault; $vault.EnableSoftDelete`.


Дополнительные сведения о Key Vault для PowerShell см. в [справочнике по PowerShell для Azure Key Vault](/powershell/module/az.keyvault).

## <a name="required-permissions"></a>Необходимые разрешения

Операции Key Vault контролируются отдельно, посредством разрешений управления доступом на основе ролей (RBAC). Это осуществляется следующим образом.

| Операция | ОПИСАНИЕ | Разрешение пользователя |
|:--|:--|:--|
|список|Выводит список удаленных хранилищ ключей.|Microsoft.KeyVault/deletedVaults/read|
|Recover|Восстанавливает удаленное хранилище ключей.|Microsoft.KeyVault/vaults/write|
|Purge|Окончательно удаляет удаленное хранилище ключей и все его содержимое.|Microsoft.KeyVault/locations/deletedVaults/purge/action|

Дополнительные сведения о разрешениях и управлении доступом см. в разделе [Защита хранилища ключей](key-vault-secure-your-key-vault.md).

## <a name="enabling-soft-delete"></a>Включение обратимого удаления

Включите обратимое удаление, чтобы разрешить восстановление удаленного хранилища ключей или хранящихся в нем объектов.

> [!IMPORTANT]
> Включение обратимого удаления в хранилище ключей необратимо. После установки для свойства обратимого удаления значения true его нельзя изменить или удалить.  

### <a name="existing-key-vault"></a>Существующее хранилище ключей

Включите обратимое удаление для существующего хранилища ключей ContosoVault следующим образом. 

```powershell
($resource = Get-AzResource -ResourceId (Get-AzKeyVault -VaultName "ContosoVault").ResourceId).Properties | Add-Member -MemberType "NoteProperty" -Name "enableSoftDelete" -Value "true"

Set-AzResource -resourceid $resource.ResourceId -Properties $resource.Properties
```

### <a name="new-key-vault"></a>Новое хранилище ключей

Обратимое удаление для нового хранилища ключей включается во время создания путем добавления флага --enable-soft-delete в команду create.

```powershell
New-AzKeyVault -Name "ContosoVault" -ResourceGroupName "ContosoRG" -Location "westus" -EnableSoftDelete
```

### <a name="verify-soft-delete-enablement"></a>Проверка включения обратимого удаления

Чтобы проверить, включено ли обратимое удаление в хранилище ключей, выполните команду *show* и в выходных данных найдите атрибут "Soft Delete Enabled?" :

```powershell
Get-AzKeyVault -VaultName "ContosoVault"
```

## <a name="deleting-a-soft-delete-protected-key-vault"></a>Удаление хранилища ключей, защищенного через обратимое удаление

В зависимости от того, включено ли обратимое удаление, поведение команды для удаления хранилища ключей может изменяться.

> [!IMPORTANT]
>Если выполнить следующую команду для хранилища ключей, в котором не включено обратимое удаление, оно и его содержимое будут окончательно удалены без возможности восстановления.

```powershell
Remove-AzKeyVault -VaultName 'ContosoVault'
```

### <a name="how-soft-delete-protects-your-key-vaults"></a>Как обратимое удаление защищает хранилище ключей

Если обратимое удаление включено:

- При удалении хранилище ключей удаляется из соответствующей группы ресурсов и помещается в зарезервированное пространство имен, которое связано с расположением, в котором оно было создано. 
- Удаленные объекты, такие как ключи, секреты и сертификаты, становятся недоступными и остаются таковыми, пока содержащее их хранилище ключей пребывает в удаленном состоянии. 
- DNS-имя удаленного хранилища ключей зарезервировано, что предотвращает создание хранилища ключей с тем же именем.  

Чтобы просмотреть хранилища ключей в удаленном состоянии, связанные с вашей подпиской, можно выполнить следующую команду.

```powershell
Get-AzKeyVault -InRemovedState 
```

- *Идентификатор* можно использовать для определения ресурса при восстановлении или очистке. 
- *Идентификатор ресурса* — это исходный идентификатор ресурса этого хранилища. Так как это хранилище ключей теперь находится в удаленном состоянии, ресурс с таким идентификатором ресурса не существует. 
- Поле *запланированной даты очистки* указывает, когда хранилище ключей будет окончательно удалено, если не предпринять какое-либо действие. Срок хранения по умолчанию, используемый для вычисления *запланированной даты очистки*, составляет 90 дней.

## <a name="recovering-a-key-vault"></a>Восстановление хранилища ключей

Чтобы восстановить хранилище ключей, необходимо указать его имя, группу ресурсов и расположение. Запишите расположение и группу ресурсов удаленного хранилища ключей, так как их необходимо знать, чтобы осуществить восстановление.

```powershell
Undo-AzKeyVaultRemoval -VaultName ContosoVault -ResourceGroupName ContosoRG -Location westus
```

После восстановления хранилища ключей вы получите новый ресурс с исходным идентификатором ресурса хранилища ключей. Если исходная группа ресурсов удалена, то прежде чем выполнить восстановление, нужно создать группу ресурсов с тем же именем.

## <a name="deleting-and-purging-key-vault-objects"></a>Удаление и очистка объектов хранилища ключей

Приведенная ниже команда удалит ключ ContosoFirstKey из хранилища ключей ContosoVault, в котором включено обратимое удаление:

```powershell
Remove-AzKeyVaultKey -VaultName ContosoVault -Name ContosoFirstKey
```

Если в хранилище ключей включено обратимое удаление, то удаленный ключ отображается как удаленный, пока вы явным образом не выведите список удаленных ключей. Большинство операций с ключом в удаленном состоянии завершится сбоем, кроме вывода списка удаленных ключей, их восстановления или удаления. 

Например, запросить список удаленных ключей в хранилище ключей можно с помощью следующей команды:

```powershell
Get-AzKeyVaultKey -VaultName ContosoVault -InRemovedState
```

### <a name="transition-state"></a>Переходное состояние 

Удаление ключа в хранилище ключей, в котором включено обратимое удаление, может занять несколько секунд. Во время этого перехода может создаться впечатление, что ключ не находится ни в активном, ни в удаленном состоянии. 

### <a name="using-soft-delete-with-key-vault-objects"></a>Использование обратимого удаления с объектами хранилища ключей

Как и хранилища ключей, удаленный ключ, секрет или сертификат останется в удаленном состоянии в течение 90 дней, если его не восстановить или не очистить. 

#### <a name="keys"></a>ключей

Чтобы восстановить обратимо удаленный ключ, выполните команду, указанную ниже:

```powershell
Undo-AzKeyVaultKeyRemoval -VaultName ContosoVault -Name ContosoFirstKey
```

Чтобы удалить без возможности восстановления обратимо удаленный ключ, выполните команду, указанную ниже:

> [!IMPORTANT]
> Очистка ключа приведет к его окончательному удалению, то есть восстановить его будет невозможно. 

```powershell
Remove-AzKeyVaultKey -VaultName ContosoVault -Name ContosoFirstKey -InRemovedState
```

Для действий **восстановления** и **очистки** в политике доступа хранилища ключей заданы собственные разрешения. Чтобы пользователь или субъект-служба могли выполнить **восстановление** или **очистку**, они должны иметь соответствующее разрешение для этого ключа или секрета. По умолчанию разрешение на **очистку** не добавляется в политику доступа хранилища ключей, если для предоставления всех разрешений используется параметр "Все". Необходимо отдельно предоставить разрешение на **очистку**. 

#### <a name="set-a-key-vault-access-policy"></a>Настройка политики доступа хранилища ключей

Приведенная ниже команда предоставляет разрешение user@contoso.com на выполнение нескольких операций с ключами в *ContosoVault*, включая **очистку**.

```powershell
Set-AzKeyVaultAccessPolicy -VaultName ContosoVault -UserPrincipalName user@contoso.com -PermissionsToKeys get,create,delete,list,update,import,backup,restore,recover,purge
```

>[!NOTE] 
> Если у вас есть хранилище ключей, в котором только что было включено обратимое удаление, то у вас может не быть разрешений на **восстановление** и **очистку**.

#### <a name="secrets"></a>Секреты

Секретами (как и ключами) можно управлять с помощью специальных команд:

- Удаление секрета SQLPassword. 
  ```powershell
  Remove-AzKeyVaultSecret -VaultName ContosoVault -name SQLPassword
  ```

- Вывод списка всех удаленных секретов в хранилище ключей. 
  ```powershell
  Get-AzKeyVaultSecret -VaultName ContosoVault -InRemovedState
  ```

- Восстановление секрета в удаленном состоянии. 
  ```powershell
  Undo-AzKeyVaultSecretRemoval -VaultName ContosoVault -Name SQLPAssword
  ```

- Очистка секрета в удаленном состоянии. 

  > [!IMPORTANT]
  > Очистка секрета приведет к его окончательному удалению, то есть восстановить его будет невозможно.

  ```powershell
  Remove-AzKeyVaultSecret -VaultName ContosoVault -InRemovedState -name SQLPassword
  ```

## <a name="purging-a-soft-delete-protected-key-vault"></a>Очистка хранилища ключей, защищенного через обратимое удаление

> [!IMPORTANT]
> Очистка хранилища ключей или одного из содержащихся в нем объектов приведет к его окончательному удалению, то есть восстановить его будет невозможно.

Функция очистки используется, чтобы полностью удалить объект хранилища ключей или всей хранилища ключей, который был ранее обратимо удаленные. Как показано в предыдущем разделе, объекты, содержащиеся в хранилище ключей со включенной функцией обратимого удаления, могут быть в нескольких состояниях:
- **Активные**: перед удалением.
- **Обратимо удалены**: после удаления; можно отобразить в списке и вернуть обратно в активное состояние.
- **Окончательно удалены**: после очистки; невозможно восстановить.


То же самое относится и к хранилищу ключей. Чтобы окончательно удалить обратимо удаленное хранилище ключей и его содержимое, необходимо очистить само хранилище ключей.

### <a name="purging-a-key-vault"></a>Очистка хранилища ключей

При очистке хранилища ключей все его содержимое, включая ключи, секреты и сертификаты, удаляется без возможности восстановления. Чтобы очистить обратимо удаленное хранилище ключей, используйте команду `Remove-AzKeyVault` с параметром `-InRemovedState`, указав расположение удаленного хранилища ключей в аргументе `-Location location`. Расположение удаленного хранилища можно найти с помощью команды `Get-AzKeyVault -InRemovedState`.

```powershell
Remove-AzKeyVault -VaultName ContosoVault -InRemovedState -Location westus
```

### <a name="purge-permissions-required"></a>Необходимые разрешения на очистку
- Чтобы очистить удаленное хранилище ключей, пользователю нужно разрешение RBAC на выполнение операции *Microsoft.KeyVault/locations/deletedVaults/purge/action*. 
- Чтобы вывести в списке удаленное хранилище ключей, пользователю нужно разрешение RBAC на выполнение операции *Microsoft.KeyVault/deletedVaults/read*. 
- По умолчанию администратор подписки имеет эти разрешения. 

### <a name="scheduled-purge"></a>Очистка по расписанию

При выводе списка объектов удаленного хранилища ключей также отображается запланированное время их очистки службой Key Vault. Поле *запланированной даты очистки* указывает, когда объект хранилища ключей будет окончательно удален, если не предпринять какое-либо действие. По умолчанию срок хранения объекта удаленного хранилища ключей составляет 90 дней.

>[!IMPORTANT]
>После очистки объекта хранилища, активированной значением его поля *Scheduled Purge Date* (Запланированная дата очистки), этот объект будет окончательно удален. Восстановить его будет невозможно.

## <a name="enabling-purge-protection"></a>Включение защиты от очистки

При использовании очистки защиты в хранилище или объект в удаленных не удается очистить состояние, пока не истечет срок 90 дней. Такое хранилище или его объект все еще подлежат восстановлению. Этот компонент предоставляет ли он хранилища или объект не может быть окончательно удалить, пока срок хранения период истек.

Защита от очистки можно включить только в том случае, если обратимого удаления включена. 

Чтобы включить оба обратимое удаление и очистку защиты при создании хранилища, используйте [New AzKeyVault](/powershell/module/az.keyvault/new-azkeyvault?view=azps-1.5.0) командлета:

```powershell
New-AzKeyVault -Name ContosoVault -ResourceGroupName ContosoRG -Location westus -EnableSoftDelete -EnablePurgeProtection
```

Для добавления защиты от очистки для существующего хранилища (с уже включенным обратимым удалением) введите [Get-AzKeyVault](/powershell/module/az.keyvault/Get-AzKeyVault?view=azps-1.5.0), [Get-AzResource](/powershell/module/az.resources/get-azresource?view=azps-1.5.0), и [AzResource набора](/powershell/module/az.resources/set-azresource?view=azps-1.5.0) командлетов:

```
($resource = Get-AzResource -ResourceId (Get-AzKeyVault -VaultName "ContosoVault").ResourceId).Properties | Add-Member -MemberType "NoteProperty" -Name "enablePurgeProtection" -Value "true"

Set-AzResource -resourceid $resource.ResourceId -Properties $resource.Properties
```

## <a name="other-resources"></a>Другие ресурсы:

- Обзор функции обратимого удаления Key Vault см. в разделе [Общие сведения об обратимом удалении в Azure Key Vault](key-vault-ovw-soft-delete.md).
- Общие сведения об использовании хранилища ключей Azure, см. в разделе [что такое хранилище ключей Azure?](key-vault-overview.md). ate = успешное выполнение}