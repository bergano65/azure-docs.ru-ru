---
title: Включение ведения журнала диагностики
description: Узнайте, как включить ведение журналов диагностики и добавить инструментирование в приложение, а также, как получить доступ к данным журналов Azure.
ms.assetid: c9da27b2-47d4-4c33-a3cb-1819955ee43b
ms.topic: article
ms.date: 09/17/2019
ms.custom: seodec18
ms.openlocfilehash: 54435dd21fccdd43f17d13674b324b989a00f7a1
ms.sourcegitcommit: 48b7a50fc2d19c7382916cb2f591507b1c784ee5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/02/2019
ms.locfileid: "74684258"
---
# <a name="enable-diagnostics-logging-for-apps-in-azure-app-service"></a>Включение ведения журнала диагностики для приложений в Службе приложений Azure
## <a name="overview"></a>Краткое описание
В Azure доступны встроенные средства диагностики для отладки [приложения Службы приложений](overview.md). Из этой статьи вы узнаете, как включить ведение журналов диагностики и добавить инструментирование в свое приложение, а также как получить доступ к данным журналов Azure.

В этой статье используется [портал Azure](https://portal.azure.com) и Azure CLI для работы с журналами диагностики. Дополнительные сведения о работе с журналами диагностики с использованием Visual Studio см. в статье [Устранение неполадок Azure в Visual Studio](troubleshoot-dotnet-visual-studio.md).

> [!NOTE]
> В дополнение к инструкциям по ведению журнала в этой статье есть новая интегрированная возможность ведения журнала с помощью мониторинга Azure. Дополнительные сведения об этой возможности см. в разделе [отправка журналов в Azure Monitor (Предварительная версия)](#send-logs-to-azure-monitor-preview) . 
>
>

|Тип|платформа|Location|Описание|
|-|-|-|-|
| Ведение журнала приложения | Windows, Linux | Файловая система службы приложений и (или) BLOB-объекты хранилища Azure | Записывает в журнал сообщения, создаваемые кодом приложения. Сообщения могут создаваться с помощью выбранной веб-платформы или из кода приложения непосредственно с использованием стандартного шаблона ведения журнала на языке. Каждому сообщению назначается одна из следующих категорий: **критическая**, **Ошибка**, **предупреждение**, **информация**, **Отладка**и **Трассировка**. Вы можете выбрать, какой уровень детализации должен быть протоколирован, установив степень серьезности при включении ведения журнала приложения.|
| Ведение журнала веб-сервера| Windows | Файловая система службы приложений или большие двоичные объекты хранилища Azure| Необработанные данные HTTP-запросов в [расширенном формате файла журнала W3C](/windows/desktop/Http/w3c-logging). Каждое сообщение журнала содержит такие данные, как метод HTTP, URI ресурса, IP-адрес клиента, порт клиента, агент пользователя, код ответа и т. д. |
| Подробное ведение журнала ошибок | Windows | Файловая система службы приложений | Копии *htm* страниц ошибок, которые были бы отправлены в браузер клиента. По соображениям безопасности подробные страницы ошибок не должны отправляться клиентам в рабочей среде, но служба приложений может сохранить страницу ошибки при каждом возникновении ошибки приложения с кодом HTTP 400 или более поздней. Страница может содержать сведения, которые могут помочь определить причину, по которой сервер возвращает код ошибки. |
| Трассировка невыполненных запросов | Windows | Файловая система службы приложений | Подробные сведения трассировки для неудачных запросов, включая трассировку компонентов IIS, используемых для обработки запроса, и время, затраченное на каждый компонент. Это полезно, если вы хотите повысить производительность веб-сайта или определить конкретную ошибку HTTP. Одна папка создается для каждого невыполненного запроса, содержащего XML-файл журнала, и таблицы стилей XSL для просмотра файла журнала с помощью. |
| Ведение журнала развертывания | Windows, Linux | Файловая система службы приложений | Регистрируется при публикации содержимого в приложении. Ведение журнала развертывания выполняется автоматически, а настраиваемые параметры для ведения журнала развертывания отсутствуют. Это помогает определить причину сбоя развертывания. Например, при использовании [пользовательского скрипта развертывания](https://github.com/projectkudu/kudu/wiki/Custom-Deployment-Script)можно использовать ведение журнала развертывания, чтобы определить причину сбоя сценария. |

> [!NOTE]
> Служба приложений предоставляет специализированное интерактивное средство диагностики, помогающее устранить неполадки в приложении. Дополнительные сведения см. в статье [Обзор диагностики службы приложений Azure](overview-diagnostics.md).
>
> Кроме того, можно использовать другие службы Azure для улучшения ведения журнала и мониторинга приложения, например [Azure Monitor](../azure-monitor/app/azure-web-apps.md).
>

## <a name="enable-application-logging-windows"></a>Включение ведения журнала приложений (Windows)

Чтобы включить ведение журнала приложений для приложений Windows в [портал Azure](https://portal.azure.com), перейдите к своему приложению и выберите **журналы службы приложений**.

Выберите **On** для **ведения журнала приложений (файловая система)** или **приложения (BLOB)** или и того, и другого. 

Параметр **FileSystem** предназначен для временных целей отладки и включается в течение 12 часов. Параметр **большого двоичного объекта** предназначен для долгосрочного ведения журнала, и для записи журналов требуется контейнер хранилища BLOB-объектов.  Параметр **BLOB-объекта** также содержит дополнительные сведения в сообщениях журнала, например идентификатор исходного экземпляра виртуальной машины сообщения журнала (`InstanceId`), идентификатор потока (`Tid`) и более детализированную метку времени ([`EventTickCount`](https://docs.microsoft.com/dotnet/api/system.datetime.ticks)).

> [!NOTE]
> Сейчас в хранилище BLOB-объектов можно записывать только журналы приложения .NET. Приложения Java, PHP, Node. js, журналы приложений Python могут храниться только в файловой системе службы приложений (без изменений кода для записи журналов во внешнее хранилище).
>
> Кроме того, при [повторном создании ключей доступа к учетной записи хранения](../storage/common/storage-create-storage-account.md)необходимо сбросить соответствующую конфигурацию ведения журнала, чтобы использовать обновленные ключи доступа. Для этого:
>
> 1. На вкладке **Настройка** установите значение **Выключено** для соответствующего компонента ведения журнала. Сохраните вашу настройку.
> 2. Снова включите ведение журнала для большого двоичного объекта учетной записи хранения. Сохраните вашу настройку.
>
>

Выберите **уровень**или уровень детализации для записи в журнал. В следующей таблице приведены категории журналов, входящие в каждый уровень.

| уровень | Включаемые категории |
|-|-|
|**Отключено** | Нет |
|**Ошибка** | "Ошибка", "Критические" |
|**Предупреждение;** | "Предупреждение", "Ошибка", "Критические"|
|**Сведения** | "Информация", "Предупреждение", "Ошибка", "Критические"|
|**Подробный** | "Трассировка", "Отладка", "Информация", "Предупреждение", "Ошибка", "Критические" (все категории) |

По завершении нажмите кнопку **сохранить**.

## <a name="enable-application-logging-linuxcontainer"></a>Включить ведение журнала приложений (Linux или контейнер)

Чтобы включить ведение журнала приложений для приложений Linux или настраиваемых приложений контейнеров в [портал Azure](https://portal.azure.com), перейдите к своему приложению и выберите **журналы службы приложений**.

В окне **ведение журнала приложений**выберите **Файловая система**.

В поле **квота (МБ)** укажите квоту диска для журналов приложений. В поле **срок хранения (в днях)** укажите число дней, в течение которых должны храниться журналы.

По завершении нажмите кнопку **сохранить**.

## <a name="enable-web-server-logging"></a>Включение ведения журналов веб-сервера

Чтобы включить ведение журнала веб-сервера для приложений Windows в [портал Azure](https://portal.azure.com), перейдите к своему приложению и выберите **журналы службы приложений**.

Для **ведения журнала веб-сервера**выберите **хранилище** для хранения журналов в хранилище больших двоичных объектов или **Файловая система** для хранения журналов в файловой системе службы приложений. 

В поле **срок хранения (в днях)** укажите число дней, в течение которых должны храниться журналы.

> [!NOTE]
> Если вы [создаете повторно ключи доступа учетной записи хранения](../storage/common/storage-create-storage-account.md), то необходимо сбросить соответствующую конфигурацию ведения журнала, чтобы использовать обновленные ключи. Для этого:
>
> 1. На вкладке **Настройка** установите значение **Выключено** для соответствующего компонента ведения журнала. Сохраните вашу настройку.
> 2. Снова включите ведение журнала для большого двоичного объекта учетной записи хранения. Сохраните вашу настройку.
>
>

По завершении нажмите кнопку **сохранить**.

## <a name="log-detailed-errors"></a>Подробные сведения об ошибках в журнале

Чтобы сохранить страницу ошибки или трассировку невыполненных запросов для приложений Windows в [портал Azure](https://portal.azure.com), перейдите к своему приложению и выберите **журналы службы приложений**.

В разделе **подробный журнал ошибок** или **Трассировка неудачных запросов**выберите **вкл**., а затем нажмите кнопку **сохранить**.

Оба типа журналов хранятся в файловой системе службы приложений. Сохраняются до 50 ошибок (файлов и папок). Если число HTML-файлов превышает 50, самые старые ошибки из 26 автоматически удаляются.

## <a name="add-log-messages-in-code"></a>Добавление сообщений журнала в код

В коде приложения для отправки сообщений журнала в журналы приложений используются обычные средства ведения журнала. Пример.

- Приложения ASP.NET могут использовать класс [System.Diagnostics.Trace](/dotnet/api/system.diagnostics.trace) для записи информации в журнал диагностики приложений. Пример.

    ```csharp
    System.Diagnostics.Trace.TraceError("If you're seeing this, something bad happened");
    ```

- По умолчанию ASP.NET Core использует поставщик ведения журнала [Microsoft. Extensions. Logging. AzureAppServices](https://www.nuget.org/packages/Microsoft.Extensions.Logging.AzureAppServices) . Дополнительные сведения см. в разделе [о ведении журнала ASP.NET Core в Azure](https://docs.microsoft.com/aspnet/core/fundamentals/logging/).

## <a name="stream-logs"></a>Журналы потоковой передачи

Прежде чем выполнять потоковую передачу журналов в режиме реального времени, включите нужный тип журнала. Любая информация, записанная в файлы с расширением. txt,. log или. htm, которые хранятся в каталоге */LogFiles* (d:/Home/файл_журнала), передается службой приложений в потоковом режиме.

> [!NOTE]
> Некоторые типы буфера журнала записывают данные в файл журнала, что может привести к нарушению порядка событий в потоке. Например, запись в журнале приложений, возникающая при посещении пользователем страницы, может отображаться в потоке перед соответствующей записью журнала HTTP о запросе страницы.
>

### <a name="in-azure-portal"></a>На портале Azure

Чтобы выполнить потоковую передачу журналов в [портал Azure](https://portal.azure.com), перейдите к своему приложению и выберите **Журнал поток**. 

### <a name="in-cloud-shell"></a>В Cloud Shell

Чтобы выполнить потоковую передачу журналов в [Cloud Shell](../cloud-shell/overview.md), используйте следующую команду:

```azurecli-interactive
az webapp log tail --name appname --resource-group myResourceGroup
```

Чтобы отфильтровать определенные события, например ошибки, используйте параметр **--Filter** . Пример.

```azurecli-interactive
az webapp log tail --name appname --resource-group myResourceGroup --filter Error
```
Чтобы отфильтровать определенные типы журналов, например HTTP, используйте параметр **--Path** . Пример.

```azurecli-interactive
az webapp log tail --name appname --resource-group myResourceGroup --path http
```

### <a name="in-local-terminal"></a>В локальном терминале

Чтобы выполнить потоковую передачу журналов в локальной консоли, [установите Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli) и [Войдите в свою учетную запись](https://docs.microsoft.com/cli/azure/authenticate-azure-cli). После входа введите [инструкции для Cloud Shell](#in-cloud-shell)

## <a name="access-log-files"></a>Файлы журнала доступа

При настройке параметра BLOB-объектов службы хранилища Azure для типа журнала требуется клиентское средство, которое работает со службой хранилища Azure. Дополнительные сведения см. в статье [клиентские средства службы хранилища Azure](../storage/common/storage-explorers.md).

Для журналов, хранящихся в файловой системе службы приложений, самый простой способ — скачать ZIP-файл в браузере по адресу:

- Приложения для Linux и контейнеров: `https://<app-name>.scm.azurewebsites.net/api/logs/docker/zip`
- Приложения Windows: `https://<app-name>.scm.azurewebsites.net/api/dump`

Для приложений Linux и контейнеров ZIP-файл содержит журналы вывода консоли как для узла DOCKER, так и для контейнера DOCKER. Для масштабируемого приложения ZIP-файл содержит один набор журналов для каждого экземпляра. В файловой системе службы приложений эти файлы журналов являются содержимым каталога */Хоме/логфилес* .

Для приложений Windows ZIP-файл содержит содержимое каталога *д:\хоме\логфилес* в файловой системе службы приложений. Он имеет следующую структуру:

| Тип журнала | Каталог | Описание |
|-|-|-|
| **Журналы приложений** |*/логфилес/аппликатион/* | Содержит один или несколько текстовых файлов. Формат сообщений журнала зависит от используемого поставщика ведения журнала. |
| **Трассировки неудачных запросов** | */LogFiles/W3SVC # # # # # # # # #/* | Содержит файлы XML и XSL-файл. Отформатированные XML-файлы можно просмотреть в браузере. |
| **Подробные журналы ошибок** | */логфилес/детаиледеррорс/* | Содержит файлы ошибок HTM. Файлы HTM можно просматривать в браузере.<br/>Другим способом просмотра трассировок неудачных запросов является переход на страницу приложения на портале. В меню слева выберите **Диагностика и устранение проблем**, а затем найдите **журналы трассировки неудачно завершенных запросов**, а затем щелкните значок, чтобы просмотреть и посмотреть нужную трассировку. |
| **Журналы веб-сервера** | */логфилес/хттп/равлогс/* | Содержит текстовые файлы, отформатированные с использованием [расширенного формата файла журнала W3C](/windows/desktop/Http/w3c-logging). Эти сведения можно прочитать с помощью текстового редактора или служебной программы, такой как [средство синтаксического анализа журналов](https://go.microsoft.com/fwlink/?LinkId=246619).<br/>Служба приложений не поддерживает поля `s-computername`, `s-ip`или `cs-version`. |
| **Журналы развертывания** | */Логфилес/ГИТ/* и */деплойментс/* | Содержат журналы, созданные внутренними процессами развертывания, а также журналы для развертываний Git. |

## <a name="send-logs-to-azure-monitor-preview"></a>Отправка журналов в Azure Monitor (Предварительная версия)

С помощью новой [интеграции Azure Monitor](https://aka.ms/appsvcblog-azmon)можно [создать параметры диагностики (Предварительная версия)](https://azure.github.io/AppService/2019/11/01/App-Service-Integration-with-Azure-Monitor.html#create-a-diagnostic-setting) для отправки журналов в учетные записи хранения, концентраторы событий и log Analytics. 

> [!div class="mx-imgBorder"]
> ![параметры диагностики (Предварительная версия)](media/troubleshoot-diagnostic-logs/diagnostic-settings-page.png)

### <a name="supported-log-types"></a>Поддерживаемые типы журналов

В следующей таблице приведены поддерживаемые типы журналов и их описания. 

| Тип журнала | Поддержка Windows | Поддержка Linux (DOCKER) | Описание |
|-|-|-|
| AppServiceConsoleLogs | Будет объявлено | ДА | Стандартный вывод и стандартная ошибка |
| AppServiceHTTPLogs | ДА | ДА | Журналы веб-сервера |
| AppServiceEnvironmentPlatformLogs | ДА | ДА | Среда службы приложений: масштабирование, изменение конфигурации и журналы состояния|
| AppServiceAuditLogs | ДА | ДА | Действия входа через FTP и KUDU |
| AppServiceFileAuditLogs | Будет объявлено | Будет объявлено | Изменения файлов с помощью FTP и KUDU |
| AppServiceAppLogs | Будет объявлено | Java SE & Tomcat | Журналы приложений |

## <a name="nextsteps"></a>Дальнейшие действия
* [Журналы запросов с Azure Monitor](../azure-monitor/log-query/log-query-overview.md)
* [Мониторинг приложений в Службе приложений Azure](web-sites-monitor.md)
* [Troubleshoot an app in Azure App Service using Visual Studio](troubleshoot-dotnet-visual-studio.md) (Устранение неполадок приложения в Службе приложений Azure с помощью Visual Studio)
* [Анализ журналов приложения в HDInsight](https://gallery.technet.microsoft.com/scriptcenter/Analyses-Windows-Azure-web-0b27d413)
