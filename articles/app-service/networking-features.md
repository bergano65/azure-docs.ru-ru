---
title: Функции развертывания сетей в службе приложений Azure | Документация Майкрософт
description: Как использовать различные сетевые функции службы приложений
author: ccompy
manager: stefsch
editor: ''
services: app-service\web
documentationcenter: ''
ms.assetid: 5c61eed1-1ad1-4191-9f71-906d610ee5b7
ms.service: app-service-web
ms.workload: web
ms.tgt_pltfrm: na
ms.topic: article
ms.date: 05/28/2019
ms.author: ccompy
ms.custom: seodec18
ms.openlocfilehash: 102f3e131b20534dc2f192b6485a3fdc95070315
ms.sourcegitcommit: c22327552d62f88aeaa321189f9b9a631525027c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2019
ms.locfileid: "73470265"
---
# <a name="app-service-networking-features"></a>Сетевые функции службы приложений

Приложения в службе приложений Azure можно развертывать несколькими способами. По умолчанию размещенные приложения службы приложений доступны непосредственно в Интернете и могут быть доступны только в конечных точках, размещенных в Интернете. Однако многим приложениям клиента необходимо управлять входящим и исходящим сетевым трафиком. В службе приложений доступно несколько функций для удовлетворения этих потребностей. Сложность заключается в том, какую функцию следует использовать для решения данной проблемы. Этот документ предназначен для того, чтобы помочь клиентам определить, какую функцию следует использовать на основе некоторых примеров вариантов использования.

Существует два основных типа развертывания для службы приложений Azure. Существует общедоступная служба, которая размещает планы службы приложений в категории "бесплатный", "общий", "базовый", "Стандартный", "Премиум" и "категории премиум v2". Затем имеется один клиентский Среда службы приложений (ASE), который размещает планы службы приложений изолированного SKU непосредственно в виртуальной сети Azure. Используемые функции будут зависеть от того, находится ли вы в службе с несколькими клиентами или в ASE. 

## <a name="multi-tenant-app-service-networking-features"></a>Сетевые возможности службы приложений с несколькими клиентами 

Служба приложений Azure — это распределенная система. Роли, обрабатывающие входящие запросы HTTP/HTTPS, называются внешними интерфейсами. Роли, в которых размещается Рабочая нагрузка клиента, называются рабочими процессами. Все роли в развертывании службы приложений существуют в сети с несколькими клиентами. Так как в одной единице масштабирования службы приложений существует много различных клиентов, вы не сможете подключить сеть службы приложений непосредственно к вашей сети. Вместо подключения к сетям нам нужны функции для управления различными аспектами взаимодействия приложений. Функции, которые обрабатывали запросы к приложению, нельзя использовать для решения проблем при выполнении вызовов из приложения. Аналогичным образом функции, устраняющие проблемы с вызовами из приложения, нельзя использовать для решения проблем в приложении.  

| Входящие функции | Исходящие функции |
|---------------------|-------------------|
| Адрес, назначенный приложению | через гибридные подключения |
| Ограничения доступа | Интеграция виртуальной сети, требуемой шлюзом |
| Конечные точки службы | Интеграция с виртуальной сетью (Предварительная версия) |

Если не указано иное, все функции можно использовать вместе. Вы можете сочетать функции для решения различных проблем.

## <a name="use-case-and-features"></a>Вариант использования и возможности

Для любого конкретного варианта использования может быть несколько способов решения проблемы.  Подходящая функция иногда может быть вызвана не только самим вариантом использования. В следующих примерах использования входящих сообщений предполагается использование сетевых функций службы приложений для решения проблем, связанных с управлением трафиком, передаваемых в приложение. 
 
| Варианты использования входящих подключений | Функция |
|---------------------|-------------------|
| Поддержка требований SSL на основе IP для вашего приложения | Адрес, назначенный приложению |
| Нет общего доступа, выделенный входящий адрес для приложения | Адрес, назначенный приложению |
| Ограничение доступа к приложению из набора четко определенных адресов | Ограничения доступа |
| Предоставить мое приложение на частных IP-адресах в моей виртуальной сети | Среда ASE с ILB </br> Шлюз приложений с конечными точками службы |
| Ограничить доступ к моему приложению из ресурсов в виртуальной сети | Конечные точки службы </br> Среда ASE с ILB |
| Предоставить мое приложение на частном IP-адресе в виртуальной сети | Среда ASE с ILB </br> частный IP-адрес для входящего трафика в шлюзе приложений с конечными точками службы |
| Защита приложения с помощью WAF | Шлюз приложений + ILB ASE </br> Шлюз приложений с конечными точками службы </br> Передняя дверца Azure с ограничениями доступа |
| Балансировка нагрузки трафика в мои приложения в разных регионах | Передняя дверца Azure с ограничениями доступа | 
| Балансировка нагрузки трафика в одном регионе | Шлюз приложений с конечными точками службы | 

В следующих сценариях исходящего трафика показано, как использовать сетевые функции службы приложений для решения задач исходящего доступа к приложению. 

| Варианты использования исходящих подключений | Функция |
|---------------------|-------------------|
| Доступ к ресурсам в виртуальной Входящий сетевой трафик Azure в одном регионе | интеграция с виртуальной сетью; </br> ASE |
| Доступ к ресурсам в виртуальной Входящий сетевой трафик Azure в другом регионе | Интеграция виртуальной сети, требуемой шлюзом </br> ASE и пиринг виртуальных сетей |
| Доступ к ресурсам, защищенным с помощью конечных точек службы | интеграция с виртуальной сетью; </br> ASE |
| Доступ к ресурсам в частной сети, не подключенной к Azure | через гибридные подключения |
| Доступ к ресурсам через каналы ExpressRoute | Интеграция с виртуальной сетью (теперь для адресов RFC 1918 можно ограничить) </br> ASE | 


### <a name="default-networking-behavior"></a>Поведение сети по умолчанию

Единицы масштабирования службы приложений Azure поддерживают множество клиентов в каждом развертывании. Планы бесплатных и общих номеров SKU размещают рабочие нагрузки клиентов на рабочих процессах с несколькими клиентами. Базовые и вышеуказанные планы размещают рабочие нагрузки клиентов, предназначенные только для одного плана службы приложений (ASP). Если у вас есть стандартный план службы приложений, все приложения в этом плане будут выполняться в одном рабочем процессе. При горизонтальном масштабировании рабочей роли все приложения в этой среде ASP будут реплицированы на новый рабочий процесс для каждого экземпляра в ASP. Рабочие роли, используемые для категории премиум v2, отличаются от сотрудников, используемых в других планах. Каждое развертывание службы приложений имеет один IP-адрес, используемый для всего входящего трафика для приложений в этом развертывании службы приложений. Однако существует от 4 до 11 адресов, используемых для выполнения исходящих вызовов. Эти адреса являются общими для всех приложений в этом развертывании службы приложений. Исходящие адреса отличаются в зависимости от разных типов рабочих ролей. Это означает, что адреса, используемые на уровне Free, Shared, Basic, Standard и Premium планах ASP, отличаются от адресов, используемых для исходящих вызовов из категории премиум v2 планах ASP. Если просмотреть свойства приложения, можно просмотреть входящие и исходящие адреса, используемые приложением. Если необходимо заблокировать зависимость с помощью списка ACL IP-адресов, используйте Поссиблеаутбаундаддрессес. 

![Свойства приложения](media/networking-features/app-properties.png)

Служба приложений имеет ряд конечных точек, которые используются для управления службой.  Эти адреса публикуются в отдельном документе и также находятся в теге службы Аппсервицеманажемент IP. Тег Аппсервицеманажемент используется только с Среда службы приложений (ASE), где необходимо разрешить такой трафик. Входящие адреса службы приложений записываются в теге AppService IP Service. Отсутствует тег службы IP-адресов, содержащий исходящие адреса, используемые службой приложений. 

![Схема входящей и исходящей передачи службы приложений](media/networking-features/default-behavior.png)

### <a name="app-assigned-address"></a>Адрес, назначенный приложению 

Функция адреса, назначенного приложению, — это оффшут возможности SSL на основе IP-адресов, доступ к которой осуществляется путем настройки SSL в приложении. Эта функция может использоваться для вызовов SSL на основе IP-адресов, но ее также можно использовать, чтобы предоставить приложению только адрес. 

![Схема адресов, назначенных приложению](media/networking-features/app-assigned-address.png)

При использовании адреса, назначенного приложению, трафик по-прежнему проходит через те же роли внешнего интерфейса, которые обрабатывали весь входящий трафик в единицу масштабирования службы приложений. Адрес, назначенный приложению, тем не менее, используется приложением. Варианты использования этой функции:

* Поддержка требований SSL на основе IP для вашего приложения
* Задать выделенный адрес для приложения, который не является общим для других пользователей

Вы можете узнать, как задать адрес в приложении с помощью учебника по [настройке SSL на основе IP][appassignedaddress]. 

### <a name="access-restrictions"></a>Ограничения доступа 

Функция ограничений доступа позволяет фильтровать **Входящие** запросы на основе IP-адреса источника. Действие фильтрации выполняется на внешних ролях, которые находятся в потоке из рабочей роли, в которой выполняются приложения. Так как внешние роли являются вышестоящими от рабочих ролей, функции ограничений доступа можно рассматривать как защиту на уровне сети для приложений. Эта функция позволяет создать список блоков адресов allow и Deny, которые оцениваются в порядке приоритета. Она аналогична функции группы безопасности сети (NSG), которая существует в сети Azure.  Эту функцию можно использовать в ASE или в службе с несколькими клиентами. При использовании с ILB ASE можно ограничить доступ из частных блоков адресов.

![Ограничения доступа](media/networking-features/access-restrictions.png)

Функция ограничений доступа помогает в сценариях, где необходимо ограничить IP-адреса, которые могут использоваться для доступа к приложению. Ниже перечислены варианты использования этой функции.

* Ограничение доступа к приложению из набора четко определенных адресов 
* Ограничьте доступ, поступающий через службу балансировки нагрузки, например на переднюю дверцу Azure. Если вы хотите заблокировать входящий трафик на переднюю дверцу Azure, создайте правила, разрешающие трафик от 147.243.0.0/16 и 2a01:111:2050::/44. 

![Ограничения доступа с помощью передней дверцы](media/networking-features/access-restrictions-afd.png)

Если вы хотите заблокировать доступ к приложению, чтобы оно было доступно только из ресурсов в виртуальной сети Azure, вам потребуется статический общедоступный адрес, который находится в вашей сети. Если ресурсы не имеют общедоступного адреса, вместо них следует использовать функцию конечных точек службы. Узнайте, как включить эту функцию с помощью учебника по [настройке ограничений доступа][iprestrictions].

### <a name="service-endpoints"></a>Конечные точки службы

Конечные точки службы позволяют заблокировать **входящий** доступ к приложению таким образом, чтобы исходный адрес был получен из набора подсетей, которые вы выбрали. Эта функция работает совместно с ограничениями доступа по IP. Конечные точки службы задаются в том же пользовательском интерфейсе, что и ограничения доступа по IP-адресу. Вы можете создать список разрешенных и запрещенных правил доступа, включающий в себя общедоступные адреса и подсети в виртуальных сетей. Эта функция поддерживает такие сценарии, как:

![Конечные точки службы](media/networking-features/service-endpoints.png)

* Настройка шлюза приложений с приложением для блокировки входящего трафика в приложение
* Ограничьте доступ к приложению для доступа к ресурсам в виртуальной сети. Сюда могут входить виртуальные машины, среды ASE или даже другие приложения, использующие интеграцию с виртуальной сетью. 

![конечные точки службы с шлюзом приложений](media/networking-features/service-endpoints-appgw.png)

Дополнительные сведения о настройке конечных точек службы в приложении см. в руководстве по [настройке ограничений доступа к конечной точке службы][serviceendpoints] .
 
### <a name="hybrid-connections"></a>через гибридные подключения

Служба приложений гибридные подключения позволяет приложениям выполнять **Исходящие** вызовы к указанным конечным точкам TCP. Конечная точка может быть локальной, в виртуальной сети или в любом месте, которая разрешает исходящий трафик в Azure через порт 443. Эта функция требует установки агента ретранслятора с именем Диспетчер гибридных подключений (HCM) на узле Windows Server 2012 или более поздней версии. HCM должен иметь возможность получить доступ к Azure Relay через порт 443. HCM можно скачать в пользовательском интерфейсе службы приложений гибридные подключения на портале. 

![Сетевой поток гибридные подключения](media/networking-features/hybrid-connections.png)

Функция гибридные подключения службы приложений основана на Azure Relay гибридные подключения. Служба приложений использует специализированную форму функции, которая поддерживает только отправку исходящих вызовов из приложения на узел и порт TCP. Этот узел и порт должны быть разрешены только на узле, где установлен HCM. Когда приложение в службе приложений выполняет поиск DNS на узле и порту, определенных в гибридном подключении, трафик автоматически перенаправляется на подключение к гибридному подключению и к Диспетчер гибридных подключений. Дополнительные сведения о гибридные подключения см. в документации по [службе приложений гибридные подключения][hybridconn]

Эта функция обычно используется для:

* Доступ к ресурсам в частных сетях, которые не подключены к Azure с помощью VPN или ExpressRoute
* Поддержка точности и сдвига локальных приложений в службу приложений без необходимости перемещения вспомогательных баз данных  
* Безопасное предоставление доступа к одному узлу и порту для гибридного подключения. Большинство сетевых функций открывают доступ к сети и с гибридные подключения вы можете получить только один узел и порт.
* Сценарии, не охваченные другими методами исходящего подключения
* Выполните разработку в службе приложений, где приложения могут легко использовать локальные ресурсы. 

Так как эта функция обеспечивает доступ к локальным ресурсам без отверстия для входящего трафика брандмауэра, она популярна для разработчиков. Другие сетевые компоненты исходящей связи службы приложений — это очень часто связанные с виртуальными сетями Azure. Гибридные подключения не зависит от прохождения через виртуальную сеть и может использоваться для более широкого спектра сетевых потребностей. Важно отметить, что функция гибридные подключения службы приложений не следит или не знает, что вы делаете над ней. Это значит, что его можно использовать для доступа к базе данных, веб-службе или произвольному сокету TCP на мэйнфрейме. Компонент, по сути, осуществляет туннелирование пакетов TCP. 

Хотя гибридные подключения является популярным для разработки, она также используется и в многочисленных рабочих приложениях. Она отлично подходит для доступа к веб-службе или базе данных, но она не подходит для ситуаций, связанных с созданием большого количества подключений. 

### <a name="gateway-required-vnet-integration"></a>Интеграция виртуальной сети, требуемой шлюзом 

Шлюз, необходимый для интеграции виртуальной сети в службе приложений, позволяет приложению выполнять **Исходящие** запросы к виртуальной сети Azure. Эта функция работает, подключив узел, на котором выполняется ваше приложение, к шлюзу виртуальной сети с VPN-подключением типа "точка — сеть". При настройке функции приложение получает один из адресов типа "точка — сеть", назначенных каждому экземпляру. Эта функция позволяет получить доступ к ресурсам в классической или диспетчер ресурсов виртуальных сетей в любом регионе. 

![Интеграция виртуальной сети, требуемой шлюзом](media/networking-features/gw-vnet-integration.png)

Эта функция решает проблему доступа к ресурсам в других виртуальных сетей и даже может использоваться для подключения через виртуальную сеть к другим виртуальных сетей или даже к локальной среде. Он не работает с подключенными виртуальных сетей ExpressRoute, но работает с VPN-подключением типа "сеть — сеть". Обычно это не подходит для использования этой функции из приложения в Среда службы приложений (ASE), так как ASE уже находится в виртуальной сети. Варианты использования, решаемые с помощью этой функции:

* Доступ к ресурсам на частных IP-адресах в виртуальных сетях Azure 
* Доступ к локальным ресурсам при наличии VPN-подключения типа "сеть — сеть" 
* Доступ к ресурсам в одноранговых виртуальных сетей 

Если эта функция включена, приложение будет использовать DNS-сервер, с которым настроена Целевая виртуальная сеть. Дополнительные сведения об этой функции см. в документации по [интеграции виртуальной сети службы приложений][vnetintegrationp2s]. 

### <a name="vnet-integration"></a>интеграция с виртуальной сетью;

Функция интеграции виртуальной сети, требуемой для шлюза, очень полезна, но по-прежнему не разрешает доступ к ресурсам через ExpressRoute. Поначалу работы с подключениями ExpressRoute необходимо, чтобы приложения могли вызывать защищенные службы конечной точки службы. Чтобы решить эти дополнительные потребности, была добавлена другая возможность интеграции с виртуальной сетью. Новая функция интеграции с виртуальной сетью позволяет разместить серверную часть приложения в подсети диспетчер ресурсов виртуальной сети в том же регионе. Эта функция недоступна из Среда службы приложений, который уже находится в виртуальной сети. Возможности этой функции:

* Доступ к ресурсам в диспетчер ресурсов виртуальных сетей в одном регионе
* Доступ к ресурсам, защищенным с помощью конечных точек службы 
* Доступ к ресурсам, доступным для подключений ExpressRoute или VPN

![интеграция с виртуальной сетью;](media/networking-features/vnet-integration.png)

Эта функция находится на этапе предварительной версии и не должна использоваться для рабочих нагрузок. Дополнительные сведения об этой функции см. в статье [Интеграция службы приложений с виртуальной][vnetintegration]сетью.

## <a name="app-service-environment"></a>Среда службы приложений 

Среда службы приложений (ASE) — это одно развертывание клиента службы приложений Azure, которое выполняется в виртуальной сети. ASE включает следующие варианты использования:

* Доступ к ресурсам в виртуальной сети
* Доступ к ресурсам в ExpressRoute
* Предоставление приложениям закрытого адреса в виртуальной сети 
* Доступ к ресурсам в конечных точках службы 

С помощью ASE вам не нужно использовать такие функции, как интеграция с виртуальной сетью или конечные точки службы, так как ASE уже находится в виртуальной сети. Если вы хотите получить доступ к ресурсам, таким как SQL или хранилище, через конечные точки службы, включите конечные точки службы в подсети ASE. Если вы хотите получить доступ к ресурсам в виртуальной сети, дополнительная настройка не требуется.  Если вы хотите получить доступ к ресурсам в ExpressRoute, вы уже подключены к виртуальной сети и не должны настраивать что-либо в ASE или в приложениях внутри нее. 

Так как приложения в ILB ASE могут быть предоставлены на частном IP-адресе, вы можете легко добавлять устройства WAF, чтобы предоставить доступ только к приложениям, которые вы хотите использовать в Интернете, и обеспечить безопасность остальных. Он позволяет легко разрабатывать многоуровневые приложения. 

Существует несколько вещей, которые еще не были доступны из службы с несколькими клиентами, ASE. К ним относятся:

* Предоставление приложений на частном IP-адресе
* Защита всего исходящего трафика с помощью сетевых средств управления, которые не являются частью приложения 
* Размещение приложений в одной службе клиента 
* Увеличение масштаба до большего числа экземпляров, чем возможно в службе с несколькими клиентами 
* Загрузка частных сертификатов клиента ЦС для использования в приложениях с защищенными конечными точками закрытого ЦС 
* Принудительно использовать TLS 1,1 для всех приложений, размещенных в системе, без возможности отключения на уровне приложения 
* Укажите выделенный исходящий адрес для всех приложений в ASE, которые не являются общими для клиентов 

![ASE в виртуальной сети](media/networking-features/app-service-environment.png)

ASE предоставляет оптимальную историю для изолированного и выделенного размещения приложений, но с некоторыми проблемами управления. Прежде чем использовать операционные ASE, следует учесть следующие моменты:
 
 * ASE выполняется внутри виртуальной сети, но имеет зависимости за пределами виртуальной сети. Эти зависимости должны быть разрешены. Дополнительные сведения см. в статье [Сетевые рекомендации для среда службы приложений][networkinfo]
 * ASE не масштабируется сразу же, как и служба с несколькими клиентами. Необходимо предвидеть необходимость масштабирования, а не масштабирование в активном масштабе. 
 * У ASE есть более высокие издержки, связанные с ней. Чтобы максимально эффективно использовать ASE, следует спланировать использование множества рабочих нагрузок в одном ASE, вместо того чтобы они использовались для небольших усилий.
 * Приложения в ASE не могут ограничивать доступ к некоторым приложениям в ASE, а не к другим.
 * ASE находится в подсети, а все правила работы с сетью применяются ко всему трафику, связанному с этим ASE. Если вы хотите назначить правила входящего трафика только для одного приложения, используйте ограничения доступа. 

## <a name="combining-features"></a>Объединение функций 

Функции, отмеченные для службы с несколькими клиентами, можно использовать совместно для решения более сложных вариантов использования. Здесь описаны два наиболее распространенных варианта использования, но они являются просто примерами. Зная о различных функциях, можно решить практически все требования к архитектуре системы.

### <a name="inject-app-into-a-vnet"></a>Внедрение приложения в виртуальную сеть

Общий запрос заключается в том, как разместить приложение в виртуальной сети. Размещение приложения в виртуальной сети означает, что входящие и исходящие конечные точки приложения находятся в виртуальной сети. ASE предоставляет лучшее решение для решения этой проблемы, но вы можете получить большую часть того, что требуется в службе с несколькими клиентами, объединив функции. Например, можно размещать приложения интрасети с частными входящими и исходящими адресами следующим образом:

* Создание шлюза приложений с частным входящим и исходящим адресом
* Защита входящего трафика приложения с помощью конечных точек службы 
* Использовать новую интеграцию виртуальной сети, чтобы серверная часть приложения нав вашей виртуальной сети 

Этот стиль развертывания не даст вам выделенного адреса для исходящего трафика в Интернет или позволяет блокировать весь исходящий трафик из приложения.  Этот стиль развертывания дает множество возможностей, которые в противном случае можно было бы получить с помощью ASE. 

### <a name="create-multi-tier-applications"></a>Создание многоуровневых приложений

Многоуровневое приложение — это приложение, в котором серверные приложения API могут получать доступ только с интерфейсного уровня. Для создания многоуровневого приложения можно:

* Использование интеграции с виртуальной сетью для подключения серверной части внешнего веб-приложения к подсети в виртуальной сети
* Используйте конечные точки службы, чтобы защитить входящий трафик к приложению API для поступающих только из подсети, используемой интерфейсным веб-приложением.

![многоуровневое приложение](media/networking-features/multi-tier-app.png)

Несколько клиентских приложений могут использовать одно и то же приложение API с помощью интеграции виртуальной сети из других клиентских приложений и конечных точек службы из приложения API с подсетями.  

<!--Links-->
[appassignedaddress]: https://docs.microsoft.com/azure/app-service/configure-ssl-certificate
[iprestrictions]: https://docs.microsoft.com/azure/app-service/app-service-ip-restrictions
[serviceendpoints]: https://docs.microsoft.com/azure/app-service/app-service-ip-restrictions
[hybridconn]: https://docs.microsoft.com/azure/app-service/app-service-hybrid-connections
[vnetintegrationp2s]: https://docs.microsoft.com/azure/app-service/web-sites-integrate-with-vnet
[vnetintegration]: https://docs.microsoft.com/azure/app-service/web-sites-integrate-with-vnet
[networkinfo]: https://docs.microsoft.com/azure/app-service/environment/network-info
