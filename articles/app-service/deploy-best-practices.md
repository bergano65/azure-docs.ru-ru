---
title: Рекомендации по развертыванию
description: Узнайте о ключевых механизмах развертывания в службе приложений Azure. Поиск рекомендаций, относящихся к конкретному языку, и других предостережений.
keywords: служба приложений Azure, веб-приложение, развертывание, развертывание, конвейеры, сборка
author: jasonfreeberg
ms.assetid: bb51e565-e462-4c60-929a-2ff90121f41d
ms.topic: article
ms.date: 07/31/2019
ms.author: jafreebe
ms.openlocfilehash: addc4edba734c350a1e0e4246203c64315f345dd
ms.sourcegitcommit: 2ffa5bae1545c660d6f3b62f31c4efa69c1e957f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2020
ms.locfileid: "88081057"
---
# <a name="deployment-best-practices"></a>Рекомендации по развертыванию

Каждая группа разработчиков имеет уникальные требования, которые могут усложнить реализацию эффективного конвейера развертывания в любой облачной службе. В этой статье представлены три основных компонента развертывания в службе приложений: источники развертывания, конвейеры сборки и механизмы развертывания. В этой статье также рассматриваются некоторые рекомендации и советы по конкретным стекам языков.

## <a name="deployment-components"></a>Компоненты развертывания

### <a name="deployment-source"></a>Источник развертывания

Источником развертывания является расположение кода приложения. Для рабочих приложений источник развертывания обычно является репозиторием, размещенным по системе управления версиями, например [GitHub, BitBucket или Azure Repos](deploy-continuous-deployment.md). Для сценариев разработки и тестирования источником развертывания может быть [проект на локальном компьютере](deploy-local-git.md). Служба приложений также поддерживает [папки OneDrive и Dropbox](deploy-content-sync.md) в качестве источников развертывания. Хотя облачные папки могут упростить начало работы со службой приложений, обычно не рекомендуется использовать этот источник для рабочих приложений корпоративного уровня. 

### <a name="build-pipeline"></a>Конвейер сборки

После выбора источника развертывания следующим шагом будет выбор конвейера сборки. Конвейер сборки считывает исходный код из источника развертывания и выполняет ряд действий (например, компиляция кода, Минификация HTML и JavaScript, выполнение тестов и компоненты упаковки), чтобы получить приложение в готовом к запуске состоянии. Конкретные команды, выполняемые конвейером сборки, зависят от вашего стека языка. Эти операции могут выполняться на сервере сборки, например Azure Pipelines или выполняться локально.

### <a name="deployment-mechanism"></a>Механизм развертывания

Механизм развертывания — это действие, которое используется для помещения созданного приложения в каталог */Хоме/Сите/ввврут* веб-приложения. Каталог */ввврут* — это расположение подключенного хранилища, которое совместно используется всеми экземплярами веб-приложения. Когда механизм развертывания помещает приложение в этот каталог, экземпляры получают уведомление для синхронизации новых файлов. Служба приложений поддерживает следующие механизмы развертывания:

- Конечные точки KUDU: [KUDU](https://github.com/projectkudu/kudu/wiki) — это средство повышения производительности разработчика с открытым исходным кодом, которое работает как отдельный процесс в службе приложений Windows, а также как второй контейнер в службе приложений Linux. KUDU обрабатывает непрерывные развертывания и предоставляет конечные точки HTTP для развертывания, такие как зипдеплой.
- FTP и WebDeploy. используя [учетные данные сайта или пользователя](deploy-configure-credentials.md), можно отправлять файлы [через FTP](deploy-ftp.md) или веб-развертывание. Эти механизмы не проходят через KUDU.  

Средства развертывания, такие как Azure Pipelines, Jenkins и подключаемые модули редактора, используют один из этих механизмов развертывания.

## <a name="use-deployment-slots"></a>Использование слотов развертывания

Везде, где это возможно, используйте [слоты развертывания](deploy-staging-slots.md) при развертывании новой рабочей сборки. При использовании уровня плана службы приложений Standard или выше можно развернуть приложение в промежуточной среде, проверить изменения и выполнить тесты состояния. Когда вы будете готовы, можно поменять местами промежуточные и рабочие слоты. Операция подкачки закрывает необходимые рабочие экземпляры в соответствии с масштабом рабочей среды, тем самым устраняя простои.

### <a name="continuously-deploy-code"></a>Непрерывное развертывание кода

Если в проекте определены ветви для тестирования, контроля качества и промежуточного хранения, каждая из этих ветвей должна быть непрерывно развернута в промежуточном слоте. (Это называется [гитфлов конструкцией](https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow).) Это позволяет заинтересованным лицам легко оценивать и тестировать развернутую ветвь. 

Непрерывное развертывание никогда не должно включаться для рабочего слота. Вместо этого Рабочая ветвь (часто главный) должна быть развернута в нерабочем слоте. Когда вы будете готовы выпустить базовую ветвь, переключайте ее в рабочий слот. Переключение в рабочую среду — вместо развертывания в рабочей среде — предотвращает время простоя и позволяет откатить изменения, переключаясь еще раз. 

![Визуальный элемент использования слота](media/app-service-deploy-best-practices/slot_flow_code_diagam.png)

### <a name="continuously-deploy-containers"></a>Непрерывное развертывание контейнеров

Для пользовательских контейнеров из DOCKER или других реестров контейнеров Разверните образ в промежуточном слоте и замените его на рабочую, чтобы предотвратить простои. Автоматизация сложнее, чем развертывание кода, так как необходимо передать образ в реестр контейнеров и обновить тег Image на webapp.

Для каждой ветви, которую требуется развернуть в слот, настройте автоматизацию для каждой фиксации в ветви.

1. **Создайте и пометьте образ**. В рамках конвейера сборки пометьте образ ИДЕНТИФИКАТОРом фиксации Git, меткой времени или другими идентифицируемыми сведениями. Лучше не использовать тег "latest" по умолчанию. В противном случае трудно отследить, какой код в настоящее время развернут, что делает отладку гораздо сложнее.
1. **Отправка изображения с тегами**. После построения и пометки образа конвейер передает его в реестр контейнеров. На следующем шаге в слоте развертывания будет извлекаться изображение с тегами из реестра контейнеров.
1. **Обновите слот развертывания с помощью нового тега Image**. При обновлении этого свойства сайт автоматически перезапускается и извлекает новый образ контейнера.

![Визуальный элемент использования слота](media/app-service-deploy-best-practices/slot_flow_container_diagram.png)

Ниже приведены примеры распространенных платформ автоматизации.

### <a name="use-azure-devops"></a>Использование Azure DevOps

Служба приложений имеет [встроенную непрерывную доставку](deploy-continuous-deployment.md) контейнеров через центр развертывания. Перейдите к приложению в [портал Azure](https://portal.azure.com/) и выберите **центр развертывания** в разделе **развертывание**. Следуйте инструкциям, чтобы выбрать репозиторий и ветвь. Это приведет к настройке конвейера сборки и выпуска DevOps для автоматической сборки, пометки и развертывания контейнера при отправке новых фиксаций в выбранную ветвь.

### <a name="use-github-actions"></a>Использование действий GitHub

Вы также можете автоматизировать развертывание контейнера [с помощью действий GitHub](deploy-container-github-action.md).  Файл рабочего процесса, приведенный ниже, построит контейнер с ИДЕНТИФИКАТОРом фиксации, отправит его в реестр контейнеров и обновит указанный слот сайта, указав новый тег Image.

```yaml
name: Build and deploy a container image to Azure Web Apps

on:
  push:
    branches:
    - <your-branch-name>

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@master

    -name: Authenticate using a Service Principal
      uses: azure/actions/login@v1
      with:
        creds: ${{ secrets.AZURE_SP }}

    - uses: azure/container-actions/docker-login@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push the image tagged with the git commit hash
      run: |
        docker build . -t contoso/demo:${{ github.sha }}
        docker push contoso/demo:${{ github.sha }}

    - name: Update image tag on the Azure Web App
      uses: azure/webapps-container-deploy@v1
      with:
        app-name: '<your-webapp-name>'
        slot-name: '<your-slot-name>'
        images: 'contoso/demo:${{ github.sha }}'
```

### <a name="use-other-automation-providers"></a>Использование других поставщиков автоматизации

Приведенные выше действия относятся к другим служебным программам автоматизации, таким как ЦирклеЦи или Travis CI. Однако необходимо использовать Azure CLI для обновления слотов развертывания новыми тегами изображений на завершающем шаге. Чтобы использовать Azure CLI в скрипте автоматизации, создайте субъект-службу с помощью следующей команды.

```shell
az ad sp create-for-rbac --name "myServicePrincipal" --role contributor \
   --scopes /subscriptions/{subscription}/resourceGroups/{resource-group} \
   --sdk-auth
```

В скрипте Войдите в систему с помощью `az login --service-principal` , предоставив сведения об участнике. Затем можно использовать `az webapp config container set` для задания имени контейнера, тега, URL-адреса реестра и пароля реестра. Ниже приведены полезные ссылки для создания процесса CI контейнера.

- [Вход в Azure CLI в элементе конфигурации Circle](https://circleci.com/orbs/registry/orb/circleci/azure-cli) 

## <a name="language-specific-considerations"></a>Рекомендации для конкретного языка

### <a name="java"></a>Java

Используйте KUDU [зипдеплой/](deploy-zip.md) API для развертывания JAR-приложений, а также [WARDEPLOY/](deploy-zip.md#deploy-war-file) for War Apps. Если вы используете Jenkins, эти API можно использовать непосредственно на этапе развертывания. Дополнительные сведения см. в [этой статье](../jenkins/execute-cli-jenkins-pipeline.md).

### <a name="node"></a>Узел

По умолчанию KUDU выполняет шаги сборки для приложения узла ( `npm install` ). Если вы используете службу сборки, например Azure DevOps, сборка KUDU не требуется. Чтобы отключить сборку KUDU, создайте параметр приложения `SCM_DO_BUILD_DURING_DEPLOYMENT` со значением `false` .

### <a name="net"></a>.NET 

По умолчанию KUDU выполняет шаги сборки для приложения .NET ( `dotnet build` ). Если вы используете службу сборки, например Azure DevOps, сборка KUDU не требуется. Чтобы отключить сборку KUDU, создайте параметр приложения `SCM_DO_BUILD_DURING_DEPLOYMENT` со значением `false` .

## <a name="other-deployment-considerations"></a>Другие рекомендации по развертыванию

### <a name="local-cache"></a>локальный кэш

Содержимое Службы приложений Azure хранится в Службе хранилища Azure; оно доступно в долгосрочном режиме в общей папке содержимого. Однако некоторым приложениям требуется только высокопроизводительное хранилище содержимого, доступное только для чтения, которое можно запускать с высокой доступностью. Эти приложения могут использовать [локальный кэш](overview-local-cache.md). Локальный кэш не рекомендуется для сайтов управления содержимым, таких как WordPress.

Для предотвращения простоя всегда используйте локальный кэш в сочетании с [слотами развертывания](deploy-staging-slots.md) . Сведения об использовании этих функций совместно см. в [этом разделе](overview-local-cache.md#best-practices-for-using-app-service-local-cache) .

### <a name="high-cpu-or-memory"></a>Высокая загрузка ЦП или памяти

Если ваш план службы приложений использует более 90% доступного процессора или памяти, то при обработке развертывания может возникнуть проблема с базовой виртуальной машиной. В этом случае можно временно увеличить число экземпляров для выполнения развертывания. После завершения развертывания можно вернуть число экземпляров к его предыдущему значению.

Дополнительные сведения о рекомендуемых методиках см. в статье [Диагностика службы приложений](https://docs.microsoft.com/azure/app-service/overview-diagnostics) .

- Перейдите к веб-приложению в [портал Azure](https://portal.azure.com).
- В области навигации слева щелкните **Диагностика и устранение проблем** , после чего откроется окно Диагностика службы приложений.
- Выберите элемент Главная страница **с рекомендациями** .
- Щелкните **рекомендации по обеспечению доступности & производительности** или **рекомендациям по оптимальной конфигурации** , чтобы просмотреть текущее состояние приложения в соответствии с рекомендациями.

Эту ссылку также можно использовать, чтобы напрямую открыть диагностику службы приложений для вашего ресурса: `https://ms.portal.azure.com/?websitesextension_ext=asd.featurePath%3Ddetectors%2FParentAvailabilityAndPerformance#@microsoft.onmicrosoft.com/resource/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Web/sites/{siteName}/troubleshoot` .
