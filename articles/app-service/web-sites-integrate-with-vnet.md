---
title: Интеграция приложения с виртуальной сетью Azure (Служба приложений Azure)
description: В этой статье показано, как подключить приложение к новой или существующей виртуальной сети Azure.
services: app-service
documentationcenter: ''
author: ccompy
manager: stefsch
ms.assetid: 90bc6ec6-133d-4d87-a867-fcf77da75f5a
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 11/12/2018
ms.author: ccompy
ms.custom: seodec18
ms.openlocfilehash: 768179f8569eac14166bcbb0a888e1cdbe41d497
ms.sourcegitcommit: 49c8204824c4f7b067cd35dbd0d44352f7e1f95e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2019
ms.locfileid: "58369706"
---
# <a name="integrate-your-app-with-an-azure-virtual-network"></a>Интеграция приложения с виртуальной сетью Azure
В этом документе описана функция службы приложений Azure — интеграция с виртуальной сетью. Кроме того, приведены инструкции по ее настройке для приложений в [службе приложений Azure](https://go.microsoft.com/fwlink/?LinkId=529714). [Виртуальные сети Azure][VNETOverview] позволяют размещать многие ресурсы Azure в сети, недоступной из Интернета. Эти сети можно подключать к локальным сетям с помощью технологий VPN. 

Служба приложений Azure реализована в виде двух моделей. 

1. Мультитенантные системы с поддержкой всей линейки тарифных планов, кроме плана "Изолированный"
2. Среда службы приложений (ASE), которая развертывается в вашей виртуальной сети. 

В этом документе рассматривается функция интеграции с виртуальной сетью, предназначенная для использования в мультитенантной службе приложений.  Если приложение размещено в [среде службы приложений][ASEintro], то оно уже находится в виртуальной сети, а для доступа к ресурсам из этой сети не требуется использовать функцию интеграции.

Интеграция с виртуальной сетью предоставляет веб-приложению доступ к ресурсам виртуальной сети, но само приложение остается для этой сети недоступным. Доступ к частным сайтам подразумевает доступность приложения только из частной сети, например из виртуальной сети Azure. Доступ к частным сайтам возможен, только если для ASE настроен внутренний балансировщик нагрузки (ILB). Дополнительные сведения об использовании ILB ASE см. в статье [Создание и использование внутренней подсистемы балансировки нагрузки с использованием Среды службы приложений][ILBASE]. 

Интеграция с виртуальной сетью часто используется для доступа приложений к базам данных и веб-службам, работающим в виртуальной сети. Благодаря интеграции с виртуальной сетью вам не нужно предоставлять общедоступную конечную точку приложениям, запущенным на виртуальной машине. Вместо этого будут использоваться частные адреса, недоступные из Интернета. 

Интеграция с виртуальной сетью связана со следующими особенностями:

* требуется тарифный план "Стандартный", "Премиум" или "Премиум V2"; 
* работает с классической виртуальной сетью или с виртуальной сетью Resource Manager; 
* поддерживает TCP и UDP;
* работает с Интернетом, мобильными приложениями, приложениями API и приложениями-функциями;
* позволяет приложению в один момент времени подключаться только к одной виртуальной сети;
* позволяет интегрировать до пяти виртуальных сетей в рамках плана службы приложений; 
* позволяет нескольким приложениям использовать одну виртуальную сеть в рамках плана службы приложений;
* требуется шлюз виртуальной сети, в котором настроена сеть VPN типа "точка — сеть";
* гарантирует практически постоянную доступность ресурсов (99,9 % по соглашению об уровне обслуживания) благодаря использованию шлюза.

Функции, не поддерживаемые при интеграции с виртуальной сетью:

* подключение диска;
* интеграция с AD; 
* NetBios;
* доступ к частным сайтам.
* доступ к ресурсам через ExpressRoute; 
* доступ к ресурсам через конечные точки служб. 

### <a name="getting-started"></a>Приступая к работе
Перед подключением веб-приложения к виртуальной сети обратите внимание на следующие моменты.

* Перед подключением к приложению в целевой виртуальной сети должна быть включена сеть VPN типа "точка — сеть" со шлюзом на основе маршрутов. 
* Виртуальная сеть должна относиться к той же подписке, что и план службы приложений (ASP).
* Приложения, которые интегрируются с виртуальной сетью, используют DNS-сервер, указанный для этой виртуальной сети.

## <a name="enabling-vnet-integration"></a>Включение интеграции с виртуальной сетью

Доступна предварительная версия новой функции интеграции с виртуальной сетью. Она не зависит от сети VPN типа "точка — сеть", а также поддерживает доступ к ресурсам через ExpressRoute и конечные точки служб. Подробнее об этой новой возможности рассказано в конце данного документа. 

### <a name="set-up-a-gateway-in-your-vnet"></a>Настройка шлюза в виртуальной сети ###

Если в шлюзе уже настроены адреса для подключения "точка — сеть", то настройку интеграции приложения с виртуальной сетью можно пропустить.  
Создание шлюза:

1. [Создайте подсеть шлюза][creategatewaysubnet] в виртуальной сети.  

1. [Создайте VPN-шлюз][creategateway]. Выберите тип сети VPN на основе маршрутов.

1. [Задайте адреса для подключения "точка — сеть"][setp2saddresses]. Если шлюз не входит в базовый SKU, то в конфигурации подключения "точка — сеть" необходимо отключить IKEV2 и выбрать SSTP. Адресное пространство должно находиться в одном из следующих блоков адресов:

* 10.0.0.0/8 означает диапазон IP-адресов от 10.0.0.0 до 10.255.255.255.
* 172.16.0.0/12 означает диапазон IP-адресов от 172.16.0.0 до 172.31.255.255. 
* 192.168.0.0/16 означает диапазон IP-адресов от 192.168.0.0 до 192.168.255.255.

Если пользователь только созданием шлюза для использования приложения службы интеграции с виртуальной сетью, затем не нужно отправить сертификат. Создание шлюза может занять 30 минут. Пока шлюз не будет подготовлен, интегрировать приложение с виртуальной сетью будет невозможно. 

### <a name="configure-vnet-integration-with-your-app"></a>Настройка интеграции приложения с виртуальной сетью ###

Включение интеграции приложения с виртуальной сетью: 

1. Перейдите к своему приложению на портале Azure, откройте параметры приложения и выберите пункты "Сеть" > "Интеграция виртуальной сети". Прежде чем настраивать интеграцию с виртуальной сетью, необходимо масштабировать ASP до SKU "Стандартный". 
 ![Пользовательский интерфейс интеграции с виртуальной сетью][1]

1. Выберите **Добавить виртуальную сеть**. 
 ![Добавление интеграции с виртуальной сетью][2]

1. Выберите виртуальную сеть. 
  ![Выбор виртуальной сети][8]
  
После последнего действия приложение будет перезапущено.  

## <a name="how-the-system-works"></a>Принципы работы системы
Функция интеграции с виртуальной сетью основана на технологии сетей VPN типа "точка — сеть". Приложения в службе приложений Azure размещаются в мультитенантной системе, которая не позволяет подготовить приложение непосредственно в виртуальной сети. Технология "точка — сеть" разрешает доступ к сети только той виртуальной машине, в которой размещается приложение. Приложениям разрешается отправлять трафик в Интернет только через гибридные подключения или путем интеграции с виртуальной сетью. 

![Как работает интеграция с виртуальной сетью][3]

## <a name="managing-the-vnet-integrations"></a>Управление интеграцией с виртуальной сетью
Возможность подключаться к виртуальной сети и отключаться от нее реализуется на уровне приложения. Операции, которые могут повлиять на интеграцию нескольких приложений с виртуальной сетью, выполняются на уровне плана службы приложений. Из UID приложения можно получить сведения о виртуальной сети. Та же информация доступна и на уровне плана ASP. 

 ![Сведения о виртуальной сети][4]

На странице состояния сетевых компонентов вы можете отследить, подключено ли приложение к виртуальной сети. Если шлюз виртуальной сети по какой-либо причине не работает, указывается, что оно не подключено. 

Теперь в пользовательском интерфейсе интеграции с виртуальной сетью на уровне приложения отображаются те же сведения, что и на уровне ASP. Они представлены ниже.

* Имя виртуальной сети. Ссылки на пользовательский интерфейс виртуальной сети
* Расположение. Указывает расположение виртуальной сети. Интеграция с виртуальной сетью в другом расположении может вызывать проблемы с задержкой для приложения. 
* Состояние сертификата. Указывает, синхронизированы ли сертификаты между планом службы приложений и виртуальной сетью.
* Состояние шлюза. Если по какой-либо причине шлюз не работает, приложение не сможет получить доступ к ресурсам в виртуальной сети. 
* Адресное пространство виртуальной сети. Указывает IP-адреса, которые используются в виртуальной сети. 
* Адресное пространство "точка — сеть". Указывает IP-адреса, которые используются при подключении типа "точка — сеть" к виртуальной сети. При отправке вызовов виртуальной сети адрес "От" приложения будет одним из этих адресов. 
* Адресное пространство "сеть — сеть". VPN типа "сеть — сеть" можно использовать для подключения виртуальной сети к ресурсам в локальной сети или к другим виртуальным сетям. Здесь показаны диапазоны IP-адресов, определенные этим VPN-подключением.
* DNS-серверы. Указывает DNS-серверы, настроенные для виртуальной сети.
* IP-адреса, направляемые в виртуальную сеть. Блоки адресов, используемые для направления трафика в виртуальную сеть 

В представлении интеграции с виртуальной сетью на уровне приложения можно выполнить только одну операцию — отключить приложение от той виртуальной сети, к которой оно сейчас подключено. Чтобы отключить приложение от виртуальной сети, нажмите **Отключить**. При отключении от виртуальной сети приложение будет перезапущено. Виртуальная сеть не меняется при отключении. Конфигурация виртуальной сети, включая настроенные шлюзы, останется неизменной. Если вы хотите удалить виртуальную сеть, необходимо сначала удалить все ее ресурсы, включая шлюзы. 

Чтобы открыть пользовательский интерфейс интеграции ASP с виртуальной сетью, откройте пользовательский интерфейс ASP и выберите **Сеть**.  В разделе "Интеграция с виртуальной сетью" нажмите **Щелкните здесь для настройки**, чтобы открыть пользовательский интерфейс состояния функций сети.

![Сведения об интеграции ASP с виртуальной сетью][5]

В пользовательском интерфейсе интеграции ASP с виртуальной сетью отображаются все виртуальные сети, используемые приложениями в ASP. Вы можете подключать до 5 виртуальных сетей к любому количеству приложений в плане службы приложений. Для каждого приложения может быть настроена только одна интеграция. Чтобы просмотреть сведения о той или иной виртуальной сети, щелкните нужную сеть. Здесь можно выполнить два действия.

* **Синхронизировать сеть.** Эта операция гарантирует, что сертификаты и сведения о сети синхронизированы. Если вы добавите или измените DNS виртуальной сети, то необходимо выполнить операцию **Синхронизировать сеть**. Эта операция перезапустит все приложения, использующие эту виртуальную сеть.
* **Добавить маршруты.** При добавлении маршрутов исходящий трафик направляется в вашу виртуальную сеть.

**Маршрутизация.** Маршруты, определенные в виртуальной сети, используемые для направления трафика в виртуальную сеть из вашего приложения. Если вам нужно отправлять дополнительный исходящий трафик в виртуальную сеть, то вы можете добавить здесь соответствующие блоки адресов.   

**Сертификаты.** При включении интеграции с виртуальной сетью требуется обмен сертификатами, чтобы обеспечить безопасность соединения. Одновременно с сертификатами передаются конфигурация DNS, маршруты и другая полезная информация о сети.
Если сертификаты или сведения о сети изменились, нажмите "Синхронизировать сеть". Выполнение синхронизации с сетью сопровождается кратковременной потерей подключения между приложением и виртуальной сетью. Хотя приложение не перезапускается, потеря подключения может привести к нарушению его работоспособности. 

## <a name="accessing-on-premises-resources"></a>Доступ к локальным ресурсам
Приложения могут получать доступ к локальным ресурсам путем интеграции с виртуальными сетями, содержащими подключения типа "сеть — сеть". Для доступа к локальным ресурсам необходимо обновить локальные маршруты VPN-шлюзов, добавив блоки адресов "точка — сеть". При первой настройке VPN-подключения "сеть-сеть" скрипты, используемые для его настройки, должны настроить маршруты надлежащим образом. Если адреса "точка — сеть" добавлены после создания VPN-подключения типа "сеть — сеть", то маршруты нужно обновить вручную. Эта процедура отличается для разных типов шлюзов, поэтому здесь мы ее не рассматриваем. Кроме того, протокол BGP невозможно настроить с VPN-подключением типа "сеть-сеть".

> [!NOTE]
> Функция интеграции c виртуальной сетью не предусматривает интеграции приложения с виртуальной сетью, в которой установлен шлюз ExpressRoute. Даже если шлюз ExpressRoute настроен в [режиме сосуществования][VPNERCoex], функция интеграции c виртуальной сетью работать не будет. Если требуется получить доступ к ресурсам через соединение ExpressRoute, можно использовать [среду службы приложений][ASE], которая работает в виртуальной сети. 
> 
> 

## <a name="peering"></a>Пиринг
Интеграцию с виртуальной сетью можно использовать для доступа к ресурсам в виртуальных сетях, соединенных с той сетью, к которой вы подключены. Настройка пиринга для работы с приложением:

1. Добавьте пиринговое подключение в виртуальную сеть, к которой подключается приложение. Добавляя пиринговое подключение, включите параметр **Разрешить доступ к виртуальным сетям**, а также установите флажки **Разрешить перенаправленный трафик** и **Разрешить транзит шлюзов**.
1. Добавьте пиринговое подключение в виртуальной сети, соединенной с той виртуальной сетью, к которой вы подключены. Добавляя пиринговое подключение к целевой виртуальной сети, включите параметр **Разрешить доступ к виртуальным сетям**, а также установите флажки **Разрешить перенаправленный трафик** и **Разрешить удаленные шлюзы**.
1. Перейдите к разделу "План службы приложений" > "Сеть" > "Интеграция виртуальной сети" на портале.  Выберите виртуальную сеть, к которой подключается приложение. В разделе маршрутизации добавьте диапазон адресов виртуальной сети, соединенной с той виртуальной сетью, к которой вы подключены.  


## <a name="pricing-details"></a>Сведения о тарифах
С использованием функции интеграции виртуальной сети связано три тарифа:

* требования к ценовой категории плана ASP;
* расходы, связанные с передачей данных;
* расходы, связанные с использованием VPN-шлюза.

Приложение должно относиться к одному из следующих планов службы приложений: "Стандартный", "Премиум" или "Премиум V2". Дополнительные сведения о ценах на планы см. на странице [цен на Службу приложений][ASPricing]. 

За исходящий трафик взимается плата, даже если виртуальная сеть находится в том же центре обработки данных. Эти тарифы описаны в [сведениях о ценах за передачу данных][DataPricing]. 

Взимается плата за шлюз виртуальной сети, необходимый для сети VPN типа "точка — сеть". Подробные сведения представлены на странице [Цены на VPN-шлюзы][VNETPricing].

## <a name="troubleshooting"></a>Устранение неполадок
Простота настройки этой функции не гарантирует отсутствия проблем при ее использовании. При проблемах с доступом к нужной конечной точке можно воспользоваться некоторыми служебными программами для проверки подключения из консоли приложения. Вы можете использовать две консоли: консоль Kudu и консоль на портале Azure. Чтобы открыть консоль Kudu из приложения, выберите пункты "Сервис" -> "Kudu". Этот же интерфейс доступен по адресу [имя_сайта].scm.azurewebsites.net. В консоли перейдите на вкладку "Отладка". Чтобы воспользоваться консолью на портале Azure, откройте меню «Сервис» -> «Консоль». 

#### <a name="tools"></a>Средства
Приложения **ping**, **nslookup** и **tracert** нельзя использовать в консоли из-за ограничений безопасности. Чтобы компенсировать это, добавлены два других средства. Для проверки работоспособности DNS мы добавили средство nameresolver.exe. Синтаксис:

    nameresolver.exe hostname [optional: DNS Server]

Для проверки имен узлов, которые использует ваше приложение, можно использовать команду **nameresolver**. Так вы сможете обнаружить ошибки в настройке DNS-сервера или проблемы с доступом к DNS-серверу.

Следующее средство позволяет проверить подключение к комбинации «узел:порт» по протоколу TCP. Этот инструмент называется **tcpping.exe** и использует следующий синтаксис.

    tcpping.exe hostname [optional: port]

Служебная программа **tcpping** сообщает, возможно ли получить доступ к определенному узлу и порту. Сообщение об успешном выполнении отображается только с том случае, когда приложение ожидает передачи данных от комбинации "узел:порт", а также есть доступ по сети из приложения к указанным узлу и порту.

#### <a name="debugging-access-to-vnet-hosted-resources"></a>Доступ к ресурсам виртуальной сети для отладки
У приложения могут возникнуть проблемы с доступом к определенной комбинации «узел:порт». Это происходит по многим причинам. Вот три наиболее распространенные причины:

* **Брандмауэр блокирует доступ.** Если вы используете брандмауэр, может быть превышено время ожидания TCP. В нашем случае это 21 секунда. Проверьте подключение с помощью средства **tcpping**. Время ожидания TCP может превышаться и по многим другим причинам, но начать стоит именно с этой. 
* **Служба DNS недоступна.** Время ожидания для DNS составляет три секунды на каждый DNS-сервер. Если у вас два DNS-сервера, то время ожидания составляет 6 секунд. Используйте средство nameresolver для проверки работы DNS. Помните, что средство nslookup не подходит для проверки, так как оно игнорирует настройки DNS для виртуальной сети.
* **Недопустимый диапазон адресов "точка — сеть".** Диапазон IP-адресов для подключения "точка — сеть" должен находиться в диапазоне частных IP-адресов согласно RFC 1918 (10.0.0.0–10.255.255.255, 172.16.0.0–172.31.255.255, 192.168.0.0–192.168.255.255). Если использовать IP-адреса вне этих диапазонов, то подключение не будет работать. 

Если эти рекомендации не помогут вам решить проблему, проверьте еще несколько простых вещей. 

* Отображается ли на портале шлюз в рабочем состоянии?
* Синхронизированы ли сертификаты?
* Менялась ли конфигурация сети после последнего выполнения синхронизации с сетью для соответствующих планов ASP? 

Если шлюз не работает, восстановите его работоспособность. Если сертификаты не синхронизированы, перейдите к представлению интеграции с виртуальной сетью на уровне ASP и нажмите "Синхронизировать сеть". Если вы подозреваете, что конфигурация виртуальной сети, не синхронизированная с вашими ASP, была изменена, нажмите "Синхронизировать сеть".  Операция "Синхронизировать сеть" перезапускает все приложения в ASP, интегрированные с этой виртуальной сетью. 

Если все описанные выше пункты в порядке, вам нужно провести расширенную проверку.

* Существуют ли другие приложения, которые используют интеграцию с виртуальной сетью для доступа к ресурсам в той же виртуальной сети? 
* Можете ли вы открыть консоль приложений и обратиться к другим ресурсам виртуальной сети с помощью средства tcpping? 

Если на любой из этих вопросов ответ будет положительным, то интеграция с виртуальной сетью выполнена. Причина проблемы в другом. Это сложная ситуация, так как простых методов, которые позволяют определить причину проблем с доступом к комбинации «узел:порт», не существует. Ниже представлено несколько возможных причин этой проблемы.

* На нужном узле запущен брандмауэр, который блокирует доступ к порту приложения для диапазона IP-адресов "точка — сеть". Для подключения между подсетями часто требуется разрешить общий доступ.
* Целевой узел не работает.
* Целевое приложение не работает.
* Указан неверный IP-адрес или неверное имя узла.
* Приложение ожидает передачи данных не по тому порту, который предполагается. Вы можете сопоставить ИД процесса с портом прослушивания при помощи команды "netstat -aon" в узле конечной точки. 
* Группы безопасности сети настроены на блокирование доступа к узлу и порту приложения для диапазона IP-адресов «точка-сеть».

Помните о том, что у вас нет возможности определить точный IP-адрес, используемый приложением. Поэтому вам нужно разрешить доступ для всего диапазона адресов "точка — сеть". 

Можно выполнить дополнительные действия по отладке.

* Войдите на другую виртуальную машину в этой виртуальной сети и попробуйте из нее обратиться к нужной комбинации "узел:порт". Чтобы проверить доступ TCP, используйте команду PowerShell **test-netconnection**. Синтаксис:

      test-netconnection hostname [optional: -Port]

* Откройте приложение на другой виртуальной машине и проверьте из консоли приложения доступ к узлу и порту.

#### <a name="on-premises-resources"></a>Локальные ресурсы ####

Если приложение не может перейти к ресурсу локально, проверьте, можно ли перейти к ней через виртуальную сеть. Чтобы проверить доступ по протоколу TCP, используйте команду PowerShell **test-netconnection**. Если получить доступ к локальному ресурсу с этой виртуальной машины не удастся, проверьте состояние VPN-подключения типа "сеть — сеть". Если подключение установлено, проверьте описанные выше пункты, а также конфигурацию и состояние локального шлюза. 

Если размещенная в виртуальной сети виртуальная машина может взаимодействовать с локальной системой, а приложение — нет, это может быть вызвано одной из следующих причин:

* для маршрутов в локальном шлюзе не настроены диапазоны IP-адресов подключений "точка — сеть";
* ваши группы безопасности сети блокируют доступ к диапазону IP-адресов подключений "точка — сеть";
* локальные брандмауэры блокируют трафик из диапазона IP-адресов подключений "точка — сеть";


## <a name="powershell-automation"></a>Автоматизация PowerShell

Службу приложений можно интегрировать с виртуальной сетью Azure с помощью PowerShell. Готовый к использованию скрипт см. в статье [Connect an app in Azure App Service to an Azure Virtual Network](https://gallery.technet.microsoft.com/scriptcenter/Connect-an-app-in-Azure-ab7527e3) (Подключение приложения в службе приложений Azure к виртуальной сети Azure).

## <a name="hybrid-connections-and-app-service-environments"></a>Гибридные подключения и среда службы приложений
Доступ к ресурсам виртуальной сети осуществляется тремя способами. К ним относятся:

* интеграция с виртуальной сетью;
* через гибридные подключения
* среда службы приложений.

Для гибридных подключений необходимо установить в сети агент ретрансляции, который называется диспетчером гибридного подключения. Диспетчер должен иметь возможность подключаться к Azure и к вашему приложению. В отличие от VPN-подключения, для гибридных подключений не требуется конечная точка, доступная из Интернета. Диспетчер гибридного подключения работает только на платформе Windows. Можно запустить до пяти его экземпляров, чтобы обеспечить высокую доступность. Гибридные подключения поддерживают только протокол TCP, поэтому для каждой конечной точки должна быть определена комбинация «узел:порт». 

Среда службы приложений (ASE) позволяет запустить в виртуальной сети однотенантный экземпляр службы приложений Azure. Если ваши приложения находятся в среде службы приложений, то приложения могут получать доступ к ресурсам в виртуальной сети без дополнительных действий. В среде службы приложений ваши приложения выполняются на более мощные рабочие роли и можно масштабировать до 100 экземпляров ASP. Среды службы приложений работают со всеми функциями работы с сетями, включая ExpressRoute и конечные точки служб.  

Хотя эти решения используются в сходных сценариях, они не являются взаимозаменяемыми. Выбор подходящего способа подключения напрямую зависит от понимания своих задач. Например: 

* Если вы разработчик и просто хотите запустить сайт в Azure, который будет обращаться к базе данных на вашем настольном компьютере, проще всего использовать гибридные подключения. 
* Если вы представляете большую организацию, которой нужно поместить большое количество веб-свойств в общедоступное облако для управления из своей сети, вам подойдет среда службы приложений. 
* Интеграция виртуальной сети используется при наличии нескольких приложений, которым требуется доступ к ресурсам виртуальной сети 

Если ваша виртуальная сеть уже подключена к локальной сети, использование интеграции с виртуальной сетью или среды службы приложений будет более простым способом доступа к локальным ресурсам. С другой стороны, если виртуальная сеть не подключена к локальной сети, то настройка VPN-подключения типа "сеть-сеть" окажется гораздо более затратным мероприятием по сравнению с установкой диспетчера гибридных подключений. 

Помимо функциональных различий учитывайте также разницу в стоимости решений. Среда службы приложений — это предложение класса «Премиум», которое предоставляет расширенные возможности настройки и множество других полезных функций. Интеграция с виртуальной сетью поддерживается в планах ASP уровня "Стандартный" или "Премиум". Эта функция идеально подходит для безопасного использования ресурсов в виртуальной сети из мультитенантной службы приложений. Для гибридных подключений сейчас требуется учетная запись BizTalk, которая доступна в виде бесплатной версии, а также в виде предложения, которое тарифицируется на основе используемых ресурсов. Если вам нужно работать с большим количеством сетей, лучшее решение — это гибридные подключения. Эта функция позволяет получить доступ к ресурсам, содержащимся более чем в 100 отдельных сетях. 

## <a name="new-vnet-integration"></a>Новая интеграция виртуальной сети ##

Это новая версия интеграции c виртуальной сетью, которая не зависит от VPN-подключения "точка — сеть". В отличие от имеющейся функции, новая предварительная версия функции совместима с ExpressRoute и конечными точками служб. 

Новая возможность доступна только из единиц масштабирования для новой Службы приложений Azure. Если перейти на план "Премиум V2", будет использоваться более новая единица масштабирования службы приложений. Пользовательский интерфейс интеграции с виртуальной сетью на портале сообщит об использовании приложением новой функции интеграции с виртуальной сетью. 

Новая функция доступна в предварительной версии и имеет описанные ниже характеристики.

* Для использования новой функции интеграции виртуальной сети не нужен шлюз.
* Доступ к ресурсам можно получить с помощью подключения ExpressRoute без дополнительной настройки, за исключением интеграции с виртуальной сетью, подключенной при помощи ExpressRoute.
* Приложения и виртуальная сеть должны находиться в одном регионе.
* Новой функции требуется неиспользуемая подсеть в виртуальной сети Resource Manager.
* План службы приложений должен быть одним из следующих: "Стандартный", "Премиум" или "Премиум V2".
* Предварительная версия новой функции не поддерживает рабочие нагрузки
* Приложение должно находиться в развернутой службе приложений Azure, поддерживающей масштабирование до плана "Премиум V2".
* Новая функция интеграции с виртуальной сетью не поддерживает программы в сети службы приложений.
* Удалить виртуальную сеть с интегрированным приложением невозможно.  
* Таблицы маршрутизации и глобальное пиринговое соединение пока что недоступны для новой функции интеграции с виртуальной сетью.  
* Один адрес используется для каждого экземпляра плана Службы приложений. Так как размер подсети невозможно изменить после назначения, используйте подсеть, которая может превышать максимальный размер масштабов. 32-разрядные адреса /27 являются рекомендуемым размером, так как они способны вместить план Службы приложений, который масштабируется до 20 экземпляров.
* Вы можете использовать защищенные ресурсы конечной точки службы при помощи новой функции интеграции с виртуальной сетью. Для этого включите конечные точки служб в подсети, используемой для интеграции с виртуальной сетью.

Чтобы использовать новую функцию, сделайте следующее:

1. Откройте пользовательский интерфейс работы с сетями на портале. Если ваше приложение может применять новую функцию, то у вас будет возможность использовать ее.  

   ![Выбор предварительной версии новой функции интеграции с виртуальной сетью][6]

1. Нажмите **Добавить виртуальную сеть (предварительная версия)**.  

1. Выберите нужную виртуальную сеть Resource Manager, а затем либо выберите пустую имеющуюся подсеть, либо создайте новую. Интеграция занимает меньше минуты. Во время интеграции приложение перезапускается.  По завершении интеграции вы увидите сведения об интегрированной виртуальной сети и баннер в верхней части страницы, указывающий, что это предварительная версия функции.

   ![Выбор виртуальной сети и подсети][7]

Чтобы приложение могло использовать DNS-сервер, заданный для виртуальной сети, создайте параметр приложения с именем WEBSITE_DNS_SERVER и задайте в качестве значения IP-адрес сервера.  Если у вас есть вспомогательный DNS-сервер, создайте еще один параметр приложения с именем WEBSITE_DNS_ALT_SERVER и задайте в качестве значения IP-адрес сервера. 

Чтобы отключить приложение от виртуальной сети, нажмите **Отключить**. Веб-приложение будет перезапущено. 

Новая функция интеграции с виртуальной сетью позволяет использовать конечные точки служб.  Чтобы использовать конечные точки служб с приложением, воспользуйтесь новой функцией интеграции с виртуальной сетью, чтобы подключиться к выбранной виртуальной сети в подсети, которая использовалась для интеграции. 

<!--Image references-->
[1]: ./media/web-sites-integrate-with-vnet/vnetint-app.png
[2]: ./media/web-sites-integrate-with-vnet/vnetint-addvnet.png
[3]: ./media/web-sites-integrate-with-vnet/vnetint-howitworks.png
[4]: ./media/web-sites-integrate-with-vnet/vnetint-details.png
[5]: ./media/web-sites-integrate-with-vnet/vnetint-aspdetails.png
[6]: ./media/web-sites-integrate-with-vnet/vnetint-newvnet.png
[7]: ./media/web-sites-integrate-with-vnet/vnetint-newvnetdetails.png
[8]: ./media/web-sites-integrate-with-vnet/vnetint-selectvnet.png

<!--Links-->
[VNETOverview]: https://azure.microsoft.com/documentation/articles/virtual-networks-overview/ 
[AzurePortal]: https://portal.azure.com/
[ASPricing]: https://azure.microsoft.com/pricing/details/app-service/
[VNETPricing]: https://azure.microsoft.com/pricing/details/vpn-gateway/
[DataPricing]: https://azure.microsoft.com/pricing/details/data-transfers/
[V2VNETP2S]: https://azure.microsoft.com/documentation/articles/vpn-gateway-howto-point-to-site-rm-ps/
[ASEintro]: environment/intro.md
[ILBASE]: environment/create-ilb-ase.md
[V2VNETPortal]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md
[VPNERCoex]: ../expressroute/expressroute-howto-coexist-resource-manager.md
[ASE]: environment/intro.md
[creategatewaysubnet]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#gatewaysubnet
[creategateway]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#creategw
[setp2saddresses]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#addresspool
