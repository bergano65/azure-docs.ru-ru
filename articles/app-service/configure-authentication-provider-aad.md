---
title: Настройка проверки подлинности Azure AD
description: Сведения о настройке проверки подлинности Azure Active Directory в качестве поставщика удостоверений для Службы приложений или приложения "Функции Azure".
ms.assetid: 6ec6a46c-bce4-47aa-b8a3-e133baef22eb
ms.topic: article
ms.date: 04/14/2020
ms.custom: seodec18, fasttrack-edit, has-adal-ref
ms.openlocfilehash: c3892cfe3f8bd6966f5bd00c0747590eef3bc50d
ms.sourcegitcommit: 95269d1eae0f95d42d9de410f86e8e7b4fbbb049
ms.contentlocale: ru-RU
ms.lasthandoff: 05/26/2020
ms.locfileid: "83860531"
---
# <a name="configure-your-app-service-or-azure-functions-app-to-use-azure-ad-login"></a>Настройка Службы приложений или приложения "Функции Azure" для использования имени для входа в Azure AD

[!INCLUDE [app-service-mobile-selector-authentication](../../includes/app-service-mobile-selector-authentication.md)]

В этой статье показано, как настроить Службу приложений Azure или Функции Azure для использования Azure Active Directory в качестве поставщика проверки подлинности.

> [!NOTE]
> Регистрацию приложения Azure Active Directory версии 1 можно настроить с помощью стандартного потока параметров. Если вы хотите использовать [Azure Active Directory версии 2.0](../active-directory/develop/v2-overview.md) (включая [MSAL](../active-directory/develop/msal-overview.md)), выполните [дополнительные инструкции по настройке](#advanced).

При настройке приложения и проверке подлинности следуйте приведенным ниже рекомендациям:

- Предоставьте каждому приложению Службы приложений свои разрешения и согласие.
- Настройте каждое приложение Службы приложений с собственной регистрацией.
- Создайте отдельные регистрации приложений для отдельных слотов развертывания, чтобы не предоставлять общий доступ к разрешениям в средах. Это поможет предотвратить проблемы с рабочим приложением при тестировании нового кода.

> [!NOTE]
> В настоящее время эта функция недоступна в плане "Потребление Linux" для Функций Azure

## <a name="configure-with-express-settings"></a><a name="express"> </a>Настройка с помощью стандартных параметров

> [!NOTE]
> Параметр **Экспресс** недоступен для облачных систем государственных организаций.

1. На [Портал Azure] найдите и выберите **Службы приложений**, а затем выберите приложение.
2. В области навигации слева выберите пункт **Проверка подлинности/авторизация** > **Вкл.** .
3. Выберите **Azure Active Directory** > **Экспресс**.

   Если вы хотите выбрать существующую регистрацию приложения, выполните следующие действия:

   1. Выберите **Выбрать существующее приложение AD**, затем щелкните **Приложение Azure AD**.
   2. Выберите существующую регистрацию приложения и нажмите кнопку **OK**.

3. Нажмите кнопку **ОК**, чтобы зарегистрировать приложение службы приложений в Azure Active Directory. Будет создано приложение регистрации.

    ![Стандартные параметры Azure Active Directory](./media/configure-authentication-provider-aad/express-settings.png)

4. (Необязательно.) По умолчанию Служба приложений обеспечивает проверку подлинности, но не ограничивает авторизованный доступ к содержимому сайта и API. Авторизация пользователей должна быть включена в код приложения. Чтобы предоставить доступ к приложению только пользователям, прошедшим проверку подлинности в Azure Active Directory, установите для параметра **Предпринимаемое действие, если проверка подлинности для запроса не выполнена** значение **Войти с использованием Azure Active Directory**. При установке этой функции приложению требуется выполнить проверку подлинности всех запросов. Оно также перенаправляет в Azure Active Directory для проверки подлинности все запросы, которые ее не прошли.

    > [!CAUTION]
    > Таким образом, ограниченный доступ применяется ко всем вызовам приложения, что может быть нежелательно для приложений, у которых есть общедоступная домашняя страница (как во многих одностраничных приложениях). Для таких приложений может быть предпочтительным установить параметр **Разрешить анонимные запросы (нет действия)** . При этом приложение выполняет вход самостоятельно. Дополнительные сведения см. в разделе [Поток проверки подлинности](overview-authentication-authorization.md#authentication-flow).
5. Щелкните **Сохранить**.

## <a name="configure-with-advanced-settings"></a><a name="advanced"> </a>Настройка с помощью дополнительных параметров

Вы можете настроить параметры приложения вручную, если хотите использовать регистрацию приложения из другого клиента Azure AD. Для выполнения этой настраиваемой конфигурации, сделайте следующее:

1. Создайте регистрацию в Azure AD.
2. Укажите некоторые сведения о регистрации в Службе приложений.

### <a name="create-an-app-registration-in-azure-ad-for-your-app-service-app"></a><a name="register"> </a>Создание регистрации приложения в Azure AD для приложения Службы приложений

При настройке приложения Службы приложений необходимо иметь следующую информацию:

- Идентификатор клиента
- Tenant ID
- секрет клиента (необязательно);
- универсальный код ресурса (URI) идентификатора приложения.

Выполните следующие действия:

1. Войдите на [портал Azure] найдите и выберите **Службы приложений**, а затем выберите приложение. Запишите **URL-адрес** приложения. Он будет использоваться для настройки регистрации приложения Azure Active Directory.
1. Последовательно выберите элементы **Azure Active Directory** > **Регистрация приложений** > **Новая регистрация**.
1. На странице **Регистрация приложения** введите **Имя** для регистрации приложения.
1. В разделе **URI перенаправления** выберите **Интернет** и введите `<app-url>/.auth/login/aad/callback`. Например, `https://contoso.azurewebsites.net/.auth/login/aad/callback`.
1. Нажмите кнопку **создания**.
1. После создания регистрации приложения скопируйте **идентификатор приложения (клиент)** и **идентификатор каталога (клиент)** для дальнейшего использования.
1. Выберите **Проверка подлинности**. В разделе **Неявное предоставление** активируйте параметр **Токен идентификатора**, чтобы разрешить вход пользователей OpenID Connect из Службы приложений.
1. (Необязательно.) Выберите **Фирменная символика**. В поле **URL-адрес домашней страницы** введите URL-адрес приложения Службы приложений и выберите **Сохранить**.
1. Выберите **Предоставление API** > **Установить**. В приложении с одним клиентом вставьте URL-адрес приложения Службы приложений и выберите **Сохранить**, а для приложения с несколькими клиентами вставьте URL-адрес на основе одного из проверенных доменов клиента, а затем нажмите кнопку **Сохранить**.

   > [!NOTE]
   > Это **универсальный код ресурса (URI) идентификатора приложения** регистрации приложения. Если веб-приложению требуется доступ к API в облаке, вам нужен будет **URI идентификатора приложения** веб-приложения при настройке ресурса облачной Службы приложений. Его можно использовать, например, если требуется, чтобы облачная служба явно предоставляла доступ к веб-приложению.

1. Нажмите **Добавить группу**.
   1. В разделе **Имя области** введите *user_impersonation*.
   1. В текстовых полях введите имя и описание области согласия, которые пользователи должны видеть на странице согласия. Например, введите *Доступ к моему приложению*.
   1. Выберите **Добавить область**.
1. (Необязательно) Чтобы создать секрет клиента, выберите **Сертификаты и секреты** > **Создать секрет клиента** > **Добавить**. Скопируйте значение секрета клиента, показанное на странице. Он больше не будет отображаться.
1. (Необязательно) Чтобы добавить несколько **URL-адресов ответа**, выберите **Проверка подлинности**.

### <a name="enable-azure-active-directory-in-your-app-service-app"></a><a name="secrets"> </a>Включение Azure Active Directory в приложение Службы приложений

1. На [Портал Azure] найдите и выберите **Службы приложений**, а затем выберите приложение.
1. В левой области в разделе **Параметры** выберите **Проверка подлинности/авторизация** > **Вкл.**
1. (Необязательно) По умолчанию проверка подлинности службы приложений разрешает доступ к приложению без проверки подлинности. Чтобы принудительно выполнить проверку подлинности, задайте для параметра **Действие, которое необходимо выполнить, если проверка подлинности запроса не выполнена** значение **Войти с помощью Azure Active Directory**.
1. В разделе **Поставщики проверки подлинности** выберите **Azure Active Directory**.
1. В разделе **Режим управления** выберите **Расширенный** и настройте проверку подлинности Службы приложений в соответствии со следующей таблицей:

    |Поле|Описание|
    |-|-|
    |Идентификатор клиента| Используйте **идентификатор приложения (клиент)** регистрации приложения. |
    |Url-адрес издателя| Используйте `<authentication-endpoint>/<tenant-id>/v2.0` и замените значение *\<конечная_точка_проверки_подлинности>* [конечной точкой проверки подлинности облачной среды](../active-directory/develop/authentication-national-cloud.md#azure-ad-authentication-endpoints) (например, https://login.microsoft.com для глобальной среды Azure). Также замените *\< идентификатор_клиента>* **идентификатором каталога (клиента)** , в котором была создана регистрация приложения. Это значение используется для перенаправления пользователей в правильный клиент Azure AD, а также для скачивания соответствующих метаданных, чтобы определить, например, соответствующие ключи подписей маркера и значение утверждения поставщика маркеров. Для приложений, использующих Azure Active Directory версии 1, раздел `/v2.0` можно опустить. |
    |Секрет клиента (необязательно)| Используйте секрет клиента, созданный при регистрации приложения.|
    |Разрешенные аудитории маркеров| Если это облачное или серверное приложение и вы хотите разрешить использовать маркеры проверки подлинности из веб-приложения, введите в этом поле **URI идентификатора приложения** веб-приложения. Настроенный **идентификатор клиента** *всегда* косвенно считается разрешенной аудиторией. |

2. Нажмите кнопку **ОК**, а затем нажмите кнопку **Сохранить**.

Теперь вы можете использовать Azure Active Directory для проверки подлинности в приложении Службы приложений.

## <a name="configure-a-native-client-application"></a>Настройка собственного клиентского приложения

Вы можете зарегистрировать собственные клиенты, чтобы разрешить проверку подлинности размещенных в приложении веб-API с помощью клиентской библиотеки, такой как **Библиотека проверки подлинности Active Directory**.

1. На [Портал Azure] последовательно выберите **Active Directory** > **Регистрация приложений** > **Новая регистрация**.
1. На странице **Регистрация приложения** введите **Имя** для регистрации приложения.
1. В разделе **URI перенаправления** выберите **Общедоступный клиент (мобильный и классический)** и введите URL-адрес `<app-url>/.auth/login/aad/callback`. Например, `https://contoso.azurewebsites.net/.auth/login/aad/callback`.

    > [!NOTE]
    > Для приложения Microsoft Store вместо этого используйте [идентификатор безопасности пакета](../app-service-mobile/app-service-mobile-dotnet-how-to-use-client-library.md#package-sid) в качестве универсального код ресурса (URI).
1. Нажмите кнопку **создания**.
1. После создания регистрации приложения скопируйте значение **идентификатора приложения (клиент)** .
1. Выберите **Разрешения API** > **Добавить разрешение** > **Мои API**.
1. Выберите регистрацию приложения, созданную ранее для приложения Службы приложений. Если регистрация приложения не отображается, убедитесь, что вы добавили область **user_impersonation** в разделе [Создание регистрации приложения в Azure AD для приложения Службы приложений](#register).
1. В разделе **Делегированные разрешения** выберите **user_impersonation** и **Добавить разрешения**.

Теперь вы настроили собственное клиентское приложение, у которого есть доступ к вашему приложению Службы приложений от имени пользователя.

## <a name="configure-a-daemon-client-application-for-service-to-service-calls"></a>Настройка клиентского приложения в качестве управляющей программы для вызовов между службами

Приложение может получить маркер для вызова веб-интерфейса API, размещенного в Службе приложений или приложении-функции, от собственного имени (а не от имени пользователя). Такой сценарий подходит для неинтерактивных управляющих приложений, которые выполняют свои задачи без входа пользователя в систему. В нем используется стандартное предоставление [учетных данных клиента](../active-directory/azuread-dev/v1-oauth2-client-creds-grant-flow.md) OAuth 2.0.

1. На [Портал Azure] последовательно выберите **Active Directory** > **Регистрация приложений** > **Новая регистрация**.
1. На странице **Регистрация приложения** введите значение в поле **Имя** для регистрации управляющего приложения.
1. Для управляющего приложения не требуется URI перенаправления, поэтому это поле можно оставить пустым.
1. Нажмите кнопку **создания**.
1. После создания регистрации приложения скопируйте значение **идентификатора приложения (клиент)** .
1. Выберите **Сертификаты и секреты** > **Новый секрет клиента** > **Добавить**. Скопируйте значение секрета клиента, показанное на странице. Он больше не будет отображаться.

Теперь вы можете [запросить маркер доступа с помощью идентификатора клиента и секрета клиента](../active-directory/azuread-dev/v1-oauth2-client-creds-grant-flow.md#first-case-access-token-request-with-a-shared-secret), присвоив параметру `resource` значение **URI идентификатора приложения** для целевого приложения. Полученный маркер доступа можно представить целевому приложению через стандартный [заголовок авторизации OAuth 2.0](../active-directory/azuread-dev/v1-oauth2-client-creds-grant-flow.md#use-the-access-token-to-access-the-secured-resource), а система проверки подлинности и авторизации в Службе приложений проверит и применит маркер обычным образом, чтобы подтвердить подлинность вызывающего объекта (которым в этом сценарии является приложение, а не пользователь).

В настоящее время это позволяет _любому_ клиентскому приложению в арендаторе Azure AD запросить маркер доступа и пройти проверку подлинности в целевом приложении. Если вы хотите применить _авторизацию_, чтобы предоставлять доступ для определенных клиентских приложений, придется выполнить дополнительную настройку.

1. [Определите роль приложения](../active-directory/develop/howto-add-app-roles-in-azure-ad-apps.md) в манифесте регистрации, который определяет защищаемую Службу приложений или приложение-функцию.
1. На странице регистрации приложения, которое представляет требующего авторизации клиента, выберите **Разрешения API** > **Добавить разрешение** > **Мои API**.
1. Выберите созданную ранее регистрацию приложения. Если регистрация приложения здесь не отображается, убедитесь, что вы [добавили роль приложения](../active-directory/develop/howto-add-app-roles-in-azure-ad-apps.md).
1. В разделе **Разрешения приложения** выберите созданную ранее роль приложения, а затем выберите **Добавить разрешения**.
1. Обязательно щелкните элемент **Предоставить согласие администратора**, чтобы разрешить клиентскому приложению запрашивать разрешение.
1. Как и в предыдущем сценарии (еще до добавления ролей), теперь вы можете [запросить маркер доступа](../active-directory/azuread-dev/v1-oauth2-client-creds-grant-flow.md#first-case-access-token-request-with-a-shared-secret) для того же целевого объекта `resource`, и этот маркер доступа будет содержать утверждение `roles` со списком ролей приложения, которые утверждены для клиентского приложения.
1. В коде целевой Службы приложений или приложения-функции теперь можно проверить наличие ожидаемых ролей в маркере (эта операция не выполняется системой проверки подлинности и авторизации в Службе приложений). Дополнительные сведения см. в разделе [Access user claims](app-service-authentication-how-to.md#access-user-claims) (Доступ к утверждениям пользователя).

Итак, вы настроили для клиентского приложения управляющей программы возможность доступа к приложению Службы приложений с собственным идентификатором.

## <a name="next-steps"></a><a name="related-content"> </a>Дальнейшие действия

[!INCLUDE [app-service-mobile-related-content-get-started-users](../../includes/app-service-mobile-related-content-get-started-users.md)]
* [Руководство. Сквозная проверка подлинности и авторизация в Службе приложений Azure](app-service-web-tutorial-auth-aad.md)
<!-- URLs. -->

[Портал Azure]: https://portal.azure.com/
