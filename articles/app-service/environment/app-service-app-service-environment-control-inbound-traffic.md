---
title: Управление входящим трафиком v1
description: Узнайте, как управлять входящим трафиком к Среда службы приложений. Этот документ предоставляется только для клиентов, использующих устаревшую версию ASE (версию 1).
author: ccompy
ms.assetid: 4cc82439-8791-48a4-9485-de6d8e1d1a08
ms.topic: article
ms.date: 01/11/2017
ms.author: stefsch
ms.custom: seodec18
ms.openlocfilehash: fe9326ea9ebd5afe981b7ba6c34b1a5d51e084b0
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "88962066"
---
# <a name="how-to-control-inbound-traffic-to-an-app-service-environment"></a>Как управлять входящим трафиком в среде службы приложений
## <a name="overview"></a>Обзор
Среду службы приложений можно создать **либо** в виртуальной сети Azure Resource Manager, **либо** в [виртуальной сети][virtualnetwork], использующей классическую модель развертывания.  Новые виртуальную сеть и подсеть можно определить во время создания среды службы приложений. Вместо этого Среда службы приложений можно создать в предварительно существующей виртуальной сети и в существующей подсети.  Начиная с июня 2016 среды ASE можно развернуть в виртуальных сетях, использующих либо общедоступные диапазоны адресов, либо АДРЕСНЫЕ пространства RFC1918 адресные пространства (частные адреса).  Дополнительные сведения см. [в разделе создание среда службы приложений][HowToCreateAnAppServiceEnvironment].

Всегда создавайте Среда службы приложений в подсети. Подсеть предоставляет границу сети, которую можно использовать для блокировки входящего трафика за пределами вышестоящего устройства и служб. Эта установка позволяет принимать трафик HTTP и HTTPS только конкретными вышестоящим IP-адресам.

Входящий и исходящий сетевой трафик в подсети контролируется с помощью [группы сетевой безопасности][NetworkSecurityGroups]. Чтобы управлять входящим трафиком, создайте правила безопасности сети в группе безопасности сети. Затем назначьте группе безопасности сети подсеть, содержащую Среда службы приложений.

После назначения группы безопасности сети для подсети входящий трафик к приложениям в Среда службы приложений разрешается или блокируется на основе правил разрешения и отказа, определенных в группе безопасности сети.

[!INCLUDE [app-service-web-to-api-and-mobile](../../../includes/app-service-web-to-api-and-mobile.md)]

## <a name="inbound-network-ports-used-in-an-app-service-environment"></a>Входящие сетевые порты, используемые в среде службы приложений
Прежде чем блокировать входящий сетевой трафик в группе безопасности сети, необходимо определить набор обязательных и необязательных сетевых портов, используемых Среда службы приложений.  Случайное закрытие трафика на некоторых портах может привести к потере функциональности в среде службы приложений.

В следующем списке содержатся порты, используемые Среда службы приложений. Это все **TCP**-порты, если явно не указано иное.

* 454:  **необходимый порт** , используемый инфраструктурой Azure для управления средами службы приложений и их обслуживания через TLS.  Не блокируйте трафик на этот порт.  Этот порт всегда привязан к общедоступному виртуальному IP-адресу ASE.
* 455:  **необходимый порт** , используемый инфраструктурой Azure для управления средами службы приложений и их обслуживания через TLS.  Не блокируйте трафик на этот порт.  Этот порт всегда привязан к общедоступному виртуальному IP-адресу ASE.
* 80: порт по умолчанию для входящего HTTP-трафика для приложений, выполняемых в планах службы приложений в среде службы приложений.  В ASE с внутренним балансировщиком нагрузки этот порт привязан к адресу балансировщика нагрузки ASE.
* 443: порт по умолчанию для входящего трафика TLS для приложений, которые выполняются в планах службы приложений в Среда службы приложений.  В ASE с внутренним балансировщиком нагрузки этот порт привязан к адресу балансировщика нагрузки ASE.
* 21: канал управления для FTP.  Этот порт можно безопасно заблокировать, если FTP не используется.  В ASE с внутренним балансировщиком нагрузки этот порт может быть привязан к адресу балансировщика нагрузки ASE.
* 990: канал управления для FTPS.  Этот порт можно безопасно заблокировать, если FTPS не используется.  В ASE с внутренним балансировщиком нагрузки этот порт может быть привязан к адресу балансировщика нагрузки ASE.
* 10001 10020: каналы данных для FTP.  Как и канал управления, эти порты можно безопасно заблокировать, если FTP не используется.  В ASE с внутренним балансировщиком нагрузки этот порт может быть привязан к адресу балансировщика нагрузки ASE.
* 4016: используется для удаленной отладки с помощью Visual Studio 2012.  Этот порт можно безопасно заблокировать, если функция не используется.  В ASE с внутренним балансировщиком нагрузки этот порт привязан к адресу балансировщика нагрузки ASE.
* 4018: используется для удаленной отладки с помощью Visual Studio 2013.  Этот порт можно безопасно заблокировать, если функция не используется.  В ASE с внутренним балансировщиком нагрузки этот порт привязан к адресу балансировщика нагрузки ASE.
* 4020: используется для удаленной отладки с помощью Visual Studio 2015.  Этот порт можно безопасно заблокировать, если функция не используется.  В ASE с внутренним балансировщиком нагрузки этот порт привязан к адресу балансировщика нагрузки ASE.

## <a name="outbound-connectivity-and-dns-requirements"></a>Требования к DNS и исходящим подключениям
Для надлежащего функционирования среды службы приложений также требуется исходящий доступ к различным конечным точкам. Полный список внешних конечных точек, используемых в ASE, приведен в разделе "Необходимое сетевое подключение" статьи [Сведения о конфигурации сети для сред службы приложений с ExpressRoute](app-service-app-service-environment-network-configuration-expressroute.md#required-network-connectivity) .

Для сред службы приложений требуется, чтобы для виртуальной сети была настроена допустимая инфраструктура DNS.  Если конфигурация DNS изменилась после создания Среда службы приложений, разработчики могут принудительно принудить Среда службы приложений выбрать новую конфигурацию DNS.  Если вы запускаете многошаговую перезагрузку среды с помощью значка **перезагрузки** , среда выбирает новую конфигурацию DNS. (Значок **перезагрузки** находится в верхней части колонки управления Среда службы приложений в [портал Azure][NewPortal].)

Также рекомендуется заранее настроить все пользовательские DNS-серверы в виртуальной сети перед созданием Среда службы приложений.  При изменении конфигурации DNS виртуальной сети во время создания Среда службы приложений процесс создания Среда службы приложений завершится ошибкой.  Аналогичным образом, если имеется пользовательский DNS-сервер, который недоступен или недоступен на другом конце VPN-шлюза, процесс создания Среда службы приложений также завершится ошибкой.

## <a name="creating-a-network-security-group"></a>Создание группы сетевой безопасности
Подробные сведения о принципах работы групп сетевой безопасности см. [здесь][NetworkSecurityGroups].  В приведенном ниже примере управления службами Azure рассматриваются основные группы безопасности сети. В примере настраивается и применяется группа безопасности сети к подсети, содержащей Среда службы приложений.

**Примечание.** Группы безопасности сети можно настроить в графическом виде с помощью [портал Azure](https://portal.azure.com) или с помощью Azure PowerShell.

Сначала группы сетевой безопасности создаются как отдельные сущности, связанные с подпиской. Так как группы безопасности сети создаются в регионе Azure, создайте группу безопасности сети в том же регионе, что и Среда службы приложений.

Следующая команда демонстрирует создание группы безопасности сети.

```azurepowershell-interactive
New-AzureNetworkSecurityGroup -Name "testNSGexample" -Location "South Central US" -Label "Example network security group for an app service environment"
```

После создания группы сетевой безопасности к ней добавляются одно или несколько правил сетевой безопасности.  Так как набор правил может измениться со временем, следует проделать пробел в схеме нумерации, используемой для приоритетов правил. Такой подход позволяет легко вставлять дополнительные правила с течением времени.

В приведенном ниже примере правило явно предоставляет доступ к портам управления, необходимым инфраструктуре Azure, для управления Среда службы приложений и их обслуживания.  Весь трафик управления проходит через TLS и защищен сертификатами клиентов. Несмотря на то, что порты открыты, они недоступны для любой сущности, отличной от инфраструктуры управления Azure.

```azurepowershell-interactive
Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "ALLOW AzureMngmt" -Type Inbound -Priority 100 -Action Allow -SourceAddressPrefix 'INTERNET'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '454-455' -Protocol TCP
```

При блокировке доступа к портам 80 и 443 для "скрытия" Среда службы приложений за пределами вышестоящего устройства или служб, запомните вышестоящий IP-адрес.  Например, если вы используете брандмауэр веб-приложения (WAF), WAF будет иметь собственный IP-адрес или адреса. WAF использует их при прокси-трафике к подчиненной Среда службы приложений.  Этот IP-адрес потребуется использовать в параметре *SourceAddressPrefix* правила безопасности сети.

В следующем примере входящий трафик от конкретного вышестоящего IP-адреса полностью разрешен.  Адрес *1.2.3.4* используется как заполнитель для IP-адреса вышестоящего WAF.  Измените значение адреса на адрес, используемый вышестоящим устройством или службой.

```azurepowershell-interactive
Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT HTTP" -Type Inbound -Priority 200 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '80' -Protocol TCP
Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT HTTPS" -Type Inbound -Priority 300 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '443' -Protocol TCP
```

Если требуется поддержка по протоколу FTP, используйте следующие правила в качестве шаблона, чтобы предоставить доступ к порту управления FTP и портам каналов данных.  Так как FTP является протоколом с отслеживанием состояния, вы не можете маршрутизировать FTP-трафик через традиционный брандмауэр HTTP/HTTPS или прокси-устройство.  В этом случае необходимо задать для *SourceAddressPrefix* другое значение, например диапазон IP-адресов для компьютеров разработчика или развертывания, на которых выполняются FTP-клиенты. 

```azurepowershell-interactive
Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT FTPCtrl" -Type Inbound -Priority 400 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '21' -Protocol TCP
Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT FTPDataRange" -Type Inbound -Priority 500 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '10001-10020' -Protocol TCP
```

(**Примечание.**  диапазон портов канала данных может измениться в период действия предварительной версии.)

Следующие правила показывают, как предоставить доступ при использовании удаленной отладки с помощью Visual Studio.  Для каждой поддерживаемой версии Visual Studio существует отдельное правило, так как каждая версия использует другой порт для удаленной отладки.  Как и для FTP-доступа, трафик удаленной отладки не может правильно проходить через традиционный брандмауэр WAF или прокси-устройство.  Для параметра *SourceAddressPrefix* вместо этого можно задать значение диапазона IP-адресов машины разработчиков, на которых запущена программа Visual Studio.

```azurepowershell-interactive
Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT RemoteDebuggingVS2012" -Type Inbound -Priority 600 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '4016' -Protocol TCP
Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT RemoteDebuggingVS2013" -Type Inbound -Priority 700 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '4018' -Protocol TCP
Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT RemoteDebuggingVS2015" -Type Inbound -Priority 800 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '4020' -Protocol TCP
```

## <a name="assigning-a-network-security-group-to-a-subnet"></a>Назначение группы сетевой безопасности для подсети
Группа безопасности сети имеет правило безопасности по умолчанию, которое запрещает доступ ко всему внешнему трафику. При объединении этого правила с правилами безопасности сети, указанными выше, только трафик из диапазонов адресов источника, связанных с действием *Разрешить* , будет иметь возможность отправки трафика приложениям, которые выполняются в среда службы приложений.

После заполнения группы безопасности сети правилами безопасности назначьте ее подсети, содержащей Среда службы приложений.  Команда назначения ссылается на два имени: имя виртуальной сети, в которой находится Среда службы приложений, и имя подсети, в которой была создана Среда службы приложений.  

В приведенном ниже примере показана группа сетевой безопасности, назначаемая для подсети и виртуальной сети.

```azurepowershell-interactive
Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityGroupToSubnet -VirtualNetworkName 'testVNet' -SubnetName 'Subnet-test'
```

Назначение — это длительная операция, выполнение которой может занять несколько минут. После успешного назначения группы безопасности сети только входящий трафик, соответствующий *разрешенным* правилам, будет успешно достигать приложения в среда службы приложений.

Для полноты в следующем примере показано, как удалить и разорвать связь группы безопасности сети с подсетью.

```azurepowershell-interactive
Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Remove-AzureNetworkSecurityGroupFromSubnet -VirtualNetworkName 'testVNet' -SubnetName 'Subnet-test'
```

## <a name="special-considerations-for-explicit-ip-ssl"></a>Специальные рекомендации для SSL на основе явного IP
Если в приложении настроен явный IP-адрес SSL (применимо *только* к среды ASE, имеющему общедоступный виртуальный IP-адрес), то вместо использования по умолчанию среда службы приложений адреса HTTP и HTTPS трафик передается в подсеть через порты, отличные от портов 80 и 443.

Чтобы найти отдельную пару портов, используемую каждым IP-адресом SSL, перейдите на портал и просмотрите колонку интерфейса пользователя Среда службы приложений.  Выберите **все параметры**  >  **IP-адреса**.  В колонке **IP-адреса** отображается таблица всех явно настроенных IP-адресов SSL для среда службы приложений. В колонке также показана специальная пара портов, которая используется для маршрутизации трафика HTTP и HTTPS, связанного с каждым IP-адресом SSL.  Используйте эту пару портов для параметров Destinationportrange и при настройке правил в группе безопасности сети.

Если приложение в ASE настроено для использования IP-SSL, внешние клиенты не увидят или не должны беспокоиться о сопоставлении специальной пары портов.  Трафик к приложениям будет проходить обычным образом по настроенному адресу SSL на основе IP.  Перевод в специальную пару портов автоматически выполняется внутренним образом во время маршрутизации конечного участка трафика в подсеть, которая содержит ASE. 

## <a name="getting-started"></a>Начало работы
Чтобы приступить к работе со средами службы приложений, см. статью [Общие сведения о среда службы приложений][IntroToAppServiceEnvironment].

Дополнительные сведения см. в разделе [безопасное подключение к серверным ресурсам из среда службы приложений][SecurelyConnecttoBackend].

[!INCLUDE [app-service-web-try-app-service](../../../includes/app-service-web-try-app-service.md)]

<!-- LINKS -->
[virtualnetwork]: ../../virtual-network/virtual-networks-faq.md
[HowToCreateAnAppServiceEnvironment]: app-service-web-how-to-create-an-app-service-environment.md
[NetworkSecurityGroups]: ../../virtual-network/virtual-network-vnet-plan-design-arm.md
[IntroToAppServiceEnvironment]:  app-service-app-service-environment-intro.md
[SecurelyConnecttoBackend]:  app-service-app-service-environment-securely-connecting-to-backend-resources.md
[NewPortal]:  https://portal.azure.com  

<!-- IMAGES -->