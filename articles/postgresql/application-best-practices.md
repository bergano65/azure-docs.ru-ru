---
title: Рекомендации по разработке приложений — База данных Azure для PostgreSQL
description: Узнайте о рекомендациях по созданию приложения с помощью базы данных Azure для PostgreSQL.
author: mksuni
ms.author: sumuth
ms.service: postgresql
ms.topic: conceptual
ms.date: 12/10/2020
ms.openlocfilehash: 6463f30bc79d937bd5a51a5c8c78fbdd72954b1e
ms.sourcegitcommit: dfc4e6b57b2cb87dbcce5562945678e76d3ac7b6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2020
ms.locfileid: "97364622"
---
# <a name="best-practices-for-building-an-application-with-azure-database-for-postgresql"></a>Рекомендации по созданию приложения с помощью базы данных Azure для PostgreSQL

Ниже приведены некоторые рекомендации, которые помогут вам создать приложение, готовое к работе в облаке, с помощью базы данных Azure для PostgreSQL. Эти рекомендации могут сократить время разработки приложения.

## <a name="configuration-of-application-and-database-resources"></a>Настройка ресурсов приложения и базы данных

### <a name="keep-the-application-and-database-in-the-same-region"></a>Обеспечение сохранения приложения и базы данных в одном регионе
Убедитесь, что все зависимости находятся в одном регионе при развертывании приложения в Azure. Распределение экземпляров по регионам или зонам доступности создает задержку в сети, что может повлиять на общую производительность приложения.

### <a name="keep-your-postgresql-server-secure"></a>Обеспечьте безопасность сервера PostgreSQL
Настройте сервер PostgreSQL для [обеспечения безопасности](./concepts-security.md) и недоступности в публичном виде. Для защиты сервера используйте один из следующих вариантов.
- [Правила брандмауэра](./concepts-firewall-rules.md)
- [Виртуальные сети](./concepts-data-access-and-security-vnet.md)
- [Приватный канал Azure](./concepts-data-access-and-security-private-link.md)

Для обеспечения безопасности необходимо всегда подключаться к серверу PostgreSQL по протоколу SSL и настроить сервер PostgreSQL и приложение для использования TLS 1,2. См. раздел [Настройка SSL/TLS](./concepts-ssl-connection-security.md).

### <a name="tune-your-server-parameters"></a>Настройка параметров сервера
Для рабочих нагрузок с большим количеством операций чтения параметры сервера, `tmp_table_size` которые `max_heap_table_size` могут помочь оптимизировать производительность. Чтобы вычислить значения, необходимые для этих переменных, просмотрите общие значения памяти для каждого подключения и базовую память. Сумма параметров памяти для каждого подключения, исключая вместе `tmp_table_size` с учетными записями базовой памяти для общего объема памяти сервера.

### <a name="use-environment-variables-for-connection-information"></a>Использование переменных среды для сведений о соединении
Не сохраняйте учетные данные базы данных в коде приложения. В зависимости от приложения внешнего интерфейса следуйте указаниям по настройке переменных среды. Сведения об использовании службы приложений см. в статье как[настроить параметры приложения](../app-service/configure-common.md#configure-app-settings) и Azure куберентес Service. см. раздел [Использование секретов Kubernetes](https://kubernetes.io/docs/concepts/configuration/secret/).

## <a name="performance-and-resiliency"></a>Производительность и устойчивость
Ниже приведены некоторые средства и рекомендации, которые можно использовать для отладки проблем с производительностью приложения.

### <a name="use-connection-pooling"></a>Использование пулов соединений
При использовании пулов соединений фиксированный набор соединений устанавливается во время запуска и сохраняется. Это также помогает снизить фрагментацию памяти на сервере, вызванный динамическими новыми соединениями, установленными на сервере базы данных. Пулы подключений можно настроить на стороне приложения, если она поддерживается платформой приложений или драйвером базы данных. Если это не поддерживается, рекомендуется использовать службу пула прокси-подключений, например [пгбаунцер](https://pgbouncer.github.io/) или [pgpool](https://pgpool.net/mediawiki/index.php/Main_Page) , работающую за пределами приложения, и подключиться к серверу базы данных. Пгбаунцер и pgpool являются инструментами на основе сообщества, которые работают с базой данных Azure для PostgreSQL.

### <a name="retry-logic-to-handle-transient-errors"></a>Логика повторных попыток для обработки временных ошибок
Приложение может столкнуться с временными ошибками, при которых подключения к базе данных удаляются или теряются периодически. В таких ситуациях сервер работает и работает после двух повторных попыток через 5 – 10 секунд. Рекомендуется подождать 5 секунд перед первой попыткой. Затем выполните каждую повторную попытку, увеличив время ожидания до 60 секунд. Ограничьте максимальное количество повторных попыток, при котором приложение считает, что операция завершилась сбоем, поэтому вы можете продолжить исследование. Дополнительные сведения см. в разделе [Устранение ошибок подключения](./concepts-connectivity.md) .

### <a name="enable-read-replication-to-mitigate-failovers"></a>Включение репликации чтения для устранения отработки отказа
Для сценариев отработки отказа можно использовать [репликация входных данных](./concepts-read-replicas.md) . Если вы используете реплики чтения, происходит автоматическая отработка отказа между сервером источника и реплики. Вы заметите задержку между источником и репликой, так как репликация выполняется асинхронно. На задержку сети может влиять множество факторов, например размер рабочей нагрузки, выполняемой на исходном сервере, и задержка между центрами обработки данных. В большинстве случаев запаздывание реплики находится в диапазоне от нескольких секунд до нескольких минут.


## <a name="database-deployment"></a>Развертывание базы данных

### <a name="configure-cicd-deployment-pipeline"></a>Настройка конвейера развертывания CI/CD
Иногда необходимо развернуть изменения в базе данных. В таких случаях можно использовать непрерывную интеграцию (CI) с помощью [действий GitHub](https://github.com/Azure/postgresql/blob/master/README.md) для сервера PostgreSQL, чтобы обновить базу данных, запустив для нее пользовательский сценарий.

### <a name="define-manual-database-deployment-process"></a>Определение процесса развертывания базы данных вручную
При ручном развертывании базы данных выполните следующие действия, чтобы свести к минимуму время простоя или снизить риск сбоя развертывания.

- Создайте копию рабочей базы данных в новой базе данных с помощью pg_dump.
- Обновите новую базу данных новыми изменениями схемы или обновлениями, необходимыми для базы данных.
- Перевод рабочей базы данных в состояние "только для чтения". В рабочей базе данных не должно быть операций записи, пока развертывание не будет завершено.
- Протестируйте приложение с обновленной базой данных, созданной на шаге 1.
- Разверните изменения приложения и убедитесь, что приложение теперь использует новую базу данных с последними обновлениями.
- Используйте старую рабочую базу данных, чтобы можно было откатить изменения. Затем можно будет либо удалить старую рабочую базу данных, либо экспортировать ее в службу хранилища Azure, если это необходимо.

>  [!NOTE]
> Если приложение похоже на приложение электронной коммерции и его нельзя перевести в состояние только для чтения, разверните изменения непосредственно в рабочей базе данных после создания резервной копии. Эти изменения должны происходить в часы наименьшей нагрузки с низким трафиком к приложению, чтобы уменьшить влияние, поскольку некоторые пользователи могут столкнуться с неудачными запросами. Убедитесь, что код приложения также обрабатывает все неудачные запросы.

## <a name="database-schema-and-queries"></a>Схема базы данных и запросы
Ниже приведены некоторые рекомендации, которые следует учитывать при построении схемы базы данных и запросов.

### <a name="use-bigint-or-uuid-for-primary-keys"></a>Использование BIGINT или UUID для первичных ключей
При создании пользовательского приложения или некоторых платформ `INT` вместо `BIGINT` первичных ключей может использоваться и. При использовании ```INT``` вы запускаете риск того, что значение в базе данных может превышать емкость хранилища для ```INT``` типа данных. Внесение этого изменения в существующее рабочее приложение может занимать много времени, что требует больших затрат времени на разработку. Другой вариант — использовать [UUID](https://www.postgresql.org/docs/current/datatype-uuid.html) для первичных ключей. Этот идентификатор использует автоматически созданную 128-разрядную строку, например ```a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11``` . Дополнительные сведения о [типах данных PostgreSQL](https://www.postgresql.org/docs/8.1/datatype.html).

### <a name="use-indexes"></a>Использование индексов

Существует много типов [индексов](https://www.postgresql.org/docs/9.1/indexes.html) в postgres, которые могут использоваться различными способами. Использование индекса помогает серверу находить и извлекать определенные строки гораздо быстрее, чем без индекса. Но индексы также добавляют дополнительные издержки на сервер базы данных, поэтому не рекомендуется использовать слишком много индексов.

### <a name="use-autovacuum"></a>Использование автоочистки
Вы можете оптимизировать сервер с помощью автоочистки на сервере базы данных Azure для PostgreSQL. PostgreSQL позволяют увеличить параллелизм базы данных, но при каждом обновлении в инструкциях INSERT и DELETE. Для удаления записи имеют мягкую маркировку, которая будет очищена позже. Для выполнения этих задач PostgreSQL запускает задание очистки. Если время от времени не выполнять очистку, накопление неиспользуемых кортежей может привести к:

- раздуванию данных — большему размеру баз данных и таблиц;
- большему размеру субоптимальных индексов;
- увеличению числа операций ввода-вывода.

Узнайте больше о [том, как оптимизировать работу с помощью автоочистки](howto-optimize-autovacuum.md).

### <a name="use-pg_stats_statements"></a>Использование pg_stats_statements
Pg_stat_statements является расширением PostgreSQL, которое по умолчанию включено в Базе данных Azure для PostgreSQL. Оно предоставляет средства для отслеживания статистики выполнения всех инструкций SQL, выполняемых сервером. См. раздел [использование pg_statement](howto-optimize-query-stats-collection.md).


### <a name="use-the-query-store"></a>Использование хранилища запросов
Компонент [Хранилище запросов](./concepts-query-store.md) в Базе данных Azure для PostgreSQL предоставляет более эффективный метод отслеживания статистики запросов. Этот компонент рекомендуется в качестве альтернативы использованию pg_stats_statements.

### <a name="optimize-bulk-inserts-and-use-transient-data"></a>Оптимизация операций вставки и использования временных данных
Если ваши операции рабочей нагрузки включают временные данные или вставляют большие наборы данных в пакетном режиме, рассмотрите возможность использования нерегистрируемых таблиц. Она по умолчанию обеспечивает атомарность и устойчивость. Атомарность, согласованность, изолированность и устойчивость составляют свойства ACID. См. статью [Оптимизация операций вставки](howto-optimize-bulk-inserts.md).

## <a name="next-steps"></a>Next Steps
[Postgres Guide](http://postgresguide.com/)
