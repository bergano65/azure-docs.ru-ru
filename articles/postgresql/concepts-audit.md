---
title: Ведение журнала аудита — база данных Azure для PostgreSQL — один сервер
description: Основные понятия для ведения журнала аудита Пгаудит в базе данных Azure для PostgreSQL-Single Server.
author: niklarin
ms.author: nlarin
ms.service: postgresql
ms.topic: conceptual
ms.date: 01/28/2020
ms.openlocfilehash: 615297a4bf47d80c9313f011b90d343b7ae680e3
ms.sourcegitcommit: 3bcce2e26935f523226ea269f034e0d75aa6693a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/23/2020
ms.locfileid: "92488050"
---
# <a name="audit-logging-in-azure-database-for-postgresql---single-server"></a>Ведение журнала аудита в базе данных Azure для PostgreSQL — один сервер

Ведение журнала аудита действий базы данных в базе данных Azure для PostgreSQL — один сервер доступен через расширение аудита PostgreSQL: [пгаудит](https://www.pgaudit.org/). Пгаудит предоставляет подробные сведения о сеансе и (или) ведении журнала аудита объектов.

> [!NOTE]
> Пгаудит находится на этапе предварительной версии в базе данных Azure для PostgreSQL.
> Расширение можно включить только для общего назначения и оптимизированных для памяти серверов.

Если вы хотите, чтобы журналы уровня ресурсов Azure для таких операций, как вычисление и масштабирование хранилища, см. в [журнале действий Azure](../azure-monitor/platform/platform-logs-overview.md).

## <a name="usage-considerations"></a>Особенности использования
По умолчанию выписки из журналов pgAudit создаются вместе с регулярными выписками с использованием стандартного средства ведения журнала Postgres. В Базе данных Azure для PostgreSQL эти файлы журнала можно скачать на портале Azure или с помощью интерфейса командной строки. Максимальный объем хранилища для коллекции файлов составляет 1 ГБ, а каждый файл доступен не более семи дней (по умолчанию — три дня). Эта служба является краткосрочным хранилищем.

Кроме того, можно настроить отправку всех журналов в Azure Monitor хранилище журналов для последующей аналитики в Log Analytics. Если вы включаете Azure Monitor ведение журнала ресурсов, журналы автоматически отправляются (в формате JSON) в хранилище Azure, концентраторы событий и (или) Azure Monitor журналы в зависимости от вашего выбора.

Включение pgAudit приводит к созданию большого объема журналов на сервере, что влияет на производительность и хранение журналов. Рекомендуется использовать журналы Azure Monitor, предлагающие долгосрочные варианты хранения, а также функции анализа и оповещения. Мы рекомендуем отключить стандартное ведение журнала, чтобы уменьшить влияние дополнительного ведения журнала на производительность:

   1. Установите для параметра значение `logging_collector` Off. 
   2. Перезапустите сервер, чтобы применить это изменение.

Чтобы узнать, как настроить ведение журнала для службы хранилища Azure, концентраторов событий или журналов Azure Monitor, посетите раздел Журналы ресурсов в [статье журналы сервера](concepts-server-logs.md).

## <a name="installing-pgaudit"></a>Установка Пгаудит

Чтобы установить Пгаудит, необходимо включить его в общие библиотеки предварительной загрузки сервера. Для вступления в `shared_preload_libraries` силу изменения параметра postgres требуется перезагрузка сервера. Параметры можно изменить с помощью [портал Azure](howto-configure-server-parameters-using-portal.md), [Azure CLI](howto-configure-server-parameters-using-cli.md)или [REST API](/rest/api/postgresql/configurations/createorupdate).

Использование [портал Azure](https://portal.azure.com):

   1. Выберите сервер базы данных Azure для PostgreSQL.
   2. На боковой панели выберите **Параметры сервера**.
   3. Найдите параметр `shared_preload_libraries`.
   4. Выберите **пгаудит**.
   5. Перезапустите сервер, чтобы применить изменение.

   6. Подключение к серверу с помощью клиента (например, psql) и включение расширения Пгаудит
      ```SQL
      CREATE EXTENSION pgaudit;
      ```

> [!TIP]
> Если появится сообщение об ошибке, подтвердите перезапуск сервера после сохранения `shared_preload_libraries` .

## <a name="pgaudit-settings"></a>Параметры Пгаудит

Пгаудит позволяет настроить ведение журнала аудита для сеанса или объекта. [Ведение журнала аудита сеансов](https://github.com/pgaudit/pgaudit/blob/master/README.md#session-audit-logging) создает подробные журналы выполненных инструкций. [Ведение журнала аудита объектов](https://github.com/pgaudit/pgaudit/blob/master/README.md#object-audit-logging) — это область аудита для конкретных связей. Можно выбрать один или оба типа ведения журнала. 

> [!NOTE]
> Параметры Пгаудит указаны глобальный и не могут быть указаны на уровне базы данных или роли.

После [установки пгаудит](#installing-pgaudit)можно настроить его параметры, чтобы начать ведение журнала. В [документации по пгаудит](https://github.com/pgaudit/pgaudit/blob/master/README.md#settings) содержится определение каждого параметра. Сначала проверьте параметры и убедитесь, что вы получаете ожидаемое поведение.

> [!NOTE]
> Если задано значение `pgaudit.log_client` On, журналы перенаправляются в клиентский процесс (например, psql), а не записываются в файл. Этот параметр обычно следует отключать. <br> <br>
> `pgaudit.log_level` включается, только если `pgaudit.log_client` включен.

> [!NOTE]
> В базе данных Azure для PostgreSQL `pgaudit.log` не может быть задано с помощью `-` сочетания знака (минус), как описано в документации по пгаудит. Все необходимые классы операторов (READ, WRITE и т. д.) должны быть указаны отдельно.

### <a name="audit-log-format"></a>Формат журналов аудита
Каждая запись аудита обозначается `AUDIT:` рядом с началом строки журнала. Формат остальной части записи подробно описан в [документации по пгаудит](https://github.com/pgaudit/pgaudit/blob/master/README.md#format).

Если вам нужны другие поля для удовлетворения требований аудита, используйте параметр postgres `log_line_prefix` . `log_line_prefix` Строка, которая выводится в начале каждой строки журнала postgres. Например, следующий `log_line_prefix` параметр предоставляет метку времени, имя пользователя, имя базы данных и идентификатор процесса:

```
t=%m u=%u db=%d pid=[%p]:
```

Дополнительные сведения `log_line_prefix` см. в [документации по PostgreSQL](https://www.postgresql.org/docs/current/runtime-config-logging.html#GUC-LOG-LINE-PREFIX).

### <a name="getting-started"></a>Начало работы
Чтобы быстро приступить к работе, присвойте параметру значение `pgaudit.log` `WRITE` и откройте журналы, чтобы просмотреть выходные данные. 

## <a name="viewing-audit-logs"></a>Просмотр журналов аудита
Если вы используете файлы. log, журналы аудита будут включены в тот же файл, что и журналы ошибок PostgreSQL. Файлы журнала можно загрузить с [портала](howto-configure-server-logs-in-portal.md) Azure или с помощью [интерфейса командной строки](howto-configure-server-logs-using-cli.md). 

Если вы используете ведение журнала ресурсов Azure, то способ доступа к журналам зависит от выбранной конечной точки. Сведения о службе хранилища Azure см. в статье [учетная запись хранения журналов](../azure-monitor/platform/resource-logs.md#send-to-azure-storage) . Сведения о концентраторах событий см. в статье [Streaming Azure Logs](../azure-monitor/platform/resource-logs.md#send-to-azure-event-hubs) .

Для журналов Azure Monitor журналы отправляются в выбранную рабочую область. Журналы postgres используют режим сбора **AzureDiagnostics** , поэтому их можно запрашивать из таблицы AzureDiagnostics. Поля в таблице описаны ниже. Дополнительные сведения о запросах и предупреждениях см. в статье о [запросах Azure Monitor журналов](../azure-monitor/log-query/log-query-overview.md) .

Этот запрос можно использовать для начала работы. Можно настроить оповещения на основе запросов.

Поиск всех журналов postgres для определенного сервера за последний день
```
AzureDiagnostics
| where LogicalServerName_s == "myservername"
| where TimeGenerated > ago(1d) 
| where Message contains "AUDIT:"
```

## <a name="next-steps"></a>Дальнейшие действия
- [Сведения о ведении журнала в базе данных Azure для PostgreSQL](concepts-server-logs.md)
- Узнайте, как задать параметры с помощью [портал Azure](howto-configure-server-parameters-using-portal.md), [Azure CLI](howto-configure-server-parameters-using-cli.md)или [REST API](/rest/api/postgresql/configurations/createorupdate).