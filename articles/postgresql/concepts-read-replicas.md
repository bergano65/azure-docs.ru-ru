---
title: Реплики чтения в Базе данных Azure для PostgreSQL
description: В этой статье описывается компонент "Реплика чтения" в службе "База данных Azure для PostgreSQL".
author: rachel-msft
ms.author: raagyema
ms.service: postgresql
ms.topic: conceptual
ms.date: 04/01/2019
ms.openlocfilehash: f340f1e42b6993a1f834ab05570c669d4241222b
ms.sourcegitcommit: c174d408a5522b58160e17a87d2b6ef4482a6694
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2019
ms.locfileid: "59789980"
---
# <a name="read-replicas-in-azure-database-for-postgresql"></a>Реплики чтения в Базе данных Azure для PostgreSQL

Компонент "Реплика чтения" позволяет реплицировать данные с сервера службы "База данных Azure для PostgreSQL" на сервер только для чтения. Вы можете реплицировать данные с главного сервера на несколько реплик (до пяти) в том же регионе Azure. Реплики асинхронно обновляются с использованием собственной технологии репликации ядра PostgreSQL.

Реплики — это новые серверы, которыми вы управляете как обычными серверами службы "База данных Azure для PostgreSQL". За каждую реплику чтения выставляется счет с учетом подготовленных вычислительных ресурсов (количество виртуальных ядер) и хранилища (ГБ/месяц).

Дополнительные сведения о создании реплик и управлении ими см. [здесь](howto-read-replicas-portal.md).

## <a name="when-to-use-a-read-replica"></a>Использование реплик чтения
Компонент "Реплика чтения" помогает повысить производительность и масштабируемость рабочих нагрузок с высокой интенсивностью чтения. Рабочие нагрузки чтения можно изолировать в реплики, направив рабочие нагрузки записи на главный сервер.

К типичным сценариям относится ситуация, когда рабочие нагрузки бизнес-аналитики и анализа используют реплику чтения в качестве источника данных для отчетов.

Так как реплики доступны только для чтения, они не снимают с главного сервера нагрузку, связанную с записью. Этот компонент не предназначен для рабочих нагрузок с интенсивной записью.

В реплике чтения используется асинхронная репликация PostgreSQL. Этот компонент также не предназначен для сценариев синхронной репликации. Между поступлением данных на главный сервер и на реплики будет существенная задержка. Данные на реплике и на главном узле согласованы в конечном счете. Используйте этот компонент только для таких рабочих нагрузок, которым не страшна такая задержка.

## <a name="create-a-replica"></a>Создание реплики
На главном сервере задайте для параметра `azure.replication_support` значение **REPLICA**. После изменения значения этого параметра сервер необходимо перезапустить, чтобы изменения вступили в силу. (Параметр `azure.replication_support` применяется только к уровням "Общего назначения" и "Оптимизированный для операций в памяти".)

При запуске рабочего процесса создания реплики создается пустой сервер службы "База данных Azure для PostgreSQL". Этот сервер заполняется данными, которые были на главном сервере. Время создания зависит от объема данных на главном сервере и времени, прошедшего с момента последнего еженедельного полного резервного копирования. Время может варьироваться от нескольких минут до нескольких часов.

Реплика чтения использует физическую (а не логическую) репликацию PostgreSQL. По умолчанию применяется потоковая передача данных репликации с использованием слотов репликации. При необходимости для наверстывания используется доставка журналов.

> [!NOTE]
> Если вы еще не настроили оповещения хранилища на серверах, рекомендуем сделать это сейчас. Это позволит получать сведения о приближении к заполнению хранилища на сервере, которое влияет на эффективность репликации.

Дополнительные сведения о создании реплики чтения на портале Azure см. [здесь](howto-read-replicas-portal.md).

## <a name="connect-to-a-replica"></a>Подключение к реплике
Создаваемая реплика не наследует от главного сервера правила брандмауэра или конечную точку службы виртуальной сети. Эти правила следует настроить для каждой реплики отдельно.

Реплика наследует от главного сервера учетную запись администратора. Также на реплики чтения копируются все учетные записи пользователей с главного сервера. К реплике чтения можно подключиться только с помощью учетных записей пользователей, доступных на главном сервере.

Вы можете подключиться к реплике, используя имя узла и действительную учетную запись, как к обычному серверу службы "База данных Azure для PostgreSQL". Например, для сервера с именем **myreplica** и именем пользователя с правами администратора **myadmin** подключение будет выполняться с помощью psql:

```
psql -h myreplica.postgres.database.azure.com -U myadmin@myreplica -d postgres
```

При появлении запроса введите пароль для учетной записи пользователя.

## <a name="monitor-replication"></a>Мониторинг репликации
В службе "База данных Azure для PostgreSQL" для Azure Monitor доступна метрика **Max Lag across Replicas** (Максимальная задержка между репликами). Эта метрика доступна только на главном сервере. Она показывает задержку между главным сервером и репликой с наибольшей задержкой в байтах. 

Служба "База данных Azure для PostgreSQL" также предоставляет для Azure Monitor метрику **Replica Lag** (Задержка реплик). Эта метрика доступна только для реплик. 

Метрика вычисляется из представления `pg_stat_wal_receiver`:

```SQL
EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp())
```

Метрика задержки реплик показывает время с момента последнего воспроизведения транзакций. Если на главном сервере не выполняются транзакции, метрика будет отображать соответствующее время задержки.

Настройте отправку предупреждений о достижении недопустимого для вашей рабочей нагрузки значения задержки реплики. 

Чтобы получить дополнительные сведения, напрямую запросите у главного сервера значение задержки репликации в байтах по всем репликам.

В PostgreSQL версии 10:

```SQL
select pg_wal_lsn_diff(pg_current_wal_lsn(), stat.replay_lsn) 
AS total_log_delay_in_bytes from pg_stat_replication;
```

В PostgreSQL 9.6 и более ранних версий:

```SQL
select pg_xlog_location_diff(pg_current_xlog_location(), stat.replay_location) 
AS total_log_delay_in_bytes from pg_stat_replication;
```

> [!NOTE]
> В случае перезапуска главного сервера или реплики чтения период, необходимый для перезапуска и наверстывания, будет отражаться в значении метрики задержки реплики.

## <a name="stop-replication"></a>Остановка репликации
Вы можете остановить репликацию между главным сервером и репликой. В этом случае реплика перезагрузится, чтобы удалить параметры репликации. После остановки репликации между главным сервером и репликой чтения реплика становится отдельным сервером. На отдельном сервере сохраняются все данные, которые существовали на нем на момент запуска команды "Остановить репликацию". Данные на изолированном сервере не синхронизируются с главным сервером.

> [!IMPORTANT]
> Это сервер нельзя снова преобразовать в реплику.
> Прежде, чем останавливать репликацию в реплике чтения убедитесь, что реплика содержит все необходимые данные.

Процесс остановки репликации описан в [этой статье](howto-read-replicas-portal.md).


## <a name="considerations"></a>Рекомендации

В этом разделе приведены рекомендации по использованию компонента "Реплика чтения".

### <a name="prerequisites"></a>Технические условия
Прежде чем создавать реплику, на главном сервере задайте для параметра `azure.replication_support` значение **REPLICA**. После изменения значения этого параметра сервер необходимо перезапустить, чтобы изменения вступили в силу. Параметр `azure.replication_support` применяется только к уровням "Общего назначения" и "Оптимизированный для операций в памяти".

### <a name="new-replicas"></a>Новые реплики
Реплики чтения создаются как новые серверы службы "База данных Azure для PostgreSQL". Существующий сервер нельзя снова преобразовать в реплику. Реплики чтения можно создавать только в том же регионе Azure, где расположен главный сервер. Невозможно создать реплику другой реплики чтения.

### <a name="replica-configuration"></a>Конфигурация реплики
Реплика создается с той же конфигурацией сервера, что и у главного сервера. После создания реплики вы можете независимо от главного сервера изменять следующие ее параметры: поколение вычислительных ресурсов, число виртуальных ядер, объем хранилища и период хранения резервных копий. Изменить также можно ценовую категорию (за исключением уровня "Базовый").

> [!IMPORTANT]
> Прежде чем изменить параметры конфигурации на главном сервере, установите на каждой реплике такие же или более высокие значения. Это позволит реплике справляться с нагрузкой, соответствующей новым параметрам главного сервера.

Postgres требует, чтобы параметр `max_connections` на реплике имел значение не ниже, чем на главном сервере. В противном случае реплика не запустится. В службе "База данных Azure для PostgreSQL" значение `max_connections` устанавливается в зависимости от номера SKU. Дополнительные сведения см. в статье [Ограничения в базе данных Azure для PostgreSQL](concepts-limits.md). 

При попытке обновить значения сервера без соблюдения ограничений возникнет ошибка.

### <a name="stopped-replicas"></a>Остановленные реплики
Если вы решили остановить репликацию между главным сервером и репликой чтения, для применения таких изменений реплика будет перезапущена. Остановленная реплика становится отдельным сервером, который принимает операции чтения и записи. Это сервер нельзя снова преобразовать в реплику.

### <a name="deleted-master-and-standalone-servers"></a>Удаленные главного и отдельного серверов
При удалении главного сервера все его реплики чтения становятся отдельными серверами. Чтобы применить такое изменение конфигурации, реплики будут перезапущены.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения см. в статье [Создание реплик чтения и управление ими с помощью портала Azure](howto-read-replicas-portal.md).
