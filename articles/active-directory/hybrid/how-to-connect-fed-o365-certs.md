---
title: Продление сертификата для пользователей Microsoft 365 и Azure AD | Документация Майкрософт
description: В этой статье объясняется, как Microsoft 365 пользователей устранять проблемы с сообщениями электронной почты, которые уведомляют об обновлении сертификата.
services: active-directory
documentationcenter: ''
author: billmath
manager: daveba
editor: curtand
ms.assetid: 543b7dc1-ccc9-407f-85a1-a9944c0ba1be
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: how-to
ms.date: 10/20/2017
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: 78dcd9d020923251439a05316569b559c19057d1
ms.sourcegitcommit: f8d2ae6f91be1ab0bc91ee45c379811905185d07
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2020
ms.locfileid: "89661445"
---
# <a name="renew-federation-certificates-for-microsoft-365-and-azure-active-directory"></a>Продлите сертификаты Федерации для Microsoft 365 и Azure Active Directory
## <a name="overview"></a>Overview
Для успешной федерации между Azure Active Directory (Azure AD) и службами федерации Active Directory (AD FS) сертификаты, используемые службами AD FS для подписывания маркеров безопасности в Azure AD, должны соответствовать параметрам, настроенным в Azure AD. Расхождение может привести к нарушению отношений доверия. Azure AD гарантирует, что эта информация синхронизируется при развертывании AD FS и прокси веб-приложения (для доступа к экстрасети).

В этой статье представлены дополнительные сведения об управлении сертификатами для подписи маркеров и их синхронизации с Azure AD в следующих случаях:

* Вы не развертываете прокси веб-приложения, поэтому метаданные федерации недоступны в экстрасети.
* Вы не применяете стандартную конфигурацию AD FS к сертификатам для подписи маркеров.
* Вы используете сторонний поставщик удостоверений.

## <a name="default-configuration-of-ad-fs-for-token-signing-certificates"></a>Стандартная конфигурация AD FS для сертификатов для подписи маркеров
Сертификаты для подписи маркеров и их расшифровки обычно представляют собой самозаверяющие сертификаты со сроком годности в один год. По умолчанию AD FS предусматривает процесс автоматического возобновления действия, который называется **AutoCertificateRollover**. Если вы используете AD FS 2,0 или более поздней версии, Microsoft 365 и Azure AD автоматически обновляют сертификат до истечения срока его действия.

### <a name="renewal-notification-from-the-microsoft-365-admin-center-or-an-email"></a>Уведомление об обновлении из центра администрирования Microsoft 365 или сообщения электронной почты
> [!NOTE]
> Если вы получите через портал или по электронной почте уведомление о том, что необходимо возобновить действие сертификата для Office, см. раздел об [управлении изменениями в сертификатах для подписи маркеров](#managecerts). Так вы сможете узнать, нужно ли предпринимать какие-либо действия. Корпорации Майкрософт известно о потенциальной проблеме, в результате которой могут отправляться уведомления о возобновлении действия сертификата, даже если никаких действий не требуется.
>
>

Azure AD пытается отслеживать метаданные федерации и обновлять сертификаты для подписи маркеров, как указано в этих метаданных. За 30 дней до истечения срока действия сертификатов для подписи маркеров Azure AD проверит, доступны ли новые сертификаты, путем опроса метаданных федерации.

* Если он может успешно опрашивать метаданные федерации и получать новые сертификаты, пользователю не выдается уведомление по электронной почте или предупреждение в центре администрирования Microsoft 365.
* Если не удается получить новые сертификаты для подписи маркеров, так как метаданные федерации недостижимы или автоматическая смена сертификатов не включена, Azure AD выдает уведомление по электронной почте и предупреждение в центре администрирования Microsoft 365.

![Уведомление на портале Office 365](./media/how-to-connect-fed-o365-certs/notification.png)

> [!IMPORTANT]
> Чтобы обеспечить непрерывность бизнес-процессов при использовании AD FS, проверьте, установлены ли на ваших серверах следующие обновления, предотвращающие ошибки проверки подлинности при известных проблемах. Это позволит устранить известные проблемы с прокси-сервером AD FS при текущем и последующем возобновлении действия сертификатов.
>
> Server 2012 R2 — [Накопительный пакет обновления от мая 2014 г. для Windows RT 8.1, Windows 8.1 и Windows Server 2012 R2](https://support.microsoft.com/kb/2955164).
>
> Server 2008 R2 и 2012 — [Authentication through proxy fails in Windows Server 2012 or Windows Server 2008 R2 SP1](https://support.microsoft.com/kb/3094446)
>
>

## <a name="check-if-the-certificates-need-to-be-updated"></a>Проверка необходимости в обновлении сертификатов <a name="managecerts"></a>
### <a name="step-1-check-the-autocertificaterollover-state"></a>Шаг 1. Проверка состояния свойства AutoCertificateRollover
На сервере AD FS откройте PowerShell. Удостоверьтесь, что для AutoCertificateRollover задано значение True.

```azurepowershell-interactive
Get-Adfsproperties
```

![AutoCertificateRollover](./media/how-to-connect-fed-o365-certs/autocertrollover.png)

>[!NOTE] 
>При использовании AD FS 2.0 необходимо сначала выполнить команду Add-Pssnapin Microsoft.Adfs.Powershell.

### <a name="step-2-confirm-that-ad-fs-and-azure-ad-are-in-sync"></a>Шаг 2. Убедитесь, что службы AD FS и Azure AD синхронизированы
На сервере AD FS откройте командную строку MSOnline PowerShell и подключитесь к Azure AD.

> [!NOTE]
> Командлеты MSOL являются частью модуля MSOnline PowerShell.
> Модуль MSOnline PowerShell можно загрузить непосредственно из коллекции PowerShell.
> 
>

```azurepowershell-interactive
Install-Module MSOnline
```

Подключитесь к Azure AD с помощью модуля PowerShell MSOnline.

```azurepowershell-interactive
Import-Module MSOnline
Connect-MsolService
```

Проверьте сертификаты, настроенные в AD FS, и свойства доверия Azure AD для указанного домена.

```azurepowershell-interactive
Get-MsolFederationProperty -DomainName <domain.name> | FL Source, TokenSigningCertificate
```

![Get-MsolFederationProperty](./media/how-to-connect-fed-o365-certs/certsync.png)

Если отпечатки в обоих наборах выходных данных совпадают, значит, сертификаты синхронизируются с Azure AD.

### <a name="step-3-check-if-your-certificate-is-about-to-expire"></a>Шаг 3. Проверьте, не истекает ли срок действия сертификата
В выходных данных Get-MsolFederationProperty или Get-AdfsCertificate проверьте дату, указанную после строки Not After. Если эта дата наступает менее чем через 30 дней, следует принять меры.

| AutoCertificateRollover | Сертификаты синхронизированы с Azure AD | Метаданные федерации общедоступны | Срок действия | Действие |
|:---:|:---:|:---:|:---:|:---:|
| Да |Да |Да |- |Никаких действий не требуется. См. раздел [Автоматическое возобновление действия сертификата для подписи маркера](#autorenew). |
| Да |Нет |- |Менее 15 дней |Обновите немедленно. См. раздел [Возобновление действия сертификата для подписи маркера вручную](#manualrenew). |
| Нет |- |- |Менее 30 дней |Обновите немедленно. См. раздел [Возобновление действия сертификата для подписи маркера вручную](#manualrenew). |

\[-] — не имеет значения

## <a name="renew-the-token-signing-certificate-automatically-recommended"></a>Автоматическое возобновление действия сертификата для подписи маркера (рекомендуется) <a name="autorenew"></a>
Если приведенные ниже условия выполняются, ничего не нужно делать вручную.

* Вы развернули прокси веб-приложения, предоставляющий доступ к метаданным федерации из экстрасети.
* Вы используете стандартную конфигурацию AD FS (свойство AutoCertificateRollover включено).

Проверьте следующие пункты, чтобы удостовериться, что действие сертификата может обновляться автоматически.

**1. Для свойства AutoCertificateRollover служб AD FS должно быть задано значение True.** Это указывает на то, что службы AD FS будут автоматически создавать сертификаты для подписи маркеров и их расшифровки до окончания срока действия старых.

**2. Метаданные федерации AD FS общедоступны.**  Убедитесь, что метаданные федерации доступны для общего пользования через Интернет (за пределами корпоративной сети), перейдя со своего компьютера по следующему URL-адресу.

https://(ваше_имя_FS)/federationmetadata/2007-06/federationmetadata.xml

где `(your_FS_name)` заменяется именем узла службы федерации, используемым вашей организацией, например FS.contoso.com.  Если проверка двух этих параметров оказалась успешной, вам больше не нужно ничего делать.  

Например, `https://fs.contoso.com/federationmetadata/2007-06/federationmetadata.xml`.
## <a name="renew-the-token-signing-certificate-manually"></a>Возобновление действия сертификата для подписи маркера вручную <a name="manualrenew"></a>
Сертификаты для подписи маркеров можно обновить вручную. Например, в следующих сценариях лучше выполнять ручное обновление.

* Сертификаты для подписи маркеров не являются самозаверяющими. Вероятнее всего, это происходит потому, что ваша организация использует сертификаты AD FS, зарегистрированные в центре сертификации организации.
* В системе безопасности сети запрещен общий доступ к метаданным федерации.

В этих сценариях каждый раз при обновлении сертификатов для подписи маркеров необходимо также обновить домен Microsoft 365 с помощью команды PowerShell Update-MsolFederatedDomain.

### <a name="step-1-ensure-that-ad-fs-has-new-token-signing-certificates"></a>Шаг 1. Убедитесь, что в службах AD FS используются новые сертификаты для подписи маркеров
**Нестандартная конфигурация**

Если применяется нестандартная конфигурация AD FS (где значение свойства **AutoCertificateRollover** равно **False**), вероятно, вы используете настраиваемые (не самозаверяющие) сертификаты. Дополнительные сведения об обновлении сертификатов подписи маркеров AD FS см. в статье [требования к сертификатам для федеративных серверов](/windows-server/identity/ad-fs/design/certificate-requirements-for-federation-servers).

**Метаданные федерации не являются общедоступными**

С другой стороны, если значение свойства **AutoCertificateRollover** равно **True**, но метаданные федерации не являются общедоступными, сначала удостоверьтесь, что сертификаты для подписи маркеров созданы службами AD FS. Чтобы убедиться, что у вас есть новые сертификаты для подписи маркеров, сделайте следующее:

1. Удостоверьтесь, что вы вошли на основной сервер AD FS.
2. Проверьте текущие сертификаты подписи в AD FS, открыв командное окно PowerShell и выполнив следующую команду.

    PS C:\>Get-ADFSCertificate –CertificateType token-signing

   > [!NOTE]
   > При использовании AD FS 2.0 необходимо сначала выполнить команду Add-Pssnapin Microsoft.Adfs.Powershell.
   >
   >
3. Просмотрите данные, которые будут выведены для всех сертификатов в списке. Если служба AD FS создала сертификат, вы увидите два сертификата в выходных данных: один, для которого значение **IsPrimary** равно **True**, а дата **NotAfter** равна 5 дней; второй, для которого значение **IsPrimary** равно **False**, а дата **NotAfter** равна приблизительно году.
4. Если вы видите только один сертификат, а дата **NotAfter** равна 5 дням, необходимо создать сертификат.
5. Чтобы создать сертификат, в командной строке PowerShell выполните такую команду: `PS C:\>Update-ADFSCertificate –CertificateType token-signing`.
6. Проверьте обновление, запустив следующую команду еще раз: PS C:\>Get-ADFSCertificate –CertificateType token-signing

Теперь должны появиться два сертификата, один из которых имеет дату **NotAfter**, равную приблизительно году, и у которого значение параметра **IsPrimary** равно **False**.

### <a name="step-2-update-the-new-token-signing-certificates-for-the-microsoft-365-trust"></a>Шаг 2. обновление новых сертификатов для подписи маркеров для Microsoft 365 доверия
Обновите Microsoft 365 с помощью новых сертификатов подписи маркера, которые будут использоваться для доверия, следующим образом.

1. Откройте модуль Microsoft Azure Active Directory для Windows PowerShell.
2. Запустите $cred=Get-Credential. Если этот командлет запрашивает учетные данные, введите данные учетной записи администратора облачных служб.
3. Выполните команду Connect-MsolService – Credential $cred. Этот командлет подключает вас к облачной службе. Перед выполнением любых дополнительных командлетов, установленных с помощью средства, необходимо создать контекст, который подключит вас к облачной службе.
4. Если эти команды выполняются на компьютере, который не является основным сервером федерации AD FS, выполните команду Set-MSOLAdfscontext -Computer &lt;основной сервер AD FS&gt;, где &lt;основной сервер AD FS&gt; — это внутреннее полное доменное имя основного сервера AD FS. Этот командлет создает контекст, подключающий вас к AD FS.
5. Выполните Update-MSOLFederatedDomain –DomainName &lt;домен&gt;. Этот командлет обновляет параметры AD FS в облачной службе и настраивает отношения доверия между ними.

> [!NOTE]
> При необходимости поддержки нескольких доменов верхнего уровня, например contoso.com и fabrikam.com, требуется использовать параметр **SupportMultipleDomain** с любым командлетом. Дополнительные сведения см. в статье [Поддержка нескольких доменов для федерации с Azure AD](how-to-connect-install-multiple-domains.md).
>


## <a name="repair-azure-ad-trust-by-using-azure-ad-connect"></a>Восстановление доверия Azure AD с помощью Azure AD Connect <a name="connectrenew"></a>
Если вы настроили ферму AD FS и доверие Azure AD, используя Azure AD Connect, то с помощью Azure AD Connect можно определить, нужно ли выполнять какие-либо действия с сертификатами для подписи маркеров. Если требуется обновить сертификаты, используйте Azure AD Connect.

Дополнительные сведения см. в разделе [Восстановление доверия](how-to-connect-fed-management.md).

## <a name="ad-fs-and-azure-ad-certificate-update-steps"></a>Действия по обновлению сертификата в AD FS и Azure AD
Сертификаты для подписи маркеров — это стандартные сертификаты X509, которые используются для безопасного подписания всех маркеров, издаваемых сервером федерации. Сертификаты для расшифровки маркеров — это стандартные сертификаты X509, которые используются для расшифровки любых входящих маркеров. 

По умолчанию в AD FS автоматически создаются сертификаты для подписи и расшифровки маркеров, когда выполняется начальная настройка и приближается дата окончания срока действия.

За 30 дней до истечения срока действия текущего сертификата в Azure AD выполняется попытка получить новый сертификат из метаданных службы федерации. Если новый сертификат в этот момент недоступен, Azure AD будет постоянно отслеживать метаданные с интервалом в сутки. Когда новый сертификат станет доступен в метаданных, параметры федерации домена обновятся с учетом данных нового сертификата. Вы можете воспользоваться командой `Get-MsolDomainFederationSettings`, чтобы проверить наличие нового сертификата в NextSigningCertificate / SigningCertificate.

Дополнительные сведения о сертификатах для подписи маркеров в AD FS см. в статье [Obtain and Configure TS and TD Certificates for AD FS](/windows-server/identity/ad-fs/operations/configure-ts-td-certs-ad-fs) (Получение и настройка сертификатов для подписи и расшифровки маркеров для AD FS).
