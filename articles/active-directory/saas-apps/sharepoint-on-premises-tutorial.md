---
title: Руководство по Интеграция Azure Active Directory с локальной версией SharePoint | Документация Майкрософт
description: Узнайте, как настроить единый вход между Azure Active Directory и локальной версией SharePoint.
services: active-directory
author: jeevansd
manager: CelesteDG
ms.reviewer: celested
ms.service: active-directory
ms.subservice: saas-app-tutorial
ms.workload: identity
ms.topic: tutorial
ms.date: 09/10/2020
ms.author: jeedes
ms.openlocfilehash: a3a5834cd63351b9bf61dc97c8d6e14d430b6284
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "90979707"
---
# <a name="tutorial-azure-active-directory-single-sign-on-integration-with-sharepoint-on-premises"></a>Руководство по интеграции единого входа Azure Active Directory с локальной версией SharePoint

В этом руководстве описано, как интегрировать локальную версию SharePoint с Azure Active Directory (Azure AD). Интеграция локальной версии SharePoint с Azure Active Directory обеспечивает следующие возможности.

* Управление доступом пользователей к локальной версии SharePoint в Azure AD.
* Включение автоматического входа пользователей в локальную версию SharePoint (единый вход) с использованием учетных записей Azure AD.
* Управление учетными записями через портал Azure.

## <a name="prerequisites"></a>Предварительные требования

Чтобы настроить интеграцию Azure AD с локальной версией SharePoint, вам потребуются такие компоненты:

* Подписка Azure AD. (если у вас нет среды Azure AD, вы можете получить [бесплатную учетную запись](https://azure.microsoft.com/free/));
* Ферма SharePoint 2013 или более поздней версии.

## <a name="scenario-description"></a>Описание сценария

В рамках этого руководства вы настроите и проверите единый вход Azure Active Directory в тестовой среде. Пользователи из Azure AD смогут получать доступ к локальной среде SharePoint.

## <a name="create-enterprise-applications-in-the-azure-portal"></a>Создание корпоративных приложений на портале Azure

Чтобы настроить интеграцию локальной версии SharePoint с Azure AD, вам потребуется добавить локальную версию SharePoint из коллекции в ваш список управляемых приложений SaaS.

Чтобы добавить локальную версию SharePoint из коллекции, выполните следующие действия.

1. На портале Azure в крайней слева области щелкните **Azure Active Directory**.

   > [!NOTE]
   > Если элемент недоступен, его можно также открыть по ссылке **Все службы** в верхней части крайней слева панели. В следующем обзоре ссылка **Azure Active Directory** будет доступна в разделе **Удостоверение**. Можно также найти ее, используя текстовое поле фильтра.

1. Перейдите в колонку **Корпоративные приложения** и выберите **Все приложения**.

1. Чтобы добавить новое приложение, в верхней части диалогового окна выберите **Новое приложение**.

1. В поле поиска введите **Локальная среда SharePoint**. В области результатов выберите **Локальная среда SharePoint**.

    <kbd>![Локальная версия SharePoint в списке результатов](./media/sharepoint-on-premises-tutorial/search-new-app.png)</kbd>

1. Укажите имя для локального экземпляра SharePoint и выберите **Добавить**, чтобы добавить приложение.

1. В новом корпоративном приложении щелкните **Свойства** и проверьте значение параметра **Требуется назначение пользователей**.

   <kbd>![Переключатель "Требуется назначение пользователей"](./media/sharepoint-on-premises-tutorial/user-assignment-required.png)</kbd>

   В данном сценарии для этого параметра установлено значение **Нет**.

## <a name="configure-and-test-azure-ad"></a>Настройка и проверка Azure AD

В этом разделе описана настройка единого входа Azure AD для локального экземпляра SharePoint. Для обеспечения работы единого входа необходимо установить связь между пользователем Azure AD и соответствующим пользователем с локальной версией SharePoint.

Чтобы настроить и проверить единый вход Azure AD в локальной среде SharePoint, выполните такие стандартные блоки:

- [Настройка единого входа Azure AD](#configure-azure-ad-sso) необходима, чтобы пользователи могли использовать эту функцию.
- [Настройка локальной среды SharePoint](#configure-sharepoint-on-premises) — необходима, чтобы настроить параметры единого входа на стороне приложения.
- [Создание тестового пользователя Azure AD на портале Azure](#create-an-azure-ad-test-user-in-the-azure-portal) — необходимо, чтобы создать в Azure AD нового пользователя для единого входа.
- [Создание группы безопасности Azure AD на портале Azure](#create-an-azure-ad-security-group-in-the-azure-portal) — требуется, чтобы создать группу безопасности в Azure AD и включить для нее единый вход.
- [Предоставление разрешений учетной записи Azure Active Directory в локальной среде SharePoint](#grant-permissions-to-an-azure-ad-account-in-sharepoint-on-premises) — необходимо для назначения разрешений пользователю Azure AD.
- [Предоставление разрешений группе Azure AD в локальной среде SharePoint](#grant-permissions-to-an-azure-ad-group-in-sharepoint-on-premises) — требуется для назначения разрешений группе Azure AD.
- [Предоставление учетной записи гостя доступа к локальной среде SharePoint на портале Azure](#grant-access-to-a-guest-account-to-sharepoint-on-premises-in-the-azure-portal) — необходимо, чтобы предоставить учетной записи гостя Azure AD разрешения в локальной среде SharePoint.
- [Настройка доверенного поставщика удостоверений для нескольких веб-приложений](#configure-the-trusted-identity-provider-for-multiple-web-applications) — необходима для настройки одного доверенного поставщика удостоверений для нескольких веб-приложений.

### <a name="configure-azure-ad-sso"></a>Настройка единого входа Azure AD

В этом разделе описано, как включить единый вход Azure AD на портале Azure.

Чтобы настроить единый вход Azure AD в локальной среде SharePoint, выполните следующие действия.

1. На портале Azure выберите **Azure Active Directory** > **Корпоративные приложения**. Выберите имя ранее созданного корпоративного приложения и щелкните **Единый вход**.

1. В диалоговом окне **Выбрать метод единого входа** выберите режим **SAML**, чтобы включить единый вход.
 
1. На странице **Настройка единого входа с помощью SAML** нажмите значок **правки**, чтобы открыть диалоговое окно **Базовая конфигурация SAML**.

1. В разделе **Базовая конфигурация SAML** выполните следующие действия:

    ![Сведения о домене и URL-адресах единого входа для локальной версии SharePoint](./media/sharepoint-on-premises-tutorial/sp-identifier-reply.png)

    1. В поле **Идентификатор** введите URL-адрес в следующем формате: `urn:<sharepointFarmName>:<federationName>`.

    1. В поле **URL-адрес ответа** введите URL-адрес в следующем формате: `https://<YourSharePointSiteURL>/_trust/`.

    1. В поле **URL-адрес для входа** введите URL-адрес в следующем формате: `https://<YourSharePointSiteURL>/`.
    1. Щелкните **Сохранить**.

    > [!NOTE]
    > Эти значения приведены в качестве примера. Укажите вместо них фактические значения URL-адреса для входа, идентификатора и URL-адреса ответа.

1. На странице **Настройка единого входа с помощью SAML** в разделе **Сертификат подписи SAML** щелкните **Скачать**, чтобы скачать требуемый **сертификат (Base64)** из предложенных вариантов, и сохраните его на компьютере.

    ![Ссылка для скачивания сертификата](./media/sharepoint-on-premises-tutorial/certificatebase64.png)

1. Скопируйте требуемый URL-адрес из раздела **Set up SharePoint on-premises** (Настройка локальной среды SharePoint).
    
    - **Login URL** (URL-адрес для входа)
    
        Скопируйте URL-адрес для входа и замените **/saml2** в конце на **/wsfed**, чтобы он выглядел как https://login.microsoftonline.com/2c4f1a9f-be5f-10ee-327d-a95dac567e4f/wsfed. (Этот URL-адрес неточен.)

    - **идентификатор Azure AD**;
    - **URL-адрес выхода**.

    > [!NOTE]
    > Этот URL-адрес нельзя использовать в SharePoint как есть. Необходимо заменить **/saml2** на **/wsfed**. В локальном приложении SharePoint используется токен SAML 1.1, поэтому Azure AD ожидает запроса WS Fed от сервера SharePoint. После проверки подлинности он выдает токен SAML 1.1.

### <a name="configure-sharepoint-on-premises"></a>Конфигурация локальной среды SharePoint

1. Создайте новый доверенный поставщик удостоверений в SharePoint Server 2016.

    Войдите в систему на сервере SharePoint и откройте командную консоль SharePoint. Заполните следующие поля:
    - **$realm** — значение идентификатора из раздела со сведениями о домене и URL-адресах в локальной версии SharePoint на портале Azure;
    - **$wsfedurl** — URL-адрес службы единого входа;
    - **$filepath** — путь к файлу сертификата, скачанного с портала Azure.

    Выполните следующие команды, чтобы настроить новый доверенный поставщик удостоверений.

    > [!TIP]
    > Если вы не знаете, как использовать PowerShell, или хотите получить дополнительные сведения о том, как работает PowerShell, см. статью [SharePoint PowerShell](https://docs.microsoft.com/powershell/sharepoint/overview?view=sharepoint-ps).


    ```
    $realm = "urn:sharepoint:sps201x"
    $wsfedurl="https://login.microsoftonline.com/2c4f1a9f-be5f-10ee-327d-a95dac567e4f/wsfed"
    $filepath="C:\temp\SharePoint 2019 OnPrem.cer"
    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2($filepath)
    New-SPTrustedRootAuthority -Name "AzureAD" -Certificate $cert
    $map1 = New-SPClaimTypeMapping -IncomingClaimType "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name" -IncomingClaimTypeDisplayName "name" -LocalClaimType "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn"
    $map2 = New-SPClaimTypeMapping -IncomingClaimType "http://schemas.microsoft.com/ws/2008/06/identity/claims/role" -IncomingClaimTypeDisplayName "Role" -SameAsIncoming
    $ap = New-SPTrustedIdentityTokenIssuer -Name "AzureAD" -Description "Azure AD SharePoint server 201x" -realm $realm -ImportTrustCertificate $cert -ClaimsMappings $map1,$map2 -SignInUrl $wsfedurl -IdentifierClaim $map1.InputClaimType
    ```
1. Включите доверенный поставщик удостоверений для приложения.

    1. В **центре администрирования** перейдите в раздел **Управление веб-приложениями** и выберите веб-приложение, которое необходимо защитить с помощью Azure AD.

    1. На ленте щелкните **Поставщики проверки подлинности** и выберите зону, которую нужно использовать.

    1. Щелкните пункт **Доверенный поставщик удостоверений** и выберите поставщик, которого вы только что зарегистрировали под именем *AzureAD*.

    1. Щелкните **ОК**.

    ![Настройка поставщика проверки подлинности](./media/sharepoint-on-premises-tutorial/config-auth-provider.png)

### <a name="create-an-azure-ad-test-user-in-the-azure-portal"></a>Создание тестового пользователя Azure AD на портале Azure

Цель этого раздела — создать на портале Azure тестового пользователя.

1. На портале Azure в крайней слева области щелкните **Azure Active Directory**. В области **Управление** выберите **Пользователи**.

1. В верхней части экрана выберите **Все пользователи** > **Новый пользователь**.

1. Выберите **Создать пользователя** и в свойствах пользователя выполните следующие действия. Возможно, вы можете создавать пользователей в Azure AD с указанием суффикса клиента или любого проверенного домена. 

    1. В поле **Имя пользователя** введите имя пользователя. Мы использовали **TestUser**.
  
    1. В поле **Имя пользователя** введите `TestUser@yourcompanydomain.extension`. В этом примере отображается `TestUser@contoso.com`.

       ![Диалоговое окно "Пользователь"](./media/sharepoint-on-premises-tutorial/user-properties.png)

    1. Установите флажок **Показать пароль** и запишите значение, которое отображается в поле **Пароль**.

    1. Нажмите кнопку **создания**.

    1. Теперь можно предоставить общий доступ к сайту с помощью TestUser@contoso.com и разрешить этому пользователю доступ к нему.

### <a name="create-an-azure-ad-security-group-in-the-azure-portal"></a>Создание группы безопасности на портале Azure

1. Выберите **Azure Active Directory** > **Группы**.

1. Выберите **Новая группа**.

1. Заполните поля **Тип группы**, **Имя группы**, **Описание группы** и **Тип членства**. Щелкая стрелки, выберите членов, а затем найдите или выберите членов, которых нужно добавить в группу. Щелкните **Выбрать**, чтобы добавить выбранных членов, а затем нажмите кнопку **Создать**.

![Создание группы безопасности Azure AD](./media/sharepoint-on-premises-tutorial/new-group.png)

### <a name="grant-permissions-to-an-azure-ad-account-in-sharepoint-on-premises"></a>Предоставление разрешений учетной записи Azure AD в локальной среде SharePoint

Чтобы предоставить доступ пользователю Azure AD в локальной среде SharePoint, предоставьте общий доступ к семейству веб-сайтов или добавьте пользователя Azure AD в одну из групп семейства веб-сайтов. Теперь пользователи могут входить в SharePoint 201x, используя удостоверения из Azure AD, однако условия работы можно сделать еще удобнее. Например, при поиске пользователя в средстве выбора людей система возвращает несколько результатов поиска. Для каждого из трех типов утверждений, которые созданы в этом сопоставлении утверждений, предоставляется отдельный результат поиска. Чтобы выбрать пользователя с помощью средства выбора, вам потребуется ввести точное имя пользователя и выбрать результат утверждения **name**.

![Результаты поиска утверждений](./media/sharepoint-on-premises-tutorial/claims-search-results.png)

Система не проверяет значения, по которым вы выполняете поиск. Это может привести к опечаткам и ошибкам в выборе типа утверждения. Такая ситуация может помешать пользователям получить доступ к ресурсам.

Чтобы исправить средство выбора людей в этом сценарии, можно использовать решение с открытым кодом [AzureCP](https://yvand.github.io/AzureCP/), которое представляет собой настраиваемый поставщик утверждений для SharePoint 2013, 2016 и 2019. С помощью API Microsoft Graph он разрешает и проверяет вводимые пользователями данные. Дополнительные сведения см. на веб-сайте [AzureCP](https://yvand.github.io/AzureCP/).

  > [!NOTE]
  > Вы можете добавить группы и без AzureCP, вручную добавив идентификатор группы Azure AD, но такой метод неудобен и ненадежен. Это выглядит так:
  > 
  >![Добавление группы Azure AD в группу SharePoint по идентификатору](./media/sharepoint-on-premises-tutorial/adding-group-by-id.png)
  
### <a name="grant-permissions-to-an-azure-ad-group-in-sharepoint-on-premises"></a>Предоставление разрешений группе Azure AD в локальной среде SharePoint

Чтобы назначить группы безопасности Azure AD для локальной версии SharePoint, потребуется применить пользовательский поставщик утверждений для SharePoint Server. В этом примере используется AzureCP.

 > [!NOTE]
 > AzureCP не является продуктом корпорации Майкрософт и не поддерживается ее службой поддержки. Сведения о скачивании, установке и настройке AzureCP в локальной ферме SharePoint см. на веб-сайте [AzureCP](https://yvand.github.io/AzureCP/). 

1. Настройте AzureCP в локальной ферме SharePoint или настройте альтернативный пользовательский поставщик утверждений. Сведения о настройке AzureCP см. на [этой странице веб-сайта AzureCP](https://yvand.github.io/AzureCP/Register-App-In-AAD.html).

1. На портале Azure выберите **Azure Active Directory** > **Корпоративные приложения**. Выберите имя ранее созданного корпоративного приложения и щелкните **Единый вход**.

1. На странице **Настройка единого входа с помощью SAML** измените значения в разделе **Утверждения и атрибуты пользователя**.

1. Выберите **Добавить утверждение о группе**.

1. Выберите связанные с пользователем группы, которые должны быть возвращены в утверждении. В данном случае выберите **Все группы**. В разделе **Атрибут источника** выберите **Идентификатор группы** и нажмите **Сохранить**.

Чтобы предоставить доступ группе безопасности Azure AD в локальной среде SharePoint, предоставьте общий доступ к семейству веб-сайтов или добавьте группу безопасности Azure AD в одну из групп семейства веб-сайтов.

1. Перейдите в раздел **Семейство веб-сайтов SharePoint**. В разделе **Параметры сайта** для семейства веб-сайтов выберите **Пользователи и группы**. 

1. Выберите группу SharePoint, а затем нажмите **Создать** > **Добавление пользователей в эту группу**. При вводе имени группы в средстве выбора людей появится группа безопасности Azure AD.

    ![Добавление группы Azure AD в группу SharePoint](./media/sharepoint-on-premises-tutorial/permission-azure-ad-group.png)

### <a name="grant-access-to-a-guest-account-to-sharepoint-on-premises-in-the-azure-portal"></a>Предоставление гостевой учетной записи доступа к локальной среде SharePoint на портале Azure

Благодаря изменению имени субъекта-пользователя вы можете стандартным образом предоставлять гостевой учетной записи доступ к сайту SharePoint. Например, пользователь `jdoe@outlook.com` представлен в виде `jdoe_outlook.com#ext#@TENANT.onmicrosoft.com`. Чтобы предоставить общий доступ к сайту внешним пользователям, необходимо внести ряд изменений в раздел **Утверждения и атрибуты пользователя** на портале Azure.

1. На портале Azure выберите **Azure Active Directory** > **Корпоративные приложения**. Выберите имя ранее созданного корпоративного приложения и щелкните **Единый вход**.

1. На странице **Настройка единого входа с помощью SAML** измените значения в разделе **Утверждения и атрибуты пользователя**.

1. В области **Обязательное утверждение** нажмите **Уникальный идентификатор пользователя (ID)** .

1. Замените значение свойства **Атрибут источника** на **user.localuserprincipalname** и щелкните **Сохранить**.

    ![Утверждения и атрибуты пользователя, исходный атрибут](./media/sharepoint-on-premises-tutorial/manage-claim.png)

1. С помощью ленты вернитесь к разделу **Вход на основе SAML**. Теперь раздел **Утверждения и атрибуты пользователя** выглядит следующим образом: 

    ![Утверждения и атрибуты пользователя, итоговое состояние](./media/sharepoint-on-premises-tutorial/user-attributes-claims-final.png)

    > [!NOTE]
    > В этой конфигурации значения имени и фамилии не требуются.

1. На портале Azure в крайней слева области щелкните **Azure Active Directory**, а затем выберите **Пользователи**.

1. Выберите **Новый гостевой пользователь**.

1. Выберите параметр **Пригласить пользователя**. Заполните свойства пользователя и выберите **Пригласить**.

1. Теперь можно предоставить общий доступ к сайту с помощью MyGuestAccount@outlook.com и разрешить этому пользователю доступ к нему.

    ![Предоставление гостевым учетным записям доступа к сайту](./media/sharepoint-on-premises-tutorial/sharing-guest-account.png)

### <a name="configure-the-trusted-identity-provider-for-multiple-web-applications"></a>Настройка доверенного поставщика удостоверений для нескольких веб-приложений

Эта конфигурация подходит для одного веб-приложения, но если вы планируете использовать тот же доверенный поставщик удостоверений для нескольких веб-приложений, нужна дополнительная настройка. Предположим, например, что вы расширили веб-приложение для использования URL-адреса `https://sales.contoso.com` и хотите обеспечить проверку подлинности пользователей для `https://marketing.contoso.com`. Для этого нужно обновить поставщик удостоверений, чтобы учесть параметр WReply, и обновить регистрацию приложения в Azure AD, чтобы добавить URL-адрес ответа.

1. На портале Azure выберите **Azure Active Directory** > **Корпоративные приложения**. Выберите имя ранее созданного корпоративного приложения и щелкните **Единый вход**.

1. На странице **Настройка единого входа с помощью SAML** измените значения в разделе **Базовая конфигурация SAML**.

    ![Базовая конфигурация SAML](./media/sharepoint-on-premises-tutorial/add-reply-url.png)

1. В поле **URL-адрес ответа (URL-адрес службы обработчика утверждений)** добавьте URL-адрес дополнительного веб-приложения и нажмите кнопку **Сохранить**.

    ![Изменение базовой конфигурации SAML](./media/sharepoint-on-premises-tutorial/reply-url-for-web-application.png)

1. На сервере SharePoint откройте консоль управления SharePoint 201x и воспользуйтесь следующей командой. Используйте имя издателя доверенного токена удостоверений, которого вы использовали ранее.
    ```
    $t = Get-SPTrustedIdentityTokenIssuer "AzureAD"
    $t.UseWReplyParameter=$true
    $t.Update()
    ```
1. В **центре администрирования** перейдите к веб-приложению и включите существующий доверенный поставщик удостоверений.

Возможно, вам понадобится предоставить внутренним пользователям доступ к локальному экземпляру SharePoint в других сценариях. В этом же сценарии необходимо развернуть Microsoft Azure Active Directory Connect, чтобы обеспечить синхронизацию локальных пользователей с Azure AD. Данная настройка обсуждается в другой статье.

## <a name="next-steps"></a>Next Steps

После настройки локальной версии SharePoint вы можете применить функцию управления сеансом, которая защищает от хищения конфиденциальных данных вашей организации и несанкционированного доступа к ним в реальном времени. Управление сеансом является расширением функции условного доступа. [Узнайте, как применять управление сеансами с помощью Microsoft Cloud App Security](https://docs.microsoft.com/cloud-app-security/proxy-deployment-aad).
