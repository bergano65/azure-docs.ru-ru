---
title: Настройка приложения OpenID или OAuth из коллекции приложений Azure AD | Документация Майкрософт
description: Инструкции по настройке приложения OpenID или OAuth из коллекции приложений Azure AD
services: active-directory
documentationCenter: na
author: jeevansd
manager: femila
ms.assetid: eedebb76-e78c-428f-9cf0-5891852e79fb
ms.service: active-directory
ms.component: saas-app-tutorial
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/25/2018
ms.author: jeedes
ms.openlocfilehash: 04639e6d27854d9c25b97936b163cfaaa25fc375
ms.sourcegitcommit: 02ce0fc22a71796f08a9aa20c76e2fa40eb2f10a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2018
ms.locfileid: "51287444"
---
# <a name="configure-an-openidoauth-application-from-the-azure-ad-app-gallery"></a>Настройка приложения OpenID или OAuth из коллекции приложений Azure AD

## <a name="process-of-adding-an-openid-application-from-the-gallery"></a>Добавление приложения OpenID из коллекции

1. На [портале Azure](https://portal.azure.com) в области слева щелкните **Azure Active Directory**. 

    ![Кнопка "Azure Active Directory"](./media/openidoauth-tutorial/tutorial_general_01.png)

2. Выберите **Корпоративные приложения** > **Все приложения**.

    ![Колонка "Корпоративные приложения"](./media/openidoauth-tutorial/tutorial_general_02.png)

3. В верхней части диалогового окна выберите **Создать приложение**.

    ![Кнопка "Новое приложение"](./media/openidoauth-tutorial/tutorial_general_03.png)

4. В поле поиска введите имя приложения. Выберите нужное приложение на панели результатов и выполните его регистрацию.

    ![Добавление приложения](./media/openidoauth-tutorial/addfromgallery.png)

    > [!NOTE]
    > Для приложений OpenID Connect и OAuth кнопка **Добавить** отключена по умолчанию. Администратор клиента должен нажать кнопку "Регистрация" и дать согласие на регистрацию приложения. Затем приложение добавляется к клиенту пользователя, где выполняется конфигурация. Нет необходимости явно добавлять приложение.

    ![Кнопка "Добавить"](./media/openidoauth-tutorial/addbutton.png)

5. Если выбрать ссылку регистрации, вы будете перенаправлены на страницу Azure Active Directory (Azure AD) учетных данных для входа.

6. После успешной проверки подлинности дайте согласие на странице согласия. После этого откроется домашняя страница приложения.

    > [!NOTE]
    > Вы можете добавить только один экземпляр приложения. Если вы уже добавили экземпляр приложения и пытаетесь еще раз дать согласие, экземпляр не будет повторно добавлен в клиент. Поэтому можно использовать только один экземпляр приложения в клиенте.

## <a name="authentication-flow-using-openid-connect"></a>Поток проверки подлинности при использовании OpenID Connect

Наиболее простой процесс входа содержит следующие этапы.

![Поток проверки подлинности при использовании OpenID Connect](./media/openidoauth-tutorial/authenticationflow.png)

### <a name="multitenant-application"></a>Мультитенантное приложение 
Мультитенантное приложение предназначено для использования не только в одной организации, а в нескольких. Как правило, это приложения категории "программное обеспечение как услуга" (SaaS), которые создают независимые поставщики программных продуктов (ISV). 

Мультитенантные приложения должны быть подготовлены в каждом каталоге, где они будут использоваться. Для их регистрации требуется согласие пользователей или администраторов. Процесс предоставление разрешений начинается, когда приложение регистрируется в каталоге и получает доступ к API-интерфейсу Graph или, возможно, к другому веб-интерфейсу API. Когда пользователь или администратор из другой организации регистрируется для использования приложения, появляется диалоговое окно, в котором отображаются разрешения, необходимые для приложения. 

Затем пользователь или администратор может предоставить согласие для приложения. Согласие дает приложению доступ к необходимым данным и регистрирует приложение в каталоге.

> [!NOTE]
> Если вы делаете свое приложение доступным для пользователей в нескольких каталогах, требуется механизм, чтобы определять, членами какого клиента они являются. Приложение с одним клиентом должно присутствовать только в собственном каталоге для пользователя. Мультитенантное приложение должно определить конкретного пользователя из всех каталогов в Azure AD.
> 
> Для выполнения этой задачи система Azure AD предоставляет общую конечную точку проверки подлинности, в которую мультитенантное приложение может направлять запросы на вход, вместо конечной точки для конкретного клиента. Для всех каталогов в Azure AD эта конечная точка — [https://login.microsoftonline.com/common](https://login.microsoftonline.com/common). Конечной точкой для конкретного клиента может быть [https://login.microsoftonline.com/contoso.onmicrosoft.com](https://login.microsoftonline.com/contoso.onmicrosoft.com). 
>
> Общую конечную точку следует учитывать при разработке своего приложения. Вам понадобится специальная логика для обработки нескольких клиентов во время входа, выхода и проверки маркеров.

Azure AD поддерживает мультитенантные приложения по умолчанию. Они легко доступные между организациями и простые в использовании после принятия согласия.

## <a name="consent-framework"></a>Платформа предоставления согласия

Платформа согласия Azure AD позволяет легко разрабатывать мультитенантные веб-приложения и собственные клиентские приложения. Эти приложения позволяют входить в учетные записи пользователей с клиентов Azure AD, отличных от того, где было зарегистрировано приложение. Им также может потребоваться доступ к веб-API, таким как:
- API Microsoft Graph, для доступа к Azure AD, Intune и службам Office 365; 
- других API служб Майкрософт;
- собственных веб-API. 

Эта платформа использует согласие пользователя или администратора на регистрацию приложения в своем каталоге. Для регистрации может потребоваться доступ к данным каталога. После предоставления такого согласия клиентское приложение сможет вызывать API Microsoft Graph от имени этого пользователя и пользоваться сведениями по мере необходимости.

[API Microsoft Graph](https://developer.microsoft.com/graph/) предоставляет доступ к данным в Office 365, например:

- календарям и сообщениям Exchange;
- сайтам и спискам SharePoint;
- документам в OneDrive;
- записным книжкам в OneNote;
- задачам Планировщика;
- книгам Excel.

API Graph также обеспечивает доступ для пользователей и групп из Azure AD и других объектов данных из нескольких облачных служб Майкрософт.

Ниже показаны особенности работы процедуры согласия для разработчика приложения и пользователя.

1. Предположим, у вас есть приложение веб-клиента, которому необходимо запросить конкретные разрешения для получения доступа к ресурсу или API. Портал Azure используется для объявления запросов на разрешения во время настройки. Как и другие параметры конфигурации, они становятся частью регистрации Azure AD приложения:

    ![API Graph](./media/openidoauth-tutorial/graphapi.png)

2. Представим себе, что разрешения вашего приложения были обновлены. Само приложение запущено, а пользователь собирается воспользоваться им в первый раз. Сначала приложение должно получить код авторизации из Azure AD или конечной точки авторизации. Код авторизации можно использовать для получения новых маркеров доступа или обновления.

3. Если пользователь еще не выполнил проверку подлинности, Azure AD или конечная точка авторизации запросит данные для входа.

    ![Authentication](./media/openidoauth-tutorial/authentication.png)

4. После входа Azure AD определяет, требуется ли отобразить этому пользователю страницу согласия. Принятие этого решения основано на том, дал ли этот пользователь (или администратор его организации) свое согласие для приложения.

   Если согласие еще не было дано, Azure AD запрашивает у пользователя согласие и отображает необходимые для этого разрешения. Разрешения, отображаемые в диалоговом окне согласия, соответствуют разрешениям, выбранным в делегированных разрешениях на портале Azure.

    ![Страница предоставления согласия](./media/openidoauth-tutorial/consentpage.png)

Обычный пользователь может дать согласие на некоторые разрешения. Для других разрешений требуется согласие администратора клиента.

## <a name="difference-between-admin-consent-and-user-consent"></a>Разница между согласием администратора и согласием пользователя

Обладая правами администратора, вы можете также согласиться использовать делегированные разрешения приложения от имени всех пользователей в клиенте. Согласие администратора предотвращает появление диалогового окна согласия отдельно для каждого пользователя в клиенте. Пользователи, которым назначена роль администратора, могут предоставить согласие на портале Azure. На странице **Параметры** приложения выберите **Необходимые разрешения** > **Предоставить разрешения**.

![Кнопка "Предоставление разрешений"](./media/openidoauth-tutorial/grantpermission.png)

> [!NOTE]
> Для одностраничных приложений (SPA), использующих ADAL.js, сейчас требуется предоставление явного разрешения с помощью кнопки **Предоставить разрешения**. В противном случае происходит сбой приложения при запросе маркера доступа.

Для разрешений "только для приложения" всегда требуется согласие администратора клиента. Если приложение запрашивает разрешение "только для приложения", и пользователь пытается войти в приложение, появится сообщение об ошибке. Это сообщение говорит о том, что пользователь не может принять это разрешение.

Если приложение использует разрешения, требующие согласия администратора, то в приложении должен быть элемент, такой как кнопка или ссылка, с помощью которого администратор может запустить действие. Запрос, отправляемый приложением для этого действия, является обычным запросом авторизации OAuth2 или OpenID Connect. Этот запрос содержит параметр строки запроса *prompt=admin_consent*. 

После того как администратор предоставит свое согласие, а в клиенте пользователя будет создан субъект-служба, в последующих запросах входа не нужно будет указывать параметр *prompt=admin_consent*. После того как администратор решил, что запрошенные разрешения являются приемлемыми, у других пользователей клиента согласие запрашиваться не будет.

Администратор клиента может отключить возможность обычным пользователям предоставлять согласие для приложений. Если эта возможность отключена, то для использования приложения в клиенте всегда требуется согласие администратора. Чтобы протестировать приложение, в котором отключена возможность предоставления согласия для конечных пользователей, найдите соответствующий параметр на [портале Azure](https://portal.azure.com/). Перейдите к разделу[Параметры пользователя](https://portal.azure.com/#blade/Microsoft_AAD_IAM/StartboardApplicationsMenuBlade/UserSettings/menuId/) и выберите **Корпоративные приложения**.

Параметр *prompt=admin_consent* может использоваться приложениями, запрашивающими разрешения, которые не требуют согласия администратора. Примером может служить приложение, которому необходима возможность одноразовой регистрации администратора клиента. После этой регистрации согласие у других пользователей не запрашивается.

Представьте, что приложение требует согласия администратора, и администратор выполняет вход, но параметр *prompt=admin_consent* не передается. Когда администратор успешно предоставит приложению согласие, оно применяется только для своей учетной записи пользователя. Обычные пользователи по-прежнему не смогут выполнять вход и давать свое согласие приложению. Это удобно в тех случаях, когда администратору клиента нужно просмотреть приложение, прежде чем предоставлять доступ к приложению другим пользователям.