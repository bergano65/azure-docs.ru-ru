---
title: Работа с существующими локальными прокси-серверами и Azure Active Directory
description: Описание работы с существующими локальными прокси-серверами с Azure Active Directory.
services: active-directory
author: kenwith
manager: celestedg
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.topic: how-to
ms.date: 04/07/2020
ms.author: kenwith
ms.reviewer: japere
ms.custom: contperfq2
ms.openlocfilehash: 81a735966b2a0ebdd7c8fcd9e9aa467d68aac354
ms.sourcegitcommit: 400f473e8aa6301539179d4b320ffbe7dfae42fe
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/28/2020
ms.locfileid: "92792758"
---
# <a name="work-with-existing-on-premises-proxy-servers"></a>Работа с имеющимися локальными прокси-серверами

В этой статье описывается, как настроить соединители прокси приложения Azure Active Directory для работы с исходящими прокси-серверами. Она предназначена для клиентов, использующих сетевые среды с имеющимися прокси.

Рассмотрим основные сценарии развертывания:

* Настройка соединителей для обхода локальных исходящих прокси-серверов.
* Настройка соединителей для доступа к прокси приложения Azure AD через исходящий прокси-сервер.
* Настройте использование прокси-сервера между соединителем и серверным приложением.

Дополнительные сведения о соединителях см. в статье [Сведения о соединителях прокси приложения Azure AD](application-proxy-connectors.md).

## <a name="bypass-outbound-proxies"></a>Обход исходящих прокси-серверов

Соединители имеют базовые компоненты ОС, выполняющие исходящие запросы. Эти компоненты автоматически пытаются найти прокси-сервер в сети с помощью автоматического обнаружения веб-прокси (WPAD).

Компоненты ОС для поиска прокси-сервера выполняют поиск в DNS для доменного имени wpad.[доменный_суффикс]. Если поиск в DNS возвращает IP-адрес для этого имени, выполняется HTTP-запрос на этот адрес для получения файла wpad.dat. Этот запрос возвращает скрипт конфигурации прокси-сервера для вашей среды. Соединитель использует этот скрипт, чтобы выбрать исходящий прокси-сервер. Однако прокси-сервер может не принимать трафик соединителя, поскольку для этого требуется настройка дополнительных параметров конфигурации.

Можно настроить соединитель, чтобы он игнорировал локальный прокси-сервер и подключался к службам Azure напрямую. Мы рекомендуем использовать именно этот подход (если допускает политика сети), так как он позволяет сократить количество конфигураций.

Чтобы отключить в соединителе использование исходящего прокси-сервера, измените файл C:\Program Files\Microsoft AAD App Proxy Connector\ApplicationProxyConnectorService.exe.config. Добавьте в него раздел *system.net* с приведенным далее текстом:

```xml
<?xml version="1.0" encoding="utf-8" ?>
<configuration>
  <system.net>
    <defaultProxy enabled="false"></defaultProxy>
  </system.net>
  <runtime>
    <gcServer enabled="true"/>
  </runtime>
  <appSettings>
    <add key="TraceFilename" value="AadAppProxyConnector.log" />
  </appSettings>
</configuration>
```

Чтобы служба обновления соединителя также обходила прокси-сервер, измените аналогичным образом и файл ApplicationProxyConnectorUpdaterService.exe.config. Этот файл расположен в каталоге C:\Program Files\Microsoft AAD App Proxy Connector Updater.

Обязательно сделайте копии исходных файлов на случай, если потребуется восстановить конфигурации по умолчанию.

## <a name="use-the-outbound-proxy-server"></a>Использование исходящего прокси-сервера

В некоторых средах весь исходящий трафик без исключений должен проходить через исходящий прокси-сервер. В результате этого невозможно будет выполнить обход прокси-сервера.

Вы можете настроить передачу трафика соединителя через исходящий прокси-сервер, как показано на следующей схеме:

 ![Использование исходящего прокси-сервера для передачи трафика от соединителя к прокси приложения Azure AD](./media/application-proxy-configure-connectors-with-proxy-servers/configure-proxy-settings.png)

Поскольку соединитель использует только исходящий трафик, нет необходимости пропускать входящий трафик через брандмауэры.

> [!NOTE]
> Прокси приложения не поддерживает проверку подлинности других прокси. Учетные записи служб соединителя и (или) обновления должны иметь возможность подключаться к прокси-серверу без необходимости проверки подлинности.

### <a name="step-1-configure-the-connector-and-related-services-to-go-through-the-outbound-proxy"></a>Шаг 1. Настройка использования исходящего прокси-сервера для соединителя и службы средства обновления

Если автоматическое обнаружение веб-прокси включено в среде и настроено должным образом, соединитель обнаружит исходящий прокси-сервер автоматически и попытается его использовать. Тем не менее можно явным образом настроить использование исходящего прокси-сервера для соединителя.

Для этого измените файл C:\Program Files\Microsoft AAD App Proxy Connector\ApplicationProxyConnectorService.exe.config и добавьте раздел *system.net* , поместив в него следующий образец кода. Вместо *proxyserver:8080* укажите имя или IP-адрес локального прокси-сервера и номер порта для доступа к нему. Значение должно иметь префикс http://, даже если вы используете IP-адрес.

```xml
<?xml version="1.0" encoding="utf-8" ?>
<configuration>
  <system.net>  
    <defaultProxy>   
      <proxy proxyaddress="http://proxyserver:8080" bypassonlocal="True" usesystemdefault="True"/>   
    </defaultProxy>  
  </system.net>
  <runtime>
    <gcServer enabled="true"/>
  </runtime>
  <appSettings>
    <add key="TraceFilename" value="AadAppProxyConnector.log" />
  </appSettings>
</configuration>
```

Затем настройте службу обновления соединителя, чтобы она использовала тот же прокси-сервер, изменив аналогичным образом файл конфигурации, расположенный по пути C:\Program Files\Microsoft AAD App Proxy Connector Updater\ApplicationProxyConnectorUpdaterService.exe.config.

### <a name="step-2-configure-the-proxy-to-allow-traffic-from-the-connector-and-related-services-to-flow-through"></a>Шаг 2. Настройка прокси-сервера для передачи трафика соединителя и связанных с ним служб

В настройках прокси-сервера нужно учесть 4 аспекта:

* правила для исходящих подключений прокси-сервера;
* проверка подлинности прокси-сервера;
* порты прокси-сервера;
* проверка TLS;

#### <a name="proxy-outbound-rules"></a>правила для исходящих подключений прокси-сервера;

Разрешите доступ к следующим URL-адресам.

| URL-адрес | Порт |  Как он используется |
| --- | --- | --- |
| &ast;.msappproxy.net;<br>&ast;.servicebus.windows.net. | 443/HTTPS | Связь между соединителем и облачной службой прокси приложения |
| crl3.digicert.com<br>crl4.digicert.com<br>ocsp.digicert.com<br>crl.microsoft.com<br>oneocsp.microsoft.com<br>ocsp.msocsp.com<br> | 80/HTTP | Соединитель использует эти URL-адреса для проверки сертификатов. |
| login.windows.net<br>secure.aadcdn.microsoftonline-p.com<br>&ast;.microsoftonline.com<br>&ast;.microsoftonline-p.com<br>&ast;.msauth.net<br>&ast;.msauthimages.net<br>&ast;.msecnd.net<br>&ast;.msftauth.net<br>&ast;.msftauthimages.net<br>&ast;.phonefactor.net<br>enterpriseregistration.windows.net<br>management.azure.com<br>policykeyservice.dc.ad.msft.net<br>ctldl.windowsupdate.com | 443/HTTPS | Соединитель использует эти URL-адреса во время регистрации. |
| ctldl.windowsupdate.com | 80/HTTP | В процессе регистрации соединитель использует этот URL-адрес. |

Если брандмауэр или прокси-сервер позволяет настроить списки разрешенных DNS, можно разрешить подключения к \*.msappproxy.net и \*.servicebus.windows.net.

Невозможно разрешить подключения по полному доменному имени. Вместо этого укажите диапазоны IP-адресов. Используйте следующие параметры:

* разрешите соединителю исходящий доступ к любым адресам назначения;
* разрешите соединителю исходящий доступ ко всем диапазонам IP-адресов центров обработки данных Azure. Если вы предпочитаете использовать диапазоны IP-адресов центров обработки данных Azure, вас ждет одна сложность — эти списки обновляются еженедельно. Необходимо организовать процесс соответствующего обновления правил доступа. Использование только подмножества IP-адресов может привести к прерыванию работы конфигурации. Чтобы скачать последние диапазоны IP-адресов центра обработки данных Azure, перейдите на страницу [https://download.microsoft.com](https://download.microsoft.com) и выполните поиск по запросу "диапазоны IP-адресов Azure и теги службы". Обязательно выберите соответствующее облако. Например, диапазоны IP-адресов общедоступного облака можно найти в области "диапазоны IP-адресов Azure" и "Теги службы — общедоступное облако". Облако для государственных организаций США можно найти, выполнив поиск по фразе "диапазоны IP-адресов Azure" и "Теги службы — облако для государственных организаций США".

#### <a name="proxy-authentication"></a>проверка подлинности прокси-сервера;

Проверка подлинности прокси в настоящее время не поддерживается. Сейчас мы рекомендуем разрешить соединителю получать анонимный доступ к определенному сайту Интернета.

#### <a name="proxy-ports"></a>порты прокси-сервера;

Соединитель устанавливает исходящие TLS-подключения, используя метод CONNECT. По сути он создает туннель через исходящий прокси-сервер. В настройках прокси-сервера разрешите туннелирование к портам 443 и 80.

> [!NOTE]
> При запуске служебной шины по протоколу HTTPS используется порт 443. По умолчанию служебная шина пытается использовать прямые TCP-подключения, а протокол HTTPS применяет только при невозможности прямого подключения.

#### <a name="tls-inspection"></a>проверка TLS;

Для трафика соединителя не стоит использовать проверку TLS, так как это вызывает проблемы. Этот соединитель использует сертификат для проверки подлинности службы прокси приложения, а он может быть потерян при проверке TLS.

## <a name="configure-using-a-proxy-between-the-connector-and-backend-application"></a>Настройка использования прокси-сервера между соединителем и серверным приложением
Использование прямого прокси-сервера для обмена данными с серверным приложением может быть специальным требованием в некоторых средах.
Чтобы включить эту функцию, выполните следующие действия.

### <a name="step-1-add-the-required-registry-value-to-the-server"></a>Шаг 1. Добавьте требуемое значение реестра на сервер
1. Чтобы включить использование прокси-сервера по умолчанию, добавьте следующий параметр реестра (DWORD) `UseDefaultProxyForBackendRequests = 1` в раздел реестра конфигурации соединителя, расположенный в разделе HKEY_LOCAL_MACHINE\Software\Microsoft\Microsoft AAD App Proxy Connector.

### <a name="step-2-configure-the-proxy-server-manually-using-netsh-command"></a>Шаг 2. Настройте прокси-сервер вручную с помощью команды netsh
1.  Включите групповую политику «Задать параметры прокси для компьютера». Она находится в следующем разделе: Конфигурация компьютера\Политики\Административные шаблоны\Компоненты Windows\Internet Explorer. Необходимо задать именно этот параметр вместо задания политики для пользователя.
2.  Запустите `gpupdate /force` на сервере или перезагрузите сервер, чтобы убедиться в том, что он использует обновленные параметры групповой политики.
3.  Запустите командную строку с повышенными привилегиями с правами администратора и введите `control inetcpl.cpl`.
4.  Настройте необходимые параметры прокси-сервера. 

Эти параметры позволяют соединителю использовать один и тот же прокси-сервер для обмена данными с Azure и серверным приложением. Если соединителю для обмена данными с Azure не требуется использовать прямой прокси-сервер или другой прямой прокси-сервер, можно настроить его путем изменения файла ApplicationProxyConnectorService.exe.config, как описано в разделах «Обход исходящих прокси-серверов» или «Использование исходящего прокси-сервера».

> [!NOTE]
> Существует множество способов настройки Интернет-прокси в операционной системе. Параметры прокси-сервера, настроенные с помощью команды NETSH WINHTTP (выполнить `NETSH WINHTTP SHOW PROXY` для проверки), переопределяют параметры прокси-сервера, настроенные на шаге 2. 

Служба обновления соединителя также будет использовать прокси-сервер компьютера. Это поведение можно изменить, отредактировав файл ApplicationProxyConnectorUpdaterService.exe.config.

## <a name="troubleshoot-connector-proxy-problems-and-service-connectivity-issues"></a>Устранение неполадок в работе соединителя через прокси-сервера и с подключением к службе

Теперь весь трафик должен проходить через прокси-сервер. Если вы столкнетесь с проблемами, попробуйте применить следующие сведения об устранении неполадок.

Чтобы определять и устранять проблемы с подключением соединителя, мы рекомендуем записывать сетевые данные во время запуска службы соединителя. Ниже приведены некоторые рекомендации, как записывать и фильтровать данные трассировки сети.

Вы можете использовать выбранное средство мониторинга. Для целей этой статьи используется анализатор сообщений (Майкрософт).

Следующие примеры относятся к анализатору сообщений, но принципы могут быть применены к любому средству анализа.

### <a name="take-a-capture-of-connector-traffic"></a>Сбор трафика соединителя

Для первоначального устранения неполадок сделайте следующее:

1. Из оснастки services.msc остановите службу соединителя прокси приложения Azure AD.

   ![Служба соединителя прокси приложения Azure AD в services.msc](./media/application-proxy-configure-connectors-with-proxy-servers/services-local.png)

1. Запустите анализатор сообщений от имени администратора.
1. Выберите **Start local trace** (Запустить локальную трассировку).
1. Запустите службу соединителя прокси приложения Azure AD.
1. Остановите запись сетевых данных.

   ![Снимок экрана с кнопкой Stop network capture (Остановить запись сетевых данных)](./media/application-proxy-configure-connectors-with-proxy-servers/stop-trace.png)

### <a name="check-if-the-connector-traffic-bypasses-outbound-proxies"></a>Проверка, обходит ли трафик соединителя исходящие прокси

Если соединитель прокси приложения настроен для обхода прокси-серверов и напрямую подключается к службе прокси приложения, можно просмотреть сетевые данные на наличие неудачных попыток подключения TCP.

Эти попытки можно определить с помощью фильтра анализатора сообщений. Введите `property.TCPSynRetransmit` в поле фильтра и выберите **Применить** .

Пакет SYN — это первый пакет, отправленный для установления подключения TCP. Если ответ на этот пакет не возвращается, пакет SYN отправляется еще раз. Для поиска повторных пакетов SYN можно использовать предыдущий фильтр. После этого можно проверить, соответствуют ли эти пакеты SYN трафику соединителя.

Если соединитель действительно должен создавать прямое соединение со службами Azure, отклики SynRetransmit на порте 443 указывают на то, что имеется проблема сети или брандмауэра.

### <a name="check-if-the-connector-traffic-uses-outbound-proxies"></a>Проверка, использует ли трафик соединителя исходящие прокси

Если трафик соединителя прокси приложения настроен для прохода через прокси-серверы, можно найти неудачные HTTP-подключения к прокси.

Чтобы отфильтровать сетевые данные для таких попыток подключения, введите `(https.Request or https.Response) and tcp.port==8080` в фильтре анализатора сообщений, заменив 8080 своим портом службы прокси. Чтобы просмотреть результаты фильтрации, выберите **Применить** .

Указанный выше фильтр отбирает только HTTP-запросы на порт прокси-сервера и его ответы. Нужно найти запросы CONNECT, которые демонстрируют взаимодействие с прокси-сервером. В случае успеха вы получите ответ OK с HTTP-кодом 200.

Если отобразятся другие коды ответов, например 407 или 502, это означает, что прокси-сервер требует проверки подлинности или не разрешает передачу трафика по другой причине. На этом этапе следует обратиться в службу поддержки прокси-сервера.

## <a name="next-steps"></a>Дальнейшие действия

* [Сведения о соединителях прокси приложения Azure AD](application-proxy-connectors.md)
* При возникновении проблем с подключением соединителя задайте вопрос на [странице Майкрософт с вопросами и ответами по Azure Active Directory](https://docs.microsoft.com/answers/topics/azure-active-directory.html) или отправьте запрос в службу технической поддержки.
