---
title: Сведения о соединителях прокси приложения Azure AD | Документация Майкрософт
description: Основные сведения о соединителях прокси приложения Azure AD.
services: active-directory
author: msmimart
manager: CelesteDG
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.topic: conceptual
ms.date: 11/15/2018
ms.author: mimart
ms.reviewer: japere
ms.collection: M365-identity-device-management
ms.openlocfilehash: f337ea9d55a119c3aec6e94649cdbf049f99e9d6
ms.sourcegitcommit: 36c50860e75d86f0d0e2be9e3213ffa9a06f4150
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/16/2019
ms.locfileid: "65783684"
---
# <a name="understand-azure-ad-application-proxy-connectors"></a>Сведения о соединителях прокси приложения Azure AD

Соединители являются основой для работы прокси приложения Azure AD. Они просты в использовании, развертывании и обслуживании. К тому же они очень производительны. В этой статье объясняется, что такое соединители, как они работают, и приводится несколько рекомендаций по оптимизации развертывания. 

## <a name="what-is-an-application-proxy-connector"></a>Что такое соединитель прокси приложения

Соединители — это упрощенные агенты, которые размещены в локальной среде. Они помогают устанавливать исходящие подключения к прокси приложения службы. Соединители необходимо установить на сервере Windows с доступом ко внутреннему приложению. Соединители можно организовать в группы соединителей, каждая из которых обрабатывает трафик определенных приложений.

## <a name="requirements-and-deployment"></a>Требования и развертывание

Чтобы успешно развернуть прокси приложения, необходим по крайней мере один соединитель, но мы рекомендуем использовать не меньше двух, чтобы повысить гибкость. Установить соединитель на компьютере под управлением Windows Server 2012 R2 или более поздней версии. Соединителю нужен доступ к службе Application Proxy и к локальным приложениям, которые вы публикуете. 

### <a name="windows-server"></a>Сервер Windows
Вам также потребуется сервер под управлением Windows Server 2012 R2 или более поздней версии, на котором можно установить соединитель Application Proxy. Серверу нужна возможность подключаться к службам Application Proxy в Azure, а также к локальным приложениям, которые вы публикуете.

Прежде чем установить этот соединитель, на сервере Windows Server нужно включить протокол TLS 1.2. Существующие соединители версий ниже 1.5.612.0 будут продолжать работать с предыдущими версиями TLS до последующего уведомления. Включение протокола TLS 1.2

1. Настройте следующие разделы реестра:
    
    ```
    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2]
    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Client] "DisabledByDefault"=dword:00000000 "Enabled"=dword:00000001
    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Server] "DisabledByDefault"=dword:00000000 "Enabled"=dword:00000001
    [HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v4.0.30319] "SchUseStrongCrypto"=dword:00000001
    ```

2. Перезапустите сервер.


Дополнительные сведения о требованиях к сети для сервера соединителя см. в разделе [Начало работы с прокси приложения и установка соединителя](application-proxy-add-on-premises-application.md).

## <a name="maintenance"></a>Обслуживание
Соединители и служба отвечают за выполнение задач, связанных с высоким уровнем доступности. Их можно добавлять или удалять динамически. Когда поступает новый запрос, он перенаправляется на один из доступных соединителей. Если соединитель временно недоступен, он перестает реагировать на трафик.

Соединители не поддерживают отслеживание состояния и не хранят данные конфигурации на компьютере. Единственные данные, которые они хранят, — это параметры подключения к службе и ее сертификат аутентификации. При подключении к службе соединители извлекают все необходимые данные конфигурации и обновляют их каждые несколько минут.

Они также опрашивают сервер, чтобы узнать, появилась ли более новая версия соединителя. Если такая версия будет найдена, соединители обновятся.

Соединители можно отслеживать с компьютера, на котором они выполняются, с помощью журнала событий и счетчиков производительности. Их состояние можно также просмотреть на портале Azure, на странице прокси приложения.

 ![Соединители прокси приложения Azure AD](./media/application-proxy-connectors/app-proxy-connectors.png)

Вам не требуется вручную удалять неиспользуемые соединители. Выполняясь, соединитель остается активным, так как подключается к службе. Неиспользуемые соединители помечаются как _неактивные_ и удаляются спустя 10 дней бездействия. Если вы хотите удалить соединитель, то удалите с сервера службу соединителя и службу средства обновления. Перезагрузите компьютер, чтобы полностью удалить службу.

## <a name="automatic-updates"></a>Автоматические обновления

Azure AD обеспечивает автоматическое обновление всех развертываемых соединителей. Пока служба средства обновления соединителей прокси приложения работает, соединители будут обновляться автоматически. Если служба обновления соединителей не отображается на сервере, для получения обновлений необходимо [переустановить соединитель](application-proxy-add-on-premises-application.md). 

Если вы не хотите дожидаться, когда ваш соединитель обновится автоматически, вы можете выполнить обновление вручную. Перейдите на [страницу скачивания соединителя](https://download.msappproxy.net/subscription/d3c8b69d-6bf7-42be-a529-3fe9c2e70c90/connector/download) на сервере, где находится соединитель, и выберите команду **Скачать**. Запустится обновление локального соединителя. 

Если клиент имеет несколько соединителей, автоматическое обновление производится для каждого соединителя поочередно в каждой группе, что позволяет избежать простоев в среде. 

При обновлении соединителя могут возникать простои в следующих случаях.  
- У вас есть только один соединитель, мы рекомендуем вам установить еще один и [создать группу соединителей](application-proxy-connector-groups.md). Это поможет избежать простоя и обеспечит более высокий уровень доступности.  
- Соединитель выполнял транзакцию в момент начала обновления. Хотя исходная транзакция утеряна, браузер должен автоматически повторить операцию. Вы также можете обновить страницу. При повторном запросе трафик направляется на резервный соединитель.

Чтобы просмотреть сведения о предыдущих версиях и изменениях в них, см. статью [Azure AD Application Proxy: Version release history](application-proxy-release-version-history.md) (Прокси-сервер приложений Azure AD — история версий).

## <a name="creating-connector-groups"></a>Создание групп соединителей

Группы соединителей позволяют назначить определенные соединители для конкретных приложений. Несколько соединителей можно сгруппировать и назначить каждое приложение группе. 

Группы соединителей упрощают управление крупными развертываниями. Они также сокращают задержку для клиентов, приложения которых размещены в различных регионах, так как можно создать группы соединителей на основе расположения только для локальных приложений. 

Дополнительные сведения о группах соединителей см. в статье [Публикация приложений в отдельных сетях и расположениях с помощью групп соединителей](application-proxy-connector-groups.md).

## <a name="capacity-planning"></a>Планирование ресурсов 

Обязательно проверьте, что между соединителями существует достаточная производственная мощность для обработки ожидаемого объема трафика. В общем, чем больше пользователей, тем больше компьютер необходим. Ниже приведена таблица с описанием объема, который могут обработать разные компьютеры. Обратите внимание, что все данные основаны на ожидаемом числе транзакций в секунду (TPS), а не на числе пользователей. Причина в том, что шаблоны использования различаются, и на их основании нельзя спрогнозировать нагрузку. В зависимости от размера ответов и времени отклика серверного приложения также будут наблюдаться некоторые различия. Больший размер ответов и большее время отклика приведут к снижению максимального числа транзакций в секунду (макс. TPS). Мы рекомендуем, чтобы у вас были дополнительные компьютеры, благодаря чему распределенная нагрузка на машины составит примерно 50%. Дополнительные емкости обеспечат вам высокую доступность и отказоустойчивость.

|Ядра|ОЗУ|Ожидаемая задержка (мс)-P99|Макс. TPS|
| ----- | ----- | ----- | ----- |
|2|8|325|586|
|4.|16|320|1150|
|8|32|270|1190|
|16|64|245|1200*|

\* Этот компьютер используется пользовательский параметр для вызывают у них ограничения подключений по умолчанию за пределами .NET, рекомендуемые параметры. Рекомендуем запустить тест с параметрами по умолчанию, прежде чем обратиться в службу поддержки, чтобы изменить это ограничение для своего клиента.
 
>[!NOTE]
>В максимальном показателе TPS между компьютерами с 4, 8 и 16 ядрами нет существенных различий. Основное различие между ними — в ожидаемой задержке.  

## <a name="security-and-networking"></a>Безопасность и сеть

Соединители можно устанавливать в любом месте в сети. Поэтому они могут отправлять запросы к службе прокси приложения. Вам достаточно лишь обеспечить доступ к вашим приложениям с компьютера, на котором выполняется соединитель. Можно установить соединители в корпоративной сети или на виртуальной машине, работающей в облаке. Соединители могут работать в сети периметра, называются демилитаризованной зоны (DMZ), но это необязательно, так как весь трафик является исходящим, поэтому сеть защищена.

Соединители отправляют только исходящие запросы. Исходящий трафик отправляется в службу прокси приложения и в опубликованные приложения. Нет необходимости открывать входящие порты, так как после установления сеанса трафик передается в обе стороны. Вам также не нужно настраивать входящий доступ через брандмауэры. 

Дополнительные сведения о настройке правил брандмауэра для исходящего трафика см. в статье [Работа с имеющимися локальными прокси-серверами](application-proxy-configure-connectors-with-proxy-servers.md).


## <a name="performance-and-scalability"></a>Производительность и масштабирование

Для службы прокси приложения масштабирование выполняется прозрачно, но масштабирование соединителей может стать важным фактором. Для обработки пикового трафика необходимо иметь достаточное количество соединителей. Так как соединители не поддерживают отслеживание состояния, для них не имеет значения количество пользователей или сеансов. Но они зависят от количества запросов и объема полезных данных в этих запросах. Обычный компьютер может обработать несколько тысяч запросов стандартного веб-трафика в секунду. Этот показатель зависит от точных характеристик компьютера. 

Производительность соединителя связана с ЦП и сетью. Производительность ЦП важна при шифровании и расшифровке SSL, а сеть нужна, чтобы быстро подключаться к приложениям и веб-службе в Azure.

Память, напротив, меньше всего важна для соединителей. Веб-служба выполняет большую часть операций обработки и отвечает за весь трафик, не прошедший аутентификацию. Все, что можно сделать в облаке, осуществляется в облаке. 

Если по какой-либо причине этот соединитель или компьютер станут недоступны, трафик перейдет к другому соединителю в группе. Такая устойчивость — еще одна причина, по которой мы рекомендуем использовать несколько соединителей.

На производительность также влияет качество сетевого подключения между соединителями, которое определяется следующими факторами. 

* **Веб-служба**. Медленные подключения или подключения с высокой задержкой к службе прокси приложения в Azure влияют на производительность соединителя. Чтобы обеспечить максимальную производительность, подключите свою организацию к Azure с помощью ExpressRoute. Для других подключений вашей команде сетевых инженеров нужно отдельно обеспечивать эффективность подключений к Azure. 
* **Внутренние приложения.** В некоторых случаях между соединителем и внутренними приложениями установлены дополнительные прокси-серверы, которые могут замедлять или нарушать подключения. Чтобы устранить неполадки в этом случае, откройте браузер на сервере соединителя и повторите попытку получить доступ к приложению. Если соединители выполняются в Azure, а приложения расположены в локальной среде, качество работы может оказаться ниже, чем ожидают пользователи.
* **Контроллеры домена.** Если соединители выполняют единый вход (SSO) на основе ограниченного делегирования Kerberos, то сначала они обращаются к контроллерам домена, а затем отправляют запрос к серверной части. Соединители содержат кэш билетов Kerberos, но в среде с высокой нагрузкой скорость реагирования контроллеров домена может снизить производительность. Такая проблема наиболее характерна для ситуации, когда соединители выполняются в Azure, но взаимодействуют с контроллерами домена в локальной среде. 

Дополнительные сведения об оптимизации сети см. в разделе [Аспекты топологии сети при использовании прокси приложения Azure Active Directory](application-proxy-network-topology.md).

## <a name="domain-joining"></a>Присоединение к домену

Соединители могут выполняться на компьютере, не присоединенном к домену. Но если вам нужен единый вход (SSO) в приложения, использующих встроенную проверку подлинности Windows (IWA), компьютер должен быть присоединен к домену. В этом случае компьютеры соединителя должны быть присоединены к домену, который может выполнить ограниченное делегирование [Kerberos](https://web.mit.edu/kerberos) от имени пользователей для опубликованных приложений.

Соединители можно также присоединять к доменам или лесам с частичным доверием либо к контроллерам домена только для чтения.

## <a name="connector-deployments-on-hardened-environments"></a>Развертывание соединителей в средах с усиленной защитой

Развертывание соединителей обычно не вызывает сложностей и не требует дополнительной настройки. Но для некоторых редких сценариев есть определенные условия.

* Если в организации используются ограничения на исходящий трафик, [откройте необходимые порты](application-proxy-add-on-premises-application.md#prepare-your-on-premises-environment).
* На FIPS-совместимых компьютерах может потребоваться изменить конфигурацию таким образом, чтобы процессы соединителя могли создать и сохранить сертификат.
* Если в организации используется блокировка среды на основе процессов, создающих сетевые запросы, то для обеих служб соединителей нужно разрешить доступ ко всем требуемым портам и IP-адресам.
* В некоторых случаях исходящие перенаправляющие прокси-серверы могут прервать двустороннюю проверку подлинности на основе сертификата и привести к сбою связи.

## <a name="connector-authentication"></a>Проверка подлинности соединителя

Чтобы предоставить доступ к защищенной службе, соединители должны пройти проверку подлинности в службе, а служба должна пройти проверку подлинности в соединителе. Такая аутентификация выполняется с использованием сертификатов клиента и сервера, когда соединители инициируют подключение. Таким образом имя пользователя и пароль администратора не хранятся на компьютере соединителя.

Используемые сертификаты уникальны для службы прокси приложения. Они создаются во время первоначальной регистрации, а затем соединители автоматически обновляют их каждые несколько месяцев. 

Если соединитель несколько месяцев не подключается к службе, возможно, его сертификаты устарели. В этом случае следует удалить соединитель и установить его заново, чтобы запустить процесс регистрации. Вы можете выполнить следующие команды PowerShell:

```
Import-module AppProxyPSModule
Register-AppProxyConnector
```

## <a name="under-the-hood"></a>Как все устроено

Соединители основаны на прокси веб-приложения Windows Server, поэтому для них доступны почти такие же средства управления, включая журналы событий Windows

 ![Управление журналами событий с помощью средства просмотра событий](./media/application-proxy-connectors/event-view-window.png)

и счетчики производительности Windows. 

 ![Добавление счетчиков в соединитель с помощью системного монитора](./media/application-proxy-connectors/performance-monitor.png)

Для соединителей настроены журнал администратора и журнал сеансов. В журналах администратора регистрируются основные события и соответствующие ошибки. В журналах сеансов содержатся все транзакции и подробные сведения об их обработке. 

Чтобы увидеть журналы, откройте средство просмотра событий и включите в нем параметр **Отобразить аналитический и отладочный журналы** в меню **Вид**. Затем включите в журналах сбор событий. Эти журналы не отображаются в прокси-службе веб-приложения в Windows Server 2012 R2, так как соединители созданы на основе более поздней версии.

Состояние службы можно проверить в окне "Служба". Соединитель состоит из двух служб Windows: собственно соединитель и служба обновления. Они должны работать постоянно.

 ![Окно "Службы (локальные)" Azure AD](./media/application-proxy-connectors/aad-connector-services.png)

## <a name="next-steps"></a>Дальнейшие действия


* [Публикация приложений в отдельных сетях и расположениях с помощью групп соединителей](application-proxy-connector-groups.md)
* [Работа с имеющимися локальными прокси-серверами](application-proxy-configure-connectors-with-proxy-servers.md)
* [Устранение неполадок и сообщения об ошибках прокси приложения](application-proxy-troubleshoot.md)
* [Автоматическая установка соединителя прокси приложения Azure AD](application-proxy-register-connector-powershell.md)

