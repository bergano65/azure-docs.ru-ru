---
title: Безопасный гибридный доступ Azure AD с помощью F5 VPN | Документация Майкрософт
description: Руководство по интеграции единого входа Azure Active Directory с помощью F5 BIG-IP для VPN без пароля
services: active-directory
author: gargi-sinha
manager: martinco
ms.service: active-directory
ms.subservice: app-mgmt
ms.topic: how-to
ms.workload: identity
ms.date: 10/12/2020
ms.author: gasinh
ms.collection: M365-identity-device-management
ms.openlocfilehash: 2961f3f01f6ea4398fab6144b34fcb4409cdd96f
ms.sourcegitcommit: e5f9126c1b04ffe55a2e0eb04b043e2c9e895e48
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/30/2020
ms.locfileid: "96318367"
---
# <a name="tutorial-for-azure-active-directory-single-sign-on-integration-with-f5-big-ip-for-password-less-vpn"></a>Руководство по Azure Active Directory интеграции единого входа с помощью F5 BIG-IP для VPN без пароля

В этом руководстве описано, как интегрировать Bigip (SSL-VPN Azure Active Directory) на основе больших IP-адресов для безопасного гибридного доступа (SHA).

Интеграция большого SSL на основе IP VPN с Azure AD обеспечивает [множество основных преимуществ](f5-aad-integration.md), в том числе:

- Улучшенное управление безопасностью с нулевым доверием с помощью [предварительной проверки подлинности и авторизации Azure AD](https://docs.microsoft.com/azure/app-service/overview-authentication-authorization)

- [Проверка подлинности без пароля для службы VPN](https://www.microsoft.com/security/business/identity/passwordless)

- Управление удостоверениями и доступом с помощью одной плоскости управления — [портал Azure](https://portal.azure.com/#home)

Несмотря на то что эти замечательные значения добавляются, классическая VPN-подключение остается в соответствии с понятием периметра сети, где доверие находится внутри и не является доверенным снаружи. Эта модель больше не действует на достижение истинного уровня доверия, так как корпоративные ресурсы больше не ограничены стенами центра обработки данных предприятия, а не в нескольких облачных средах без фиксированных границ. По этой причине мы рекомендуем нашим клиентам перейти на более новый подход, основанный на удостоверениях, в управлении [доступом на уровне отдельных приложений](https://docs.microsoft.com/azure/active-directory/fundamentals/five-steps-to-full-application-integration-with-azure-ad).

## <a name="scenario-description"></a>Описание сценария

В этом сценарии экземпляр APM для службы SSL-VPN будет настроен в качестве поставщика службы SAML (SP), а Azure AD станет доверенным IDP SAML, предоставляя предварительную проверку подлинности. Затем единый вход из Azure AD обеспечивается с помощью проверки подлинности на основе утверждений в большом IP-адресе APM, что обеспечивает простой способ доступа к VPN.

![На рисунке показана архитектура SSL-VPN](media/f5-sso-vpn/ssl-vpn-architecture.png)

>[!NOTE]
>Все примеры строк или значений, упоминаемых в этом руководству, должны быть заменены на значения для реальной среды.

## <a name="prerequisites"></a>Предварительные требования

Более ранний опыт или знание F5 BIG-IP не требуется, однако вам потребуется:

- [Бесплатная подписка](https://azure.microsoft.com/trial/get-started-active-directory/) Azure AD или более поздняя

- Удостоверения пользователей должны [синхронизироваться из локального каталога](https://docs.microsoft.com/azure/active-directory/hybrid/how-to-connect-sync-whatis) с Azure AD.

- Учетная запись с [разрешениями](https://docs.microsoft.com/azure/active-directory/users-groups-roles/directory-assign-admin-roles#application-administrator) администратора приложения Azure AD

- Существующая инфраструктура крупных IP-адресов с маршрутизацией клиентского трафика в большой IP-адрес или [развертывание виртуального выпуска с большим IP-адресом в Azure](f5-bigip-deployment-guide.md).

- При тестировании должна существовать запись для опубликованной службы с большим IP-адресом в общедоступной службе DNS или в файле localhost тестового клиента.

- БОЛЬШОЙ IP-адрес должен быть подготовлен с помощью необходимых SSL-сертификатов для публикации служб по протоколу HTTPS.

Ознакомление с [терминологией F5 больших IP-адресов](https://www.f5.com/services/resources/glossary) также поможет понять различные компоненты, упоминаемые в этом руководстве.

>[!NOTE]
>Azure постоянно развивается, поэтому не стоит удивление, если вы нашли какие-либо особенности в этом пошаговом окне и что вы видите в портал Azure. Снимки экрана — от версия 15 больших IP-адресов, но остаются относительно похожи от v 13.1.

## <a name="add-f5-big-ip-from-the-azure-ad-gallery"></a>Добавление F5 BIG-IP из коллекции Azure AD

Настройка отношения доверия SAML Federation между большим IP-адресом позволяет Azure AD BIG-IP передать предварительную проверку подлинности и [Условный доступ](https://docs.microsoft.com/azure/active-directory/conditional-access/overview) к Azure AD, прежде чем предоставлять доступ к опубликованной службе VPN.

1. Войдите на портал Azure AD с помощью учетной записи с правами администратора приложения.

2. В левой области навигации выберите **службу Azure Active Directory**

3. Перейдите в раздел **корпоративные приложения** и на верхней ленте выберите **новое приложение**.

4. Выполните поиск по клавише F5 в коллекции и выберите **F5 BIG-IP APM интеграция Azure AD**.

5. Укажите имя приложения, а затем **добавьте или создайте** его, чтобы добавить его в клиент. Пользователь может увидеть имя в виде значка на порталах приложений Azure и Office 365. Имя должно отражать эту конкретную службу. Например, VPN.

## <a name="configure-azure-ad-sso"></a>Настройка единого входа Azure AD

1. Используя новые свойства приложения F5 в представлении, перейдите к разделу **Управление**  >  **единым входом** .

2. На странице **Выбрать метод единого входа** выберите **SAML**. Пропустить запрос на сохранение параметров единого входа, выбрав **нет, я буду сохранять его позже**.

3. В меню **Настройка единого входа с помощью SAML** выберите значок пера для **базовой конфигурации SAML** , чтобы предоставить следующие сведения.

   - Замените предварительно определенный **URL-адрес** URL-адресом для опубликованной службы с большими IP-адресами. например `https://ssl-vpn.contoso.com`

   - Сделайте то же самое с текстовым полем **URL-адрес ответа** , включая путь к КОНЕЧНОЙ точке SAML. например `https://ssl-vpn.contoso.com/saml/sp/profile/post/acs`

   - В этой конфигурации приложение будет действовать в режиме, инициированном IDP, где Azure AD выдает пользователю утверждение SAML перед перенаправлением в службу SAML с большим IP-адресом. Для приложений, которые не поддерживают режим, инициированный IDP, укажите **URL-адрес входа** для службы SAML с большим IP-адресом. Например, `https://ssl-vpn.contoso.com`.

   - Для параметра URL-адрес выхода введите конечную точку с одним выходом в службу больших IP-адресов APM (цель уровня обслуживания), предварительно заданную в заголовке узла публикуемой службы. например `https://ssl-vpn.contoso.com/saml/sp/profile/redirect/slr`

   Указание URL-адреса цели уровня обслуживания гарантирует, что сеанс пользователя завершается на обоих концах, а также в большом IP-адресе и Azure AD после выхода пользователя. БОЛЬШИЕ IP APM также предоставляют [возможность](https://support.f5.com/csp/article/K12056) завершать все сеансы при вызове определенного URL-адреса приложения.

![На рисунке показана базовая конфигурация SAML](media/f5-sso-vpn/basic-saml-configuration.png).

>[!NOTE]
>Из ТМОС V16 конечная точка цели SAML изменилась на/самл/СП/профиле/редирект/сло

4. Выберите **сохранить** перед выходом из меню конфигурации SAML и пропустите тестовый запрос SSO.

Обратите внимание на свойства раздела **User attributes & Claims** , так как Azure AD будет выдавать эти данные пользователям для проверки подлинности APM с большим IP-адресом.

![На рисунке показаны утверждения атрибутов пользователей](media/f5-sso-vpn/user-attributes-claims.png)

Вы можете добавить любые другие специальные заявки, которые может ожидать ваша опубликованная служба с большим IP-адресом, и отметить, что любые утверждения, определенные в дополнение к набору по умолчанию, будут выдаваться только в том случае, если они существуют в Azure AD, как заполненные атрибуты Таким же образом, роли каталога [или](https://docs.microsoft.com/azure/active-directory/hybrid/how-to-connect-fed-group-claims) членство в группах также требуют определения для объекта пользователя в Azure AD, прежде чем их можно будет выдать в качестве утверждения.

![На рисунке показана ссылка для скачивания метаданных федерации](media/f5-sso-vpn/saml-signing-certificate.png)

Срок существования сертификатов подписи SAML, созданных Azure AD, составляет три года, поэтому потребуется управление с помощью опубликованного руководства Azure AD.

### <a name="azure-ad-authorization"></a>Авторизация Azure AD

По умолчанию Azure AD будет выдавать маркеры только пользователям, которым был предоставлен доступ к службе.

1. По-прежнему в представлении конфигурации приложения выберите **Пользователи и группы** .

2. Выберите **+ Добавить пользователя** и в меню Добавление назначения выберите **Пользователи и группы** .

3. В диалоговом окне **Пользователи и группы** добавьте группы пользователей, которым разрешен доступ к VPN, а затем **выберите**  >  **назначить** .

![Изображение показывает добавление ссылки на пользователя ](media/f5-sso-vpn/add-user-link.png)

4. Это завершает часть Azure AD для доверия федерации SAML. Теперь можно настроить поддержку APM в большом IP-адресе, чтобы опубликовать службу SSL-VPN и настроить соответствующий набор свойств, чтобы завершить отношение доверия для предварительной проверки подлинности SAML.

## <a name="big-ip-apm-configuration"></a>Конфигурация APM для больших IP-адресов

### <a name="saml-federation"></a>Федерация SAML

В следующем разделе создается поставщик службы SAML для больших IP-адресов и соответствующие объекты SAML IDP, необходимые для завершения Федерации службы VPN с Azure AD.

1. Перейдите к разделу **доступ к**  >  **Federation**  >  локальной **службе SP поставщика службы SAML** Федерации  >  **Local SP Services** и выберите **создать** .

![На рисунке показана конфигурация SAML с большим IP-адресом](media/f5-sso-vpn/bigip-saml-configuration.png)

2. Введите **имя** и то же значение **идентификатора сущности** , которое вы определили ранее в Azure AD, и полное доменное имя узла, которое будет использоваться для подключения к приложению.

![На рисунке показано создание новой службы SAML SP Service](media/f5-sso-vpn/create-new-saml-sp.png)

   Параметры **имени** SP требуются только в том случае, если идентификатор сущности не является точным соответствием части имени узла опубликованного URL-адреса или если он не является стандартным форматом URL-адреса на основе имени узла. Укажите внешнюю схему и имя узла публикуемого приложения, если идентификатор сущности — `urn:ssl-vpn:contosoonline` .

3. Прокрутите вниз, чтобы выбрать новый **объект SAML SP** , и выберите **BIND/Unbind IDP Connectors**.

![На рисунке показано создание Федерации с локальной службой SP](media/f5-sso-vpn/federation-local-sp-service.png)

4. Выберите **создать новый соединитель IDP** и из раскрывающегося меню выберите **из метаданных** .

![На рисунке показано создание нового соединителя IDP](media/f5-sso-vpn/create-new-idp-connector.png)

5. Перейдите к XML-файлу метаданных федерации, скачанному ранее, и укажите **имя поставщика удостоверений** для объекта APM, который будет представлять внешний IDP SAML.

6. Щелкните **Добавить новую строку** , чтобы выбрать новый внешний соединитель Azure AD External IDP.

![На рисунке показан внешний соединитель IDP](media/f5-sso-vpn/external-idp-connector.png)

7. Выберите **Обновить** , чтобы привязать объект SAML SP к объекту SAML IDP, а затем нажмите кнопку **ОК**.

![На рисунке показан SAML IDP с помощью SP](media/f5-sso-vpn/saml-idp-using-sp.png)

### <a name="webtop-configuration"></a>Конфигурация Webtop

Ниже приведены действия по включению поддержки SSL-VPN для пользователей через собственный веб-портал с большим IP-адресом.

1. Перейдите в раздел **доступ к**  >  **Webtops**  >  **спискам** и выберите пункт **создать**.

2. Присвойте порталу имя и задайте для него значение **Full**. Например, `Contoso_webtop`.

3. Настройте остальные параметры и нажмите кнопку **Готово**.

![На рисунке показана конфигурация Webtop](media/f5-sso-vpn/webtop-configuration.png)

### <a name="vpn-configuration"></a>Конфигурация VPN

Возможность VPN состоит из нескольких элементов, каждый из которых управляет различными аспектами общей службы.

1. Выберите **доступ к**  >  **подключениям/**  >  Пулы аренды VPN **(VPN)**  >  **IPv4** и щелкните **создать**.

2. Укажите имя пула IP-адресов, назначаемых VPN-клиентам. Например, Contoso_vpn_pool

3. Задайте для параметра Тип значение **диапазон IP-адресов** и укажите начальный и конечный IP-адрес, а затем **добавьте** и **завершите работу**.

![На рисунке показана конфигурация VPN](media/f5-sso-vpn/vpn-configuration.png)

Список доступа к сети подготавливает службу с параметрами IP и DNS из пула VPN, разрешений на маршрутизацию пользователей, а также при необходимости запускать приложения.

1. Перейдите к разделу подключение **доступа**  >  **или VPN:** списки доступа к сети (VPN)  >  **Network Access Lists** и выберите **создать**.

2. Укажите имя для списка доступа к VPN и заголовок, например contoso-VPN, а затем — " **завершено**".

![На рисунке показана конфигурация VPN в списке доступа к сети](media/f5-sso-vpn/vpn-configuration-network-access-list.png)

3. На верхней ленте выберите **Параметры сети** и добавьте указанные ниже параметры.

   • **Поддерживаемая версия IP-адреса**: IPv4

   • **Пул аренды IPv4**: выберите созданный ранее пул VPN, например Contoso_vpn_pool

![На рисунке показан пул VPN contoso](media/f5-sso-vpn/contoso-vpn-pool.png)

   Параметры клиента можно использовать для принудительного применения ограничений на маршрутизацию трафика клиента при установке VPN.

4. Нажмите кнопку **Готово** и перейдите на вкладку DNS/узлы, чтобы добавить параметры.

   • **Основной сервер имен IPv4**: IP-адрес DNS-сервера окружения

   • **DNS-суффикс домена по умолчанию**: суффикс домена для этого конкретного VPN-подключения. Например, contoso.com

![Изображение показывает суффикс домена по умолчанию](media/f5-sso-vpn/domain-suffix.png)

В [статье F5](https://techdocs.f5.com/kb/en-us/products/big-ip_apm/manuals/product/apm-network-access-11-5-0/2.html) приведены сведения о настройке остальных параметров в соответствии с вашими предпочтениями.

Профиль подключения с большим IP-адресом теперь требуется для настройки параметров для каждого типа VPN-клиента, который должна поддерживать служба VPN. Например, Windows, OSX и Android.

1. Перейдите в раздел **доступ к**  >  профилям подключения и подключения **VPN**  >  **Connectivity**  >  **Profiles** и нажмите кнопку **Добавить**.

2. Укажите имя профиля и задайте для родительского профиля значение **/Коммон/Коннективити**, например Contoso_VPN_Profile.

![На рисунке показано создание нового профиля подключения](media/f5-sso-vpn/create-connectivity-profile.png)

В [документации](https://techdocs.f5.com/kb/en-us/bigip-edge-apps.html) bigip содержатся дополнительные сведения о поддержке клиентов.

## <a name="access-profile-configuration"></a>Конфигурация профиля доступа

После настройки VPN-объектов требуется политика доступа, чтобы включить службу для проверки подлинности SAML.

1. Последовательно выберите **Access**  >  **профили доступа/политики**  >  **профили доступа (политики для каждого сеанса)** и нажмите кнопку **создать** .

2. Укажите имя профиля и для типа профиля выберите **все**, например Contoso_network_access

3. Прокрутите вниз, чтобы добавить хотя бы один язык в список **принятых языков** , и нажмите кнопку **Готово** .

![Изображение показывает общие свойства](media/f5-sso-vpn/general-properties.png)

4. Выберите **изменить** в поле Per-Session политика нового профиля доступа, чтобы редактор визуальных политик запускался на отдельной вкладке браузера.

![На рисунке показана политика для каждого сеанса](media/f5-sso-vpn/per-session-policy.png)

5. Выберите **+** знак и во всплывающем окне выберите **Проверка подлинности SAML аутентификация**  >  **SAML Auth**  >  **Добавить элемент**.

6. В конфигурации SP проверки подлинности SAML выберите созданный ранее объект VPN SAML SP, а затем **Сохраните**.

![На рисунке показана проверка подлинности SAML](media/f5-sso-vpn/saml-authentication.png)

7. Выберите **+** для успешной ветви проверки подлинности SAML.

8. На вкладке Назначение выберите пункт **дополнительно назначить ресурс** , а затем — **Добавить элемент** .

![На изображении показано предварительное назначение ресурса](media/f5-sso-vpn/advance-resource-assign.png)

9. Во всплывающем окне выберите **создать запись** , а затем — **Добавить или удалить**.

10. В дочернем окне выберите **доступ к сети** и выберите профиль доступа к сети, созданный ранее.

![На рисунке показано добавление новой записи сетевого доступа](media/f5-sso-vpn/add-new-entry.png)

11. Перейдите на вкладку **Webtop** и добавьте созданный ранее объект Webtop.

![На рисунке показано добавление объекта Webtop](media/f5-sso-vpn/add-webtop-object.png)

12. Выберите **Обновление** , а затем **Сохраните**.

13. Щелкните ссылку в верхнем поле запрета, чтобы изменить ветвь успешно, чтобы **Разрешить** **Сохранение**.

![На рисунке показан новый редактор визуальных политик](media/f5-sso-vpn/vizual-policy-editor.png)

14. Зафиксируйте эти параметры, выбрав **Применить политику доступа** и закройте вкладку Редактор визуальных политик.

![На рисунке показан новый диспетчер политики доступа](media/f5-sso-vpn/access-policy-manager.png)

## <a name="publish-the-vpn-service"></a>Публикация службы VPN

Теперь, когда все параметры настроены, APM требует, чтобы интерфейсный виртуальный сервер прослушивает клиенты, подключающиеся к VPN.

1. Выберите **локальный трафик**  >  **виртуальные серверы**  >  **список виртуальных** серверов и щелкните **создать**.

2. Укажите **имя** виртуального VPN-сервера, например **VPN_Listener**.

3. Укажите виртуальный сервер с неиспользуемым **IP-адресом назначения** , который имеет маршрутизацию для получения трафика клиента.

4. Задайте для порта службы значение **443 HTTPS** и убедитесь, что отображается состояние **включено** .

![На рисунке показан новый виртуальный сервер](media/f5-sso-vpn/new-virtual-server.png)

5. Задайте для **профиля HTTP** значение HTTP и добавьте профиль SSL (клиент) для общедоступного SSL-сертификата, подготовленного в рамках предварительных требований.

![На рисунке показан профиль SSL](media/f5-sso-vpn/ssl-profile.png)

6. В разделе Политика доступа задайте **профиль доступа** и **профиль подключения** , чтобы использовать созданные VPN-объекты.

![На рисунке показана политика доступа](media/f5-sso-vpn/access-policy.png)

7. По завершении нажмите кнопку **Готово** .

8.  Теперь служба SSL-VPN опубликована и доступна через SHA, напрямую через ее URL-адрес или через порталы приложений Майкрософт.

## <a name="additional-resources"></a>Дополнительные ресурсы

- [Конец паролей, не используйте пароль](https://www.microsoft.com/security/business/identity/passwordless)

- [Что представляет собой условный доступ?](https://docs.microsoft.com/azure/active-directory/conditional-access/overview)

- [Инфраструктура нулевого доверия Майкрософт для включения удаленной работы](https://www.microsoft.com/security/blog/2020/04/02/announcing-microsoft-zero-trust-assessment-tool/)

- [Пять шагов по полной интеграции приложений с Azure AD](https://docs.microsoft.com/azure/active-directory/fundamentals/five-steps-to-full-application-integration-with-azure-ad)

## <a name="next-steps"></a>Дальнейшие действия

Откройте браузер на удаленном клиенте Windows и перейдите по URL-адресу **службы VPN с большим IP**-адресом. После проверки подлинности в Azure AD вы увидите портал "большой IP-адрес" и средство запуска VPN.

![На рисунке показано средство запуска VPN](media/f5-sso-vpn/vpn-launcher.png)

При выборе плитки VPN будет установлен клиент BIG-IP пограничных клиентов и установлено VPN-подключение, настроенное для SHA.
Приложение F5 VPN также должно отображаться в качестве целевого ресурса в условном доступе Azure AD. См. [рекомендации](https://docs.microsoft.com/azure/active-directory/conditional-access/concept-conditional-access-policies) по созданию политик условного доступа, а также пользователям для [проверки подлинности без пароля](https://www.microsoft.com/security/business/identity/passwordless)Azure AD.