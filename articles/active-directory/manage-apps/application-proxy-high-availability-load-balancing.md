---
title: Высокий уровень доступности и балансировка нагрузки для Azure AD Application Proxy | Документация Майкрософт
description: Как распределение трафика работает с развертыванием прокси приложения. Содержит советы по оптимизации производительности соединителя и использованию балансировки нагрузки для внутренних серверов.
services: active-directory
documentationcenter: ''
author: msmimart
manager: CelesteDG
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 07/24/2019
ms.author: mimart
ms.reviewer: japere
ms.custom: it-pro
ms.collection: M365-identity-device-management
ms.openlocfilehash: ff5f814eac095770990ecbc0c4b01d2e0cc6f931
ms.sourcegitcommit: fecb6bae3f29633c222f0b2680475f8f7d7a8885
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/30/2019
ms.locfileid: "68667203"
---
# <a name="high-availability-and-load-balancing-of-your-application-proxy-connectors-and-applications"></a>Высокий уровень доступности и балансировка нагрузки соединителей прокси приложения и приложений

В этой статье объясняется, как работает распределение трафика при развертывании прокси приложения. Мы обсудим следующее:

- Распределение трафика между пользователями и соединителями, а также советы по оптимизации производительности соединителя

- Как проходит трафик между соединителями и серверами серверных приложений с рекомендациями по балансировке нагрузки между несколькими внутренними серверами.

## <a name="traffic-distribution-across-connectors"></a>Распределение трафика между соединителями

Соединители устанавливают подключения на основе принципов обеспечения высокого уровня доступности. Нет никакой гарантии, что трафик всегда будет равномерно распределяться по соединителям, а сходство сеансов отсутствует. Однако использование может варьироваться, и запросы в экземпляры службы прокси приложения будут отправляться случайным образом. В результате трафик, как правило, распределяется почти равномерно по соединителям. На схеме и шагах ниже показано, как устанавливаются соединения между пользователями и соединителями.

![Схема, показывающая подключения между пользователями и соединителями](media/application-proxy-high-availability-load-balancing/application-proxy-connections.png)

1. Пользователь клиентского устройства пытается получить доступ к локальному приложению, опубликованному через прокси приложения.
2. Запрос проходит через Azure Load Balancer, чтобы определить, какой экземпляр службы прокси приложения должен принимать запрос. Для каждого региона доступно десятки экземпляров, которые могут принять запрос. Этот метод позволяет равномерно распределить трафик между экземплярами службы.
3. Запрос отправляется в [служебную шину](https://docs.microsoft.com/azure/service-bus-messaging/).
4. Служебная шина проверяет, использовалось ли ранее подключение к существующему соединителю в группе соединителей. Если да, используется соединение. Если соединитель еще не связан с подключением, он выбирает доступный соединитель в случайном порядке для передачи сигнала. Затем соединитель выбирает запрос из служебной шины.

   - На шаге 2 запросы отправляются в разные экземпляры службы прокси приложения, поэтому подключение с разными соединителями скорее всего будет создано. В результате соединители почти равномерно используются в группе.

   - Соединение переустанавливается только в том случае, если соединение разорвано или происходит период простоя в 10 минут. Например, подключение может быть разорвано при перезапуске компьютера или службы соединителя или разрыве сети.

5. Соединитель передает запрос серверу серверной части приложения. Затем приложение отправляет ответ обратно в соединитель.
6. Соединитель завершает ответ, открывая исходящее соединение с экземпляром службы, из которого пришел запрос. Затем это соединение немедленно закрывается. По умолчанию каждый соединитель имеет ограничение в 200 одновременных исходящих подключений.
7. Затем ответ передается обратно клиенту из экземпляра службы.
8. Последующие запросы одного и того же подключения повторяют описанные выше действия, пока это подключение не будет разорвано или не будет бездействующим в течение 10 минут.

Приложение часто имеет много ресурсов и открывает несколько подключений при загрузке. Каждое подключение проходит через описанные выше шаги, чтобы стать выделенным экземпляру службы, и выберите новый доступный соединитель, если соединение еще не было парно с соединителем.


## <a name="best-practices-for-high-availability-of-connectors"></a>Рекомендации по обеспечению высокой доступности соединителей

- Из-за того, что трафик распределяется между соединителями для обеспечения высокой доступности, важно всегда иметь по крайней мере два соединителя в группе соединителей. Три соединителя являются предпочтительными для предоставления дополнительных буферов между соединителями. Чтобы определить необходимое количество соединителей, следуйте инструкциям по планированию ресурсов.

- Размещайте соединители на различных исходящих подключениях, чтобы избежать единой точки отказа. Если соединители используют одно и то же исходящее подключение, то сетевая проблема с подключением может повлиять на все соединители, использующие его.

- Избегайте принудительного перезапуска соединителей при подключении к рабочим приложениям. Это может негативно сказаться на распределении трафика между соединителями. Перезапуск соединителей приводит к недоступности дополнительных соединителей и принудительному подключению к остальному доступному соединителю. В результате в этом случае соединители не используются изначально.

- Избегайте всех форм встроенной проверки исходящих соединений TLS между соединителями и Azure. Этот тип встроенной проверки приводит к ухудшению потока связи.

- Следите за тем, чтобы автоматические обновления для соединителей были установлены. Если служба Средство обновления соединителей прокси приложения запущена, соединители обновляются автоматически и получают последние обновления. Если на сервере не отображается служба Средство обновления соединителей, необходимо переустановить соединитель для получения обновлений.

## <a name="traffic-flow-between-connectors-and-back-end-application-servers"></a>Поток трафика между соединителями и серверами серверных приложений

Другой ключевой областью, где высокий уровень доступности, является подключение между соединителями и внутренними серверами. При публикации приложения с помощью AD Application Proxy Azure трафик от пользователей к приложениям проходит через три прыжка:

1. Пользователь подключается к общедоступной конечной точке службы AD Application Proxy Azure в Azure. Соединение устанавливается между исходным IP-адресом клиента (общедоступным) и IP-адресом конечной точки прокси приложения.
2. Соединитель прокси приложения извлекает HTTP-запрос клиента из службы прокси приложения.
3. Соединитель прокси приложения подключается к целевому приложению. Соединитель использует собственный IP-адрес для установления соединения.

![Схема подключения пользователя к приложению через прокси приложения](media/application-proxy-high-availability-load-balancing/application-proxy-three-hops.png)

### <a name="x-forwarded-for-header-field-considerations"></a>X-Forwardd — для рекомендаций по полям заголовка
В некоторых ситуациях (например, аудит, балансировка нагрузки и т. д.) совместное использование исходного IP-адреса внешнего клиента с локальной средой является обязательным требованием. Чтобы устранить это требование, соединитель Azure AD Application Proxy добавляет поле заголовка X-Forwarded-For с исходным IP-адресом клиента (открытый) в HTTP-запрос. Затем соответствующее сетевое устройство (балансировщик нагрузки, брандмауэр) или веб-сервер или внутреннее приложение могут читать и использовать эти сведения.

## <a name="best-practices-for-load-balancing-among-multiple-app-servers"></a>Рекомендации по балансировке нагрузки между несколькими серверами приложений
Если группа соединителей, назначенная для приложения прокси приложения, имеет два или больше соединителей и серверное веб-приложение выполняется на нескольких серверах (ферма серверов), требуется хорошая стратегия балансировки нагрузки. Хорошая стратегия гарантирует, что серверы получают клиентские запросы равномерно и не потребует чрезмерного или чрезмерного использования серверов в ферме серверов.
### <a name="scenario-1-back-end-application-does-not-require-session-persistence"></a>Сценарий 1. Для серверного приложения не требуется сохранение сеанса
Самый простой сценарий заключается в том, что серверное веб-приложение не требует прикрепления сеанса (сохраняемости сеанса). Любой запрос от пользователя может обрабатываться любым экземпляром серверной части в ферме серверов. Вы можете использовать балансировщик нагрузки уровня 4 и настроить его без сходства. К некоторым вариантам относятся балансировка сетевой нагрузки Майкрософт, Azure Load Balancer или балансировщик нагрузки от другого поставщика. Кроме того, можно настроить службу DNS с циклическим перебором.
### <a name="scenario-2-back-end-application-requires-session-persistence"></a>Сценарий 2. Для серверного приложения требуется сохранение сеанса
В этом сценарии серверное веб-приложение требует прикрепления сеанса (сохраняемости сеанса) во время сеанса, прошедшего проверку подлинности. Все запросы от пользователя должны обрабатываться экземпляром серверного приложения, который выполняется на том же сервере в ферме серверов.
Этот сценарий может быть более сложным, так как клиент обычно устанавливает несколько подключений к службе прокси приложения. Запросы к разным подключениям могут поступать на разные соединители и серверы в ферме. Так как каждый соединитель использует собственный IP-адрес для этого взаимодействия, балансировщик нагрузки не может гарантировать прикрепление сеанса на основе IP-адреса соединителей. Сходство исходного IP-адреса использовать нельзя.
Ниже приведены некоторые варианты сценария 2.

- Вариант 1. Создать сохраняемость сеанса для файла cookie сеанса, заданного подсистемой балансировки нагрузки. Этот параметр рекомендуется использовать, так как он позволяет более равномерно распределить нагрузку между внутренними серверами. Для этого требуется балансировщик нагрузки уровня 7 с этой возможностью, который может обработать HTTP-трафик и завершать подключение SSL. Вы можете использовать шлюз приложений Azure (сходство сеансов) или подсистему балансировки нагрузки другого поставщика.

- Вариант 2. Применяйте сохраняемость сеанса в поле заголовка X-Forwardd-for. Для этого параметра требуется балансировщик нагрузки уровня 7 с этой возможностью, который может обработать HTTP-трафик и завершать подключение SSL.  

- Вариант 3. Настройте серверное приложение так, чтобы оно не затребовало сохранения сеанса.

Сведения о требованиях к балансировке нагрузки серверного приложения см. в документации поставщика программного обеспечения.

## <a name="next-steps"></a>Следующие шаги

- [Включение прокси приложения](application-proxy-add-on-premises-application.md)
- [Включение единого входа](application-proxy-configure-single-sign-on-with-kcd.md)
- [Включить условный доступ](application-proxy-integrate-with-sharepoint-server.md)
- [Устранение неполадок с прокси приложения](application-proxy-troubleshoot.md)
