---
title: Настройка удаленного доступа к SharePoint с помощью прокси приложения Azure AD | Документы Майкрософт
description: Рассматриваются основные сведения об интеграции локального сервера SharePoint с прокси приложения Azure AD.
services: active-directory
documentationcenter: ''
author: barbkess
manager: mtillman
ms.service: active-directory
ms.component: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 12/10/2018
ms.author: barbkess
ms.reviewer: japere
ms.custom: it-pro
ms.openlocfilehash: 9b8ae85d1a5410677dd9299ebb947c2189a6b663
ms.sourcegitcommit: efcd039e5e3de3149c9de7296c57566e0f88b106
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2018
ms.locfileid: "53166189"
---
# <a name="enable-remote-access-to-sharepoint-with-azure-ad-application-proxy"></a>Настройка удаленного доступа к SharePoint с помощью прокси приложения Azure AD

В этой статье описывается интеграция локального сервера SharePoint с прокси приложения Azure Active Directory (Azure AD).

Чтобы включить удаленный доступ к SharePoint с помощью прокси приложения Azure AD, следуйте пошаговым инструкциям в разделах этой статьи.

## <a name="prerequisites"></a>Предварительные требования

В этой статье предполагается, что в вашей среде уже есть SharePoint 2013 или более поздней версии. Кроме того, необходимо выполнить следующие предварительные требования.

* SharePoint имеет встроенную поддержку Kerberos. Поэтому можно предположить, что пользователи, которые получают удаленный доступ к внутренним сайтам через прокси приложения Azure AD, пользуются преимуществами единого входа.

* В этом сценарии предусмотрено внесение некоторых изменений в конфигурацию на сервере SharePoint. Мы рекомендуем использовать промежуточную среду. Так вы сначала внесете изменения на промежуточном сервере, что упростит цикл тестирования при переходе на рабочую среду.

* Нам требуется SSL для опубликованного URL-адреса. Протокол SSL необходим также для внутреннего URL-адреса, чтобы правильно отправлять и сопоставлять ссылки.

## <a name="step-1-configure-kerberos-constrained-delegation-kcd"></a>Шаг 1. Настройка ограниченного делегирования Kerberos

Для локальных приложений, использующих проверку подлинности Windows, единый вход можно обеспечить с помощью протокола проверки подлинности Kerberos и функции, называемой ограниченным делегированием Kerberos (KCD). Если функция KCD настроена, она дает возможность соединителю прокси приложения получить билет и маркер Windows для пользователя, даже если тот не выполнил вход в Windows напрямую. Дополнительные сведения об ограниченном делегировании Kerberos см. в [этой статье](https://technet.microsoft.com/library/jj553400.aspx).

Чтобы настроить KCD для сервера, выполните процедуры, описанные в следующих разделах.

### <a name="ensure-that-sharepoint-web-application-is-running-under-a-domain-account"></a>Проверка того, что веб-приложение SharePoint работает под учетной записью домена

Сначала проверьте, что веб-приложение SharePoint запущено под учетной записью домена, но не учетной записью локальной системы, локальной службы или сетевой службы. Это нужно сделать, чтобы вы могли присоединить имена субъектов-служб к этой учетной записи. Kerberos идентифицирует различные службы по этим именам. Учетная запись потребуется позже, чтобы настроить ограниченное делегирование Kerberos.

> [!NOTE]
Вам потребуется ранее созданная учетная запись AD для службы. Мы рекомендуем настроить автоматическую смену паролей. Описание полной процедуры и сведения по устранению неполадок см. в статье [о настройке автоматической смены паролей в SharePoint](https://technet.microsoft.com/library/ff724280.aspx).

Чтобы убедиться, что сайты запущены с использованием определенной учетной записи службы, сделайте следующее.

1. Откройте страницу **центра администрирования SharePoint**.
2. Щелкните **Безопасность** и выберите **Настройка учетных записей служб**.
3. Выберите **Пул веб-приложений — SharePoint — 80**. Параметры могут немного отличаться в зависимости от имени пула веб-приложений или при использовании SSL по умолчанию.

  ![Параметры для настройки учетной записи службы](./media/application-proxy-integrate-with-sharepoint-server/service-web-application.png)

4. Если в поле **Выберите учетную запись для этого компонента** выбран вариант **Локальная служба** или **Сетевая служба**, необходимо создать учетную запись. В противном случае все готово, и вы можете переходить к следующему шагу.
5. Выберите **Регистрация новой управляемой учетной записи**. Как только учетная запись будет создана, прежде чем ее использовать, необходимо задать **пул веб-приложений**.

### <a name="set-a-service-principal-name-for-the-sharepoint-service-account"></a>Задание имени субъекта-службы для учетной записи службы SharePoint

Прежде чем настраивать ограниченное делегирование Kerberos, выполните следующее.

* Укажите учетную запись домена, под которой работает веб-приложение SharePoint, предоставляемое прокси-сервером Azure AD.
* Выберите внутренний URL-адрес, который будет настроен в SharePoint и на прокси-сервере AAD. Этот внутренний URL-адрес не должен использоваться в веб-приложении в других целях, и он никогда не будет отображаться в веб-браузере.

Если вы выберете внутренний URL-адрес <https://sharepoint>, то имя участника-службы будет выглядеть так:

```
HTTP/SharePoint
```

> [!NOTE]
> Соблюдайте следующие рекомендации при настройке внутреннего URL-адреса:
> * Используйте протокол HTTPS.
> * Не используйте пользовательские порты.
> * В DNS создайте запись A (узел), которая будет указывать на интерфейсный веб-сервер SharePoint или подсистему балансировки нагрузки. Не используйте запись CNAME (псевдоним).

Чтобы зарегистрировать имя субъекта-службы, выполните указанную ниже команду из командной строки с правами администратора домена.

```
setspn -S HTTP/SharePoint demo\spAppPoolAccount
```

Эта команда задает имя участника-службы _HTTP/SharePoint_ для учетной записи пула приложений SharePoint _demo\spAppPoolAccount_.

Замените _HTTP/SharePoint_ именем участника-службы для внутреннего URL-адреса, а _demo\spAppPoolAccount_ — учетной записью пула приложений в вашей среде. Команда setspn выполняет поиск имени субъекта-службы, прежде чем его добавить. Если он уже существует, вы увидите ошибку **Повторяющееся значение имени участника-службы**. В этом случае мы рекомендуем удалить существующее имя субъекта-службы, если оно настроено с неправильной учетной записью пула приложений.

Чтобы проверить добавление имени субъекта-службы, выполните команду Setspn с параметром -L. Дополнительные сведения о команде setspn см. в [этой статье](https://technet.microsoft.com/library/cc731241.aspx).

### <a name="ensure-that-the-connector-is-trusted-for-delegation-to-the-spn-added-to-the-sharepoint-application-pool-account"></a>Убедитесь, что соединитель является доверенным для делегирования на имя субъекта-службы, добавленное в учетную запись пула приложений SharePoint.

Настройте ограниченное делегирование Kerberos, чтобы служба прокси приложения Azure AD могла делегировать удостоверения пользователей для учетной записи пула приложений SharePoint. Для этого настройте для соединителя прокси приложения возможность получать билеты Kerberos для пользователей, которые прошли проверку подлинности в Azure AD. Затем этот сервер передает контекст в целевое приложение (SharePoint в нашем случае).

Чтобы настроить ограниченное делегирование Kerberos, выполните приведенные далее действия для каждого компьютера соединителя.

1. Войдите в контроллер домена от имени администратора домена, а затем перейдите к компоненту **Пользователи и компьютеры Active Directory**.
2. Найдите компьютер, на котором запущен соединитель. В этом примере это тот же сервер SharePoint.
3. Дважды щелкните имя компьютера, а затем перейдите на вкладку **Делегирование**.
4. Установите переключатель **Trust this computer for delegation to the specified services only** (Доверять этому компьютеру для делегирования только указанным службам), а затем — **Use any authentication protocol** (Использовать любой протокол проверки подлинности).
5. Нажмите кнопку **Добавить**, выберите элемент **Пользователи или компьютеры** и найдите учетную запись пула приложений SharePoint, например _demo\spAppPoolAccount_.
6. В списке имен участников-служб выберите того, который вы создали ранее для учетной записи службы.
7. Последовательно выберите **ОК**. Нажмите кнопку **ОК** еще раз, чтобы сохранить изменения.
  
  ![Параметры делегирования](./media/application-proxy-integrate-with-sharepoint-server/delegation-box2.png)

## <a name="step-2-configure-azure-ad-proxy"></a>Шаг 2. Настройка прокси AAD

Итак, вы настроили ограниченное делегирование Kerberos, и теперь готовы настроить Azure Active Directory Application Proxy.

1. Опубликуйте сайт SharePoint со следующими параметрами. Пошаговые инструкции см. в статье [Публикация приложений с помощью прокси приложения Azure AD](application-proxy-publish-azure-portal.md).
   * **Внутренний URL-адрес**. Внутренний URL-адрес SharePoint, который был выбран ранее, например **<https://SharePoint/>**.
   * **Метод предварительной проверки подлинности**. Azure Active Directory
   * **Перевод веб-страниц в заголовках**. НЕТ

   >[!TIP]
   >SharePoint использует значение _заголовка узла_ для поиска сайта. Он также создает ссылки на его основе. Таким образом, любая ссылка, созданная в SharePoint, представляет собой опубликованный URL-адрес, правильно настроенный для использования внешнего URL-адреса. Если выбрать значение **Да**, соединитель будет перенаправлять запрос к серверному приложению. Но если выбрать значение **Нет**, соединитель не будет отправлять имя внутреннего узла. Вместо этого он отправляет заголовок узла в качестве опубликованного URL-адреса в серверное приложение.

   ![Публикация SharePoint в качестве приложения](./media/application-proxy-integrate-with-sharepoint-server/publish-app.png)

2. После публикации приложения необходимо настроить параметры единого входа с помощью следующих действий:

   1. На странице приложения на портале выберите **Единый вход**.
   2. Для единого входа выберите режим **Встроенная проверка подлинности Windows**.
   3. Задайте для параметра "Внутреннее имя субъекта-службы приложения" значение, заданное ранее. В нашем примере это будет значение **HTTP/SharePoint**.
   4. В поле "Делегированное удостоверение для входа" выберите **Имя локальной учетной записи управления лицензиями (SAM)**.

   ![Настройка встроенной проверки подлинности Windows для единого входа](./media/application-proxy-integrate-with-sharepoint-server/configure-iwa.png)

3. Чтобы завершить настройку приложения, перейдите к разделу **Пользователи и группы** и назначьте доступ к этому приложению необходимым пользователям. 

## <a name="step-3-configure-sharepoint-to-use-kerberos-and-azure-ad-proxy-urls"></a>Шаг 3. Настройка SharePoint для использования Kerberos и URL-адресов прокси-сервера AAD

На следующем шаге мы распространим веб-приложение SharePoint в новую зону, в которой настроен Kerberos и соответствующее альтернативное сопоставление доступа, что позволит SharePoint обрабатывать входящие запросы на внутренний URL-адрес и отправлять в ответ ссылки, основанные на внешнем URL-адресе.

1. Запустите **консоль управления SharePoint**.
2. Выполните следующий скрипт, чтобы распространить веб-приложение на зону экстрасети и включить проверку подлинности Kerberos:

  ```powershell
  # Replace "http://spsites/" with the URL of your web application
  # Replace "https://sharepoint-f128.msappproxy.net/" with the External URL in your Azure AD proxy application
  $winAp = New-SPAuthenticationProvider -UseWindowsIntegratedAuthentication -DisableKerberos:$false
  Get-SPWebApplication "http://spsites/" | New-SPWebApplicationExtension -Name "SharePoint - AAD Proxy" -SecureSocketsLayer -Zone "Extranet" -Url "https://sharepoint-f128.msappproxy.net/" -AuthenticationProvider $winAp
  ```

3. Откройте страницу **центра администрирования SharePoint**.
4. В разделе **Параметры системы** выберите **Настройка сопоставлений альтернативного доступа**. Откроется окно "Сопоставления для альтернативного доступа".
5. Выберите сайт, например **SharePoint — 80**. Пока для зоны экстрасети не настроен правильный внутренний URL-адрес:

  ![Окно "Сопоставления для альтернативного доступа"](./media/application-proxy-integrate-with-sharepoint-server/alternate-access1.png)

6. Щелкните **Добавить внутренние URL-адреса**.
7. В текстовом поле **URL protocol, host and port** (Протокол, узел и порт для URL-адреса) введите **Внутренний URL-адрес**, который настроен на прокси-сервере AAD, например <https://SharePoint/>.
8. Выберите зону **Экстрасеть** в раскрывающемся списке.
9. Выберите команду **Сохранить**.
10. Сопоставления для альтернативного доступа теперь будут выглядеть так:

  ![Правильные сопоставления для альтернативного доступа](./media/application-proxy-integrate-with-sharepoint-server/alternate-access3.png)

## <a name="step-4-ensure-that-an-https-certificate-is-configured-for-the-iis-site-of-the-extranet-zone"></a>Шаг 4. Проверка того, что сертификат HTTPS настроен для использования сайта IIS в зоне экстрасети

Итак, настройку SharePoint можно считать завершенной, но внутренний URL-адрес для зоны экстрасети имеет значение <https://SharePoint/>, и для него нужно задать сертификат.

1. Откройте консоль Windows PowerShell
2. Выполните следующий скрипт, чтобы создать самозаверяющий сертификат, и добавьте его в My store на компьютере.

  ```powershell
  # Replace "SharePoint" with the actual hostname of the Internal URL of your Azure AD proxy application
  New-SelfSignedCertificate -DnsName "SharePoint" -CertStoreLocation "cert:\LocalMachine\My"
  ```

  > [!NOTE]
  Самозаверяющие сертификаты допустимо использовать только для целей тестирования. В рабочей среде мы настоятельно рекомендуем использовать только сертификаты, выданные центром сертификации.

3. Откройте консоль службы IIS.
4. Разверните сервер в представлении дерева, разверните "Сайты", выберите узел "SharePoint – AAD Proxy" и щелкните **Привязки**.
5. Выберите привязку https и щелкните **Изменить...**.
6. В поле сертификата SSL выберите сертификат **SharePoint** и щелкните ОК.

Теперь вы можете получать внешний доступ к сайту SharePoint через прокси приложения Azure AD.

## <a name="next-steps"></a>Дополнительная информация

* [Работа с пользовательскими доменами в прокси приложения Azure AD](application-proxy-configure-custom-domain.md)
* [Сведения о соединителях прокси приложения Azure AD](application-proxy-connectors.md)
