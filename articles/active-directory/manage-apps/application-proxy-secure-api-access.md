---
title: Доступ к локальным API с помощью Azure AD Application Proxy
description: Прокси приложения Azure Active Directory позволяет собственным приложениям безопасно обращаться к API и бизнес-логике, размещенным локально или на облачных виртуальных машинах.
services: active-directory
author: jeevanbisht
manager: mtillman
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.topic: conceptual
ms.date: 10/24/2019
ms.author: celested
ms.reviewer: japere
ms.openlocfilehash: b741f42bb215df59903fed7ed84094b7d037ce65
ms.sourcegitcommit: f7f70c9bd6c2253860e346245d6e2d8a85e8a91b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2019
ms.locfileid: "73063036"
---
# <a name="secure-access-to-on-premises-apis-with-azure-ad-application-proxy"></a>Безопасный доступ к локальным API с помощью Azure AD Application Proxy

У вас могут быть интерфейсы API бизнес-логики, работающие в локальной среде или размещенные на виртуальных машинах в облаке. Собственные приложения Android, iOS, Mac или Windows должны взаимодействовать с конечными точками API, чтобы использовать данные или обеспечивать взаимодействие с пользователем. AD Application Proxy Azure и [библиотеки проверки Подлинности Azure Active Directory (ADAL)](/azure/active-directory/develop/active-directory-authentication-libraries) позволяют собственным приложениям безопасно получать доступ к локальным API. Azure Active Directory Application Proxy — это более быстрое и безопасное решение, чем открытие портов брандмауэра и управление проверкой подлинности и авторизацией на уровне приложения. 

В этой статье описывается настройка решения Azure AD Application Proxy для размещения службы веб-API, к которой могут обращаться собственные приложения. 

## <a name="overview"></a>Краткое описание

На следующей схеме показан традиционный способ публикации локальных интерфейсов API. Этот подход требует открытия входящих портов 80 и 443.

![Традиционный доступ к API](./media/application-proxy-secure-api-access/overview-publish-api-open-ports.png)

На следующей схеме показано, как можно использовать AD Application Proxy Azure для безопасной публикации API-интерфейсов без открытия входящих портов.

![Доступ к Azure AD Application Proxy API](./media/application-proxy-secure-api-access/overview-publish-api-app-proxy.png)

AD Application Proxy Azure формирует основу решения, работает как общедоступную конечную точку для доступа через API и обеспечивает проверку подлинности и авторизацию. Доступ к API можно получить из огромного массива платформ с помощью библиотек [ADAL](/azure/active-directory/develop/active-directory-authentication-libraries) . 

Так как проверка подлинности и авторизация Azure AD Application Proxy созданы на основе Azure AD, вы можете использовать условный доступ Azure AD, чтобы предоставить доступ к API, опубликованным через прокси приложения, только доверенным устройствам. Используйте присоединение к Azure AD или гибридное подключение Azure AD для настольных компьютеров и Intune, управляемых для устройств. Вы также можете воспользоваться преимуществами Azure Active Directory Premium функций, таких как многофакторная идентификация Azure, и защитой с помощью машинного обучения [защиты идентификации Azure](/azure/active-directory/active-directory-identityprotection).

## <a name="prerequisites"></a>Технические условия

Для выполнения этого пошагового руководства необходимо следующее:

- Административный доступ к каталогу Azure с учетной записью, которая может создавать и регистрировать приложения
- Пример веб-API и собственных клиентских приложений из [https://github.com/jeevanbisht/API-NativeApp-ADAL-SampleApp](https://github.com/jeevanbisht/API-NativeApp-ADAL-SampleApp) 

## <a name="publish-the-api-through-application-proxy"></a>Публикация API через прокси приложения

Чтобы опубликовать API за пределами интрасети через прокси приложения, следуйте той же схеме, что и для публикации веб-приложений. Дополнительные сведения см. [в разделе Учебник. Добавление локального приложения для удаленного доступа через прокси приложения в Azure Active Directory](application-proxy-add-on-premises-application.md).

Чтобы опубликовать веб-API Секретапи через прокси приложения, выполните следующие действия.

1. Создайте и опубликуйте пример проекта Секретапи как веб-приложение ASP.NET на локальном компьютере или в интрасети. Убедитесь, что веб-приложение можно использовать локально. 
   
1. В [портал Azure](https://portal.azure.com)выберите **Azure Active Directory** в левой области навигации. Затем на странице **Обзор** выберите **корпоративные приложения**.
   
1. В верхней части страницы **корпоративные приложения — все приложения** выберите пункт **новое приложение**.
   
1. На странице " **Обзор коллекции Azure AD** " в разделе " **локальные приложения**" выберите **Добавить локальное приложение**. Откроется страница **Добавить собственное локальное приложение** .
   
1. Если соединитель прокси приложения не установлен, вам будет предложено установить его. Выберите **скачать соединитель прокси приложения** , чтобы скачать и установить соединитель. 
   
1. После установки соединителя прокси приложения на странице **Добавление локального приложения** выполните следующие действия.
   
   1. Введите *секретапи* рядом с **именем**.
      
   1. Введите URL-адрес, используемый для доступа к API из интрасети рядом с **внутренним URL-адресом**. 
      
   1. Убедитесь, что **Предварительная проверка подлинности** имеет значение **Azure Active Directory**. 
      
   1. Выберите **Добавить** в верхней части страницы и дождитесь создания приложения.
   
   ![Добавить приложение API](./media/application-proxy-secure-api-access/3-add-api-app.png)
   
1. На странице **корпоративные приложения — все приложения** выберите приложение **секретапи** . 
   
1. На странице **секретапи-Overview (обзор** ) выберите **свойства** в области навигации слева.
   
1. Вы не хотите, чтобы интерфейсы API были доступны конечным пользователям на панели " **MyApps** ", поэтому установите для параметра **видимые пользователи** значение **нет** в нижней части страницы **Свойства** , а затем нажмите кнопку **сохранить**.
   
   ![Не отображается для пользователей](./media/application-proxy-secure-api-access/5-not-visible-to-users.png)
   
Вы опубликовали веб-API с помощью Azure AD Application Proxy. Теперь добавьте пользователей, которые имеют доступ к приложению. 

1. На странице **секретапи-Overview (обзор** ) выберите **Пользователи и группы** в левой области навигации.
   
1. На странице **Пользователи и группы** выберите **Добавить пользователя**.  
   
1. На странице **Добавление назначения** выберите **Пользователи и группы**. 
   
1. На странице **Пользователи и группы** найдите и выберите пользователей, которые имеют доступ к приложению, включая по крайней мере. Выбрав все пользователи, нажмите **кнопку Выбрать**. 
   
   ![Выбор и назначение пользователя](./media/application-proxy-secure-api-access/7-select-admin-user.png)
   
1. Вернитесь на страницу **Добавление назначения** и выберите **назначить**. 

> [!NOTE]
> Для API, использующих встроенную проверку подлинности Windows, могут потребоваться [Дополнительные действия](/azure/active-directory/manage-apps/application-proxy-configure-single-sign-on-with-kcd).

## <a name="register-the-native-app-and-grant-access-to-the-api"></a>Регистрация собственного приложения и предоставление доступа к API

Собственные приложения — это программы, разработанные для использования на определенной платформе или устройстве. Прежде чем ваше собственное приложение сможет подключиться к API и получить к нему доступ, его необходимо зарегистрировать в Azure AD. В следующих шагах показано, как зарегистрировать собственное приложение и предоставить ему доступ к веб-API, опубликованному через прокси приложения.

Чтобы зарегистрировать собственное приложение Апппроксинативеаппсампле, выполните следующие действия.

1. На странице **обзор** Azure Active Directory выберите **Регистрация приложений**и в верхней части области **Регистрация приложений** выберите пункт **Новая регистрация**.
   
1. На странице **Регистрация приложения** выполните следующие действия.
   
   1. В поле **имя**введите *апппроксинативеаппсампле*. 
      
   1. В разделе **Поддерживаемые типы учетных записей** выберите **Accounts in any organizational directory and personal Microsoft accounts** (Учетные записи в любом каталоге организации и личные учетные записи Майкрософт). 
      
   1. В разделе **URL-адрес перенаправления**раскрывающийся список и выберите **общедоступный клиент (мобильный & Настольный)** , а затем введите *https:\//апппроксинативеапп*. 
      
   1. Выберите **зарегистрировать**и подождите, пока приложение будет успешно зарегистрировано. 
      
      ![Регистрация нового приложения](./media/application-proxy-secure-api-access/8-create-reg-ga.png)
   
Теперь вы зарегистрировали приложение Апппроксинативеаппсампле в Azure Active Directory. Чтобы предоставить собственному приложению доступ к веб-API Секретапи, выполните следующие действия.

1. На странице **обзор** Azure Active Directory > **Регистрация приложений** выберите приложение **апппроксинативеаппсампле** . 
   
1. На странице **апппроксинативеаппсампле** выберите **разрешения API** в левой области навигации. 
   
1. На странице **разрешения API** выберите **Добавить разрешение**.
   
1. На странице **разрешения API первого запроса** выберите **API-интерфейсы, используемые моей организацией** , а затем найдите и выберите **секретапи**. 
   
1. На странице следующие **разрешения API запроса** установите флажок **user_impersonation**, а затем выберите **Добавить разрешения**. 
   
    ![Выбор API](./media/application-proxy-secure-api-access/10-secretapi-added.png)
   
1. На странице **разрешения API** можно выбрать параметр **предоставить согласие администратора для Contoso** , чтобы запретить другим пользователям индивидуальное согласие на доступ к приложению. 

## <a name="configure-the-native-app-code"></a>Настройка кода собственного приложения

Последним шагом является настройка собственного приложения. В следующем фрагменте кода из файла *Form1.CS* в примере приложения NATIVECLIENT библиотека ADAL получает маркер для запроса вызова API и присоединяет его как носитель к заголовку приложения. 
   
   ```csharp
       AuthenticationResult result = null;
       HttpClient httpClient = new HttpClient();
       authContext = new AuthenticationContext(authority);
       result = await authContext.AcquireTokenAsync(todoListResourceId, clientId, redirectUri, new PlatformParameters(PromptBehavior.Auto));
       
       // Append the token as bearer in the request header.
       httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", result.AccessToken);
       
       // Call the API.
       HttpResponseMessage response = await httpClient.GetAsync(todoListBaseAddress + "/api/values/4");
   
       // MessageBox.Show(response.RequestMessage.ToString());
       string s = await response.Content.ReadAsStringAsync();
       MessageBox.Show(s);
   ```
   
Чтобы настроить собственное приложение для подключения к Azure Active Directory и вызова прокси приложения API, обновите значения заполнителей в файле *app. config* примера приложения NativeClient, указав значения из Azure AD: 

- Вставьте **идентификатор каталога (клиента)** в поле `<add key="ida:Tenant" value="" />`. Это значение (GUID) можно найти и скопировать на странице **Обзор** любого из ваших приложений. 
  
- Вставьте **идентификатор приложения апппроксинативеаппсампле (Client)** в поле `<add key="ida:ClientId" value="" />`. Это значение (GUID) можно найти и скопировать на странице **обзора** апппроксинативеаппсампле.
  
- Вставьте **URI перенаправления** апппроксинативеаппсампле в поле `<add key="ida:RedirectUri" value="" />`. Это значение (URI) можно найти и скопировать на странице **проверки подлинности** апппроксинативеаппсампле. 
  
- Вставьте **URI идентификатора приложения** секретапи в поле `<add key="todo:TodoListResourceId" value="" />`. Это значение (URI) можно найти и скопировать в Секретапи **предоставить страницу API** .
  
- Вставьте **URL-адрес домашней страницы** секретапи в поле `<add key="todo:TodoListBaseAddress" value="" />`. Это значение (URL-адрес) можно найти и скопировать на странице **фирменной символики** секретапи.

После настройки параметров выполните сборку и запустите собственное приложение. При нажатии кнопки **входа** приложение позволяет войти в систему, а затем отображает экран успешного завершения, чтобы убедиться, что он успешно подключен к секретапи.

![Успешно](./media/application-proxy-secure-api-access/success.png)

## <a name="next-steps"></a>Дальнейшие действия

- [Руководство. Добавление локального приложения для удаленного доступа через прокси приложения в Azure Active Directory](application-proxy-add-on-premises-application.md)
- [Краткое руководство. Настройка клиентского приложения для доступа к веб-API](../develop/quickstart-configure-app-access-web-apis.md)
- [Как включить собственные клиентские приложения для взаимодействия с приложениями прокси-сервера](application-proxy-configure-native-client-application.md)
