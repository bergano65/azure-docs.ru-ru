---
title: Публикация удаленного рабочего стола с помощью прокси приложения Azure Active Directory
description: Описание настройки прокси приложения с помощью службы удаленных рабочих столов (RDS)
services: active-directory
author: kenwith
manager: celestedg
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.topic: how-to
ms.date: 07/22/2020
ms.author: kenwith
ms.reviewer: japere
ms.openlocfilehash: 03e89b0da25a915a00c70a9a87bd0f675b8e12d6
ms.sourcegitcommit: 8e7316bd4c4991de62ea485adca30065e5b86c67
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2020
ms.locfileid: "94658083"
---
# <a name="publish-remote-desktop-with-azure-ad-application-proxy"></a>Публикация удаленного рабочего стола с помощью прокси приложения Azure AD

Служба удаленных рабочих столов и прокси приложения Azure AD работают вместе для улучшения продуктивности рабочих ролей, находящихся за пределами корпоративной сети. 

Предполагаемая аудитория этой статьи:
- Текущие клиенты, использующие прокси приложения, которые хотят предложить больше приложений пользователям за счет публикации локальных приложений с помощью служб удаленных рабочих столов.
- Текущие клиенты, использующие службы удаленных рабочих столов, которые хотят сократить поверхность атаки своего развертывания с помощью прокси приложения Azure AD. Этот сценарий предоставляет набор из двухфакторной проверки подлинности и элементов управления условным доступом для RDS.

## <a name="how-application-proxy-fits-in-the-standard-rds-deployment"></a>Как прокси приложения встраивается в стандартное развертывание RDS

Стандартное развертывание RDS включает в себя различные службы ролей удаленного рабочего стола, выполняемые в Windows Server. Если взглянуть на [архитектуру служб удаленных рабочих столов](/windows-server/remote/remote-desktop-services/Desktop-hosting-logical-architecture), можно выделить несколько вариантов развертывания. В отличие от других вариантов развертывания RDS, [развертывание RDS с прокси приложения Azure AD](/windows-server/remote/remote-desktop-services/Desktop-hosting-logical-architecture) (как показано на следующей схеме) имеет постоянное исходящее подключение с сервера, на котором запущена служба соединителя. Другие развертывания оставляют открытыми входящие подключения через подсистему балансировки нагрузки.

![Прокси приложения располагается между виртуальной машиной RDS и общедоступным Интернетом](./media/application-proxy-integrate-with-remote-desktop-services/rds-with-app-proxy.png)

В развертывании RDS роль веб-сайта удаленных рабочих столов и роль шлюза удаленных рабочих столов выполняют компьютеры с подключением к Интернету. Эти конечные точки предоставляются по следующим причинам:
- Веб-сайт удаленных рабочих столов предоставляет пользователю общедоступную конечную точку для входа и просмотра различных локальных приложений и компьютеров, к которым у него есть доступ. После выбора ресурса создается подключение к удаленному рабочему столу с помощью собственного приложения в операционной системе.
- Когда пользователь открывает подключение к удаленному рабочему столу, на сцену выходит шлюз удаленных рабочих столов. Он обрабатывает зашифрованный трафик RDP, проходящий через Интернет, и транслирует его на локальный сервер, к которому подключается пользователь. В этом сценарии трафик, который получает шлюз удаленных рабочих столов, поступает от прокси приложения Azure AD.

>[!TIP]
>Если вы еще не разворачивали RDS или хотите получить дополнительные сведения, прежде чем начать, узнайте, как [незаметно для пользователя развернуть RDS с помощью Azure Resource Manager и Azure Marketplace](/windows-server/remote/remote-desktop-services/rds-in-azure).

## <a name="requirements"></a>Требования

- Конечные точки веб-сайта удаленных рабочих столов и шлюза удаленных рабочих столов должны располагаться на одном компьютере и в общем корне. Веб-сайт удаленных рабочих столов и шлюз удаленных рабочих столов публикуется как отдельные приложения с помощью прокси приложения, поэтому возможен единый вход в эти два приложения.

- Необходимо, чтобы [были развернуты службы удаленных рабочих столов (RDS)](/windows-server/remote/remote-desktop-services/rds-in-azure) и [включен прокси приложения](application-proxy-add-on-premises-application.md).

- Конечные пользователи должны использовать совместимый браузер для подключения к удаленному рабочему столу или веб-клиенту удаленных рабочих столов. Дополнительные сведения см. в разделе [Поддержка конфигураций клиентов](#support-for-other-client-configurations).

- При публикации веб-сайта удаленных рабочих столов рекомендуется использовать одинаковые внутреннее и внешнее полные доменные имена. Если эти имена отличаются, следует отключить преобразование заголовков запросов, чтобы клиент не получал недопустимые ссылки.

- Если вы используете RD Web в Internet Explorer, необходимо включить надстройку RDS ActiveX.

- При использовании веб-клиента удаленных рабочих столов необходимо использовать соединитель прокси приложения [версии 1.5.1975 или более поздней](./application-proxy-release-version-history.md).

- Для потока предварительной проверки подлинности Azure AD пользователи могут подключаться к ресурсам, опубликованным в них на панели " **Удаленные приложения" и "рабочие столы** ". Пользователи не могут подключаться к рабочему столу с помощью панели " **Подключение к удаленному компьютеру** ".

## <a name="deploy-the-joint-rds-and-application-proxy-scenario"></a>Сценарий совместного развертывания RDS и прокси приложения

Настроив RDS и прокси приложения Azure AD для своей среды, выполните приведенные инструкции, чтобы объединить эти два решения. В них описывается, как опубликовать две конечные точки RDS с подключением к Интернету (для веб-сайта удаленных рабочих столов и шлюза удаленных рабочих столов) в качестве приложений, а затем направить трафик RDS через прокси приложения.

### <a name="publish-the-rd-host-endpoint"></a>Публикация конечной точки узла удаленных рабочих столов

1. [Опубликуйте новое приложение прокси приложения](application-proxy-add-on-premises-application.md) с приведенными ниже значениями.
   - Внутренний URL-адрес: `https://\<rdhost\>.com/`, где `\<rdhost\>` — общий корень, совместно используемый веб-сайтом удаленных рабочих столов и шлюзом удаленных рабочих столов.
   - Внешний URL-адрес: это поле заполняется автоматически на основе имени приложения, но его можно изменить. Ваши пользователи будут переходить по этому URL-адресу при обращении к RDS.
   - Метод предварительной аутентификации: выберите Azure Active Directory.
   - Преобразование URL-адреса в заголовок: выберите значение "Нет".
2. Назначьте пользователей опубликованному приложению удаленных рабочих столов. Убедитесь также, что все они имеют доступ к RDS.
3. Для параметра единого входа для приложения оставьте значение **Единый вход Azure AD отключен**.

   >[!Note]
   >Пользователям предлагается пройти проверку подлинности один раз в Azure AD и один раз в веб-сайте RD, но у них есть единый вход на шлюз удаленных рабочих столов.

4. Выберите **Azure Active Directory**, а затем — **Регистрация приложений**. Выберите приложение из списка.
5. В разделе **Управление** выберите **фирменная символика**.
6. Обновите поле **URL-адрес домашней страницы** , чтобы указать конечную точку веб-сайта удаленных рабочих столов (например `https://\<rdhost\>.com/RDWeb` ,).

### <a name="direct-rds-traffic-to-application-proxy"></a>Направление трафика RDS в прокси приложения

Подключитесь к развертыванию RDS как администратор и измените имя сервера шлюза удаленных рабочих столов для развертывания. Эта конфигурация обеспечивает прохождение подключений через прокси приложения Azure AD.

1. Подключитесь серверу RDS, выполняющему роль посредника подключений к удаленному рабочему столу.
2. Запустите **Диспетчер сервера**.
3. В левой области выберите **Службы удаленных рабочих столов**.
4. Щелкните **Обзор**.
5. В разделе "Обзор развертывания" щелкните раскрывающееся меню и выберите **Изменить свойства развертывания**.
6. На вкладке "Шлюз удаленных рабочих столов" в поле **Имя сервера** укажите внешний URL-адрес, заданный для конечной точки узла удаленных рабочих столов в прокси приложения.
7. В поле **Метод входа** укажите **Проверка подлинности с помощью пароля**.

   ![Экран свойств развертывания RDS](./media/application-proxy-integrate-with-remote-desktop-services/rds-deployment-properties.png)

8. Выполните эту команду для каждой коллекции. Замените *\<yourcollectionname\>* и *\<proxyfrontendurl\>* собственными сведениями. Эта команда включает единый вход между веб-сайтом удаленных рабочих столов и шлюзом удаленных рабочих столов и оптимизирует производительность.

   ```
   Set-RDSessionCollectionConfiguration -CollectionName "<yourcollectionname>" -CustomRdpProperty "pre-authentication server address:s:<proxyfrontendurl>`nrequire pre-authentication:i:1"
   ```

   **Например:**
   ```
   Set-RDSessionCollectionConfiguration -CollectionName "QuickSessionCollection" -CustomRdpProperty "pre-authentication server address:s:https://remotedesktoptest-aadapdemo.msappproxy.net/`nrequire pre-authentication:i:1"
   ```
   >[!NOTE]
   >В приведенной выше команде используется обратная одиночная кавычка: `nrequire.

9. Чтобы проверить изменение настраиваемых свойств протокола удаленного рабочего стола, а также просмотреть оглавление RDP-файла, которое будет скачано с веб-сайта удаленных рабочих столов для этой коллекции, выполните следующую команду:
    ```
    (get-wmiobject -Namespace root\cimv2\terminalservices -Class Win32_RDCentralPublishedRemoteDesktop).RDPFileContents
    ```

Теперь, после настройки удаленного рабочего стола, прокси приложения Azure AD взял на себя роль компонента для Интернета RDS. Можно удалить другие общедоступные конечные точки для Интернета на компьютерах веб-сайта удаленных рабочих столов и шлюза удаленных рабочих столов.

### <a name="enable-the-rd-web-client"></a>Включение веб-клиента удаленных рабочих столов
Если вы также хотите, чтобы пользователи могли использовать веб-клиент удаленных рабочих столов, выполните действия, описанные в разделе [Настройка веб-клиента удаленный рабочий стол,](/windows-server/remote/remote-desktop-services/clients/remote-desktop-web-client-admin) чтобы включить эту возможность для пользователей.

Веб-клиент удаленный рабочий стол позволяет пользователям получить доступ к инфраструктуре удаленный рабочий стол Организации через веб-браузер, совместимый с HTML5, например Microsoft ребр, Internet Explorer 11, Google Chrome, Safari или Mozilla Firefox (v 55.0 и более поздние версии).

## <a name="test-the-scenario"></a>Тестирование сценария

Протестируйте сценарий в Internet Explorer на компьютере Windows 7 или Windows 10.

1. Перейдите по настроенному внешнему URL-адресу или найдите свое приложение на [панели MyApps](https://myapps.microsoft.com).
2. Вам будет предложено пройти аутентификацию в Azure Active Directory. Используйте учетную запись, назначенную приложению.
3. Вам будет предложено пройти аутентификацию на веб-сайте удаленных рабочих столов.
4. После успешной аутентификации в RDS вы сможете выбрать рабочий стол или приложение и начать работу.

## <a name="support-for-other-client-configurations"></a>Поддержка других конфигураций клиента

Конфигурация, описанная в этой статье, предназначена для доступа к RDS через веб-клиента удаленных рабочих столов или через веб-клиент. Однако, если требуется, можно использовать и другие операционные системы или браузеры. Разница заключается в используемом методе проверки подлинности.

| Метод проверки подлинности | Поддерживаемая конфигурация клиента |
| --------------------- | ------------------------------ |
| Предварительная аутентификация    | RD Web — Windows 7/10 с использованием Internet Explorer или [пограничной Chromium в режиме IE](/deployedge/edge-ie-mode) и надстройки RDS ActiveX |
| Предварительная аутентификация    | Веб-клиент RD — совместимый с HTML5 веб-браузер, такой как Microsoft ребр, Internet Explorer 11, Google Chrome, Safari или Mozilla Firefox (v 55.0 и более поздние версии) |
| Сквозной режим | Любая другая операционная система, поддерживающая приложение "Удаленный рабочий стол (Майкрософт)" |

Поток предварительной аутентификации предлагает больше преимуществ с точки зрения безопасности, чем сквозной режим. Предварительная проверка подлинности позволяет использовать функции аутентификации Azure AD, такие как единый вход, условный доступ и двухфакторная проверка подлинности для локальных ресурсов. Также гарантируется, что сети достигает только прошедший аутентификацию трафик.

Чтобы использовать аутентификацию в сквозном режиме, необходимо внести только два изменения в действия, описанные в этой статье:
1. В разделе [Публикация конечной точки узла удаленных рабочих столов](#publish-the-rd-host-endpoint) (шаг 1) в качестве метода предварительной аутентификации выберите **Сквозной режим**.
2. В разделе [Направление трафика RDS в прокси приложения](#direct-rds-traffic-to-application-proxy) полностью пропустите шаг 8.

## <a name="next-steps"></a>Дальнейшие действия
- [Настройка удаленного доступа к SharePoint с помощью прокси приложения Azure AD](application-proxy-integrate-with-sharepoint-server.md)
- [Вопросы безопасности при удаленном доступе к приложениям через прокси приложения Azure AD](application-proxy-security.md)
- [Рекомендации по балансировке нагрузки нескольких серверов приложений](application-proxy-high-availability-load-balancing.md#best-practices-for-load-balancing-among-multiple-app-servers)