---
title: Настройка согласия конечных пользователей для приложений с помощью Azure Active Directory
description: Узнайте, как управлять согласием пользователей на приложения, которые будут иметь доступ к данным вашей организации.
services: active-directory
author: kenwith
manager: celestedg
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.topic: how-to
ms.date: 06/01/2020
ms.author: kenwith
ms.reviewer: arvindh, luleon, phsignor
ms.custom: contperfq2
ms.openlocfilehash: 1617015d6d4a026d5dadda667dcd03447a20c288
ms.sourcegitcommit: 8e7316bd4c4991de62ea485adca30065e5b86c67
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2020
ms.locfileid: "94649506"
---
# <a name="configure-how-end-users-consent-to-applications"></a>Настройка согласия конечных пользователей для приложений

Вы можете интегрировать приложения с платформой удостоверений Microsoft, чтобы пользователи могли выполнять вход с рабочей или учебной учетной записью и получать доступ к данным вашей организации для использования расширенных возможностей, предоставляемых данными.

Прежде чем приложение сможет получить доступ к данным организации, пользователь должен предоставить ему разрешения. Различные разрешения позволяют использовать разные уровни доступа. По умолчанию всем пользователям разрешено предоставлять согласие на разрешения приложений, не требующие согласия администратора. Например, по умолчанию пользователь может предоставить приложению разрешение на доступ к своему почтовому ящику, но не может дать приложению неограниченный доступ на чтение и запись для всех файлов в организации.

Позволяя пользователям предоставлять приложениям доступ к данным, вы даете им возможность легко получать полезные приложения и работать продуктивно. Однако в некоторых ситуациях такая конфигурация может представлять риск, поэтому нужно внимательно отслеживать и контролировать такие разрешения.

> [!IMPORTANT]
> Чтобы снизить риск того, что вредоносные приложения попытаются обманным путем заставить пользователей предоставить им доступ к данным организации, рекомендуется разрешить согласие пользователя только для приложений, опубликованных [проверенным издателем](../develop/publisher-verification-overview.md).

## <a name="user-consent-settings"></a>Параметры согласия пользователя

Политики согласия приложений описывают условия, которые должны быть выполнены, прежде чем можно будет принять согласие на принятие приложения. Эти политики могут включать условия для приложения, запрашивающего доступ, а также разрешения, запрашиваемые приложением.

Если выбрать, какие политики согласия приложений применяются для всех пользователей, можно установить ограничения, когда конечные пользователи смогут предоставлять согласие на доступ к приложениям, и когда им потребуется запросить проверку и утверждение администратора:

* **Отключить согласие пользователя** — пользователи не могут предоставлять приложениям разрешения. Пользователи могут входить в приложения, на которые они согласились ранее или на которые дал согласие администратор от их имени, но они не смогут согласиться на новые разрешения или приложения самостоятельно. Только пользователи, которым предоставлена роль каталога, включающая разрешение на предоставление согласия, смогут дать согласие на новые приложения.

* **Пользователи могут согласиться с приложениями от проверенных издателей или вашей организации, но только для выбранных разрешений** . все пользователи могут согласиться только на приложения, которые были опубликованы [проверенным издателем](../develop/publisher-verification-overview.md) и приложениями, зарегистрированными в вашем клиенте. Пользователи могут согласиться только на те разрешения, которые классифицируются как "низкие последствия". Необходимо [классифицировать разрешения](configure-permission-classifications.md) , чтобы выбрать разрешения, которым разрешено согласие пользователям.

* **Пользователи могут согласиться на все приложения** . Этот параметр позволяет всем пользователям получать согласие на любые разрешения, не требующие согласия администратора для любого приложения.

* **Политика согласия настраиваемого приложения** . для дополнительных параметров в условиях, регулирующих согласие пользователя, можно [создать пользовательскую политику согласия приложений](manage-app-consent-policies.md#create-a-custom-app-consent-policy)и настроить их для согласия пользователя.

# <a name="portal"></a>[Портал](#tab/azure-portal)

Настройка параметров согласия пользователя на портале Azure:

1. Войдите на [портал Azure](https://portal.azure.com) как [глобальный администратор](../roles/permissions-reference.md#global-administrator--company-administrator).
1. Выберите **Azure Active Directory** > **Корпоративные приложения** > **Согласия и разрешения** > **Параметры согласия пользователя**.
1. В разделе **Согласие пользователя для приложений** выберите параметр согласия, который вы хотите настроить для всех пользователей.
1. Нажмите кнопку **Save** (Сохранить), чтобы сохранить настройки.

:::image type="content" source="media/configure-user-consent/setting-for-all-users.png" alt-text="Параметры согласия пользователя":::

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

Вы можете использовать последний модуль предварительной версии Azure AD PowerShell, [AzureADPreview](/powershell/azure/active-directory/install-adv2?preserve-view=true&view=azureadps-2.0-preview), чтобы выбрать политику согласия приложения, определяющую согласие пользователя для приложений.

#### <a name="disable-user-consent"></a>Отключение согласия пользователя

Чтобы отключить согласие пользователя, установите политики согласия, определяющие согласие пользователя как пустые:

  ```powershell
  Set-AzureADMSAuthorizationPolicy `
     -Id "authorizationPolicy" `
     -PermissionGrantPolicyIdsAssignedToDefaultUserRole @()
  ```

#### <a name="allow-user-consent-subject-to-an-app-consent-policy"></a>Разрешить согласие пользователя в соответствии с политикой согласия приложения

Чтобы разрешить согласие пользователя, выберите политику согласия приложения, которая должна управлять авторизацией пользователей, чтобы предоставить согласие для приложений:

  ```powershell
  Set-AzureADMSAuthorizationPolicy `
     -Id "authorizationPolicy" `
     -PermissionGrantPolicyIdsAssignedToDefaultUserRole @("managePermissionGrantsForSelf.{consent-policy-id}")
  ```

Замените `{consent-policy-id}` идентификатором политики, которую вы хотите применить. Можно выбрать созданную [политику согласия приложения](manage-app-consent-policies.md#create-a-custom-app-consent-policy) или выбрать одну из следующих встроенных политик:

| ID | Описание |
|:---|:------------|
| Microsoft-пользователь-по умолчанию-низкий | **Разрешить согласие пользователя для приложений от проверенных издателей для выбранных разрешений**<br /> Разрешить ограниченное согласие пользователя только для приложений из проверенных издателей и приложений, зарегистрированных в клиенте, и только для тех разрешений, которые классифицируются как "низкие последствия". (Не забудьте [классифицировать разрешения](configure-permission-classifications.md) , чтобы выбрать разрешения, которым разрешено согласие пользователям.) |
| Microsoft-пользователь-default — устаревший | **Разрешить согласие пользователя для приложений**<br /> Этот параметр позволяет всем пользователям получать согласие на любые разрешения, не требующие согласия администратора, для любого приложения. |
  
Например, чтобы разрешить согласие пользователя в соответствии со встроенной политикой, `microsoft-user-default-low` выполните следующие действия.

```powershell
Set-AzureADMSAuthorizationPolicy `
   -Id "authorizationPolicy" `
   -PermissionGrantPolicyIdsAssignedToDefaultUserRole @("managePermissionGrantsForSelf.microsoft-user-default-low")
```

---

> [!TIP]
> [Включите рабочий процесс согласия администратора](configure-admin-consent-workflow.md) , чтобы разрешить пользователям запрашивать проверку и утверждение приложения, к которому пользователю не может быть предоставлено согласие, например, когда согласие пользователя было отключено или когда приложение запрашивает разрешения, которые пользователю запрещено предоставлять.

## <a name="risk-based-step-up-consent"></a>Согласие на действия на основе риска

Повышение уровня согласия на основе рисков позволяет снизить уязвимость пользователей для вредоносных приложений, которые делают [незаконные запросы на согласие](/microsoft-365/security/office-365-security/detect-and-remediate-illicit-consent-grants). Если корпорация Майкрософт обнаружит рискованный запрос согласия пользователя, запрос будет перенаправлен администратору. Эта возможность включена по умолчанию, но поведение будет изменено только при включенном согласии конечных пользователей.

При обнаружении рискованного запроса на согласие будет отображаться сообщение о необходимости утверждения администратором. Если [рабочий процесс запроса согласия администратора](configure-admin-consent-workflow.md) включен, пользователь может отправить запрос администратору для дальнейшей проверки непосредственно из запроса согласия. Если он не включен, отображается следующее сообщение:

* **AADSTS90094:** &lt;clientAppDisplayName&gt; требуются разрешения на доступ к ресурсам в вашей организации, которые может предоставить только администратор. Попросите администратора предоставить разрешение для этого приложения, прежде чем его можно будет использовать.

В этом случае событие аудита также будет регистрироваться с категорией "ApplicationManagement", типом действия "Согласие на приложение" и состоянием "Обнаружено рискованное приложение".

> [!IMPORTANT]
> Администраторы должны внимательно [изучать все запросы на согласие](manage-consent-requests.md#evaluating-a-request-for-tenant-wide-admin-consent) перед утверждением запроса, особенно если корпорация Майкрософт обнаружила риск.

### <a name="disable-or-re-enable-risk-based-step-up-consent-using-powershell"></a>Отключение и повторное включение повышения уровня согласия на основе риска с помощью PowerShell

Вы можете использовать модуль предварительной версии Azure AD PowerShell, [AzureADPreview](/powershell/module/azuread/?preserve-view=true&view=azureadps-2.0-preview), чтобы отключить перенаправление согласия администратору в случаях, когда корпорация Майкрософт обнаружит риск, или повторно включить его, если оно было отключено.

1. Убедитесь, что используете модуль [AzureADPreview](/powershell/module/azuread/?preserve-view=true&view=azureadps-2.0-preview). Этот важно, если вы установили модуль [AzureAD](/powershell/module/azuread/?preserve-view=true&view=azureadps-2.0) и модуль [AzureADPreview](/powershell/module/azuread/?preserve-view=true&view=azureadps-2.0-preview).

    ```powershell
    Remove-Module AzureAD
    Import-Module AzureADPreview
    ```

1. Подключитесь к Azure AD PowerShell.

   ```powershell
   Connect-AzureAD
   ```

1. Получите текущее значение параметров каталога **Параметры политики согласия** в клиенте. Для этого необходимо проверить, были ли созданы параметры каталога для этой функции, и если нет, использовать значения из соответствующего шаблона параметров каталога.

    ```powershell
    $consentSettingsTemplateId = "dffd5d46-495d-40a9-8e21-954ff55e198a" # Consent Policy Settings
    $settings = Get-AzureADDirectorySetting -All $true | Where-Object { $_.TemplateId -eq $consentSettingsTemplateId }

    if (-not $settings) {
        $template = Get-AzureADDirectorySettingTemplate -Id $consentSettingsTemplateId
        $settings = $template.CreateDirectorySetting()
    }

    $riskBasedConsentEnabledValue = $settings.Values | ? { $_.Name -eq "BlockUserConsentForRiskyApps" }
    ```

1. Сведения о значении параметров:

    | Параметр       | Тип         | Описание  |
    | ------------- | ------------ | ------------ |
    | _BlockUserConsentForRiskyApps_   | Логическое |  Флаг, указывающий, будет ли согласие пользователя блокироваться при обнаружении рискованного запроса. |

1. Обновите значение параметров для требуемой конфигурации:

    ```powershell
    # Disable risk-based step-up consent entirely
    $riskBasedConsentEnabledValue.Value = "False"
    ```

    ```powershell
    # Re-enable risk-based step-up consent, if disabled previously
    $riskBasedConsentEnabledValue.Value = "True"
    ```

1. Сохраните параметры.

    ```powershell
    if ($settings.Id) {
        # Update an existing directory settings
        Set-AzureADDirectorySetting -Id $settings.Id -DirectorySetting $settings
    } else {
        # Create a new directory settings to override the default setting 
        New-AzureADDirectorySetting -DirectorySetting $settings
    }
    ```

## <a name="next-steps"></a>Дальнейшие действия

Чтобы получить дополнительные сведения, обратитесь к разделу

* [Настройка параметров согласия пользователя](configure-user-consent.md)
* [Управление политиками согласия для приложений](manage-app-consent-policies.md)
* [Настройка рабочего процесса согласия администратора](configure-admin-consent-workflow.md)
* [Узнайте, как управлять согласием для приложений и оценивать запросы на согласие](manage-consent-requests.md)
* [Предоставление приложению согласия администратора на уровне арендатора](grant-admin-consent.md)
* [Разрешения и согласие для платформы удостоверений Майкрософт](../develop/v2-permissions-and-consent.md)

Получение справки или ответов на вопросы:
* [Azure AD в StackOverflow](https://stackoverflow.com/questions/tagged/azure-active-directory)