---
title: Прямая федерация с поставщиком удостоверений для B2B — Azure AD
description: Сведения о прямой федерации с поставщиком удостоверений SAML или WS-Fed для обеспечения возможности гостевого входа в приложения Azure AD
services: active-directory
ms.service: active-directory
ms.subservice: B2B
ms.topic: how-to
ms.date: 06/24/2020
ms.author: mimart
author: msmimart
manager: celestedg
ms.reviewer: mal
ms.custom: it-pro
ms.collection: M365-identity-device-management
ms.openlocfilehash: 0b7350d793ea42a46d52d881f1399174a3bb5d0e
ms.sourcegitcommit: 28c5fdc3828316f45f7c20fc4de4b2c05a1c5548
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/22/2020
ms.locfileid: "92362898"
---
# <a name="direct-federation-with-ad-fs-and-third-party-providers-for-guest-users-preview"></a>Прямая федерация с AD FS и сторонними поставщиками для гостевых пользователей (предварительная версия)

> [!NOTE]
>  Прямая федерация — это общедоступная предварительная версия функции Azure Active Directory. См. подробные сведения о [дополнительных условиях использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

В этой статье описывается, как настроить прямую федерацию с другой организацией для совместной работы B2B. Вы можете настроить прямую федерацию с любой организацией, поставщик удостоверений которой поддерживает протокол SAML 2.0 или WS-Fed.
После настройки прямой федерации с IdP партнера, новые гостевые пользователи из соответствующего домена смогут использовать собственную учетную запись организации, управляемую таким IdP, чтобы войти в клиент Azure AD и начать сотрудничество с вами. При этом гостевому пользователю не нужно создавать отдельную учетную запись Azure AD.
> [!NOTE]
> Гостевым пользователям прямой федерации необходимо войти по ссылке, содержащей контекст клиента (например, `https://myapps.microsoft.com/?tenantid=<tenant id>` или `https://portal.azure.com/<tenant id>`, а в случае проверенного домена — `https://myapps.microsoft.com/\<verified domain>.onmicrosoft.com`). Прямые ссылки на приложения и ресурсы также работают, если они содержат контекст клиента. В настоящее время пользователи прямой федерации не могут войти в систему, используя общие конечные точки, которые не имеют контекста клиента. Например, использование `https://myapps.microsoft.com`, `https://portal.azure.com` или `https://teams.microsoft.com` приведет к ошибке.
 
## <a name="when-is-a-guest-user-authenticated-with-direct-federation"></a>Условия проверки подлинности гостевого пользователя с помощью прямой федерации
После настройки прямой интеграции с организацией все новые приглашенные гостевые пользователи будут проходить проверку подлинности с помощью прямой федерации. Важно отметить, что настройка прямой федерации не меняет метод проверки подлинности для гостевых пользователей, которые уже активировали отправленное вами приглашение. Ниже приведены некоторые примеры:
 - Если гостевые пользователи уже активировали приглашения, а затем вы настроили прямую федерацию с их организацией, эти гостевые пользователи будут по прежнему использовать тот же метод проверки подлинности, который они использовали до настройки прямой федерации.
 - Если вы настроили прямую федерацию с партнерской организацией и пригласили гостевых пользователей, а затем партнерская организация перешла на Azure AD, уже активировавшие свои приглашения гостевые пользователи продолжат использовать прямую федерацию при условии наличия в клиенте политики прямой федерации.
 - В случае удаления прямой федерации с партнерской организацией все гостевые пользователи, которые сейчас используют прямую федерацию, не смогут войти в систему.

В любом из этих сценариев вы можете обновить метод проверки подлинности гостевого пользователя, удалив учетную запись гостевого пользователя из каталога и отправив ему приглашение повторно.

Прямая федерация привязана к пространствам имен домена, например contoso.com и fabrikam.com. При установке конфигурации прямой федерации с AD FS или сторонними поставщиками удостоверений организации связывают одно или несколько пространств имен домена с такими поставщиками удостоверений. 

## <a name="end-user-experience"></a>Возможности для пользователей 
При использовании прямой федерации гостевые пользователи входят в клиент Azure AD с помощью собственной учетной записи организации. При попытке доступа к общим ресурсам и запросе на вход пользователи прямой федерации перенаправляются в IdP. После успешного входа они возвращаются в Azure AD для доступа к ресурсам. Токены обновления пользователей прямой федерации действительны в течение 12 часов. Это [стандартная продолжительность для сквозного токена обновления](../develop/active-directory-configurable-token-lifetimes.md#exceptions) в Azure AD. Если в федеративном поставщике удостоверений включен единый вход, пользователю будет обеспечен единый вход. При этом после первоначальной проверки подлинности запросы на вход для него отображаться не будут.

## <a name="limitations"></a>Ограничения

### <a name="dns-verified-domains-in-azure-ad"></a>Проверенные DNS домены в Azure AD
Домен, с которым вы хотите создать федерацию, должен проверяться в Azure AD в качестве ***Not**_. Вы можете настроить прямую федерацию с неуправляемыми клиентами Azure AD (проверяемыми по электронной почте или "вирусами"), так как они не проверяются DNS.

### <a name="authentication-url"></a>URL-адрес проверки подлинности
Прямая федерация разрешена только для политик, в которых домен URL-адреса проверки подлинности совпадает с целевым доменом или URL-адрес проверки подлинности принадлежит одному из таких разрешенных поставщиков удостоверений (этот список может быть изменен):

-   accounts.google.com;
-   pingidentity.com;
-   login.pingone.com;
-   okta.com;
-   oktapreview.com;
-   okta-emea.com;
-   my.salesforce.com;
-   federation.exostar.com;
-   federation.exostartest.com.

Например, при настройке прямой Федерации для _ * Fabrikam. com * * URL-адрес проверки подлинности `https://fabrikam.com/adfs` будет проходить проверку. Ее пройдет также и узел в том же домене, например `https://sts.fabrikam.com/adfs`. Однако с URL-адресом проверки подлинности `https://fabrikamconglomerate.com/adfs` или `https://fabrikam.com.uk/adfs` для того же домена пройти ее не удастся.

### <a name="signing-certificate-renewal"></a>Возобновление действия сертификата для подписи
Если указать URL-адрес метаданных в параметрах поставщика удостоверений, Azure AD автоматически возобновит сертификат для подписи по истечении срока его действия. Тем не менее, в случае смены сертификата по какой-либо причине до истечения срока действия, а также при отсутствии URL-адреса метаданных Azure AD не сможет возобновить его действие. В этом случае вам потребуется обновить сертификат для подписи вручную.

### <a name="limit-on-federation-relationships"></a>Ограничение отношения федерации
В настоящее время поддерживается не более 1 000 отношений федерации. Это ограничение охватывает как [внутренние ](https://docs.microsoft.com/powershell/module/msonline/set-msoldomainfederationsettings?view=azureadps-1.0), так и прямые федерации.

### <a name="limit-on-multiple-domains"></a>Ограничение для нескольких доменов
На данный момент прямая федерация с несколькими доменами из одного и того же клиента не поддерживается.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы
### <a name="can-i-set-up-direct-federation-with-a-domain-for-which-an-unmanaged-email-verified-tenant-exists"></a>Можно ли настроить прямую федерацию с доменом, для которого существует неуправляемый клиент (с проверкой по электронной почте)? 
Да. Если домен не проверен, а клиент не прошел [смену администратором](../enterprise-users/domains-admin-takeover.md), вы можете настроить прямую федерацию с таким доменом. Неуправляемые (проверяемые по электронной почте) клиенты создаются, когда пользователь активирует приглашение для совместной работы B2B или выполняет самостоятельную регистрацию в Azure AD, используя домен, который в настоящее время не существует. Вы можете настроить прямую федерацию с такими доменами. Попытка настроить прямую федерацию с проверенным DNS доменом на портале Azure либо с помощью PowerShell приведет к ошибке.
### <a name="if-direct-federation-and-email-one-time-passcode-authentication-are-both-enabled-which-method-takes-precedence"></a>Какой метод имеет приоритет, если включена проверка подлинности как с помощью прямой федерации, так и по электронной почте с помощью одноразового секретного кода?
При установке прямой федерации с партнерской организацией она считается более приоритетной для новых гостевых пользователей из этой организации по сравнению с проверкой подлинности по электронной почте с помощью одноразового секретного кода. Если гостевой пользователь активировал приглашение до настройки прямой федерации, используя проверку подлинности на основе одноразового секретного кода, для него и в дальнейшем будет использоваться этот способ проверки подлинности. 
### <a name="does-direct-federation-address-sign-in-issues-due-to-a-partially-synced-tenancy"></a>Решает ли прямая федерация проблемы со входом из-за частичной синхронизации аренды?
Нет, в этом сценарии следует использовать возможность [отправки одноразового секретного кода по электронной почте](one-time-passcode.md). Под "частичной синхронизацией аренды" подразумевается ситуация, когда удостоверения локальных пользователей клиента Azure AD не полностью синхронизируются с облаком. При попытке активировать ваше приглашение для совместной работы B2B гость, удостоверение которого пока еще отсутствует в облаке, не сможет войти в систему. Для входа он может воспользоваться возможностью применения одноразового секретного кода. Возможность прямой федерации решает проблему в ситуации, когда у гостя есть собственная учетная запись организации, управляемой IdP, но у организации полностью отсутствует Azure AD.

## <a name="step-1-configure-the-partner-organizations-identity-provider"></a>Шаг 1. Настройка поставщика удостоверений партнерской организации
Для начала партнерской организации следует настроить поставщик удостоверений с необходимыми утверждениями и отношениями доверия с проверяющей стороной. 

> [!NOTE]
> Чтобы продемонстрировать настройку поставщика удостоверений для прямой федерации, воспользуемся в качестве примера службой федерации Active Directory (AD FS). Примеры настройки AD FS в качестве поставщика удостоверений SAML 2.0 или WS-Fed при подготовке к прямой интеграции см. в статье [Настройка прямой федерации с AD FS](direct-federation-adfs.md).

### <a name="saml-20-configuration"></a>Конфигурация SAML 2.0

B2B в Azure AD можно настроить для федерации с поставщиками удостоверений, использующими протокол SAML, в соответствии с определенными требованиями, которые приведены ниже. Дополнительные сведения о настройке отношения доверия между поставщиком удостоверений SAML и Azure AD см. в статье [Использование поставщика удостоверений SAML 2.0 для единого входа](https://docs.microsoft.com/azure/active-directory/hybrid/how-to-connect-fed-saml-idp).  

> [!NOTE]
> Целевой домен для прямой федерации не должен проверяться DNS в Azure AD. Домен URL-адреса проверки подлинности должен совпадать с целевым доменом или быть доменом разрешенного поставщика удостоверений. Дополнительные сведения см. в разделе [Ограничения](#limitations). 

#### <a name="required-saml-20-attributes-and-claims"></a>Обязательные атрибуты и утверждения SAML 2.0
В следующих таблицах приведены требования к конкретным атрибутам и утверждениям, которые должны быть настроены у стороннего поставщика удостоверений. Чтобы настроить прямую федерацию, в ответе SAML 2.0 от поставщика удостоверений должны быть получены указанные ниже атрибуты. Их можно настроить путем связывания с XML-файлом службы токенов безопасности в сети или ввести вручную.

Обязательные атрибуты для ответа SAML 2.0 от IdP:

|attribute  |Значение  |
|---------|---------|
|AssertionConsumerService     |`https://login.microsoftonline.com/login.srf`         |
|Аудитория     |`urn:federation:MicrosoftOnline`         |
|Издатель     |URI издателя IdP партнера, например `http://www.example.com/exk10l6w90DHM0yi...`         |


Обязательные утверждения для токена SAML 2.0, выданного IdP:

|attribute  |Значение  |
|---------|---------|
|NameID Format     |`urn:oasis:names:tc:SAML:2.0:nameid-format:persistent`         |
|emailaddress     |`http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`         |

### <a name="ws-fed-configuration"></a>Конфигурация WS-Fed 
B2B в Azure AD можно настроить для федерации с поставщиками удостоверений, использующими протокол WS-Fed, в соответствии с определенными требованиями, которые приведены ниже. В настоящее время на совместимость с Azure AD протестированы два поставщика WS-Fed: AD FS и Shibboleth. Дополнительные сведения о создании отношения доверия с проверяющей стороной между совместимым поставщиком WS-Fed и Azure AD см. в публикации "Документация по интеграции STS с использованием протоколов WS", доступной в [пакете документации по совместимости поставщика удостоверений Azure AD](https://www.microsoft.com/download/details.aspx?id=56843).

> [!NOTE]
> Целевой домен для прямой федерации не должен проверяться DNS в Azure AD. Домен URL-адреса проверки подлинности должен либо совпадать с целевым доменом, либо быть доменом разрешенного поставщика удостоверений. Дополнительные сведения см. в разделе [Ограничения](#limitations). 

#### <a name="required-ws-fed-attributes-and-claims"></a>Обязательные атрибуты и утверждения WS-Fed

В следующих таблицах приведены требования к конкретным атрибутам и утверждениям, которые должны быть настроены у стороннего поставщика удостоверений WS-Fed. Чтобы настроить прямую федерацию, в сообщении WS-Fed от поставщика удостоверений должны быть получены указанные ниже атрибуты. Их можно настроить путем связывания с XML-файлом службы токенов безопасности в сети или ввести вручную.

Обязательные атрибуты в сообщении WS-Fed от поставщика удостоверений:
 
|attribute  |Значение  |
|---------|---------|
|PassiveRequestorEndpoint     |`https://login.microsoftonline.com/login.srf`         |
|Аудитория     |`urn:federation:MicrosoftOnline`         |
|Издатель     |URI издателя IdP партнера, например `http://www.example.com/exk10l6w90DHM0yi...`         |

Обязательные утверждения для токена WS-Fed, выданного IdP:

|attribute  |Значение  |
|---------|---------|
|ImmutableID     |`http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID`         |
|emailaddress     |`http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`         |

## <a name="step-2-configure-direct-federation-in-azure-ad"></a>Шаг 2. Настройка прямой федерации в Azure AD 
Далее вы настроите федерацию с поставщиком удостоверений, настроенным на шаге 1 в Azure AD. Вы можете использовать портал Azure AD или PowerShell. Для вступления в силу политики прямой федерации может потребоваться 5–10 минут. Не пытайтесь активировать приглашение для домена прямой федерации в течение этого времени. Ниже приведены обязательные атрибуты.
- URI издателя IdP партнера
- Конечная точка пассивной проверки подлинности IdP партнера (поддерживается только протокол HTTPS)
- Сертификат

### <a name="to-configure-direct-federation-in-the-azure-ad-portal"></a>Настройка прямой федерации на портале Azure AD

1. Перейдите на [портал Azure](https://portal.azure.com/). В области слева выберите **Azure Active Directory**. 
2. Выберите **Внешние удостоверения** > **Все поставщики удостоверений**.
3. Затем выберите **Новый поставщик удостоверений (IdP) SAML/WS-Fed**.

    ![Снимок экрана, на котором показана кнопка добавления нового поставщика удостоверений SAML или WS-Fed](media/direct-federation/new-saml-wsfed-idp.png)

4. На странице **Новый поставщик удостоверений (IdP) SAML/WS-Fed** в разделе **Протокол поставщика удостоверений** выберите **SAML** или **WS-FED**.

    ![Снимок экрана, на котором показана кнопка "Выполнить анализ" на странице SAML или WS-IdP](media/direct-federation/new-saml-wsfed-idp-parse.png)

5. Введите доменное имя партнерской организации, которое будет целевым доменным именем для прямой федерации.
6. Для заполнения сведений о метаданных можно передать файл метаданных. Если вы решили ввести метаданные вручную, укажите следующие сведения:
   - доменное имя IdP партнера;
   - идентификатор сущности IdP партнера;
   - конечную точку запрашивающей стороны IdP партнера;
   - Сертификат
   > [!NOTE]
   > URL-адрес метаданных необязателен, но мы настоятельно рекомендуем его указать. Если URL-адреса метаданных задан, Azure AD может автоматически возобновить действие сертификата для подписи по истечении срока его действия. В случае смены сертификата по какой-либо причине до истечения срока действия, а также при отсутствии URL-адреса метаданных Azure AD не сможет возобновить его действие. В этом случае вам потребуется обновить сертификат для подписи вручную.

7. Щелкните **Сохранить**. 

### <a name="to-configure-direct-federation-in-azure-ad-using-powershell"></a>Настройка прямой федерации в Azure AD с помощью PowerShell

1. Установите последнюю версию модуля Azure AD PowerShell для Graph ([AzureADPreview](https://www.powershellgallery.com/packages/AzureADPreview)). (Если вам нужны подробные инструкции, ознакомьтесь с разделом [Установка последнего модуля AzureADPreview](b2b-quickstart-invite-powershell.md#install-the-latest-azureadpreview-module) в кратком руководстве по добавлению гостевого пользователя.) 
2. Выполните следующую команду: 
   ```powershell
   Connect-AzureAD
   ```
1. При появлении запроса на вход войдите с помощью управляемой учетной записи глобального администратора. 
2. Выполните следующие команды, заменив значения соответствующими данными из файла метаданных федерации. Для сервера AD FS и Okta файлом федерации является federationmetadata.xml, например `https://sts.totheclouddemo.com/federationmetadata/2007-06/federationmetadata.xml`. 

   ```powershell
   $federationSettings = New-Object Microsoft.Open.AzureAD.Model.DomainFederationSettings
   $federationSettings.PassiveLogOnUri ="https://sts.totheclouddemo.com/adfs/ls/"
   $federationSettings.LogOffUri = $federationSettings.PassiveLogOnUri
   $federationSettings.IssuerUri = "http://sts.totheclouddemo.com/adfs/services/trust"
   $federationSettings.MetadataExchangeUri="https://sts.totheclouddemo.com/adfs/services/trust/mex"
   $federationSettings.SigningCertificate= <Replace with X509 signing cert’s public key>
   $federationSettings.PreferredAuthenticationProtocol="WsFed" OR "Samlp"
   $domainName = <Replace with domain name>
   New-AzureADExternalDomainFederation -ExternalDomainName $domainName  -FederationSettings $federationSettings
   ```

## <a name="step-3-test-direct-federation-in-azure-ad"></a>Шаг 3. Тестирование прямой федерации в Azure AD
Теперь протестируйте настройку прямой федерации, пригласив нового гостевого пользователя для совместной работы B2B. Дополнительные сведения см. в статье [Добавление пользователей для совместной работы B2B в Azure AD на портале Azure](add-users-administrator.md).
 
## <a name="how-do-i-edit-a-direct-federation-relationship"></a>Как изменить отношение прямой федерации?

1. Перейдите на [портал Azure](https://portal.azure.com/). В области слева выберите **Azure Active Directory**. 
2. Выберите **Внешние удостоверения**.
3. Выберите **Все поставщики удостоверений**
4. В разделе **Поставщики удостоверений SAML/WS-Fed** выберите поставщик.
5. Обновите значения в области сведений о поставщике удостоверений.
6. Щелкните **Сохранить**.


## <a name="how-do-i-remove-direct-federation"></a>Как удалить прямую федерацию?
Настройку прямой федерации можно удалить. В этом случае гостевые пользователи прямой федерации, которые уже активировали свои приглашения, не смогут войти в систему. Однако вы можете снова предоставить им доступ к ресурсам, удалив их из каталога и пригласив повторно. Чтобы удалить прямую федерацию с поставщиком удостоверений на портале Azure AD, сделайте следующее.

1. Перейдите на [портал Azure](https://portal.azure.com/). В области слева выберите **Azure Active Directory**. 
2. Выберите **Внешние удостоверения**.
3. Выберите **Все поставщики удостоверений**.
4. Выберите поставщик удостоверений и щелкните **Удалить**. 
5. Выберите **Да**, чтобы подтвердить удаление. 

Чтобы удалить прямую федерацию с поставщиком удостоверений с помощью PowerShell, выполните следующие действия.
1. Установите последнюю версию модуля Azure AD PowerShell для Graph ([AzureADPreview](https://www.powershellgallery.com/packages/AzureADPreview)).
2. Выполните следующую команду: 
   ```powershell
   Connect-AzureAD
   ```
3. При появлении запроса на вход войдите с помощью управляемой учетной записи глобального администратора. 
4. Введите следующую команду:
   ```powershell
   Remove-AzureADExternalDomainFederation -ExternalDomainName  $domainName
   ```

## <a name="next-steps"></a>Дальнейшие шаги

Узнайте больше о процессе [активации приглашения](redemption-experience.md) , когда внешние пользователи входят с различными поставщиками удостоверений.