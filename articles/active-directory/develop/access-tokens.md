---
title: Маркеры доступа платформы удостоверений Майкрософт | Azure
titleSuffix: Microsoft identity platform
description: Познакомьтесь с маркерами доступа, создаваемыми конечными точками Azure AD версии 1.0 и платформы удостоверений Майкрософт (версии 2.0).
services: active-directory
author: hpsin
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 09/18/2020
ms.author: hirsin
ms.reviewer: hirsin
ms.custom: aaddev, identityplatformtop40, fasttrack-edit
ms.openlocfilehash: c59dbe9464e70c1a071b64fabf91ce56f409d8d7
ms.sourcegitcommit: 32c521a2ef396d121e71ba682e098092ac673b30
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2020
ms.locfileid: "91258527"
---
# <a name="microsoft-identity-platform-access-tokens"></a>Маркеры доступа платформы удостоверений Майкрософт

Маркеры доступа позволяют клиентам безопасно вызывать защищенные API-интерфейсы. Маркеры доступа платформы удостоверений Майкрософт — это [JWT](https://tools.ietf.org/html/rfc7519), объекты JSON в кодировке Base64, подписанные платформой удостоверений Майкрософт. Клиентам следует обрабатывать маркеры как непрозрачные строки, так как их содержимое предназначено только для ресурса. Для проверки и отладки разработчики могут декодировать JWT (веб-маркеры JSON) через [jwt.ms](https://jwt.ms) или другой аналогичный сайт. Клиент может получить маркер доступа из любой конечной точки (версии 1.0 или 2.0) по протоколу на свой выбор.

При запросе маркера доступа платформы удостоверений Майкрософт также возвращает некоторые метаданные о маркере доступа для приложения. Эти сведения включают срок действия маркера доступа и области, для которых он действителен. Благодаря этим данным приложение может выполнять интеллектуальное кэширование маркеров доступа, не анализируя сам маркер.

Если приложение является ресурсом, к которому могут обращаться клиенты (веб-API), маркеры доступа предоставляют полезные сведения для аутентификации и авторизации, в том числе идентификаторы пользователя, клиента и издателя, разрешения и многое другое.

В следующих разделах показано, как ресурс может проверять и использовать утверждения в маркере доступа.

> [!IMPORTANT]
> Маркеры доступа создаются на основе *аудитории* маркера, то есть приложения, владеющего областями в маркере.  Именно так параметр ресурса `accessTokenAcceptedVersion` в [манифесте приложения](reference-app-manifest.md#manifest-reference) в `2` позволяет клиенту вызывать конечную точку версии 1.0 для получения маркера доступа версии 2.0.  Аналогично, вот почему изменение [необязательных утверждений](active-directory-optional-claims.md) маркера доступа для клиента не изменяет маркер доступа, полученный при запросе маркера для `user.read`, который принадлежит ресурсу.
> По той же причине при тестировании клиентского приложения с использованием личной учетной записи (например, hotmail.com или outlook.com) вы можете заметить, что от клиента в качестве маркера доступа поступает непрозрачная строка. Это происходит в тех случаях, когда ресурс, к которому осуществляется доступ, требует использовать старую версию билетов MSA (учетная запись Майкрософт), которые шифруются и недоступны для анализа в клиенте.

## <a name="sample-tokens"></a>Примеры маркеров

Токены версий 1.0 и 2.0 похожи друг на друга и содержат много одинаковых утверждений. Ниже представлены примеры каждого из них.

### <a name="v10"></a>Версия 1.0

```
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Imk2bEdrM0ZaenhSY1ViMkMzbkVRN3N5SEpsWSIsImtpZCI6Imk2bEdrM0ZaenhSY1ViMkMzbkVRN3N5SEpsWSJ9.eyJhdWQiOiJlZjFkYTlkNC1mZjc3LTRjM2UtYTAwNS04NDBjM2Y4MzA3NDUiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC9mYTE1ZDY5Mi1lOWM3LTQ0NjAtYTc0My0yOWYyOTUyMjIyOS8iLCJpYXQiOjE1MzcyMzMxMDYsIm5iZiI6MTUzNzIzMzEwNiwiZXhwIjoxNTM3MjM3MDA2LCJhY3IiOiIxIiwiYWlvIjoiQVhRQWkvOElBQUFBRm0rRS9RVEcrZ0ZuVnhMaldkdzhLKzYxQUdyU091TU1GNmViYU1qN1hPM0libUQzZkdtck95RCtOdlp5R24yVmFUL2tES1h3NE1JaHJnR1ZxNkJuOHdMWG9UMUxrSVorRnpRVmtKUFBMUU9WNEtjWHFTbENWUERTL0RpQ0RnRTIyMlRJbU12V05hRU1hVU9Uc0lHdlRRPT0iLCJhbXIiOlsid2lhIl0sImFwcGlkIjoiNzVkYmU3N2YtMTBhMy00ZTU5LTg1ZmQtOGMxMjc1NDRmMTdjIiwiYXBwaWRhY3IiOiIwIiwiZW1haWwiOiJBYmVMaUBtaWNyb3NvZnQuY29tIiwiZmFtaWx5X25hbWUiOiJMaW5jb2xuIiwiZ2l2ZW5fbmFtZSI6IkFiZSAoTVNGVCkiLCJpZHAiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC83MmY5ODhiZi04NmYxLTQxYWYtOTFhYi0yZDdjZDAxMjIyNDcvIiwiaXBhZGRyIjoiMjIyLjIyMi4yMjIuMjIiLCJuYW1lIjoiYWJlbGkiLCJvaWQiOiIwMjIyM2I2Yi1hYTFkLTQyZDQtOWVjMC0xYjJiYjkxOTQ0MzgiLCJyaCI6IkkiLCJzY3AiOiJ1c2VyX2ltcGVyc29uYXRpb24iLCJzdWIiOiJsM19yb0lTUVUyMjJiVUxTOXlpMmswWHBxcE9pTXo1SDNaQUNvMUdlWEEiLCJ0aWQiOiJmYTE1ZDY5Mi1lOWM3LTQ0NjAtYTc0My0yOWYyOTU2ZmQ0MjkiLCJ1bmlxdWVfbmFtZSI6ImFiZWxpQG1pY3Jvc29mdC5jb20iLCJ1dGkiOiJGVnNHeFlYSTMwLVR1aWt1dVVvRkFBIiwidmVyIjoiMS4wIn0.D3H6pMUtQnoJAGq6AHd
```

Изучите этот маркер версии 1.0 на сайте [jwt.ms](https://jwt.ms/#access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Imk2bEdrM0ZaenhSY1ViMkMzbkVRN3N5SEpsWSIsImtpZCI6Imk2bEdrM0ZaenhSY1ViMkMzbkVRN3N5SEpsWSJ9.eyJhdWQiOiJlZjFkYTlkNC1mZjc3LTRjM2UtYTAwNS04NDBjM2Y4MzA3NDUiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC9mYTE1ZDY5Mi1lOWM3LTQ0NjAtYTc0My0yOWYyOTUyMjIyOS8iLCJpYXQiOjE1MzcyMzMxMDYsIm5iZiI6MTUzNzIzMzEwNiwiZXhwIjoxNTM3MjM3MDA2LCJhY3IiOiIxIiwiYWlvIjoiQVhRQWkvOElBQUFBRm0rRS9RVEcrZ0ZuVnhMaldkdzhLKzYxQUdyU091TU1GNmViYU1qN1hPM0libUQzZkdtck95RCtOdlp5R24yVmFUL2tES1h3NE1JaHJnR1ZxNkJuOHdMWG9UMUxrSVorRnpRVmtKUFBMUU9WNEtjWHFTbENWUERTL0RpQ0RnRTIyMlRJbU12V05hRU1hVU9Uc0lHdlRRPT0iLCJhbXIiOlsid2lhIl0sImFwcGlkIjoiNzVkYmU3N2YtMTBhMy00ZTU5LTg1ZmQtOGMxMjc1NDRmMTdjIiwiYXBwaWRhY3IiOiIwIiwiZW1haWwiOiJBYmVMaUBtaWNyb3NvZnQuY29tIiwiZmFtaWx5X25hbWUiOiJMaW5jb2xuIiwiZ2l2ZW5fbmFtZSI6IkFiZSAoTVNGVCkiLCJpZHAiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC83MmY5ODhiZi04NmYxLTQxYWYtOTFhYi0yZDdjZDAxMjIyNDcvIiwiaXBhZGRyIjoiMjIyLjIyMi4yMjIuMjIiLCJuYW1lIjoiYWJlbGkiLCJvaWQiOiIwMjIyM2I2Yi1hYTFkLTQyZDQtOWVjMC0xYjJiYjkxOTQ0MzgiLCJyaCI6IkkiLCJzY3AiOiJ1c2VyX2ltcGVyc29uYXRpb24iLCJzdWIiOiJsM19yb0lTUVUyMjJiVUxTOXlpMmswWHBxcE9pTXo1SDNaQUNvMUdlWEEiLCJ0aWQiOiJmYTE1ZDY5Mi1lOWM3LTQ0NjAtYTc0My0yOWYyOTU2ZmQ0MjkiLCJ1bmlxdWVfbmFtZSI6ImFiZWxpQG1pY3Jvc29mdC5jb20iLCJ1dGkiOiJGVnNHeFlYSTMwLVR1aWt1dVVvRkFBIiwidmVyIjoiMS4wIn0.D3H6pMUtQnoJAGq6AHd).

### <a name="v20"></a>Версия 2.0

```
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imk2bEdrM0ZaenhSY1ViMkMzbkVRN3N5SEpsWSJ9.eyJhdWQiOiI2ZTc0MTcyYi1iZTU2LTQ4NDMtOWZmNC1lNjZhMzliYjEyZTMiLCJpc3MiOiJodHRwczovL2xvZ2luLm1pY3Jvc29mdG9ubGluZS5jb20vNzJmOTg4YmYtODZmMS00MWFmLTkxYWItMmQ3Y2QwMTFkYjQ3L3YyLjAiLCJpYXQiOjE1MzcyMzEwNDgsIm5iZiI6MTUzNzIzMTA0OCwiZXhwIjoxNTM3MjM0OTQ4LCJhaW8iOiJBWFFBaS84SUFBQUF0QWFaTG8zQ2hNaWY2S09udHRSQjdlQnE0L0RjY1F6amNKR3hQWXkvQzNqRGFOR3hYZDZ3TklJVkdSZ2hOUm53SjFsT2NBbk5aY2p2a295ckZ4Q3R0djMzMTQwUmlvT0ZKNGJDQ0dWdW9DYWcxdU9UVDIyMjIyZ0h3TFBZUS91Zjc5UVgrMEtJaWpkcm1wNjlSY3R6bVE9PSIsImF6cCI6IjZlNzQxNzJiLWJlNTYtNDg0My05ZmY0LWU2NmEzOWJiMTJlMyIsImF6cGFjciI6IjAiLCJuYW1lIjoiQWJlIExpbmNvbG4iLCJvaWQiOiI2OTAyMjJiZS1mZjFhLTRkNTYtYWJkMS03ZTRmN2QzOGU0NzQiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJhYmVsaUBtaWNyb3NvZnQuY29tIiwicmgiOiJJIiwic2NwIjoiYWNjZXNzX2FzX3VzZXIiLCJzdWIiOiJIS1pwZmFIeVdhZGVPb3VZbGl0anJJLUtmZlRtMjIyWDVyclYzeERxZktRIiwidGlkIjoiNzJmOTg4YmYtODZmMS00MWFmLTkxYWItMmQ3Y2QwMTFkYjQ3IiwidXRpIjoiZnFpQnFYTFBqMGVRYTgyUy1JWUZBQSIsInZlciI6IjIuMCJ9.pj4N-w_3Us9DrBLfpCt
```

Изучите этот маркер версии 2.0 на сайте [jwt.ms](https://jwt.ms/#access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imk2bEdrM0ZaenhSY1ViMkMzbkVRN3N5SEpsWSJ9.eyJhdWQiOiI2ZTc0MTcyYi1iZTU2LTQ4NDMtOWZmNC1lNjZhMzliYjEyZTMiLCJpc3MiOiJodHRwczovL2xvZ2luLm1pY3Jvc29mdG9ubGluZS5jb20vNzJmOTg4YmYtODZmMS00MWFmLTkxYWItMmQ3Y2QwMTFkYjQ3L3YyLjAiLCJpYXQiOjE1MzcyMzEwNDgsIm5iZiI6MTUzNzIzMTA0OCwiZXhwIjoxNTM3MjM0OTQ4LCJhaW8iOiJBWFFBaS84SUFBQUF0QWFaTG8zQ2hNaWY2S09udHRSQjdlQnE0L0RjY1F6amNKR3hQWXkvQzNqRGFOR3hYZDZ3TklJVkdSZ2hOUm53SjFsT2NBbk5aY2p2a295ckZ4Q3R0djMzMTQwUmlvT0ZKNGJDQ0dWdW9DYWcxdU9UVDIyMjIyZ0h3TFBZUS91Zjc5UVgrMEtJaWpkcm1wNjlSY3R6bVE9PSIsImF6cCI6IjZlNzQxNzJiLWJlNTYtNDg0My05ZmY0LWU2NmEzOWJiMTJlMyIsImF6cGFjciI6IjAiLCJuYW1lIjoiQWJlIExpbmNvbG4iLCJvaWQiOiI2OTAyMjJiZS1mZjFhLTRkNTYtYWJkMS03ZTRmN2QzOGU0NzQiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJhYmVsaUBtaWNyb3NvZnQuY29tIiwicmgiOiJJIiwic2NwIjoiYWNjZXNzX2FzX3VzZXIiLCJzdWIiOiJIS1pwZmFIeVdhZGVPb3VZbGl0anJJLUtmZlRtMjIyWDVyclYzeERxZktRIiwidGlkIjoiNzJmOTg4YmYtODZmMS00MWFmLTkxYWItMmQ3Y2QwMTFkYjQ3IiwidXRpIjoiZnFpQnFYTFBqMGVRYTgyUy1JWUZBQSIsInZlciI6IjIuMCJ9.pj4N-w_3Us9DrBLfpCt).

## <a name="claims-in-access-tokens"></a>Утверждения в маркерах доступа

JWT (веб-маркеры JSON) состоят из трех частей.

* **Заголовок** содержит сведения о том, как можно [проверить маркер](#validating-tokens), в том числе сведения о типе и способе подписывания маркера.
* **Полезные данные** содержат все важные сведения о пользователе или приложении, которые пытаются вызвать эту службу.
* **Подпись** содержит исходный материал для проверки маркера.

Эти части разделяются точками (`.`) и кодируются в Base64 по отдельности.

В маркер включаются только те утверждения, для которых существуют значения. Это означает, что приложение не должно принимать зависимости от наличия определенных утверждений. В качестве примеров можно назвать `pwd_exp` (не каждому клиенту нужен срок действия паролей) или `family_name` (потоки учетных данных клиента ([v1.0](../azuread-dev/v1-oauth2-client-creds-grant-flow.md), [v2.0](v2-oauth2-client-creds-grant-flow.md)) выполняются от лица приложений, которым не присвоены имена). Утверждения, используемые для проверки маркера доступа, присутствуют всегда.

> [!NOTE]
> Некоторые утверждения помогают Azure AD защищать маркеры от повторного использования. Они отмечаются в описании как Opaque (Непрозрачные), то есть недоступные для широкого использования. Такие утверждения могут присутствовать или отсутствовать в маркере, и в любой момент без предварительного уведомления могут быть добавлены новые.

### <a name="header-claims"></a>Утверждения заголовка

|Утверждение | Формат | Описание |
|--------|--------|-------------|
| `typ` | Строка — всегда JWT | Указывает, что маркер имеет тип JWT.|
| `nonce` | Строка | Уникальный идентификатор для защиты от атак с повторением маркеров. Ваш ресурс может сохранять это значение для защиты от повторов. |
| `alg` | Строка | Обозначает алгоритм, с помощью которого был подписан маркер, например RS256. |
| `kid` | Строка | Содержит отпечаток для открытого ключа, который использовался для подписания этого маркера. Выпускаются в маркерах доступа версий 1.0 и 2.0. |
| `x5t` | Строка | Действует и указывается точно так же, как `kid`. `x5t` — устаревшее утверждение, которое выпускается только в маркерах доступа версии 1.0 для обеспечения совместимости. |

### <a name="payload-claims"></a>Утверждения полезных данных

| Утверждение | Формат | Описание |
|-----|--------|-------------|
| `aud` | Строка с URI идентификатора приложения | Определяет целевого получателя маркера. Аудитория в маркерах идентификации — это идентификатор приложения, назначенный этому приложению на портале Azure. Приложение должно проверить это значение и отклонить маркер, если он ему не соответствует. |
| `iss` | Строка с URI службы токенов безопасности | Определяет службу маркеров безопасности (STS), которая создает и возвращает маркер, а также клиент Azure AD, в котором пользователь прошел аутентификацию. Если выданный маркер является маркером версии 2.0 (см. утверждение `ver`), URI заканчивается на `/v2.0`. GUID, который указывает, что пользователь является потребителем с учетной записью Майкрософт: `9188040d-6c67-4c5b-b112-36a304b66dad`. Приложению также следует использовать часть утверждения, содержащую GUID, для ограничения списка клиентов, которым разрешено входить в приложение, если это применимо. |
|`idp`| Строка, обычно — URI STS | Фиксирует поставщика удостоверений, который проверил подлинность субъекта маркера. Это значение идентично значению утверждения издателя, за исключением случаев, когда учетная запись пользователя и издатель принадлежат разным клиентам (например, гости). Если утверждение отсутствует, это означает, что взамен можно использовать значение `iss`.  Для пользовательских учетных записей, используемых в контексте организации (например, приглашение пользовательской учетной записи в клиент Azure AD), утверждение `idp` может быть live.com или URI STS, содержащим клиент учетной записи Microsoft `9188040d-6c67-4c5b-b112-36a304b66dad`. |
| `iat` | int, метка времени UNIX | Значение Issued At (Выпущено в) показывает, когда произошла проверка подлинности этого маркера. |
| `nbf` | int, метка времени UNIX | Утверждение nbf (не ранее) определяет время, до которого маркер JWT не должен приниматься в обработку. |
| `exp` | int, метка времени UNIX | Утверждение exp (время окончания срока действия) указывает время окончания срока действия или время, начиная с которого маркер JWT не должен приниматься в обработку. Важно отметить, что ресурс может отклонить маркер и раньше указанного времени, если, например, требуется изменить способ аутентификации или маркер был отозван. |
| `aio` | Непрозрачная строка | Внутреннее утверждение, в котором Azure AD сохраняет данные для повторного использования маркеров. Ресурсы не должны использовать это утверждение. |
| `acr` | Строка со значением 0 или 1 | Присутствует только в маркерах версии 1.0. Утверждение Authentication context class (Класс контекста аутентификации). Значение 0 означает, что аутентификация конечного пользователя не соответствовала требованиям ISO/IEC 29115. |
| `amr` | Массив строк в формате JSON | Присутствует только в маркерах версии 1.0. Указывает способ проверки подлинности субъекта токена. Дополнительные сведения см. в [разделе об утверждении amr](#the-amr-claim). |
| `appid` | Строка с идентификатором GUID | Присутствует только в маркерах версии 1.0. Идентификатор приложения клиента, использующего маркер. Приложение может действовать самостоятельно или от имени пользователя. Идентификатор приложения, как правило, представляет объект приложения, но может также представлять и объект субъекта-службы в Azure AD. |
| `appidacr` | 0, 1 или 2 | Присутствует только в маркерах версии 1.0. Указывает на способ проверки подлинности клиента. Для общедоступного клиента значение равно 0. При использовании идентификатора и секрета клиента значение равно 1. Если для аутентификации использовался сертификат клиента, значение равно 2. |
| `azp` | Строка с идентификатором GUID | Только в маркерах версии 2.0. Заменяет `appid`. Идентификатор приложения клиента, использующего маркер. Приложение может действовать самостоятельно или от имени пользователя. Идентификатор приложения, как правило, представляет объект приложения, но может также представлять и объект субъекта-службы в Azure AD. |
| `azpacr` | 0, 1 или 2 | Только в маркерах версии 2.0. Заменяет `appidacr`. Указывает на способ проверки подлинности клиента. Для общедоступного клиента значение равно 0. При использовании идентификатора и секрета клиента значение равно 1. Если для аутентификации использовался сертификат клиента, значение равно 2. |
| `preferred_username` | Строка | Основное имя пользователя, представляющее пользователя. Это может быть адрес электронной почты, телефонный номер или универсальное имя пользователя без определенного формата. Его значение не является неизменяемым и может меняться с течением времени. Так как это значение является изменяемым, его нельзя использовать для принятия решений об авторизации.  Но его можно использовать в качестве подсказки при вводе имени пользователя. Чтобы получить это утверждение, необходимо указать область `profile`. |
| `name` | Строка | Предоставляет удобное для восприятия значение, которое идентифицирует субъект маркера. Это значение не обязательно должно быть уникальным. Оно изменяемое и предназначено только для отображения. Чтобы получить это утверждение, необходимо указать область `profile`. |
| `scp` | Строка, список областей с разделителями-пробелами | Набор областей, предоставляемых приложением, для которых клиентское приложение уже запросило (и получило) согласие. Приложению следует проверить, что здесь указаны допустимые предоставляемые приложением области, а затем принять решение об авторизации на основе значений для этих областей. Включаются только в [маркеры пользователя](#user-and-application-tokens). |
| `roles` | Массив строк, список разрешений | Набор разрешений, предоставляемых приложением, на вызов которых запрашивающему приложению или пользователю предоставлены разрешения. Для [маркеров приложений](#user-and-application-tokens) это используется в потоке учетных данных клиента ([v1.0](../azuread-dev/v1-oauth2-client-creds-grant-flow.md), [v2.0](v2-oauth2-client-creds-grant-flow.md)) вместо областей пользователя.  Для [маркеров пользователей](#user-and-application-tokens) он заполняется ролями, которым пользователь был назначен в целевом приложении. |
| `wids` | Массив GUID [RoleTemplateID](../users-groups-roles/directory-assign-admin-roles.md#role-template-ids) | Обозначает роли на уровне клиента, назначенные этому пользователю, из раздела ролей, имеющихся в [странице роли администратора](../users-groups-roles/directory-assign-admin-roles.md#role-template-ids).  Это утверждение настраивается на уровне приложения с использованием свойства `groupMembershipClaims` [манифеста приложения](reference-app-manifest.md).  Для него необходимо задать значение ALL или DirectoryRole.  Может отсутствовать в маркерах, полученных через неявный поток из-за проблем с длиной маркера. |
| `groups` | Массив идентификаторов GUID в формате JSON | Предоставляет идентификаторы объектов, представляющие членство субъекта в группах. Эти значения уникальны (см. раздел «Object ID»), их можно безопасно использовать для управления доступом, например для принудительной авторизации для доступа к ресурсу. Группы, входящие в утверждение groups, настраиваются для конкретного приложения с помощью свойства `groupMembershipClaims` в [манифесте приложения](reference-app-manifest.md). Значение NULL исключит все группы, значение "SecurityGroup" будет включать только Active Directory членства в группах безопасности, а значение "все" будет содержать как группы безопасности, так и Microsoft 365 списки рассылки. <br><br>См. описание утверждения `hasgroups` ниже, чтобы получить сведения об использовании утверждения `groups` с неявным разрешением. <br>Для других потоков: если число групп, в которые входит пользователь, превышает лимит (150 для SAML и 200 для JWT), тогда избыточное утверждение будет добавлено к источникам утверждений, указывая на конечную точку Microsoft Graph, содержащую список групп для пользователя. |
| `hasgroups` | Логическое | Если он присутствует, всегда имеет значение `true`. Это обозначает, что пользователь входит как минимум в одну группу. Используется вместо утверждения `groups` для JWT в неявных потоках предоставления, если утверждение полной группы расширяет фрагмент URI за пределы ограничения длины URL-адреса (в настоящее время 6 или более групп). Указывает на то, что клиент должен использовать API Microsoft Graph для определения групп пользователя (`https://graph.microsoft.com/v1.0/users/{userID}/getMemberObjects`). |
| `groups:src1` | Объект JSON | Для запросов маркеров, которые не ограничены по длине (см. `hasgroups` выше), но все еще слишком большие для маркеров, будет добавлена ссылка на полный список групп, в которые входит пользователь. Используется для JWT в качестве распределенного утверждения и для SAML в качестве нового утверждения вместо `groups`. <br><br>**Пример значения JWT**: <br> `"groups":"src1"` <br> `"_claim_sources`: `"src1" : { "endpoint" : "https://graph.microsoft.com/v1.0/users/{userID}/getMemberObjects" }` |
| `sub` | Строка | Субъект, в отношении которого маркер утверждает сведения, например данные о пользователе приложения. Это значение является неизменяемым и не может быть переназначено или повторно использовано. Это значение можно использовать для безопасных проверок авторизации, например, когда маркер используется для доступа к ресурсу, а также в качестве ключа в таблицах базы данных. Так как субъект всегда присутствует в выдаваемых Azure AD маркерах, мы советуем использовать это значение в системе авторизации общего назначения. Тем не менее субъект — это попарный идентификатор, который является уникальным для конкретного приложения. Если один пользователь войдет в два различных приложения с помощью двух разных идентификаторов клиента, эти приложения получат два разных значения в утверждении субъекта. Это может быть или не быть необходимым в зависимости от требований архитектуры и конфиденциальности. См. также утверждение `oid` (которое остается неизменным в разных приложениях внутри клиента). |
| `oid` | Строка с идентификатором GUID | Неизменяемый идентификатор объекта на платформе удостоверений Майкрософт. В нашем случае это учетная запись пользователя. Его можно использовать для безопасных проверок авторизации, а также в качестве ключа в таблицах базы данных. Этот идентификатор уникально идентифицирует пользователя в приложениях. Если один пользователь войдет в два различных приложения с помощью двух разных идентификаторов клиента, эти приложения получат одинаковое значение в утверждении `oid`. Это означает, что `oid` может использоваться при выполнении запросов к веб-службам корпорации Майкрософт, например Microsoft Graph. Microsoft Graph возвратит этот идентификатор в качестве свойства `id` указанной [учетной записи пользователя](/graph/api/resources/user). Так как `oid` позволяет нескольким приложениям сопоставлять пользователей, для получения этого утверждения необходимо указать область `profile`. Обратите внимание, что если один пользователь существует в нескольких клиентах, его учетная запись в каждом клиенте будет содержать разные идентификаторы объекта. Такие учетные записи считаются разными, даже если пользователь входит в каждую из них с помощью одних учетных данных. |
| `tid` | Строка с идентификатором GUID | Представляет клиент Azure AD, в котором определен пользователь. Для рабочих и учебных учетных записей значением GUID является неизменяемый идентификатор клиента организации, к которой принадлежит пользователь. Для личных учетных записей значением является `9188040d-6c67-4c5b-b112-36a304b66dad`. Чтобы получить это утверждение, необходимо указать область `profile`. |
| `unique_name` | Строка | Присутствует только в маркерах версии 1.0. Предоставляет удобное для восприятия значение, которое идентифицирует субъект маркера. Это значение не обязательно должно быть уникальным в пределах клиента. Оно используется только для отображения. |
| `uti` | Непрозрачная строка | Внутреннее утверждение, используемое Azure для повторной проверки маркеров. Ресурсы не должны использовать это утверждение. |
| `rh` | Непрозрачная строка | Внутреннее утверждение, используемое Azure для повторной проверки маркеров. Ресурсы не должны использовать это утверждение. |
| `ver` | Строка со значением `1.0` или `2.0` | Обозначает номер версии маркера доступа. |

**Утверждение избытка групп**

Чтобы размер токена не превышал ограничения на размер заголовка HTTP, Azure AD ограничивает количество идентификаторов объектов, включаемых в утверждение групп. Если число групп, в которых состоит пользователь, выходит за предел избытка (150 для маркеров SAML, 200 для маркеров JWT), Azure AD не выдает утверждение групп в маркере. Вместо этого в маркер включается утверждение избытка, которое указывает приложению выполнить запрос к API Microsoft Graph для получения групп, в которых состоит пользователь.

```JSON
{
  ...
  "_claim_names": {
   "groups": "src1"
    },
    {
  "_claim_sources": {
    "src1": {
        "endpoint":"[Url to get this user's group membership from]"
        }
       }
     }
  ...
 }
 ```

Вы можете использовать `BulkCreateGroups.ps1`, предоставленный в папке [Скрипты создания приложений](https://github.com/Azure-Samples/active-directory-aspnetcore-webapp-openidconnect-v2/tree/master/5-WebApp-AuthZ/5-2-Groups/AppCreationScripts), чтобы тестировать сценарии избытка.

#### <a name="v10-basic-claims"></a>Базовые утверждения в версии 1.0

Следующие утверждения (если они применимы) по умолчанию включаются в маркеры версии 1.0, но не включаются в маркеры версии 2.0. Если вы используете версию 2.0 и намерены использовать одно из этих утверждений, запросите его через механизм [необязательных утверждений](active-directory-optional-claims.md).

| Утверждение | Формат | Описание |
|-----|--------|-------------|
| `ipaddr`| Строка | IP-адрес, с которого пользователь прошел аутентификацию. |
| `onprem_sid`| Строка в [формате SID](/windows/desktop/SecAuthZ/sid-components) | В тех случаях, когда пользователь использует локальную аутентификацию, это утверждение содержит его идентификатор безопасности. Вы можете использовать `onprem_sid` для авторизации в приложениях прежних версий.|
| `pwd_exp`| int, метка времени UNIX | Указывает, когда истекает срок действия пароля пользователя. |
| `pwd_url`| Строка | URL-адрес, на который можно направить пользователя для сброса пароля. |
| `in_corp`| Логическое | Посылает сигнал, если клиент входит в корпоративную сеть. В противном случае это утверждение не добавляется. |
| `nickname`| Строка | Дополнительное имя для пользователя, отдельное от имени или фамилии.|
| `family_name` | Строка | Указывает фамилию пользователя, которая определена в объекте пользователя. |
| `given_name` | Строка | Указывает личное имя пользователя, которое задано в объекте пользователя. |
| `upn` | Строка | Имя пользователя. Может содержать номер телефона, адрес электронной почты или любую неформатированную строку. Должно использоваться только для отображения и подсказки имени пользователя в сценариях повторной аутентификации. |

#### <a name="the-amr-claim"></a>Утверждение `amr`

Проверку подлинности удостоверений Майкрософт можно выполнять несколькими способами, с учетом особенностей приложения. Утверждение `amr` представляет собой массив с несколькими элементами, например `["mfa", "rsa", "pwd"]`, и используется при аутентификации с помощью пароля и приложения Authenticator.

| Значение | Описание |
|-----|-------------|
| `pwd` | Проверка пароля. Это может быть пароль учетной записи Майкрософт для пользователя или секрет клиента для приложения. |
| `rsa` | Аутентификация выполнялась путем проверки ключа RSA, например с помощью [приложения Microsoft Authenticator](https://aka.ms/AA2kvvu). Сюда же включается аутентификация по JWT с самозаверяющим сертификатом X509 службы. |
| `otp` | Одноразовый секретный код, переданный по электронной почте или в текстовом сообщении. |
| `fed` | Использовалось утверждение федеративной проверки подлинности (например, JWT или SAML). |
| `wia` | Встроенная проверка подлинности Windows |
| `mfa` | Использовалась [многофакторная проверка подлинности](../authentication/concept-mfa-howitworks.md). Если указано это утверждение, будут перечислены и другие методы проверки подлинности. |
| `ngcmfa` | Эквивалентно `mfa`, используется для подготовки определенных расширенных типов учетных данных. |
| `wiaormfa`| Пользователь использовал для аутентификации учетные данные Windows или MFA. |
| `none` | Аутентификация не выполнялась. |

## <a name="validating-tokens"></a>Проверка маркеров

Для проверки id_token или access_token приложение должно проверить подпись и утверждения маркера. Чтобы проверить маркеры доступа, приложению также следует проверить издателя, аудиторию и маркеры подписывания. Они должны проверяться на соответствие значениям в документе обнаружения OpenID. Например, версия документа для любых клиентов находится в [https://login.microsoftonline.com/common/.well-known/openid-configuration](https://login.microsoftonline.com/common/.well-known/openid-configuration).

ПО промежуточного слоя Azure AD содержит встроенные возможности для проверки маркеров доступа. Вы можете найти пример для выбранного вами языка в нашем наборе [примеров](../azuread-dev/sample-v1-code.md).

Мы предоставляем библиотеки и примеры кода, демонстрирующие способы проверки маркеров. Ниже предоставляется информация для тех, кто хочет разобраться в базовых процессах. Для проверки JWT доступны несколько сторонних библиотек с открытым кодом. Среди них вы найдете как минимум один вариант практически для каждой платформы и языка. Дополнительные сведения о библиотеках аутентификации Azure AD и примеры кода см. в документации по библиотекам проверки подлинности [версии 1.0](../azuread-dev/active-directory-authentication-libraries.md) и [версии 2.0](reference-v2-libraries.md).

### <a name="validating-the-signature"></a>Проверка подписи

Маркер JWT содержит три сегмента, разделенных символом `.` . Первый сегмент называется **заголовком**, второй — **телом**, а третий — **подписью**. Сегмент подписи можно использовать для проверки подлинности маркера, чтобы приложение доверяло ему.

Маркеры, выдаваемые Azure AD, подписываются при помощи стандартных отраслевых алгоритмов асимметричного шифрования, таких как RS256. Заголовок JWT содержит сведения о ключе и методе шифрования, используемых для подписания маркера.

```json
{
  "typ": "JWT",
  "alg": "RS256",
  "x5t": "iBjL1Rcqzhiy4fpxIxdZqohM2Yk",
  "kid": "iBjL1Rcqzhiy4fpxIxdZqohM2Yk"
}
```

Утверждение `alg` определяет алгоритм, использованный для подписания токена, а утверждение `kid` — конкретный открытый ключ, использованный для проверки токена.

Azure AD может в любой момент времени подписать маркер идентификации с использованием любой пары открытого и закрытого ключей из определенного набора пар. Azure AD периодически изменяет возможный набор ключей, поэтому при создании приложения необходимо обеспечить автоматическую обработку подобных изменений ключей. Рекомендуем проверять наличие обновлений открытых ключей, которые использует служба Azure AD, каждые 24 часа.

Данные ключа подписи, необходимые для проверки подписи, можно найти в [документе метаданных OpenID Connect](v2-protocols-oidc.md#fetch-the-openid-connect-metadata-document) по ссылке:

```
https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration
```

> [!TIP]
> Попробуйте ввести этот [URL-адрес](https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration) в браузере.

Документ метаданных:

* Это объект в формате JSON, который содержит несколько полезных блоков информации, таких как расположение различных конечных точек, необходимых для проверки подлинности OpenID Connect.
* Он включает `jwks_uri` с информацией о расположении набора общедоступных ключей, используемых для подписания маркеров. Документ веб-ключа JSON (JWK), который находится в `jwks_uri`, содержит все сведения об открытых ключах, используемые в конкретный момент времени.  Формат JWK описан в [RFC 7517](https://tools.ietf.org/html/rfc7517).  Приложение может использовать утверждение `kid` в заголовке маркера JWT, чтобы выбрать открытый ключ в этом документе, использованный для подписания определенного маркера. Затем оно может выполнить проверку подписи с использованием правильного общедоступного ключа и указанного алгоритма.

> [!NOTE]
> Конечная точка версии 1.0 возвращает оба утверждения `x5t` и `kid`, в то время как конечная точка версии 2.0 отправляет только утверждение `kid`. В будущем мы рекомендуем использовать утверждение `kid` для проверки маркера.

Выполнение проверки подписи выходит за рамки этого документа. Если вам требуется помощь в этом вопросе, воспользуйтесь всевозможными библиотеками с открытым исходным кодом.  Однако платформа удостоверений Майкрософт имеет одно расширение подписывания маркеров для стандартов — пользовательские ключи подписывания.

Если в приложении есть настраиваемые ключи подписывания в результате использования функции [сопоставления утверждений](active-directory-claims-mapping.md), необходимо добавить параметр запроса `appid`, содержащий идентификатор приложения, чтобы получить `jwks_uri`, указывающий на сведения о ключе подписывания приложения, которые следует использовать для проверки. Например: `https://login.microsoftonline.com/{tenant}/.well-known/openid-configuration?appid=6731de76-14a6-49ae-97bc-6eba6914391e` содержит `jwks_uri` для `https://login.microsoftonline.com/{tenant}/discovery/keys?appid=6731de76-14a6-49ae-97bc-6eba6914391e`.

### <a name="claims-based-authorization"></a>Авторизация на основе утверждений

Этот шаг зависит от бизнес-логики конкретного приложения. Ниже просто описаны несколько распространенных методов авторизации.

* Проверьте утверждение `scp` или `roles` и убедитесь, что все присутствующие области соответствуют тем, которые доступны через API, и они позволяют клиенту выполнить запрошенное действие.
* С помощью утверждения `appid` убедитесь, что вызывающий клиент имеет право вызывать API.
* Проверьте состояние аутентификации для вызывающего клиента с помощью утверждения `appidacr`. Если общедоступным клиентским приложениям не разрешено вызывать этот API, значение этого утверждения не может быть равно 0.
* Сверьтесь со списком ранее полученных утверждений `nonce`, чтобы защититься от повторного использования маркера.
* Убедитесь, что `tid` обозначает клиент, который имеет право вызывать этот API.
* С помощью утверждения `acr` проверьте, прошел ли пользователь многофакторную проверку подлинности. Это требование нужно предварительно применять при помощи [Условного доступа](../conditional-access/overview.md).
* Если вы запросили в маркере доступа утверждения `roles` или `groups`, убедитесь, что пользователь входит в группу, которая может выполнять это действие.
  * В случае с маркерами, получаемых через неявный поток, для получения этих данных обычно нужно запрашивать [Microsoft Graph](https://developer.microsoft.com/graph/), ведь их размер часто превышает допустимый для маркера.

## <a name="user-and-application-tokens"></a>Маркеры пользователя и приложения

Приложение может получить маркеры для пользователя (обычно он обсуждается) или напрямую из приложения (через [поток учетных данных клиента](../azuread-dev/v1-oauth2-client-creds-grant-flow.md)). Маркеры для приложений указывают, что вызов поступает от самого приложения, а не по запросу пользователя. Эти маркеры обрабатываются практически так же:

* Используйте `roles` для просмотра разрешений, предоставленных субъекту маркера (субъекту-службе, а не пользователю в данном случае).
* Используйте `oid` или, `sub` чтобы проверить, что вызывающий субъект-служба является ожидаемым.

Если приложению необходимо различать маркеры доступа только для приложений и маркеры доступа для пользователей, используйте `idtyp` [необязательное утверждение](active-directory-optional-claims.md).  При добавлении `idtyp` утверждения в `accessToken` поле и проверке значения `app` можно обнаружить маркеры доступа только для приложений.  В маркерах идентификации и маркерах доступа для пользователей не будет `idtyp` включаться утверждение.


## <a name="token-revocation"></a>Отзыв маркеров

Маркеры обновления могут стать недействительными или могут быть отозваны в любое время по различным причинам. Эти причины делятся на две основные категории: время ожидания и отзыв.

### <a name="token-timeouts"></a>Время ожидания для маркеров

С помощью [конфигурации времени жизни маркера](active-directory-configurable-token-lifetimes.md) можно изменить время существования маркеров обновления.  Для маркеров нормальным и ожидаемым является неиспользование (например, если пользователь не открывает приложение в течение 3 месяцев), с соответствующим истечением срока их действия.  В приложениях будут возникать сценарии, в которых сервер входа отклоняет маркер обновления из-за его возраста. 

* MaxInactiveTime: если маркер обновления не использовался в течение времени, указанного в параметре MaxInactiveTime, этот маркер обновления считается недопустимым.
* MaxSessionAge: если MaxAgeSessionMultiFactor или MaxAgeSessionSingleFactor имеют значения, отличные от значений по умолчанию (Until-revoked), то по истечении периода, заданного в параметре MaxAgeSession*, потребуется повторная аутентификация.
* Примеры:
  * Для клиента параметр MaxInactiveTime имеет значение 5 дней. Пользователь провел неделю в отпуске, а значит, в течение 7 дней от него не поступало запросов к Azure AD на получение маркеров. При следующем запросе маркера от этого пользователя выяснится, что маркер обновления уже отозван, а значит, учетные данные нужно ввести заново.
  * Для важных приложений параметр MaxAgeSessionSingleFactor имеет значение 1 день. Если пользователь выполнит вход в понедельник, то по истечении 25 часов (во вторник) ему придется пройти проверку подлинности повторно.

### <a name="revocation"></a>Запрет доступа

Маркеры обновления могут отзываться сервером из-за изменения учетных данных или из-за их использования, или действием администратора.  Маркеры обновления делятся на два класса — те, которые выдаются конфиденциальным клиентам (самый правый столбец) и которые выдаются открытым клиентам (все остальные столбцы).   

| Изменить | Файл cookie на основе пароля | Токен на основе пароля | Файл cookie без использования пароля | Токен без использования пароля | Конфиденциальный маркер клиента |
|---|-----------------------|----------------------|---------------------------|--------------------------|---------------------------|
| Срок действия пароля | Остается активным | Остается активным | Остается активным | Остается активным | Остается активным |
| Пароль изменен пользователем | Отменен | Отменен | Остается активным | Остается активным | Остается активным |
| Пользователь выполняет SSPR | Отменен | Отменен | Остается активным | Остается активным | Остается активным |
| Администратор сбрасывает пароль | Отменен | Отменен | Остается активным | Остается активным | Остается активным |
| Пользователь отменяет свои маркеры обновления [с помощью PowerShell](/powershell/module/azuread/revoke-azureadsignedinuserallrefreshtoken) | Отменен | Отменен | Отменен | Отменен | Отменен |
| Администратор отменяет все маркеры обновления для пользователя [с помощью PowerShell](/powershell/module/azuread/revoke-azureaduserallrefreshtoken) | Отменен | Отменен |Отменен | Отменен | Отменен |
| Единый выход ([v 1.0](../azuread-dev/v1-protocols-openid-connect-code.md#single-sign-out), [v 2.0](v2-protocols-oidc.md#single-sign-out)) в Интернете | Отменен | Остается активным | Отменен | Остается активным | Остается активным |

#### <a name="non-password-based"></a>Не на основе пароля

Имя входа, *не основанное на пароле* , является одним из тех, для которых пользователь не напечатал пароль, чтобы получить его. Примеры входа, не основанные на пароле, включают:

- Использование вашего лица с Windows Hello
- Ключ FIDO2
- SMS
- Голосовая связь
- Пин-код 

> [!NOTE]
> Основные маркеры обновления (PRT) в Windows 10 разделены на основе учетных данных. Например, Windows Hello и пароль имеют собственные основные маркеры обновления, изолированные друг от друга. Когда пользователь входит в систему с помощью учетных данных Hello (ПИН-код или биометрия), а затем изменяет пароль, PRT на основе пароля, полученный ранее, будет отозван. Повторный вход с помощью пароля делает недействительным старый PRT и запрашивает новый.
>
> Маркеры обновления не аннулируются и не отзываются, если они используются для получения нового маркера доступа и маркера обновления.  Однако приложение должно удалить старый маркер, как только он будет использован, и заменить его новым, так как новый маркер имеет новый срок действия. 

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о [`id_tokens` в Azure AD](id-tokens.md).
* Дополнительные сведения о разрешении и согласии (для [версии 1.0](../azuread-dev/v1-permissions-consent.md) и [версии 2.0](v2-permissions-and-consent.md)).
