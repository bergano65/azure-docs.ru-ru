---
title: Настройка утверждений токена SAML для приложения
titleSuffix: Microsoft identity platform
description: Узнайте, как настроить утверждения, выданные платформой идентификации Майкрософт в токене SAML для корпоративных приложений.
services: active-directory
author: kenwith
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: how-to
ms.date: 10/22/2019
ms.author: kenwith
ms.reviewer: luleon, paulgarn, jeedes
ms.custom: aaddev
ms.openlocfilehash: f35e5971374f54940396f602a23ffa0ae3abd015
ms.sourcegitcommit: 1b2d1755b2bf85f97b27e8fbec2ffc2fcd345120
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87552838"
---
# <a name="how-to-customize-claims-issued-in-the-saml-token-for-enterprise-applications"></a>Практическое руководство по настройке утверждений, выпущенных в токене SAML для корпоративных приложений

В настоящее время платформа Microsoft Identity поддерживает единый вход (SSO) с большинством корпоративных приложений, включая приложения, предварительно интегрированные в коллекцию приложений Azure AD, а также пользовательские приложения. Когда пользователь проходит проверку подлинности в приложении через платформу Microsoft Identity, используя протокол SAML 2,0, платформа Microsoft Identity отправляет маркер приложению (через HTTP-запрос POST). Затем приложение проверяет и использует маркер для входа пользователя вместо запроса имени пользователя и пароля. Эти токены SAML содержат элементы информации о пользователе, которые называются *утверждениями*.

*Утверждение* представляет собой информацию, предложенную поставщиком удостоверений, о пользователе в составе токена, выпущенного для этого пользователя. В [токене SAML](https://en.wikipedia.org/wiki/SAML_2.0)эти данные обычно содержит оператор атрибута SAML. А уникальный идентификатор пользователя, как правило, представлен в субъекте SAML, который также называют идентификатором имени.

По умолчанию платформа удостоверений Майкрософт выдает в приложение токен SAML, который содержит `NameIdentifier` утверждение со значением имени пользователя (также известного как имя участника-пользователя) в Azure AD, которое может однозначно идентифицировать пользователя. Маркер SAML включает также дополнительные утверждения, содержащие адрес электронной почты, имя и фамилию пользователя.

Чтобы просмотреть или изменить утверждения, выданные приложению в токене SAML, откройте приложение на портале Azure. Откройте раздел **Атрибуты пользователей и утверждения**.

![Открытие раздела "Утверждения и атрибуты пользователя" на портале Azure](./media/active-directory-saml-claims-customization/sso-saml-user-attributes-claims.png)

Изменение утверждений, выданных в маркере SAML, может потребоваться по двум основным причинам:

* Приложение требует, чтобы утверждение `NameIdentifier` или NameID содержало данные, отличные от имени пользователя (или имени участника-пользователя), которое хранится в Azure AD.
* Приложение требует другого набора URI утверждений или значений утверждений.

## <a name="editing-nameid"></a>Изменение NameID

Чтобы изменить NameID (значение идентификатора имени), сделайте следующее.

1. Откройте страницу **Значение идентификатора имени**.
1. Выберите атрибут или преобразование, которое необходимо применить к атрибуту. При необходимости можно указать формат, который должен использоваться для утверждения NameID.

   ![Измените значение NameID (идентификатор имени)](./media/active-directory-saml-claims-customization/saml-sso-manage-user-claims.png)

### <a name="nameid-format"></a>Формат NameID

Если запрос SAML содержит элемент NameIDPolicy с указанным форматом, платформа Microsoft Identity будет учитывать формат запроса.

Если запрос SAML не содержит элемент для NameIDPolicy, платформа Microsoft Identity выдаст NameID с указанным вами форматом. Если формат не указан, платформа Microsoft Identity будет использовать исходный формат по умолчанию, связанный с выбранным источником утверждений.

В раскрывающемся списке **Выбор формата идентификатора имени** можно выбрать один из следующих вариантов.

| Формат NameID | Описание |
|---------------|-------------|
| **Default** | Платформа Microsoft Identity будет использовать формат источника по умолчанию. |
| **Persistent** | Платформа Microsoft Identity будет использовать persistent в качестве формата NameID. |
| **EmailAddress** | Платформа Microsoft Identity будет использовать EmailAddress в качестве формата NameID. |
| **Unspecified** | Платформа Microsoft Identity будет использовать в качестве формата NameID значение не указано. |
| **WindowsDomainQualifiedName** | Платформа Microsoft Identity будет использовать Виндовсдомаинкуалифиеднаме в качестве формата NameID. |

Также поддерживается временное значение NameID, но оно недоступно в раскрывающемся списке и его нельзя настроить на стороне Azure. Дополнительные сведения об атрибуте NameIDPolicy см. в статье [Протокол единого входа SAML](single-sign-on-saml-protocol.md).

### <a name="attributes"></a>Атрибуты

Выберите нужный источник для утверждения `NameIdentifier` (или NameID). Вы можете выбирать из следующих параметров.

| Имя | Описание |
|------|-------------|
| Email | Адрес электронной почты пользователя |
| userprincipalName | Имя участника-пользователя для данного пользователя |
| onpremisessamaccount | Имя учетной записи SAM, синхронизированное из локального Azure AD |
| objectid | Objectid пользователя в Azure AD |
| employeeid | Идентификатор сотрудника пользователя |
| Расширения каталогов | Расширения каталогов, [синхронизированные из локальной Active Directory с помощью синхронизации Azure AD Connect](../hybrid/how-to-connect-sync-feature-directory-extensions.md) |
| Атрибуты расширения 1–15 | Локальные атрибуты расширения, используемые для расширения схемы Azure AD |

Дополнительные сведения см. в разделе [Табл. 3. Допустимые значения идентификатора для источников](active-directory-claims-mapping.md#table-3-valid-id-values-per-source).

Всем утверждениям, определенным в Azure AD, можно также назначить любые постоянные (статические) значения. Выполните следующие действия, чтобы присвоить постоянное значение.

1. На [портале Azure](https://portal.azure.com/) в разделе **Атрибуты и утверждения пользователя** щелкните значок **Изменить**, чтобы изменить утверждение.

1. Щелкните обязательное утверждение, которое необходимо изменить.

1. Введите постоянное значение без кавычек в поле **Атрибут источника** в соответствии с параметрами вашей организации и нажмите кнопку **Сохранить**.

    ![Открытие раздела "Утверждения и атрибуты пользователя" на портале Azure](./media/active-directory-saml-claims-customization/organization-attribute.png)

1. Постоянное значение будет отображаться, как показано ниже.

    ![Открытие раздела "Утверждения и атрибуты пользователя" на портале Azure](./media/active-directory-saml-claims-customization/edit-attributes-claims.png)

### <a name="special-claims---transformations"></a>Специальные утверждения — преобразования

Вы можете также использовать функции преобразования утверждений.

| Компонент | Описание |
|----------|-------------|
| **ExtractMailPrefix()** | Удаляет суффикс домена из адреса электронной почты или имени участника-пользователя. В таком случае будет извлекаться только первая часть передаваемого имени пользователя (например, joe_smith вместо joe_smith@contoso.com). |
| **Join()** | Присоединяет атрибут к проверенному домену. Если выбранное значение идентификатора пользователя имеет домен, он извлечет имя пользователя для добавления выбранного проверенного домена. Например, если в качестве значения идентификатора пользователя вы выберите адрес электронной почты (joe_smith@contoso.com), а в качестве проверенного домена выберите contoso.onmicrosoft.com, то в результате получите joe_smith@contoso.onmicrosoft.com. |
| **ToLower()** | Преобразует символы выбранного атрибута в символы нижнего регистра. |
| **ToUpper()** | Преобразует символы выбранного атрибута в символы верхнего регистра. |

## <a name="adding-application-specific-claims"></a>Добавление утверждений для конкретного приложения

Чтобы добавить утверждения для конкретного приложения, выполните следующие действия.

1. В разделе **Утверждения и атрибуты пользователя** выберите **Добавить новое утверждение**, чтобы открыть страницу **Управление утверждениями пользователя**.
1. Введите **имя** утверждений. Согласно спецификации SAML значение не обязательно должно строго соответствовать шаблону URI. Если вам нужен шаблон URI, его можно разместить в поле **Пространство имен**.
1. Выберите **источник**, из которого утверждение будет получать свое значение. Вы можете выбрать атрибут пользователя из раскрывающегося списка "Атрибут источника" или применить преобразование к атрибуту пользователя, прежде чем передавать его в качестве утверждения.

### <a name="claim-transformations"></a>Преобразования утверждения

Чтобы применить преобразование к атрибуту пользователя, выполните следующие действия.

1. В разделе **Управление утверждениями** выберите в качестве источника утверждения *Преобразование*, чтобы открыть страницу **Управление преобразованием**.
2. Выберите функцию из раскрывающегося списка преобразований. В зависимости от выбранной функции необходимо указать постоянное значение и параметры, которые будут использоваться для вычисления преобразования. Дополнительные сведения о доступных функциях см. в таблице ниже.
3. Чтобы применить множественное преобразование, щелкните **Добавить преобразование**. К утверждению можно применить не более двух преобразований. Например, вы можете сначала извлечь префикс электронной почты для `user.mail`. Затем преобразуйте строку в верхний регистр.

   ![Измените значение NameID (идентификатор имени)](./media/active-directory-saml-claims-customization/sso-saml-multiple-claims-transformation.png)

Для преобразования утверждений можно использовать следующие функции.

| Компонент | Описание |
|----------|-------------|
| **ExtractMailPrefix()** | Удаляет суффикс домена из адреса электронной почты или имени участника-пользователя. В таком случае будет извлекаться только первая часть передаваемого имени пользователя (например, joe_smith вместо joe_smith@contoso.com). |
| **Join()** | Создает новое значение путем соединения двух атрибутов. При необходимости можно использовать разделитель между двумя атрибутами. Для преобразования утверждения NameID соединение ограничено проверенным доменом. Если выбранное значение идентификатора пользователя имеет домен, он извлечет имя пользователя для добавления выбранного проверенного домена. Например, если в качестве значения идентификатора пользователя вы выберите адрес электронной почты (joe_smith@contoso.com), а в качестве проверенного домена выберите contoso.onmicrosoft.com, то в результате получите joe_smith@contoso.onmicrosoft.com. |
| **ToLower()** | Преобразует символы выбранного атрибута в символы нижнего регистра. |
| **ToUpper()** | Преобразует символы выбранного атрибута в символы верхнего регистра. |
| **Contains()** | Выводит атрибут или константу, если входные данные соответствуют указанному значению. В противном случае при отсутствии совпадений можно указать другие выходные данные.<br/>Допустим, например, что необходимо создать утверждение, где значение является адресом электронной почты пользователя, если этот адрес содержит домен "@contoso.com". В противном случае должно выводиться имя участника-пользователя. Для этого необходимо настроить следующие значения:<br/>*Параметр 1 (входные данные)* : user.email<br/>*Значение*: "@contoso.com"<br/>Параметр 2 (выходные данные): user.email<br/>Параметр 3 (выходные данные при отсутствии совпадений): user.userprincipalname |
| **EndWith()** | Выводит атрибут или константу, если входные данные заканчиваются указанным значением. В противном случае при отсутствии совпадений можно указать другие выходные данные.<br/>Допустим, например, что необходимо создать утверждение, где значение является идентификатором сотрудника для пользователя, если этот идентификатор сотрудника заканчивается на "000". В противном случае должен выводиться атрибут расширения. Для этого необходимо настроить следующие значения:<br/>*Параметр 1 (входные данные)* : user.employeeid<br/>*Value* (Значение): "000"<br/>Параметр 2 (выходные данные): user.employeeid<br/>Параметр 3 (выходные данные при отсутствии совпадений): user.extensionattribute1 |
| **StartWith()** | Выводит атрибут или константу, если входные данные начинаются указанным значением. В противном случае при отсутствии совпадений можно указать другие выходные данные.<br/>Допустим, например, что необходимо создать утверждение, где значение является идентификатором сотрудника для пользователя, если страна или регион сотрудника начинается с "RF". В противном случае должен выводиться атрибут расширения. Для этого необходимо настроить следующие значения:<br/>*Параметр 1 (входные данные)* : user.country<br/>*Value* (Значение): "RF"<br/>Параметр 2 (выходные данные): user.employeeid<br/>Параметр 3 (выходные данные при отсутствии совпадений): user.extensionattribute1 |
| **Extract() — после сопоставления** | Возвращает подстроку после ее сопоставления с указанным значением.<br/>Например, если входное значение — "Finance_BSimon", соответствующее значение равно "Finance_", то выходным значением утверждения будет "BSimon". |
| **Extract() — до сопоставления** | Возвращает подстроку до ее сопоставления с указанным значением.<br/>Например, если входное значение — "BSimon_RF", соответствующее значение равно "_RF", то выходным значением утверждения будет "BSimon". |
| **Extract() — между сопоставлениями** | Возвращает подстроку до ее сопоставления с указанным значением.<br/>Например, если входное значение — "Finance_BSimon_US", первое соответствующее значение равно "Finance_", второе соответствующее значение равно "_RF", то выходным значением утверждения будет "BSimon". |
| **ExtractAlpha() — префикс** | Возвращает буквенный префикс строки.<br/>Например, если входное значение равно "BSimon_123", то возвращается "BSimon". |
| **ExtractAlpha() — суффикс** | Возвращает буквенный суффикс строки.<br/>Например, если входное значение равно "123_Simon", то возвращается "Simon". |
| **ExtractNumeric() — префикс** | Возвращает числовой префикс строки.<br/>Например, если входное значение равно "123_BSimon", то возвращается "123". |
| **ExtractNumeric() — суффикс** | Возвращает числовой суффикс строки.<br/>Например, если входное значение равно "BSimon_123", то возвращается "123". |
| **IfEmpty()** | Выводит атрибут или константу, если входные данные пусты или имеют значение NULL.<br/>Предположим, например, что вы хотите вывести атрибут, хранящийся в extensionattribute, если идентификатор сотрудника для данного пользователя пуст. Для этого необходимо настроить следующие значения:<br/>Параметр 1 (входные данные): user.employeeid<br/>Параметр 2 (выходные данные): user.extensionattribute1<br/>Параметр 3 (выходные данные при отсутствии совпадений): user.employeeid |
| **IfNotEmpty()** | Выводит атрибут или константу, если входные данные не пусты и не равны NULL.<br/>Предположим, например, что вы хотите вывести атрибут, хранящийся в extensionattribute, если идентификатор сотрудника для данного пользователя не пуст. Для этого необходимо настроить следующие значения:<br/>Параметр 1 (входные данные): user.employeeid<br/>Параметр 2 (выходные данные): user.extensionattribute1 |

Если вам нужны дополнительные преобразования, поделитесь своей идеей [на форуме для обратной связи в Azure AD](https://feedback.azure.com/forums/169401-azure-active-directory?category_id=160599) в категории *Приложение SaaS*.

## <a name="emitting-claims-based-on-conditions"></a>Создание утверждений на основе условий

Вы можете указать источник утверждения на основе типа пользователя и группы, к которой он принадлежит. 

Ниже перечислены возможные типы пользователя.
- **Любой**. Всем пользователям разрешен доступ к приложению.
- **Члены**. Собственный член клиента.
- **Все гости**. Пользователь подключается из внешней организации с Azure AD или без.
- **Гости AAD**. Гостевой пользователь входит в другую организацию, использующую Azure AD.
- **Внешние гости**. Гостевой пользователь принадлежит внешней организации, не имеющей Azure AD.


Одним из сценариев, в которых удобно использовать такую возможность, является ситуация, когда при обращении к приложению гостя и сотрудника источник утверждения для них отличается. Возможно, потребуется указать, что если пользователь является сотрудником, то источником NameID является user.email, а если пользователь гость, то источником NameID является user.extensionattribute1.

Чтобы добавить условие утверждения, выполните следующие действия.

1. В разделе **Управление утверждениями** разверните условия утверждения.
2. Выберите тип пользователя.
3. Выберите группы, к которым должен принадлежать пользователь. Можно выбрать до 50 уникальных групп для всех утверждений для заданного приложения. 
4. Выберите **источник**, из которого утверждение будет получать свое значение. Вы можете выбрать атрибут пользователя из раскрывающегося списка "Атрибут источника" или применить преобразование к атрибуту пользователя, прежде чем передавать его в качестве утверждения.

Порядок добавления условий важен. При определении значения, которое будет выводиться в утверждении, Azure AD оценивает условия сверху вниз. 

Например, Britta Simon является гостевым пользователем в клиенте Contoso. Она принадлежит другой организации, которая также использует Azure AD. Учитывая приведенную ниже конфигурацию для приложения Fabrikam, когда Britta пытается войти в Fabrikam, платформа Microsoft Identity вычислит условия следующим образом.

Во-первых, платформа Microsoft Identity проверяет, имеет ли тип пользователя Britta значение `All guests` . Так как это так, платформа идентификации Майкрософт назначает источник утверждения `user.extensionattribute1` . Во-вторых, платформа Microsoft Identity проверяет, имеет ли тип пользователя Britta значение `AAD guests` , так как это также верно и в том, что платформа идентификации Майкрософт назначает источник для утверждения `user.mail` . Наконец, для Britta создается утверждение со значением `user.mail`.

![Условная конфигурация утверждений](./media/active-directory-saml-claims-customization/sso-saml-user-conditional-claims.png)

## <a name="next-steps"></a>Дальнейшие действия

* [Управление приложениями с помощью Azure Active Directory](../manage-apps/what-is-application-management.md)
* [Настройка федеративного единого входа для приложения не из коллекции](../manage-apps/configure-federated-single-sign-on-non-gallery-applications.md)
* [Устранение неполадок единого входа на основе SAML](../azuread-dev/howto-v1-debug-saml-sso-issues.md)
