---
title: Создание мультитенантной управляющей программы, которая использует конечную точку платформы удостоверений Майкрософт
description: Из этого учебника вы узнаете, как вызвать веб-API ASP.NET, защищенный с помощью Azure Active Directory, из классического приложения для Windows (WPF). Клиент WPF выполняет проверку подлинности пользователя, запрашивает маркер доступа и вызывает веб-API.
services: active-directory
documentationcenter: dev-center-name
author: jmprieur
manager: CelesteDG
editor: ''
ms.assetid: ''
ms.service: active-directory
ms.subservice: develop
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 11/20/2019
ms.author: jmprieur
ms.custom: aaddev, identityplatformtop40, scenarios:getting-started, languages:ASP.NET
ms.collection: M365-identity-device-management
ms.openlocfilehash: d130a962c14415c417eedecd6ae26af1131b2e86
ms.sourcegitcommit: d614a9fc1cc044ff8ba898297aad638858504efa
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2019
ms.locfileid: "74997026"
---
# <a name="build-a-multitenant-daemon-that-uses-the-microsoft-identity-platform-endpoint"></a>Создание мультитенантной управляющей программы, которая использует конечную точку платформы удостоверений Майкрософт

В этом учебнике вы узнаете, как использовать платформу удостоверений Майкрософт для доступа к данным бизнес-клиентов Майкрософт с использованием продолжительного неинтерактивного процесса. Пример управляющей программы использует [предоставление учетных данных клиента OAuth2](v2-oauth2-client-creds-grant-flow.md) для получения маркера доступа. Затем управляющая программа использует этот маркер для вызова [Microsoft Graph](https://graph.microsoft.io) и доступа к данным организации.

Это приложение создается в формате приложения ASP.NET MVC. Для входа пользователей в нем используется ПО промежуточного слоя OWIN для OpenID Connect.  

Компонент управляющей программы в этом примере является контроллером API `SyncController.cs`. При вызове этот контроллер извлекает список пользователей в арендаторе Azure Active Directory (Azure AD) клиента из Microsoft Graph. `SyncController.cs` активируется AJAX-вызовом в веб-приложении. Контроллер использует [библиотеку аутентификации Майкрософт (MSAL) для .NET](msal-overview.md), чтобы получить маркер доступа для Microsoft Graph.

Более простой пример консольной управляющей программы вы найдете в статье [Краткое руководство. Получение маркера безопасности и вызов API Microsoft Graph из консольного приложения с помощью удостоверения приложения](quickstart-v2-netcore-daemon.md).

## <a name="scenario"></a>Сценарий

Так как это мультитенантное приложение, предназначенное для использования любым корпоративным клиентом Майкрософт, оно должно предоставить клиентам возможность зарегистрироваться или подключить приложение к данным организации. В рамках потока подключения администратор компании сначала напрямую предоставляет *разрешения* приложению, чтобы оно могло получать доступ к данным компании неинтерактивным способом (при отсутствии пользователя, выполнившего вход). В большей части логики в этом примере показано, как реализовать этот поток подключения с помощью конечной точки предоставления [согласия администратора](v2-permissions-and-consent.md#using-the-admin-consent-endpoint) платформы удостоверений.

![Топология](./media/tutorial-v2-aspnet-daemon-webapp/topology.png)

Дополнительные сведения об основных понятиях, используемых в этом примере, см. в [документации по протоколу учетных данных клиента для конечной точки платформы удостоверений](v2-oauth2-client-creds-grant-flow.md).

## <a name="prerequisites"></a>Предварительные требования

Чтобы запустить пример в этом кратком руководстве, вам потребуется:

- [Visual Studio 2017 или 2019.](https://visualstudio.microsoft.com/downloads/)
- Клиент Azure AD. Дополнительные сведения см. в статье о том, [как получить клиент Azure AD](quickstart-create-new-tenant.md).
- Одна или несколько учетных записей пользователей в арендаторе Azure AD. Этот пример не будет работать с учетной записью Майкрософт (ранее она называлась учетной записью Windows Live). Если вы вошли на [портал Azure](https://portal.azure.com) с учетной записью Майкрософт и ранее не создавали учетную запись пользователя в каталоге, ее необходимо создать сейчас.

## <a name="clone-or-download-this-repository"></a>Клонирование или скачивание этого репозитория

В оболочке или командной строке введите такую команду:

```Shell
git clone https://github.com/Azure-Samples/active-directory-dotnet-daemon-v2.git
```

Вы также можете [скачать пример в виде ZIP-файла](https://github.com/Azure-Samples/ms-identity-aspnet-daemon-webapp/archive/master.zip).

## <a name="register-the-sample-application-with-your-azure-ad-tenant"></a>Регистрация примера приложения в арендаторе Azure AD

Этот пример содержит один проект. Чтобы зарегистрировать его, выполните одно из следующих действий:

- Выполните шаги, описанные в разделах [Регистрация примера приложения в арендаторе Azure AD](#register-the-sample-application-with-your-azure-ad-tenant) и [Настройка примера для использования арендатора Azure AD](#choose-the-azure-ad-tenant).
- Используйте скрипты PowerShell, которые:
  - *автоматически* создают приложения Azure AD и связанные объекты (пароли, разрешения и зависимости);
  - изменяют файлы конфигурации проектов Visual Studio.

Если вы хотите использовать автоматизацию, сделайте следующее:

1. В Windows запустите PowerShell и перейдите в корень клонированного каталога.
1. Выполните следующую команду:

   ```PowerShell
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process -Force
   ```

1. Запустите скрипт, чтобы создать приложение Azure AD и соответствующим образом настройте код примера приложения.

   ```PowerShell
   .\AppCreationScripts\Configure.ps1
   ```

   Другие способы выполнения скриптов описаны в статье о [скриптах создания приложения](https://github.com/Azure-Samples/ms-identity-aspnet-daemon-webapp/blob/master/AppCreationScripts/AppCreationScripts.md).

1. Откройте решение Visual Studio и щелкните **Пуск**, чтобы выполнить код.

Если вы не хотите использовать автоматизацию, выполните шаги из следующих разделов.

### <a name="choose-the-azure-ad-tenant"></a>Выбор арендатора Azure AD

1. Войдите на [портал Azure](https://portal.azure.com) с помощью личной учетной записи Майкрософт либо рабочей или учебной учетной записи.
1. Если ваша учетная запись относится к нескольким арендаторам Azure AD, выберите профиль в меню в верхней части страницы, а затем **переключите каталог**.
1. Измените сеанс портала на нужный клиент Azure AD.

### <a name="register-the-client-app-dotnet-web-daemon-v2"></a>Зарегистрируйте клиентское приложение (dotnet-web-daemon-v2).

1. Перейдите на страницу [Регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) платформы удостоверений Майкрософт для разработчиков.
1. Выберите **Новая регистрация**.
1. После появления страницы **Регистрация приложения** введите сведения о регистрации приложения:
   - В разделе **Имя** введите понятное имя приложения, которое будет отображаться пользователям приложения. Например, введите **dotnet-web-daemon-v2**.
   - В разделе **Поддерживаемые типы учетных записей** выберите **Учетные записи в любом каталоге организации**.
   - В разделе **URI перенаправления (необязательно)** выберите **Интернет** в поле со списком и введите следующие URI перенаправления:
       - **https://localhost:44316/**
       - **https://localhost:44316/Account/GrantPermissions**
          
     Если у вас более двух URI перенаправления, их придется добавить на вкладке **Проверка подлинности** позднее, после успешного создания приложения.
1. Выберите **Зарегистрировать**, чтобы создать приложение.
1. На странице приложения **Обзор** найдите **идентификатор приложения (клиента)** и запишите его, чтобы использовать позже. Он понадобится для настройки файла конфигурации Visual Studio для этого проекта.
1. В списке страниц приложения выберите **Проверка подлинности**. Затем сделайте следующее:
   - В разделе **Дополнительные параметры** задайте для параметра **URL-адрес выхода** значение **https://localhost:44316/Account/EndSession** .
   - В разделе **Дополнительные параметры** > **Неявное предоставление** установите флажки **Маркеры доступа** и **Токен идентификатора**. Для этого примера должен быть включен [поток неявного предоставления](v2-oauth2-implicit-grant-flow.md), чтобы пользователь мог входить в систему и вызывать API.
1. Щелкните **Сохранить**.
1. На странице **Сертификаты и секреты** в разделе **Секреты клиента** щелкните **Новый секрет клиента**. Затем сделайте следующее:

   1. Введите описание ключа (например, **секрет приложения**).
   1. Выберите срок действия ключа **1 год**, **2 года** или **Срок действия неограничен**.
   1. Нажмите кнопку **Добавить**. 
   1. Когда отобразится значение ключа, скопируйте его и сохраните в безопасном месте. Этот ключ потребуется позже для настройки проекта в Visual Studio. Он больше не будет отображаться, и его невозможно получить каким-либо другим способом.
1. В списке страниц приложения выберите **Разрешения API**. Затем сделайте следующее:
   1. Нажмите кнопку **Add a permission** (Добавить разрешение).
   1. Убедитесь, что выбрана вкладка **API Майкрософт**.
   1. В разделе **Часто используемые интерфейсы API Microsoft** выберите **Microsoft Graph**.
   1. В разделе **Разрешения приложений** убедитесь, что выбраны нужные разрешения: **User.Read.All**.
   1. Нажмите кнопку **Add permissions** (Добавить разрешения).

## <a name="configure-the-sample-to-use-your-azure-ad-tenant"></a>Настройка примера для использования арендатора Azure AD

На следующих шагах значение **ClientID** совпадает с идентификатором приложения (**AppId**).

Откройте решение в Visual Studio, чтобы настроить проекты.

### <a name="configure-the-client-project"></a>Настройка клиентского проекта

Если вы использовали скрипты установки, будут применены следующие изменения.

1. Откройте файл **UserSync\Web.Config**.
1. Найдите ключ приложения **Ida:ClientId**. Замените существующее значение идентификатором для приложения **dotnet-web-daemon-v2**, скопированным на портале Azure.
1. Найдите ключ приложения **ida:ClientSecret**. Замените существующее значение ключом, который вы сохранили во время создания приложения **dotnet-web-daemon-v2** на портале Azure.

## <a name="run-the-sample"></a>Запуск примера

Очистите решение, повторно создайте его, запустите приложение UserSync и войдите в систему от имени администратора в арендаторе Azure AD. Если у вас нет арендатора Azure AD для тестирования, [выполните эти инструкции](quickstart-create-new-tenant.md), чтобы получить его.

Когда вы будете входить в систему, приложение сначала запросит у вас разрешение на вход и чтение профиля пользователя. Это согласие подтверждает для приложения, что вы являетесь бизнес-пользователем.

![предоставление согласия пользователем.](./media/tutorial-v2-aspnet-daemon-webapp/firstconsent.png)

Затем приложение пытается синхронизировать список пользователей из арендатора Azure AD через Microsoft Graph. Если это не удастся, вам (администратору арендатора) будет предложено подключить арендатор к приложению.

Затем приложение запросит разрешение на чтение списка пользователей в арендаторе.

![Согласие администратора](./media/tutorial-v2-aspnet-daemon-webapp/adminconsent.PNG)

После предоставления разрешений выполняется выход из приложения. Выход нужен для того, чтобы удалить из кэша маркеров все существующие маркеры доступа для Microsoft Graph. Когда вы войдете в следующий раз, вы получите новый маркер с разрешениями для выполнения вызовов к Microsoft Graph.


Получив от вас разрешения, приложение может запрашивать данные пользователей в любой момент. Это можно проверить, нажав кнопку **Синхронизация пользователей** и обновив список пользователей. Попробуйте добавить или удалить пользователя и повторно синхронизировать список. (Обратите внимание, что приложение синхронизирует только первую страницу списка пользователей.)

## <a name="about-the-code"></a>Примечания о коде

Соответствующий код для этого примера находится в следующих файлах:

- **App_Start\Startup.Auth.cs**, **Controllers\AccountController.cs**: начальный вход. В частности, действия на контроллере имеют атрибут **Authorize**, который обеспечивает принудительный вход пользователя в систему. Приложение использует [поток кода авторизации](v2-oauth2-auth-code-flow.md) для входа пользователя.
- **Controllers\SyncController.cs**: синхронизация списка пользователей с локальным хранилищем в памяти.
- **Controllers\UserController.cs**: отображение списка пользователей из локального хранилища в памяти.
- **Controllers\AccountController.cs**: получение разрешений от администратора арендатора с помощью конечной точки предоставления согласия администратора.

## <a name="re-create-the-sample-app"></a>Повторное создание примера приложения

1. Создайте в Visual Studio новый проект **веб-приложения ASP.NET (платформа .NET)** для **Visual C#** . 
1. На следующем экране выберите шаблон проекта **MVC**. Добавьте также папку и ссылки на основные компоненты для **веб-API**, так как позднее вы добавите контроллер веб-API. Сохраните выбранный по умолчанию режим проверки подлинности проекта: **Без аутентификации**.
1. Выберите проект в окне **обозревателя решений** и нажмите клавишу **F4**. 
1. В свойствах проекта задайте для параметра **SSL включен** значение **True**. Обратите внимание на значение **URL-адрес SSL**. Оно понадобится при настройке регистрации этого приложения на портале Azure.
1. Добавьте следующие пакеты NuGet для ПО промежуточного слоя OWIN для ASP.NET. 
   - Microsoft.Owin.Security.ActiveDirectory
   - Microsoft.Owin.Security.Cookies
   - Microsoft.Owin.Host.SystemWeb
   - Microsoft.IdentityModel.Protocol.Extensions
   - Microsoft.Owin.Security.OpenIdConnect
   - Microsoft.Identity.Client 
1. В папке **App_Start** сделайте следующее:
   1. Создайте класс с именем **Startup.Auth.cs**. 
   1. Удалите **.App_Start** из имени пространства имен. 
   1. Замените код класса **Startup** кодом из аналогичного файла в примере приложения.       
   Полностью скопируйте все определение класса. В определении вместо **public class Startup** теперь указано **public partial class Startup**.
1. В файле **Startup.Auth.cs** разрешите отсутствующие ссылки, добавив инструкции **using**, которые предложит Visual Studio IntelliSense.
1. Щелкните проект правой кнопкой мыши, а затем выберите **Добавить** и **Класс**.
1. В поле поиска введите **OWIN**. В качестве выделенного фрагмента отобразится **класс запуска OWIN**. Выберите его и присвойте классу имя **Startup.cs**.
1. В файле **Startup.cs** замените код класса **Startup** кодом из аналогичного файла в примере приложения. В этом определении также вместо **public class Startup** теперь указано **public partial class Startup**.
1. В папке **Models** добавьте новый класс с именем **MsGraphUser.cs**. Замените реализацию содержимым файла с тем же именем из примера.
1. Добавьте новый экземпляр **Контроллер MVC 5 — пустой** с именем **AccountController**. Замените реализацию содержимым файла с тем же именем из примера.
1. Добавьте новый экземпляр **Контроллер MVC 5 — пустой** с именем **UserController**. Замените реализацию содержимым файла с тем же именем из примера.
1. Добавьте новый экземпляр **Контроллер Web API 2 — пустой** с именем **SyncController**. Замените реализацию содержимым файла с тем же именем из примера.
1. Для пользовательского интерфейса в папке **Views\Account** добавьте три **пустых представления (без модели)** с именами **GrantPermissions**, **Index** и **UserMismatch**. Еще одно с именем **Index** добавьте в папку **Views\User**. Замените реализацию содержимым файла с тем же именем из примера.
1. Обновите файлы **Shared\_Layout.cshtml** и **Home\Index.cshtml**, чтобы правильно связать разные представления.

## <a name="deploy-the-sample-to-azure"></a>Развертывание примера в Azure

Этот проект содержит проекты веб-приложения и веб-API. Чтобы развернуть их на веб-сайтах Azure, выполните следующие шаги для каждого из них:

1. Создайте веб-сайт Azure.
1. Опубликуйте на этом веб-сайте веб-приложение и веб-API.
1. Измените клиенты, чтобы они вызвали этот веб-сайт вместо IIS Express.

### <a name="create-and-publish-dotnet-web-daemon-v2-to-an-azure-website"></a>Создание и публикация dotnet-web-daemon-v2 на веб-сайте Azure

1. Войдите на [портале Azure](https://portal.azure.com).
1. В нижнем левом углу щелкните **Создать ресурс**.
1. Выберите **Интернет** > **Веб-приложение** и присвойте веб-сайту имя. Например, **dotnet-web-daemon-v2-contoso.azurewebsites.net**.
1. Заполните поля **Подписка**, **Группа ресурсов**, а также **Расположение или план службы приложений**- Для параметра **Операционная система** укажите **Windows**, а для параметра **Публиковать** — значение **Код**.
1. Щелкните **Создать** и дождитесь создания службы приложений.
1. Когда появится уведомление **Развертывание выполнено**, щелкните **Перейти к ресурсу**, чтобы перейти к созданной службе приложений.
1. После создания веб-сайта найдите его на **панели мониторинга** и щелкните, чтобы открыть окно **Обзор** для службы приложений.
1. На этой вкладке **Обзор** службы приложений скачайте профиль публикации, щелкнув ссылку **Скачать профиль публикации**, и сохраните его. Вы также можете использовать другие механизмы развертывания, например развертывание из системы управления версиями.
1. Откройте Visual Studio и сделайте следующее:
   1. Перейдите к проекту **dotnet-web-daemon-v2**. 
   1. В обозревателе решений щелкните правой кнопкой мыши проект и выберите **Опубликовать**.
   1. Щелкните **Импортировать профиль** на нижней панели и импортируйте скачанный ранее профиль публикации.
1. Нажмите кнопку **Настроить**.
1. На вкладке **Подключение** измените значение URL-адреса назначения, чтобы в нем был указан протокол HTTPS. Например, укажите [https://dotnet-web-daemon-v2-contoso.azurewebsites.net](https://dotnet-web-daemon-v2-contoso.azurewebsites.net). Щелкните **Далее**.
1. На вкладке **Параметры** убедитесь, что снят флажок **Включение аутентификации в организации**.  
1. Щелкните **Сохранить**. Щелкните **Опубликовать** на главном экране.

Visual Studio опубликует проект и автоматически откроет в браузере страницу с URL-адресом этого проекта. Если вы увидите стандартную веб-страницу проекта, значит публикация прошла успешно.

### <a name="update-the-azure-ad-tenant-application-registration-for-dotnet-web-daemon-v2"></a>Обновление регистрации приложения dotnet-web-daemon-v2 в арендаторе Azure AD

1. Вернитесь на [портал Azure](https://portal.azure.com).
1. На панели слева выберите службу **Azure Active Directory**, а затем щелкните **Регистрация приложений**.
1. Выберите приложение **dotnet-web-daemon-v2**.
1. На странице **Проверка подлинности** приложения обновите поля **URL-адрес выхода**, указав адрес службы. Например, укажите [https://dotnet-web-daemon-v2-contoso.azurewebsites.net](https://dotnet-web-daemon-v2-contoso.azurewebsites.net).
1. В меню **Фирменная символика** измените **URL-адрес домашней страницы** на адрес службы. Например, укажите [https://dotnet-web-daemon-v2-contoso.azurewebsites.net](https://dotnet-web-daemon-v2-contoso.azurewebsites.net).
1. Сохраните конфигурацию.
1. Добавьте тот же URL-адрес в список значений в меню **Проверка подлинности** > **URI перенаправления**. При наличии нескольких URL-адресов перенаправления убедитесь, что для каждого из них есть новая запись, в которой указан соответствующий URI службы приложений.

## <a name="community-help-and-support"></a>Справка и поддержка в сообществе

Для получения поддержки от сообщества используйте [Stack Overflow](http://stackoverflow.com/questions/tagged/msal).
Задайте вопросы на сайте Stack Overflow и просмотрите имеющиеся проблемы, чтобы узнать, не задавал ли кто-то аналогичные вопросы раньше.
Пометьте вопросы и комментарии тегами "adal", "msal" и "dotnet".

Если вы найдете ошибку в примере, напишите о ней в [разделе проблем на сайте GitHub](https://github.com/Azure-Samples/ms-identity-aspnet-daemon-webapp/issues).

Если в MSAL.NET обнаружена ошибка, напишите об этой ошибке в разделе [проблем с MSAL.NET на сайте GitHub](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/issues).

Чтобы предоставить рекомендацию, откройте страницу [форума User Voice](https://feedback.azure.com/forums/169401-azure-active-directory).

## <a name="next-steps"></a>Дополнительная информация
Дополнительные сведения о различных потоках проверки подлинности и сценариях приложений, поддерживаемых платформой идентификации Майкрософт, см. [здесь](authentication-flows-app-scenarios.md).

Дополнительные сведения см. в следующей документации:

- [Tenancy in Azure Active Directory](single-and-multi-tenant-apps.md) (Аренда в Azure Active Directory)
- [Основные сведения о процедуре предоставления согласия для приложений Azure AD](application-consent-experience.md)
- [Sign in any Azure Active Directory user using the multi-tenant application pattern](howto-convert-app-to-be-multi-tenant.md) (Реализация входа любого пользователя Azure Active Directory с помощью шаблона мультитенантного приложения)
- [Understand user and admin consent](howto-convert-app-to-be-multi-tenant.md#understand-user-and-admin-consent) (Получение согласия пользователя и администратора)
- [Application and service principal objects in Azure Active Directory](app-objects-and-service-principals.md) (Объекты приложения и субъекта-службы в Azure Active Directory)
- [Краткое руководство Регистрация приложения с помощью платформы удостоверений Майкрософт](quickstart-register-app.md)
- [Краткое руководство Настройка клиентского приложения для доступа к веб-API](quickstart-configure-app-access-web-apis.md)
- [Public client and confidential client applications](msal-client-applications.md) (Общедоступные клиентские и конфиденциальные клиентские приложения)

Более простой пример мультитенантной консольной управляющей программы вы найдете в статье [Краткое руководство. Получение маркера безопасности и вызов API Microsoft Graph из консольного приложения с помощью удостоверения приложения](quickstart-v2-netcore-daemon.md).
