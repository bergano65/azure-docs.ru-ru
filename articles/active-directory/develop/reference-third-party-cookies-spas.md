---
title: Как управлять интеллектуальной защитой от слежения (ITP) в Safari | Azure
titleSuffix: Microsoft identity platform
description: Проверка подлинности одностраничного приложения (SPA) при запрете сторонних файлов cookie.
services: active-directory
author: hpsin
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: how-to
ms.date: 05/19/2020
ms.author: hirsin
ms.reviewer: kkrishna
ms.custom: aaddev
ms.openlocfilehash: cc93f4062851f01dd127c108ca60bc240a1940e6
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "87311761"
---
# <a name="handle-itp-in-safari-and-other-browsers-where-third-party-cookies-are-blocked"></a>Работа с ITP в Safari и других браузерах с блокировкой сторонних файлов cookie

Сегодня многие браузеры блокируют сторонние файлы cookie, использующиеся для запросов к доменам, которые отличаются от отображаемых в строке браузера. Это приводит к прерыванию неявного потока и требует наличия новых шаблонов проверки подлинности для успешного входа пользователей. На платформе удостоверений Майкрософт мы используем поток авторизации с PKCE и маркерами обновления для сохранения пользователей в системе после входа в случае, когда сторонние файлы cookie блокируются.

## <a name="what-is-intelligent-tracking-protection-itp"></a>Что такое интеллектуальная защита от слежения (ITP)?

В Apple Safari есть функция защиты конфиденциальности по умолчанию, которая называется [интеллектуальной защитой от слежения](https://webkit.org/tracking-prevention-policy/) или *ITP*. ITP блокирует сторонние файлы cookie, которые нужны для выполнения запросов между доменами.

Общая форма отслеживания пользователей выполняется путем загрузки iFrame на сторонний сайт в фоновом режиме и использования файлов cookie для сопоставления пользователя через Интернет. К сожалению, этот шаблон также является стандартным способом реализации [неявных потоков](v2-oauth2-implicit-grant-flow.md) в одностраничных приложениях. Если браузер блокирует сторонние файлы cookie для предотвращения отслеживания пользователей, одностраничные приложения также не работают.

Сторонние файлы cookie блокируются для повышения конфиденциальности пользователей не только в Safari. В веб-браузере Brave сторонние файлы cookie заблокированы по умолчанию, а в Chromium (платформа для Google Chrome и Microsoft Edge) также планируется прекращение поддержки сторонних файлов cookie.

Решение, описанное в этой статье, работает во всех этих и других браузерах с заблокированными сторонними файлами cookie.

## <a name="overview-of-the-solution"></a>Общие сведения о решении

Чтобы продолжить проверку подлинности пользователей в одностраничных приложениях, их разработчики должны использовать [поток кода авторизации](v2-oauth2-auth-code-flow.md). В потоке кода авторизации поставщик удостоверений выдает код, а SPA активирует его для маркера доступа и маркера обновления. Если приложению требуются дополнительные маркеры, для их получения оно может использовать [поток маркеров обновления](v2-oauth2-auth-code-flow.md#refresh-the-access-token). Библиотека платформы удостоверений Майкрософт для одностраничных приложений MSAL.js 2.0 реализует поток кода авторизации для SPA и является готовой заменой MSAL.js 1.x (при незначительных обновлениях).

Для платформы удостоверений Майкрософт одностраничные приложения и собственные клиенты используют аналогичные правила протокола:

* Используется [запрос кода PKCE](https://tools.ietf.org/html/rfc7636)
    * PKCE *является обязательным* для одностраничных приложений на платформе удостоверений Майкрософт. PKCE *рекомендуется* для собственных и конфиденциальных клиентов.
* Секрет клиента не используется

Одностраничные приложения имеют два дополнительных ограничения:

* [URI перенаправления необходимо отметить как тип `spa`](v2-oauth2-auth-code-flow.md#redirect-uri-setup-required-for-single-page-apps), чтобы включить CORS для конечных точек входа.
* Время существования маркеров обновления, выданных с помощью потока кода авторизации в URI перенаправления `spa`, составляет 24 часа, а не 90 дней.

![Поток кода для приложений SPA](media/v2-oauth-auth-code-spa/active-directory-oauth-code-spa.png)

## <a name="performance-and-ux-implications"></a>Влияние производительности и пользовательского интерфейса

Некоторые приложения, использующие неявный поток, предпринимают попытку выполнить вход без перенаправления, открывая iFrame для входа с помощью `prompt=none`. В большинстве браузеров на этот запрос будут отправляться маркеры для текущего вошедшего в систему пользователя (при условии, что согласие уже предоставлено). В этом шаблоне приложениям не надо было полностраничное перенаправление для входа пользователя в систему, что повышало производительность и удобство работы пользователя, так как при посещении веб-страницы он уже выполнял вход. Поскольку `prompt=none` в iFrame больше нет, в случае блокировки сторонних файлов cookie приложения должны перейти на страницу входа во фрейме верхнего уровня, чтобы получить код авторизации.

Выполнить вход можно двумя способами:

* **Полностраничные перенаправления**
    * При первой загрузке SPA перенаправьте пользователя на страницу входа, если сеанс еще не существует (или истек срок его действия). Браузер пользователя откроет страницу входа, представит файлы cookie, содержащие пользовательский сеанс, а затем перенаправит пользователя обратно в приложение с кодом и маркерами во фрагменте.
    * В результате перенаправления SPA загружается дважды. Чтобы избежать этого, выполните рекомендации по кэшированию одностраничных приложений.
    * Рассмотрите возможность последовательности предварительной загрузки в приложении, которая проверяет наличие сеанса входа и перенаправляет на страницу входа, прежде чем приложение полностью распакует и выполнит полезные данные JavaScript.
* **Всплывающие окна**
    * Если взаимодействие с пользователем (UX) при полностраничном перенаправлении не работает для приложения, рассмотрите возможность использования всплывающего окна для обработки аутентификации.
    * После того, как всплывающее окно завершит перенаправление в приложение после проверки подлинности, код в обработчике перенаправления сохранит код и маркеры в локальном хранилище для использования приложением. MSAL.js поддерживает всплывающие окна для проверки подлинности, как и большинство библиотек.
    * Браузеры ограничивают поддержку всплывающих окон, поэтому они могут быть не самым надежным вариантом. Для удовлетворения требований браузера может потребоваться взаимодействие пользователя и SPA перед созданием всплывающего окна.

>[!NOTE]
> Компания Apple [описывает метод всплывающего окна](https://webkit.org/blog/8311/intelligent-tracking-prevention-2-0/) как временное исправление совместимости, чтобы предоставить исходному окну доступ к сторонним файлам cookie. Хотя компания Apple может удалить передачу разрешений в будущем, это не повлияет на указанные здесь рекомендации. Мы используем всплывающее окно в качестве первой части перехода к странице входа, чтобы найти сеанс и указать код авторизации. Это должно работать и в будущем.

### <a name="a-note-on-iframe-apps"></a>Примечание к приложениям iFrame

Распространенный шаблон в веб-приложениях — использование iFrame для внедрения одного приложения в другое. Фрейм верхнего уровня обрабатывает проверку подлинности пользователя, а приложение, размещенное в iFrame, может гарантировать вход пользователя в систему и автоматически получать маркеры с помощью неявного потока. Автоматическое получение маркера не работает, если сторонние файлы cookie заблокированы. Приложение, внедренное в iFrame, должно переключиться на использование всплывающих окон для доступа к сеансу пользователя, так как иначе ему не удастся выполнить переход на страницу входа.

## <a name="security-implications-of-refresh-tokens-in-the-browser"></a>Влияние маркеров обновления на безопасность в браузере

Выдача маркеров обновления браузеру считается проблемой безопасности. Используя атаки межсайтовых сценариев (XSS) или скомпрометированные пакеты JS, можно украсть маркер обновления и использовать его удаленно до истечения срока действия или отзыва. Чтобы свести к минимуму риск кражи маркеров обновления, одностраничным приложениям будут выдаваться маркеры, действительные только в течение 24 часов. Через 24 часа приложение должно получить новый код авторизации через фрейм верхнего уровня, открыв страницу входа.

Этот шаблон маркера обновления с ограниченным сроком действия был выбран в качестве компромисса между безопасностью и ухудшенным взаимодействием с пользователем. Без маркеров обновления или сторонних файлов cookie поток кода авторизации (как рекомендуется в [черновике оптимальных методов безопасности OAuth](https://tools.ietf.org/html/draft-ietf-oauth-security-topics-14)) становится обременительным, если требуются новые или дополнительные маркеры. Полностраничное перенаправление или всплывающее окно требуется для получения каждого отдельного маркера каждый раз по истечении срока действия маркера (для маркеров платформы удостоверений Майкрософт обычно через каждый час).

## <a name="next-steps"></a>Дальнейшие действия

Ознакомьтесь с дополнительными сведениями о [потоке кода авторизации](v2-oauth2-auth-code-flow.md).

Испытайте поток кода авторизации, выполнив инструкции приведенные в [кратком руководстве по MSAL.js 2.0](quickstart-v2-javascript-auth-code.md).
