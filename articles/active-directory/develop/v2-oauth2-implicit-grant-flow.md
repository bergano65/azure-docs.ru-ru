---
title: Защита одностраничных приложений с помощью неявного потока платформы идентификации Майкрософт | Службы
description: Создание веб-приложений с помощью реализации неявного потока для одностраничных приложений на платформе идентификации Майкрософт.
services: active-directory
documentationcenter: ''
author: rwike77
manager: CelesteDG
editor: ''
ms.assetid: 3605931f-dc24-4910-bb50-5375defec6a8
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 11/19/2019
ms.author: ryanwi
ms.reviewer: hirsin
ms.custom: aaddev
ms.collection: M365-identity-device-management
ms.openlocfilehash: 8afae9535c190c05bca3153dfbe5279cd4c47968
ms.sourcegitcommit: a5ebf5026d9967c4c4f92432698cb1f8651c03bb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/08/2019
ms.locfileid: "74919228"
---
# <a name="microsoft-identity-platform-and-implicit-grant-flow"></a>Платформа удостоверений Майкрософт и неявный поток предоставления

[!INCLUDE [active-directory-develop-applies-v2](../../../includes/active-directory-develop-applies-v2.md)]

Конечная точка платформы идентификации Майкрософт позволяет подписывать пользователей в одностраничных приложениях с помощью личных и рабочих учетных записей Майкрософт. Во время проверки подлинности одностраничные и другие приложения JavaScript, которые запускаются в основном в браузере, сталкиваются с некоторыми проблемами.

* Характеристики безопасности этих приложений значительно отличаются от традиционных серверных веб-приложений.
* Многие серверы авторизации и поставщики удостоверений не поддерживают запросы CORS.
* Полностраничный браузер перенаправляет пользователя из приложения, взаимодействие с которым становится особенно агрессивным.

Для этих приложений (AngularJS, Ember. js, реагируют. js и т. д.) платформа Microsoft Identity поддерживает неявный поток предоставления OAuth 2,0. Подробное описание неявного потока данных см. в [спецификации OAuth 2.0](https://tools.ietf.org/html/rfc6749#section-4.2). Его основное преимущество заключается в том, что оно позволяет приложению получать маркеры от платформы Microsoft Identity, не выполняя обмен учетными данными внутреннего сервера. Так, приложение может авторизовать пользователей, поддерживать сеансы и получать маркеры для других веб-API — и все это из клиентского кода JavaScript. Во время использования неявного потока данных необходимо обращать внимание на некоторые важные вопросы безопасности, касающиеся [клиента](https://tools.ietf.org/html/rfc6749#section-10.3) и [маскировки под другого пользователя](https://tools.ietf.org/html/rfc6749#section-10.3).

В этой статье описывается, как программировать непосредственно по протоколу в приложении.  По возможности рекомендуется использовать поддерживаемые библиотеки проверки подлинности Майкрософт (MSAL) вместо [получения маркеров и вызова защищенных веб-API](authentication-flows-app-scenarios.md#scenarios-and-supported-authentication-flows).  Также ознакомьтесь с [примерами приложений, которые используют MSAL](sample-v2-code.md).

Но в одностраничном приложении можно обойтись без использования библиотеки. Отправлять сообщения протокола в таком случае нужно самостоятельно. Для этого выполните следующие шаги.

> [!NOTE]
> Не все сценарии и функции Azure Active Directory (Azure AD) поддерживаются конечной точкой платформы Microsoft Identity. Чтобы определить, следует ли использовать конечную точку платформы идентификации Майкрософт, ознакомьтесь с [ограничениями платформы удостоверений Майкрософт](active-directory-v2-limitations.md).

## <a name="protocol-diagram"></a>Схема протокола

На следующей схеме показано, как выглядит весь неявный входной поток. В последующих разделах каждый шаг описывается более подробно.

![Схема, показывающая неявный поток входа](./media/v2-oauth2-implicit-grant-flow/convergence-scenarios-implicit.svg)

## <a name="send-the-sign-in-request"></a>Отправка запроса на вход

Чтобы изначально подписать пользователя в приложении, можно отправить запрос на проверку подлинности [OpenID Connect Connect](v2-protocols-oidc.md) и получить `id_token` из конечной точки платформы идентификации Майкрософт.

> [!IMPORTANT]
> Для успешного запроса маркера идентификации и (или) маркера доступа регистрация приложения на странице [портал Azure-регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) должна иметь соответствующий неявный поток предоставления разрешения, выбрав **токены идентификации** и или **маркеры доступа** в разделе **неявного предоставления** . Если он не включен, будет возвращена ошибка `unsupported_response`: **указанное значение входного параметра "response_type" не разрешено для этого клиента. Ожидаемое значение — "Code"**

```
// Line breaks for legibility only

https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=id_token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&scope=openid
&response_mode=fragment
&state=12345
&nonce=678910
```

> [!TIP]
> Чтобы проверить вход с помощью неявного потока, щелкните <a href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=id_token&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&scope=openid&response_mode=fragment&state=12345&nonce=678910" target="_blank">https://login.microsoftonline.com/common/oauth2/v2.0/authorize...</a> После входа в систему браузер следует перенаправить на `https://localhost/myapp/` с `id_token` в адресной строке.
>

| Параметр |  | Описание |
| --- | --- | --- |
| `tenant` | обязательно |Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints). |
| `client_id` | обязательно | Идентификатор приложения (клиента), которому назначена страница [портал Azure регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) приложения. |
| `response_type` | обязательно |Должен включать `id_token` для входа в OpenID Connect. Этот параметр также может содержать значение `token` параметра response_type (тип ответа). Использование `token` здесь позволяет приложению получать токен доступа непосредственно от конечной точки авторизации, при этом отправлять новый запрос на вход в эту конечную точку не требуется. При использовании response_type `token` параметр `scope` должен содержать область, указывающую, в какой ресурс выдается маркер (например, пользователь. Read on Microsoft Graph).  |
| `redirect_uri` | рекомендуется |URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| `scope` | обязательно |Список [областей](v2-permissions-and-consent.md) с разделителями-пробелами. Для OpenID Connect Connect (id_tokens) он должен включать `openid`области, которая преобразуется в разрешение "вход" в пользовательском интерфейсе согласия. При необходимости можно также включить области `email` и `profile`, чтобы получить доступ к дополнительным данным пользователя. Вы также можете включить в этот запрос другие области для запроса согласия на различные ресурсы, если запрошен маркер доступа. |
| `response_mode` | необязательный |Указывает метод, с помощью которого результирующий маркер будет отправлен приложению. По умолчанию запрашивает только маркер доступа, но фрагмент, если запрос содержит id_token. |
| `state` | рекомендуется |Значение, включенное в запрос, которое также возвращается в ответе токена. Это может быть строка любого контента. Как правило, для [предотвращения подделки межсайтовых запросов](https://tools.ietf.org/html/rfc6749#section-10.12)используется генерируемое случайным образом уникальное значение. Параметр "state" также используется для кодирования информации о состоянии пользователя в приложении перед созданием запроса на проверку подлинности, например информации об открытой на тот момент странице или представлении. |
| `nonce` | обязательно |Значение, включенное в запрос и созданное приложением, которое войдет в состав полученного токена "id_token" в качестве утверждения. Приложение может проверить это значение во избежание атак с использованием воспроизведения токена. Это значение обычно представляет собой случайную уникальную строку, которую можно использовать для определения источника запроса. Требуется только при запросе id_token. |
| `prompt` | необязательный |Указывает требуемый тип взаимодействия с пользователем. На текущий момент единственные допустимые значения — login, none, select_account и consent. При значении `prompt=login` пользователю придется вводить учетные данные по запросу. Единый вход не сработает. `prompt=none` является обратной. Это гарантирует, что пользователь не будет представлен ни в каких интерактивных запросах. Если запрос не может быть выполнен автоматически с помощью единого входа, конечная точка платформы Microsoft Identity возвратит ошибку. `prompt=select_account` отправляет пользователя в средство выбора учетных записей, где будут отображаться все учетные записи, запомненные в сеансе. Если установить значение `prompt=consent`, то после входа пользователь увидит диалоговое окно согласия OAuth с запросом на предоставление разрешений приложению. |
| `login_hint`  |необязательный |Можно применять для предварительного заполнения поля имени пользователя или электронного адреса на странице входа пользователя (если имя пользователя известно заранее). Зачастую этот параметр используется в приложениях при повторной проверке подлинности. При этом имя пользователя извлекается во время предыдущего входа с помощью утверждения `preferred_username`.|
| `domain_hint` | необязательный |Если этот параметр включен, процесс обнаружения на основе электронной почты будет пропускаться на странице входа, что упрощает работу пользователя. Обычно это используется для бизнес-приложений, которые работают в одном клиенте, где они будут предоставлять доменное имя в пределах заданного клиента.  Это приведет к пересылке пользователя поставщику Федерации для этого клиента.  Обратите внимание, что это предотвратит вход гостей в приложение.  |

На текущем этапе пользователю придется ввести учетные данные и завершить проверку подлинности. Конечная точка платформы идентификации Майкрософт также обеспечит, чтобы пользователь предоставил разрешения, указанные в параметре запроса `scope`. Если пользователь **не предоставил** какие-либо из этих разрешений, конечная точка запросит их у пользователя. Дополнительные сведения см. в статье [Разрешения и предоставление согласия в конечной точке Azure Active Directory версии 2.0](v2-permissions-and-consent.md).

После того как пользователь пройдет проверку подлинности и предоставит согласие, конечная точка платформы Microsoft Identity возвратит ответ в приложение на указанном `redirect_uri`с помощью метода, указанного в параметре `response_mode`.

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ с использованием `response_mode=fragment` и `response_type=id_token+token` выглядит следующим образом (разрывы строк — для удобства чтения):

```
GET https://localhost/myapp/#
&token_type=Bearer
&expires_in=3599
&id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&state=12345
```

| Параметр | Описание |
| --- | --- |
| `access_token` |Указывается, если параметр `response_type` содержит значение `token`. Маркер доступа, запрошенный приложением. Маркер доступа не должен декодироваться или проверяться иным образом, он должен рассматриваться как непрозрачная строка. |
| `token_type` |Указывается, если параметр `response_type` содержит значение `token`. Всегда будет использоваться значение `Bearer`. |
| `expires_in`|Указывается, если параметр `response_type` содержит значение `token`. Указывает количество секунд, в течение которых маркер остается допустимым (для кэширования). |
| `scope` |Указывается, если параметр `response_type` содержит значение `token`. Указывает области, для которых будет допустимым access_token. Может не включать все запрошенные области, если они не были применимы к пользователю (в случае запроса областей только Azure AD, когда для входа используется личная учетная запись). |
| `id_token` | Подписанный JSON Web Token (JWT). Приложение может декодировать сегменты этого токена, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать значения и отображать их, но не зависит от ограничений авторизации или безопасности. См. дополнительные сведения о маркерах id_token: [`id_token reference`](id-tokens.md). <br> **Примечание.** Предоставляется, только если подан запрос на область `openid`. |
| `state` |Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

#### <a name="error-response"></a>Сообщение об ошибке

Сообщения об ошибках также можно отправлять на `redirect_uri` , чтобы приложение обрабатывало их должным образом:

```
GET https://localhost/myapp/#
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание |
| --- | --- |
| `error` |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` |Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

## <a name="getting-access-tokens-silently-in-the-background"></a>Автоматическое получение маркеров доступа в фоновом режиме

Теперь, когда пользователь подписан в одностраничном приложении, можно получать маркеры доступа для вызова веб-API, защищенных платформой Microsoft Identity, например [Microsoft Graph](https://developer.microsoft.com/graph). Даже если вы уже получили токен с использованием параметра response_type со значением `token`, этот метод можно использовать для получения токенов к дополнительным ресурсам. При наличии этих токенов пользователям не нужно повторно выполнять вход.

В обычном потоке OpenID Connect Connect/OAuth это можно сделать, выполнив запрос к конечной точке платформы Microsoft Identity `/token`. Однако конечная точка платформы Microsoft Identity не поддерживает запросы CORS, поэтому выполнение вызовов AJAX для получения и обновления маркеров не является вопросом. Вместо этого для получения новых маркеров для других веб-API можно использовать неявный поток данных в скрытом iframe. 

```
// Line breaks for legibility only

https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&scope=https%3A%2F%2Fgraph.microsoft.com%2Fuser.read 
&response_mode=fragment
&state=12345
&nonce=678910
&prompt=none
&login_hint=myuser@mycompany.com
```

Дополнительные сведения о параметрах запроса в URL-адресе см. в разделе [Отправка запроса на вход](#send-the-sign-in-request).

> [!TIP]
> Попробуйте скопировать и вставить запрос, показанный ниже, на вкладку браузера. (Не забудьте заменить значения `login_hint` на правильное значение для вашего пользователя.)
>
>`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=token&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&scope=https%3A%2F%2Fgraph.microsoft.com%2Fuser.read&response_mode=fragment&state=12345&nonce=678910&prompt=none&login_hint={your-username}`
>

Благодаря параметру `prompt=none` этот запрос успешно выполнится или немедленно завершится с ошибкой, и вы вернетесь к своему приложению. Успешный ответ будет отправлен в ваше приложение на указанный `redirect_uri` с помощью метода, заданного в параметре `response_mode`.

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ с использованием метода `response_mode=fragment` выглядит следующим образом:

```
GET https://localhost/myapp/#
access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&state=12345
&token_type=Bearer
&expires_in=3599
&scope=https%3A%2F%2Fgraph.windows.net%2Fdirectory.read
```

| Параметр | Описание |
| --- | --- |
| `access_token` |Указывается, если параметр `response_type` содержит значение `token`. Это маркер доступа, запрошенный приложением. В данном случае для Microsoft Graph. Маркер доступа не должен декодироваться или проверяться иным образом, он должен рассматриваться как непрозрачная строка. |
| `token_type` | Всегда будет использоваться значение `Bearer`. |
| `expires_in` | Указывает количество секунд, в течение которых маркер остается допустимым (для кэширования). |
| `scope` | Указывает области, для которых будет допустимым access_token. Может не включать все запрошенные области, если они не были применимы к пользователю (в случае запроса областей только Azure AD, когда для входа используется личная учетная запись). |
| `id_token` | Подписанный JSON Web Token (JWT). Указывается, если параметр `response_type` содержит значение `id_token`. Приложение может декодировать сегменты этого токена, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать значения и отображать их, но не зависит от ограничений авторизации или безопасности. Дополнительные сведения о маркерах id_token см. в статье [`id_token`Маркеры идентификаторов](id-tokens.md). <br> **Примечание.** Предоставляется, только если подан запрос на область `openid`. |
| `state` |Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

#### <a name="error-response"></a>Сообщение об ошибке

Сообщения об ошибках также можно отправлять на `redirect_uri` , чтобы приложение правильно обрабатывало их. Если вы используете `prompt=none`, отобразится следующая ошибка.

```
GET https://localhost/myapp/#
error=user_authentication_required
&error_description=the+request+could+not+be+completed+silently
```

| Параметр | Описание |
| --- | --- |
| `error` |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` |Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

После появления этой ошибки в запросе iframe пользователю необходимо войти еще раз в интерактивном режиме для получения нового маркера. Этот случай можно обрабатывать любым способом, который лучше всего подходит для вашего приложения.

## <a name="refreshing-tokens"></a>Обновление маркеров

Неявное предоставление не обеспечивает маркеры обновления. Срок действия маркеров `id_token` и `access_token` очень короткий, поэтому приложение должно быть готово периодически обновлять их. Чтобы обновить токен любого типа, можно выполнить тот же скрытый запрос IFRAME, приведенный выше, используя параметр `prompt=none` для управления поведением платформы удостоверений. Если вы хотите получить новый `id_token`, обязательно используйте `id_token` в `response_type` и `scope=openid`, а также в параметре `nonce`.

## <a name="send-a-sign-out-request"></a>Отправка запроса на выход

OpenID Connect Connect `end_session_endpoint` позволяет приложению отправить запрос к конечной точке платформы Microsoft Identity, чтобы завершить сеанс пользователя и очистить файлы cookie, заданные конечной точкой платформы Microsoft Identity. Чтобы пользователь полностью вышел из веб-приложения, приложение должно завершить свой сеанс пользователя (обычно с помощью очистки кэша маркеров или файлов cookie), а затем перенаправить браузер на:

```
https://login.microsoftonline.com/{tenant}/oauth2/v2.0/logout?post_logout_redirect_uri=https://localhost/myapp/
```

| Параметр |  | Описание |
| --- | --- | --- |
| `tenant` |обязательно |Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints). |
| `post_logout_redirect_uri` | рекомендуется | URL-адрес, на который следует возвратить пользователя после выхода. Это значение должно соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных для приложения. Если этот параметр не указан, пользователь будет отображать общее сообщение в конечной точке платформы идентификации Майкрософт. |

## <a name="next-steps"></a>Дальнейшие действия

* Перейдите на страницу [примеров MSAL JS](sample-v2-code.md), чтобы приступить к созданию кода.
