---
title: Неявный поток предоставления OAuth 2,0 — платформа Microsoft Identity | Службы
description: Защита одностраничных приложений с помощью неявного потока платформы идентификации Майкрософт.
services: active-directory
author: hpsin
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 11/30/2020
ms.author: hirsin
ms.reviewer: hirsin
ms.custom: aaddev
ms.openlocfilehash: 4b5465cc5c1c3447af5303a5c0bfe82874705362
ms.sourcegitcommit: df66dff4e34a0b7780cba503bb141d6b72335a96
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/02/2020
ms.locfileid: "96511204"
---
# <a name="microsoft-identity-platform-and-implicit-grant-flow"></a>Платформа удостоверений Майкрософт и неявный поток предоставления

Платформа Microsoft Identity поддерживает поток неявного предоставления OAuth 2,0, как описано в [спецификации OAuth 2,0](https://tools.ietf.org/html/rfc6749#section-4.2). Определяющая характеристика неявного предоставления разрешения заключается в том, что токены (маркеры идентификации или маркеры доступа) возвращаются непосредственно из конечной точки/Authorize, а не из конечной точки/Token. Это часто используется как часть [потока кода авторизации](v2-oauth2-auth-code-flow.md)в том, что называется "гибридный поток" — получение маркера идентификатора для запроса/Authorize вместе с кодом авторизации.

[!INCLUDE [suggest-msal-from-protocols](includes/suggest-msal-from-protocols.md)]

## <a name="prefer-the-auth-code-flow"></a>Предпочитать поток кода проверки подлинности

При использовании планов для [сторонних файлов cookie, которые будут удалены из браузеров](reference-third-party-cookies-spas.md), **неявный поток предоставления больше не является подходящим методом проверки подлинности**.  [Функции автоматического единого входа](#getting-access-tokens-silently-in-the-background) неявного потока не работают без файлов cookie сторонних производителей, что приводит к сбою приложений при попытке получить новый маркер. Настоятельно рекомендуется, чтобы все новые приложения использовали [поток кода авторизации](v2-oauth2-auth-code-flow.md) , который теперь поддерживает одностраничные приложения вместо неявного потока, и что [существующие приложения с одной страницей начинают переходить на поток кода авторизации](migrate-spa-implicit-to-auth-code.md) .

## <a name="suitable-scenarios-for-the-oauth2-implicit-grant"></a>Подходящие сценарии для неявного предоставления OAuth2

Неявное предоставление является надежным только для начальной интерактивной части потока входа, где отсутствие [файлов cookie сторонних производителей](reference-third-party-cookies-spas.md) не может повлиять на работу приложения. Это ограничение означает, что следует использовать его исключительно в рамках гибридного потока, где приложение запрашивает код, а также маркер из конечной точки авторизации. Это гарантирует, что приложение получит код, который можно активировать для маркера обновления, таким образом гарантируя, что сеанс входа в приложение остается действительным с течением времени.

## <a name="protocol-diagram"></a>Схема протокола

На следующей схеме представлен весь неявный поток входа, а каждый его шаг подробно описан в следующих разделах.

![Схема, показывающая неявный поток входа](./media/v2-oauth2-implicit-grant-flow/convergence-scenarios-implicit.svg)

## <a name="send-the-sign-in-request"></a>Отправка запроса на вход

Чтобы изначально подписать пользователя в приложении, можно отправить запрос на проверку подлинности [OpenID Connect Connect](v2-protocols-oidc.md) и получить `id_token` из конечной точки платформы идентификации Майкрософт.

> [!IMPORTANT]
> Для успешного запроса маркера идентификации и (или) маркера доступа регистрация приложения на странице [портал Azure-регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) должна иметь соответствующий неявный поток предоставления разрешения, выбрав **токены идентификации** и или **маркеры доступа** в разделе **неявного предоставления** . Если он не включен, `unsupported_response` будет возвращена ошибка: **указанное значение входного параметра "response_type" не разрешено для этого клиента. Ожидаемое значение — "Code"**

```
// Line breaks for legibility only

https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=id_token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&scope=openid
&response_mode=fragment
&state=12345
&nonce=678910
```

> [!TIP]
> Чтобы проверить вход с помощью неявного потока, нажмите кнопку <a href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=id_token&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&scope=openid&response_mode=fragment&state=12345&nonce=678910" target="_blank"> https://login.microsoftonline.com/common/oauth2/v2.0/authorize.. .</a> После входа в систему браузер должен быть перенаправлен `https://localhost/myapp/` с помощью `id_token` в адресной строке.
>

| Параметр | Тип | Описание |
| --- | --- | --- |
| `tenant` | обязательно |Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints). |
| `client_id` | обязательно | Идентификатор приложения (клиента), назначенный вашему приложению на странице [регистрации приложений на портале Azure](https://go.microsoft.com/fwlink/?linkid=2083908). |
| `response_type` | обязательно |Должен включать `id_token` для входа в OpenID Connect. Этот параметр также может содержать значение `token` параметра response_type (тип ответа). Использование `token` здесь позволяет приложению получать токен доступа непосредственно от конечной точки авторизации, при этом отправлять новый запрос на вход в эту конечную точку не требуется. При использовании `token` response_type `scope` параметр должен содержать область, указывающую, для какого ресурса выдается маркер (например, пользователь. read on Microsoft Graph). Он также может содержать вместо `code` `token` , чтобы предоставить код авторизации для использования в [потоке кода авторизации](v2-oauth2-auth-code-flow.md). Этот ответ id_token + Code иногда называют гибридным потоком.  |
| `redirect_uri` | рекомендуется |URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| `scope` | обязательно |Список [областей](v2-permissions-and-consent.md)с разделителями-пробелами. Для OpenID Connect Connect (id_tokens) он должен включать область `openid` , которая преобразуется в разрешение "вход" в пользовательском интерфейсе согласия. При необходимости также можно включить `email` `profile` области и для получения доступа к дополнительным данным пользователя. Вы также можете включить в этот запрос другие области для запроса согласия на различные ресурсы, если запрошен маркер доступа. |
| `response_mode` | необязательно |Определяет метод, который следует использовать для отправки созданного маркера запрашивающему приложению. По умолчанию запрашивает только маркер доступа, но фрагмент, если запрос содержит id_token. |
| `state` | рекомендуется |Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Как правило, для [предотвращения подделки межсайтовых запросов](https://tools.ietf.org/html/rfc6749#section-10.12)используется генерируемое случайным образом уникальное значение. Состояние также используется для кодирования сведений о состоянии пользователя в приложении перед выполнением запроса проверки подлинности, например о просматриваемой странице или представлении. |
| `nonce` | обязательные |Значение, включаемое в создаваемый приложением запрос, которое будет использоваться как утверждение в получаемом значении id_token. Приложение может проверять это значение, чтобы устранить атаки с воспроизведением маркеров. Значение обычно представляет собой случайным образом полученную уникальную строку, которую можно использовать для идентификации источника запроса. Требуется только при запросе id_token. |
| `prompt` | необязательный |Указывает требуемый тип взаимодействия с пользователем. На текущий момент единственные допустимые значения — login, none, select_account и consent. При значении `prompt=login` пользователю придется вводить учетные данные по запросу. Единый вход не сработает. `prompt=none` обратное — это гарантирует, что пользователь не будет представлен ни в каких интерактивных запросах. Если запрос не может быть выполнен автоматически с помощью единого входа, конечная точка платформы Microsoft Identity возвратит ошибку. `prompt=select_account` отправляет пользователя в средство выбора учетных записей, где будут отображаться все учетные записи, запомненные в сеансе. Если установить значение `prompt=consent`, то после входа пользователь увидит диалоговое окно согласия OAuth с запросом на предоставление разрешений приложению. |
| `login_hint`  |необязательно |Может использоваться для предварительного заполнения полей имени пользователя или адреса электронной почты на отображаемой пользователю странице входа, если имя пользователя уже известно. Часто приложения будут использовать этот параметр во время повторной проверки подлинности, уже извлекли имя пользователя из предыдущего входа с помощью `preferred_username` утверждения.|
| `domain_hint` | необязательный |Если этот параметр включен, процесс обнаружения на основе электронной почты будет пропускаться на странице входа, что упрощает работу пользователя. Этот параметр обычно используется для бизнес-приложений, которые работают в одном клиенте, где они будут предоставлять доменное имя в пределах заданного клиента, пересылая пользователя поставщику Федерации для этого клиента.  Обратите внимание, что это указание не позволяет гостям входить в это приложение и ограничивает использование облачных учетных данных, таких как FIDO.  |

На текущем этапе пользователю придется ввести учетные данные и завершить проверку подлинности. Конечная точка платформы удостоверений Майкрософт также проверяет, согласился ли пользователь предоставить разрешения, указанные в параметре запроса `scope`. Если пользователь **не предоставил** какие-либо из этих разрешений, конечная точка запросит их у пользователя. Дополнительные сведения см. в статье [Разрешения и предоставление согласия в конечной точке Azure Active Directory версии 2.0](v2-permissions-and-consent.md).

После того как пользователь пройдет проверку подлинности и предоставит разрешения, конечная точка платформы удостоверений Майкрософт вернет приложению ответ на указанный `redirect_uri` с помощью метода, указанного в параметре `response_mode`.

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ с использованием `response_mode=fragment` и `response_type=id_token+code` выглядит следующим образом (разрывы строк — для удобства чтения):

```HTTP
GET https://localhost/myapp/#
code=0.AgAAktYV-sfpYESnQynylW_UKZmH-C9y_G1A
&id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&state=12345
```

| Параметр | Описание: |
| --- | --- |
| `code` | Указывается, если параметр `response_type` содержит значение `code`. Это код авторизации, подходящий для использования в [потоке кода авторизации](v2-oauth2-auth-code-flow.md).  |
| `access_token` |Указывается, если параметр `response_type` содержит значение `token`. Маркер доступа, запрошенный приложением. Маркер доступа не должен декодироваться или проверяться иным образом, он должен рассматриваться как непрозрачная строка. |
| `token_type` |Указывается, если параметр `response_type` содержит значение `token`. Всегда будет использоваться значение `Bearer`. |
| `expires_in`|Указывается, если параметр `response_type` содержит значение `token`. Обозначает количество секунд, в течение которых маркер является допустимым. Используется для кэширования. |
| `scope` |Указывается, если параметр `response_type` содержит значение `token`. Позволяет указать одну или несколько областей, для которых access_token будет допустимым. Может не включать все запрошенные области, если они не были применимы к пользователю (в случае запроса областей только Azure AD, когда для входа используется личная учетная запись). |
| `id_token` | Подписанный JSON Web Token (JWT) Приложение может декодировать сегменты этого токена, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать значения и отображать их, но не зависит от ограничений авторизации или безопасности. См. дополнительные сведения о маркерах id_token: [`id_token reference`](id-tokens.md). <br> **Примечание.** Предоставляется только при `openid` запросе и `response_type` включении области `id_tokens` . |
| `state` |Если в запрос включен этот параметр состояния, идентичное значение должно содержаться и в ответе на этот запрос. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

#### <a name="error-response"></a>Сообщение об ошибке

Сообщения об ошибках также можно отправлять на `redirect_uri` , чтобы приложение обрабатывало их должным образом:

```HTTP
GET https://localhost/myapp/#
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание |
| --- | --- |
| `error` |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` |Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

## <a name="getting-access-tokens-silently-in-the-background"></a>Автоматическое получение маркеров доступа в фоновом режиме

> [!Important]
> Эта часть неявного потока вряд ли будет работать для вашего приложения, так как она используется в разных браузерах из-за [удаления файлов cookie сторонних производителей по умолчанию](reference-third-party-cookies-spas.md).  Хотя это все еще работает в браузерах на основе Chromium, которые не находятся в режиме инкогнито, разработчики должны переоценить использование этой части последовательности. В браузерах, которые не поддерживают сторонние файлы cookie, появится сообщение об ошибке, указывающее, что пользователи не вошли, так как файлы cookie сеанса страницы входа были удалены браузером. 

Теперь, когда пользователь подписан в одностраничном приложении, можно получать маркеры доступа для вызова веб-API, защищенных платформой Microsoft Identity, например [Microsoft Graph](https://developer.microsoft.com/graph). Даже если вы уже получили токен с использованием параметра response_type со значением `token`, этот метод можно использовать для получения токенов к дополнительным ресурсам. При наличии этих токенов пользователям не нужно повторно выполнять вход.

В обычном потоке OpenID Connect Connect/OAuth это можно сделать, выполнив запрос к конечной точке платформы идентификации Майкрософт `/token` . Вы можете сделать запрос в скрытом IFRAME, чтобы получить новые маркеры для других веб-API:

```
// Line breaks for legibility only

https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&scope=https%3A%2F%2Fgraph.microsoft.com%2Fuser.read
&response_mode=fragment
&state=12345
&nonce=678910
&prompt=none
&login_hint=myuser@mycompany.com
```

Дополнительные сведения о параметрах запроса в URL-адресе см. в разделе [Отправка запроса на вход](#send-the-sign-in-request).

> [!TIP]
> Попробуйте скопировать и вставить запрос, показанный ниже, на вкладку браузера. (Не забудьте заменить значения `login_hint` на правильное значение для вашего пользователя.)
>
>`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=token&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&scope=https%3A%2F%2Fgraph.microsoft.com%2Fuser.read&response_mode=fragment&state=12345&nonce=678910&prompt=none&login_hint={your-username}`
>
> Обратите внимание, что это будет работать даже в браузерах без поддержки файлов cookie стороннего производителя, так как вы вводите его непосредственно на панели браузера, в отличие от его открытия в IFRAME. 

Благодаря параметру `prompt=none` этот запрос успешно выполнится или немедленно завершится с ошибкой, и вы вернетесь к своему приложению. Ответ будет отправлен в ваше приложение в указанном `redirect_uri` виде с помощью метода, указанного в `response_mode` параметре.

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ с использованием метода `response_mode=fragment` выглядит следующим образом:

```HTTP
GET https://localhost/myapp/#
access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&state=12345
&token_type=Bearer
&expires_in=3599
&scope=https%3A%2F%2Fgraph.microsoft.com%2Fdirectory.read
```

| Параметр | Описание: |
| --- | --- |
| `access_token` |Указывается, если параметр `response_type` содержит значение `token`. Это маркер доступа, запрошенный приложением. В данном случае для Microsoft Graph. Маркер доступа не должен декодироваться или проверяться иным образом, он должен рассматриваться как непрозрачная строка. |
| `token_type` | Всегда будет использоваться значение `Bearer`. |
| `expires_in` | Обозначает количество секунд, в течение которых маркер является допустимым. Используется для кэширования. |
| `scope` | Позволяет указать одну или несколько областей, для которых access_token будет допустимым. Может не включать все запрошенные области, если они не были применимы к пользователю (в случае запроса областей только Azure AD, когда для входа используется личная учетная запись). |
| `id_token` | Подписанный JSON Web Token (JWT) Указывается, если параметр `response_type` содержит значение `id_token`. Приложение может декодировать сегменты этого токена, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать значения и отображать их, но не зависит от ограничений авторизации или безопасности. Дополнительные сведения о id_tokens см. в [ `id_token` справочнике](id-tokens.md). <br> **Примечание.** Предоставляется, только если подан запрос на область `openid`. |
| `state` |Если в запрос включен этот параметр состояния, идентичное значение должно содержаться и в ответе на этот запрос. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

#### <a name="error-response"></a>Сообщение об ошибке

Сообщения об ошибках также можно отправлять на `redirect_uri` , чтобы приложение правильно обрабатывало их. Если вы используете `prompt=none`, отобразится следующая ошибка.

```HTTP
GET https://localhost/myapp/#
error=user_authentication_required
&error_description=the+request+could+not+be+completed+silently
```

| Параметр | Описание |
| --- | --- |
| `error` |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` |Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

После появления этой ошибки в запросе iframe пользователю необходимо войти еще раз в интерактивном режиме для получения нового маркера. Этот случай можно обрабатывать любым способом, который лучше всего подходит для вашего приложения.

## <a name="refreshing-tokens"></a>Обновление маркеров

Неявное предоставление не использует маркеры обновления. Срок действия маркеров `id_token` и `access_token` очень короткий, поэтому приложение должно быть готово периодически обновлять их. Чтобы обновить токен любого типа, можно выполнить тот же скрытый запрос IFRAME, приведенный выше, с помощью `prompt=none` параметра, чтобы управлять поведением платформы удостоверений. Если вы хотите получить новый объект `id_token` , обязательно используйте `id_token` в и, а также `response_type` в `scope=openid` качестве `nonce` параметра.

В браузерах, которые не поддерживают сторонние файлы cookie, это приведет к ошибке, указывающей, что пользователь не вошел в приложение. 

## <a name="send-a-sign-out-request"></a>Отправка запроса на выход

OpenID Connect Connect `end_session_endpoint` позволяет приложению отправить запрос к конечной точке платформы Microsoft Identity, чтобы завершить сеанс пользователя и очистить файлы cookie, заданные конечной точкой платформы Microsoft Identity. Чтобы пользователь полностью вышел из веб-приложения, приложение должно завершить свой сеанс пользователя (обычно с помощью очистки кэша маркеров или файлов cookie), а затем перенаправить браузер на:

```
https://login.microsoftonline.com/{tenant}/oauth2/v2.0/logout?post_logout_redirect_uri=https://localhost/myapp/
```

| Параметр | Тип | Описание |
| --- | --- | --- |
| `tenant` |обязательно |Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints). |
| `post_logout_redirect_uri` | рекомендуется | URL-адрес, на который следует возвратить пользователя после выхода. Это значение должно соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных для приложения. Если этот параметр не указан, пользователь будет отображать общее сообщение в конечной точке платформы идентификации Майкрософт. |

## <a name="next-steps"></a>Следующие шаги

* Перейдите на страницу [примеров MSAL JS](sample-v2-code.md), чтобы приступить к созданию кода.
* Проверьте [поток кода авторизации](v2-oauth2-auth-code-flow.md) как более новую, лучшую альтернативу неявному предоставлению. 
