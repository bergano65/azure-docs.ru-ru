---
title: Протоколы согласия администратора платформы удостоверений Майкрософт | Документация Майкрософт
description: Описание авторизации в конечной точке платформы идентификации Майкрософт, включая области, разрешения и согласие.
services: active-directory
documentationcenter: ''
author: rwike77
manager: CelesteDG
editor: ''
ms.assetid: 8f98cbf0-a71d-4e34-babf-e642ad9ff423
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 09/24/2019
ms.author: ryanwi
ms.reviewer: hirsin
ms.custom: aaddev
ms.collection: M365-identity-device-management
ms.openlocfilehash: 9e44207429abb5aa03f4850861d49de8c5dcfdf7
ms.sourcegitcommit: 0486aba120c284157dfebbdaf6e23e038c8a5a15
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/26/2019
ms.locfileid: "71310377"
---
# <a name="admin-consent-on-the-microsoft-identity-platform"></a>Согласие администратора на платформе Microsoft Identity

Некоторым разрешениям требуется согласие от администратора, прежде чем они смогут быть предоставлены в клиенте.  Вы также можете использовать конечную точку предоставления согласия администратора, чтобы предоставить разрешения для всего клиента.  

## <a name="recommended-sign-the-user-into-your-app"></a>Рекомендация: выполнение входа пользователя в приложение

Как правило, при создании приложения, использующего конечную точку предоставления согласия администратора, для него нужно настроить страницу или представление, в котором администратор может утвердить разрешения приложения. Эта страница может быть частью потока регистрации приложения, параметров приложения или выделенного потока подключения. Во многих случаях разумно отображать это представление подключения в приложении только после того, как пользователь выполнил вход с помощью учебной или рабочей учетной записи Майкрософт.

При входе пользователя в приложение можно определить организацию, к которой принадлежит администратор, прежде чем запрашивать у него утверждение необходимых разрешений. Хотя это не обязательно, таким образом можно сделать пользовательский интерфейс более интуитивно понятным для сотрудников организации. Чтобы подписать пользователя в, следуйте нашим [руководствам по протоколу платформы идентификации Майкрософт](active-directory-v2-protocols.md).

## <a name="request-the-permissions-from-a-directory-admin"></a>Запрос разрешений у администратора каталога

Когда вы будете готовы запросить разрешения у администратора вашей организации, вы можете перенаправить пользователя на *конечную точку согласия администратора*платформы удостоверений Майкрософт.

```
// Line breaks are for legibility only.
    GET https://login.microsoftonline.com/{tenant}/v2.0/adminconsent?
  client_id=6731de76-14a6-49ae-97bc-6eba6914391e
  &state=12345
  &redirect_uri=http://localhost/myapp/permissions
    &scope=
    https://graph.microsoft.com/calendars.read 
    https://graph.microsoft.com/mail.send
```


| Параметр     | Условие     | Описание                                                                               |
|--------------:|--------------:|:-----------------------------------------------------------------------------------------:|
| `tenant` | Обязательное значение | Клиент каталога, из которого необходимо запросить разрешение. Может быть указан как GUID или в формате понятного имени, а также использоваться в универсальной ссылке с элементом `common`, как показано в примере. |
| `client_id` | Обязательное значение | **Идентификатор приложения (клиента)** , который [портал Azure — регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) , назначенный приложению. |
| `redirect_uri` | Обязательное значение |Универсальный код ресурса (URI) перенаправления, на который нужно направлять ответ для обработки в приложении. Он должен в точности соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных на портале регистрации приложений. |
| `state` | Рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе токена. Это может быть строка любого содержания. Используйте параметр state для кодирования сведений о состоянии пользователя в приложении перед выполнением запроса на аутентификацию. Например, это могут быть сведения об открытой на тот момент странице или представлении. |
|`scope`        | Обязательное значение      | Определяет набор разрешений, запрашиваемых приложением. Это может быть либо статическая (с помощью/.дефаулт), либо Динамическая область.  Это могут быть области OIDC (`openid`, `profile`, `email`). | 


На этом этапе Azure AD требует, чтобы администратор клиента вошел в систему, чтобы выполнить запрос. Администратору предлагается утвердить все разрешения, запрошенные в `scope` параметре.  Если вы использовали статическое значение (`/.default`), оно будет работать как конечная точка согласия администратора версии 1.0 и запросить согласие для всех областей, найденных в необходимых разрешениях для приложения.

### <a name="successful-response"></a>Успешный ответ

Если администратор утверждает разрешения для приложения, то успешный ответ будет выглядеть следующим образом.

```
http://localhost/myapp/permissions?admin_consent=True&tenant=fa00d692-e9c7-4460-a743-29f2956fd429&state=12345&scope=https%3a%2f%2fgraph.microsoft.com%2fCalendars.Read+https%3a%2f%2fgraph.microsoft.com%2fMail.Send
```

| Параметр         | Описание                                                                                       |
|------------------:|:-------------------------------------------------------------------------------------------------:|
| `tenant`| Клиент каталога, предоставивший приложению запрошенные разрешения, в виде GUID.|
| `state`           | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого содержания. Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении.|
| `scope`          | Набор разрешений, которым был предоставлен доступ к приложению.|
| `admin_consent`   | Для этого параметра будет задано значение `True`.|

### <a name="error-response"></a>Сообщение об ошибке

`http://localhost/myapp/permissions?error=consent_required&error_description=AADSTS65004%3a+The+resource+owner+or+authorization+server+denied+the+request.%0d%0aTrace+ID%3a+d320620c-3d56-42bc-bc45-4cdd85c41f00%0d%0aCorrelation+ID%3a+8478d534-5b2c-4325-8c2c-51395c342c89%0d%0aTimestamp%3a+2019-09-24+18%3a34%3a26Z&admin_consent=True&tenant=fa15d692-e9c7-4460-a743-29f2956fd429&state=12345`

При добавлении параметров к параметрам, которые встречаются в случае успешного ответа, параметры ошибки отображаются ниже.

| Параметр          | Описание                                                                                      |
|-------------------:|:-------------------------------------------------------------------------------------------------:|
| `error`            | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них.|
| `error_description`| Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки.|
| `tenant`| Клиент каталога, предоставивший приложению запрошенные разрешения, в виде GUID.|
| `state`           | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого содержания. Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении.|
| `admin_consent`   | Будет иметь значение `True` , указывающее, что этот ответ произошел в потоке согласия администратора.|

## <a name="next-steps"></a>Следующие шаги
- Дополнительные сведения см. в руководстве по [преобразованию приложения в мультитенантное](howto-convert-app-to-be-multi-tenant.md).
- Узнайте, как [согласие поддерживается на уровне протокола OAuth 2,0 во время потока предоставления кода авторизации](v2-oauth2-auth-code-flow.md#request-an-authorization-code).
- Узнайте, [как приложение с несколькими клиентами может использовать инфраструктуру согласия](active-directory-devhowto-multi-tenant-overview.md) для реализации согласия "пользователь" и "Администратор", поддерживающей более сложные шаблоны многоуровневых приложений.
