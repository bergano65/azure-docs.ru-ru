---
title: Потоки проверки подлинности MSAL | Службы
titleSuffix: Microsoft identity platform
description: Сведения о потоках проверки подлинности и предоставлении разрешений, используемых библиотекой проверки подлинности Майкрософт (MSAL).
services: active-directory
author: TylerMSFT
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: conceptual
ms.workload: identity
ms.date: 10/16/2019
ms.author: twhitney
ms.reviewer: saeeda
ms.custom: aaddev
ms.collection: M365-identity-device-management
ms.openlocfilehash: 2c818b7d7508555e1233d4ef954502728f65abfb
ms.sourcegitcommit: a5ebf5026d9967c4c4f92432698cb1f8651c03bb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/08/2019
ms.locfileid: "74917205"
---
# <a name="authentication-flows"></a>Потоки проверки подлинности

В этой статье описаны различные потоки проверки подлинности, предоставляемые библиотекой проверки подлинности Майкрософт (MSAL).  Эти потоки можно использовать в различных сценариях приложений.

| Поток | Описание | Используется в|  
| ---- | ----------- | ------- | 
| [Интерактивный](#interactive) | Получает маркер через интерактивный процесс, который запрашивает у пользователя учетные данные через браузер или всплывающее окно. | [Классические приложения](scenario-desktop-overview.md), [мобильные приложения](scenario-mobile-overview.md) |
| [Неявное предоставление](#implicit-grant) | Позволяет приложению получать токены без выполнения обмена учетными данными серверной части. Это позволяет приложению входить в систему пользователя, поддерживать сеанс и получать маркеры для других веб-API, в коде JavaScript клиента.| [Одностраничные приложения (SPA)](scenario-spa-overview.md) |
| [Код авторизации](#authorization-code) | Используется в приложениях, установленных на устройстве для получения доступа к защищенным ресурсам, таким как веб-API. Это позволит вам добавить доступ к мобильным и классическим приложениям с помощью функции входа и доступа через API. | [Классические приложения](scenario-desktop-overview.md), [мобильные приложения](scenario-mobile-overview.md), [веб-приложения](scenario-web-app-call-api-overview.md) | 
| [От имени](#on-behalf-of) | Приложение вызывает службу или веб-API, который, в свою очередь, должен вызывать другую службу или веб-API. Идея состоит в том, чтобы распространить делегированное удостоверение пользователя и разрешения с помощью цепочки запросов. | [Интерфейсы веб-API](scenario-web-api-call-api-overview.md) |
| [Учетные данные клиента](#client-credentials) | Позволяет получить доступ к ресурсам, размещенным в Интернете, с помощью удостоверения приложения. Обычно используется для взаимодействий "сервер-сервер", которые должны выполняться в фоновом режиме без немедленного взаимодействия с пользователем. | [Приложения управляющей программы](scenario-daemon-overview.md) |
| [Код устройства](#device-code) | Позволяет пользователям входить на устройства с ограниченным входом, например на интеллектуальный телевизор, на устройство IoT или на принтер. | [Классические и мобильные приложения](scenario-desktop-acquire-token.md#command-line-tool-without-web-browser) |
| [Встроенная аутентификация Windows](scenario-desktop-acquire-token.md#integrated-windows-authentication) | Позволяет приложениям на компьютерах, подключенных к домену или Azure Active Directory (Azure AD), получать маркер автоматически (без взаимодействия с пользовательским ИНТЕРФЕЙСом).| [Классические и мобильные приложения](scenario-desktop-acquire-token.md#integrated-windows-authentication) |
| [Имя пользователя и пароль](scenario-desktop-acquire-token.md#username--password) | Позволяет приложению войти в систему, напрямую обрабатывая свой пароль. Этот поток не рекомендуется. | [Классические и мобильные приложения](scenario-desktop-acquire-token.md#username--password) |

## <a name="how-each-flow-emits-tokens-and-codes"></a>Как каждый поток порождает маркеры и коды
 
В зависимости от того, как строится клиент, он может использовать один (или несколько) потоков проверки подлинности, поддерживаемых платформой Microsoft Identity.  Эти потоки могут создавать различные маркеры (id_tokens, маркеры обновления, маркеры доступа), а также коды авторизации, и для их работы требуются разные токены. На этой диаграмме представлен обзор:
 
|Поток | Обязательно | id_token | Twitter, | маркер обновления | Код авторизации | 
|-----|----------|----------|--------------|---------------|--------------------|
|[Поток кода авторизации](v2-oauth2-auth-code-flow.md) | | x | x | x | x|  
|[Неявный поток](v2-oauth2-implicit-grant-flow.md) | | x        | x    |      |                    |
|[Гибридный поток OIDC](v2-protocols-oidc.md#get-access-tokens)| | x  | |          |            x   |
|[Активация токена обновления](v2-oauth2-auth-code-flow.md#refresh-the-access-token) | маркер обновления | x | x | x| |
|[Поток On-Behalf-Of](v2-oauth2-on-behalf-of-flow.md) | Twitter,| x| x| x| |
|[Поток кода устройства](v2-oauth2-device-code.md) | | x| x| x| |
|[Учетные данные клиента](v2-oauth2-client-creds-grant-flow.md) | | | x (только для приложений)| | |
 
Токены, выданные через неявный режим, имеют ограничение длины, так как они передаются обратно в браузер через URL-адрес (где `response_mode` — `query` или `fragment`).  Некоторые браузеры имеют ограничение на размер URL-адреса, который может быть размещен в строке браузера, и завершается ошибкой, если она слишком длинная.  Таким же маркер не имеет `groups` или `wids` утверждений.

## <a name="interactive"></a>Интерактивный режим

MSAL поддерживает возможность интерактивного запроса у пользователя учетных данных для входа и получения маркера с использованием этих учетных данных.

![Схема интерактивного потока](media/msal-authentication-flows/interactive.png)

Дополнительные сведения об использовании MSAL.NET для интерактивного получения маркеров на конкретных платформах см. в следующих статьях:
- [Xamarin Android](msal-net-xamarin-android-considerations.md)
- [Xamarin iOS](msal-net-xamarin-ios-considerations.md)
- [Универсальная платформа Windows](msal-net-uwp-considerations.md)

Дополнительные сведения о интерактивных вызовах в MSAL. js см. [в статье поведение запросов в интерактивных запросах MSAL. js](msal-js-prompt-behavior.md).

## <a name="implicit-grant"></a>Неявное разрешение

MSAL поддерживает [неявный поток предоставления OAuth 2](v2-oauth2-implicit-grant-flow.md), позволяющий приложению получать маркеры от платформы Microsoft Identity, не выполняя обмен учетными данными сервера. Это позволяет приложению входить в систему пользователя, поддерживать сеанс и получать маркеры для других веб-API, в коде JavaScript клиента.

![Схема неявного потока предоставления разрешений](media/msal-authentication-flows/implicit-grant.svg)

Многие современные веб-приложения создаются как клиентские приложения с одной страницей, написанные с помощью JavaScript или платформы SPA (например, угловой, Vue. js и реагируют. js). Эти приложения работают в веб-браузере и имеют разные характеристики проверки подлинности, чем традиционные веб-приложения на стороне сервера. Платформа Microsoft Identity позволяет одностраничным приложениям входить в систему пользователей и получать маркеры для доступа к серверным службам или веб-API с помощью неявного потока предоставления. Неявный поток позволяет приложению получать маркеры ИДЕНТИФИКАТОРов для представления пользователя, прошедшего проверку подлинности, а также маркеры, необходимые для вызова защищенных API.

Этот поток проверки подлинности не включает сценарии приложений, в которых используются межплатформенные платформы JavaScript, такие как электронное и собственное реагирование, так как для них требуются дополнительные возможности для взаимодействия с собственными платформами.

## <a name="authorization-code"></a>Код авторизации

MSAL поддерживает [предоставление кода авторизации OAuth 2](v2-oauth2-auth-code-flow.md). Это право можно использовать в приложениях, установленных на устройстве, чтобы получить доступ к защищенным ресурсам, таким как веб-API. Это позволит вам добавить доступ к мобильным и классическим приложениям с помощью функции входа и доступа через API. 

При входе пользователей в веб-приложения (веб-сайты) веб-приложение получает код авторизации.  Код авторизации активируется для получения маркера для вызова веб-API. В ASP.NET и ASP.NET Core веб-приложениях единственной целью `AcquireTokenByAuthorizationCode` является Добавление маркера в кэш маркеров. Затем маркер может использоваться приложением (обычно в контроллерах, которое просто получает маркер для API с помощью `AcquireTokenSilent`).

![Схема потока кода авторизации](media/msal-authentication-flows/authorization-code.png)

На предыдущей схеме приложение:

1. Запрашивает код авторизации, который активируется для маркера доступа.
2. Использует маркер доступа для вызова веб-API.

### <a name="considerations"></a>Рекомендации

- Код авторизации можно использовать только один раз для активации токена. Не пытайтесь получить маркер несколько раз с одним и тем же кодом авторизации (он явно запрещен спецификацией протокола Standard). Если вы активируете код несколько раз преднамеренно или не знаете, что платформа также делает это, вы получаете следующую ошибку: `AADSTS70002: Error validating credentials. AADSTS54005: OAuth2 Authorization code was already redeemed, please retry with a new valid code or use an existing refresh token.`

- Если вы пишете приложение ASP.NET или ASP.NET Core, это может произойти, если вы не сообщитее платформе, что вы уже активировали код авторизации. Для этого необходимо вызвать метод `context.HandleCodeRedemption()` обработчика событий `AuthorizationCodeReceived`.

- Избегайте совместного использования маркера доступа с ASP.NET, что может помешать правильному последовательному согласию. Дополнительные сведения см. в разделе [issue #693](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/issues/693).

## <a name="on-behalf-of"></a>От имени

MSAL поддерживает [поток проверки подлинности OAuth 2 от имени пользователя](v2-oauth2-on-behalf-of-flow.md).  Этот поток используется, когда приложение вызывает службу или веб-API, который, в свою очередь, должен вызывать другую службу или веб-API. Идея состоит в том, чтобы распространить делегированное удостоверение пользователя и разрешения с помощью цепочки запросов. Чтобы служба среднего уровня выполняла запросы с проверкой подлинности к подчиненной службе, ей необходимо защитить маркер доступа от платформы Microsoft Identity, от имени пользователя.

![Схема потока «от имени»](media/msal-authentication-flows/on-behalf-of.png)

На предыдущей схеме показано следующее:

1. Приложение получает маркер доступа для веб-API.
2. Клиент (веб-приложение, настольное, мобильное или одностраничное) вызывает защищенный веб-API, добавляя маркер доступа в качестве токена носителя в заголовок проверки подлинности HTTP-запроса. Веб-API выполняет проверку подлинности пользователя.
3. Когда клиент вызывает веб-API, веб-API запрашивает другой токен от имени пользователя.  
4. Защищенный веб-API использует этот токен для вызова подчиненного веб-API от имени пользователя.  Веб-API также может запрашивать маркеры для других нижестоящих API (но по-прежнему от имени одного и того же пользователя).

## <a name="client-credentials"></a>Учетные данные клиента

MSAL поддерживает [поток учетных данных клиента OAuth 2](v2-oauth2-client-creds-grant-flow.md). Этот поток позволяет получить доступ к ресурсам, размещенным в Интернете, с помощью удостоверения приложения. Этот тип предоставления разрешения часто используется для взаимодействия между серверами, которое должно выполняться в фоновом режиме без непосредственного взаимодействия с пользователем. Эти типы приложений часто называются управляющими программами или учетными записями служб. 

Поток предоставления учетных данных клиента позволяет веб-службе (конфиденциальному клиенту) использовать собственные учетные данные вместо олицетворения пользователя для проверки подлинности при вызове другой веб-службы. В этом сценарии клиент обычно представляет собой веб-службу среднего уровня, службу управляющей программы или веб-сайт. Для большей надежности платформа удостоверений Майкрософт также позволяет вызывающей службе использовать в качестве учетных данных сертификат (вместо общего секрета).

> [!NOTE]
> Конфиденциальный поток клиента недоступен на мобильных платформах (UWP, Xamarin. iOS и Xamarin. Android), так как они поддерживают только общедоступные клиентские приложения. Общедоступные клиентские приложения не узнают, как подтвердить удостоверение приложения для поставщика удостоверений. Безопасное подключение может быть достигнуто на веб-приложении или серверной стороне веб-API путем развертывания сертификата.

MSAL.NET поддерживает два типа клиентских учетных данных. Эти учетные данные клиента должны быть зарегистрированы в Azure AD. Учетные данные передаются в конструкторы конфиденциального клиентского приложения в коде.

### <a name="application-secrets"></a>Секреты приложений

![Схема конфиденциального клиента с паролем](media/msal-authentication-flows/confidential-client-password.png)

На предыдущей схеме приложение:

1. Получает маркер с помощью секрета приложения или учетных данных пароля.
2. Использует маркер для выполнения запросов к ресурсу.

### <a name="certificates"></a>Сертификаты

![Схема конфиденциального клиента с сертификатом](media/msal-authentication-flows/confidential-client-certificate.png)

На предыдущей схеме приложение:

1. Получает маркер с помощью учетных данных сертификата.
2. Использует маркер для выполнения запросов к ресурсу.

Эти учетные данные клиента должны быть следующими:
- Зарегистрировано в Azure AD.
- Передается при создании конфиденциального клиентского приложения в коде.

## <a name="device-code"></a>Код устройства

MSAL поддерживает [поток кода устройства OAuth 2](v2-oauth2-device-code.md), который позволяет пользователям входить на устройства с ограниченным входом, например на интеллектуальный телевизор, на устройство IOT или на принтер. Для интерактивной проверки подлинности в Azure AD требуется веб-браузер. Поток кода устройства позволяет пользователю использовать другое устройство (например, другой компьютер или мобильный телефон) для входа в интерактивном режиме, где устройство или операционная система не предоставляют веб-браузер.

С помощью потока кода устройства приложение получает маркеры через двухэтапный процесс, специально предназначенный для этих устройств или операционных систем. К примерам таких приложений относятся те, которые работают на устройствах IoT или в программах командной строки (CLI). 

![Схема потока кода устройства](media/msal-authentication-flows/device-code.png)

На предыдущей схеме показано следующее:

1. Всякий раз, когда требуется проверка подлинности пользователя, приложение предоставляет код и запрашивает у пользователя использование другого устройства (например, смартфона, подключенного к Интернету) для перехода по URL-адресу (например, https://microsoft.com/devicelogin). После этого пользователю будет предложено ввести код и выполнить обычную проверку подлинности, включая запросы согласия и многофакторную проверку подлинности, если это необходимо.

2. После успешной проверки подлинности приложение командной строки получает необходимые токены через канал обратного вызова и использует их для выполнения необходимых им вызовов веб-API.

### <a name="constraints"></a>Ограничения

- Поток кода устройства доступен только в общедоступных клиентских приложениях.
- При создании общедоступного клиентского приложения центр должен иметь одно из следующих данных:
  - Клиентский (формы `https://login.microsoftonline.com/{tenant}/`, где `{tenant}` — это идентификатор GUID, представляющий идентификатор клиента или домен, связанный с клиентом).
  - Для всех рабочих и учебных учетных записей (`https://login.microsoftonline.com/organizations/`).
- Личные учетные записи Майкрософт пока не поддерживаются конечной точкой Azure AD версии 2.0 (вы не можете использовать клиенты `/common` или `/consumers`).

## <a name="integrated-windows-authentication"></a>Встроенная проверка подлинности Windows

MSAL поддерживает встроенную проверку подлинности Windows (IWA) для настольных или мобильных приложений, работающих на присоединенном к домену компьютере Windows или присоединенном к Azure AD. С помощью IWA эти приложения могут получать маркер автоматически (без взаимодействия с пользовательским ИНТЕРФЕЙСом). 

![Схема встроенной проверки подлинности Windows](media/msal-authentication-flows/integrated-windows-authentication.png)

На предыдущей схеме приложение:

1. Получает маркер, используя встроенную проверку подлинности Windows.
2. Использует маркер для выполнения запросов к ресурсу.

### <a name="constraints"></a>Ограничения

IWA поддерживает только Федеративные пользователи, то есть пользователи, созданные в Active Directory и поддерживающие Azure AD. Пользователи, созданные непосредственно в Azure AD без Active Directoryного резервного копирования (управляемые пользователи), не могут использовать этот поток проверки подлинности. Это ограничение не влияет на [поток имени пользователя и пароля](#usernamepassword).

IWA предназначен для приложений, написанных для платформ .NET Framework, .NET Core и универсальная платформа Windows.

IWA не обходит многофакторную проверку подлинности. Если настроена многофакторная проверка подлинности, IWA может завершиться ошибкой, если требуется запрос многофакторной проверки подлинности. Для многофакторной проверки подлинности требуется вмешательство пользователя.

Вы не контролируете, когда поставщик удостоверений запрашивает двухфакторную проверку подлинности. Администратор клиента выполняет. Обычно двухфакторная проверка подлинности требуется при входе из другой страны, когда вы не подключены через VPN к корпоративной сети и иногда даже при подключении через VPN. Azure AD использует искусственный интеллект для непрерывного изучения необходимости двухфакторной проверки подлинности. В случае сбоя IWA следует вернуться к [интерактивному приглашению пользователя] (#interactive).

При создании общедоступного клиентского приложения центр должен иметь одно из следующих данных:
- Клиентский (формы `https://login.microsoftonline.com/{tenant}/`, где `tenant` — это идентификатор GUID, представляющий идентификатор клиента или домен, связанный с клиентом).
- Для всех рабочих и учебных учетных записей (`https://login.microsoftonline.com/organizations/`). Личные учетные записи Майкрософт не поддерживаются (вы не можете использовать `/common` или `/consumers` клиентов).

Так как IWA является продвижением в автоматическом режиме, необходимо выполнить одно из следующих условий.
- Для использования приложения пользователь приложения должен быть предварительно отправлен. 
- Администратор клиента должен быть ранее передан всем пользователям в клиенте для использования приложения.

Это означает, что выполняется одно из следующих условий.
- Вы как разработчик выбрали **право** на портал Azure.
- Администратор клиента выбрал **разрешение GRANT/REVOKE администратора для {домен клиента}** на вкладке **разрешения API** для регистрации приложения (см. раздел [Добавление разрешений для доступа к веб-API](quickstart-configure-app-access-web-apis.md#add-permissions-to-access-web-apis)).
- Вы указали способ предоставления пользователям согласия на приложение (см. раздел [запрос согласия отдельного пользователя](v2-permissions-and-consent.md#requesting-individual-user-consent)).
- Вы указали способ предоставления администратору клиента согласия для приложения (см. раздел [согласие администратора](v2-permissions-and-consent.md#requesting-consent-for-an-entire-tenant)).

Поток IWA включен для приложений .NET для настольных систем, .NET Core и универсальной платформы Windows. В .NET Core необходимо предоставить имя пользователя IWA, так как .NET Core не может получить имена пользователей из операционной системы.
  
Дополнительные сведения о согласии см. в разделе [разрешения и согласие версии 2.0](v2-permissions-and-consent.md).

## <a name="usernamepassword"></a>Имя пользователя или пароль

MSAL поддерживает [предоставление учетных данных владельца ресурса OAuth 2](v2-oauth-ropc.md), что позволяет приложению входить в систему пользователя путем непосредственной обработки пароля. В классическом приложении можно использовать поток имени пользователя и пароля для автоматического получения маркера. При использовании приложения пользовательский интерфейс не требуется.

![Схема потока имени пользователя и пароля](media/msal-authentication-flows/username-password.png)

На предыдущей схеме приложение:

1. Получает маркер, отправляя имя пользователя и пароль поставщику удостоверений.
2. Вызывает веб-API с помощью токена.

> [!WARNING]
> Этот поток не рекомендуется. Для этого требуется высокая степень доверия и доступность пользователя.  Этот поток следует использовать только в том случае, если другие, более безопасные, потоки не могут использоваться. Дополнительные сведения см. в разделе [что такое решение для растущей проблемы паролей?](https://news.microsoft.com/features/whats-solution-growing-problem-passwords-says-microsoft/). 

Предпочтительным потоком для автоматического получения маркера на компьютерах, присоединенных к домену Windows, является [Встроенная проверка подлинности Windows](#integrated-windows-authentication). В противном случае можно также использовать [поток кода устройства](#device-code).

Хотя это полезно в некоторых случаях (DevOps сценарии), если вы хотите использовать имя пользователя и пароль в интерактивных сценариях, где вы предоставляете собственный пользовательский интерфейс, постарайтесь избежать этого. С помощью имени пользователя и пароля:
- Пользователи, которым требуется выполнить многофакторную проверку подлинности, не смогут войти в систему (так как взаимодействие отсутствует).
- Пользователи не смогут выполнять единый вход.

### <a name="constraints"></a>Ограничения

Помимо [встроенных ограничений проверки подлинности Windows](#integrated-windows-authentication), также применяются следующие ограничения.

- Поток имени пользователя и пароля несовместим с условным доступом и многофакторной проверкой подлинности. Как следствие, если приложение выполняется в клиенте Azure AD, где администратор клиента требует многофакторную проверку подлинности, вы не сможете использовать этот поток. Многие организации делают это.
- Он работает только для рабочих и учебных учетных записей (не учетных записей Майкрософт).
- Поток доступен на платформе .NET Desktop и .NET Core, но не на универсальная платформа Windows.

### <a name="azure-ad-b2c-specifics"></a>Особенности Azure AD B2C

Дополнительные сведения об использовании MSAL.NET и Azure AD B2C см. в разделе [Использование ропк с Azure AD B2C (MSAL.NET)](msal-net-aad-b2c-considerations.md#resource-owner-password-credentials-ropc-with-azure-ad-b2c).
