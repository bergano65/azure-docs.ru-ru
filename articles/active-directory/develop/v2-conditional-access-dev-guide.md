---
title: Руководство для разработчиков по условному доступу в Azure Active Directory
titleSuffix: Microsoft identity platform
description: Руководство для разработчиков и сценарии по условному доступу в Azure AD и платформе удостоверений Майкрософт.
services: active-directory
keywords: ''
author: rwike77
manager: CelesteDG
ms.author: ryanwi
ms.reviewer: jmprieur, saeeda
ms.date: 05/18/2020
ms.service: active-directory
ms.subservice: develop
ms.custom: aaddev
ms.topic: conceptual
ms.workload: identity
ms.openlocfilehash: b1bfefb3b72c151e7a61068b3c0ad9f3e2bc4a6f
ms.sourcegitcommit: b8702065338fc1ed81bfed082650b5b58234a702
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2020
ms.locfileid: "88120632"
---
# <a name="developer-guidance-for-azure-active-directory-conditional-access"></a>Руководство для разработчиков по условному доступу в Azure Active Directory

Функция условного доступа в Azure Active Directory (Azure AD) предлагает один из нескольких способов, с помощью которых можно защитить приложение и службу. Условный доступ позволяет разработчикам и корпоративным клиентам защищать службы множеством способов, включая следующие.

* [Многофакторная проверка подлинности](../authentication/concept-mfa-howitworks.md)
* разрешение доступа к определенным службам только устройствам, зарегистрированным в Intune;
* ограничение расположения пользователей и диапазонов IP-адресов.

Сведения обо всех возможностях условного доступа см. в статье [Что собой представляет условный доступ](../conditional-access/overview.md).

Эта статья адресуется разработчикам, создающим приложения для Azure AD. В ней показано, как можно использовать условный доступ, и описано влияние на доступ к неконтролируемым ресурсам, к которым могут применяться политики условного доступа. В статье рассматриваются последствия применения условного доступа в потоке On-Behalf-Of, веб-приложениях, а также при доступе к Microsoft Graph и вызове API.

Предполагается знание [однотенантных](quickstart-register-app.md) и [мультитенантных](howto-convert-app-to-be-multi-tenant.md) приложений, а также [распространенных шаблонов аутентификации](./authentication-vs-authorization.md).

> [!NOTE]
> Для использования этой функции требуется лицензия Azure AD Premium P1. Чтобы найти подходящую лицензию, ознакомьтесь с разделом [Сравнение общедоступных функций выпусков Free, Basic и Premium](https://azure.microsoft.com/pricing/details/active-directory/).
> Клиенты с [лицензиями Microsoft 365 бизнес](/office365/servicedescriptions/microsoft-365-service-descriptions/microsoft-365-business-service-description) также имеют доступ к функциям условного доступа.

## <a name="how-does-conditional-access-impact-an-app"></a>Как условный доступ влияет на приложения

### <a name="app-types-impacted"></a>Затронутые типы приложений

В самых распространенных случаях условный доступ не изменяет поведение приложения и не требует внесения изменений разработчиком. Только в некоторых случаях, когда приложение опосредованно или автоматически запрашивает маркер для службы, для приложения требуется изменить код, чтобы устранить проблемы, связанные с применением условного доступа. Это может быть так же просто, как выполнение запроса на интерактивный вход.

В частности, изменить код требуется в следующих сценариях, чтобы решить задачу реализации условного доступа:

* приложения, выполняющие поток On-Behalf-Of;
* приложения, получающие доступ к нескольким службам или ресурсам;
* одностраничные приложения, использующие MSAL.js;
* веб-приложения, которые вызывают ресурс.

Политики условного доступа могут применяться не только к приложению, но и к веб-API, к которому получает доступ ваше приложение. Сведения о том, как настроить политику условного доступа, см. в статье [Руководство по защите событий входа с помощью Многофакторной идентификации Azure](../authentication/tutorial-enable-azure-mfa.md).

В зависимости от сценария корпоративный клиент может в любое время применять и удалять политики условного доступа. Чтобы ваше приложение продолжало функционировать при применении новой политики, необходимо реализовать обработку запросов. В следующих примерах показана обработка запроса.

### <a name="conditional-access-examples"></a>Примеры реализации условного доступа

В некоторых сценариях требуется изменять код для применения условного доступа, тогда как в других — нет. Ниже приводятся несколько сценариев применения многофакторной проверки подлинности с помощью условного доступа, демонстрирующие особенности его реализации.

* Вы создаете приложение iOS с одним клиентом и применяете политику условного доступа. В приложении выполняется вход пользователя и оно не запрашивает доступ к API. При входе пользователя в систему политика автоматически вызывается и пользователю необходимо выполнить многофакторную проверку подлинности (MFA).
* Вы создаете собственное приложение, в котором используется служба среднего уровня для доступа к нисходящему API. Корпоративный клиент в организации, использующей это приложение, применяет политику к нисходящему API. Когда пользователь входит в систему, собственное приложение запрашивает доступ к среднему уровню и отправляет маркер. Средний уровень выполняет поток On-Behalf-Of для запроса доступа к нисходящему API. На этом этапе запрос утверждений передается на средний уровень. Средний уровень возвращает запрос собственному приложению, которое должно соответствовать политике условного доступа.

#### <a name="microsoft-graph"></a>Microsoft Graph

При создании приложений для работы с Microsoft Graph в средах условного доступа следует учитывать ряд моментов. В целом механизм условного доступа работает одинаково, но политики, которые видят пользователи, будут основываться на базовых данных, запрашиваемых приложением из графа.

В частности, все области Microsoft Graph представляют собой некоторый набор данных, к которому можно применить политики. Так как политикам условного доступа назначаются определенные наборы данных, Azure AD будет применять политики условного доступа на основе данных Graph, а не самого этого компонента.

Например, если приложение запрашивает следующие области Microsoft Graph,

```
scopes="Bookings.Read.All Mail.Read"
```

можно предположить, что пользователи будут выполнять все политики, заданные в Bookings и Exchange. Некоторые области могут сопоставляться с несколькими наборами данных, если предоставляется необходимый доступ.

### <a name="complying-with-a-conditional-access-policy"></a>Соответствие политике условного доступа

В некоторых топологиях политика условного доступа оценивается при начале сеанса. Так как политика условного доступа работает на уровне приложений и служб, момент ее вызова в значительной степени зависит от сценария, который вы пытаетесь реализовать.

Когда приложение пытается получить доступ к службе, для которой действует политика условного доступа, может возникнуть запрос условного доступа. Этот запрос кодируется в параметре `claims`, который поступает в ответе Azure AD. Ниже приведен пример этого параметра запроса:

```
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

Разработчики могут воспользоваться этим запросом и добавить его в новый запрос к Azure AD. При передаче этого состояния пользователю предлагается выполнить некоторое действие, необходимое для соответствия политике условного доступа. В следующих сценариях описываются особенности ошибок и представлены сведения о том, как извлечь параметр.

## <a name="scenarios"></a>Сценарии

### <a name="prerequisites"></a>Предварительные требования

Условный доступ Azure AD — это функция, доступная в [Azure AD Premium](../fundamentals/active-directory-whatis.md). Клиенты с [лицензиями Microsoft 365 бизнес](/office365/servicedescriptions/microsoft-365-service-descriptions/microsoft-365-business-service-description) также имеют доступ к функциям условного доступа.

### <a name="considerations-for-specific-scenarios"></a>Рекомендации для конкретных сценариев

Указанные сведения применимы только в следующих сценариях условного доступа:

* приложения, выполняющие поток On-Behalf-Of;
* приложения, получающие доступ к нескольким службам или ресурсам;
* одностраничные приложения, использующие MSAL.js;

В следующих разделах рассматриваются более сложные сценарии. Основной принцип работы заключается в том, что политики условного доступа оцениваются во время запроса маркера для службы, к которой применена политика условного доступа.

## <a name="scenario-app-performing-the-on-behalf-of-flow"></a>Сценарий: приложение, выполняющее поток On-Behalf-Of

В этом сценарии рассматривается вариант, при котором собственное приложение вызывает веб-службу или API. Эта служба, в свою очередь, выполняет поток On-Behalf-Of для вызова подчиненной службы. В нашем случае применяется политика условного доступа к подчиненной службе (веб-API 2) и используется собственное приложение, а не серверное приложение или управляющая программа.

![Схема приложения, выполняющего поток On-Behalf-Of](./media/v2-conditional-access-dev-guide/app-performing-on-behalf-of-scenario.png)

В изначальном запросе маркера для веб-API 1 не отображается запрос на многофакторную проверку подлинности пользователя, так как веб-API 1 может не всегда получить доступ к подчиненному API. Когда веб-API 1 пытается запросить маркер от имени пользователя для веб-API 2, запрос завершается ошибкой, так как пользователь не выполнил вход и не прошел многофакторную проверку подлинности.

Azure AD возвращает ответ HTTP с некоторыми полезными данными:

> [!NOTE]
> В нашем примере это описание ошибки многофакторной проверки подлинности, но существует целый ряд ошибок `interaction_required`, которые могут быть связаны с условным доступом.

```
HTTP 400; Bad Request
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API 2 App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

В веб-API 1 перехватывается ошибка `error=interaction_required` и отправляется запрос `claims` в классическое приложение. На этом этапе классическое приложение может сделать новый вызов `acquireToken()` и добавить запрос `claims` в качестве дополнительного параметра строки запроса. Новый запрос требует от пользователя выполнить многофакторную проверку подлинности, отправить новый маркер в веб-API 1 и завершить поток On-Behalf-Of.

Чтобы опробовать этот сценарий, см. [пример кода .NET](https://github.com/Azure-Samples/active-directory-dotnet-native-aspnetcore-v2/tree/master/2.%20Web%20API%20now%20calls%20Microsoft%20Graph#handling-required-interactions-with-the-user-dynamic-consent-mfa-etc-). Он демонстрирует передачу запроса утверждений из веб-API 1 в собственное приложение и создание запроса в клиентском приложении.

## <a name="scenario-app-accessing-multiple-services"></a>Сценарий: приложение, обращающееся к нескольким службам

В этом сценарии рассматривается вариант, когда веб-приложение получает доступ к двум службам, одной из которых назначена политика условного доступа. В зависимости от логики приложения ему может не потребоваться доступ к обеим веб-службам. В этом сценарии порядок запроса маркера играет важную роль при взаимодействии с пользователем.

Предположим, что у нас есть веб-службы A и B. К веб-службе B применяется политика условного доступа. Хотя исходный интерактивный запрос на аутентификацию требует согласия для обеих служб, политика условного доступа используется не всегда. Если приложение запрашивает маркер для веб-службы B, тогда вызывается политика и последующие запросы к веб-службе A также выполняются следующим образом.

![Схема приложения, получающего доступ к нескольким службам](./media/v2-conditional-access-dev-guide/app-accessing-multiple-services-scenario.png)

Кроме того, если приложение изначально запрашивает маркер для веб-службы A, пользователь не вызывает политику условного доступа. Это позволяет разработчику приложения контролировать взаимодействие с пользователем, чтобы политика условного доступа не вызывалась постоянно. Самый сложный вариант — если пользователь после этого запросит маркер для веб-службы В. На этом шаге пользователь должен выполнить условия политики условного доступа. Когда приложение пытается выполнить операцию `acquireToken`, может произойти следующая ошибка (как показано на схеме ниже):

```
HTTP 400; Bad Request
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

![Приложение, получающее доступ к нескольким службам, запрашивающим новый маркер](./media/v2-conditional-access-dev-guide/app-accessing-multiple-services-new-token.png)

Если приложение использует библиотеку MSAL, при сбое получения маркера всегда осуществляется повторная попытка в интерактивном режиме. Во время такого интерактивного запроса пользователь может выполнить условия условного доступа, но только если запрос не является `AcquireTokenSilentAsync` или `PromptBehavior.Never`, иначе приложение должно выполнить интерактивный запрос ```AcquireToken```, чтобы пользователь мог обеспечить соответствие политике.

## <a name="scenario-single-page-app-spa-using-msaljs"></a>Сценарий: Одностраничные приложения, использующие MSAL.js

В этом сценарии рассматривается вариант, когда одностраничное приложение (SPA) использует MSAL.js для вызова защищенного условным доступом веб-API. Это простая архитектура с некоторыми особенностями, которые необходимо учитывать при реализации условного доступа.

В MSAL.js есть несколько функций получения маркеров: `loginPopup()`, `acquireTokenSilent(...)`, `acquireTokenPopup(…)` и `acquireTokenRedirect(…)`.

* `loginPopup()` получает маркер идентификатора через интерактивный запрос на вход, но не получает маркер доступа для любой службы (включая защищенный условным доступом веб-API).
* `acquireTokenSilent(…)` может использоваться для автоматического получения маркера доступа. Это означает, что он никогда не будет отображаться на пользовательском интерфейсе.
* `acquireTokenPopup(…)` и `acquireTokenRedirect(…)` используются для автоматического запроса маркера для ресурса. Это означает, что они всегда отображаются на пользовательском интерфейсе входа.

Если приложению требуется маркер доступа для вызова веб-API, оно попробует выполнить функцию `acquireTokenSilent(…)`. Если срок действия маркера истек или необходимо обеспечить соответствие политике условного доступа, функция *acquireToken* завершится сбоем и приложение будет использовать `acquireTokenPopup()` или `acquireTokenRedirect()`.

![Схема одностраничного приложения, использующего поток MSAL](./media/v2-conditional-access-dev-guide/spa-using-msal-scenario.png)

Давайте подробно рассмотрим пример со сценарием условного доступа. Пользователь только что зашел на веб-сайт и не имеет сеанса. Мы выполним вызов `loginPopup()` и получим идентификатор маркера без многофакторной проверки подлинности. Затем пользователь нажимает кнопку, которая требует от приложения запросить данные из веб-API. Приложение пытается выполнить вызов `acquireTokenSilent()`, но попытка завершается неудачей, так как пользователь еще не прошел многофакторную проверку подлинности и должен обеспечить соответствие политике условного доступа.

Azure AD отправляет следующий ответ HTTP:

```
HTTP 400; Bad Request
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API App/Client ID>'.
```

Приложению необходимо перехватить `error=interaction_required`. Приложение может использовать `acquireTokenPopup()` или `acquireTokenRedirect()` для того же ресурса. Пользователь вынужден пройти многофакторную проверку подлинности. После того как пользователь завершит многофакторную проверку подлинности, приложению выдается новый маркер доступа для запрашиваемого ресурса.

Чтобы проверить этот сценарий, см. [пример кода On-Behalf-Of JS SPA](https://github.com/Azure-Samples/active-directory-dotnet-native-aspnetcore-v2/blob/a2b257381b410c765ee01ecb611aa6f98c099eb1/2.%20Web%20API%20now%20calls%20Microsoft%20Graph/README.md). В этом примере кода для демонстрации этого сценария используется политика условного доступа и веб-API, зарегистрированный ранее с помощью JS SPA. Он демонстрирует, как правильно обрабатывать запросы утверждений и получать маркер доступа, который может использоваться для веб-API. Кроме того ознакомьтесь с общим [примером кода Angular.js](https://github.com/Azure-Samples/active-directory-javascript-graphapi-v2) для получения руководства по Angular SPA.

## <a name="see-also"></a>См. также раздел

* Дополнительные сведения о возможностях условного доступа см. в статье об [условном доступе в Azure Active Directory](../conditional-access/overview.md).
* Дополнительные примеры кода Azure AD доступны [здесь](sample-v2-code.md).
* Дополнительные сведения о пакете SDK ADAL и ссылки на справочную документацию см. в статье [Обзор библиотеки проверки подлинности Майкрософт (MSAL)](msal-overview.md).
* Дополнительные сведения о сценариях с несколькими клиентами см. в статье [Как реализовать вход любого пользователя Azure Active Directory (AD) с помощью шаблона мультитенантного приложения](howto-convert-app-to-be-multi-tenant.md).
* Изучите статью [Защита приложения SaaS IoT с помощью платформы удостоверений Майкрософт](/azure/architecture/example-scenario/iot-aad/iot-aad).