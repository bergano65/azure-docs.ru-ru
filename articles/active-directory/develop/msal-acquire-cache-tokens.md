---
title: Получение маркеров кэша & с помощью библиотеки проверки подлинности Майкрософт (MSAL) | Службы
titleSuffix: Microsoft identity platform
description: Дополнительные сведения о получении и кэшировании маркеров с помощью MSAL.
services: active-directory
author: mmacy
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: conceptual
ms.workload: identity
ms.date: 05/28/2020
ms.author: marsma
ms.reviewer: saeeda
ms.custom: aaddev
ms.openlocfilehash: 47af4015fa5c6d9a73ee597146890a29b4b9ef9d
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "88119901"
---
# <a name="acquire-and-cache-tokens-using-the-microsoft-authentication-library-msal"></a>Получение и кэширование маркеров с помощью библиотеки проверки подлинности Майкрософт (MSAL)

[Маркеры доступа](access-tokens.md) позволяют клиентам безопасно вызывать веб-API, защищенные платформой Azure. Существует несколько способов получить маркер с помощью библиотеки проверки подлинности Майкрософт (MSAL). Для некоторых требуется вмешательство пользователя через веб-браузер, а для других пользователей не требуется вмешательство пользователя. Как правило, метод, используемый для получения маркера, зависит от того, является ли приложение общедоступным клиентским приложением, таким как настольное приложение или мобильное приложение, или конфиденциальным клиентским приложением, например веб-приложением, веб-API или приложением управляющей программы.

MSAL кэширует маркер после того, как он был получен. Код приложения должен сначала попытаться получить маркер из кэша, прежде чем пытаться получить маркер другими способами.

Вы также можете очистить кэш токенов, удалив из него учетные записи. Однако он не удаляет файл cookie сеанса, который находится в браузере.

## <a name="scopes-when-acquiring-tokens"></a>Области при получении токенов

[Области](v2-permissions-and-consent.md) — это разрешения, предоставляемые веб-API, к которым клиентские приложения могут запрашивать доступ. Клиентские приложения запрашивают согласие пользователя на эти области при отправке запросов на аутентификацию для получения токенов, предоставляющих доступ к веб-API. MSAL позволяет получить токены для доступа к Azure AD для разработчиков (версии 1.0) и API-интерфейсов платформы удостоверений Майкрософт (версии 2.0). В запросах протокола версии 2.0 вместо ресурсов используются области. Дополнительные сведения о сравнении версий 1.0 и 2.0 см. [здесь](../azuread-dev/azure-ad-endpoint-comparison.md). В зависимости от того, какую версию токенов принимает веб-API, конечная точка версии 2.0 возвращает соответствующий маркер доступа в MSAL.

Для некоторых методов получения маркера MSAL требуется `scopes` параметр. `scopes`Параметр представляет собой список строк, объявляющих нужные разрешения и запрошенные ресурсы. Хорошо известными областями являются [разрешения Microsoft Graph](/graph/permissions-reference).

В MSAL также можно получить доступ к ресурсам версии 1.0. Дополнительные сведения см. в разделе [области действия для приложения v 1.0](msal-v1-app-scopes.md).

### <a name="request-scopes-for-a-web-api"></a>Области запроса для веб-API

Если приложению требуется запросить маркер доступа с конкретными разрешениями для API ресурсов, передайте области, содержащие универсальный код ресурса (URI) идентификатора приложения API в формате `<app ID URI>/<scope>` .

Некоторые примеры значений области для разных ресурсов:

- Microsoft Graph API: `https://graph.microsoft.com/User.Read`
- Пользовательский веб-API: `api://11111111-1111-1111-1111-111111111111/api.read`

Формат значения области зависит от ресурса (API), получающего маркер доступа, и от `aud` принимаемых им значений утверждений.

Только для Microsoft Graph `user.read` область сопоставляется с `https://graph.microsoft.com/User.Read` , и оба формата областей могут быть взаимозаменяемы.

Некоторые веб-API, такие как Azure Resource Manager API ( https://management.core.windows.net/) в завершающей косой черте ("/") в заявке на аудиторию ( `aud` ) маркера доступа. В этом случае передайте область как `https://management.core.windows.net//user_impersonation` , включая двойную косую черту ("//").

Для других интерфейсов API может потребоваться, чтобы *схема или узел не* включались в значение области, и ТРЕБОВАЛОСЬ только идентификатор приложения (GUID) и имя области, например:

`11111111-1111-1111-1111-111111111111/api.read`

> [!TIP]
> Если подчиненный ресурс не находится под контролем, может потребоваться попробовать другие форматы значений области (например, with/без схемы и узла), если при `401` передаче маркера доступа ресурсу возникли ошибки.

### <a name="request-dynamic-scopes-for-incremental-consent"></a>Запрос динамических областей для добавочного согласия

По мере изменения функций, предоставляемых приложением, или его требований, при необходимости можно запросить дополнительные разрешения с помощью параметра scope. Такие *динамические области* позволяют пользователям предоставлять добавочное согласие на области.

Например, вы можете войти в систему пользователя, но сначала запретить им доступ к любым ресурсам. Позже можно предоставить им возможность просматривать календарь, запросив область календаря в методе получения маркера и получив согласие пользователя. Например, запросив `https://graph.microsoft.com/User.Read` `https://graph.microsoft.com/Calendar.Read` области и.

## <a name="acquiring-tokens-silently-from-the-cache"></a>Получение токенов в автоматическом режиме (из кэша)

MSAL поддерживает кэш маркеров (или два кэша для конфиденциальных клиентских приложений) и кэширует маркер после его получения. Во многих случаях при попытке получить токен автоматически будет получен еще один токен с дополнительными областями в зависимости от токена в кэше. Также токен может автоматически обновляться, когда приближается завершение срока действия (так как кэш токенов содержит и токен обновления).

### <a name="recommended-call-pattern-for-public-client-applications"></a>Рекомендуемый шаблон вызова для общедоступных клиентских приложений

Код приложения сначала пытается получить маркер из кэша автоматически. Если вызов метода возвращает ошибку или исключение UI required (Требуется пользовательский интерфейс), попробуйте получить токен с помощью других средств.

Однако существует два потока, в которых **не следует** пытаться автоматически получить маркер:

- [Поток учетных данных клиента](msal-authentication-flows.md#client-credentials), который не использует кэш маркеров пользователя, но кэш маркеров приложения. Этот метод следит за проверкой кэша маркеров приложений перед отправкой запроса в службу маркеров безопасности (STS).
- [Поток кода авторизации](msal-authentication-flows.md#authorization-code) в веб-приложениях, так как он активирует код, полученный приложением при входе в систему, и имеет согласие на большее количество областей. Так как в качестве параметра передается код, а не учетная запись, метод не может просмотреть кэш до того, как будет активирован код, вызывающий вызов службы.

### <a name="recommended-call-pattern-in-web-apps-using-the-authorization-code-flow"></a>Рекомендуемый шаблон вызова в веб-приложениях с использованием потока кода авторизации

Для веб-приложений, использующих [поток кода авторизации OpenID Connect](v2-protocols-oidc.md), рекомендуется следующий шаблон действий в контроллерах:

- создание экземпляра конфиденциального клиентского приложения с помощью кэша токенов с использованием настраиваемой сериализации;
- получение токена с помощью потока кода авторизации.

## <a name="acquiring-tokens"></a>Получение токенов

Как правило, метод получения токена зависит от типа клиентского приложения (общедоступное или конфиденциальное).

### <a name="public-client-applications"></a>Общедоступные клиентские приложения

Для общедоступных клиентских приложений (классическое или мобильное приложение) справедливо следующее.

- Вы часто получаете токены в интерактивном режиме, выполняя вход пользователей с помощью пользовательского интерфейса или всплывающего окна.
- Вы можете [автоматически получить токен для вошедшего в систему пользователя](msal-authentication-flows.md#integrated-windows-authentication), используя встроенную проверку подлинности Windows (IWA/Kerberos), если классическое приложение выполняется на компьютере Windows, присоединенном к домену или Azure.
- Может [получить маркер с именем пользователя и паролем](msal-authentication-flows.md#usernamepassword) в клиентских приложениях .NET Framework для настольных компьютеров (не рекомендуется). Не используйте имя пользователя и пароль в конфиденциальных клиентских приложениях.
- Может получить маркер через [поток кода устройства](msal-authentication-flows.md#device-code) в приложениях, выполняющихся на устройствах без веб-браузера. Пользователю предоставляется URL-адрес и код, которые он вводит в веб-браузере на другом устройстве для входа в систему. После этого Azure AD отправляет токен обратно на устройство без браузера.

### <a name="confidential-client-applications"></a>Конфиденциальные клиентские приложения

Для конфиденциальных клиентских приложений (веб-приложение, веб-API или управляющее приложение, например служба Windows) вы:

- Получаете токены **для самого приложения**, а не для пользователя, с использованием [потока учетных данных клиента](msal-authentication-flows.md#client-credentials). Этот метод можно использовать для синхронизации средств или средств, которые обрабатывают пользователей как общие, а не для конкретного пользователя.
- Используйте [поток "от имени](msal-authentication-flows.md#on-behalf-of) " для веб-API, чтобы вызвать API от имени пользователя. Приложение идентифицируется с учетными данными клиента, чтобы получить маркер на основе пользовательского утверждения (например, SAML или маркера JWT). Этот поток используется приложениями, которым требуется доступ к ресурсам определенного пользователя в вызовах между службами.
- Получаете токены с помощью [потока кода авторизации](msal-authentication-flows.md#authorization-code) в веб-приложениях после входа пользователя через URL-адрес запроса авторизации. Этот механизм обычно используется в приложении OpenID Connect, что позволяет пользователю входить в систему с помощью OpenID Connect, а затем получать доступ к веб-API от имени пользователя.

## <a name="authentication-results"></a>Результаты аутентификации

Когда клиент запрашивает маркер доступа, Azure AD также возвращает результат проверки подлинности, включающий метаданные о маркере доступа. Эти сведения включают срок действия маркера доступа и области, для которых он действителен. Благодаря этим данным приложение может выполнять интеллектуальное кэширование маркеров доступа, не анализируя сам маркер. В результате аутентификации содержится следующая информация.

- [Маркер доступа](access-tokens.md) для доступа веб-API к ресурсам. Эта строка обычно является JWT в кодировке Base64, но клиент никогда не должен искать в маркере доступа. Формат не гарантирует стабильной, и его можно зашифровать для ресурса. Написание кода в зависимости от содержимого маркера доступа на клиенте является одним из наиболее распространенных источников ошибок и поврежденной логикой клиента.
- [Маркер идентификации](id-tokens.md) пользователя (JWT).
- Срок действия токена, то есть дата и время завершения его применимости.
- Идентификатор клиента содержит сведения о клиенте, в котором был найден пользователь. Для гостевых пользователей (сценарии Azure AD B2B) используется гостевой идентификатор клиента, а не уникальный клиент. Когда токен предоставляется в имени пользователя, результат аутентификации также содержит сведения об этом пользователе. Для потоков конфиденциальных клиентов, где токены запрашиваются без пользователя (для приложения), эта информация пользователя имеет значение NULL.
- Области, для которых выдан токен.
- Уникальный идентификатор пользователя.

## <a name="next-steps"></a>Дальнейшие шаги

Если вы используете MSAL для Java, ознакомьтесь с [сериализацией кэша пользовательских маркеров в MSAL для Java](msal-java-token-cache-serialization.md).

Узнайте об [обработке ошибок и исключений](msal-handling-exceptions.md).