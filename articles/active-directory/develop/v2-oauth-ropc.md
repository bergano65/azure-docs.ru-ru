---
title: Вход с помощью предоставления учетных данных владельца ресурса | Azure
titleSuffix: Microsoft identity platform
description: Поддержка внебраузерных потоков аутентификации с помощью предоставления учетных данных пароля владельца ресурса (ROPC).
services: active-directory
author: hpsin
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 05/18/2020
ms.author: hirsin
ms.reviewer: hirsin
ms.custom: aaddev
ms.openlocfilehash: bfc6b6fa6a2af8750c868aaacb289d39306ce06e
ms.sourcegitcommit: 318d1bafa70510ea6cdcfa1c3d698b843385c0f6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/21/2020
ms.locfileid: "83770982"
---
# <a name="microsoft-identity-platform-and-oauth-20-resource-owner-password-credentials"></a>Учетные данные владельца ресурса OAuth 2.0 для платформы удостоверений Майкрософт

Платформа удостоверений Майкрософт поддерживает [предоставление учетных данных владельца ресурса OAuth 2.0](https://tools.ietf.org/html/rfc6749#section-4.3), что позволяет приложению войти в систему, напрямую обрабатывая пароль.  В этой статье описывается, как программировать непосредственно в протокол в приложении.  По возможности рекомендуется использовать поддерживаемые библиотеки проверки подлинности Майкрософт (MSAL) вместо [получения маркеров и вызова защищенных веб-API](authentication-flows-app-scenarios.md#scenarios-and-supported-authentication-flows).  Также ознакомьтесь с [примерами приложений, которые используют MSAL](sample-v2-code.md).

> [!WARNING]
> Корпорация Майкрософт рекомендует _не_ использовать поток ROPC. В большинстве случаев доступны и рекомендуются более безопасные альтернативы. Для этого потока нужен очень высокий уровень доверия в приложении и он несет риски, которых нет в других потоках. Этот поток следует использовать только при невозможности использовать другие, более безопасные потоки.

> [!IMPORTANT]
>
> * Конечная точка платформы удостоверений Майкрософт поддерживает ROPC для клиентов AAD, но не для личных учетных записей. Это означает, что придется использовать конечную точку клиента (`https://login.microsoftonline.com/{TenantId_or_Name}`) или конечную точку `organizations`.
> * Пользователи личных учетных записей, приглашенные в клиент Azure AD, не могут использовать ROPC.
> * Пользователи учетных записей без пароля не смогут войти в систему через ROPC. Для таких случаев мы рекомендуем использовать для приложения другой поток.
> * Если пользователи должны использовать для входа в приложение [многофакторную проверку подлинности (MFA)](../authentication/concept-mfa-howitworks.md), они будут заблокированы.
> * ROPC не поддерживается в сценариях [гибридной федерации удостоверений](/azure/active-directory/hybrid/whatis-fed) (например, Azure AD и ADFS, используемые для проверки подлинности локальных учетных записей). Если пользователи полностью перенаправляются на страницу локальных поставщиков удостоверений, Azure AD не сможет проверить имя пользователя и пароль для этого поставщика удостоверений. Однако с ROPC поддерживается [сквозная проверка подлинности](/azure/active-directory/hybrid/how-to-connect-pta).

## <a name="protocol-diagram"></a>Схема протокола

На следующей схеме показано представление потока ROPC.

![Схема, показывающая поток учетных данных пароля владельца ресурса](./media/v2-oauth2-ropc/v2-oauth-ropc.svg)

## <a name="authorization-request"></a>Запрос авторизации

Весь поток ROPC выполняется в рамках одного запроса: он отправляет поставщику удостоверений идентификатор клиента и учетные данные пользователя, а в ответ получает от него маркеры. Перед этим клиент должен получить от пользователя адрес электронной почты (или другое имя участника-пользователя) и пароль. Сразу после успешного выполнения запроса клиент обязан безопасно удалить из памяти учетные данные пользователя. Ни в коем случае нельзя сохранять их.

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman.
> [![Попытайтесь выполнить этот запрос в Postman](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)


```HTTP
// Line breaks and spaces are for legibility only.  This is a public client, so no secret is required.

POST {tenant}/oauth2/v2.0/token
Host: login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&scope=user.read%20openid%20profile%20offline_access
&username=MyUsername@myTenant.com
&password=SuperS3cret
&grant_type=password
```

| Параметр | Условие | Описание |
| --- | --- | --- |
| `tenant` | Обязательно | Клиент каталога, в который пользователь выполняет вход. Его можно указать в виде GUID или понятного имени. Этот параметр не может иметь значение `common` или `consumers`, но может быть равен `organizations`. |
| `client_id` | Обязательно | Идентификатор приложения (клиента), назначенный вашему приложению на странице [регистрации приложений на портале Azure](https://go.microsoft.com/fwlink/?linkid=2083908). |
| `grant_type` | Обязательно | Нужно задать значение `password`. |
| `username` | Обязательно | Адрес электронной почты пользователя. |
| `password` | Обязательно | Пароль пользователя. |
| `scope` | Рекомендуемая | Разделенный пробелами список [областей](v2-permissions-and-consent.md) или разрешений, которые нужны приложению. В интерактивном потоке администратор или пользователь должен заранее дать согласие на эти области. |
| `client_secret`| Иногда требуется | `client_secret` или `client_assertion` невозможно добавить, если приложение является общедоступным клиентом.  Если приложение является конфиденциальным клиентом, его нужно включить. |
| `client_assertion` | Иногда требуется | Другая форма `client_secret`, созданная с помощью сертификата.  Дополнительные сведения см. в статье об [учетных данных сертификата](active-directory-certificate-credentials.md). |

### <a name="successful-authentication-response"></a>Успешный ответ аутентификации

Ниже приведен пример успешного ответа маркера:

```json
{
    "token_type": "Bearer",
    "scope": "User.Read profile openid email",
    "expires_in": 3599,
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD..."
}
```

| Параметр | Формат | Описание |
| --------- | ------ | ----------- |
| `token_type` | Строка | Всегда имеет значение `Bearer`. |
| `scope` | Строки, разделенные пробелами | Если возвращен маркер доступа, этот параметр содержит список областей, для которых действует этот маркер. |
| `expires_in`| INT | Количество секунд, в течение которых действует предоставленный маркер доступа. |
| `access_token`| Непрозрачная строка | Выдается для запрошенных [областей](v2-permissions-and-consent.md). |
| `id_token` | JWT | Выдается, если исходный параметр `scope` содержит область `openid`. |
| `refresh_token` | Непрозрачная строка | Выдается, если исходный параметр `scope` содержит `offline_access`. |

Вы можете использовать маркер обновления для получения новых маркеров доступа и маркеров обновления с помощью того же потока, который описан в [документации по потоку кода OAuth](v2-oauth2-auth-code-flow.md#refresh-the-access-token).

### <a name="error-response"></a>Сообщение об ошибке

Если пользователь не указал правильное имя пользователя или пароль, либо клиент не получил требуемое согласие, аутентификация завершается ошибкой.

| Error | Описание | Действие клиента |
|------ | ----------- | -------------|
| `invalid_grant` | Сбой аутентификации | Учетные данные указаны неверно или у клиента отсутствует согласие для запрошенных областей. Если области не предоставлены, возвращается ошибка `consent_required`. В этом случае клиент должен перенаправить пользователя в интерактивный интерфейс через веб-представление или браузер. |
| `invalid_request` | Запрос был неправильно сформирован | Тип предоставления разрешения не поддерживается для контекстов аутентификации `/common` или `/consumers`.  Вместо этого используйте `/organizations` или идентификатор клиента. |

## <a name="learn-more"></a>Дополнительные сведения

* Вы можете опробовать ROPC самостоятельно с помощью [примера консольного приложения](https://github.com/azure-samples/active-directory-dotnetcore-console-up-v2).
* Чтобы определить, стоит ли вам использовать конечную точку версии 2.0, ознакомьтесь с [ограничениями платформы удостоверений Майкрософт](active-directory-v2-limitations.md).
