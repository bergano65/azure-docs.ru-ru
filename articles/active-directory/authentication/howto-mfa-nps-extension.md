---
title: Использование многофакторной идентификации Azure с NPS — Azure Active Directory
description: Узнайте, как использовать возможности многофакторной идентификации Azure с существующей инфраструктурой проверки подлинности сервера политики сети (NPS).
services: multi-factor-authentication
ms.service: active-directory
ms.subservice: authentication
ms.topic: how-to
ms.date: 08/31/2020
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: michmcla
ms.collection: M365-identity-device-management
ms.custom: has-adal-ref
ms.openlocfilehash: 5095df51fe430990e200b7bc7c3ca03feb0799d5
ms.sourcegitcommit: d103a93e7ef2dde1298f04e307920378a87e982a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/13/2020
ms.locfileid: "91964287"
---
# <a name="integrate-your-existing-network-policy-server-nps-infrastructure-with-azure-multi-factor-authentication"></a>Интеграция существующей инфраструктуры сервера сетевых политик (NPS) с многофакторной идентификацией Azure

Расширение сервера политики сети (NPS) для многофакторной идентификации Azure позволяет добавлять облачные возможности MFA в инфраструктуру проверки подлинности с помощью существующих серверов. Расширение NPS позволяет добавить телефонный звонок, текстовое сообщение или запрос на подтверждение в мобильном приложении в существующий процесс аутентификации, позволяя обойтись без установки, настройки и поддержания новых серверов.

Расширение NPS выступает в качестве адаптера между RADIUS и облачной многофакторной идентификацией Azure, чтобы обеспечить второй фактор проверки подлинности для федеративных или синхронизированных пользователей.

## <a name="how-the-nps-extension-works"></a>Как работает расширение NPS

При использовании расширения NPS для многофакторной идентификации Azure поток проверки подлинности включает следующие компоненты:

1. **NAS или VPN-сервер** получает запросы от клиентов, использующих VPN-подключение, и преобразует их в запросы RADIUS, направляемые на серверы политики сети.
2. **Сервер политики сети** подключается к службам домен Active Directory (AD DS), чтобы выполнить первичную проверку подлинности для запросов RADIUS и при успешном выполнении передает запрос всем установленным расширениям.  
3. **Расширение NPS** активирует запрос к службе многофакторной идентификации Azure для дополнительной проверки подлинности. Когда расширение получает ответ (при условии, что запрос MFA выполнен успешно), расширение завершает процесс проверки подлинности, возвращая серверу NPS маркеры безопасности, которые включают утверждение многофакторной идентификации, выданное службой маркеров безопасности Azure.
4. **Azure MFA** взаимодействует с Azure Active Directory (Azure AD) для получения сведений о пользователе и выполняет дополнительную проверку подлинности с помощью метода проверки, настроенного для пользователя.

На следующей схеме обобщенно представлен поток запросов на проверку подлинности.

![Схема потока аутентификации для пользователя, выполняющего проверку подлинности через VPN-сервер на сервер политики сети и расширение NPS многофакторной идентификации Azure](./media/howto-mfa-nps-extension/auth-flow.png)

### <a name="radius-protocol-behavior-and-the-nps-extension"></a>Поведение протокола RADIUS и расширение NPS

Так как RADIUS является протоколом UDP, отправитель предполагает потери пакетов и ожидает ответа. Через некоторое время время ожидания соединения может истекает. В этом случае пакет отправляется повторно, так как отправитель предполагает, что пакет не получил доступ к назначению. В сценарии проверки подлинности в этой статье VPN-серверы отправляют запрос и ожидают ответа. Если время ожидания подключения истекло, VPN-сервер отправляет запрос повторно.

![Схема потока UDP-пакетов RADIUS и запросов после истечения времени ожидания в ответе от сервера политики сети](./media/howto-mfa-nps-extension/radius-flow.png)

Сервер политики сети может не отвечать на исходный запрос VPN-сервера до истечения времени ожидания соединения, так как запрос MFA может продолжать обрабатываться. Возможно, пользователь не ответил на запрос MFA, поэтому расширение NPS для многофакторной идентификации Azure ожидает завершения этого события. В этом случае сервер политики сети выявляет дополнительные запросы VPN-сервера в виде повторяющегося запроса. Сервер политики сети отклоняет эти дублирующие запросы VPN-сервера.

![Схема сервера политики сети, удаляющая дублирующиеся запросы с сервера RADIUS](./media/howto-mfa-nps-extension/discard-duplicate-requests.png)

Если взглянуть на журналы сервера политики сети, вы можете увидеть, что эти дополнительные запросы отбрасываются. Это поведение предназначено для защиты конечного пользователя от получения нескольких запросов на одну попытку проверки подлинности. Отклоненные запросы в журнале событий сервера политики сети не указывают на наличие проблем с сервером политики сети или расширением NPS многофакторной идентификации Azure.

Для снижения количества отклоненных запросов рекомендуется настроить для VPN-серверов время ожидания не менее 60 секунд. При необходимости или для уменьшения количества отклоненных запросов в журналах событий можно увеличить значение времени ожидания VPN-сервера 90 или 120 секунд.

Из-за этого поведения протокола UDP сервер политики сети может получить дублирующийся запрос и отправить еще одну строку MFA, даже после того, как пользователь уже ответил на первоначальный запрос. Чтобы избежать этого, расширение NPS для многофакторной идентификации Azure по-своему выполняет фильтрацию и отмену повторных запросов в течение 10 секунд после отправки ответа серверу VPN.

![Схема, с которой сервер политики сети продолжает удалять дублирующие запросы с VPN-сервера в течение десяти секунд после успешного ответа](./media/howto-mfa-nps-extension/delay-after-successful-authentication.png)

Опять же, вы можете увидеть отклоненные запросы в журналах событий NPS-сервера, даже если запрос многофакторной идентификации Azure был успешным. Это ожидаемое поведение, которое не указывает на проблему с сервером NPS или расширением NPS многофакторной идентификации Azure.

## <a name="plan-your-deployment"></a>Планирование развертывания

Расширение NPS автоматически обрабатывает избыточность, поэтому специальная настройка не требуется.

Вы можете создать столько серверов NPS с поддержкой многофакторной идентификации Azure, сколько требуется. При установке нескольких серверов для каждого из них следует использовать отдельный сертификат клиента. Создание сертификата для каждого сервера означает, что каждый сертификат можно обновлять отдельно и не беспокоиться о простоях на всех серверах.

VPN-серверы направляют запросы на проверку подлинности, поэтому им необходимо знать о новых NPS-серверах с поддержкой многофакторной идентификации Azure.

## <a name="prerequisites"></a>Предварительные требования

Расширение NPS предназначено для работы с существующей инфраструктурой. Прежде чем приступить к работе, убедитесь, что у вас есть следующие необходимые компоненты.

### <a name="licenses"></a>Лицензии

Расширение NPS для многофакторной идентификации Azure доступно клиентам с [лицензиями на службу многофакторной идентификации Azure](multi-factor-authentication.md). Лицензии на основе потребления для многофакторной идентификации Azure, например для каждого пользователя или лицензии на проверку подлинности, несовместимы с расширением NPS.

### <a name="software"></a>Программное обеспечение

Windows Server 2012 или более поздней версии.

### <a name="libraries"></a>Библиотеки

Необходимо вручную установить следующую библиотеку:

- [Распространяемый пакет Visual C++ для Visual Studio 2015](https://www.microsoft.com/download/details.aspx?id=48145)

Следующие библиотеки устанавливаются автоматически с расширением.

- [Распространяемые пакеты Visual C++ для Visual Studio 2013 (X64)](https://www.microsoft.com/download/details.aspx?id=40784)
- [Модуль Microsoft Azure Active Directory для Windows PowerShell, версия 1.1.166](https://www.powershellgallery.com/packages/MSOnline/1.1.166.0)

Модуль Microsoft Azure Active Directory для Windows PowerShell также устанавливается с помощью скрипта конфигурации, который выполняется в процессе установки, если он отсутствует. Нет необходимости устанавливать этот модуль заранее, если он еще не установлен.

### <a name="azure-active-directory"></a>Azure Active Directory

Все пользователи, использующие расширение NPS, должны быть синхронизированы с Azure AD с помощью Azure AD Connect и должны быть зарегистрированы для MFA.

При установке расширения вам потребуется *идентификатор клиента* и учетные данные администратора для клиента Azure AD. Чтобы получить идентификатор клиента, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com) как глобальный администратор клиента Azure.
1. Найдите и выберите **Azure Active Directory**.
1. На странице **Обзор** отображаются *сведения о клиенте* . Рядом с *идентификатором клиента*выберите значок **копирования** , как показано на снимке экрана ниже.

   ![Получение идентификатора клиента из портал Azure](./media/howto-mfa-nps-extension/azure-active-directory-tenant-id-portal.png)

### <a name="network-requirements"></a>Требования к сети

Сервер политики сети должен иметь возможность взаимодействия со следующими URL-адресами через порты 80 и 443:

* *HTTPS: \/ /adnotifications.WindowsAzure.com*
* *HTTPS: \/ /Login.microsoftonline.com*
* *HTTPS: \/ /Credentials.Azure.com*

Кроме того, для завершения [установки адаптера с помощью предоставленного сценария PowerShell](#run-the-powershell-script)требуется подключение к следующим URL-адресам:

* *HTTPS: \/ /Login.microsoftonline.com*
* *HTTPS: \/ /provisioningapi.microsoftonline.com*
* *HTTPS: \/ /aadcdn.msauth.NET*

## <a name="prepare-your-environment"></a>Подготовка среды

Перед установкой расширения NPS подготовьте среду для обработки трафика проверки подлинности.

### <a name="enable-the-nps-role-on-a-domain-joined-server"></a>Включение роли NPS на сервере, присоединенном к домену

Сервер политики сети подключается к Azure AD и проверяет подлинность запросов MFA. Выберите один сервер для этой роли. Рекомендуется выбрать сервер, который не обрабатывает запросы от других служб, так как расширение NPS выдает ошибки для всех запросов, которые не являются запросами RADIUS. Сервер NPS должен быть настроен в качестве основного и дополнительного сервера проверки подлинности для вашей среды. Он не может выполнять прокси-запросы RADIUS к другому серверу.

1. На сервере откройте **Диспетчер сервера**. *В меню быстрого* запуска выберите **Мастер добавления ролей и компонентов** .
2. Для типа установки выберите Установка на **основе ролей или компонентов**.
3. Выберите роль сервера **Службы политики сети и доступа**. На всплывающем окне может появиться сообщение о дополнительных функциях, необходимых для выполнения этой роли.
4. Продолжайте работу с мастером до страницы *подтверждения* . Когда все будет готово, нажмите кнопку **установить**.

Установка роли сервера NPS может занять несколько минут. По завершении перейдите к следующим разделам, чтобы настроить этот сервер для обработки входящих RADIUS-запросов из решения VPN.

### <a name="configure-your-vpn-solution-to-communicate-with-the-nps-server"></a>Настройка решения VPN для обмена данными с NPS-сервером

В зависимости от того, какое решение VPN используется, действия по настройке политики аутентификации RADIUS могут отличаться. Настройте политику VPN, чтобы она указывала на сервер NPS RADIUS.

### <a name="sync-domain-users-to-the-cloud"></a>Синхронизация пользователей домена с облаком

Возможно, этот шаг уже выполнен в клиенте, но рекомендуется еще раз убедиться, что служба Azure AD Connect недавно синхронизировала базы данных.

1. Войдите на [портал Azure](https://portal.azure.com) с использованием учетной записи администратора.
2. Щелкните **Azure Active Directory** > **Azure AD Connect**.
3. Убедитесь в том, что синхронизация находится в состоянии **Включена** и последняя синхронизация была выполнена менее часа назад.

Если необходимо запустить новый цикл синхронизации, см. раздел [Azure AD Connect Sync: Scheduler](../hybrid/how-to-connect-sync-feature-scheduler.md#start-the-scheduler).

### <a name="determine-which-authentication-methods-your-users-can-use"></a>Определение методов проверки подлинности, которые смогут использовать пользователи

Существует два фактора, влияющих на то, какие методы проверки подлинности доступны для развертывания расширения сервера политики сети (NPS):

1. Алгоритм шифрования пароля для обмена данными между клиентом RADIUS (VPN, сервером Netscaler или другим) и серверами NPS.
   - **PAP** поддерживает все методы проверки подлинности многофакторной идентификации Azure в облаке: телефонный звонок, односторонняя текстовое сообщение, уведомление мобильного приложения, токены оборудования OATH и код проверки мобильного приложения.
   - **CHAPV2** и **EAP** поддерживают телефонный звонок или уведомление мобильного приложения.

      > [!NOTE]
      > При развертывании расширения NPS используйте эти факторы, чтобы оценить, какие методы будут доступны для пользователей. Если клиент RADIUS поддерживает протокол PAP, а клиент UX не имеет полей ввода для проверки кода, тогда телефонный звонок или уведомление мобильного приложения являются подходящими вариантами.
      >
      > Кроме того, если ваш интерфейс VPN-клиента поддерживает поля ввода и настроена политика сетевого доступа, проверка подлинности может быть выполнена успешно. Однако ни один из атрибутов RADIUS, настроенных в политике сети, не будет применяться ни к каким устройствам доступа к сети, например к серверу RRAS, ни к VPN-клиенту. В результате VPN-клиент может иметь больше доступа, чем требуется, или меньше, чем без доступа.

2. Методы ввода, которые может обработать клиентское приложение (VPN, сервер Netscaler или другое). Например, может ли VPN-клиент разрешить пользователю вводить код проверки из мобильного приложения или текста?

Вы можете [отключить неподдерживаемые методы проверки подлинности](howto-mfa-mfasettings.md#verification-methods) в Azure.

### <a name="register-users-for-mfa"></a>Регистрация пользователей для использования MFA

Перед развертыванием и использованием расширения NPS необходимо зарегистрировать пользователей, которым требуется выполнить многофакторную идентификацию Azure, для MFA. Чтобы проверить расширение при развертывании, вам также потребуется по крайней мере одна тестовая учетная запись, которая полностью зарегистрирована для многофакторной идентификации Azure.

Если необходимо создать и настроить тестовую учетную запись, выполните следующие действия.

1. Войдите на сайт [https://aka.ms/mfasetup](https://aka.ms/mfasetup) с тестовой учетной записью.
2. Чтобы настроить методы проверки, следуйте инструкциям на экране.
3. В портал Azure как пользователь с правами администратора [Создайте политику условного доступа](howto-mfa-getstarted.md#create-conditional-access-policy) , чтобы требовать многофакторную проверку подлинности для тестовой учетной записи.

> [!IMPORTANT]
>
> Убедитесь, что пользователи успешно зарегистрировались для многофакторной проверки подлинности Azure. Если пользователи ранее регистрировались только для самостоятельного сброса пароля (SSPR), в их учетных записях включен параметр *StrongAuthenticationMethods*. Если настроен параметр *StrongAuthenticationMethods*, то применяется многофакторная проверка подлинности, даже если пользователь зарегистрирован только для SSPR.
>
> Можно включить объединенную регистрацию сведений о безопасности, которая одновременно настраивает SSPR и многофакторную проверку подлинности Azure. Дополнительные сведения см. в разделе [Включение объединенной регистрации сведений о безопасности в Azure Active Directory](howto-registration-mfa-sspr-combined.md).
>
> Можно также [заставить пользователей повторно регистрировать методы проверки подлинности](howto-mfa-userdevicesettings.md#manage-user-authentication-options), если они ранее включали только SSPR.

## <a name="install-the-nps-extension"></a>Установка расширения NPS

> [!IMPORTANT]
> Установите расширение NPS на другом сервере, который не является точкой доступа VPN.

### <a name="download-and-install-the-nps-extension-for-azure-mfa"></a>Скачивание и установка расширения NPS для MFA Azure

Чтобы скачать и установить расширение NPS, выполните следующие действия.

1. [Скачайте расширение NPS](https://aka.ms/npsmfa) из Центра загрузки Майкрософт.
1. Скопируйте этот двоичный файл на сервер политики сети, который требуется настроить.
1. Запустите файл *setup.exe* и следуйте инструкциям по установке. При возникновении ошибок убедитесь, что [библиотеки из раздела необходимые компоненты](#libraries) успешно установлены.

#### <a name="upgrade-the-nps-extension"></a>Обновление расширения NPS

Если позднее обновить существующую установку расширения NPS, чтобы избежать перезагрузки базового сервера, выполните следующие действия.

1. Удалите существующую версию.
1. Запустите новый установщик.
1. Перезапустите службу *сервера политики сети (IAS)* .

### <a name="run-the-powershell-script"></a>Запуск скрипта PowerShell

Установщик создает сценарий PowerShell в `C:\Program Files\Microsoft\AzureMfa\Config` (где `C:\` находится установочный диск). Этот сценарий PowerShell выполняет следующие действия при каждом запуске:

* создает самозаверяющий сертификат;
* связывает открытый ключ сертификата с субъектом-службой в Azure AD;
* Сохраняет сертификат в хранилище сертификатов локального компьютера.
* Предоставляет пользователю сети доступ к закрытому ключу сертификата.
* перезапускает службу NPS.

Если вы не хотите использовать собственные сертификаты (вместо самозаверяющих сертификатов, создаваемых сценарием PowerShell), запустите сценарий PowerShell, чтобы завершить установку расширения NPS. При установке расширения на нескольких серверах каждый сервер должен иметь собственный сертификат.

Чтобы обеспечить возможность балансировки нагрузки или избыточности, повторите эти действия на дополнительных серверах NPS, как нужно.

1. Откройте командную строку Windows PowerShell с правами администратора.
1. Перейдите в каталог, где установщик создал скрипт PowerShell:

   ```powershell
   cd "C:\Program Files\Microsoft\AzureMfa\Config"
   ```

1. Запустите сценарий PowerShell, созданный установщиком.

   > [!IMPORTANT]
   > Для клиентов, использующих облака Azure для государственных организаций или Azure для Китая в Китае, сначала измените `Connect-MsolService` командлеты в *AzureMfaNpsExtnConfigSetup.ps1* скрипте, чтобы включить параметры *AzureEnvironment* для требуемого облака. Например, укажите *-AzureEnvironment усговернмент* или *-AzureEnvironment AzureChinaCloud*.
   >
   > Дополнительные сведения см. в статье [Справочник по параметрам Connect-MsolService](/powershell/module/msonline/connect-msolservice#parameters).

   ```powershell
   .\AzureMfaNpsExtnConfigSetup.ps1
   ```

1. При появлении запроса войдите в Azure AD в качестве администратора.
1. PowerShell запросит ваш идентификатор клиента. Используйте *идентификатор GUID идентификатора клиента* , скопированный из портал Azure в разделе Предварительные требования.
1. После завершения скрипта отображается сообщение об успешном выполнении.  

Если срок действия предыдущего сертификата компьютера истек и был создан новый сертификат, необходимо удалить все сертификаты с истекшим сроком действия. Наличие сертификатов с истекшим сроком действия может вызвать проблемы с запуском расширения NPS.

> [!NOTE]
> При использовании собственных сертификатов вместо их создания с помощью сценария PowerShell убедитесь, что они соответствуют соглашению об именовании сервера политики сети. Имя субъекта должно быть равно **CN = \<TenantID\> , OU = Microsoft NPS Extension**.

### <a name="microsoft-azure-government-or-azure-china-21vianet-additional-steps"></a>Дополнительные действия по Microsoft Azure для государственных организаций или Azure для Китая (Microsoft)

Для клиентов, использующих облака Azure для государственных организаций или Azure для Китая, необходимо выполнить следующие дополнительные действия по настройке на каждом сервере политики сети.

> [!IMPORTANT]
> Эти параметры реестра следует настраивать только в том случае, если вы являетесь клиентом Azure для государственных организаций или Azure для Китая.

1. Если вы являетесь клиентом Azure для государственных организаций или Azure для Китая (21Vianet), откройте **редактор реестра** на сервере NPS.
1. Перейдите на страницу `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\AzureMfa`.
1. Для клиентов Azure для государственных организаций задайте следующие значения ключей:

    | Раздел реестра       | Значение |
    |--------------------|-----------------------------------|
    | AZURE_MFA_HOSTNAME | adnotifications.windowsazure.us   |
    | STS_URL            | https://login.microsoftonline.us/ |

1. Для клиентов Azure для Китая в Китае необходимо задать следующие значения ключей:

    | Раздел реестра       | Значение |
    |--------------------|-----------------------------------|
    | AZURE_MFA_HOSTNAME | adnotifications.windowsazure.cn   |
    | STS_URL            | https://login.chinacloudapi.cn/   |

1. Повторите предыдущие два шага, чтобы задать значения разделов реестра для каждого сервера NPS.
1. Перезапустите службу NPS для каждого сервера NPS.

    Чтобы минимизировать воздействие, выводите каждый сервер NPS из ротации NLB по одному и дожидайтесь завершения всех подключений.

### <a name="certificate-rollover"></a>Смена сертификатов

В выпуске *1.0.1.32* расширения NPS теперь поддерживается чтение нескольких сертификатов. Эта возможность помогает упростить обновление сертификатов до истечения срока их действия. Если в вашей организации запущена предыдущая версия расширения NPS, выполните обновление до версии *1.0.1.32* или более поздней.

Сертификаты, созданные скриптом `AzureMfaNpsExtnConfigSetup.ps1`, действительны в течение 2 лет. Наблюдение за сертификатами для истечения срока действия. Сертификаты для расширения NPS помещаются в хранилище сертификатов *локального компьютера* в папке *Личные* и *выдаются для* идентификатора клиента, предоставленного сценарию установки.

Если сертификат приближается к дате окончания срока действия, необходимо создать новый сертификат для замены истекающего.  Чтобы сделать это, следует еще раз запустить `AzureMfaNpsExtnConfigSetup.ps1` и при появлении запроса идентификатора клиента оставить прежний идентификатор. Этот процесс необходимо повторить на каждом сервере NPS в вашей среде.

## <a name="configure-your-nps-extension"></a>Настройка расширения NPS

После подготовки среды и расширения NPS, установленного на необходимых серверах, можно настроить расширение.

Этот раздел содержит рекомендации по проектированию и успешному развертыванию расширения NPS.

### <a name="configuration-limitations"></a>Ограничения конфигурации

- Расширение NPS для многофакторной идентификации Azure не включает средства для переноса пользователей и параметров с сервера MFA в облако. По этой причине мы рекомендуем вам использовать расширение для новых развертываний, а не для существующего развертывания. При использовании расширения в существующем развертывании пользователям придется еще раз подтвердить свою личность, чтобы заполнить сведения для MFA в облаке.  
- Расширение NPS использует имя участника-пользователя из локальной среды AD DS для идентификации пользователя в службе многофакторной идентификации Azure для выполнения вторичной проверки подлинности. Расширение можно настроить для использования другого идентификатора, например альтернативного имени входа или пользовательского AD DS поля, отличного от имени участника-пользователя. Дополнительные сведения см. в статье [Параметры расширенной конфигурации расширения NPS для Многофакторной идентификации](howto-mfa-nps-extension-advanced.md).
- Не все протоколы шифрования поддерживают все методы проверки.
   - **PAP** поддерживает такие методы: телефонный звонок, одностороннее текстовое сообщение, уведомление мобильного приложения и код проверки мобильного приложения.
   - **CHAPV2** и **EAP** поддерживают телефонный звонок или уведомление мобильного приложения.

### <a name="control-radius-clients-that-require-mfa"></a>Управление клиентами RADIUS, для которых требуется MFA

После включения MFA для клиента RADIUS с помощью расширения NPS все проверки подлинности для этого клиента необходимы для выполнения MFA. Если вы хотите включить MFA только для отдельных клиентов RADIUS, настройте два сервера NPS и установите расширение только на один из них.

Затем настройте для клиентов RADIUS, которые должны использовать MFA, отправку запросов на сервер NPS, на котором установлено это расширение. Всех остальных клиентов RADIUS направьте на другой сервер NPS, для которого расширение не используется.

### <a name="prepare-for-users-that-arent-enrolled-for-mfa"></a>Подготовка к входу пользователей, не зарегистрированных для MFA

Если у вас есть пользователи, не зарегистрированные для MFA, вы можете выбрать действие, которое будет выполняться при попытке проверки подлинности. Для управления этим поведением используйте параметр *REQUIRE_USER_MATCH* в пути реестра *разделе hklm\software\microsoft\azuremfa*. Здесь есть только один параметр конфигурации:

| Клавиши | Значение | По умолчанию |
| --- | ----- | ------- |
| REQUIRE_USER_MATCH | True или false | Не задано (эквивалентно значению True) |

Этот параметр определяет, что делать, если пользователь не зарегистрировался для MFA. Если ключ не существует, не задан или имеет значение *true*, а пользователь не зарегистрирован, расширение не сможет выполнить запрос mfa.

Если для ключа задано *значение false* и пользователь не зарегистрирован, проверка подлинности продолжается без выполнения mfa. Если пользователь зарегистрирован в MFA, он должен пройти проверку подлинности с помощью MFA, даже если для *REQUIRE_USER_MATCH* задано значение *false*.

Вы можете создать этот ключ и присвоить ему значение *false* , пока пользователи не будут подключены, и все еще не будут зарегистрированы для многофакторной идентификации Azure. Однако такая настройка ключа разрешает вход всем пользователям, которые не зарегистрированы для MFA, поэтому этот ключ следует удалить до начала использования в рабочей среде.

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="nps-extension-health-check-script"></a>Скрипт проверки работоспособности расширения NPS

Следующий скрипт можно использовать для выполнения основных этапов проверки работоспособности при устранении неполадок расширения NPS.

[MFA_NPS_Troubleshooter.ps1](/samples/azure-samples/azure-mfa-nps-extension-health-check/azure-mfa-nps-extension-health-check/)

### <a name="how-do-i-verify-that-the-client-cert-is-installed-as-expected"></a>Как проверить, правильно ли установлен сертификат клиента?

Найдите самозаверяющий сертификат, созданный установщиком в хранилище сертификатов, и убедитесь, что его закрытый ключ имеет разрешения, предоставленные пользователю *NETWORK SERVICE*. У сертификата есть имя субъекта **: CN \<tenantid\> , OU = Microsoft NPS Extension** .

Самозаверяющие сертификаты, созданные сценарием, имеют срок действия, состоящие `AzureMfaNpsExtnConfigSetup.ps1` из двух лет. При проверке установки сертификата следует также убедиться, что срок действия сертификата не истек.

### <a name="how-can-i-verify-that-my-client-certificate-is-associated-to-my-tenant-in-azure-ad"></a>Как проверить, связан ли мой клиентский сертификат с моим клиентом в Azure AD?

Откройте командную строку PowerShell и выполните следующие команды:

```powershell
import-module MSOnline
Connect-MsolService
Get-MsolServicePrincipalCredential -AppPrincipalId "981f26a1-7f43-403b-a875-f8b09b8cd720" -ReturnKeyValues 1
```

Эти команды выводят в сеанс PowerShell все сертификаты, благодаря которым ваш клиент связывается с экземпляром расширения NPS. Найдите свой сертификат путем экспорта сертификата клиента в виде файла *X. 509 (CER) с кодировкой Base-64* без закрытого ключа и сравните его со списком из PowerShell.

Следующая команда создаст файл с именем *нпсцертификате* в корне диска *C:* в формате *. cer*.

```powershell
import-module MSOnline
Connect-MsolService
Get-MsolServicePrincipalCredential -AppPrincipalId "981f26a1-7f43-403b-a875-f8b09b8cd720" -ReturnKeyValues 1 | select -ExpandProperty "value" | out-file c:\npscertificate.cer
```

После выполнения этой команды перейдите в корневую папку диска *C:* , найдите файл и дважды щелкните его. Перейдите к сведениям и прокрутите вниз до пункта "отпечаток". Сравните отпечаток сертификата, установленного на сервере, с этим сертификатом. Отпечатки сертификатов должны совпадать.

*Допустимые* и *Допустимые* метки времени, которые находятся в удобочитаемой форме, можно использовать для фильтрации очевидных несоответствия, если команда возвращает более одного сертификата.

### <a name="why-cannot-i-sign-in"></a>Почему не удается войти?

Проверьте, не истек ли срок действия пароля. Расширение NPS не поддерживает смену паролей в рамках рабочего процесса входа. Обратитесь за дополнительной помощью к ИТ-специалистам вашей организации.

### <a name="why-are-my-requests-failing-with-adal-token-error"></a>Почему запросы завершаются сбоем с ошибкой маркера ADAL?

Эта ошибка может быть вызвана одной из нескольких причин. Чтобы устранить неполадки, выполните следующие действия.

1. Перезагрузите сервер политики сети.
2. Убедитесь, что сертификат клиента установлен правильно.
3. Убедитесь, что сертификат связан с клиентом в Azure AD.
4. Убедитесь, что адрес `https://login.microsoftonline.com/` доступен с сервера, на котором выполняется расширение.

### <a name="why-does-authentication-fail-with-an-error-in-http-logs-stating-that-the-user-is-not-found"></a>Почему проверка подлинности завершается ошибкой, а в журналы HTTP заносится ошибка с сообщением о том, что пользователь не найден?

Убедитесь, что служба AD Connect запущена и что пользователь есть как в локальной среде AD DS, так и в Azure AD.

### <a name="why-do-i-see-http-connect-errors-in-logs-with-all-my-authentications-failing"></a>Почему в журналах отображаются ошибки подключения HTTP для всех попыток проверки подлинности?

Убедитесь, что адрес https://adnotifications.windowsazure.com доступен с сервера, на котором выполняется расширение NPS.

### <a name="why-is-authentication-not-working-despite-a-valid-certificate-being-present"></a>Почему аутентификация не работает, несмотря на наличие действительного сертификата?

Если срок действия предыдущего сертификата компьютера истек, и был создан новый сертификат, удалите все сертификаты с истекшим сроком действия. Сертификаты с истекшим сроком действия могут вызвать проблемы с запуском расширения NPS.

Чтобы проверить наличие действительного сертификата, проверьте *хранилище сертификатов учетной записи локального компьютера* с помощью MMC и убедитесь, что срок действия сертификата не прошел. Чтобы создать новый действительный сертификат, повторно выполните действия, описанные в разделе [Запуск скрипта установщика PowerShell](#run-the-powershell-script).

### <a name="why-do-i-see-discarded-requests-in-the-nps-server-logs"></a>Почему в журналах сервера политики сети отображаются отклоненные запросы?

Если значение времени ожидания слишком мало, VPN-сервер может отправить повторяющиеся запросы на сервер политики сети. Сервер политики сети обнаруживает эти дублирующие запросы и отклоняет их. Такое поведение характерно для разработки и не указывает на проблему с сервером NPS или расширением NPS многофакторной идентификации Azure.

Дополнительные сведения о том, почему отброшенные пакеты в журналах NPS-сервера см. в разделе [поведение протокола RADIUS и расширение NPS](#radius-protocol-behavior-and-the-nps-extension) в начале этой статьи.

## <a name="managing-the-tlsssl-protocols-and-cipher-suites"></a>Управление протоколами TLS и SSL, а также комплектами шифров

Рекомендуется отключить или удалить старые и более слабые комплекты шифров, если это не требуется для Организации. Сведения о том, как выполнить эту задачу, можно найти в статье [Управление протоколами SSL/TLS и комплектами шифров для AD FS](/windows-server/identity/ad-fs/operations/manage-ssl-protocols-in-ad-fs)

### <a name="additional-troubleshooting"></a>Дополнительные сведения об устранении неполадок

Дополнительные рекомендации по устранению неполадок и возможные решения см. в статье [Разрешение сообщений об ошибках из расширения NPS для многофакторной идентификации Azure](howto-mfa-nps-extension-errors.md).

## <a name="next-steps"></a>Дальнейшие действия

- [Общие сведения о сервере политики сети и его настройка в Windows Server](/windows-server/networking/technologies/nps/nps-top)

- Настройте альтернативные идентификаторы для входа или настройте список исключений IP-адресов, которым не нужно выполнять двухфакторную проверку подлинности, в [дополнительных параметрах конфигурации расширения NPS для Многофакторной идентификации](howto-mfa-nps-extension-advanced.md)

- См. дополнительные сведения об интеграции [шлюза удаленных рабочих столов](howto-mfa-nps-extension-rdg.md) и [VPN-серверов](howto-mfa-nps-extension-vpn.md) с помощью расширения NPS.

- [Устранение ошибок, связанных с расширением NPS для Многофакторной идентификации Azure](howto-mfa-nps-extension-errors.md)