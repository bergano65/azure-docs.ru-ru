---
title: Настройка расширения NPS для многофакторной проверки Подлинности Azure — Azure Active Directory
description: После установки расширения NPS выполните приведенные здесь действия для расширенной настройки, например создание утвержденного списка IP-адресов и замена имени участника-пользователя.
services: multi-factor-authentication
ms.service: active-directory
ms.subservice: authentication
ms.topic: conceptual
ms.date: 07/11/2018
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: michmcla
ms.collection: M365-identity-device-management
ms.openlocfilehash: 5bfae3b3be7812ff50ed90a61d495877141bbc7e
ms.sourcegitcommit: 90dcc3d427af1264d6ac2b9bde6cdad364ceefcc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/21/2019
ms.locfileid: "58309714"
---
# <a name="advanced-configuration-options-for-the-nps-extension-for-multi-factor-authentication"></a>Параметры расширенной конфигурации расширения NPS для Многофакторной идентификации

Расширение сервера политики сети (NPS) позволяет использовать облачные функции Многофакторной идентификации Azure в локальной инфраструктуре. В этой статье предполагается, что расширение уже установлено и вы хотите узнать, как настроить его для своих потребностей. 

## <a name="alternate-login-id"></a>Альтернативное имя пользователя

Так как расширение NPS подключается и к локальному, и к облачному каталогу, может возникнуть проблема, при которой имена участников-пользователей в локальной и облачной средах не совпадают. Чтобы решить эту проблему, используйте альтернативные имена пользователей. 

В расширении NPS можно настроить использование атрибута Active Directory вместо имени участника-пользователя для Многофакторной идентификации Azure. Это позволяет защитить локальные ресурсы с помощью двухфакторной проверки подлинности без изменения локальных имен участников-пользователей. 

Чтобы настроить альтернативные имена пользователей, перейдите к `HKLM\SOFTWARE\Microsoft\AzureMfa` и измените следующие значения реестра:

| ИМЯ | type | Значение по умолчанию | ОПИСАНИЕ |
| ---- | ---- | ------------- | ----------- |
| LDAP_ALTERNATE_LOGINID_ATTRIBUTE | строка | Empty | Укажите имя атрибута Active Directory, которое нужно использовать вместо имени участника-пользователя. Этот атрибут используется в качестве атрибута AlternateLoginId. Если это значение реестра указано как [допустимый атрибут Active Directory](https://msdn.microsoft.com/library/ms675090.aspx) (например, mail или displayName), тогда значение атрибута используется вместо имени участника-пользователя для проверки подлинности. Если значение реестра пустое или не настроено, тогда AlternateLoginId отключен и имя участника-пользователя используется для проверки подлинности. |
| LDAP_FORCE_GLOBAL_CATALOG | Логическое | Ложь | Используйте этот параметр, чтобы принудительно использовать глобальный каталог для поисков LDAP при поиске AlternateLoginId. Настройте контроллер домена в качестве глобального каталога, добавьте для него атрибут AlternateLoginId, а затем включите этот параметр. <br><br> Если LDAP_LOOKUP_FORESTS настроен (не пустой), **этот параметр будет устанавливаться со значением TRUE** независимо от значения параметра реестра. В этом случае расширению NPS требуется глобальный каталог с настроенным атрибутом AlternateLoginId для каждого леса. |
| LDAP_LOOKUP_FORESTS | строка | Empty | Предоставьте список разделенных точкой с запятой лесов для поиска. Например, *contoso.com;foobar.com*. Если значение реестра настроено, расширение NPS итеративно ищет все леса в порядке, в котором они были перечислены, и возвращает первое успешное значение AlternateLoginId. Если значение реестра не настроено, поиск AlternateLoginId ограничен текущим доменом.|

Для устранения проблем с альтернативным именем пользователя выполните рекомендуемые действия, описанные в разделе [Ошибки с альтернативным именем пользователя](howto-mfa-nps-extension-errors.md#alternate-login-id-errors).

## <a name="ip-exceptions"></a>Исключения IP-адресов

При необходимости отслеживать доступность сервера эти проверки не должны блокироваться запросами проверки. Например, если подсистемы балансировки нагрузки проверяют, какие серверы запущены, перед отправкой рабочей нагрузки. Вместо этого создайте список IP-адресов, которые используются учетными записями служб, и отключите для него требования Многофакторной идентификации. 

Чтобы настроить утвержденный список IP-адресов, перейдите к `HKLM\SOFTWARE\Microsoft\AzureMfa` и настройте следующий параметр реестра: 

| ИМЯ | type | Значение по умолчанию | ОПИСАНИЕ |
| ---- | ---- | ------------- | ----------- |
| IP_WHITELIST | строка | Empty | Предоставьте список разделенных точкой с запятой IP-адресов. Включите в него IP-адреса компьютеров, где создаются запросы к службе, например NAS- или VPN-сервер. Диапазоны IP-адресов и подсетей не поддерживаются. <br><br> Например, *10.0.0.1;10.0.0.2;10.0.0.3*.

При поступлении запроса с IP-адреса, который имеется в списке разрешений, двухфакторная проверка подлинности пропускается. Утвержденный список IP-адресов сравнивается с IP-адресом, который предоставляется в атрибуте *ratNASIPAddress* запроса RADIUS. При поступлении запроса RADIUS без атрибута ratNASIPAddress регистрируется следующее предупреждение: P_WHITE_LIST_WARNING:IP Whitelist is being ignored as source IP is missing in RADIUS request in NasIpAddress attribute (P_WHITE_LIST_WARNING: список разрешенных IP-адресов игнорируется, так как в атрибуте NasIpAddress запроса RADIUS отсутствует исходный IP-адрес).

## <a name="next-steps"></a>Дальнейшие действия

[Устранение ошибок, связанных с расширением NPS для Многофакторной идентификации Azure](howto-mfa-nps-extension-errors.md)
