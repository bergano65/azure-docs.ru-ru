---
title: Устранение неполадок в Azure AD пароли — Azure Active Directory
description: Понять, Azure AD пароль защиты Общие рекомендации по устранению
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: conceptual
ms.date: 02/01/2019
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: jsimmons
ms.collection: M365-identity-device-management
ms.openlocfilehash: 108ead982529d2ac6549cceffd9d2177ab6456bf
ms.sourcegitcommit: d83fa82d6fec451c0cb957a76cfba8d072b72f4f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/02/2019
ms.locfileid: "58863188"
---
# <a name="azure-ad-password-protection-troubleshooting"></a>Устранение неполадок с функцией защиты паролей Azure AD

После развертывания функции защиты паролей Azure AD может потребоваться устранить неполадки. В этой статье подробно рассматриваются некоторые общие шаги по устранению неполадок.

## <a name="the-dc-agent-cannot-locate-a-proxy-in-the-directory"></a>Агент контроллера домена не удается найти учетную запись-посредник в каталоге

Основной симптомом этой проблемы является 30017 события в журнале событий администрирования агента DC.

Обычно причиной этой проблемы является то, что прокси-сервер еще не был зарегистрирован. Если прокси-сервер зарегистрирован, до определенного агента DC возможность увидеть, что прокси-сервер может быть задержка из-за задержки репликации AD.

## <a name="the-dc-agent-is-not-able-to-communicate-with-a-proxy"></a>Агент контроллера домена не может взаимодействовать с прокси-сервера

Основной симптомом этой проблемы является 30018 события в журнале событий администрирования агента DC. Это может произойти по следующим причинам.

1. Агент контроллер домена находится в изолированной части сети, который не допускает сетевое подключение к зарегистрированным proxy(s). Эта проблема может быть expected\benign, поэтому до тех пор, пока другие DC агенты могли обмениваться данными с proxy(s) для загрузки политики паролей из Azure, которая будет получен контроллером домена, изолированное с помощью репликации файлов политики в общей папке sysvol.

1. Хост-компьютере прокси-сервер блокирует доступ к конечной точке модуля сопоставления конечной точки RPC (порт 135)

   Программа установки прокси-сервера для защиты паролей Azure AD автоматически создает правило входящего трафика брандмауэра Windows, которое разрешает доступ к порту 135. Если это правило позднее удален или отключен, агенты контроллера домена будут не удается связаться со службой прокси. Если вместо другого продукта брандмауэр был отключен builtin брандмауэра Windows, необходимо настроить этот брандмауэр, чтобы разрешить доступ к порту 135.

1. Хост-компьютере прокси-сервер блокирует доступ к конечной точке RPC (динамический или статический) слушал службой прокси-сервера

   Программа установки прокси-сервера для защиты паролей Azure AD автоматически создает брандмауэр Windows правилом, разрешающим доступ к входящие порты прислушалась к службе прокси-сервера для защиты паролей Azure AD. Если это правило позднее удален или отключен, агенты контроллера домена будут не удается связаться со службой прокси. Если вместо другого продукта брандмауэр был отключен builtin брандмауэра Windows, необходимо настроить, брандмауэр, чтобы разрешить доступ к входящие порты прислушалась к службе прокси-сервера для защиты паролей Azure AD. Эта конфигурация может быть сделан более точным, если служба прокси-сервер был настроен на прослушивание определенного статический RPC-порт (с помощью `Set-AzureADPasswordProtectionProxyConfiguration` командлет).

## <a name="the-proxy-service-can-receive-calls-from-dc-agents-in-the-domain-but-is-unable-to-communicate-with-azure"></a>Служба прокси-сервера может принимать вызовы от агентов на контроллер домена в домене, но не сможет обмениваться данными с Azure

1. Убедитесь, на компьютере прокси-сервер имеет подключение к конечным точкам, перечисленные в [требования к развертыванию](howto-password-ban-bad-on-premises-deploy.md).

1. Убедитесь, что леса и все прокси-сервера регистрации серверов в том же клиенте Azure.

   Это можно проверить, выполнив `Get-AzureADPasswordProtectionProxy` и `Get-AzureADPasswordProtectionDCAgent` командлеты PowerShell, затем сравнить `AzureTenant` каждого элемента, возвращаемый элемент. Для правильной работы они должны совпадать в рамках леса, для всех агентов DC и прокси-серверы.

   Если существует условие несоответствие регистрации клиента Azure, это можно исправить, запустив `Register-AzureADPasswordProtectionProxy` и/или `Register-AzureADPasswordProtectionForest` командлеты PowerShell, при необходимости используйте учетные данные из того же клиента Azure для всех регистраций.

## <a name="the-dc-agent-is-unable-to-encrypt-or-decrypt-password-policy-files-and-other-state"></a>Агенту контроллера домена не удалось зашифровать или расшифровать файлы политики паролей и других состояниях

Эту проблему можно манифеста с разнообразными симптомы, но обычно имеет распространенных причин.

Защита паролей AD Azure зависит от критических шифрования и расшифровки функции, предоставляемые службы распространения ключей Майкрософт, который доступен на контроллерах домена под управлением Windows Server 2012 и более поздних. KDS службы должна быть включена и работает на всех Windows Server 2012 и более поздних версий контроллеры домена в домене.

По умолчанию KDS службы режим запуска для службы настраивается как вручную (запуск триггера). Эта конфигурация означает, что первый раз, клиент пытается использовать службу, он запускается по запросу. Этот режим запуска службы по умолчанию приемлемо для защиты паролей Azure AD для работы.

Если был настроен режим запуска службы KDS отключено, эта конфигурация должны быть исправлены перед защиты паролей Azure AD будет работать должным образом.

— Это простой тест для этой проблемы вручную запустить службу KDS, либо с помощью консоли управления MMC службы, или с помощью других средств управления службами (например, выполните команду «net start kdssvc» с помощью консоли командной строки). KDS службы должен успешно запуститься и будут работать.

Основная причина для KDS службы, когда не удается запустить является расположен вне Подразделение контроллеров домена по умолчанию объекта контроллера домена Active Directory. Эта конфигурация не поддерживается службой KDS и не является ограничением, накладываемые защиты паролей Azure AD. Для исправления этого условия является перемещение объекта контроллера домена в расположение, в Подразделение контроллеров домена по умолчанию.

## <a name="weak-passwords-are-being-accepted-but-should-not-be"></a>Слабые пароли, принимаются, но не следует

Эта проблема может быть обусловлено несколькими причинами.

1. Агентов на контроллер домена: не удается загрузить политику или не удалось расшифровать существующие политики. Проверьте наличие возможных причин в разделе выше.

1. Режим принудительного применения политики паролей по-прежнему имеет значение "Аудит". Если действует эта конфигурация, его необходимо перенастройте для принудительно с помощью портала Azure AD пароли. См. в разделе [защиту паролем включить](howto-password-ban-bad-on-premises-operations.md#enable-password-protection).

1. Политика паролей отключена. Если действует эта конфигурация, перенастройте ее включить, с помощью портала Azure AD пароли. См. в разделе [защиту паролем включить](howto-password-ban-bad-on-premises-operations.md#enable-password-protection).

1. Не установлено программное обеспечение агента контроллера домена на всех контроллерах домена в домене. В этом случае сложно гарантировать, что удаленные клиенты Windows имеют своей целью определенного контроллера домена во время операции изменения пароля. Если предполагается успешно назначенный конкретный контроллер домена, где установлено программное обеспечение агента DC, можно проверить с двойной записи журнала событий контроллера домена агента администратора: независимо от результата, будет существовать по крайней мере одно событие, чтобы задокументировать результат пароль Проверка. Если нет события, для пользователя, пароль которого изменяется, изменить пароль скорее всего обработано с другого контроллера домена.

   Как альтернативный проверка попробуйте setting\changing пароли, войдя в систему непосредственно к контроллеру домена, где установлено программное обеспечение агента DC. Этот способ не рекомендуется для доменов Active Directory в рабочей среде.

   Во время добавочного развертывания программного обеспечения агента DC поддерживается накладываются следующие ограничения, корпорация Майкрософт настоятельно рекомендует, что программное обеспечение агента DC установлен на всех контроллерах домена в домене, как можно скорее.

1. Алгоритм проверки пароля может работает должным образом. См. в разделе [пароли проверка](concept-password-ban-bad.md#how-are-passwords-evaluated).

## <a name="directory-services-repair-mode"></a>Режим восстановления служб каталогов

Если контроллер домена загружается в режиме восстановления служб каталогов, служба агента DC обнаруживает это и будет вызывать все проверки пароля или действия применения быть отключены, вне зависимости от текущей активной политики конфигурации.

## <a name="emergency-remediation"></a>Аварийное исправление

Если служба агента контроллера домена вызывает проблемы, ее можно немедленно отключить. Библиотека DLL фильтрации паролей агента контроллера домена по-прежнему пытается вызвать нерабочую службу и регистрирует события предупреждения (10012, 10013), но все входящие пароли принимаются в течение этого времени. Затем служба агента контроллера домена также может быть настроена с помощью диспетчера управления службами Windows с типом запуска "Отключено" при необходимости.

Еще один способ устранения неполадки — установить для режима включения значение "Нет" на портале функции защиты паролей Azure AD. Как только обновленная политика будет скачана, каждая служба агента контроллера домена перейдет в режим бездействия, в котором все пароли принимаются как есть. Дополнительные сведения см. в разделе [Режим принудительного применения](howto-password-ban-bad-on-premises-operations.md#enforce-mode).

## <a name="domain-controller-demotion"></a>Понижение контроллера домена

Поддерживается понижение контроллера домена, который все еще запускает программное обеспечение агента контроллера. Администраторы должны знать, что программное обеспечение агента контроллера домена продолжает применять текущую политику паролей во время процедуры понижения. Новый пароль учетной записи локального администратора (указанный как часть операции понижения) проверяется, как и любой другой пароль. В ходе процедуры понижения контроллера домена корпорация Майкрософт рекомендует выбирать безопасные пароли для локальных учетных записей администратора. Однако проверка нового пароля учетной записи локального администратора с помощью программного обеспечения агента контроллера домена может мешать ранее созданным процедурам понижения.

После успешного понижения роли контроллера домена и перезагрузки и повторного запуска в качестве обычного рядового сервера программное обеспечение агента контроллера домена возвращается к работе в пассивном режиме. Затем его можно удалить в любое время.

## <a name="removal"></a>Удаление

Если решено удалить программное обеспечение для защиты паролей Azure AD и очистки из леса и домены в все связанные состояния, эту задачу можно выполнить, выполнив следующие действия:

> [!IMPORTANT]
> Важно выполнить эти шаги по порядку. Если какой-либо экземпляр службы прокси-сервера остается включенным, он будет периодически повторно создавать объект serviceConnectionPoint. Если какой-либо экземпляр службы агента контроллера домена остается включенным, он будет периодически повторно создавать объект serviceConnectionPoint и состояние sysvol.

1. Удалите программное обеспечение прокси-сервера со всех компьютеров. Для этого шага **не** требуется перезагрузка компьютера.
2. Удалите программное обеспечение агента контроллера домена со всех контроллеров. Для этого шага **требуется** перезагрузка компьютера.
3. Вручную удалите все точки подключения службы прокси-сервера в каждом контексте именования домена. Расположение этих объектов можно обнаружить с помощью следующей команды PowerShell Active Directory:

   ```powershell
   $scp = "serviceConnectionPoint"
   $keywords = "{ebefb703-6113-413d-9167-9f8dd4d24468}*"
   Get-ADObject -SearchScope Subtree -Filter { objectClass -eq $scp -and keywords -like $keywords }
   ```

   Не опускайте звездочку (*) в конце значения переменной $keywords.

   Полученные объекты, найденные с помощью команды `Get-ADObject`, затем можно переадресовать в `Remove-ADObject` или удалить вручную.

4. Вручную удалите все точки подключения агента контроллера домена в каждом контексте именования домена. Может существовать один эти объекты каждого контроллера домена в лесу, в зависимости от того, эта программа была установлена. Расположение этого объекта можно обнаружить с помощью следующей команды PowerShell Active Directory:

   ```powershell
   $scp = "serviceConnectionPoint"
   $keywords = "{2bac71e6-a293-4d5b-ba3b-50b995237946}*"
   Get-ADObject -SearchScope Subtree -Filter { objectClass -eq $scp -and keywords -like $keywords }
   ```

   Полученные объекты, найденные с помощью команды `Get-ADObject`, затем можно переадресовать в `Remove-ADObject` или удалить вручную.

   Не опускайте звездочку (*) в конце значения переменной $keywords.

5. Вручную удалите состояние конфигурации уровня леса. Состояние конфигурации леса поддерживается в контейнере в контексте именования конфигурации Active Directory. Его можно обнаружить и удалить следующим образом:

   ```powershell
   $passwordProtectionConfigContainer = "CN=Azure AD Password Protection,CN=Services," + (Get-ADRootDSE).configurationNamingContext
   Remove-ADObject -Recursive $passwordProtectionConfigContainer
   ```

6. Вручную удалите все сведения о состоянии sysvol, удалив следующую папку и все ее содержимое:

   `\\<domain>\sysvol\<domain fqdn>\AzureADPasswordProtection`

   При необходимости к этому пути также можно получить доступ локально на данном контроллере домена. Расположение по умолчанию будет выглядеть следующим образом:

   `%windir%\sysvol\domain\Policies\AzureADPasswordProtection`

   Этот путь будет другим, если общий ресурс sysvol настроен в нестандартном местоположении.

## <a name="next-steps"></a>Дальнейшие действия

[Часто задаваемые вопросы для защиты паролей Azure AD](howto-password-ban-bad-on-premises-faq.md)

Для получения дополнительной информации о глобальном и пользовательском запрещенных списках паролей см. статью [Запрет неверных паролей в организации](concept-password-ban-bad.md).
