---
title: Аварийное восстановление и Устойчивые функции Azure для географического распространения
description: Узнайте об аварийном восстановлении и географическом распределении в устойчивых функциях.
author: MS-Santi
ms.topic: conceptual
ms.date: 08/27/2020
ms.author: azfuncdf
ms.openlocfilehash: 01c400f51cce85ef39e9d39bcad1221253c6942d
ms.sourcegitcommit: 656c0c38cf550327a9ee10cc936029378bc7b5a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2020
ms.locfileid: "89071216"
---
# <a name="disaster-recovery-and-geo-distribution-in-azure-durable-functions"></a>Аварийное восстановление и географическое распространение в Azure Устойчивые функции

Корпорация Майкрософт стремится непрерывно поддерживать доступность служб Azure. Но иногда могут происходить незапланированные сбои служб. Если приложению требуется устойчивость, корпорация Майкрософт рекомендует настроить для приложения геоизбыточность. Кроме того, клиентам следует иметь план аварийного восстановления на случай регионального сбоя служб. Важной частью плана аварийного восстановления является подготовка к отслеживанию отказа на вторичную реплику приложения и хранилища в случае, если первичная реплика становится недоступной.

В Устойчивые функции все состояния сохраняются в службе хранилища Azure по умолчанию. [Центр задач](durable-functions-task-hubs.md) — это логический контейнер для ресурсов службы хранилища Azure, которые используются для [оркестрации](durable-functions-types-features-overview.md#orchestrator-functions) и [сущностей](durable-functions-types-features-overview.md#entity-functions). Функции Orchestrator, Activity и Entity могут взаимодействовать друг с другом только тогда, когда они принадлежат одному и тому же концентратору задач. Этот документ будет называться центрами задач при описании сценариев поддержания высокой доступности ресурсов службы хранилища Azure.

Оркестрации и сущности можно активировать с помощью [клиентских функций](durable-functions-types-features-overview.md#client-functions) , которые сами по себе активируются по протоколу HTTP или одной из других поддерживаемых типов триггеров функций Azure. Их также можно активировать с помощью [встроенных API HTTP](durable-functions-http-features.md#built-in-http-apis). Для простоты в этой статье основное внимание уделяется сценариям, связанным с хранилищем Azure и триггерами функций на основе HTTP, а можно повысить доступность и уменьшить время простоя во время аварийного восстановления. Другие типы триггеров, такие как служебная шина или триггеры Cosmos DB, не будут рассматриваться явным образом.

Следующие сценарии основаны на конфигурациях "активный — пассивный", так как они посвящены использованию службы хранилища Azure. В этом шаблоне выполняется развертывание резервной копии (пассивного) приложения-функции в другой регион. Диспетчер трафика будет отслеживать доступность основного (активного) приложения-функции для доступности HTTP. Если основное приложение выйдет из строя, будет выполнена отработка отказа в резервную копию приложения-функции. Дополнительные сведения см. в статье [метод маршрутизации трафика с приоритетом](../../traffic-manager/traffic-manager-routing-methods.md#priority-traffic-routing-method) [диспетчера трафика Azure](https://azure.microsoft.com/services/traffic-manager/).

> [!NOTE]
> - Предложенная конфигурация "активный — пассивный" гарантирует, что у клиента всегда будет возможность активировать новую оркестрацию через протокол HTTP. Однако, как следствие, если два приложения-функции совместно работают с одним и тем же концентратором задач в хранилище, некоторые транзакции фонового хранилища будут распределяться между ними. Таким образом, эта конфигурация включает в себя некоторые дополнительные затраты на исходящие данные для вторичного приложения-функции.
> - Основная учетная запись хранения и центр задач создаются в основном регионе и совместно используются обоими приложениями-функциями.
> - Все приложения-функции с избыточным развертыванием должны использовать одни и те же ключи доступа к функциям в случае активации через HTTP. Среда выполнения функций предоставляет [API управления](https://github.com/Azure/azure-functions-host/wiki/Key-management-API), который позволяет потребителям программно добавлять, удалять и обновлять ключи функций. Управление ключами также возможно с помощью [Azure Resource Manager API](https://www.markheath.net/post/managing-azure-functions-keys-2).

## <a name="scenario-1---load-balanced-compute-with-shared-storage"></a>Сценарий 1. Распределение нагрузки вычислений при использовании общего хранилища

Если в Azure происходит сбой инфраструктуры вычисления, приложение-функция может стать недоступным. Чтобы свести к минимуму вероятность такого простоя, в этом сценарии используются два приложения-функции, развернутые в разных регионах.
Диспетчер трафика настроен обнаруживать проблемы в основном приложении-функции и автоматически перенаправлять трафик в приложение-функцию во вторичном регионе. Приложения-функции совместно используют одну учетную запись службы хранилища Azure и центр задач. Таким образом состояние приложений-функций не будет потеряно и работу можно возобновить в обычном режиме. Когда работоспособность в основном регионе восстанавливается, диспетчер траффика Azure автоматически направляет запросы к этому приложению-функции.

![Схема, демонстрирующая сценарий 1.](./media/durable-functions-disaster-recovery-geo-distribution/durable-functions-geo-scenario01.png)

Этот сценарий развертывания обладает несколькими преимуществами:

- В случае сбоя инфраструктуры вычислений можно возобновить работу в области отработки отказа без потери данных.
- Диспетчер трафика выполняет автоматическую отработку отказа в работоспособное приложение функции автоматически.
- Диспетчер трафика автоматически настраивает направление трафика к основному приложению-функции после устранения сбоя.

Тем не менее, при использовании этого сценария учтите следующее:

- Если приложение-функция развертывается с помощью выделенного плана службы приложений, то репликация вычислений в центре обработки данных с отработкой отказа приводит к увеличению затрат.
- Этот сценарий охватывает сбои в инфраструктуре вычислений, но учетная запись хранилища остается единственной точкой отказа для приложения-функции. Если происходит сбой хранилища, приложение снижает время простоя.
- При отработке отказа приложения-функции будет увеличена задержка, так как оно будет получать доступ к своей учетной записи хранилища между регионами.
- Доступ приложения к службе хранения не из того региона, в котором он находится, влечет за собой более высокие затраты из-за исходящего трафика.
- Этот сценарий зависит от диспетчера трафика. Учитывая, [как работает диспетчер трафика](../../traffic-manager/traffic-manager-how-it-works.md), может потребоваться некоторое время, прежде чем клиентскому приложению, которое потребляет устойчивые функции, снова потребуется запрашивать адрес приложения-функции из диспетчера трафика.

> [!NOTE]
> Начиная с версии **v 2.3.0** расширения устойчивые функции, два приложения-функции могут быть безопасно запущены одновременно с одной и той же учетной записью хранения и конфигурацией концентратора задач. Первое приложение для запуска получит аренду больших двоичных объектов на уровне приложения, которая не позволяет другим приложениям украсть сообщения из очередей концентратора задач. Если первое приложение прекращает работу, срок аренды истекает и может быть получен вторым приложением, которое затем продолжит обрабатывать сообщения центра задач.
> 
> До версии 2.3.0 приложения функций, настроенные для использования одной и той же учетной записи хранения, будут обрабатывать сообщения и обновлять артефакты хранилища параллельно, что приводит к значительному увеличению задержек и исходящих расходов. Если на первичном и в реплике приложения когда-либо развернут другой код, даже временно, согласованность не может быть выполнена правильно из-за несогласованности функций Orchestrator в двух приложениях. Поэтому рекомендуется, чтобы все приложения, для которых требуется географическое распределение в целях аварийного восстановления, использовали v 2.3.0 или более высокий уровень устойчивого расширения.

## <a name="scenario-2---load-balanced-compute-with-regional-storage"></a>Сценарий 2. Распределение нагрузки вычислений при использовании регионального хранилища

В предыдущем сценарии рассматриваются только случаи сбоя в инфраструктуре вычислений. Если происходит сбой службы хранилища, это приведет к сбою приложения-функции.
Для обеспечения непрерывной работы устойчивых функций в этом сценарии используется локальная учетная запись хранения для каждого региона, в котором развернуто приложение-функция.

![Схема, демонстрирующая сценарий 2.](./media/durable-functions-disaster-recovery-geo-distribution/durable-functions-geo-scenario02.png)

Этот подход добавляет улучшения в предыдущий сценарий:

- При сбое приложения-функции диспетчер трафика выполняет отработку отказа в дополнительный регион. Тем не менее, так как приложение-функция использует собственную учетную запись хранения, устойчивые функции будут продолжать работать.
- Во время отработки отказа дополнительная задержка в регионе отработки отказа отсутствует, так как приложение-функция и учетная запись хранения являются соразмещены.
- Сбой уровня хранилища приведет к сбоям в устойчивых функциях, которые, в свою очередь, будут активировать перенаправление в регион отработки отказа. Опять же, так как приложение-функция и хранилище изолированы в регионе, устойчивые функции будут продолжать работать.

Что следует учитывать при работе с данным сценарием:

- Если приложение-функция развертывается с помощью выделенного плана службы приложений, то репликация вычислений в центре обработки данных с отработкой отказа приводит к увеличению затрат.
- Текущее состояние не выполняет отработку отказа. Это означает, что существующие оркестрации и сущности будут эффективно приостановлены и недоступны до восстановления основного региона.

Подводя итог, компромисс между первым и вторым сценариями заключается в том, что задержка сохраняется и затраты на исходящий трафик сведены к минимуму, но существующие оркестрации и сущности будут недоступны во время простоя. Допустимость этих компромиссов зависит от требований приложения.

## <a name="scenario-3---load-balanced-compute-with-grs-shared-storage"></a>Сценарий 3. Распределение нагрузки вычислений при использовании общего хранилища GRS

Этот сценарий является модификацией первого сценария, использующего общую учетную запись хранения. Основное отличие заключается в том, что учетная запись хранения создается с включенной георепликацией.
С функциональной точки зрения этот сценарий предоставляет те же преимущества, что и сценарий 1, но он обеспечивает дополнительные преимущества восстановления данных:

- Геоизбыточное хранилище (GRS) и геоизбыточное хранилище с доступом на чтение (RA-GRS) максимально увеличивают доступность учетной записи хранения.
- При наличии регионального сбоя службы хранилища можно [вручную запустить отработку отказа на вторичную реплику](../../storage/common/storage-initiate-account-failover.md). В экстренных ситуациях, когда значительная авария приводит к неработоспособности целого региона, корпорация Майкрософт может инициировать отработку отказа между регионами. В этом случае вам не нужно предпринимать какие-либо действия.
- В случае отработки отказа состояние устойчивых функций будет сохранено до последней репликации учетной записи хранения, которая обычно выполняется каждые несколько минут.

Как и в других сценариях, есть важные сведения, которые нужно учитывать:

- Отработка отказа для реплики может занять некоторое время. До завершения отработки отказа и обновления записей DNS службы хранилища Azure приложение-функция будет испытывать сбой.
- За использование учетных записей хранения с географической репликацией взимается увеличенная плата.
- GRS репликация копирует данные асинхронно. Некоторые последние транзакции могут быть потерны из-за задержки процесса репликации.

![Схема, демонстрирующая сценарий 3.](./media/durable-functions-disaster-recovery-geo-distribution/durable-functions-geo-scenario03.png)

> [!NOTE]
> Как описано в сценарии 1, настоятельно рекомендуется, чтобы приложения-функции, развертываемые с этой стратегией, использовали **v 2.3.0** или более поздней версии расширения устойчивые функции.

Дополнительные сведения см. в документации по [аварийному восстановлению службы хранилища Azure и отработке отказа учетной записи хранения](../../storage/common/storage-disaster-recovery-guidance.md) .

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Дополнительные сведения о проектировании высокодоступных приложений в службе хранилища Azure](../../storage/common/geo-redundant-design.md)
