---
title: Мониторинг Функций Azure
description: Сведения об использовании Azure Application Insights с решением "Функции Azure" для мониторинга выполнения функций.
ms.assetid: 501722c3-f2f7-4224-a220-6d59da08a320
ms.topic: conceptual
ms.date: 10/14/2020
ms.custom: devx-track-csharp, fasttrack-edit, contperfq2, devx-track-js
ms.openlocfilehash: 87c31df6ecb92acd5bedaee274f9886383e5c617
ms.sourcegitcommit: 4cb89d880be26a2a4531fedcc59317471fe729cd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/27/2020
ms.locfileid: "92668731"
---
# <a name="monitor-azure-functions"></a>Мониторинг Функций Azure

Решение [Функции Azure](functions-overview.md) предлагает встроенную интеграцию со службой [Azure Application Insights](../azure-monitor/app/app-insights-overview.md) для мониторинга функций. В этой статье представлен обзор возможностей мониторинга, предоставляемых Azure для мониторинга функций Azure.

Application Insights собирает данные журнала, производительности и ошибок. Благодаря автоматическому обнаружению аномалий производительности и предоставлению мощных средств аналитики можно легко диагностировать проблемы и лучше понять, как используются функции. Эти средства призваны помочь в постоянном повышении производительности и удобства использования функций. Вы даже можете применить Application Insights на этапе локальной работы над проектом приложения-функции. Дополнительные сведения см. в статье [Что такое Application Insights?](../azure-monitor/app/app-insights-overview.md).

Так как Application Insights инструментирование встроены в функции Azure, необходим допустимый ключ инструментирования для подключения приложения-функции к ресурсу Application Insights. Ключ инструментирования добавляется в параметры приложения при создании ресурса приложения-функции в Azure. Если у приложения-функции еще нет такого ключа, его можно [настроить вручную](configure-monitoring.md#enable-application-insights-integration).  

## <a name="application-insights-pricing-and-limits"></a>Стоимость и ограничения Application Insights

Вы можете испытать Application Insightsную интеграцию со службой "функции Azure", чтобы бесплатно применять ежедневное ограничение на объем данных, которые обрабатываются бесплатно.

Если включить Application Insights во время разработки, это ограничение может быть достигнуто во время тестирования. Azure отправляет уведомления на портале и по электронной почте при приближении к ежедневному ограничению. Если вы пропустите эти оповещения и превысите предельное значение, новые журналы не будут отображаться в Application Insights. Учитывайте ограничения, чтобы не тратить время на ненужное устранение неполадок. Дополнительные сведения см. в статье [Управление ценами и объемом данных в Application Insights](../azure-monitor/app/pricing.md).

> [!IMPORTANT]
> В Application Insights есть функция [выборки](../azure-monitor/app/sampling.md), которая позволяет избежать создания слишком большого объема данных телеметрии для завершенных выполнений в периоды пиковой нагрузки. Выборка включена по умолчанию. Если кажется, что некоторые данные отсутствуют, можно просто настроить параметры выборки в соответствии с конкретным сценарием мониторинга. Дополнительные сведения см. в разделе о [настройке выборки](configure-monitoring.md#configure-sampling).

Полный список функций Application Insights, доступных для приложения-функции, подробно описан в статье [Application Insights для функций, поддерживаемых в решении "Функции Azure"](../azure-monitor/app/azure-functions-supported-features.md).

## <a name="application-insights-integration"></a>Интеграция Application Insights

Как правило, экземпляр Application Insights создается при создании приложения функции. В этом случае ключ инструментирования, необходимый для интеграции, уже задан как параметр приложения с именем *APPINSIGHTS_INSTRUMENTATIONKEY* . Если по какой бы то ни было причине в приложении функции не установлен ключ инструментирования, необходимо [включить интеграцию с Application Insights](configure-monitoring.md#enable-application-insights-integration).  

## <a name="collecting-telemetry-data"></a>Сбор данных телеметрии

При включенной интеграции Application Insights данные телеметрии отправляются в подключенный экземпляр Application Insights. Эти данные включают журналы, созданные узлом функций, трассировки, записанные из кода функций, и данные о производительности. 

>[!NOTE]
>Помимо данных из функций и узла функций, можно также выполнять получение данных из [контроллера масштабирования функций](#scale-controller-logs).   

### <a name="log-levels-and-categories"></a>Уровни ведения журнала и категории

При записи трассировок из кода приложения необходимо назначить трассировку уровень ведения журнала. Уровни ведения журнала позволяют ограничить объем данных, собираемых из трассировок.  

[!INCLUDE [functions-log-levels](../../includes/functions-log-levels.md)]

Дополнительные сведения об уровнях ведения журнала см. в разделе [Настройка уровней ведения журнала](configure-monitoring.md#configure-log-levels).

Назначив зарегистрированные элементы категории, вы получите больший контроль над данными телеметрии, созданными из конкретных источников в приложении-функции. Категории упрощают выполнение анализа собранных данных. Трассировки, записанные в коде функции, назначаются отдельным категориям на основе имени функции. Дополнительные сведения о категориях см. в разделе [Настройка категорий](configure-monitoring.md#configure-categories).

### <a name="custom-telemetry-data"></a>Пользовательские данные телеметрии

В [C#](functions-dotnet-class-library.md#log-custom-telemetry-in-c-functions) и [JavaScript](functions-reference-node.md#log-custom-telemetry)для записи пользовательских данных телеметрии можно использовать пакет SDK для Application Insights.

### <a name="dependencies"></a>Зависимости

Начиная с версии 2. x функций, среда выполнения автоматически собирает данные о зависимостях для привязок, использующих определенные клиентские пакеты SDK. Application Insights собирает данные по следующим зависимостям:

+ Azure Cosmos DB; 
+ Центры событий Azure
+ Azure Service Bus
+ Службы хранилища Azure (BLOB-объекты, очереди и таблицы)

Также фиксируются HTTP-запросы и вызовы баз данных с помощью `SqlClient` . Полный список зависимостей, поддерживаемых Application Insights, см. в разделе [автоматических отслеживаний зависимостей](../azure-monitor/app/asp-net-dependencies.md#automatically-tracked-dependencies).

Application Insights создает _схему приложения_ собранных данных зависимостей. Ниже приведен пример схемы приложения функции триггера HTTP с выходной привязкой хранилища очередей.  

![Схема приложения с зависимостью](./media/functions-monitoring/app-map.png)

Зависимости записываются на `Information` уровне. Если фильтр фильтруется по адресу `Warning` или выше, данные зависимостей отображаться не будут. Кроме того, автоматическая коллекция зависимостей происходит в области, отличной от пользовательской. Чтобы записать данные зависимостей, убедитесь, что в узле задан уровень не ниже `Information` области пользователя ( `Function.<YOUR_FUNCTION_NAME>.User` ).

Кроме автоматического сбора данных о зависимостях, для записи пользовательских сведений о зависимостях в журналы можно также использовать один из Application Insights пакетов SDK для конкретного языка. Пример написания пользовательских зависимостей см. в одном из следующих примеров для конкретного языка:

+ [Раздел о записи пользовательской телеметрии в функциях C#](functions-dotnet-class-library.md#log-custom-telemetry-in-c-functions)
+ [Раздел о записи пользовательской телеметрии в функциях JavaScript](functions-reference-node.md#log-custom-telemetry) 

## <a name="writing-to-logs"></a>Запись в журналы 

Способ записи в журналы и используемые API-интерфейсы зависят от языка проекта приложения-функции.   
Дополнительные сведения о записи журналов из функций см. в разделе руководства разработчика для вашего языка.

+ [C# (библиотека классов .NET)](functions-dotnet-class-library.md#logging)
+ [Java](functions-reference-java.md#logger)
+ [JavaScript](functions-reference-node.md#write-trace-output-to-logs) 
+ [PowerShell](functions-reference-powershell.md#logging)
+ [Python](functions-reference-python.md#logging)

## <a name="streaming-logs"></a>Журналы потоковой передачи

При разработке приложения часто требуется узнать, какие записи записываются в журналы практически в реальном времени при работе в Azure.

Существует два способа просмотра потока данных журнала, создаваемых при выполнении функций.

* **Встроенная потоковая передача журналов** . Платформа Службы приложений позволяет просматривать поток файлов журналов приложений. Этот поток эквивалентен выходным данным при отладке функций во время [локальной разработки](functions-develop-local.md) , а также при использовании на портале вкладки " **тестирование** ". При этом отображаются все данные в журнале. Дополнительные сведения см. в разделе [Потоковая передача журналов](../app-service/troubleshoot-diagnostic-logs.md#stream-logs). Этот потоковый метод поддерживает только один экземпляр и не может использоваться с приложением, которое выполняется в Linux в плане потребления.

* **Live Metrics Stream** . Если приложение-функция [подключено к Application Insights](configure-monitoring.md#enable-application-insights-integration), можно просматривать данные журнала и другие метрики практически в реальном времени в портал Azure с помощью [Live Metrics Stream](../azure-monitor/app/live-stream.md). Используйте этот метод при мониторинге функций, выполняемых в нескольких экземплярах или в Linux в плане потребления. Этот метод использует [данные выборки](configure-monitoring.md#configure-sampling).

Потоки журнала можно просматривать как на портале, так и в большинстве локальных сред разработки. Сведения о том, как включить потоки журналов, см. [в статье Включение потоковой передачи журналов выполнения в службе "функции Azure](streaming-logs.md)".

## <a name="diagnostic-logs"></a>Журналы диагностики

_Эта функция доступна в предварительной версии._ 

Application Insights позволяет экспортировать данные телеметрии в долгосрочное хранение или другие службы Analysis Services.  

Поскольку функции также интегрируются с Azure Monitor, можно также использовать параметры диагностики для отправки данных телеметрии в различные назначения, включая журналы Azure Monitor. Дополнительные сведения см. в статье [Мониторинг Функций Azure с помощью журналов Azure Monitor](functions-monitor-log-analytics.md).

## <a name="scale-controller-logs"></a>Журналы контроллера масштабирования

_Эта функция доступна в предварительной версии._ 

[Контроллер масштабирования функций Azure](./functions-scale.md#runtime-scaling) наблюдает за экземплярами узла функций Azure, на котором выполняется приложение. Этот контроллер принимает решения о том, когда следует добавлять или удалять экземпляры на основе текущей производительности. Вы можете подать журналам контроллера масштабирования Application Insights, чтобы лучше понять, какие решения выполняет контроллер масштабирования для приложения-функции. Вы также можете хранить созданные журналы в хранилище BLOB-объектов для анализа другой службой. 

Чтобы включить эту функцию, добавьте параметр приложения с именем `SCALE_CONTROLLER_LOGGING_ENABLED` в параметры приложения функции. Дополнительные сведения см. в разделе [Настройка журналов контроллера масштабирования](configure-monitoring.md#configure-scale-controller-logs).

## <a name="report-issues"></a>Сообщение о проблемах

Чтобы сообщить о проблеме с интеграцией Функций Azure с Application Insights, внести предложение или отправить запрос, [создайте обращение в GitHub](https://github.com/Azure/Azure-Functions/issues/new).

## <a name="next-steps"></a>Дальнейшие действия

Для получения дополнительных сведений см. следующие ресурсы:

* [Application Insights](/azure/application-insights/)
* [Общие сведения о ведении журналов в ASP.NET Core](/aspnet/core/fundamentals/logging/)
