---
title: Учебник. Ограничение доступа к ресурсам PaaS с помощью портала Azure
description: В этом руководстве описано, как ограничить сетевой доступ к ресурсам Azure, таким как служба хранилища Azure и База данных SQL Azure, с помощью конечных точек служб для виртуальной сети и портала Azure.
services: virtual-network
documentationcenter: virtual-network
author: KumudD
manager: mtillman
editor: ''
tags: azure-resource-manager
Customer intent: I want only resources in a virtual network subnet to access an Azure PaaS resource, such as an Azure Storage account.
ms.assetid: ''
ms.service: virtual-network
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: virtual-network
ms.workload: infrastructure
ms.date: 12/11/2020
ms.author: kumud
ms.openlocfilehash: cb3a4b6a726ee9163582b15586c65fc750712c63
ms.sourcegitcommit: 1bdcaca5978c3a4929cccbc8dc42fc0c93ca7b30
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/13/2020
ms.locfileid: "97368299"
---
# <a name="tutorial-restrict-network-access-to-paas-resources-with-virtual-network-service-endpoints-using-the-azure-portal"></a>Руководство. Ограничение сетевого доступа к ресурсам PaaS с помощью конечных точек служб для виртуальной сети и портала Azure

Конечные точки служб для виртуальной сети позволяют ограничить сетевой доступ к некоторым ресурсам службы Azure определенной подсетью виртуальной сети. Можно также запретить доступ к ресурсам через Интернет. Конечные точки службы предоставляют прямое подключение из виртуальной сети к поддерживаемым службам Azure. Это позволяет использовать закрытый диапазон адресов виртуальной сети для доступа к службам Azure. Трафик, поступающий к ресурсам Azure через конечные точки службы, всегда остается в магистральной сети Microsoft Azure. В этом руководстве описано следующее.

> [!div class="checklist"]
> * Создание виртуальной сети с одной подсетью.
> * Добавление подсети и включение конечной точки службы.
> * Создание ресурса Azure и разрешение сетевого доступа к нему только из подсети.
> * Развертывание виртуальной машины в каждой подсети.
> * Подтверждение прав доступа к ресурсу из подсети.
> * Подтверждение запрета доступа к ресурсу из подсети и Интернета.

При необходимости инструкции из этого руководства можно выполнить с помощью [Azure CLI](tutorial-restrict-network-access-to-resources-cli.md) или [Azure PowerShell](tutorial-restrict-network-access-to-resources-powershell.md).

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="log-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу https://portal.azure.com.

## <a name="create-a-virtual-network"></a>Создание виртуальной сети

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Последовательно выберите элементы **Сеть** и **Виртуальные сети**.
3. Щелкните элемент **+ Добавить** и введите следующие сведения: 

   |Параметр|Значение|
   |----|----|
   |Подписка| Выберите свою подписку.|
   |Группа ресурсов | Выберите **Создать новую**, а затем введите *myResourceGroup*.|
   |Имя| Введите *myVirtualNetwork*. |
   |Регион| Выберите регион **(США) Восточная часть США**. |

   ![Ввод основных сведений о виртуальной сети](./media/tutorial-restrict-network-access-to-resources/create-virtual-network.png)

4. Щелкните **Далее: IP-адреса >**
   
   |Параметр|Значение|
   |----|----|
   |Адресное пространство IPv4| Оставьте значение по умолчанию. |
   |Имя подсети| Щелкните имя **default** и измените его на "Public".|
   |Диапазон адресов подсети| Оставьте значение по умолчанию.|

5. Щелкните **Далее: Безопасность >** 
   
   |Параметр|Значение|
   |----|----|   
   |Узел-бастион| Отключить|
   |Защита от атак DDoS| Отключить|
   |Брандмауэр| Отключить|

6. По завершении щелкните элемент **Просмотр и создание**.
7. Если проверки пройдены, щелкните элемент **Создать**.
8. Дождитесь завершения развертывания, а затем щелкните элемент **Перейти к ресурсу** или перейдите к следующему разделу. 

## <a name="enable-a-service-endpoint"></a>Включение конечной точки службы

Конечные точки службы включены для каждой службы, для каждой подсети. Чтобы создать подсеть и включить для нее конечную точку службы, сделайте следующее:

1. Если вы еще не перешли на страницу ресурса виртуальной сети, можно найти только что созданную сеть с помощью поля **Поиск ресурсов, служб и документов** в верхней части окна портала, введя *myVirtualNetwork*, и выбрать эту виртуальную сеть в списке.
2. В меню **Параметры** слева последовательно выберите элементы **Подсети** и **+ Подсеть**, как показано ниже:

    ![Добавление подсети](./media/tutorial-restrict-network-access-to-resources/add-subnet.png) 

3. В разделе **Добавление подсети** выберите или введите следующие сведения, а затем нажмите кнопку **ОК**.

    |Параметр|Значение|
    |----|----|
    |Имя| Private |
    |Диапазон адресов| Оставьте значение по умолчанию.|
    |Конечные точки служб| Выберите элемент **Microsoft.Storage**.|
    |Политики конечной точки службы | Сохраните значение по умолчанию 0. |

> [!CAUTION]
> Перед включением конечной точки службы для существующей подсети, которая содержит ресурсы, см. раздел [Изменение параметров подсети](virtual-network-manage-subnet.md#change-subnet-settings).

4. Нажмите кнопку **Сохранить** и закройте окно подсети справа. Только что созданная подсеть должна отобразиться в списке.

## <a name="restrict-network-access-for-a-subnet"></a>Ограничение сетевого доступа для подсети

По умолчанию все экземпляры виртуальных машин в подсети могут обмениваться данными со всеми ресурсами. Вы можете ограничить обмен данными со всеми ресурсами в подсети, создав группу безопасности сети и связав ее с подсетью:

1. Выберите **Все службы** в левом верхнем углу на портале Azure.
2. Выберите элемент **Сеть**, а затем — элемент **Группы безопасности сети** (или выполните поиск по этой фразе).
3. В колонке **Группы безопасности сети** выберите элемент **+ Добавить**.
4. Введите следующие сведения: 

    |Параметр|Значение|
    |----|----|
    |Подписка| Выберите свою подписку.|
    |Группа ресурсов | Выберите *myResourceGroup* в списке.|
    |Имя| Введите **myNsgPrivate**. |
    |Расположение| Выберите **Восточная часть США**. |

5. Щелкните элемент **Просмотр и создание** и после прохождения проверки щелкните элемент **Создать**.
6. После создания группы безопасности сети щелкните элемент **Перейти к ресурсу** или выполните поиск по имени *myNsgPrivate*.
7. В разделе **Параметры** слева выберите элемент **Правила безопасности для исходящего трафика**.
8. Щелкните **+ Добавить**.
9. Создайте правило, разрешающее исходящий обмен данными в службе хранилища Azure. Выберите или введите следующие сведения, а затем нажмите кнопку **Добавить**:

    |Параметр|Значение|
    |----|----|
    |Источник| Выберите **VirtualNetwork** (Виртуальная сеть). |
    |Диапазоны исходных портов| * |
    |Назначение | Выберите **Service Tag** (Тег службы).|
    |Тег целевой службы | Выберите **Хранилище**.|
    |Диапазоны портов назначения| Сохраните значение по умолчанию *8080*. |
    |Протокол|Любой|
    |Действие|Allow|
    |Приоритет|100|
    |Имя|Измените имя на **Allow-Storage-All**.|

10. Создайте другое правило безопасности, которое запрещает исходящие подключения через Интернет. Это правило переопределяет правило по умолчанию во всех группах безопасности сети, которое позволяет исходящую связь через Интернет. Выполните описанные выше шаги 6–9, указав следующие значения:

    |Параметр|Значение|
    |----|----|
    |Источник| Выберите **VirtualNetwork** (Виртуальная сеть). |
    |Диапазоны исходных портов| * |
    |Назначение | Выберите **Service Tag** (Тег службы).|
    |Тег целевой службы| Выберите **Интернет**.|
    |Диапазоны портов назначения| * |
    |Протокол|Любой|
    |Действие|**Измените значение по умолчанию на *Запретить***. |
    |Приоритет|110|
    |Имя|Измените имя на *Deny-Internet-All*.|

11. Создайте *правило безопасности, которое разрешает для подсети входящий трафик* протокола удаленного рабочего стола (RDP), поступающий из любого расположения. Это правило переопределяет правило безопасности по умолчанию, запрещающее весь входящий трафик из Интернета. Подключения к удаленному рабочему столу в подсети разрешены, чтобы позже можно было проверить подключение. 
12. В разделе **Параметры** выберите **Правила безопасности для входящего трафика**.
13. Выберите элемент **+ Добавить** и используйте следующие значения:

    |Параметр|Значение|
    |----|----|
    |Источник| Любой |
    |Диапазоны исходных портов| * |
    |Назначение | Выберите **VirtualNetwork** (Виртуальная сеть).|
    |Диапазоны портов назначения| Измените значение на *3389*. |
    |Протокол|Любой|
    |Действие|Allow|
    |Приоритет|120|
    |Имя|Измените имя на *Allow-RDP-All*.|

   >[!WARNING] 
   > RDP-порт 3389 доступен через Интернет. Рекомендуется использовать его только для тестирования. Для *рабочих сред* мы рекомендуем использовать VPN или частное подключение.

1.  В разделе **Параметры** выберите **Подсети**.
2.  Щелкните **+ Associate** (+ Связать).
3.  В разделе **Виртуальная сеть** выберите элемент **myVirtualNetwork**.
4.  В разделе **Подсеть** выберите элемент **Private** и нажмите кнопку **ОК**.

## <a name="restrict-network-access-to-a-resource"></a>Ограничение сетевого доступа к ресурсу

Действия, требуемые для ограничения сетевого доступа к ресурсам, которые созданы с помощью служб Azure, использующих конечные точки службы, зависят от службы. Ознакомьтесь с документацией по отдельным службам, чтобы получить точные инструкции для них. В оставшейся части этого руководства в качестве примера приведены инструкции по ограничению сетевого доступа для учетной записи хранения Azure.

### <a name="create-a-storage-account"></a>Создание учетной записи хранения

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. В строке поиска введите фразу "учетная запись хранения" и выберите ее в раскрывающемся меню.
3. Щелкните **+ Добавить**.
4. Введите следующие сведения:

    |Параметр|Значение|
    |----|----|
    |Подписка| Выберите свою подписку.|
    |Группа ресурсов| Выберите *MyResourceGroup*.|
    |Имя учетной записи хранения| Введите имя, которое является уникальным для всех расположений Azure, содержащим только цифры и строчные буквы (длиной от 3 до 24 знаков).|
    |Расположение| Выберите регион **(США) Восточная часть США**. |
    |Производительность|Стандартный|
    |Тип учетной записи| StorageV2 (учетная запись общего назначения версии 2)|
    |Репликация| Локально избыточное хранилище (LRS)|

5. Выберите элемент **Просмотр и создание** и после прохождения проверки щелкните элемент **Создать**. 

>[!NOTE] 
> Развертывание может занять несколько минут.

6. После создания учетной записи хранения щелкните элемент **Перейти к ресурсу**.

### <a name="create-a-file-share-in-the-storage-account"></a>Создание файлового ресурса в учетной записи хранения

1. Перейдите к странице обзора своей учетной записи хранения.
2. Выберите значок приложения **Общие папки**, а затем щелкните элемент **+ Общая папка**.

    |Параметр|Значение|
    |----|----|
    |Имя| my-file-share|
    |Quota| Щелкните элемент "Установить максимальное значение" |

   ![Учетная запись хранения](./media/tutorial-restrict-network-access-to-resources/storage-account.png) 

3. Нажмите кнопку **Создать**.
4. Общая папка должна отображаться в окне Azure. Если это не так, щелкните элемент **Обновить**.

### <a name="restrict-network-access-to-a-subnet"></a>Ограничение сетевого доступа к подсети

По умолчанию учетные записи хранения принимают сетевые подключения от клиентов из любой сети, включая Интернет. Вы можете ограничить сетевой доступ из Интернета и всех других подсетей во всех виртуальных сетях (за исключением подсети *Private* в виртуальной сети *myVirtualNetwork*). Ограничение сетевого доступа к подсети:

1. В разделе **Параметры** для своей учетной записи хранения (с уникальным именем) выберите элемент **Сеть**.
2. Выберите **Выбранные сети**.
3. Выберите элемент **+ Добавить существующую виртуальную сеть**.
4. В разделе **Добавить сети** укажите приведенные ниже значения, а затем щелкните **Добавить**.

    |Параметр|Значение|
    |----|----|
    |Подписка| Выберите свою подписку.|
    |Виртуальные сети| **myVirtualNetwork**|
    |Подсети| **Частная**|

    ![Снимок экрана: панель "Добавление сетей", где вы можете ввести указанные значения.](./media/tutorial-restrict-network-access-to-resources/virtual-networks.png)

5. Выберите элемент **Добавить** и сразу щелкните значок **Сохранить**, чтобы сохранить изменения.
6. В разделе **Параметры** учетной записи хранения выберите элемент **Ключи доступа**, как показано на следующем изображении:

      ![Снимок экрана: выбранный пункт "Ключи доступа" в параметрах, где вы можете получить ключ.](./media/tutorial-restrict-network-access-to-resources/storage-access-key.png)

7. Щелкните элемент **Показать ключи** и запишите значения **ключей**, так как позже значение key1 потребуется ввести вручную при сопоставлении общей папки с буквой диска на виртуальной машине.

## <a name="create-virtual-machines"></a>Создание виртуальных машин

Чтобы проверить сетевой доступ к учетной записи хранения, разверните виртуальную машину в каждой подсети.

### <a name="create-the-first-virtual-machine"></a>Создание первой виртуальной машины

1. На панели "Поиск ресурсов. . ." выполните поиск по фразе **Виртуальные машины**.
2. Выберите элементы **+ Добавить > Виртуальная машина**. 
3. Введите следующие сведения:

   |Параметр|Значение|
   |----|----|
   |Подписка| Выберите свою подписку.|
   |Группа ресурсов| Выберите группу **myResourceGroup, которая была создана ранее.|
   |Имя виртуальной машины| Введите *myVmPublic*.|
   |Регион | Восточная часть США (США)
   |Параметры доступности| Зона доступности|
   |Зона доступности | 1 |
   |Изображение | Windows Server 2019 Datacenter (поколение 1). |
   |Размер | Выберите размер экземпляра виртуальной машины, который хотите использовать. |
   |Имя пользователя|Введите выбранное имя пользователя.|
   |Пароль| Введите выбранный пароль. Пароль должен включать минимум 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).|
   |Общедоступные входящие порты | Разрешить выбранные порты |
   |Выбрать входящие порты | Оставьте значение по умолчанию *RDP (3389)* . |

   ![Выбор виртуальной сети](./media/tutorial-restrict-network-access-to-resources/virtual-machine-settings.png)
  
4. Откройте вкладку **Сеть** и выберите элемент **myVirtualNetwork**. 
5. Выберите подсеть *Public*.
6. В разделе **Группа безопасности сети сетевого адаптера** выберите элемент **Дополнительно**. Портал автоматически создаст группу безопасности сети, которая открывает порт 3389. Это требуется для подключения к виртуальной машине на следующем шаге. 

   ![Ввод базовых сведений о виртуальной машине](./media/tutorial-restrict-network-access-to-resources/virtual-machine-basics.png)

7. Последовательно выберите элементы **Просмотр и создание** и **Создать**. Затем дождитесь завершения развертывания.
8. Щелкните элемент **Перейти к ресурсу** или откройте страницу **Главная > Виртуальные машины** и выберите только что созданную виртуальную машину *myVmPublic*, которую нужно запустить.

### <a name="create-the-second-virtual-machine"></a>Создание второй виртуальной машины

1. Повторите шаги 1–8, но на шаге 3 присвойте виртуальной машине имя *myVmPrivate* и задайте для параметра **Общедоступные входящие порты** значение "Нет". 
2. На шагах 4–5 выберите подсеть **Private**.

>[!NOTE]
> Параметры в разделах **Группа безопасности сети сетевого адаптера** и **Общедоступные входящие порты** должны отображаться, как на приведенном ниже изображении, включая синее окно подтверждения с сообщением "По умолчанию будет блокироваться весь трафик из Интернета".

   ![Создание частной виртуальной машины](./media/tutorial-restrict-network-access-to-resources/create-private-virtual-machine.png)

3. Последовательно выберите элементы **Просмотр и создание** и **Создать**. Затем дождитесь завершения развертывания. 

>[!WARNING]
> Не переходите к следующему шагу, пока развертывание не будет завершено.

4. Дождитесь, пока появится показанное ниже окно подтверждения, и щелкните элемент **Перейти к ресурсу**.

   ![Окно подтверждения создания частной виртуальной машины](./media/tutorial-restrict-network-access-to-resources/create-vm-confirmation-window.png)

## <a name="confirm-access-to-storage-account"></a>Подтверждение прав доступа к учетной записи хранения

1. Создав виртуальную машину *myVmPrivate*, щелкните элемент **Перейти к ресурсу**. 
2. Подключитесь к виртуальной машине. Для этого последовательно выберите элементы **Подключиться > RDP**.
3. После нажатия кнопки **Подключиться** создается файл протокола удаленного рабочего стола (RDP-файл). Щелкните элемент **Скачать RDP-файл**, чтобы загрузить файл на компьютер.  
4. Откройте этот RDP-файл. При появлении запроса выберите **Подключиться**. Введите имя пользователя и пароль, указанные при создании виртуальной машины. Возможно, потребуется выбрать элемент **More choices** (Дополнительные варианты), а затем — элемент **Использовать другую учетную запись**, чтобы указать учетные данные, введенные при создании виртуальной машины. В поле адреса электронной почты введите указанные ранее учетные данные (имя пользователя, указанное в разделе учетной записи администратора). 
5. Щелкните **ОК**.
6. При входе в систему может появиться предупреждение о сертификате. Если вы получили предупреждение, выберите **Да** или **Продолжить**. Виртуальная машина должна запуститься, как показано ниже:

   ![Отображение запущенной частной виртуальной машины](./media/tutorial-restrict-network-access-to-resources/virtual-machine-running.png)

7. В окне виртуальной машины откройте экземпляр PowerShell CLI.
8. Воспользовавшись приведенным ниже скриптом, с помощью PowerShell подключите общую папку Azure как диск Z. Перед выполнением следующих команд замените `<storage-account-key>` и оба поля `<storage-account-name>` значениями, указанными ранее при [создании учетной записи хранения](#create-a-storage-account).

   ```powershell
   $acctKey = ConvertTo-SecureString -String "<storage-account-key>" -AsPlainText -Force
   $credential = New-Object System.Management.Automation.PSCredential -ArgumentList "Azure\<storage-account-name>", $acctKey
   New-PSDrive -Name Z -PSProvider FileSystem -Root "\\<storage-account-name>.file.core.windows.net\my-file-share" -Credential $credential
   ```

   PowerShell вернет выходные данные, как в следующем примере.

   ```powershell
   Name           Used (GB)     Free (GB) Provider      Root
   ----           ---------     --------- --------      ----
   Z                                      FileSystem    \\vnt.file.core.windows.net\my-f...
   ```

   Файловый ресурс Azure успешно подключен как диск Z.

9.   Закройте сеанс удаленного рабочего стола с виртуальной машиной *myVmPrivate*.

## <a name="confirm-access-is-denied-to-storage-account"></a>Подтверждение запрета доступа к учетной записи хранения

1. В поле *Search resources, services, and docs* (Поиск ресурсов, служб и документов) в верхней части портала введите **myVmPublic**.
2. При появлении пункта **myVmPublic** в результатах поиска выберите его.
3. Выполните описанные выше шаги 1–8 из подраздела [Подтверждение прав доступа к учетной записи хранения](#confirm-access-to-storage-account) для виртуальной машины *myVmPublic*.

   После короткого ожидания отобразится ошибка `New-PSDrive : Access is denied`. В доступе будет отказано, так как виртуальная машина *myVmPublic* развернута в подсети *Public*. Подсеть *Public* не поддерживает конечную точку службы для службы хранилища Azure. Учетная запись хранения разрешает доступ к сети только из подсети *Private*, но не из подсети *Public*.

4. Закройте сеанс удаленного рабочего стола с виртуальной машиной *myVmPublic*.
5. Вернитесь на портал Azure и перейдите к созданной ранее учетной записи хранения с уникальным именем.
6. В разделе службы файлов выберите элемент **Общие папки**. Затем выберите папку *my-file-share*, созданную ранее.
7. Должно появиться следующее сообщение об ошибке:

   ![Доступ запрещен](./media/tutorial-restrict-network-access-to-resources/access-denied-error.png)
   
>[!NOTE] 
> Доступ запрещен, так как ваш компьютер не находится в подсети *Private* виртуальной сети *MyVirtualNetwork*.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите группу ресурсов и все содержащиеся в ней ресурсы, когда она станет не нужна.

1. В поле **Поиск** в верхней части портала введите *myResourceGroup*. Когда группа ресурсов **myResourceGroup** появится в результатах поиска, выберите ее.
2. Выберите **Удалить группу ресурсов**.
3. Введите *myResourceGroup* в поле **TYPE THE RESOURCE GROUP NAME:** (Введите имя группы ресурсов:) и нажмите кнопку **Удалить**.

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы включили конечную точку службы для подсети виртуальной сети. Вы узнали, что конечные точки службы можно включать для ресурсов, развернутых несколькими службами Azure. Вы создали учетную запись хранения Azure и ограничили сетевой доступ к учетной записи хранения ресурсами одной подсети в виртуальной сети. См. дополнительные сведения о [конечных точках службы](virtual-network-service-endpoints-overview.md) и [управляемых подсетях](virtual-network-manage-subnet.md).

Если в вашей учетной записи имеется несколько виртуальных сетей, можно соединить две виртуальные сети, чтобы ресурсы в каждой из них могли взаимодействовать друг с другом. Перейдите к следующему руководству, чтобы научиться подключать виртуальные сети.

> [!div class="nextstepaction"]
> [Подключение виртуальных сетей](./tutorial-connect-virtual-networks-portal.md)
