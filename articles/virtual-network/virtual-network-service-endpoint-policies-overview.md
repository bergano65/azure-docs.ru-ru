---
title: Политики конечных точек служб для виртуальной сети Azure | Документация Майкрософт
description: Сведения о фильтрации трафика из виртуальной сети к ресурсам Azure с помощью политик конечных точек служб.
services: virtual-network
documentationcenter: na
author: RDhillon
ms.service: virtual-network
ms.devlang: NA
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/21/2020
ms.author: rdhillon
ms.openlocfilehash: 495d0bce905a980f840527f4cc8cd9e2116e3e66
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "82133752"
---
# <a name="virtual-network-service-endpoint-policies-for-azure-storage"></a>Политики конечной точки службы виртуальной сети в службе хранилища Azure

Политики конечных точек службы виртуальной сети позволяют фильтровать исходящий трафик виртуальной сети в учетных записях хранения Azure через конечную точку службы и разрешать утечка данных только для конкретных учетных записей хранения Azure. Политики конечных точек обеспечивают детализированный контроль доступа для трафика виртуальной сети к службе хранилища Azure при подключении через конечную точку службы.

![Защита исходящего трафика виртуальной сети в учетных записях хранения Azure](./media/virtual-network-service-endpoint-policies-overview/vnet-service-endpoint-policies-overview.png)

Эта функция общедоступна для службы __хранилища Azure__ во __всех глобальных регионах Azure__.

## <a name="key-benefits"></a>Основные преимущества

Политики конечных точек служб для виртуальной сети предоставляют следующие преимущества:

- __Улучшенная безопасность трафика виртуальной сети в службе хранилища Azure__

  [Теги служб Azure для групп безопасности сети](https://aka.ms/servicetags) позволяют ограничить исходящий трафик от виртуальной сети к определенным регионам службы хранилища Azure. Однако это позволяет прохождение трафика для любой учетной записи в выбранном регионе хранилища Azure.
  
  Политики конечных точек позволяют указать учетные записи хранения Azure, которые разрешают исходящий доступ к виртуальной сети и ограничивают доступ ко всем остальным учетным записям хранения. Это обеспечивает гораздо более детализированное управление безопасностью для защиты утечка данных из виртуальной сети.

- __Фильтрация трафика служб Azure с помощью масштабируемых высокодоступных политик__

   Политики конечных точек — это горизонтально масштабируемое высокодоступное решение, позволяющее фильтровать трафик служб Azure из виртуальных сетей через конечные точки служб. Обслуживание центральных сетевых устройств обработки этого трафика в виртуальных сетях не требует дополнительных расходов.

## <a name="json-object-for-service-endpoint-policies"></a>Объект JSON для политик конечной точки службы
Давайте кратко рассмотрим объект политики конечной точки службы.

```json
"serviceEndpointPolicyDefinitions": [
    {
            "description": null,
            "name": "MySEP-Definition",
            "resourceGroup": "MySEPDeployment",
            "service": "Microsoft.Storage",
            "serviceResources": [ 
                    "/subscriptions/subscriptionID/resourceGroups/MySEPDeployment/providers/Microsoft.Storage/storageAccounts/mystgacc"
            ],
            "type": "Microsoft.Network/serviceEndpointPolicies/serviceEndpointPolicyDefinitions"
    }
]
```

## <a name="configuration"></a>Параметр Configuration

-   Можно настроить политики конечных точек для ограничения трафика виртуальной сети к определенным учетным записям хранения Azure.
-   Политика конечной точки настраивается в подсети виртуальной сети. Конечные точки службы для хранилища Azure должны быть включены в подсети для применения политики.
-   Политика конечных точек позволяет добавлять определенные учетные записи хранения Azure в список разрешений с использованием формата resourceID. Вы можете ограничить доступ к
    - все учетные записи хранения в подписке<br>
      `E.g. /subscriptions/subscriptionId`

    - все учетные записи хранения в группе ресурсов<br>
      `E.g. subscriptions/subscriptionId/resourceGroups/resourceGroupName`
     
    - отдельная учетная запись хранения путем перечисления соответствующего resourceId Azure Resource Manager. Это позволит блокировать трафик к большим двоичным объектам, таблицам, очередям, файлам и Azure Data Lake Storage 2-го поколения. <br>
    `E.g. /subscriptions/subscriptionId/resourceGroups/resourceGroupName/providers/Microsoft.Storage/storageAccounts/storageAccountName`
-   По умолчанию, если ни одна из политик не подключена к подсети с конечными точками, вы можете получить доступ ко всем учетным записям хранения в службе. Если настроить политику, доступ из вычислительных экземпляров в подсети можно получать только к ресурсам, указанным в этой подсети. Доступ ко всем другим учетным записям хранения будет запрещен.
-   При применении политик конечных точек службы в подсети *область конечных точек службы* хранилища Azure обновляется с регионального на **глобальную**. Это означает, что весь трафик в службу хранилища Azure защищен от конечной точки службы. Политики конечной точки службы также применяются глобально, поэтому доступ к учетным записям хранения, которые не разрешены явно, будет запрещен. 
-   К подсети можно применять несколько политик. Если с подсетью связано несколько политик, трафик виртуальной сети к ресурсам, указанным в любой из этих политик, будет разрешен. Доступ ко всем другим ресурсам служб, не указанным в любой из этих политик, отклоняется.

    > [!NOTE]  
    > Политики конечной точки службы **разрешают политики**, так что помимо указанных ресурсов, все остальные ресурсы будут ограничены. Убедитесь, что все зависимости ресурсов службы для ваших приложений определены и указаны в политике.

- В политике конечных точек можно указывать только учетные записи хранения, использующие модель ресурсов Azure. Классические учетные записи хранения Azure не будут поддерживать политики конечных точек службы Azure.
- Если в политике указана основная учетная запись, доступ к дополнительным учетным записям геоизбыточного хранилища с доступом на чтение автоматически разрешается.
- Учетные записи хранения могут находиться в той же либо другой подписке или клиенте Azure Active Directory, что и виртуальная сеть.

## <a name="scenarios"></a>Сценарии

- **Одноранговая, подключенная виртуальная сеть или несколько виртуальных сетей.** Чтобы фильтровать трафик в одноранговых виртуальных сетях, политики конечных точек следует применять отдельно к каждой из них.
- **Фильтрация трафика Интернета с помощью сетевых устройств или брандмауэра Azure**: Фильтрация трафика службы Azure с помощью политик, конечных точек службы и фильтрация оставшейся части Интернета или трафика Azure через устройства или брандмауэр Azure.
- **Фильтрация трафика в службах Azure, развернутых в виртуальных сетях**. в настоящее время политики конечной точки службы Azure не поддерживаются для управляемых служб Azure, развернутых в виртуальной сети. 
- **Фильтрация трафика к службам Azure из локальной среды.** Политики конечных точек служб применяются только к связанными с ними подсетям. Чтобы разрешить доступ к определенным ресурсам служб Azure из локальной среды, трафик следует фильтровать с помощью виртуальных сетевых модулей или брандмауэров.

## <a name="logging-and-troubleshooting"></a>Ведение журнала и устранение неполадок
Политики конечных точек служб не поддерживают централизованное ведение журнала. Сведения о журналах ресурсов службы см. в разделе [регистрация конечных точек служб](virtual-network-service-endpoints-overview.md#logging-and-troubleshooting).

### <a name="troubleshooting-scenarios"></a>Сценарии устранения неисправностей
- Отказано в доступе к учетным записям хранения, которые работали в предварительной версии (не в геопарном регионе)
  - При обновлении службы хранилища Azure для использования тегов глобальных служб область конечных точек службы и политики конечной точки службы теперь являются глобальными. Таким образом, весь трафик к службе хранилища Azure шифруется через конечные точки службы, и доступ предоставляется только к учетным записям хранения, которые явно указаны в политике.
  - Явно разрешить вывод списка всех необходимых учетных записей хранения для восстановления доступа.  
  - Обратитесь в службу поддержки Azure.
- Доступ запрещен к учетным записям, указанным в политиках конечных точек
  - Группы безопасности сети или брандмауэр могут блокировать доступ.
  - Если после удаления и повторного применения политики исчезает подключение, сделайте следующее:
    - Проверьте, настроена ли служба Azure для разрешения доступа из виртуальной сети через конечные точки или что для политики по умолчанию для ресурса задано значение *Разрешить все*.
    - Проверьте, имеются ли в журнале диагностики службы данные о трафике через конечные точки.
    - Проверьте, имеются ли в журналах потоков групп безопасности сети данные о доступе, а также имеются ли в журналах хранилища сведения о доступе через конечные точки служб (как и предполагается).
    - Обратитесь в службу поддержки Azure.
- Доступ запрещен к учетным записям, не указанным в политиках конечных точек служб
  - Проверьте, настроена ли служба хранилища Azure для разрешения доступа из виртуальной сети через конечные точки или задана ли для ресурса политика по умолчанию *Разрешить все*.
  - Убедитесь, что учетные записи не являются **классическими учетными записями хранения** с политиками конечной точки службы в подсети.
- Управляемая служба Azure прекратила работу после применения политики конечной точки службы к подсети.
  - В настоящее время управляемые службы не поддерживаются политиками конечной точки службы. *Просмотрите это пространство для обновлений*.

## <a name="provisioning"></a>Подготовка

Политики конечных точек служб может настроить пользователь с правами на запись в виртуальной сети. Узнайте больше о [встроенных ролях](../role-based-access-control/built-in-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json) Azure и назначении разрешений, определенных для [настраиваемых ролей](../role-based-access-control/custom-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

Виртуальные сети и учетные записи хранения Azure могут находиться в одной или разных подписках или в Azure Active Directory клиентах.

## <a name="limitations"></a>Ограничения

- Политики конечных точек служб можно применять только в виртуальных сетях, развернутых на основе модели развертывания с помощью Azure Resource Manager.
- Виртуальные сети должны относиться к тому же региону, что и политика конечных точек служб.
- Политику конечных точек служб можно применять в подсети, только если в указанных в этой политике службах Azure настроены конечные точки служб.
- Политики конечных точек служб нельзя применять к трафику из локальной сети к службам Azure.
- Управляемые службы Azure сейчас не поддерживают политики конечных точек. Сюда входят управляемые службы, развернутые в общих подсетях (например *, Azure HDInsight, пакетная служба Azure, добавление Azure, шлюз приложений Azure, VPN-шлюз Azure, брандмауэр Azure*) или в выделенные подсети (например *Среда службы приложений Azure, кэш Redis для Azure, управление API Azure, Azure SQL MI, классические управляемые службы*).

 > [!WARNING]
 > В соответствии с требованиями к инфраструктуре службы Azure, развернутые в виртуальной сети, например Azure HDInsight, получают доступ к другим службам Azure, например служба хранилища Azure. Ограничение доступа к определенным ресурсам с помощью политики конечных точек может заблокировать доступ к этим ресурсам инфраструктуры для служб Azure, развернутых в виртуальной сети.

- Классические учетные записи хранения не поддерживаются в политиках конечных точек. По умолчанию политики запрещают доступ ко всем таким учетным записям. Если приложению требуется доступ к Azure Resource Manager и классическим учетным записям хранения, политики конечных точек не следует применять к трафику.

## <a name="pricing-and-limits"></a>Цены и ограничения

За использование политик конечных точек служб дополнительная плата не взимается. Текущие цены на службы Azure, например службу хранилища Azure, применяются без изменений (через конечные точки служб).

К политикам конечных точек служб применяются следующие ограничения: 

 |Ресурс | Ограничение по умолчанию |
 |---------|---------------|
 |Количество политик конечных точек служб на подписку |500 |
 |Количество политик конечных точек служб на подсеть|100 |
 |Ресурсы служб на определение политики конечных точек служб|200 |

## <a name="next-steps"></a>Следующие шаги

- Узнайте, как [настроить политики конечных точек служб для виртуальной сети](virtual-network-service-endpoint-policies-portal.md).
- Дополнительные сведения о [конечных точках службы виртуальной сети](virtual-network-service-endpoints-overview.md)
