---
title: Конечные точки служб для виртуальной сети Azure
titlesuffix: Azure Virtual Network
description: Узнайте, как включить прямой доступ к ресурсам Azure из виртуальной сети с помощью конечных точек служб.
services: virtual-network
documentationcenter: na
author: sumeetmittal
ms.service: virtual-network
ms.devlang: NA
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 11/08/2019
ms.author: sumi
ms.custom: ''
ms.openlocfilehash: 72c2c90f7a71bd9bf251adb492168fa5d2baa60a
ms.sourcegitcommit: f523c8a8557ade6c4db6be12d7a01e535ff32f32
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/22/2019
ms.locfileid: "74378694"
---
# <a name="virtual-network-service-endpoints"></a>Конечные точки служб для виртуальной сети

Конечные точки службы виртуальной сети расширяют пространство частных адресов виртуальной сети. Конечные точки также расширяют удостоверение виртуальной сети на службы Azure через прямое подключение. Конечные точки позволяют защищать критически важные ресурсы служб Azure в пределах отдельных виртуальных сетей. Трафик, поступающий из виртуальной сети в службу Azure, всегда остается в магистральной сети Microsoft Azure.

Эта функция доступна для следующих служб и регионов Azure. Ресурс *Microsoft.\** находится в круглых скобках. Включите этот ресурс на стороне подсети при настройке конечных точек службы для службы:

**Общедоступная версия**

- Служба **[хранилища Azure](../storage/common/storage-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json#grant-access-from-a-virtual-network)** (*Microsoft. Storage*). общедоступна во всех регионах Azure.
- **[База данных SQL Azure](../sql-database/sql-database-vnet-service-endpoint-rule-overview.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (*Microsoft. SQL*). общедоступна во всех регионах Azure.
- **[Хранилище данных SQL Azure](../sql-database/sql-database-vnet-service-endpoint-rule-overview.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (*Microsoft. SQL*) — общедоступно во всех регионах Azure.
- **[Сервер базы данных Azure для PostgreSQL](../postgresql/howto-manage-vnet-using-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (*Microsoft. SQL*): общедоступный в регионах Azure, где доступна служба базы данных.
- **[Сервер базы данных Azure для MySQL](../mysql/howto-manage-vnet-using-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (*Microsoft. SQL*): общедоступный в регионах Azure, где доступна служба базы данных.
- **[База данных Azure для MariaDB](https://docs.microsoft.com/azure/mariadb/concepts-data-access-security-vnet)** (*Microsoft. SQL*): общедоступная версия в регионах Azure, где доступна служба базы данных.
- **[Azure Cosmos DB](../cosmos-db/vnet-service-endpoint.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (*Microsoft. азурекосмосдб*): общедоступная версия доступна во всех регионах Azure.
- **[Azure Key Vault](../key-vault/key-vault-overview-vnet-service-endpoints.md)** (*Microsoft. KeyVault*): общедоступная версия доступна во всех регионах Azure.
- **[Служебная шина Azure](../service-bus-messaging/service-bus-service-endpoints.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (*Microsoft. servicebus*): общедоступная версия доступна во всех регионах Azure.
- **[Концентраторы событий Azure](../event-hubs/event-hubs-service-endpoints.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (*Microsoft. EventHub*). общедоступно во всех регионах Azure.
- **[Azure Data Lake Store Gen 1](../data-lake-store/data-lake-store-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (*Microsoft. AzureActiveDirectory*): общедоступная версия доступна во всех регионах Azure, где доступна ADLS 1-го поколения.
- **[Служба приложений Azure](https://docs.microsoft.com/azure/app-service/app-service-ip-restrictions)** . общедоступная версия доступна во всех регионах Azure, где доступна служба приложений.

**Общедоступная предварительная версия**

- **[Реестр контейнеров Azure](../container-registry/container-registry-vnet.md)** (*Microsoft. ContainerRegistry*): Предварительная версия доступна во всех регионах Azure, где доступен реестр контейнеров Azure.

Самые актуальные уведомления доступны на странице [обновлений виртуальной сети Azure](https://azure.microsoft.com/updates/?product=virtual-network).

## <a name="key-benefits"></a>Основные преимущества

Конечные точки служб обеспечивают следующие преимущества.

- **Улучшенная безопасность ресурсов службы Azure**: частные адресные пространства виртуальной сети могут перекрываться. Перекрывающиеся пробелы нельзя использовать для уникальной идентификации трафика, поступающих из виртуальной сети. Конечные точки службы обеспечивают возможность защиты ресурсов службы Azure в виртуальной сети путем расширения удостоверения виртуальной сети для службы. После включения конечных точек службы в виртуальной сети можно добавить правило виртуальной сети для защиты ресурсов службы Azure в виртуальной сети. Добавление правил обеспечивает повышенную безопасность за счет полного удаления общедоступного доступа через Интернет к ресурсам и разрешения трафика только из виртуальной сети.
- **Оптимальная маршрутизация трафика службы Azure из виртуальной сети**. сейчас все маршруты в виртуальной сети, которые принудительно направляют Интернет-трафик в локальные и (или) виртуальные устройства, также принудительно используют для трафика службы Azure тот же маршрут, что и Интернет-трафик. Конечные точки служб обеспечивают оптимальную маршрутизацию трафика Azure. 

  Конечные точки всегда направляют трафик служб непосредственно из виртуальной сети в службу в магистральной сети Microsoft Azure. Так как трафик не покидает пределы магистральной сети, это позволяет и дальше выполнять аудит и мониторинг исходящего интернет-трафика из виртуальных сетей при помощи принудительного туннелирования без воздействия на трафик служб. Дополнительные сведения об определяемых пользователем маршрутах и принудительном туннелировании см. в статье [Маршрутизация трафика виртуальной сети Azure](virtual-networks-udr-overview.md).
- **Простота настройки и управления.** Больше не нужны зарезервированные общедоступные IP-адреса в виртуальных сетях для защиты ресурсов Azure с помощью брандмауэра IP-адресов. Для настройки конечных точек службы не требуется преобразование сетевых адресов (NAT) или устройств шлюза. Конечные точки службы можно настроить с помощью простого щелчка подсети. Для обслуживания конечных точек дополнительная нагрузка не взимается.

## <a name="limitations"></a>Ограничения

- Функция доступна только для виртуальных сетей, развернутых посредством модели развертывания с помощью Azure Resource Manager.
- Конечные точки включаются в подсетях, которые настроены в виртуальных сетях Azure. Конечные точки нельзя использовать для трафика из локальной среды в службы Azure. Дополнительные сведения см. [в статье Защита доступа к службам Azure из локальной](#secure-azure-services-to-virtual-networks) среды.
- В SQL Azure конечная точка службы применяется только к трафику службы Azure в пределах региона виртуальной сети. Для службы хранилища Azure конечные точки также расширяются для включения парных регионов, в которых развертывается виртуальная сеть для поддержки геоизбыточного хранилища с доступом на чтение (RA-GRS) и геоизбыточного хранилища (GRS). Дополнительные сведения см. в статье [Непрерывность бизнес-процессов и аварийное восстановление в службах BizTalk: пары регионов Azure](../best-practices-availability-paired-regions.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-paired-regions).
- Для Azure Data Lake Storage (ADLS) Gen 1 возможность интеграции с виртуальной сетью доступна только для виртуальных сетей в том же регионе. Также обратите внимание, что интеграция виртуальной сети для ADLS 1-го поколения использует безопасность конечной точки службы виртуальной сети между виртуальной сетью и Azure Active Directory (Azure AD) для создания дополнительных утверждений безопасности в маркере доступа. Эти утверждения используются для проверки подлинности виртуальной сети в учетной записи ADLS 1-го поколения и для предоставления доступа. Тег *Microsoft. AzureActiveDirectory* , указанный в разделе службы, поддерживающие конечные точки службы, используется только для вспомогательных конечных точек службы для ADLS Gen 1. Azure AD не поддерживает конечные точки службы изначально. Дополнительные сведения о Azure Data Lake Store интеграции с виртуальной сетью Gen 1 см. [в разделе Сетевая безопасность в Azure Data Lake Storage 1-го поколения](../data-lake-store/data-lake-store-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

## <a name="secure-azure-services-to-virtual-networks"></a>Защита служб Azure в виртуальных сетях

- Конечная точка службы для виртуальной сети предоставляет службе Azure удостоверение виртуальной сети. После включения конечных точек службы в виртуальной сети можно добавить правило виртуальной сети для защиты ресурсов службы Azure в виртуальной сети.
- В настоящее время трафик служб Azure из виртуальной сети использует общедоступные IP-адреса в качестве исходных IP-адресов. При помощи конечных точек служб трафик в качестве исходных IP-адресов использует частные адреса виртуальной сети при обращении к службе Azure из виртуальной сети. Это переключение позволяет осуществлять доступ к службам без необходимости в зарезервированных общедоступных IP-адресах, которые используются в брандмауэрах.

   >[!NOTE]
   > При использовании конечных точек службы исходные IP-адреса виртуальных машин в подсети для трафика служб переключаются с общедоступных адресов IPv4 на частные. Существующие правила брандмауэра службы Azure, использующие общедоступные IP-адреса Azure, перестанут работать после этого переключения. Перед настройкой конечных точек службы убедитесь, что правила брандмауэра службы Azure поддерживают переключение. При настройке конечных точек службы также может наблюдаться временное прерывание трафика служб из этой подсети. 
 
## <a name="secure-azure-service-access-from-on-premises"></a>Защита доступа к службам Azure из локальной среды

  По умолчанию ресурсы служб Azure, защищенные виртуальными сетями, недоступны из локальных сетей. Чтобы разрешить трафик из локальной среды, необходимо также разрешить общедоступные IP-адреса (обычно это NAT) из локальных каналов или каналов ExpressRoute. Эти IP-адреса можно добавить с помощью конфигурации брандмауэра IP для ресурсов службы Azure.

  ExpressRoute. Если вы используете [expressroute](../expressroute/expressroute-introduction.md?toc=%2fazure%2fvirtual-network%2ftoc.json) для общедоступного пиринга или пиринга Майкрософт из локальной сети, вам потребуется выяснить IP-адреса NAT, которые вы используете. Для общедоступного пиринга каждый канал ExpressRoute использует два IP-адреса NAT, которые по умолчанию применяются к трафику службы Azure, когда трафик входит в Microsoft Azureную магистральную сеть. Для пиринга Майкрософт IP-адреса NAT являются либо клиентами, либо предоставленными поставщиком услуг. Чтобы разрешить доступ к ресурсам службы, необходимо разрешить эти общедоступные IP-адреса в параметрах брандмауэра для IP-адресов ресурсов. Чтобы найти IP-адреса канала ExpressRoute общедоступного пиринга, отправьте запрос в [службу поддержки с помощью ExpressRoute](https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview) через портал Azure. Дополнительные сведения о протоколе NAT для общедоступного и пиринга Майкрософт см. в статье [требования к NAT для expressroute](../expressroute/expressroute-nat.md?toc=%2fazure%2fvirtual-network%2ftoc.json#nat-requirements-for-azure-public-peering).

![Защита служб Azure в виртуальных сетях](./media/virtual-network-service-endpoints-overview/VNet_Service_Endpoints_Overview.png)

### <a name="configuration"></a>Параметр Configuration

- Настройка конечных точек службы в подсети в виртуальной сети. Конечные точки работают с любым типом вычислительных экземпляров, выполняющихся в этой подсети.
- Вы можете настроить несколько конечных точек службы для всех поддерживаемых служб Azure (например, службы хранилища Azure или базы данных SQL Azure) в подсети.
- Для Базы данных SQL Azure виртуальные сети должны относиться к тому же региону, что и ресурс службы Azure. При использовании учетных записей хранения Azure GRS и RA-GRS основная учетная запись должна принадлежать тому же региону, что и виртуальная сеть. Для всех других служб можно защитить ресурсы службы Azure в виртуальных сетях в любом регионе. 
- Виртуальная сеть, в которой настраивается конечная точка, может относиться к той же подписке, что и ресурс службы Azure, либо же к другой подписке. Дополнительные сведения о разрешениях, которые требуются для настройки конечных точек и защиты служб Azure, см. в разделе [Подготовка](#provisioning).
- Вы можете защитить новые или существующие ресурсы в виртуальных сетях с помощью конечных точек служб для поддерживаемых служб.

### <a name="considerations"></a>Рекомендации

- После включения конечной точки службы исходные IP-адреса виртуальных машин в коммутаторе подсети. Исходные IP-адреса переключаются с использования общедоступных IPv4-адресов для использования их частного IPv4-адреса при взаимодействии со службой из этой подсети. Во время этого переключения все открытые TCP-подключения к службе закрываются. Убедитесь, что при включении или отключении конечной точки службы в подсети не выполняются критически важные задачи. Также удостоверьтесь, что приложения могут автоматически подключаться к службам Azure после этого переключения IP-адресов.

  Коммутатор IP-адресов влияет только на трафик служб из виртуальной сети. Никакого воздействия на любой другой трафик, адресованный виртуальным машинам или из общедоступных IPv4-адресов, не влияет. Если для служб Azure установлены правила брандмауэра с использованием общедоступных IP-адресов Azure, то после переключения на частные адреса виртуальной сети эти правила перестают работать.
- С конечными точками службы записи DNS для служб Azure остаются как есть сегодня и продолжают разрешаться в общедоступные IP-адреса, назначенные службе Azure.

- Группы безопасности сети (NSG) с конечными точками служб:
  - По умолчанию группы безопасности сети разрешает исходящий Интернет, а также разрешает трафик из виртуальной сети в службы Azure. Этот трафик продолжит работать с конечными точками службы, как есть. 
  - Если вы хотите запретить весь исходящий Интернет и разрешить только трафик к определенным службам Azure, это можно сделать с помощью [тегов службы](security-overview.md#service-tags) в группы безопасности сети. Вы можете указать поддерживаемые службы Azure в качестве места назначения в правилах NSG, а Azure также обеспечивает обслуживание IP-адресов, лежащих в основе каждого тега. Дополнительные сведения см. в статье о [тегах служб Azure для групп NSG](security-overview.md#service-tags). 

### <a name="scenarios"></a>Сценарии

- **Пиринговые виртуальные сети, связанные виртуальные сети или несколько виртуальных сетей**. Чтобы обеспечить защиту служб Azure в нескольких подсетях в виртуальной сети или в нескольких виртуальных сетях, вы можете включить конечные точки служб для каждой из этих подсетей независимо друг от друга и защитить ресурсы служб Azure во всех этих подсетях.
- **Фильтрация исходящего трафика из виртуальной сети в службы Azure**. Если вы хотите проверить или отфильтровать трафик, отправляемый в службу Azure из виртуальной сети, можно развернуть сетевой виртуальный модуль в виртуальной сети. Это позволяет применять конечные точки служб к подсети, в которой развертывается виртуальное сетевое устройство, и обеспечить защиту ресурса службы Azure только в этой подсети. Этот сценарий может быть полезен, если вы хотите использовать фильтрацию виртуальных сетевых устройств, чтобы ограничить доступ к службе Azure из виртуальной сети только определенными ресурсами Azure. Дополнительные сведения см. в разделе [Deploy highly available network virtual appliances](/azure/architecture/reference-architectures/dmz/nva-ha) (Развертывание высокодоступных сетевых устройств).
- **Защита ресурсов Azure для служб, развернутых непосредственно в виртуальных сетях**. Вы можете напрямую развернуть различные службы Azure в определенных подсетях в виртуальной сети. Вы можете защитить ресурсы служб Azure в подсетях [управляемой службы](virtual-network-for-azure-services.md), настроив конечную точку службы в подсети управляемой службы.
- **Трафик диска с виртуальной машины Azure**: трафик диска виртуальной машины для управляемых и неуправляемых дисков не зависит от изменений маршрутизации конечных точек службы в службе хранилища Azure. Этот трафик включает Дискио, а также подключение и отсоединение. Вы можете ограничить доступ к ОСТАВШИМся страничным BLOB-объектам для выбора сетей через конечные точки служб и [правила сети службы хранилища Azure](../storage/common/storage-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json). 

### <a name="logging-and-troubleshooting"></a>Ведение журнала и устранение неполадок

После настройки конечных точек службы для определенной службы убедитесь, что маршрут конечной точки службы действует следующим образом. 
 
- Проверка исходного IP-адреса любого запроса к службе при ее диагностике. Во всех новых запросах с использованием конечных точек служб исходный IP-адрес отображается как частный IP-адрес виртуальной сети, который назначен клиенту, выполняющему запрос из виртуальной сети. Без конечной точки этот адрес является общедоступным IP-адресом Azure.
- Просмотр действующих маршрутов любого сетевого интерфейса в подсети. Маршрут к службе:
  - отображает более точный маршрут по умолчанию с учетом префиксов адресов каждой службы;
  - использует значение *VirtualNetworkServiceEndpoint* параметра nextHopType;
  - Указывает, что более прямое подключение к службе действует по сравнению с маршрутами с принудительным туннелированием.

>[!NOTE]
> Маршрут конечной точки службы переопределяет маршруты BGP или UDR при совпадении префиксов адресов для службы Azure. Дополнительные сведения см. [в разделе Устранение неполадок с эффективными маршрутами](diagnose-network-routing-problem.md).

## <a name="provisioning"></a>Подготовка

Конечные точки службы можно настроить в виртуальных сетях независимо от пользователя с доступом на запись к виртуальной сети. Чтобы защитить ресурсы службы Azure для виртуальной сети, пользователь должен иметь разрешение на доступ к *Microsoft. Network/virtualNetworks/подсети/жоинвиасервицеендпоинт/Action* для добавленных подсетей. Встроенные роли администратора служб включают это разрешение по умолчанию. Разрешение можно изменить, создав пользовательские роли.

Дополнительные сведения о встроенных ролях см. в статье [встроенные роли для ресурсов Azure](../role-based-access-control/built-in-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json). Дополнительные сведения о назначении конкретных разрешений настраиваемым ролям см. в статье [пользовательские роли для ресурсов Azure](../role-based-access-control/custom-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

Виртуальные сети и ресурсы служб Azure могут находиться в одной или разных подписках. Если они находятся в разных подписках, ресурсы должны быть размещены в одном клиенте Active Directory (AD). 

## <a name="pricing-and-limits"></a>Цены и ограничения

Дополнительная плата за использование конечных точек службы не взимается. Текущая модель ценообразования для служб Azure (служба хранилища Azure, база данных SQL Azure и т. д.) действует сегодня.

В виртуальной сети нет ограничений на общее число конечных точек служб.

Некоторые службы Azure, такие как учетные записи хранения Azure, могут применять ограничения на количество подсетей, используемых для защиты ресурса. Дополнительные сведения см. в документации по различным службам в разделе [дальнейшие действия](#next-steps) .

## <a name="vnet-service-endpoint-policies"></a>Политики конечной точки службы виртуальной сети 

Политики конечной точки службы виртуальной сети позволяют фильтровать трафик виртуальной сети в службах Azure. Этот фильтр разрешает только определенные ресурсы службы Azure через конечные точки службы. Политики конечных точек служб предоставляют возможность детального контроля доступа трафика из виртуальной сети к службам Azure. Дополнительные сведения см. в статье [политики конечной точки службы виртуальной сети](https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoint-policies-overview).

## <a name="faqs"></a>Часто задаваемые вопросы

Часто задаваемые вопросы см. в разделе [вопросы и ответы о конечной точке службы виртуальной сети](https://docs.microsoft.com/azure/virtual-network/virtual-networks-faq#virtual-network-service-endpoints).

## <a name="next-steps"></a>Дополнительная информация

- [Настройка конечных точек службы виртуальной сети](tutorial-restrict-network-access-to-resources.md)
- [Защита учетной записи хранения Azure в виртуальной сети](../storage/common/storage-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json)
- [Защита базы данных SQL Azure в виртуальной сети](../sql-database/sql-database-vnet-service-endpoint-rule-overview.md?toc=%2fazure%2fvirtual-network%2ftoc.json)
- [Защита хранилища данных SQL Azure в виртуальной сети](../sql-database/sql-database-vnet-service-endpoint-rule-overview.md?toc=%2fazure%2fsql-data-warehouse%2ftoc.json)
- [Интеграция служб Azure в виртуальные сети](virtual-network-for-azure-services.md)
- [Политики конечных точек служб для виртуальной сети (предварительная версия)](https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoint-policies-overview).
- [Шаблон Azure Resource Manager](https://azure.microsoft.com/resources/templates/201-vnet-2subnets-service-endpoints-storage-integration)

