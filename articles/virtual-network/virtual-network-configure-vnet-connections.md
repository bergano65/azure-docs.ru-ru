---
title: Настройка и проверка виртуальной сети или VPN-подключений
description: Пошаговое руководство по настройке и проверке различных развертываний VPN и виртуальных сетей Azure
services: virtual-network
documentationcenter: na
author: v-miegge
manager: dcscontentpm
editor: ''
ms.assetid: 0433a4f4-b5a0-476d-b398-1506c57eafa2
ms.service: virtual-network
ms.devlang: na
ms.topic: troubleshooting
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/28/2019
ms.author: kaushika
ms.openlocfilehash: dddf402455292e19bf0fcda3c50d9ce10d5888d2
ms.sourcegitcommit: cd70273f0845cd39b435bd5978ca0df4ac4d7b2c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/18/2019
ms.locfileid: "71099060"
---
# <a name="configure-and-validate-virtual-network-or-vpn-connections"></a>Настройка и проверка виртуальной сети или VPN-подключений

В этом пошаговом руководстве содержатся пошаговые инструкции по настройке и проверке различных развертываний VPN и виртуальных сетей Azure. К таким сценариям относятся транзитная маршрутизация, подключения "сеть — сеть", протокол BGP (BGP), многосайтовых подключений и подключения "точка — сеть".

VPN-шлюзы Azure обеспечивают гибкость при Организации практически любого типа подключенной топологии виртуальной сети в Azure. Например, можно подключить виртуальные сети:

- Между регионами.
- Между типами виртуальных сетей (Azure Resource Manager и классической).
- В Azure или в локальной гибридной среде.
- В разных подписках. 

## <a name="network-to-network-vpn-connection"></a>VPN-подключение "сеть — сеть"

Подключение виртуальной сети к другой виртуальной сети через VPN аналогично подключению виртуальной сети к расположению локального сайта. Оба типа подключения используют VPN-шлюз для обеспечения безопасного туннеля через IPsec и IKE. Виртуальные сети могут относиться к одному или разным регионам и к одной или разным подпискам.

![Подключение "сеть — сеть" с использованием IPsec](./media/virtual-network-configure-vnet-connections/4034386_en_2.png)
 
Если виртуальные сети находятся в одном регионе, их можно подключить с помощью пиринга виртуальных сетей. Пиринг виртуальных сетей не использует VPN-шлюз. Это увеличивает пропускную способность и сокращает задержку. Чтобы настроить подключение пиринга между виртуальными сетями, выберите **Настройка и проверка пиринга**виртуальной сети.

Если виртуальные сети были созданы с помощью модели развертывания диспетчера ресурсов Azure, выберите **Настройка и проверка диспетчер ресурсов виртуальной сети для подключения к Диспетчер ресурсов виртуальной сети** , чтобы настроить VPN-подключение.

Если одна из виртуальных сетей была создана с помощью классической модели развертывания Azure, а другая была создана с помощью диспетчер ресурсов, выберите **настроить и проверить классическую виртуальную сеть диспетчер ресурсов подключение к виртуальной сети** для настройки VPN-подключения.

### <a name="configure-virtual-network-peering-for-two-virtual-networks-in-the-same-region"></a>Настройка пиринга виртуальной сети для двух виртуальных сетей в одном регионе

Прежде чем приступить к внедрению и настройке пиринга виртуальной сети Azure, убедитесь, что выполнены следующие предварительные требования.

* Пиринговые виртуальные сети должны находиться в одном регионе Azure.
* Одноранговые виртуальные сети должны иметь пространства IP-адресов, которые не перекрываются.
* Пиринговая связь устанавливается между двумя виртуальными сетями. Между одноранговыми узлами нет производной промежуточной связи. Например, если VNetA соединен с VNetB, а *VNetB — с* Внетк, VNetA не является одноранговым элементом внетк.

При соблюдении требований вы можете следовать указаниям [в учебнике: Подключите виртуальные сети с помощью пиринга виртуальных сетей, используя портал Azure](https://docs.microsoft.com/azure/virtual-network/virtual-network-create-peering) для создания и настройки пиринга.

Чтобы проверить конфигурацию пиринга, используйте следующий метод:

1. Войдите в [портал Azure](https://portal.azure.com/) , используя учетную запись с необходимыми [ролями и разрешениями](virtual-network-manage-peering.md#permissions).
2. В верхней части окна портала в поле с текстом **Поиск ресурсов** введите **виртуальные сети**. Когда в результатах поиска появится пункт **Виртуальные сети**, выберите его.
3. В появившейся колонке **виртуальные сети** выберите виртуальную сеть, для которой нужно создать пиринг.
4. В области, которая отображается для виртуальной сети, в разделе **Параметры** выберите **пиринг** .
5. Выберите пиринг и просмотрите результаты конфигурации.

![Параметры для проверки конфигурации пиринга виртуальной сети](./media/virtual-network-configure-vnet-connections/4034496_en_1.png)
 
Для Azure PowerShell выполните команду [Get-azurermvirtualnetworkpeering —](https://docs.microsoft.com/powershell/module/azurerm.network/get-azurermvirtualnetworkpeering?view=azurermps-4.1.0) , чтобы получить пиринг виртуальной сети. Ниже приведен пример:

```
PS C:\Users\User1> Get-AzureRmVirtualNetworkPeering -VirtualNetworkName Vnet10-01 -ResourceGroupName dev-vnets
Name                             : LinkToVNET10-02
Id                               : /subscriptions/GUID/resourceGroups/dev-vnets/providers/Microsoft.Network/virtualNetworks/VNET10-01/virtualNetworkPeerings/LinkToVNET10-0
2
Etag                             : W/"GUID"
ResourceGroupName                : dev-vnets
VirtualNetworkName               : vnet10-01
ProvisioningState                : Succeeded
RemoteVirtualNetwork             : {
                                  "Id": "/subscriptions/GUID/resourceGroups/DEV-VNET
                                   s/providers/Microsoft.Network/virtualNetworks/VNET10-02"
                                   }
AllowVirtualNetworkAccess        : True
AllowForwardedTraffic            : False
AllowGatewayTransit              : False
UseRemoteGateways                : False
RemoteGateways                   : null
RemoteVirtualNetworkAddressSpace : null
```

### <a name="connect-a-resource-manager-virtual-network-to-another-resource-manager-virtual-network"></a>Подключение диспетчер ресурсов виртуальной сети к другой диспетчер ресурсов виртуальной сети

Вы можете настроить подключение из одной диспетчер ресурсов виртуальной сети к другой диспетчер ресурсов виртуальной сети напрямую. Также можно настроить подключение с помощью IPsec.

### <a name="configure-a-vpn-connection-between-resource-manager-virtual-networks"></a>Настройка VPN-подключения между диспетчер ресурсов виртуальными сетями

Сведения о настройке подключения между виртуальными сетями диспетчер ресурсов без использования IPsec см. [в статье Настройка подключения к VPN-шлюзу типа "сеть — сеть" с помощью портал Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal).

Чтобы настроить подключение между двумя диспетчер ресурсов виртуальными сетями по протоколу IPsec, выполните шаги 1 – 5 в разделе [Создание подключения типа "сеть — сеть" в портал Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal) для каждой виртуальной сети.

> [!Note]
> Эти действия применимы только к виртуальным сетям в одной подписке. Если ваши виртуальные сети находятся в разных подписках, для подключения необходимо использовать PowerShell. См. статью, посвященную использованию [PowerShell](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-vnet-vnet-rm-ps).

### <a name="validate-the-vpn-connection-between-resource-manager-virtual-networks"></a>Проверка VPN-подключения между диспетчер ресурсов виртуальными сетями

![Классическая виртуальная сеть подключение к Azure Resource Manager виртуальной сети](./media/virtual-network-configure-vnet-connections/4034493_en_2.png)

Чтобы проверить, правильно ли настроено VPN-подключение, выполните приведенные ниже инструкции.

> [!Note] 
> Числа после компонентов виртуальной сети в этих шагах соответствуют числам на предыдущей схеме.

1. Убедитесь, что в подключенных виртуальных сетях нет перекрывающихся адресных пространств.
2. Убедитесь, что диапазон адресов для виртуальной сети Azure Resource Manager (1) точно определен в экземпляре **объекта соединения** (4).
3. Убедитесь, что диапазон адресов для виртуальной сети Azure Resource Manager (6) точно определен в экземпляре **объекта соединения** (3).
4. Убедитесь, что общие ключи совпадают с объектами соединения.
5. Убедитесь, что виртуальный IP-адрес шлюза виртуальной сети (2) Azure Resource Manager точно определен в экземпляре **объекта соединения** (4).
6. Убедитесь, что виртуальный IP-адрес шлюза виртуальной сети (5) Azure Resource Manager определен точно в экземпляре **объекта соединения** (3).

### <a name="connect-a-classic-virtual-network-to-a-resource-manager-virtual-network"></a>Подключение классической виртуальной сети к диспетчер ресурсов виртуальной сети

Можно создать подключение между виртуальными сетями, которые находятся в разных подписках, и в разных регионах. Вы также можете подключать виртуальные сети, которые уже имеют подключения к локальным сетям, при условии, что тип шлюза настроен как на основе маршрутов.

Сведения о настройке подключения между классической виртуальной сетью и диспетчер ресурсов виртуальной сетью см. в статье [подключение виртуальных сетей из разных моделей развертывания с помощью портал Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-connect-different-deployment-models-portal).

![Классическая виртуальная сеть подключение к Azure Resource Manager виртуальной сети](./media/virtual-network-configure-vnet-connections/4034389_en_2.png)

Чтобы проверить конфигурацию при подключении классической виртуальной сети к Azure Resource Manager виртуальной сети, выполните следующие инструкции.

> [!Note] 
> Числа после компонентов виртуальной сети в этих шагах соответствуют числам на предыдущей схеме. 

1. Убедитесь, что в подключенных виртуальных сетях нет перекрывающихся адресных пространств.
2. Убедитесь, что диапазон адресов для виртуальной сети Azure Resource Manager (6) точно определен в классическом определении локальной сети (3).
3. Убедитесь, что диапазон адресов для классической виртуальной сети (1) точно определен в Azure Resource Manager экземпляре **объекта соединения** (4).
4. Убедитесь, что классический виртуальный IP-адрес шлюза виртуальной сети (2) точно определен в Azure Resource Manager экземпляре **объекта соединения** (4).
5. Убедитесь, что шлюз виртуальной сети Azure Resource Manager (5) точно определен в классическом экземпляре **определения локальной сети** (3).
6. Убедитесь, что общие ключи совпадают в обеих подключенных виртуальных сетях:
   - Классическая виртуальная сеть: **Определение локальной сети** 3-5
   - Виртуальная сеть Azure Resource Manager: **Объект Connection** четырех

## <a name="create-a-point-to-site-vpn-connection"></a>Создание VPN-подключения типа "точка — сеть"

Конфигурация "точка — сеть" (*P2S* на следующей схеме) позволяет создать безопасное подключение с отдельного клиентского компьютера к виртуальной сети. Подключения типа "точка — сеть" полезны, если требуется подключиться к виртуальной сети из удаленного расположения, например из дома или конференции. Они также полезны при наличии нескольких клиентов, которым требуется подключение к виртуальной сети. 

VPN-подключение типа "точка — сеть" инициируется с клиентского компьютера с помощью собственного VPN-клиента Windows. Для проверки подлинности подключений клиентов используются сертификаты.

![Подключение типа "точка — сеть"](./media/virtual-network-configure-vnet-connections/4034387_en_3.png)

Для подключений типа "точка — сеть" не требуется VPN-устройство. Они создают VPN-подключение по протоколу SSTP. Подключение типа "точка — сеть" к виртуальной сети можно подключить с помощью различных средств развертывания и моделей развертывания.

* [Настройка подключения типа "точка — сеть" к виртуальной сети с помощью портал Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal)
* [Настройка подключения типа "точка — сеть" к виртуальной сети с помощью портал Azure (классическая модель)](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-classic-azure-portal)
* [Настройка подключения типа "точка — сеть" к виртуальной сети с помощью PowerShell](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-rm-ps)

### <a name="validate-your-point-to-site-connection"></a>Проверка подключения "точка — сеть"

Устранение [неполадок в статье: Проблемы](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-troubleshoot-vpn-point-to-site-connection-problems) с подключением "точка — сеть" в Azure проходят через общие проблемы с подключением "точка — сеть".

## <a name="create-a-multisite-vpn-connection"></a>Создание многосайтового VPN-подключения

Вы можете добавить подключение типа "сеть — сеть" (*S2S* на следующей схеме) к виртуальной сети, в которой уже есть подключение типа "сеть — сеть", подключение типа "точка — сеть" или сетевое подключение. Такой тип подключения часто называется *многосайтововой* конфигурацией. 

![Многосайтовое подключение](./media/virtual-network-configure-vnet-connections/4034497_en_2.png)

В настоящее время Azure работает с двумя моделями развертывания: Диспетчер ресурсов и Classic. Эти две модели не полностью совместимы друг с другом. Сведения о настройке многосайтового подключения с различными моделями см. в следующих статьях:

* [Добавление подключения типа "сеть — сеть" в виртуальную сеть с существующим VPN-шлюзом](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-multi-site-to-site-resource-manager-portal)
* [Добавление подключения типа "сеть — сеть" в виртуальную сеть с существующим подключением VPN-шлюза (классическая модель)](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-multi-site)

> [!Note]
> Действия, описанные в этих статьях, не применяются к параллельным конфигурациям подключений Azure ExpressRoute и "сеть — сеть". Дополнительные сведения см. в разделе [подключения ExpressRoute и соединения "сеть — сеть](https://docs.microsoft.com/azure/expressroute/expressroute-howto-coexist-resource-manager)".

## <a name="configure-transit-routing"></a>Настройка транзитной маршрутизации

Транзитная маршрутизация — это конкретный сценарий маршрутизации, при котором вы подключаете несколько сетей в топологии последовательной цепочки. Эта маршрутизация позволяет ресурсам в виртуальных сетях с обеих сторон цепочки взаимодействовать друг с другом через виртуальные сети между. Без транзитной маршрутизации сети или устройства, которые были равноправны через концентратор, не могут подключиться друг к другу.

### <a name="configure-transit-routing-in-a-point-to-site-connection"></a>Настройка транзитной маршрутизации в подключении типа "точка — сеть"

Представьте себе ситуацию, в которой необходимо настроить VPN-подключение типа "сеть — сеть" между VNetA и VNetB. Кроме того, необходимо настроить VPN-подключение типа "точка — сеть" для подключения клиента к шлюзу VNetA. Затем необходимо включить транзитную маршрутизацию для клиентов "точка — сеть", чтобы подключиться к VNetB, который проходит через VNetA. 

Этот сценарий поддерживается при включении BGP для VPN типа "сеть — сеть" между VNetA и VNetB. Дополнительные сведения см. в статье [о маршрутизации VPN типа "точка — сеть](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-point-to-site-routing)".

### <a name="configure-transit-routing-in-an-expressroute-connection"></a>Настройка транзитной маршрутизации в подключении ExpressRoute

Azure ExpressRoute позволяет переносить локальные сети в облако Microsoft по выделенному закрытому соединению, которое обеспечивается поставщиком услуг подключения. ExpressRoute позволяет устанавливать подключения к облачным службам Майкрософт, таким как Microsoft Azure, Office 365 и Dynamics 365. Дополнительные сведения см. в статье [Обзор ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-introduction).

![Подключение частного пиринга ExpressRoute к виртуальным сетям Azure](./media/virtual-network-configure-vnet-connections/4034395_en_1.png)

> [!Note]
> Рекомендуется [связать обе виртуальные сети с каналом ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-howto-linkvnet-arm) , а не настроить транзитную маршрутизацию, если VNetA и VNetB находятся в одном регионе. Если ваши виртуальные сети находятся в разных регионах, их также можно связать непосредственно с каналом, если у вас установлен [ExpressRoute Premium](https://docs.microsoft.com/azure/expressroute/expressroute-faqs#expressroute-premium). 

Если у вас есть ExpressRoute и сосуществование между сайтами, транзитная маршрутизация не поддерживается. Дополнительные сведения см. в статье [Настройка ExpressRoute и "сеть — сеть" с помощью PowerShell](https://docs.microsoft.com/azure/expressroute/expressroute-howto-coexist-resource-manager).

Если вы включили ExpressRoute для подключения локальных сетей к виртуальной сети Azure, вы можете включить пиринг между виртуальными сетями, в которых требуется транзитная маршрутизация. Чтобы разрешить локальным сетям подключаться к удаленной виртуальной сети, необходимо настроить [пиринг виртуальных сетей](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview#gateways-and-on-premises-connectivity). 

> [!Note]
> Пиринг виртуальных сетей доступен только для виртуальных сетей в том же регионе.

Чтобы проверить, настроена ли транзитная маршрутизация для пиринга виртуальных сетей, выполните следующие действия:

1. Войдите в [портал Azure](https://portal.azure.com/) , используя учетную запись с необходимыми [ролями и разрешениями](virtual-network-manage-peering.md#permissions).
2. [Создайте пиринг между VNetA и VNetB](https://docs.microsoft.com/azure/virtual-network/virtual-network-create-peering) , как показано на предыдущей схеме. 
3. В области, которая отображается для виртуальной сети, в разделе **Параметры** выберите **пиринг** .
4. Выберите пиринг, который вы хотите просмотреть. Затем выберите **Конфигурация** , чтобы проверить, включен ли параметр **Разрешить транзит шлюза** в сети VNetA, подключенной к каналу Expressroute, и **использовать удаленный шлюз** в удаленной сети VNetB, не подключенной к ExpressRoute. цепи.

### <a name="configure-transit-routing-in-a-virtual-network-peering-connection"></a>Настройка транзитной маршрутизации в одноранговом подключении к виртуальной сети

Если между виртуальными сетями установлена пиринговая связь, можно использовать шлюз в одной из этих сетей в качестве транзитного пункта при подключении к локальной сети. Чтобы настроить транзитный маршрут в пиринга виртуальной сети, см. раздел [подключения типа "сеть — сеть](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-vnet-vnet-rm-ps?toc=/azure/virtual-network/toc.json)".

> [!Note]
> Транзитный шлюз не поддерживается в связи пиринга между виртуальными сетями, созданными с помощью разных моделей развертывания. Обе виртуальные сети в связи пиринга должны быть созданы с помощью диспетчер ресурсов для передачи шлюза.

Чтобы проверить, настроен ли транзитный маршрут для пиринга виртуальных сетей, выполните следующие действия:

1. Войдите в [портал Azure](https://portal.azure.com/) , используя учетную запись с необходимыми [ролями и разрешениями](virtual-network-manage-peering.md#permissions).
2. В верхней части окна портала в поле с текстом **Поиск ресурсов** введите **виртуальные сети**. Когда в результатах поиска появится пункт **Виртуальные сети**, выберите его.
3. В появившейся колонке **виртуальные сети** выберите виртуальную сеть, для которой необходимо проверить параметр пиринга.
4. В области, которая отображается для выбранной виртуальной сети, в разделе **Параметры** выберите **пиринг** .
5. Выберите пиринг, который требуется просмотреть. Убедитесь, что вы включили параметр **Разрешить транзит шлюза** и **использовать удаленные шлюзы** в разделе **Конфигурация**.

![Параметры для проверки настройки транзитного маршрута для пиринга виртуальной сети](./media/virtual-network-configure-vnet-connections/4035414_en_1.png)

### <a name="configure-transit-routing-in-a-network-to-network-connection"></a>Настройка транзитной маршрутизации в подключении "сеть — сеть"

Чтобы настроить транзитную маршрутизацию между виртуальными сетями, необходимо включить протокол BGP для всех промежуточных подключений "сеть — сеть" с помощью модели развертывания диспетчер ресурсов и PowerShell. Инструкции см. [в статье Настройка BGP на VPN-шлюзах Azure с помощью PowerShell](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-bgp-resource-manager-ps).

Транзитный трафик через VPN-шлюзы Azure можно перебрать с помощью классической модели развертывания, но в нем используются статически определенные адресные пространства в файле конфигурации сети. BGP пока не поддерживается виртуальными сетями Azure и VPN-шлюзами через классическую модель развертывания. Без BGP определение адресов транзитного пространства вручную может привести к ошибке, и мы не рекомендуем их использовать.

> [!Note]
> Классические подключения типа "сеть — сеть" настраиваются с помощью классического портала Azure или файла конфигурации сети на классическом портале. Вы не можете создать или изменить классическую виртуальную сеть с помощью модели развертывания Azure Resource Manager или портал Azure. Дополнительные сведения о транзитной маршрутизации для классических виртуальных сетей см. в [блоге разработчика Майкрософт](https://blogs.msdn.microsoft.com/igorpag/2015/10/01/hubspoke-daisy-chain-and-full-mesh-vnet-topologies-in-azure-arm-using-vpn-v1/).

### <a name="configure-transit-routing-in-a-site-to-site-connection"></a>Настройка транзитной маршрутизации в подключении типа "сеть — сеть"

Чтобы настроить транзитную маршрутизацию между локальной сетью и виртуальной сетью с подключением типа "сеть — сеть", необходимо включить протокол BGP для всех промежуточных подключений типа "сеть — сеть" с помощью модели развертывания диспетчер ресурсов и PowerShell. Инструкции см. [в статье Настройка BGP на VPN-шлюзах Azure с помощью PowerShell](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-bgp-resource-manager-ps) .

Транзитный трафик через VPN-шлюзы Azure можно перебрать с помощью классической модели развертывания, но в нем используются статически определенные адресные пространства в файле конфигурации сети. BGP пока не поддерживается виртуальными сетями Azure и VPN-шлюзами через классическую модель развертывания. Без BGP определение адресов транзитного пространства вручную может привести к ошибке, и мы не рекомендуем их использовать.

> [!Note]
> Классические подключения типа "сеть — сеть" настраиваются с помощью классического портала Azure или файла конфигурации сети на классическом портале. Вы не можете создать или изменить классическую виртуальную сеть с помощью модели развертывания Azure Resource Manager или портал Azure. Дополнительные сведения о транзитной маршрутизации для классических виртуальных сетей см. в [блоге разработчика Майкрософт](https://blogs.msdn.microsoft.com/igorpag/2015/10/01/hubspoke-daisy-chain-and-full-mesh-vnet-topologies-in-azure-arm-using-vpn-v1/).

## <a name="configure-bgp-for-a-vpn-gateway"></a>Настройка BGP для VPN-шлюза

BGP — это стандартный протокол маршрутизации, используемый в Интернете для обмена информацией о маршрутизации и достижимости между двумя или более сетями. Когда BGP используется в контексте виртуальных сетей Azure, он включает VPN-шлюзы Azure и локальные VPN-устройства, называемые одноранговыми узлами BGP или соседями. Они обмениваются "маршрутами", которые будут сообщать о доступности и достижимости обоих шлюзов, чтобы эти префиксы продавались через шлюзы или маршрутизаторы. 

BGP также может включить транзитную маршрутизацию между несколькими сетями путем распространения маршрутов, которые шлюз BGP изучает с одного узла BGP на все остальные узлы BGP. Дополнительные сведения см. в статье Общие сведения о [BGP с VPN-шлюзом Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-bgp-overview).

### <a name="configure-bgp-for-a-vpn-connection"></a>Настройка BGP для VPN-подключения

Сведения о настройке VPN-подключения, использующего BGP, см. в статье [Настройка BGP на VPN-шлюзах Azure с помощью PowerShell](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-bgp-resource-manager-ps).

Включите протокол BGP для шлюза виртуальной сети, создав для него автономную систему (как). Основные шлюзы не поддерживают BGP. Чтобы проверить номер SKU шлюза, перейдите к разделу **Обзор** колонки **VPN-шлюза** в портал Azure. Если номер SKU является **базовым**, необходимо изменить номер SKU (см. раздел изменение [размера шлюза](https://docs.microsoft.com/powershell/module/azurerm.network/resize-azurermvirtualnetworkgateway?view=azurermps-4.1.0&viewFallbackFrom=azurermps-4.0.0)) на **VpnGw1**. 

Проверка номера SKU приведет к простою 20 – 30 минут. Как только шлюз будет иметь правильный номер SKU, его можно добавить с помощью командлета PowerShell [Set-AzureRmVirtualNetworkGateway](https://docs.microsoft.com/powershell/module/azurerm.network/set-azurermvirtualnetworkgateway?view=azurermps-3.8.0) . Когда вы настроите значение AS, IP-адрес узла BGP для шлюза будет предоставляться автоматически.

Необходимо вручную указать `LocalNetworkGateway` номер AS и адрес узла BGP. Значения `ASN` и`-BgpPeeringAddress` можно задать с помощью команды [New-азурермлокалнетворкгатевай](https://docs.microsoft.com/powershell/module/azurerm.network/new-azurermlocalnetworkgateway?view=azurermps-4.1.0) или [Set-азурермлокалнетворкгатевай](https://docs.microsoft.com/powershell/module/azurerm.network/set-azurermlocalnetworkgateway?view=azurermps-4.1.0) PowerShell командлет. Некоторые цифры зарезервированы для Azure, и их нельзя использовать, как описано в статье [о BGP с VPN-шлюзом Azure](../vpn-gateway/vpn-gateway-bgp-overview.md#faq).

Для объекта соединения должен быть включен BGP. `-EnableBGP` Можно задать `$True` значение с помощью [New-AzureRmVirtualNetworkGatewayConnection](https://docs.microsoft.com/powershell/module/azurerm.network/new-azurermvirtualnetworkgatewayconnection?view=azurermps-4.1.0) или [Set-AzureRmVirtualNetworkGatewayConnection](https://docs.microsoft.com/powershell/module/azurerm.network/set-azurermvirtualnetworkgatewayconnection?view=azurermps-4.1.0).

### <a name="validate-the-bgp-configuration"></a>Проверка конфигурации BGP

Чтобы проверить, правильно ли настроен протокол BGP, можно запустить `get-AzureRmVirtualNetworkGateway` и `get-AzureRmLocalNetworkGateway` командлеты. Затем Обратите внимание на выходные данные, связанные с `BgpSettingsText` BGP, в части. Пример:

```
{

"Asn": AsnNumber,

"BgpPeeringAddress": "IP address",

"PeerWeight": 0

}
```

## <a name="create-a-highly-available-activeactive-vpn-connection"></a>Создание высокодоступного активного/активного VPN-подключения

Основные различия между шлюзами "активный/активный" и "активный/резервный":

* Необходимо создать две IP-конфигурации шлюза с двумя общедоступными IP-адресами.
* Необходимо задать флаг **енаблеактивеактивефеатуре** .
* Номер SKU шлюза должен быть **VpnGw1**, **VpnGw2**или **VpnGw3**.

Чтобы обеспечить высокий уровень доступности между локальными и сетевыми подключениями, необходимо развернуть несколько VPN-шлюзов и установить несколько параллельных подключений между сетями и Azure. Общие сведения о вариантах подключения и топологии см. в разделе [высокодоступные подключения между локальными сетями и сеть-сеть](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-highlyavailable).

Чтобы создать активные или активные подключения между локальными и сетевыми сетями, следуйте инструкциям в статье Настройка активных и активных подключений [S2S с VPN-шлюзами Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-activeactive-rm-powershell) для настройки VPN-шлюза Azure в режиме "активный/активный".

> [!Note]  
> * При добавлении адресов в шлюз локальной сети для режима "активный/активный" с поддержкой BGP *добавьте только адреса узлов BGP (/32)* . Если добавить дополнительные адреса, они будут рассматриваться как статические маршруты и имеют приоритет над маршрутами BGP.
> * Для локальных сетей, подключающихся к Azure, необходимо использовать разные номера BGP. (Если они одинаковы, необходимо изменить виртуальную сеть как число, если локальное VPN-устройство уже использует ASN для пиринга с другими соседями BGP.)

## <a name="change-an-azure-vpn-gateway-type-after-deployment"></a>Изменение типа VPN-шлюза Azure после развертывания

Невозможно изменить тип шлюза виртуальной сети Azure с политики на основе политик на основе маршрутов или напрямую. Сначала необходимо удалить шлюз. После этого IP-адрес и общий ключ не будут сохранены. Затем можно создать новый шлюз для нужного типа. 

Чтобы удалить и создать шлюз, выполните следующие действия.

1. Удалите все подключения, связанные с исходным шлюзом.
2. Удалите шлюз с помощью портал Azure, PowerShell или классической оболочки PowerShell: 
   * [Удаление шлюза виртуальной сети с помощью портал Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-delete-vnet-gateway-portal)
   * [Удаление шлюза виртуальной сети с помощью PowerShell](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-delete-vnet-gateway-powershell)
   * [Удаление шлюза виртуальной сети с помощью PowerShell (классическая модель)](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-delete-vnet-gateway-classic-powershell)
3. Выполните действия, описанные в разделе [Создание VPN-шлюза](../vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal.md#VNetGateway) , чтобы создать новый шлюз требуемого типа и завершить настройку VPN.

> [!Note]
> Этот процесс займет около 60 минут.

## <a name="next-steps"></a>Следующие шаги

* [Устранение проблем с подключением между виртуальными машинами Azure](https://docs.microsoft.com/azure/virtual-network/virtual-network-troubleshoot-connectivity-problem-between-vms)

