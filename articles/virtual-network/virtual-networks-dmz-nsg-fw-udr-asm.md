---
title: Пример сети периметра — защита сетей с сетью периметра, состоящий из брандмауэром, определяемым пользователем Маршрутом и группами безопасности сети | Документация Майкрософт
description: Создание сети периметра (также называемой демилитаризованной ЗОНОЙ) с брандмауэром, определяемых пользователем маршрутов (UDR) и группы безопасности сети (Nsg).
services: virtual-network
documentationcenter: na
author: tracsman
manager: rossort
editor: ''
ms.assetid: dc01ccfb-27b0-4887-8f0b-2792f770ffff
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/01/2016
ms.author: jonor;sivae
ms.openlocfilehash: 668862714b416bd89d3b5f82caf8b0305fccae54
ms.sourcegitcommit: c174d408a5522b58160e17a87d2b6ef4482a6694
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2019
ms.locfileid: "59426534"
---
# <a name="example-3-build-a-perimeter-network-to-protect-networks-with-a-firewall-udr-and-nsgs"></a>Пример 3 Создание сети периметра для защиты сетей с брандмауэром, определяемым пользователем Маршрутом и группами безопасности сети

[Вернуться на страницу с советами и рекомендациями по построению периметра безопасности][HOME]

В этом примере создание сети периметра (также известны как DMZ, демилитаризованной зоной и промежуточной подсетью). В примере реализован брандмауэр, четырех серверов Windows, определяемые пользователем маршрутизацию (UDR), IP-пересылку и группы безопасности сети (Nsg). В этой статье описаны все используемые команды для более глубокого понимания каждого этапа. Трафик сценарии раздел также поясняет, подробные сведения о том, как прохождение трафика через уровни защиты в сети периметра. Наконец в разделе справочной информации содержит весь код и инструкции по созданию этой среды для тестирования и экспериментов с различными сценариями.

![Сеть периметра с двунаправленным письмом с NVA, группы безопасности сети и определяемыми пользователем Маршрутами][1]

## <a name="environment-setup"></a>Настройка среды

В этом примере используется подписка, которая содержит следующие компоненты:

* три облачные службы: SecSvc001, FrontEnd001 и BackEnd001
* Виртуальная сеть (CorpNetwork) с тремя подсетями: SecNet, FrontEnd и BackEnd
* Виртуальное сетевое устройство: брандмауэр, подключенный к подсети secnet;
* Сервера Windows, который представляет веб-сервер приложения: IIS01
* Два сервера Windows, которые представляют серверы серверной части приложения: AppVM01, AppVM02
* Сервер Windows, который представляет DNS-сервер: DNS01

[Ссылается на раздел](#references) содержит скрипт PowerShell, который создает большую часть среды, описанные здесь. В этой статье, в противном случае не дает подробные инструкции по созданию виртуальных машин (ВМ) и виртуальных сетей.

Чтобы создать среду, сделайте следующее.

1. Сохраните XML-файл конфигурации сети, включенные в [разделом](#references). Вам потребуется обновить его с именами, расположение и IP-адресов в соответствии с нужным сценарием.
1. Измените пользовательские переменные в полный скрипт в соответствии с конкретной среды (например, подписки, имена служб и т. д.).
1. Выполните сценарий в PowerShell.

> [!NOTE]
> Регион, указанный в скрипте PowerShell, должен соответствовать региону, в XML-файле конфигурации сети.

После успешного выполнения сценария, выполните следующие действия:

1. Настройка правил брандмауэра. См. в разделе [правила брандмауэра](#firewall-rules) раздел.
1. При необходимости используйте два скрипта в разделе справочной информации для настройки веб-приложения на сервере приложений и веб-сервер при тестировании данной конфигурации сети Периметра.

## <a name="user-defined-routing"></a>Определяемые пользователем маршруты

По умолчанию следующие системные маршруты определяются так:

    Effective routes :
     Address Prefix    Next hop type    Next hop IP address Status   Source
     --------------    -------------    ------------------- ------   ------
     {10.0.0.0/16}     VNETLocal                            Active   Default
     {0.0.0.0/0}       internet                             Active   Default
     {10.0.0.0/8}      Null                                 Active   Default
     {100.64.0.0/10}   Null                                 Active   Default
     {172.16.0.0/12}   Null                                 Active   Default
     {192.168.0.0/16}  Null                                 Active   Default

VNETLocal всегда является префиксы адреса для этой виртуальной сети. Например он изменится с виртуальной сети к виртуальной сети в зависимости от того, как определяется каждая конкретная виртуальная сеть. Остальные системные маршруты статические и по умолчанию, как показано.

Как и для приоритета маршруты обрабатываются с помощью метода длинного префикса (LPM). Поэтому наиболее подходящий маршрут в таблице применяется для определенного адреса назначения.

Таким образом, трафик, предназначенный для сервера DNS01 (10.0.2.4) в локальной сети (10.0.0.0/16) направляется всей виртуальной сети из-за маршрут 10.0.0.0/16.  Для 10.0.2.4 наиболее подходящий маршрут является маршрут 10.0.0.0/16. Это правило применяется, несмотря на то, что 10.0.0.0/8 и 0.0.0.0/0 могут также применяться. Они являются менее точно, тем не менее, поэтому они не влияют на этот трафик. Трафик к 10.0.2.4 имеет локальную виртуальную сеть, что его следующего прыжка, направляется в место назначения.

Например маршрут 10.0.0.0/16 не применяется к трафику, который предназначен для 10.1.1.1. Системный маршрут 10.0.0.0/8 является наиболее подходящим, трафик будет удалена, или «поставщик только черный», так как следующий прыжок имеет значение Null.

Если назначение не применяется к любому из префиксами Null или VNETLocal префиксы, трафика соответствует наименее подходящий маршрут (0.0.0.0/0). Оно будет направлено к Интернету следующим прыжком, а также за пределы границы Azure.

Если существует двух одинаковых префиксов в таблице маршрутов, в порядке предпочтения основан на исходный атрибут маршрута:

1. VirtualAppliance: Определяемые пользователем маршруты, добавленные вручную в таблицу.
1. VPNGateway: Добавить динамический маршрут (BGP при использовании с гибридными сетями) с динамическим сетевым протоколом. Эти маршруты могут меняться со временем, как динамический протокол автоматически отражает изменения в одноранговой сети.
1. Значение по умолчанию: Системные маршруты локальной виртуальной сети и статические маршруты, как показано в приведенной выше таблице маршрутизации.

> [!NOTE]
> Теперь можно использовать определяемых пользователем маршрутов (UDR) с ExpressRoute и VPN-шлюзов для принудительного входящий и исходящий трафик между локальными трафика, адресованного виртуальный сетевой модуль (NVA).

### <a name="create-local-routes"></a>Создание локальных маршрутов

В этом примере используется две таблицы маршрутизации, по одной для интерфейсной и внутренней подсети. В каждую таблицу загружены статические маршруты для данной подсети. В нашем примере каждая таблица содержит по три маршрута:

1. Нет возможности определения следующего прыжка определенные трафика локальной подсети. Этот маршрут позволяет трафику локальной подсети обходить брандмауэр.
2. Трафика виртуальной сети значением следующего прыжка, определенные как брандмауэр. Этот маршрут переопределяет правило по умолчанию, которое разрешает трафика виртуальной локальной сети для маршрутизации напрямую.
3. Всего остального трафика (0/0) с типом следующего прыжка, определенные как межсетевой экран.

После создания таблиц маршрутизации они привязываются к соответствующим подсетям. Таблица маршрутизации подсети frontend должен выглядеть так:

    Effective routes :
     Address Prefix    Next hop type       Next hop IP address  Status   Source
     --------------    ------------------  -------------------  ------   ------
     {10.0.1.0/24}     VNETLocal                                Active
     {10.0.0.0/16}     VirtualAppliance    10.0.0.4             Active
     {0.0.0.0/0}       VirtualAppliance    10.0.0.4             Active

В этом примере использует следующие команды для построения таблицы маршрутизации, добавления определяемого пользователем маршрута и затем привязать таблицу маршрутов с подсетью. Элементы, начинающиеся с `$`, такие как `$BESubnet`, — это определяемые пользователем переменные из сценария в разделе ссылок.

1. Во-первых создайте базовую таблицу маршрутизации. В следующем фрагменте кода создается таблица для серверной подсети. Полный скрипт также создает соответствующая таблица для интерфейсной подсети.

   ```powershell
   New-AzureRouteTable -Name $BERouteTableName `
       -Location $DeploymentLocation `
       -Label "Route table for $BESubnet subnet"
   ```

1. После создания таблицы маршрутов, можно добавить определенные определяемые пользователем маршруты. В следующем фрагменте кода указывает, что весь трафик (0.0.0.0/0) направляется через виртуальный модуль. Переменная `$VMIP[0]` используется для передачи IP-адрес, назначенный при создании виртуального устройства ранее в этом скрипте. Полный скрипт также создает соответствующее правило в таблице внешнего интерфейса.

   ```powershell
   Get-AzureRouteTable $BERouteTableName | `
       Set-AzureRoute -RouteName "All traffic to FW" -AddressPrefix 0.0.0.0/0 `
       -NextHopType VirtualAppliance `
       -NextHopIpAddress $VMIP[0]
   ```

1. У предыдущей записи маршрут переопределяет маршрут по умолчанию «0.0.0.0/0», но правило по умолчанию 10.0.0.0/16 разрешает трафик в виртуальной сети для маршрутизации непосредственно к назначению, а не к виртуальному сетевому устройству. Чтобы исправить это, необходимо добавить следующее правило:

   ```powershell
   Get-AzureRouteTable $BERouteTableName | `
       Set-AzureRoute -RouteName "Internal traffic to FW" -AddressPrefix $VNetPrefix `
       -NextHopType VirtualAppliance `
       -NextHopIpAddress $VMIP[0]
   ```

1. На этом этапе необходимо сделать выбор. Два правила из предыдущего направлять весь трафик на брандмауэр для оценки, включая трафик внутри одной подсети. Вы можете это поведение. Тем не менее, если этого не сделать, можно разрешить трафик внутри подсети локальную маршрутизацию без участия брандмауэра. Добавьте третий, определенное правило, непосредственно направляет любой адрес, предназначенный для локальной подсети (NextHopType = VNETLocal).

   ```powershell
   Get-AzureRouteTable $BERouteTableName | `
       Set-AzureRoute -RouteName "Allow Intra-Subnet Traffic" -AddressPrefix $BEPrefix `
           -NextHopType VNETLocal
   ```

1. Наконец после таблицы маршрутизации создается и заполняется с помощью определяемых пользователем маршрутов, необходимо привязать к подсети в таблице. В следующем фрагменте кода связывает таблицы для внутренней подсети. Полный сценарий также привязывает таблице переднего плана к интерфейсной подсети.

   ```powershell
   Set-AzureSubnetRouteTable -VirtualNetworkName $VNetName `
       -SubnetName $BESubnet `
       -RouteTableName $BERouteTableName
   ```

## <a name="ip-forwarding"></a>IP-пересылка

IP-пересылка всегда используется вместе для определяемого пользователем Маршрута. Этот параметр для виртуального устройства, позволяет принимать трафик, направленный на устройство и затем пересылать трафик его конечному получателю.

Например если трафик от AppVM01 делает запрос к серверу DNS01, определяемый пользователем Маршрут направляет трафик на брандмауэр. С помощью IP-пересылка включена принят устройством (10.0.0.4) брандмауэр и затем передан конечному получателю (10.0.2.4) трафик с указанным назначением DNS01 (10.0.2.4). Без IP-пересылка включена на брандмауэре, трафик не принят устройством несмотря на то, что в таблице маршрутизации указан брандмауэр следующим прыжком.

> [!IMPORTANT]
> Не забудьте включить IP-пересылку в сочетании с определяемой пользователем маршрутизации.

IP-пересылку можно включить с помощью одной команды во время создания виртуальной Машины. Вызовите экземпляр виртуальной Машины, — это виртуальное устройство брандмауэра и включить IP-пересылку. Имейте в виду, что элементы, начинающиеся с красным `$`, например `$VMName[0]`, — это определяемые пользователем переменные из сценария в в справочном разделе этого документа. Ноль в квадратных скобках, `[0]`, представляет первую виртуальную Машину в массиве виртуальных машин. Пример скрипта работал без изменений первая виртуальная машина (VM 0) должна быть брандмауэром. В полный скрипт в фрагменте соответствующий код группируется с командами UDR ближе к концу.

```powershell
Get-AzureVM -Name $VMName[0] -ServiceName $ServiceName[0] | `
    Set-AzureIPForwarding -Enable
```

## <a name="network-security-groups"></a>Группы безопасности сети

В этом примере можно создать группу безопасности сети (NSG) и последующей ее загрузки с помощью одного правила. Затем в примере выполняется привязка группы безопасности сети только к подсетям frontend и серверной части (не SecNet). Правила, которые вы загружаете в группу безопасности сети выглядит следующим образом:

* Весь трафик (все порты) из Интернета ко всей виртуальной сети (все подсети) запрещается

Несмотря на то, что в этом примере используются группы безопасности сети, их основной целью является создание дополнительного уровня защиты от неправильной настройки вручную. Вы хотите блокировать весь входящий трафик из Интернета для переднего плана или внутренней подсети. Трафик должен проходить только через подсеть SecNet на брандмауэр, после которого следует маршрутизируются только соответствующего трафика в подсети переднего плана или внутренней. Кроме того Установлены правила маршрутизации любой трафик, который достигает переднего плана или внутренней подсети на брандмауэр. Брандмауэр воспринимает его как асимметричный поток и исходящий трафик.

Три уровня безопасности для защиты подсетей интерфейсной и серверной части:

1. Нет открытых конечных точек в облачных службах FrontEnd001 и BackEnd001
1. Группы безопасности сети запрещают трафик из Интернета
1. Брандмауэр Удаляет асимметричный трафик

Интересная особенность группу безопасности сети в этом примере является то, что он содержит только одно правило, показано ниже. Это правило запрещает Интернет-трафик ко всей виртуальной сети, включая подсеть безопасности.

```powershell
Get-AzureNetworkSecurityGroup -Name $NSGName | `
    Set-AzureNetworkSecurityRule -Name "Isolate the $VNetName VNet `
    from the internet" `
    -Type Inbound -Priority 100 -Action Deny `
    -SourceAddressPrefix INTERNET -SourcePortRange '*' `
    -DestinationAddressPrefix VIRTUAL_NETWORK `
    -DestinationPortRange '*' `
    -Protocol *
```

Так как сетевая группа безопасности привязана только к подсетям frontend и серверной части, правило не применяется к трафик, входящий в подсеть безопасности. В результате трафик будет проходить в подсеть безопасности.

```powershell
Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName `
    -SubnetName $FESubnet -VirtualNetworkName $VNetName

Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName `
    -SubnetName $BESubnet -VirtualNetworkName $VNetName
```

## <a name="firewall-rules"></a>Правила файрволла

В брандмауэре необходимо создать правила пересылки. Так как брандмауэр блокирует или пересылает весь входящий, исходящий и intra-virtual-network трафик, требуется много правил брандмауэра. Кроме того брандмауэр должен обрабатывать весь входящий трафик на IP-адрес общедоступной службы безопасности (на разных портах). Чтобы позже избежать дополнительной работы, следуйте рекомендациям, построив диаграмму логических потоков, прежде чем настраивать подсети и правила брандмауэра. Следующий рисунок является логическим представлением правил брандмауэра для этого примера.

![Логическое представление правил брандмауэра][2]

> [!NOTE]
> Порты управления зависят от сетевого виртуального модуля. В этом примере показано, брандмауэр Barracuda NextGen Firewall, который использует порты 22, 801 и 807. Обратитесь к документации поставщика устройства, чтобы точно знать, какие порты для управления устройством.

### <a name="logical-rule-description"></a>Описание логического правила

Приведенной выше логической схеме не отображаются в подсеть безопасности, так как брандмауэр является единственным ресурсом в этой подсети. На этой схеме показаны правила брандмауэра, как логика разрешения или запрета трафика, но не фактический перенаправленные путь. Кроме того внешние порты, выбранные для трафика протокола удаленного рабочего стола (RDP), выше диапазоны портов (8014 – 8026), выбранный для удобства в соответствии с последними двумя октетами локального IP-адресов. Например адрес локального сервера 10.0.1.4 связан с внешним портом 8014. Тем не менее, можно выполнить какие-либо более поздней версии неконфликтующие порты.

В этом примере требуется следующие типы правил:

* Внешние правила для входящего трафика:
  1. Правило управления брандмауэром: разрешает передачу трафика на порты управления виртуального сетевого устройства.
  2. Правила RDP для каждого сервера windows server: позволяет управлять серверами через RDP.  В зависимости от возможностей вашего сетевого виртуального модуля можно объединить правила в одну.
  3. Правила трафика приложений: один для внешнего интерфейса веб-трафика, а другой для внутреннего трафика (например, веб-сервера к уровню данных). Параметры этих правил зависит от архитектуры сети и трафика потоков.

     * Первое правило позволяет фактическому трафику приложения достигать сервера приложений. В отличие от правила безопасности, управления и т. д. правила приложений позволяют внешним пользователям и службам взаимодействовать с приложениями. В этом примере имеет один веб-сервер на порте 80, что позволяет одно правило приложения брандмауэра для перенаправления трафика, предназначенного для внешнего IP-адреса, вместо маршрутизации внутренний IP-адрес веб сервера. Трафик меняется с NAT к внутреннему серверу.
     * Второе правило трафика приложения используется для внутренних позволяют использовать любой порт для маршрутизации трафика, к серверу AppVM01, но не AppVM02 сервера веб-серверу.

* Внутренние правила для трафика сети intra virtual:
  1. Исходящие подключения к Интернету правило: трафик из любой сети для передачи в указанные сети. Обычно это правило является по умолчанию в брандмауэре, но в отключенном состоянии. Включите это правило в этом примере.
  2. Правило DNS: разрешен только трафик DNS (порт 53) для передачи на DNS-сервер. Для этой среды блокируется большая часть трафика от интерфейсной подсети к серверной части. В частности, это правило явно разрешает трафик DNS из любой локальной подсети.
  3. Правило трафика между подсетями: позволяет любому серверу в подсети серверной части для подключения к любому серверу в интерфейсной подсети, но не наоборот.

* Резервное правило для трафика, который не соответствует указанным выше критериям.
  1. Правило запрета любого трафика: всегда последнее правило приоритету. Если трафик не соответствует ни одному из предыдущих правил, это правило блокирует его. Это правило по умолчанию. Так как он часто активируется, необходимы какие-либо изменения.

> [!TIP]
> Второе правило трафика приложения любой порт разрешено простоты в этом примере. В реальном сценарии чтобы уменьшить контактную зону это правило следует использовать определенный порт, а также диапазоны адресов.


> [!IMPORTANT]
> После создания правила, очень важно, что вы проверьте приоритет каждого правила, чтобы убедиться, что трафик разрешен или запрещен при необходимости. В нашем примере правила расположены в порядке приоритета. Его можно легко потерять брандмауэр, в случае неправильного порядка правил. Не забудьте задать правило управления брандмауэром абсолютный наивысший приоритет.

### <a name="rule-prerequisites"></a>Предварительные требования для правил

Общедоступные конечные точки являются обязательными для виртуальной машины, работающей брандмауэр. Эти общедоступные конечные точки, необходимо открыть, чтобы брандмауэр может обрабатывать трафик. Существует три типа трафика в этом примере:

1. Трафик управления для управления брандмауэром и правилами брандмауэра
1. Трафик RDP для управления серверами windows Server
1. Трафик приложения

Типы трафика отображаются в верхней половине окна брандмауэра правила выше логической схеме.

> [!IMPORTANT]
> Помните, что *все* трафик поступает через брандмауэр. К удаленному рабочему столу сервера IIS01 необходимо подключиться к порту 8014 брандмауэра, а затем разрешить брандмауэру отправить запрос RDP внутри на порт IIS01 RDP. На портале Azure **Connect** кнопки не будет работать, поскольку нет прямого пути RDP к IIS01, как можно увидеть в портале. Все подключения из Интернета — это служба безопасности и порт (например, secscv001.cloudapp.net:xxxx). Ссылаться на схеме выше для сопоставления внешнего порта и внутренних IP-адрес и порт.

Во время создания виртуальной Машины или после построения, можно открыть конечную точку. В примере сценария и в следующем фрагменте кода откройте конечную точку, после создания виртуальной Машины.

Имейте в виду, что элементы, начинающиеся с `$`, такие как `$VMName[$i]`, — это определяемые пользователем переменные из сценария в разделе ссылок. `[$i]` Является номером массива определенной виртуальной машины в массиве виртуальных машин.

```powershell
Add-AzureEndpoint -Name "HTTP" -Protocol tcp -PublicPort 80 -LocalPort 80 `
    -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | `
    Update-AzureVM
```

Несмотря на то, что это показано не очевидно из-за переменных, следует открывать только конечные точки в облачной службе безопасности. Эта мера предосторожности гарантирует, что брандмауэр обрабатывает весь входящий трафик, ли маршрутизации, повторное сопоставление с NAT или удаляется.

Установите клиент управления на ПК для управления брандмауэром и создания необходимых конфигураций. Дополнительные сведения об управлении брандмауэром или другого виртуального сетевого устройства к документации поставщика. В оставшейся части этого раздела, а также **создания правил брандмауэра** раздела описывают конфигурацию брандмауэра. Использование клиента управления поставщика, а не портал Azure или PowerShell.

Перейдите к [администратора Barracuda NG](https://techlib.barracuda.com/NG61/NGAdmin) для загрузки клиента управления и сведения о подключении к брандмауэру Barracuda.

После вы выполнили вход в брандмауэр, определите сетью и службой объекты, прежде чем создавать правила брандмауэра. Эти два класса готовности к установке объектов можно сделать, создания правил с помощью.

В этом примере Определите три именованных сетевых объекта для каждого:

* Интерфейсной подсети
* Внутренней подсети
* IP-адрес DNS-сервера

Чтобы создать именованные сети, панель мониторинга администратора Barracuda NG:

1. Перейдите к **вкладка "Конфигурация"**.
1. Выберите **Ruleset** в **рабочая конфигурация** раздел
1. Выберите **сетей** под **объекты брандмауэра** меню.
1. Выберите **New** в **изменение сетей** меню.
1. Создание сетевого объекта, добавив имя и префикс:

   ![Создание сетевого front-ed объекта][3]

Описанные выше шаги создана именованная сеть для интерфейсной подсети. Создайте похожий объект для серверной подсети, а также. Теперь, когда у подсетей есть имена, их проще использовать в правилах брандмауэра.

Для объекта DNS-сервера:

![Создание объекта сервера DNS][4]

Это одна ссылка адрес IP-адрес используется в правиле DNS позднее в этом документе.

Класс объекта содержит объекты служб, которые представляют порты подключения RDP для каждого сервера. Существующий служебный объект RDP привязан к порту RDP по умолчанию 3389. Таким образом можно создать новые службы, чтобы разрешить трафик от внешних портов (8014 – 8026). Можно также добавить новые порты в существующую службу RDP. Тем не менее для удобства демонстрации, можно сделать для каждого сервера отдельное правило. Чтобы создать новое правило RDP для сервера панель мониторинга администратора Barracuda NG:

1. Перейдите к **вкладка "Конфигурация"**.
1. Выберите **Ruleset** в **рабочая конфигурация** раздел.
1. Выберите **служб** под **объекты брандмауэра** меню.
1. Прокрутите вниз список служб и выберите **RDP**.
1. Щелкните правой кнопкой мыши и выберите копию, затем щелкните правой кнопкой мыши и выберите команду Вставить.
1. Теперь есть объект службы RDP-Copy1, который можно редактировать. Щелкните правой кнопкой мыши **RDP-Copy1** и выберите **изменить**.
1. **Изменение объекта службы** откроется окно до, как показано ниже:

   ![Копия правила RDP по умолчанию][5]

1. Измените значения для представления службы RDP для конкретного сервера. Для AppVM01, правила RDP по умолчанию может изменяться в соответствии с новой службы **имя**, **описание**и внешним портом RDP, используемый в схеме на рисунке 8. Имейте в виду, что порты изменяются RDP по умолчанию 3389 на внешний порт для этого сервера. Например 8025 является внешний порт для AppVM01. Ниже приведен правило измененной службы.

   ![Правило AppVM01][6]

Повторите эту процедуру для создания служб RDP для остальных серверов: AppVM02, DNS01 и IIS01. Правила упростить эти службы в следующем разделе для создания и более очевидным.

> [!NOTE]
> Службу удаленного рабочего СТОЛА для брандмауэра не требуется, так как брандмауэр виртуальной Машины является образ на базе Linux, SSH, используемый для управления виртуальными Машинами, а не по протоколу RDP через порт 22. Кроме того, порт 22, а два других порта запрещены для управления подключением. См. в разделе **правило управления брандмауэром** в следующем разделе.

### <a name="firewall-rules-creation"></a>Создание правил брандмауэра

Существует три типа правил брандмауэра, используемых в этом примере все с помощью разных значков:

Правило перенаправления приложения: ![Значок перенаправления приложения][7]

Правило NAT назначения: ![Значок NAT назначения][8]

Разрешающее правило: ![Значок передачи][9]

Дополнительные сведения об этих правилах можно найти на веб-сайте Barracuda.

Чтобы создать следующие правила или проверить существующие правила по умолчанию:

1. Панель мониторинга администратора Barracuda NG, перейдите к **конфигурации** вкладки.
1. В **рабочая конфигурация** выберите **Ruleset**.
1. **Основные правила** сетке показаны существующие активные и деактивации правила брандмауэра. Щелкните зеленый **+** в правом верхнем углу, чтобы создать новое правило. Если брандмауэр будет заблокирован для изменения, вы видите кнопку помечены **блокировки** и не удается создать или изменить правила. Выберите **блокировки** кнопку, чтобы разблокировать набор правил и разрешить редактирование. Щелкните правой кнопкой мыши правило, требуется изменить и выберите **изменение правила**.

После создания или изменять какие-либо правила, отправить их в брандмауэр и активировать их. В противном случае правила изменения не вступят в силу. Процесс отправки и активации описан в [правила активации](#rule-activation).

Ниже приведены особенности каждого правила, необходимые для выполнения в этом примере.

* **Правило управления брандмауэром**: Это правило перенаправления приложения разрешает передачу трафика на порты управления сетевого виртуального модуля, в этом примере брандмауэр Barracuda NextGen Firewall. Портами управления являются 801, 807 и, при необходимости, 22. Внешние и внутренние порты совпадают, преобразование портов не используется. Это правило называется SETUP-MGMT-ACCESS. Правило по умолчанию и по умолчанию брандмауэр Barracuda NextGen Firewall версии 6.1.
  
    ![Правило управления брандмауэром][10]

  > [!TIP]
  > Адресное пространство источника в этом правиле — **любой**. Если известны диапазоны IP-адресов управления, уменьшение этой области также снижает уязвимость к портам управления.

* **Правила RDP**:  Эти правила назначения NAT обеспечивают управление серверами через RDP. Ниже приведены критические поля для этих правил.
  * Источник. Чтобы разрешить RDP из любого места, используйте ссылку **любой** в поле источника.
  * Service. Используйте ранее созданный объект службы RDP: **AppVM01 RDP**. Внешние порты, перенаправляется на локальный IP-адрес сервера и порт RDP по умолчанию 3389. Это правило предназначено для доступа к AppVM01 по протоколу RDP.
  * Место назначения. Используйте локальный порт в брандмауэре: **DCHP 1 Local IP** или **eth0** при использовании статических IP-адресов. Порядковый номер (eth0, eth1 и т. д.) может отличаться в том случае, если сетевое устройство имеет несколько локальных интерфейсов. Брандмауэр использует этот порт для отправки, и он может быть таким же, как принимающий порт. Фактическое назначение указано в **целевой список** поля.
  * Перенаправление. Настройка виртуального устройства ключ указывает, куда счете перенаправить трафик. Самый простой перенаправления может быть IP-адрес в поле целевого списка. Можно также указать порт и перенаправляет NAT, порт и IP-адрес. Если не указать порт, виртуальное устройство использует порт назначения для входящего запроса.

    ![Правило RDP брандмауэра][11]

    Создайте четыре правила RDP:

    | Имя правила | сервер; | Service | Целевой список |
    | --- | --- | --- | --- |
    | RDP-to-IIS01 |IIS01 |IIS01 RDP |10.0.1.4:3389 |
    | RDP-to-DNS01 |DNS01 |DNS01 RDP |10.0.2.4:3389 |
    | RDP-to-AppVM01 |AppVM01 |AppVM01 RDP |10.0.2.5:3389 |
    | RDP-to-AppVM02 |AppVM02 |AppVm02 RDP |10.0.2.6:3389 |

  > [!TIP]
  > Сужение области поля «источник» и «служба снижает уязвимость. Используйте наиболее ограниченную область действия, функции.

* **Правила трафика приложений**: Существует два правила трафика приложений. Одним является интерфейсный веб-трафика. Другой охватывает внутреннего трафика, такие как веб-сервера к уровню данных. Эти правила зависят от архитектуры сети и характеристик потоков трафика.
  
  * Правило переднего плана для веб-трафика.
  
    ![Веб-правило брандмауэра][12]
  
    Это правило NAT назначения позволяет фактическому трафику приложения достигать сервера приложений. В отличие от правил безопасности, управления и прочих правила приложений позволяют внешним пользователям и службам взаимодействовать с приложениями. В этом примере имеет один веб-сервер на порте 80, что позволяет одно правило приложения брандмауэра для перенаправления трафика, предназначенного для внешнего IP-адреса, вместо маршрутизации внутренний IP-адрес веб сервера. Трафик меняется с NAT к внутреннему серверу.

    > [!NOTE]
    > Нет порта, назначенный в **целевой список** поля. Таким образом входящий порт 80 (или 443 для выбранной службы) используется в перенаправлении веб-сервера. Если веб-сервер прослушивает другой порт, например 8080, указать значение 10.0.1.4:8080, чтобы разрешить перенаправление портов также можно обновить поле целевой список.
  
  * Внутреннее правило позволяет веб-серверу обращаться к серверу AppVM01, но не AppVM02 через **любой** службы:
  
    ![Правило AppVM01 брандмауэра][13]
  
    Это разрешающее правило разрешает любому серверу IIS подсети переднего плана к AppVM01 (10.0.2.5) через любой порт, с использованием любого протокола, таким образом, чтобы данные можно получить веб-приложением.
  
    На этом снимке экрана `<explicit-dest>` используется в **назначения** поля для обозначения 10.0.2.5 в качестве места назначения. IP-адрес можно указать явным образом, как показано на снимке экрана. Можно также использовать именованные сетевые объекты, такие как в предварительных требованиях для DNS-сервера. Администратор брандмауэра можно выбрать используемый метод. Чтобы добавить 10.0.2.5 в качестве явного назначения, дважды щелкните первую пустую строку под `<explicit-dest>` и введите адрес в открывшемся диалоговом окне.
  
    С помощью этого разрешающего правила NAT не требуется, поскольку им операций внутреннего трафика. Можно задать **метод подключения** для `No SNAT`.
  
    > [!NOTE]
    > Исходная сеть в этом правиле — это любой ресурс подсети переднего плана, если имеется только один. Если вашей архитектуры указывает ряд известных веб-серверов, можно создать объект сетевого ресурса, более точным, чтобы эти конкретные IP-адреса, а не всей подсети переднего плана.

    > [!TIP]
    > Это правило использует службу **любой** для упрощения примера приложения для установки и использования. Он позволяет ICMPv4 (проверка связи) в одном правиле. Тем не менее для уменьшения атаки поверхности через эту границу, мы советуем ограничивать порты и протоколы службы до возможного минимума, Разрешить операцию для приложения.

    > [!TIP]
    > Несмотря на то, что это правило пример использует `<explicit-dest>` ссылку, следует использовать последовательный подход в конфигурации брандмауэра. Рекомендуется использовать именованные сетевые объекты для упрощения читаемость и возможности поддержки. `<explicit-dest>` Приведенных здесь только для отображения альтернативного метода ссылки. Мы не рекомендуется, особенно для сложных конфигураций.

* **Правило исходящий трафик для IIS**: Это разрешающее правило разрешает трафик из исходной сети для передачи в указанные сети назначения. Брандмауэр Barracuda NextGen обычно имеет это правило «on», по умолчанию, но в отключенном состоянии. Щелкните правой кнопкой мыши на это правило для доступа к **активировать правило** команды. Измените правило, показано на снимке экрана для добавления объектов сети для подсетей внутреннего и внешнего интерфейса для исходного атрибута из этого правила. Вы создали эти объекты сети в разделе предварительных требований в этой статье.
  
    ![Правило исходящего трафика брандмауэра][14]

* **Правило DNS**: Это разрешающее правило разрешает только трафик DNS (порт 53) для передачи на DNS-сервер. Для этой среды блокируется большая часть трафика от внешнего интерфейса к серверной части, поэтому это правило отдельно разрешает трафик DNS.
  
    ![Правило DNS брандмауэра][15]
  
    > [!NOTE]
    > **Метод подключения** присваивается `No SNAT` так, как это правило предназначено для внутреннего IP-адреса для внутренних IP-адресов трафика и перенаправление через NAT не является обязательным.

* **Правило трафика между подсетями**: Это разрешающее правило по умолчанию активирована и изменить, чтобы разрешить любому серверу в подсети серверной части для подключения к любому серверу в интерфейсной подсети. Это правило coves только внутренний трафик поэтому **метод подключения** можно присвоить `No SNAT`.

    ![Правило брандмауэра для внутреннего трафика виртуальной сети][16]
  
    > [!NOTE]
    > **Двустороннего** не установлен флажок ниже, это правило применяется только в одном направлении. Соединение может быть инициировано от внутренней подсети к внешней сети, но не наоборот. Если этот флажок установлен, правило будет разрешать двунаправленный трафик, который мы указали как нежелательным в нашей логической схеме.

* **Правило запрета любого трафика**: Это правило всегда должно быть последнее правило приоритету. Если поток трафика не соответствует ни одному из предыдущих правил, это правило вызывает его для удаления. Правила обычно активируется по умолчанию, поэтому изменения не требуются.
  
    ![Правило запрета брандмауэра][17]

> [!IMPORTANT]
> После создания всех предыдущих правил, проверьте приоритет каждого правила, чтобы трафик разрешен или запрещен при необходимости. Например правила, перечислены в порядке, в котором они должны отображаться в основной сетке правил пересылки клиента управления Barracuda.

## <a name="rule-activation"></a>Активация правила

После изменения набора правил в соответствует спецификациям логической схемой, необходимо отправить набор правил в брандмауэр и активировать его.

![Активация правила брандмауэра][18]

Загляните в правом верхнем углу окна клиента управления и выберите **отправить изменения** Чтобы отправить измененные правила в брандмауэр. Выберите **Активировать**.

При активации набора правил брандмауэра, этот пример среды завершена.

## <a name="traffic-scenarios"></a>Варианты прохождения трафика

> [!IMPORTANT]
> Помните, что *все* трафик поступает через брандмауэр. К удаленному рабочему столу сервера IIS01 необходимо подключиться к порту 8014 брандмауэра, а затем разрешить брандмауэру отправить запрос RDP внутри на порт IIS01 RDP. На портале Azure **Connect** кнопки не будет работать, поскольку нет прямого пути RDP к IIS01, как можно увидеть в портале. Все подключения из Интернета — это служба безопасности и порт (например, secscv001.cloudapp.net:xxxx). Ссылаться на схеме выше для сопоставления внешнего порта и внутренних IP-адрес и порт.

В этих сценариях должны соблюдаться приведенные ниже правила брандмауэра.

1. Управление брандмауэра (FW Mgmt)
2. Запрос через RDP к IIS01.
3. Запрос через RDP к DNS01.
4. Запрос через RDP к AppVM01.
5. Запрос через RDP к AppVM02.
6. Трафик приложения в Интернет.
7. Трафик приложения на AppVM01.
8. Исходящие подключения к Интернету
9. Внешний интерфейс к DNS01.
10. Трафик внутри подсети (только из внутренней подсети в подсеть переднего плана).
11. Запрет любого трафика.

Набор правил в реальном брандмауэре скорее всего потребует Дополнительные правила, чем в этом примере. Они скорее всего, также различные приоритеты номера. См. в этот список и связанные с ними номера для их относительный приоритет друг с другом. Например, правило «RDP на IIS01» может быть правилом номер 5 в реальном брандмауэре, но при условии его ниже «управление брандмауэром» и выше «RDP на DNS01» правила набора выравнивает, целям этого списка. Этот список также позволяет упростить для сценариев, следуйте инструкциям. Например «правило брандмауэра 9 (DNS).» Имейте в виду, что четыре правила RDP называются «правилами RDP» Если сценарий трафика не связан с RDP.

Также помните, что группы безопасности сети (Nsg) применяются для входящего Интернет-трафика в подсетях интерфейсной и серверной части.

### <a name="allowed-internet-to-web-server"></a>(Разрешено) Интернет, веб-сервер

1. Интернет-пользователь запрашивает страницу HTTP из службы SecSvc001.CloudApp.Net (облачная Интернет-служба).
1. Облачная служба передает трафик через открытую конечную точку на порте 80 на интерфейс брандмауэра 10.0.0.4:80.
1. Отсутствие группы безопасности сети назначается подсети безопасности в том случае, поэтому эти правила группы безопасности сети системы разрешают трафик на брандмауэр.
1. Трафик достигает внутреннего IP-адреса брандмауэра (10.0.1.4).
1. Брандмауэр выполняет обработку правил:
   1. Правила брандмауэра (FW Mgmt) 1 не применяется. Переход к следующему правилу.
   1. Правила брандмауэра 2-5 (правила RDP) не применяются. Переход к следующему правилу.
   1. Правило брандмауэра 6 (приложение: Применение веб-приложений). Трафик разрешается. Брандмауэр перенаправляет трафик через NAT на 10.0.1.4 (IIS01).
1. Интерфейсной подсети выполняет обработку правил для входящего трафика:
   1. Правило группы безопасности сети (блокирование доступа к Интернету) 1 не применяется. Брандмауэр пересылаются этот трафик через NAT, поэтому адресом источника теперь является брандмауэр. Так как брандмауэр в подсети безопасности и отображается как локальный трафик в интерфейсной подсети NSG, трафик разрешается. Переход к следующему правилу.
   1. Правила группы безопасности сети по умолчанию разрешает трафик между подсетями, поэтому трафик разрешается. Остановите обработку правил группы безопасности сети.
1. IIS01 ожидает передачи данных для веб-трафика. Он получает этот запрос и начинает обработку запроса.
1. IIS01 пытается инициировать сеанс FTP для AppVM01 в подсети серверной части.
1. Определяемый Пользователем маршрут в подсети frontend следующим прыжком задает брандмауэр.
1. Нет исходящих правил в интерфейсной подсети, поэтому трафик разрешается.
1. Брандмауэр начинает обработку правил.
   1. Правила брандмауэра (FW Mgmt) 1 не применяется. Переход к следующему правилу.
   1. Правила брандмауэра 2-5 (правила RDP) не применяются. Переход к следующему правилу.
   1. Правило брандмауэра 6 (приложение: Веб-приложений) не применяется. Переход к следующему правилу.
   1. Правило брандмауэра 7 (приложение: серверной части) применяются. Трафик разрешается. Брандмауэр перенаправляет трафик на 10.0.2.5 (AppVM01).
1. Внутренней подсети выполняет обработку правил для входящего трафика:
    1. Правило группы безопасности сети (блокирование доступа к Интернету) 1 не применяется. Переход к следующему правилу.
    1. Правила группы безопасности сети по умолчанию разрешают трафик трафика между подсетями. Трафик разрешается. Остановите обработку правил группы безопасности сети.
1. AppVM01 получает запрос, запускает сеанс и отвечает.
1. Определяемый Пользователем маршрут в подсети серверной части следующим прыжком задает брандмауэр.
1. Существует нет правил для исходящего трафика в подсети серверной части, ответ пропускается.
1. Так как он это обратный трафик в активном сеансе, брандмауэр возвращает ответ обратно веб-серверу (IIS01).
1. Интерфейсной подсети выполняет обработку правил для входящего трафика:
    1. Правило группы безопасности сети (блокирование доступа к Интернету) 1 не применяется. Переход к следующему правилу.
    1. Правила группы безопасности сети по умолчанию разрешает трафик между подсетями, поэтому трафик разрешается. Остановите обработку правил группы безопасности сети.
1. Сервер IIS получает ответ и завершает транзакцию с AppVM01. Затем сервер завершает создание HTTP-ответ и отправляет его запрашивающей стороне.
1. Существует нет правил для исходящего трафика в подсети frontend, ответ пропускается.
1. HTTP-ответ попадает в брандмауэр. Так как это ответ активному сеансу NAT, брандмауэр принимает его.
1. Брандмауэр перенаправляет ответ обратно Интернет-пользователь.
1. Не существует правил для исходящего трафика или прыжков определяемых пользователем Маршрутов в подсети frontend, ответ пропускается. Интернет-пользователь получает запрашиваемую веб-страницу.

### <a name="allowed-internet-rdp-to-back-end"></a>(Разрешено) Интернет по протоколу RDP к серверной части

1. Администратор сервера в Интернете запрашивает сеанс RDP с AppVM01 через SecSvc001.CloudApp.Net:8025. 8025 — это номер порта, назначаемого пользователем правила брандмауэра (RDP AppVM01). 4.
1. Облачная служба передает трафик через открытую конечную точку на порте 8025 на интерфейс брандмауэра 10.0.0.4:8025.
1. Отсутствие группы безопасности сети назначается подсети безопасности, поэтому правила группы безопасности сети системы разрешают трафик на брандмауэр.
1. Брандмауэр выполняет обработку правил:
   1. Правила брандмауэра (FW Mgmt) 1 не применяется. Переход к следующему правилу.
   1. Правила брандмауэра (RDP IIS) 2 не применяется. Переход к следующему правилу.
   1. Правило брандмауэра 3 (RDP DNS01) не применяется. Переход к следующему правилу.
   1. Применяются правила брандмауэра (RDP AppVM01) 4, поэтому трафик разрешается. Брандмауэр перенаправляет его через NAT для 10.0.2.5:3386 (порт RDP на AppVM01).
1. Внутренней подсети выполняет обработку правил для входящего трафика:
   1. Правило группы безопасности сети (блокирование доступа к Интернету) 1 не применяется. Брандмауэр пересылаются этот трафик через NAT, поэтому адресом источника теперь является брандмауэр, который находится в подсети безопасности. Он виден NSG подсети серверной части как локальный трафик и разрешается. Переход к следующему правилу.
   1. Правила группы безопасности сети по умолчанию разрешает трафик между подсетями, поэтому трафик разрешается. Остановите обработку правил группы безопасности сети.
1. AppVM01 прослушивает трафик RDP и отвечает.
1. Имеется нет правил для исходящего трафика, поэтому применяются правила по умолчанию. Обратный трафик разрешается.
1. Определяемые пользователем Маршруты направляют исходящий трафик в брандмауэр следующим прыжком.
1. Так как он это обратный трафик в активном сеансе, брандмауэр возвращает ответ обратно Интернет-пользователь.
1. Включен сеанс удаленного рабочего СТОЛА.
1. Сервер AppVM01 запрашивает имя пользователя, пароль.

### <a name="allowed-web-server-dns-lookup-on-dns-server"></a>(Разрешено) Web server DNS-запрос серверу DNS

1. Веб-серверу IIS01 запрашивает поток HTTP-данных\:\/\/www.data.gov, но ему необходимо разрешить адрес.
1. Конфигурация сети для виртуальной сети списков DNS01 (10.0.2.4 в подсети серверной части) как основной DNS-сервер. Сервер IIS01 отправляет DNS-запрос серверу dns01.
1. Определяемые пользователем Маршруты направляют исходящий трафик в брандмауэр следующим прыжком.
1. Нет правил для исходящего трафика привязаны к интерфейсной подсети. Трафик разрешается.
1. Брандмауэр выполняет обработку правил:
   1. Правила брандмауэра (FW Mgmt) 1 не применяется. Переход к следующему правилу.
   1. Правило брандмауэра на 2 – 5 (правила RDP) не применяются. Переход к следующему правилу.
   1. Правила брандмауэра, 6 и 7 (правила приложений) не применяются. Переход к следующему правилу.
   1. Правило брандмауэра 8 (для доступа к Интернету) не применяется. Переход к следующему правилу.
   1. Применить правила брандмауэра 9 (DNS). Трафик разрешается. Брандмауэр перенаправляет трафик на 10.0.2.4 (DNS01).
1. Внутренней подсети выполняет обработку правил для входящего трафика:
   1. Правило группы безопасности сети (блокирование доступа к Интернету) 1 не применяется. Переход к следующему правилу.
   1. Правила группы безопасности сети по умолчанию разрешают трафик трафика между подсетями. Трафик разрешается. Остановите обработку правил группы безопасности сети.
1. DNS-сервер получает запрос.
1. DNS-сервер не указан адрес, который кэшируются и запрашивает корневой DNS-сервер в Интернете.
1. Определяемые пользователем Маршруты направляют исходящий трафик в брандмауэр следующим прыжком.
1. Существуют нет правил для исходящего трафика в подсети серверной части на трафик разрешен.
1. Брандмауэр выполняет обработку правил:
   1. Правила брандмауэра (FW Mgmt) 1 не применяется. Переход к следующему правилу.
   1. Правило брандмауэра на 2 – 5 (правила RDP) не применяются. Переход к следующему правилу.
   1. Правила брандмауэра, 6 и 7 (правила приложений) не применяются. Переход к следующему правилу.
   1. Применить правила брандмауэра, 8 (Интернет). Трафик разрешается. Сеанс перенаправляется через SNAT к корневому DNS-серверу в Интернете.
1. The internet DNS server responds. Этот сеанс инициирован от брандмауэра, поэтому он принимает ответ брандмауэром.
1. Этот сеанс уже установлено, поэтому брандмауэр перенаправляет ответ на инициирующий сервер DNS01.
1. Внутренней подсети выполняет обработку правил для входящего трафика:
    1. Правило группы безопасности сети (блокирование доступа к Интернету) 1 не применяется. Переход к следующему правилу.
    1. Правила группы безопасности сети по умолчанию разрешить трафик трафика между подсетями на трафик разрешается. Остановите обработку правил группы безопасности сети.
1. DNS-сервер получает и кэширует ответ и затем отвечает на исходный запрос обратно на сервер IIS01.
1. Определяемый Пользователем маршрут в подсети серверной части следующим прыжком задает брандмауэр.
1. Нет правил для исходящего трафика существует в подсети серверной части, поэтому трафик разрешается.
1. Этот сеанс уже установлено на брандмауэре, брандмауэр перенаправляет ответ обратно к серверу IIS.
1. Интерфейсной подсети выполняет обработку правил для входящего трафика:
    1. Нет правил NSG для входящего трафика из внутренней подсети для интерфейсной подсети, ни одно из правил группы безопасности сети применяется.
    1. Системное правило по умолчанию разрешает трафик между подсетями. Трафик разрешается.
1. Сервер IIS01 получает ответ от сервера DNS01.

### <a name="allowed-back-end-server-to-front-end-server"></a>(Разрешено) Тыловых серверов сервер клиентского доступа

1. Администратор вошел на appvm02 через RDP запрашивает файл непосредственно с сервера IIS01 через проводник.
1. Определяемый Пользователем маршрут в подсети серверной части следующим прыжком задает брандмауэр.
1. Существует нет правил для исходящего трафика в подсети серверной части, ответ пропускается.
1. Брандмауэр выполняет обработку правил:
   1. Правила брандмауэра (FW Mgmt) 1 не применяется. Переход к следующему правилу.
   1. Правило брандмауэра на 2 – 5 (правила RDP) не применяются. Переход к следующему правилу.
   1. Правила брандмауэра, 6 и 7 (правила приложений) не применяются. Переход к следующему правилу.
   1. Правило брандмауэра 8 (для доступа к Интернету) не применяется. Переход к следующему правилу.
   1. Правило брандмауэра 9 (DNS) не применяется. Переход к следующему правилу.
   1. Применить правила брандмауэра 10 (внутри подсети). Трафик разрешается. Брандмауэр передает трафик на 10.0.1.4 (IIS01).
1. Интерфейсной подсети начинает обработку правила для входящего трафика:
   1. Правило 1 группы безопасности сети (блокирование доступа к Интернету) не применяется — переход к следующему правилу.
   1. Правила группы безопасности сети по умолчанию разрешает трафик между подсетями, поэтому трафик разрешается. Остановите обработку правил группы безопасности сети.
1. При условии, что надлежащую проверку подлинности и авторизации, IIS01 принимает запрос и отвечает.
1. Определяемый Пользователем маршрут в подсети frontend следующим прыжком задает брандмауэр.
1. Существует нет правил для исходящего трафика в подсети frontend, ответ пропускается.
1. Этот сеанс уже существует в брандмауэре, поэтому этот ответ разрешен. Брандмауэр возвращает ответ AppVM02.
1. Внутренней подсети выполняет обработку правил для входящего трафика:
    1. Правило группы безопасности сети (блокирование доступа к Интернету) 1 не применяется. Переход к следующему правилу.
    2. Правила группы безопасности сети по умолчанию разрешает трафик между подсетями, поэтому трафик разрешается. Остановите обработку правил группы безопасности сети.
1. AppVM02 получает ответ.

### <a name="denied-internet-direct-to-web-server"></a>(Запрещено) Интернет непосредственно к веб-сервера

1. Интернет-пользователь пытается получить доступ к веб-сервер IIS01 через службу FrontEnd001.CloudApp.Net.
1. Существует не открыты конечные точки для трафика HTTP, этот трафик не проходит через облачную службу. Трафик не достигает сервера.
1. Если для какой-либо причине открыты конечные точки, группы безопасности сети (блокирование доступа к Интернету) для интерфейсной подсети блокирует трафик.
1. И, наконец определяемый Пользователем маршрут подсети frontend отправляет весь исходящий трафик от IIS01 на брандмауэр, следующим прыжком. Брандмауэр воспринимает его как асимметричный трафик и удаляет исходящих ответов.

>Таким образом существует по крайней мере три независимых уровня защиты между Интернетом и IIS01. Облачная служба предотвращает несанкционированный и несоответствующий доступ.

### <a name="denied-internet-to-back-end-server"></a>(Запрещено) Из Интернета к серверу серверной части

1. Интернет-пользователь пытается получить доступ к файлу на AppVM01 через службу BackEnd001.CloudApp.Net.
2. Конечные точки не открыты для общего доступа к файлам, поэтому этот запрос не передан облачной службе. Трафик не достигает сервера.
3. Если для какой-либо причине открыты конечные точки, группы безопасности сети (блокирование доступа к Интернету) блокирует трафик.
4. Наконец определяемый Пользователем маршрут отправляет весь исходящий трафик от AppVM01 в брандмауэр, следующим прыжком. Брандмауэр воспринимает его как асимметричный трафик и удаляет исходящих ответов.

> Таким образом существует по крайней мере три независимых уровня защиты между Интернетом и AppVM01. Облачная служба предотвращает несанкционированный и несоответствующий доступ.

### <a name="denied-front-end-server-to-back-end-server"></a>(Запрещено) Сервера переднего плана для внутреннего сервера

1. IIS01 нарушена и выполняется вредоносный код, для проверки серверов внутренней подсети.
1. Определяемый Пользователем маршрут подсети frontend отправляет весь исходящий трафик от сервера IIS01 на брандмауэр следующим прыжком. Взломанная виртуальная машина не может изменить эту маршрутизацию.
1. Брандмауэр обрабатывает трафик. Если запрос к AppVM01 или DNS-сервер для уточняющих запросов DNS, брандмауэр может потенциально разрешать трафик из-за правил брандмауэра 7 и 9. Весь остальной трафик блокируется правилом брандмауэра (запрет любого) 11.
1. Трафик, который содержит известные подписи или шаблоны, вызывающие правило дополнительных угроз может быть запрещен, если включить расширенное обнаружение угроз в брандмауэре. Эта мера может работать, даже если трафик согласно правилам основные пересылки, которые рассматриваются в этой статье. Расширенное обнаружение угроз не рассматриваемые в данном документе. См. в документации поставщика своего сетевого устройства, в расширенных возможностях противостояния угрозам.

### <a name="denied-internet-dns-lookup-on-dns-server"></a>DNS-запрос из Интернета к серверу DNS (запрещено)

1. Интернет-пользователь пытается найти внутреннюю запись DNS на DNS01 через службу BackEnd001.CloudApp.Net.
1. Так как конечные точки не открыты для трафика DNS, этот трафик не проходит через облачную службу. Он не достигнет сервера.
1. Если для какой-то причине конечные точки открыты, правило группы безопасности сети (блокирование доступа к Интернету) в подсети frontend блокирует трафик.
1. И, наконец определяемый Пользователем маршрут в подсети серверной части отправляет весь исходящий трафик от DNS01 на брандмауэр, следующим прыжком. Брандмауэр воспринимает это как асимметричный трафик и удаляет исходящих ответов.

> Таким образом существует по крайней мере три независимых уровня защиты между Интернетом и DNS01. Облачная служба предотвращает несанкционированный и несоответствующий доступ.

#### <a name="denied-internet-to-sql-access-through-firewall"></a>(Запрещено) Интернет для доступа к SQL через брандмауэр

1. Интернет-пользователь запрашивает данные SQL из службы SecSvc001.CloudApp.Net Интернета облачной службы.
1. Существует не открыты конечные точки для SQL, этот трафик не передан облачной службе. Он не достигнет брандмауэра.
1. Если конечные точки SQL открыты по какой причине, брандмауэр выполняет обработку правил:
   1. Правила брандмауэра (FW Mgmt) 1 не применяется. Переход к следующему правилу.
   1. Правила брандмауэра 2-5 (правила RDP) не применяются. Переход к следующему правилу.
   1. Правила брандмауэра, 6 и 7 (правила приложения) не применяются. Переход к следующему правилу.
   1. Правило брандмауэра 8 (для доступа к Интернету) не применяется. Переход к следующему правилу.
   1. Правило брандмауэра 9 (DNS) не применяется. Переход к следующему правилу.
   1. Правило брандмауэра 10 (внутри подсети) не применяется. Переход к следующему правилу.
   1. Применить правила брандмауэра (запрет любого) 11. Трафик блокируется. Дальнейшая обработка правил прекращается.

## <a name="references"></a>Ссылки

Этот раздел содержит следующие элементы:

* Полный сценарий. Сохраните его в файл сценария PowerShell.
* Конфигурация сети. Сохраните его в файл с именем NetworkConf2.xml.

Измените пользовательские переменные в файлах, при необходимости. Запустите скрипт и затем выполните инструкции по настройке правил брандмауэра, перечисленных ранее в этой статье.

### <a name="full-script"></a>Полный сценарий

После настройки пользовательских переменных, выполните следующий сценарий, чтобы:

1. Подключение к подписке Azure
1. Создание новой учетной записи хранения
1. Создайте новую виртуальную сеть и три подсети, как определено в файле конфигурации сети
1. Построение пяти виртуальных машин: брандмауэр и четыре виртуальные машины Windows Server
1. Настройте определяемые пользователем Маршруты:
   1. Создайте два новых таблиц маршрутизации.
   1. Добавление маршрутов в таблицы.
   1. Привязка таблиц к соответствующим подсетям.
1. Включит IP-пересылку на виртуальном сетевом устройстве.
1. Настройка группы безопасности сети:
   1. Создать группу безопасности сети
   1. Добавление правила
   1. Привязать группу безопасности сети к соответствующим подсетям.

Выполните эту команду PowerShell скрипт локально на Интернета подключен ПК или сервер.

> [!IMPORTANT]
> При выполнении этого скрипта, предупреждения и другие информационные сообщения может всплывающее окно в PowerShell. Только сообщения, красный значок ошибки, причиной для беспокойства.

```powershell
    <#
     .SYNOPSIS
      Example of DMZ and User Defined Routing in an isolated network (Azure only, no hybrid connections)

     .DESCRIPTION
      This script will build out a sample DMZ setup containing:
       - A default storage account for VM disks
       - Three new cloud services
       - Three Subnets (SecNet, FrontEnd, and BackEnd subnets)
       - A Network Virtual Appliance (NVA), in this case a Barracuda NextGen Firewall
       - One server on the FrontEnd Subnet
       - Three Servers on the BackEnd Subnet
       - IP Forwarding from the FireWall out to the internet
       - User Defined Routing FrontEnd and BackEnd Subnets to the NVA

      Before running script, ensure the network configuration file is created in
      the directory referenced by $NetworkConfigFile variable (or update the
      variable to reflect the path and file name of the config file being used).

     .Notes
      Everyone's security requirements are different and can be addressed in a myriad of ways.
      Please be sure that any sensitive data or applications are behind the appropriate
      layer(s) of protection. This script serves as an example of some of the techniques
      that can be used, but should not be used for all scenarios. You are responsible to
      assess your security needs and the appropriate protections needed, and then effectively
      implement those protections.

      Security Service (SecNet subnet 10.0.0.0/24)
       myFirewall - 10.0.0.4

      FrontEnd Service (FrontEnd subnet 10.0.1.0/24)
       IIS01      - 10.0.1.4

      BackEnd Service (BackEnd subnet 10.0.2.0/24)
       DNS01      - 10.0.2.4
       AppVM01    - 10.0.2.5
       AppVM02    - 10.0.2.6

    #>

    # Fixed Variables
        $LocalAdminPwd = Read-Host -Prompt "Enter Local Admin Password to be used for all VMs"
        $VMName = @()
        $ServiceName = @()
        $VMFamily = @()
        $img = @()
        $size = @()
        $SubnetName = @()
        $VMIP = @()

    # User Defined Global Variables
      # These should be changes to reflect your subscription and services
      # Invalid options will fail in the validation section

      # Subscription Access Details
        $subID = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

      # VM Account, Location, and Storage Details
        $LocalAdmin = "theAdmin"
        $DeploymentLocation = "Central US"
        $StorageAccountName = "vmstore02"

      # Service Details
        $SecureService = "SecSvc001"
        $FrontEndService = "FrontEnd001"
        $BackEndService = "BackEnd001"

      # Network Details
        $VNetName = "CorpNetwork"
        $VNetPrefix = "10.0.0.0/16"
        $SecNet = "SecNet"
        $FESubnet = "FrontEnd"
        $FEPrefix = "10.0.1.0/24"
        $BESubnet = "BackEnd"
        $BEPrefix = "10.0.2.0/24"
        $NetworkConfigFile = "C:\Scripts\NetworkConf3.xml"

      # VM Base Disk Image Details
        $SrvImg = Get-AzureVMImage | Where {$_.ImageFamily -match 'Windows Server 2012 R2 Datacenter'} | sort PublishedDate -Descending | Select ImageName -First 1 | ForEach {$_.ImageName}
        $FWImg = Get-AzureVMImage | Where {$_.ImageFamily -match 'Barracuda NextGen Firewall'} | sort PublishedDate -Descending | Select ImageName -First 1 | ForEach {$_.ImageName}

      # UDR Details
        $FERouteTableName = "FrontEndSubnetRouteTable"
        $BERouteTableName = "BackEndSubnetRouteTable"

      # NSG Details
        $NSGName = "MyVNetSG"

    # User Defined VM Specific Config
        # Note: To ensure UDR and IP forwarding is setup
        # properly this script requires VM 0 be the NVA.

        # VM 0 - The Network Virtual Appliance (NVA)
          $VMName += "myFirewall"
          $ServiceName += $SecureService
          $VMFamily += "Firewall"
          $img += $FWImg
          $size += "Small"
          $SubnetName += $SecNet
          $VMIP += "10.0.0.4"

        # VM 1 - The Web Server
          $VMName += "IIS01"
          $ServiceName += $FrontEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $FESubnet
          $VMIP += "10.0.1.4"

        # VM 2 - The First Application Server
          $VMName += "AppVM01"
          $ServiceName += $BackEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $BESubnet
          $VMIP += "10.0.2.5"

        # VM 3 - The Second Application Server
          $VMName += "AppVM02"
          $ServiceName += $BackEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $BESubnet
          $VMIP += "10.0.2.6"

        # VM 4 - The DNS Server
          $VMName += "DNS01"
          $ServiceName += $BackEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $BESubnet
          $VMIP += "10.0.2.4"

    # ----------------------------- #
    # No User Defined Variables or   #
    # Configuration past this point #
    # ----------------------------- #

      # Get your Azure accounts
        Add-AzureAccount
        Set-AzureSubscription –SubscriptionId $subID -ErrorAction Stop
        Select-AzureSubscription -SubscriptionId $subID -Current -ErrorAction Stop

      # Create Storage Account
        If (Test-AzureName -Storage -Name $StorageAccountName) {
            Write-Host "Fatal Error: This storage account name is already in use, please pick a different name." -ForegroundColor Red
            Return}
        Else {Write-Host "Creating Storage Account" -ForegroundColor Cyan
              New-AzureStorageAccount -Location $DeploymentLocation -StorageAccountName $StorageAccountName}

      # Update Subscription Pointer to New Storage Account
        Write-Host "Updating Subscription Pointer to New Storage Account" -ForegroundColor Cyan 
        Set-AzureSubscription –SubscriptionId $subID -CurrentStorageAccountName $StorageAccountName -ErrorAction Stop

    # Validation
    $FatalError = $false

    If (-Not (Get-AzureLocation | Where {$_.DisplayName -eq $DeploymentLocation})) {
         Write-Host "This Azure Location was not found or available for use" -ForegroundColor Yellow
         $FatalError = $true}

    If (Test-AzureName -Service -Name $SecureService) { 
        Write-Host "The SecureService service name is already in use, please pick a different service name." -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "The FrontEndService service name is valid for use." -ForegroundColor Green}

    If (Test-AzureName -Service -Name $FrontEndService) { 
        Write-Host "The FrontEndService service name is already in use, please pick a different service name." -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "The FrontEndService service name is valid for use" -ForegroundColor Green}

    If (Test-AzureName -Service -Name $BackEndService) { 
        Write-Host "The BackEndService service name is already in use, please pick a different service name." -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "The BackEndService service name is valid for use." -ForegroundColor Green}

    If (-Not (Test-Path $NetworkConfigFile)) { 
        Write-Host 'The network config file was not found, please update the $NetworkConfigFile variable to point to the network config xml file.' -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "The network config file was found" -ForegroundColor Green
            If (-Not (Select-String -Pattern $DeploymentLocation -Path $NetworkConfigFile)) {
                Write-Host 'The deployment location was not found in the network config file, please check the network config file to ensure the $DeploymentLocation variable is correct and the network config file matches.' -ForegroundColor Yellow
                $FatalError = $true}
            Else { Write-Host "The deployment location was found in the network config file." -ForegroundColor Green}}

    If ($FatalError) {
        Write-Host "A fatal error has occurred, please see the above messages for more information." -ForegroundColor Red
        Return}
    Else { Write-Host "Validation passed, now building the environment." -ForegroundColor Green}

    # Create VNET
        Write-Host "Creating VNET" -ForegroundColor Cyan 
        Set-AzureVNetConfig -ConfigurationPath $NetworkConfigFile -ErrorAction Stop

    # Create Services
        Write-Host "Creating Services" -ForegroundColor Cyan
        New-AzureService -Location $DeploymentLocation -ServiceName $SecureService -ErrorAction Stop
        New-AzureService -Location $DeploymentLocation -ServiceName $FrontEndService -ErrorAction Stop
        New-AzureService -Location $DeploymentLocation -ServiceName $BackEndService -ErrorAction Stop

    # Build VMs
        $i=0
        $VMName | Foreach {
            Write-Host "Building $($VMName[$i])" -ForegroundColor Cyan
            If ($VMFamily[$i] -eq "Firewall") 
                { 
                New-AzureVMConfig -Name $VMName[$i] -ImageName $img[$i] –InstanceSize $size[$i] | `
                    Add-AzureProvisioningConfig -Linux -LinuxUser $LocalAdmin -Password $LocalAdminPwd  | `
                    Set-AzureSubnet  –SubnetNames $SubnetName[$i] | `
                    Set-AzureStaticVNetIP -IPAddress $VMIP[$i] | `
                    New-AzureVM –ServiceName $ServiceName[$i] -VNetName $VNetName -Location $DeploymentLocation
                # Set up all the EndPoints we'll need once we're up and running
                # Note: All traffic goes through the firewall, so we'll need to set up all ports here.
                #       Also, the firewall will be redirecting traffic to a new IP and Port in a forwarding
                #       rule, so all of these endpoint have the same public and local port and the firewall
                #       will do the mapping, NATing, and/or redirection as declared in the firewall rules.
                Add-AzureEndpoint -Name "MgmtPort1" -Protocol tcp -PublicPort 801  -LocalPort 801  -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "MgmtPort2" -Protocol tcp -PublicPort 807  -LocalPort 807  -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "HTTP"      -Protocol tcp -PublicPort 80   -LocalPort 80   -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPWeb"    -Protocol tcp -PublicPort 8014 -LocalPort 8014 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPApp1"   -Protocol tcp -PublicPort 8025 -LocalPort 8025 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPApp2"   -Protocol tcp -PublicPort 8026 -LocalPort 8026 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPDNS01"  -Protocol tcp -PublicPort 8024 -LocalPort 8024 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                # Note: A SSH endpoint is automatically created on port 22 when the appliance is created.
                }
            Else
                {
                New-AzureVMConfig -Name $VMName[$i] -ImageName $img[$i] –InstanceSize $size[$i] | `
                    Add-AzureProvisioningConfig -Windows -AdminUsername $LocalAdmin -Password $LocalAdminPwd  | `
                    Set-AzureSubnet  –SubnetNames $SubnetName[$i] | `
                    Set-AzureStaticVNetIP -IPAddress $VMIP[$i] | `
                    Set-AzureVMMicrosoftAntimalwareExtension -AntimalwareConfiguration '{"AntimalwareEnabled" : true}' | `
                    Remove-AzureEndpoint -Name "RemoteDesktop" | `
                    Remove-AzureEndpoint -Name "PowerShell" | `
                    New-AzureVM –ServiceName $ServiceName[$i] -VNetName $VNetName -Location $DeploymentLocation
                }
            $i++
        }

    # Configure UDR and IP Forwarding
        Write-Host "Configuring UDR" -ForegroundColor Cyan

      # Create the Route Tables
        Write-Host "Creating the Route Tables" -ForegroundColor Cyan 
        New-AzureRouteTable -Name $BERouteTableName `
            -Location $DeploymentLocation `
            -Label "Route table for $BESubnet subnet"
        New-AzureRouteTable -Name $FERouteTableName `
            -Location $DeploymentLocation `
            -Label "Route table for $FESubnet subnet"

      # Add Routes to Route Tables
        Write-Host "Adding Routes to the Route Tables" -ForegroundColor Cyan 
        Get-AzureRouteTable $BERouteTableName `
            |Set-AzureRoute -RouteName "All traffic to FW" -AddressPrefix 0.0.0.0/0 `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $BERouteTableName `
            |Set-AzureRoute -RouteName "Internal traffic to FW" -AddressPrefix $VNetPrefix `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $BERouteTableName `
            |Set-AzureRoute -RouteName "Allow Intra-Subnet Traffic" -AddressPrefix $BEPrefix `
            -NextHopType VNETLocal
        Get-AzureRouteTable $FERouteTableName `
            |Set-AzureRoute -RouteName "All traffic to FW" -AddressPrefix 0.0.0.0/0 `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $FERouteTableName `
            |Set-AzureRoute -RouteName "Internal traffic to FW" -AddressPrefix $VNetPrefix `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $FERouteTableName `
            |Set-AzureRoute -RouteName "Allow Intra-Subnet Traffic" -AddressPrefix $FEPrefix `
            -NextHopType VNETLocal

      # Associate the Route Tables with the Subnets
        Write-Host "Binding Route Tables to the Subnets" -ForegroundColor Cyan 
        Set-AzureSubnetRouteTable -VirtualNetworkName $VNetName `
            -SubnetName $BESubnet `
            -RouteTableName $BERouteTableName
        Set-AzureSubnetRouteTable -VirtualNetworkName $VNetName `
            -SubnetName $FESubnet `
            -RouteTableName $FERouteTableName

     # Enable IP Forwarding on the Virtual Appliance
        Get-AzureVM -Name $VMName[0] -ServiceName $ServiceName[0] `
            |Set-AzureIPForwarding -Enable

    # Configure NSG
        Write-Host "Configuring the Network Security Group (NSG)" -ForegroundColor Cyan

      # Build the NSG
        Write-Host "Building the NSG" -ForegroundColor Cyan
        New-AzureNetworkSecurityGroup -Name $NSGName -Location $DeploymentLocation -Label "Security group for $VNetName subnets in $DeploymentLocation"

      # Add NSG Rule
        Write-Host "Writing rules into the NSG" -ForegroundColor Cyan
        Get-AzureNetworkSecurityGroup -Name $NSGName | Set-AzureNetworkSecurityRule -Name "Isolate the $VNetName VNet from the Internet" -Type Inbound -Priority 100 -Action Deny `
            -SourceAddressPrefix INTERNET -SourcePortRange '*' `
            -DestinationAddressPrefix VIRTUAL_NETWORK -DestinationPortRange '*' `
            -Protocol *

      # Assign the NSG to two Subnets
        # The NSG is *not* bound to the Security Subnet. The result
        # is that internet traffic flows only to the Security subnet
        # since the NSG bound to the FrontEnd and BackEnd subnets
        # will Deny internet traffic to those subnets.
        Write-Host "Binding the NSG to two subnets" -ForegroundColor Cyan
        Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName -SubnetName $FESubnet -VirtualNetworkName $VNetName
        Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName -SubnetName $BESubnet -VirtualNetworkName $VNetName

    # Optional Post-script Manual Configuration
      # Configure Firewall
      # Install Test Web App (Run Post-Build Script on the IIS Server)
      # Install BackEnd resource (Run Post-Build Script on the AppVM01)
      Write-Host
      Write-Host "Build Complete!" -ForegroundColor Green
      Write-Host
      Write-Host "Optional Post-script Manual Configuration Steps" -ForegroundColor Gray
      Write-Host " - Configure Firewall" -ForegroundColor Gray
      Write-Host " - Install Test Web App (Run Post-Build Script on the IIS Server)" -ForegroundColor Gray
      Write-Host " - Install Backend resource (Run Post-Build Script on the AppVM01)" -ForegroundColor Gray
      Write-Host
```

### <a name="network-config-file"></a>Файл конфигурации сети

Сохраните этот файл XML расположение. Изменение `$NetworkConfigFile` переменной в полный сценарий выше для связи с файлом конфигурации сети, сохраненный.

```xml
    <NetworkConfiguration xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://schemas.microsoft.com/ServiceHosting/2011/07/NetworkConfiguration">
      <VirtualNetworkConfiguration>
        <Dns>
          <DnsServers>
            <DnsServer name="DNS01" IPAddress="10.0.2.4" />
            <DnsServer name="Level3" IPAddress="209.244.0.3" />
          </DnsServers>
        </Dns>
        <VirtualNetworkSites>
          <VirtualNetworkSite name="CorpNetwork" Location="Central US">
            <AddressSpace>
              <AddressPrefix>10.0.0.0/16</AddressPrefix>
            </AddressSpace>
            <Subnets>
              <Subnet name="SecNet">
                <AddressPrefix>10.0.0.0/24</AddressPrefix>
              </Subnet>
              <Subnet name="FrontEnd">
                <AddressPrefix>10.0.1.0/24</AddressPrefix>
              </Subnet>
              <Subnet name="BackEnd">
                <AddressPrefix>10.0.2.0/24</AddressPrefix>
              </Subnet>
            </Subnets>
            <DnsServersRef>
              <DnsServerRef name="DNS01" />
              <DnsServerRef name="Level3" />
            </DnsServersRef>
          </VirtualNetworkSite>
        </VirtualNetworkSites>
      </VirtualNetworkConfiguration>
    </NetworkConfiguration>
```

## <a name="next-steps"></a>Дальнейшие действия

Вы можете установить образец приложения для помощи в этом примере сети периметра.

> [!div class="nextstepaction"]
> [Скрипт примера приложения](./virtual-networks-sample-app.md)

<!--Image References-->
[1]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/example3design.png "Двунаправленная сеть периметра с виртуальным сетевым устройством, группой безопасности сети и определяемыми пользователем маршрутами"
[2]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/example3firewalllogical.png "Логическое представление правил брандмауэра"
[3]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectfrontend.png "Создание сетевого объекта FrontEnd"
[4]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectdns.png "Создание объекта DNS-сервера"
[5]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectrdpa.png "Копия правила RDP по умолчанию"
[6]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectrdpb.png "Правило AppVM01"
[7]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/iconapplicationredirect.png "Значок перенаправления приложения"
[8]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/icondestinationnat.png "Значок NAT назначения"
[9]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/iconpass.png "Значок передачи"
[10]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/rulefirewall.png "Правило управления брандмауэром"
[11]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/rulerdp.png "Правило RDP брандмауэра"
[12]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleweb.png "Правило Интернета брандмауэра"
[13]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleappvm01.png "Правило AppVM01 брандмауэра"
[14]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleoutbound.png "Правило исходящего трафика брандмауэра"
[15]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruledns.png "Правило DNS брандмауэра"
[16]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleintravnet.png "Правило брандмауэра для внутреннего трафика виртуальной сети"
[17]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruledeny.png "Правило запрета брандмауэра"
[18]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/firewallruleactivate.png "Активация правила брандмауэра"

<!--Link References-->
[HOME]: ../best-practices-network-security.md
