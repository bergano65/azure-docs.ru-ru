---
title: 'Подключение компьютера к виртуальной сети с помощью P2S: проверка подлинности на основе сертификата: портал Azure классический'
titleSuffix: Azure VPN Gateway
description: Создайте классическое подключение VPN-шлюза типа "точка — сеть" с помощью портал Azure.
services: vpn-gateway
author: cherylmc
ms.service: vpn-gateway
ms.topic: how-to
ms.date: 10/08/2020
ms.author: cherylmc
ms.openlocfilehash: 42b0945de55775f55f20cefdeb547cb5d6492c06
ms.sourcegitcommit: 8e7316bd4c4991de62ea485adca30065e5b86c67
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2020
ms.locfileid: "94657080"
---
# <a name="configure-a-point-to-site-connection-by-using-certificate-authentication-classic"></a>Настройка подключения типа "точка — сеть" с помощью проверки подлинности на основе сертификата (классическая модель)

[!INCLUDE [deployment models](../../includes/vpn-gateway-classic-deployment-model-include.md)]

В этой статье объясняется, как создать виртуальную сеть с подключением типа "точка — сеть". Эту виртуальную сеть можно создать с помощью классической модели развертывания, используя портал Azure. В этой конфигурации для аутентификации подключающегося клиента используются сертификаты — самозаверяющие или выпущенные ЦС. Эту конфигурацию можно также создать с помощью другого средства развертывания или модели, используя варианты, описанные в следующих статьях:

> [!div class="op_single_selector"]
> * [Портал Azure](vpn-gateway-howto-point-to-site-resource-manager-portal.md)
> * [PowerShell](vpn-gateway-howto-point-to-site-rm-ps.md)
> * [Портал Azure (классический)](vpn-gateway-howto-point-to-site-classic-azure-portal.md)
>

С помощью VPN-шлюза типа "точка — сеть" (P2S) создается безопасное подключение к виртуальной сети с отдельного клиентского компьютера. VPN-подключения типа "точка — сеть" (P2S) эффективны для подключения к виртуальной сети из удаленного расположения. Если у вас небольшое количество клиентов, которым требуется подключение к виртуальной сети, такая конфигурация эффективна для использования вместо VPN-подключения типа "сеть — сеть". VPN-подключение типа P2S сначала устанавливается с клиентского компьютера.

> [!IMPORTANT]
> Классическая модель развертывания поддерживает только клиенты VPN в Windows и использует Socket Tunneling Protocol (SSTP), протокол VPN на основе SSL. Чтобы обеспечить поддержку клиентов VPN не в Windows, виртуальную сеть следует создавать с использованием модели развертывания с помощью Resource Manager. Помимо SSTP, эта модель развертывания поддерживает VPN IKEv2. Дополнительные сведения см. в статье [Сведения о VPN-подключениях типа "точка — сеть"](point-to-site-about.md).
>
>

![Схема подключения типа "точка — сеть"](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/point-to-site-connection-diagram.png)

## <a name="settings-and-requirements"></a>Параметры и требования

### <a name="requirements"></a>Требования

Для подключений проверки подлинности сертификатов "точка — сеть" требуются следующие элементы. В этой статье описаны действия, которые помогут создать их.

* Динамический VPN-шлюз.
* Открытый ключ (CER-файл) для корневого сертификата, импортированный в Azure. Этот ключ считается доверенным сертификатом и используется для проверки подлинности.
* Сертификат клиента создается из корневого сертификата и устанавливается на каждом подключаемом клиентском компьютере. Этот сертификат используется для проверки подлинности клиента.
* Пакет конфигурации VPN-клиента необходимо создать и установить на каждом подключаемом клиентском компьютере. Пакет конфигурации клиента настраивает собственный VPN-клиент, находящийся в операционной системе, используя данные, необходимые для подключения к виртуальной сети.

Для подключения типа "точка — сеть" не требуется VPN-устройство или локальный общедоступный IP-адрес. Для создания VPN-подключения используется протокол SSTP (Secure Socket Tunneling Protocol). На стороне сервера поддерживается SSTP версии 1.0, 1.1 и 1.2. Какую версию использовать, решает клиент. Для Windows 8.1 и более поздних версий по умолчанию используется SSTP версии 1.2.

Дополнительные сведения см. в статье [о подключениях "точка — сеть](point-to-site-about.md) " и " [вопросы и ответы](#faq)".

### <a name="example-settings"></a>Примеры настроек

Используйте следующие значения для создания тестовой среды или для лучшего понимания примеров в этой статье:

* **Группа ресурсов:** TestRG
* **Имя виртуальной сети:** VNet1
* **Адресное пространство:** 192.168.0.0/16 <br>В этом примере мы используем только одно адресное пространство, но для виртуальной сети можно настроить несколько.
* **Имя подсети**: FrontEnd
* **Диапазон адресов подсети:** 192.168.1.0/24
* **GatewaySubnet:** 10.11.255.0/27
* **Регион**: Восточная часть США (США)
* **Адресное пространство клиента:** 172.16.201.0/24. <br> VPN-клиенты, подключающиеся к виртуальной сети с помощью этого подключения "точка — сеть", получают IP-адреса из указанного пула.
* **Тип подключения**: выберите **точка-сеть**.
* **Диапазон адресов GatewaySubnet (блок CIDR):** 192.168.200.0/24

Прежде чем начать, убедитесь в том, что у вас есть подписка Azure. Если у вас нет подписки Azure, вы можете [активировать преимущества для подписчиков MSDN](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details) или [зарегистрировать бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial).

## <a name="create-a-virtual-network"></a><a name="vnet"></a>Создание виртуальной сети

Если у вас уже есть виртуальная сеть, проверьте совместимость параметров со структурой VPN-шлюза. Обратите особое внимание на подсети, которые могут пересекаться с другими сетями.

[!INCLUDE [basic classic vnet](../../includes/vpn-gateway-vnet-classic.md)]

[!INCLUDE [basic classic DNS](../../includes/vpn-gateway-dns-classic.md)]

## <a name="create-a-vpn-gateway"></a><a name="gateway"></a>Создание VPN-шлюза

1. Перейдите к созданной виртуальной сети.
1. На странице Виртуальная сеть в разделе Параметры выберите **шлюз**. На странице **шлюз** можно просмотреть шлюз для виртуальной сети. У этой виртуальной сети еще нет шлюза. Щелкните Примечание. **щелкните здесь, чтобы добавить подключение и шлюз**.
1. На странице **Настройка VPN-подключения и шлюза** выберите следующие параметры.

   * Тип подключения: "точка — сеть"
   * Адресное пространство клиента: Добавьте диапазон IP-адресов, из которого VPN-клиенты получают IP-адрес при подключении. Используйте диапазон частных IP-адресов, который не пересекается с локальным расположением, из которого выполнено подключение, или с виртуальной сетью, к которой вы подключаетесь.
1. Не устанавливайте флажок не **настраивать шлюз в это время** . Будет создан шлюз.
1. В нижней части страницы нажмите кнопку **Далее: шлюз >**.
1. На вкладке **шлюз** выберите следующие значения:

   * **Размер:** Размер — номер SKU шлюза для шлюза виртуальной сети. На портале Azure SKU по умолчанию — **По умолчанию**. Дополнительные сведения о SKU шлюзов см. в разделе [сведения о параметрах VPN-шлюза](vpn-gateway-about-vpn-gateway-settings.md#gwsku).
   * **Тип маршрутизации:** Для конфигурации "точка — сеть" необходимо выбрать **динамический** . Статическая маршрутизация не будет работать.
   * **Подсеть шлюза:** Это поле уже заполнено автоматически. Изменить имя нельзя. Если вы попытаетесь изменить имя с помощью PowerShell или других средств, шлюз не будет работать должным образом.
   * **Диапазон адресов (блок CIDR):** Хотя можно создать подсеть шлюза размером/29, рекомендуется создать более крупную подсеть, включающую больше адресов, выбрав по меньшей мере/28 или/27. Таким образом, у вас будет достаточно адресов, чтобы добавить дополнительные конфигурации в будущем. При работе с подсетями шлюза не связывайте группу безопасности сети (NSG) с подсетью шлюза. Связывание группы безопасности сети с этой подсетью приведет к тому, что VPN-шлюз перестанет правильно функционировать.
1. Чтобы проверить параметры, выберите **Просмотр и создание**.
1. После завершения проверки выберите **создать**. Создание VPN-шлюза может занять до 45 минут в зависимости от выбранного номера SKU шлюза.

## <a name="create-certificates"></a><a name="generatecerts"></a>Создание сертификатов

В Azure сертификаты используются для проверки подлинности VPN-клиентов в VPN-подключениях типа "точка — сеть". Необходимо отправить сведения об открытом ключе корневого сертификата в Azure. Открытый ключ считается *доверенным*. Сертификаты клиентов должны создаваться из доверенного корневого сертификата, а затем устанавливаться на каждом клиентском компьютере в хранилище сертификатов Certificates-Current User\Personal\Certificates. Сертификат используется для проверки подлинности клиента, когда он подключается к виртуальной сети. 

Используемые самозаверяющие сертификаты должны быть созданы с помощью определенных параметров. Чтобы создать самозаверяющий сертификат, см. инструкции по [PowerShell и Windows 10](vpn-gateway-certificates-point-to-site.md) или [MakeCert](vpn-gateway-certificates-point-to-site-makecert.md). Следовать этим инструкциям очень важно при использовании самозаверяющих корневых сертификатов и создании на их основе клиентских сертификатов. В противном случае создаваемые сертификаты не будут совместимы с подключениями типа "точка — сеть", и вы получите сообщение об ошибке подключения.

### <a name="acquire-the-public-key-cer-for-the-root-certificate"></a>Получение открытого ключа CER-файла для корневого сертификата

[!INCLUDE [vpn-gateway-basic-vnet-rm-portal](../../includes/vpn-gateway-p2s-rootcert-include.md)]

### <a name="generate-a-client-certificate"></a>Создание сертификата клиента

[!INCLUDE [vpn-gateway-basic-vnet-rm-portal](../../includes/vpn-gateway-p2s-clientcert-include.md)]

## <a name="upload-the-root-certificate-cer-file"></a>Отправка CER-файла корневого сертификата

После создания шлюза отправьте CER-файл (который содержит сведения об открытом ключе) доверенного корневого сертификата на сервер Azure. Не отправляйте закрытый ключ для корневого сертификата. После отправки CER-файла Azure будет использовать его для проверки подлинности клиентов, на которых установлен клиентский сертификат, созданный из доверенного корневого сертификата. При необходимости позже можно отправить дополнительные файлы доверенных корневых сертификатов (до 20).

1. Перейдите к созданной виртуальной сети.
1. В разделе **Параметры** выберите **подключения "точка — сеть**".
1. Выберите **Управление сертификатом**.
1. Щелкните **Отправить**.
1. На панели **отправить сертификат** выберите значок папки и перейдите к сертификату, который нужно отправить.
1. Щелкните **Отправить**.
1. После успешной отправки сертификата его можно просмотреть на странице Управление сертификатами. Возможно, потребуется нажать кнопку **Обновить** , чтобы просмотреть только что отправленный сертификат.

## <a name="configure-the-client"></a>Настройка клиента

Для подключения к виртуальной сети с помощью VPN-подключения типа "точка — сеть" для каждого клиента необходимо установить пакет конфигурации для собственного VPN-клиента Windows. Пакет конфигурации настраивает собственный VPN-клиент Windows с необходимыми параметрами для подключения к виртуальной сети.

На каждом клиентском компьютере можно использовать один и тот же пакет конфигурации VPN-клиента при условии, что его версия соответствует архитектуре клиента. Список поддерживаемых клиентских операционных систем см. в статье [о подключениях типа "точка — сеть](point-to-site-about.md) " и [часто задаваемых вопросах](#faq).

### <a name="generate-and-install-a-vpn-client-configuration-package"></a>Создание и установка пакета конфигурации VPN-клиента

1. Перейдите к параметрам **подключения "точка — сеть** " для виртуальной сети.
1. В верхней части страницы выберите загружаемый пакет, соответствующий клиентской операционной системе, в которой будет установлено приложение:

   * Для 64-разрядных клиентов выберите **VPN-клиент (64-бит)**.
   * Для 32-разрядных клиентов выберите **VPN-клиент (32-бит)**.

1. Azure создает пакет с конкретными параметрами, которые требуются клиенту. Каждый раз при внесении изменений в виртуальную сеть или шлюз необходимо скачать новый пакет конфигурации клиента и установить их на клиентских компьютерах.
1. После создания пакета выберите **скачать**.
1. Установите пакет конфигурации клиента на клиентском компьютере. Если при установке отображается всплывающее окно SmartScreen с сообщением о том, что Windows защищен ваш компьютер, выберите **Дополнительные сведения**, а затем выберите **выполнить все равно**. Вы также можете сохранить пакет для установки на других клиентских компьютерах.

### <a name="install-a-client-certificate"></a>Установка сертификата клиента

В этом упражнении при создании сертификата клиента он был автоматически установлен на компьютере. Чтобы создать подключение P2S с другого клиентского компьютера, отличного от того, который использовался для создания сертификатов клиента, необходимо установить на этом компьютере созданный сертификат клиента.

При установке сертификата клиента потребуется пароль, созданный при экспорте сертификата клиента. Как правило, можно установить сертификат, просто дважды щелкнув его. Дополнительные сведения см. в разделе [Установка экспортированного сертификата клиента](vpn-gateway-certificates-point-to-site.md#install).

## <a name="connect-to-your-vnet"></a>Подключение к виртуальной сети

>[!NOTE]
>Вам потребуются права администратора для клиентского компьютера, с которого устанавливается подключение.
>

1. На клиентском компьютере перейдите в раздел Параметры VPN.
1. Выберите созданную VPN. Если вы использовали параметры примера, подключение будет помечено как **Group TestRG VNet1**.
1. Выберите **Подключиться**.
1. В поле виртуальная сеть Windows Azure выберите **подключить**. Если появится всплывающее сообщение о сертификате, выберите **продолжить** использовать повышенные привилегии и **Да** , чтобы принять изменения конфигурации.
1. Когда подключение будет выполнено, вы увидите **подключенное** уведомление.

[!INCLUDE [verify-client-certificates](../../includes/vpn-gateway-certificates-verify-client-cert-include.md)]

## <a name="verify-the-vpn-connection"></a>Проверка VPN-подключения

1. Убедитесь, что вы используете активное VPN-подключение. Откройте командную строку с повышенными привилегиями на клиентском компьютере и выполните **ipconfig/all**.
1. Просмотрите результаты. Обратите внимание, что полученный вами IP-адрес — это один из адресов в адресном пространстве подключения типа "точка — сеть", которое вы указали при создании виртуальной сети. Результаты должны выглядеть приблизительно как в приведенном примере.

   ```
    PPP adapter VNet1:
        Connection-specific DNS Suffix .:
        Description.....................: VNet1
        Physical Address................:
        DHCP Enabled....................: No
        Autoconfiguration Enabled.......: Yes
        IPv4 Address....................: 192.168.130.2(Preferred)
        Subnet Mask.....................: 255.255.255.255
        Default Gateway.................:
        NetBIOS over Tcpip..............: Enabled
   ```

## <a name="to-connect-to-a-virtual-machine"></a>Подключение к виртуальной машине

[!INCLUDE [Connect to a VM](../../includes/vpn-gateway-connect-vm-p2s-classic-include.md)]

## <a name="to-add-or-remove-trusted-root-certificates"></a>Добавление и удаление доверенного корневого сертификата

Вы можете добавлять доверенные корневые сертификаты в Azure, а также удалять их из Azure. При удалении корневого сертификата клиенты, использующие сертификат, созданный из этого корневого сертификата, больше не смогут пройти проверку подлинности и подключиться. Чтобы эти клиенты снова могли проходить проверку подлинности и подключаться, необходимо установить новый сертификат клиента, созданный на основе корневого сертификата, который является доверенным для Azure.

### <a name="add-a-trusted-root-certificate"></a>Добавление доверенного корневого сертификата

Вы можете добавить до 20 файлов доверенных корневых сертификатов. cer в Azure с помощью того же процесса, который использовался для добавления первого доверенного корневого сертификата.

### <a name="remove-a-trusted-root-certificate"></a>Удаление доверенного корневого сертификата

1. В разделе **подключения типа "точка — сеть** " страницы для виртуальной сети выберите **Управление сертификатом**.
1. Нажмите кнопку с многоточием рядом с сертификатом, который необходимо удалить, а затем выберите **Удалить**.

## <a name="to-revoke-a-client-certificate"></a>Отзыв сертификата клиента

При необходимости можно отозвать сертификат клиента. Список отзыва сертификатов позволяет выборочно запрещать подключение типа "точка-сеть" на основе отдельных сертификатов клиента. Этот метод отличается от удаления доверенного корневого сертификата. При удалении доверенного корневого сертификата (CER-файл) из Azure будет запрещен доступ для всех сертификатов клиента, созданных на основе отозванного корневого сертификата или подписанных им. Отзыв сертификата клиента, а не корневого сертификата, позволяет по-прежнему использовать другие сертификаты, созданные на основе корневого сертификата, для проверки подлинности подключения типа "точка — сеть".

Обычно корневой сертификат используется для управления доступом на уровнях группы или организации, а отозванный сертификат клиента — для точного контроля доступа для отдельных пользователей.

Вы можете отозвать сертификат клиента, добавив отпечаток в список отзыва.

1. Получите отпечаток сертификата клиента. Дополнительные сведения см. в статье [Практическое руководство. Извлечение отпечатка сертификата](/dotnet/framework/wcf/feature-details/how-to-retrieve-the-thumbprint-of-a-certificate).
1. Скопируйте данные в текстовый редактор и удалите все пробелы, чтобы предоставить отпечаток в виде непрерывной строки.
1. Перейдите к **VPN-подключению "точка — сеть**", а затем выберите **Управление сертификатом**.
1. Выберите **Список отзыва**, чтобы открыть страницу **Список отзыва**.
1. На странице **Отпечаток** вставьте отпечаток сертификата в виде одной непрерывной текстовой строки без пробелов.
1. Выберите **+ Добавить в список** , чтобы добавить отпечаток в список отзыва сертификатов (CRL).

После применения изменений сертификат больше не будет использоваться для подключения. Клиенты, пытающиеся подключиться с помощью этого сертификата, получат сообщение, что он недействителен.

## <a name="faq"></a><a name="faq"></a>Часто задаваемые вопросы

[!INCLUDE [Point-to-Site FAQ](../../includes/vpn-gateway-faq-point-to-site-classic-include.md)]

## <a name="next-steps"></a>Дальнейшие действия

* Установив подключение, можно добавить виртуальные машины в виртуальные сети. Дополнительные сведения о виртуальных машинах см. [здесь](../index.yml).

* Дополнительные сведения о сетях и виртуальных машинах см. в статье [Виртуальные сети и виртуальные машины в Azure](../virtual-machines/network-overview.md).

* Дополнительные сведения см. в руководстве по [устранению неполадок с подключением "точка — сеть" в Azure](vpn-gateway-troubleshoot-vpn-point-to-site-connection-problems.md).