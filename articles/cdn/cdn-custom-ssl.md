---
title: Руководство по Настройка протокола HTTPS для личного домена в Azure CDN
description: Из этого руководства вы узнаете, как включить и отключить протокол HTTPS для конечной точки Azure CDN, сопоставленной с личным доменом.
services: cdn
author: asudbring
ms.service: azure-cdn
ms.topic: tutorial
ms.date: 01/27/2021
ms.author: allensu
ms.custom: mvc
ms.openlocfilehash: c4ad270b989e0e212c1d362ae4bfafc91fe07f3e
ms.sourcegitcommit: 2f9f306fa5224595fa5f8ec6af498a0df4de08a8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/28/2021
ms.locfileid: "98943531"
---
# <a name="tutorial-configure-https-on-an-azure-cdn-custom-domain"></a>Руководство по Настройка протокола HTTPS для личного домена в Azure CDN

В этом руководстве показано, как включить протокол HTTPS для личного домена, связанного с конечной точкой в сети доставки содержимого (CDN) Azure. 

Протокол HTTPS в личном домене (например, https:\//www.contoso.com) гарантирует безопасную доставку конфиденциальных данных по протоколу TLS/SSL. Если веб-браузер подключается через HTTPS, он проверяет сертификат веб-сайта. А именно, выдан ли он авторизованным центром сертификации. Этот процесс обеспечивает безопасность и защиту веб-приложений от атак.

Azure CDN по умолчанию поддерживает HTTPS в имени узла конечной точки CDN. К примеру, при создании конечной точки CDN (скажем, https:\//contoso.azureedge.net) протокол HTTPS включен по умолчанию.  

Ниже приведены некоторые ключевые характеристики настраиваемой функции HTTPS:

- Отсутствие дополнительных затрат — вам не придется оплачивать приобретение или продление сертификата либо передачу трафика по HTTPS. Вы платите только за исходящий трафик из CDN.

- Простое включение: на [портале Azure](https://portal.azure.com) доступна подготовка одним щелчком. Для включения этого компонента можно также использовать REST API или другие средства разработки.

- Доступно полноценное управление сертификатами: 
    * закупка всех сертификатов и управление ими осуществляется без вашего участия. 
    * Сертификаты автоматически подготавливаются и продлеваются до истечения их срока действия.

В этом руководстве описано следующее:
> [!div class="checklist"]
> - включение протокола HTTPS в личном домене;
> - использование сертификата, управляемого CDN; 
> - использование собственного сертификата;
> - проверка домена;
> - отключение протокола HTTPS в личном домене.

## <a name="prerequisites"></a>Предварительные требования

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)] 

Прежде чем перейти к выполнению шагов из этого учебника, создайте профиль и как минимум одну конечную точку CDN. Дополнительные сведения см. в [кратком руководстве по созданию профиля и конечной точки Azure CDN](cdn-create-new-endpoint.md).

Свяжите личный домен Azure CDN с конечной точкой CDN. Дополнительные сведения см. в статье [Учебник. Добавление личного домена к конечной точке CDN Azure](cdn-map-content-to-custom-domain.md).

> [!IMPORTANT]
> Управляемые сертификаты CDN недоступны для корневых или вершинных доменов. Если личный домен Azure CDN является корневым или вершинным, необходимо использовать возможность применения собственного сертификата. 
>

---

## <a name="tlsssl-certificates"></a>TLS/SSL-сертификаты

Чтобы включить протокол HTTPS в личном домене Azure CDN, используйте TLS/SSL-сертификат. Вы можете использовать сертификат под управлением Azure CDN или собственный сертификат.

# <a name="option-1-default-enable-https-with-a-cdn-managed-certificate"></a>[Вариант 1 (по умолчанию). Включение HTTPS с помощью сертификата под управлением CDN](#tab/option-1-default-enable-https-with-a-cdn-managed-certificate)

Azure CDN управляет задачами управления сертификатами, такими как приобретение и продление. Как только функция будет включена, процесс сразу же запустится. 

Если личный домен уже сопоставлен с конечной точкой CDN, дальнейших действий не требуется. Azure CDN предпримет нужные действия и автоматически выполнит запрос.

Если личный домен сопоставлен в другом месте, используйте электронную почту, чтобы подтвердить принадлежность домена.

Ниже описана процедура включения протокола HTTPS для личного домена.

1. Перейдите на [портал Azure](https://portal.azure.com) и найдите сертификат, управляемый Azure CDN. Выполните поиск по запросу **Профили CDN** и выберите этот пункт. 

2. Выберите свой профиль:
    * **Azure CDN уровня "Стандартный" от Майкрософт**;
    * **Azure CDN уровня "Стандартный" от Akamai**;
    * **Azure CDN уровня "Стандартный" от Verizon**;
    * **Azure CDN уровня "Премиум" от Verizon**

3. В списке конечных точек CDN выберите ту из них, которая содержит личный домен.

    ![Список конечных точек](./media/cdn-custom-ssl/cdn-select-custom-domain-endpoint.png)

    Откроется страница **Конечная точка**.

4. В списке личных доменов выберите домен, для которого нужно включить протокол HTTPS.

    ![Снимок экрана: страница "Личный домен" с параметром "Использовать собственный сертификат"](./media/cdn-custom-ssl/cdn-custom-domain.png)

    Откроется страница **Личный домен**.

5. В разделе с типом управления сертификатом выберите **Управляемые CDN**.

6. Выберите **Вкл.** , чтобы включить HTTPS.

    ![Состояние HTTPS для личного домена](./media/cdn-custom-ssl/cdn-select-cdn-managed-certificate.png)

7. Выберите [Подтвердить домен](#validate-the-domain).


# <a name="option-2-enable-https-with-your-own-certificate"></a>[Вариант 2. Включение HTTPS с помощью собственного сертификата](#tab/option-2-enable-https-with-your-own-certificate)

> [!IMPORTANT]
> Эта возможность доступна только в профилях **Azure CDN от Майкрософт** и **Verizon**. 
>
 
Для включения функции HTTPS можно использовать собственный сертификат. Этот процесс выполняется путем интеграции с Azure Key Vault, что позволяет безопасно хранить сертификаты. Azure CDN использует этот механизм безопасности, чтобы получить сертификат. При этом вам потребуется выполнить ряд дополнительных действий. TLS/SSL-сертификат необходимо создать в разрешенном центре сертификации. В противном случае при использовании недопустимого ЦС, ваш запрос, будет отклонен. Список разрешенных ЦС см. в разделе [Разрешенные центры сертификации для включения настраиваемого HTTPS в сети доставки содержимого (CDN) Azure](cdn-troubleshoot-allowed-ca.md). Для **Azure CDN от Verizon** принимается любой допустимый ЦС. 

### <a name="prepare-your-azure-key-vault-account-and-certificate"></a>Подготовка учетной записи Azure Key Vault и сертификата
 
1. Azure Key Vault. Вам требуется активная учетная запись Azure Key Vault в той же подписке, что и профиль Azure CDN и конечные точки CDN, для которых нужно включить настраиваемый HTTPS. Если у вас ее еще нет, создайте учетную запись Azure Key Vault.
 
2. Сертификаты Azure Key Vault. Если у вас есть сертификат, отправьте его непосредственно в учетную запись Azure Key Vault. Если у вас нет сертификата, создайте сертификат напрямую через Azure Key Vault.

### <a name="register-azure-cdn"></a>Регистрация Azure CDN

Зарегистрируйте Azure CDN как приложение в Azure Active Directory с помощью PowerShell.

1. При необходимости установите [Azure PowerShell](/powershell/azure/install-az-ps) на локальном компьютере.

2. Выполните следующую команду в PowerShell:

     `New-AzADServicePrincipal -ApplicationId "205478c0-bd83-4e1b-a9d6-db63a3e1e1c8"`
    > [!NOTE]
    > **205478c0-bd83-4e1b-a9d6-db63a3e1e1c8** — это субъект-служба для **Microsoft.AzureFrontDoor-Cdn**.

    ```bash  
    New-AzADServicePrincipal -ApplicationId "205478c0-bd83-4e1b-a9d6-db63a3e1e1c8"

    Secret                : 
    ServicePrincipalNames : {205478c0-bd83-4e1b-a9d6-db63a3e1e1c8, 
                                https://microsoft.onmicrosoft.com/033ce1c9-f832-4658-b024-ef1cbea108b8}
    ApplicationId         : 205478c0-bd83-4e1b-a9d6-db63a3e1e1c8
    ObjectType            : ServicePrincipal
    DisplayName           : Microsoft.AzureFrontDoor-Cdn
    Id                    : c87be08f-686a-4d9f-8ef8-64707dbd413e
    Type                  :
    ```
### <a name="grant-azure-cdn-access-to-your-key-vault"></a>Предоставление Azure CDN доступа к хранилищу ключей
 
Предоставьте Azure CDN разрешение на доступ к сертификатам (секретам) в учетной записи Azure Key Vault.

1. В хранилище ключей в разделе **Параметры** выберите **Политики доступа**. В правой области щелкните **+ Добавить политику доступа**:

    :::image type="content" source="./media/cdn-custom-ssl/cdn-new-access-policy.png" alt-text="Создание политики доступа к хранилищу ключей для CDN" border="true":::

2. На странице **Добавление политики доступа** выберите **Нет выбранных** рядом с полем **Выбрать субъект**. На странице **Субъект** введите **205478c0-bd83-4e1b-a9d6-db63a3e1e1c8**. Выберите **Microsoft.AzureFrontdoor-Cdn**.  Щелкните **Выбрать**:

2. На странице **Выбор субъекта** найдите строку **205478c0-bd83-4e1b-a9d6-db63a3e1e1c8** и выберите **Microsoft.AzureFrontDoor-Cdn**. Щелкните **Выбрать**.

    :::image type="content" source="./media/cdn-custom-ssl/cdn-access-policy-settings.png" alt-text="Выбор субъекта-службы Azure CDN" border="true":::
    
3. Выберите **Разрешения сертификата**. Установите флажки **Получить** и **Вывод**, чтобы разрешить CDN использовать разрешения на получение и вывод списка сертификатов.

4. Выберите **Разрешения секрета**. Установите флажки **Получить** и **Вывод**, чтобы разрешить CDN использовать разрешения на получение и вывод списка секретов:

    :::image type="content" source="./media/cdn-custom-ssl/cdn-vault-permissions.png" alt-text="Выбор разрешений CDN для хранилища ключей" border="true":::

5. Выберите **Добавить**. 

    Теперь у Azure CDN будет доступ к этому хранилищу ключей и сертификатам (секретам), которые в нем хранятся.
 
### <a name="select-the-certificate-for-azure-cdn-to-deploy"></a>Выбор сертификата для развертывания в Azure CDN
 
1. Вернитесь на портал Azure CDN и выберите профиль и конечную точку CDN, где необходимо включить настраиваемый HTTPS. 

2. В списке личных доменов выберите домен, для которого нужно включить протокол HTTPS.

    Откроется страница **Личный домен**.

3. В разделе с типом управления сертификатом выберите **Использовать собственный сертификат**. 

    ![Настройка сертификата](./media/cdn-custom-ssl/cdn-configure-your-certificate.png)

4. Выберите хранилище ключей, сертификат (секрет) и версию сертификата.

    Azure CDN выведет следующие сведения: 
    - учетные записи хранилища ключей для идентификатора подписки; 
    - сертификаты (секреты) в выбранном хранилище ключей; 
    - доступные версии сертификатов. 
 
5. Выберите **Вкл.** , чтобы включить HTTPS.
  
6. При использовании собственного сертификата подтверждение домена не является обязательным. Перейдите к разделу [Ожидание распространения](#wait-for-propagation).

---

## <a name="validate-the-domain"></a>проверка домена;

Если вы используете личный домен, сопоставленный с пользовательской конечной точкой с помощью записи CNAME, или используете собственный сертификат, перейдите к разделу [Личный домен, сопоставленный с конечной точкой CDN](#custom-domain-is-mapped-to-your-cdn-endpoint-by-a-cname-record). 

Если же запись CNAME для конечной точки больше не существует или содержит поддомен cdnverify, перейдите к разделу [Личный домен не сопоставлен с конечной точкой CDN](#custom-domain-isnt-mapped-to-your-cdn-endpoint).

### <a name="custom-domain-is-mapped-to-your-cdn-endpoint-by-a-cname-record"></a>Пользовательский домен сопоставлен с конечной точкой CDN с помощью записи CNAME

Добавив личный домен для конечной точки, вы создали в таблице DNS вашего регистратора домена запись CNAME, которая сопоставляет домен с именем узла конечной точки CDN. 

Если запись CNAME еще существует и не содержит поддомен cdnverify, центр сертификации DigiCert использует ее для автоматического подтверждения прав владения доменом. 

При использовании собственного сертификата подтверждение домена не является обязательным.

Запись CNAME должна иметь следующий формат:

* *Name* — имя личного домена.
* *Value* — имя узла конечной точки CDN.

| Название            | Тип  | Значение                 |
|-----------------|-------|-----------------------|
| <www.contoso.com> | CNAME | contoso.azureedge.net |

Дополнительные сведения о записи CNAME см. в разделе [о создании записи CNAME в DNS](./cdn-map-content-to-custom-domain.md).

Если запись CNAME имеет правильный формат, DigiCert автоматически подтвердит имя личного домена и создаст сертификат для вашего домена. DigitCert не будет отправлять писем для подтверждения и вам не нужно подтверждать этот запрос. Сертификат будет действителен в течение одного года, а перед истечением срока действия — автоматически продлеваться. Перейдите к разделу [Ожидание распространения](#wait-for-propagation). 

Автоматическая проверка обычно занимает несколько часов. Если после проверки домен не отображается в течение 24 часов, отправьте запрос в службу поддержки.

>[!NOTE]
>Если у поставщика DNS имеется запись авторизации центра сертификации, то она должна включать DigiCert как допустимый ЦС. Запись авторизации ЦС позволяет владельцам доменов указывать своим поставщикам DNS, какие ЦС уполномочены выдавать сертификаты безопасности для их домена. Если ЦС получает заказ на сертификат для домена, который имеет запись авторизации ЦС, и этот ЦС не указан как уполномоченный издатель, тогда этому домену или поддомену запрещается выдавать сертификат безопасности. Сведения об управлении записями авторизации ЦС см. в [этой статье](https://support.dnsimple.com/articles/manage-caa-record/). Средство для работы с записями авторизации ЦС доступно [здесь](https://sslmate.com/caa/).

### <a name="custom-domain-isnt-mapped-to-your-cdn-endpoint"></a>Личный домен не сопоставлен с конечной точкой CDN

>[!NOTE]
>Если вы используете **Azure CDN от Akamai**, необходимо настроить следующую запись CNAME для включения автоматической проверки домена. "_acme-challenge.&lt;имя узла личного домена&gt; -> CNAME -> &lt;имя узла личного домена&gt;.ak-acme-challenge.azureedge.net"

Если запись CNAME содержит поддомен cdnverify, следуйте остальным инструкциям в этом шаге.

DigiCert отправляет письмо для подтверждения на следующие адреса электронной почты. Убедитесь, что возможно утверждение непосредственно с одного из таких адресов:

* **admin@your-domain-name.com** 
* **administrator@your-domain-name.com** 
* **webmaster@your-domain-name.com** 
* **hostmaster@your-domain-name.com**  
* **postmaster@your-domain-name.com**  

Через несколько минут должно появиться электронное сообщение с просьбой подтвердить запрос. При использовании фильтра нежелательной почты добавьте verification@digicert.com в список разрешений. Если вы не получите электронное сообщение в течение 24 часов, обратитесь в службу поддержки Майкрософт.
    
![Письмо для подтверждения заказа на сертификат](./media/cdn-custom-ssl/domain-validation-email.png)

При щелчке ссылки для подтверждения запроса откроется следующая онлайн-форма: 
    
![Форма подтверждения для домена](./media/cdn-custom-ssl/domain-validation-form.png)

Следуйте инструкциям в форме. Есть два варианта проверки:

- Можно утвердить все будущие заказы, оформленные с использованием одной и той же учетной записи для одного корневого домена, например contoso.com. Этот подход рекомендуется, если вы планируете добавлять дополнительные личные домены для одного корневого домена.

- Можно просто утвердить конкретное имя узла, которое используется в данном запросе. Для последующих запросов потребуется дополнительное утверждение.

После утверждения DigiCert завершает создание сертификата для имени личного домена. Сертификат будет действителен в течение одного года, а перед истечением срока действия — автоматически продлеваться.

## <a name="wait-for-propagation"></a>Ожидание распространения

Активация компонента HTTPS для личного домена после проверки доменного имени может занять до 6–8 часов. По завершении процесса для состояния пользовательского HTTPS на портале Azure будет установлено значение **Включено**. Четыре шага операции в диалоговом окне личного домена будут помечены как завершенные. Личный домен готов для использования протокола HTTPS.

![Диалоговое окно "Включить HTTPS"](./media/cdn-custom-ssl/cdn-enable-custom-ssl-complete.png)

### <a name="operation-progress"></a>Ход выполнения операции

В следующей таблице показан ход операции, возникающей при включении HTTPS. После включения HTTPS в диалоговом окне личного домена отобразятся четыре шага операции. По мере активации этих шагов в них появляются другие вложенные шаги со сведениями о ходе выполнения. Не все из вложенных шагов будут выполняться. После успешного завершения шага рядом с ним появится зеленый флажок. 

| Шаг операции | Сведения о вложенном шаге операции | 
| --- | --- |
| 1\. Отправка запроса | Отправка запроса |
| | Отправляется HTTP-запрос. |
| | HTTPS-запрос успешно отправлен. |
| 2\. Проверка домена | Домен автоматически подтверждается, если он сопоставлен с конечной точкой CDN с помощью записи CNAME. В противном случае запрос на проверку будет отправляться на адрес электронной почты, указанный в записи регистрации вашего домена (регистрант WHOIS).|
| | Владение доменом успешно подтверждено. |
| | Истек срок действия запроса на подтверждение прав владения доменом (клиент, скорее всего, не ответил в течение 6 дней). HTTPS не будет включен в вашем домене. * |
| | Клиент отклонил запрос на подтверждение прав собственности на домен. HTTPS не будет включен в вашем домене. * |
| 3\. Подготовка сертификата | В настоящее время центр сертификации выдает сертификат, необходимый для включения HTTPS в вашем домене. |
| | Сертификат был выдан и в настоящее время развертывается в сеть доставки содержимого. Это может занять до 6 часов. |
| | Сертификат успешно развернут в сети доставки содержимого. |
| 4\. Завершение | HTTPS успешно включен для вашего домена. |

\* Это сообщение отображается, только если произошла ошибка. 

Если перед отправкой запроса возникает ошибка, появится следующее сообщение об ошибке:

<code>
We encountered an unexpected error while processing your HTTPS request. Please try again and contact support if the issue persists.
</code>



## <a name="clean-up-resources---disable-https"></a>Очистка ресурсов и отключение HTTPS

Из этого раздела вы узнаете, как отключить протокол HTTPS для личного домена.

### <a name="disable-the-https-feature"></a>Отключение компонента HTTPS 

1. Войдите на [портал Azure](https://portal.azure.com). Выполните поиск по запросу **Профили CDN** и выберите этот пункт. 

2. Выберите профиль **Azure CDN уровня "Стандартный" от Майкрософт**, **Azure CDN уровня "Стандартный" от Verizon** или **Azure CDN уровня "Премиум" от Verizon**.

3. В списке конечных точек выберите ту из них, которая содержит личный домен.

4. Щелкните личный домен, для которого требуется отключить HTTPS.

    ![Список личных доменов](./media/cdn-custom-ssl/cdn-custom-domain-HTTPS-enabled.png)

5. Щелкните **Выкл.** , чтобы отключить HTTPS, а затем нажмите кнопку **Применить**.

    ![Диалоговое окно "Настраиваемый HTTPS"](./media/cdn-custom-ssl/cdn-disable-custom-ssl.png)

### <a name="wait-for-propagation"></a>Ожидание распространения

После отключения компонента HTTPS личного домена для вступления изменений в силу может потребоваться до 6–8 часов. По завершении процесса для состояния пользовательского HTTPS на портале Azure будет установлено значение **Отключено**. Три шага операции в диалоговом окне личного домена помечены как завершенные. Личный домен больше не сможет использовать HTTPS.

![Диалоговое окно "Отключить HTTPS"](./media/cdn-custom-ssl/cdn-disable-custom-ssl-complete.png)

#### <a name="operation-progress"></a>Ход выполнения операции

В следующей таблице показан ход операции, возникающей при отключении HTTPS. После отключения HTTPS в диалоговом окне личного домена отобразятся три шага. По мере того, как каждый шаг становится активным, под ним появляются сведения. После успешного завершения шага рядом с ним появится зеленый флажок. 

| Ход выполнения операции | Сведения об операции | 
| --- | --- |
| 1\. Отправка запроса | Отправка запроса |
| 2\. Отзыв сертификата | Удаление сертификата |
| 3\. Завершение | Сертификат удален |

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

1. *Кто является поставщиком сертификата и какой тип сертификата используется?*

    Для личного домена используется выделенный сертификат, предоставленный Digicert:
    
    * **Azure CDN от Verizon**
    * **Azure CDN от Майкрософт**

2. *Какое подключение TLS/SSL используется: на основе IP-адреса или SNI?*

    Для **Azure CDN от Verizon** и **Azure CDN уровня "Стандартный" от Майкрософт** используется подключение TLS/SSL на основе SNI.

3. *Что делать, если я не получу сообщение электронной почты для проверки домена от DigiCert?*

    Если вы не используете поддомен *cdnverify* и существует запись CNAME, которая указывает на ваше имени узла конечной точки, вы не получите электронное сообщение о подтверждении домена.
     
    Проверка в этом случае проходит автоматически. Если запись CNAME отсутствует и вы не получили сообщение электронной почты в течение 24 часов, обратитесь в службу поддержки Майкрософт.

4. *Не окажется ли сертификат SAN менее безопасным, чем выделенный сертификат?*
    
    Для сертификата SAN используются те же стандарты безопасности и шифрования, что и для выделенного сертификата. Чтобы дополнительно обезопасить сервер, для всех выданных TLS/SSL-сертификатов используется алгоритм SHA-256.

5. *Нужно ли иметь запись авторизации центра сертификации у моего поставщика DNS?*

    В настоящее время запись авторизации центра сертификации не требуется. Однако если у вас она есть, она должна включать DigiCert в качестве действительного центра сертификации.

6. *С 20 июня 2018 г. в Azure CDN от Verizon начато использование выделенного сертификата с подключением TLS/SSL на основе SNI по умолчанию. Что произойдет с моими существующими личными доменами, использующими сертификат SAN и подключение TLS/SSL на основе IP-адресов?*

    В ближайшие месяцы ваши существующие домены будут постепенно переведены на использование одного сертификата, если корпорация Майкрософт сделает вывод, что к приложению выполнялись только клиентские запросы SNI. 
    
    Если обнаруживаются клиенты без SNI, домены продолжат использовать сертификат SAN с протоколом TLS/SSL на основе IP-адресации. Это не повлияет на запросы к службе или клиентам, которые не используют SNI.

7. *Как работает продление сертификатов с помощью собственного сертификата?*

    Чтобы обеспечить развертывание более нового сертификата в инфраструктуре PoP, отправьте новый сертификат в Azure KeyVault. В параметрах TLS в Azure CDN выберите самую новую версию сертификата и нажмите кнопку "Сохранить". Затем Azure CDN распространит ваш обновленный сертификат. 

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как выполнять следующие задачи:

> [!div class="checklist"]
> - включение протокола HTTPS в личном домене;
> - использование сертификата, управляемого CDN; 
> - использование собственного сертификата;
> - проверка домена;
> - отключение протокола HTTPS в личном домене.

Перейдите к следующему руководству, чтобы научиться настраивать кэширование в конечной точке CDN.

> [!div class="nextstepaction"]
> [Руководство. Настройка правил кэширования Azure CDN](cdn-caching-rules-tutorial.md)