---
title: Удаление типа узла в Azure Service Fabric | Документация Майкрософт
description: Узнайте, как удалить тип узла из кластера Service Fabric, работающего в Azure.
author: inputoutputcode
manager: sridmad
ms.topic: conceptual
ms.date: 08/11/2020
ms.author: chrpap
ms.openlocfilehash: ede999bee9ce1a4a9dd10652a2c52a840d5b24be
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "88163583"
---
# <a name="how-to-remove-a-service-fabric-node-type"></a>Удаление типа узла Service Fabric
В этой статье описывается, как масштабировать кластер Azure Service Fabric путем удаления существующего типа узла из кластера. Кластер Service Fabric — это подключенный к сети набор виртуальных машин или физических компьютеров, в котором вы развертываете микрослужбы и управляете ими. Компьютер или виртуальная машина, которая входит в состав кластера. Масштабируемые наборы виртуальных машин относятся к вычислительным ресурсам Azure. Их можно использовать для развертывания коллекции виртуальных машин и управления ею как набором. Каждый тип узла, определенный в кластере Azure, [настроен как отдельный масштабируемый набор](service-fabric-cluster-nodetypes.md). Затем каждым типом узла можно управлять отдельно. После создания кластера Service Fabric вы можете масштабировать кластер по горизонтали, удалив тип узла (масштабируемый набор виртуальных машин) и все его узлы.  Кластер можно масштабировать в любое время, даже когда в нем выполняются рабочие нагрузки.  Вместе с кластером автоматически масштабируются ваши приложения.

> [!WARNING]
> Использовать этот подход для удаления типа узла из рабочего кластера не рекомендуется, так как он часто используется. Это опасная команда, так как она удаляет ресурс масштабируемого набора виртуальных машин, связанный с типом узла. 

## <a name="durability-characteristics"></a>Характеристики устойчивости
При использовании Remove-Азсервицефабрикнодетипе приоритетность безопасности определяется по скорости. Тип узла должен иметь [уровень устойчивости](./service-fabric-cluster-capacity.md#durability-characteristics-of-the-cluster) Silver или Gold по следующим причинам:
- Уровень Bronze не дает никаких гарантий в отношении сохранении сведений о состоянии.
- В рамках устойчивости уровня Silver и Gold перехватываются любые изменения в масштабируемом наборе.
- Уровень Gold также позволяет контролировать обновления Azure для нижестоящего масштабируемого набора.

Service Fabric "координирует" базовые изменения и обновления, поэтому данные не теряются. Однако при удалении типа узла с помощью бронзовой устойчивости вы можете потерять сведения о состоянии. Если вы удаляете тип первичного узла и ваше приложение не имеет состояния, бронзовая допустимая. При выполнении рабочих нагрузок с отслеживанием состояния в рабочей среде минимальной конфигурацией должен быть уровень Silver. Аналогичным образом для рабочих сценариев тип первичного узла всегда должен быть уровня Silver или Gold.

### <a name="more-about-bronze-durability"></a>Сведения об устойчивости Bronze

При удалении типа узла Bronze все узлы этого типа сразу же выходят из строя. Service Fabric не перехватывает обновления масштабируемого набора для узлов Bronze, поэтому все виртуальные машины сразу же выходят из строя. Если у вас есть какой-либо объект с отслеживанием состояния на этих узлах, данные будут потеряны. Теперь, даже если вы использовали объекты без отслеживания состояния, все узлы в Service Fabric входят в кольцевую топологию, поэтому все окружение может быть потеряно, что может нарушить работу самого кластера.

## <a name="remove-a-node-type"></a>Удаление типа узла

1. Перед началом процесса примите во внимание эти предварительные требования.

    - Кластер находится в работоспособном состоянии.
    - После удаления типа узла все равно будет иметь достаточную емкость, например. количество узлов для размещения требуемого количества реплик.

2. Переместите все службы, имеющие ограничения на размещение, чтобы использовать тип узла из типа узла.

    - Измените манифест приложения или службы, чтобы он больше не ссылался на тип узла.
    - Разверните изменение.

    Затем проверьте следующее:
    - Все службы, измененные выше, больше не выполняются на узле, входящем в тип узла.
    - Все службы работоспособны.

3. Снять пометку типа узла как не являющегося первичным (пропустить для типов, не являющихся первичными узлами)

    - Поиск шаблона Azure Resource Manager, используемого для развертывания.
    - Найдите раздел, связанный с типом узла, в разделе Service Fabric.
    - Измените свойство IsFalse на false. * * Не удаляйте раздел, связанный с типом узла в этой задаче.
    - Разверните измененный шаблон Azure Resource Manager. * * В зависимости от конфигурации кластера этот шаг может занять некоторое время.
    
    Затем проверьте следующее:
    - Service Fabric разделе на портале указывает, что кластер готов.
    - Кластер исправен.
    - Ни один из узлов, принадлежащих к типу узла, не помечен как начальный узел.

4. Отключите каждый узел в типе узла.

    Подключитесь к кластеру с помощью PowerShell, а затем выполните следующий шаг.
    
    ```powershell
    $nodeType = "" # specify the name of node type
    $nodes = Get-ServiceFabricNode
    
    foreach($node in $nodes)
    {
      if ($node.NodeType -eq $nodeType)
      {
        $node.NodeName
     
        Disable-ServiceFabricNode -Intent RemoveNode -NodeName $node.NodeName -Force
      }
    }
    ```

    - Для устойчивости к бронзовому дождитесь перехода всех узлов в состояние отключено.
    - Для уровня устойчивости "серебро" и "Gold" некоторые узлы будут отключены, а остальные будут находиться в состоянии отключения. Проверьте вкладку Сведения узлов в отключенном состоянии, если они все заблокированы для обеспечения кворума для секций службы инфраструктуры, то можно продолжать работу.

5. Останавливает данные для типа узла.

    Подключитесь к кластеру с помощью PowerShell, а затем выполните следующий шаг.
    
    ```powershell
    foreach($node in $nodes)
    {
      if ($node.NodeType -eq $nodeType)
      {
        $node.NodeName
     
        Start-ServiceFabricNodeTransition -Stop -OperationId (New-Guid) -NodeInstanceId $node.NodeInstanceId -NodeName $node.NodeName -StopDurationInSeconds 10000
      }
    }
    ```
    
    Дождитесь, пока все узлы для типа узла будут отмечены как отключенные.

6. Освобождение узлов в исходном масштабируемом наборе виртуальных машин
    
    Войдите в подписку Azure, где был развернут масштабируемый набор, и удалите масштабируемый набор виртуальных машин. 

    ```powershell
    $scaleSetName="myscaleset"
    $scaleSetResourceType="Microsoft.Compute/virtualMachineScaleSets"
    
    Remove-AzResource -ResourceName $scaleSetName -ResourceType $scaleSetResourceType -ResourceGroupName $resourceGroupName -Force
    ```

    
7. Удаление данных для типа узла.

    Подключитесь к кластеру с помощью PowerShell, а затем выполните следующий шаг.
    
    ```powershell
    foreach($node in $nodes)
    {
      if ($node.NodeType -eq $nodeType)
      {
        $node.NodeName
     
        Remove-ServiceFabricNodeState -NodeName $node.NodeName -Force
      }
    }
    ```

    Подождите, пока все узлы будут удалены из кластера. Узлы не должны отображаться в SFX.

8. Удалите тип узла из раздела Service Fabric.

    - Поиск шаблона Azure Resource Manager, используемого для развертывания.
    - Найдите раздел, связанный с типом узла, в разделе Service Fabric.
    - Удалите раздел, соответствующий типу узла.
    - Только для отказоустойчивых и более высоких кластеров, обновите ресурс кластера в шаблоне и настройте политики работоспособности, чтобы игнорировать структуру:/работоспособность системного приложения, добавив `applicationDeltaHealthPolicies` в раздел ресурс кластера `properties` , как указано ниже. Приведенная ниже политика должна пропускать существующие ошибки, но не разрешать новые ошибки работоспособности. 
 
 
     ```json
    "upgradeDescription":  
    { 
      "forceRestart": false, 
      "upgradeReplicaSetCheckTimeout": "10675199.02:48:05.4775807", 
      "healthCheckWaitDuration": "00:05:00", 
      "healthCheckStableDuration": "00:05:00", 
      "healthCheckRetryTimeout": "00:45:00", 
      "upgradeTimeout": "12:00:00", 
      "upgradeDomainTimeout": "02:00:00", 
      "healthPolicy": { 
        "maxPercentUnhealthyNodes": 100, 
        "maxPercentUnhealthyApplications": 100 
      }, 
      "deltaHealthPolicy":  
      { 
        "maxPercentDeltaUnhealthyNodes": 0, 
        "maxPercentUpgradeDomainDeltaUnhealthyNodes": 0, 
        "maxPercentDeltaUnhealthyApplications": 0, 
        "applicationDeltaHealthPolicies":  
        { 
            "fabric:/System":  
            { 
                "defaultServiceTypeDeltaHealthPolicy":  
                { 
                        "maxPercentDeltaUnhealthyServices": 0 
                } 
            } 
        } 
      } 
    },
    ```

    - Разверните измененный шаблон Azure Resource Manager. * * Этот шаг займет некоторое время, обычно не более двух часов. Это обновление изменит параметры на Инфраструктуресервице, поэтому требуется перезагрузка узла. В этом случае `forceRestart` игнорируется. 
    Параметр `upgradeReplicaSetCheckTimeout` задает максимальное время, которое Service Fabric ожидает, когда Секция находится в надежном состоянии, если она еще не находится в надежном состоянии. После проверки безопасности для всех секций на узле Service Fabric переходит к обновлению на этом узле.
    Значение параметра `upgradeTimeout` может быть сокращено до 6 часов, но для максимальной безопасности следует использовать 12 часов.

    Затем проверьте следующее:
    - Service Fabric ресурс на портале — готово.

9. Удалите все ссылки на ресурсы, связанные с типом узла, из шаблона ARM.

    - Поиск шаблона Azure Resource Manager, используемого для развертывания.
    - Удалите из шаблона масштабируемый набор виртуальных машин и другие ресурсы, связанные с типом узла.
    - Разверните изменения.

    Затем сделайте следующее:
    - Дождитесь завершения развертывания.
    
10. Удалите ресурсы, связанные с типом узла, который больше не используется. Пример Load Balancer и общедоступного IP-адреса. 

    - Чтобы удалить эти ресурсы, можно использовать ту же команду PowerShell, которая использовалась на шаге 6, указав конкретный тип ресурса и версию API. 

> [!Note]
> Этот шаг является необязательным, если тот же Load Balancer и IP-адрес используется повторно между типами узлов.

## <a name="next-steps"></a>Дальнейшие шаги
- Дополнительные сведения о [характеристиках устойчивости](./service-fabric-cluster-capacity.md#durability-characteristics-of-the-cluster) кластера.
- Дополнительные сведения о [типах узлов и масштабируемых наборах виртуальных машин](service-fabric-cluster-nodetypes.md).
- Дополнительные сведения о [масштабировании кластеров Service Fabric](service-fabric-cluster-scaling.md).
