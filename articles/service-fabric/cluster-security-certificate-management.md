---
title: Управление сертификатами в кластере Service Fabric
description: Сведения об управлении сертификатами в кластере Service Fabric, защищенном с помощью сертификатов X. 509.
ms.topic: conceptual
ms.date: 04/10/2020
ms.custom: sfrev
ms.openlocfilehash: aba681157d71f94914462b8d9fc13b90d4d6b153
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "88653670"
---
# <a name="certificate-management-in-service-fabric-clusters"></a>Управление сертификатами в кластерах Service Fabric

В этой статье рассматриваются аспекты управления сертификатами, используемыми для защиты обмена данными в кластерах Azure Service Fabric, а также приводятся общие сведения о проверке подлинности в [Service Fabric кластерах](service-fabric-cluster-security.md) и об [аутентификации на основе сертификатов X. 509 в Service Fabric](cluster-security-certificates.md). Предполагается, что читатель знаком с основными концепциями безопасности, а также с элементами управления, которые Service Fabric предоставляет для настройки безопасности кластера.  

Аспекты, описываемые в этом заголовке:

* Что такое "Управление сертификатами"?
* Роли и сущности, участвующие в управлении сертификатами
* Путешествие сертификата
* Углубленное углубление в пример
* Устранение неполадок и часто задаваемые вопросы

Но сначала заявление об отказе от ответственности: в этой статье мы постараемся связать теоретическую сторону с практическими примерами, в которых требуются, а также особенности служб, технологий и т. д. Так как немалым часть аудитории является внутренней, мы будем называть службы, технологии и продукты, относящиеся к Microsoft Azure. Вы можете обратиться к разделу комментариев, чтобы получить пояснения или рекомендации, в которых в вашей ситуации не применяются сведения, относящиеся к Майкрософт.

## <a name="defining-certificate-management"></a>Определение управления сертификатами
Как мы видели в [сопровождающей статье](cluster-security-certificates.md), сертификат — это криптографический объект, в сущности связывающий пару асимметричных ключей с атрибутами, описывающими сущность, которую она представляет. Однако он также является объектом "перишабле", в котором его время существования ограничено и подвержено нарушениям безопасности, или успешная атака может привести к отображению сертификата, бесполезного с точки зрения защиты. Это означает необходимость изменения сертификатов — как обычно, так и в ответ на инцидент безопасности. Другой аспект управления (и сам по себе является целиком) — это защита закрытых ключей сертификатов или секретов, защищающих удостоверения сущностей, участвующих в приобретение и сертификатах подготовки. Мы будем обращаться к процессам и процедурам, используемым для получения сертификатов, а также для безопасного (и безопасного) передачи их в то место, где они необходимы для управления сертификатами. Некоторые операции управления, такие как регистрация, параметры политики и элементы управления авторизацией, выходят за рамки этой статьи. Другие, такие как подготовка, продление, повторная запись или отзыв, по-прежнему связаны только с Service Fabric; Тем не менее, мы будем обращаться к ним в некоторой степени, так как понимание этих операций может помочь правильно защитить кластер одного. 

Цель состоит в том, чтобы автоматизировать управление сертификатами, чтобы обеспечить непрерывную доступность кластера и предложить гарантии безопасности, учитывая, что этот процесс не ориентирован на пользователей. Эта цель сейчас достижима в кластерах Azure Service Fabric. Оставшаяся часть статьи сначала деконструирует Управление сертификатами, и в дальнейшем основное внимание уделяется включению автосмены.

В частности, темы в области действия:
  - допущения, связанные с разделением соотнесений между владельцем и платформой, в контексте управления сертификатами
  - длинный конвейер сертификатов от выдачи до потребления
  - Смена сертификатов. Почему, как и когда
  - что может быть, возможно, не так?

Такие аспекты, как защита доменных имен и управление ими, регистрация в сертификатах или Настройка элементов управления авторизацией для принудительного выдачи сертификата, выходят за рамки этой статьи. Обратитесь к центру регистрации (RA) вашей любимой службы инфраструктуры открытых ключей (PKI). Внутренние потребители корпорации Майкрософт. Вы можете обратиться в службу безопасности Azure.

## <a name="roles-and-entities-involved-in-certificate-management"></a>Роли и сущности, участвующие в управлении сертификатами
Подход к безопасности в кластере Service Fabric — это случай, когда владелец кластера объявляет его, Service Fabric среда выполнения применяет его. Это означает, что почти ни один из сертификатов, ключей или других учетных данных удостоверений, участвующих в работе кластера, не поступает от самой службы. Все они объявляются владельцем кластера. Кроме того, владелец кластера также отвечает за подготовку сертификатов в кластере, их обновление по мере необходимости и обеспечение безопасности сертификатов в любое время. В частности, владелец кластера должен убедиться в том, что:
  - сертификаты, объявленные в разделе NodeType манифеста кластера, можно найти на каждом узле этого типа в соответствии с [правилами представления](cluster-security-certificates.md#presentation-rules) .
  - сертификаты, объявленные выше, установлены вместе с соответствующими закрытыми ключами
  - сертификаты, объявленные в правилах презентации, должны пройти [правила проверки](cluster-security-certificates.md#validation-rules) . 

Service Fabric для своей части предполагает, что обязанности:
  - Поиск и поиск сертификатов, соответствующих объявлениям в определении кластера  
  - предоставление доступа к соответствующим закрытым ключам для сущностей, управляемых Service Fabric, на основе "необходимости"
  - Проверка сертификатов в соответствии с установленными рекомендациями по безопасности и определением кластера
  - Создание оповещений о незавершенном истечении срока действия сертификатов или ошибках для выполнения основных шагов проверки сертификата
  - Проверка (в некоторой степени) того, что связанные с сертификатами аспекты определения кластера выполняются базовой конфигурацией узлов. 

В этом случае нагрузка на управление сертификатами (как активные операции) становится исключительно для владельца кластера. В следующих разделах мы подробнее рассмотрим каждую из операций управления с доступными механизмами и их влиянием на кластер.

## <a name="the-journey-of-a-certificate"></a>Путешествие сертификата
Давайте быстро перейдем к прогрессу сертификата от выдачи до потребления в контексте кластера Service Fabric:

  1. Владелец домена регистрируется в RA (домен PKI) домена или субъекта, который необходимо связать с последующими сертификатами. сертификаты, в свою очередь, будут считаться доказательствами принадлежности к домену или субъекту.
  2. Владелец домена также обозначает в RA идентификаторы уполномоченных запрашивающих лиц, которые имеют право запрашивать регистрацию сертификатов с указанным доменом или субъектом; в Microsoft Azure поставщик удостоверений по умолчанию Azure Active Directory, а полномочные запрашивающие стороны назначаются соответствующим удостоверением AAD (или группами безопасности).
  3. Затем Полномочный запрашивающий регистрируется в сертификате через службу управления секретами. в Microsoft Azure в качестве SMS выбирается Azure Key Vault (AKV), который безопасно сохраняет и разрешает получение секретов и сертификатов с помощью полномочных сущностей. AKV также обновляет и повторно использует ключ сертификата, как указано в соответствующей политике сертификата. (AKV использует AAD в качестве поставщика удостоверений.)
  4. Полномочный получатель, который мы будем называть "агентом подготовки", получает сертификат, включающий его закрытый ключ, из хранилища и устанавливает его на компьютерах, где размещен кластер.
  5. Служба Service Fabric (с повышенными правами на каждом узле) предоставляет доступ к сертификату для разрешенных Service Fabric сущностей; они назначаются локальными группами и разбиваются между ServiceFabricAdministrators и ServiceFabricAllowedUsers
  6. Среда выполнения Service Fabric обращается к сертификату и использует его для установления Федерации, а также для проверки подлинности входящих запросов от полномочных клиентов.
  7. Агент подготовки отслеживает сертификат хранилища и активирует процесс подготовки после обнаружения обновления. Впоследствии при необходимости владелец кластера обновляет определение кластера, чтобы указать цель для перебора сертификата.
  8. Агент подготовки или владелец кластера также отвечает за очистку и удаление неиспользуемых сертификатов.
  
В наших целях первые два шага в приведенной выше последовательности практически не связаны. единственное соединение заключается в том, что общее имя субъекта сертификата — это DNS-имя, объявленное в определении кластера.

Эти шаги показаны ниже. Обратите внимание на различия в подготовке сертификатов, объявленных по отпечатку и общему имени соответственно.

*Рис. 1.* Поток выдачи и подготовки сертификатов, объявленных по отпечатку.
![Сертификаты подготовки, объявленные отпечатком][Image1]

*Рисунок. 2.* Поток выдачи и подготовки сертификатов, объявленных по общему имени субъекта.
![Подготовка сертификатов, объявленных по общему имени субъекта][Image2]

### <a name="certificate-enrollment"></a>Подача заявки на сертификат
Этот раздел подробно рассматривается в [документации](../key-vault/certificates/create-certificate.md)по Key Vault. Мы включающи краткий обзор для обеспечения непрерывности и упрощения справочника. Продолжая работу с Azure в качестве контекста и используя Azure Key Vault в качестве службы управления секретами, полномочный запрашивающий сертификат должен иметь по крайней мере разрешения на управление сертификатами в хранилище, предоставленном владельцем хранилища. Затем инициатор запроса будет регистрироваться в сертификате следующим образом:
    - создает политику сертификата в Azure Key Vault (AKV), которая указывает домен или субъект сертификата, требуемого издателя, типа ключа и длины, предполагаемого использования ключа и т. д. Дополнительные сведения см. [в разделе Сертификаты в Azure Key Vault](../key-vault/certificates/certificate-scenarios.md) . 
    - создает сертификат в том же хранилище с указанной выше политикой; Это, в свою очередь, создает пару ключей как объекты хранилища, запрос подписи сертификата, подписанный закрытым ключом, который затем перенаправляется указанному издателю для подписывания.
    - После того как издатель (центр сертификации) ответит на подписанный сертификат, результат будет объединен в хранилище, а сертификат будет доступен для следующих операций:
      - в разделе {vaultUri}/цертификатес/{наме}: сертификат, включая открытый ключ и метаданные.
      - в разделе {vaultUri}/Кэйс/{наме}: закрытый ключ сертификата, доступный для криптографических операций (перенос/распаковка, подпись и проверка).
      - в разделе {vaultUri}/Секретс/{наме}: сертификат, включающий закрытый ключ, доступный для загрузки в виде незащищенного PFX-файла или PEM-файл.  
    Помните, что сертификат хранилища, в действительности, представляет собой хронологический ряд экземпляров сертификатов, совместно использующих политику. Версии сертификатов будут созданы в соответствии с атрибутами времени существования и продления политики. Настоятельно рекомендуется, чтобы сертификаты хранилища не совместно используют субъекты или домены или DNS-имена. в кластере может быть нарушена работа кластера для инициализации экземпляров сертификатов из разных сертификатов хранилища с идентичными субъектами, но значительно отличающимися другими атрибутами, такими как издатель, использование ключей и т. д.

На этом этапе сертификат существует в хранилище и готов к потреблению. Назад к:

### <a name="certificate-provisioning"></a>Подготовка сертификатов
Мы упомянули "агент подготовки", который представляет собой сущность, которая получает сертификат, включая его закрытый ключ, из хранилища и устанавливает его на каждом узле кластера. (Помните, что Service Fabric не подготавливает сертификаты.) В нашем контексте кластер будет размещен в коллекции виртуальных машин Azure и (или) масштабируемых наборов виртуальных машин. В Azure подготовка сертификата из хранилища в виртуальную машину или VMSS может быть достигнута с помощью следующих механизмов. Предполагается, что, как указано выше, агент подготовки ранее предоставил разрешения "Get" в хранилище владельцем хранилища. 
  - ad-hoc. оператор получает сертификат из хранилища (PFX/PKCS #12 или PEM) и устанавливает его на каждом узле.
  - в качестве секрета для масштабируемого набора виртуальных машин во время развертывания: Служба вычислений извлекает, использует удостоверение первой стороны от имени оператора, сертификат из хранилища шаблона и устанавливает его на каждом узле масштабируемого набора виртуальных машин ([например,](../virtual-machine-scale-sets/virtual-machine-scale-sets-faq.md#certificates)); Обратите внимание, что разрешает подготовку только версий секретов
  - использование [расширения виртуальной машины Key Vault](../virtual-machines/extensions/key-vault-windows.md); Это позволяет подготовить сертификаты с помощью объявлений без версии, периодически обновляя наблюдаемые сертификаты. В этом случае для виртуальной машины или VMSS ожидается [управляемое удостоверение](../virtual-machines/security-policy.md#managed-identities-for-azure-resources)— удостоверение, которому предоставлен доступ к хранилищам, содержащим наблюдаемые сертификаты.

Механизм ad-hoc не рекомендуется по нескольким причинам, от безопасности до доступности и не будет обсуждаться здесь. Дополнительные сведения см. в разделе [сертификаты в масштабируемых наборах виртуальных машин](../virtual-machine-scale-sets/virtual-machine-scale-sets-faq.md#certificates).

Подготовка VMSS-/Компуте-басед предоставляет преимущества обеспечения безопасности и доступности, но также предоставляет ограничения. Для этого необходимо объявить сертификаты как версии секретов, что делает его пригодным только для кластеров, защищенных сертификатами, объявленными по отпечатку. В отличие от этого, подготовка на основе расширения виртуальной машины Key Vault всегда будет устанавливать последнюю версию каждого наблюдаемого сертификата, что делает его пригодным только для кластеров, защищенных сертификатами, объявленными по общему имени субъекта. Чтобы подчеркнуть, не используйте механизм подготовки автообновления (например, расширение КВВМ) для сертификатов, объявленных экземпляром (то есть по отпечатку). риск потери доступности существенно.

Могут существовать другие механизмы подготовки; Приведенные выше сведения в настоящее время приняты для кластеров Azure Service Fabric.

### <a name="certificate-consumption-and-monitoring"></a>Использование и мониторинг сертификатов
Как упоминалось ранее, среда выполнения Service Fabric отвечает за поиск и использование сертификатов, объявленных в определении кластера. В статье подробно описывается [Проверка подлинности на основе сертификатов](cluster-security-certificates.md) , как Service Fabric реализует правила представления и проверки, соответственно, и не будет посещаться здесь. Мы будем просматривать доступ и предоставлять разрешения, а также выполнять мониторинг.

Помните, что сертификаты в Service Fabric используются в различных целях, от взаимной проверки подлинности на уровне Федерации до TLS-аутентификации для конечных точек управления. для этого требуется, чтобы различные компоненты или системные службы имели доступ к закрытому ключу сертификата. Среда выполнения Service Fabric регулярно сканирует хранилище сертификатов, выполняя поиск совпадений для каждого из известных правил представления. для каждого из соответствующих сертификатов размещается соответствующий закрытый ключ, и его список управления доступом на уровне пользователей обновляется для включения разрешений — обычно чтение и выполнение — предоставляются соответствующему удостоверению, которому они требуются. (Этот процесс формально называется "адресам".) Этот процесс выполняется с частотой 1 минуту, а также охватывает сертификаты приложения, например те, которые используются для шифрования параметров или в качестве сертификатов конечной точки. Адресам соответствует правилам представления, поэтому важно помнить, что сертификаты, объявленные по отпечатку и которые обновляются без обновления конфигурации кластера, будут недоступны.    

### <a name="certificate-rotation"></a>смены сертификатов;
В качестве побочной заметки: IETF [RFC 3647](https://tools.ietf.org/html/rfc3647) формально определяет [продление](https://tools.ietf.org/html/rfc3647#section-4.4.6) в качестве выдачи сертификата с теми же атрибутами, что и заменяющий сертификат. издатель, Открытый ключ субъекта и информация сохраняются, а также [Повторное создание ключей](https://tools.ietf.org/html/rfc3647#section-4.4.7) в качестве выдачи сертификата с новой парой ключей и отсутствие каких-либо ограничений на то, может ли поставщик измениться. С учетом различий может быть важно (рассмотрим случай, когда сертификаты объявляются по общему имени субъекта с закреплением издателя). Мы будем использовать нейтральный термин "вращение", чтобы охватить оба сценария. (Не забывайте, что при использовании "продления" на самом деле для повторного создания ключа используется "обновление".) 

Ранее мы видели, что Azure Key Vault поддерживает автоматическое вращение сертификатов. Политика связывания сертификатов определяет момент времени (в днях до истечения срока действия или в процентах от общего времени существования), когда сертификат поворачивается в хранилище. Агент подготовки должен быть вызван через этот момент времени и до истечения срока действия предыдущего сертификата, чтобы распространить этот новый сертификат на все узлы кластера. Service Fabric поможет, вызывая предупреждения о работоспособности, когда срок действия сертификата (который в настоящее время используется в кластере) происходит раньше, чем заранее определенный интервал. Агент автоматической подготовки (т. е. расширение виртуальной машины KeyVault), настроенный для наблюдения за сертификатом хранилища, периодически опрашивает хранилище, обнаруживает смену и получает и устанавливает новый сертификат. Для подготовки к работе с помощью функции "секреты" виртуальной машины или VMSS потребуется Полномочный оператор для обновления виртуальной машины или VMSS с помощью универсального кода ресурса (URI) версии KeyVault, соответствующего новому сертификату.

В любом случае повернутый сертификат теперь подготавливается ко всем узлам, и мы описываем механизм, Service Fabric использует для обнаружения поворотов. Давайте рассмотрим, что происходит в следующий раз, предполагая, что применяется поворот к сертификату кластера, объявленному по общему имени субъекта (все применимо на момент написания этой статьи, и Service Fabric Runtime версии 7.1.409):
  - для новых подключений в, а также в кластере среда выполнения Service Fabric обнаружит и выберет соответствующий сертификат с самой последней датой истечения срока действия (свойство "NotAfter" сертификата, которое часто сокращается на "НД").
  - существующие соединения будут храниться в активном состоянии или быть разрешены в течение естественного срока действия или прекращения. внутренний обработчик будет уведомлен о существовании нового совпадения

Это преобразуется в следующие важные наблюдения:
  - Сертификат продления можно игнорировать, если срок его действия предшествует значению сертификата, используемого в данный момент.
  - Доступность кластера или размещенных приложений имеет приоритет над директивой для смены сертификата; кластер будет расвлекаться по новому сертификату в конечном итоге, но без гарантий синхронизации. В следующем случае:
  - Очевидно, что повернутый сертификат полностью заменен его предшественником. единственный способ убедиться, что (для сертификатов кластера) перезагружать хост-компьютеры. Обратите внимание, что недостаточно перезапускать узлы Service Fabric, так как компоненты режима ядра, которые формируют подключения аренды в кластере, не будут затронуты. Также обратите внимание, что перезапуск виртуальной машины или VMSS может привести к временной потере доступности. (Для сертификатов приложений достаточно перезапустить только соответствующие экземпляры приложения.)
  - Новый сертификат с повторной назначением, который не соответствует правилам проверки, может эффективно прерывать работу кластера. Наиболее распространенным примером такого случая является непредвиденный поставщик: сертификаты кластера объявляются по общему имени субъекта с закреплением издателя, но повернутый сертификат был выдан новым или необъявленным издателем.     

### <a name="certificate-cleanup"></a>Очистка сертификата
В настоящее время в Azure нет подположений для явного удаления сертификатов. Зачастую нетривиальной задачей является определение того, используется ли данный сертификат в данный момент времени. Это сложнее для сертификатов приложений, чем для сертификатов кластера. Service Fabric сама по себе не является агентом подготовки, не удалит сертификат, объявленный пользователем при каких-либо обстоятельствах. Для стандартных механизмов подготовки:
  - Сертификаты, объявленные как секреты ВМ или VMSS, будут подготовлены при условии, что на них есть ссылка в определении VM или VMSS, и они будут извлечены из хранилища (удаление секрета или сертификата хранилища приведет к сбою при последующих развертываниях виртуальной машины или VMSS. Аналогично, при отключении версии секрета в хранилище также произойдет сбой развертываний VM/VMSS, которые ссылаются на эту версию секрет
  - Предыдущие версии сертификатов, подготовленные с помощью расширения виртуальной машины KeyVault, могут присутствовать или отсутствовать на узле VM или VMSS. Агент извлекает и устанавливает текущую версию и не удаляет сертификаты. Повторное создание образа узел (который обычно выполняется каждый месяц) будет сбрасывать хранилище сертификатов к содержимому образа ОС, поэтому предыдущие версии будут неявно удалены. Однако учтите, что при масштабировании масштабируемого набора виртуальных машин будет установлена только текущая версия наблюдаемых сертификатов; не следует считать однородность узлов в отношении установленных сертификатов.   

## <a name="simplifying-management---an-autorollover-example"></a>Упрощение управления — пример с автопереключением
Мы описывали механизмы, ограничения, сложные правила и определения и сделали ужасные прогнозы простоев. Это, возможно, покажет, как настроить автоматическое управление сертификатами, чтобы избежать всех этих проблем. Мы делаем это в контексте кластера Azure Service Fabric, работающего в масштабируемом наборе виртуальных машин PaaSv2, используя Azure Key Vault для управления секретами и использования управляемых удостоверений, как показано ниже.
  - Проверка сертификатов изменена с отпечатка на закрепление по теме + Издатель: любой сертификат с заданной темой от данного издателя является одинаковым доверенным
    - Сертификаты регистрируются в надежном хранилище и получаются из него (Key Vault) и обновляются агентом. в данном случае это расширение виртуальной машины KeyVault.
    - Подготовка сертификатов изменялась с версии времени развертывания и на основе версий (как сделано Компутерп) до развертывания и использования URI-кодов, меньших версии KeyVault
    - Доступ к KeyVault предоставляется через управляемые пользователем удостоверения. удостоверение агента пользователя создается и назначается масштабируемому набору виртуальных машин во время развертывания.
    - После развертывания агент (расширение виртуальной машины KV) будет опрашивать и обновлять наблюдаемые сертификаты на каждом узле масштабируемого набора виртуальных машин. Таким образом, смена сертификатов полностью автоматизирована, так как она автоматически выберет самый крайний действительный сертификат.

Эта последовательность является полностью настраиваемой или автоматизированной и позволяет пользователю без вмешательства пользователя выполнять начальное развертывание кластера, настроенного для автоматической смены сертификата. Подробные инструкции приведены ниже. Мы будем использовать сочетание командлетов PowerShell и фрагментов шаблонов JSON. Одни и те же функции можно достичь с помощью всех поддерживаемых средств взаимодействия с Azure.

[!NOTE] В этом примере предполагается, что сертификат уже существует в хранилище. регистрация и обновление сертификата, управляемого KeyVault, требует выполнения предварительных требований вручную, как описано выше в этой статье. Для рабочих сред Используйте сертификаты, управляемые KeyVault. ниже приведен пример скрипта, относящегося к внутренней инфраструктуре PKI Майкрософт.
Автосмена сертификата имеет смысл только для сертификатов, выданных ЦС; Использование самозаверяющих сертификатов, в том числе тех, которые были созданы при развертывании Service Fabric кластера в портал Azure, является бессмысленное, но по-прежнему возможно для локальных и размещенных развертываний, объявляя отпечаток издателя в качестве того же конечного сертификата.

### <a name="starting-point"></a>Начальная точка
Для краткости мы будем воспринимать следующее начальное состояние:
  - Кластер Service Fabric существует и защищен сертификатом, выданным центром сертификации, объявленным отпечатком.
  - Сертификат хранится в хранилище и подготавливается в качестве секрета масштабируемого набора виртуальных машин.
  - Один и тот же сертификат будет использоваться для преобразования кластера в объявления общих сертификатов на основе имен, поэтому его можно проверить по теме и издателю. Если это не так, получите сертификат, выданный ЦС, предназначенный для этой цели, и добавьте его в определение кластера по отпечатку, как описано [здесь](service-fabric-cluster-security-update-certs-azure.md) .

Ниже приведен фрагмент JSON из шаблона, соответствующего такому состоянию. Обратите внимание, что в нем опущены многие обязательные параметры и показаны только связанные с сертификатами аспекты.
```json
  "resources": [
    {   ## VMSS definition
      "apiVersion": "[variables('vmssApiVersion')]",
      "type": "Microsoft.Compute/virtualMachineScaleSets",
      "name": "[variables('vmNodeTypeName')]",
      "location": "[variables('computeLocation')]",
      "properties": {
        "virtualMachineProfile": {
          "extensionProfile": {
            "extensions": [
            {
                "name": "[concat('ServiceFabricNodeVmExt','_vmNodeTypeName')]",
                "properties": {
                  "type": "ServiceFabricNode",
                  "autoUpgradeMinorVersion": true,
                  "publisher": "Microsoft.Azure.ServiceFabric",
                  "settings": {
                    "clusterEndpoint": "[reference(parameters('clusterName')).clusterEndpoint]",
                    "nodeTypeRef": "[variables('vmNodeTypeName')]",
                    "dataPath": "D:\\SvcFab",
                    "durabilityLevel": "Bronze",
                    "certificate": {
                        "thumbprint": "[parameters('primaryClusterCertificateTP')]",
                        "x509StoreName": "[parameters('certificateStoreValue')]"
                    }
                  },
                  "typeHandlerVersion": "1.1"
                }
            },}},
          "osProfile": {
            "adminPassword": "[parameters('adminPassword')]",
            "adminUsername": "[parameters('adminUsername')]",
            "secrets": [
            {
                "sourceVault": {
                    "id": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                },
                "vaultCertificates": [
                {
                    "certificateStore": "[parameters('certificateStoreValue')]",
                    "certificateUrl": "[parameters('clusterCertificateUrlValue')]"
                },
            ]}]
        },
    },
    {   ## cluster definition
        "apiVersion": "[variables('sfrpApiVersion')]",
        "type": "Microsoft.ServiceFabric/clusters",
        "name": "[parameters('clusterName')]",
        "location": "[parameters('clusterLocation')]",
        "certificate": {
            "thumbprint": "[parameters('primaryClusterCertificateTP')]",
            "x509StoreName": "[parameters('certificateStoreValue')]"
        },
    }
  ]
```   

Описанный выше параметр говорит о том, что сертификат с отпечатком ```json [parameters('primaryClusterCertificateTP')] ``` и найден в URI KeyVault ```json [parameters('clusterCertificateUrlValue')] ``` объявляется как единственный сертификат кластера по отпечатку. Далее предстоит настроить дополнительные ресурсы, необходимые для обеспечения автосмены сертификата.

### <a name="setting-up-prerequisite-resources"></a>Настройка необходимых ресурсов
Как упоминалось ранее, сертификат, подготовленный в качестве секрета для масштабируемого набора виртуальных машин, извлекается из хранилища службой поставщика ресурсов Microsoft. COMPUTE, используя его первую идентификацию и от имени оператора развертывания. Для автоматического переключения, которое изменится, мы перейдем к использованию управляемого удостоверения, назначенного масштабируемому набору виртуальных машин, и которому предоставляются разрешения на секреты хранилища.

Все последующие фрагменты должны быть развернуты конкомитантли — они перечислены отдельно для анализа и объяснений воспроизведения.

Сначала определите пользовательское удостоверение (значения по умолчанию включены в качестве примеров). актуальные сведения см. в [официальной документации](../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-arm.md#create-a-user-assigned-managed-identity) :
```json
{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "userAssignedIdentityName": {
      "type": "string",
      "defaultValue": "sftstuaicus",
      "metadata": {
        "description": "User-assigned managed identity name"
      }
    },
  },
  "variables": {
      "vmssApiVersion": "2018-06-01",
      "sfrpApiVersion": "2018-02-01",
      "miApiVersion": "2018-11-30",
      "kvApiVersion": "2018-02-14",
      "userAssignedIdentityResourceId": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]"
  },    
  "resources": [
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "name": "[parameters('userAssignedIdentityName')]",
      "apiVersion": "[variables('miApiVersion')]",
      "location": "[resourceGroup().location]"
    },
  ]}
```

Затем предоставьте этому удостоверению доступ к секреты хранилища. сведения о текущей информации см. в [официальной документации](/rest/api/keyvault/vaults/updateaccesspolicy) :
```json
  "resources":
  [{
      "type": "Microsoft.KeyVault/vaults/accessPolicies",
      "name": "[concat(parameters('keyVaultName'), '/add')]",
      "apiVersion": "[variables('kvApiVersion')]",
      "properties": {
        "accessPolicies": [
          {
            "tenantId": "[reference(variables('userAssignedIdentityResourceId'), variables('miApiVersion')).tenantId]",
            "objectId": "[reference(variables('userAssignedIdentityResourceId'), variables('miApiVersion')).principalId]",
            "dependsOn": [
              "[variables('userAssignedIdentityResourceId')]"
            ],
            "permissions": {
              "secrets": [
                "get",
                "list"
              ]}}]}}]
```

На следующем шаге мы будем:
  - Назначение назначенного пользователю удостоверения для масштабируемого набора виртуальных машин
  - Объявите зависимость масштабируемого набора виртуальных машин для создания управляемого удостоверения и результат предоставления ему доступа к хранилищу.
  - Объявите расширение виртуальной машины KeyVault, чтобы оно получало наблюдаемые сертификаты при запуске ([официальная документация](../virtual-machines/extensions/key-vault-windows.md))
  - Обновите определение Service Fabric расширения виртуальной машины, чтобы оно зависело от расширения КВВМ, и преобразуйте сертификат кластера в общее имя (эти изменения вносятся в один шаг, так как они попадают в область одного и того же ресурса).

```json
  "parameters": {
    "kvvmextPollingInterval": {
      "type": "string",
      "defaultValue": "3600",
      "metadata": {
        "description": "kv vm extension polling interval in seconds"
      }
    },
    "kvvmextLocalStoreName": {
      "type": "string",
      "defaultValue": "MY",
      "metadata": {
        "description": "kv vm extension local store name"
      }
    },
    "kvvmextLocalStoreLocation": {
      "type": "string",
      "defaultValue": "LocalMachine",
      "metadata": {
        "description": "kv vm extension local store location"
      }
    },
    "kvvmextObservedCertificates": {
      "type": "array",
      "defaultValue": [
                "https://sftestcus.vault.azure.net/secrets/sftstcncluster",
                "https://sftestcus.vault.azure.net/secrets/sftstcnserver"
            ],
      "metadata": {
        "description": "kv vm extension observed certificates versionless uri"
      }
    },
    "certificateCommonName": {
      "type": "string",
      "defaultValue": "cus.cluster.sftstcn.system.servicefabric.azure-int",
      "metadata": {
        "description": "Certificate Common name"
      }
    },
  },
  "resources": [
  {
    "apiVersion": "[variables('vmssApiVersion')]",
    "type": "Microsoft.Compute/virtualMachineScaleSets",
    "name": "[variables('vmNodeTypeName')]",
    "location": "[variables('computeLocation')]",
    "dependsOn": [
      "[variables('userAssignedIdentityResourceId')]",
      "[concat('Microsoft.KeyVault/vaults/', concat(parameters('keyVaultName'), '/accessPolicies/add'))]"
    ],
    "identity": {
      "type": "UserAssigned",
      "userAssignedIdentities": {
        "[variables('userAssignedIdentityResourceId')]": {}
      }
    },
    "virtualMachineProfile": {
      "extensionProfile": {
        "extensions": [
        {
          "name": "KVVMExtension",
          "properties": {
            "publisher": "Microsoft.Azure.KeyVault",
            "type": "KeyVaultForWindows",
            "typeHandlerVersion": "1.0",
            "autoUpgradeMinorVersion": true,
            "settings": {
                "secretsManagementSettings": {
                    "pollingIntervalInS": "[parameters('kvvmextPollingInterval')]",
                    "linkOnRenewal": false,
                    "observedCertificates": "[parameters('kvvmextObservedCertificates')]",
                    "requireInitialSync": true
                }
            }
          }
        },
        {
        "name": "[concat('ServiceFabricNodeVmExt','_vmNodeTypeName')]",
        "properties": {
          "type": "ServiceFabricNode",
          "provisionAfterExtensions" : [ "KVVMExtension" ],
          "publisher": "Microsoft.Azure.ServiceFabric",
          "settings": {
            "certificate": {
                "commonNames": [
                    "[parameters('certificateCommonName')]"
                ],
                "x509StoreName": "[parameters('certificateStoreValue')]"
            }
            },
            "typeHandlerVersion": "1.0"
          }
        },
  ] } ## extension profile
  },  ## VM profile
  "osProfile": {
    "adminPassword": "[parameters('adminPassword')]",
    "adminUsername": "[parameters('adminUsername')]",
  } 
  }
  ]
```
Обратите внимание, что, хотя это и не указано явно, мы удалили URL-адрес сертификата хранилища из раздела "OsProfile" масштабируемого набора виртуальных машин.
Последним шагом является обновление определения кластера для изменения объявления сертификата с отпечатка на общее имя. здесь мы также закреплять отпечатки издателя:

```json
  "parameters": {
    "certificateCommonName": {
      "type": "string",
      "defaultValue": "cus.cluster.sftstcn.system.servicefabric.azure-int",
      "metadata": {
        "description": "Certificate Common name"
      }
    },
    "certificateIssuerThumbprint": {
      "type": "string",
      "defaultValue": "1b45ec255e0668375043ed5fe78a09ff1655844d,d7fe717b5ff3593764f4d90654d86e8362ec26c8,3ac7c3cac8de0dd392c02789c8be97474f456960,96ea05926e2e42cc207e358668be2c316857fb5e",
      "metadata": {
        "description": "Certificate issuer thumbprints separated by comma"
      }
    },
  },
  "resources": [
    {
      "apiVersion": "[variables('sfrpApiVersion')]",
      "type": "Microsoft.ServiceFabric/clusters",
      "name": "[parameters('clusterName')]",
      "location": "[parameters('clusterLocation')]",
      "properties": {
        "certificateCommonNames": {
          "commonNames": [{
              "certificateCommonName": "[parameters('certificateCommonName')]",
              "certificateIssuerThumbprint": "[parameters('certificateIssuerThumbprint')]"
          }],
          "x509StoreName": "[parameters('certificateStoreValue')]"
        },
  ]
```

На этом этапе можно выполнить обновления, упомянутые выше, в одном развертывании. для его части служба поставщика ресурсов Service Fabric разделит обновление кластера в несколько шагов, как описано в разделе [Преобразование сертификатов кластера с отпечатка на общее имя](cluster-security-certificates.md#converting-a-cluster-from-thumbprint--to-common-name-based-certificate-declarations).

### <a name="analysis-and-observations"></a>Анализ и наблюдение
Этот раздел является перечислением для объяснения шагов, описанных выше, а также для привлечения внимания к важным аспектам.

#### <a name="certificate-provisioning-explained"></a>Подготовка сертификатов, описание
Расширение КВВМ в качестве агента подготовки выполняется непрерывно с предварительно заданной частотой. При сбое получения отслеживаемого сертификата он будет продолжаться в следующем расположении, а затем перейти в режим гибернации до следующего цикла. Расширение СФВМ в качестве агента начальной загрузки кластера потребует объявленных сертификатов до того, как кластер станет доступен. Это, в свою очередь, означает, что расширение СФВМ может выполняться только после успешного получения сертификатов кластера, обозначенных здесь ```json "provisionAfterExtensions" : [ "KVVMExtension" ]"``` предложением, и параметра расширения кэйваултвм ```json "requireInitialSync": true``` . Это указывает на расширение КВВМ, которое при первом запуске (после развертывания или перезагрузки) должно пройти через наблюдаемые сертификаты до тех пор, пока все они не будут успешно скачаны. Установка этого параметра в значение false в сочетании с неудачным получением сертификатов кластера приведет к сбою развертывания кластера. И наоборот, необходимость первоначальной синхронизации с неверным или недопустимым списком наблюдаемых сертификатов приведет к сбою расширения КВВМ, и опять же произойдет сбой развертывания кластера.  

#### <a name="certificate-linking-explained"></a>Связывание сертификатов, описание
Возможно, вы заметили флаг "Линконреневал" расширения КВВМ и тот факт, что он имеет значение false. Здесь мы подробно рассмотрим поведение, контролируемое этим флагом, и его влияние на работу кластера. Обратите внимание, что это поведение характерно для Windows.

В соответствии с [определением](../virtual-machines/extensions/key-vault-windows.md#extension-schema):
```json
"linkOnRenewal": <Only Windows. This feature enables auto-rotation of SSL certificates, without necessitating a re-deployment or binding.  e.g.: false>,
```

Сертификаты, используемые для установления подключения TLS, обычно задаются в [виде обработчика](/windows/win32/api/sspi/nf-sspi-acquirecredentialshandlea) через поставщик поддержки безопасности канала S-Channel, то есть клиент не обращается напрямую к закрытому ключу самого сертификата. S-Channel поддерживает перенаправление (связывание) учетных данных в форме расширения сертификата ([CERT_RENEWAL_PROP_ID](/windows/win32/api/wincrypt/nf-wincrypt-certsetcertificatecontextproperty#cert_renewal_prop_id)). Если это свойство задано, его значение представляет отпечаток сертификата "продление", и поэтому канал S-Channel будет пытаться загрузить связанный сертификат. На самом деле, он будет перемещаться по связанному списку (и, надеюсь, ациклический) до тех пор, пока не завершится с помощью окончательного сертификата — один без отметки продления. Эта функция при разумном использовании — это отличная мера снижения доступности, вызванного просроченными сертификатами (например,). В других случаях это может быть причиной сбоев, которые трудно диагностировать и устранить. S-Channel выполняет обход сертификатов в своих свойствах обновления безусловно независимо от субъекта, издателя или любых других атрибутов, участвующих в проверке результирующего сертификата клиентом. Возможно, у результирующего сертификата нет связанного закрытого ключа, или ключ не был доступен на потенциального потребителя. 
 
Если связывание включено, расширение виртуальной машины KeyVault при извлечении отслеживаемого сертификата из хранилища попытается найти совпадающие существующие сертификаты, чтобы связать их с помощью свойства продления расширения. Сопоставление (исключительно) основано на альтернативном имени субъекта (SAN) и работает как содержащиеся ниже.
Предположим, что два существующих сертификата: A: CN = "Аксессуары для Алисы", SAN = {"alice.universalexports.com"}, продление = "B: CN =" биты Боба ", SAN = {" bob.universalexports.com "," bob.universalexports.net "}, продление =" "
 
Предположим, что сертификат C извлекается с помощью КВВМ Ext: CN = "вредоносная программа Мэллори", SAN = {"alice.universalexports.com", "bob.universalexports.com", "mallory.universalexports.com"}
 
Список SAN полностью включен в C, а так далее A. продление = C. Thumbprint; Список SAN B имеет общее пересечение с C, но не полностью включено в него, поэтому б. обновление остается пустым.
 
Любая попытка вызвать AcquireCredentialsHandle (S-Channel) в этом состоянии в сертификате а фактически приведет к отправке C на удаленную сторону. В случае Service Fabric в [подсистеме транспорта](service-fabric-architecture.md#transport-subsystem) кластера используется S-Channel для взаимной проверки подлинности, поэтому описанное выше поведение влияет на фундаментальное взаимодействие кластера напрямую. Если продолжить приведенный выше пример и предполагается, что является сертификатом кластера, то что происходит в следующий зависимости:
  - Если закрытый ключ C не Аклд учетной записи, от имени которой работает структура, мы увидим, что для получения закрытого ключа (SEC_E_UNKNOWN_CREDENTIALS или аналогичного) будут отображаться ошибки.
  - Если закрытый ключ C доступен, будут отображаться ошибки авторизации, возвращенные другими узлами (Цертификатенотматчед, несанкционированный доступ и т. д.). 
 
В любом случае произойдет сбой транспорта и кластер может быть отключен. Симптомы различаются. Чтобы сделать что-то хуже, компоновка зависит от порядка продления, который определяется порядком списка наблюдаемых сертификатов расширения КВВМ, расписанием обновления в хранилище или даже временными ошибками, которые могут изменить порядок извлечения.

Для предотвращения таких инцидентов рекомендуется:
  - не смешивать San разных сертификатов хранилища; Каждый сертификат хранилища должен обслуживать отдельную цель, а их субъект и сеть SAN должны отражать это с учетом особенностей.
  - Включите общее имя субъекта в список SAN (как буквально, "CN = <subject common name> ")  
  - Если не уверены, отключите связывание при продлении сертификатов, подготовленных с помощью расширения КВВМ. 

#### <a name="why-use-a-user-assigned-managed-identity-what-are-the-implications-of-using-it"></a>Зачем использовать управляемое удостоверение, назначенное пользователем? Каковы последствия использования этой функции?
Как выявилось из фрагментов кода JSON выше, для обеспечения успеха преобразования и поддержания доступности кластера требуется определенная последовательность операций и обновлений. В частности, ресурс масштабируемого набора виртуальных машин объявляет и использует его удостоверение для получения секретов в одном из обновлений (с точки зрения пользователя). Расширение Service Fabric VM (которое загружает кластер) зависит от завершения расширения виртуальной машины KeyVault, которое зависит от успешной загрузки наблюдаемых сертификатов. Расширение КВВМ использует для доступа к хранилищу удостоверение масштабируемого набора виртуальных машин. Это означает, что политика доступа в хранилище должна быть уже обновлена до развертывания масштабируемого набора виртуальных машин. 

Чтобы ликвидировать создание управляемого удостоверения или назначить его другому ресурсу, оператор развертывания должен иметь необходимую роль (Манажедидентитйоператор) в подписке или группе ресурсов в дополнение к ролям, необходимым для управления другими ресурсами, упоминаемыми в шаблоне. 

С точки зрения безопасности Помните, что виртуальная машина (масштабируемый набор) считается границей безопасности в отношении ее удостоверения Azure. Это означает, что любое приложение, размещенное на виртуальной машине, может, в принципе, получить маркер доступа, представляющий маркеры доступа идентификации, управляемые виртуальной машиной, из конечной точки IMDS без проверки подлинности. Если вы считаете, что виртуальная машина является общей или многоклиентской средой, то, возможно, этот метод получения сертификатов кластера не указан. Тем не менее, это единственный механизм подготовки, подходящий для автоматической смены сертификатов.

## <a name="troubleshooting-and-frequently-asked-questions"></a>Устранение неполадок и часто задаваемые вопросы

*Вопрос*. как программно регистрироваться в сертификате, управляемом KeyVault?
Ответ *. Найдите*имя издателя из документации по KeyVault, а затем замените его в приведенном ниже сценарии.  
```PowerShell
  $issuerName=<depends on your PKI of choice>
    $clusterVault="sftestcus"
    $clusterCertVaultName="sftstcncluster"
    $clusterCertCN="cus.cluster.sftstcn.system.servicefabric.azure-int"
    Set-AzKeyVaultCertificateIssuer -VaultName $clusterVault -Name $issuerName -IssuerProvider $issuerName
    $distinguishedName="CN=" + $clusterCertCN
    $policy = New-AzKeyVaultCertificatePolicy `
        -IssuerName $issuerName `
        -SubjectName $distinguishedName `
        -SecretContentType 'application/x-pkcs12' `
        -Ekus "1.3.6.1.5.5.7.3.1", "1.3.6.1.5.5.7.3.2" `
        -ValidityInMonths 4 `
        -KeyType 'RSA' `
        -RenewAtPercentageLifetime 75        
    Add-AzKeyVaultCertificate -VaultName $clusterVault -Name $clusterCertVaultName -CertificatePolicy $policy
    
    # poll the result of the enrollment
    Get-AzKeyVaultCertificateOperation -VaultName $clusterVault -Name $clusterCertVaultName 
```

*Вопрос*. что происходит при выдаче сертификата необъявленным или неопределенным издателем? Где можно получить исчерпывающий список активных издателей для данной PKI?
Ответ *. Если*в объявлении сертификата указаны отпечатки издателя, а прямой издатель сертификата не включен в список закрепленных издателей, сертификат будет считаться недопустимым независимо от того, является ли его корень доверенным для клиента. Поэтому важно убедиться, что список издателей является актуальным или актуальным. Введение нового издателя — это редкое событие, которое должно быть общедоступно перед выпуском сертификатов. 

Как правило, PKI публикует и поддерживает заявление о сертификации в соответствии с IETF [RFC 7382](https://tools.ietf.org/html/rfc7382). Среди прочих сведений будут включены все активные издатели. Получение этого списка программным способом может отличаться от PKI к другому.   

Для внутренних инфраструктур Майкрософт обратитесь к внутренней документации по конечным точкам и пакетам SDK, используемым для получения полномочных издателей. ответственность за периодически проверять этот список и убедиться, что их определение кластера включает в себя *всех* ожидаемых издателей.

*Вопрос*. поддерживаются ли несколько PKI? 
Ответ *. Да*; Вы не можете объявить несколько записей CN в манифесте кластера с одним и тем же значением, но может вывести список издателей из нескольких PKI, соответствующих одному CN. Это не рекомендуемый подход, и методы прозрачности сертификатов могут препятствовать выдаче таких сертификатов. Однако, как и при переходе с одной PKI на другую, это приемлемый механизм.

*Вопрос*. что делать, если текущий сертификат кластера не выдан ЦС или не имеет предполагаемого субъекта? 
Ответ *. получите*сертификат с предполагаемой темой и добавьте его в определение кластера в качестве получателя по отпечатку. После успешного завершения обновления запустите другое обновление конфигурации кластера, чтобы преобразовать объявление сертификата в общее имя. 

[Image1]:./media/security-cluster-certificate-mgmt/certificate-journey-thumbprint.png
[Image2]:./media/security-cluster-certificate-mgmt/certificate-journey-common-name.png
