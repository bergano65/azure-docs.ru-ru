---
title: Создание трассировок производительности на стороне клиента
description: Рекомендации по профилированию производительности на стороне клиента с помощью WPF
author: florianborn71
ms.author: flborn
ms.date: 12/11/2019
ms.topic: conceptual
ms.openlocfilehash: 2a10558e76a6e9af7c7571dc4ba3d063ce3e2286
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "84021166"
---
# <a name="create-client-side-performance-traces"></a>Создание трассировок производительности на стороне клиента

Существует множество причин, по которым производительность удаленной подготовки Azure может быть неудовлетворительной. Помимо чистой производительности отрисовки на облачном сервере, в особенности качество сетевого подключения существенно влияет на работу. Сведения о профилировании производительности сервера см. в разделе [запросы производительности на стороне сервера](../overview/features/performance-queries.md).

В этой главе основное внимание уделяется выявлению потенциальных узких мест на стороне клиента с помощью *:::no-loc text="performance traces":::* .

## <a name="getting-started"></a>Начало работы

Если вы не знакомы с :::no-loc text="performance tracing"::: функциональностью Windows, в этом разделе будут упомянуты самые фундаментальные термины и приложения, которые помогут вам приступить к работе.

### <a name="installation"></a>Установка

Приложения, используемые для отслеживания с помощью ARR, — это средства общего назначения, которые можно использовать для всей разработки Windows. Они предоставляются с помощью [набора средств производительности Windows](https://docs.microsoft.com/windows-hardware/test/wpt/). Чтобы получить этот набор средств, скачайте [комплект средств для развертывания и оценки Windows](https://docs.microsoft.com/windows-hardware/get-started/adk-install).

### <a name="terminology"></a>Терминология

При поиске сведений о трассировках производительности неизбежно приходится идти на ряд терминов. Наиболее важные из них:

* `ETW`
* `ETL`
* `WPR`
* `WPA`

**ETW обозначает трассировку** [ **E**вентиляционного отверстия для **W**Windows **T**](https://docs.microsoft.com/windows/win32/etw/about-event-tracing). Это просто расширение для эффективного средства трассировки уровня ядра, встроенного в Windows. Он называется трассировкой *событий* , так как приложения, ПОДДЕРЖИВАЮЩие ETW, будут отправлять события в журнал действий, которые могут помочь в отслеживании проблем с производительностью. По умолчанию операционная система уже создает события для таких объектов, как доступ к диску, переключатели задач и т. д. Такие приложения, как ARR, также выдают пользовательские события, например сведения о пропущенных кадрах, задержке сети и т. д.

**ETL** означает, **E**что **T** **-оггинг.** Это просто означает, что трассировка была собрана (занесена в журнал) и поэтому обычно используется в качестве расширения файла для файлов, в которых хранятся данные трассировки. Таким же при выполнении трассировки обычно будет \* ETL-файл.

Язык **ЗВЧ** означает [ **W**Windows **P**водительности **R**екордер](https://docs.microsoft.com/windows-hardware/test/wpt/windows-performance-recorder) и — это имя приложения, которое запускает и останавливает запись трассировок событий. ЗВЧ принимает файл профиля ( \* . впрп), который настраивает конкретные события для записи в журнал. Такой `wprp` файл предоставляется вместе с пакетом SDK для arr. При выполнении трассировок на настольном компьютере вы можете напрямую запустить ЗВЧ. При выполнении трассировки в HoloLens обычно выполняется переход по веб-интерфейсу.

**WPA** означает [ **W**Windows **P**водительности **A**нализер](https://docs.microsoft.com/windows-hardware/test/wpt/windows-performance-analyzer) and — это имя приложения GUI, которое используется для открытия \* ETL-файлов и необходимости просеивания с помощью данных для обнаружения проблем с производительностью. WPA позволяет сортировать данные по различным критериям, отображать данные несколькими способами, подробно анализировать сведения и сопоставлять информацию.

Хотя трассировка ETL может быть создана на любом устройстве Windows (локальный компьютер, HoloLens, облачный сервер и т. д.), они обычно сохраняются на диске и анализируются с помощью WPA на настольном компьютере. ETL-файлы могут отправляться другим разработчикам для их просмотра. Имейте в виду, что конфиденциальные сведения, такие как пути к файлам и IP-адреса, могут быть захвачены в трассировках ETL. ETW можно использовать двумя способами: для записи трассировок или для анализа трассировок. Запись трассировок выполняется прямо вперед и требует минимальной настройки. Анализ трассировок с другой стороны требует от вас четкого понимания как средства WPA, так и проблем, которые вы изучаете. Общие материалы для обучения WPA будут приведены ниже, а также рекомендации по интерпретации трассировок, связанных с ARR.

## <a name="recording-a-trace-on-a-local-pc"></a>Запись трассировки на локальном компьютере

Для выявления проблем производительности ARR следует выполнять трассировку непосредственно на HoloLens, поскольку это единственный способ получить моментальный снимок истинных характеристик производительности. Однако если вы хотите выполнить трассировку без ограничений по производительности HoloLens или хотите узнать, как использовать WPA и не требуется реалистичная трассировка, вот как это сделать.

### <a name="wpr-configuration"></a>Настройка ЗВЧ

1. Запустите [:::no-loc text="Windows Performance Recorder":::](https://docs.microsoft.com/windows-hardware/test/wpt/windows-performance-recorder) из меню " *Пуск*".
1. Развернуть **Дополнительные параметры**
1. Нажмите кнопку **Добавить профили...**
1. Выберите файл *азуреремотерендерингнетворкпрофилинг. впрп*. Этот файл можно найти в пакете SDK для программы ARR в разделе *Tools/етлпрофилес*.
   Теперь профиль будет перечислен в разделе " *Настраиваемые измерения*". Убедитесь, что это единственный включенный профиль.
1. Разверните узел *"рассмотрение первого уровня"*:
    * Если все, что нужно сделать, — это запись быстрой трассировки событий сети ARR, **Отключите** этот параметр.
    * Если необходимо сопоставить события сети ARR с другими системными характеристиками, такими как использование ЦП или памяти, **включите** этот параметр.
    * Если этот параметр включен, трассировка, скорее всего, будет составлять несколько гигабайт, и ее сохранение и открытие в WPA будет длительное время.

После этого конфигурация ЗВЧ должна выглядеть следующим образом:

![Настройка ЗВЧ](./media/wpr.png)

### <a name="recording"></a>Запись

Нажмите кнопку **Пуск** , чтобы начать запись трассировки. Вы можете запускать и прекращать запись в любое время. перед этим вам не нужно закрывать приложение. Как видите, вам не нужно указывать приложение для трассировки, так как ETW всегда будет записывать трассировку для всей системы. В `wprp` файле указываются типы записываемых событий.

Нажмите кнопку **сохранить** , чтобы прерывать запись и указать место хранения ETL-файла.

Теперь у вас есть ETL-файл, который можно открыть непосредственно в WPA или отправить другому пользователю.

## <a name="recording-a-trace-on-a-hololens"></a>Запись трассировки на HoloLens

Чтобы записать трассировку на HoloLens, загрузите устройство и введите его IP-адрес в браузере, чтобы открыть *портал устройств*.

![Портал устройств](./media/wpr-hl.png)

1. В левой части экрана перейдите к разделу *производительность > Трассировка производительности*.
1. Выбор **настраиваемых профилей**
1. Откройте**:::no-loc text="Browse...":::**
1. Выберите файл *азуреремотерендерингнетворкпрофилинг. впрп*. Этот файл можно найти в пакете SDK для программы ARR в разделе *Tools/етлпрофилес*.
1. Нажмите кнопку **Начать трассировку** .
1. Теперь HoloLens записывает трассировку. Обязательно активируйте проблемы с производительностью, которые необходимо исследовать. Затем нажмите кнопку " **прерывать трассировку**".
1. Трассировка будет отображаться в нижней части веб-страницы. Щелкните значок диска в правой части, чтобы скачать ETL-файл.

Теперь у вас есть ETL-файл, который можно открыть непосредственно в WPA или отправить другому пользователю.

## <a name="analyzing-traces-with-wpa"></a>Анализ трассировок с помощью WPA

### <a name="wpa-basics"></a>Основы WPA

Анализатор производительности Windows — это стандартное средство для открытия ETL-файлов и проверки трассировок. Объяснение того, как работает WPA, выходит за рамки этой статьи. Чтобы приступить к работе, ознакомьтесь с этими ресурсами:

* Ознакомьтесь с [вводными видеоматериалами](https://docs.microsoft.com/windows-hardware/test/wpt/windows-performance-analyzer) для начала обзора.
* У самой WPA есть вкладка *Начало работы* , в которой объясняются общие шаги. Ознакомьтесь с доступными разделами. В частности, в разделе "Просмотр данных" вы получаете краткие сведения о создании графиков для конкретных данных.
* [На этом веб-сайте](https://randomascii.wordpress.com/2015/09/24/etw-central/)есть отличная информация, но не все из них применимы для начинающих.

### <a name="graphing-data"></a>Построение диаграмм данных

Чтобы приступить к работе с трассировкой ARR, лучше понять следующие компоненты.

![Диаграмма производительности](./media/wpa-graph.png)

На рисунке выше показана таблица с данными трассировки и представлением графа одних и тех же данных.

В таблице внизу Обратите внимание на желтую (золотистую) строку и синюю полосу. Можно перетаскивать эти панели и размещать их в любой позиции.

Все **столбцы слева от желтой строки** считаются **ключами**. Ключи используются для структурирования дерева в верхнем левом окне. Здесь у нас есть два *ключевых* столбца: "имя поставщика" и "имя задачи". Следовательно, древовидная структура в верхнем левом окне находится на двух уровнях. При изменении порядка столбцов или добавлении или удалении столбцов из области ключей структура в представлении в виде дерева изменяется.

**Столбцы справа от синей линии** используются для **отображения графика** в правом верхнем окне. В большинстве случаев используется только первый столбец, но для некоторых режимов графа требуется несколько столбцов данных. Для работы графов графики необходимо установить *режим агрегирования* для этого столбца. Используйте "AVG" или "Max". Режим агрегирования используется для определения значения диаграммы в заданном пикселе, когда пиксел охватывает диапазон с несколькими событиями. Это можно наблюдать, установив для параметра агрегирование значение Sum, а затем выполнив его.

Столбцы в середине не имеют специального значения.

![Представление событий](./media/wpa-event-view.png)

В *редакторе представлений "универсальные события* " можно настроить все столбцы для отображения, режим агрегирования, сортировку и столбцы, используемые в качестве ключей или для построения диаграмм. В приведенном выше примере **поле 2** включено, а поле 3-6 — отключено. Поле 2 обычно является первым *настраиваемым полем данных* события ETW и, таким же, для событий arr "фраместатистикс", которые представляют некоторое значение задержки сети. Включите другие столбцы "Field", чтобы просмотреть дополнительные значения этого события.

### <a name="presets"></a>Предустановки

Чтобы правильно проанализировать трассировку, необходимо определить собственный рабочий процесс и предпочтительное отображение данных. Тем не менее, чтобы получить краткий обзор событий, связанных с ARR, мы включаем профиль платформы защиты программного обеспечения Windows и файлы предустановок в папке *Tools/етлпрофилес*. Чтобы загрузить полный профиль, выберите *профили > применить...* в строке меню WPA или откройте панель *Мои стили* (*окно > мои предустановки*) и выберите *Импорт*. В первом случае будет настроена полная конфигурация WPA, как показано на рисунке ниже. В последнем случае предустановки будут предустанавливаться только для различных доступных конфигураций представления, и вы сможете быстро открыть представление для просмотра определенного фрагмента данных события ARR.

![Предустановки](./media/wpa-arr-trace.png)

На рисунке выше показаны представления различных событий, связанных с ARR, а также общее использование ЦП.

## <a name="next-steps"></a>Дальнейшие шаги

* [Запросы данных производительности на стороне сервера](../overview/features/performance-queries.md)
