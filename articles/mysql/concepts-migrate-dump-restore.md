---
title: Миграция с помощью дампа и восстановления — база данных Azure для MySQL
description: В этой статье описываются два распространенных способа архивации и восстановления баз данных в базе данных Azure для MySQL с помощью таких средств, как mysqldump, MySQL Workbench и PHPMyAdmin.
author: ajlam
ms.author: andrela
ms.service: mysql
ms.topic: conceptual
ms.date: 2/27/2020
ms.openlocfilehash: 7cc18980d1dddc33ddf98f06de70449dee22e2ac
ms.sourcegitcommit: 3bcce2e26935f523226ea269f034e0d75aa6693a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/23/2020
ms.locfileid: "92484599"
---
# <a name="migrate-your-mysql-database-to-azure-database-for-mysql-using-dump-and-restore"></a>Перенос базы данных MySQL в базу данных Azure для MySQL с помощью дампа и восстановления

[!INCLUDE[applies-to-single-flexible-server](includes/applies-to-single-flexible-server.md)]

В этой статье описываются два распространенных способа архивации и восстановления баз данных в базе данных Azure для MySQL:
- дамп и восстановление из командной строки (с помощью mysqldump);
- дамп и восстановление с помощью PHPMyAdmin.

## <a name="before-you-begin"></a>Перед началом
Прежде чем приступить к выполнению этого руководства, необходимо выполнить следующее:
- [создать сервер базы данных Azure для MySQL с помощью портала Azure](quickstart-create-mysql-server-database-using-azure-portal.md);
- установить на компьютере служебную программу командной строки [mysqldump](https://dev.mysql.com/doc/refman/5.7/en/mysqldump.html);
- [MySQL Workbench](https://dev.mysql.com/downloads/workbench/) или другое стороннее средство MySQL для команд dump и RESTORE.

> [!TIP]
> Если вы хотите перенести большие базы данных с размерами базы данных более 1 TBs, попробуйте использовать такие средства сообщества, как **мидумпер/милоадер** , которые поддерживают параллельный экспорт и импорт. Узнайте [, как перенести большие базы данных MySQL](https://techcommunity.microsoft.com/t5/azure-database-for-mysql/best-practices-for-migrating-large-databases-to-azure-database/ba-p/1362699).


## <a name="common-use-cases-for-dump-and-restore"></a>Распространенные варианты использования для дампа и восстановления

Наиболее распространенные варианты использования:

- **Перемещение от другого поставщика управляемых служб** — самый управляемый поставщик услуг может не предоставлять доступ к файлу физического хранилища по соображениям безопасности, поэтому для миграции необходимо выполнять логическую архивацию и восстановление.
- **Миграция из локальной среды или виртуальной машины** . база данных Azure для MySQL не поддерживает восстановление физических резервных копий, что обеспечивает логическую архивацию и восстановление в качестве единственного подхода.
- **Перемещение хранилища резервных копий из локально избыточного в геоизбыточное хранилище** . база данных Azure для MySQL позволяет настроить локально избыточное или геоизбыточное хранилище для резервного копирования только во время создания сервера. После подготовки сервера невозможно изменить тип избыточности для хранилища резервных копий. Чтобы переместить хранилище резервных копий из локально избыточного хранилища в геоизбыточное хранилище, единственным вариантом является режим дампа и восстановления. 
-  **Миграция из альтернативных ядер хранилища в InnoDB** . база данных Azure для MySQL поддерживает только подсистему хранилища InnoDB, поэтому не поддерживает альтернативные механизмы хранения. Если таблицы настроены с помощью других подсистем хранилища, преобразуйте их в формат ядра InnoDB перед перемещением в базу данных Azure для MySQL.

    Например, если у вас есть WordPress или WebApp, использующее таблицы MyISAM, то перед восстановлением в базе данных Azure для MySQL вам сначала нужно преобразовать эти таблицы в формат InnoDB путем перемещения. Используйте предложение `ENGINE=InnoDB`, чтобы задать ядро, используемое при создании таблицы, а затем передайте данные в совместимую таблицу перед восстановлением.

   ```sql
   INSERT INTO innodb_table SELECT * FROM myisam_table ORDER BY primary_key_columns
   ```
> [!Important]
> - Чтобы избежать проблем с совместимостью, должна использоваться одна версия MySQL в системах источника и назначения при дампе баз данных. Например, если вы используете существующий сервер MySQL Server версии 5.7, тогда вы должны выполнить перемещение в базу данных Azure для MySQL, настроенную на запуск версии 5.7. Команда `mysql_upgrade` не будет работать в базе данных Azure для MySQL и является неподдерживаемой. 
> - Если вам необходимо обновить все версии MySQL, используйте сначала дамп или экспорт базы данных ранней версии, чтобы получить наиболее актуальную версию MySQL в собственной среде. Затем перед выполнением перемещения в базу данных Azure для MySQL запустите `mysql_upgrade`.

## <a name="performance-considerations"></a>Вопросы производительности
Для оптимизации производительности при дампе больших баз данных мы рекомендуем ознакомиться с рекомендациями ниже.
-   Используйте параметр `exclude-triggers` в mysqldump при выполнении дампа баз данных. Исключите триггеры из файлов дампа, чтобы избежать сбоев запуска команд триггера во время восстановления данных.
-   Используйте параметр `single-transaction`, чтобы задать режим изоляции транзакций REPEATABLE READ и отправлять на сервер инструкцию SQL START TRANSACTION перед созданием дампа данных. Формирование дампа нескольких таблиц в одной транзакции приведет к использованию дополнительных ресурсов хранилища во время восстановления. Параметры `single-transaction` и `lock-tables` являются взаимоисключающими, так как LOCK TABLES приводит к неявной фиксации всех ожидающих транзакций. Для формирования дампа больших таблиц используйте параметр `single-transaction` с параметром `quick`.
-   Используйте многострочный синтаксис `extended-insert` с несколькими списками VALUE. Это позволяет уменьшить размер файла дампа и ускорить операции вставки при перезагрузке файла.
-  Используйте параметр `order-by-primary` в mysqldump при выполнении дампа баз данных, чтобы данные были добавлены в сценарий в порядке первичных ключей.
-   Используйте параметр `disable-keys` в mysqldump при выполнении дампа данных, чтобы отключить ограничения для внешнего ключа перед загрузкой. Отключение проверок внешнего ключа обеспечивает значительный прирост производительности. Включите ограничения и проверьте данные после загрузки, чтобы обеспечить целостность данных.
-   Используйте секционированные таблицы, когда это необходимо.
-   Загружайте данные в параллельном режиме. Не выполняйте слишком много параллельных операций, так как можно достигнуть лимита ресурсов. Отслеживайте ресурсы с помощью метрик, доступных на портале Azure.
-   Используйте параметр `defer-table-indexes` в mysqlpump при выполнении дампа баз данных для создания индекса после загрузки данных таблиц.
-   Используйте параметр `skip-definer` в mysqlpump, чтобы опустить определитель и предложения SQL SECURITY из инструкций создания для представлений и хранимых процедур.  При перезагрузке файла дампа создаются объекты, которые используют значения DEFINER и SQL SECURITY по умолчанию.
-   Скопируйте файлы резервной копии в большой двоичный объект Azure или хранилище Azure и выполните восстановление из них, что должно быть намного быстрее, чем восстановление через Интернет.

## <a name="create-a-database-on-the-target-azure-database-for-mysql-server"></a>Создание базы данных в целевой службе базы данных Azure для сервера MySQL Server
Создайте пустую базу данных в целевой базе данных Azure для сервера MySQL, куда необходимо перенести данные. Для создания базы данных используйте такие средства, как MySQL Workbench или mysql.exe. База данных может иметь то же имя, что и база данных, содержащая данные дампа. Вы также можете создать базу данных с другим именем.

Чтобы подключиться, найдите сведения о подключении на странице **Обзор** базы данных Azure для MySQL.

:::image type="content" source="./media/concepts-migrate-dump-restore/1_server-overview-name-login.png" alt-text="Поиск сведений о подключении на портале Azure":::

Добавьте сведения о подключении в MySQL Workbench.

:::image type="content" source="./media/concepts-migrate-dump-restore/2_setup-new-connection.png" alt-text="Поиск сведений о подключении на портале Azure":::

## <a name="preparing-the-target-azure-database-for-mysql-server-for-fast-data-loads"></a>Подготовка целевого сервера базы данных Azure для MySQL для быстрой загрузки данных
Чтобы подготовить целевой сервер базы данных Azure для MySQL для ускорения загрузки данных, необходимо изменить следующие параметры и конфигурацию сервера.
- max_allowed_packet — задайте значение 1073741824 (т. е. 1 ГБ), чтобы предотвратить проблемы с переполнением из-за длинных строк.
- slow_query_log — установите значение OFF, чтобы отключить журнал запросов с задержкой. Это позволит избежать накладных расходов, вызванных ведением журнала запросов с задержкой при загрузке данных.
- query_store_capture_mode — установите значение нет, чтобы отключить хранилище запросов. Это позволит устранить издержки, вызванные операциями выборки в хранилище запросов.
- innodb_buffer_pool_size — увеличьте масштаб сервера до 32 виртуальных ядер, оптимизированных для памяти, в разделе ценовой категории на портале во время миграции, чтобы увеличить innodb_buffer_pool_size. Innodb_buffer_pool_size можно увеличить только путем увеличения масштаба вычислений для сервера базы данных Azure для MySQL.
- innodb_io_capacity & innodb_io_capacity_max — измените значение 9000 с параметров сервера в портал Azure, чтобы улучшить использование операций ввода-вывода для оптимизации скорости миграции.
- innodb_write_io_threads & innodb_write_io_threads — замените на 4 в параметрах сервера в портал Azure, чтобы повысить скорость миграции.
- Масштабирование уровня хранилища — число операций ввода-вывода в секунду для сервера базы данных Azure для MySQL увеличиваются с увеличением уровня хранилища. Для ускорения загрузки может потребоваться увеличить уровень хранилища, чтобы увеличить число подготовленных операций ввода-вывода в секунду. Помните, что масштаб хранилища можно только увеличивать, а не уменьшать.

После завершения миграции можно вернуть параметры сервера и конфигурации уровня вычислений к предыдущим значениям.

## <a name="dump-and-restore-using-mysqldump-utility"></a>Дамп и восстановление с помощью служебной программы mysqldump

### <a name="create-a-backup-file-from-the-command-line-using-mysqldump"></a>Создание файла резервной копии из командной строки с помощью mysqldump
Чтобы создать резервную копию существующей базы данных MySQL на локальном сервере или виртуальной машине, выполните команду ниже:
```bash
$ mysqldump --opt -u [uname] -p[pass] [dbname] > [backupfile.sql]
```

Необходимо указать следующие параметры:
- [uname] — имя пользователя базы данных;
- [pass] — пароль для базы данных (обратите внимание, что между "-p" и паролем нет пробела);
- [dbname] — имя базы данных;
- [backupfile.sql] — имя файла резервной копии базы данных;
- [--opt] — параметр mysqldump.

Например, чтобы создать резервную копию базы данных с именем testdb на сервере MySQL с именем пользователя testuser и без пароля и сохранить ее в файл testdb_backup.sql, используйте приведенную ниже команду. Команда создает резервную копию базы данных `testdb` в файле с именем `testdb_backup.sql`, который содержит все инструкции SQL, необходимые для повторного создания базы данных. Убедитесь, что имя пользователя "TestUser" имеет по крайней мере права на выбор для выгруженных таблиц, ОТОБРАЖАЕТ представление для сохраненных представлений, триггер для дампов триггеров и БЛОКИРУЕТ таблицы, если параметр--Single-Transaction не используется.

```bash
GRANT SELECT, LOCK TABLES, SHOW VIEW ON *.* TO 'testuser'@'hostname' IDENTIFIED BY 'password';
```
Теперь запустите mysqldump, чтобы создать резервную копию `testdb` базы данных

```bash
$ mysqldump -u root -p testdb > testdb_backup.sql
```
Чтобы выбрать для создания резервной копии конкретные таблицы в базе данных, укажите имена этих таблиц в виде списка, разделенного пробелами. Например, чтобы создать резервную копию только для таблиц table1 и table2 из базы данных testdb, используйте этот пример:

```bash
$ mysqldump -u root -p testdb table1 table2 > testdb_tables_backup.sql
```
Чтобы создать резервную копию сразу нескольких баз данных, используйте параметр --databases и укажите имена этих баз данных в виде списка, разделенного пробелами.
```bash
$ mysqldump -u root -p --databases testdb1 testdb3 testdb5 > testdb135_backup.sql
```

### <a name="restore-your-mysql-database-using-command-line-or-mysql-workbench"></a>Восстановление базы данных MySQL с помощью командной строки или MySQL Workbench
После создания целевой базы данных можно воспользоваться командой mysql или клиентом MySQL Workbench, чтобы восстановить данные в определенную вновь созданную базу данных из файла дампа.
```bash
mysql -h [hostname] -u [uname] -p[pass] [db_to_restore] < [backupfile.sql]
```
В этом примере восстановите данные в созданную базу данных в целевой базе данных Azure для сервера MySQL Server.

Ниже приведен пример использования **MySQL** для **одного сервера** .

```bash
$ mysql -h mydemoserver.mysql.database.azure.com -u myadmin@mydemoserver -p testdb < testdb_backup.sql
```
Ниже приведен пример использования **MySQL** для **гибкого сервера** .

```bash
$ mysql -h mydemoserver.mysql.database.azure.com -u myadmin -p testdb < testdb_backup.sql
```
---

## <a name="dump-and-restore-using-phpmyadmin"></a>дамп и восстановление с помощью PHPMyAdmin.
Выполните следующие действия, чтобы выгрузить и восстановить базу данных с помощью PHPMyadmin.

> [!NOTE]
> Для одного сервера имя пользователя должно иметь формат " username@servername ", но для гибкого сервера можно просто использовать "Username" username@servername , если для гибкого сервера используется "".

### <a name="export-with-phpmyadmin"></a>Экспорт с помощью PHPMyadmin
Для экспорта можно использовать распространенный инструмент phpMyAdmin, который уже может быть установлен в вашей локальной среде. Чтобы экспортировать базу данных MySQL с помощью PHPMyAdmin, выполните следующие действия:
1. Откройте phpMyAdmin.
2. Выберите свою базу данных. Щелкните имя базы данных в списке слева.
3. Щелкните ссылку **Экспорт**. Появится страница для просмотра дампа базы данных.
4. В области экспорта щелкните ссылку **Выбрать все**, чтобы выбрать все таблицы в базе данных.
5. В области параметров SQL щелкните необходимые параметры.
6. Щелкните параметр **Сохранить как файл**, выберите соответствующий вариант сжатия, а затем нажмите кнопку **Перейти**. Появится диалоговое окно, предлагающее сохранить файл локально.

### <a name="import-using-phpmyadmin"></a>Импорт с помощью PHPMyAdmin
Импорт базы данных выполняется подобно экспорту. Выполните следующие действия:
1. Откройте phpMyAdmin.
2. На странице настройки phpMyAdmin щелкните **Добавить**, чтобы добавить базу данных Azure для сервера MySQL Server. Укажите сведения о подключении и учетные данные.
3. Создайте базу данных, присвоив ей соответствующее имя. Затем выберите эту базу данных, щелкнув ее имя в списке в левой части экрана. Чтобы перезаписать существующую базу данных, щелкните имя базы данных, установите все флажки рядом с именами таблиц, а затем выберите **Удалить**, чтобы удалить существующие таблицы.
4. Щелкните ссылку **SQL**, чтобы отобразилась страница, на которой можно ввести команды SQL или передать файл SQL.
5. Нажмите кнопку **обзора**, чтобы найти файл базы данных.
6. Нажмите кнопку **Перейти**, чтобы экспортировать резервную копию, выполнить команды SQL и повторно создать базу данных.

## <a name="known-issues"></a>Известные проблемы
Сведения об известных проблемах, советы и рекомендации см. в [блоге технического сообщества](https://techcommunity.microsoft.com/t5/azure-database-for-mysql/tips-and-tricks-in-using-mysqldump-and-mysql-restore-to-azure/ba-p/916912).

## <a name="next-steps"></a>Дальнейшие действия
- [Подключите приложения к базе данных Azure для MySQL](./howto-connection-string.md).
- Дополнительные сведения о переносе баз данных в службу "База данных Azure для MySQL" см. в [этой статье](https://aka.ms/datamigration).
- Если вы хотите перенести большие базы данных с размерами базы данных более 1 TBs, попробуйте использовать такие средства сообщества, как **мидумпер/милоадер** , которые поддерживают параллельный экспорт и импорт. Узнайте [, как перенести большие базы данных MySQL](https://techcommunity.microsoft.com/t5/azure-database-for-mysql/best-practices-for-migrating-large-databases-to-azure-database/ba-p/1362699).
