---
title: Рекомендации по разработке приложений — База данных Azure для MySQL
description: Узнайте о рекомендациях по созданию приложения с помощью базы данных Azure для MySQL.
author: mksuni
ms.author: sumuth
ms.service: mysql
ms.topic: conceptual
ms.date: 08/11/2020
ms.openlocfilehash: 93bd6972a89065832a20fbd66949cde5b7510534
ms.sourcegitcommit: c5021f2095e25750eb34fd0b866adf5d81d56c3a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/25/2020
ms.locfileid: "88794192"
---
# <a name="best-practices-for-building-an-application-with-azure-database-for-mysql"></a>Рекомендации по созданию приложения с помощью базы данных Azure для MySQL 

Ниже приведены некоторые рекомендации, которые помогут вам создать приложение, готовое к работе в облаке, с помощью базы данных Azure для MySQL. Эти рекомендации могут сократить время разработки приложения. 

## <a name="configuration-of-application-and-database-resources"></a>Настройка ресурсов приложения и базы данных

### <a name="keep-the-application-and-database-in-the-same-region"></a>Обеспечение сохранения приложения и базы данных в одном регионе
Убедитесь, что все зависимости находятся в одном регионе при развертывании приложения в Azure. Распределение экземпляров по регионам или зонам доступности создает задержку в сети, что может повлиять на общую производительность приложения. 

### <a name="keep-your-mysql-server-secure"></a>Обеспечьте безопасность сервера MySQL
Настройте сервер MySQL для [обеспечения безопасности](https://docs.microsoft.com/azure/mysql/concepts-security) и недоступности в открытых источниках. Для защиты сервера используйте один из следующих вариантов. 
- [Правила брандмауэра](https://docs.microsoft.com/azure/mysql/concepts-firewall-rules)
- [Виртуальные сети](https://docs.microsoft.com/azure/mysql/concepts-data-access-and-security-vnet) 
- [Приватный канал Azure](https://docs.microsoft.com/azure/mysql/concepts-data-access-security-private-link)

Для обеспечения безопасности необходимо всегда подключаться к серверу MySQL по протоколу SSL и настроить сервер MySQL и приложение для использования TLS 1,2. См. раздел [Настройка SSL/TLS](https://docs.microsoft.com/azure/mysql/concepts-ssl-connection-security). 

### <a name="tune-your-server-parameters"></a>Настройка параметров сервера
Для рабочих нагрузок с большим количеством операций чтения параметры сервера, `tmp_table_size` которые `max_heap_table_size` могут помочь оптимизировать производительность. Чтобы вычислить значения, необходимые для этих переменных, просмотрите общие значения памяти для каждого подключения и базовую память. Сумма параметров памяти для каждого подключения, исключая вместе `tmp_table_size` с учетными записями базовой памяти для общего объема памяти сервера.

Чтобы вычислить максимально возможный размер `tmp_table_size` и `max_heap_table_size` , используйте следующую формулу:

```(total memory - (base memory + (sum of per-connection memory * # of connections)) / # of connections```

>[!NOTE]
> Общая память указывает общий объем памяти, которую сервер использует в подготовленных виртуальных ядер.  Например, в общего назначения 2-Виртуальное ядро база данных Azure для сервера MySQL, общий объем памяти будет 5 ГБ * 2. Дополнительные сведения о памяти для каждого уровня можно найти в документации по [ценовой категории](https://docs.microsoft.com/azure/mysql/concepts-pricing-tiers) .
>
> Базовая память указывает переменные памяти, такие как `query_cache_size` и `innodb_buffer_pool_size` , которые будут инициализированы и выделяться MySQL при запуске сервера. Память для каждого подключения, например `sort_buffer_size` и `join_buffer_size` , — это память, выделенная только при необходимости запроса.

### <a name="create-non-admin-users"></a>Создание пользователей без прав администратора 
[Создание пользователей, не являющихся администраторами](https://docs.microsoft.com/azure/mysql/howto-create-users) , для каждой базы данных. Как правило, имена пользователей определяются как имена баз данных.

### <a name="reset-your-password"></a>Сброс пароля
[Сбросить пароль](https://docs.microsoft.com/azure/mysql/howto-create-manage-server-portal#update-admin-password) для сервера MySQL можно с помощью портал Azure. 

Сброс пароля сервера для рабочей базы данных может привести к отключению приложения. Рекомендуется сбрасывать пароль для всех рабочих нагрузок в нерабочее время, чтобы снизить влияние на пользователей приложения.

## <a name="performance-and-resiliency"></a>Производительность и устойчивость 
Ниже приведены некоторые средства и рекомендации, которые можно использовать для отладки проблем с производительностью приложения.

### <a name="enable-slow-query-logs-to-identify-performance-issues"></a>Включение журналов медленных запросов для обнаружения проблем с производительностью
На сервере можно включить [журналы запросов](https://docs.microsoft.com/azure/mysql/concepts-server-logs) и [аудита](https://docs.microsoft.com/azure/mysql/concepts-audit-logs) . Анализ медленных журналов запросов помогает определить узкие места производительности для устранения неполадок. 

Журналы аудита также доступны в журналах система диагностики Azure в Azure Monitor журналах, концентраторах событий Azure и учетных записях хранения. См. статью [Устранение проблем с производительностью запросов](https://docs.microsoft.com/azure/mysql/howto-troubleshoot-query-performance).

### <a name="use-connection-pooling"></a>Использование пула соединений
Управление подключениями к базе данных может оказать значительное влияние на производительность приложения в целом. Чтобы оптимизировать производительность, необходимо уменьшить количество случаев, когда устанавливаются соединения, и время установления соединений в путях кода ключей. Используйте [пулы подключений](https://docs.microsoft.com/azure/mysql/concepts-connectivity#access-databases-by-using-connection-pooling-recommended) для подключения к базе данных Azure для MySQL, чтобы повысить устойчивость и производительность. 

Для эффективного управления подключениями можно использовать пул подключений [проксискл](https://proxysql.com/) . Использование пула подключений может уменьшить время бездействия подключений и повторно использовать существующие подключения, что поможет избежать проблем. Дополнительные сведения см. в разделе [Настройка проксискл](https://techcommunity.microsoft.com/t5/azure-database-for-mysql/connecting-efficiently-to-azure-database-for-mysql-with-proxysql/ba-p/1279842) . 

### <a name="retry-logic-to-handle-transient-errors"></a>Логика повторных попыток для обработки временных ошибок
Приложение может столкнуться с [временными ошибками](https://docs.microsoft.com/azure/mysql/concepts-connectivity#handling-transient-errors) , при которых подключения к базе данных удаляются или теряются периодически. В таких ситуациях сервер работает и работает после двух повторных попыток через 5 – 10 секунд. 

Рекомендуется подождать 5 секунд перед первой попыткой. Затем выполните каждую повторную попытку, увеличив время ожидания до 60 секунд. Ограничьте максимальное количество повторных попыток, при котором приложение считает, что операция завершилась сбоем, поэтому вы можете продолжить исследование. Дополнительные сведения см. в разделе [Устранение ошибок подключения](https://docs.microsoft.com/azure/mysql/howto-troubleshoot-common-connection-issues) . 

### <a name="enable-read-replication-to-mitigate-failovers"></a>Включение репликации чтения для устранения отработки отказа
Для сценариев отработки отказа можно использовать [репликация входных данных](https://docs.microsoft.com/azure/mysql/howto-data-in-replication) . Если вы используете реплики чтения, происходит автоматическая отработка отказа между главным сервером и серверами реплики. 

Обратите внимание на задержку между главным и репликой, так как репликация выполняется асинхронно. На задержку сети может влиять множество факторов, например размер рабочей нагрузки, выполняемой на главном сервере, и задержка между центрами обработки данных. В большинстве случаев запаздывание реплики находится в диапазоне от нескольких секунд до нескольких минут.

## <a name="database-deployment"></a>Развертывание базы данных 

### <a name="configure-an-azure-database-for-mysql-task-in-your-cicd-deployment-pipeline"></a>Настройка задачи "база данных Azure для MySQL" в конвейере развертывания CI/CD
Иногда необходимо развернуть изменения в базе данных. В таких случаях можно использовать непрерывную интеграцию (CI) и непрерывную доставку (CD) с помощью [Azure pipelines](https://azure.microsoft.com/services/devops/pipelines/) и использовать задачу для [сервера MySQL](https://docs.microsoft.com/azure/devops/pipelines/tasks/deploy/azure-mysql-deployment?view=azure-devops) для обновления базы данных, запустив для нее пользовательский сценарий.

### <a name="use-an-effective-process-for-manual-database-deployment"></a>Использование эффективного процесса развертывания базы данных вручную 
При ручном развертывании базы данных выполните следующие действия, чтобы свести к минимуму время простоя или снизить риск сбоя развертывания. 

1. Создайте копию рабочей базы данных в новой базе данных с помощью [mysqldump](https://dev.mysql.com/doc/refman/8.0/en/mysqldump.html) или [MySQL Workbench](https://dev.mysql.com/doc/workbench/en/wb-admin-export-import-management.html). 
2. Обновите новую базу данных новыми изменениями схемы или обновлениями, необходимыми для базы данных. 
3. Перевод рабочей базы данных в состояние "только для чтения". В рабочей базе данных не должно быть операций записи, пока развертывание не будет завершено. 
4. Протестируйте приложение с обновленной базой данных, созданной на шаге 1.
5. Разверните изменения приложения и убедитесь, что приложение теперь использует новую базу данных с последними обновлениями. 
6. Используйте старую рабочую базу данных, чтобы можно было откатить изменения. Затем можно будет либо удалить старую рабочую базу данных, либо экспортировать ее в службу хранилища Azure, если это необходимо. 

>[!NOTE]
>Если приложение похоже на приложение электронной коммерции и его нельзя перевести в состояние только для чтения, разверните изменения непосредственно в рабочей базе данных после создания резервной копии. Эти изменения должны происходить в часы наименьшей нагрузки с низким трафиком к приложению, чтобы уменьшить влияние, поскольку некоторые пользователи могут столкнуться с неудачными запросами. 
>
>Убедитесь, что код приложения также обрабатывает все неудачные запросы.

### <a name="use-mysql-native-metrics-to-see-if-your-workload-is-exceeding-in-memory-temporary-table-sizes"></a>Используйте собственные метрики MySQL, чтобы узнать, превышает ли ваша рабочая нагрузка размеры временных таблиц в памяти.
При высокой нагрузке чтения запросы, выполняемые для сервера MySQL, могут превысить размеры временных таблиц в памяти. Рабочая нагрузка с интенсивным чтением может привести к тому, что ваш сервер переключается на запись временных таблиц на диск, что влияет на производительность приложения. Чтобы определить, будет ли сервер выполнять запись на диск в результате превышения временного размера таблицы, просмотрите следующие метрики:

```
show global status like 'created_tmp_disk_tables';
show global status like 'created_tmp_tables';
```
`created_tmp_disk_tables`Метрика показывает, сколько таблиц было создано на диске. `created_tmp_table`Метрика показывает, сколько временных таблиц должно быть сформировано в памяти, учитывая рабочую нагрузку. Чтобы определить, будет ли выполнение определенного запроса использовать временные таблицы, выполните инструкцию [объяснить](https://dev.mysql.com/doc/refman/8.0/en/explain.html) для запроса. Сведения в `extra` столбце указывают, `Using temporary` будет ли запрос выполняться с использованием временных таблиц.

Чтобы вычислить процент рабочей нагрузки с запросами, которые сбрасываются на диски, используйте значения метрик в следующей формуле:

```(created_tmp_disk_tables / (created_tmp_disk_tables + created_tmp_tables)) * 100```

В идеале этот процент должен быть менее 25%. Если вы видите, что процент равен 25% или больше, мы рекомендуем изменить два параметра сервера: tmp_table_size и max_heap_table_size.

## <a name="database-schema-and-queries"></a>Схема базы данных и запросы

Ниже приведены некоторые рекомендации, которые следует учитывать при построении схемы базы данных и запросов.

### <a name="use-the-right-datatype-for-your-table-columns"></a>Использование правильного типа данных для столбцов таблицы
С помощью правильного типа данных, основанного на типе сохраняемой информации, можно оптимизировать хранилище и сократить количество ошибок, которые могут возникать из-за неправильного ввода типов.

### <a name="use-indexes"></a>Использование индексов
Чтобы избежать снижения производительности запросов, можно использовать индексы. Индексы позволяют быстро находить строки с указанными столбцами. См. статью [Использование индексов в MySQL](https://dev.mysql.com/doc/refman/8.0/en/mysql-indexes.html).

### <a name="use-explain-for-your-select-queries"></a>Использование объяснения для запросов SELECT
Используйте `EXPLAIN` инструкцию, чтобы получить подробные сведения о том, что делает MySQL для выполнения запроса. Это поможет выявить узкие места или проблемы с запросом. См. статью [Использование объяснения для профилирования производительности запросов](https://docs.microsoft.com/azure/mysql/howto-troubleshoot-query-performance).


