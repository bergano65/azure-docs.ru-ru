---
title: Начало работы с настраиваемыми политиками в Azure Active Directory B2C | Документация Майкрософт
description: Как начать работу с настраиваемыми политиками Azure Active Directory B2C.
services: active-directory-b2c
author: davidmu1
manager: mtillman
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 09/17/2018
ms.author: davidmu
ms.component: B2C
ms.openlocfilehash: b4ff8b607f9fded02a519b5f2a3abdfeedf93d88
ms.sourcegitcommit: 5b8d9dc7c50a26d8f085a10c7281683ea2da9c10
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/26/2018
ms.locfileid: "47181790"
---
# <a name="get-started-with-custom-policies-in-azure-active-directory-b2c"></a>Начало работы с настраиваемыми политиками в Azure Active Directory B2C

[!INCLUDE [active-directory-b2c-advanced-audience-warning](../../includes/active-directory-b2c-advanced-audience-warning.md)]

[Настраиваемые политики](active-directory-b2c-overview-custom.md) — это файлы конфигурации, определяющие поведение вашего клиента Azure Active Directory (Azure AD) B2C. В рамках этой статьи вы создадите настраиваемую политику, которая будет поддерживать регистрацию и вход с помощью локальной учетной записи с использованием адреса электронной почты и пароля. Кроме того, вы подготовите среду для добавления поставщиков удостоверений (например, Facebook или Azure Active Directory).

## <a name="prerequisites"></a>Предварительные требования

Если у вас еще нет клиента Azure AD B2C, его необходимо [создать](tutorial-create-tenant.md). Он должен быть связан с вашей подпиской Azure.

## <a name="add-signing-and-encryption-keys"></a>Добавление ключей подписи и шифрования

1. Войдите на [портал Azure](https://portal.azure.com/) с правами глобального администратора клиента Azure AD B2C.
2. Убедитесь, что используете каталог, содержащий клиент Azure AD B2C, щелкнув **Фильтр каталога и подписки** в верхнем меню и выбрав каталог, содержащий ваш клиент. 

    ![Переключение на клиент Azure AD B2C](./media/active-directory-b2c-setup-fb-app/switch-directories.png)

3. Выберите **Все службы** в левом верхнем углу окна портала Azure, найдите службу **Azure AD B2C** и выберите ее.
4. На странице "Обзор" выберите **Identity Experience Framework — предварительная версия**.

### <a name="create-the-signing-key"></a>Создание ключа подписи

1. Выберите **Ключи политики**, а затем щелкните **Добавить**.
2. Для пункта **Параметры** выберите `Generate`.
3. В разделе **Имя** введите `TokenSigningKeyContainer`. Префикс `B2C_1A_` может быть добавлен автоматически.
4. Для параметра **Тип ключа** выберите **RSA**.
5. Для параметра **Использование ключа** выберите **Подпись**.
6. Нажмите кнопку **Создать**.

### <a name="create-the-encryption-key"></a>Создание ключа шифрования

1. Выберите **Ключи политики**, а затем щелкните **Добавить**.
2. Для пункта **Параметры** выберите `Generate`.
3. В разделе **Имя** введите `TokenEncryptionKeyContainer`. Префикс `B2C_1A`_ может быть добавлен автоматически.
4. Для параметра **Тип ключа** выберите **RSA**.
5. Для параметра **Использование ключа** задайте значение **Шифрование**.
6. Нажмите кнопку **Создать**.

### <a name="create-the-facebook-key"></a>Создание ключа Facebook

При наличии [секрета приложения Facebook](active-directory-b2c-setup-fb-app.md) добавьте его как ключ политики в клиенте. В противном случае создайте ключ со значением-заполнителем. Это позволит политикам проходить проверку.

1. Выберите **Ключи политики**, а затем щелкните **Добавить**.
2. Для пункта **Параметры** выберите `Manual`.
3. Для параметра **Имя** введите `FacebookSecret`. Префикс `B2C_1A_` может быть добавлен автоматически.
4. Выберите **Секрет**, введите секрет Facebook, указанный на сайте developers.facebook.com, или задайте значение `0` в качестве заполнителя. Обратите внимание, что это секрет, а не идентификатор приложения.
5. Для параметра **Использование ключа** выберите **Подпись**.
6. Нажмите кнопку **Создать**.

## <a name="register-applications"></a>Регистрация приложений

При работе с Active Directory B2C требуется зарегистрировать два приложения, используемые для регистрации и входа пользователей. IdentityExperienceFramework (веб-приложение) и ProxyIdentityExperienceFramework (встроенное приложение) с делегированным разрешением из приложения IdentityExperienceFramework. Локальные учетные записи хранятся только в клиенте. Пользователи регистрируются в системе, используя уникальное сочетание адреса электронной почты и пароля, чтобы получить доступ к зарегистрированным в клиенте приложениям.

### <a name="register-the-identityexperienceframework-application"></a>Регистрация приложения IdentityExperienceFramework

1. Выберите **Все службы** в левом верхнем углу портала Azure, найдите и выберите службу **Azure Active Directory**, а затем выберите **Регистрация приложений**.
2. Выберите **Регистрация нового приложения**.
3. Для параметра **Имя** введите `IdentityExperienceFramework`.
4. Для параметра **Тип приложения** выберите **Веб-приложение или API**.
5. Для параметра **URL-адрес для входа** введите `https://your-tenant-name.b2clogin.com/your-tenant-name.onmicrosoft.com`, где `your-tenant-name` — это доменное имя клиента Azure AD B2C.
6. Нажмите кнопку **Создать**. 
7. По завершении операции создания скопируйте идентификатор приложения и сохраните его для последующего использования.

### <a name="register-the-proxyidentityexperienceframework-application"></a>Регистрация приложения ProxyIdentityExperienceFramework

1. Щелкните **Регистрация приложений** и выберите **Регистрация нового приложения**.
2. Для параметра **Имя** введите `ProxyIdentityExperienceFramework`.
3. Для параметра **Тип приложения** выберите **Собственный**.
4. Для параметра **URI перенаправления** введите `https://your-tenant-name.b2clogin.com/your-tenant-name.onmicrosoft.com`, где `yourtenant` — это ваш клиент Azure AD B2C.
5. Нажмите кнопку **Создать**. По завершении операции создания скопируйте идентификатор приложения и сохраните его для последующего использования.
6. На странице параметров выберите **Необходимые разрешения** и щелкните **Добавить**.
7. Выберите **Выбор API**.
8. Найдите и выберите **IdentityExperienceFramework**, а затем щелкните **Выбрать**.
9. Установите флажок рядом с элементом **Access IdentityExperienceFramework** (Доступ к IdentityExperienceFramework), щелкните **Выбрать**, а затем — **Готово**.
10. Выберите **Предоставление разрешений**, затем **Да** для подтверждения.

## <a name="download-starter-pack-and-modify-policies"></a>Скачивание начального пакета и изменение политик

Настраиваемые политики — это набор XML-файлов, которые нужно отправить в клиент Azure AD B2C. Предоставляются начальные пакеты, которые позволяют быстро приступить к работе. Каждый начальный пакет из следующего списка содержит минимальное количество технических профилей и путей взаимодействия пользователей, необходимых для достижения описанных сценариев:

- LocalAccounts. Позволяет использовать только локальные учетные записи.
- SocialAccounts. Позволяет использовать только учетные записи социальных сетей (или федеративные).
- SocialAndLocalAccounts. Позволяет использовать и локальные учетные записи, и учетные записи социальных сетей.
- SocialAndLocalAccountsWithMFA. Позволяет использовать локальные учетные записи и учетные записи социальных сетей с Многофакторной идентификацией.

Каждый начальный пакет содержит:

- Базовый файл. Для базового файла требуется несколько изменений.
* Файл расширения.  В этот файл вносится большинство изменений конфигурации.
* Файлы проверяющей стороны. Файлы, запрашиваемые приложением для выполнения определенных задач.

>[!NOTE]
>Если в редакторе XML поддерживается проверка, проверьте файлы с помощью XML-файла схемы TrustFrameworkPolicy_0.3.0.0.xsd, который расположен в корневом каталоге начального пакета. При проверке по схеме XML определяются ошибки перед отправкой.

1. [Скачайте ZIP-файл](https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack/archive/master.zip) или выполните команду:

    ```console
    git clone https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack
    ```

2. В папке SocialAndLocalAccounts измените все файлы, заменив `yourtenant.onmicrosoft.com` именем вашего клиента. Например, `contosoTenant.onmicrosoft.com`. Если вам нужен редактор XML, [попробуйте Visual Studio Code](https://code.visualstudio.com/download) — упрощенный кроссплатформенный редактор.

### <a name="add-application-ids-to-the-custom-policy"></a>Добавление идентификаторов приложений в настраиваемую политику

В файл расширений *TrustFrameworkExtensions* добавьте идентификаторы приложений.

1. Откройте файл *TrustFrameworkExtensions* и найдите элемент `<TechnicalProfile Id="login-NonInteractive">`.
2. Замените оба экземпляра `IdentityExperienceFrameworkAppId` идентификатором созданного ранее приложения инфраструктуры процедур идентификации. Замените оба экземпляра `ProxyIdentityExperienceFrameworkAppId` идентификатором созданного ранее приложения прокси инфраструктуры процедур идентификации. В следующем примере показан технический профиль **login-NonInteractive** после внесения изменений:

    ![Идентификаторы приложений](./media/active-directory-b2c-get-started-custom/login-NonInteractive.png)

3. Сохраните файл расширений.

## <a name="upload-the-policies"></a>Отправка политик

1. На странице "Настраиваемые политики" инфраструктуры процедур идентификации щелкните **Отправить политику**.
1. Отправьте файлы в следующем порядке: *TrustFrameworkBase.xml*, *TrustFrameworkExtensions.xml*, *SignUpOrSignin.xml*, *ProfileEdit.xml* и *PasswordReset.xml*. При отправке к имени файла политики добавляется префикс `B2C_1A_`.

## <a name="test-the-custom-policy"></a>Проверка пользовательской политики

1. На странице "Настраиваемые политики" выберите **B2C_1A_signup_signin**. 
2. Выберите **Запустить сейчас**.

3. Вы сможете зарегистрироваться, используя адрес электронной почты.

4. Войдите в систему с помощью той же учетной записи, чтобы подтвердить правильность конфигурации.

## <a name="add-facebook-as-an-identity-provider"></a>Добавление Facebook в качестве поставщика удостоверений

1. Настройте [приложение Facebook](active-directory-b2c-setup-fb-app.md).
2. В файле *TrustFrameworkExtensions.xml* замените значение `client_id` идентификатором приложения Facebook.

   ```xml
   <TechnicalProfile Id="Facebook-OAUTH">
     <Metadata>
     <!--Replace the value of client_id in this technical profile with the Facebook app ID"-->
       <Item Key="client_id">00000000000000</Item>
   ```
3. Отправьте файл *TrustFrameworkExtensions.xml* в клиент.
4. Выполните проверку с помощью команды **Запустить сейчас** или вызовите политику непосредственно из зарегистрированного приложения.

## <a name="next-steps"></a>Дальнейшие действия

- Добавьте Azure Active Directory в качестве поставщика удостоверений. В базовом файле, который использовался в этом руководстве по началу работы, уже имеется некоторое содержимое, необходимое для добавления других поставщиков удостоверений. Сведения о настройке входа в систему см. в статье [Azure Active Directory B2C. Выполнение входа с помощью учетных записей Azure AD](active-directory-b2c-setup-aad-custom.md).
