---
title: Определение настраиваемых атрибутов в Azure Active Directory B2C | Документация Майкрософт
description: Определите настраиваемые атрибуты в Azure Active Directory B2C для сбора данных о клиентах.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: how-to
ms.date: 12/14/2020
ms.custom: project-no-code
ms.author: mimart
ms.subservice: B2C
zone_pivot_groups: b2c-policy-type
ms.openlocfilehash: 9759c1109c7be279520fa187bd3366bcac505d46
ms.sourcegitcommit: 2ba6303e1ac24287762caea9cd1603848331dd7a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/15/2020
ms.locfileid: "97503749"
---
# <a name="define-custom-attributes-in-azure-active-directory-b2c"></a>Определение настраиваемых атрибутов в Azure Active Directory B2C

[!INCLUDE [active-directory-b2c-choose-user-flow-or-custom-policy](../../includes/active-directory-b2c-choose-user-flow-or-custom-policy.md)]

В статье [Добавление утверждений и настройка вводимых пользователем данных с помощью пользовательских политик](configure-user-input.md) вы узнаете, как использовать встроенные [атрибуты профиля пользователя](user-profile-attributes.md). В этой статье вы включите настраиваемый атрибут в каталог Azure Active Directory B2C (Azure AD B2C). Позже можно использовать новый атрибут в качестве настраиваемого утверждения в пользовательских [потоках](user-flow-overview.md) или [пользовательских политиках](custom-policy-get-started.md) одновременно.

Каталог Azure AD B2C поставляется со [встроенным набором атрибутов](user-profile-attributes.md). Однако часто приходится создавать собственные атрибуты для управления конкретным сценарием, например:

* Приложению, ориентированному на клиента, необходимо сохранить атрибут **лойалтид** .
* Поставщик удостоверений имеет уникальный идентификатор пользователя **уникуеусергуид**, который должен быть сохранен.
* Пользовательский путь взаимодействия пользователя должен сохранить состояние пользователя **migrationStatus** для выполнения другой логики.

Azure AD B2C позволяет расширить набор атрибутов, хранящихся в каждой учетной записи пользователя. Эти атрибуты можно также считывать и записывать с помощью [Microsoft API Graph](manage-user-accounts-graph-api.md).

## <a name="prerequisites"></a>Предварительные требования

[!INCLUDE [active-directory-b2c-customization-prerequisites](../../includes/active-directory-b2c-customization-prerequisites.md)]

## <a name="create-a-custom-attribute"></a>Создание настраиваемого атрибута

1. Войдите на [портал Azure](https://portal.azure.com/) с правами глобального администратора клиента Azure AD B2C.
1. Убедитесь, что используется каталог с вашим клиентом Azure AD B2C, переключившись на него в правом верхнем углу окна портала Azure. Выберите сведения о подписке, а затем выберите **Переключение каталога**.
1. Выберите **Все службы** в левом верхнем углу окна портала Azure, найдите службу **Azure AD B2C** и выберите ее.
1. Выберите **Атрибуты пользователя**, а затем щелкните **Добавить**.
1. Введите **Имя** настраиваемого атрибута (например, ShoeSize).
1. Выберите **Тип данных**. Здесь доступны только варианты **String**, **Boolean** и **Int**.
1. При желании введите **Описание**, которое используется только в информационных целях.
1. Нажмите кнопку **Создать**.

Настраиваемый атрибут теперь доступен в списке **атрибутов пользователя** и используется в потоках пользователя. Настраиваемый атрибут создается только при первом использовании в любом потоке пользователя, но не при его добавлении в список **атрибутов пользователя**.

::: zone pivot="b2c-user-flow"

## <a name="use-a-custom-attribute-in-your-user-flow"></a>Использование настраиваемого атрибута в потоке пользователя

1. В клиенте Azure AD B2C выберите **Потоки пользователей**.
1. Откройте политику (например B2C_1_SignupSignin), щелкнув ее.
1. Выберите **Атрибуты пользователя**, а затем — настраиваемый атрибут (например, ShoeSize). Нажмите кнопку **Сохранить**.
1. Щелкните **Утверждения приложения** и выберите настраиваемый атрибут.
1. Нажмите кнопку **Сохранить**.

После создания нового пользователя с помощью пользовательского потока, использующего только что созданный настраиваемый атрибут, объект можно запросить в [Microsoft Graph Explorer](https://developer.microsoft.com/graph/graph-explorer). Кроме того, можно использовать функцию « [Запуск потока пользователя](./tutorial-create-user-flows.md) » в потоке пользователя, чтобы проверить работу клиента. Теперь вы увидите **ShoeSize** в списке атрибутов, собираемых в процессе регистрации, а также в токене, возвращаемом в приложение.

::: zone-end

## <a name="azure-ad-b2c-extensions-app"></a>Приложение Azure AD B2C Extensions

Атрибуты расширения могут быть зарегистрированы только в объекте приложения, даже если они могут содержать данные для пользователя. Атрибут расширения прикрепляется к приложению с именем b2c-extensions-app. Не изменяйте это приложение, поскольку оно используется Azure AD B2C для хранения данных пользователя. Это приложение можно найти в разделе Azure AD B2C, регистрация приложений.

В контексте этой статьи *свойство расширения*, *настраиваемый атрибут* и *пользовательское утверждение* подразумевают одно и то же. Имя изменяется в зависимости от контекста, например приложения, объекта, политики.

## <a name="get-the-application-properties"></a>Получение свойств приложения

1. Войдите на [портал Azure](https://portal.azure.com).
1. Выберите фильтр **Каталог и подписка** в верхнем меню, а затем выберите каталог, содержащий клиент Azure AD B2C.
1. В меню слева выберите **Azure AD B2C**. Либо щелкните **Все службы**, а затем найдите и выберите **Azure AD B2C**
1. Выберите **Регистрация приложений**, а затем выберите **все приложения**.
1. Выберите приложение `b2c-extensions-app. Do not modify. Used by AADB2C for storing user data.`.
1. Скопируйте следующие идентификаторы в буфер обмена и сохраните их.
    * **Идентификатор приложения**. Например, `11111111-1111-1111-1111-111111111111`.
    * **Идентификатор объекта**. Например, `22222222-2222-2222-2222-222222222222`.

## <a name="using-custom-attribute-with-ms-graph-api"></a>Использование настраиваемого атрибута с MS API Graph

Microsoft Graph API поддерживает создание и обновление пользователя с помощью атрибутов расширения. Атрибуты расширения в API Graph именуются с помощью соглашения `extension_ApplicationClientID_attributename` , где `ApplicationClientID` — это **идентификатор приложения (клиента)** `b2c-extensions-app` приложения. Обратите внимание, что **идентификатор приложения (клиента)** , представленный в имени атрибута расширения, не включает дефисы. Пример:

```json
"extension_831374b3bd5041bfaa54263ec9e050fc_loyaltyNumber": "212342"
``` 

::: zone pivot="b2c-custom-policy"

## <a name="modify-your-custom-policy"></a>Изменение настраиваемой политики

Чтобы включить настраиваемые атрибуты в политике, укажите **идентификатор приложения** и **идентификатор объекта** приложения в AAD-Common метаданных технического профиля. Технический профиль *AAD-Common* находится в основном [Azure Active Directory](active-directory-technical-profile.md) техническом профиле и обеспечивает поддержку управления пользователями в Azure AD. Другие технические профили Azure AD включают AAD-Common, чтобы использовать его конфигурацию. Переопределите AAD-Common технический профиль в файле расширения.

1. Откройте файл расширения для политики, например <em>`SocialAndLocalAccounts/`**`TrustFrameworkExtensions.xml`**</em>.
1. Найдите элемент ClaimsProviders. Добавьте новый поставщика утверждений в элемент Клаимспровидерс.
1. Замените на `ApplicationObjectId` идентификатор объекта, который вы записали ранее. Затем замените `ClientId` идентификатором приложения, записанным ранее в следующем фрагменте кода.

    ```xml
    <ClaimsProvider>
      <DisplayName>Azure Active Directory</DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="AAD-Common">
          <Metadata>
            <!--Insert b2c-extensions-app application ID here, for example: 11111111-1111-1111-1111-111111111111-->  
            <Item Key="ClientId"></Item>
            <!--Insert b2c-extensions-app application ObjectId here, for example: 22222222-2222-2222-2222-222222222222-->
            <Item Key="ApplicationObjectId"></Item>
          </Metadata>
        </TechnicalProfile>
      </TechnicalProfiles> 
    </ClaimsProvider>
    ```

## <a name="upload-your-custom-policy"></a>Отправка настраиваемой политики

1. Войдите на [портал Azure](https://portal.azure.com).
2. Убедитесь, что вы используете каталог, содержащий клиент Azure AD, выбрав фильтр " **каталог и подписка** " в верхнем меню и выбрав Каталог, содержащий клиент Azure AD B2C.
3. Выберите **Все службы** в левом верхнем углу окна портала Azure, а затем найдите и выберите **Регистрация приложений**.
4. Выберите **Инфраструктура процедур идентификации**.
5. Выберите **Отправить настраиваемую политику**, а затем отправьте измененные файлы политики TrustFrameworkExtensions.xml.

> [!NOTE]
> В первый раз, когда технический профиль Azure AD сохраняет утверждение в каталоге, он проверяет, существует ли настраиваемый атрибут. В противном случае он создает настраиваемый атрибут.  

## <a name="create-a-custom-attribute-through-azure-portal"></a>Создание настраиваемого атрибута с помощью портал Azure

Одни и те же атрибуты расширения являются общими для встроенных и пользовательских политик. При добавлении настраиваемых атрибутов с помощью портала эти атрибуты регистрируются с помощью **B2C-Extensions-App** , которые существуют в каждом клиенте B2C.

Эти атрибуты можно создать с помощью пользовательского интерфейса портала до или после их использования в пользовательских политиках. При создании атрибута **лойалтид** на портале необходимо ссылаться на него следующим образом:

|Имя     |Используется в |
|---------|---------|
|`extension_loyaltyId`  | Настраиваемая политика|
|`extension_<b2c-extensions-app-guid>_loyaltyId`  | [API Microsoft Graph](manage-user-accounts-graph-api.md)|

В следующем примере показано использование настраиваемых атрибутов в определении утверждения настраиваемой политики Azure AD B2C.

```xml
<BuildingBlocks>
  <ClaimsSchema>
    <ClaimType Id="extension_loyaltyId">
      <DisplayName>Loyalty Identification</DisplayName>
      <DataType>string</DataType>
      <UserHelpText>Your loyalty number from your membership card</UserHelpText>
      <UserInputType>TextBox</UserInputType>
    </ClaimType>
  </ClaimsSchema>
</BuildingBlocks>
```

В следующем примере демонстрируется использование настраиваемого атрибута в Azure AD B2C настраиваемой политики в техническом профиле, вводе, выходе и материализованных утверждениях.

```xml
<InputClaims>
  <InputClaim ClaimTypeReferenceId="extension_loyaltyId"  />
</InputClaims>
<PersistedClaims>
  <PersistedClaim ClaimTypeReferenceId="extension_loyaltyId" />
</PersistedClaims>
<OutputClaims>
  <OutputClaim ClaimTypeReferenceId="extension_loyaltyId" />
</OutputClaims>
```

::: zone-end

## <a name="next-steps"></a>Дальнейшие действия

Следуйте указаниям по [добавлению утверждений и настройке пользовательского ввода с помощью пользовательских политик](configure-user-input.md). В этом образце используется встроенное утверждение "City". Чтобы использовать настраиваемый атрибут, замените City на собственные настраиваемые атрибуты.