---
title: Настройка поведения сеанса — Azure Active Directory B2C | Документация Майкрософт
description: Узнайте, как настроить поведение сеанса в Azure Active Directory B2C.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: how-to
ms.date: 12/14/2020
ms.author: mimart
ms.subservice: B2C
zone_pivot_groups: b2c-policy-type
ms.openlocfilehash: de0f4824cb23a37f37d3834dce67eb0b7edf0b15
ms.sourcegitcommit: 2ba6303e1ac24287762caea9cd1603848331dd7a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/15/2020
ms.locfileid: "97503249"
---
# <a name="configure-session-behavior-in-azure-active-directory-b2c"></a>Настройка поведения сеанса в Azure Active Directory B2C

[!INCLUDE [active-directory-b2c-choose-user-flow-or-custom-policy](../../includes/active-directory-b2c-choose-user-flow-or-custom-policy.md)]

Единый вход (SSO) обеспечивает безопасность и удобство при входе пользователей в приложения в Azure Active Directory B2C (Azure AD B2C). В этой статье описываются методы единого входа, используемые в Azure AD B2C и помогающие выбрать наиболее подходящий метод единого входа при настройке политики.

С помощью единого входа пользователи могут войти один раз с одной учетной записью и получить доступ к нескольким приложениям. Приложение может быть веб-приложением, мобильным или одностраничным, независимо от платформы или имени домена.

Когда пользователь изначально входит в приложение, Azure AD B2C сохраняет сеанс на основе файла cookie. При последующих запросах проверки подлинности Azure AD B2C считывает и проверяет сеанс на основе файлов cookie и выдает маркер доступа без запроса пользователя на вход. Если сеанс на основе файлов cookie истекает или становится недействительным, пользователю предлагается выполнить вход еще раз.  

## <a name="prerequisites"></a>Предварительные требования

[!INCLUDE [active-directory-b2c-customization-prerequisites](../../includes/active-directory-b2c-customization-prerequisites.md)]

## <a name="azure-ad-b2c-session-overview"></a>Общие сведения о Azure AD B2C сеансе

Интеграция с Azure AD B2C включает три типа сеансов единого входа:

- **Azure AD B2C** — сеанс, управляемый Azure AD B2C
- **Федеративный поставщик удостоверений** — сеанс, управляемый поставщиком удостоверений, например Facebook, Salesforce или учетная запись Майкрософт
- Сеанс **приложения** , управляемый веб-, мобильным приложением или одностраничное приложение

![Сеанс единого входа](media/session-behavior/sso-session-types.png)

### <a name="azure-ad-b2c-session"></a>Azure AD B2C сеанс 

При успешной проверке подлинности пользователя с локальной или социальной учетной записью Azure AD B2C сохраняет сеанс на основе файлов cookie в браузере пользователя. Файл cookie хранится в доменном имени клиента Azure AD B2C, например `https://contoso.b2clogin.com` .

Если пользователь изначально выполняет вход с помощью федеративной учетной записи, а затем во время сеанса (срок жизни или TTL) входит в то же приложение или другое приложение, Azure AD B2C пытается получить новый маркер доступа от федеративного поставщика удостоверений. Если срок действия сеанса федеративного поставщика удостоверений истек или недопустим, то поставщик федеративных удостоверений запрашивает у пользователя свои учетные данные. Если сеанс все еще активен (или если пользователь выполнил вход с локальной учетной записью вместо федеративной учетной записи), Azure AD B2C авторизует пользователя и не выводит дальнейшие запросы.

Можно настроить поведение сеанса, включая срок жизни сеанса, а также то, как Azure AD B2C использует сеанс совместно с политиками и приложениями.

### <a name="federated-identity-provider-session"></a>Сеанс федеративного поставщика удостоверений

Социальные или корпоративные поставщики удостоверений управляют собственным сеансом. Файл cookie хранится в доменном имени поставщика удостоверений, например `https://login.salesforce.com` . Azure AD B2C не управляет сеансом федеративного поставщика удостоверений. Вместо этого поведение сеанса определяется федеративным поставщиком удостоверений. 

Рассмотрим следующий сценарий.

1. Пользователь входит в Facebook для проверки канала.
2. Позже пользователь откроет приложение и начнет процесс входа. Приложение перенаправляет пользователя в Azure AD B2C для завершения процесса входа.
3. На странице Регистрация или вход Azure AD B2C пользователь выбирает вход с использованием учетной записи Facebook. Пользователь перенаправляется на Facebook. Если в Facebook есть активный сеанс, пользователь не будет получать запрос на ввод учетных данных и сразу же перенаправится на Azure AD B2C с маркером Facebook.

### <a name="application-session"></a>Сеанс приложения

Приложение, которое может быть защищено с помощью доступа OAuth, маркеров идентификации или SAML-токенов, можно защитить через Интернет, на мобильные устройства или на отдельные страницы. Когда пользователь пытается получить доступ к защищенному ресурсу в приложении, приложение проверяет наличие активного сеанса на стороне приложения. Если сеанс приложения отсутствует или срок действия сеанса истек, приложение перейдет на страницу входа Azure AD B2C.

Сеанс приложения может быть сеансом на основе файлов cookie, хранящимся в имени домена приложения, например `https://contoso.com` . В мобильных приложениях сеанс может храниться по-другому, но с помощью аналогичного подхода.

## <a name="configure-azure-ad-b2c-session-behavior"></a>Настройка поведения сеанса Azure AD B2C

Поведение сеанса Azure AD B2C можно настроить, включая:

- **Время существования сеанса веб-приложения (в минутах)** — время, в течение которого файл cookie сеанса Azure AD B2C хранится в браузере пользователя после успешной проверки подлинности. Время жизни сеанса можно установить в интервале от 15 до 720 минут.

- **Время ожидания сеанса веб-приложения** — указывает, как сеанс расширяется параметром времени жизни сеанса или параметром "всегда оставаться в системе".
  - **Пошаговое — указывает** , что сеанс увеличивается каждый раз, когда пользователь выполняет проверку подлинности на основе файлов cookie (по умолчанию).
  - **Absolute** — указывает, что пользователь вынужден пройти повторную проверку подлинности по истечении указанного периода времени.

- **Настройка единого входа** . для сеанса Azure AD B2C можно настроить следующие области:
  - **Клиент**. Это значение по умолчанию. Если выбрано это значение, несколько приложений и потоков пользователя в клиенте B2C могут совместно использовать один и тот же сеанс пользователя. Например, когда пользователь выполняет вход в приложение, он также может без труда войти в другой пользователь при обращении к нему.
  - **Приложение**. Значение этого параметра позволяет поддерживать сеанс пользователя исключительно для одного приложения и независимо от других приложений. Например, этот параметр можно использовать, если вы хотите, чтобы пользователь вошел в Contoso фармацевтической независимо от того, входит ли пользователь в Contoso Гроцериес.
  - **Политика**. Этот параметр позволяет поддерживать эксклюзивный сеанс пользователя для определенного потока пользователя, независимо от использующих его приложений. Например, если пользователь уже выполнил вход и выполнил шаг многофакторной проверки подлинности (MFA), ему может быть предоставлен доступ к частям с более высоким уровнем безопасности в нескольких приложениях, если срок действия сеанса, привязанного к потоку пользователя, не истекает.
  - **Отключено** — этот параметр заставляет пользователя выполнять весь поток пользователя при каждом выполнении политики.
::: zone pivot="b2c-custom-policy"
- **Оставаться в** системе — расширяет время жизни сеанса за счет использования постоянного файла cookie. Сеанс остается активным после того, как пользователь закроет и снова откроет браузер. Сеанс отменяется, только когда пользователь выходит из него. Функция "оставаться в системе" применяется только для входа с локальными учетными записями. Функция "оставаться в системе" имеет приоритет над временем жизни сеанса. Если функция "оставаться в системе" включена и пользователь выбрал ее, эта функция определяет время истечения срока действия сеанса. 
::: zone-end

::: zone pivot="b2c-user-flow"

Чтобы настроить поведение сеанса, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com).
1. Убедитесь, что вы используете каталог, содержащий клиент Azure AD B2C, выбрав фильтр " **каталог и подписка** " в верхнем меню и выбрав Каталог, содержащий ваш клиент Azure AD B2C.
1. Выберите **Все службы** в левом верхнем углу окна портала Azure, а затем найдите и выберите **Azure AD B2C**.
1. Выберите **Потоки пользователей**.
1. Откройте созданный ранее пользовательский поток.
1. Выберите **Свойства**.
1. Настройте **время существования сеанса веб-приложения (в минутах)**, **время ожидания сеанса веб-приложения**, **конфигурацию единого входа** и **требование маркера идентификатора при необходимости в запросах на выход** .
1. Нажмите кнопку **Сохранить**.

::: zone-end

::: zone pivot="b2c-custom-policy"

Чтобы изменить конфигурации режима работы сеанса и SSO, добавьте элемент **UserJourneyBehaviors** в элемент [RelyingParty](relyingparty.md).  Элемент **UserJourneyBehaviors** должен сразу же следовать за элементом **DefaultUserJourney**. Элемент **усержаурнэйбехаворс** должен выглядеть, как в следующем примере:

```xml
<UserJourneyBehaviors>
   <SingleSignOn Scope="Application" />
   <SessionExpiryType>Absolute</SessionExpiryType>
   <SessionExpiryInSeconds>86400</SessionExpiryInSeconds>
</UserJourneyBehaviors>
```

## <a name="enable-keep-me-signed-in-kmsi"></a>Включить оставаться в системе (функции "оставаться)

Вы можете включить функцию "оставаться в системе" для пользователей вашего веб-приложения и собственных приложений с локальными учетными записями в каталоге Azure Active Directory B2C (Azure AD B2C). Эта функция предоставляет пользователям доступ к приложению без запроса на повторное ввод имени пользователя и пароля. Доступ отменяется, когда пользователь выходит из системы.

![Пример страницы входа, на которой отображается флажок "оставаться в системе"](./media/session-behavior/keep-me-signed-in.png)

Пользователям не следует включать этот параметр на общедоступных компьютерах.

### <a name="configure-the-page-identifier"></a>Настройка идентификатора страницы

Чтобы включить функции "оставаться, задайте `DataUri` для элемента определения содержимого [идентификатор страницы](contentdefinitions.md#datauri) `unifiedssp` и [версию страницы](page-layout.md) *1.1.0* или выше.

1. Откройте файл расширения политики. например <em>`SocialAndLocalAccounts/`**`TrustFrameworkExtensions.xml`**</em>. Этот файл расширения является одним из файлов политики, включенных в начальный пакет пользовательской политики, который должен быть получен в предварительных требованиях, приступить [к работе с настраиваемыми политиками](custom-policy-get-started.md).
1. Найдите элемент **BuildingBlocks**. Если такой элемент не существует, добавьте его.
1. Добавьте элемент **ContentDefinitions** в элемент **BuildingBlocks** политики.

    Ваша пользовательская политика должна выглядеть, как в следующем фрагменте кода:

    ```xml
    <BuildingBlocks>
      <ContentDefinitions>
        <ContentDefinition Id="api.signuporsignin">
          <DataUri>urn:com:microsoft:aad:b2c:elements:unifiedssp:1.1.0</DataUri>
        </ContentDefinition>
      </ContentDefinitions>
    </BuildingBlocks>
    ```

### <a name="add-the-metadata-to-the-self-asserted-technical-profile"></a>Добавление метаданных в самостоятельно утвержденный технический профиль

Чтобы добавить флажок функции "оставаться на страницу регистрации и входа, установите `setting.enableRememberMe` для метаданных значение true. Переопределите технические профили SelfAsserted-Локалаккаунтсигнин-email в файле расширения.

1. Найдите элемент ClaimsProviders. Если такой элемент не существует, добавьте его.
1. Добавьте в элемент Клаимспровидерс следующий поставщик утверждений:

```xml
<ClaimsProvider>
  <DisplayName>Local Account</DisplayName>
  <TechnicalProfiles>
    <TechnicalProfile Id="SelfAsserted-LocalAccountSignin-Email">
      <Metadata>
        <Item Key="setting.enableRememberMe">True</Item>
      </Metadata>
    </TechnicalProfile>
  </TechnicalProfiles>
</ClaimsProvider>
```

1. Сохраните файл расширений.

### <a name="configure-a-relying-party-file"></a>Настройка файла проверяющей стороны

Обновите файл проверяющей стороны, который активирует созданный путь взаимодействия пользователя.

1. Откройте файл настраиваемой политики. Например, *SignUpOrSignin.xml*.
1. Добавьте `<UserJourneyBehaviors>` в узел дочерний узел, если он еще не создан `<RelyingParty>` . Он должен располагаться сразу после `<DefaultUserJourney ReferenceId="User journey Id" />` , например: `<DefaultUserJourney ReferenceId="SignUpOrSignIn" />` .
1. Добавьте следующий узел в качестве дочернего узла элемента `<UserJourneyBehaviors>`.

    ```xml
    <UserJourneyBehaviors>
      <SingleSignOn Scope="Tenant" KeepAliveInDays="30" />
      <SessionExpiryType>Absolute</SessionExpiryType>
      <SessionExpiryInSeconds>1200</SessionExpiryInSeconds>
    </UserJourneyBehaviors>
    ```

Рекомендуется установить значение Сессионекспиринсекондс на короткий период (1200 секунд), а значение Кипаливеиндайс можно задать относительно длительный период (30 дней), как показано в следующем примере:

```xml
<RelyingParty>
  <DefaultUserJourney ReferenceId="SignUpOrSignIn" />
  <UserJourneyBehaviors>
    <SingleSignOn Scope="Tenant" KeepAliveInDays="30" />
    <SessionExpiryType>Absolute</SessionExpiryType>
    <SessionExpiryInSeconds>1200</SessionExpiryInSeconds>
  </UserJourneyBehaviors>
  <TechnicalProfile Id="PolicyProfile">
    <DisplayName>PolicyProfile</DisplayName>
    <Protocol Name="OpenIdConnect" />
    <OutputClaims>
      <OutputClaim ClaimTypeReferenceId="displayName" />
      <OutputClaim ClaimTypeReferenceId="givenName" />
      <OutputClaim ClaimTypeReferenceId="surname" />
      <OutputClaim ClaimTypeReferenceId="email" />
      <OutputClaim ClaimTypeReferenceId="objectId" PartnerClaimType="sub"/>
      <OutputClaim ClaimTypeReferenceId="identityProvider" />
      <OutputClaim ClaimTypeReferenceId="tenantId" AlwaysUseDefaultValue="true" DefaultValue="{Policy:TenantObjectId}" />
    </OutputClaims>
    <SubjectNamingInfo ClaimType="sub" />
  </TechnicalProfile>
</RelyingParty>
```

::: zone-end

## <a name="sign-out"></a>Функция выхода

Если вы хотите подписать пользователя из приложения, достаточно очистить файлы cookie приложения или иным способом завершить сеанс с пользователем. Необходимо перенаправить пользователя в Azure AD B2C для выхода. В противном случае пользователь может повторно пройти проверку подлинности в приложениях без повторного ввода учетных данных.

При запросе выхода Azure AD B2C:

1. Делает недействительным сеанс на основе файла cookie Azure AD B2C.
::: zone pivot="b2c-user-flow"
2. Попытки выхода из федеративных поставщиков удостоверений
::: zone-end
::: zone pivot="b2c-custom-policy"
3. Пытается выйти из федеративных поставщиков удостоверений:
   - OpenID Connect Connect — если конечная точка хорошо известной конфигурации поставщика удостоверений указывает `end_session_endpoint` расположение.
   - OAuth2 — если [метаданные поставщика удостоверений](oauth2-technical-profile.md#metadata) содержат `end_session_endpoint` расположение.
   - SAML — если [метаданные поставщика удостоверений](saml-identity-provider-technical-profile.md#metadata) содержат `SingleLogoutService` расположение.
4. При необходимости выходит из других приложений. Дополнительные сведения см. в разделе [единый выход](#single-sign-out) .

> [!NOTE]
> Вы можете отключить выход из федеративных поставщиков удостоверений, установив метаданные технического профиля поставщика удостоверений в значение `SingleLogoutEnabled` `false` .
::: zone-end

При выходе выполняется очистка состояния единого входа пользователя с Azure AD B2C, но пользователь не может выйти из сеанса поставщика удостоверений социальных сетей. Если пользователь выбирает одного и того же поставщика удостоверений во время последующего входа, он может выполнить повторную проверку подлинности без ввода учетных данных. Если пользователь хочет выйти из приложения, это не обязательно означает, что нужно выйти из своей учетной записи Facebook. Однако если используются локальные учетные записи, то сеанс пользователя завершается правильно.

::: zone pivot="b2c-custom-policy"

### <a name="single-sign-out"></a>Единый выход 

При перенаправлении пользователя в конечную точку выхода Azure AD B2C (для протоколов OAuth2 и SAML) Azure AD B2C очищает сеанс пользователя из браузера. Однако пользователь по-прежнему может войти в другие приложения, использующие Azure AD B2C для проверки подлинности. Чтобы разрешить этим приложениям одновременный выход пользователя из приложения, Azure AD B2C отправляет запрос HTTP GET зарегистрированным `LogoutUrl` во всех приложениях, на которые пользователь вошел в систему.

Приложения должны ответить на него, удалив любой сеанс, который идентифицирует пользователя, и возвратив ответ `200`. Если вы хотите поддерживать единый выход в приложении, необходимо реализовать `LogoutUrl` в коде приложения. 

Для поддержки единого выхода в технический профиль издателя маркера для JWT и SAML необходимо указать:

- Имя протокола, например `<Protocol Name="OpenIdConnect" />`
- Ссылка на технический профиль сеанса, например `UseTechnicalProfileForSessionManagement ReferenceId="SM-OAuth-issuer" />` .

В следующем примере показаны издатели маркеров JWT и SAML с единым выходом:

```xml
<ClaimsProvider>
  <DisplayName>Local Account SignIn</DisplayName>
  <TechnicalProfiles>
    <!-- JWT Token Issuer -->
    <TechnicalProfile Id="JwtIssuer">
      <DisplayName>JWT token Issuer</DisplayName>
      <Protocol Name="OpenIdConnect" />
      <OutputTokenFormat>JWT</OutputTokenFormat>
      ...    
      <UseTechnicalProfileForSessionManagement ReferenceId="SM-OAuth-issuer" />
    </TechnicalProfile>

    <!-- Session management technical profile for OIDC based tokens -->
    <TechnicalProfile Id="SM-OAuth-issuer">
      <DisplayName>Session Management Provider</DisplayName>
      <Protocol Name="Proprietary" Handler="Web.TPEngine.SSO.OAuthSSOSessionProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
    </TechnicalProfile>

    <!--SAML token issuer-->
    <TechnicalProfile Id="Saml2AssertionIssuer">
      <DisplayName>SAML token issuer</DisplayName>
      <Protocol Name="SAML2" />
      <OutputTokenFormat>SAML2</OutputTokenFormat>
      ...
      <UseTechnicalProfileForSessionManagement ReferenceId="SM-Saml-issuer" />
    </TechnicalProfile>

    <!-- Session management technical profile for SAML based tokens -->
    <TechnicalProfile Id="SM-Saml-issuer">
      <DisplayName>Session Management Provider</DisplayName>
      <Protocol Name="Proprietary" Handler="Web.TPEngine.SSO.SamlSSOSessionProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
    </TechnicalProfile>
  </TechnicalProfiles>
</ClaimsProvider>
```

::: zone-end

### <a name="secure-your-logout-redirect"></a>Защита перенаправления выхода

После выхода пользователя перенаправляется на URI, указанный в `post_logout_redirect_uri` параметре, независимо от URL-адресов ответа, указанных для приложения. Однако если `id_token_hint` передано допустимое значение, а **маркер обязательного идентификатора в запросах выхода** включен, Azure AD B2C проверяет, соответствует ли значения `post_logout_redirect_uri` одному из настроенных URI перенаправления приложения перед выполнением перенаправления. Если соответствующий URL-адрес ответа не был настроен для приложения, выводится сообщение об ошибке, и пользователь не перенаправляется. 

::: zone pivot="b2c-user-flow"

Чтобы требовать маркер идентификации в запросах выхода:

1. Войдите на [портал Azure](https://portal.azure.com).
1. Убедитесь, что вы используете каталог, содержащий клиент Azure AD B2C, выбрав фильтр " **каталог и подписка** " в верхнем меню и выбрав Каталог, содержащий ваш клиент Azure AD B2C.
1. Выберите **Все службы** в левом верхнем углу окна портала Azure, а затем найдите и выберите **Azure AD B2C**.
1. Выберите **Потоки пользователей**.
1. Откройте созданный ранее пользовательский поток.
1. Выберите **Свойства**.
1. Включите **маркер обязательного идентификатора в запросах выхода**.
1. Вернитесь к  **Azure AD B2C**.
1. Выберите **Регистрация приложений**, а затем выберите свое приложение.
1. Выберите **Проверка подлинности**.
1. В текстовом поле **logout URL** (текст для выхода) введите URI перенаправления выхода и нажмите кнопку **сохранить**.

::: zone-end

::: zone pivot="b2c-custom-policy"

Чтобы запросить маркер идентификации в запросах выхода, добавьте элемент **усержаурнэйбехавиорс** в элемент [релингпарти](relyingparty.md) . Затем задайте для **енфорцеидтокенхинтонлогаут** элемента **SingleSignOn** значение `true` . Элемент **усержаурнэйбехавиорс** должен выглядеть, как в следующем примере:

```xml
<UserJourneyBehaviors>
  <SingleSignOn Scope="Tenant" EnforceIdTokenHintOnLogout="true"/>
</UserJourneyBehaviors>
```

::: zone-end

Чтобы настроить URL-адрес выхода из приложения, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com).
1. Убедитесь, что вы используете каталог, содержащий клиент Azure AD B2C, выбрав фильтр " **каталог и подписка** " в верхнем меню и выбрав Каталог, содержащий ваш клиент Azure AD B2C.
1. Выберите **Все службы** в левом верхнем углу окна портала Azure, а затем найдите и выберите **Azure AD B2C**.
1. Выберите **Регистрация приложений**, а затем выберите свое приложение.
1. Выберите **Проверка подлинности**.
1. В текстовом поле **logout URL** (текст для выхода) введите URI перенаправления выхода и нажмите кнопку **сохранить**.

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте, как [настроить маркеры в Azure AD B2C](configure-tokens.md).
