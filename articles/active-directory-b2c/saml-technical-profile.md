---
title: Определение технического профиля SAML в настраиваемой политике в Azure Active Directory B2C | Документация Майкрософт
description: Определение технического профиля SAML в настраиваемой политике в Azure Active Directory B2C.
services: active-directory-b2c
author: davidmu1
manager: mtillman
ms.service: active-directory
ms.workload: identity
ms.topic: reference
ms.date: 09/10/2018
ms.author: davidmu
ms.component: B2C
ms.openlocfilehash: 347a437a9f45f29348e97c616c985764135e5427
ms.sourcegitcommit: db2cb1c4add355074c384f403c8d9fcd03d12b0c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/15/2018
ms.locfileid: "51687475"
---
# <a name="define-a-saml-technical-profile-in-an-azure-active-directory-b2c-custom-policy"></a>Определение технического профиля SAML в настраиваемой политике Azure Active Directory B2C

[!INCLUDE [active-directory-b2c-advanced-audience-warning](../../includes/active-directory-b2c-advanced-audience-warning.md)]

Azure Active Directory (Azure AD) B2C поддерживает поставщика удостоверений SAML 2.0. В этой статье описаны особенности технического профиля для взаимодействия с поставщиком утверждений, который поддерживает этот стандартизированный протокол. С помощью технического профиля SAML можно создавать федерацию с поставщиком удостоверений на основе SAML, например [ADFS](active-directory-b2c-custom-setup-adfs2016-idp.md) и [Salesforce](active-directory-b2c-setup-sf-app-custom.md), позволяя пользователям выполнять вход с использованием их удостоверений для социальных сетей или корпоративных удостоверений.

## <a name="metadata-exchange"></a>Обмен метаданными

Метаданные — это сведения, используемые в протоколе SAML для предоставления конфигурации стороны SAML, например поставщика услуг или поставщика удостоверений. Метаданные определяют расположение служб, например вход и выход, сертификаты, метод входа и многое другое. Поставщик удостоверений использует метаданные, чтобы узнать, как взаимодействовать с Azure AD B2C. Метаданные настраиваются в формате XML и могут быть подписаны с помощью цифровой подписи, чтобы другая сторона могла проверить их целостность. Когда служба Azure AD B2C создает федерацию с поставщиком удостоверений SAML, она выступает в качестве поставщика услуг, инициируя запрос SAML и ожидая ответ SAML. Кроме того, в некоторых случаях она принимает незапрашиваемую аутентификацию SAML, которая также называется инициированной поставщиком удостоверений. 

Метаданные можно настроить у обеих сторон как "Статические метаданные" или "Динамические метаданные". В статическом режиме все метаданные копируются у одной стороны и настраиваются у другой. В динамическом режиме для метаданных задается URL-адрес, в то время как другая сторона считывает конфигурацию динамически. Принципы те же: вы задаете метаданные технического профиля Azure AD B2C у поставщика удостоверений и задаете метаданные поставщика удостоверений в Azure AD B2C.

В каждом поставщике удостоверений SAML предусмотрены разные действия для предоставления и настройки поставщика услуг (в данном случае Azure AD B2C), а также настройки метаданных Azure AD B2C в поставщике удостоверений. Рекомендации о том, как это сделать, см. в документации поставщика удостоверений.

В указанном ниже примере показан URL-адрес метаданных SAML, связанных с техническим профилем Azure AD B2C.

```
https://your-tenant-name.b2clogin.com/your-tenant-name/your-policy/samlp/metadata?idptp=your-technical-profile
```

Замените следующие значения:

- **your-tenant-name** — именем клиента, например fabrikam.b2clogin.com.
- **your-policy** — именем собственной политики. Используйте политику с настроенным техническим профилем поставщика SAML или политику, которая от нее наследуется.
- **your-technical-profile** — именем технического профиля поставщика удостоверений SAML.

## <a name="digital-signing-certificates-exchange"></a>Обмен сертификатами для цифровой подписи

Чтобы создать отношение доверия между Azure AD B2C и поставщиком удостоверений SAML, необходимо указать допустимый сертификат X509 с закрытым ключом. Отправьте сертификат с закрытым ключом (PFX-файл) в хранилище ключей политики Azure AD B2C. Azure AD B2C подписывает запрос на вход SAML с использованием предоставленного вами сертификата. 

Сертификат используется в следующих случаях.

- Azure AD B2C создает и подписывает запрос SAML, используя закрытый ключ Azure AD B2C сертификата. Запрос SAML отправляется поставщику удостоверений, который проверяет запрос с помощью открытого ключа Azure AD B2C сертификата. Получить доступ к открытому сертификату Azure AD B2C можно с помощью метаданных технического профиля. Кроме того, можно вручную отправить CER-файл поставщику удостоверений SAML.
- Поставщик удостоверений подписывает данные, отправляемые в Azure AD B2C, с помощью закрытого ключа поставщика удостоверений сертификата. Azure AD B2C проверяет данные, используя открытый сертификат поставщика удостоверений. В каждом поставщике удостоверений предусмотрены разные действия по настройке. Рекомендации о том, как это сделать, см. в документации поставщиков удостоверений. В Azure AD B2C политике требуется доступ к открытому ключу сертификата с использованием метаданных поставщика удостоверений.

Самозаверяющий сертификат приемлем для большинства сценариев. В рабочей среде рекомендуется использовать сертификат X509, выданный центром сертификации. Кроме того, как описано далее в этом документе, для нерабочей среды можно отключить подписывание SAML на обеих сторонах.

На следующей схеме показан обмен метаданными и сертификатами:

![обмен метаданными и сертификатами](media/saml-technical-profile/technical-profile-idp-saml-metadata.png)


## <a name="digital-encryption"></a>Цифровое шифрование

Чтобы зашифровать утверждение ответа SAML, поставщик удостоверений всегда использует открытый ключ сертификата шифрования в техническом профиле Azure AD B2C. Когда службе Azure AD B2C необходимо расшифровать данные, она использует закрытую часть сертификата шифрования.

Шифрование утверждения ответа SAML:

1. Отправьте допустимый сертификат X509 с закрытым ключом (PFX-файл) в хранилище ключей политики Azure AD B2C.
2. Добавьте элемент **CryptographicKey** с идентификатором `SamlAssertionDecryption` в коллекцию **CryptographicKeys** технического профиля. Задайте для **StorageReferenceId** имя ключа политики, созданного на шаге 1.
3. Задайте для метаданных технического профиля **WantsEncryptedAssertions** значение `true`.
4. Добавьте в поставщик удостоверений новые метаданные технического профиля Azure AD B2C. В параметре **KeyDescriptor** свойству **use** должно быть присвоено значение `encryption`, содержащее открытый ключ сертификата.

В следующем примере показан раздел шифрования метаданных технического профиля Azure AD B2C:

```XML
<KeyDescriptor use="encryption">
  <KeyInfo xmlns="http://www.w3.org/2000/09/xmldsig#">
    <X509Data>
      <X509Certificate>valid certificate</X509Certificate>
    </X509Data>
  </KeyInfo>
</KeyDescriptor>
```

## <a name="identity-provider-initiated-flow"></a>Последовательность, инициируемая поставщиком удостоверений

В сеансе единого входа (незапрашиваемый запрос), инициированном поставщиком удостоверений, незапрашиваемый ответ SAML отправляется поставщику услуг, в этом случае в технический профиль Azure AD B2C. В этой последовательности пользователь не проходит сначала через веб-приложение, а направляется к поставщику удостоверений. При отправке запроса страница аутентификации предоставляется пользователю с помощью поставщика удостоверений. Пользователь выполняет вход, а затем запрос перенаправляется в Azure AD B2C с ответом SAML, содержащим утверждения. Azure AD B2C считывает утверждения и выдает новый токен SAML, а затем перенаправляет пользователя обратно в приложение проверяющей стороны. Перенаправления выполняются с помощью свойства **Location** элемента **AssertionConsumerService**.


![Вход SAML, инициированный поставщиком удостоверений](media/saml-technical-profile/technical-profile-idp-saml-idp-initiated.png) 

Рассмотрите следующие требования политики при создании последовательности, инициированной поставщиком удостоверений:

- Первым шагом оркестрации должен быть единственный обмен утверждениями, который указывает на технический профиль SAML.
- В техническом профиле должен быть элемент метаданных с именем **IdpInitiatedProfileEnabled**, которому присвоено значение `true`.
- Должна применяться политика проверяющей стороны SAML.
- В политике проверяющей стороны должен быть элемент метаданных с именем **IdpInitiatedProfileEnabled**, которому присвоено значение `true`.
- Незапрашиваемые ответы необходимо отправить в конечную точку `/your-tenant/your-policy/samlp/sso/assertionconsumer`. Любое состояние ретранслятора, включенное в ответ, перенаправляется проверяющей стороне. Замените следующие значения: **your-tenant** именем своего клиента; **your-policy** — именем политики проверяющей стороны.
    
## <a name="protocol"></a>Протокол

Атрибуту **Name** элемента Protocol необходимо задать значение `SAML2`. 

## <a name="metadata"></a>Метаданные

| Атрибут | Обязательно | ОПИСАНИЕ |
| --------- | -------- | ----------- |
| PartnerEntity | Yes | URL-адрес метаданных поставщика удостоверений SAML. Скопируйте метаданные поставщика удостоверений и добавьте их в элемент CDATA `<![CDATA[Your IDP metadata]]>` |
| WantsSignedRequests | Нет  | Указывает, требуется ли для технического профиля, чтобы все исходящие запросы аутентификации были подписаны. Возможные значения: `true` или `false`. По умолчанию используется значение `true`. Если присвоено значение `true`, криптографический ключ **SamlMessageSigning** должен быть указан и все исходящие запросы аутентификации должны быть подписаны. Если присвоено значение `false`, параметры **SigAlg** и **Signature** (строка запроса или параметр отправки) не включаются в запрос. Эти метаданные также определяют атрибут **AuthnRequestsSigned** метаданных, который представляет собой выходные данные в метаданных технического профиля Azure AD B2C, совместно используемого с поставщиком удостоверений. |
| XmlSignatureAlgorithm | Нет  | Метод, который Azure AD B2C использует для подписывания запроса SAML. Эти метаданные определяют значение параметра **SigAlg** (строка запроса или параметр отправки) в запросе SAML. Возможные значения: `Sha256`, `Sha384`, `Sha512` или `Sha1`. Настройте алгоритм подписи на обеих сторонах, используя одно и то же значение. Используйте только тот алгоритм, который поддерживается вашим сертификатом. | 
| WantsSignedAssertions | Нет  | Указывает, требуется ли для технического профиля, чтобы все входящие утверждения были подписаны. Возможные значения: `true` или `false`. По умолчанию используется значение `true`. Если присвоено значение `true`, весь раздел утверждений `saml:Assertion`, отправленный поставщиком удостоверений в Azure AD B2C, должен быть подписан. Если присвоено значение `false`, поставщик удостоверений не должен подписывать утверждения, но даже если он подпишет, Azure AD B2C не проверит его подпись. Эти метаданные также определяют флаг **WantsAssertionsSigned** метаданных, который представляет собой выходные данные в метаданных технического профиля Azure AD B2C, совместно используемого с поставщиком удостоверений. Если отключить проверку утверждений, также может понадобиться отключить проверку подписи ответа (дополнительные сведения см. в разделе **ResponsesSigned**). |
| ResponsesSigned | Нет  | Возможные значения: `true` или `false`. По умолчанию используется значение `true`. Если присвоено значение `false`, поставщик удостоверений не должен подписывать ответ SAML, но даже если он подпишет, Azure AD B2C не проверит его подпись. Если присвоено значение `true`, ответ SAML, отправляемый поставщиком удостоверений в Azure AD B2C, подписан и должен быть проверен. Если отключить проверку ответов SAML, также может понадобиться отключить проверку подписи утверждений (дополнительные сведения см. в разделе **WantsSignedAssertions**). |
| WantsEncryptedAssertions | Нет  | Указывает, требуется ли для технического профиля, чтобы все входящие утверждения были зашифрованы. Возможные значения: `true` или `false`. По умолчанию используется значение `false`. Если присвоено значение `true`, утверждения, отправляемые поставщиком удостоверений в Azure AD B2C, должны быть подписаны, а также необходимо указать криптографический ключ **SamlAssertionDecryption**. Если присвоено значение `true`, метаданные технического профиля Azure AD B2C включают в себя раздел **encryption**. Поставщик удостоверений считывает метаданные и шифрует утверждение ответа SAML с помощью открытого ключа, указанного в метаданных технического профиля Azure AD B2C. Если включить шифрование утверждений, также может понадобиться отключить проверку подписи ответа (дополнительные сведения см. в разделе **ResponsesSigned**). | 
| IdpInitiatedProfileEnabled | Нет  |Указывает, включен ли профиль сеанса единого входа, инициированный профилем поставщика удостоверений SAML. Возможные значения: `true` или `false`. Значение по умолчанию — `false`. В последовательности, инициированной поставщиком удостоверений, пользователь проходит аутентификацию извне, а незапрашиваемый ответ отправляется в Azure AD B2C. Эта служба затем использует токен, выполняет шаги оркестрации и отправляет ответ в приложение проверяющей стороны. |

## <a name="cryptographic-keys"></a>Криптографические ключи

Элемент **CryptographicKeys** содержит следующие атрибуты.

| Атрибут |Обязательно | ОПИСАНИЕ |
| --------- | ----------- | ----------- |
| SamlMessageSigning |Yes | Сертификат X509 (набор ключей RSA), используемый для подписывания сообщений SAML. Azure AD B2C использует этот ключ для подписывания запросов и отправки их поставщику удостоверений. |
| SamlAssertionDecryption |Yes | Сертификат X509 (набор ключей RSA), используемый для расшифровки сообщений SAML. Этот сертификат необходимо указать с помощью поставщика удостоверений. Azure AD B2C использует этот сертификат для расшифровки данных, отправленных поставщиком удостоверений. |
| MetadataSigning |Нет  | Сертификат X509 (набор ключей RSA), используемый для подписывания метаданных SAML. Azure AD B2C использует этот ключ для подписывания метаданных.  |

## <a name="examples"></a>Примеры

- [Добавление ADFS в качестве поставщика удостоверений SAML с помощью пользовательских политик в Azure Active Directory B2C](active-directory-b2c-custom-setup-adfs2016-idp.md)
- [Azure Active Directory B2C. Выполнение входа с помощью учетных записей Salesforce через SAML](active-directory-b2c-setup-sf-app-custom.md)













