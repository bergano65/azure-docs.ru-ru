---
title: Методы маршрутизации трафика средствами диспетчера трафика Azure
description: Эта статья поможет вам разобраться в различных методах маршрутизации трафика, используемых диспетчером трафика.
services: traffic-manager
author: rohinkoul
ms.service: traffic-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/17/2018
ms.author: rohink
ms.openlocfilehash: 4a035506943eeffa2c3fc4fec27c47da4136683b
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "79250911"
---
# <a name="traffic-manager-routing-methods"></a>Методы маршрутизации диспетчера трафика

Диспетчер трафика Azure поддерживает шесть методов маршрутизации трафика, которые определяют правила маршрутизации сетевого трафика в разные конечные точки службы. Для любого профиля диспетчер трафика применяет связанный с ним метод маршрутизации трафика к каждому полученному запросу DNS. Метод маршрутизации трафика определяет, какая конечная точка будет возвращена в ответе DNS.

В диспетчере трафика доступны следующие методы маршрутизации трафика:

* **[Приоритет](#priority-traffic-routing-method).** выберите **приоритет** , если хотите использовать конечную точку основной службы для всего трафика, и создайте резервные копии в случае недоступности первичной или резервной конечной точки.
* **[Взвешенный](#weighted).** выберите **взвешенный** , если требуется распределить трафик по набору конечных точек равномерно или в соответствии с весовыми коэффициентами, которые вы определяете.
* **[Производительность](#performance).** выберите **производительность** при наличии конечных точек в разных географических расположениях и необходимо, чтобы конечные пользователи использовали "ближайшую" конечную точку с точки зрения наименьшей задержки сети.
* **[Географический](#geographic):** выберите метод **Географический**, чтобы пользователи направлялись к определенным конечным точкам (Azure, внешним или вложенным) в зависимости от географического расположения, из которого исходит их DNS-запрос. Это позволяет клиентам диспетчера трафика реализовать сценарии, в которых важно знать географический регион пользователей и направлять их на основе этих данных. К примерам относятся соблюдение предписаний независимости данных, локализация содержимого и взаимодействия с пользователем, а также измерение трафика из разных регионов.
* **[Многозначный](#multivalue):** выберите **Многозначный** для профилей диспетчера трафика, которые могут иметь конечные точки только в виде IPv4- или IPv6-адресов. При получении запроса для этого профиля возвращаются все работоспособные конечные точки.
* **[Подсеть](#subnet):** выберите метод маршрутизации трафика **Подсеть** для сопоставления наборов диапазонов IP-адресов пользователей с определенной конечной точкой в профиле диспетчера трафика. При получении запроса возвращаемая конечная точка будет сопоставлена с этим исходным IP-адресом запроса. 


Все профили диспетчера трафика включают мониторинг работоспособности и автоматическую отработку отказа для всех конечных точек. Дополнительные сведения см. в статье [Мониторинг и отработка отказов конечной точки диспетчера трафика](traffic-manager-monitoring.md). Отдельный профиль диспетчера трафика может использовать только один метод маршрутизации трафика. В любое время для профиля можно выбрать другой метод маршрутизации трафика. Изменения применяются в течение одной минуты, не приводя к простою. Методы маршрутизации трафика можно комбинировать с помощью вложенных профилей диспетчера трафика. Вложенность позволяет создавать сложные и гибкие конфигурации для маршрутизации трафика в соответствии с потребностями крупных и сложных приложений. Дополнительную информацию см. в статье [Вложенные профили диспетчера трафика](traffic-manager-nested-profiles.md).

## <a name="priority-traffic-routing-method"></a>Метод маршрутизации трафика по приоритету

Как правило, организация стремится обеспечить надежность своих служб, развертывая одну или несколько резервных служб на случай, если основная служба выйдет из строя. Метод маршрутизации трафика "По приоритету" позволяет клиентам Azure легко реализовать эту схему отработки отказа.

![Диспетчер трафика Azure: маршрутизация трафика по приоритету](media/traffic-manager-routing-methods/priority.png)

В этом профиле диспетчера трафика создается упорядоченный список конечных точек службы. По умолчанию диспетчер трафика направляет весь трафик в первичную конечную точку (с наивысшим приоритетом). Если основная конечная точка недоступна, диспетчер трафика направляет трафик на вторую конечную точку. Если и первичная, и вторичная конечные точки становятся недоступны, трафик направляется к третьей и т. д. Доступность конечной точки определяется по указанному для нее состоянию (включена или отключена) и данным мониторинга конечных точек.

### <a name="configuring-endpoints"></a>Настройка конечных точек

В Azure Resource Manager можно явно указать приоритет для каждой конечной точки, изменяя значение свойства priority. Допускаются значения в диапазоне от 1 до 1000. Чем меньше значение, тем выше приоритет. Нельзя использовать одинаковые значения приоритетов для нескольких конечных точек. Это необязательное свойство. Если оно не указано, для конечной точки задается приоритет по умолчанию в соответствии с ее расположением в профиле.

## <a name="weighted-traffic-routing-method"></a><a name = "weighted"></a>Метод маршрутизации трафика со взвешиванием
Маршрутизация трафика по методу взвешивания позволяет распределять трафик равномерно или в соответствии с предустановленными весовыми коэффициентами.

![Диспетчер трафика Azure: маршрутизации трафика по методу взвешивания](media/traffic-manager-routing-methods/weighted.png)

При использовании метода взвешивания при маршрутизации трафика каждой конечной точке в профиле диспетчера трафика присваивается определенный весовой коэффициент. Это целое число в диапазоне от 1 до 1000. Это необязательный параметр. Если значение не указано, диспетчер трафика использует коэффициент 1 по умолчанию. Чем выше коэффициент, тем выше приоритет.

Для каждого полученного запроса DNS диспетчер трафика случайным образом выбирает конечную точку из числа доступных. Вероятность выбора конечной точки определяется сочетанием весовых коэффициентов всех доступных конечных точек. Если для всех конечных точек используются одинаковые коэффициенты, трафик будет распределяться между ними равномерно. Если задать больший (или меньший) вес для определенных конечных точек, они будут чаще (или реже) возвращаться в ответах DNS.

Метод взвешивания позволяет реализовать некоторые полезные сценарии.

* Постепенное обновление приложения: направляйте часть трафика в новую конечную точку и постепенно доведите объем трафика до 100 %.
* Миграция приложений в Azure: создайте профиль, который включает конечные точки, расположенные в среде Azure и за ее пределами. Настройте весовые коэффициенты так, чтобы приоритет отдавался новым конечным точкам.
* Повышение в облако для получения дополнительной емкости: быстро расширьте локальное развертывание в облако, изменив профиль диспетчера трафика. Если вам требуется дополнительная емкость в облаке, добавьте конечные точки и укажите, какая часть трафика направляется на ту или иную конечную точку.

Помимо портала Azure, весовые коэффициенты также можно настроить с помощью Azure PowerShell, интерфейса командной строки и интерфейсов REST API.

Важно понимать, что ответы DNS кэшируются клиентами и рекурсивными DNS-серверами, которые клиенты используют для разрешения имен DNS. Это может повлиять на распределение трафика по приоритетам. При большом числе клиентов и рекурсивных DNS-серверов распределение трафика работает ожидаемым образом. Но если клиентов и (или) рекурсивных DNS-серверов мало, кэширование может ощутимо исказить распределение трафика.

Типичные примеры такой ситуации:

* среды для разработки и тестирования;
* обмен данных между приложениями;
* приложения, предназначенные для узкого круга пользователей, которые используют общую инфраструктуру рекурсивной DNS-службы (например, сотрудники компании, подключенные через общий прокси-сервер).

Такое воздействие кэширования DNS характерно для всех систем маршрутизации трафика на основе DNS, а не только для диспетчера трафика. В некоторых случаях может помочь явная очистка кэша DNS. В других случаях более подходящим может оказаться альтернативный метод маршрутизации трафика.

## <a name="performance-traffic-routing-method"></a><a name = "performance"></a>Метод маршрутизации трафика для повышения производительности

Скорость реагирования многих приложений можно повысить, развернув конечные точки в двух или больше расположениях в разных регионах и направляя трафик в соответствующее ближайшее расположение. Эта схема реализуется при маршрутизации трафика по производительности.

![Диспетчер трафика Azure: маршрутизация трафика по производительности](media/traffic-manager-routing-methods/performance.png)

Под ближайшей конечной точкой не обязательно подразумевается та, которая ближе всего географически. Вместо этого при определении расстояния для маршрутизации трафика по производительности используются характеристики задержки сети. Диспетчер трафика ведет собственную таблицу задержек Интернета, в которой сохраняет время кругового пути между диапазонами IP-адресов и центрами обработки данных Azure.

Для каждого входящего запроса DNS он находит в таблице задержек Интернета строки, соответствующие IP-адресу клиента. Затем диспетчер трафика выбирает доступную конечную точку, расположенную в том центре обработки данных Azure, который демонстрирует наименьшую задержку для этого диапазона IP-адресов, и возвращает адрес этой конечной точки в ответе DNS.

Как описано в статье [Как работает диспетчер трафика](traffic-manager-how-it-works.md), запросы DNS поступают к нему не напрямую от клиентов. Обычно запросы DNS отправляет рекурсивная служба DNS, которую используют клиенты. Поэтому для определения ближайшей конечной точки используется не IP-адрес пользователя, а IP-адрес рекурсивной службы DNS. На практике такая замена адреса обычно дает неплохой результат.


Чтобы учесть изменения в глобальной сети Интернет и добавление новых регионов Azure, диспетчер трафика регулярно обновляет используемую таблицу задержек Интернета. Но производительность приложения зависит от распределения и колебаний загрузки в сети Интернет на определенный момент времени. При маршрутизации трафика по производительности текущая нагрузка на конкретную конечную точку службы не отслеживается. Но если конечная точка становится недоступной, диспетчер трафика перестает включать ее в ответы на запросы DNS.


Примечания:

* Если профиль содержит несколько конечных точек, которые входят в один регион Azure, диспетчер трафика распределяет трафик равномерно между всеми доступными конечными точками в этом регионе. Если вы предпочитаете распределение трафика в пределах региона, используйте [вложенные профили диспетчера трафика](traffic-manager-nested-profiles.md).
* Если работоспособность всех задействованных конечных точек в ближайших регионах Azure снижена, диспетчер трафика перенаправляет трафик к конечным точкам в следующем ближайшем регионе Azure. Если вы хотите определить свою логику отработки сбоя, используйте [вложенные профили диспетчера трафика](traffic-manager-nested-profiles.md).
* Чтобы использовать маршрутизацию трафика по производительности между внешними или вложенными конечными точками, нужно вручную указать их расположение. Выберите ближайший к вашему развертыванию регион Azure. Именно эти расположения отслеживаются в таблице задержек Интернета.
* Алгоритм выбора конечной точки детерминирован. Повторные запросы DNS от одного клиента будут направляться к той же конечной точке. Обычно клиенты используют разные рекурсивные серверы DNS, когда путешествуют. Возможно, в этом случае клиент будет перенаправлен к другой конечной точке. Кроме того, на маршрутизацию могут влиять изменения в таблице задержек Интернета. Таким образом, маршрутизация трафика по производительности не гарантирует, что клиент всегда будет обращаться к одной конечной точке.
* При изменении таблицы задержек Интернета вы можете заметить, что некоторые клиенты переключились на другую конечную точку. Такие изменения маршрутизации основываются на свежих данных о задержках. Данные обновления необходимы, чтобы обеспечить точность маршрутизации трафика для повышения производительности, так как Интернет постоянно развивается.

## <a name="geographic-traffic-routing-method"></a><a name = "geographic"></a>Метод географической маршрутизации трафика

Можно настроить профили диспетчера трафика для применения метода географической маршрутизации трафика. В этом случае пользователи будут направляться к определенным конечным точкам (Azure, внешним или вложенным) в зависимости от географического расположения, из которого исходит их DNS-запрос. Это позволяет клиентам диспетчера трафика реализовать сценарии, в которых важно знать географический регион пользователей и направлять их на основе этих данных. К примерам относятся соблюдение предписаний независимости данных, локализация содержимого и взаимодействия с пользователем, а также измерение трафика из разных регионов.
Если в профиле настроена географическая маршрутизация, то каждой конечной точке, связанной с профилем, необходимо назначить набор географических регионов. Ниже приведены возможные уровни детализации географических регионов. 
- Мир — любой регион.
- Группа регионов — например, Африка, Ближний Восток, Австралия и Тихоокеанский регион и т. д. 
- Страна или регион — например, Ирландия, Перу, Гонконг, САР и т. д. 
- Область, штат, провинция — например, Калифорния (США), Квинсленд (Австралия), Альберта (Канада) и т. д. (Обратите внимание: этот уровень детализации поддерживается только для штатов и провинций в Австралии, Канаде и США.)

Если конечной точкой назначен регион или набор регионов, все запросы из этих регионов направляются только к этой конечной точке. Диспетчер трафика использует исходный IP-адрес DNS-запроса, чтобы определить регион, из которого пользователь отправляет запрос. Обычно это IP-адрес локального сопоставителя DNS, выполняющего запрос от имени пользователя.  

![Диспетчер трафика Azure: метод географической маршрутизации трафика](./media/traffic-manager-routing-methods/geographic.png)

Диспетчер трафика считывает исходный IP-адрес DNS-запроса и определяет, из какого географического региона он поступил. Затем он определяет, имеется ли конечная точка, с которой сопоставлен этот географический регион. Этот поиск начинается с самого низкого уровня детализации (штата или Республики, где он поддерживается, в другом месте на уровне страны или региона) и проходит до самого высокого уровня, который является **мировым**. Первая найденная соответствующая конечная точка при этом обходе будет возвращена в ответе на запрос. Если это конечная точка вложенного типа, то будет возвращена конечная точка в соответствующем дочернем профиле, в зависимости от его метода маршрутизации. В такой ситуации возможно следующее.

- Если используется географическая маршрутизация, то географический регион может быть сопоставлен только с одной конечной точкой в профиле диспетчера трафика. Это гарантирует детерминированную маршрутизацию пользователей и дает клиентам возможность реализовывать сценарии, требующие установления однозначных географических границ.
- Если регион пользователя географически сопоставлен с двумя разными конечными точками, то диспетчер трафика выбирает конечную точку на нижнем уровне детализации и не учитывает запросы на маршрутизацию, исходящие из другой конечной точки этого региона. Рассмотрим пример профиля с географической маршрутизацией и двумя конечными точками: Endpoint1 и Endpoint2. Endpoint1 настроена для приема трафика из Ирландии, а Endpoint2 — для приема трафика из Европы. Если запрос исходит из Ирландии, он всегда будет направляться к Endpoint1.
- Так как регион может быть сопоставлен только с одной конечной точкой, диспетчер трафика возвращает ее независимо от того, является ли эта конечная точка работоспособной или нет.

    >[!IMPORTANT]
    >Клиентам настоятельно рекомендуется использовать метод географической маршрутизации с конечными точками вложенного типа, у которых имеются дочерние профили, содержащие по крайней мере по две конечные точки.
- Если найдена соответствующая конечная точка, которая **остановлена**, то диспетчер трафика вернет ответ NODATA. В этом случае поиски не продолжаются вверх по иерархии географических регионов. Это также относится к конечным точкам вложенного типа, когда дочерний профиль **остановлен** или **отключен**.
- Если конечная точка **отключена**, она не участвует в процессе сопоставления с регионом. Это также относится к конечным точкам вложенного типа, когда конечная точка **отключена**.
- Если поступает запрос из географического региона, сопоставления с которым в данном профиле нет, то диспетчер трафика возвращает ответ NODATA. Поэтому клиентам настоятельно рекомендуется использовать географическую маршрутизацию с одной конечной точкой (лучше всего вложенного типа), в дочернем профиле которой имеются по крайней мере две конечные точки, которым назначен регион **Мир**. Это также гарантирует обработку всех IP-адресов, которые не соответствуют какому-либо региону.

Как описано в статье [Как работает диспетчер трафика](traffic-manager-how-it-works.md), запросы DNS поступают к нему не напрямую от клиентов. Обычно запросы DNS отправляет рекурсивная служба DNS, которую используют клиенты. Поэтому для определения региона используется не IP-адрес клиента, а IP-адрес рекурсивной службы DNS. На практике такая замена адреса обычно дает неплохой результат.

### <a name="faqs"></a>Частые вопросы

* [В каких случаях следует использовать географическую маршрутизацию?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#what-are-some-use-cases-where-geographic-routing-is-useful)

* [Как решить, какой метод использовать — метод маршрутизации трафика по производительности или метод географической маршрутизации?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#how-do-i-decide-if-i-should-use-performance-routing-method-or-geographic-routing-method)

* [Какие регионы диспетчер трафика поддерживает для географической маршрутизации?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#what-are-the-regions-that-are-supported-by-traffic-manager-for-geographic-routing)

* [Как диспетчер трафика определяет, откуда пользователь обращается к приложению?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#how-does-traffic-manager-determine-where-a-user-is-querying-from)

* [Есть ли гарантия, что диспетчер трафика правильно определит точное географическое расположение пользователя во всех случаях?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#is-it-guaranteed-that-traffic-manager-can-correctly-determine-the-exact-geographic-location-of-the-user-in-every-case)

* [Должна дли конечная точка физически располагаться в том же регионе, что и регион, с которым она сопоставлена для географической маршрутизации?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#does-an-endpoint-need-to-be-physically-located-in-the-same-region-as-the-one-it-is-configured-with-for-geographic-routing)

* [Можно ли назначить географические регионы конечным точкам в профиле, в котором не настроена географическая маршрутизация?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#can-i-assign-geographic-regions-to-endpoints-in-a-profile-that-is-not-configured-to-do-geographic-routing)

* [Почему, когда я пытаюсь изменить метод маршрутизации существующего профиля на географический, возникает ошибка?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#why-am-i-getting-an-error-when-i-try-to-change-the-routing-method-of-an-existing-profile-to-geographic)

* [Почему клиентам настоятельно рекомендуется создавать в профиле с географической маршрутизацией вложенные профили вместо конечных точек?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#why-is-it-strongly-recommended-that-customers-create-nested-profiles-instead-of-endpoints-under-a-profile-with-geographic-routing-enabled)

* [Существуют ли ограничения на версии API, которые поддерживает этот тип маршрутизации?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#are-there-any-restrictions-on-the-api-version-that-supports-this-routing-type)

## <a name="multivalue-traffic-routing-method"></a><a name = "multivalue"></a>Метод маршрутизации трафика "Многозначный"
Метод маршрутизации трафика **Многозначный** позволяет получить несколько работоспособных конечных точек в одном ответе на запрос DNS. Это позволяет вызывающему объекту выполнять повторные попытки на стороне клиента с другими конечными точками в случае, если возвращаемая конечная точка не отвечает. Этот шаблон может повысить доступность службы и сократить задержки, связанные с новым запросом DNS на получение работоспособной конечной точки. Метод маршрутизации "Многозначный" работает только в том случае, если все конечные точки внешние и являются IPv4- или IPv6-адресами. При получении запроса для этого профиля все работоспособные конечные точки возвращаются на основе настраиваемого максимального числа записей в ответе.

### <a name="faqs"></a>Частые вопросы

* [В каких случаях следует использовать маршрутизацию с несколькими значениями?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#what-are-some-use-cases-where-multivalue-routing-is-useful)

* [Сколько конечных точек возвращается, если используется маршрутизация с несколькими значениями?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#how-many-endpoints-are-returned-when-multivalue-routing-is-used)

* [Я буду получать одинаковый набор конечных точек при использовании маршрутизации с несколькими значениями?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#will-i-get-the-same-set-of-endpoints-when-multivalue-routing-is-used)

## <a name="subnet-traffic-routing-method"></a><a name = "subnet"></a>Метод маршрутизации трафика "Подсеть"
Метод маршрутизации трафика **Подсеть** позволяет сопоставить набор диапазонов IP-адресов пользователя с определенными конечными точками в профиле. После этого, если диспетчер трафика получает запрос DNS для этого профиля, он будет проверять исходный IP-адрес этого запроса (в большинстве случаев это будет исходящий IP-адрес сопоставителя DNS, используемый вызывающим объектом), чтобы определить, какая конечная точка сопоставляется, и вернет конечную точку в ответе на запрос. 

IP-адрес для сопоставления с конечной точкой может быть указан как диапазоны CIDR (например, 1.2.3.0/24) или как диапазон адресов (например, 1.2.3.4-5.6.7.8). Диапазоны IP-адресов, связанные с конечной точкой, должны быть уникальными в этом профиле и не могут перекрываться набором IP-адресов другой конечной точки в этом же профиле.
При определении конечной точки без диапазона адресов, которая используется в качестве резервной и принимает трафик из оставшихся подсетей. Если резервная конечная точка отсутствует, диспетчер трафика отправляет ответ NODATA для всех неопределенных диапазонов. Поэтому настоятельно рекомендуется определить резервную конечную точку или иным образом убедиться, что в ваших конечных точках указаны все возможные диапазоны IP-адресов.

Маршрутизацию подсети можно использовать для предоставления различных возможностей для пользователей, подключающихся из определенного пространства IP-адресов. Например, с помощью маршрутизации типа "Подсеть" клиент может перенаправлять все запросы из своего офиса к другой конечной точке, в которой с помощью запросов можно протестировать внутреннюю версию приложения. Другой сценарий — если вы хотите указать другие возможности для пользователей, подключающихся из конкретного поставщика услуг Интернета (например, заблокировать пользователей данного поставщика услуг Интернета).

### <a name="faqs"></a>Частые вопросы

* [В каких случаях следует использовать маршрутизацию подсети?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#what-are-some-use-cases-where-subnet-routing-is-useful)

* [Как диспетчер трафика узнает IP-адрес конечного пользователя?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#how-does-traffic-manager-know-the-ip-address-of-the-end-user)

* [Как можно указать IP-адреса при использовании маршрутизации подсети?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#how-can-i-specify-ip-addresses-when-using-subnet-routing)

* [Как указать резервную конечную точку при использовании маршрутизации подсети?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#how-can-i-specify-a-fallback-endpoint-when-using-subnet-routing)

* [Что произойдет, если конечная точка отключена в профиле типа маршрутизации подсети?](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs#what-happens-if-an-endpoint-is-disabled-in-a-subnet-routing-type-profile)


## <a name="next-steps"></a>Дальнейшие шаги

Узнайте, как разрабатывать приложения с высоким уровнем доступности с помощью [мониторинга конечных точек диспетчера трафика](traffic-manager-monitoring.md)




