---
title: Настройка репликации данных в службе "база данных Azure для MariaDB"
description: В этой статье описывается, как настроить Репликация входных данных в базе данных Azure для MariaDB.
author: ajlam
ms.author: andrela
ms.service: mariadb
ms.topic: how-to
ms.date: 9/29/2020
ms.openlocfilehash: 21a0aaaa9e10a7c3e445145eb178b50b446ba6ae
ms.sourcegitcommit: 6906980890a8321dec78dd174e6a7eb5f5fcc029
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/22/2020
ms.locfileid: "92426002"
---
# <a name="configure-data-in-replication-in-azure-database-for-mariadb"></a>Настройка Репликация входных данных в базе данных Azure для MariaDB

В этой статье описывается, как настроить [репликация входных данных](concepts-data-in-replication.md) в базе данных Azure для MariaDB, настроив серверы источника и реплики. В этой статье предполагается, что у вас есть опыт работы с серверами и базами данных MariaDB.

Чтобы создать реплику в службе "база данных Azure для MariaDB", [репликация входных данных](concepts-data-in-replication.md) синхронизирует данные с исходного MariaDB локального сервера, на виртуальных машинах (ВМ) или в облачных службах баз данных. Репликация входных данных основана на функции собственной репликации в MariaDB на основе позиции файла двоичного журнала (binlog). Дополнительные сведения о репликации binlog см. в [этой статье](https://mariadb.com/kb/en/library/replication-overview/).

Перед выполнением действий, описанных в этой статье, ознакомьтесь с [ограничениями и требованиями к](concepts-data-in-replication.md#limitations-and-considerations) репликации данных.

> [!NOTE]
> Если на исходном сервере используется версия 10,2 или более поздняя, рекомендуется настроить Репликация входных данных с помощью [идентификатора глобальной транзакции](https://mariadb.com/kb/en/library/gtid/).


## <a name="create-a-mariadb-server-to-use-as-a-replica"></a>Создание сервера MariaDB для использования в качестве реплики

1. Создайте новую базу данных Azure для сервера MariaDB (например, replica.mariadb.database.azure.com). Сервер является сервером-репликой в Репликация входных данных.

    Дополнительные сведения о создании сервера см. в статье [Создание сервера базы данных Azure для MariaDB с помощью портал Azure](quickstart-create-mariadb-server-database-using-azure-portal.md).

   > [!IMPORTANT]
   > Необходимо создать сервер базы данных Azure для MariaDB в общего назначения или ценовой категории, оптимизированные для памяти.

2. Создайте идентичные учетные записи пользователей и соответствующие привилегии.
    
    Учетные записи пользователей не реплицируются с исходного сервера на сервер реплики. Чтобы предоставить пользователю доступ к серверу реплики, необходимо вручную создать все учетные записи и соответствующие привилегии на созданном сервере базы данных Azure для MariaDB.

3. Добавьте IP-адрес исходного сервера в правила брандмауэра для реплики. 

   Измените правила брандмауэра на [портале Azure](howto-manage-firewall-portal.md) или с помощью [Azure CLI](howto-manage-firewall-cli.md).

> [!NOTE]
> Обмен данными без смещения
>
> Корпорация Майкрософт поддерживает принципы инклюзивности, а также этнического и социокультурного многообразия. В версии этой статьи на английском языке используется термин _slave_ (раб, ведомый). В [руководстве по стилю для политкорректной коммуникации](https://github.com/MicrosoftDocs/microsoft-style-guide/blob/master/styleguide/bias-free-communication.md) корпорации Майкрософт это слово указано как недопустимое. Термин приводится в версии этой статьи на английском языке в целях согласования, так как сейчас он используется в программном обеспечении. После обновления программного обеспечения с удалением этого слова статья будет изменена соответствующим образом.
>

## <a name="configure-the-source-server"></a>Настройка исходного сервера

Следующие шаги подготавливают и настраивают сервер MariaDB, размещенный локально, на виртуальной машине или в облачной службе базы данных для Репликация входных данных. Сервер MariaDB является источником в Репликация входных данных.

1. Прежде чем продолжать, ознакомьтесь с [требованиями к главному серверу](concepts-data-in-replication.md#requirements) . 

2. Убедитесь, что исходный сервер разрешает как входящий, так и исходящий трафик через порт 3306 и что исходный сервер имеет общедоступный **IP-адрес**, DNS является публично доступным или имеет полное доменное имя (FQDN). 
   
   Проверьте подключение к исходному серверу, выполнив попытку подключения из средства, такого как Командная строка MySQL, размещенного на другом компьютере, или из [Azure Cloud Shell](../cloud-shell/overview.md) , доступных в портал Azure.

   Если ваша организация имеет ограниченные политики безопасности и не позволит всем IP-адресам на исходном сервере разрешить обмен данными из Azure с исходным сервером, можно использовать приведенную ниже команду, чтобы определить IP-адрес сервера базы данных Azure для MariaDB.
    
   1. Войдите в базу данных Azure для MariaDB с помощью такого средства, как MySQL командной строки.
   2. Выполните приведенный ниже запрос.
      ```bash
      mysql> SELECT @@global.redirect_server_host;
      ```
      Ниже приведен пример выходных данных:
      ```bash 
      +-----------------------------------------------------------+
      | @@global.redirect_server_host                             |
      +-----------------------------------------------------------+
      | e299ae56f000.tr1830.westus1-a.worker.database.windows.net |
       +-----------------------------------------------------------+
      ```
   3. Выйдите из командной строки MySQL.
   4. Чтобы получить IP-адрес, выполните приведенную ниже команду в служебной программе Ping.
      ```bash
      ping <output of step 2b>
      ``` 
      Пример: 
      ```bash      
      C:\Users\testuser> ping e299ae56f000.tr1830.westus1-a.worker.database.windows.net
      Pinging tr1830.westus1-a.worker.database.windows.net (**11.11.111.111**) 56(84) bytes of data.
      ```

   5. Настройте правила брандмауэра исходного сервера, чтобы включить выведенный на предыдущий шаг IP-адрес на порт 3306.

   > [!NOTE]
   > Этот IP-адрес может измениться из-за операций обслуживания и развертывания. Этот метод подключения предназначен только для клиентов, которые не могут позволить себе разрешить все IP-адреса на порту 3306.

2. Включите ведение журнала в двоичном формате.
    
    Чтобы узнать, включено ли ведение журнала на базе главного сервера, введите следующую команду:

   ```sql
   SHOW VARIABLES LIKE 'log_bin';
   ```

   Если переменная [`log_bin`](https://mariadb.com/kb/en/library/replication-and-binary-log-server-system-variables/#log_bin) возвращает значение `ON` , ведение двоичного журнала включено на сервере.

   Если `log_bin` возвращает значение `OFF` , измените файл **My. cnf** , чтобы `log_bin=ON` включить ведение двоичного журнала. Перезапустите сервер, чтобы изменения вступили в силу.

3. Настройте параметры исходного сервера.

    Для Репликация входных данных требуется `lower_case_table_names` согласованность параметра между серверами источника и реплики. `lower_case_table_names`Параметр по `1` умолчанию установлен в базе данных Azure для MariaDB.

   ```sql
   SET GLOBAL lower_case_table_names = 1;
   ```

4. Создайте новую роль репликации и настройте разрешения.

   Создайте учетную запись пользователя на исходном сервере, для которой настроены права репликации. Учетную запись можно создать с помощью команд SQL или MySQL Workbench. Если планируется репликация с помощью протокола SSL, необходимо указать ее при создании учетной записи пользователя.
   
   Чтобы узнать, как добавить учетные записи пользователей на исходном сервере, см. [документацию по MariaDB](https://mariadb.com/kb/en/library/create-user/).

   С помощью следующих команд новая роль репликации может получить доступ к источнику с любого компьютера, а не только с компьютера, на котором размещен сам источник. Для этого доступа укажите **синкусер \@ "%"** в команде, чтобы создать пользователя.
   
   Дополнительные сведения о документации по MariaDB см. в разделе [Указание имен учетных записей](https://mariadb.com/kb/en/library/create-user/#account-names).

   **Команда SQL**

   - Репликация с использованием SSL

       Чтобы включить SSL для всех подключений пользователей, введите следующую команду, чтобы создать пользователя:

       ```sql
       CREATE USER 'syncuser'@'%' IDENTIFIED BY 'yourpassword';
       GRANT REPLICATION SLAVE ON *.* TO ' syncuser'@'%' REQUIRE SSL;
       ```

   - Репликация без SSL

       Если протокол SSL не требуется для всех подключений, введите следующую команду, чтобы создать пользователя:
    
       ```sql
       CREATE USER 'syncuser'@'%' IDENTIFIED BY 'yourpassword';
       GRANT REPLICATION SLAVE ON *.* TO ' syncuser'@'%';
       ```

   **MySQL Workbench**

   Чтобы создать роль репликации в MySQL Workbench, в области **управления** выберите **Пользователи и привилегии**. Затем выберите **Добавить учетную запись**.
 
   ![Пользователи и привилегии](./media/howto-data-in-replication/users_privileges.png)

   Введите имя пользователя в поле **имя входа** .

   ![Синхронизация пользователя](./media/howto-data-in-replication/syncuser.png)
 
   Выберите панель " **административные роли** ", а затем в списке **глобальных привилегий**выберите **репликация Slave**. Нажмите кнопку **Применить** , чтобы создать роль репликации.

   ![Ведомая роль репликации](./media/howto-data-in-replication/replicationslave.png)


5. Установите исходный сервер в режим «только для чтения».

   Перед созданием дампа базы данных сервер должен быть переведен в режим "только для чтения". В режиме только для чтения источник не может обрабатывать какие-либо транзакции записи. Чтобы избежать воздействия на бизнес, запланируйте окно, доступное только для чтения, во время наименьшей нагрузки.

   ```sql
   FLUSH TABLES WITH READ LOCK;
   SET GLOBAL read_only = ON;
   ```

6. Возвращает текущее имя двоичного файла журнала и смещение.

   Чтобы определить текущее имя двоичного файла журнала и смещение, выполните команду [`show master status`](https://mariadb.com/kb/en/library/show-master-status/) .
    
   ```sql
   show master status;
   ```
   Результаты должны быть похожи на приведенную ниже таблицу.
   
   ![Результаты состояния основного сервера](./media/howto-data-in-replication/masterstatus.png)

   Запишите имя двоичного файла, так как оно будет использоваться на последующих шагах.
   
7. Получите расположение ГТИД (необязательно, необходимое для репликации с помощью ГТИД).

   Выполните функцию, [`BINLOG_GTID_POS`](https://mariadb.com/kb/en/library/binlog_gtid_pos/) чтобы получить расположение гтид для соответствующего имени и смещения файла бинлог.
  
    ```sql
    select BINLOG_GTID_POS('<binlog file name>', <binlog offset>);
    ```
 

## <a name="dump-and-restore-the-source-server"></a>Дамп и восстановление исходного сервера

1. Выводит дамп всех баз данных с исходного сервера.

   Используйте mysqldump для дампа всех баз данных с исходного сервера. Нет необходимости в выгрузить библиотеку библиотек и тестирования MySQL.

    Дополнительные сведения см. в разделе [dump и RESTORE](howto-migrate-dump-restore.md).

2. Задайте для исходного сервера режим чтения/записи.

   После создания дампа базы данных измените исходный сервер MariaDB обратно на режим чтения/записи.

   ```sql
   SET GLOBAL read_only = OFF;
   UNLOCK TABLES;
   ```

3. Восстановите файл дампа на новом сервере.

   Восстановите файл дампа на сервере, созданном в базе данных Azure для MariaDB. См. раздел [dump & Restore](howto-migrate-dump-restore.md) , как восстановить файл дампа на сервер MariaDB.

   Если файл дампа большой, отправьте его на виртуальную машину в Azure в том же регионе, что и сервер реплики. Восстановите его на сервере базы данных Azure для MariaDB с виртуальной машины.

## <a name="link-the-source-and-replica-servers-to-start-data-in-replication"></a>Свяжите серверы источника и реплики для запуска Репликация входных данных

1. Задайте исходный сервер.

   Все функции репликации входных данных выполняются хранимыми процедурами. Все процедуры можно найти в статье о [хранимых процедурах репликации входных данных](reference-stored-procedures.md). Хранимые процедуры можно запускать в оболочке MySQL или MySQL Workbench.

   Чтобы связать два сервера и запустить репликацию, войдите на целевой сервер реплики в службе "база данных Azure для MariaDB". Затем задайте внешний экземпляр в качестве исходного сервера с помощью `mysql.az_replication_change_master` `mysql.az_replication_change_master_with_gtid` хранимой процедуры или на сервере базы данных Azure для MariaDB.

   ```sql
   CALL mysql.az_replication_change_master('<master_host>', '<master_user>', '<master_password>', 3306, '<master_log_file>', <master_log_pos>, '<master_ssl_ca>');
   ```
   
   или
   
   ```sql
   CALL mysql.az_replication_change_master_with_gtid('<master_host>', '<master_user>', '<master_password>', 3306, '<master_gtid_pos>', '<master_ssl_ca>');
   ```

   - master_host: имя узла исходного сервера
   - master_user: имя пользователя исходного сервера
   - master_password: пароль для исходного сервера
   - master_log_file: имя файла двоичного журнала из выполняемой команды `show master status`.
   - master_log_pos: позиция в двоичном журнале из выполняемой команды `show master status`.
   - master_gtid_pos: ГТИД должно выполняться `select BINLOG_GTID_POS('<binlog file name>', <binlog offset>);`
   - master_ssl_ca: контекст сертификата ЦС. Если вы не используете SSL, передайте пустую строку. *
    
    
    * Мы рекомендуем передавать параметр master_ssl_ca в виде переменной. Дополнительные сведения см. в следующих примерах.

   **Примеры**

   - Репликация с использованием SSL

       Создайте переменную `@cert` , выполнив следующие команды:

       ```sql
       SET @cert = '-----BEGIN CERTIFICATE-----
       PLACE YOUR PUBLIC KEY CERTIFICATE\'S CONTEXT HERE
       -----END CERTIFICATE-----'
       ```

       Репликация с SSL настраивается между исходным сервером, размещенным в домене companya.com, и сервером реплики, размещенным в базе данных Azure для MariaDB. Эта хранимая процедура выполняется на реплике.
    
       ```sql
       CALL mysql.az_replication_change_master('master.companya.com', 'syncuser', 'P@ssword!', 3306, 'mariadb-bin.000016', 475, @cert);
       ```
   - Репликация без SSL

       Репликация без SSL настраивается между исходным сервером, размещенным в домене companya.com, и сервером реплики, размещенным в базе данных Azure для MariaDB. Эта хранимая процедура выполняется на реплике.

       ```sql
       CALL mysql.az_replication_change_master('master.companya.com', 'syncuser', 'P@ssword!', 3306, 'mariadb-bin.000016', 475, '');
       ```

2. Запустите репликацию.

   Вызовите `mysql.az_replication_start` хранимую процедуру, чтобы запустить репликацию.

   ```sql
   CALL mysql.az_replication_start;
   ```

3. Проверьте состояние репликации.

   Вызовите [`show slave status`](https://mariadb.com/kb/en/library/show-slave-status/) команду на сервере реплики, чтобы просмотреть состояние репликации.
    
   ```sql
   show slave status;
   ```

   Если `Slave_IO_Running` и `Slave_SQL_Running` находятся в состоянии `yes` , а значение `Seconds_Behind_Master` равно `0` , то репликация работает. `Seconds_Behind_Master` указывает величину задержки на реплике. Если значение не равно `0` , реплика обрабатывает обновления.

4. Обновите соответствующие переменные сервера, чтобы обеспечить безопасность репликации данных (требуется только для репликации без ГТИД).
    
    Из-за ограничений собственной репликации в MariaDB необходимо задать  [`sync_master_info`](https://mariadb.com/kb/en/library/replication-and-binary-log-system-variables/#sync_master_info) [`sync_relay_log_info`](https://mariadb.com/kb/en/library/replication-and-binary-log-system-variables/#sync_relay_log_info) переменные и в репликации без сценария гтид.

    Проверьте значения и переменные подчиненного сервера `sync_master_info` `sync_relay_log_info` , чтобы убедиться в стабильной репликации данных, и задайте для переменных значение `1` .
    
## <a name="other-stored-procedures"></a>Другие хранимые процедуры

### <a name="stop-replication"></a>Остановка репликации

Чтобы отключить репликацию между сервером источника и реплики, используйте следующую хранимую процедуру:

```sql
CALL mysql.az_replication_stop;
```

### <a name="remove-the-replication-relationship"></a>Удаление отношения репликации

Чтобы удалить связь между источником и сервером реплики, используйте следующую хранимую процедуру:

```sql
CALL mysql.az_replication_remove_master;
```

### <a name="skip-the-replication-error"></a>Пропустить ошибку репликации

Чтобы пропустить ошибку репликации и разрешить репликацию, используйте следующую хранимую процедуру:
    
```sql
CALL mysql.az_replication_skip_counter;
```

## <a name="next-steps"></a>Дальнейшие действия
См. дополнительные сведения о [репликации входных данных](concepts-data-in-replication.md) в базе данных Azure для MariaDB.
