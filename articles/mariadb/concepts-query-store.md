---
title: Хранилище запросов — База данных Azure для MariaDB
description: Сведения о функции хранилища запросов в службе "база данных Azure для MariaDB", чтобы помочь вам в отслеживании производительности с течением времени.
author: ajlam
ms.author: andrela
ms.service: mariadb
ms.topic: conceptual
ms.date: 3/18/2020
ms.openlocfilehash: a502638744009fc34a7f0a27f8034b89d2c8fa26
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "79527815"
---
# <a name="monitor-azure-database-for-mariadb-performance-with-query-store"></a>Мониторинг производительности базы данных Azure для MariaDB с помощью хранилища запросов

**Применимо к:** База данных Azure для MariaDB 10,2

Функция хранилища запросов в базе данных Azure для MariaDB позволяет контролировать производительность запросов с течением времени. Хранилище запросов упрощает устранение неполадок, позволяя быстро выявлять самые медленные и ресурсоемкие запросы. Хранилище запросов автоматически ведет журнал запросов и статистики выполнения и сохраняет их для просмотра. Этот компонент разделяет данные по периодам, давая представление о закономерностях использования баз данных. Данные для всех пользователей, баз данных и запросов хранятся в базе данных схемы **MySQL** в экземпляре базы данных Azure для MariaDB.

## <a name="common-scenarios-for-using-query-store"></a>Распространенные сценарии использования хранилища запросов

Хранилище запросов можно использовать во многих сценариях, включая следующие:

- обнаружение регрессивных запросов;
- определение числа выполнений запроса за данный период времени;
- сравнение среднего времени выполнения запроса за периоды времени для выявления больших расхождений;

## <a name="enabling-query-store"></a>Включение хранилища запросов

Хранилище запросов является дополнительной функцией, поэтому оно не активно на сервере по умолчанию. Хранилище запросов включается или отключается глобально для всех (но не для отдельных) баз данных на данном сервере.

### <a name="enable-query-store-using-the-azure-portal"></a>Включение хранилища запросов с помощью портала Azure

1. Войдите в портал Azure и выберите сервер базы данных Azure для MariaDB.
1. В разделе меню **Параметры** выберите **Параметры сервера**.
1. Найдите параметр query_store_capture_mode.
1. Задайте для него значение "ALL" и щелкните **Сохранить**.

Чтобы включить статистику ожидания в хранилище запросов, сделайте следующее.

1. Найдите параметр query_store_wait_sampling_capture_mode.
1. Задайте для него значение "ALL" и щелкните **Сохранить**.

Подождите около 20 минут, пока первый набор данных не сохранится в базе данных mysql.

## <a name="information-in-query-store"></a>Данные в хранилище запросов

Хранилище запросов включает два хранилища:

- Хранилище статистики времени выполнения для сохранения статистических данных о выполнении запроса.
- Хранилище статистики ожидания для сохранения сведений о статистике ожидания.

С целью экономии места к статистическим данным о выполнении запросов в хранилище статистики времени выполнения применяется агрегирование за фиксированный настраиваемый период. Сведения в этих хранилищах отображаются путем запроса представлений хранилища запросов.

Следующий запрос возвращает сведения о запросах в хранилище запросов:

```sql
SELECT * FROM mysql.query_store;
```

Это запрос статистики ожидания:

```sql
SELECT * FROM mysql.query_store_wait_stats;
```

## <a name="finding-wait-queries"></a>Поиск запросов ожидания

> [!NOTE]
> Сбор статистики ожидания не следует включать в часы пиковой рабочей нагрузки или же его следует включить на неограниченное время только для конфиденциальных рабочих нагрузок. <br>Для рабочих нагрузок, работающих с высокой загрузкой ЦП или на серверах с пониженным числом виртуальных ядер, будьте внимательны при включении сбора статистики ожидания. Ее не стоит включать на неограниченное время. 

Типы событий ожидания объединяют разные события ожидания в группы по принципу сходства. Хранилище запросов предоставляет тип события ожидания, имя определенного события ожидания и запрашиваемый запрос. Возможность сопоставлять эти сведения об ожидании со статистикой времени выполнения запроса позволяет получить более глубокое понимание аспектов, влияющих на характеристики производительности запросов.

Ниже приведены некоторые примеры получения более подробных сведений о рабочей нагрузке с помощью статистики ожидания в хранилище запросов.

| **Наблюдение** | **Действие** |
|---|---|
|Ожидания с высоким уровнем блокировки | Проверьте текст затронутых запросов и выявите целевые сущности. Найдите в хранилище запросов другие запросы, изменяющие ту же сущность, которые часто выполняются и (или) имеют большую длительность. Найдя такие запросы, рекомендуется изменить логику приложения, чтобы улучшить параллелизм, или использовать менее строгий уровень изоляции. |
|Ожидания с большим числом операций ввода-вывода буфера | Найдите в хранилище запросов запросы с большим числом физических операций чтения. Если они соответствуют запросам с высокими значениями ожидания ввода-вывода, попробуйте ввести индекс для базовой сущности, чтобы задать поиск вместо сканирования. Это позволит свести к минимуму затраты на операции ввода-вывода запросов. Ознакомьтесь с **рекомендациями по повышению производительности** серверов на портале: возможно, для этого сервера есть рекомендации по индексам, которые позволят оптимизировать запросы. |
|Ожидания с высокой загрузкой памяти | Найдите в хранилище запросов те запросы, которые используют больше всего памяти. Вероятнее всего, эти запросы препятствуют дальнейшей обработке затронутых запросов. Ознакомьтесь с **рекомендациями по повышению производительности** для сервера на портале: возможно, есть рекомендации по индексам, которые позволят оптимизировать запросы.|

## <a name="configuration-options"></a>Варианты настройки

При включении хранилища запросов оно сохраняет данные с 15-минутным периодом агрегирования: не более 500 уникальных запросов на период.

Ниже приведены настраиваемые параметры для хранилища запросов.

| **Параметр** | **Описание** | **Default** | **Range** |
|---|---|---|---|
| query_store_capture_mode | Включение или отключение функции хранилища запросов в зависимости от значения. Примечание. Если параметр performance_schema отключен, то включение параметра query_store_capture_mode включит performance_schema и набор инструментов схемы производительности, необходимых для работы этой функции. | ALL | NONE, ALL |
| query_store_capture_interval | Интервал записи в хранилище запросов в минутах. Позволяет указать интервал агрегирования метрик запросов. | 15 | 5–60 |
| query_store_capture_utility_queries | Включение или отключение сбора статистики всех запросов служебной программы, которые выполняются в системе. | NO | YES, NO |
| query_store_retention_period_in_days | Период времени в днях для хранения данных в хранилище запросов. | 7 | 1–30 |

Следующие параметры применяются исключительно к статистике ожидания.

| **Параметр** | **Описание** | **Default** | **Range** |
|---|---|---|---|
| query_store_wait_sampling_capture_mode | Позволяет включить и отключить сбор статистики ожидания. | None | NONE, ALL |
| query_store_wait_sampling_frequency | Изменяет частоту выборки времени ожидания в секундах. 5–300 секунд. | 30 | 5–300 |

> [!NOTE]
> В настоящее время **query_store_capture_mode** заменяет эту конфигурацию, то есть для сбора статистики ожидания нужно присвоить **query_store_capture_mode** и **query_store_wait_sampling_capture_mode** значение ALL. Если параметр **query_store_capture_mode** отключен, то сбор статистики ожидания отключается, так как эта функция использует включенный параметр performance_schema и значение query_text, записанное в хранилище запросов.

Используйте [портал Azure](howto-server-parameters.md) , чтобы получить или задать другое значение для параметра.

## <a name="views-and-functions"></a>Представления и функции

Просмотр и управление хранилищем запросов осуществляется с помощью следующих представлений и функций. Любой пользователь с [ролью select privilege public](howto-create-users.md#create-additional-admin-users) может использовать эти представления для просмотра данных в хранилище запросов. Эти представления доступны только в базе данных **mysql**.

Запросы нормализованы: обратите внимание на их структуру после удаления литералов и констант. Если два запроса идентичны, за исключением литеральных значений, они будут иметь один хэш.

### <a name="mysqlquery_store"></a>mysql.query_store

Это представление возвращает все данные в хранилище запросов. Для каждого отдельного идентификатора базы данных, идентификатора пользователя и идентификатора запроса используется отдельная строка.

| **имя**; | **Тип данных** | **IS_NULLABLE** | **Описание** |
|---|---|---|---|
| `schema_name`| varchar(64) | NO | Имя схемы. |
| `query_id`| bigint(20) | NO| Уникальный идентификатор, сформированный для конкретного запроса. Если тот же запрос выполняется в другой схеме, создается новый идентификатор. |
| `timestamp_id` | TIMESTAMP| NO| Метка времени выполнения запроса. Она основана на значении query_store_interval.|
| `query_digest_text`| longtext| NO| Нормализованный текст запроса после удаления всех литералов.|
| `query_sample_text` | longtext| NO| Первое вхождение фактического запроса с литералами.|
| `query_digest_truncated` | bit| YES| Указывает, был ли текст запроса усечен. Если длина запроса превышает 1 КБ, будет указано значение YES.|
| `execution_count` | bigint(20)| NO| Количество выполнений запроса для этого идентификатора метки времени или в течение заданного периода времени.|
| `warning_count` | bigint(20)| NO| Число предупреждений, созданных во время указанного периода.|
| `error_count` | bigint(20)| NO| Количество ошибок, созданных этим запросом в течение указанного периода.|
| `sum_timer_wait` | double| YES| Общее время выполнения этого запроса в течение указанного периода.|
| `avg_timer_wait` | double| YES| Среднее время выполнения этого запроса в течение указанного периода.|
| `min_timer_wait` | double| YES| Минимальное время выполнения этого запроса.|
| `max_timer_wait` | double| YES| Максимальное время выполнения.|
| `sum_lock_time` | bigint(20)| NO| Общее время, затраченное на все блокировки при выполнении этого запроса в течение указанного периода времени.|
| `sum_rows_affected` | bigint(20)| NO| количество затронутых строк.|
| `sum_rows_sent` | bigint(20)| NO| Количество строк, отправленных в клиент.|
| `sum_rows_examined` | bigint(20)| NO| Число проверенных строк.|
| `sum_select_full_join` | bigint(20)| NO| Число полных объединений.|
| `sum_select_scan` | bigint(20)| NO| Количество поисков с помощью инструкции SELECT. |
| `sum_sort_rows` | bigint(20)| NO| Количество отсортированных строк.|
| `sum_no_index_used` | bigint(20)| NO| Количество случаев, когда запрос не использовал индексы.|
| `sum_no_good_index_used` | bigint(20)| NO| Количество случаев, когда подсистема выполнения запросов не использовала правильные индексы.|
| `sum_created_tmp_tables` | bigint(20)| NO| Общее число созданных временных таблиц.|
| `sum_created_tmp_disk_tables` | bigint(20)| NO| Общее число временных таблиц, созданных на диске (с помощью операций ввода-вывода).|
| `first_seen` | TIMESTAMP| NO| Первое обнаружение (в формате UTC) запроса во время периода агрегирования.|
| `last_seen` | TIMESTAMP| NO| Последнее обнаружение (в формате UTC) запроса во время этого периода агрегирования.|

### <a name="mysqlquery_store_wait_stats"></a>mysql.query_store_wait_stats

Это представление возвращает данные событий ожидания в хранилище запросов. Для каждого отдельного идентификатора базы данных, идентификатора пользователя, идентификатора запроса и события используется отдельная строка.

| **имя**;| **Тип данных** | **IS_NULLABLE** | **Описание** |
|---|---|---|---|
| `interval_start` | TIMESTAMP | NO| Начало интервала (с приращением по 15 минут).|
| `interval_end` | TIMESTAMP | NO| Окончание интервала (с приращением по 15 минут).|
| `query_id` | bigint(20) | NO| Созданный уникальный идентификатор нормализованного запроса (из хранилища запросов).|
| `query_digest_id` | varchar(32) | NO| Нормализованный текст запроса после удаления всех литералов (из хранилища запросов). |
| `query_digest_text` | longtext | NO| Первое вхождение фактического запроса с литералами (из хранилища запросов). |
| `event_type` | varchar(32) | NO| Категория события ожидания. |
| `event_name` | varchar(128) | NO| Имя события ожидания. |
| `count_star` | bigint(20) | NO| Число событий ожидания, выбранных в течение интервала для запроса. |
| `sum_timer_wait_ms` | double | NO| Общее время ожидания (в миллисекундах) этого запроса в течение интервала. |

### <a name="functions"></a>Функции

| **имя**;| **Описание** |
|---|---|
| `mysql.az_purge_querystore_data(TIMESTAMP)` | Очистка всех данных хранилища запросов до заданной метки времени. |
| `mysql.az_procedure_purge_querystore_event(TIMESTAMP)` | Очистка всех данных событий ожидания до заданной метки времени. |
| `mysql.az_procedure_purge_recommendation(TIMESTAMP)` | Очистка рекомендаций, срок действия которых предшествует заданной метке времени. |

## <a name="limitations-and-known-issues"></a>Ограничения и известные проблемы

- Если сервер MariaDB имеет параметр `default_transaction_read_only` в, хранилище запросов не может записывать данные.
- Операции хранилища запросов могут быть прерваны при обнаружении длинных запросов в Юникоде (\>= 6000 байт).
- Период хранения статистики ожидания составляет 24 часа.
- Статистика ожидания использует образец TI для записи доли событий. Частоту выборки можно изменить с помощью параметра `query_store_wait_sampling_frequency`.

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте больше об [анализе производительности запросов](concepts-query-performance-insight.md).
