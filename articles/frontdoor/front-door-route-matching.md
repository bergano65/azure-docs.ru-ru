---
title: Передняя дверца Azure — мониторинг сопоставления правил маршрутизации | Документация Майкрософт
description: Эта статья поможет вам понять, как передняя дверца Azure соответствует правилу маршрутизации, используемому для входящего запроса.
services: front-door
documentationcenter: ''
author: sharad4u
ms.service: frontdoor
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/10/2018
ms.author: sharadag
ms.openlocfilehash: 420aa52293da14a0dfe8fbdfe681440ee4309e6b
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "80878601"
---
# <a name="how-front-door-matches-requests-to-a-routing-rule"></a>Как Front Door сопоставляет запросы и правила маршрутизации

После установления соединения и выполнения подтверждения TLS, когда запрос пытается в среде передней дверцы, одно из первых подвижок — определить из всех конфигураций, в которых конкретное правило маршрутизации будет соответствовать запросу, а затем выполнить определенное действие. В следующем документе объясняется, как служба Front Door определяет, какую конфигурацию маршрута использовать для обработки HTTP-запроса.

## <a name="structure-of-a-front-door-route-configuration"></a>Структура конфигурации маршрута Front Door
Конфигурация правила маршрутизации Front Door состоит из двух важных частей: левой и правой. Мы сопоставляем входящий запрос левой части маршрута, в то время как правая часть определяет способ обработки запроса.

### <a name="incoming-match-left-hand-side"></a>Входящее соответствие (левая сторона)
Следующие свойства определяют, соответствует ли входящий запрос правилу маршрутизации (левая сторона)

* **Протоколы HTTP** (HTTP/HTTPS)
* **Узлы** (например, www \. foo.com, \* . Bar.com);
* **Пути** (например, /\*, /users/\*, /file.gif)

Эти свойства развертываются внутри так, чтобы любое сочетание протоколов, узлов и путей становилось набором потенциальных соответствий.

### <a name="route-data-right-hand-side"></a>Данные маршрута (справа)
Решение по обработке запроса зависит от того, включено ли кэширование для конкретного маршрута или нет. Так, если у нас нет кэшированного ответа для запроса, запрос перенаправляется на соответствующий сервер в настроенном пуле серверов.

## <a name="route-matching"></a>Сопоставление маршрутов
В этом разделе основное внимание уделяется сопоставлению с заданным правилом маршрутизации Front Door. Суть в том, что сначала всегда выполняется сопоставление **наиболее конкретному соответствию**, мы смотрим только на "левую сторону".  Сначала мы устанавливаем соответствие по HTTP-протоколу, затем по узлу внешнего интерфейса, затем по пути.

### <a name="frontend-host-matching"></a>Сопоставление узла внешнего интерфейса
При сопоставлении узлов внешнего интерфейса мы используем следующую логику:

1. Следует искать любой маршрут с точным соответствием на узле.
2. Если точное соответствие среди узлов внешнего интерфейса не найдено, следует отклонить запрос и отправить ошибку 400: неверный запрос.

Чтобы рассмотреть эту процедуру еще подробнее, обратимся к примеру конфигурации маршрутов Front Door (только левая сторона):

| Правило маршрутизации | Узлы внешнего интерфейса | Path |
|-------|--------------------|-------|
| Объект | foo.contoso.com | /\* |
| B | foo.contoso.com | /users/\* |
| C | www \. Fabrikam.com, foo.Adventure-Works.com  | /\*, /images/\* |

Если следующие входящие запросы были отправлены во Front Door, они будут соответствовать следующим правилам маршрутизации (см. выше):

| Входящий узел внешнего интерфейса | Сопоставленные правила маршрутизации |
|---------------------|---------------|
| foo.contoso.com | A, B |
| www \. Fabrikam.com | C |
| images.fabrikam.com | Ошибка 400: неверный запрос |
| foo.adventure-works.com | C |
| contoso.com | Ошибка 400: неверный запрос |
| www \. Adventure-Works.com | Ошибка 400: неверный запрос |
| www \. northwindtraders.com | Ошибка 400: неверный запрос |

### <a name="path-matching"></a>Согласование путей
Определив конкретный узел внешнего интерфейса и отфильтровав возможные правила маршрутизации (оставив только маршруты с соответствующим узлом внешнего интерфейса), служба Front Door затем фильтрует правила маршрутизации на основе пути запроса. Мы используем ту же логику, что и узлы внешнего интерфейса:

1. Следует искать любое правило маршрутизации с точным соответствием по пути
2. Если путей с точным соответствием не найдено, ищите правила маршрутизации с соответствующим путем с символами подстановки
3. Если правила маршрутизации с соответствующим путем не найдены, отклоняйте запрос и возвращайте HTTP-ответ "Ошибка 400: неверный запрос".

>[!NOTE]
> Любые пути без подстановочного знака считаются путями точного соответствия. Даже если путь завершается косой чертой, он считается путем точного соответствия.

Чтобы пояснить это, давайте взглянем еще на несколько примеров:

| Правило маршрутизации | Узел внешнего интерфейса    | Path     |
|-------|---------|----------|
| Объект     | www\.contoso.com | /        |
| B     | www\.contoso.com | /\*      |
| C     | www\.contoso.com | /ab      |
| D     | www\.contoso.com | /abc     |
| E     | www\.contoso.com | /abc/    |
| F     | www\.contoso.com | /abc/\*  |
| G.     | www\.contoso.com | /abc/def |
| H     | www\.contoso.com | /path/   |

С учетом конфигурации в следующем примере таблицы сопоставлений будут представлены следующие данные:

| Входящий запрос    | Соответствующий маршрут |
|---------------------|---------------|
| www \. contoso.com/            | Объект             |
| www \. contoso.com/a           | B             |
| www \. contoso.com/AB          | C             |
| www \. contoso.com/ABC         | D             |
| www \. contoso.com/abzzz       | B             |
| www \. contoso.com/ABC/        | E             |
| www \. contoso.com/ABC/d       | F             |
| www \. contoso.com/ABC/DEF     | G.             |
| www \. contoso.com/ABC/defzzz  | F             |
| www \. contoso.com/ABC/DEF/GHI | F             |
| www \. contoso.com/Path        | B             |
| www \. contoso.com/Path/       | H             |
| www \. contoso.com/Path/ZZZ    | B             |

>[!WARNING]
> </br> Если нет правил маршрутизации для узла внешнего интерфейса с точным соответствием и универсальным путем маршрута (`/*`), то не будет соответствия и для любого правила маршрутизации.
>
> Пример конфигурации:
>
> | Маршрут | Узел             | Path    |
> |-------|------------------|---------|
> | Объект     | profile.contoso.com | /api/\* |
>
> Таблица соответствия:
>
> | Входящий запрос       | Соответствующий маршрут |
> |------------------------|---------------|
> | profile.domain.com/other | Отсутствует. Ошибка 400: неверный запрос |

### <a name="routing-decision"></a>Решение о маршрутизации
После того как мы выполнили сопоставление относительно одного правила маршрутизации Front Door, необходимо выбрать, как обработать запрос. Если для сопоставленного правила маршрутизации у Front Door имеется кэшированный ответ, он же отправляется клиенту. В противном случае далее оценивается следующее: настроили ли вы [перезапись URL-адреса (пользовательский путь перенаправления)](front-door-url-rewrite.md) для сопоставленного правила маршрутизации или нет. Если пользовательский путь перенаправления не определен, запрос перенаправляется на соответствующий сервер в настроенном пуле серверов как есть. В противном случае путь запроса обновляется согласно определенному [пользовательскому пути перенаправления](front-door-url-rewrite.md), а затем перенаправляется на сервер.

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о [создании Front Door](quickstart-create-front-door.md).
- Дополнительные сведения о том, [как работает Front Door](front-door-routing-architecture.md).
