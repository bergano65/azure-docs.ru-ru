---
title: Устранение неполадок доменных служб Azure Active Directory | Документация Майкрософт "
description: Узнайте, как устранять распространенные ошибки при создании доменных служб Azure Active Directory или управлении ими
services: active-directory-ds
author: iainfoulds
manager: daveba
ms.assetid: 4bc8c604-f57c-4f28-9dac-8b9164a0cf0b
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: conceptual
ms.date: 09/13/2019
ms.author: iainfou
ms.openlocfilehash: 5c2a8c8cfa2425985a22b93d4ade509320c48564
ms.sourcegitcommit: e97a0b4ffcb529691942fc75e7de919bc02b06ff
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/15/2019
ms.locfileid: "70998732"
---
# <a name="common-errors-and-troubleshooting-steps-for-azure-active-directory-domain-services"></a>Распространенные ошибки и действия по устранению неполадок для Azure Active Directory доменных служб

В качестве центральной части идентификации и проверки подлинности для приложений Azure Active Directory в доменных службах (Azure AD DS) иногда возникают проблемы. При возникновении проблем возникают некоторые распространенные сообщения об ошибках и связанные действия по устранению неполадок, которые помогут вам снова запустить систему. В любое время можно также [открыть запрос в службу поддержки Azure][azure-support] для получения дополнительных сведений об устранении неполадок.

В этой статье приведены действия по устранению распространенных проблем в Azure AD DS.

## <a name="you-cannot-enable-azure-ad-domain-services-for-your-azure-ad-directory"></a>Не удается включить доменные службы Azure AD для каталога Azure AD

Если у вас возникли проблемы с включением Azure AD DS, ознакомьтесь со следующими распространенными ошибками и действиями по их устранению:

| **Пример сообщения об ошибке** | **Способы устранения:** |
| --- |:--- |
| *Имя contoso.com уже используется в этой сети. Введите неиспользуемое имя.* |[Конфликт доменных имен в виртуальной сети](troubleshoot.md#domain-name-conflict) |
| *Не удалось включить доменные службы в этом клиенте Azure AD. У службы нет необходимых разрешений на доступ к приложению с именем Azure AD Domain Services Sync. Удалите приложение с именем Azure AD Domain Services Sync, а затем попробуйте снова включить доменные службы для своего клиента Azure AD.* |[Доменные службы не имеют достаточных разрешений для приложения синхронизации доменных служб Azure AD.](troubleshoot.md#inadequate-permissions) |
| *Не удалось включить доменные службы в этом клиенте Azure AD. У приложения доменных служб в клиенте Azure AD нет разрешений, необходимых для включения доменных служб. Удалите приложение с идентификатором d87dcbc6-a371-462e-88e3-28ad15ec4e64, а затем попробуйте снова включить доменные службы для своего клиента Azure AD.* |[Приложение доменных служб не настроено должным образом в клиенте Azure AD](troubleshoot.md#invalid-configuration) |
| *Не удалось включить доменные службы в этом клиенте Azure AD. Приложение Microsoft Azure AD отключено в клиенте Azure AD. Включите приложение с идентификатором 00000002-0000-0000-c000-000000000000, а затем попробуйте снова включить доменные службы для своего клиента Azure AD.* |[Приложение Microsoft Graph отключено в клиенте Azure AD](troubleshoot.md#microsoft-graph-disabled) |

### <a name="domain-name-conflict"></a>Конфликт доменных имен

**Сообщение об ошибке**

*Имя contoso.com уже используется в этой сети. Введите неиспользуемое имя.*

**Способы устранения:**

Убедитесь, что у вас нет существующей среды AD DS с таким же доменным именем в виртуальной сети. Например, у вас может быть домен AD DS с именем *contoso.com* , работающий на виртуальных машинах Azure. При попытке включить управляемый домен AD DS Azure с тем же доменным именем *contoso.com* в виртуальной сети запрошенная операция завершается ошибкой.

Эта ошибка вызвана конфликтом имен в имени домена в виртуальной сети. Поиск DNS проверяет, отвечает ли существующая среда AD DS на запрошенное доменное имя. Чтобы устранить эту ошибку, используйте другое имя для настройки управляемого домена Azure AD DS или отмените наполнение имеющегося домена AD DS и повторите попытку, чтобы включить AD DS Azure.

### <a name="inadequate-permissions"></a>Недостаточно разрешений

**Сообщение об ошибке**

*Не удалось включить доменные службы в этом клиенте Azure AD. У службы нет необходимых разрешений на доступ к приложению с именем Azure AD Domain Services Sync. Удалите приложение с именем Azure AD Domain Services Sync, а затем попробуйте снова включить доменные службы для своего клиента Azure AD.*

**Способы устранения:**

Проверьте, есть ли в каталоге Azure AD приложение с именем " *доменные службы Azure AD* ". Если это приложение существует, удалите его и повторите попытку, чтобы включить Azure AD DS. Чтобы проверить наличие существующего приложения и при необходимости удалить его, выполните следующие действия.

1. В портал Azure выберите **Azure Active Directory** в меню навигации слева.
1. Выберите **Корпоративные приложения**. Выберите *все приложения* в раскрывающемся меню **Тип приложения** , а затем нажмите кнопку **Применить**.
1. В поле поиска введите *Sync доменные службы Azure AD*. Если приложение существует, выберите его и нажмите кнопку **Удалить**.
1. После удаления приложения попробуйте снова включить Azure AD DS.

### <a name="invalid-configuration"></a>Недопустимая конфигурация

**Сообщение об ошибке**

*Не удалось включить доменные службы в этом клиенте Azure AD. У приложения доменных служб в клиенте Azure AD нет разрешений, необходимых для включения доменных служб. Удалите приложение с идентификатором d87dcbc6-a371-462e-88e3-28ad15ec4e64, а затем попробуйте снова включить доменные службы для своего клиента Azure AD.*

**Способы устранения:**

Проверьте, есть ли у вас приложение с именем *азуреактиведиректоридомаинконтроллерсервицес* с идентификатором приложения *D87dcbc6-a371-462e-88e3-28ad15ec4e64* в каталоге Azure AD. Если это приложение существует, удалите его и повторите попытку, чтобы включить Azure AD DS.

Используйте следующий сценарий PowerShell для поиска существующего экземпляра приложения и при необходимости удалите его.

```powershell
$InformationPreference = "Continue"
$WarningPreference = "Continue"

$aadDsSp = Get-AzureADServicePrincipal -Filter "AppId eq 'd87dcbc6-a371-462e-88e3-28ad15ec4e64'" -ErrorAction Ignore
if ($aadDsSp -ne $null)
{
    Write-Information "Found Azure AD Domain Services application. Deleting it ..."
    Remove-AzureADServicePrincipal -ObjectId $aadDsSp.ObjectId
    Write-Information "Deleted the Azure AD Domain Services application."
}

$identifierUri = "https://sync.aaddc.activedirectory.windowsazure.com"
$appFilter = "IdentifierUris eq '" + $identifierUri + "'"
$app = Get-AzureADApplication -Filter $appFilter
if ($app -ne $null)
{
    Write-Information "Found Azure AD Domain Services Sync application. Deleting it ..."
    Remove-AzureADApplication -ObjectId $app.ObjectId
    Write-Information "Deleted the Azure AD Domain Services Sync application."
}

$spFilter = "ServicePrincipalNames eq '" + $identifierUri + "'"
$sp = Get-AzureADServicePrincipal -Filter $spFilter
if ($sp -ne $null)
{
    Write-Information "Found Azure AD Domain Services Sync service principal. Deleting it ..."
    Remove-AzureADServicePrincipal -ObjectId $sp.ObjectId
    Write-Information "Deleted the Azure AD Domain Services Sync service principal."
}
```

### <a name="microsoft-graph-disabled"></a>Интерфейс Microsoft Graph отключен

**Сообщение об ошибке**

*Не удалось включить доменные службы в этом клиенте Azure AD. Приложение Microsoft Azure AD отключено в клиенте Azure AD. Включите приложение с идентификатором 00000002-0000-0000-c000-000000000000, а затем попробуйте снова включить доменные службы для своего клиента Azure AD.*

**Способы устранения:**

Проверьте, отключено ли приложение с идентификатором *00000002-0000-0000-C000-000000000000*. Это приложение Microsoft Azure AD, которое предоставляет доступ к API Graph вашему клиенту Azure AD. Чтобы синхронизировать клиент Azure AD, необходимо включить это приложение.

Чтобы проверить состояние этого приложения и включить его при необходимости, выполните следующие действия.

1. В портал Azure выберите **Azure Active Directory** в меню навигации слева.
1. Выберите **Корпоративные приложения**. Выберите *все приложения* в раскрывающемся меню **Тип приложения** , а затем нажмите кнопку **Применить**.
1. В поле поиска введите *00000002-0000-0000-C000-00000000000*. Выберите приложение, а затем щелкните **Свойства**.
1. Если параметр **включен для пользователей при входе** в систему установлен в значение *нет*, задайте для параметра *Да*, а затем нажмите кнопку **сохранить**.
1. После включения приложения попробуйте снова включить Azure AD DS.

## <a name="users-are-unable-to-sign-in-to-the-azure-ad-domain-services-managed-domain"></a>Пользователи не могут войти в домен, находящийся под управлением доменных служб Azure AD

Если один или несколько пользователей в клиенте Azure AD не могут войти в управляемый домен Azure AD DS, выполните следующие действия по устранению неполадок:

* **Формат учетных данных** — попробуйте использовать формат имени участника-пользователя, чтобы `dee@contoso.onmicrosoft.com`указать учетные данные, например. Формат UPN — это рекомендуемый способ указания учетных данных в AD DS Azure. Убедитесь, что имя участника-пользователя правильно настроено в Azure AD.

    *SamAccountName* для вашей учетной записи, например *контосо\дрилэй* , может быть автоматически создан, если в клиенте есть несколько пользователей с одним префиксом имени участника-пользователя или если префикс UPN слишком длинный. Поэтому формат *SamAccountName* для вашей учетной записи может отличаться от предполагаемого или используемого в локальном домене.

* **Синхронизация паролей** . Убедитесь, что вы включили синхронизацию паролей [только для облачных пользователей][cloud-only-passwords] или [гибридных сред, использующих Azure AD Connect][hybrid-phs].
    * **Гибридные синхронизированные учетные записи:** Если затронутые учетные записи пользователей синхронизируются из локального каталога, проверьте следующие области.
    
      * Вы развернули или обновили [последнюю рекомендуемую версию Azure AD Connect](https://www.microsoft.com/download/details.aspx?id=47594).
      * Вы настроили Azure AD Connect для [выполнения полной синхронизации][hybrid-phs].
      * В зависимости от размера каталога может потребоваться некоторое время, чтобы учетные записи пользователей и хэши учетных данных были доступны в AD DS Azure. Прежде чем пытаться пройти проверку подлинности в управляемом домене, убедитесь в наличии достаточного времени.
      * Если проблема сохраняется после проверки предыдущих шагов, попробуйте перезапустить *службу синхронизации Microsoft Azure AD*. На [виртуальной машине управления][management-vm]откройте командную строку и выполните следующие команды:
    
        ```console
        net stop 'Microsoft Azure AD Sync'
        net start 'Microsoft Azure AD Sync'
        ```

    * **Только облачные учетные записи**. Если затронутая учетная запись пользователя является облачной учетной записью пользователя, убедитесь, что [пользователь изменил пароль после включения Azure AD DS][cloud-only-passwords]. Этот сброс пароля вызывает создание необходимых хэшей учетных данных для доменных служб Azure AD.

* **Убедитесь, что учетная запись пользователя активна**: По умолчанию пять недопустимых попыток ввода пароля в течение 2 минут в управляемом домене приводят к блокировке учетной записи пользователя в течение 30 минут. Пользователь не может войти в систему, пока учетная запись заблокирована. Через 30 минут учетная запись пользователя будет автоматически разблокирована.
  * Недопустимые попытки ввода пароля в управляемом домене Azure AD DS не блокируйте учетную запись пользователя в Azure AD. Учетная запись пользователя заблокирована только в управляемом домене. Проверьте состояние учетной записи пользователя в *консоли администрирования Active Directory (ADAC)* с помощью [виртуальной машины управления][management-vm], а не в Azure AD.
  * Можно также [настроить точные политики паролей][password-policy] , чтобы изменить порог и длительность блокировки по умолчанию.

* **Внешние учетные записи** . Убедитесь, что затронутая учетная запись пользователя не является внешней учетной записью в клиенте Azure AD. Примеры внешних учетных записей включают учетные `dee@live.com` записи Майкрософт, такие как или учетные записи пользователей из внешнего каталога Azure AD. AD DS Azure не сохраняет учетные данные для внешних учетных записей пользователей, поэтому они не могут войти в управляемый домен.

## <a name="there-are-one-or-more-alerts-on-your-managed-domain"></a>Имеется одно или несколько оповещений для управляемого домена

Если в управляемом домене Azure AD DS есть активные предупреждения, это может препятствовать правильной работе процесса проверки подлинности.

Чтобы узнать, есть ли активные оповещения, [Проверьте состояние работоспособности управляемого домена AD DS Azure][check-health]. Если отображаются предупреждения, [устраните неполадки и устраните их][troubleshoot-alerts].

## <a name="users-removed-from-your-azure-ad-tenant-are-not-removed-from-your-managed-domain"></a>Пользователи, удаленные из вашего клиента Azure AD, не удаляются из управляемого домена

Azure AD защищает от случайного удаления объектов пользователей. При удалении учетной записи пользователя из клиента Azure AD соответствующий объект пользователя перемещается в корзину. Когда эта операция удаления синхронизируется с управляемым доменом AD DS Azure, соответствующая учетная запись пользователя помечается как отключенная. Эта функция помогает восстановить или отменить удаление учетной записи пользователя.

Учетная запись пользователя остается в отключенном состоянии в управляемом домене Azure AD DS, даже если вы повторно создаете учетную запись пользователя с тем же именем участника-пользователя в каталоге Azure AD. Чтобы удалить учетную запись пользователя из управляемого домена AD DS Azure, необходимо принудительно удалить его из клиента Azure AD.

Чтобы полностью удалить учетную запись пользователя из управляемого домена AD DS Azure, удалите пользователя из клиента Azure AD с помощью командлета PowerShell [Remove-MsolUser][Remove-MsolUser] с `-RemoveFromRecycleBin` параметром.

## <a name="next-steps"></a>Следующие шаги

Если у вас по-прежнему возникают проблемы, отправьте [запрос в службу поддержки Azure][azure-support] для получения дополнительных сведений об устранении неполадок.

<!-- INTERNAL LINKS -->
[cloud-only-passwords]: tutorial-create-instance.md#enable-user-accounts-for-azure-ad-ds
[hybrid-phs]: tutorial-configure-password-hash-sync.md
[management-vm]: tutorial-create-management-vm.md
[password-policy]: password-policy.md
[check-health]: check-health.md
[troubleshoot-alerts]: troubleshoot-alerts.md
[Remove-MsolUser]: /powershell/module/MSOnline/Remove-MsolUser
[azure-support]: ../active-directory/fundamentals/active-directory-troubleshooting-support-howto.md
