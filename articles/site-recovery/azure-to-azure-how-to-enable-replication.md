---
title: Настройка репликации для виртуальных машин Azure в Azure Site Recovery | Документация Майкрософт
description: В этой статье описывается, как настроить репликацию для виртуальных машин Azure между регионами Azure с помощью Site Recovery.
services: site-recovery
author: asgang
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 11/27/2018
ms.author: asgang
ms.openlocfilehash: 79ad4b3598c227ad2c2e3b76562cf95a30e82ad3
ms.sourcegitcommit: 30d23a9d270e10bb87b6bfc13e789b9de300dc6b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2019
ms.locfileid: "54101553"
---
# <a name="replicate-azure-virtual-machines-to-another-azure-region"></a>Репликация виртуальных машин Azure в другой регион Azure



В этой статье описывается, как включить репликацию виртуальных машин Azure между регионами Azure.

## <a name="prerequisites"></a>Предварительные требования

В этой статье предполагается, что у вас уже есть настроенный Site Recovery для этого сценария, как описано в руководстве [Set up disaster recovery for Azure VMs to a secondary Azure region (Preview)](azure-to-azure-tutorial-enable-replication.md) (Настройка аварийного восстановления виртуальных машин Azure в дополнительный регион Azure (предварительная версия)). Убедитесь, что у вас есть необходимые компоненты и создано хранилище служб восстановления.



## <a name="enable-replication"></a>Включение репликации

Включите репликацию. Предполагается, что основной регион Azure — это "Восточная Азия", а дополнительный — "Юго-Восточная Азия".

1. В хранилище щелкните **+Replicate** (+Репликация).
2. Обратите внимание на следующие поля:
    - **Источник**. Источник происхождения виртуальных машин, в нашем примере это **Azure**.
    - **Расположение источника**. Регион Azure, в котором вы хотите защитить свои виртуальные машины. В этом примере исходным расположением является "Восточная Азия".
    - **Модель развертывания**. Модель развертывания Azure для исходных компьютеров.
    - **Исходная подписка**. Подписка, к которой принадлежат исходные виртуальные машины. Это может быть любая подписка в одном клиенте Azure Active Directory, где существует хранилище служб восстановления.
    - **Группа ресурсов**. Группа ресурсов, к которой принадлежат исходные виртуальные машины. Для защиты на следующем шаге будут перечислены все виртуальные машины в выбранной группе ресурсов.

    ![Включение репликации](./media/site-recovery-replicate-azure-to-azure/enabledrwizard1.png)

3. В разделе **Виртуальные машины > Выбор виртуальных машин** выберите все виртуальные машины, которые нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Затем нажмите кнопку **ОК**.
    ![Включение репликации](./media/site-recovery-replicate-azure-to-azure/virtualmachine_selection.png)

4. В разделе **Параметры** можно при необходимости настроить параметры целевого веб-сайта:

    - **Целевое расположение**. Расположение, в которое будут реплицированы данные исходных виртуальных машин. В зависимости от расположения выбранной машины Site Recovery предоставит список подходящих целевых регионов. Мы рекомендуем сохранить такое же целевое расположение, что и расположение хранилищ служб восстановления.
    - **Целевая подписка**. Целевая подписка, которая используется для аварийного восстановления. По умолчанию целевая подписка будет совпадать с исходной подпиской.
    - **Целевая группа ресурсов**. Группа ресурсов, в которой будут находиться все реплицированные виртуальные машины. По умолчанию Azure Site Recovery создаст группу ресурсов в целевом регионе с суффиксом "asr". Если группа ресурсов, создаваемая Azure Site Recovery, уже существует, она будет использована повторно. Можно также настроить ее, как показано в следующем разделе. Целевая группа ресурсов может располагаться в любом регионе Azure, за исключением того, в котором размещены исходные виртуальные машины.
    - **Целевая виртуальная сеть**. По умолчанию Site Recovery создает в целевом регионе виртуальную сеть с суффиксом asr. Она будет сопоставлена с исходной сетью и будет использоваться для защиты в будущем. [Узнайте больше](site-recovery-network-mapping-azure-to-azure.md) о сетевом сопоставлении.
    - **Целевые учетные записи хранения (если исходная виртуальная машина не использует управляемые диски)**. По умолчанию Site Recovery создает целевую учетную запись хранения, копируя конфигурацию хранилища с исходной виртуальной машины. В случае, если учетная запись хранения уже существует, она используется повторно.
    - **Управляемые диски реплики (если исходная виртуальная машина использует управляемые диски)**. Служба Site Recovery создает управляемые диски реплики в целевом регионе, которые отражают управляемые диски исходной виртуальной машины с тем же типом хранилища (класса "Стандартный" или "Премиум"), что и на управляемом диске исходной виртуальной машины.
    - **Учетные записи хранения кэша**. Для Site Recovery в исходном регионе должна существовать дополнительная учетная запись хранения, называемая учетной записью хранения кэша. Все изменения, происходящие на исходных виртуальных машинах, отслеживаются и отправляются учетной записи хранения кэша перед репликацией в целевое расположение.
    - **Целевые группы доступности**. По умолчанию Azure Site Recovery создает в целевом регионе группу доступности, добавляя к ее имени суффикс "asr" для определения виртуальных машин, входящих в эту группу доступности. Если группа доступности, создаваемая Azure Site Recovery, уже существует, она будет использована повторно.
    - **Целевые зоны доступности**. По умолчанию Site Recovery назначает в целевом регионе тот же номер зоны, что и в исходном регионе, если целевой регион поддерживает зоны доступности.

    Если целевой регион не поддерживает зоны доступности, целевые виртуальные машины настраиваются как отдельные экземпляры по умолчанию. При необходимости можно включить такие виртуальные машины в группы доступности в целевом регионе. Для этого нажмите кнопку "Настроить".

    >[!NOTE]
    >После включения репликации изменить тип доступности (один экземпляр), группу доступности или зону доступности нельзя. Чтобы изменить тип доступности, необходимо отключить и повторно включить репликацию.
    >
    
    - **Политика репликации**. Определяет параметры для журнала хранения точки восстановления и периодичность создания моментальных снимков, совместимых на уровне приложений. По умолчанию Azure Site Recovery создает политику репликации с параметрами по умолчанию "24 часа" для хранения точки восстановления и "60 минут" — для периодичности создания моментальных снимков с согласованием приложений.

    ![Включение репликации](./media/site-recovery-replicate-azure-to-azure/enabledrwizard3.PNG)
  
## <a name="customize-target-resources"></a>Настройка целевых ресурсов

Можно изменить целевые параметры по умолчанию, используемые Site Recovery.

1. Нажмите кнопку **Настройка** рядом с пунктом "Целевая подписка", чтобы изменить целевую подписку по умолчанию. Выберите подписку из списка подписок, доступных в одном клиенте Azure Active Directory (AAD).

2. Щелкните **Настроить**, чтобы изменить параметры по умолчанию:
    - **Целевая группа ресурсов**. Выберите группу ресурсов из списка групп ресурсов в целевом расположении подписки.
    - **Target Virtual Network** (Целевая виртуальная сеть). Выберите сеть из списка всех виртуальных сетей в целевой локации.
    - **Группа доступности**. Здесь можно добавить параметры группы доступности для виртуальной машины, если она является частью группы доступности исходного региона.
    - **Target Storage accounts** (Целевые учетные записи хранения). Выберите учетную запись хранения, которую нужно использовать.

        ![Включение репликации](./media/site-recovery-replicate-azure-to-azure/customize.PNG)
1. Щелкните **Настроить**, чтобы изменить настройки репликации.
   - В разделе **Согласованность нескольких виртуальных машин** выберите виртуальные машины, которые необходимо реплицировать. 
   - На всех компьютерах в группе репликации будут общие отказоустойчивые и согласованные точки восстановления после отработки отказа. Включение согласованности нескольких виртуальных машин может повлиять на производительность рабочей нагрузки (так как это является интенсивным использованием ресурсов ЦП). Поэтому ее необходимо использовать, только если компьютеры выполняют одну и ту же рабочую нагрузку и вам необходима согласованность между ними. Например, если приложение имеет 2 виртуальные машины SQL и 2 веб-сервера, вам следует добавить только виртуальные машины SQL в состав группы репликации.
   - Вы можете выбрать максимум 16 виртуальных машин в группе репликации.
   - Если включить согласованность между виртуальными машинами, компьютеры в группе репликации будут обмениваться данными друг с другом через порт 20004. Убедитесь, что нет устройства брандмауэра, которое блокирует внутренний обмен данными между виртуальными машинами через порт 20004. Если вы хотите, чтобы виртуальные машины Linux входили в группу репликации, нужно вручную открыть исходящий трафик через порт 20004 согласно указаниям для конкретной версии Linux.
![Включение репликации](./media/site-recovery-replicate-azure-to-azure/multivmsettings.PNG)
    
2. Щелкните **Create target resource** (Создать целевой ресурс) > **Включить репликацию**.
3. После включения репликации виртуальных машин можно проверить их состояние работоспособности в разделе **Реплицированные элементы**.

>[!NOTE]
>Во время начальной репликации обновление состояния может занять некоторое время (без видимого прогресса). Щелкните **Обновить**, чтобы получить последние сведения о состоянии задания.
>

# <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения о выполнении тестовой отработки отказа см. в [этой статье](site-recovery-test-failover-to-azure.md).
