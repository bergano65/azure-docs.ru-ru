---
title: Устранение неполадок репликации виртуальных машин Azure с помощью Azure Site Recovery
description: Устранение неполадок репликации в аварийном восстановлении виртуальной машины Azure с помощью Azure Site Recovery
author: sideeksh
manager: rochakm
ms.topic: troubleshooting
ms.date: 8/2/2019
ms.openlocfilehash: e5e52c6e8560c7369054cfc9fcf2ba4c405671e0
ms.sourcegitcommit: b07964632879a077b10f988aa33fa3907cbaaf0e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/13/2020
ms.locfileid: "77190814"
---
# <a name="troubleshoot-replication-in-azure-vm-disaster-recovery"></a>Устранение неполадок репликации в аварийном восстановлении виртуальной машины Azure

В этой статье рассматриваются распространенные проблемы с Azure Site Recovery, возникающие при репликации и восстановлении виртуальных машин Azure из одного региона в другой. Здесь также объясняется, как устранять распространенные проблемы. Дополнительные сведения о поддерживаемых конфигурациях см. в статье [Azure Site Recovery support matrix for replicating from Azure to Azure](site-recovery-support-matrix-azure-to-azure.md) (Матрица поддержки Azure Site Recovery для репликации виртуальных машин из Azure в Azure).

Azure Site Recovery согласованно реплицирует данные из исходного региона в регион аварийного восстановления. Она также создает отказоустойчивую точку восстановления каждые 5 минут. Если службе Site Recovery не удается создать точки восстановления в течение 60 минут, она уведомляет об этом:

Сообщение об ошибке: "нет доступной отказоустойчивой точки восстановления для виртуальной машины за последние 60 минут".</br>
Идентификатор ошибки: 153007

В следующих разделах описаны причины и способы устранения неполадок.

## <a name="high-data-change-rate-on-the-source-virtal-machine"></a>Высокая частота изменения данных на исходной виртуальной машине

Azure Site Recovery создает событие, если скорость изменения данных на исходной виртуальной машине превышает поддерживаемые ограничения. Чтобы узнать, связана ли проблема с высоким уровнем обновления, перейдите в раздел **реплицированные элементы** > **виртуальная машина** > **события — последние 72 часов**.
Должно отобразиться событие "частота изменения данных превышает поддерживаемые ограничения":

![Azure Site Recovery страница, на которой показана слишком высокая частота изменения данных](./media/site-recovery-azure-to-azure-troubleshoot/data_change_event.png)

Если выбрать это событие, вы увидите точные сведения о диске.

![Страница, на которой показаны сведения о событии частоты изменения данных](./media/site-recovery-azure-to-azure-troubleshoot/data_change_event2.png)

### <a name="azure-site-recovery-limits"></a>Ограничения Azure Site Recovery

В таблице ниже приведены ограничения Azure Site Recovery. Эти ограничения основаны на наших тестах, но они не охватывают все возможные сочетания ввода-вывода в приложении. Фактические результаты зависят от сочетания операций ввода-вывода приложения.

Существует два ограничения, которые следует учитывать: обработка данных на диск и обработка данных на каждой виртуальной машине. Например, рассмотрим диск Premium P20 в следующей таблице. Для одной виртуальной машины Site Recovery может выполнять обработку 5 МБ/с на один диск, не более пяти таких дисков. Site Recovery имеет ограничение в 25 МБ/с от общего количества обновлений на виртуальную машину.

**Целевое хранилище репликации** | **Среднее число операций ввода-вывода для исходного диска** |**Средняя частота обновления данных для исходного диска** | **Общая частота обновления данных в день для исходного диска данных**
---|---|---|---
Хранилище уровня "Стандартный" | 8 КБ | 2 МБ/с | 168 ГБ на диск
Диск P10 или P15 класса Premium | 8 КБ  | 2 МБ/с | 168 ГБ на диск
Диск P10 или P15 класса Premium | 16 КБ | 4 МБ/с |  336 ГБ на диск
Диск P10 или P15 класса Premium | 32 КБ или выше | 8 МБ/с | 672 ГБ на диск
Диск P20, P30, P40 или P50 класса Premium | 8 КБ    | 5 МБ/с | 421 ГБ на диск
Диск P20, P30, P40 или P50 класса Premium | 16 КБ или выше |10 МБ/с | 842 ГБ на диск

### <a name="solution"></a>Решение

Azure Site Recovery имеет ограничения на скорость изменения данных в зависимости от типа диска. Чтобы узнать, является ли проблема повторяющейся или временной, найдите частоту изменения данных для затронутой виртуальной машины. Выберите исходную виртуальную машину, найдите метрики в разделе **Мониторинг** и добавьте метрики, как показано на снимке экрана ниже.

![Страница, на которой показан процесс, сокоторый в три этапа для поиска скорости изменения данных](./media/site-recovery-azure-to-azure-troubleshoot/churn.png)

1. Выберите **Добавить метрику**, а затем добавьте **Скорость записи на диск ОС (байт/с)** и **Скорость записи на диск данных (байт/с)** .
1. Отслеживайте пики, как показано на снимке экрана.
1. Просмотрите общее количество операций записи на дисках ОС и на всех дисках данных. Эти метрики могут не содержать сведения на уровне отдельных дисков, но они указывают общий шаблон частоты обновления данных.

Пиковая скорость изменения данных может поступать с нерегулярным увеличением данных. Если скорость изменения данных превышает 10 МБ/с (для уровня Premium) или 2 МБ/с (для уровня "Стандартный") и не работает, репликация будет остановлена. Если обновление постоянно выходит за пределы поддерживаемого ограничения, рассмотрите один из следующих вариантов:

- Исключите диск, который вызывает высокую частоту изменения данных: сначала отключите репликацию. После этого можно исключить диск с помощью [PowerShell](./azure-to-azure-exclude-disks.md).
- Изменение уровня диска хранилища аварийного восстановления. Этот вариант возможен только в том случае, если объем данных диска не превышает 20 МБ/с. Предположим, что виртуальная машина с диском P10 имеет объем данных больше 8 МБ/с, но менее 10 МБ/с. Если клиент может использовать диск P30 для целевого хранилища во время защиты, эту проблему можно устранить. Это решение возможно только для компьютеров, использующих диски с управлением уровня "Премиум". Выполните следующие действия.

    1. Перейдите на **диски** затронутой реплицированной машины и скопируйте имя диска реплики.
    1. Перейдите к этой реплике управляемого диска.
    1. В разделе Обзор вы можете увидеть баннер с сообщением **о** том, что был создан URL-адрес SAS. Выберите этот баннер и отмените экспорт. Пропустите этот шаг, если баннер не отображается.
    1. Как только URL-адрес SAS будет отозван, перейдите в раздел **Конфигурация** для управляемого диска. Увеличьте размер, чтобы Site Recovery поддерживала наблюдаемую скорость обработки на исходном диске.

## <a name="Network-connectivity-problem"></a>Проблемы с сетью

### <a name="network-latency-to-a-cache-storage-account"></a>Задержка в сети при обращении к учетной записи хранения кэша

Site Recovery отправляет реплицированные данные в учетную запись хранения кэша. Если передача данных из виртуальной машины в учетную запись хранения кэша выполняется медленнее 4 МБ в течение 3 секунд, может возникнуть задержка в сети.

Чтобы проверить наличие проблемы, связанной с задержкой, используйте [AzCopy](https://docs.microsoft.com/azure/storage/common/storage-use-azcopy). Эту служебную программу командной строки можно использовать для передачи данных из виртуальной машины в учетную запись хранения кэша. Если задержка высока, проверьте, используется ли виртуальный сетевой модуль (NVA) для управления исходящим сетевым трафиком с виртуальных машин. Если весь трафик репликации проходит через сетевой виртуальный модуль, к модулю может применяться регулирование.

Мы рекомендуем создать конечную точку службы сети в виртуальной сети для хранилища, чтобы трафик репликации не передавался в виртуальный сетевой модуль. Дополнительные сведения можно найти в разделе [Настройка виртуального сетевого модуля](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-about-networking#network-virtual-appliance-configuration).

### <a name="network-connectivity"></a>Сетевое подключение

Для работы Site Recovery репликации требуется виртуальная машина для обеспечения исходящего подключения к конкретным URL-адресам или диапазонам IP-адресов. Возможно, ваша виртуальная машина находится за брандмауэром или для управления исходящими подключениями используются правила группы безопасности сети (NSG). В этом случае могут возникнуть проблемы. Сведения о том, как убедиться, что все URL-адреса подключены, см. в разделе [Исходящие подключения для диапазонов IP-адресов](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-about-networking#outbound-connectivity-for-ip-address-ranges).

## <a name="error-id-153006---no-app-consistent-recovery-point-available-for-the-vm-in-the-past-x-minutes"></a>Идентификатор ошибки 153006-нет доступной для виртуальной машины точки восстановления с постоянными приложениями за последние "X" минут

Ниже приведены некоторые из наиболее распространенных проблем.

#### <a name="known-issue-in-sql-server-20082008-r2"></a>Известная ошибка в SQL Server 2008/2008 R2

**Как исправить**: существует известная проблема с SQL Server 2008/2008 R2. См. статью [Azure Site Recovery агент или другая некомпонентная архивация VSS для сервера, на котором размещена SQL Server 2008 R2](https://support.microsoft.com/help/4504103/non-component-vss-backup-fails-for-server-hosting-sql-server-2008-r2).

#### <a name="azure-site-recovery-jobs-fail-on-servers-hosting-any-version-of-sql-server-instances-with-auto_close-dbs"></a>Сбой заданий Azure Site Recovery на серверах, где размещается любая версия SQL Server экземпляров с AUTO_CLOSE баз данных

**Инструкции по исправлению**: см. статью [некомпонентные РЕЗЕРВные копии VSS, такие как задания Azure Site Recovery сбой на серверах, где размещены экземпляры SQL Server с AUTO_CLOSE баз данных](https://support.microsoft.com/help/4504104/non-component-vss-backups-such-as-azure-site-recovery-jobs-fail-on-ser).


#### <a name="known-issue-in-sql-server-2016-and-2017"></a>Известная ошибка в SQL Server 2016 и 2017

**Инструкции по исправлению**: [при создании резервной копии виртуальной машины с резервной копией, не основанной на компонентах, в SQL Server 2016 и 2017 возникает ошибка](https://support.microsoft.com/help/4493364/fix-error-occurs-when-you-back-up-a-virtual-machine-with-non-component).

#### <a name="youre-using-azure-storage-spaces-direct-configuration"></a>Вы используете конфигурацию Локальные дисковые пространства Azure

**Как исправить**: Azure Site Recovery не удается создать точку восстановления с постоянным приложением для конфигурации Локальные дисковые пространства. [Настройте политику репликации](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-how-to-enable-replication-s2d-vms).

### <a name="more-causes-because-of-vss-related-issues"></a>Причины возникновения проблем, связанных с VSS:

Для дальнейшего устранения неполадок проверьте файлы на исходном компьютере, чтобы получить точный код ошибки для ошибки:

    C:\Program Files (x86)\Microsoft Azure Site Recovery\agent\Application Data\ApplicationPolicyLogs\vacp.log

Чтобы найти ошибки в файле, выполните поиск строки "Вакперрор", открыв файл vacp. log в редакторе.

    Ex: vacpError:220#Following disks are in FilteringStopped state [\\.\PHYSICALDRIVE1=5, ]#220|^|224#FAILED: CheckWriterStatus().#2147754994|^|226#FAILED to revoke tags.FAILED: CheckWriterStatus().#2147754994|^|

В предыдущем примере **2147754994** — это код ошибки, который сообщает о сбое после этого предложения.

#### <a name="vss-writer-is-not-installed---error-2147221164"></a>Модуль записи VSS не установлен — ошибка 2147221164

**Как исправить**: чтобы создать тег согласованности приложений, Azure Site Recovery использует служба ТЕНЕВОГО копирования ТОМОВ (VSS). Site Recovery устанавливает поставщик VSS для его работы, чтобы получить моментальные снимки согласованности приложений. Azure Site Recovery устанавливает этот поставщик VSS как службу. Если поставщик VSS не установлен, создание моментального снимка согласованности приложений завершится ошибкой. В нем отображается идентификатор ошибки 0x80040154 "класс не зарегистрирован". См. статью об [устранении неполадок при установке модуля записи VSS](https://docs.microsoft.com/azure/site-recovery/vmware-azure-troubleshoot-push-install#vss-installation-failures).

#### <a name="vss-writer-is-disabled---error-2147943458"></a>Модуль записи VSS отключен — ошибка 2147943458

**Как исправить**: чтобы создать тег согласованности приложений, Azure Site Recovery использует VSS. Site Recovery устанавливает поставщик VSS для его работы, чтобы получить моментальные снимки согласованности приложений. Этот поставщик VSS устанавливается как служба. Если служба поставщика VSS не включена, создание моментального снимка согласованности приложений завершится ошибкой. Отображается ошибка "указанная служба отключена и не может быть запущена (0x80070422)".

Если служба VSS отключена:

- Убедитесь, что для параметра Тип запуска службы поставщика VSS задано значение **автоматически**.
- Перезапустите следующие службы:
   - Служба VSS
   - поставщик VSS Azure Site Recovery.
   - Служба VDS

#### <a name="vss-provider-not_registered---error-2147754756"></a>Поставщик VSS NOT_REGISTERED-ошибка 2147754756

**Как исправить**: чтобы создать тег согласованности приложений, Azure Site Recovery использует VSS. Проверьте, установлена ли служба поставщика VSS Azure Site Recovery.

Чтобы переустановить поставщик VSS, используйте следующие команды:
1. Удаление существующего поставщика: C:\Program Files (x86) \Microsoft Azure site Рековери\ажент\ InMageVSSProvider_Uninstall. cmd
1. Переустановите поставщик VSS: C:\Program Files (x86) \Microsoft Azure site Рековери\ажент\ InMageVSSProvider_Install. cmd

Убедитесь, что для параметра Тип запуска службы поставщика VSS задано значение **автоматически**.

Перезапустите следующие службы:
- Служба VSS
- поставщик VSS Azure Site Recovery.
- Служба VDS
