---
title: Настройка аварийного восстановления для SQL Server с помощью SQL Server и Azure Site Recovery | Документация Майкрософт
description: В этой статье описывается, как настроить аварийное восстановление для SQL Server с помощью SQL Server и Azure Site Recovery.
services: site-recovery
author: sujayt
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 08/02/2019
ms.author: sutalasi
ms.openlocfilehash: 79428520eed95e6e79f29e1676e2711e6ee24087
ms.sourcegitcommit: f3f4ec75b74124c2b4e827c29b49ae6b94adbbb7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/12/2019
ms.locfileid: "70934834"
---
# <a name="set-up-disaster-recovery-for-sql-server"></a>Настройка аварийного восстановления для SQL Server

В этой статье описывается, как защитить SQL Server серверной части приложения. Это можно сделать, используя SQL Server сочетание технологий непрерывности бизнес-процессов и аварийного восстановления (BCDR) и [Azure Site Recovery](site-recovery-overview.md).

Прежде чем начать, убедитесь, что вы понимаете SQL Server возможности аварийного восстановления. К этим возможностям относятся следующие:

* Отказоустойчивая кластеризация
* Группы доступности AlwaysOn
* Зеркальное отображение базы данных
* Доставка журналов
* Активная георепликация
* Группы автоматической отработки отказа

## <a name="combining-bcdr-technologies-with-site-recovery"></a>Объединение технологий BCDR с Site Recovery

При выборе технологии BCDR для восстановления экземпляров SQL Server должны быть основаны на целевом времени восстановления (RTO) и требуемой цели точки восстановления (RPO), как описано в следующей таблице. Объедините Site Recovery с операцией отработки отказа выбранной технологии, чтобы управлять восстановлением всего приложения.

Тип развертывания | Технология BCDR | Ожидалось RTO для SQL Server | Ожидаемая RPO для SQL Server |
--- | --- | --- | ---
SQL Server на виртуальную машину Azure в виде службы (IaaS) или в локальной среде.| [Группы доступности AlwaysOn](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server?view=sql-server-2017) | Время, затраченное на создание вторичной реплики в качестве первичной. | Так как репликация на вторичную реплику является асинхронной, возможна некоторая часть данных.
SQL Server на виртуальной машине Azure IaaS или в локальной среде.| [Отказоустойчивая кластеризация (AlwaysOn FCI)](https://docs.microsoft.com/sql/sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server?view=sql-server-2017) | Время, затраченное на отработку отказа между узлами. | Так как Always On FCI использует общее хранилище, для отработки отказа доступно то же представление экземпляра хранилища.
SQL Server на виртуальной машине Azure IaaS или в локальной среде.| [Зеркальное отображение базы данных (режим высокой производительности)](https://docs.microsoft.com/sql/database-engine/database-mirroring/database-mirroring-sql-server?view=sql-server-2017) | Время, затраченное на принудительное выполнение службы, в котором зеркальный сервер используется в качестве сервера «горячего» резервирования. | Репликация выполняется асинхронно. Зеркальная база данных может немного отставать от основной базы данных. Задержка обычно мала. Но он может стать большим, если система основного или зеркального сервера находится под большой нагрузкой.<br/><br/>Доставка журналов может быть дополнением к зеркальному отображению базы данных. Это является приемлемой альтернативой асинхронному зеркальному отображению базы данных.
SQL как платформа как услуга (PaaS) в Azure.<br/><br/>Этот тип развертывания включает эластичные пулы и серверы базы данных SQL Azure. | Активная георепликация | 30 секунд после отработки отказа.<br/><br/>При активации отработки отказа для одной из баз данных-получателей все остальные вторичные реплики автоматически связываются с новым сервером-источником. | RPO, равное пяти секундам.<br/><br/>Активная Георепликация использует Always Onную технологию SQL Server. Она асинхронно реплицирует зафиксированные транзакции в базе данных-источнике в базу данных получателя с помощью изоляции моментального снимка.<br/><br/>Вторичные данные гарантированно никогда не имеют частичных транзакций.
SQL AS PaaS, настроенный с активной георепликацией в Azure.<br/><br/>Этот тип развертывания включает в себя управляемый экземпляр базы данных SQL, эластичные пулы и серверы баз данных SQL. | Группы автоматической отработки отказа | RTO — один час. | RPO, равное пяти секундам.<br/><br/>Группы автоматической отработки отказа обеспечивают семантику группы поверх активной георепликации. Но используется тот же механизм асинхронной репликации.
SQL Server на виртуальной машине Azure IaaS или в локальной среде.| Репликация с Azure Site Recovery | Значение RTO обычно меньше 15 минут. Чтобы узнать больше, прочитайте [соглашение об уровне обслуживания RTO, предоставляемое Site Recovery](https://azure.microsoft.com/support/legal/sla/site-recovery/v1_2/). | Один час для согласованности приложений и пять минут для согласованности при сбоях. Если вы ищете более низкие значения RPO, используйте другие технологии BCDR.

> [!NOTE]
> Ниже приведено несколько важных вопросов, которые помогут защитить рабочие нагрузки SQL с помощью Site Recovery.
> * Site Recovery не зависит от приложения. Site Recovery может помочь защитить любую версию SQL Server, развернутую в поддерживаемой операционной системе. Дополнительные сведения см. в [матрице поддержки для восстановления](vmware-physical-azure-support-matrix.md#replicated-machines) реплицированных компьютеров.
> * Вы можете использовать Site Recovery для любого развертывания в Azure, Hyper-V, VMware или физической инфраструктуре. Следуйте указаниям в конце этой статьи, [чтобы помочь защитить кластер SQL Server](#how-to-help-protect-a-sql-server-cluster) с Site Recovery.
> * Убедитесь, что частота изменения данных на компьютере находится в пределах [Site Recovery ограничений](vmware-physical-azure-support-matrix.md#churn-limits). Частота изменений измеряется в байтах записи в секунду. Для компьютеров под управлением Windows можно просмотреть эту частоту изменений, выбрав вкладку " **производительность** " в диспетчере задач. Обратите внимание на скорость записи для каждого диска.
> * Site Recovery поддерживает репликацию экземпляров отказоустойчивого кластера на Локальные дисковые пространства. Дополнительные сведения см. в разделе [Включение репликации Локальные дисковые пространства](azure-to-azure-how-to-enable-replication-s2d-vms.md).

## <a name="disaster-recovery-of-an-application"></a>Аварийное восстановление приложения

Site Recovery позволяет управлять тестовой отработкой отказа и отработкой отказа всего приложения с помощью планов восстановления.

Для обеспечения полной настройки плана восстановления в соответствии с вашими требованиями необходимо выполнить некоторые предварительные условия. Для любого SQL Server развертывания обычно требуется Active Directory развертывание. Также требуется подключение к уровню приложения.

### <a name="step-1-set-up-active-directory"></a>Шаг 1. настроить Active Directory;

Настройте Active Directory на дополнительном сайте восстановления для правильной работы SQL Server.

* **Малый корпоративный**: У вас есть небольшое количество приложений и один контроллер домена для локального сайта. Если вы хотите выполнить отработку отказа для всего сайта, используйте Site Recoveryную репликацию. Эта служба реплицирует контроллер домена во вторичный центр обработки данных или в Azure.
* От **среднего до крупного предприятия**: Может потребоваться настроить дополнительные контроллеры домена.
  - Если у вас много приложений, у вас есть Active Directory лес и требуется выполнить отработку отказа для приложения или рабочей нагрузки, настройте другой контроллер домена в дополнительном центре обработки данных или в Azure.
  -  Если вы используете группы доступности Always On для восстановления на удаленном сайте, настройте другой контроллер домена на дополнительном сайте или в Azure. Этот контроллер домена используется для восстановленного экземпляра SQL Server.

В инструкциях в этой статье предполагается, что контроллер домена доступен в дополнительном расположении. Дополнительные сведения см. в статье [защита Active Directory с помощью Site Recovery](site-recovery-active-directory.md).

### <a name="step-2-ensure-connectivity-with-other-tiers"></a>Шаг 2. Обеспечение подключения с другими уровнями

После запуска уровня базы данных в целевом регионе Azure убедитесь в наличии подключения к приложениям и веб-уровням. Выполните необходимые действия, чтобы проверить возможность подключения с помощью тестовой отработки отказа.

Чтобы понять, как можно проектировать приложения для обеспечения подключения, см. следующие примеры:

* [Проектирование приложения для аварийного восстановления в облаке](../sql-database/sql-database-designing-cloud-solutions-for-disaster-recovery.md)
* [Стратегии аварийного восстановления эластичного пула](../sql-database/sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md)

### <a name="step-3-interoperate-with-always-on-active-geo-replication-and-auto-failover-groups"></a>Шаг 3. Взаимодействие с Always On, активной георепликацией и группами автоматической отработки отказа

Always On технологии BCDR, активная Георепликация и группы автоматической отработки отказа имеют вторичные реплики SQL Server, выполняющиеся в целевом регионе Azure. Первым шагом для отработки отказа приложения является указание этой реплики в качестве основной. В этом шаге предполагается, что у вас уже есть контроллер домена в базе-получателе. Если вы решили выполнить автоматическую отработку отказа, этот шаг может быть необязательным. Отработка отказа веб-уровня и уровней приложений выполняется только после завершения перехода базы данных на другой ресурс.

> [!NOTE]
> Если вы помогла защитить компьютеры SQL с Site Recovery, необходимо просто создать группу восстановления этих компьютеров и добавить их отработку отказа в план восстановления.

[Создайте план восстановления](site-recovery-create-recovery-plans.md) с виртуальными машинами приложений и веб-уровня. Ниже показано, как добавить отработку отказа уровня базы данных.

1. Импортируйте скрипты для отработки отказа группы доступности SQL как на [Диспетчер ресурсов виртуальной машине](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/asr-automation-recovery/scripts/ASR-SQL-FailoverAG.ps1) , так и на [классической виртуальной машине](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/asr-automation-recovery/scripts/ASR-SQL-FailoverAGClassic.ps1). Импортируйте скрипты в учетную запись службы автоматизации Azure.

    [![Изображение логотипа "Deploy to Azure"](https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c4803408-340e-49e3-9a1f-0ed3f689813d.png)](https://aka.ms/asr-automationrunbooks-deploy)

1. Добавьте сценарий ASR-SQL-FailoverAG в качестве предварительного действия первой группы плана восстановления.

1. Чтобы создать переменную автоматизации, следуйте инструкциям в сценарии. Эта переменная предоставляет имена групп доступности.

### <a name="step-4-conduct-a-test-failover"></a>Шаг 4. Проведение тестовой отработки отказа

Некоторые технологии BCDR, такие как SQL Always On, изначально не поддерживают тестовую отработку отказа. Рекомендуется использовать следующий подход *только при использовании таких технологий*.

1. Настройте [Azure Backup](../backup/backup-azure-arm-vms.md) на виртуальной машине, на которой размещена реплика группы доступности в Azure.

1. Прежде чем активировать тестовую отработку отказа плана восстановления, восстановите виртуальную машину из резервной копии, созданной на предыдущем шаге.

    ![Снимок экрана, на котором показано окно для восстановления конфигурации из Azure Backup](./media/site-recovery-sql/restore-from-backup.png)

1. [Принудительное](https://docs.microsoft.com/sql/sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum#PowerShellProcedure) восстановление кворума в виртуальной машине, восстановленной из резервной копии.

1. Обновите IP-адрес прослушивателя, чтобы он был адресом, доступным в сети тестовой отработки отказа.

    ![Снимок экрана: окно правил и диалоговое окно свойств IP-адреса](./media/site-recovery-sql/update-listener-ip.png)

1. Подключите прослушиватель.

    ![Снимок экрана окна с меткой Content_AG, показывающее имена и состояния серверов](./media/site-recovery-sql/bring-listener-online.png)

1. Убедитесь, что подсистема балансировки нагрузки в сети отработки отказа имеет один IP-адрес, из пула IP-адресов внешнего интерфейса, соответствующего каждому прослушивателю группы доступности, а также с виртуальной машиной SQL Server в пуле серверной части.

     ![Снимок экрана окна с именем "пул IP-адресов"](./media/site-recovery-sql/create-load-balancer1.png)

    ![Снимок экрана окна "SQL-AlwaysOn-фунтов-внутренний пул IP-адресов"](./media/site-recovery-sql/create-load-balancer2.png)

1. В последующих группах восстановления добавьте отработку отказа уровня приложения, а затем веб-уровень для этого плана восстановления.

1. Выполните тестовую отработку отказа плана восстановления, чтобы протестировать сквозную отработку отказа приложения.

## <a name="steps-to-do-a-failover"></a>Действия по отработке отказа

После добавления скрипта на шаге 3 и его проверки на шаге 4 можно выполнить отработку отказа плана восстановления, созданного на шаге 3.

Шаги отработки отказа для приложений и веб-уровней должны быть одинаковыми в планах тестовой отработки отказа и восстановления при сбое.

## <a name="how-to-help-protect-a-sql-server-cluster"></a>Как обеспечить защиту кластера SQL Server

Для кластера, работающего SQL Server Standard Edition или SQL Server 2008 R2, рекомендуется использовать Site Recoveryную репликацию, чтобы обеспечить защиту SQL Server.

### <a name="azure-to-azure-and-on-premises-to-azure"></a>Из Azure в Azure и из локальной среды в Azure

Site Recovery не обеспечивает поддержку гостевого кластера при репликации в регион Azure. SQL Server Standard Edition также не предоставляет решения для аварийного восстановления с низкой стоимостью. В этом сценарии рекомендуется защитить кластер SQL Server к автономному экземпляру SQL Server в основном расположении и восстановить его в базе данных-получателе.

1. Настройте дополнительный автономный экземпляр SQL Server в основном регионе Azure или на локальном сайте.

1. Настройте экземпляр, который будет служить зеркалом для баз данных, которые требуется защитить. Настройка зеркального отображения в режиме высокой безопасности.

1. Настройте Site Recovery на первичном сайте для [виртуальных машин и физических серверов](site-recovery-vmware-to-azure-classic.md) [Azure](azure-to-azure-tutorial-enable-replication.md), [Hyper-V](site-recovery-hyper-v-site-to-azure.md)или VMware.

1. Используйте Site Recoveryную репликацию для репликации нового экземпляра SQL Server на дополнительный сайт. Так как это зеркальная копия высокого уровня безопасности, она будет синхронизирована с основным кластером, но реплицирована с помощью Site Recovery репликации.

   ![Образ стандартного кластера, который показывает связь и поток между первичным сайтом, Site Recovery и Azure](./media/site-recovery-sql/standalone-cluster-local.png)

### <a name="failback-considerations"></a>Рекомендации относительно восстановления размещения

Для кластеров SQL Server Standard восстановление размещения после внеплановой отработки отказа требует SQL Server резервного копирования и восстановления. Эта операция выполняется из зеркального экземпляра в исходный кластер с повторной назначением зеркала.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="how-does-sql-server-get-licensed-when-used-with-site-recovery"></a>Как SQL Server поддается лицензированию при использовании с Site Recovery?

Site Recovery репликация для SQL Server рассматривается в рамках преимущества аварийного восстановления Software Assurance. Это покрытие применимо ко всем Site Recovery сценариям: от локальной среды к аварийному восстановлению Azure и аварийному восстановлению Azure IaaS в разных регионах. Дополнительные сведения см. в разделе [цены на Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/) .

### <a name="will-site-recovery-support-my-sql-server-version"></a>Будет Site Recovery поддерживать мою версию SQL Server?

Site Recovery не зависит от приложения. Site Recovery может помочь защитить любую версию SQL Server, развернутую в поддерживаемой операционной системе. Дополнительные сведения см. в [матрице поддержки для восстановления](vmware-physical-azure-support-matrix.md#replicated-machines) реплицированных компьютеров.

## <a name="next-steps"></a>Следующие шаги

* Дополнительные сведения об [архитектуре Site Recovery](site-recovery-components.md).
* Дополнительные сведения о [решениях высокой доступности](../virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr.md#azure-only-high-availability-solutions) для восстановления в дополнительном регионе Azure см. в SQL Server в Azure.
* Дополнительные сведения о [непрерывности бизнес-процессов](../sql-database/sql-database-business-continuity.md) и возможности обеспечения [высокой доступности](../sql-database/sql-database-high-availability.md) для восстановления базы данных SQL см. в дополнительном регионе Azure.
* Дополнительные сведения о вариантах обеспечения [высокой доступности](../virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr.md#hybrid-it-disaster-recovery-solutions) для восстановления на виртуальных машинах Azure для SQL Server компьютеров см. здесь.
