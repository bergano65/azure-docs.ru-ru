---
title: Восстановить после сбоя виртуальные машины Hyper-V из Azure с помощью Azure Site Recovery
description: Как восстановить порезервное копирование виртуальных машин Hyper-V на локальный сайт из Azure с помощью Azure Site Recovery.
services: site-recovery
author: Rajeswari-Mamilla
manager: gaggupta
ms.service: site-recovery
ms.topic: article
ms.date: 09/12/2019
ms.author: ramamill
ms.openlocfilehash: a31a28728dd0521262bd0518cc49a385f4314302
ms.sourcegitcommit: e71da24cc108efc2c194007f976f74dd596ab013
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/29/2020
ms.locfileid: "87416236"
---
# <a name="run-a-failback-for-hyper-v-vms"></a>Восстановление размещения для виртуальных машин Hyper-V

В этой статье описывается, как восстановить работоспособность виртуальных машин Azure, созданных после отработки отказа виртуальных машин Hyper-V с локального сайта в Azure, с [Azure Site Recovery](site-recovery-overview.md).

- Вы отвернете виртуальные машины Hyper-V из Azure, выполнив плановую отработку отказа из Azure на локальный сайт. Если направление отработки отказа — из Azure в локальную среду, оно считается восстановлением размещения.
- Так как Azure является высокодоступной средой и виртуальными машинами всегда доступны, восстановление размещения из Azure — это запланированная активность. Можно запланировать небольшое время простоя, чтобы рабочие нагрузки могли снова начать работу в локальной среде. 
- При запланированном восстановлении виртуальные машины в Azure отключаются и загружаются последние изменения. Потери данных не ожидается.

## <a name="before-you-start"></a>Перед началом работы

1. [Проверьте типы восстановления размещения](failover-failback-overview.md#hyper-v-reprotectionfailback) , которые можно использовать — восстановление исходного расположения и восстановление в альтернативное расположение.
2. Убедитесь, что виртуальные машины Azure используют учетную запись хранения, а не управляемые диски. Восстановление размещения виртуальных машин Hyper-V, реплицированных с помощью управляемых дисков, не поддерживается.
3. Убедитесь, что локальный узел Hyper-V (или сервер System Center VMM, если вы используете с Site Recovery) работает и подключен к Azure. 
4. Убедитесь, что отработка отказа и фиксация для виртуальных машин завершены. Вам не нужно настраивать конкретные компоненты Site Recovery для восстановления размещения виртуальных машин Hyper-V из Azure.
5. Время, необходимое для завершения синхронизации данных и запуска локальной виртуальной машины, зависит от ряда факторов. Чтобы ускорить загрузку данных, можно настроить агент служб восстановления Майкрософт на использование большего числа потоков для параллелизации загрузки. [Подробнее.](https://support.microsoft.com/help/3056159/how-to-manage-on-premises-to-azure-protection-network-bandwidth-usage)


## <a name="fail-back-to-the-original-location"></a>Восстановление размещения в исходное расположение.

Чтобы восстановить порезервное копирование виртуальных машин Hyper-V в Azure на исходную локальную виртуальную машину, запустите плановую отработку отказа из Azure на локальный сайт следующим образом:

1. В хранилище > **реплицированные элементы**выберите виртуальную машину. Щелкните правой кнопкой мыши виртуальную машину > **плановую отработку отказа**. Если вы не выполняете резервное копирование плана восстановления, выберите имя плана **и щелкните**  >  **плановая отработка**отказа.
2. В поле **Подтверждение плановой отработки отказа**выберите исходное и целевое расположения. Запомните направление отработки отказа. Если отработка отказа с первичного сервера работала ожидаемо и все виртуальные машины находятся в дополнительном расположении, это относится только к информации.
3. В окне **Синхронизация данных**выберите параметр:
    - **Синхронизация данных до отработки отказа (синхронизация только Дельта-изменений)**. Этот параметр позволяет сократить время простоя виртуальных машин при синхронизации, не прерывая их работу.
        - **Этап 1**. создает моментальный снимок виртуальной машины Azure и копирует его на локальный узел Hyper-V. Машина продолжит работать в Azure.
        - **Этап 2**. завершает работу виртуальной машины Azure, чтобы в ней не происходили новые изменения. Окончательный набор разностных изменений передается на локальный сервер, а локальная виртуальная машина запускается.
    - **Синхронизировать данные только во время отработки отказа (полная загрузка)**— этот вариант быстрее, так как предполагается, что большая часть диска изменилась и не требуется тратить время на вычисление контрольных сумм. Этот параметр не выполняет вычисления контрольной суммы.
        - Выполняется скачивание диска. 
        - Мы рекомендуем использовать этот вариант, если вы работали с Azure на некоторое время (месяц или более) или если локальная виртуальная машина удалена.

4. Только для VMM, если для облака включено шифрование данных, в **разделе ключ шифрования**выберите сертификат, выданный при включении шифрования данных во время установки поставщика на сервере VMM.
5. Запустите отработку отказа. На вкладке **Задания** можно следить за ходом выполнения отработки отказа.
6. Если вы выбрали параметр для синхронизации данных перед отработкой отказа, после завершения начальной синхронизации данных и готовности к завершению работы виртуальных машин в Azure щелкните **задания** > имя задания > **завершить отработку отказа**. Таким образом вы сделаете следующее:
    - Завершает работу компьютера Azure.
    - Передает последние изменения в локальную виртуальную машину.
    - Запускает локальную виртуальную машину.
7. Теперь вы можете войти на локальный компьютер виртуальной машины, чтобы убедиться, что он доступен, как и ожидалось.
8. Виртуальная машина будет находиться в состоянии ожидания фиксации. Щелкните **Применить**, чтобы применить отработку отказа.
9. Чтобы завершить восстановление размещения, нажмите кнопку **обратная репликация** , чтобы снова начать репликацию локальной виртуальной машины в Azure.



## <a name="fail-back-to-an-alternate-location"></a>Восстановление размещения в альтернативное расположение. 

Выполните отработку отказа в альтернативное расположение следующим образом:

1. Если выполняется настройка нового оборудования, установите [поддерживаемую версию Windows](hyper-v-azure-support-matrix.md#replicated-vms)и роль Hyper-V на компьютере.
2. Создайте коммутатор виртуальной сети с тем же именем, что и на исходном сервере.
3. В группе Защита **защищенных элементов**  >  **Protection Group**  >  \<ProtectionGroupName>  ->  \<VirtualMachineName> выберите виртуальную машину, для которой необходимо выполнить откат, а затем выберите **плановая отработка отказа**.
4. В окне **Подтверждение плановой отработки отказа**выберите **создать локальную виртуальную машину, если она не существует**.
5. В поле **имя узла**выберите новый сервер узла Hyper-V, на котором требуется разместить виртуальную машину.
6. При **синхронизации данных**рекомендуется выбрать параметр для синхронизации данных перед отработкой отказа. Это сокращает время простоя виртуальных машин при синхронизации, не прерывая их работу. Он выполняет следующие действия:
    - **Этап 1**. создает моментальный снимок виртуальной машины Azure и копирует его на локальный узел Hyper-V. Машина продолжит работать в Azure.
    - **Этап 2**. завершает работу виртуальной машины Azure, чтобы в ней не происходили новые изменения. Последний набор изменений передается на локальный сервер, после чего запускается локальная виртуальная машина.
    
7. Установите этот флажок, чтобы начать отработку отказа (восстановление размещения).
8. После завершения начальной синхронизации и готовности к завершению работы виртуальной машины Azure щелкните **задания**  >  \<planned failover job>  >  **завершить отработку отказа**. Это позволит завершить работу компьютера с Azure, перенести последние изменения на локальную виртуальную машину и запустить ее.
9. Вы можете войти в локальную виртуальную машину, чтобы убедиться, что все работает правильно.
10. Нажмите кнопку **фиксация** , чтобы завершить отработку отказа. Фиксация удаляет виртуальную машину Azure и ее диски, а затем подготавливает локальную виртуальную машину для повторной защиты.
10. Щелкните " **обратная репликация** ", чтобы начать репликацию локальной виртуальной машины в Azure. Будут реплицированы только изменения, внесенные после отключения виртуальной машины в Azure.

    > [!NOTE]
    > Если отменить задание восстановления размещения во время синхронизации данных, локальная виртуальная машина будет находиться в поврежденном состоянии. Это связано с тем, что при синхронизации данных копируются последние данные с дисков виртуальных машин Azure на локальные диски данных, а пока синхронизация не завершится, данные на диске могут быть не в стабильном состоянии. Если локальная виртуальная машина запускается после отмены синхронизации данных, она может не загружаться. В этом случае повторно запустите отработку отказа, чтобы завершить синхронизацию данных.


## <a name="next-steps"></a>Дальнейшие действия
После репликации локальной виртуальной машины в Azure можно при необходимости [выполнить другую отработку отказа](site-recovery-failover.md) в Azure.
