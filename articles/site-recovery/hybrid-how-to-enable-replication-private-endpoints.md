---
title: Включение репликации для локальных компьютеров с частными конечными точками
description: В этой статье описывается настройка репликации для локальных компьютеров с помощью частных конечных точек в Site Recovery.
author: Harsha-CS
ms.author: harshacs
ms.service: site-recovery
ms.topic: article
ms.date: 07/14/2020
ms.openlocfilehash: 3d15f4039da85dfa926e7bc9ab96b2c48965d5f0
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "89658797"
---
# <a name="replicate-on-premises-machines-by-using-private-endpoints"></a>Репликация локальных компьютеров с помощью частных конечных точек

Azure Site Recovery позволяет использовать частные конечные точки [частной связи Azure](../private-link/private-endpoint-overview.md) для репликации локальных компьютеров в виртуальную сеть в Azure. Доступ к хранилищу восстановления в частной конечной точке поддерживается во всех регионах коммерческих & правительственных учреждений Azure.

В этой статье объясняется, как выполнить следующие действия:

- Создайте хранилище служб восстановления Azure Backup для защиты компьютеров.
- Включите управляемое удостоверение для хранилища. Предоставьте разрешения, необходимые для доступа к учетным записям хранения, чтобы включить репликацию трафика из локальной среды в целевое расположение Azure. Доступ к управляемым удостоверениям для хранилища необходим для доступа к хранилищу через частный канал.

- Внесите изменения DNS, необходимые для частных конечных точек.
- Создание и утверждение частных конечных точек для хранилища в виртуальной сети.
- Создайте частные конечные точки для учетных записей хранения. Вы можете по мере необходимости разрешить общий доступ или брандмауэр для хранилища. Создание частной конечной точки для доступа к хранилищу не требуется для Azure Site Recovery.
  
На следующей схеме показан рабочий процесс репликации для гибридного аварийного восстановления с частными конечными точками. В локальной сети нельзя создавать частные конечные точки. Чтобы использовать частные ссылки, необходимо создать виртуальную сеть Azure (которая называется *обходом сети* в этой статье), установить частное подключение между локальной средой и обходом сети, а затем создать частные конечные точки в обходной сети. Можно выбрать любую форму частного подключения.

:::image type="content" source="./media/hybrid-how-to-enable-replication-private-endpoints/architecture.png" alt-text="Схема, показывающая архитектуру для Azure Site Recovery и частных конечных точек.":::

## <a name="prerequisites-and-caveats"></a>Предварительные требования и предостережения

- Частные ссылки поддерживаются в Site Recovery 9,35 и более поздних версиях.
- Частные конечные точки можно создавать только для новых хранилищ служб восстановления, на которые не зарегистрирован ни один элемент. Поэтому перед добавлением элементов в хранилище необходимо создать частные конечные точки. Сведения о ценах см. на [странице цен на частную связь Azure](https://azure.microsoft.com/pricing/details/private-link/) .
- При создании частной конечной точки для хранилища хранилище блокируется. Доступ к нему можно получить только из сетей с частными конечными точками.
- Azure Active Directory в настоящее время не поддерживает частные конечные точки. Поэтому необходимо разрешить исходящий доступ из защищенной виртуальной сети Azure к IP-адресам и полным доменным именам, необходимым для работы Azure Active Directory в регионе.
  Можно также использовать тег группы безопасности сети "Azure Active Directory" и теги брандмауэра Azure, чтобы разрешить доступ к Azure Active Directory.
- В пропускной сети, в которой создается частная конечная точка, требуются пять IP-адресов. При создании частной конечной точки для хранилища Site Recovery создает пять частных ссылок для доступа к ее микрослужбам.
- В режиме обхода сети для подключения частной конечной точки к учетной записи хранения кэша требуется один дополнительный IP-адрес. Вы можете использовать любой способ подключения между локальной средой и конечной точкой учетной записи хранения. Например, можно использовать Интернет или Azure [ExpressRoute](../expressroute/index.yml). Устанавливать частную связь необязательно. Частные конечные точки можно создавать только для учетных записей общего назначения v2. Сведения о ценах на перенос данных в учетных записях общего назначения v2 см. в статье [цены на страничные BLOB-объекты Azure](https://azure.microsoft.com/pricing/details/storage/page-blobs/) .

 ## <a name="create-and-use-private-endpoints-for-site-recovery"></a>Создание и использование частных конечных точек для восстановления сайта

 В следующих разделах описаны действия, которые необходимо предпринять, чтобы создать и использовать частные конечные точки для восстановления сайта в виртуальных сетях.

> [!NOTE]
> Рекомендуется выполнить эти действия в указанном порядке. В противном случае вы не сможете использовать частные конечные точки в хранилище, и вам может потребоваться перезапустить процесс с новым хранилищем.

### <a name="create-a-recovery-services-vault"></a>Создание хранилища Служб восстановления

Хранилище служб восстановления содержит сведения о репликации компьютеров. Он используется для активации Site Recoveryных операций. Сведения о создании хранилища служб восстановления в регионе Azure, в котором вы хотите выполнить отработку отказа в случае аварии, см. в разделе [Создание хранилища служб восстановления](./azure-to-azure-tutorial-enable-replication.md#create-a-recovery-services-vault).

### <a name="enable-the-managed-identity-for-the-vault"></a>Включение управляемого удостоверения для хранилища

[Управляемое удостоверение](../active-directory/managed-identities-azure-resources/overview.md) позволяет хранилищу получать доступ к учетным записям хранения. Site Recovery может потребоваться доступ к целевому хранилищу и учетным записям хранения кэша или журнала в зависимости от требований. При использовании службы частной связи для хранилища требуется доступ к управляемым удостоверениям.

1. Перейдите к хранилищу служб восстановления. В разделе **Параметры**выберите **удостоверение** .

   :::image type="content" source="./media/hybrid-how-to-enable-replication-private-endpoints/enable-managed-identity-in-vault.png" alt-text="Схема, показывающая архитектуру для Azure Site Recovery и частных конечных точек.":::

1. Измените **состояние** на **вкл** и нажмите кнопку **сохранить**.

   Создается идентификатор объекта. Хранилище теперь зарегистрировано в Azure Active Directory.

### <a name="create-private-endpoints-for-the-recovery-services-vault"></a>Создание частных конечных точек для хранилища служб восстановления

Для защиты компьютеров в локальной исходной сети вам потребуется одна частная конечная точка для хранилища в режиме обхода сети. Создайте закрытую конечную точку с помощью частного центра ссылок в портал Azure или с помощью [Azure PowerShell](../private-link/create-private-endpoint-powershell.md).

1. В поле поиска портал Azure выполните поиск по фразе "Частная ссылка". Выберите **Частная ссылка** , чтобы открыть частный центр ссылок:

   :::image type="content" source="./media/hybrid-how-to-enable-replication-private-endpoints/search-private-links.png" alt-text="Схема, показывающая архитектуру для Azure Site Recovery и частных конечных точек.":::

1. В левой области выберите **частные конечные точки**. На странице **частные конечные точки** выберите **Добавить** , чтобы начать создание частной конечной точки для хранилища:

   :::image type="content" source="./media/hybrid-how-to-enable-replication-private-endpoints/create-private-endpoints.png" alt-text="Схема, показывающая архитектуру для Azure Site Recovery и частных конечных точек.":::

1. На странице **Создание частной конечной точки** укажите сведения для создания подключения к частной конечной точке.

   1. **Основные сведения**. Укажите основные сведения о частных конечных точках. Используйте регион, который использовался для обхода сети:

      :::image type="content" source="./media/hybrid-how-to-enable-replication-private-endpoints/create-private-endpoints-basic-tab.png" alt-text="Схема, показывающая архитектуру для Azure Site Recovery и частных конечных точек.":::

   1. **Ресурс**. На этой вкладке необходимо указать ресурс "платформа как услуга", для которого нужно создать подключение. В разделе **тип ресурса** для выбранной подписки выберите **Microsoft. RecoveryServices/хранилища**. В разделе **ресурс**выберите имя хранилища служб восстановления. Выберите **Azure Site Recovery** в качестве **целевого вспомогательного ресурса**.

      :::image type="content" source="./media/hybrid-how-to-enable-replication-private-endpoints/create-private-endpoints-resource-tab.png" alt-text="Схема, показывающая архитектуру для Azure Site Recovery и частных конечных точек.":::

   1. **Конфигурация**. На этой вкладке укажите сеть и подсеть обхода, в которых необходимо создать частную конечную точку. 

      Включите интеграцию с частной зоной DNS, выбрав **Да**.
      Выберите существующую зону DNS или создайте новую. При выборе пункта **Да** автоматически связывается зона с обходом сети. Это действие также добавляет записи DNS, необходимые для разрешения DNS новых IP-адресов и полных доменных имен, созданных для частной конечной точки.

      Убедитесь, что вы решили создать новую зону DNS для каждой новой частной конечной точки, подключенной к тому же хранилищу. При выборе существующей частной зоны DNS предыдущие записи CNAME перезаписываются. Прежде чем продолжить, ознакомьтесь с [руководством по закрытой конечной точке](../private-link/private-endpoint-overview.md#private-endpoint-properties) .

      Если в вашей среде есть модель "звезда", вам потребуется только одна частная конечная точка и только одна частная зона DNS для всей установки. Это связано с тем, что между всеми виртуальными сетями уже включены пиринга. Дополнительные сведения см. в разделе [Интеграция DNS с частной конечной точкой](../private-link/private-endpoint-dns.md#virtual-network-workloads-without-custom-dns-server).

      Чтобы вручную создать зону частной зоны DNS, выполните действия, описанные в статье [создание частных зон DNS и добавление записей DNS вручную](#create-private-dns-zones-and-add-dns-records-manually).

      :::image type="content" source="./media/hybrid-how-to-enable-replication-private-endpoints/create-private-endpoints-configuration-tab.png" alt-text="Схема, показывающая архитектуру для Azure Site Recovery и частных конечных точек.":::

   1. **Теги**. При необходимости можно добавить теги для частной конечной точки.

   1. **Проверьте \+ Создание**. После завершения проверки выберите **создать** , чтобы создать частную конечную точку.

При создании частной конечной точки в частную конечную точку добавляются пять полных доменных имен (FQDN). Эти ссылки позволяют компьютерам в локальной сети получать доступ через "обход сети", все необходимые Site Recovery микрослужбы в контексте хранилища. Вы можете использовать одну и ту же закрытую конечную точку для защиты любой виртуальной машины Azure в пропускной сети и во всех одноранговых сетях.

Пять доменных имен форматируются в этом шаблоне:

`{Vault-ID}-asr-pod01-{type}-.{target-geo-code}.siterecovery.windowsazure.com`

### <a name="approve-private-endpoints-for-site-recovery"></a>Утверждение частных конечных точек для Site Recovery

Если вы создаете закрытую конечную точку, а также являетесь владельцем хранилища служб восстановления, то ранее созданная закрытая конечная точка будет автоматически утверждена в течение нескольких минут. В противном случае владелец хранилища должен утвердить закрытую конечную точку, прежде чем ее можно будет использовать. Чтобы утвердить или отклонить запрошенное подключение к **частной конечной точке, перейдите в раздел** " **Параметры** " на странице "хранилище восстановления".

Прежде чем продолжить, можно перейти к ресурсу частной конечной точки, чтобы проверить состояние подключения:

:::image type="content" source="./media/hybrid-how-to-enable-replication-private-endpoints/vault-private-endpoint-connections.png" alt-text="Схема, показывающая архитектуру для Azure Site Recovery и частных конечных точек.":::

### <a name="optional-create-private-endpoints-for-the-cache-storage-account"></a><a name="create-private-endpoints-for-the-cache-storage-account"></a>Используемых Создание частных конечных точек для учетной записи хранения кэша

Вы можете использовать частную конечную точку в службе хранилища Azure. Создание частных конечных точек для доступа к хранилищу необязательно для Azure Site Recovery репликации. Если вы создаете частную конечную точку для хранилища, вам потребуется частная конечная точка для учетной записи хранения кэша или журнала в виртуальной сети обхода.

> [!NOTE]
> Частные конечные точки для хранилища можно создавать только в учетных записях хранения общего назначения v2. Сведения о ценах см. на [странице цен на страничные BLOB-объекты Azure](https://azure.microsoft.com/pricing/details/storage/page-blobs/).

Следуйте указаниям [по созданию частного хранилища](../private-link/create-private-endpoint-storage-portal.md#create-your-private-endpoint) для создания учетной записи хранения с частной конечной точкой. Обязательно выберите **Да** в разделе **Интеграция с частной зоной DNS**. Выберите существующую зону DNS или создайте новую.

### <a name="grant-required-permissions-to-the-vault"></a>Предоставление требуемых разрешений для хранилища

В зависимости от настроек может потребоваться одна или несколько учетных записей хранения в целевом регионе Azure. Затем предоставьте разрешения управляемого удостоверения для всех учетных записей хранения кэша и журнала, необходимых для Site Recovery. В этом случае необходимо заранее создать необходимые учетные записи хранения.

Прежде чем включить репликацию виртуальных машин, управляемое удостоверение хранилища должно иметь следующие разрешения роли в зависимости от типа учетной записи хранения.

- Учетные записи хранения на основе диспетчер ресурсов (стандартный тип):
  - [Участник](../role-based-access-control/built-in-roles.md#contributor)
  - [участник данных BLOB-объектов хранилища](../role-based-access-control/built-in-roles.md#storage-blob-data-contributor);
- Учетные записи хранения на основе диспетчер ресурсов (тип "Премиум"):
  - [Участник](../role-based-access-control/built-in-roles.md#contributor)
  - [владелец данных BLOB-объектов хранилища](../role-based-access-control/built-in-roles.md#storage-blob-data-owner);
- Классические учетные записи хранения:
  - [Участник классической учетной записи хранения](../role-based-access-control/built-in-roles.md#classic-storage-account-contributor)
  - [Роль службы оператора ключей классических учетных записей хранения](../role-based-access-control/built-in-roles.md#classic-storage-account-key-operator-service-role)

В этих шагах описывается добавление назначения роли в учетную запись хранения.

1. Перейдите в учетную запись хранения. На левой панели выберите **Управление доступом (IAM)** .

1. В разделе **Добавление назначения ролей** выберите **Добавить**.

   :::image type="content" source="./media/hybrid-how-to-enable-replication-private-endpoints/storage-role-assignment.png" alt-text="Схема, показывающая архитектуру для Azure Site Recovery и частных конечных точек.":::

1. На странице **Добавление назначения ролей** в списке **роль** выберите роль из списка в начале этого раздела. Введите имя хранилища и нажмите кнопку **сохранить**.

   :::image type="content" source="./media/hybrid-how-to-enable-replication-private-endpoints/storage-role-assignment-select-role.png" alt-text="Схема, показывающая архитектуру для Azure Site Recovery и частных конечных точек.":::

После добавления этих разрешений необходимо разрешить доступ к доверенным службам Майкрософт. Перейдите в раздел **брандмауэры и виртуальные сети** и выберите **разрешить доверенным службам Майкрософт доступ к этой учетной записи хранения** в **исключениях**.

### <a name="protect-your-virtual-machines"></a>Защитите свои виртуальные машины

После завершения предыдущих задач продолжайте настройку локальной инфраструктуры. Продолжите выполнение одной из следующих задач. 

- [Развертывание сервера конфигурации для VMware и физических компьютеров](./vmware-azure-deploy-configuration-server.md)
- [Настройка среды Hyper-V для репликации](./hyper-v-azure-tutorial.md#set-up-the-source-environment)

После завершения установки включите репликацию для исходных компьютеров. Не устанавливайте инфраструктуру до тех пор, пока не будут созданы частные конечные точки для хранилища в режиме обхода сети.

### <a name="create-private-dns-zones-and-add-dns-records-manually"></a>Создание частных зон DNS и добавление записей DNS вручную

Если вы не выбрали параметр для интеграции с частной зоной DNS при создании частной конечной точки для хранилища, выполните действия, описанные в этом разделе.

Создайте одну закрытую зону DNS, чтобы разрешить поставщику Site Recovery (для компьютеров Hyper-V) или серверу обработки (для виртуальных машин VMware или физических компьютеров) разрешать частные полные доменные имена в частные IP-адреса.

1. Создайте частную зону DNS.

   1. Выполните поиск по фразе "Частная зона DNS" в поле поиска **All Services (все службы** ), а затем выберите **Частная зона DNS Zone (зона** ) в результатах:

      :::image type="content" source="./media/hybrid-how-to-enable-replication-private-endpoints/search-private-dns-zone.png" alt-text="Схема, показывающая архитектуру для Azure Site Recovery и частных конечных точек.":::

   1. На странице **Частная зона DNS зоны** нажмите кнопку **Добавить** , чтобы начать создание новой зоны.

   1. На странице **Создание частной зоны DNS** введите необходимые сведения. Введите **privatelink.siterecovery.WindowsAzure.com** в качестве имени частной зоны DNS. Можно выбрать любую группу ресурсов и любую подписку.

      :::image type="content" source="./media/hybrid-how-to-enable-replication-private-endpoints/create-private-dns-zone.png" alt-text="Схема, показывающая архитектуру для Azure Site Recovery и частных конечных точек.":::

   1. Перейдите на вкладку **Проверка \+ создания** , чтобы проверить и создать зону DNS.

1. Свяжите частную зону DNS с виртуальной сетью.

   Теперь необходимо связать закрытую зону DNS, созданную вами, в обход.

   1. Перейдите к частной зоне DNS, созданной на предыдущем шаге, а затем перейдите по **ссылке виртуальная сеть** в левой области. Выберите **Добавить**.

   1. Введите необходимые сведения. В списках **Подписка** и **Виртуальная сеть** выберите сведения, соответствующие пропускной сети. Оставьте в остальных полях значения по умолчанию.

      :::image type="content" source="./media/hybrid-how-to-enable-replication-private-endpoints/add-virtual-network-link.png" alt-text="Схема, показывающая архитектуру для Azure Site Recovery и частных конечных точек.":::

1. Добавление записей DNS.

   Теперь, когда вы создали требуемую частную зону DNS и закрытую конечную точку, необходимо добавить записи DNS в зону DNS.

   > [!NOTE]
   > Если вы используете пользовательскую частную зону DNS, обязательно сделайте аналогичные записи, как описано на следующем шаге.

   На этом шаге необходимо сделать записи для каждого полного доменного имени в частной конечной точке в частной зоне DNS.

   1. Перейдите к частной зоне DNS, а затем перейдите к разделу **Обзор** в левой области. Выберите **набор записей** , чтобы начать добавление записей.

   1. На странице **Добавление набора записей** добавьте запись для каждого полного доменного имени и частного IP- **адреса в качестве записи типа.** Список полных доменных имен и IP-адресов можно получить на странице **Частная конечная точка** в разделе **Обзор**. Как видно на следующем снимке экрана, первое полное доменное имя из частной конечной точки добавляется в набор записей в частной зоне DNS.

      Эти полные доменные имена соответствуют этому шаблону: `{Vault-ID}-asr-pod01-{type}-.{target-geo-code}.siterecovery.windowsazure.com`

      :::image type="content" source="./media/hybrid-how-to-enable-replication-private-endpoints/add-record-set.png" alt-text="Схема, показывающая архитектуру для Azure Site Recovery и частных конечных точек.":::

## <a name="next-steps"></a>Дальнейшие шаги

Теперь, когда вы включили частные конечные точки для репликации виртуальных машин, ознакомьтесь со следующими статьями, чтобы получить дополнительные и связанные сведения.

- [Развертывание локального сервера конфигурации](./vmware-azure-deploy-configuration-server.md)
- [Настройка аварийного восстановления локальных виртуальных машин Hyper-V в Azure](./hyper-v-azure-tutorial.md)