---
title: Настройка аварийного восстановления SAP NetWeaver с помощью Azure Site Recovery
description: Узнайте, как настроить аварийное восстановление SAP NetWeaver с Azure Site Recovery.
author: sideeksh
manager: rochakm
ms.topic: how-to
ms.date: 11/27/2018
ms.openlocfilehash: 29acd1b00d23e4f1c2f241027dadbbb406e5e049
ms.sourcegitcommit: b07964632879a077b10f988aa33fa3907cbaaf0e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/13/2020
ms.locfileid: "77190800"
---
# <a name="set-up-disaster-recovery-for-a-multi-tier-sap-netweaver-app-deployment"></a>Настройка аварийного восстановления для многоуровневого развертывания приложения SAP NetWeaver

Для большинства развертываний большого и среднего размера SAP используется какая-либо разновидность решения аварийного восстановления. По мере переноса все большего числа ключевых бизнес-процессов в такие приложения, как SAP, повысилась важность надежных и тестируемых решений аварийного восстановления. Azure Site Recovery был протестирован и интегрирован с приложениями SAP. Site Recovery превышает возможности большинства локальных решений аварийного восстановления, а также более низкая совокупная стоимость владения, чем конкурирующие решения.

Служба Site Recovery предоставляет следующие возможности:
* Включите защиту рабочих приложений SAP NetWeaver и не-NetWeaver, которые выполняются локально, путем репликации компонентов в Azure.
* Включите защиту рабочих приложений SAP NetWeaver и не-NetWeaver, работающих в Azure, путем репликации компонентов в другой центр обработки данных Azure.
* упрощение миграции в облако благодаря использованию Site Recovery для переноса развертывания SAP в Azure;
* Упростите обновление проекта SAP, тестирование и создание прототипов, создав производственный клон по запросу для тестирования приложений SAP.

Для защиты развертывания приложений SAP NetWeaver можно использовать [Azure Site Recovery](site-recovery-overview.md). В этой статье рассматриваются рекомендации по защите трехуровневого развертывания SAP NetWeaver в Azure при репликации в другой центр обработки данных Azure с помощью Site Recovery. В этой статье описываются поддерживаемые сценарии и конфигурации, а также способы тестирования отработки отказа (детализации аварийного восстановления) и фактические отработки отказа.

## <a name="prerequisites"></a>Предварительные требования

Прежде чем начать, необходимо знать, как выполнять следующие задачи:

* [Репликация виртуальной машины в Azure](azure-to-azure-walkthrough-enable-replication.md).
* [Проектирование сети для аварийного восстановления](site-recovery-azure-to-azure-networking-guidance.md).
* [Выполнение тестовой отработки отказа в Azure](azure-to-azure-walkthrough-test-failover.md).
* [Выполнение отработки отказа в Azure](site-recovery-failover.md).
* [Репликация контроллера домена](site-recovery-active-directory.md).
* [Репликация экземпляра SQL Server](site-recovery-sql.md)

## <a name="supported-scenarios"></a>Поддерживаемые сценарии

С помощью Site Recovery можно реализовать решение аварийного восстановления для приведенных ниже сценариев:
* У вас есть системы SAP, работающие в одном центре обработки данных Azure, и вы реплицируете их в другой центр обработки данных Azure (аварийное восстановление из Azure в Azure). 
   Дополнительные сведения см. в статье [Azure to Azure replication architecture](https://aka.ms/asr-a2a-architecture) (Архитектура репликации из Azure в Azure).
* У вас есть системы SAP, работающие на локальных серверах VMware (или физических). Вы также реплицируете системы SAP на сайт аварийного восстановления в центре обработки данных Azure (аварийное восстановление из VMware в Azure). 
   Данному сценарию требуются некоторые дополнительные компоненты. Дополнительные сведения см. в статье [Архитектура репликации из VMware в Azure](https://aka.ms/asr-v2a-architecture).
* У вас есть системы SAP, работающие в локальной среде Hyper-V. Вы также реплицируете системы SAP на сайт аварийного восстановления в центре обработки данных Azure (аварийное восстановление из Hyper-V в Azure).
   Данному сценарию требуются некоторые дополнительные компоненты. Дополнительные сведения см. в статье [Архитектура репликации из Hyper-V в Azure](https://aka.ms/asr-h2a-architecture).

В этой статье мы используем сценарий аварийного восстановления из **Azure в Azure** . В сценарии показаны возможности аварийного восстановления SAP Site Recovery. Так как репликация Site Recovery не относится к приложению, описанный процесс применим к другим сценариям.

### <a name="required-foundation-services"></a>Требуемые основные службы
В сценарии, описанном в этой статье, развертываются следующие основные службы:
* Azure ExpressRoute или VPN-шлюз Azure;
* По крайней мере один Azure Active Directory контроллер домена и DNS-сервер, работающий в Azure

Рекомендуем развернуть эту инфраструктуру перед развертыванием Site Recovery.

## <a name="reference-sap-application-deployment"></a>Развертывание эталонного приложения SAP

Эта Эталонная архитектура использует SAP NetWeaver в среде Windows в Azure с высокой доступностью. Эта архитектура развертывается с конкретными размерами виртуальных машин, которые можно изменить в соответствии с потребностями вашей организации.

![Схема обычного шаблона развертывания SAP](./media/site-recovery-sap/sap-netweaver_latest.png)

## <a name="disaster-recovery-considerations"></a>Рекомендации по аварийному восстановлению

Для аварийного восстановления необходимо иметь возможность отработки отказа в дополнительный регион. Каждый уровень использует другую стратегию для обеспечения защиты от аварийного восстановления.

#### <a name="vms-running-sap-web-dispatcher-pools"></a>Виртуальные машины, на которых выполняются пулы веб-диспетчеров SAP

Компонент веб-диспетчера работает как балансировщик нагрузки для трафика SAP между серверами приложений SAP. Чтобы обеспечить высокий уровень доступности для компонента веб-диспетчера, Azure Load Balancer реализует параллельную установку веб-диспетчера. Веб-диспетчер использует конфигурацию с циклическим перебором для распределения трафика HTTP (S) между доступными веб-диспетчерами в пуле подсистемы балансировки.

#### <a name="vms-running-application-servers-pools"></a>Виртуальные машины, на которых выполняются пулы серверов приложений
Транзакция СМЛГ управляет группами входа для серверов приложений ABAP. Она использует функцию балансировки нагрузки на сервере сообщений центральных служб для распределения рабочей нагрузки между пулами серверов приложений SAP для трафика Сапгуис и RFC. Это управление можно реплицировать с помощью Site Recovery.

#### <a name="vms-running-sap-central-services-clusters"></a>Виртуальные машины, на которых выполняются кластеры Центральной службы SAP
Эта эталонная архитектура запускает центральные службы на виртуальных машинах на уровне приложений. Центральные службы — это потенциальная единая точка отказа в одной виртуальной машине. Обычное развертывание и высокий уровень доступности не являются требованиями.

Для реализации решения высокой доступности можно использовать общий кластер дисков или кластер файлового ресурса. Чтобы настроить виртуальные машины для кластера общих дисков, используйте отказоустойчивый кластер Windows Server. Мы рекомендуем использовать облако-свидетель в качестве следящего сервера кворума.

 > [!NOTE]
 > Поскольку Site Recovery не реплицирует облако-свидетель, рекомендуется развернуть его в регионе аварийного восстановления.

Для поддержки среды отказоустойчивого кластера [SIOS Clustering Edition](https://azuremarketplace.microsoft.com/marketplace/apps/sios_datakeeper.sios-datakeeper-8) выполняет функцию общего тома кластера. В функции SIOS Clustering выполняет репликацию независимых дисков, принадлежащих узлам кластера. Так как Azure изначально не поддерживает общие диски, для нее требуются решения, предоставляемые SIOS.

Кластеризацию также можно реализовать путем реализации кластера файловых ресурсов. В [SAP](https://blogs.sap.com/2018/03/19/migration-from-a-shared-disk-cluster-to-a-file-share-cluster) недавно изменили шаблон развертывания центральных служб для доступа к глобальным каталогам /sapmnt через UNC-путь. Мы по-прежнему рекомендуем обеспечить высокую доступность общего ресурса UNC/sapmnt. Вы можете проверить экземпляр Центральной службы. Используйте отказоустойчивый кластер Windows Server с Scale Out файловым сервером (SOFS) и функцией Локальные дисковые пространства (S2D) в Windows Server 2016.

 > [!NOTE]
 > В настоящее время Site Recovery поддерживает только репликацию с точки зрения отказоустойчивости виртуальных машин, использующих локальные дисковые пространства и пассивный узел SIOS.


## <a name="more-disaster-recovery-considerations"></a>Дополнительные рекомендации по аварийному восстановлению

Вы можете использовать Site Recovery для координации отработки отказа полного развертывания SAP в регионах Azure.
Ниже приведены действия по настройке аварийного восстановления.

1. Репликация виртуальных машин
1. Проектирование сети для аварийного восстановления
1. Репликация контроллера домена
1. Репликация уровня базы данных
1. Выполнение тестовой отработки отказа
1. Выполнение отработки отказа

Ниже приведены рекомендации по аварийному восстановлению каждого уровня, используемого в этом примере.

 **Уровни SAP** | **Рекомендация**
 --- | ---
**Пул Диспетчера SAP Web** |  Репликация с помощью Site Recovery 
**Пул серверов приложений SAP** |  Репликация с помощью Site Recovery 
**Кластер центральных служб SAP** |  Репликация с помощью Site Recovery 
**Виртуальные машины Active Directory** |  Использовать репликацию Active Directory 
**Серверы Базы данных SQL** |  Использование репликации Always On SQL Server

## <a name="replicate-virtual-machines"></a>Репликация виртуальных машин

Чтобы начать, репликацию всех виртуальных машин приложений SAP в центре обработки данных аварийного восстановления Azure, следуйте указаниям в статье о [репликации виртуальных машин в Azure](azure-to-azure-walkthrough-enable-replication.md).

* Рекомендации по защите Active Directory и DNS см. [в статье защита Active Directory и DNS](site-recovery-active-directory.md).

* Рекомендации по защите уровня базы данных, выполняемого на SQL Server, см. [в статье защита SQL Server](site-recovery-sql.md).

## <a name="networking-configuration"></a>Конфигурация сети

Если используется статический IP-адрес, вы можете указать нужный IP-адрес для виртуальной машины. Чтобы задать IP-адрес, откройте раздел **Compute and Network settings** (Параметры вычисления и сети) > **Network interface card** (Сетевой адаптер).

![Снимок экрана, показывающий, как установить частный IP-адрес в области карты сетевого интерфейса Site Recovery](./media/site-recovery-sap/sap-static-ip.png)


## <a name="create-a-recovery-plan"></a>Создайте план восстановления

План восстановления позволяет воссоздать последовательность различных уровней в многоуровневом приложении во время отработки отказа. Благодаря этому обеспечивается целостность на уровне приложения. При создании плана восстановления для многоуровневого веб-приложения выполните действия, описанные в [этой статье](site-recovery-create-recovery-plans.md).

### <a name="add-virtual-machines-to-failover-groups"></a>Добавление виртуальных машин в группы отработки отказа

1. Создайте план восстановления, добавив виртуальные машины сервера приложений, веб-диспетчера и служб SAP Central Services.
1. Выберите **настроить** , чтобы сгруппировать виртуальные машины. По умолчанию все виртуальные машины входят в группу 1.

### <a name="add-scripts-to-the-recovery-plan"></a>Добавление сценариев в план восстановления
Для правильной работы приложений может потребоваться выполнить некоторые операции на виртуальных машинах Azure. Выполните эти операции после отработки отказа или во время тестовой отработки отказа. Можно также автоматизировать некоторые операции после отработки отказа. Например, обновите запись DNS и измените привязки и соединения, добавив соответствующие скрипты в план восстановления.

Вы можете развернуть наиболее используемые сценарии Site Recovery в учетной записи службы автоматизации Azure, выбрав **развернуть в Azure**. При использовании любого опубликованного скрипта следуйте указаниям в сценарии.

[![Развертывание в Azure](https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c4803408-340e-49e3-9a1f-0ed3f689813d.png)](https://aka.ms/asr-automationrunbooks-deploy)

1. Добавьте скрипт, выполняемый перед действием, в группу 1 для отработки отказа группы доступности SQL Server. Используйте сценарий ASR-SQL-FailoverAG, опубликованный в примерах сценариев. Следуйте указаниям в сценарии и внесите необходимые изменения в сценарий соответствующим образом.
1. Добавьте скрипт после действия, чтобы подключить подсистему балансировки нагрузки к виртуальным машинам с отработкой отказа на веб-уровне (Группа 1). Используйте сценарий ASR-Аддсинглелоадбаланцер, опубликованный в примерах сценариев. Следуйте указаниям в сценарии и внесите необходимые изменения в сценарий по мере необходимости.

![План восстановления SAP](./media/site-recovery-sap/sap_recovery_plan.png)


## <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

1. На портале Azure выберите хранилище служб восстановления.
1. Выберите план восстановления, созданный для приложений SAP.
1. Выберите **Тестовая отработка отказа**.
1. Чтобы запустить тестовую отработку отказа, выберите точку восстановления и виртуальную сеть Azure.
1. После запуска вторичной среды можно выполнить проверку.
1. После завершения проверок очистите среду отработки отказа, выбрав **очистить тестовую отработку отказа**.

Дополнительные сведения см. в статье [Тестовая отработка отказа в Azure с помощью Site Recovery](site-recovery-test-failover-to-azure.md).

## <a name="run-a-failover"></a>Запуск отработки отказа

1. На портале Azure выберите хранилище служб восстановления.
1. Выберите план восстановления, созданный для приложений SAP.
1. Выберите **Отработка отказа**.
1. Чтобы запустить отработку отказа, выберите точку восстановления.

Дополнительные сведения см. в статье [Отработка отказа в Site Recovery](site-recovery-failover.md).

## <a name="next-steps"></a>Следующие шаги
* Узнайте больше о создании решения аварийного восстановления для развертываний SAP NetWeaver с помощью Site Recovery. Ознакомьтесь с прилагаемой технической документацией [SAP NetWeaver: создание решения для аварийного восстановления с Site Recovery](https://aka.ms/asr_sap). В техническом документе рассматриваются рекомендации по различным архитектурам SAP. Вы можете просмотреть Поддерживаемые приложения и типы виртуальных машин для SAP в Azure. Существуют также параметры плана для тестирования решения аварийного восстановления.
* Узнайте больше о [репликации других рабочих нагрузок](site-recovery-workload.md) с помощью Site Recovery.
