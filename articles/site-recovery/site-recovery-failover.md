---
title: Запуск отработки отказа во время аварийного восстановления с помощью Azure Site Recovery
description: Как выполнить отработку отказа виртуальных машин или физических серверов в Azure с помощью Azure Site Recovery.
ms.service: site-recovery
ms.topic: article
ms.date: 12/10/2019
ms.openlocfilehash: 6737f64773f91ede1631d42cd7f28c7d961c0454
ms.sourcegitcommit: 28c5fdc3828316f45f7c20fc4de4b2c05a1c5548
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/22/2020
ms.locfileid: "92368627"
---
# <a name="run-a-failover-from-on-premises-to-azure"></a>Выполнение отработки отказа из локальной среды в Azure

В этой статье описывается, как выполнить отработку отказа локальных компьютеров в Azure в [Azure Site Recovery](site-recovery-overview.md)

## <a name="before-you-start"></a>Перед началом работы

- [Сведения](failover-failback-overview.md) о процессе отработки отказа в аварийном восстановлении.
- Если вы хотите выполнить отработку отказа нескольких компьютеров, [Узнайте](recovery-plan-overview.md) , как собирать компьютеры вместе в плане восстановления.
- Прежде чем выполнять полную отработку отказа, выполните [детализацию аварийного восстановления](site-recovery-test-failover-to-azure.md) , чтобы убедиться, что все работает правильно.

## <a name="prepare-to-connect-after-failover"></a>Подготовка к подключению после отработки отказа

Чтобы обеспечить возможность подключения к виртуальным машинам Azure, созданным после отработки отказа, ниже приведены некоторые задачи, которые необходимо выполнить в локальной среде перед отработкой отказа.


### <a name="prepare-on-premises-to-connect-after-failover"></a>Подготовка локальной среды к подключению после отработки отказа

Если вы хотите подключиться к виртуальным машинам Azure с помощью RDP или SSH после отработки отказа, необходимо выполнить ряд действий перед отработкой отказа.

**После отработки отказа** | **Расположение** | **Действия**
--- | --- | ---
**Виртуальная машина Azure под управлением Windows** | Локальный компьютер до отработки отказа | Чтобы получить доступ к виртуальной машине Azure через Интернет, включите протокол RDP и проверьте, добавлены ли правила TCP и UDP в разделе **Общее** и разрешен ли протокол RDP в разделе **Брандмауэр Windows** > **Разрешенные программы** для всех профилей.<br/><br/> Чтобы получить доступ к виртуальной машине Azure через подключение типа "сеть — сеть", включите RDP на компьютере и убедитесь, что протокол RDP разрешен в окне **Брандмауэр Windows**  ->  **Разрешенные приложения и компоненты**для **доменных и частных** сетей.<br/><br/> <br/><br/> Удалите все статические постоянные маршруты и прокси-серверы WinHTTP. Задайте для политики сети SAN операционной системы значение **OnlineAll**. [Подробнее](https://support.microsoft.com/kb/3031135).<br/><br/> Прежде чем активировать отработку отказа, убедитесь, что на виртуальной машине нет ожидающих установки обновлений Windows. Когда вы начнете отработку отказа, может начаться обновление Windows. В этом случае вы не сможете войти на виртуальную машину до завершения обновления.
**Виртуальная машина Azure под управлением Linux** | Локальный компьютер до отработки отказа | Настройте автоматический запуск службы SSH на виртуальной машине при загрузке системы (если он еще не настроен).<br/><br/> Убедитесь, что правила брандмауэра разрешают SSH-подключение к виртуальной машине.


## <a name="run-a-failover"></a>Запуск отработки отказа

В этой процедуре описывается, как запустить отработку отказа для [плана восстановления](site-recovery-create-recovery-plans.md). Если вы хотите выполнить отработку отказа для одной виртуальной машины, следуйте инструкциям для [виртуальной машины VMware](vmware-azure-tutorial-failover-failback.md), [физического сервера](physical-to-azure-failover-failback.md)или [виртуальной машины Hyper-V](hyper-v-azure-failover-failback-tutorial.md).


Выполните отработку отказа плана восстановления следующим образом:

1. В Site Recovery хранилище выберите **планы восстановления**  >  *recoveryplan_name*.
2. Щелкните **Отработка отказа**.

    ![Снимок экрана с Azure Site Recovery отображением панели АДРП с отработкой отказа, выбранной в меню "Дополнительно".](./media/site-recovery-failover/Failover.png)

3. В **поле**  >  **направление отработки**отказа при отработке отказа оставьте значение по умолчанию, если выполняется репликация в Azure.
4. В расходе **отработки отказа**выберите **точку восстановления** , для которой требуется выполнить переход на другой ресурс.

    - **Последняя**: используйте последнюю точку. При этом все данные, отправленные в службу Site Recovery, будут обрабатываться, а для каждого компьютера будет создана точка восстановления. Этот параметр обеспечивает наименьшее значение RPO (Целевая точка восстановления), так как виртуальная машина, созданная после отработки отказа, содержит все данные, которые реплицируются на Site Recovery при активации отработки отказа.
    Обратите внимание, что когда исходный регион выходит из строя, больше не удается обработать журнал. Поэтому потребуется выполнить отработку отказа до последней обработанной точки восстановления. Дополнительные сведения см. в следующей точке.
   - **Последняя обработанная**: Используйте этот параметр для отработки отказа виртуальных машин в последнюю точку восстановления, уже обработанную Site Recovery. Последнюю обработанную точку восстановления можно увидеть в виртуальной машине **последние точки восстановления**. Этот параметр обеспечивает низкое значение RTO, так как не тратится время на обработку необработанных данных.
   - **Последняя совместимость с приложениями**. Используйте этот параметр для сбоя виртуальных машин до последней точки восстановления с постоянным приложением, которая была обработана Site Recovery.
   - **Последняя обработанная многовиртуальная машина**. с помощью этого параметра виртуальные машины, входящие в группу репликации, отработки отказа до последней общей точки восстановления, согласованной с несколькими виртуальными машинами. Другие виртуальные машины отправляют отказ на последнюю обработанную точку восстановления. Этот параметр предназначен только для планов восстановления, имеющих по крайней мере одну виртуальную машину с включенной согласованностью нескольких виртуальных машин.
   - **Последняя совместимость с несколькими виртуальными машинами**. с помощью этого параметра виртуальные машины, которые входят в группу репликации, переключаются на последнюю общую точку восстановления с согласованием приложений с несколькими виртуальными машинами. Остальные виртуальные машины выполняют отработку отказа до последней точки восстановления, согласованной с приложением. Только для планов восстановления, имеющих по крайней мере одну виртуальную машину с включенной согласованностью нескольких виртуальных машин.
   - **Custom**: недоступно для планов восстановления. Этот параметр предназначен только для отработки отказа отдельных виртуальных машин.

5. Выберите **завершить работу компьютера перед началом отработки отказа** , если требуется Site Recovery завершить работу исходных виртуальных машин перед началом отработки отказа. Отработка отказа продолжится, даже если их не удастся отключить.  

    > [!NOTE]
    > При отработке отказа виртуальных машин Hyper-V завершение работы пытается синхронизировать и реплицировать локальные данные, которые еще не были отправлены в службу, прежде чем активировать отработку отказа. 

6. Следуйте ходу выполнения отработки отказа на странице **задания** . Даже при возникновении ошибок план восстановления выполняется до завершения.
7. После отработки отказа Войдите на виртуальную машину, чтобы проверить ее. 
8. Если вы хотите переключиться на другую точку восстановления для отработки отказа, используйте **команду изменить точку восстановления**.
9. Когда вы будете готовы, можно зафиксировать отработку отказа. Действие **фиксации** удаляет все точки восстановления, доступные в службе. Параметр **изменить точку восстановления** больше не будет доступен.

## <a name="run-a-planned-failover-hyper-v"></a>Запуск плановой отработки отказа (Hyper-V)

Вы можете запустить плановую отработку отказа для виртуальных машин Hyper-V.

- Плановая отработка отказа — это нулевой параметр потери данных.
- Когда выполняется плановая отработка отказа, сначала завершается работа исходных виртуальных машин, затем синхронизируются последние данные, и лишь затем запускается отработка отказа.
- Плановую отработку отказа можно запустить с помощью параметра **плановая отработка отказа** . Он выполняется аналогичным образом для обычной отработки отказа.
 
## <a name="track-failovers"></a>Контроль отработки отказа

Существует несколько заданий, связанных с отработкой отказа.

![Снимок экрана со страницей "задания" с отображением списка заданий с группой 1: Начало (1), развернутых в столбце "имя". Строка для задания SQLServer выделяется.](./media/site-recovery-failover/FailoverJob.png)

- **Проверка предварительных требований**. проверяет выполнение всех условий, необходимых для отработки отказа.
- **Отработка отказа**. обрабатывает данные, чтобы можно было создать виртуальную машину Azure из нее. Если выбрана **Последняя** точка восстановления, то создается точка восстановления на основе данных, отправленных в службу.
- **Начало**: создает виртуальную машину Azure, используя данные, обработанные на предыдущем шаге.

> [!WARNING]
> **Не отменяйте отработку отказа**. перед запуском отработки отказа репликация для виртуальной машины остановлена. Если вы отменяете выполняющееся задание, отработка отказа останавливается, но репликация виртуальной машины не начнется. Не удается запустить репликацию повторно.


### <a name="extra-failover-time"></a>Время дополнительного перехода на другой ресурс

В некоторых случаях для выполнения отработки отказа виртуальной машины требуется промежуточный шаг, который обычно занимает от восьми до 10 минут. Это следующие компьютеры, на которые влияет этот дополнительный шаг или время:

* Виртуальные машины VMware с версией службы Mobility Service старше 9,8.
* Физические серверы и виртуальные машины Hyper-V, защищенные как физические серверы.
* виртуальные машины Linux VMware;
* Виртуальные машины VMware, на которых эти драйверы отсутствуют в качестве драйверов загрузки:
    * storvsc;
    * vmbus;
    * storflt;
    * intelide;
    * atapi;
* Виртуальные машины VMware без поддержки DHCP, независимо от того, используют ли они протоколы DHCP или статические IP-адреса.


## <a name="automate-actions-during-failover"></a>Автоматизация действий во время отработки отказа

Может потребоваться автоматизировать действия во время отработки отказа. Для этого можно использовать сценарии или модули Runbook службы автоматизации Azure в планах восстановления.

- [Узнайте](site-recovery-create-recovery-plans.md) о создании и настройке планов восстановления, включая добавление скриптов.
- [Узнайте, как](site-recovery-runbook-automation.md) добавить модули Runbook службы автоматизации Azure в планы восстановления.


## <a name="configure-settings-after-failover"></a>Настройка параметров после отработки отказа

### <a name="retain-drive-letters-after-failover"></a>Хранить буквы дисков после отработки отказа

Site Recovery поддерживает хранение букв дисков. Если вы исключаете диски во время репликации виртуальных машин, [Ознакомьтесь с примером](exclude-disks-replication.md#example-1-exclude-the-sql-server-tempdb-disk) работы.

### <a name="prepare-in-azure-to-connect-after-failover"></a>Подготовка в Azure к подключению после отработки отказа

Если вы хотите подключиться к виртуальным машинам Azure, созданным после отработки отказа с помощью RDP или SSH, выполните приведенные в таблице требования.

**Тип отработки отказа** | **Расположение** | **Действия**
--- | --- | ---
**Виртуальная машина Azure под управлением Windows** | Виртуальная машина Azure после отработки отказа |  [Добавьте общедоступный IP-адрес](/archive/blogs/srinathv/how-to-add-a-public-ip-address-to-azure-vm-for-vm-failed-over-using-asr) для виртуальной машины.<br/><br/> Правила группы безопасности сети на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту RDP.<br/><br/> Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**.<br/><br/> Если вы не можете подключиться, убедитесь, что виртуальная машина запущена, и просмотрите эти [Советы по устранению неполадок](https://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).
**Виртуальная машина Azure под управлением Linux** | Виртуальная машина Azure после отработки отказа | Правила группы безопасности сети на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту SSH.<br/><br/> [Добавьте общедоступный IP-адрес](/archive/blogs/srinathv/how-to-add-a-public-ip-address-to-azure-vm-for-vm-failed-over-using-asr) для виртуальной машины.<br/><br/> Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**.<br/><br/>

Для устранения проблем с подключением после отработки отказа выполните шаги, описанные [здесь](site-recovery-failover-to-azure-troubleshoot.md).

## <a name="set-up-ip-addressing"></a>Настройка IP-адресов

- **Внутренние IP-адреса**. чтобы задать внутренний IP-адрес виртуальной машины Azure после отработки отказа, можно использовать несколько вариантов:
    - Хранить один и тот же IP-адрес. на виртуальной машине Azure можно использовать тот же IP-адрес, который был выделен для локального компьютера.
    - Использовать другой IP-адрес. Вы можете использовать другой IP-адрес для виртуальной машины Azure.
    - Дополнительные [сведения](concepts-on-premises-to-azure-networking.md#assign-an-internal-address) о настройке внутренних IP-адресов.
- **Внешние IP-адреса**. Вы можете хранить общедоступные IP-адреса при отработке отказа. Виртуальным машинам Azure, созданным в рамках процесса отработки отказа, должен быть назначен общедоступный IP-адрес Azure в регионе Azure. Общедоступный IP-адрес можно назначить вручную либо путем автоматизации процесса с помощью плана восстановления. [Подробнее](concepts-public-ip-address-with-site-recovery.md).


## <a name="next-steps"></a>Дальнейшие шаги

После отработки отказа необходимо повторно включить защиту, чтобы начать репликацию виртуальных машин Azure обратно на локальный сайт. После того как репликация будет запущена, вы сможете выполнить откат в локальной среде, когда будете готовы.

- Дополнительные [сведения](failover-failback-overview.md#reprotectionfailback) о повторном включении защиты и восстановлении размещения.
- [Подготовка](vmware-azure-reprotect.md) к повторному включению защиты и восстановлению размещения VMware.
- [Восстановить при сбое](hyper-v-azure-failback.md) Виртуальные машины Hyper-V.
- [Сведения о](physical-to-azure-failover-failback.md) процессе отработки отказа и восстановления размещения для физических серверов.