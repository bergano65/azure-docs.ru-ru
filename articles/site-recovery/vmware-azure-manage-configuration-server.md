---
title: Управление сервером конфигурации для аварийного восстановления с помощью Azure Site Recovery
author: Rajeswari-Mamilla
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 04/15/2019
ms.author: ramamill
ms.openlocfilehash: bcd232a3242b0341bfc81fa9785f76b0d3bd90cb
ms.sourcegitcommit: 28c5fdc3828316f45f7c20fc4de4b2c05a1c5548
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/22/2020
ms.locfileid: "92369460"
---
# <a name="manage-the-configuration-server-for-vmware-vmphysical-server-disaster-recovery"></a>Управление сервером конфигурации для аварийного восстановления виртуальных машин и физических серверов VMware

При использовании [Azure Site Recovery](site-recovery-overview.md) для аварийного восстановления виртуальных машин VMware и физических серверов в Azure настраивается локальный сервер конфигурации. Сервер конфигурации используется для управления обменом данными между локальной средой VMware и Azure, а также репликацией данных. В этой статье перечислены распространенные задачи управления сервером конфигурации после его развертывания.


[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="update-windows-license"></a>Обновление лицензии Windows

Вместе с шаблоном OVF предоставляется пробная лицензия сроком на 180 дней. Для бесперебойной работы необходимо активировать Windows с использованием приобретенной лицензии. Обновление лицензий можно выполнить либо с помощью автономного ключа, либо стандартного ключа KMS. Руководство можно найти в [командной строке DISM Windows для запуска операционной системы](/windows-hardware/manufacture/desktop/dism-windows-edition-servicing-command-line-options). Чтобы получить ключи, см. раздел [Настройка клиента службы KMS](/windows-server/get-started/kmsclientkeys).

## <a name="access-configuration-server"></a>Доступ к серверу конфигурации

Доступ к серверу конфигурации можно получить следующими способами:

* Войдите на виртуальную машину, на которой она развернута, и запустите **Azure Site Recovery Configuration Manager** с помощью ярлыка на рабочем столе.
* Кроме того, сервер конфигурации можно получить удаленно из https://*конфигуратионсервернаме*/: 44315/. Для входа необходимы учетные данные администратора.

## <a name="modify-vmware-server-settings"></a>Изменение параметров сервера VMware

1. Чтобы привязать другой сервер VMware к серверу конфигурации, после [входа](#access-configuration-server) выберите **Добавление сервера vCenter Server или ESXi vSphere**.
2. Введите сведения и нажмите кнопку **ОК**.

## <a name="modify-credentials-for-automatic-discovery"></a>Изменение учетных данных для автоматического обнаружения

1. Чтобы обновить учетные данные, используемые для подключения к серверу VMware для автоматического обнаружения виртуальных машин VMware, после [входа](#access-configuration-server) выберите учетную запись и щелкните **Изменить**.
2. Введите новые учетные данные и нажмите кнопку **ОК**.

    ![Изменение VMware](./media/vmware-azure-manage-configuration-server/modify-vmware-server.png)

Учетные данные также можно изменить с помощью CSPSConfigtool.exe.

1. Войдите на сервер конфигурации и запустите CSPSConfigtool.exe
2. Выберите учетную запись, которую необходимо изменить, и щелкните **Изменить**.
3. Введите измененные учетные данные и щелкните **ОК**.

## <a name="modify-credentials-for-mobility-service-installation"></a>Изменение учетных данных для установки службы Mobility Service

Измените учетные данные, используемые для автоматической установки службы Mobility Service на виртуальных машинах VMware, предназначенных для репликации.

1. После [входа](#access-configuration-server)выберите **Управление учетными данными виртуальной машины** .
2. Выберите учетную запись, которую вы хотите изменить, и нажмите кнопку **изменить** .
3. Введите новые учетные данные и нажмите кнопку **ОК**.

    ![Изменение учетных данных службы Mobility Service](./media/vmware-azure-manage-configuration-server/modify-mobility-credentials.png)

Учетные данные также можно изменить с помощью CSPSConfigtool.exe.

1. Войдите на сервер конфигурации и запустите CSPSConfigtool.exe
2. Выберите учетную запись, которую вы хотите изменить, и нажмите кнопку **изменить** .
3. Введите новые учетные данные и щелкните **ОК**.

## <a name="add-credentials-for-mobility-service-installation"></a>Добавление учетных данных для установки службы Mobility Service

Если учетные данные не были добавлены во время развертывания OVF сервера конфигурации, выполните следующие шаги.

1. После [входа](#access-configuration-server) выберите **Управление учетными данными виртуальной машины**.
2. Щелкните **Добавить учетные данные виртуальной машины**.
    ![Снимок экрана: Управление панелью учетных данных виртуальной машины с помощью ссылки "добавить учетные данные виртуальной машины".](media/vmware-azure-manage-configuration-server/add-mobility-credentials.png)
3. Введите новые учетные данные и щелкните **Добавить**.

Учетные данные также можно добавить с помощью CSPSConfigtool.exe.

1. Войдите на сервер конфигурации и запустите CSPSConfigtool.exe
2. Щелкните **Добавить**, введите новые учетные данные и щелкните **ОК**.

## <a name="modify-proxy-settings"></a>Изменение параметров прокси-сервера

Измените параметры прокси-сервера, используемые на компьютере сервера конфигурации для доступа к Azure через Интернет. При наличии компьютера сервера обработки помимо сервера обработки по умолчанию, выполняемого на сервере конфигурации, измените параметры на обоих компьютерах.

1. После [входа](#access-configuration-server) на сервер конфигурации выберите **Управление подключением**.
2. Обновление значения прокси-сервера. Затем выберите **Сохранить**, чтобы обновить параметры.

## <a name="add-a-network-adapter"></a>Добавление сетевого адаптера

Шаблон в формате OVF развертывает виртуальную машину сервера конфигурации с одним сетевым адаптером.

- [На виртуальную машину можно добавить дополнительный адаптер](vmware-azure-deploy-configuration-server.md#add-an-additional-adapter), но необходимо добавить его перед регистрацией сервера конфигурации в хранилище.
- Если необходимо добавить адаптер после того, как сервер конфигурации был зарегистрирован в хранилище, необходимо добавить адаптер в свойствах виртуальной машины. Затем необходимо [повторно зарегистрировать](#reregister-a-configuration-server-in-the-same-vault) сервер в хранилище.

## <a name="how-to-renew-ssl-certificates"></a>Как продлить SSL-сертификаты

Сервер конфигурации содержит встроенный веб-сервер, который управляет действиями агентов мобильности на всех защищенных компьютерах, встроенных и масштабируемых серверах обработки, а также подключенных к нему главных целевых серверов. Веб-сервер использует SSL-сертификат для аутентификации клиентов. Срок действия этого сертификата составляет три года, его можно обновить в любое время.

### <a name="check-expiry"></a>Проверка срока действия

Дата окончания срока действия отображается в разделе **Работоспособность сервера конфигурации**. Для серверов конфигурации, развернутых до мая 2016 года, срока действия сертификата составлял один год. При наличии сертификата, срок действия которого истекает, происходит следующее.

- Когда до даты истечения срока действия остается не больше двух месяцев, служба начинает отправлять уведомления на портале и по электронной почте (если вы подписаны на уведомления Site Recovery).
- Баннер уведомления отображается на странице ресурсов хранилища. Для получения дополнительных сведений выберите баннер.
- Если вы видите кнопку **Обновить**, это указывает, что некоторые компоненты в вашей среде не обновлены до версии 9.4.xxxx.x или более поздней. Обновите компоненты, прежде чем обновлять сертификат. При наличии более ранних версий обновление сертификата будет невозможно.

### <a name="if-certificates-are-yet-to-expire"></a>Если срок действия сертификатов еще не истек

1. Чтобы продлить, в хранилище откройте **Site Recovery Infrastructure**  >  **сервер конфигурации**инфраструктуры Site Recovery. Выберите нужный сервер конфигурации.
2. Убедитесь, что все компоненты масштабируемые серверы обработки, главные целевые серверы и агенты мобильности на всех защищенных компьютерах имеют последние версии и находятся в подключенном состоянии.
3. Теперь выберите **обновить сертификаты**.
4. Внимательно следуйте инструкциям на этой странице и нажмите кнопку ОК, чтобы обновить сертификаты на выбранном сервере конфигурации и связанных с ним компонентах.

### <a name="if-certificates-have-already-expired"></a>Если срок действия сертификатов уже истек

1. Срок действия POST истек, сертификаты **не могут быть обновлены из портал Azure**. Перед продолжением убедитесь, что все компоненты масштабируемые серверы обработки, главные целевые серверы и агенты мобильности на всех защищенных компьютерах находятся в режиме "последние версии" и находятся в подключенном состоянии.
2. **Выполните эту процедуру только в том случае, если срок действия сертификатов уже истек.** Войдите на сервер конфигурации, перейдите на диск C > Program Data > Site Recovery > Главная > svsystems > bin и выполните средство исполнителя "служебную renewcerts" от имени администратора.
3. Откроется окно выполнения PowerShell, в котором активируется возобновление сертификатов. Это может занять до 15 минут. Не закрывайте окно до завершения обновления.

:::image type="content" source="media/vmware-azure-manage-configuration-server/renew-certificates.png" alt-text="реневцертификатес":::

## <a name="reregister-a-configuration-server-in-the-same-vault"></a>Повторная регистрация сервера конфигурации в том же хранилище

Можно повторно зарегистрировать сервер конфигурации в том же хранилище, если необходимо. При наличии дополнительного компьютера сервера обработки помимо сервера обработки по умолчанию, выполняемого на сервере конфигурации, следует повторно зарегистрировать оба эти компьютера.


1. В хранилище откройте **Управление**  >  **Site Recovery Infrastructure**  >  **серверы конфигурации**инфраструктуры Site Recovery.
2. В списке **Серверы** выберите **Скачать ключ регистрации**, чтобы загрузить файл учетных данных хранилища.
3. Войдите на компьютер сервера конфигурации.
4. В папке **%ProgramData%\ASR\home\svsystems\bin** запустите файл **cspsconfigtool.exe**.
5. На вкладке **Vault Registration** (Регистрация в хранилище) выберите **Обзор** и найдите скачанный файл с учетными данными хранилища.
6. При необходимости укажите данные прокси-сервера. Нажмите кнопку **Зарегистрировать**.
7. Откройте командную строку PowerShell с правами администратора и выполните следующую команду:
   ```
    $pwd = ConvertTo-SecureString -String MyProxyUserPassword
    Set-OBMachineSetting -ProxyServer http://myproxyserver.domain.com -ProxyPort PortNumber – ProxyUserName domain\username -ProxyPassword $pwd
   ```

    >[!NOTE]
    >Чтобы получить **последние сертификаты** с сервера конфигурации на сервер обработки масштабирования, выполните команду *" \<Installation Drive\Microsoft Azure Site Recovery\agent\cdpcli.exe> " — registermt*

8. И, наконец, перезапустите службу OBEngine, выполнив приведенную ниже команду.
   ```
        net stop obengine
        net start obengine
   ```


## <a name="register-a-configuration-server-with-a-different-vault"></a>Регистрация сервера конфигурации с другим хранилищем

> [!WARNING]
> Если выполнить описанное ниже действие, связь сервера конфигурации с текущим хранилищем будет удалена и репликация защищенных виртуальных машин на сервере конфигурации будет остановлена.

1. Войдите на сервер конфигурации.
2. Откройте командную строку PowerShell с правами администратора и выполните следующую команду:

    ```
    reg delete "HKLM\Software\Microsoft\Azure Site Recovery\Registration"
    net stop dra
    ```
3. Откройте портал браузера устройства сервера конфигурации с помощью ярлыка на рабочем столе.
4. Выполните регистрацию, аналогичную [регистрации](vmware-azure-tutorial.md#register-the-configuration-server) нового сервера конфигурации.

## <a name="upgrade-the-configuration-server"></a>Обновление сервера конфигурации

Для обновления сервера конфигурации запускаются накопительные пакеты обновления. Обновления применимы к версиям вплоть до N-4. Пример:

- Если вы используете версии 9.7, 9.8, 9.9 или 9.10, можно обновить их непосредственно до версии 9.11.
- Если вы используете версию 9.6 или ниже и хотите обновить ее до версии 9.11, сначала выполните обновление до версии 9.7, а затем — до версии 9.11.

Дополнительные сведения о заявлении о поддержке компонентов Azure Site Recovery см. [здесь](./service-updates-how-to.md#support-statement-for-azure-site-recovery).
Ссылки на накопительные пакеты обновления для всех версий сервера конфигурации доступны [здесь](./service-updates-how-to.md#links-to-currently-supported-update-rollups).

> [!IMPORTANT]
> С каждой новой выпускаемой версией N компонента Azure Site Recovery поддержка всех версий ниже N-4 считается прекращенной. Рекомендуется всегда обновляться до последней доступной версии.</br>
> Дополнительные сведения о заявлении о поддержке компонентов Azure Site Recovery см. [здесь](./service-updates-how-to.md#support-statement-for-azure-site-recovery).

Инструкции по обновлению сервера:

1. В хранилище выберите **Управление**  >  **Site Recovery Infrastructure**  >  **серверы конфигурации**инфраструктуры Site Recovery.
2. Если обновление доступно, то в строке **Версия агента** > появится ссылка.
    ![Update](./media/vmware-azure-manage-configuration-server/update2.png)
3. Скачайте файл установщика обновлений на сервер конфигурации.

    ![Update](./media/vmware-azure-manage-configuration-server/update1.png)

4. Дважды щелкните, чтобы запустить установщик.
5. Установщик определит текущую версию на компьютере. Чтобы начать обновление, нажмите кнопку **Да**.
6. После завершения обновления будет выполнена проверка сервера конфигурации.

    ![Update](./media/vmware-azure-manage-configuration-server/update3.png)

7. Чтобы закрыть установщик, нажмите кнопку **Готово**.
8. Сведения об обновлении остальных компонентов Site Recovery см. в [руководстве по обновлению](./service-updates-how-to.md#vmware-vmphysical-server-disaster-recovery-to-azure).

## <a name="upgrade-configuration-serverprocess-server-from-the-command-line"></a>Обновление сервера конфигурации и сервера обработки из командной строки

Запустите файл установки следующим образом:

  ```
  UnifiedSetup.exe [/ServerMode <CS/PS>] [/InstallDrive <DriveLetter>] [/MySQLCredsFilePath <MySQL credentials file path>] [/VaultCredsFilePath <Vault credentials file path>] [/EnvType <VMWare/NonVMWare>] [/PSIP <IP address to be used for data transfer] [/CSIP <IP address of CS to be registered with>] [/PassphraseFilePath <Passphrase file path>]
  ```

### <a name="sample-usage"></a>Пример использования
  ```
  MicrosoftAzureSiteRecoveryUnifiedSetup.exe /q /x:C:\Temp\Extracted
  cd C:\Temp\Extracted
  UNIFIEDSETUP.EXE /AcceptThirdpartyEULA /servermode "CS" /InstallLocation "D:\" /MySQLCredsFilePath "C:\Temp\MySQLCredentialsfile.txt" /VaultCredsFilePath "C:\Temp\MyVault.vaultcredentials" /EnvType "VMWare"
  ```


### <a name="parameters"></a>Параметры

|Имя параметра| Type | Описание| Значения|
|-|-|-|-|
| /ServerMode|Обязательно|Указывает, нужно ли установить и сервер конфигурации, и сервер обработки или только север обработки.|CS<br>PS|
|/InstallLocation|Обязательно|Папка для установки компонентов.| Любая папка на компьютере.|
|/MySQLCredsFilePath|Обязательно|Путь к файлу, в котором хранятся учетные данные сервера MySQL.|Этот файл должен быть в формате, указанном ниже.|
|/VaultCredsFilePath|Обязательно|Путь к файлу с учетными данными хранилища.|Допустимый путь к файлу.|
|/EnvType|Обязательно|Тип среды, которую необходимо защитить |VMware<br>NonVMware|
|/PSIP|Обязательно|IP-адрес сетевой карты для передачи данных репликации.| Любой допустимый IP-адрес|
|/CSIP|Обязательно|IP-адрес сетевой карты, передачу данных через который ожидает сервер конфигурации.| Любой допустимый IP-адрес|
|/PassphraseFilePath|Обязательно|Полный путь к расположению файла с парольной фразой.|Допустимый путь к файлу.|
|/BypassProxy|Необязательно|Указывает, что сервер конфигурации подключается к Azure без использования прокси-сервера.|Следует получить это значение от Venu.|
|/ProxySettingsFilePath|Необязательно|Параметры прокси-сервера (прокси-сервер по умолчанию с обязательной аутентификацией или пользовательский прокси-сервер).|Этот файл должен быть в формате, указанном ниже.|
|DataTransferSecurePort|Необязательно|Номер порта PSIP для данных репликации.| Допустимый номер порта (значение по умолчанию — 9433).|
|/SkipSpaceCheck|Необязательно|Пропуск проверки места на диске кэша.| |
|/AcceptThirdpartyEULA|Обязательно|Флажок означает принятие лицензионного соглашения между пользователем и сторонним разработчиком.| |
|/ShowThirdpartyEULA|Необязательно|Отображает лицензионное соглашение со сторонним разработчиком. Если оно задано как источник данных, то все остальные параметры игнорируются.| |



### <a name="create-file-input-for-mysqlcredsfilepath"></a>Создание файла входных данных для MYSQLCredsFilePath

Параметр MySQLCredsFilePath принимает в качестве входных данных файл. Создайте файл, используя следующий формат, и передайте его в качестве входных данных для параметра MySQLCredsFilePath.
```ini
[MySQLCredentials]
MySQLRootPassword = "Password>"
MySQLUserPassword = "Password"
```
### <a name="create-file-input-for-proxysettingsfilepath"></a>Создание файла входных данных для ProxySettingsFilePath
Параметр ProxySettingsFilePath принимает в качестве входных данных файл. Создайте файл, используя следующий формат, и передайте его в качестве входных данных для параметра ProxySettingsFilePath.

```ini
[ProxySettings]
ProxyAuthentication = "Yes/No"
Proxy IP = "IP Address"
ProxyPort = "Port"
ProxyUserName="UserName"
ProxyPassword="Password"
```

## <a name="delete-or-unregister-a-configuration-server"></a>Отмена регистрации или удаление сервера конфигурации

1. [Отключите защиту](site-recovery-manage-registration-and-protection.md#disable-protection-for-a-vmware-vm-or-physical-server-vmware-to-azure) для всех виртуальных машин на сервере конфигурации.
2. [Отмените связь](vmware-azure-set-up-replication.md#disassociate-or-delete-a-replication-policy) всех политик репликации с сервером конфигурации и [удалите](vmware-azure-set-up-replication.md#disassociate-or-delete-a-replication-policy) их.
3. [Удалите](vmware-azure-manage-vcenter.md#delete-a-vcenter-server) все узлы vSphere и серверы vCenter Server, связанные с сервером конфигурации.
4. В хранилище откройте **Site Recovery**  >  **серверы конфигурации**инфраструктуры.
5. Выберите сервер конфигурации, который должен быть удален. На странице **Сведения** выберите **Удалить**.

    ![Удаление сервера конфигурации](./media/vmware-azure-manage-configuration-server/delete-configuration-server.png)


### <a name="delete-with-powershell"></a>Удаление с помощью PowerShell

При необходимости можно удалить сервер конфигурации с помощью PowerShell.

1. [Установите](/powershell/azure/install-Az-ps) модуль Azure PowerShell.
2. Войдите в учетную запись Azure с помощью следующей команды:

    `Connect-AzAccount`
3. Выберите подписку хранилища.

     `Get-AzSubscription –SubscriptionName <your subscription name> | Select-AzSubscription`
3.  Задание контекста хранилища.

    ```
    $vault = Get-AzRecoveryServicesVault -Name <name of your vault>
    Set-AzSiteRecoveryVaultSettings -ARSVault $vault
    ```
4. Получите сервер конфигурации.

    `$fabric = Get-AzSiteRecoveryFabric -FriendlyName <name of your configuration server>`
6. Удалите сервер конфигурации.

    `Remove-AzSiteRecoveryFabric -Fabric $fabric [-Force]`

> [!NOTE]
> Параметр **-Force** можно использовать в Remove-AzSiteRecoveryFabric для принудительного удаления сервера конфигурации.

## <a name="generate-configuration-server-passphrase"></a>Создание парольной фразы сервера конфигурации.

1. Войдите на сервер конфигурации и откройте окно командной строки с правами администратора.
2. Чтобы изменить каталог на папку корзины, выполните команду **cd %ProgramData%\ASR\home\svsystems\bin**
3. Чтобы создать файл с парольной фразой, выполните команду **genpassphrase.exe -v > MobSvc.passphrase**.
4. Парольная фраза будет храниться в файле, расположенном по адресу **%ProgramData%\ASR\home\svsystems\bin\MobSvc.passphrase**.

## <a name="refresh-configuration-server"></a>Обновление сервера конфигураций

1. В портал Azure перейдите к **хранилищу служб восстановления**  >  **Управление**  >  **инфраструктурой Site Recovery**  >  **для VMware & физические компьютеры**  >  **серверы конфигурации**
2. Щелкните сервер конфигурации, который нужно обновить.
3. В колонке с подробными сведениями о выбранном сервере конфигурации щелкните **больше**  >  **обновить сервер**.
4. Отслеживайте ход выполнения задания в разделе Наблюдение за **хранилищем служб восстановления**  >  **Monitoring**  >  **Site Recovery задания**.

## <a name="failback-requirements"></a>Требования к восстановлению размещения

Во время повторной защиты и восстановления размещения локальный сервер конфигурации должен быть запущен и подключен. Для успешного восстановления размещения виртуальная машина должна существовать в базе данных сервера конфигурации.

Не забывайте регулярно создавать плановые резервные копии конфигурации сервера. Если происходит авария и сервер конфигурации утерян, необходимо сначала восстановить сервер конфигурации из резервной копии и убедиться, что он имеет тот же IP-адрес, с которым он был зарегистрирован в хранилище. Восстановление размещения не будет работать, если для восстановленного сервера конфигурации используется другой IP-адрес.

## <a name="next-steps"></a>Дальнейшие шаги

Ознакомьтесь с руководствами по настройке аварийного восстановления [виртуальных машин VMware](vmware-azure-tutorial.md) в Azure.