---
title: Диагностика и устранение неполадок с доступностью пакетов SDK для Cosmos Azure в многорегионовых средах
description: Узнайте все о принципах доступности пакета SDK для Azure Cosmos при работе в разных регионах.
author: ealsur
ms.service: cosmos-db
ms.date: 02/16/2021
ms.author: maquaran
ms.subservice: cosmosdb-sql
ms.topic: troubleshooting
ms.reviewer: sngun
ms.openlocfilehash: 641b7d44407f8f3760c673f45d69dcfdc8b363b8
ms.sourcegitcommit: 227b9a1c120cd01f7a39479f20f883e75d86f062
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/18/2021
ms.locfileid: "100650989"
---
# <a name="diagnose-and-troubleshoot-the-availability-of-azure-cosmos-sdks-in-multiregional-environments"></a>Диагностика и устранение неполадок с доступностью пакетов SDK для Cosmos Azure в многорегионовых средах
[!INCLUDE[appliesto-sql-api](includes/appliesto-sql-api.md)]

В этой статье описывается поведение последней версии пакетов SDK для Azure Cosmos при возникновении проблем с подключением к определенному региону или при отработке отказа региона.

Все пакеты SDK для Azure Cosmos позволяют настроить региональные предпочтения. В разных пакетах SDK используются следующие свойства:

* Свойство [ConnectionPolicy. PreferredLocations](/dotnet/api/microsoft.azure.documents.client.connectionpolicy.preferredlocations) в пакете SDK для .NET v2.
* Свойства [космосклиентоптионс. аппликатионрегион](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.applicationregion) или [космосклиентоптионс. аппликатионпреферредрегионс](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.applicationpreferredregions) в пакете SDK для .NET v3.
* Метод [космосклиентбуилдер. преферредрегионс](/java/api/com.azure.cosmos.cosmosclientbuilder.preferredregions) в пакете SDK для Java v4.
* Параметр [CosmosClient.preferred_locations](/python/api/azure-cosmos/azure.cosmos.cosmos_client.cosmosclient) в пакете SDK для Python.
* Параметр [космосклиентоптионс. ConnectionPolicy. preferredLocations](/javascript/api/@azure/cosmos/connectionpolicy#preferredlocations) в пакете SDK для JS.

При задании региональных настроек клиент будет подключаться к региону, как упоминалось в следующей таблице.

|Тип учетной записи |Операции чтения |Запись |
|------------------------|--|--|
| Регион с одной записью | Предпочтительный регион | Основной регион  |
| Несколько регионов записи | Предпочтительный регион | Предпочтительный регион  |

Если **не задать предпочитаемый регион**, клиент SDK по умолчанию будет основным регионом:

|Тип учетной записи |Операции чтения |Запись |
|------------------------|--|--|
| Регион с одной записью | Основной регион | Основной регион |
| Несколько регионов записи | Основной регион  | Основной регион  |

> [!NOTE]
> Основной регион относится к первому региону в [списке регионов учетной записи Azure Cosmos](distribute-data-globally.md).
> Если значения, указанные в качестве региональных настроек, не совпадают с существующими регионами Azure, они будут проигнорированы. Если они совпадают с существующим регионом, но учетная запись не реплицируется на нее, клиент будет подключаться к следующему предпочитаемому региону, который соответствует или к основному региону.

> [!WARNING]
> Отключение повторного обнаружения конечных точек (при этом устанавливается значение false) в конфигурации клиента отключит всю логику отработки отказа и доступности, описанную в этом документе.
> Доступ к этой конфигурации можно получить с помощью следующих параметров в каждом пакете SDK для Azure Cosmos:
>
> * Свойство [ConnectionPolicy. енаблиндпоинтредисковери](/dotnet/api/microsoft.azure.documents.client.connectionpolicy.enableendpointdiscovery) в пакете SDK для .NET v2.
> * Метод [космосклиентбуилдер. ендпоинтдисковеренаблед](/java/api/com.azure.cosmos.cosmosclientbuilder.endpointdiscoveryenabled) в пакете SDK для Java v4.
> * Параметр [CosmosClient.enable_endpoint_discovery](/python/api/azure-cosmos/azure.cosmos.cosmos_client.cosmosclient) в пакете SDK для Python.
> * Параметр [космосклиентоптионс. ConnectionPolicy. енаблиндпоинтдисковери](/javascript/api/@azure/cosmos/connectionpolicy#enableEndpointDiscovery) в пакете SDK для JS.

В нормальных обстоятельствах клиент SDK будет подключаться к предпочтительному региону (если задана региональная предпочтение) или к основному региону (если предпочтений не задан), и операции будут ограничены этим регионом, если не будет выполнено ни один из следующих сценариев.

В таких случаях клиент, использующий пакет SDK Azure Cosmos, предоставляет журналы и включает сведения о повторных попытках в ходе **операции диагностической информации**:

* Свойство *рекуестдиагностиксстринг* для ответов в пакете SDK для .NET v2.
* Свойство *Diagnostics* в ответах и исключениях в пакете SDK для .NET v3.
* Метод *getDiagnostics()* в ответах и исключениях в пакете SDK для Java версии 4.

При определении следующего региона в порядке предпочтения клиент SDK будет использовать список регионов учетной записи, определяя приоритеты предпочитаемых регионов (если они есть).

Подробные сведения о гарантиях SLA во время этих событий см. в разделе соглашения об уровне обслуживания [для обеспечения доступности](high-availability.md#slas-for-availability).

## <a name="removing-a-region-from-the-account"></a><a id="remove-region"></a>Удаление региона из учетной записи

При удалении региона из учетной записи Azure Cosmos любой клиент SDK, который активно использует эту учетную запись, определит удаление региона с помощью кода ответа сервера. Затем клиент помечает региональную конечную точку как недоступную. Клиент повторяет текущую операцию, и все будущие операции окончательно направляются в следующий регион в порядке предпочтения. Если в списке предпочтений имеется только одна запись (или она была пуста), но у учетной записи есть другие регионы, она будет направляться в следующий регион в списке учетных записей.

## <a name="adding-a-region-to-an-account"></a>Добавление региона в учетную запись

Каждые 5 минут клиент Azure Cosmos SDK считывает конфигурацию учетной записи и обновляет регионы, о которых она знает.

Если удалить регион и позже добавить его обратно в учетную запись, если в конфигурации пакета SDK для добавленного региона задан более высокий региональный приоритет, чем в текущем подключенном регионе, пакет SDK снова переключится на использование этого региона. После обнаружения добавленной области в нее направляются все будущие запросы.

Если настроить клиент так, чтобы он лучше подключаться к региону, который не имеет учетной записи Azure Cosmos, предпочтительный регион игнорируется. Если вы добавите этот регион позже, клиент обнаружит ее и вернется к этому региону без возможности восстановления.

## <a name="fail-over-the-write-region-in-a-single-write-region-account"></a><a id="manual-failover-single-region"></a>Отработка отказа региона записи в одной учетной записи региона записи

При запуске отработки отказа текущего региона записи следующий запрос на запись завершится ошибкой с известным ответом внутреннего сервера. При обнаружении этого ответа клиент запросит учетную запись, чтобы узнать новый регион записи, и продолжит выполнять текущую операцию и будет окончательно маршрутизировать все будущие операции записи в новый регион.

## <a name="regional-outage"></a>Региональный сбой

Если учетная запись является отдельным регионом записи и в ходе операции записи возникает региональный сбой, поведение аналогично [отработке отказа вручную](#manual-failover-single-region). Для запросов чтения или учетных записей с несколькими регионами записи поведение аналогично [удалению области](#remove-region).

## <a name="session-consistency-guarantees"></a>Гарантии согласованности сеансов

При использовании [согласованности сеанса](consistency-levels.md#guarantees-associated-with-consistency-levels)клиент должен гарантировать, что он сможет считывать собственные записи. В учетных записях с одним регионом записи, где предпочтение в области чтения отличается от региона записи, возможны случаи, когда пользователь создает запись и при выполнении чтения из локального региона в локальной области еще не получена репликация данных (скорость необлегченного ограничения). В таких случаях пакет SDK обнаруживает конкретный сбой операции чтения и повторяет попытку чтения в основном регионе, чтобы обеспечить согласованность сеанса.

## <a name="transient-connectivity-issues-on-tcp-protocol"></a>Проблемы с временным подключением по протоколу TCP

В сценариях, где клиент SDK Azure Cosmos настроен для использования протокола TCP, в данном запросе могут возникнуть ситуации, когда условия сети временно влияют на связь с определенной конечной точкой. Эти временные состояния сети могут быть в состоянии истечения времени ожидания TCP и ошибок "Служба недоступна" (HTTP 503). Клиент повторит запрос локально в той же конечной точке, прежде чем отображая ошибку.

Если пользователь настроил предпочтительный список регионов с более чем одним регионом, а учетная запись Azure Cosmos — несколько регионов записи или отдельный регион записи, а операция является запросом на чтение, клиент обнаружит локальный сбой и попытается выполнить одну операцию в следующем регионе в списке предпочтений.

## <a name="next-steps"></a>Дальнейшие действия

* Ознакомьтесь с соглашением об [уровне обслуживания для доступности](high-availability.md#slas-for-availability).
* Использование последнего [пакета SDK для .NET](sql-api-sdk-dotnet-standard.md)
* Использование последнего [пакета SDK для Java](sql-api-sdk-java-v4.md)
* Использование последнего [пакета SDK для Python](sql-api-sdk-python.md)
* Использовать последний [пакет SDK для Node](sql-api-sdk-node.md)
