---
title: Заголовки ответа Azure Cosmos DB Gremlin
description: Справочная документация по метаданным ответа сервера, которая включает дополнительные способы устранения неполадок
author: olignat
ms.service: cosmos-db
ms.subservice: cosmosdb-graph
ms.topic: reference
ms.date: 09/03/2019
ms.author: olignat
ms.openlocfilehash: 9efd2afe2e1048b205f8ae0b0680fad2417c42bf
ms.sourcegitcommit: 97605f3e7ff9b6f74e81f327edd19aefe79135d2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/06/2019
ms.locfileid: "70737465"
---
# <a name="azure-cosmos-db-gremlin-server-response-headers"></a>Заголовки ответа сервера Azure Cosmos DB Gremlin
В этой статье рассматриваются заголовки, Cosmos DB сервер Gremlin возвращается вызывающему объекту при выполнении запроса. Эти заголовки полезны для устранения неполадок с производительностью запросов, создания приложения, которое интегрируется с Cosmos DB службой и упрощает поддержку клиентов.

Помните, что зависимость от этих заголовков ограничивает переносимость приложения другими реализациями Gremlin. По возвращении вы получите более тесную интеграцию с Cosmos DB Gremlin. Эти заголовки не являются стандартным TinkerPop.

## <a name="headers"></a>Заголовки

| Header | Type | Образец значения | Включение | Объяснение |
| --- | --- | --- | --- | --- |
| **x-ms-request-charge** | double | 11,3243 | Успешные и неудачные события | Объем сбора или пропускной способности базы данных, использованной в [единицах запросов (единиц запроса/с или RUs)](request-units.md) для частичного ответного сообщения. Этот заголовок имеется в каждом продолжении для запросов с несколькими фрагментами. Он отражает стоимость определенного фрагмента ответа. Только для запросов, состоящих из одного фрагмента ответа этот заголовок соответствует общей стоимости обхода. Однако для большинства сложных обходов это значение представляет собой частичную стоимость. |
| **x-ms-total-request-charge** | double | 423,987 | Успешные и неудачные события | Объем сбора или пропускной способности базы данных, использованной в [единицах запросов (единиц запроса/с или RUs)](request-units.md) для всего запроса. Этот заголовок имеется в каждом продолжении для запросов с несколькими фрагментами. Он указывает совокупную стоимость с начала запроса. Значение этого заголовка в последнем фрагменте указывает на полную плату за запрос. |
| **x-MS-Server-Time-MS** | double | 13,75 | Успешные и неудачные события | Этот заголовок включен в целях устранения проблем с задержкой. Указывает время (в миллисекундах), которое Cosmos DB сервера Gremlin для выполнения и создания частичного ответного сообщения. Использование значения этого заголовка и его сравнение с общей задержкой запросов позволяет вычислять нагрузку на задержку сети. |
| **x-MS-Total-сервер-время-МС** | double | 130,512 | Успешные и неудачные события | Общее время в миллисекундах, которое Cosmos DB сервера Gremlin для выполнения всего обхода. Этот заголовок включен в каждый частичный ответ. Он представляет совокупное время выполнения с момента запуска запроса. Последний ответ показывает общее время выполнения. Этот заголовок полезен для различения клиента и сервера в качестве источника задержки. Можно сравнить время выполнения обхода на клиенте со значением этого заголовка. |
| **x-ms-status-code** | long | 200 | Успешные и неудачные события | Заголовок указывает на внутреннюю причину завершения запроса или завершения. В приложении рекомендуется просмотреть значение этого заголовка и принять меры по исправлению. |
| **x-MS-подсостояние — код** | long | 1003 | Только сбой | Cosmos DB — это многомодельная база данных, построенная на уровне единого хранилища. Этот заголовок содержит дополнительные сведения о причине сбоя, возникающие в случае сбоя в более низких уровнях стека высокого уровня доступности. Приложение рекомендуется хранить этот заголовок и использовать его при обращении в службу поддержки клиентов Cosmos DB. Значение этого заголовка полезно для Cosmos DB инженера по быстрому устранению неполадок. |
| **x-ms-retry-after-ms** | строка (TimeSpan) | "00:00:03.9500000" | Только сбой | Этот заголовок представляет собой строковое представление типа [TimeSpan](https://docs.microsoft.com/dotnet/api/system.timespan) .NET. Это значение будет включаться только в запросы, не выполненные из-за нехватки пропускной способности. Приложение должно повторно отправить обход после указанного периода времени. |
| **x-ms-activity-id** | строка (GUID) | "A9218E01-3A3A-4716-9636-5BD86B056613" | Успешные и неудачные события | Заголовок содержит уникальный идентификатор запроса на стороне сервера. Каждому запросу назначается уникальный идентификатор сервера для отслеживания целей. Приложения должны регистрировать идентификаторы действий, возвращаемые сервером, для запросов, о которых может потребоваться обратиться в службу поддержки клиентов по адресу. Специалисты службы поддержки Cosmos DB могут найти определенные запросы по этим идентификаторам в телеметрии Cosmos DBных служб. |

## <a name="status-codes"></a>Коды состояния

Ниже перечислены наиболее распространенные коды состояния, возвращаемые сервером.

| Status | Объяснение |
| --- | --- |
| **401** | Сообщение `"Unauthorized: Invalid credentials provided"` об ошибке возвращается, если пароль для проверки подлинности не совпадает с ключом учетной записи Cosmos DB. Перейдите к учетной записи Cosmos DB Gremlin в портал Azure и убедитесь, что ключ указан правильно.|
| **404** | Одновременные операции, которые пытаются одновременно удалить и обновить одно и то же ребро или вершину. Сообщение об ошибке `"Owner resource does not exist"` означает, что в указанной базе данных или коллекции содержатся неправильные параметры подключения в формате `/dbs/<database name>/colls/<collection or graph name>`.|
| **408** | `"Server timeout"`Указывает, что обход занял более **30 секунд** и был отменен сервером. Оптимизируйте обходы для быстрого выполнения путем фильтрации вершин или ребер на каждом прыжке обхода до области поиска с узким списком.|
| **409** | `"Conflicting request to resource has been attempted. Retry to avoid conflicts."` Это обычно происходит, если вершина или ребро с определенным идентификатором уже есть в графе.| 
| **412** | Код состояния дополняется сообщением `"PreconditionFailedException": One of the specified pre-condition is not met`об ошибке. Эта ошибка свидетельствует о нарушении управления оптимистичным параллелизмом между чтением ребра или вершины и записью обратно в хранилище после изменения. Наиболее распространенными ситуациями при возникновении этой ошибки является изменение свойств `g.V('identifier').property('name','value')`, например. Подсистема Gremlin будет считывать вершину, изменять ее и записывать ее обратно. Если в параллельной попытке записи одной и той же вершины или границы выполняется другой обход, то одна из них получит эту ошибку. Приложение должно снова отправить обход на сервер.| 
| **429** | Запрос отрегулирован. Его следует повторить по истечении времени, указанного в заголовке **x-ms-retry-after-ms**.| 
| **500** | Сообщение об ошибке `"NotFoundException: Entity with the specified id does not exist in the system."` указывает, что база данных и (или) коллекция была повторно создана с тем же именем. Эта ошибка исчезнет в течение 5 минут по мере распространения изменений и сделает кэши в разных компонентах Cosmos DB недействительными. Чтобы избежать этой проблемы, каждый раз используйте уникальные имена базы данных и коллекции.| 
| **1000** | Этот код состояния возвращается, когда сервер успешно выполнил синтаксический анализ сообщения, но не смог выполнить его. Обычно это указывает на проблему с запросом.| 
| **1001** | Этот код возвращается, когда сервер завершает обходное выполнение, но не выполняет сериализацию ответа обратно клиенту. Эта ошибка может произойти, когда обход приводит к созданию сложного результата, который слишком велик или не соответствует спецификации протокола TinkerPop. Приложение должно упростить обход при возникновении этой ошибки. | 
| **1003** | `"Query exceeded memory limit. Bytes Consumed: XXX, Max: YYY"`возвращается, если обходной объем памяти превышает допустимый предел. Ограничение памяти составляет **2 ГБ** на обход.| 
| **1004** | Этот код состояния указывает на неверно сформированный запрос Graph. При сбое десериализации запрос может быть сформирован неправильно, тип, не являющийся типом значения, десериализуется как тип значения или запрошена неподдерживаемая операция Gremlin. Приложение не должно повторять запрос, так как оно не будет успешным. | 
| **1007** | Обычно этот код состояния возвращается с сообщением `"Could not process request. Underlying connection has been closed."`об ошибке. Такая ситуация может возникать, если драйвер клиента пытается использовать соединение, закрываемое сервером. Приложение должно повторить обход для другого соединения.
| **1008** | Cosmos DB Gremlin Server может прекратить подключение для перераспределения трафика в кластере. Клиентские драйверы должны справиться с этой ситуацией и использовать только активные подключения для отправки запросов на сервер. Иногда клиентские драйверы могут не обнаружить, что соединение было закрыто. Когда приложение обнаруживает ошибку, `"Connection is too busy. Please retry after sometime or open more connections."` оно должно повторить обход для другого соединения.

## <a name="samples"></a>Примеры

Пример клиентского приложения на основе Gremlin.Net, считывающего один атрибут Status:

```csharp
// Following example reads a status code and total request charge from server response attributes.
// Variable "server" is assumed to be assigned to an instance of a GremlinServer that is connected to Cosmos DB account.
using (GremlinClient client = new GremlinClient(server, new GraphSON2Reader(), new GraphSON2Writer(), GremlinClient.GraphSON2MimeType))
{
  ResultSet<dynamic> responseResultSet = await GremlinClientExtensions.SubmitAsync<dynamic>(client, requestScript: "g.V().count()");
  long statusCode = (long)responseResultSet.StatusAttributes["x-ms-status-code"];
  double totalRequestCharge = (double)responseResultSet.StatusAttributes["x-ms-total-request-charge"];

  // Status code and request charge are logged into application telemetry.
}
```

Пример, демонстрирующий чтение атрибута Status из клиента Gremlin Java:

```java
try {
  ResultSet resultSet = this.client.submit("g.addV().property('id', '13')");
  List<Result> results = resultSet.all().get();

  // Process and consume results

} catch (ResponseException re) {
  // Check for known errors that need to be retried or skipped
  if (re.getStatusAttributes().isPresent()) {
    Map<String, Object> attributes = re.getStatusAttributes().get();
    int statusCode = (int) attributes.getOrDefault("x-ms-status-code", -1);

    // Now we can check for specific conditions
    if (statusCode == 409) {
        // Handle conflicting writes
      }
    }

    // Check if we need to delay retry
    if (attributes.containsKey("x-ms-retry-after-ms")) {
      // Read the value of the attribute as is
      String retryAfterTimeSpan = (String) attributes.get("x-ms-retry-after-ms"));

      // Convert the value into actionable duration
            LocalTime locaTime = LocalTime.parse(retryAfterTimeSpan);
            Duration duration = Duration.between(LocalTime.MIN, locaTime);

      // Perform a retry after "duration" interval of time has elapsed
    }
  }
}

```

## <a name="next-steps"></a>Следующие шаги
* [Коды состояния HTTP для Azure Cosmos DB](https://docs.microsoft.com/rest/api/cosmos-db/http-status-codes-for-cosmosdb) 
* [Общие заголовки ответа для Azure Cosmos DB RESTFUL](https://docs.microsoft.com/rest/api/cosmos-db/common-cosmosdb-rest-response-headers)
* [Требования поставщика драйвера TinkerPop Graph]( http://tinkerpop.apache.org/docs/current/dev/provider/#_graph_driver_provider_requirements)
