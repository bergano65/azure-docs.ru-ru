---
title: Устранение неполадок при использовании триггера функций Azure для Cosmos DB
description: Распространенные проблемы, обходные пути и шаги диагностики при использовании триггера функций Azure для Cosmos DB
author: ealsur
ms.service: cosmos-db
ms.date: 03/13/2020
ms.author: maquaran
ms.topic: troubleshooting
ms.reviewer: sngun
ms.openlocfilehash: 7bf7d418e3f2680b32f61e42cffc76c921068508
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "79365514"
---
# <a name="diagnose-and-troubleshoot-issues-when-using-azure-functions-trigger-for-cosmos-db"></a>Диагностика и устранение неполадок при использовании триггера функций Azure для Cosmos DB

В этой статье рассматриваются распространенные проблемы, способы их устранения и диагностические действия при использовании [триггера функций Azure для Cosmos DB](change-feed-functions.md).

## <a name="dependencies"></a>Зависимости

Триггеры и привязки функций Azure для Cosmos DB зависят от пакетов расширений в базовой среде выполнения функций Azure. Всегда обновляйте эти пакеты, так как они могут включать исправления и новые функции, которые могут помочь в решении любых потенциальных проблем.

* Сведения о функциях Azure версии 2 см. в разделе [Microsoft. Azure. веб-jobs. Extensions. CosmosDB](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.CosmosDB).
* Сведения о функциях Azure v1 см. в разделе [Microsoft.Azure.WebJobs.Extensions.Docументдб](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.DocumentDB).

Эта статья всегда будет обращаться к функциям Azure версии 2 при каждом упоминании среды выполнения, если не указано явно.

## <a name="consume-the-azure-cosmos-db-sdk-independently"></a>Использование пакета SDK Azure Cosmos DB независимо

Ключевыми функциями пакета расширения являются предоставление поддержки триггера и привязок функций Azure для Cosmos DB. Он также включает [пакет SDK для .net Azure Cosmos DB](sql-api-sdk-dotnet-core.md), который полезен, если вы хотите взаимодействовать с Azure Cosmos DB программным способом без использования триггера и привязок.

Если вы хотите использовать пакет SDK для Azure Cosmos DB, убедитесь, что вы не добавили в проект ссылку на другой пакет NuGet. Вместо этого разрешите **ссылку на пакет SDK с помощью пакета расширения функций Azure**. Использование пакета SDK Azure Cosmos DB отдельно от триггера и привязок

Кроме того, если вы вручную создаете собственный экземпляр [клиента Azure Cosmos DB SDK](./sql-api-sdk-dotnet-core.md), следует следовать шаблону, который использует только один экземпляр клиента, [используя подход одноэлементного шаблона](../azure-functions/manage-connections.md#documentclient-code-example-c). Этот процесс позволит избежать потенциальных проблем с сокетами в операциях.

## <a name="common-scenarios-and-workarounds"></a>Распространенные сценарии и решения

### <a name="azure-function-fails-with-error-message-collection-doesnt-exist"></a>Функция Azure завершается с ошибкой, коллекция сообщений об ошибках не существует

Функция Azure завершается сбоем с сообщением об ошибке "либо исходная коллекция" Collection-Name "(в базе данных" Database-Name "), либо коллекция аренды" collection2-Name "(в базе данных" Database2-Name ") не существует. Перед запуском прослушивателя должны существовать обе коллекции. Чтобы автоматически создать коллекцию аренд, установите для "Креателеасеколлектионифнотексистс" значение "true".

Это означает, что один или оба контейнера Azure Cosmos, необходимые для работы триггера, не существуют или недоступны для функции Azure. **Сама ошибка сообщит, какая база данных и контейнер Azure Cosmos является триггером, который ищется** в зависимости от конфигурации.

1. Проверьте `ConnectionStringSetting` атрибут и то, что он **ссылается на параметр, существующий в приложение-функция Azure**. Значение этого атрибута не должно быть самой строкой подключения, а именем параметра конфигурации.
2. Убедитесь, что `databaseName` и `collectionName` существует в вашей учетной записи Azure Cosmos. Если вы используете автоматическую замену значений (с помощью `%settingName%` шаблонов), убедитесь, что имя параметра существует в приложение-функцияе Azure.
3. Если не указать `LeaseCollectionName/leaseCollectionName` , по умолчанию используется значение "Аренда". Убедитесь, что такой контейнер существует. При необходимости можно задать `CreateLeaseCollectionIfNotExists` атрибуту триггера значение `true` для автоматического создания.
4. Проверьте [конфигурацию брандмауэра учетной записи Azure Cosmos](how-to-configure-firewall.md) , чтобы увидеть, что она не блокирует функцию Azure.

### <a name="azure-function-fails-to-start-with-shared-throughput-collection-should-have-a-partition-key"></a>Не удается запустить функцию Azure, так как "Общая пропускная способность должна иметь ключ секции"

Предыдущие версии расширения Azure Cosmos DB не поддерживали использование контейнера аренды, созданного в [базе данных с общей пропускной способностью](./set-throughput.md#set-throughput-on-a-database). Чтобы устранить эту проблему, обновите расширение [Microsoft. Azure. веб-задания. Extensions. CosmosDB](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.CosmosDB) , чтобы получить последнюю версию.

### <a name="azure-function-fails-to-start-with-partitionkey-must-be-supplied-for-this-operation"></a>Не удается запустить функцию Azure, так как для этой операции необходимо указать PartitionKey.

Эта ошибка означает, что в настоящее время используется секционированная коллекция аренды с устаревшей [зависимостью расширения](#dependencies). Обновите до последней доступной версии. Если вы работаете в службе "функции Azure" версии 1, вам потребуется выполнить обновление до функций Azure v2.

### <a name="azure-function-fails-to-start-with-the-lease-collection-if-partitioned-must-have-partition-key-equal-to-id"></a>Функция Azure не запускается с параметром "сбор аренд, если он секционирован, должен иметь ключ секции, равный идентификатору".

Эта ошибка означает, что текущий контейнер аренды секционирован, а путь ключа раздела — нет `/id` . Чтобы устранить эту проблему, необходимо повторно создать контейнер аренды с помощью `/id` ключа секции.

### <a name="you-see-a-value-cannot-be-null-parameter-name-o-in-your-azure-functions-logs-when-you-try-to-run-the-trigger"></a>Вы видите "значение не может быть null. Имя параметра: o "в журналах функций Azure при попытке запустить триггер

Эта проблема возникает, если вы используете портал Azure и пытаетесь нажать кнопку **выполнить** на экране при проверке функции Azure, которая использует триггер. Триггер не требует выбора запуска для запуска. он будет автоматически запускаться при развертывании функции Azure. Если вы хотите проверить поток журнала функции Azure на портал Azure, просто перейдите к отслеживаемому контейнеру и вставьте новые элементы, и вы автоматически увидите триггер, выполняемый.

### <a name="my-changes-take-too-long-to-be-received"></a>Мои изменения занимают слишком много времени для получения

Этот сценарий может иметь несколько причин, и все они должны быть проверены:

1. Развернута ли ваша Функция Azure в том же регионе, что и ваша учетная запись Azure Cosmos? Для оптимальной задержки в сети Функция Azure и ваша учетная запись Azure Cosmos должны располагаться в одном регионе Azure.
2. Изменения происходят в вашем контейнере Azure Cosmos непрерывно или случайно?
Если случайно, может наблюдаться задержка между сохраняемыми изменениями и их получением Функцией Azure. Это связано с тем, что когда триггер проверяет изменения в контейнере Azure Cosmos и не находит ожидающих запросов на чтение, он будет пребывать в режиме ожидания в течение настраиваемого промежутка времени (5 секунд по умолчанию), прежде чем проверить наличие новых изменений (чтобы избежать высокого уровня потребления ЕЗ). Это время ожидания можно настроить с помощью параметра `FeedPollDelay/feedPollDelay` в [конфигурации](../azure-functions/functions-bindings-cosmosdb-v2-trigger.md#configuration) триггера (значение следует указать в миллисекундах).
3. В контейнере Azure Cosmos может быть [ограничена скорость](./request-units.md).
4. Вы можете использовать `PreferredLocations` атрибут в триггере, чтобы указать список регионов Azure с разделителями-запятыми для определения предпочтительного порядка подключения.

### <a name="some-changes-are-repeated-in-my-trigger"></a>Некоторые изменения повторяются в триггере

Понятие "изменение" — это операция над документом. Ниже перечислены наиболее распространенные сценарии, в которых получаются события для одного и того же документа.
* В учетной записи используется окончательная согласованность. При использовании канала изменений на уровне итоговой согласованности могут возникать повторяющиеся события между последовательными операциями чтения канала изменений (последнее событие одной операции чтения отображается как первое событие следующей операции).
* Выполняется обновление документа. Веб-канал изменений может содержать несколько операций для одних и тех же документов, если документ получает обновления, он может выбрать несколько событий (по одному для каждого обновления). Одним из простых способов различения различных операций для одного документа является отслеживание `_lsn` [свойства для каждого изменения](change-feed.md#change-feed-and-_etag-_lsn-or-_ts). Если они не совпадают, изменения в одном документе различны.
* Если вы определяете документы с помощью `id` , помните, что уникальный идентификатор для документа — `id` и его ключ раздела (могут существовать два документа с одним и тем же, `id` но разными ключами секции).

### <a name="some-changes-are-missing-in-my-trigger"></a>Некоторые изменения отсутствуют в триггере

Если вы обнаружите, что некоторые изменения, произошедшие в контейнере Azure Cosmos, не выбираются функцией Azure, необходимо выполнить начальный этап исследования.

Когда функция Azure получает изменения, она часто обрабатывает их и при необходимости отправляет результат в другое место назначения. При изучении недостающих изменений необходимо определить, **какие изменения принимаются в точке приема** (при запуске функции Azure), а не в месте назначения.

Если в назначении отсутствуют некоторые изменения, это может означать, что во время выполнения функции Azure после получения изменений происходит ошибка.

В этом сценарии лучшим способом является добавление `try/catch` блоков в код и внутри циклов, которые могут обрабатывать изменения, для обнаружения ошибок определенного подмножества элементов и их обработки соответствующим образом (отправка их в другое хранилище для дальнейшего анализа или повторных попыток). 

> [!NOTE]
> По умолчанию триггер Функций Azure для Cosmos DB не будет повторно запускать пакет изменений, если во время выполнения кода возникнет необработанное исключение. Это означает, что изменения не поступали в место назначения, так как не удается обработать их.

Если вы обнаружите, что некоторые изменения не были получены вашим триггером, наиболее распространенным сценарием является **выполнение другой функции Azure**. Это может быть другая функция Azure, развернутая в Azure, или функция Azure, которая выполняется локально на компьютере разработчика, который имеет такую **же конфигурацию (в** том же отслеживаемом и контейнере аренды), и эта функция Azure кража подмножества изменений, которые вы хотели бы обработать с помощью функции Azure.

Кроме того, сценарий можно проверить, если известно, сколько экземпляров Azure приложение-функция вы выполняли. Если вы просматриваете контейнер аренды и подсчитываете количество элементов аренды в, уникальные значения `Owner` свойства в них должны быть равны числу экземпляров приложение-функция. Если у вас больше владельцев, чем у известных экземпляров Azure приложение-функция, это означает, что эти дополнительные владельцы являются «кражой» изменений.

Одним из простых способов обойти эту ситуацию является применение `LeaseCollectionPrefix/leaseCollectionPrefix` к функции с новым или иным значением, а также тестирование с новым контейнером аренды.

### <a name="need-to-restart-and-reprocess-all-the-items-in-my-container-from-the-beginning"></a>Необходимо перезапустить и повторно обработать все элементы в контейнере с начала 
Повторная обработка всех элементов в контейнере с начала:
1. Останавливает функцию Azure, если она выполняется в данный момент. 
1. Удалите документы из коллекции аренд (или удалите и повторно создайте коллекцию аренды, чтобы она была пустой).
1. Присвойте атрибуту CosmosDBTrigger [стартфромбегиннинг](../azure-functions/functions-bindings-cosmosdb-v2-trigger.md#configuration) в функции значение true. 
1. Перезапустите функцию Azure. Теперь он будет считывать и обрабатывать все изменения с самого начала. 

Если задать для [стартфромбегиннинг](../azure-functions/functions-bindings-cosmosdb-v2-trigger.md#configuration) значение true, функция Azure начнет считывать изменения с начала истории коллекции, а не текущего времени. Работает только при отсутствии уже созданных аренд (т. е. документов в коллекции аренд). Присвоение этому свойству значения true, если уже созданные аренды не оказывают никакого влияния; в этом случае, когда функция остановлена и перезапущена, она начинает чтение с последней контрольной точки, как определено в коллекции аренд. Чтобы выполнить повторную обработку с начала, выполните описанные выше шаги 1-4.  

### <a name="binding-can-only-be-done-with-ireadonlylistdocument-or-jarray"></a>Привязку можно выполнять только с помощью Иреадонлилист \<Document> или жаррай

Эта ошибка возникает, если проект функций Azure (или любой проект, на который указывает ссылка) содержит ручную ссылку NuGet на Azure Cosmos DB SDK с версией, отличной от версии, предоставленной [Cosmos DB расширением функций Azure](./troubleshoot-changefeed-functions.md#dependencies).

Чтобы обойти эту ситуацию, удалите добавленную ссылку NuGet вручную и разрешите ссылку на Azure Cosmos DB SDK с помощью пакета расширения "функции Azure Cosmos DB".

### <a name="changing-azure-functions-polling-interval-for-the-detecting-changes"></a>Изменение интервала опроса функции Azure для обнаружения изменений

Как упоминалось ранее, для того [чтобы изменения вступили в силу слишком долго](./troubleshoot-changefeed-functions.md#my-changes-take-too-long-to-be-received), функция Azure будет в спящем режиме на настраиваемое время (по умолчанию 5 секунд), прежде чем проверять наличие новых изменений (чтобы избежать высокой степени потребления единиц запросов). Это время ожидания можно настроить с помощью параметра `FeedPollDelay/feedPollDelay` в [конфигурации](../azure-functions/functions-bindings-cosmosdb-v2-trigger.md#configuration) триггера (значение следует указать в миллисекундах).

## <a name="next-steps"></a>Дальнейшие действия

* [Включение мониторинга для функций Azure](../azure-functions/functions-monitoring.md)
* [Устранение неполадок пакета SDK для .NET Azure Cosmos DB](./troubleshoot-dot-net-sdk.md)
