---
title: Секционирование и горизонтальное масштабирование в Azure Cosmos DB
description: Сведения о секционировании, логических, физических секциях в Azure Cosmos DB, рекомендации по выбору ключа секции и управлении логическими секциями
author: deborahc
ms.author: dech
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 10/12/2020
ms.openlocfilehash: a70cfc7ab01dabd3d740d878acb453b4d1e76b5f
ms.sourcegitcommit: b85ce02785edc13d7fb8eba29ea8027e614c52a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "99507424"
---
# <a name="partitioning-and-horizontal-scaling-in-azure-cosmos-db"></a>Секционирование и горизонтальное масштабирование в Azure Cosmos DB
[!INCLUDE[appliesto-all-apis](includes/appliesto-all-apis.md)]

Azure Cosmos DB использует секционирование для масштабирования отдельных контейнеров в базе данных в соответствии с потребностями производительности приложения. При секционировании элементы в контейнере делятся на отдельные подмножества, называемые *логическими секциями*. Логические секции формируются на основе значения *ключа секции* , связанного с каждым элементом в контейнере. Все элементы в логической секции имеют одинаковое значение ключа секции.

Например, контейнер содержит элементы. Каждый элемент имеет уникальное значение для `UserID` Свойства. Если используется в `UserID` качестве ключа секции для элементов в контейнере и имеется 1 000 уникальных `UserID` значения, то для контейнера создаются 1 000 логических секции.

В дополнение к ключу секции, определяющему логическую секцию элемента, каждый элемент в контейнере имеет *идентификатор элемента* (уникальный в пределах логической секции). Сочетание ключа секции и *идентификатора элемента* создает *индекс* элемента, который однозначно определяет элемент. [Выбор ключа секции](#choose-partitionkey) — это важное решение, которое повлияет на производительность приложения.

В этой статье объясняется связь между логическими и физическими секциями. Здесь также обсуждаются рекомендации по секционированию и представлено подробное представление о том, как работает горизонтальное масштабирование в Azure Cosmos DB. Нет необходимости понимать эти внутренние сведения для выбора ключа секции, но мы посмотрели их так, чтобы вы могли понять, как работает Azure Cosmos DB.

## <a name="logical-partitions"></a>Логические секции

Логическая Секция состоит из набора элементов, имеющих один и тот же ключ секции. Например, в контейнере, содержащем данные о Food информации питании, все элементы содержат `foodGroup` свойство. В `foodGroup` качестве ключа секции для контейнера можно использовать. Группы элементов, имеющие определенные значения для `foodGroup` , такие как `Beef Products` , `Baked Products` и `Sausages and Luncheon Meats` , формируют логические секции для различных форм. При удалении базовых данных не нужно беспокоиться об удалении логической секции.

Логическая Секция также определяет область транзакций базы данных. Элементы в логической секции можно обновить с помощью [транзакции с изоляцией моментальных снимков](database-transactions-optimistic-concurrency.md). При добавлении новых элементов в контейнер новые логические секции прозрачно создаются системой.

Количество логических секций в контейнере не ограничено. Каждый логический раздел может хранить до 20 ГБ данных. Хороший выбор ключа секции имеет широкий диапазон возможных значений. Например, в контейнере, где все элементы содержат `foodGroup` свойство, данные в `Beef Products` логической секции могут увеличиваться до 20 ГБ. [Выбор ключа секции](#choose-partitionkey) с широким диапазоном возможных значений гарантирует возможность масштабирования контейнера.

## <a name="physical-partitions"></a>Физические секции

Контейнер масштабируется путем распределения данных и пропускной способности в физических секциях. На внутреннем уровне одна или несколько логических секций сопоставлены с одной физической секцией. Обычно в небольших контейнерах много логических секций, но для них требуется только одна физическая секция. В отличие от логических секций физические секции являются внутренней реализацией системы и полностью управляются с помощью Azure Cosmos DB.

Число физических секций в контейнере зависит от следующих факторов:

* Число подготовленных пропускной способности (каждая отдельная физическая секция может обеспечить пропускную способность до 10 000 единиц запросов в секунду).
* Общий объем хранилища данных (каждая отдельная физическая секция может хранить до 50 ГБ данных).

> [!NOTE]
> Физические секции являются внутренней реализацией системы и полностью управляются с помощью Azure Cosmos DB. При разработке решений не следует сосредоточиться на физических секциях, так как вы не можете управлять ими, а сосредоточиться на ключах секций. При выборе ключа секции, который равномерно распределяет потребление пропускной способности по логическим секциям, вы обеспечите балансировку потребления пропускной способности в физических секциях.

Общее число физических секций в контейнере не ограничено. По мере роста подготовленной пропускной способности или размера данных Azure Cosmos DB автоматически создаст новые физические секции, разделив существующие. Разбиение физического раздела не влияет на доступность вашего приложения. После разбиения физического раздела все данные в пределах одной логической секции будут по-прежнему храниться в одной и той же физической секции. Разбиение физического раздела просто создает новое сопоставление логических секций с физическими секциями.

Пропускная способность, подготовленная для контейнера, распределяется равномерно между физическими секциями. Структура ключа секции, которая равномерно распределяет запросы, может привести к созданию слишком большого количества запросов, направленных на небольшое подмножество секций, которые становятся «горячими». Критические секции приводят к неэффективному использованию подготовленной пропускной способности, что может привести к снижению скорости и увеличению затрат.

Физические разделы контейнера можно просмотреть в разделе **хранилище** в **колонке метрики** портал Azure:

:::image type="content" source="./media/partitioning-overview/view-partitions-zoomed-out.png" alt-text="Просмотр числа физических разделов" lightbox="./media/partitioning-overview/view-partitions-zoomed-in.png" ::: 

На приведенном выше снимке экрана контейнер имеет в `/foodGroup` качестве ключа секции. Каждая из трех линий в графе представляет физическую секцию. В образе **диапазон ключей раздела** совпадает с физическим разделом. Выбранная физическая секция содержит основные 3 наиболее значимых логических раздела размера: `Beef Products` , `Vegetable and Vegetable Products` и `Soups, Sauces, and Gravies` .

При подготовке пропускной способности 18 000 единиц запросов в секунду каждый из трех физических секций может использовать 1/3 из общей подготовленной пропускной способности. В пределах выбранной физической секции ключи логических секций, `Beef Products` `Vegetable and Vegetable Products` и, в `Soups, Sauces, and Gravies` совокупности, могут использовать подготовленные единицы запросов в 6 000 для физического раздела. Так как подготовленная пропускная способность равномерно распределяется по физическим секциям контейнера, важно выбрать ключ секции, который равномерно распределяет потребление пропускной способности, [выбрав правильный ключ логической секции](#choose-partitionkey). 

## <a name="managing-logical-partitions"></a>Управление логическими секциями

Azure Cosmos DB прозрачно и автоматически управляет размещением логических секций в физических секциях для эффективного удовлетворения требований к масштабируемости и производительности контейнера. По мере увеличения требований к пропускной способности и хранению приложения Azure Cosmos DB перемещает логические секции, чтобы автоматически распределять нагрузку между большим количеством физических секций. Вы можете узнать больше о [физических секциях](partitioning-overview.md#physical-partitions).

Azure Cosmos DB использует секционирование на основе хэша для распределения логических секций по физическим секциям. Azure Cosmos DB хэширует значение ключа секции элемента. Хэшированный результат определяет физическую секцию. Затем Azure Cosmos DB выделяет пространство ключей для хэшей ключей секций равномерно по физическим секциям.

Транзакции (в хранимых процедурах или триггерах) допускаются только для элементов в одном логическом разделе.

Дополнительные сведения о том, [как Azure Cosmos DB управляет секциями](partitioning-overview.md), см. здесь. (Нет необходимости понимать внутренние сведения для сборки или запуска приложений, но это можно добавить для читателя.)

## <a name="replica-sets"></a>Наборы реплик

Каждая физическая Секция состоит из набора реплик, которые также называют [*набором реплик*](global-dist-under-the-hood.md). На каждом наборе реплик размещается экземпляр ядра СУБД. Набор реплик делает данные, хранящиеся в физическом разделе, устойчивой, высокой доступностью и целостными. Каждая реплика, составляющая физическую секцию, наследует квоту хранилища секции. Все реплики физической секции совокупно поддерживают пропускную способность, выделенную для физической секции. Azure Cosmos DB автоматически управляет наборами реплик.

Как правило, для небольших контейнеров требуется только одна физическая секция, но они по-прежнему имеют по крайней мере 4 реплики.

На следующем рисунке показано, как логические секции сопоставляются с физическими, которые распределяются глобально:

:::image type="content" source="./media/partitioning-overview/logical-partitions.png" alt-text="Изображение, демонстрирующее Azure Cosmos DB секционирования" border="false":::

## <a name="choosing-a-partition-key"></a><a id="choose-partitionkey"></a>Выбор ключа секции

Ключ секции содержит два компонента: **путь к ключу раздела** и **значение ключа секции**. Например, рассмотрим элемент {"userId": "Эндрю", "Ворксфор": "Microsoft"} Если в качестве ключа раздела выбрано "userId", то ниже приведены два основных компонента раздела.

* Путь к ключу раздела (например, "/userId"). Путь к ключу секции принимает буквенно-цифровые и символы подчеркивания (_). Вложенные объекты также можно использовать с помощью стандартной нотации пути (/).

* Значение ключа секции (например, "Эндрю"). Значение ключа секции может быть строкой или числовым типом.

Дополнительные сведения об ограничениях пропускной способности, хранилища и длины ключа секции см. в статье [Azure Cosmos DB квоты службы](concepts-limits.md) .

Выбор ключа секции — это простой, но важный вариант проектирования в Azure Cosmos DB. После выбора ключа секции его нельзя изменить на месте. Если необходимо изменить ключ секции, необходимо переместить данные в новый контейнер с новым нужным ключом секции.

Для **всех** контейнеров ключ секции должен:

* Быть свойством со значением, которое не изменяется. Если свойство является ключом секции, обновление значения этого свойства невозможно.

* Высокая кратность. Иными словами, свойство должно иметь широкий диапазон возможных значений.

* Распределенное распределение единиц запросов (RU) и хранение данных равномерно по всем логическим секциям. Это обеспечивает даже потребление единиц запросов и распределение хранилища по физическим секциям.

Если в Azure Cosmos DB требуются [транзакции ACID с несколькими элементами](database-transactions-optimistic-concurrency.md#multi-item-transactions) , необходимо использовать [хранимые процедуры или триггеры](how-to-write-stored-procedures-triggers-udfs.md#stored-procedures). Все хранимые процедуры и триггеры на основе JavaScript ограничены одной логической секцией.

## <a name="partition-keys-for-read-heavy-containers"></a>Ключи разделов для контейнеров с высокой интенсивностью чтения

Для большинства контейнеров необходимо учитывать указанные выше критерии при выборе ключа секции. Однако для больших контейнеров с большим объемом чтения может потребоваться выбрать ключ секции, который часто встречается как фильтр в запросах. Запросы можно [эффективно маршрутизировать только к соответствующим физическим секциям](how-to-query-container.md#in-partition-query) , включая ключ секции в предикате фильтра.

Если большинство запросов рабочей нагрузки являются запросами, а большинство запросов имеют фильтр равенства для одного и того же свойства, это свойство может быть хорошим выбором ключа секции. Например, если часто выполняется запрос, который фильтруется по `UserID` , то при выборе в `UserID` качестве ключа секции будет уменьшено количество [запросов между секциями](how-to-query-container.md#avoiding-cross-partition-queries).

Тем не менее, если ваш контейнер невелик, возможно, у вас недостаточно физических секций, чтобы не беспокоиться о влиянии на производительность запросов между секциями. Большинству малых контейнеров в Azure Cosmos DB требуется только одна или две физические секции.

Если контейнер может увеличиваться до нескольких физических секций, следует убедиться, что выбран ключ секции, который уменьшает количество запросов между секциями. В вашем контейнере потребуется больше, чем несколько физических секций, если выполняется одно из следующих условий.

* В вашем контейнере будет выинициализировано более 30 000 единиц запросов.

* В вашем контейнере будет храниться свыше 100 ГБ данных.

## <a name="using-item-id-as-the-partition-key"></a>Использование идентификатора элемента в качестве ключа секции

Если у контейнера есть свойство, имеющее широкий диапазон возможных значений, скорее всего, это будет отличный вариант ключа секции. Одним из возможных примеров такого свойства является *идентификатор элемента*. Для небольших контейнеров с большой интенсивностью чтения или контейнеров с большой интенсивностью записи любого размера *идентификатор элемента* естественным образом подходит для ключа секции.

*Идентификатор элемента* системного свойства существует в каждом элементе в контейнере. У вас могут быть другие свойства, представляющие логический идентификатор элемента. Во многих случаях они также являются отличным выбором ключа секции по тем же причинам, что и *идентификатор элемента*.

*Идентификатор элемента* является отличным выбором ключа секции по следующим причинам:

* Существует широкий диапазон возможных значений (один уникальный *идентификатор элемента* для каждого элемента).
* Так как для каждого элемента существует уникальный *идентификатор* , *идентификатор элемента* выполняет отличное задание с равномерной балансировкой потребления единиц запросов и хранилища данных.
* Вы можете легко выполнять эффективные операции чтения точек, так как вы всегда узнаете ключ секции элемента, если известно его *идентификатор*.

При выборе *идентификатора элемента* в качестве ключа секции следует учитывать следующие моменты:

* Если *идентификатор элемента* является ключом секции, он станет уникальным идентификатором во всем контейнере. Вы не сможете иметь элементы с повторяющимися *идентификаторами элементов*.
* При наличии контейнера, интенсивно считывающего большое количество [физических секций](partitioning-overview.md#physical-partitions), запросы будут более эффективны, если у них есть фильтр проверки на равенство с *идентификатором элемента*.
* Нельзя запускать хранимые процедуры или триггеры по нескольким логическим секциям.

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о [подготовленной пропускной способности в Azure Cosmos DB](request-units.md).
* Сведения о [глобальном распределении в Azure Cosmos DB](distribute-data-globally.md).
* Подробнее о [подготовке пропускной способности для контейнера Azure Cosmos](how-to-provision-container-throughput.md).
* Подробнее о [подготовке пропускной способности для базы данных Azure Cosmos](how-to-provision-database-throughput.md).
