---
title: Подготовка пропускной способности в контейнерах и базах данных Azure Cosmos
description: Сведения о настройке подготовленной пропускной способности для контейнеров и баз данных Azure Cosmos.
author: markjbrown
ms.author: mjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 05/19/2020
ms.openlocfilehash: 050da712df6dad872fc03bd6ca79bbdf2a3e1753
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85563194"
---
# <a name="introduction-to-provisioned-throughput-in-azure-cosmos-db"></a>Общие сведения о подготовленной пропускной способности в Azure Cosmos DB

Azure Cosmos DB дает возможность настроить подготовленную пропускную способность для баз данных и контейнеров. Существуют два типа подготовленной пропускной способности: стандартная (настроенная вручную) и автомасштабируемая. В этой статье приводятся общие сведения о том, как работает подготовленная пропускная способность. 

База данных Azure Cosmos представляет собой единицу управления для набора контейнеров. База данных состоит из набора схемонезависимых контейнеров. Контейнер Azure Cosmos — это единица масштабируемости как для пропускной способности, так и для хранения. Контейнер горизонтально разделяется между набором компьютеров в регионе Azure и распределяется по всем регионам Azure, связанным с учетной записью Azure Cosmos.

В Azure Cosmos DB можно подготовить пропускную способность на уровне двух компонентов:
 
- контейнеры Azure Cosmos;
- базы данных Azure Cosmos.

## <a name="set-throughput-on-a-container"></a>Настройка пропускной способности в контейнере  

Пропускная способность, подготавливаемая для контейнера Azure Cosmos, резервируется исключительно для этого контейнера. Контейнер получает подготовленную пропускную способность постоянно. Финансовой гарантией подготовленной пропускной способности в контейнере являются соглашения об уровне обслуживания. Чтобы узнать, как настроить стандартную пропускную способность (вручную) для контейнера, ознакомьтесь со статьей [Подготовка пропускной способности в контейнере Azure Cosmos](how-to-provision-container-throughput.md). Чтобы узнать, как настроить автомасштабируемую пропускную способность для контейнера, ознакомьтесь с разделом [Подготовка автомасштабируемой пропускной способности](how-to-provision-autoscale-throughput.md).

Настройка подготовленной пропускной способности для контейнера — широко применяемый подход. Вы можете гибко масштабировать пропускную способность для контейнера, подготавливая любой объем пропускной способности с помощью [единиц запроса (ЕЗ)](request-units.md). 

Пропускная способность, подготовленная для контейнера, равномерно распределяется между физическими секциями. Это подразумевает, что применяется эффективный ключ секции, который позволяет равномерно распределить логические секции между физическими секциями. Пропускная способность также равномерно распределяется между всеми логическими секциями контейнера. Невозможно выборочно указать пропускную способность для логических разделов. Так как один логический раздел контейнера или несколько размещаются в физическом разделе, физические разделы относятся исключительно к данному контейнеру и поддерживают пропускную способность, подготовленную для контейнера. 

Если Рабочая нагрузка, запущенная в логической секции, использует больше пропускной способности, выделенной для физической секции, возможно, ваши операции будут ограничены с учетом частоты. Что называется _горячей секцией_ , происходит, когда одна логическая секция имеет непропорциональное количество запросов, чем другие значения ключа секции.

При ограничении скорости можно либо увеличить подготовленную пропускную способность для всего контейнера, либо повторить операцию. Также следует убедиться, что выбран ключ раздела, который равномерно распределяет объем хранилища и запросов. Дополнительные сведения о секционировании см. [в разделе секционирование и горизонтальное масштабирование в Azure Cosmos DB](partition-data.md).

Если нужно получить гарантированную производительность для определенного контейнера, мы рекомендуем настроить пропускную способность на уровне контейнера.

На следующем рисунке показано, как в физическом разделе размещаются один или несколько логических разделов контейнера.

:::image type="content" source="./media/set-throughput/resource-partition.png" alt-text="Физическая секция" border="false":::

## <a name="set-throughput-on-a-database"></a>Настройка пропускной способности в базе данных

> [!NOTE]
> Сейчас невозможно подготовить пропускную способность для базы данных Azure Cosmos в учетных записях, где включены [ключи, управляемые клиентом](how-to-setup-cmk.md) .

При подготовке пропускной способности для базы данных Azure Cosmos пропускная способность распределяется между всеми контейнерами (называемыми общими контейнерами базы данных) в этой базе данных. Исключением является случай, если вы указали подготовленную пропускную способность для определенных контейнеров в базе данных. Совместное использование пропускной способности, подготовленной на уровне базы данных, ее контейнерами аналогично размещению базы данных в кластере виртуальных машин. Так как все контейнеры в базе данных совместно используют ресурсы, доступные на компьютере, естественно, что для любого конкретного контейнера невозможно обеспечить прогнозируемую производительность. Чтобы узнать, как настроить подготовленную пропускную способность для базы данных, ознакомьтесь со статьей [Подготовка пропускной способности для базы данных в Azure Cosmos DB](how-to-provision-database-throughput.md). Чтобы узнать, как настроить автомасштабируемую пропускную способность для базы данных, ознакомьтесь с разделом [Подготовка автомасштабируемой пропускной способности](how-to-provision-autoscale-throughput.md).

Настройка пропускной способности для базы данных Azure Cosmos гарантирует, что ей всегда будет доступна подготовленная пропускная способность. Так как все контейнеры в базе данных совместно используют подготовленную пропускную способность, Azure Cosmos DB не предоставляет никаких гарантий относительно прогнозируемой пропускной способности для определенного контейнера в этой базе данных. Часть пропускной способности, которую может получить определенный контейнер, зависит от:

* числа контейнеров;
* выбора ключей разделов для различных контейнеров;
* распределения рабочей нагрузки между различными логическими разделами контейнеров. 

Мы рекомендуем настроить пропускную способность на уровне базы данных, когда требуется совместно использовать пропускную способность в нескольких контейнерах, но нежелательно выделять ее какому-либо определенному контейнеру. 

В следующих примерах показано, когда предпочтительнее подготовить пропускную способность на уровне базы данных:

* Совместное использование пропускной способности базы данных набором контейнеров удобно для мультитенантного приложения. Каждый пользователь может быть представлен отдельным контейнером Azure Cosmos.

* Совместное использование подготовленной пропускной способности базы данных набором контейнеров удобно, если выполняется перенос базы данных NoSQL, например MongoDB или Cassandra, размещенной в кластере виртуальных машин или на локальных физических серверах, в Azure Cosmos DB. Подготовленную пропускную способность, настроенную в базе данных Azure Cosmos, можно представить как логический эквивалент (но более экономичный и эластичный) вычислительной мощности кластера MongoDB или Cassandra.  

Все контейнеры, создаваемые внутри базы данных с подготовленной пропускной способностью, должны создаваться с помощью [ключа секции](partition-data.md). В любой момент времени пропускная способность, выделенная контейнеру в базе данных, распределяется по всем логическим секциям этого контейнера. При наличии контейнеров с общей подготовленной пропускной способностью, настроенной на уровне базы данных, невозможно выборочно применить пропускную способность к конкретному контейнеру или логической секции. 

Если рабочая нагрузка, выполняемая в логическом разделе, потребляет больше пропускной способности, чем выделено определенному логическому разделу, скорость выполнения операций будет ограничена. При ограничении скорости можно либо увеличить пропускную способность для всей базы данных, либо повторить операцию. Дополнительные сведения о секционировании см. в статье о [логических разделах](partition-data.md).

Контейнеры в базе данных с общей пропускной способностью совместно используют пропускную способность (ЕЗ/с), выделенную этой базе данных. В базе данных можно использовать до четырех контейнеров с минимальной пропускной способностью в 400 ЕЗ/с. Если подготовлена стандартная пропускная способность (вручную), то для каждого нового контейнера после первых четырех дополнительно потребуется не менее 100 ЕЗ/с. Например, при использовании общей пропускной способности базы данных с восемью контейнерами минимальное значение для базы данных составит 800 ЕЗ/с. При подготовленной пропускной способности автомасштабирования можно использовать до 25 контейнеров в базе данных с автомасштабированием max 4000 единиц запросов в секунду (масштабирование между 400-4000 единиц запросов в секунду).

> [!NOTE]
> В феврале 2020 года мы представили изменение, которое позволяет использовать общую пропускную способность не более чем для 25 контейнеров, что обеспечивает более эффективное совместное использование пропускной способности между контейнерами. После первых 25 контейнеров в базу данных можно добавить дополнительные контейнеры, только если для них [подготовлена выделенная пропускная способность](#set-throughput-on-a-database-and-a-container), которая отделена от общей пропускной способности базы данных.<br>
Если учетная запись Azure Cosmos DB уже содержит базу данных с общей пропускной способностью, используемой более чем 25 контейнерами, то эта учетная запись и все остальные учетные записи в той же подписке Azure будут исключены из этого изменения. Если у вас есть отзывы или вопросы, обратитесь в [службу поддержки продуктов](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade). 

Если ваши рабочие нагрузки предполагают удаление и повторное создание всех коллекций в базе данных, рекомендуется удалять пустую базу данных и создавать новую базу данных перед созданием коллекции. На следующем рисунке показано, как в физическом разделе можно разместить один логический раздел или несколько, которые относятся к разным контейнерам в базе данных.

:::image type="content" source="./media/set-throughput/resource-partition2.png" alt-text="Физическая секция" border="false":::

## <a name="set-throughput-on-a-database-and-a-container"></a>Настройка пропускной способности для базы данных и контейнера

Вы можете объединить эти две модели. Допускается подготовка пропускной способности для базы данных и для контейнера. В следующем примере показано, как подготовить стандартную пропускную способность (вручную) для базы данных Azure Cosmos и контейнера.

* Вы можете создать базу данных Azure Cosmos с именем *Z* со стандартной подготовленной пропускной способностью, составляющей *K* единиц запроса. 
* Затем создайте в этой базе данных пять контейнеров с именами *A*, *B*, *C*, *D* и *E*. При создании контейнера B обязательно включите параметр **Provision dedicated throughput for this container** (Подготовить выделенную пропускную способность для этого контейнера) и явно настройте для него *P* единиц запроса. Обратите внимание на то, что общую и выделенную пропускную способность можно настроить только при создании базы данных и контейнера. 

   :::image type="content" source="./media/set-throughput/coll-level-throughput.png" alt-text="Настройка пропускной способности на уровне контейнера":::

* Пропускная способность в *K* единиц запроса совместно используется в четырех контейнерах: *A*, *C*, *D* и *E*. Точный объем пропускной способности, доступной для *A*, *C*, *D* и *E*, меняется. Не существует Соглашений об уровне обслуживания для пропускной способности каждого отдельного контейнера.
* Контейнер *B* гарантированно будет получать пропускную способность в *P* единиц запроса. Он поддерживается Соглашением об уровне обслуживания.

> [!NOTE]
> Контейнер с подготовленной пропускной способностью невозможно преобразовать в общий контейнер базы данных. И наоборот, невозможно преобразовать общий контейнер базы данных, чтобы он использовал выделенную пропускную способность.

## <a name="update-throughput-on-a-database-or-a-container"></a>Изменение пропускной способности для базы данных и контейнера

После создания контейнера или базы данных Azure Cosmos можно изменить настроенную подготовленную пропускную способность. Максимальная подготовленная пропускная способность, которую можно настроить для базы данных или контейнера, не ограничивается. 

Чтобы оценить [минимальную подготовленную пропускную способность](concepts-limits.md#storage-and-throughput) базы данных или контейнера, найдите максимум:

* 400 ЕЗ/с 
* Текущий объем хранилища в ГБ * 10 единиц запросов в секунду
* Максимальное значение единиц запросов в секунду, подготовленное для базы данных или контейнера/100
* Число контейнеров * 100 единиц запросов в секунду (только для базы данных общей пропускной способности)

Фактический минимальный номер единицы запросов в секунду может различаться в зависимости от конфигурации учетной записи. [Azure Monitor метрики](monitor-cosmos-db.md#view-operation-level-metrics-for-azure-cosmos-db) можно использовать для просмотра журнала подготовленной пропускной способности (единиц запросов в секунду) и хранилища в ресурсе.

Вы можете программно получить минимальную пропускную способность контейнера или базы данных с помощью пакетов SDK или просмотреть это значение на портале Azure. При использовании пакета SDK для .NET масштабировать значение подготовленной пропускной способности можно с помощью метода [DocumentClient.ReplaceOfferAsync](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.documentclient.replaceofferasync?view=azure-dotnet). При использовании пакета SDK для Java масштабировать значение подготовленной пропускной способности можно с помощью метода [RequestOptions.setOfferThroughput](sql-api-java-sdk-samples.md). 

При использовании пакета SDK для .NET получить значение минимальной пропускной способности контейнера или базы данных можно с помощью метода [DocumentClient.ReadOfferAsync](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.documentclient.readofferasync?view=azure-dotnet). 

Вы можете в любое время масштабировать подготовленную пропускную способность контейнера или базы данных. Выполнение операции масштабирования для увеличения пропускной способности может занять больше времени, так как системным задачам потребуется подготовить необходимые ресурсы. Состояние операции масштабирования можно проверить на портале Azure или программно с помощью пакетов SDK. При использовании пакета SDK для .NET получить состояние операции масштабирования можно с помощью метода `DocumentClient.ReadOfferAsync`.

## <a name="comparison-of-models"></a>Сравнение моделей
В этой таблице показано сравнение стандартной (настроенной вручную) пропускной способности для базы данных и контейнера. 

|**Параметр**  |**Стандартная (настроенная вручную) пропускная способность для базы данных**  |**Стандартная (настроенная вручную) пропускная способность для контейнера**|**Автомасштабируемая пропускная способность для базы данных** | **Автомасштабируемая пропускная способность для контейнера**|
|---------|---------|---------|---------|---------|
|Точка входа (минимальное число ЕЗ/с) |400 ЕЗ/с (после первых четырех контейнеров для каждого дополнительного контейнера требуется не менее 100 ЕЗ/с).</li> |400| Автомасштабирование от 400 до 4000 ЕЗ/с. Допускается до 25 контейнеров без минимального числа ЕЗ/с на контейнер.</li> | Автомасштабирование от 400 до 4000 ЕЗ/с.|
|Минимальное число ЕЗ/с на контейнер|100|400|--|Автомасштабирование от 400 до 4000 ЕЗ/с.|
|Максимум ЕЗ|Без ограничений, для базы данных.|Без ограничений, для контейнера.|Без ограничений, для базы данных.|Без ограничений, для контейнера.
|ЕЗ, назначенные или доступные для определенного контейнера|Нет гарантий. ЕЗ, назначенные для заданного контейнера зависят от свойств. Свойствами могут быть выбор ключей разделов контейнеров, совместно использующих пропускную способность, распределение рабочей нагрузки и число контейнеров. |Все ЕЗ, настроенные для контейнера, резервируются исключительно для него.|Нет гарантий. ЕЗ, назначенные для заданного контейнера зависят от свойств. Свойствами могут быть выбор ключей разделов контейнеров, совместно использующих пропускную способность, распределение рабочей нагрузки и число контейнеров. |Все ЕЗ, настроенные для контейнера, резервируются исключительно для него.|
|Максимальный размер хранилища для контейнера|Без ограничений.|Без ограничений|Без ограничений|Без ограничений|
|Максимальная пропускная способность на логический раздел контейнера|10 000 ЕЗ/с|10 000 ЕЗ/с|10 000 ЕЗ/с|10 000 ЕЗ/с|
|Максимальная пропускная способность (данные + индекс) на логический раздел контейнера|20 ГБ|20 ГБ|20 ГБ|20 ГБ|

## <a name="next-steps"></a>Дальнейшие действия

* Подробнее о [логических секциях](partition-data.md).
* Узнайте, как [подготовить стандартную (настраиваемую вручную) пропускную способность для контейнера Azure Cosmos](how-to-provision-container-throughput.md).
* Узнайте, как [подготовить стандартную (настраиваемую вручную) пропускную способность базы данных Azure Cosmos](how-to-provision-database-throughput.md).
* Узнайте, как [подготовить автомасштабируемую пропускную способность для базы данных или контейнера Azure Cosmos](how-to-provision-autoscale-throughput.md).
