---
title: Глобальное распределение Azure Cosmos DB (взгляд изнутри)
description: Эта статья содержит технические сведения, относящиеся к глобальному распределению Azure Cosmos DB
services: cosmos-db
author: dharmas-cosmos
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 10/10/2018
ms.author: dharmas
ms.reviewer: sngun
ms.openlocfilehash: 5db43c6488a4592eb46d9a0fe9a044dde36fc494
ms.sourcegitcommit: c61c98a7a79d7bb9d301c654d0f01ac6f9bb9ce5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/27/2018
ms.locfileid: "52423353"
---
# <a name="azure-cosmos-db-global-distribution---under-the-hood"></a>Глобальное распределение Azure Cosmos DB (взгляд изнутри)

Azure Cosmos DB является базовой службой Azure, поэтому она развернута во всех регионах Azure по всему миру, включая общедоступные, национальные облака, облака Министерства обороны (DOD) и государственных организаций. В центре обработки данных мы развертываем службу Azure Cosmos DB и управляем ей на больших метках машин, каждая из которых имеет выделенное локальное хранилище. В центре обработки данных Azure Cosmos DB развертывается во многих кластерах, каждый из которых потенциально запускает несколько поколений оборудования. Машины в кластере обычно распределяются по 10–20 доменам сбоя. На следующем рисунке показана топология системы к использованию глобального распределения Cosmos DB.

![Топология системы](./media/global-dist-under-the-hood/distributed-system-topology.png)

**Глобальное распределение в Azure Cosmos DB находится "под ключом".** В любое время несколькими щелчками или программным способом с помощью одного вызова API клиент может добавлять или удалять географические регионы, связанные с базой данных Cosmos. База данных Cosmos, в свою очередь, состоит из набора контейнеров Cosmos. В Cosmos DB контейнеры служат в качестве логических единиц распределения и масштабируемости. Коллекции, таблицы и диаграммы, которые вы создаете, являются (изнутри) просто контейнерами Cosmos. Контейнеры полностью независимы от схем и предоставляют область для запроса. Данные в контейнере Cosmos автоматически индексируются после приема. Автоматическое индексирование позволяет пользователям запрашивать данные без схемы или трудностей управления индексами, особенно в глобально распределенной инфраструктуре.  

- В приведенном регионе данные в контейнере распределяются с помощью ключа секции, который вы предоставляете и с помощью которого прозрачно управляете базовыми секциями ресурсов (локальное распределение).  

- Каждая секция ресурсов также реплицируется по географическим регионам (глобальное распределение). 

Когда приложение, использующее Cosmos DB, гибко масштабирует пропускную способность (или потребляет больше памяти) в контейнере Cosmos, Cosmos DB прозрачно обрабатывает операции управления секциями (разделение, клонирование, удаление) по всем регионам. Независимо от масштабирования, распределения или ошибок, Cosmos DB предоставляет один образ системы данных в контейнерах, которые распределены по всему миру в любом количестве регионов.  

Как показано на следующем рисунке, данные в контейнере распределяются по двум направлениям.  

![Физические секции](./media/global-dist-under-the-hood/distribution-of-resource-partitions.png)

Физическая секция выполняется группой реплик, которую называют набором реплик. Каждая машина содержит сотни реплик, соответствующих различным физическим секциям в рамках фиксированного набора процессов, как показано на предыдущем рисунке. Реплики, соответствующие физическим секциям, динамически размещаются и распределяют нагрузки между машинами в кластере и центрах обработки данных в пределах региона.  

Реплика однозначно принадлежит клиенту Azure Cosmos DB. Каждая реплика содержит экземпляр [ядра СУБД](https://www.vldb.org/pvldb/vol8/p1668-shukla.pdf) Cosmos DB, который управляет ресурсами, а также соответствующими индексами. Ядро СУБД Cosmos DB работает на базе системы типов последовательности записей атомов (ARS). Ядро не зависит от концепции схемы и размывает границы между значениями структуры и экземпляров записей. База данных Cosmos DB обеспечивает полную независимость от схемы, автоматически индексируя все при приеме эффективным образом, что позволяет пользователям запрашивать свои глобально распределенные данные без необходимости управлять схемой или индексом.

Ядро СУБД Cosmos DB состоит из компонентов, включая реализацию нескольких координационных примитивов, языковых сред выполнения, обработчика запросов и подсистем хранения и индексирования, ответственных за хранение транзакций и индексацию данных соответственно. Чтобы обеспечить устойчивость и высокую доступность, ядро СУБД сохраняет свои данные и индексы на дисках SSD и реплицирует их среди экземпляров ядра СУБД в наборах реплик соответственно. Большие клиенты соответствуют более высокой шкале пропускной способности и хранения и имеют либо большие реплики, либо большее количество реплик, или и то и другое. Каждый компонент системы полностью асинхронен — ни один поток никогда не блокирует другой, и каждый поток работает кратковременно без каких-либо ненужных переключателей потоков. Ограничение скорости и обратной реакции передаются по всему стеку из контроля допуском на все каналы ввода-вывода. Наше ядро СУБД предназначено для использования точного параллелизма и обеспечения высокой пропускной способности при работе в экономных объемах системных ресурсов.

Глобальное распределение Cosmos DB использует две ключевые абстракции — наборы реплик и наборы секций. Набор реплик представляет собой модульный блок "Лего" для координации, а набор секций — это динамическое наложение одного или нескольких географически распределенных физических секций. Чтобы понять, как работает глобальное распределение, необходимо понимать эти две ключевые абстракции. 

## <a name="replica-sets"></a>Наборы реплик

Секция ресурсов, которая материализуется как самоуправляемая и динамически сбалансированная по нагрузке группа реплик, распределенная между несколькими доменами сбоя, называется набором реплик. Этот набор совместно реализует протокол реплицированного состояния машины, чтобы сделать данные в секции ресурсов доступными, устойчивыми и согласованными. Членство в наборе реплик N является динамическим — оно постоянно меняется между NMin и NMax на основе сбоев, административных операций и времени для повторного создания или восстановления неудачных реплик. Исходя из изменений членства, протокол репликации также перенастраивает размер кворумов чтения и записи. Для равномерного распределения пропускной способности, присвоенной данной секции ресурсов, мы используем две идеи. Во-первых, стоимость обработки запросов на запись для лидера выше, чем стоимость применения обновлений для подписчика. Соответственно, лидеру предусмотрено больше системных ресурсов, чем подписчику. Во-вторых, насколько это возможно, кворум чтения для заданного уровня согласованности состоит исключительно из реплик подписчиков. Мы избегаем контакта с лидером для выполнения операций чтения, если этого не требуется. Мы используем ряд идей из исследования, проведенного в отношении [нагрузки и производительности](http://www.cs.utexas.edu/~lorenzo/corsi/cs395t/04S/notes/naor98load.pdf) в системах на основе кворума для пяти моделей согласованности, поддерживаемых Cosmos DB.  

## <a name="partition-sets"></a>Наборы секций

Группа физических секций, одна из каждой сконфигурированной области базы данных Cosmos, составлена для управления одним и тем же набором ключей, реплицированных во всех настроенных регионах. Этот более высокий координационный примитив называется набором секций — географически распределенное динамическое наложение физических секций, управляющих заданным набором ключей. Хотя данная секция ресурсов (набор реплик) находится в пределах кластера, набор секций может охватывать несколько кластеров, центры обработки данных и географические регионы, как показано на следующем рисунке.  

![Наборы секций](./media/global-dist-under-the-hood/dynamic-overlay-of-resource-partitions.png)

Набор секций можно считать географически распределенным "супернабором реплик", который состоит из нескольких наборов реплик, обладающих тем же набором ключей. Как и в наборе реплик, членство в наборе секций также является динамическим — оно меняется на основе неявных операций управления секциями ресурсов для добавления новых секций в заданный набор секций или удаления из него (например, когда вы уменьшаете пропускную способность на контейнер, добавляете или удаляете регион в базе данных Cosmos или когда возникают сбои). Благодаря тому, что каждая из секций (набора секций) управляет членством в наборе секций в пределах своего собственного набора реплик, членство является полностью децентрализованным и высокодоступным. Во время перенастройки набора секций также устанавливается топология наложения между физическими секциями. Топология динамически выбирается на основе уровня согласованности, географического расстояния и доступной пропускной способности сети между исходными и целевыми физическими секциями.  

Служба позволяет настроить базы данных Cosmos либо с одним регистром записи, либо с несколькими регионами записи, и в зависимости от выбора наборы секций настроены так, чтобы принимать записи в только одном или во всех регионах. Система использует двухуровневый протокол на основе консенсуса — один уровень работает в репликах набора реплик секции ресурсов, принимая записи, а другой работает на уровне набора секций, чтобы обеспечить полные гарантии упорядочения для всех зафиксированных записей в наборе секций. Этот многоуровневый вложенный консенсус имеет решающее значение для реализации наших строгих соглашений об уровне обслуживания для обеспечения высокой доступности, а также для реализации моделей согласованности, которые предлагает Cosmos DB своим клиентам.  

## <a name="conflict-resolution"></a>Разрешение конфликтов

Наша разработка для распространения обновлений, разрешения конфликтов и отслеживания причинности основана на предыдущей работе над [алгоритмами эпидемии](http://www.cs.utexas.edu/~lorenzo/corsi/cs395t/04S/notes/naor98load.pdf) и системой [Bayou](http://zoo.cs.yale.edu/classes/cs422/2013/bib/terry95managing.pdf). Хотя ядра идей сохранились и предоставляют удобную систему отсчета для создания структуры системы Cosmos DB, они также значительно изменились, когда их применяли к системе Cosmos DB. Это было необходимо, поскольку предыдущие системы не были разработаны ни с помощью управления ресурсами, ни с помощью масштабирования, которое требуется для работы Cosmos DB, ни для обеспечения возможностей (например, согласованность с ограниченным устареванием) и строгих и всесторонних Соглашений об уровне обслуживания, которые предоставляет Cosmos DB своим клиентам.  

Помните, что набор секций распределяется по нескольким регионам и следует за протоколом репликации Cosmos DB (с несколькими источниками) для репликации данных между физическими секциями, содержащими заданный набор секций. Каждая секция ресурсов (из набора секций) принимает записи и обычно служит для чтения клиентам из этого региона. Записи, принятые секцией ресурсов в регионе, надежно зафиксированы и сделаны высокодоступными в пределах секции ресурсов, прежде чем подтверждаться для клиента. Эти предварительные записи распространяются на другие физические секции в наборе секций с помощью канала защиты от энтропии. Клиенты могут запрашивать либо предварительные, либо зафиксированные записи путем передачи заголовка запроса. Распространение защиты от энтропии (включая частоту распространения) является динамическим, основанным на топологии набора секций, региональной близости физических секций и настроенном уровне согласованности. В наборе секций Cosmos DB следует первичной схеме фиксации с динамически выбранной секцией арбитра. Выбор арбитра динамический. Он является неотъемлемой частью перенастройки набора секций на основе топологии наложения. Заказы зафиксированных записей (включая многострочные или пакетные обновления) гарантируются. 

Мы используем закодированные векторные часы (содержащие идентификатор региона и логические часы, соответствующие каждому уровню консенсуса в наборе реплик и наборе секций соответственно) для отслеживания причинно-следственных связей и версий векторов, чтобы обнаружить и разрешить конфликты обновления. Топология и алгоритм выбора одноранговых узлов предназначены для обеспечения фиксированного и минимального хранения и минимальных нагрузок на сеть версий векторов. Алгоритм гарантирует строгое свойство конвергенции.  

Для баз данных Cosmos, настроенных с несколькими регионами записи, система предлагает ряд гибких политик автоматического разрешения конфликтов для разработчиков на выбор, включая следующие. 

- Приоритет последней записи (LWW), при котором по умолчанию используется свойство метки времени, назначенное системой (на основе протокола синхронизации времени). Cosmos DB также позволяет указать любое другое пользовательское числовое свойство, которое будет использоваться для разрешения конфликтов.  
- Определенная приложением политика пользовательского разрешения конфликтов (выраженная через процедуры слияния), которая предназначена для определяемой приложением семантики выверки конфликтов. Эти процедуры вызываются при обнаружении конфликтов "запись — запись" во время обработки транзакции в базе данных на стороне сервера. Система гарантирует только однократное выполнение слияния в рамках протокола обязательств. Для вас доступно несколько образцов.  

## <a name="consistency-models"></a>Модели согласованности

Независимо от того, настраиваете ли вы свою базу данных Cosmos в одном или нескольких регионах записи, вы можете выбрать из пяти четко определенных моделей согласованности. Благодаря недавно добавленной поддержке для включения нескольких регионов записи ниже приведены некоторые важные аспекты уровней согласованности.  

Как и прежде, согласованность ограниченного устаревания гарантирует, что все операции чтения будут находиться в пределах префиксов k или секунд t от последней записи в любом из регионов. Кроме того, операции чтения с согласованностью ограниченного устаревания гарантируют монотонность и постоянность префикса. Протокол защиты от энтропии работает с ограничением скорости и гарантирует, что префиксы не накапливаются и обратная реакция при записи не применяется. Как и прежде, согласованность сеанса гарантирует монотонное чтение, монотонную запись, чтение ваших собственных писем, запись после чтения и гарантии постоянного префикса по всему миру. Базы данных с заданной строгой согласованностью лишены преимущества, обеспечиваемого наличием нескольких источников (малая задержка записи, высокий уровень доступности для записи), вследствие их синхронной репликации в регионах.

Семантика пяти моделей согласованности в Cosmos DB описана [здесь](consistency-levels.md) и математически показана с помощью общих спецификаций TLA+ [здесь](https://github.com/Azure/azure-cosmos-tla).

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения о том, как настроить политики глобального распределения, можно узнать в приведенных ниже статьях.

* [Configure clients for multi-homing](how-to-manage-database-account.md#configure-clients-for-multi-homing) (Настройка клиентов для поддержки нескольких веб-сайтов)
* [Добавление и удаление регионов из учетной записи базы данных](how-to-manage-database-account.md#addremove-regions-from-your-database-account)
* [Create a custom conflict resolution policy](how-to-manage-conflicts.md#create-a-custom-conflict-resolution-policy) (Создание настраиваемой политики разрешения конфликтов)
