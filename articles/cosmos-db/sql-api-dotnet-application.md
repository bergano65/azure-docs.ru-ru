---
title: Руководство по ASP.NET Core MVC для Azure Cosmos DB. Разработка веб-приложений
description: Это руководство по MVC Core для ASP.NET поможет вам создать веб-приложение MVC с использованием Azure Cosmos DB. С помощью этого руководства по ASP NET Core MVC вы сможете сохранить файл JSON и получить доступ к данным из приложения "Список дел", размещенного в Службе приложений Azure.
author: SnehaGunda
ms.service: cosmos-db
ms.subservice: cosmosdb-sql
ms.devlang: dotnet
ms.topic: tutorial
ms.date: 09/24/2019
ms.author: sngun
ms.openlocfilehash: abff58be25a23c783f476dc849e0d6fa97e9eed2
ms.sourcegitcommit: 29880cf2e4ba9e441f7334c67c7e6a994df21cfe
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/26/2019
ms.locfileid: "71299342"
---
# <a name="tutorial-develop-an-aspnet-core-mvc-web-application-with-azure-cosmos-db-by-using-net-sdk"></a>Руководство по Разработка веб-приложения ASP.NET Core MVC с использованием Azure Cosmos DB с помощью пакета SDK для .NET

> [!div class="op_single_selector"]
> * [.NET](sql-api-dotnet-application.md)
> * [Java](sql-api-java-application.md)
> * [Node.js](sql-api-nodejs-application.md)
> * [Python](sql-api-python-application.md)
> * [Xamarin](mobile-apps-with-xamarin.md)

В этом руководстве показано, как использовать Azure Cosmos DB для хранения данных и обеспечения доступа к ним из приложения ASP.NET MVC, размещенного в Azure. В этом руководстве используется пакет SDK для .NET версии 3. На следующем рисунке показана веб-страница, которая создается с помощью примера в этой статье:

![Снимок экрана: список дел веб-приложения MVC, созданный с помощью этого руководства по ASP.NET Core MVC](./media/sql-api-dotnet-application/asp-net-mvc-tutorial-image01.png)

Если у вас нет времени для работы с руководством, можно скачать полный пример проекта с [GitHub][GitHub].

Темы, рассматриваемые в этом руководстве:

> [!div class="checklist"]
>
> * Создание учетной записи Azure Cosmos.
> * Создание приложения ASP.NET Core MVC
> * Подключение приложения к Azure Cosmos DB.
> * Выполнение операций создания, чтения, обновления и удаления (CRUD) данных

> [!TIP]
> Предполагается, что у вас есть опыт использования ASP.NET Core MVC и службы приложений Azure. Если вы никогда не работали с ASP.NET Core или [необходимыми инструментами](#prerequisites), мы рекомендуем скачать полный пример проекта с портала [GitHub][GitHub], добавить требуемые пакеты NuGet и запустить его. Когда создадите проект, вы можете просмотреть эту статью, чтобы разобраться в коде этого проекта.

## <a name="prerequisites"></a>Предварительные требования

Перед выполнением инструкций, приведенных в этой статье, подготовьте следующие ресурсы:

* Активная учетная запись Azure. Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

  [!INCLUDE [cosmos-db-emulator-docdb-api](../../includes/cosmos-db-emulator-docdb-api.md)]

* Visual Studio 2019. [!INCLUDE [cosmos-db-emulator-vs](../../includes/cosmos-db-emulator-vs.md)]  

Все снимки экранов в этой статье взяты из Microsoft Visual Studio Community 2019. Если вы используете другую версию, экраны и параметры могут не совпадать полностью. Решение будет работать, если вы выполните все предварительные требования.

## <a name="create-an-azure-cosmos-account"></a>Шаг 1. Создание учетной записи Azure Cosmos

Давайте сначала создадим учетную запись Azure Cosmos. Если у вас уже есть учетная запись API SQL Azure Cosmos DB или вы используете эмулятор Azure Cosmos DB, можно перейти к разделу [Шаг 2. Создание приложения ASP.NET MVC](#create-a-new-mvc-application).

[!INCLUDE [create-dbaccount](../../includes/cosmos-db-create-dbaccount.md)]

[!INCLUDE [keys](../../includes/cosmos-db-keys.md)]

В следующем разделе вы создадите приложение ASP.NET Core MVC.

## <a name="create-a-new-mvc-application"></a>Шаг 2. Создание приложения ASP.NET Core MVC

1. Откройте Visual Studio и выберите **Создать проект**.

1. В окне **Создание проекта** найдите и выберите **Веб-приложение ASP.NET Core** для C#. Нажмите кнопку **Далее**, чтобы продолжить.

   ![Создание проекта веб-приложения ASP.NET Core](./media/sql-api-dotnet-application/asp-net-mvc-tutorial-new-project-dialog.png)

1. В окне **Настроить новый проект** присвойте проекту имя *todo* и щелкните **Создать**.

1. В окне **Создать веб-приложение ASP.NET Core** выберите **Веб-приложение (модель-представление-контроллер)** . Щелкните **Создать** , чтобы продолжить.

   Visual Studio создаст пустой проект MVC.

1. Щелкните **Отладка** > **Начать отладку** или нажмите клавишу F5, чтобы запустить приложение ASP.NET в локальной среде.

## <a name="add-nuget-packages"></a>Шаг 3. Добавление пакета Azure Cosmos DB NuGet в проект

Теперь, когда у нас есть большая часть кода платформы ASP.NET Core MVC, необходимого для этого решения, давайте добавим пакеты NuGet, требуемые для подключения к Azure Cosmos DB.

1. В **обозревателе решений** щелкните проект правой кнопкой мыши и выберите **Управление пакетами NuGet**.

1. В окне **Диспетчер пакетов NuGet** найдите и выберите **Microsoft.Azure.Cosmos**. Щелкните **Установить**.

   ![Установка пакета NuGet](./media/sql-api-dotnet-application/asp-net-mvc-tutorial-nuget.png)

   Visual Studio скачает и установит пакет Azure Cosmos DB вместе с зависимостями.

   Для установки пакета NuGet можно также воспользоваться **консолью диспетчера пакетов**. Для этого выберите **Инструменты** > **Диспетчер пакетов NuGet** > **Консоль диспетчера пакетов**. При появлении запроса введите следующую команду:

   ```ps
   Install-Package Microsoft.Azure.Cosmos
   ```
  
## <a name="set-up-the-mvc-application"></a>Шаг 4. Настройка приложения ASP.NET Core MVC

Теперь мы добавим в это приложение MVC модели, представления и контроллеры.

### <a name="add-a-model"></a> Добавление модели

1. В **обозревателе решений** щелкните правой кнопкой мыши папку **Models** и выберите **Добавить** > **Класс**.

1. В области **Добавить новый элемент** присвойте классу имя *Item.cs* и щелкните **Добавить**.

1. Замените содержимое класса *Item.cs* приведенным ниже кодом.

   [!code-csharp[Main](~/samples-cosmosdb-dotnet-core-web-app/src/Models/Item.cs)]

Azure Cosmos DB использует для перемещения и хранения данных формат JSON. Чтобы управлять тем, как JSON сериализует и десериализует объекты, можно использовать атрибут `JsonProperty`. Класс `Item` демонстрирует использование атрибута `JsonProperty`. Этот код позволяет управлять форматом имени свойства в представлении JSON. Также этот код отвечает за переименование свойства .NET `Completed`.

### <a name="add-views"></a>Добавление представлений

Теперь давайте создадим следующие три представления:

* представление элемента списка;
* представление создания элемента;
* представление изменения элемента.

#### <a name="AddItemIndexView"></a>Добавление представления "Элемент списка"

1. В **обозревателе решений** щелкните правой кнопкой мыши папку **Views** и выберите **Добавить** > **Новая папка**. Присвойте этой папке имя *Item*.

1. Щелкните правой кнопкой мыши пустую папку **Item** и выберите **Добавить** > **Представление**.

1. В окне **Добавление представления MVC** предоставьте следующие значения.

   * В поле **Имя представления** введите *Index*.
   * В поле **Шаблон** выберите **List**.
   * В поле **Класс модели** выберите **Item (todo.Models)** (Элемент (todo.Models)).
   * Выберите **Use a layout page** (Использовать страницу макета) и введите *~/Views/Shared/_Layout.cshtml*.

   ![Снимок экрана: диалоговое окно "Добавление представления MVC"](./media/sql-api-dotnet-application/asp-net-mvc-tutorial-add-mvc-view.png)

1. После добавления этих значений выберите **Добавить**, и Visual Studio создаст представление.

После этого Visual Studio откроет созданный *CSHTML-файл*. Вы можете закрыть этот файл в Visual Studio. Мы вернемся к нему позже.

#### <a name="AddNewIndexView"></a>Добавление представления "Создание элементов"

Аналогично тому, как вы создали представление для вывода списка элементов, создайте представление для создания элементов, выполнив следующие действия:

1. В **обозревателе решений** снова щелкните правой кнопкой мыши папку **Item** и выберите **Добавить** > **Представление**.

1. В разделе **Добавить представление MVC ASP.NET** внесите следующие изменения:

   * В поле **Имя представления** введите *Create*.
   * В поле **Шаблон** выберите **Create**.
   * В поле **Класс модели** выберите **Item (todo.Models)** (Элемент (todo.Models)).
   * Выберите **Use a layout page** (Использовать страницу макета) и введите *~/Views/Shared/_Layout.cshtml*.
   * Выберите **Добавить**.

#### <a name="AddEditIndexView"></a>Добавление представления "Редактирование элементов"

И наконец, добавьте представление для редактирования элемента, сделав следующее:

1. В **обозревателе решений** cyjdf щелкните правой кнопкой мыши папку **Item** и выберите **Добавить** > **Представление**.

1. В разделе **Добавить представление MVC ASP.NET** внесите следующие изменения:

   * В поле **Имя представления** введите *Изменить*.
   * В поле **Шаблон** выберите **Изменить**.
   * В поле **Класс модели** выберите **Item (todo.Models)** (Элемент (todo.Models)).
   * Выберите **Use a layout page** (Использовать страницу макета) и введите *~/Views/Shared/_Layout.cshtml*.
   * Выберите **Добавить**.

Как только вы выполните эти действия, закройте в Visual Studio все документы *cshtml*. Вы вернетесь к ним позже.

### <a name="add-a-controller"></a>Добавление контроллера

1. В **обозревателе решений** щелкните правой кнопкой мыши папку **Controllers** и выберите **Добавить** > **Контроллер**.

1. В разделе **Добавление шаблона** выберите **Контроллер MVC — пустой** и щелкните **Добавить**.

   ![Выборе элемента "Контроллер MVC — пустой" в разделе добавления шаблона](./media/sql-api-dotnet-application/asp-net-mvc-tutorial-controller-add-scaffold.png)

1. Присвойте новому контроллеру имя *ItemController*.

1. Замените содержимое файла *ItemController.cs* приведенным ниже кодом.

   [!code-csharp[Main](~/samples-cosmosdb-dotnet-core-web-app/src/Controllers/ItemController.cs)]

Атрибут **ValidateAntiForgeryToken** используется здесь для защиты этого приложения от атак с подделкой межсайтовых запросов. Все представления должны нормально работать с этим маркером защиты от подделки запросов. Чтобы узнать больше и просмотреть примеры, ознакомьтесь со статьей [Preventing Cross-Site Request Forgery (CSRF) Attacks in ASP.NET MVC Application][Preventing Cross-Site Request Forgery] (Предупреждения атак с подделкой межсайтовых запросов в приложении ASP.NET MVC). Исходный код, предоставленный на [GitHub][GitHub], имеет полную реализацию.

Для защиты от атак overposting также используется атрибут **Bind** в параметре метода. Дополнительные сведения см. в статье [Руководство. Implement CRUD Functionality with the Entity Framework in ASP.NET MVC][Basic CRUD Operations in ASP.NET MVC] (Реализация функций CRUD с использованием Entity Framework в ASP.NET MVC).

## <a name="connect-to-cosmosdb"></a>Шаг 5. Подключение к Azure Cosmos DB

Теперь, когда мы позаботились об основных ресурсах MVC, давайте перейдем к добавлению кода для подключения к Azure Cosmos DB и выполнения операций CRUD.

### <a name="perform-crud-operations"></a>Выполнение операций CRUD с данными

Сначала мы добавим класс, который содержит необходимую логику для подключения к службе Azure Cosmos DB и ее использования. В этом руководстве мы инкапсулируем эту логику в класс с именем `CosmosDBService` и интерфейсом с именем `ICosmosDBService`. Эта служба выполняет операции CRUD. Также она отвечает за операции веб-каналов, такие как отображение незавершенных элементов, а также создание, редактирование и удаление элементов.

1. В **обозревателе решений** щелкните правой кнопкой мыши проект и выберите **Добавить** > **Новая папка**. Присвойте этой папке имя *Services*.

1. Щелкните правой кнопкой мыши папку **Services**, выберите **Добавить** > **Класс**. Назовите новый класс *CosmosDBService* и выберите **Добавить**.

1. Замените содержимое файла *CosmosDBService.cs* следующим кодом:

   [!code-csharp[Main](~/samples-cosmosdb-dotnet-core-web-app/src/Services/CosmosDbService.cs)]

1. Повторите предыдущие два шага, но на этот раз используйте имя *ICosmosDBService* и представленный ниже код:

   [!code-csharp[Main](~/samples-cosmosdb-dotnet-core-web-app/src/Services/ICosmosDbService.cs)]

1. В обработчик **ConfigureServices** добавьте следующую строчку:

    ```csharp
    services.AddSingleton<ICosmosDbService>(InitializeCosmosClientInstanceAsync(Configuration.GetSection("CosmosDb")).GetAwaiter().GetResult());
    ```

    Код из предыдущего шага получает `CosmosClient` в составе конструктора. В соответствии со структурой контейнера ASP.NET Core нам нужно открыть файл *Startup.cs*. Код на этом этапе инициализирует клиент, настроенный как одноэлементный экземпляр, который будет внедрен с помощью [внедрения зависимостей в ASP.NET Core](https://docs.microsoft.com/aspnet/core/fundamentals/dependency-injection).

1. В этом же файле добавьте следующий метод **InitializeCosmosClientInstanceAsync**, который отвечает за чтение конфигурации и инициализацию клиента.

    [!code-csharp[](~/samples-cosmosdb-dotnet-core-web-app/src/Startup.cs?name=InitializeCosmosClientInstanceAsync)]

1. Определите конфигурацию в файле проекта *appsettings.json*. Откройте этот файл и добавьте раздел с именем **CosmosDb**.

   ```csharp
     "CosmosDb": {
        "Account": "<enter the URI from the Keys blade of the Azure Portal>",
        "Key": "<enter the PRIMARY KEY, or the SECONDARY KEY, from the Keys blade of the Azure  Portal>",
        "DatabaseName": "Tasks",
        "ContainerName": "Items"
      }
   ```

При запуске приложения с помощью конвейера ASP.NET Core создается экземпляр **CosmosDbService**. Один экземпляр поддерживается как singleton. Когда **ItemController** обрабатывает запросы на стороне клиента, он получает этот единственный экземпляр и может использовать его для операций CRUD.

Если создать и запустить этот проект сейчас, отобразятся примерно следующие данные.

![Снимок экрана: веб-приложение "Список дел", созданное с помощью этого учебника по базе данных](./media/sql-api-dotnet-application/build-and-run-the-project-now.png)

## <a name="run-the-application"></a>Шаг 6. Локальный запуск приложения

Чтобы проверить приложение на локальном компьютере, выполните следующие шаги.

1. Нажмите клавишу F5 в Visual Studio, чтобы создать приложение в режиме отладки. После этого будет создано приложение и откроется окно браузера с пустой сеткой, которую мы уже видели:

   ![Снимок экрана: веб-приложение "Список дел", созданное с помощью этого руководства](./media/sql-api-dotnet-application/asp-net-mvc-tutorial-create-an-item-a.png)

1. Щелкните ссылку **Создать** и введите значения в поля **Имя** и **Описание**. Не устанавливайте флажок **Выполнено**. Если вы его установите, приложение добавит новый элемент в завершенном состоянии. Элемент больше не отображается в исходном списке.

1. Нажмите кнопку **Создать**. Приложение возвращает вас к представлению **Индекс**, где в списке уже появился новый элемент. Вы можете добавить еще несколько элементов в **список задач**.

    ![Снимок экрана: представление "Индекс"](./media/sql-api-dotnet-application/asp-net-mvc-tutorial-create-an-item.png)
  
1. Выберите действие **Редактировать** рядом со строкой **Элемент** в списке. В приложении откроется представление **Изменить**, где вы можете изменить любое свойство объекта, в том числе флажок **Выполнено**. Если установить флажок **Выполнено** и щелкнуть **Сохранить**, приложение отобразит для пункта **Элемент** в списке состояние "Выполнено".

   ![Снимок экрана: представление "Индекс" с установленным флажком возле параметра "Завершено"](./media/sql-api-dotnet-application/asp-net-mvc-tutorial-completed-item.png)

1. Проверьте состояние данных в службе Azure Cosmos DB с помощью [обозревателя Cosmos](https://cosmos.azure.com) или обозревателя данных эмулятора Azure Cosmos DB.

1. После проверки приложения нажмите сочетание клавиш CTRL+F5, чтобы остановить отладку приложения. Теперь все готово к развертыванию.

## <a name="deploy-the-application-to-azure"></a>Шаг 7. Развертывание приложения

Теперь, когда у вас есть готовое приложение, которое корректно работает в Azure Cosmos DB, мы собираемся развернуть его в службу приложений Azure.  

1. Чтобы опубликовать это приложение, щелкните проект правой кнопкой мыши в **обозревателе решений** и выберите действие **Опубликовать**.

1. В поле **Выберите целевой объект публикации** выберите **Служба приложений**.

1. Чтобы использовать существующий профиль Службы приложений, щелкните **Выбрать существующий**, а затем **Опубликовать**.

1. В **Службе приложений** выберите элемент **Подписка**. Используйте фильтр **Просмотр** для сортировки по группе ресурсов или типу ресурсов.

1. Найдите нужный профиль и щелкните **OK**. Затем выполните поиск необходимой Службы приложений Azure и нажмите кнопку **ОК**.

   ![Диалоговое окно "Служба приложений" в Visual Studio](./media/sql-api-dotnet-application/asp-net-mvc-tutorial-app-service-2019.png)

Другой вариант — создать новый профиль.

1. Как и в предыдущей процедуре, щелкните правой кнопкой мыши проект в **обозревателе решений** и выберите **Опубликовать**.
  
1. В поле **Выберите целевой объект публикации** выберите **Служба приложений**.

1. В поле **Выберите целевой объект публикации** выберите **Создать новый**, а затем **Опубликовать**.

1. В разделе **Служба приложений** введите имя веб-приложения и укажите нужные варианты подписки, группы ресурсов и плана службы приложений. Затем щелкните **Создать**.

   ![Диалоговое окно "Создать службу приложений" в Visual Studio](./media/sql-api-dotnet-application/asp-net-mvc-tutorial-create-app-service-2019.png)

Через несколько секунд Visual Studio опубликует ваше веб-приложение и запустит браузер, где вы увидите свой проект, запущенный в Azure!

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как создать веб-приложение ASP.NET Core MVC. Это приложение может обращаться к данным, сохраненным в Azure Cosmos DB. Теперь вы можете продолжить работу с этими ресурсами:

* [Partitioning in Azure Cosmos DB](./partitioning-overview.md) (Секционирование в Azure Cosmos DB)
* [Getting started with SQL queries](./how-to-sql-query.md) (Начало работы с запросами SQL)
* [Как моделировать и секционировать данные в Azure Cosmos DB на примере реальной задачи](./how-to-model-partition-example.md)

[Visual Studio Express]: https://www.visualstudio.com/products/visual-studio-express-vs.aspx
[Microsoft Web Platform Installer]: https://www.microsoft.com/web/downloads/platform.aspx
[Preventing Cross-Site Request Forgery]: https://docs.microsoft.com/aspnet/web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
[Basic CRUD Operations in ASP.NET MVC]: https://go.microsoft.com/fwlink/?LinkId=317598
[GitHub]: https://github.com/Azure-Samples/cosmos-dotnet-core-todo-app
