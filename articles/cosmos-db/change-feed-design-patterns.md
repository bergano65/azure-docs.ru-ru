---
title: Конструктивные шаблоны для каналов изменений в Azure Cosmos DB
description: Общие сведения об основных конструктивных шаблонах канала изменений
author: timsander1
ms.author: tisande
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 04/08/2020
ms.openlocfilehash: ebd1c4f71d71ca70f6d10763d538b1877b0c3539
ms.sourcegitcommit: 3bcce2e26935f523226ea269f034e0d75aa6693a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/23/2020
ms.locfileid: "92489359"
---
# <a name="change-feed-design-patterns-in-azure-cosmos-db"></a>Конструктивные шаблоны для каналов изменений в Azure Cosmos DB

Канал изменений Azure Cosmos DB позволяет эффективно обрабатывать большие наборы данных с большим объемом операций записи. Также канал изменений позволяет обойтись без запросов ко всему набору данных, когда нужно найти только изменившиеся данные. В этом документе рассматриваются распространенные конструктивные шаблоны для каналов изменений, компромиссы разработки и ограничения канала изменений.

Azure Cosmos DB используется для приложений Интернета вещей, розничной торговли, игр и приложений для ведения журнала операций. Для таких приложений часто используется одинаковый конструктивный шаблон, в котором изменения в данных активируют дополнительные действия, например:

* активирование уведомления или вызова API при вставке или изменении элемента;
* потоковая обработка в режиме реального времени (для Интернета вещей) или аналитическая обработка в режиме реального времени по рабочим данным;
* перемещение данных, такое как синхронизация с кэшем, поисковая система, хранилище данных или холодное хранилище.

Канал изменений в Azure Cosmos DB позволяет создавать эффективные и масштабируемые решения для каждого из этих шаблонов, как показано на следующем рисунке:

:::image type="content" source="./media/change-feed/changefeedoverview.png" alt-text="Использование веб-канала изменений Azure Cosmos DB для аналитики в реальном времени и вычислений на основе событий" border="false":::

## <a name="event-computing-and-notifications"></a>Вычисление и уведомления о событиях

Канал изменений Azure Cosmos DB может упростить сценарии, которые должны активировать уведомление или отправлять вызов в API при определенном событии. Для автоматического опроса вашего контейнера на наличие изменений и вызова внешнего API при каждой записи или обновлении можно использовать [библиотеку процессов канала изменений](change-feed-processor.md).

Вы также можете выборочно активировать уведомление или отправить вызов в API на основе определенного критерия. Например, при чтении канала изменений с помощью [функций Azure](change-feed-functions.md) можно поместить в функцию логику, которая будет отправлять уведомление только при выполнении определенного критерия. Несмотря на то, что код функций Azure выполняется во время каждой операции записи и обновления, уведомление отправляется только при выполнении определенных критериев.

## <a name="real-time-stream-processing"></a>Потоковая обработка в режиме реального времени

Канал изменений Azure Cosmos DB можно использовать для потоковой обработки в режиме реального времени (для Интернета вещей) или для аналитической обработки рабочих данных в режиме реального времени.
Например, можно получать и хранить данные о событиях из устройств, датчиков, инфраструктуры и приложений и обрабатывать эти события в режиме реального времени, например с помощью [Spark](../hdinsight/spark/apache-spark-overview.md). Ниже показано, как реализовать лямбда-архитектуру, используя Azure Cosmos DB с помощью канала изменений:

:::image type="content" source="./media/change-feed/lambda.png" alt-text="Использование веб-канала изменений Azure Cosmos DB для аналитики в реальном времени и вычислений на основе событий" border="false":::

Во многих случаях реализации потоковой обработки сначала получают большой объем входящих данных во временную очередь сообщений, например в концентратор событий Azure или в Apache Kafka. Канал изменений — отличная альтернатива, поскольку Azure Cosmos DB поддерживает устойчивую высокую скорость приема данных с гарантированной низкой задержкой чтения и записи. Преимущества канала изменений Azure Cosmos DB перед очередью сообщений включают следующее.

### <a name="data-persistence"></a>Сохраняемость данных

Данные, записанные в Azure Cosmos DB, отобразятся в канале изменений и будут храниться до удаления. Обычно очереди сообщений имеют максимальный срок хранения. Например, [концентратор событий Azure](https://azure.microsoft.com/services/event-hubs/) предлагает максимальный срок хранения данных 90 дней.

### <a name="querying-ability"></a>Возможность запросов

Помимо чтения данных из канала изменений контейнера Cosmos вы также можете выполнять SQL-запросы к данным, хранящимся в Azure Cosmos DB. Канал изменений не дублирует данные, которые уже находятся в контейнере, а служит скорее другим механизмом для чтения данных. Таким образом, при чтении данных из канала изменений они всегда будут соответствовать запросам контейнера Azure Cosmos DB.

### <a name="high-availability"></a>Высокий уровень доступности

Azure Cosmos DB обеспечивает доступность для чтения и записи до 99,999 %. В отличие от многих очередей сообщений, данные Azure Cosmos DB легко поддаются глобальному распределению и настраиваются с [RTO (целевое время восстановления)](./consistency-levels.md#rto), равным 0.

Обработав элементы в канале изменений, вы сможете создать материализованное представление и сохранить агрегированные значения в Azure Cosmos DB. При использовании Azure Cosmos DB для создания игр веб-канал изменений можно использовать, например, для создания списков лидеров в режиме реального времени на основе очков в завершенных играх.

## <a name="data-movement"></a>Перемещение данных

Для перемещения данных в режиме реального времени можно также считывать данные из канала изменений.

Например, с помощью канала изменений можно эффективно выполнять следующие задачи:

* обновление кэша, индекса поиска или хранилища данными, хранящихся в Azure Cosmos DB;

* выполнение миграции без простоя в другую учетную запись Azure Cosmos или другой контейнер Azure Cosmos с другим ключом логического раздела;

* реализация распределения данных по уровням и архивирования на уровне приложения. Например, можно хранить "горячие" данные в Azure Cosmos DB и переводить "холодные данные" в другие системы хранения, такие как [хранилище BLOB-объектов Azure](../storage/common/storage-introduction.md).

Если вам нужно выполнить [денормализацию данных в разделы и контейнеры](how-to-model-partition-example.md#v2-introducing-denormalization-to-optimize-read-queries
), данные можно считать из канала изменений контейнера как из источника для репликации данных. Репликация данных в режиме реального времени с помощью канала изменений может гарантировать только окончательную согласованность. Вы можете [отслеживать, насколько отстает от обработчика канала изменений](how-to-use-change-feed-estimator.md) обработка изменений в контейнере Cosmos.

## <a name="event-sourcing"></a>Источник событий

[Шаблон источников событий](/azure/architecture/patterns/event-sourcing) включает использование хранилища, доступного только для добавления данных, для записи полного набора действий с этими данными. Канал изменений Azure Cosmos DB — отличный вариант центрального хранилища данных для архитектур источников событий, где любой прием данных моделируется как операции записи (без обновлений и удалений). В этом случае каждая запись в Azure Cosmos DB является "событием" и вы получаете полную запись прошлых событий в канале изменений. Как правило, события, публикуемые центральным хранилищем событий, предназначены для хранения материализованных представлений или для интеграции с внешними системами. Поскольку срок хранения данных в канале изменений не ограничен, вы можете воспроизвести все предыдущие события, считывая их с начала канала изменений контейнера Cosmos.

Вы можете [подписать на один и тот же веб-канал изменений контейнера сразу нескольких потребителей](how-to-create-multiple-cosmos-db-triggers.md#optimizing-containers-for-multiple-triggers). Помимо подготовленной пропускной способности [контейнера аренды](change-feed-processor.md#components-of-the-change-feed-processor), никакая плана за использование канала изменений не взимается. Канал изменений доступен в каждом контейнере, используется он или нет.

Azure Cosmos DB — это отличное центральное хранилище постоянных данных в шаблоне источников событий, доступное только для добавления. Оно отличается высокой горизонтальной масштабируемостью и высоким уровнем доступности. Кроме того, библиотека обработчика канала изменений предлагает["как минимум, разовую"](change-feed-processor.md#error-handling) гарантию того, что вы не пропустили обработку каких-либо событий.

## <a name="current-limitations"></a>Текущие ограничения

Канал изменений имеет важные ограничения, которые нужно знать. Несмотря на то, что элементы в контейнере Cosmos остаются в канале изменений, он не является полным журналом операций. Проектируя приложение с использованием канала изменений, необходимо учитывать несколько важных аспектов.

### <a name="intermediate-updates"></a>Промежуточные обновления

В канал изменений заносится только последнее изменение конкретного элемента. При обработке изменений вы будете считывать последнюю доступную версию элемента. Если за короткий период времени происходят несколько обновлений одного и того же элемента, обработку промежуточных обновлений можно пропустить. Если вы хотите отслеживать обновления и иметь возможность воспроизводить предыдущие обновления элемента, рекомендуем вместо этого смоделировать эти обновления как ряд операций записи.

### <a name="deletes"></a>Deletes

Канал изменений не записывает удаления. Когда элемент удаляется из контейнера, он удаляется и из канала изменений. Наиболее распространенный способ обработки — это добавление программного маркера к удаляемым элементам. Вы можете добавить свойство "deleted" и задать для него значение "true" в момент удаления. Обновление документа появится в канале изменений. Для этого элемента можно задать TTL, чтобы удалить его автоматически позднее.

### <a name="guaranteed-order"></a>Гарантированный порядок

В канале изменений есть гарантированный порядок в пределах одного значения ключа раздела, а значения разных ключей разделов не упорядочены. Вам нужно выбрать ключ раздела, чтобы обеспечить значимый порядок.

Рассмотрим, например, приложение для розничной торговли, используя шаблон проектирования источников событий. В этом приложении разные действия пользователя представляют собой события, которые моделируются как операции записи в Azure Cosmos DB. Допустим, произошло несколько событий в следующей последовательности.

1. Клиент добавляет в корзину товар A.
2. Клиент добавляет в корзину товар Б.
3. Клиент удаляет из корзины товар A.
4. Клиент оформляет покупку и получает содержимое корзины.

Для каждого клиента сохраняется материализованное представление текущего содержимого корзины. Приложение должно обеспечивать обработку этих событий в том порядке, в котором они происходят. Если, например, покупку потребуется обработать до удаления товара А, скорее всего, вместо желаемого товара Б клиенту будет доставлен товар А. Чтобы все эти четыре события были обработаны в том порядке, в котором они происходят, они должны иметь одно и то же значение ключа раздела. Если вы выбрали в качестве ключа раздела **имя пользователя** (у каждого клиента должно быть уникальное имя пользователя), эти события отображаются в канале изменений в том же порядке, в котором они были записаны в Azure Cosmos DB.

## <a name="examples"></a>Примеры

Ниже показано несколько практических примеров кода канала изменений, которые выходят за рамки примеров, которые приводятся в документах Майкрософт.

- [Общие сведения о канале изменений](https://azurecosmosdb.github.io/labs/dotnet/labs/08-change_feed_with_azure_functions.html)
- [Вариант использования IoT с применением канала изменений](https://github.com/AzureCosmosDB/scenario-based-labs)
- [Вариант использования в сфере розничной торговли с применением канала изменений](https://github.com/AzureCosmosDB/scenario-based-labs)

## <a name="next-steps"></a>Дальнейшие действия

* [Общие сведения о канале изменений](change-feed.md)
* [Reading Azure Cosmos DB change feed](read-change-feed.md) (Чтение канала изменений Azure Cosmos DB)
* [Как использовать канал изменений Azure Cosmos DB с Функциями Azure](change-feed-functions.md)