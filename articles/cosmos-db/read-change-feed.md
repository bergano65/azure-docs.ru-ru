---
title: Чтение канала изменений Azure Cosmos DB
description: В этой статье описываются различные варианты, с помощью которых можно получать доступ к каналу изменений и читать его в Azure Cosmos DB.
author: timsander1
ms.author: tisande
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 09/09/2020
ms.reviewer: sngun
ms.openlocfilehash: 58db7dcade7567d632fb405b31c4ff7bdbc6e71a
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "90018975"
---
# <a name="reading-azure-cosmos-db-change-feed"></a>Чтение канала изменений Azure Cosmos DB

Вы можете работать с веб-каналом изменений Azure Cosmos DB, используя модель принудительной отправки или модель извлечения. При использовании модели push-уведомлений сервер (обработчик веб-канала изменений) отправляет клиенту данные, которые имеют бизнес-логику для обработки этой работы. Однако сложность проверки работы и сохранения состояния для последней обработанной работы обрабатывается на сервере.

При использовании модели извлечения клиент должен извлечь работу с сервера. В данном случае клиент не только имеет бизнес-логику для обработки работы, но также сохраняет состояние для последней обработанной работы, что позволяет обрабатывать балансировку нагрузки на нескольких клиентах параллельно и обрабатывать ошибки.

При чтении из канала изменений Azure Cosmos DB обычно рекомендуется использовать модель принудительной отправки уведомлений, поскольку вам не нужно беспокоиться о следующем:

- Опрос веб-канала изменений о будущих изменениях.
- Сохранение состояния для последнего обработанного изменения. При чтении из веб-канала изменений он автоматически сохраняется в [контейнере аренды](change-feed-processor.md#components-of-the-change-feed-processor).
- Балансировка нагрузки для нескольких клиентов, использующих изменения. Например, если один клиент не может справиться с обработкой изменений, а у другого есть доступные мощности.
- [Обработка ошибок](change-feed-processor.md#error-handling). Например, автоматически повторяются неудачные изменения, которые были бы неправильно обработаны после необработанного исключения в коде или временной проблемы с сетью.

Большинство сценариев, использующих веб-канал изменений Azure Cosmos DB, будут использовать один из параметров модели принудительной отправки. Однако существуют сценарии, в которых может потребоваться дополнительный низкоуровневый контроль для модели извлечения данных. К ним относятся следующие объекты.

- считывание изменений по определенному ключу секции;
- необходимость в управлении скоростью, с которой клиент получает изменения для обработки;
- однократный доступ к существующим данным в веб-канале изменений (например, для переноса данных).

## <a name="reading-change-feed-with-a-push-model"></a>Чтение канала изменений с помощью модели принудительной отправки

Использование модели принудительной отправки — это самый простой способ чтения данных из веб-канала изменений. Существует два способа чтения из веб-канала изменений с помощью модели принудительной отправки: [Триггеры Функций Azure Cosmos DB](change-feed-functions.md) и [библиотеки обработчика канала изменений](change-feed-processor.md). Функции Azure используют обработчик веб-канала изменений в фоновом режиме, поэтому они выполняют чтение веб-канала изменений очень похожими способами. Представьте себе Функции Azure в качестве платформы размещения для обработчика веб-канала изменений, а не совершенно иной способ чтения веб-канала изменений.

### <a name="azure-functions"></a>Функции Azure

Служба "Функции Azure" является самым простым вариантом, если вы только приступили к работе с веб-каналом изменений. Из-за ее простоты ее также рекомендуется использовать в большинстве вариантов использования каналов изменений. Когда вы создаете триггер Функций Azure для Azure Cosmos DB, можно выбрать контейнер для подключения, и Функции Azure будут запускаться при каждом внесении изменений в контейнер. Так как Функции Azure используют обработчик веб-канала изменений в фоновом режиме, он автоматически параллелизует обработку изменений в [секциях](partition-data.md) контейнера.

Разработка с помощью Функций Azure имеет простой интерфейс, использовать который может оказаться быстрее, чем развертывать обработчик веб-канала изменений. Триггеры можно создавать с помощью портала Функций Azure или программно с помощью пакетов SDK. Visual Studio и VS Code обеспечивают поддержку для написания Функций Azure. Для кроссплатформенной разработки можно даже использовать CLI Функций Azure. Вы можете написать и отладить код на своем компьютере, а затем развернуть функцию одним щелчком мыши. Дополнительные сведения см. в статьях [Обработка бессерверной базы данных с помощью Функций Azure](serverless-computing-database.md) и [Использование канала изменений вместе с Функциями Azure](change-feed-functions.md).

### <a name="change-feed-processor-library"></a>Библиотека обработчика веб-канала изменений

Обработчик веб-канала изменений обеспечивает более полный контроль над каналом изменений и все равно сохраняет значительную сложность. Библиотека обработки канала использует шаблон наблюдателя, в котором библиотека вызывает функцию обработки. Библиотека обработчика веб-канала изменений будет автоматически проверять наличие изменений и, если изменения будут найдены, отправит их клиенту. Если у вас есть канал изменений с высокой пропускной способностью, можно создать несколько экземпляров клиентов, чтобы считывать данные канала изменений. Библиотека обработчика веб-канала изменений будет автоматически распределять нагрузку между различными клиентами. Для балансировки нагрузки между несколькими клиентами или логики для поддержания состояния аренды не требуется реализовывать какую бы то ни было логику.

Библиотека обработчика веб-канала изменений гарантирует доставку всех изменений "не менее одного раза". Иными словами, при использовании библиотеки обработчика веб-канала изменений функция обработки будет успешно вызываться для каждого элемента в веб-канале изменений. Если в бизнес-логике в функции обработки имеется необработанное исключение, то неудачные изменения будут повторяться до тех пор, пока они не будут успешно обработаны. Чтобы обработчик канала изменений не мог постоянно повторять попытки с одними и теми же изменениями, следует добавить в функцию обработки логику для записи документов в очередь недоставленных сообщений при возникновении исключения. Дополнительные сведения об [обработке ошибок](change-feed-processor.md#error-handling).

В Функциях Azure рекомендации по обработке ошибок те же. По-прежнему необходимо добавить логику в код делегата для записи документов (до исключения) в очередь недоставленных сообщений. Однако если в Функциях Azure имеется необработанное исключение, то изменение, создавшее исключение, не будет автоматически повторяться. Если в бизнес-логике имеется необработанное исключение, Функции Azure перейдут к обработке следующего изменения. Функция Azure не будут повторять то же неудачное изменение.

Как и в случае с Функциями Azure, разработка с помощью библиотеки обработчика веб-канала изменений очень проста. Однако вы несете ответственность за развертывание одного или нескольких узлов для обработчика веб-канала изменений. Узел — это экземпляр приложения, который использует обработчик канала изменений для прослушивания изменений. Хотя Функции Azure имеют возможности для автоматического масштабирования, ответственность за масштабирование узлов несете вы. Дополнительные сведения см. в статье [Использование обработчика канала изменений](change-feed-processor.md#dynamic-scaling). Библиотека обработчика канала изменений входит в состав [Azure Cosmos DB SDK версии 3](https://github.com/Azure/azure-cosmos-dotnet-v3).

## <a name="reading-change-feed-with-a-pull-model"></a>Чтение канала изменений с помощью модели извлечения

Модель [извлечения веб-канала изменений](change-feed-pull-model.md) позволяет использовать веб-канал изменений в удобном для вас темпе. Клиент должен запросить изменения и не выполнять автоматический опрос изменений. Если вы хотите "запомнить" последнее обработанное изменение (аналогично контейнеру аренды модели принудительной отправки), необходимо [сохранить маркер продолжения](change-feed-pull-model.md#saving-continuation-tokens).

С помощью модели извлечения веб-канала изменений вы получаете более низкий уровень контроля веб-канала изменений. При чтении веб-канала изменений с помощью модели извлечения можно выбрать три варианта:

- Чтение изменений для всего контейнера.
- Чтение изменений для определенного диапазона каналов [FeedRange](change-feed-pull-model.md#using-feedrange-for-parallelization).
- Чтение изменений для определенного значения ключа секции.

Обработку изменений в нескольких клиентах можно параллелизовать так же, как и в случае с обработчиком веб-канала изменений. Однако модель извлечения не поддерживает автоматическую балансировку нагрузки для клиентов. При использовании модели извлечения для параллельной обработки веб-канала изменений сначала необходимо получить список диапазонов FeedRange. Список FeedRange содержит диапазон значений ключа секции. Вам потребуется процесс оркестрации, который получает списки FeedRange и распределяет их между компьютерами. Затем эти списки FeedRange можно использовать, чтобы несколько компьютеров могли параллельно считывать веб-канал изменений.

В модели извлечения не предусмотрена встроенная гарантия доставки "как минимум один раз". Модель извлечения обеспечивает низкоуровневый контроль, позволяя выбрать способ обработки ошибок.

> [!NOTE]
> Модель извлечения веб-канала изменений в настоящее время предоставляется только в [пакете SDK .NET для Azure Cosmos DB и в режиме предварительной версии](https://www.nuget.org/packages/Microsoft.Azure.Cosmos/3.13.0-preview). Для других версий пакета SDK пока недоступна даже предварительная версия.

## <a name="change-feed-in-apis-for-cassandra-and-mongodb"></a>Канал изменений в API-интерфейсах для Cassandra и MongoDB

Функциональность канала изменений отображается как потоки изменений в API MongoDB и запрос с предикатом в API Cassandra. Подробные сведения о реализации API MongoDB см. в разделе [Потоки изменений в API Azure Cosmos DB для MongoDB](mongodb-change-streams.md).

Встроенный API Apache Cassandra обеспечивает отслеживание измененных данных (CDC), механизм пометки определенных таблиц для архивирования, а также отклонения записей в эти таблицы после достижения настраиваемого размера на диске для журнала CDC. Функция канала изменений в API Azure Cosmos DB для Cassandra расширяет возможности запроса изменений с помощью предиката через CQL. Подробные сведения о реализации см. в разделе [Канал изменений в API Azure Cosmos DB для Cassandra](cassandra-change-feed.md).

## <a name="next-steps"></a>Дальнейшие действия

Вы можете продолжить знакомство с каналом изменений, перейдя к следующим статьям:

* [Работа с поддержкой веб-канала изменений в Azure Cosmos DB](change-feed.md)
* [Как использовать канал изменений Azure Cosmos DB с Функциями Azure](change-feed-functions.md)
* [Using the Azure Cosmos DB change feed processor library](change-feed-processor.md) (Использование библиотеки обработчика канала изменений Azure Cosmos DB)
