---
title: Рекомендации для разработчиков. Обеспечение безопасности групп pod в Службе контейнеров Azure (AKS)
description: Рекомендации для разработчиков по защите групп pod в службе контейнеров Azure (AKS)
services: container-service
author: iainfoulds
ms.service: container-service
ms.topic: conceptual
ms.date: 12/06/2018
ms.author: iainfou
ms.openlocfilehash: 412f27c572953b3f44ddca54a99f75895f438f21
ms.sourcegitcommit: b767a6a118bca386ac6de93ea38f1cc457bb3e4e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/18/2018
ms.locfileid: "53559082"
---
# <a name="best-practices-for-pod-security-in-azure-kubernetes-service-aks"></a>Рекомендации по защите групп pod в Службе контейнеров Azure (AKS)

В процессе разработки и выполнения приложений в службе контейнеров Azure (AKS) важно не забывать о безопасности групп pod. Необходимо разработать приложения за принципом минимального количества требуемых привилегий. Защита личных данных играет важнейшую роль для клиентов. Вы вряд ли захотите, чтобы учетные данные, например строки подключения к базам данных, ключи, секреты и сертификаты свободно предоставлялись внешнему миру, где злоумышленники могут использовать их в злонамеренных целях. Не добавляйте учетные данные в код и не внедряйте в образы контейнеров. Такой подход создает риск компрометации и снижает возможность замены учетных данных, так как для этого придется перестраивать образы контейнеров.

Это статья с рекомендациями посвящена защите групп pod в среде AKS. Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * использование контекста безопасности групп pod для ограничения доступа к процессам и службам или повышения привилегий;
> * аутентификация доступа к другим ресурсам Azure с помощью управляемых удостоверений групп pod;
> * запрос и получение учетных данных из цифрового хранилища, например Azure Key Vault.

Вы также можете изучить рекомендации по [безопасности кластера][best-practices-cluster-security] и [управлению образами контейнеров][best-practices-container-image-management].

## <a name="secure-pod-access-to-resources"></a>Защита доступа групп pod к ресурсам

**Наилучший вариант**. Определите параметры безопасности групп pod, чтобы выполнять их от имени другого пользователя (или группы) и ограничить доступ к процессам и службам базового узла. Назначайте минимальное число требуемых привилегий.

Чтобы приложения работали правильно, группы pod следует выполнять от имени определенного пользователя или группы, но не от имени *привилегированного пользователя*. `securityContext` для группы pod или контейнера позволяет определить такие параметры, как *runAsUser* или *fsGroup*, чтобы предоставить соответствующие разрешения. Назначайте только необходимые разрешения для пользователя или группы и не используйте контекст безопасности для предоставления дополнительных разрешений. При выполнении от имени непривилегированного пользователя нельзя привязать контейнеры к привилегированным портам (с номерами менее 1024). В таком сценарии можно скрыть порт, на котором работает приложение, с помощью Службы контейнеров.

Контекст безопасности групп pod позволяет также определить дополнительные возможности или разрешения для доступа к процессами и службами. Вы можете задать следующие типичные определения для контекста безопасности.

* **allowPrivilegeEscalation** определяет, может ли группа pod принимать привилегии *привилегированного пользователя*. Приложения следует разрабатывать так, чтобы этот параметр всегда имел значение *false*.
* **Возможности Linux** разрешают группам pod обращаться к процессам базового узла. Соблюдайте осторожность при назначении таких возможностей. Назначайте минимальное число требуемых привилегий. См. дополнительные сведения о [возможностях Linux][linux-capabilities].
* **Метки SELinux** — это модуль безопасности ядра Linux, который позволяет задать политики доступа для служб, процессов и файловой системы. Как и прежде, назначайте минимальное число требуемых привилегий. Дополнительные сведения см. в описании [параметров SELinux в Kubernetes][selinux-labels]

Следующий пример манифеста YAML для групп pod настраивает следующие параметры контекста безопасности:

* группа pod выполняется как идентификатор пользователя *1000* и относится к группе с идентификатором *2000*;
* повысить привилегии для использования `root` нельзя;
* разрешаются возможности Linux для доступа к сетевым интерфейсам и аппаратным часам реального времени на узле.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: security-context-demo
spec:
  containers:
    - name: security-context-demo
      image: nginx:1.15.5
    securityContext:
      runAsUser: 1000
      fsGroup: 2000
      allowPrivilegeEscalation: false
      capabilities:
        add: ["NET_ADMIN", "SYS_TIME"]
```

Согласуйте с оператором кластера, какие параметры контекста безопасности вам необходимы. Старайтесь спроектировать приложения так, чтобы свести к минимуму требования группы pod к дополнительным разрешениям и правам доступа. Есть несколько дополнительных функций, позволяющих ограничить доступ с помощью AppArmor и seccomp (безопасные вычисления), которые может реализовать оператор кластера. Дополнительные сведения см. в руководстве по [защите доступа контейнера к ресурсам][apparmor-seccomp].

## <a name="limit-credential-exposure"></a>Ограничение уязвимости учетных данных

**Наилучший вариант**. Не определяйте учетные данные в коде приложения. Используйте управляемые удостоверения ресурсов Azure, чтобы позволить группе pod запрашивать доступ к другим ресурсам. Кроме того, для хранения и извлечения цифровых ключей и учетных данных следует применить цифровое хранилище, например Azure Key Vault.

Чтобы ограничить риск раскрытия учетных данных через код приложения, старайтесь не использовать фиксированные или общие учетные данные. Учетные данные и ключи не следует напрямую включать в код. В случае компрометации таких учетных данных вам придется обновлять и заново развертывать приложение. Гораздо лучше предоставить группе pod собственное удостоверение и метод аутентификации или автоматически извлекать учетные данные из цифрового хранилища.

Служба контейнеров Azure поддерживает два способа автоматической аутентификации групп pod или запроса учетных данных и ключей из цифрового хранилища:

* управляемые удостоверения для ресурсов Azure;
* драйвер FlexVol для Azure Key Vault.

### <a name="use-pod-managed-identities"></a>Использование управляемых удостоверений для групп pod

Управляемые удостоверения для ресурсов Azure позволяют группам pod выполнять аутентификацию в любой службе Azure, которая их поддерживает, например в хранилище или службе SQL. Группе pod присваивается удостоверение Azure, которое позволяет проходить аутентификацию Azure Active Directory и получать цифровой маркер. Этот цифровой маркер предоставляется другим службам Azure, которые проверяют авторизацию группы pod для доступа к соответствующей службе и выполнения запрошенных действий. Такой подход позволяет, в частности, не использовать секреты в строках подключения к базам данных. На следующей схеме показан упрощенный рабочий процесс при использовании управляемых удостоверений группы pod:

![Упрощенный рабочий процесс при использовании управляемых удостоверений группы pod в Azure](media/developer-best-practices-pod-security/basic-pod-identity.png)

С управляемым удостоверением вам не придется включать учетные данные в код приложения, чтобы получить доступ к службе, например к службе хранилища Azure. Так как каждая группа pod выполняет аутентификацию со своим удостоверением, вы можете легко проводить аудит и отзывать доступ. Если приложение подключается к другим службам Azure, примените управляемые удостоверения для ограничения риска многократного использования учетных данных и риска раскрытия.

Дополнительные сведения об удостоверениях для групп pod см. в руководствах по [настройке кластера AKS для использования управляемых удостоверений групп pod][aad-pod-identity] и [назначении и использовании управляемых удостоверений групп pod в коде][aad-pod-identity].

### <a name="use-azure-key-vault-with-flexvol"></a>Использование Azure Key Vault с FlexVol

Управляемые удостоверения групп pod отлично подходят для аутентификации во вспомогательных службах Azure. Для собственных служб или приложений, которые не используют управляемые удостоверения для ресурсов Azure, аутентификация по-прежнему осуществляется на основе учетных данных или ключей. Для хранения этих учетных данных можно использовать цифровое хранилище.

Когда приложениям требуются учетные данные, они обращаются в цифровое хранилище и получают последнюю версию учетных данных, а затем подключаются к нужной службе. В качестве цифрового хранилища можно использовать Azure Key Vault. На следующей схеме показан упрощенный рабочий процесс извлечения учетных данных из Azure Key Vault с использованием управляемых удостоверений группы pod:

![Упрощенный рабочий процесс извлечения учетных данных из Key Vault с использованием управляемого удостоверения группы pod](media/developer-best-practices-pod-security/basic-key-vault-flexvol.png)

Key Vault позволяет хранить и регулярно менять секреты, в том числе учетные данные, ключи учетной записи хранения или сертификаты. Azure Key Vault можно интегрировать в кластер Службы контейнеров с помощью FlexVolume. Драйвер FlexVolume позволяет кластеру Службы контейнеров собственными средствами получать учетные данные из Key Vault и безопасно предоставлять их только запрашивающей группе pod. Обратитесь к оператору кластера, чтобы развернуть драйвер FlexVol для Key Vault на узлах Службы контейнеров. Управляемое удостоверение группы pod позволяет запрашивать доступ к Key Vault и получать нужные учетные данные через драйвер FlexVolume.

## <a name="next-steps"></a>Дополнительная информация

Эта статья была посвящена вопросам, связанным с безопасностью групп pod. Для реализации части этих рекомендаций требуются сведения, опубликованных в следующих статьях:

* [Использование управляемых удостоверений для ресурсов Azure с AKS][aad-pod-identity]
* [Интеграция Azure Key Vault со Службой контейнеров Azure][aks-keyvault-flexvol]

<!-- EXTERNAL LINKS -->
[aad-pod-identity]: https://github.com/Azure/aad-pod-identity#demo-pod
[aks-keyvault-flexvol]: https://github.com/Azure/kubernetes-keyvault-flexvol
[linux-capabilities]: http://man7.org/linux/man-pages/man7/capabilities.7.html
[selinux-labels]: https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#selinuxoptions-v1-core

<!-- INTERNAL LINKS -->
[best-practices-cluster-security]: operator-best-practices-cluster-security.md
[best-practices-container-image-management]: operator-best-practices-container-image-management.md
[aks-pod-identities]: operator-best-practices-identity.md#use-pod-identities
[apparmor-seccomp]: operator-best-practices-cluster-security.md#secure-container-access-to-resources
