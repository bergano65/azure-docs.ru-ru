---
title: Настройка определяемых пользователем маршрутов в службе Azure Kubernetes (AKS)
description: Узнайте, как определить пользовательский маршрут исходящего трафика в службе Azure Kubernetes (AKS)
services: container-service
ms.topic: article
ms.date: 06/29/2020
ms.openlocfilehash: 103d7dc76dee56a336f08f2cc0c7c8489c0bc565
ms.sourcegitcommit: 99955130348f9d2db7d4fb5032fad89dad3185e7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2020
ms.locfileid: "93348140"
---
# <a name="customize-cluster-egress-with-a-user-defined-route"></a>Настройка исходящего трафика кластера с помощью User-Defined маршрута

Исходящий трафик из кластера AKS можно настроить в соответствии с конкретными сценариями. По умолчанию AKS будет подготавливать Стандартный номер SKU Load Balancer, который будет настроен и использован для исходящего трафика. Однако настройка по умолчанию может не соответствовать требованиям всех сценариев, если общедоступные IP-адреса запрещены или для исходящего трафика требуются дополнительные прыжки.

В этой статье описывается настройка маршрута исходящего трафика кластера для поддержки пользовательских сетевых сценариев, например тех, которые запрещают использование общедоступных IP-адресов и требуют наличия кластера за сетевым виртуальным устройством (NVA).

## <a name="prerequisites"></a>Предварительные требования
* Интерфейс командной строки Azure 2.0.81 или более поздней версии
* Версия API `2020-01-01` или выше


## <a name="limitations"></a>Ограничения
* Аутбаундтипе можно определить только во время создания кластера и не может быть обновлено позже.
* Для настройки `outboundType` требуются кластеры AKS с `vm-set-type` `VirtualMachineScaleSets` и `load-balancer-sku` `Standard`.
* Чтобы задать для `outboundType` значение `UDR`, необходимо использовать определяемый пользователем маршрут с действительными исходящими подключениями для кластера.
* Если для `outboundType` задано значение `UDR`, это подразумевает, что исходный IP-адрес входящего трафика, маршрутизируемого на балансировщик нагрузки, может **не соответствовать** конечному адресу исходящего трафика кластера.

## <a name="overview-of-outbound-types-in-aks"></a>Общие сведения о типах исходящих подключений в AKS

Кластер AKS можно настроить с помощью уникального `outboundType` типа `loadBalancer` или `userDefinedRouting` .

> [!IMPORTANT]
> Тип исходящего трафика влияет только на исходящий трафик кластера. Дополнительные сведения см. в разделе Настройка входных [контроллеров](ingress-basic.md).

> [!NOTE]
> Вы можете использовать собственную [таблицу маршрутов][byo-route-table] с сетями UDR и кубенет. Убедитесь, что удостоверение кластера (субъект-служба или управляемое удостоверение) имеет разрешения участника для таблицы настраиваемых маршрутов.

### <a name="outbound-type-of-loadbalancer"></a>Тип исходящего трафика балансировщика нагрузки

Если `loadBalancer` задано значение, AKS автоматически выполняет следующую настройку. Балансировщик нагрузки используется для исходящего трафика через назначенный общедоступный IP-адрес AKS. Тип исходящего трафика `loadBalancer` поддерживает службы Kubernetes типа `loadBalancer`, которые ожидают исходящий трафик из балансировщика нагрузки, созданного поставщиком ресурсов AKS.

Следующая конфигурация выполняется с помощью AKS.
   * Общедоступный IP-адрес подготавливается для исходящего трафика кластера.
   * Общедоступный IP-адрес назначается ресурсу балансировщика нагрузки.
   * Серверные пулы для подсистемы балансировки нагрузки настраиваются для узлов агентов в кластере.

Ниже приведена топология сети, развернутая в кластерах AKS по умолчанию, которая использует `outboundType` `loadBalancer`.

![На схеме показаны входящие и исходящие данные i p, в которых входящий трафик I P направлен на подсистему балансировки нагрузки, которая направляет трафик из внутреннего кластера в другой и т. д., который направляет трафик в Интернет, M C R, требуемые службы Azure и элемент управления K S.](media/egress-outboundtype/outboundtype-lb.png)

### <a name="outbound-type-of-userdefinedrouting"></a>Тип исходящего трафика userDefinedRouting

> [!NOTE]
> Использование типа исходящего трафика является сложным сетевым сценарием и требует правильной настройки сети.

Если `userDefinedRouting` задано значение, AKS не будет автоматически настраивать пути выхода. Настройка исходящего трафика должна быть выполнена вами.

Кластер AKS должен быть развернут в существующей виртуальной сети с подсетью, которая ранее была настроена, так как при отсутствии использования архитектуры "Стандартный балансировщик нагрузки" (SLB) необходимо установить явный выход. Таким образом, для этой архитектуры требуется явная отправка исходящего трафика на устройство, например брандмауэр, шлюз, прокси-сервер или разрешение преобразования сетевых адресов (NAT) с помощью общедоступного IP-адреса, назначенного стандартному балансировщик нагрузки или устройству.

#### <a name="load-balancer-creation-with-userdefinedrouting"></a>Создание подсистемы балансировки нагрузки с помощью Усердефинедраутинг

Кластеры AKS с типом исходящего трафика UDR получают стандартную подсистему балансировки нагрузки (SLB) только при развертывании первой службы Kubernetes типа "Balance". Подсистема балансировки нагрузки настроена с общедоступным IP-адресом для *входящих* запросов и внутренним пулом для *входящих* запросов. Правила для входящих подключений настраиваются поставщиком облачных служб Azure, но **ни один исходящий общедоступный IP-адрес или правила для исходящих подключений не** настроены в результате наличия исходящего типа UDR. UDR по-прежнему будет единственным источником исходящего трафика.

Подсистемы балансировки нагрузки Azure [не взимается до тех пор, пока не будет помещено правило](https://azure.microsoft.com/pricing/details/load-balancer/).

## <a name="deploy-a-cluster-with-outbound-type-of-udr-and-azure-firewall"></a>Развертывание кластера с типом исходящего трафика UDR и брандмауэром Azure

Чтобы проиллюстрировать применение кластера с типом исходящего трафика с помощью определяемого пользователем маршрута, можно настроить кластер в виртуальной сети с помощью брандмауэра Azure в своей подсети. См. Этот пример в [примере ограничения трафика с помощью брандмауэра Azure](limit-egress-traffic.md#restrict-egress-traffic-using-azure-firewall).

> [!IMPORTANT]
> Для исходящего типа UDR требуется маршрут для 0.0.0.0/0 и назначения следующего прыжка NVA (сетевого виртуального модуля) в таблице маршрутов.
> Таблица маршрутов уже имеет значение по умолчанию 0.0.0.0/0 для Интернета, без общедоступного IP-адреса для SNAT. только что добавление этого маршрута не даст вам исходящего трафика. AKS проверит, что вы не создадите маршрут 0.0.0.0/0, указывающий на Интернет, а не NVA, шлюз и т. д. При использовании исходящего типа UDR общедоступный IP-адрес подсистемы балансировки нагрузки для **входящих запросов** не создается, если *не настроена служба типа "* балансировщик". Общедоступный IP-адрес для **исходящих запросов** никогда не создается с помощью AKS, если задан тип исходящего трафика UDR.

## <a name="next-steps"></a>Дальнейшие действия

См. раздел [Обзор сетевой UDR Azure](../virtual-network/virtual-networks-udr-overview.md).

См. раздел [Сведения о создании, изменении и удалении таблицы маршрутизации](../virtual-network/manage-route-table.md).

<!-- LINKS - internal -->
[az-aks-get-credentials]: /cli/azure/aks?view=azure-cli-latest#az-aks-get-credentials
[byo-route-table]: configure-kubenet.md#bring-your-own-subnet-and-route-table-with-kubenet
