---
title: Размещение группы PostgreSQL Scale Server на узлах кластера Kubernetes
description: Объясняется, как экземпляры PostgreSQL, формирующие PostgreSQLную группу серверов, размещаются на узлах кластера Kubernetes.
services: azure-arc
ms.service: azure-arc
ms.subservice: azure-arc-data
author: TheJY
ms.author: jeanyd
ms.reviewer: mikeray
ms.date: 09/22/2020
ms.topic: how-to
ms.openlocfilehash: 5da00916a3f7a6a3685b1de1c56dd032355e28fa
ms.sourcegitcommit: 53acd9895a4a395efa6d7cd41d7f78e392b9cfbe
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/22/2020
ms.locfileid: "90938748"
---
# <a name="azure-arc-enabled-postgresql-hyperscale-server-group-placement"></a>Размещение группы серверов PostgreSQL в службе "Дуга Azure" с поддержкой масштабирования

В этой статье мы рассмотрим пример того, как на физических узлах кластера Kubernetes, на котором размещены эти экземпляры PostgreSQL, PostgreSQL на физические узлы кластеров с включенной службой "геомасштабирование Azure". 

[!INCLUDE [azure-arc-data-preview](../../../includes/azure-arc-data-preview.md)]

## <a name="configuration"></a>Конфигурация

В этом примере мы используем кластер Azure Kubernetes Service (AKS) с четырьмя физическими узлами. 

:::image type="content" source="media/migrate-postgresql-data-into-postgresql-hyperscale-server-group/1_cluster_portal.png" alt-text="кластер AKS с 4 узлами в портал Azure":::

Перечислите физические узлы кластера Kubernetes, выполнив команду:

```console
kubectl get nodes
```

В котором показаны четыре физических узла в кластере Kubernetes:

```output
NAME                                STATUS   ROLES   AGE   VERSION
aks-agentpool-42715708-vmss000000   Ready    agent   11h   v1.17.9
aks-agentpool-42715708-vmss000001   Ready    agent   11h   v1.17.9
aks-agentpool-42715708-vmss000002   Ready    agent   11h   v1.17.9
aks-agentpool-42715708-vmss000003   Ready    agent   11h   v1.17.9
```

Архитектура может быть представлена следующим образом:

:::image type="content" source="media/migrate-postgresql-data-into-postgresql-hyperscale-server-group/2_logical_cluster.png" alt-text="Логическое представление 4 узлов, сгруппированных в кластере Kubernetes":::

В кластере Kubernetes размещается один контроллер данных ARC в Azure и одна группа PostgreSQL Scale. Эта группа серверов состоит из трех экземпляров PostgreSQL: одного координатора и двух рабочих ролей.

Выведите список модулей Pod с помощью команды:

```console
kubectl get pods -n arc3
```
В результате будут возвращены следующие выходные данные:

```output
NAME                 READY   STATUS    RESTARTS   AGE
…
postgres01-0         3/3     Running   0          9h
postgres01-1         3/3     Running   0          9h
postgres01-2         3/3     Running   0          9h
```
Каждый из этих модулей Pod размещает экземпляр PostgreSQL. Вместе они формируют группу серверов PostgreSQL в службе "Дуга Azure Enabled".

```output
Pod name    Role in the server group
postgres01-0            Coordinator
postgres01-1    Worker
postgres01-2    Worker
```

## <a name="placement"></a>Размещение
Рассмотрим, как Kubernetes помещает модули из группы серверов. Опишите каждый модуль и выясните, на каком физическом узле кластера Kubernetes они размещены. Например, для координатора выполните следующую команду:

```console
kubectl describe pod postgres01-0 -n arc3
```

В результате будут возвращены следующие выходные данные:

```output
Name:         postgres01-0
Namespace:    arc3
Priority:     0
Node:         aks-agentpool-42715708-vmss000000
Start Time:   Thu, 17 Sep 2020 00:40:33 -0700
…
```

По мере выполнения этой команды для каждого из модулей, мы будем суммировать текущее размещение следующим образом:

| Роль группы серверов|Модуль группы серверов|Физический узел Kubernetes, на котором размещен модуль |
|--|--|--|
| Рабочий узел|postgres01-1|AKS-ажентпул-42715708-vmss000002 |
| Рабочий узел|postgres01-2|AKS-ажентпул-42715708-vmss000003 |

Кроме того, обратите внимание, что в описании модулей Pod имена контейнеров, размещаемых каждым из них. Например, для второго рабочего процесса выполните следующую команду:

```console
kubectl describe pod postgres01-2 -n arc3
```

В результате будут возвращены следующие выходные данные:

```output
…
Node:         aks-agentpool-42715708-vmss000003/10.240.0.7
..
Containers:
  Fluentbit:
…
  Postgres:
…
  Telegraf:
…
```

Каждый модуль, входящий в состав группы серверов PostgreSQL в службе "Дуга Azure", содержит следующие три контейнера:

|Контейнеры|Описание
|----|----|
|`Fluentbit` |Сборщик данных *: https://fluentbit.io/
|`Postgres`|Экземпляр PostgreSQL, который входит в состав Postgresqlной группы серверов "Дуга Azure"
|`Telegraf` |Сборщик метрик: https://www.influxdata.com/time-series-platform/telegraf/

Архитектура выглядит следующим образом:

:::image type="content" source="media/migrate-postgresql-data-into-postgresql-hyperscale-server-group/3_pod_placement.png" alt-text="3 модули, каждая из которых размещена на отдельных узлах":::

Это означает, что на этом этапе каждый экземпляр PostgreSQL, образующей группу комасштабируемых серверов в Azure Arc, размещается на определенном физическом узле в контейнере Kubernetes. Это лучшая конфигурация, которая позволяет максимально эффективно использовать группу серверов PostgreSQL с поддержкой дуги Azure, так как каждая роль (координатор и рабочие роли) использует ресурсы каждого физического узла. Эти ресурсы не являются общими для нескольких PostgreSQL ролей.

## <a name="scale-out-azure-arc-enabled-postgresql-hyperscale"></a>Масштабирование PostgreSQL для дуги Azure с поддержкой масштабирования

Теперь выполним масштабирование, чтобы добавить третий рабочий узел в группу серверов и определить, что произойдет. Он создаст Четвертый экземпляр PostgreSQL, который будет размещен в четвертом модуле.
Чтобы выполнить масштабирование, выполните команду:

```console
azdata arc postgres server edit --name postgres01 --workers 3
```

В результате получается следующий результат:

```output
Updating postgres01 in namespace `arc3`
postgres01 is Ready
```

Перечислите группы серверов, развернутые в контроллере данных ARC в Azure, и убедитесь, что группа серверов теперь работает с тремя рабочими ролями. Выполните приведенную ниже команду.

```console
azdata arc postgres server list
```

И проследите за тем, чтобы она выполняла масштабирование от двух рабочих ролей до трех.

```output
Name        State    Workers
----------  -------  ---------
postgres01  Ready    3
```

Как мы делали раньше, обратите внимание, что теперь группа серверов использует четыре модуля:

```console
kubectl get pods -n arc3
```

```output
NAME                 READY   STATUS    RESTARTS   AGE
…
postgres01-0         3/3     Running   0          11h
postgres01-1         3/3     Running   0          11h
postgres01-2         3/3     Running   0          11h
postgres01-3         3/3     Running   0          5m2s
```

И опишите новый модуль, определяющий, на каких физических узлах кластера Kubernetes он размещается.
Выполните приведенную ниже команду.

```console
kubectl describe pod postgres01-3 -n arc3
```

Чтобы узнать имя узла размещения, выполните следующие действия.

```output
Name:         postgres01-3
Namespace:    arc3
Priority:     0
Node:         aks-agentpool-42715708-vmss000000
```

Размещение экземпляров PostgreSQL на физических узлах кластера теперь:

|Роль группы серверов|Модуль группы серверов|Физический узел Kubernetes, на котором размещен модуль
|-----|-----|-----
|Распределен|postgres01-0|AKS-ажентпул-42715708-vmss000000
|Рабочий узел|postgres01-1|AKS-ажентпул-42715708-vmss000002
|Рабочий узел|postgres01-2|AKS-ажентпул-42715708-vmss000003
|Рабочий узел|postgres01-3|AKS-ажентпул-42715708-vmss000000

И обратите внимание, что модуль нового рабочего процесса (postgres01-3) был размещен на том же узле, что и координатор. 

Архитектура выглядит следующим образом:

:::image type="content" source="media/migrate-postgresql-data-into-postgresql-hyperscale-server-group/4_pod_placement_.png" alt-text="Четвертый модуль на том же узле, что и координатор":::

Почему новый исполнитель или модуль не помещается на оставшийся физический узел кластера Kubernetes AKS-ажентпул-42715708-vmss000003?

Причина заключается в том, что на последнем физическом узле кластера Kubernetes на самом деле размещено несколько модулей, в которых размещены дополнительные компоненты, необходимые для запуска служб данных, поддерживающих службу Arc Azure. Kubernetes оценивает, что лучшим кандидатом — в момент планирования — для размещения дополнительного работника — это физический узел AKS-ажентпул-42715708-vmss000000. 

Используйте те же команды, что и выше; Мы видим, что размещает каждый физический узел:

|Другие имена модулей Pod\* |Использование|Физический узел Kubernetes, на котором размещены модули
|----|----|----
|начальный загрузчик — jh48b||AKS-ажентпул-42715708-vmss000003
|Control-гвмбс||AKS-ажентпул-42715708-vmss000002
|контролдб-0||AKS-ажентпул-42715708-vmss000001
|контролвд — zzjp7||AKS-ажентпул-42715708-vmss000000
|логсдб-0|Elasticsearch, получает данные из `Fluentbit` контейнера каждого Pod|AKS-ажентпул-42715708-vmss000003
|логсуи — 5fzv5||AKS-ажентпул-42715708-vmss000003
|метриксдб-0|InfluxDB, получает данные из `Telegraf` контейнера каждого Pod|AKS-ажентпул-42715708-vmss000000
|метриксдк — 47d47||AKS-ажентпул-42715708-vmss000002
|метриксдк — 864kj||AKS-ажентпул-42715708-vmss000001
|метриксдк — l8jkf||AKS-ажентпул-42715708-vmss000003
|метриксдк — nxm4l||AKS-ажентпул-42715708-vmss000000
|метриксуи — 4fb7l||AKS-ажентпул-42715708-vmss000003
|мгмтпрокси — 4qppp||AKS-ажентпул-42715708-vmss000002

> \* Суффиксы в именах модулей будут отличаться в зависимости от других развертываний. Кроме того, здесь перечислены только модули Pod, размещенные в пространстве имен Kubernetes контроллера данных Arc Azure.

Архитектура выглядит следующим образом:

:::image type="content" source="media/migrate-postgresql-data-into-postgresql-hyperscale-server-group/5_full_list_of_pods.png" alt-text="Все модули Pod в пространстве имен на различных узлах":::

Это означает, что узлы координатора (Pod 1) для группы серверов postgres в службе "Дуга Azure" используют те же физические ресурсы, что и третий рабочий узел (Pod 4) группы серверов. Это допустимо, так как узел координатор обычно использует очень небольшие ресурсы в сравнении с тем, что может использоваться рабочим узлом. В этом случае вы можете определить, что следует тщательно выбрать:
- Размер кластера Kubernetes и характеристики каждого из его физических узлов (память, виртуальное ядро)
- число физических узлов в кластере Kubernetes
- приложения или рабочие нагрузки, размещенные в кластере Kubernetes.

При размещении слишком большого количества рабочих нагрузок в кластере Kubernetes может произойти регулирование для группы серверов PostgreSQL в службе "Дуга" с поддержкой дуги Azure. В таком случае вам не придется выполнять масштабирование по горизонтали. Производительность, получаемая из системы, не только заключается в размещении или физических характеристиках физических узлов или системы хранения. Производительность, которую вы получаете, также связана с настройкой каждого из ресурсов, которые выполняются в кластере Kubernetes (в том числе с помощью PostgreSQLного масштабирования Azure), например запросов и ограничений, заданных для памяти и виртуальное ядро. Объем рабочей нагрузки, которую можно разместить в данном кластере Kubernetes, зависит от характеристик кластера Kubernetes, природы рабочих нагрузок, числа пользователей, способа выполнения операций кластера Kubernetes...

## <a name="scale-out-aks"></a>Масштабирование AKS

Давайте продемонстрируем, что масштабирование по горизонтали: как кластер AKS, так и служба "Дуга Azure", включенная в PostgreSQL.
Добавим пятый узел в кластер AKS:

:::row:::
    :::column:::
        До
    :::column-end:::
    :::column:::
        После
    :::column-end:::
:::row-end:::
:::row:::
    :::column:::
        :::image type="content" source="media/migrate-postgresql-data-into-postgresql-hyperscale-server-group/6_layout_before.png" alt-text="портал Azure макет до":::
    :::column-end:::
    :::column:::
        :::image type="content" source="media/migrate-postgresql-data-into-postgresql-hyperscale-server-group/7_layout_after.png" alt-text="портал Azure макет после":::
    :::column-end:::
:::row-end:::

Архитектура выглядит следующим образом:

:::image type="content" source="media/migrate-postgresql-data-into-postgresql-hyperscale-server-group/8_logical_layout_after.png" alt-text="Логическая структура в кластере Kubernetes после обновления":::

Давайте посмотрим, какие модули пространства имен ARC для контроллера данных размещаются на новом физическом узле AKS, выполнив команду:

```console
kubectl describe node aks-agentpool-42715708-vmss000004
```

А теперь изменим представление архитектуры нашей системы:

:::image type="content" source="media/migrate-postgresql-data-into-postgresql-hyperscale-server-group/9_updated_list_of_pods.png" alt-text="Все модули Pod на логической схеме кластера":::

Мы можем заметить, что новый физический узел кластера Kubernetes размещает только тот модуль метрик, который необходим для служб данных Azure ARC. Обратите внимание, что в этом примере основное внимание уделяется только пространству имен контроллера данных ARC. Другие модули не представляют собой другие модули.

## <a name="scale-out-azure-arc-enabled-postgresql-hyperscale-again"></a>Повторное масштабирование дуги Azure с включенной PostgreSQL

Пятый физический узел еще не размещен ни в одной рабочей нагрузке. При горизонтальном масштабировании PostgreSQLного масштабирования Azure Kubernetes оптимизирует размещение нового модуля PostgreSQL и не должен размещать его на физических узлах, где уже размещены дополнительные рабочие нагрузки. Выполните следующую команду, чтобы масштабировать PostgreSQLную службу "Дуга Azure" с 3 до 4 рабочих ролей. По завершении операции группа серверов будет составляться и распределяться по пяти экземплярам PostgreSQL, одному координатору и четырем рабочим процессам.

```console
azdata arc postgres server edit --name postgres01 --workers 4
```

В результате получается следующий результат:

```output
Updating postgres01 in namespace `arc3`
postgres01 is Ready
```

Перечислите группы серверов, развернутые в контроллере данных, и убедитесь, что группа серверов теперь работает с четырьмя рабочими процессами:

```console
azdata arc postgres server list
```

И следить за масштабированием от трех до четырех рабочих ролей. 

```console
Name        State    Workers
----------  -------  ---------
postgres01  Ready    4
```

Как мы делали ранее, обратите внимание, что в группе серверов используется четыре модуля:

```output
kubectl get pods -n arc3

NAME                 READY   STATUS    RESTARTS   AGE
…
postgres01-0         3/3     Running   0          13h
postgres01-1         3/3     Running   0          13h
postgres01-2         3/3     Running   0          13h
postgres01-3         3/3     Running   0          179m
postgres01-4         3/3     Running   0          3m13s
```

Теперь форма группы серверов:

|Роль группы серверов|Модуль группы серверов
|----|-----
|Распределен|postgres01-0
|Рабочий узел|postgres01-1
|Рабочий узел|postgres01-2
|Рабочий узел|postgres01-3
|Рабочий узел|postgres01-4

Давайте Опишите модуль postgres01-4, чтобы определить, на каком физическом узле он размещен:

```console
kubectl describe pod postgres01-4 -n arc3
```

И обратите внимание на то, какие модули в нем выполняются:

|Роль группы серверов|Модуль группы серверов| Pod
|----|-----|------
|Распределен|postgres01-0|AKS-ажентпул-42715708-vmss000000
|Рабочий узел|postgres01-1|AKS-ажентпул-42715708-vmss000002
|Рабочий узел|postgres01-2|AKS-ажентпул-42715708-vmss000003
|Рабочий узел|postgres01-3|AKS-ажентпул-42715708-vmss000000
|Рабочий узел|postgres01-4|AKS-ажентпул-42715708-vmss000004

Архитектура выглядит следующим образом:

:::image type="content" source="media/migrate-postgresql-data-into-postgresql-hyperscale-server-group/10_kubernetes_schedules_newest_pod.png" alt-text="Kubernetes планирует новейшие модульные работы в узле с самым низким уровнем использования":::

Kubernetes запланировал новый модуль PostgreSQL на наименее загруженном физическом узле кластера Kubernetes.

## <a name="summary"></a>Сводка

Чтобы максимально эффективно использовать масштабируемость и производительность масштабирования группы серверов с поддержкой ARC в Azure по горизонтали, следует избегать состязаний за ресурсы в кластере Kubernetes:
- между PostgreSQLной группой серверов "Дуга Azure" и другими рабочими нагрузками, размещенными в том же кластере Kubernetes
- между всеми экземплярами PostgreSQL, составляющими группу серверов PostgreSQL Scale, включенной в дугу Azure.

Это можно сделать несколькими способами.
- Масштабирование как Kubernetes, так и дуги Azure с Postgres масштабированием. Рассмотрите возможность масштабирования по горизонтали в кластере Kubernetes так же, как при масштабировании группы серверов с поддержкой службы "Дуга Azure" PostgreSQL. Добавьте физический узел в кластер для каждого рабочего процесса, добавляемого в группу серверов.
- Масштабирование дуги Azure с включенной функцией масштабирования postgres без масштабирования Kubernetes: путем установки правильных ограничений ресурсов (запросов и ограничений в памяти и виртуальное ядро) на рабочих нагрузках, размещенных в Kubernetes (включенная в состав Azure Arc PostgreSQL Scale), вы сможете совместно использовать рабочие нагрузки на Kubernetes и снизить риск конфликтов ресурсов. Необходимо убедиться, что физические характеристики физических узлов кластера Kubernetes могут учитывать определенные вами ограничения ресурсов. Также следует убедиться, что равновесия остается в процессе развития рабочих нагрузок со временем или при добавлении дополнительных рабочих нагрузок в кластер Kubernetes.
- Используйте механизмы Kubernetes (селектор Pod, сходство, сглаживание), чтобы повлиять на размещение модулей.

## <a name="next-steps"></a>Дальнейшие действия

[Масштабирование группы масштабируемых серверов PostgreSQL в службе "Дуга Azure" путем добавления дополнительных рабочих узлов](scale-out-postgresql-hyperscale-server-group.md)
