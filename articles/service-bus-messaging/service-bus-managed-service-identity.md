---
title: Управляемые удостоверения для ресурсов Azure со Служебной шиной Azure (предварительная версия) | Документация Майкрософт
description: Использование управляемых удостоверений для ресурсов Azure со Служебной шиной Azure
services: service-bus-messaging
documentationcenter: na
author: spelluru
manager: timlt
editor: ''
ms.assetid: ''
ms.service: service-bus-messaging
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 09/01/2018
ms.author: spelluru
ms.openlocfilehash: 25d2db5dcf3979341fc104643f7178047c29483b
ms.sourcegitcommit: 11d8ce8cd720a1ec6ca130e118489c6459e04114
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/04/2018
ms.locfileid: "52842838"
---
# <a name="managed-identities-for-azure-resources-with-service-bus"></a>Управляемые удостоверения для ресурсов Azure со служебной шиной 

[Управляемые удостоверения для ресурсов Azure](../active-directory/managed-identities-azure-resources/overview.md) — это функция Azure, которая позволяет создавать удостоверения безопасности, связанные с развертыванием, в рамках которого выполняется код приложения. Затем можно связать этот идентификатор с ролями управления доступом, предоставляющими настраиваемые разрешения для доступа к определенным ресурсам Azure, необходимым приложению.

С помощью управляемых удостоверений платформа Azure управляет этим идентификатором среды выполнения. Ключи доступа не нужно хранить и защищать в коде приложений или конфигурации ни для удостоверения, ни для ресурсов, к которым необходимо получить доступ. Клиентскому приложению "Служебная шина Azure", которое выполняется в приложении Службы приложений Azure или на виртуальной машине с включенной поддержкой управляемых удостоверений для ресурсов Azure, не нужно обрабатывать правила и ключи SAS или любые другие маркеры доступа. Клиентскому приложению достаточно только адреса конечной точки пространства имен служебной шины для обмена сообщениями. При подключении приложения служебная шина привязывает контекст управляемого удостоверения к клиенту в операции, показанной в примере далее в этой статье. Как только он будет связан с управляемым удостоверением, клиент Служебной шины Azure сможет выполнять все авторизованные операции. Авторизация выполняется путем привязывания управляемого удостоверения к ролям служебной шины. 

## <a name="service-bus-roles-and-permissions"></a>Роли и разрешения служебной шины

Управляемое удостоверение можно добавить только к ролям пространства имен служебной шины "Владелец" или "Участник". Благодаря этому ко всем сущностям в пространстве имен предоставляется полный доступ. Однако операции управления, изменяющие топологию пространства имен, изначально поддерживаются только через Azure Resource Manager. Они не поддерживаются через собственный интерфейс управления REST для служебной шины. Эта поддержка также означает, что в управляемом удостоверении нельзя использовать объект [NamespaceManager](/dotnet/api/microsoft.servicebus.namespacemanager) клиента .NET Framework.

## <a name="use-service-bus-with-managed-identities-for-azure-resources"></a>Использование служебной шины с управляемыми удостоверениями для ресурсов Azure

В следующем разделе описано, как создать и развернуть пример приложения, выполняющегося с использованием управляемого удостоверения службы, как предоставить удостоверению доступ к пространству имен служебной шины и как приложение взаимодействует с сущностями служебной шины через этот идентификатор.

В этом обзоре описано веб-приложение, размещенное в [службе приложений Azure](https://azure.microsoft.com/services/app-service/). Шаги для приложения, размещенного на виртуальной машине, аналогичны.

### <a name="create-an-app-service-web-application"></a>Создание веб-приложения службы приложений

Первым шагом является создание приложения ASP.NET службы приложения. Если вы не знаете, как это сделать в Azure, ознакомьтесь с [этим руководством](../app-service/app-service-web-get-started-dotnet-framework.md). Однако вместо того, чтобы создавать приложение MVC, как показано в этом руководстве, создайте приложение веб-форм.

### <a name="set-up-the-managed-identity"></a>Настройка управляемого удостоверения

После создания приложения перейдите к только что созданному веб-приложению на портале Azure (также отображается в практическом руководстве), а затем перейдите на страницу **Управляемое удостоверение службы** и включите возможность: 

![](./media/service-bus-managed-service-identity/msi1.png)

После включения возможности в Azure Active Directory будет создано удостоверение службы и настроено в узле службы приложений.

### <a name="create-a-new-service-bus-messaging-namespace"></a>Создание пространства имен служебной шины, предназначенного для обмена сообщениями

Далее [создайте пространство имен служебной шины, предназначенное для обмена сообщениями](service-bus-create-namespace-portal.md), в одном из регионов Azure с поддержкой предварительной версии для RBAC: **восточная часть США**, **восточная часть США 2** или **Западная Европа**. 

Перейдите к пространству имен на странице **Служба контроля доступа (IAM)** на портале и щелкните **Добавить назначение ролей**, чтобы добавить управляемое удостоверение к роли **Владелец**. Для этого найдите название веб-приложения на панели **Добавление разрешений** в поле **Select** (Выбор), а затем щелкните запись. Нажмите кнопку **Сохранить**.

Теперь управляемое удостоверение службы веб-приложения имеет доступ к пространству имен служебной шины и к ранее созданной очереди. 

### <a name="run-the-app"></a>Запуск приложения

Теперь можно изменить стандартную страницу созданного вами приложения ASP.NET. Вы можете использовать код веб-приложения из этого [репозитория GitHub](https://github.com/Azure-Samples/app-service-msi-servicebus-dotnet).  

Страница Default.aspx является целевой. Код можно найти в файле Default.aspx.cs. В результате вы получите самое простое веб-приложение с несколькими полями для ввода и кнопками **отправки** и **получения**, которые позволяют отправить сообщения в служебную шину или получить их оттуда.

Обратите внимание, как инициализируется объект [MessagingFactory](/dotnet/api/microsoft.servicebus.messaging.messagingfactory). Вместо того чтобы использовать поставщик общих маркеров доступа (SAS), код создает поставщик маркеров для управляемого удостоверения с помощью вызова `TokenProvider.CreateManagedServiceIdentityTokenProvider(ServiceAudience.ServiceBusAudience)`. Таким образом, нет никаких секретов для хранения и использования. Поток контекста управляемого удостоверения службы в служебную шину и подтверждение авторизации автоматически обрабатываются поставщиком маркеров. Это является более простой моделью, чем использование SAS.

После внесения этих изменений опубликуйте и запустите приложение. Чтобы получить правильные данные публикации, скачайте их, а затем импортируйте профиль публикации в Visual Studio.

![](./media/service-bus-managed-service-identity/msi3.png)
 
Чтобы отправлять или получать сообщения, введите имя пространства имен и имя созданной сущности. Затем нажмите кнопки **Отправить** или **Получить**.


> [!NOTE]
> - Управляемое удостоверение работает только в среде Azure, в службах приложений, на виртуальных машинах Azure и масштабируемых наборах. Для приложений .NET библиотека Microsoft.Azure.Services.AppAuthentication, которая используется пакетом NuGet служебной шины, предоставляет абстракцию этого протокола и поддерживает локальную разработку. Эта библиотека также позволяет локально тестировать код на компьютере разработки с использованием учетной записи пользователя из Visual Studio, Azure CLI 2.0 или встроенной проверки подлинности Active Directory. Дополнительные сведения о параметрах локальной разработки с помощью этой библиотеки см. в руководстве по [аутентификации между службами в Azure Key Vault с использованием .NET](../key-vault/service-to-service-authentication.md).  
> 
> - Сейчас эти удостоверения не работают со слотами развертывания Службы приложений Azure.

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения об обмене сообщениями через служебную шину см. в следующих статьях:

* [Очереди, разделы и подписки служебной шины](service-bus-queues-topics-subscriptions.md)
* [Начало работы с очередями служебной шины](service-bus-dotnet-get-started-with-queues.md)
* [Как использовать разделы и подписки служебной шины](service-bus-dotnet-how-to-use-topics-subscriptions.md)