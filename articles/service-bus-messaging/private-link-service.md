---
title: Интеграция Служебной шины Azure со службой "Приватный канал Azure"
description: Узнайте, как интегрировать Служебную шину Azure со службой "Приватный канал Azure"
author: spelluru
ms.author: spelluru
ms.date: 06/23/2020
ms.topic: article
ms.openlocfilehash: 4f3b67794d1a7f3935c79c70f18b8bd4a1e0d7ef
ms.sourcegitcommit: 6fc156ceedd0fbbb2eec1e9f5e3c6d0915f65b8e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2020
ms.locfileid: "88716628"
---
# <a name="allow-access-to-azure-service-bus-namespaces-via-private-endpoints"></a>Разрешение доступа к пространствам имен служебной шины Azure через частные конечные точки

Приватный канал Azure обеспечивает доступ к службам Azure (например, к Служебной шине Azure, службе хранилища Azure и Azure Cosmos DB), а также размещенным в Azure службам клиентов или партнеров через **частную конечную точку** в виртуальной сети.

Частная конечная точка — это сетевой интерфейс, который защищенно и надежно подключается к службе через Приватный канал Azure. Частная конечная точка использует частный IP-адрес из виртуальной сети, по сути перемещая службу в виртуальную сеть. Весь трафик к службе может маршрутизироваться через частную конечную точку, поэтому шлюзы, устройства преобразования сетевых адресов (NAT), подключения ExpressRoute и VPN, а также общедоступные IP-адреса не требуются. Трафик между виртуальной сетью и службой проходит через магистральную сеть Майкрософт, что позволяет избежать рисков общедоступного Интернета. Вы можете подключиться к экземпляру ресурса Azure, обеспечивая наивысшую степень детализации в управлении доступом.

Дополнительные сведения см. в статье [Что такое Приватный канал Azure](../private-link/private-link-overview.md).

>[!WARNING]
> Реализация частных конечных точек может предотвратить взаимодействие других служб Azure со Служебной шиной.
>
> Доверенные службы Майкрософт не поддерживаются при использовании виртуальных сетей.
>
> Распространенные сценарии Azure, которые не работают с виртуальными сетями (обратите внимание, что список **НЕ** является исчерпывающим):
> - Интеграция со службой "Сетка событий Azure".
> - Маршруты Центра Интернета вещей Azure.
> - Device Explorer Интернета вещей Azure.
>
> В виртуальной сети должны присутствовать следующие службы Майкрософт:
> - Служба приложений Azure
> - Функции Azure

> [!IMPORTANT]
> Эта функция поддерживается для Служебной шины Azure категории **Премиум**. Дополнительные сведения о категории "Премиум" см. в статье [Категории обмена сообщениями через служебную шину "Премиум" и "Стандартный"](service-bus-premium-messaging.md).


## <a name="add-a-private-endpoint-using-azure-portal"></a>Добавление частной конечной точки с помощью портала Azure

### <a name="prerequisites"></a>Предварительные требования

Чтобы интегрировать пространство имен служебной шины с Приватным каналом Azure, вам потребуются следующие сущности или разрешения:

- Пространство имен служебной шины.
- Виртуальная сеть Azure.
- Подсеть в виртуальной сети. Можно использовать подсеть **по умолчанию** . 
- Разрешения владельца или участника для пространства имен Служебной шины и виртуальной сети.

Частная конечная точка и виртуальная сеть должны находиться в одном регионе. При выборе региона для частной конечной точки с помощью портала будут автоматически фильтроваться только виртуальные сети в этом регионе. Пространство имен Служебной шины может находиться в другом регионе. Частная конечная точка использует частный IP-адрес в виртуальной сети.

### <a name="steps"></a>steps

Если у вас уже есть пространство имен, можно создать частную конечную точку, выполнив следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com). 
2. В строке поиска введите **Служебная шина**.
3. Выберите **пространство имен** из списка, для которого необходимо добавить частную конечную точку.
2. В меню слева выберите параметр **сеть** в разделе **Параметры**. 

    > [!NOTE]
    > Вкладка " **сеть** " отображается только для пространств имен " **премиум** ".  
    
    По умолчанию выбран параметр **Выбранные сети** . Если на этой странице не добавлено по крайней мере одно правило брандмауэра IP или виртуальная сеть, доступ к этому пространству имен можно получить через общедоступный Интернет (с помощью ключа доступа).

    :::image type="content" source="./media/service-bus-ip-filtering/default-networking-page.png" alt-text="Страница "Сетевые подключения" — по умолчанию" lightbox="./media/service-bus-ip-filtering/default-networking-page.png":::
    
    Если выбран параметр **все сети** , пространство имен служебной шины принимает подключения с любого IP-адреса (с помощью ключа доступа). То есть, такое значение параметра по умолчанию равноценно правилу, которое принимает диапазон IP-адресов 0.0.0.0/0. 

    ![Брандмауэр — выбран вариант "Все сети"](./media/service-bus-ip-filtering/firewall-all-networks-selected.png)
5. Чтобы разрешить доступ к пространству имен через частные конечные точки, выберите вкладку **подключения к частной конечной точке** в верхней части страницы.
6. Нажмите кнопку **+ Частная конечная точка** в верхней части страницы.

    ![Кнопка "Добавить частную конечную точку"](./media/private-link-service/private-link-service-3.png)
7. На странице **Базовые** выполните следующие действия. 
    1. Выберите **подписку Azure**, в которой нужно создать частную конечную точку. 
    2. Выберите **группу ресурсов** для ресурса частной конечной точки.
    3. Укажите **имя** частной конечной точки. 
    5. Выберите **регион** частной конечной точки. Частная конечная точка должна находиться в том же регионе, что и виртуальная сеть, но может находиться в разных регионах с ресурсом Приватного канала, к которому выполняется подключение. 
    6. По завершении выберите **Next: Ресурс >** в нижней части страницы.

        ![Создание частной конечной точки — страница "Базовые"](./media/private-link-service/create-private-endpoint-basics-page.png)
8. На странице **Ресурс** выполните следующие действия.
    1. Если для метода подключения вы выбираете **Подключиться к ресурсу Azure в моем каталоге**, выполните следующие действия.   
        1. Выберите **подписку Azure**, в которой существует **пространство имен Служебной шины**. 
        2. Для параметра **Тип ресурса** выберите **Microsoft.ServiceBus.Namespaces** в качестве **типа ресурса**.
        3. В качестве значения параметра **Ресурс** выберите пространство имен Служебной шины из раскрывающегося списка. 
        4. Убедитесь, что для параметра **Целевой подресурс** задано **пространство имен**.
        5. По завершении выберите **Next: Конфигурация >**  в нижней части страницы. 
        
            ![Создание частной конечной точки — страница "Ресурсы"](./media/private-link-service/create-private-endpoint-resource-page.png)
    2. Если вы выбрали **Подключиться к ресурсу Azure по идентификатору ресурса или псевдониму**, выполните следующие действия.
        1. Введите **идентификатор ресурса** и **псевдоним**. Это может быть идентификатор ресурса или псевдоним, к которому вам предоставили доступ. Самый простой способ получить идентификатор ресурса — перейти к пространству имен Служебной шины на портале Azure и скопировать часть URI, начиная с `/subscriptions/`. См. следующее изображение в качестве примера. 
        2. Для параметра **Целевой подресурс** введите **пространство имен**. Это тип подресурса, к которому имеет доступ частная конечная точка. 
        3. (необязательно) Введите **сообщение запроса**. Владелец ресурса видит это сообщение при управлении подключением к частной конечной точке. 
        4. Затем щелкните **Далее. Конфигурация >**  в нижней части страницы. 

            ![Создание частной конечной точки — подключение с использованием идентификатора ресурса](./media/private-link-service/connect-resource-id.png)
9. На странице **Конфигурация** выберите подсеть в виртуальной сети, в которой требуется развернуть закрытую конечную точку. 
    1. Выберите **виртуальную сеть**. В раскрывающемся списке отображаются только виртуальные сети в выбранных сейчас подписке и расположении. 
    2. Выберите **подсеть** в выбранной виртуальной сети. 
    3. По завершении выберите **Next: Теги >** в нижней части страницы. 

        ![Частная конечная точка — страница "Конфигурация"](./media/private-link-service/create-private-endpoint-configuration-page.png)
10. На странице **Теги** создайте теги (имена и значения), которые нужно связать с ресурсом частной конечной точки. В нижней части страницы нажмите на кнопку **Просмотреть и создать**. 
11. На странице **Проверка и создание** проверьте все параметры и нажмите **Создать**, чтобы создать частную конечную точку.
    
    ![Создание частной конечной точки — страница "Проверка и создание"](./media/private-link-service/create-private-endpoint-review-create-page.png)
12. Убедитесь, что частная конечная точка создана. Если вы являетесь владельцем ресурса и выбрали **Подключиться к ресурсу Azure в моем каталоге** в качестве параметра **Метод подключения**, подключение к конечной точке должно **утверждаться автоматически**. Если она находится в **состоянии ожидания**, см. раздел [Управление частными конечными точками с помощью портала Azure](#manage-private-endpoints-using-azure-portal).

    ![Частная конечная точка создана](./media/private-link-service/private-endpoint-created.png)

## <a name="add-a-private-endpoint-using-powershell"></a>Добавление частной конечной точки с помощью PowerShell
В следующем примере показано, как использовать Azure PowerShell для создания подключение частной конечной точки к пространству имен Служебной шины.

Частная конечная точка и виртуальная сеть должны находиться в одном регионе. Пространство имен Служебной шины может находиться в другом регионе. Частная конечная точка использует частный IP-адрес в виртуальной сети.

```azurepowershell-interactive

$rgName = "<RESOURCE GROUP NAME>"
$vnetlocation = "<VNET LOCATION>"
$vnetName = "<VIRTUAL NETWORK NAME>"
$subnetName = "<SUBNET NAME>"
$namespaceLocation = "<NAMESPACE LOCATION>"
$namespaceName = "<NAMESPACE NAME>"
$peConnectionName = "<PRIVATE ENDPOINT CONNECTION NAME>"

# create resource group
az group create -l $vnetLocation -n $rgName

# create virtual network
$virtualNetwork = New-AzVirtualNetwork `
                    -ResourceGroupName $rgName `
                    -Location $vnetlocation `
                    -Name $vnetName `
                    -AddressPrefix 10.0.0.0/16

# create subnet with endpoint network policy disabled
$subnetConfig = Add-AzVirtualNetworkSubnetConfig `
                    -Name $subnetName `
                    -AddressPrefix 10.0.0.0/24 `
                    -PrivateEndpointNetworkPoliciesFlag "Disabled" `
                    -VirtualNetwork $virtualNetwork

# update virtual network
$virtualNetwork | Set-AzVirtualNetwork

# create premium service bus namespace
$namespaceResource = New-AzResource -Location $namespaceLocation -ResourceName $namespaceName -ResourceGroupName $rgName -Sku @{name = "Premium"; capacity = 1} -Properties @{} -ResourceType "Microsoft.ServiceBus/namespaces" -

# create a private link service connection
$privateEndpointConnection = New-AzPrivateLinkServiceConnection `
                                -Name $peConnectionName `
                                -PrivateLinkServiceId $namespaceResource.ResourceId `
                                -GroupId "namespace"

# get subnet object that you will use in the next step                                
$virtualNetwork = Get-AzVirtualNetwork -ResourceGroupName  $rgName -Name $vnetName
$subnet = $virtualNetwork | Select -ExpandProperty subnets `
                                | Where-Object  {$_.Name -eq $subnetName}  
   
# now, create private endpoint   
$privateEndpoint = New-AzPrivateEndpoint -ResourceGroupName $rgName  `
                                -Name $vnetName   `
                                -Location $vnetlocation `
                                -Subnet  $subnet   `
                                -PrivateLinkServiceConnection $privateEndpointConnection

(Get-AzResource -ResourceId $namespaceResource.ResourceId -ExpandProperties).Properties


```


## <a name="manage-private-endpoints-using-azure-portal"></a>Управление частными конечными точками с помощью портала Azure

При создании частной конечной точки подключение должно быть утверждено. Если ресурс, для которого создается частная конечная точка, находится в вашем каталоге, вы можете утвердить запрос на подключение, если у вас есть необходимые разрешения. При подключении к ресурсу Azure в другом каталоге необходимо дождаться, пока владелец этого ресурса утвердит запрос на подключение.

Существует четыре состояния подготовки:

| Действие в службе | Состояние частной конечной точки объекта-получателя службы | Описание |
|--|--|--|
| None | Ожидает | Подключение создается вручную и ожидает утверждения от владельца ресурса Приватного канала. |
| Утверждение | Approved | Подключение утверждено автоматически или вручную и готово к использованию. |
| Reject | Отклонено | Подключение отклонил владелец ресурса Приватного канала. |
| Удалить | Отключено | Подключение удалил владелец ресурса Приватного канала. Частная конечная точка станет информативной и подлежит удалению для очистки. |
 
###  <a name="approve-reject-or-remove-a-private-endpoint-connection"></a>Утверждение, отклонение или удаление подключения к частной конечной точке

1. Войдите на портал Azure.
1. В строке поиска введите **Служебная шина**.
1. Выберите **пространство имен** для управления.
1. Перейдите на вкладку **Сеть**.
5. Перейдите к соответствующему разделу в зависимости от операции, которую нужно выполнить: утвердить, отклонить или удалить. 

### <a name="approve-a-private-endpoint-connection"></a>Утверждение подключения частной конечной точки

1. Если есть подключения в состоянии подготовки, вы увидите такое подключение в списке с состоянием **В ожидании**. 
2. Выберите **частную конечную точку**, которую вы хотите утвердить.
3. Нажмите кнопку **Утвердить**.

    ![Утверждение частной конечной точки](./media/private-link-service/private-endpoint-approve.png)
4. На странице **Утвердить подключение** введите **комментарий** по желанию и нажмите **Да**. Если выбрать **Нет**, ничего не произойдет. 

    ![Страница утверждения подключения](./media/private-link-service/approve-connection-page.png)
5. Вы увидите, что состояние подключения в списке изменилось на **Утверждено**. 

    ![Состояние подключения — утверждено](./media/private-link-service/connection-status-approved.png)

### <a name="reject-a-private-endpoint-connection"></a>Отклонение подключения к частной конечной точке

1. Если есть подключения к частным конечным точкам, которые вы хотите отклонить (ожидающее или ранее одобренное существующее подключение), выберите подключение и нажмите кнопку **Отклонить**.

    ![Кнопка "Отклонить"](./media/private-link-service/private-endpoint-reject.png)
2. На странице **Отклонить подключение** по желанию можно ввести комментарий, после чего нажать **Да**. Если выбрать **Нет**, ничего не произойдет. 

    ![Страница отклонения подключения](./media/private-link-service/reject-connection-page.png)
3. Вы увидите, что состояние подключения в списке изменилось на **Отклонено**. 

    ![Конечная точка отклонена](./media/private-link-service/endpoint-rejected.png)


### <a name="remove-a-private-endpoint-connection"></a>Удаление подключения к частной конечной точке

1. Чтобы удалить подключение к частной конечной точке, выберите ее в списке и нажмите **Удалить** на панели инструментов. 

    ![Кнопка "Удалить"](./media/private-link-service/remove-endpoint.png)
2. На странице **Удалить подключение** нажмите **Да**, чтобы подтвердить удаление частной конечной точки. Если выбрать **Нет**, ничего не произойдет. 

    ![Страница удаления подключения](./media/private-link-service/delete-connection-page.png)
3. Вы увидите, что состояние изменилось на **Отключено**. Затем конечная точка исчезнет из списка. 

## <a name="validate-that-the-private-link-connection-works"></a>Проверка работоспособности подключения Приватного канала

Необходимо проверить, что ресурсы в виртуальной сети частной конечной точки подключаются к пространству имен служебной шины по частному IP-адресу и что они имеют правильную интеграцию частной зоны DNS.

Сначала создайте виртуальную машину, выполнив действия, описанные в статье [Краткое руководство. Создание виртуальной машины Windows на портале Azure](../virtual-machines/windows/quick-create-portal.md).

На вкладке **Сеть** выполните следующее. 

1. Укажите **виртуальную сеть** и **подсеть**. Необходимо выбрать виртуальную сеть, в которой развернута частная конечная точка.
2. Укажите ресурс **общедоступного IP-адреса**.
3. В списке **Группа безопасности сети сетевого адаптера** выберите **Нет**.
4. В поле **Балансировка нагрузки** выберите **Нет**.

Подключитесь к виртуальной машине, откройте командную строку и выполните следующую команду:

```console
nslookup <service-bus-namespace-name>.servicebus.windows.net
```

Должен появиться следующий результат. 

```console
Non-authoritative answer:
Name:    <service-bus-namespace-name>.privatelink.servicebus.windows.net
Address:  10.0.0.4 (private IP address associated with the private endpoint)
Aliases:  <service-bus-namespace-name>.servicebus.windows.net
```

## <a name="limitations-and-design-considerations"></a>Проблемы и ограничения разработки

**Цены**. Сведения о ценах на службу "Приватный канал Azure" см. [здесь](https://azure.microsoft.com/pricing/details/private-link/).

**Ограничения**.  Эта возможность есть во всех общедоступных регионах Azure.

**Максимальное число частных конечных точек на пространство имен Служебной шины**: 120.

Дополнительные сведения см. в разделе [Azure Private Link service: Limitations](../private-link/private-link-service-overview.md#limitations) (Служба "Приватный канал Azure". Ограничения)

## <a name="next-steps"></a>Next Steps

- Дополнительные сведения о службе [Приватный канал Azure](../private-link/private-link-service-overview.md)
- Дополнительные сведения о [служебной шине Azure](service-bus-messaging-overview.md).
