---
title: Изолирование приложений служебной шины Azure от сбоев и аварий
description: В этой статье приводятся методы защиты приложений от возможного сбоя служебной шины Azure.
ms.topic: article
ms.date: 06/23/2020
ms.openlocfilehash: 4f3ff89e3ec59ad4445ab0b7ee7eeb45d18fa3b8
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "88065630"
---
# <a name="best-practices-for-insulating-applications-against-service-bus-outages-and-disasters"></a>Рекомендации по изолированию приложений от простоев и аварий служебной шины

Критически важные приложения должны работать постоянно, даже при возникновении незапланированных простоев или аварий. В этой статье описаны методы, которые можно использовать для защиты приложений служебной шины от возможного простоя службы или аварии.

Простой определяется как временная недоступность служебной шины Azure. Простой может влиять на некоторые компоненты служебной шины, например на хранилище сообщений или даже на весь центр обработки данных. После устранения проблемы служебная шина снова становится доступной. Как правило, простой не приводит к утрате сообщений или других данных. Примером сбоя компонента является недоступность определенного хранилища сообщений. Примером простоя центра обработки данных является сбой питания центра обработки данных или неисправность сетевого коммутатора центра обработки данных. Простой может длиться от нескольких минут до нескольких дней.

Авария определяется как полная потеря единицы масштабирования или центра обработки данных служебной шины. Центр обработки данных может снова стать доступным, но может и не стать. Авария обычно вызывает потерю некоторых или всех сообщений или других данных. Примеры аварий — пожар, наводнение или землетрясение.

## <a name="protecting-against-outages-and-disasters---service-bus-premium"></a>Защита от простоев и аварий с помощью Служебной шины ценовой категории "Премиум"
Принципы высокой доступности и аварийного восстановления реализуются в Служебной шине Azure ценовой категории "Премиум" в пределах одного региона (с помощью Зон доступности) и в разных регионах (с помощью геоизбыточного аварийного восстановления).

### <a name="geo-disaster-recovery"></a>Геоизбыточное аварийное восстановление

Служебная шина ценовой категории "Премиум" поддерживает геоизбыточное аварийное восстановление на уровне пространства имен. Дополнительные сведения см. в разделе [Географическое аварийное восстановление в служебной шине Azure](service-bus-geo-dr.md). Функция аварийного восстановления, доступная только для [номеров SKU уровня "Премиум"](service-bus-premium-messaging.md), реализует аварийное восстановление метаданных и основывается на первичном и вторичном пространствах имен для аварийного восстановления.

### <a name="availability-zones"></a>Зоны доступности

SKU Служебной шины ценовой категории "Премиум" поддерживает [Зоны доступности](../availability-zones/az-overview.md), предоставляя изолированные от сбоев расположения в пределах одного и того же региона Azure. Служебная шина управляет тремя копиями хранилища сообщений (1 первичный и 2-вторичный). Служебная шина хранит все три копии в синхронизации для операций с данными и управления. Если первичная копия завершается сбоем, одна из дополнительных копий повышается до первичной без наблюдаемого простоя. Если приложения видят временную отсоединение от служебной шины, логика повторных попыток в пакете SDK автоматически подключится к служебной шине. 

> [!NOTE]
> Поддержка Зон доступности Служебной шины Azure ценовой категории "Премицм"доступна только в [регионах Azure](../availability-zones/az-region.md), в которых представлены зоны доступности.

Вы можете включить эту функцию только в новых пространствах имен с помощью портала Azure. Служебная шина не поддерживает миграцию существующих пространств имен. Вы не можете отключить избыточность в пределах зоны после ее включения в пространстве имен.

![1][]


## <a name="protecting-against-outages-and-disasters---service-bus-standard"></a>Защита от простоев и аварий с помощью Служебной шины ценовой категории "Стандартный"
Для обеспечения устойчивости к простоям центра обработки данных при обмене сообщениями посредством решения ценовой категории "Стандартный" Служебная шина поддерживает два подхода: *активную* и *пассивную* репликацию. В каждом из этих подходов, если заданная очередь или раздел должны оставаться доступными при простое центра обработки данных, то эти очередь или раздел можно создать в обоих пространствах имен. Обе сущности могут иметь одно и то же имя. Например, основная очередь может быть доступна в разделе **contosoPrimary.servicebus.windows.net/myQueue**, а ее аналог — в разделе **contosoSecondary.servicebus.windows.net/myQueue**.

>[!NOTE]
> **Активная репликация** и **пассивная репликация** являются решениями общего назначения, а не особенностями Служебной шины. Логика репликации (отправка данных в 2 разных пространства имен) реализуется в отправителях, а получатель должен иметь настраиваемую логику для обнаружения повторяющихся сообщений.

Если приложение не требует постоянной связи отправителя и получателя, в нем можно реализовать долгосрочную клиентскую очередь для предотвращения потери сообщений и защиты отправителя от любых временных ошибок служебной шины.

### <a name="active-replication"></a>Активная репликация
При активной репликации для каждой операции используются объекты в обоих пространствах имен. Любой клиент, отправляющий сообщение, отправляет две копии одного и того же сообщения. Первая копия отправляется в основную сущность (например, **contosoPrimary.servicebus.windows.net/sales**), а вторая копия сообщения отправляется в дополнительную сущность (например, **contosoSecondary.servicebus.windows.net/sales**).

Клиент получает сообщения из обеих очередей. Получатель обрабатывает первую копию сообщения, а вторая копия пропускается. Во избежание дублирования сообщений отправитель должен помечать каждое сообщение уникальным идентификатором. Обе копии сообщения должны быть помечены одним и тем же идентификатором. Для указания идентификатора сообщения можно использовать свойства [BrokeredMessage.MessageId][BrokeredMessage.MessageId], [BrokeredMessage.Label][BrokeredMessage.Label] или пользовательские свойства. Получатель должен хранить список уже полученных им сообщений.

В примере [георепликации с использованием Служебной шины ценовой категории "Стандартный"][Geo-replication with Service Bus Standard Tier] показана активная репликация сущностей обмена сообщениями.

> [!NOTE]
> При активной репликации количество операций удваивается, поэтому этот подход может привести к увеличению расходов.
> 
> 

### <a name="passive-replication"></a>Пассивная репликация
При отсутствии сбоев в пассивной репликации используется только одна из двух сущностей обмена сообщениями. Клиент отправляет сообщение активной сущности. При сбое операции на активной сущности с кодом ошибки, который указывает, что центр обработки данных, в котором размещена активная сущность, может быть недоступным, клиент отправляет копию сообщения резервной сущности. В этот момент активная и резервная сущности меняются ролями: клиент, отправляющий сообщение, считает старую активную сущность новой резервной сущностью, а старую резервную сущность — новой активной сущностью. Если обе операции завершаются неудачно, роли двух сущностей не изменяются и возвращается сообщение об ошибке.

Клиент получает сообщения из обеих очередей. Поскольку есть вероятность того, что получатель получит две копии одного сообщения, он должен устранить дублирование сообщений. Устранить дубликаты можно так же, как при активной репликации.

В целом пассивная репликация экономичнее активной, поскольку в большинстве случаев выполняется только одна операция. Задержки, пропускная способность и расходы для нее идентичны сценарию без репликации.

При использовании пассивной репликации сообщения могут быть утрачены или получены дважды в следующих сценариях:

* **Задержка или потеря сообщения.** Предположим, что отправитель успешно отправил сообщение m1 в основную очередь, а затем очередь стала недоступной до получения сообщения m1 получателем. Отправитель отправляет следующее сообщение m2 в дополнительную очередь. Если основная очередь временно недоступна, то получатель получит сообщение m1 после того, как очередь снова станет доступной. В случае сбоя получатель может никогда не получить сообщение m1.
* **Дублирование.** Предположим, что отправитель отправляет сообщение m в основную очередь. Служебная шина успешно обрабатывает m, но ей не удается отправить ответ. По истечении времени ожидания отправки сообщения отправитель посылает идентичную копию сообщения m в дополнительную очередь. Если получатель смог получить первую копию m до того как основная очередь стала недоступной, то он получит обе копии m приблизительно в одно и то же время. Если получатель не смог получить первую копию m до того, как основная очередь стала недоступной, то сначала он получит вторую копию m, но затем получит первую копию m, когда основная очередь станет доступна.

В примере [георепликации с использованием Служебной шины ценовой категории "Стандартный"][Geo-replication with Service Bus Standard Tier] показана пассивная репликация сущностей обмена сообщениями.

## <a name="protecting-relay-endpoints-against-datacenter-outages-or-disasters"></a>Защита конечных точек ретрансляции от простоев или аварий центра обработки данных
Георепликация [Azure Relay](../azure-relay/relay-what-is-it.md) конечных точек позволяет службе, предоставляющей конечную точку ретранслятора, быть доступной при наличии простоев служебной шины. Для достижения георепликации служба должна создать две конечные точки ретрансляции в разных пространствах имен. Пространства имен должны находиться в разных центрах обработки данных, а две конечные точки должны иметь разные имена. Например, основная конечная точка может быть доступна в разделе **contosoPrimary.servicebus.windows.net/myQueue**, а ее аналог — в разделе **contosoSecondary.servicebus.windows.net/myQueue**.

Затем служба прослушивает обе конечные точки, и клиент может вызывать службу через любую из них. Клиентское приложение случайным образом выбирает один из ретрансляторов в качестве первичной конечной точки и отправляет свой запрос активной конечной точке. Если операция завершается ошибкой с кодом ошибки, это означает, что конечная точка ретрансляции недоступна. Приложение открывает канал к резервной конечной точке и снова отправляет запрос. В этот момент активная и резервная конечные точки меняются ролями: клиентское приложение считает старую активную конечную точку новой резервной конечной точкой, а старую резервную конечную точку — новой активной конечной точкой. Если обе операции завершаются неудачно, роли двух сущностей не изменяются и возвращается сообщение об ошибке.

## <a name="next-steps"></a>Дальнейшие шаги
Дополнительные сведения об аварийном восстановлении см. в следующих статьях:

* [Географическое аварийное восстановление в служебной шине Azure](service-bus-geo-dr.md)
* [Обзор обеспечения непрерывности бизнес-процессов с помощью Базы данных SQL Azure][Azure SQL Database Business Continuity]
* [Проектирование устойчивых приложений для Azure][Azure resiliency technical guidance]

[Service Bus Authentication]: service-bus-authentication-and-authorization.md
[Partitioned messaging entities]: service-bus-partitioning.md
[Asynchronous messaging patterns and high availability]: service-bus-async-messaging.md#failure-of-service-bus-within-an-azure-datacenter
[BrokeredMessage.MessageId]: /dotnet/api/microsoft.servicebus.messaging.brokeredmessage
[BrokeredMessage.Label]: /dotnet/api/microsoft.servicebus.messaging.brokeredmessage
[Geo-replication with Service Bus Standard Tier]: https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoReplication
[Azure SQL Database Business Continuity]:../azure-sql/database/business-continuity-high-availability-disaster-recover-hadr-overview.md
[Azure resiliency technical guidance]: /azure/architecture/resiliency

[1]: ./media/service-bus-outages-disasters/az.png