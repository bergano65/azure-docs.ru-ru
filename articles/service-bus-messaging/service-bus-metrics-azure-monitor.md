---
title: Метрики Служебной шины Azure в Azure Monitor | Документация Майкрософт
description: В этой статье объясняется, как использовать Azure Monitor для мониторинга сущностей Служебной шины (очередей, разделов и подписок).
ms.topic: article
ms.date: 11/18/2020
ms.openlocfilehash: 1f8bd9484bf2a2106818da1d6e4ef21e937d2ac3
ms.sourcegitcommit: f6236e0fa28343cf0e478ab630d43e3fd78b9596
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/19/2020
ms.locfileid: "94916888"
---
# <a name="azure-service-bus-metrics-in-azure-monitor"></a>Метрики Служебной шины Azure в Azure Monitor

Метрики служебной шины предоставляют состояние ресурсов в подписке Azure. Используя обширный набор данных метрик, можно оценить общую работоспособность ресурсов служебной шины не только на уровне пространства имен, но также и на уровне сущности. Эти статистические данные могут быть важны, так как они позволяют отслеживать состояние служебной шины. Кроме того, метрики могут помочь в устранении первопричин проблем без необходимости обращения в службу поддержки Azure.

Azure Monitor предоставляет унифицированный пользовательский интерфейс для мониторинга различных служб Azure. Дополнительные сведения см. в разделе [Обзор мониторинга в Microsoft Azure](../azure-monitor/overview.md). Ознакомьтесь также с примером [получения данных метрик Azure Monitor с помощью .NET](https://github.com/Azure-Samples/monitor-dotnet-metrics-api) на сайте GitHub.

> [!IMPORTANT]
> Если в течение двух часов не было взаимодействия с сущностью, в результатах метрики будет отображаться значение "0", пока сущность не станет активной.

## <a name="access-metrics"></a>Доступ к метрикам

Azure Monitor предоставляет несколько способов доступа к метрикам. Вы можете использовать [портал Azure](https://portal.azure.com), интерфейсы API Azure Monitor (REST и .NET), а также решения для анализа, например журналы Azure Monitor и Центры событий. Дополнительные сведения см. в статье [Метрики в Azure Monitor](../azure-monitor/platform/data-platform-metrics.md).

Метрики включены по умолчанию, и вы можете получить доступ к данным за последние 30 дней. Если необходимо хранить данные в течение более длительного периода времени, можно архивировать данные метрик в учетную запись хранения Azure. Это значение задается в [параметрах диагностики](../azure-monitor/platform/diagnostic-settings.md) Azure Monitor.

## <a name="access-metrics-in-the-portal"></a>Доступ к метрикам на портале

На [портале Azure](https://portal.azure.com) можно отслеживать метрики в течение продолжительного периода времени. В приведенном ниже примере показано, как просмотреть успешные запросы и входящие запросы на уровне учетной записи.

![Снимок экрана со страницей мониторинга метрик (Предварительная версия) в портал Azure.][1]

Можно также открыть метрики непосредственно с помощью пространства имен. Для этого выберите пространство имен и щелкните **метрики**. Чтобы отобразить метрики, отфильтрованные по области сущности, выберите сущность, а затем щелкните **метрики**.

![Снимок экрана страницы мониторинга — метрики (Предварительная версия), отфильтрованная по области сущности.][2]

Для метрик с поддержкой измерений необходимо выполнить фильтрацию по нужному значению измерения.

## <a name="billing"></a>Выставление счетов

Метрики и оповещения в Azure Monitor оплачиваются по количеству оповещений. Эти расходы должны быть доступны на портале, когда предупреждение настраивается и до его сохранения. 

За дополнительные решения для приема данных метрик плата взимается на условиях, действующих для этих решений. Например, при архивации данных метрик в учетную запись хранения Azure выставляется счет в службе хранилища Azure. Кроме того, счет выставляется Log Analytics при передаче данных метрик в Log Analytics для расширенного анализа.

Приведенные ниже метрики позволяют получить общие сведения о работоспособности службы. 

> [!NOTE]
> Несколько метрик стали неподдерживаемыми, так как теперь они доступны под другим именем. Это может потребовать обновления ссылок. Метрики, помеченные ключевым словом "нерекомендуемая", больше не будут поддерживаться.

Все значения метрик ежеминутно отправляются в Azure Monitor. Степень детализации определяет интервал времени, за который представлены значения метрик. Поддерживаемый интервал времени для всех метрик служебной шины составляет 1 минуту.

## <a name="request-metrics"></a>Метрики запросов

Подсчитывают объем данных и количество запросов операций управления.

| Имя метрики | Описание |
| ------------------- | ----------------- |
| Входящих запросов| Число запросов к службе служебной шины за указанный период. <br/><br/> Единица измерения: Count <br/> Тип агрегирования: Итог <br/> Измерение: имя сущности|
|Выполненные запросы|Число успешных запросов к службе служебной шины за указанный период.<br/><br/> Единица измерения: Count <br/> Тип агрегирования: Итог <br/> Измерение: имя сущности|
|Server Errors|Число запросов, не обработанных из-за ошибки в службе служебной шины за указанный период.<br/><br/> Единица измерения: Count <br/> Тип агрегирования: Итог <br/> Измерение: имя сущности|
|Ошибки пользователей (см. следующий подраздел)|Число запросов, не обработанных из-за ошибок пользователя за указанный период.<br/><br/> Единица измерения: Count <br/> Тип агрегирования: Итог <br/> Измерение: имя сущности|
|Регулируемые запросы|Число запросов, которые были отрегулированы из-за превышения квоты использования.<br/><br/> Единица измерения: Count <br/> Тип агрегирования: Итог <br/> Измерение: имя сущности|

### <a name="user-errors"></a>Ошибки пользователей

К ошибкам пользователей относятся следующие два типа ошибок:

1. Ошибки на стороне клиента (в HTTP это ошибки с кодом 400).
2. Ошибки, возникающие при обработке сообщений (например, [MessageLockLostException](/dotnet/api/microsoft.azure.servicebus.messagelocklostexception)).


## <a name="message-metrics"></a>Метрики использования

| Имя метрики | Описание |
| ------------------- | ----------------- |
|Входящие сообщения|Количество событий или сообщений, отправленных в служебную шину, за указанный период.<br/><br/> Единица измерения: Count <br/> Тип агрегирования: Итог <br/> Измерение: имя сущности|
|Исходящие сообщения|Количество событий или сообщений, полученных из служебной шины, за указанный период.<br/><br/> Единица измерения: Count <br/> Тип агрегирования: Итог <br/> Измерение: имя сущности|
| Сообщения| Количество сообщений в очереди или разделе. <br/><br/> Единица измерения: Count <br/> Тип агрегирования: Среднее <br/> Измерение: имя сущности |
| Активные сообщения| Количество активных сообщений в очереди или разделе. <br/><br/> Единица измерения: Count <br/> Тип агрегирования: Среднее <br/> Измерение: имя сущности |
| Недоставленные сообщения| Число недоставленных сообщений в очереди или разделе. <br/><br/> Единица измерения: Count <br/> Тип агрегирования: Среднее <br/>Измерение: имя сущности |
| Запланированные сообщения| Число запланированных сообщений в очереди или разделе. <br/><br/> Единица измерения: Count <br/> Тип агрегирования: Среднее  <br/> Измерение: имя сущности |
| Завершенные сообщения| Число завершенных сообщений в очереди или разделе. <br/><br/> Единица измерения: Count <br/> Тип агрегирования: Среднее <br/> Измерение: имя сущности |
| Отброшенные сообщения| Число отброшенных сообщений в очереди или разделе. <br/><br/> Единица измерения: Count <br/> Тип агрегирования: Среднее <br/> Измерение: имя сущности |
| Размер | Размер сущности (очереди или раздела) в байтах. <br/><br/>Единица измерения: Count <br/>Тип агрегирования: Среднее <br/>Измерение: имя сущности | 

> [!NOTE]
> Значения для сообщений, активных, недоставленных, запланированных, завершенных и отброшенных сообщений являются значениями на момент времени. Входящие сообщения, которые были получены сразу после этого момента времени, могут не отражаться в этих метриках. 

## <a name="connection-metrics"></a>Метрики подключения

| Имя метрики | Описание |
| ------------------- | ----------------- |
|Активные подключения|Количество активных соединений в пространстве имен и сущности в пространстве имен. Значение для этой метрики является значением на момент времени. Подключения, которые были активны сразу после этого момента времени, могут не отражаться в метрике.<br/><br/> Единица измерения: Count <br/> Тип агрегирования: Итог <br/> Измерение: имя сущности|
|Открытые подключения |Число открытых подключений.<br/><br/> Единица измерения: Count <br/> Тип агрегирования: Итог <br/> Измерение: имя сущности|
|Закрытые подключения |Число закрытых подключений.<br/><br/> Единица измерения: Count <br/> Тип агрегирования: Итог <br/> Измерение: имя сущности|

## <a name="resource-usage-metrics"></a>Метрики использования ресурсов

> [!NOTE] 
> Следующие метрики доступны только в ценовой категории **Премиум**. 
> 
> Важные метрики, по которым можно отслеживать любые сбои в пространстве имен уровня "Премиум": **Загрузка ЦП на пространство имен** и **Объем используемой памяти на пространство имен**. [Настройте оповещения](../azure-monitor/platform/alerts-metric.md) для этих метрик с помощью Azure Monitor.
> 
> Вот еще одна метрика, которую стоит отслеживать: **Регулируемые запросы**. Но проблемы с ней маловероятны, если для пространства имен сохраняется нормальная загрузка памяти, ЦП и подключений через брокер. Дополнительные сведения можно найти в разделе [Регулирование на уровне "Премиум" Служебной шины Azure](service-bus-throttling.md#throttling-in-azure-service-bus-premium-tier).

| Имя метрики | Описание |
| ------------------- | ----------------- |
|CPU usage per namespace|Процент использования ЦП для пространства имен.<br/><br/> Единица измерения: Процент <br/> Тип агрегирования: Максимальная <br/> Измерение: имя сущности|
|Memory size usage per namespace|Процент использования памяти для пространства имен.<br/><br/> Единица измерения: Процент <br/> Тип агрегирования: Максимальная <br/> Измерение: имя сущности|

## <a name="metrics-dimensions"></a>Измерения метрик

Служебная шина Azure поддерживает следующие измерения метрик в Azure Monitor. Добавление измерений для метрик является необязательным. Если не добавить измерения, метрики задаются на уровне пространства имен. 

|Имя измерения|Описание|
| ------------------- | ----------------- |
|Имя сущности| Служебная шина поддерживает сущности обмена сообщениями в пространстве имен.|

## <a name="set-up-alerts-on-metrics"></a>Настройка оповещений по метрикам

1. На вкладке **Метрики** страницы **Пространство имен служебной шины** нажмите **Настройка оповещений**. 

    ![Страница "Метрики" — Настройка меню оповещений](./media/service-bus-metrics-azure-monitor/metrics-page-configure-alerts-menu.png)
2. Выберите действие **Выбор целевого объекта** и выполните следующие действия на странице **Выбор ресурса**: 
    1. Выберите **Пространство имен служебной шины** для поля **Фильтрация по типу ресурса**. 
    2. Выберите свою подписку для поля **Фильтрация по подписке**.
    3. Выберите **Пространство имен служебной шины** из списка. 
    4. Нажмите кнопку **Готово**. 
    
        ![Выбор пространства имен](./media/service-bus-metrics-azure-monitor/select-namespace.png)
1. Выберите **Добавить критерий** и выполните следующие действия на странице **Настройка логики сигнала**:
    1. Выберите **Метрики** для параметра **Типа сигнала**. 
    2. Выберите сигнал. Пример: **Service errors** (Ошибки службы). 

        ![Выбор ошибок сервера](./media/service-bus-metrics-azure-monitor/select-server-errors.png)
    1. Выберите **Больше чем** для параметра **Условие**.
    2. Выберите **Общее** для параметра **Агрегат времени**. 
    3. Введите **5** для параметра **Пороговое значение**. 
    4. Нажмите кнопку **Готово**.    

        ![Назначение условия](./media/service-bus-metrics-azure-monitor/specify-condition.png)    
1. На странице **Создание правила** разверните **Определение сведений об оповещении** и выполните следующие действия:
    1. Введите **имя** оповещения. 
    2. Введите **описание** оповещения.
    3. Выберите **уровень серьезности** для оповещения. 

        ![Снимок экрана со страницей создания правила. Определение сведений о предупреждении разворачивается, и поля для имени правила генерации оповещений, описания и серьезности выделяются.](./media/service-bus-metrics-azure-monitor/alert-details.png)
1. На странице **Создание правила** разверните **Определение группы действий**, выберите **Новая группа действий** и выполните следующие действия на странице **Добавление группы действий**. 
    1. Введите имя для группы действий.
    2. Введите короткое имя для группы действий. 
    3. Выберите свою подписку. 
    4. Выберите группу ресурсов. 
    5. В этом пошаговом руководстве введите **Отправить электронное письмо** для параметра **ИМЯ ДЕЙСТВИЯ**.
    6. Выберите **Email/SMS/Push/Voice** для параметра **ТИП ДЕЙСТВИЯ**. 
    7. Нажмите **Изменить сведения**. 
    8. На странице **Email/SMS/Push/Voice** выполните следующие действия:
        1. Нажмите **Электронная почта**. 
        2. Введите **адрес электронной почты**. 
        3. Щелкните **ОК**.

            ![Снимок экрана со страницей добавления группы действий. В группу добавляется действие "отправить электронное письмо" с типом действия "Электронная почта", "SMS/Push/Voice".](./media/service-bus-metrics-azure-monitor/add-action-group.png)
        4. На странице **Добавить группу действий** нажмите **ОК**. 
1. На странице **Создание правила** выберите **Создать правило оповещений**. 

    ![Кнопка "Создать правило генерации оповещений"](./media/service-bus-metrics-azure-monitor/create-alert-rule.png)

## <a name="next-steps"></a>Дальнейшие действия

См. статью [Общие сведения о службе Azure Monitor](../azure-monitor/overview.md).

[1]: ./media/service-bus-metrics-azure-monitor/service-bus-monitor1.png
[2]: ./media/service-bus-metrics-azure-monitor/service-bus-monitor2.png