---
title: Группы отработки отказа. База данных SQL Azure | Документация Майкрософт
description: Группы автоматической отработки отказа являются возможностью Базы данных SQL, которая позволяет управлять репликацией и автоматической или согласованной отработкой отказа группы баз данных на сервере Базы данных SQL или во всех базах данных в управляемом экземпляре.
services: sql-database
ms.service: sql-database
ms.subservice: high-availability
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: mathoma, carlrab
manager: craigg
ms.date: 02/08/2019
ms.openlocfilehash: 2857b7f5347cf546a9745dcbea02f636a798f4a2
ms.sourcegitcommit: e69fc381852ce8615ee318b5f77ae7c6123a744c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/11/2019
ms.locfileid: "56004253"
---
# <a name="use-auto-failover-groups-to-enable-transparent-and-coordinated-failover-of-multiple-databases"></a>Использование групп автоматической отработки отказа для включения прозрачной и согласованной отработки отказа в нескольких базах данных

Группы автоматической отработки отказа являются возможностью базы данных SQL, которая позволяет управлять репликацией и отработкой отказа группы баз данных на сервере Базы данных SQL или во всех базах данных в Управляемом экземпляре в другом регионе (сейчас предоставляется в общедоступной предварительной версии для Управляемого экземпляра). Она использует ту же базовую технологию, что и [активная георепликация](sql-database-active-geo-replication.md). Вы можете запустить отработку отказа вручную или делегировать службе Базы данных SQL, используя определяемую пользователем политику. Последний вариант позволяет автоматически восстановить несколько связанных баз данных в дополнительном регионе после катастрофических сбоев или других незапланированных событий, которые приводят к полной или частичной потере доступности службы Базы данных SQL в основном регионе. Кроме того, клиенты могут использовать доступные для чтения базы данных-получатели для разгрузки рабочих нагрузок запросов, доступных только для чтения. Так как группы автоматической отработки отказа включают в себя несколько баз данных, базы данных необходимо настроить на сервере-источнике. Основной и дополнительный серверы баз данных в группе отработки отказа должны размещаться в одной подписке. Группы автоматической отработки отказа поддерживают репликацию всех баз данных в группе только на один сервер-получатель в другом регионе.

> [!NOTE]
> Если при работе с отдельными базами данных или с базами данных в составе пула на сервере базы данных SQL вы хотите создать несколько вторичных реплик в одном или в разных регионах, используйте [активную георепликацию](sql-database-active-geo-replication.md).

Во время работы с группами автоматической отработки отказа с политикой автоматической отработки отказа любой сбой, который влияет на одну или на несколько баз данных в группе, приведет к автоматической отработке отказа. Кроме того, группы автоматической отработки отказа предоставляют конечные точки прослушивателя только для чтения и для чтения-записи, которые во время отработки отказа не изменяются. Независимо от того, используете ли вы активацию вручную или автоматическую активацию отработки отказа, отработка отказа переключит все базы данных-получатели в группе в базу данных-источник. После выполнения автоматической отработки отказа базы данных запись DNS автоматически обновляется, чтобы перенаправить конечные точки в новый регион. Конкретные сведения о RPO и RTO можно найти в [обзоре обеспечения непрерывности бизнес-процессов](sql-database-business-continuity.md).

Во время работы с группами автоматической отработки отказа с политикой автоматической отработки отказа любой сбой, который влияет на базы данных на сервере Базы данных SQL или в управляемом экземпляре, приведет к автоматической отработки отказа. Управляйте группами автоматической отработки отказа используя:

- [портал Azure](sql-database-implement-geo-distributed-database.md).
- [PowerShell: группа отработки отказа](scripts/sql-database-setup-geodr-failover-database-failover-group-powershell.md);
- [REST API: группа отработки отказа](https://docs.microsoft.com/rest/api/sql/failovergroups).

После отработки отказа убедитесь, что для новой базы данных-источника настроены требования аутентификации ваших сервера и базы данных. Дополнительные сведения см. в разделе [Безопасность базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).

Добавление избыточности баз данных между центрами обработки данных — только часть решения для достижения настоящей непрерывности бизнес-процессов. Для комплексного восстановления приложения (службы) после катастрофического сбоя необходимо восстановить все компоненты, из которых состоит служба и все зависимые службы. К примерам этих компонентов относятся клиентское программное обеспечение (например, браузер с пользовательским кодом JavaScript), интерфейсные веб-серверы, хранилище и DNS. Очень важно, чтобы все компоненты были устойчивы к одинаковым сбоям и становились доступными в соответствии с целевым временем восстановления (RTO) вашего приложения. Следовательно, необходимо определить все зависимые службы и получить сведения о гарантиях и возможностях, которые они предоставляют. Затем необходимо выполнить соответствующие действия, чтобы обеспечить работу службы во время отработки отказа служб, от которых она зависит. Дополнительные сведения о проектировании решений для аварийного восстановления см. в статье о [разработке облачных решений для аварийного восстановления с помощью активной георепликации](sql-database-designing-cloud-solutions-for-disaster-recovery.md).

## <a name="auto-failover-group-terminology-and-capabilities"></a>Терминология и способности группы автоматической отработки отказа

- **Группа отработки отказа**

  Группа отработки отказа — это группа баз данных, управляемая отдельным сервером Базы данных SQL или в пределах отдельного управляемого экземпляра, который может выполнить отработку отказа как единица измерения в другой регион, если каждая или некоторые базы данных-источники становятся недоступными в связи со сбоем в основном регионе.

  - **Серверы Базы данных SQL**

     С помощью серверов Базы данных SQL можно разместить некоторые или все пользовательские базы данных с отдельного сервера Базы данных SQL в группе отработки отказа. Сервер Базы данных SQL также поддерживает несколько групп отработки отказа на отдельном сервере Базы данных SQL.

  - **Управляемые экземпляры**
  
     С помощью управляемого экземпляра группа отработки отказа размещает все пользовательские базы данных в Управляемом экземпляре, и, следовательно, он поддерживает только одну группу отработки отказа.

- **Источник**

  Сервер Базы данных SQL или Управляемый экземпляр, на котором размещаются базы данных-источники в группе отработки отказа.

- **Получатель**

  Сервер Базы данных SQL или Управляемый экземпляр, на котором размещаются базы данных-получатели в группе отработки отказа. Источники и получатели не могут находиться в одном и том же регионе.

- **Добавление баз данных в группу отработки отказа на сервере Базы данных SQL**

  Вы можете разместить несколько отдельных баз данных или баз данных эластичного пула на одном сервере Базы данных SQL в одной группе отработки отказа. Если вы добавите отдельную базу данных в группу отработки отказа, она автоматически создаст базу данных-получатель, используя тот же выпуск и объем вычислительных ресурсов. Если база данных-источник расположена в эластичном пуле, в нем автоматически создается база данных-получатель с тем же именем. Если вы добавите базу данных, у которой уже есть база данных-получатель на сервере-получателе, эта георепликация наследуется группой. Во время добавления базы данных, у которой уже есть база данных-получатель на сервере, которая не является частью группы отработки отказа, на этом сервере-получателе будет создана новая база данных-получатель.
  
> [!IMPORTANT]
  > В Управляемом экземпляре реплицируются все пользовательские базы данных. Нельзя выбирать подмножество для репликации пользовательских баз данных в группе отработки отказа.

- **Прослушиватель чтения и записи для группы отработки отказа**

  Формирование записи DNS CNAME, которая указывает на URL-адрес текущего источника. Она позволяет приложениям SQL для чтения и записи прозрачно повторно подключиться к базе данных-источнику, когда эта база данных изменяется после отработки отказа.

  - **Запись CNAME DNS сервера Базы данных SQL для прослушивателя чтения и записи**

     На сервере Базы данных SQL запись CNAME DNS для группы отработки отказа, которая указывает на URL-адрес текущего источника, выглядит как `failover-group-name.database.windows.net`.

  - **Управляемый экземпляр DNS CNAME для прослушивателя чтения и записи**

     В Управляемом экземпляре запись DNS CNAME для группы отработки отказа, которая указывает на URL-адрес текущего источника, выглядит как `failover-group-name.zone_id.database.windows.net`.

- **Прослушиватель только для чтения для группы отработки отказа**

  Формируется запись DNS CNAME, которая указывает на прослушиватель только для чтения, указывающий на URL-адрес получателя. Она позволяет приложениям SQL для чтения прозрачно повторно подключиться к базе данных-получателю, используя специальные правила балансировки нагрузки.

  - **Запись CNAME DNS сервера Базы данных SQL для прослушивателя только для чтения**

     На сервере Базы данных SQL запись CNAME DNS для прослушивателя только для чтения, которая указывает на URL-адрес получателя, выглядит как `failover-group-name.secondary.database.windows.net`.

  - **Управляемый Экземпляр DNS CNAME для прослушивателя только для чтения**

     В Управляемом єкземпляре запись DNS CNAME для прослушивателя только для чтения, которая указывает на URL-адрес получателя, выглядит как `failover-group-name.zone_id.database.windows.net`.

- **Политика автоматической отработки отказа**

  По умолчанию группа отработки отказа настроена с помощью политики автоматической отработки отказа. Служба базы данных SQL запускает отработку отказа после обнаружения сбоя и истечения льготного периода. Системе необходимо убедиться, что сбой нельзя устранить с помощью встроенной [инфраструктуры обеспечения высокой доступности Службы базы данных SQL](sql-database-high-availability.md) из-за масштаба влияния. Если вы хотите управлять рабочим процессом отработки отказа из приложения, вы можете отключить автоматическую отработку отказа.

- **Политика отработки отказа только для чтения**

  По умолчанию группа отработки отказа только для чтения отключена. Это гарантирует, что производительность базы данных-источника не изменится, если база данных-получателя отключена. Тем не менее, это также означает, что невозможно будет активировать сеансы только для чтения, пока база данных-получателя не восстановится. Если вас не устраивает время простоя для сеансов с доступом только для чтения, и вы предпочитаете временно использовать базы данных-источника для режима только для чтения, а также для режима чтения и записи трафика за счет возможного замедления производительности источника, вы можете включить отработку отказа в сеансе с доступом только для чтения. В таком случае трафик только для чтения будет автоматически перенаправляться на источник, если получатель недоступен.

- **Плановая отработка отказа**

   Плановая отработка отказа выполняет полную синхронизацию между базой данных-источник и базой данных-получатель, прежде чем база данных-получатель переключится на основную роль. Такая обработка отказа гарантирует отсутствие потерь данных. Плановая отработка отказа используется в следующих сценариях.

  - Тестирование аварийного восстановления (DR) в рабочей среде в случае, если потеря данных неприемлема.
  - Перемещение баз данных в другой регион.
  - Возвращение баз данных в основной регион после устранения сбоя (восстановление размещения).

- **Незапланированная отработка отказа**

   При незапланированной или принудительной отработке отказа база данных-получатель немедленно переключается на основную роль без какой-либо синхронизации с базой данных-источником. Эта операция приведет к потере данных. Незапланированная отработка отказа используется в качестве метода восстановления при сбоях, когда база данных-источник недоступна. Когда база данных-источник снова становится доступной, она автоматически повторно подключается без синхронизации и становится новой базой данных-получателем.

- **Отработка отказа вручную**

  Вы можете запустить отработку отказа вручную в любое время, независимо от настройки автоматической отработки отказа. Если политика автоматической отработки отказа не настроена, для восстановления баз данных в группе отработки отказа в получателя требуется отработка отказа вручную. Вы можете запустить принудительную отработку отказа или адаптированную (с полной синхронизацией данных). Адаптированная отработка отказа может использоваться для перемещения источника в дополнительный регион. После завершения отработки отказа записи DNS автоматически обновляются для установления подключения к новому источнику.

- **Льготный период с потерей данных**

  Так как база данных-источник и база данных-получатель синхронизированы с помощью асинхронной репликации, отработка отказа может привести к потере данных. Вы можете настроить политику автоматической отработки отказа, чтобы представить устойчивость приложения к потере данных. Настраивая параметр **GracePeriodWithDataLossHours**, вы можете управлять продолжительностью периода ожидания системы перед последующим запуском отработки отказа, которая, вероятнее всего, приведет к потере данных.

- **Несколько групп отработки отказа**

  Вы можете настроить несколько групп отработки отказа для одной пары серверов, чтобы управлять масштабом отработок отказа. Каждая группа выполняет отработку отказа независимо от других групп. Если ваше мультитенантное приложение использует эластичные пулы, вы можете воспользоваться этой возможностью, чтобы объединить базу данных-источник и базу данных-получатель в каждом пуле. Таким образом вы сможете снизить последствия сбоя для половины клиентов.

  > [!IMPORTANT]
  > Управляемый экземпляр не поддерживает несколько групп отработки отказа.

## <a name="best-practices-of-using-failover-groups-with-single-databases-and-elastic-pools"></a>Рекомендации по использованию групп отработки отказа с отдельными базами данных и эластичными пулами

Группу автоматической отработки отказа необходимо настроить на сервере-источнике Базы данных SQL и подключить к серверу-получателю Базы данных SQL в другом регионе Azure.  Группы могут содержать все или некоторые базы данных на этих серверах. На следующей схеме показана типичная конфигурация геоизбыточного облачного приложения, использующего несколько баз данных и активную георепликацию.

![автоматическая отработка отказа](./media/sql-database-auto-failover-group/auto-failover-group.png)

При разработке службы с обеспечением непрерывности бизнес-процессов придерживайтесь следующих рекомендаций.

- **Использование одной или нескольких групп отработки отказа для управления отработкой отказа нескольких баз данных**

  Вы можете создать одну или несколько групп отработки отказа между двумя серверами в различных регионах (для основного сервера и сервера-получателя). Каждая группа может содержать одну или несколько баз данных, которые восстанавливаются единым блоком в случае, когда все или часть баз данных-источников становятся недоступными из-за сбоя в основном регионе. Группа отработки отказа создает базу данных-получатель в дополнительном географическом регионе с таким же целевым уровнем служб, который указан для базы данных-источника. При добавлении существующей связи георепликации к группе отработки отказа убедитесь, что база данных-получатель геореплицируемых данных настроена с тем же уровнем служб и объемом вычислительных ресурсов, что и база данных-источник.

- **Использование прослушивателя чтения и записи для рабочей нагрузки OLTP**

  При выполнении операций OLTP используйте `failover-group-name.database.windows.net` в качестве URL-адреса сервера, чтобы все подключения автоматически перенаправлялись на сервер-источник. Этот URL-адрес не будет изменяться после отработки отказа. Обратите внимание на то, что отработка отказа включает в себя обновление DNS-записи, поэтому клиентские подключения будут перенаправляться на новый сервер-источник только после обновления кэша DNS на стороне клиента.

- **Использование прослушивателя только для чтения для рабочей нагрузки только для чтения**

  Если вы используете логически изолированную рабочую нагрузку в режиме только для чтения, устойчивую к некоторым задержкам в обновлении данных, в приложении можно использовать базу данных-получатель. Для сеансов с доступом только для чтения используйте `failover-group-name.secondary.database.windows.net` в качестве URL-адреса сервера, чтобы подключение автоматически перенаправлялось на сервер-получатель. Кроме того, мы рекомендуем указать режим только для чтения прямо в строке подключения, добавив аргумент **ApplicationIntent=ReadOnly**.

- **Будьте готовы к снижению производительности**

  Решение отработки отказа SQL не зависит от остальной части приложения или других используемых служб. Приложение может смешаться с некоторыми компонентами в одном регионе и с некоторыми в другом. Чтобы избежать снижения производительности, обеспечьте избыточное развертывание приложения в регионе аварийного восстановления и следуйте этим [рекомендациям по безопасности в сети](#failover-groups-and-network-security).

  > [!NOTE]
  > Приложение в регионе аварийного восстановления не требует использования другой строки подключения.  

- **Будьте готовы к потере данных**

  При обнаружении сбоя SQL ожидает в течение периода, указанного в **GracePeriodWithDataLossHours**. Значение этого свойства по умолчанию – 1 час. Если вы не можете позволить себе потерю данных, установите для параметра **GracePeriodWithDataLossHours** достаточно большое количество времени, например 24 часа. Используйте группу ручной отработки отказа для восстановления размещения из получателя в источник.

> [!IMPORTANT]
> Эластичные пулы с 800 DTU или менее и более чем 250 базами данных, использующими георепликацию, могут испытывать проблемы, включая более длительные плановые операции отработки отказа и снижение производительности.  Эти проблемы чаще всего возникают из-за рабочих нагрузок, интенсивно записывающих данные, если конечные точки георепликации физически находятся далеко друг от друга или если используется несколько дополнительных конечных точек для каждой базы данных.  Симптомы этих проблем проявляются при увеличении задержки георепликации с течением времени.  Эту задержку можно отслеживать с помощью [sys.dm_geo_replication_link_status](/sql/relational-databases/system-dynamic-management-views/sys-dm-geo-replication-link-status-azure-sql-database).  Если эти проблемы возникли, к возможным способам их устранения относятся увеличение числа DTU пула или уменьшение количества геореплицируемых баз данных в одном пуле.

## <a name="best-practices-of-using-failover-groups-with-managed-instances"></a>Рекомендации по использованию групп отработки отказа с Управляемыми экземплярами

Группы автоматической отработки отказа должны быть настроены на экземпляре источника и подключены к экземпляру получателя в другом регионе Azure.  Все базы данных в экземпляре будут реплицированы в экземпляр получателя. На следующей схеме показана типичная конфигурация геоизбыточного облачного приложения, использующего несколько управляемых экземпляров и активную георепликацию.

![автоматическая отработка отказа](./media/sql-database-auto-failover-group/auto-failover-group-mi.png)

> [!IMPORTANT]
> Группы автоматической отработки отказа для управляемого экземпляра предоставляются в общедоступной предварительной версии.

Если ваше приложение использует Управляемый экземпляр в качестве уровня данных, придерживайтесь следующих рекомендаций при разработке для непрерывности бизнес-процессов.

- **Создание экземпляра получателя в той же зоне DNS, что и для экземпляра источника**

  При создании нового экземпляра уникальный код автоматически создается как зона DNS и отображается в DNS-имени экземпляра. Сертификат нескольких доменов (SAN) предоставляется экземпляру вместе с полем SAN в виде `zone_id.database.windows.net`. Этот сертификат можно использовать для проверки подлинности клиентских подключений к экземпляру в той же зоне DNS. Чтобы обеспечить беспрерывное подключение к экземпляру источника после отработки отказа, экземпляры и источника, и получателя должны находиться в одной зоне DNS. После подготовки вашего приложения к рабочему развертыванию создайте экземпляр получателя в другом регионе и убедитесь, что он использует ту же зону DNS, что и экземпляр источника. Для этого следует указать дополнительный параметр `DNS Zone Partner`, используя портал Azure, PowerShell или REST API.

  Дополнительные сведения о создании экземпляров получателя и источника в одной зоне DNS см. в статье [Use auto-failover groups to enable transparent and coordinated failover of multiple databases](#powershell-managing-failover-groups-with-managed-instances-preview) (Обеспечение прозрачной согласованной отработки отказа нескольких баз данных с помощью групп автоматической отработки отказа).

- **Включение трафика репликации между двумя экземплярами**

  Поскольку каждый экземпляр изолирован в своей виртуальной сети, двусторонний трафик между этими виртуальными сетями должен быть разрешен. См. [VPN-шлюзы Azure](../vpn-gateway/vpn-gateway-about-vpngateways.md)

- **Настройка группы отработки отказа для управления отработками отказов для всего экземпляра**

  Группа отработки отказа будет управлять отработкой отказа всех баз данных в экземпляре. При создании группы каждая база данных в экземпляре будет автоматически геореплицироваться в экземпляр получателя. Вы не можете использовать группы отработки отказа для запуска частичной отработки отказа подмножества баз данных.

  > [!IMPORTANT]
  > Если база данных удалена из экземпляра источника, то она также будет автоматически удалена из экземпляра геополучателя.

- **Использование прослушивателя чтения и записи для рабочей нагрузки OLTP**

  При выполнении операций OLTP используйте `failover-group-name.zone_id.database.windows.net` в качестве URL-адреса сервера, чтобы все подключения автоматически перенаправлялись на сервер-источник. Этот URL-адрес не будет изменяться после отработки отказа. Отработка отказа включает в себя обновление DNS-записи, поэтому клиентские подключения будут перенаправляться на новый сервер-источник только после обновления кэша DNS на стороне клиента. Клиентское приложение сможет повторно подключиться к серверу-источнику, используя тот же сертификат SAN, поскольку экземпляры источника и получателя используют общую DNS-зону.

- **Прямое подключение к георепликации получателя для запросов только для чтения**

  Если вы используете логически изолированную рабочую нагрузку в режиме только для чтения, устойчивую к некоторым задержкам в обновлении данных, в приложении можно использовать базу данных-получатель. Для прямого подключения к георепликации получателя используйте `server.secondary.zone_id.database.windows.net` в качестве URL-сервера.

  > [!NOTE]
  > На некоторых уровнях База данных SQL Azure поддерживает использование [реплик только для чтения](sql-database-read-scale-out.md) для балансировки рабочих нагрузок запросов только для чтения, используя возможности одной реплики и параметра `ApplicationIntent=ReadOnly` в строке соединения. После настройки георепликации получателя вы можете использовать эту возможность для соединения с репликой только для чтения либо в основном расположении, либо в геореплицированном расположении.
  > - Для подключения к реплике только для чтения в основном расположении используйте `failover-group-name.zone_id.database.windows.net`.
  > - Для подключения к реплике только для чтения в основном расположении используйте `failover-group-name.secondary.zone_id.database.windows.net`.

- **Будьте готовы к снижению производительности**

  Решение отработки отказа SQL не зависит от остальной части приложения или других используемых служб. Приложение может смешаться с некоторыми компонентами в одном регионе и с некоторыми в другом. Чтобы избежать снижения производительности, обеспечьте избыточное развертывание приложения в регионе аварийного восстановления и следуйте этим [рекомендациям по безопасности в сети](#failover-groups-and-network-security).

- **Будьте готовы к потере данных**

  При обнаружении сбоя SQL автоматически активирует отработку отказа с чтением и записью, если потери данных нулевые, насколько нам известно. В противном случае он ожидает в течение периода, указанного в `GracePeriodWithDataLossHours`. Если вы указали `GracePeriodWithDataLossHours`, будьте готовы к потере данных. Во время сбоев Azure, как правило, повышает доступность. Если вы не можете позволить себе потерю данных, установите для параметра GracePeriodWithDataLossHours достаточно большое количество времени, например 24 часа.

  После запуска отработки отказа DNS обновления прослушивателя чтения и записи произойдут автоматически. Эта операция не приведет к потере данных. Однако процесс смены ролей баз данных в обычных условиях может занять до 5 минут. До окончания этого процесса некоторые базы данных в новом экземпляре источника будут оставаться в режиме только для чтения. Если отработка отказа инициируется с помощью PowerShell, то вся операция будет синхронной. Если она инициируется с помощью портала Azure, то пользовательский интерфейс будет отображать состояние выполнения. Если она инициируется с помощью REST API, то используйте стандартный механизм опроса Azure Resource Manager для мониторинга выполнения.

  > [!IMPORTANT]
  > Используйте группу ручной отработки отказа для перемещения источников в исходное расположение. После устранения сбоя, вызвавшего отработку отказа, вы можете переместить базы данных-источники в исходное расположение. Для этого вам следует инициировать ручную отработку отказа группы.

## <a name="failover-groups-and-network-security"></a>Группы отработки отказа и сетевая безопасность

В некоторых приложениях правила безопасности требуют, чтобы сетевой доступ к уровню данных ограничивался определенным компонентом или компонентами, например виртуальной машиной, веб-службой и т. д. Это создает трудности для обеспечения непрерывности бизнес-процессов и использования групп отработки отказа. При реализации такого ограниченного доступа необходимо учитывать следующие варианты.

### <a name="using-failover-groups-and-virtual-network-rules"></a>Использование групп отработки отказа и правил виртуальной сети

Если вы используете [конечные точки службы и правила виртуальной сети](sql-database-vnet-service-endpoint-rule-overview.md) для ограничения доступа к базе данных SQL, помните, что каждая конечная точка службы виртуальной сети применяется только к одному региону Azure. Конечная точка не поддерживает прием подключений из подсети в других регионах. Таким образом, только клиентские приложения, развернутые в одном регионе, могут подключаться к базе данных-источнику. Так как результаты отработки отказа в сеансах клиента SQL пересылаются на сервер в другом (дополнительном) регионе, эти сеансы завершатся сбоем, если будут исходить из клиента за пределами этого региона. По этой причине политику автоматической отработки отказа невозможно включить, если на серверы-участники распространяются правила виртуальной сети. Для поддержки перехода на другой ресурс вручную выполните следующие действия:

1. Подготовьте избыточные копии интерфейсных компонентов приложения (веб-службы, виртуальные машины и т. д.) в дополнительном регионе.
2. Настройте [правила виртуальной сети](sql-database-vnet-service-endpoint-rule-overview.md) по отдельности для основного и дополнительного сервера.
3. Включите [отработку отказа внешнего интерфейса с помощью конфигурации диспетчера трафика](sql-database-designing-cloud-solutions-for-disaster-recovery.md#scenario-1-using-two-azure-regions-for-business-continuity-with-minimal-downtime).
4. Инициируйте отработку отказа вручную при обнаружении сбоя. Этот параметр оптимизирован для приложений, требующих последовательной задержки между внешним интерфейсом и уровнем данных, и поддерживает восстановление после сбоя внешнего интерфейса уровня данных или их обоих.

> [!NOTE]
> При использовании **прослушивателя только для чтения** для балансировки рабочей нагрузки только для чтения убедитесь, что эта рабочая нагрузка выполняется на виртуальной машине или в другом ресурсе в дополнительном регионе, чтобы прослушиватель мог подключаться к базе данных-получателю.

### <a name="using-failover-groups-and-sql-database-firewall-rules"></a>Использование групп отработки отказа и правил брандмауэра базы данных SQL

Если для плана обеспечения непрерывности бизнес-процессов требуется отработка отказа с помощью групп с автоматической отработкой отказа, можно ограничить доступ к базе данных SQL с помощью традиционных правил брандмауэра.  Для поддержки автоматического перехода на другой ресурс выполните следующие действия:

1. [создайте общедоступный IP-адрес](../virtual-network/virtual-network-public-ip-address.md#create-a-public-ip-address);
2. [создайте общедоступный балансировщик нагрузки](../load-balancer/quickstart-create-basic-load-balancer-portal.md#create-a-basic-load-balancer) и назначьте ему общедоступный IP-адрес;
3. [создайте виртуальную сеть и виртуальные машины](../load-balancer/quickstart-create-basic-load-balancer-portal.md#create-back-end-servers) для интерфейсных компонентов;
4. [создайте группу безопасности сети](../virtual-network/security-overview.md) и настройте входящие подключения.
5. Убедитесь, что исходящие подключения открыты в Базе данных SQL Azure с помощью [тега службы](../virtual-network/security-overview.md#service-tags) "Sql".
6. Создайте [правило брандмауэра базы данных SQL](sql-database-firewall-configure.md), чтобы разрешить входящий трафик из общедоступного IP-адреса, созданного на этапе 1.

Дополнительные сведения о том, как настроить исходящий доступ и какой IP-адрес нужно использовать в правилах брандмауэра, см. в статье [Исходящие подключения в Azure](../load-balancer/load-balancer-outbound-connections.md).

Приведенная выше конфигурация гарантирует, что автоматический переход на другой ресурс не будет блокировать подключения из интерфейсных компонентов, и предполагает, что приложение может выдержать более длительную задержку между интерфейсном и уровнем данных.

> [!IMPORTANT]
> Для обеспечения непрерывности бизнес-процессов при региональных сбоях должна присутствовать географическая избыточность интерфейсных компонентов и баз данных.

## <a name="enabling-geo-replication-between-managed-instances-and-their-vnets"></a>Включение георепликации между Управляемыми экземплярами и их виртуальными сетями

Во время настройки групп отработки отказа между управляемыми экземплярами источника и получателя в двух разных регионах каждый экземпляр изолирован с помощью независимой виртуальной сети. Чтобы разрешить трафик репликации между этими виртуальными сетями, убедитесь, что соблюдены следующие условия.

1. Оба управляемых экземпляра должны находиться в различных регионах Azure.
2. Ваш получатель должен быть пустым (без пользовательских баз данных).
3. Управляемые экземпляры источника и получателя должны находиться в одной группе ресурсов.
4. Виртуальные сети, частью которых являются управляемые экземпляры, должны соединятся через [VPN-шлюз](../vpn-gateway/vpn-gateway-about-vpngateways.md). Пиринг глобальной виртуальной сети не поддерживается.
5. Виртуальные сети двух управляемых экземпляров не должны иметь перекрывающиеся IP-адреса.
6. Вы должны настроить группы безопасности сети (NSG) так, чтобы порты 5022 и диапазон 11000~12000 были открыты для входящих и исходящих подключений из другой подсети управляемого экземпляра. Это позволяет обеспечить трафик репликации между экземплярами.

    > [!IMPORTANT]
    > Неправильная настройка правил безопасности NSG приводит к задержке операций копирования баз данных.

7. Необходимо настроить партнера зоны DNS на экземпляре получателя. Зона DNS является свойством Управляемого экземпляра. Она представляет часть имени узла после имени управляемого экземпляра и перед префиксом `.database.windows.net`. Она создается в качестве произвольной строки во время создания первого управляемого экземпляра в каждой виртуальной сети. После создания управляемого экземпляра невозможно изменить зону DNS и в пределах одной подсети все управляемые экземпляры разделяют одинаковое значение зоны DNS. Для настройки группы отработки отказа Управляемого экземпляра Управляемый экземпляр источника и Управляемый экземпляр получателя должны иметь одинаковое значение зоны DNS. Это возможно благодаря указанию параметра DnsZonePartner во время создания управляемого экземпляра получателя. Свойство участника зоны DNS определяет управляемый экземпляр для совместного использования с группой отработки отказа экземпляра. Управляемый экземпляр, который создается в настоящее время, наследует то же значение зоны DNS партнерского управляемого экземпляра путем принятия идентификатора ресурса другого управляемого экземпляра, поступившего от DnsZonePartner.

## <a name="upgrading-or-downgrading-a-primary-database"></a>Повышение или понижение уровня производительности базы данных-источника

Вы можете повышать или понижать объем вычислительных ресурсов базы данных-источника (в рамках одного уровня служб, а не между уровнем общего назначения и критически важным для бизнеса) без отключения каких-либо баз данных-получателей. При повышении рекомендуется сначала повысить уровень производительности базы данных-получателя, а затем — уровень базы данных-источника. При понижении следует действовать в обратном порядке: сначала нужно понизить уровень производительности базы данных-источника, а после этого — базы данных-получателя. Когда вы повышаете или понижаете базу данных до следующего уровня службы, особенно важно выполнять рекомендацию выше.

> [!NOTE]
> Если вы создали базу данных-получатель как часть конфигурации группы отработки отказа, понижение ее уровня не рекомендуется. Это необходимо, чтобы обеспечить достаточную емкость уровня данных для обработки регулярных рабочих нагрузок после активации отработки отказа.

## <a name="preventing-the-loss-of-critical-data"></a>Предотвращение потери важных данных

Из-за высокой задержки глобальных сетей непрерывная копия использует механизм асинхронной репликации. Ввиду асинхронной репликации потеря данных в случае сбоя неизбежна. Тем не менее для некоторых приложений терять данные недопустимо. Чтобы защитить эти критические обновления, разработчик приложения сразу же после фиксации транзакции может вызывать системную процедуру [sp_wait_for_database_copy_sync](/sql/relational-databases/system-stored-procedures/active-geo-replication-sp-wait-for-database-copy-sync). Вызов **sp_wait_for_database_copy_sync** блокирует вызывающий поток до передачи последней зафиксированной транзакции в базе данных-получателе. Но вызов не дожидается воспроизведения и фиксации переданных транзакций в базе данных-получателе. **sp_wait_for_database_copy_sync** ограничена конкретной связью непрерывной копии. Эту процедуру может вызвать любой пользователь с правами подключения к базе данных-источнику.

> [!NOTE]
> Процедура **sp_wait_for_database_copy_sync** предотвращает потерю данных после отработки отказа, но не гарантирует полную синхронизацию для доступа на чтение. Вызов процедуры **sp_wait_for_database_copy_sync** может привести к значительной задержке, которая будет зависеть от размера журнала транзакций во время вызова.

## <a name="failover-groups-and-point-in-time-restore"></a>Группы отработки отказа и восстановление до точки во времени

Сведения об использовании восстановления до точки во времени с группами отработки отказа см. в разделе [Восстановление до точки во времени (PITR)](sql-database-recovery-using-backups.md#point-in-time-restore).

## <a name="programmatically-managing-failover-groups"></a>Программное управление группами отработки отказа

Как уже говорилось ранее, группами автоматической отработки отказа и активной георепликацией можно также управлять программно с помощью Azure PowerShell и REST API. В приведенных ниже таблицах описан доступный для этого набор команд. Активная георепликация включает в себя набор API-интерфейсов Azure Resource Manager для управления, в том числе [REST API базы данных SQL Azure](https://docs.microsoft.com/rest/api/sql/) и [командлеты Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview). Эти интерфейсы API требуют использования групп ресурсов и поддерживают безопасность на основе ролей (RBAC). Дополнительные сведения о том, как реализовать контроль доступа на основе ролей, см. в статье [Использование управления доступом на основе ролей для контроля доступа к ресурсам в подписке Azure](../role-based-access-control/overview.md).

### <a name="powershell-manage-sql-database-failover-with-single-databases-and-elastic-pools"></a>PowerShell: Управление отработкой отказа баз данных SQL с отдельными базами данных и эластичными пулами

| Командлет | ОПИСАНИЕ |
| --- | --- |
| [New-AzureRmSqlDatabaseFailoverGroup](https://docs.microsoft.com/powershell/module/azurerm.sql/set-azurermsqldatabasefailovergroup) |Создает группу отработки отказа и регистрирует ее на основном сервере и сервере-получателе.|
| [Remove-AzureRmSqlDatabaseFailoverGroup](https://docs.microsoft.com/powershell/module/azurerm.sql/remove-azurermsqldatabasefailovergroup) | Удаляет группу отработки отказа с сервера, а также удаляет все входящие в нее базы данных-получатели. |
| [Get-AzureRmSqlDatabaseFailoverGroup](https://docs.microsoft.com/powershell/module/azurerm.sql/get-azurermsqldatabasefailovergroup) | Возвращает конфигурацию группы отработки отказа. |
| [Set-AzureRmSqlDatabaseFailoverGroup](https://docs.microsoft.com/powershell/module/azurerm.sql/set-azurermsqldatabasefailovergroup) |Изменяет конфигурацию группы отработки отказа. |
| [Switch-AzureRMSqlDatabaseFailoverGroup](https://docs.microsoft.com/powershell/module/azurerm.sql/switch-azurermsqldatabasefailovergroup) | Запускает отработку отказа группы отработки отказа на сервер-получатель. |
| [Add-AzureRmSqlDatabaseToFailoverGroup](https://docs.microsoft.com/powershell/module/azurerm.sql/add-azurermsqldatabasetofailovergroup)|Добавляет одну или несколько баз данных в группу отработки отказа базы данных SQL Azure.|
|  | |

> [!IMPORTANT]
> Пример сценария см. в статье [Use PowerShell to configure an active geo-replication failover group for a single Azure SQL database](scripts/sql-database-setup-geodr-failover-database-failover-group-powershell.md) (Использование PowerShell для настройки группы отработки отказа активной георепликации для отдельной базы данных SQL Azure).
>

### <a name="powershell-managing-failover-groups-with-managed-instances-preview"></a>PowerShell: Управление группами отработки отказа с помощью Управляемого экземпляра (предварительная версия)

#### <a name="install-the-newest-pre-release-version-of-powershell"></a>Установите последнюю предварительную версию PowerShell

1. Обновите модуль PowerShellGet до версии 1.6.5 (или до новой предварительной версии). См. [Сайт ознакомительной версии PowerShell](https://www.powershellgallery.com/packages/AzureRM.Sql/4.11.6-preview).

   ```Powershell
      install-module PowerShellGet -MinimumVersion 1.6.5 -force
   ```

2. В новом окне PowerShell выполните следующие команды.

   ```Powershell
      import-module PowerShellGet
      get-module PowerShellGet #verify version is 1.6.5 (or newer)
      install-module azurerm.sql -RequiredVersion 4.5.0-preview -AllowPrerelease –Force
      import-module azurerm.sql
   ```

#### <a name="powershell-commandlets-to-create-an-instance-failover-group"></a>Командлеты Powershell для создания группы отработки отказа экземпляров

| API | ОПИСАНИЕ |
| --- | --- |
| New-AzureRmSqlDatabaseInstanceFailoverGroup |Создает группу отработки отказа и регистрирует ее на основном сервере и сервере-получателе.|
| Set-AzureRmSqlDatabaseInstanceFailoverGroup |Изменяет конфигурацию группы отработки отказа.|
| Get-AzureRmSqlDatabaseInstanceFailoverGroup |Возвращает конфигурацию группы отработки отказа.|
| Switch-AzureRmSqlDatabaseInstanceFailoverGroup |Запускает отработку отказа группы отработки отказа на сервер-получатель.|
| Remove-AzureRmSqlDatabaseInstanceFailoverGroup | Удаляет группу отработки отказа.|

### <a name="rest-api-manage-sql-database-failover-groups-with-single-and-pooled-databases"></a>REST API: Управление группами отработки отказа базы данных SQL с отдельными базами данных или с базами данных в составе пула

| API | ОПИСАНИЕ |
| --- | --- |
| [Создание или обновление группы отработки отказа](https://docs.microsoft.com/rest/api/sql/failovergroups/createorupdate) | Создает или обновляет группу отработки отказа. |
| [Удаление группы отработки отказа](https://docs.microsoft.com/rest/api/sql/failovergroups/delete) | Удаляет группу отработки отказа с сервера. |
| [Плановая отработка отказа](https://docs.microsoft.com/rest/api/sql/failovergroups/failover) | Выполняет отработку отказа из текущего основного сервера на этот сервер. |
| [Принудительная отработка отказа (возможна потеря данных)](https://docs.microsoft.com/rest/api/sql/failovergroups/forcefailoverallowdataloss) |Выполняет отработку отказа из текущего основного сервера на этот сервер. Эта операция может привести к потере данных. |
| [Получение группы отработки отказа](https://docs.microsoft.com/rest/api/sql/failovergroups/get) | Получает группу отработки отказа. |
| [Вывод списка групп отработки отказа с фильтрацией по серверу](https://docs.microsoft.com/rest/api/sql/failovergroups/listbyserver) | Перечисляет группы отработки отказа на сервере. |
| [Обновление группы отработки отказа](https://docs.microsoft.com/rest/api/sql/failovergroups/update) | Обновляет группу отработки отказа. |
|  | |

### <a name="rest-api-manage-failover-groups-with-managed-instances-preview"></a>REST API: Управление группами отработки отказа с помощью Управляемого экземпляра (предварительная версия)

| API | ОПИСАНИЕ |
| --- | --- |
| [Создание или обновление группы отработки отказа](https://docs.microsoft.com/rest/api/sql/instancefailovergroups/createorupdate) | Создает или обновляет группу отработки отказа. |
| [Удаление группы отработки отказа](https://docs.microsoft.com/rest/api/sql/instancefailovergroups/delete) | Удаляет группу отработки отказа с сервера. |
| [Плановая отработка отказа](https://docs.microsoft.com/rest/api/sql/instancefailovergroups/failover) | Выполняет отработку отказа из текущего основного сервера на этот сервер. |
| [Принудительная отработка отказа (возможна потеря данных)](https://docs.microsoft.com/rest/api/sql/instancefailovergroups/forcefailoverallowdataloss) |Выполняет отработку отказа из текущего основного сервера на этот сервер. Эта операция может привести к потере данных. |
| [Получение группы отработки отказа](https://docs.microsoft.com/rest/api/sql/instancefailovergroups/get) | Получает группу отработки отказа. |
| [Перечисление групп отработки отказа – Перечисление по расположению](https://docs.microsoft.com/rest/api/sql/instancefailovergroups/listbylocation) | Перечисляет группы отработки отказа в расположении. |

## <a name="next-steps"></a>Дополнительная информация

- Ознакомьтесь с примерами скриптов в следующих статьях:
  - [Настройка активной георепликации для отдельной базы данных SQL Azure с помощью PowerShell](scripts/sql-database-setup-geodr-and-failover-database-powershell.md)
  - [Настройка активной георепликации для базы данных SQL Azure в составе пула с помощью PowerShell](scripts/sql-database-setup-geodr-and-failover-pool-powershell.md)
  - [Настройка и отработка отказа для группы отработки отказа для отдельной базы данных](scripts/sql-database-setup-geodr-failover-database-failover-group-powershell.md)
- Сведения об обеспечении непрерывности бизнес-процессов и возможные сценарии описаны в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md)
- Чтобы узнать об автоматически создаваемых резервных копиях базы данных SQL Azure, ознакомьтесь со статьей [Общие сведения об автоматическом резервном копировании базы данных SQL](sql-database-automated-backups.md).
- Чтобы узнать об использовании автоматически создаваемых резервных копий для восстановления, ознакомьтесь с [восстановлением базы данных из резервных копий, инициируемых службой](sql-database-recovery-using-backups.md).
- Дополнительные сведения о требованиях к проверке подлинности для новых сервера-источника и базы данных-источника см. в статье [Безопасность базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).
