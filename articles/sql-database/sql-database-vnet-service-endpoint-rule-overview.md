---
title: Конечные точки службы и правила виртуальной сети для Базы данных SQL Azure и Хранилища данных SQL | Документация Майкрософт
description: Пометьте подсеть как конечную точку службы виртуальной сети. Затем внесите конечную точку в виде правила виртуальной сети в список управления доступом к базе данных SQL Azure. После этого база данных SQL будет принимать подключения от всех виртуальных машин и других узлов в этой подсети.
services: sql-database
ms.service: sql-database
ms.subservice: development
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: oslake
ms.author: moslake
ms.reviewer: vanto, genemi
manager: craigg
ms.date: 12/13/2018
ms.openlocfilehash: d4957efa151a0f992d098b2d6355b03f336e3738
ms.sourcegitcommit: c2e61b62f218830dd9076d9abc1bbcb42180b3a8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/15/2018
ms.locfileid: "53438597"
---
# <a name="use-virtual-network-service-endpoints-and-rules-for-azure-sql"></a>Использование конечных точек службы и правил виртуальной сети для SQL Azure

*Правила виртуальной сети* — это одна из функций безопасности брандмауэра, которая контролирует прием сервером Azure [Базы данных SQL](sql-database-technical-overview.md) или [Хранилища данных SQL](../sql-data-warehouse/sql-data-warehouse-overview-what-is.md) сообщений, ранее отправленных из определенных подсетей в виртуальных сетях. В этой статье объясняется, почему правила виртуальной сети иногда являются лучшим вариантом для защиты подключений к Базе данных SQL Azure и Хранилищу данных SQL.

> [!NOTE]
> Этот раздел относится к Azure SQL Server, а также к базам данных SQL и хранилища данных SQL, создаваемым на сервере Azure SQL Server. Для простоты база данных SQL используется как для базы данных SQL, так и для хранилища данных SQL.

Чтобы создать правило виртуальной сети, требуется [конечная точка службы виртуальной сети][vm-virtual-network-service-endpoints-overview-649d], используемая для ссылки.

## <a name="how-to-create-a-virtual-network-rule"></a>Как создать правило виртуальной сети

Если вы собираетесь просто создать правило виртуальной сети, то можете сразу перейти к инструкциям и пояснениям, приведенным [далее в этой статье](#anchor-how-to-by-using-firewall-portal-59j).

<a name="anch-terminology-and-description-82f" />

## <a name="terminology-and-description"></a>Терминология и описание

**Виртуальная сеть.** С подпиской Azure могут быть связаны виртуальные сети.

**Подсеть.** Виртуальная сеть содержит **подсети**. Все ваши виртуальные машины Azure назначены в подсети. Одна подсеть может содержать несколько виртуальных машин или других вычислительных узлов. Вычислительные узлы, которые находятся вне вашей виртуальной сети, не имеют доступа к ней, если только не настроить систему безопасности таким образом, чтобы предоставить им доступ.

**Конечная точка службы виртуальной сети.** [Конечная точка службы виртуальной сети][vm-virtual-network-service-endpoints-overview-649d] — это подсеть, значения свойств которой включают в себя одно или несколько формальных имен типов службы Azure. В этой статье мы рассмотрим тип **Microsoft.Sql**, который относится к службе Azure, которая называется Базой данных SQL.

**Правило виртуальной сети.** Правило виртуальной сети для сервера Базы данных SQL — это подсеть, которая указана в списке управления доступом сервера Базы данных SQL. Для включения в ACL для базы данных SQL подсеть должна содержать имя типа **Microsoft.Sql**.

Правило виртуальной сети предписывает серверу базы данных SQL принимать подключения от всех узлов, находящихся в подсети.

<a name="anch-benefits-of-a-vnet-rule-68b" />

## <a name="benefits-of-a-virtual-network-rule"></a>Преимущества правила виртуальной сети

Пока вы не выполните соответствующие действия, виртуальные машины в подсети не могут взаимодействовать с базой данных SQL. Создание правила виртуальной сети — это единственное действие, которое устанавливает подключение. Чтобы обосновать выбор подхода на основе правил виртуальной сети, требуется сравнить преимущества и недостатки этого подхода с конкурирующими функциями безопасности, предоставляемыми брандмауэром.

### <a name="a-allow-access-to-azure-services"></a>О. Разрешение доступа к службам Azure

В области брандмауэра есть кнопка **ON/OFF** (Вкл./выкл.) с надписью **Разрешить доступ к службам Azure**. Значение **ON** (Вкл.) разрешает подключение со всех IP-адресов Azure и из всех подсетей Azure. Эти Azure IP-адреса и подсети могут принадлежать не вам. Возможно, значение **ON** (Вкл.) делает вашу систему более открытой, чем требуется для базы данных SQL. Правила виртуальной сети обеспечивают более детализированный контроль.

### <a name="b-ip-rules"></a>B. Правила фильтрации IP-адресов

Брандмауэр базы данных SQL позволяет указать диапазоны IP-адресов, подключения с которых принимаются базой данных SQL. Эта методика хорошо подходит для постоянных IP-адресов, которые находятся за пределами частной сети Azure. Однако за пределами частной сети Azure используется множество *динамических* IP-адресов. Динамические IP-адреса могут изменяться, например при перезапуске виртуальной машины. Было бы неразумно указывать динамический IP-адрес в правиле брандмауэра в рабочей среде.

Можно сохранить выбранный IP-адрес, присвоив виртуальной машине *статический* IP-адрес. Дополнительные сведения см. в разделе [Настройка частных IP-адресов для виртуальной машины с помощью портала Azure][vm-configure-private-ip-addresses-for-a-virtual-machine-using-the-azure-portal-321w].

Однако применение статических IP-адресов может усложнить управление и создать дополнительные расходы при увеличении масштаба среды. Правила виртуальной сети проще устанавливать и контролировать.

### <a name="c-cannot-yet-have-sql-database-on-a-subnet"></a>C. Пока еще невозможно разместить базу данных SQL в подсети

Если сервер базы данных SQL Azure был узлом в подсети виртуальной сети, то все узлы в этой виртуальной сети могли взаимодействовать с базой данных SQL. В этом случае виртуальные машины могли взаимодействовать с базой данных SQL без необходимости в каких-либо правилах виртуальной сети или правилах фильтрации IP-адресов.

Однако к сентябрю 2017 года служба базы данных SQL Azure еще не вошла в список служб, которые могут быть назначены в подсеть.

<a name="anch-details-about-vnet-rules-38q" />

## <a name="details-about-virtual-network-rules"></a>Сведения о правилах виртуальной сети

В этом разделе приводятся некоторые сведения о правилах виртуальной сети.

### <a name="only-one-geographic-region"></a>Только один географический регион

Каждая конечная точка службы виртуальной сети может использоваться только в одном регионе Azure. Конечная точка не поддерживает прием подключений из подсети в других регионах.

Любое правило виртуальной сети ограничена регионом, в котором используется базовая конечная точка.

### <a name="server-level-not-database-level"></a>На уровне сервера, а не базы данных

Каждое правило виртуальной сети применяется ко всему серверу базы данных SQL Azure, не только к одной конкретной базе данных на сервере. Другими словами, правило виртуальной сети применяется на уровне сервера,а не на уровне базы данных.

- Для сравнения, правило фильтрации IP-адресов можно применить на любом уровне.

### <a name="security-administration-roles"></a>Роли администратора безопасности

Роли безопасности для администрирования конечных точек службы виртуальной сети разделены. Требуется действие каждой из следующих ролей:

- **Администратор сети.** &nbsp;Включение конечной точки.
- **Администратор базы данных.** &nbsp;Обновление списка управления доступом для добавления данной подсети на сервер Базы данных SQL.

*Альтернатива RBAC*

Роли администратора сети и администратора базы данных имеют больше возможностей, чем требуется для управления правилами виртуальной сети. На самом деле для этого требуется только часть их возможностей.

У вас есть возможность использовать [управление доступом на основе ролей (RBAC)][rbac-what-is-813s] в Azure, чтобы создать отдельную настраиваемую роль с необходимыми правами. Эту настраиваемую роль можно использовать вместо роли администратора сети или администратора базы данных. Контактная зона потенциального нарушения безопасности будет меньше при добавлении пользователя в настраиваемую роль, чем при его добавлении в одну из двух основных ролей администратора.

> [!NOTE]
> Иногда база данных SQL Azure и подсеть виртуальной сети относятся к разным подпискам. В этих случаях необходимо обеспечить следующую конфигурацию:
> - Обе подписки должны быть в одном клиенте Azure Active Directory.
> - Пользователь должен иметь необходимые разрешения для запуска операций, например для включения конечных точек службы или добавления подсети виртуальной сети к заданному серверу.
> - Обе подписки должны иметь зарегистрированного поставщика Microsoft.Sql.

## <a name="limitations"></a>Ограничения

Для базы данных SQL Azure правила виртуальной сети имеют следующие ограничения.

- Веб-приложения можно сопоставить с частным IP-адресом в виртуальной сети или подсети. Даже если конечные точки службы включены в определенной виртуальной сети или подсети, при подключении из веб-приложения к серверу в качестве источника будет использоваться открытый IP-адрес Azure, виртуальная сеть или подсеть. Чтобы обеспечить подключение из веб-приложения к серверу, на котором установлены правила брандмауэра виртуальной сети, включите параметр **Разрешить службам Azure доступ к серверу** на сервере.

- В брандмауэре для базы данных SQL каждое правило виртуальной сети ссылается на подсеть. Все такие упомянутые подсети должны размещаться в том же географическом регионе, где размещена база данных SQL.

- Каждый сервер базы данных SQL Azure может использовать до 128 записей ACL для любой заданной виртуальной сети.

- Правила виртуальной сети применяются только к виртуальным сетям Azure Resource Manager, но не к сетям на основе [классической модели развертывания][arm-deployment-model-568f].

- Включение конечных точек службы виртуальной сети для базы данных SQL Azure также включает конечные точки для служб MySQL и PostgreSQL Azure. Тем не менее, если конечные точки включены в базе данных, подключиться через них к экземплярам MySQL или PostgreSQL не удастся.
  - Основной причиной является то, что сейчас MySQL и PostgreSQL не поддерживают списки управления доступом (ACL).
- К приведенным ниже элементам сети применяются диапазоны IP-адресов в брандмауэре, а правила виртуальной сети — нет:
  - [виртуальная частная сеть (VPN) типа "сеть — сеть"][vpn-gateway-indexmd-608y].
  - локальная среда с подключением [ExpressRoute][expressroute-indexmd-744v].

### <a name="considerations-when-using-service-endpoints"></a>Рекомендации по использованию конечных точек служб

При использовании конечных точек служб базы данных SQL Azure обратите внимание на следующие моменты:

- **Требуется исходящее подключение к общедоступным IP-адресам Базы данных SQL Azure.** Чтобы предоставить возможность подключения, группы безопасности сети (NSG) необходимо открыть для IP-адресов Базы данных SQL Azure. Это можно сделать с помощью [тегов службы](../virtual-network/security-overview.md#service-tags) NSG для базы данных SQL Azure.

### <a name="expressroute"></a>ExpressRoute

Если вы используете [ExpressRoute](../expressroute/expressroute-introduction.md?toc=%2fazure%2fvirtual-network%2ftoc.json) для локальной среды, для общедоступного пиринга или пиринга Майкрософт, то вам необходимо определить используемые IP-адреса NAT. Для общедоступного пиринга в каждом канале ExpressRoute по умолчанию используется два IP-адреса NAT для трафика служб Azure, когда он входит в основную магистральную сеть Microsoft Azure. Для пиринга Майкрософт используются IP-адреса NAT, предоставленные клиентом или поставщиком услуг. Чтобы разрешить доступ к ресурсам служб, необходимо разрешить эти общедоступные IP-адреса в настройках брандмауэра IP-адресов ресурсов. Чтобы найти IP-адреса канала ExpressRoute для общедоступного пиринга, [отправьте запрос по ExpressRoute в службу поддержки](https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview) через портал Azure. Узнайте больше о [NAT для общедоступного пиринга и пиринга Майкрософт](../expressroute/expressroute-nat.md?toc=%2fazure%2fvirtual-network%2ftoc.json#nat-requirements-for-azure-public-peering).
  
Чтобы разрешить взаимодействие канала с базой данных SQL Azure, необходимо создать правила IP-сети для общедоступных IP-адресов NAT.

<!--
FYI: Re ARM, 'Azure Service Management (ASM)' was the old name of 'classic deployment model'.
When searching for blogs about ASM, you probably need to use this old and now-forbidden name.
-->

## <a name="impact-of-removing-allow-azure-services-to-access-server"></a>Последствия удаления параметра "Разрешить службам Azure доступ к серверу"

Многие пользователи хотят удалить параметр **Разрешить службам Azure доступ к серверу** с серверов SQL Azure и заменить его правилом брандмауэра виртуальной сети.
Но удаление этого параметра затрагивает указанные ниже возможности.

### <a name="import-export-service"></a>Служба импорта и экспорта

Служба импорта и экспорта базы данных SQL Azure выполняется на виртуальных машинах в Azure. Эти виртуальные машины не находятся в вашей виртуальной сети и поэтому получают IP-адрес Azure при подключении к базе данных. После удаления параметра **Разрешить службам Azure доступ к серверу** эти виртуальные машины не смогут получить доступ к базам данных.
Эту проблему можно решить. Импортируйте или экспортируйте BACPAC-файл непосредственно в коде с помощью API DACFx. Его нужно развернуть на виртуальной машине, расположенной в подсети виртуальной сети, для которой задано правило брандмауэра.

### <a name="sql-database-query-editor"></a>Редактор запросов базы данных SQL

Редактор запросов базы данных SQL Azure развертывается на виртуальных машинах в Azure. Эти виртуальные машины не находятся в вашей виртуальной сети. Поэтому они получают IP-адрес Azure при подключении к базе данных. После удаления параметра **Разрешить службам Azure доступ к серверу** эти виртуальные машины не смогут получить доступ к базам данных.

### <a name="table-auditing"></a>Аудит таблиц

Сейчас есть два способа включения аудита для базы данных SQL. Аудит таблицы завершается сбоем после включения конечных точек службы на сервере Azure SQL Server. Чтобы устранить риски, используйте аудит больших двоичных объектов.

### <a name="impact-on-data-sync"></a>Влияние на синхронизацию данных

Компонент "Синхронизация данных" в базе данных SQL Azure подключается к базам данных через IP-адреса Azure. При использовании конечных точек служб вполне вероятно, что вы запретите **всем службам Azure доступ к логическому серверу**. Это приведет к разрыву подключения к компоненту "Синхронизация данных".

## <a name="impact-of-using-vnet-service-endpoints-with-azure-storage"></a>Влияние использования конечных точек службы виртуальной сети со службой хранилища Azure

Служба хранилища Azure реализовала ту же функцию, которая позволяет ограничить возможность подключения к учетной записи службы хранилища Azure. Если вы решили применить эту функцию к учетной записи службы хранилища Azure, используемой сервером Azure SQL Server, могут возникнуть проблемы. Ниже приведен список и описание функций Базы данных SQL Azure и Хранилища данных SQL Azure, на которых это отразится.

### <a name="azure-sql-data-warehouse-polybase"></a>PolyBase для хранилища данных SQL Azure

PolyBase часто используют для загрузки данных в Хранилище данных SQL Azure из учетных записей службы хранилища Azure. Если учетная запись службы хранилища Azure, из которой загружаются данные, предоставляет доступ только к набору подсетей виртуальной сети, подключение из PolyBase к учетной записи будет прервано. Чтобы обеспечить возможность импорта и экспорта PolyBase в Хранилище данных SQL Azure, подключенное к службе хранилища Azure, прикрепленной к виртуальной сети, сделайте следующее:

#### <a name="prerequisites"></a>Предварительные требования
1.  Установите Azure PowerShell, следуя инструкциям в этом [руководстве](https://docs.microsoft.com/powershell/azure/install-azurerm-ps).
2.  При наличии учетной записи хранения общего назначения версии 1 или учетной записи хранилища BLOB-объектов необходимо сначала выполнить обновление до учетной записи хранения общего назначения версии 2, следуя инструкциям в этом [руководстве](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade).
3.  Необходимо включить параметр **Разрешить доверенным службам Майкрософт доступ к этой учетной записи хранения** в меню параметров **Брандмауэры и виртуальные сети** учетной записи службы хранилища Azure. Дополнительные сведения см. в [этом руководстве](https://docs.microsoft.com/azure/storage/common/storage-network-security#exceptions).
 
#### <a name="steps"></a>Действия
1.  В PowerShell **зарегистрируйте логический сервер SQL Server** с помощью Azure Active Directory (AAD):

    ```powershell
    Add-AzureRmAccount
    Select-AzureRmSubscription -SubscriptionId your-subscriptionId
    Set-AzureRmSqlServer -ResourceGroupName your-logical-server-resourceGroup -ServerName your-logical-servername -AssignIdentity
    ```
    
 1. Создайте **учетную запись хранения общего назначения версии 2** с помощью этого [руководства](https://docs.microsoft.com/azure/storage/common/storage-quickstart-create-account).

    > [!NOTE]
    > - При наличии учетной записи хранения общего назначения версии 1 или учетной записи хранилища BLOB-объектов необходимо **сначала выполнить обновление до учетной записи хранения версии 2**, следуя инструкциям в этом [руководстве](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade).
    > - Сведения об известных проблемах с Azure Data Lake Storage 2-го поколения см. в этом [руководстве](https://docs.microsoft.com/azure/storage/data-lake-storage/known-issues).
    
1.  В учетной записи хранения перейдите к элементу **Управление доступом (IAM)** и нажмите кнопку **Добавить назначение ролей**. Назначьте роль RBAC **Участник для данных больших двоичных объектов хранилища (предварительная версия)** логическому серверу SQL Server.

    > [!NOTE] 
    > Этот шаг могут выполнять только участники с правами владельца. Сведения о различных встроенных ролях для ресурсов Azure см. в этом [руководстве](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles).
  
1.  **Установка подключения Polybase к учетной записи службы хранилища Azure:**

    1. Создайте **[главный ключ](https://docs.microsoft.com/sql/t-sql/statements/create-master-key-transact-sql?view=sql-server-2017)** базы данных, если он еще не создан:
        ```SQL
        CREATE MASTER KEY [ENCRYPTION BY PASSWORD = 'somepassword'];
        ```
    
    1. Создайте учетные данные базы данных, указав **IDENTITY = 'Managed Service Identity'**:

        ```SQL
        CREATE DATABASE SCOPED CREDENTIAL msi_cred WITH IDENTITY = 'Managed Service Identity';
        ```
        > [!NOTE] 
        > - Не нужно указывать СЕКРЕТ с использованием ключа доступа к хранилищу Azure, так как на самом деле этот механизм использует [управляемое удостоверение](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview).
        > - Имя IDENTITY должно быть **Managed Service Identity**, чтобы подключения PolyBase работали с учетной записью службы хранилища Azure, прикрепленной к виртуальной сети.    
    
    1. Создайте внешний источник данных с использованием схемы abfss:// для подключения к учетной записи хранения общего назначения версии 2 с помощью PolyBase:

        ```SQL
        CREATE EXTERNAL DATA SOURCE ext_datasource_with_abfss WITH (TYPE = hadoop, LOCATION = 'abfss://myfile@mystorageaccount.dfs.core.windows.net', CREDENTIAL = msi_cred);
        ```
        > [!NOTE] 
        > - При наличии внешних таблиц, связанных с учетной записью общего назначения версии 1 или учетной записью хранилища BLOB-объектов, сначала удалите эти внешние таблицы, а затем удалите соответствующий внешний источник данных. Затем создайте внешний источник данных с использованием схемы abfss://, подключенной к учетной записи хранения общего назначения версии 2, как описано выше, и повторно создайте все внешние таблицы с использованием этого нового внешнего источника данных. Для удобства вы можете создать сценарии для всех внешних таблиц с помощью [мастера создания и публикации сценариев](https://docs.microsoft.com/sql/ssms/scripting/generate-and-publish-scripts-wizard?view=sql-server-2017).
        > - Дополнительные сведения о схеме abfss:// см. в этом [руководстве](https://docs.microsoft.com/azure/storage/data-lake-storage/introduction-abfs-uri).
        > - Дополнительные сведения об инструкции CREATE EXTERNAL DATA SOURCE см. в этом [руководстве](https://docs.microsoft.com/sql/t-sql/statements/create-external-data-source-transact-sql).
        
    1. Выполните запрос как обычно, используя [внешние таблицы](https://docs.microsoft.com/sql/t-sql/statements/create-external-table-transact-sql).

### <a name="azure-sql-database-blob-auditing"></a>Аудит BLOB-объектов баз данных SQL Azure

При аудите больших двоичных объектов журналы аудита отправляются в вашу учетную запись хранения. Если эта учетная запись хранения использует функцию конечных точек службы виртуальной сети, то подключение из базы данных SQL Azure к учетной записи хранения будет прервано.

## <a name="adding-a-vnet-firewall-rule-to-your-server-without-turning-on-vnet-service-endpoints"></a>Добавление правила брандмауэра виртуальной сети к серверу без включения конечных точек службы виртуальной сети

Пока возможности этой функции не были расширены, вам нужно было включить конечные точки службы виртуальной сети, чтобы реализовать динамическое правило виртуальной сети в брандмауэре. Конечные точки связывают данную подсеть виртуальной сети с базой данных SQL Azure. По состоянию на январь 2018 г. это требование можно обойти, задав параметр **IgnoreMissingVNetServiceEndpoint**.

Если задать лишь правило брандмауэра, вы не сможете обеспечить безопасность сервера. Для этого вам также потребуется включить конечные точки службы виртуальной сети. При включении конечных точек службы подсеть виртуальной сети будет простаивать, пока не будет выполнен переход из состояния "Выкл." в состояние "Вкл.". Это особенно верно в случае с большими виртуальными сетями. С помощью параметра **IgnoreMissingVNetServiceEndpoint** можно уменьшить или исключить время простоя во время перехода.

Задать параметр **IgnoreMissingVNetServiceEndpoint** можно с помощью PowerShell. Дополнительные сведения см. в статье [Создание конечной точки службы и правила виртуальной сети для базы данных SQL Azure с помощью PowerShell][sql-db-vnet-service-endpoint-rule-powershell-md-52d].

## <a name="errors-40914-and-40615"></a>Ошибки 40914 и 40615

Ошибка подключения 40914 относится к *правилам виртуальных сетей*, указанным в области "Брандмауэр" на портале Azure. Ошибка 40615 отличается от предыдущей тем, что относится к *правилам IP-адресов* в брандмауэре.

### <a name="error-40914"></a>Ошибка 40914

*Текст сообщения.* Невозможно открыть сервер *[имя-сервера]*, запрашиваемый именем входа. Клиенту запрещен доступ к серверу.

*Описание ошибки.* Клиент находится в подсети, которая содержит конечные точки сервера виртуальной сети. Но для сервера базы данных SQL Azure не установлено правило виртуальной сети, разрешающее подсети обмениваться данными с базой данных SQL.

*Устранение ошибки.* В области "Брандмауэр" портала Azure с помощью элемента управления правилами виртуальных сетей [добавьте правило виртуальной сети](#anchor-how-to-by-using-firewall-portal-59j) для этой подсети.

### <a name="error-40615"></a>Ошибка 40615

*Текст сообщения.* Не удается открыть сервер {0}, запрашиваемый с использованием имени для входа. Для клиента с IP-адресом {1} доступ к серверу запрещен.

*Описание ошибки.* Клиент пытается подключиться с IP-адреса, который не авторизован на подключение к серверу Базы данных SQL Azure. Брандмауэр сервера не содержит правило IP-адресов, разрешающее клиенту обмениваться данными с базой данных SQL с этого IP-адреса.

*Устранение ошибки.* Введите IP-адрес клиента в качестве правила IP-адреса. Это следует сделать в области "Брандмауэр" на портале Azure.

Список сообщений об ошибках базы данных SQL содержится в [этом документе][sql-database-develop-error-messages-419g].

<a name="anchor-how-to-by-using-firewall-portal-59j" />

## <a name="portal-can-create-a-virtual-network-rule"></a>Портал может создать правило виртуальной сети

В этом разделе показано, как с помощью [портала Azure][http-azure-portal-link-ref-477t] создать *правило виртуальной сети* в базе данных SQL Azure. Правило предписывает базе данных SQL принимать подключения из определенной подсети, которая помечена как *конечная точка службы виртуальной сети*.

> [!NOTE]
> Если вы собираетесь добавить конечную точку службы в правила брандмауэра виртуальной сети на сервере Базы данных SQL Azure, сначала убедитесь, что конечные точки службы включены для подсети.
>
> Если конечные точки службы не включены для подсети, портал предложит их включить. Нажмите кнопку **Включить** в той же колонке, в которой вы добавляете правило.

## <a name="powershell-alternative"></a>Альтернатива PowerShell

Создать правила виртуальной сети можно также с помощью сценария PowerShell. Для этого используется командлет **New-AzureRmSqlServerVirtualNetworkRule**. Если вам это интересно, ознакомьтесь с разделом [Создание конечной точки службы и правила виртуальной сети для базы данных SQL Azure с помощью PowerShell][sql-db-vnet-service-endpoint-rule-powershell-md-52d].

## <a name="rest-api-alternative"></a>Альтернативный REST API

На внутреннем уровне командлеты PowerShell для действий виртуальной сети SQL вызывают REST API. REST API можно вызывать напрямую.

- [Правила для виртуальной сети. Операции][rest-api-virtual-network-rules-operations-862r]

## <a name="prerequisites"></a>Предварительные требования

Необходима подсеть, помеченная определенным *именем типа* конечной точки службы виртуальной сети, относящимся к базе данных SQL Azure.

- В нашем случае именем типа конечной точки является **Microsoft.Sql**.
- Если ваша подсеть, возможно, не помечена именем типа, прочитайте раздел [Проверка того, является ли подсеть конечной точкой][sql-db-vnet-service-endpoint-rule-powershell-md-a-verify-subnet-is-endpoint-ps-100].

<a name="a-portal-steps-for-vnet-rule-200" />

## <a name="azure-portal-steps"></a>Инструкции для портала Azure

1. Войдите на [портал Azure][http-azure-portal-link-ref-477t].

2. Выберите **Серверы SQL Server** &gt; **Брандмауэр или виртуальные сети**.

3. Задайте для элемента управления **Разрешить доступ к службам Azure** значение "Выкл.".

    > [!IMPORTANT]
    > Если оставить для этого элемента управления значение "Вкл.", то сервер базы данных SQL Azure будет принимать подключение из любой подсети, что сделает доступ слишком незащищенным. Используя конечные точки службы виртуальной сети Microsoft Azure с правилами виртуальной сети базы данных SQL можно уменьшить контактную зону системы безопасности.

4. Щелкните элемент управления **+ Добавить существующий** в разделе **Виртуальные сети**.

    ![Щелкните "Добавить существующий" (добавьте конечную точку подсети в виде правила SQL).][image-portal-firewall-vnet-add-existing-10-png]

5. В новой области **Создание или изменение** введите в элементы управления имена ресурсов Azure.

    > [!TIP]
    > Необходимо указать правильный **префикс адреса** для подсети. Его значение можно найти на портале.
    > Выберите **Все ресурсы** &gt; **Все типы** &gt; **Виртуальные сети**. Фильтр отобразит ваши виртуальные сети. Выберите свою виртуальную сеть и щелкните **Подсети**. Столбец **Диапазон адресов** содержит интересующий вас префикс адреса.

    ![Заполните поля для нового правила.][image-portal-firewall-create-update-vnet-rule-20-png]

6. Нажмите кнопку **ОК** в нижней части области.

7. Созданное правило виртуальной сети отобразится в области брандмауэра.

    ![Просмотрите новое правило в области брандмауэра.][image-portal-firewall-vnet-result-rule-30-png]

> [!NOTE]
> К правилам применяются следующие статусы или состояния:
> - **Готово.** Указывает, что операция, которую вы инициировали, завершена успешно.
> - **Сбой.** Указывает, что операция, которую вы инициировали, завершена сбоем.
> - **Удалено.** Применяется только к операции удаления и указывает, что правило удалено и больше не применяется.
> - **Выполняется.** Указывает, что операция выполняется. Старое правило применяется, когда операция находится в этом состоянии.

<a name="anchor-how-to-links-60h" />

## <a name="related-articles"></a>Связанные статьи

- [Конечные точки служб виртуальной сети][vm-virtual-network-service-endpoints-overview-649d]
- [Правила брандмауэра уровня сервера и уровня базы данных SQL Azure][sql-db-firewall-rules-config-715d]

Функция правила виртуальной сети для базы данных SQL Azure стала доступной в конце сентября 2017 г.

## <a name="next-steps"></a>Дополнительная информация

- [Создание конечной точки службы и правила виртуальной сети для базы данных SQL Azure с помощью PowerShell][sql-db-vnet-service-endpoint-rule-powershell-md-52d]
- [Правила для виртуальной сети. Операции][rest-api-virtual-network-rules-operations-862r] с REST API.

<!-- Link references, to images. -->

[image-portal-firewall-vnet-add-existing-10-png]: media/sql-database-vnet-service-endpoint-rule-overview/portal-firewall-vnet-add-existing-10.png

[image-portal-firewall-create-update-vnet-rule-20-png]: media/sql-database-vnet-service-endpoint-rule-overview/portal-firewall-create-update-vnet-rule-20.png

[image-portal-firewall-vnet-result-rule-30-png]: media/sql-database-vnet-service-endpoint-rule-overview/portal-firewall-vnet-result-rule-30.png

<!-- Link references, to text, Within this same GitHub repo. -->

[arm-deployment-model-568f]: ../azure-resource-manager/resource-manager-deployment-model.md

[expressroute-indexmd-744v]: ../expressroute/index.yml

[rbac-what-is-813s]:../role-based-access-control/overview.md

[sql-db-firewall-rules-config-715d]: sql-database-firewall-configure.md

[sql-database-develop-error-messages-419g]: sql-database-develop-error-messages.md

[sql-db-vnet-service-endpoint-rule-powershell-md-52d]: sql-database-vnet-service-endpoint-rule-powershell.md

[sql-db-vnet-service-endpoint-rule-powershell-md-a-verify-subnet-is-endpoint-ps-100]: sql-database-vnet-service-endpoint-rule-powershell.md#a-verify-subnet-is-endpoint-ps-100

[vm-configure-private-ip-addresses-for-a-virtual-machine-using-the-azure-portal-321w]: ../virtual-network/virtual-networks-static-private-ip-arm-pportal.md

[vm-virtual-network-service-endpoints-overview-649d]: https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoints-overview

[vpn-gateway-indexmd-608y]: ../vpn-gateway/index.yml

<!-- Link references, to text, Outside this GitHub repo (HTTP). -->

[http-azure-portal-link-ref-477t]: https://portal.azure.com/

[rest-api-virtual-network-rules-operations-862r]: https://docs.microsoft.com/rest/api/sql/virtualnetworkrules

<!-- ??2
#### Syntax related articles
- REST API Reference, including JSON

- Azure CLI

- ARM templates
-->
