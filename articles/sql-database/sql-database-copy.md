---
title: Копирование базы данных SQL Azure | Документация Майкрософт
description: Создание транзакционно согласованной копии существующей базы данных SQL Azure на том же или на другом сервере.
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: CarlRabeler
ms.author: carlrab
ms.reviewer: carlrab
manager: craigg
ms.date: 03/12/2019
ms.openlocfilehash: 87db25bbfd68aea1b8835211d7b51dfddcd43038
ms.sourcegitcommit: 5839af386c5a2ad46aaaeb90a13065ef94e61e74
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2019
ms.locfileid: "57899389"
---
# <a name="copy-a-transactionally-consistent-copy-of-an-azure-sql-database"></a>Копирование транзакционно согласованной копии базы данных Azure SQL

База данных SQL Azure предоставляет несколько методов создания транзакционно согласованной копии имеющейся базы данных SQL Azure на том же или на другом сервере. Базу данных SQL можно копировать с помощью портала Azure, PowerShell или T-SQL. 

## <a name="overview"></a>Обзор

Копия базы данных представляет собой моментальный снимок исходной базы данных на момент запроса копирования. Вы можете выбрать тот же или другой сервер, его уровень служб и объем вычислительных ресурсов, а также другой объем вычислительных ресурсов в рамках установленного уровня служб (выпуска). После завершения копирования копия становится полностью работоспособной и независимой базой данных. На этом этапе можно перейти на использование любой более поздней или более ранней версии. Именами входа, пользователями и разрешениями можно управлять независимо.  

> [!NOTE]
> [Создаваемые автоматически резервные копии базы данных](sql-database-automated-backups.md) используются при создании копии базы данных.

## <a name="logins-in-the-database-copy"></a>Имена входа в копии базы данных

При копировании базы данных на тот же сервер Базы данных SQL можете использовать для обеих баз данных одинаковые имена входа. Субъект безопасности, используемый для копирования базы данных, становится владельцем новой базы данных. В копируемую базу данных копируются все пользователи, их разрешения и идентификаторы безопасности (SID).  

При копировании базы данных на другой сервер Базы данных SQL субъект безопасности на новом сервере становится владельцем новой базы данных. Если вы используете [пользователей автономной базы данных](sql-database-manage-logins.md) для доступа к данным, это гарантирует, что база данных-источник и база данных-получатель всегда имеют одинаковые учетные данные пользователей, поэтому после завершения копирования к копии можно будет немедленно обратиться, используя прежние учетные данные. 

Если вы используете [Azure Active Directory](../active-directory/fundamentals/active-directory-whatis.md), то можно полностью исключить потребность в управлении учетными данными в копии. Тем не менее при копировании базы данных на новый сервер доступ по имени для входа может перестать работать, так на новом сервере отсутствуют имена для входа. В статье [Настройка безопасности Базы данных SQL Azure и управление ею для геовосстановления или отработки отказа](sql-database-geo-replication-security-config.md) описывается управление именами для входа при копировании базы данных на другой сервер Базы данных SQL. 

С момента успешного завершения копирования и вплоть до сопоставления остальных пользователей войти в новую базу данных может только ее владелец, т. е. пользователь, инициировавший копирование. Сведения о разрешении имен для входа после завершения операции копирования см. в разделе [Копирование базы данных SQL Azure с помощью Transact-SQL](#resolve-logins).

## <a name="copy-a-database-by-using-the-azure-portal"></a>Копирование базы данных на портале Azure

Чтобы скопировать базу данных с помощью портала Azure, откройте страницу базы данных и щелкните **Копировать**. 

   ![Копирование базы данных](./media/sql-database-copy/database-copy.png)

## <a name="copy-a-database-by-using-powershell"></a>Копирование базы данных с помощью PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается базой данных SQL Azure, но все будущие разработки — для модуля Az.Sql. Для этих командлетов см. в разделе [AzureRM.Sql](https://docs.microsoft.com/powershell/module/AzureRM.Sql/). Аргументы для команд в модуле Az и в модуле AzureRm практически идентичны.

Чтобы скопировать базу данных с помощью PowerShell, используйте [New AzSqlDatabaseCopy](/powershell/module/az.sql/new-azsqldatabasecopy) командлета. 

```PowerShell
New-AzSqlDatabaseCopy -ResourceGroupName "myResourceGroup" `
    -ServerName $sourceserver `
    -DatabaseName "MySampleDatabase" `
    -CopyResourceGroupName "myResourceGroup" `
    -CopyServerName $targetserver `
    -CopyDatabaseName "CopyOfMySampleDatabase"
```

Полный пример сценария см. в статье [Копирование базы данных SQL на новый сервер с помощью PowerShell](scripts/sql-database-copy-database-to-new-server-powershell.md).

## <a name="copy-a-database-by-using-transact-sql"></a>Копирование базы данных с помощью Transact-SQL

Войдите в базу данных master под именем для входа субъекта на уровне сервера или под именем для входа, которое использовалось для создания копируемой базы данных. Для успешного копирования базы данных имена для входа, не принадлежащие субъектам уровня сервера, должны быть членами роли dbmanager. Дополнительные сведения об именах для входа и подключении к серверу см. в статье [Проверка подлинности и авторизация в базе данных SQL: предоставление доступа](sql-database-manage-logins.md).

Начните копирование исходной базы данных с помощью инструкции [CREATE DATABASE](https://msdn.microsoft.com/library/ms176061.aspx) . Данный оператор запускает процесс копирования базы данных. Так как копирование базы данных — процесс асинхронный, оператор CREATE DATABASE возвращается до завершения копирования базы данных.

### <a name="copy-a-sql-database-to-the-same-server"></a>Копирование Базы данных SQL на тот же сервер

Войдите в базу данных master под именем для входа субъекта на уровне сервера или под именем для входа, которое использовалось для создания копируемой базы данных. Для успешного копирования базы данных имена для входа, не принадлежащие субъектам уровня сервера, должны быть членами роли dbmanager.

Эта команда копирует Database1 в новую базу данных с именем Database2 на том же сервере. Операция копирования может занять некоторое время в зависимости от размера базы данных.

    -- Execute on the master database.
    -- Start copying.
    CREATE DATABASE Database2 AS COPY OF Database1;

### <a name="copy-a-sql-database-to-a-different-server"></a>Копирование Базы данных SQL на другой сервер

Войдите в базу данных master на целевом сервере, т. е. на сервер Базы данных SQL, на котором необходимо создать базу данных. Для входа укажите имя пользователя и пароль владельца базы данных-источник на исходном сервере Базы данных SQL. Имя входа на целевом сервере также должно относиться к роли dbmanager или являться основным именем входа на уровне сервера.

Эта команда копирует Database1 на сервере server1 в новую базу данных с именем Database2 на сервере server2. Операция копирования может занять некоторое время в зависимости от размера базы данных.

    -- Execute on the master database of the target server (server2)
    -- Start copying from Server1 to Server2
    CREATE DATABASE Database2 AS COPY OF server1.Database1;

## <a name="to-move-a-database-between-subscriptions"></a>Перенос базы данных из одной подписки в другую

На [портале Azure](https://portal.azure.com)щелкните **Серверы SQL Server** и выберите из списка сервер, на котором размещена ваша база данных. Щелкните **Перенести**и выберите ресурсы, которые нужно перенести, а также подписку, в которую их нужно переместить.

### <a name="monitor-the-progress-of-the-copying-operation"></a>Отслеживание хода операции копирования

Следить за ходом процесса копирования можно в представлениях sys.databases и sys.dm_database_copies. Во время копирования в столбце **state_desc** представления sys.databases для новой базы данных отображается значение **COPYING**.

* Если копирование завершается неудачей, в столбце **state_desc** представления sys.databases для новой базы данных отображается значение **SUSPECT**. Выполните инструкцию DROP для новой базы данных и повторите попытку позднее.
* Если копирование завершается успешно, в столбце **state_desc** представления sys.databases для новой базы данных отображается значение **ONLINE**. Это означает, что копирование завершено и новая база данных является обычной базой данных, которую можно изменять независимо от исходной.

> [!NOTE]
> Чтобы отменить копирование до его завершения, выполните в новой базе данных инструкцию [DROP DATABASE](https://msdn.microsoft.com/library/ms178613.aspx). Кроме того, процесс копирования отменяет также выполнение оператора DROP DATABASE в исходной базе данных.

## <a name="resolve-logins"></a>Разрешение имен для входа

После того как новая база данных на целевом сервере будет в сети, сопоставьте пользователей из новой базы данных с именами входа на целевом сервере с помощью оператора [ALTER USER](https://msdn.microsoft.com/library/ms176060.aspx). Сведения о разрешении потерянных пользователей см. в разделе [Диагностика пользователей, утративших связь с учетной записью](https://msdn.microsoft.com/library/ms175475.aspx). Ознакомьтесь также со статьей [Как управлять безопасностью базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).

Все пользователи в новой базе данных получают такие же разрешения, как и в исходной базе данных. Пользователь, инициировавший копирование базы данных, становится владельцем новой базы данных и получает новый идентификатор безопасности (SID). С момента успешного завершения копирования и вплоть до сопоставления остальных пользователей войти в новую базу данных может только ее владелец, т. е. пользователь, инициировавший копирование.

Дополнительные сведения об управлении пользователями и именами для входа при копировании базы данных на другой сервер Базы данных SQL см. в статье [Настройка безопасности Базы данных SQL Azure и управление ею для геовосстановления или отработки отказа](sql-database-geo-replication-security-config.md).

## <a name="next-steps"></a>Дальнейшие действия

* Сведения об именах для входа см. в статьях [Предоставление доступа к базе данных и управление им](sql-database-manage-logins.md) и [Настройка безопасности Базы данных SQL Azure и управление ею для геовосстановления или отработки отказа](sql-database-geo-replication-security-config.md).
* Сведения об экспорте базы данных см. в статье [Экспорт базы данных SQL Azure или SQL Server в BACPAC-файл](sql-database-export.md).
