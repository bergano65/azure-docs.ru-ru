---
title: Миграция виртуальных машин Hyper-V в Azure с помощью средства "Миграция сервера" в службе "Миграция Azure"
description: Сведения о миграции локальных виртуальных машин Hyper-V в Azure с помощью средства "Миграция сервера" в службе "Миграция Azure"
ms.topic: tutorial
ms.date: 06/08/2020
ms.custom:
- MVC
- fasttrack-edit
ms.openlocfilehash: 2d31c5b90f37f336b48118e4f4adde4777f8cf4a
ms.sourcegitcommit: d60976768dec91724d94430fb6fc9498fdc1db37
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/02/2020
ms.locfileid: "96493140"
---
# <a name="migrate-hyper-v-vms-to-azure"></a>Перенос виртуальных машин Hyper-V в Azure 

В этой статье показано, как перенести локальные виртуальные машины Hyper-V в Azure с помощью инструмента [Миграция сервера](migrate-services-overview.md#azure-migrate-server-migration-tool) службы "Миграция Azure".

Это руководство является третьим в серии, в которой показано, как оценивать и переносить компьютеры в Azure. 

> [!NOTE]
> В руководствах показан простейший путь развертывания сценария, использование которого позволяет быстро настроить проверку концепции. В руководствах по возможности используются параметры по умолчанию и показаны не все возможные параметры и пути. 

 В этом руководстве описано следующее:

> [!div class="checklist"]
> * Добавьте средство "Миграция сервера" службы "Миграция Azure".
> * Обнаружение виртуальных машин, которые требуется перенести.
> * Запуск репликации виртуальных машин.
> * Выполнение тестовой миграции, позволяющей убедиться в правильной работе всех компонентов.
> * Выполнение полной миграции виртуальной машины.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу.


## <a name="prerequisites"></a>Предварительные требования


Для работы с этим руководством вам потребуется:

1. [Просмотрите](hyper-v-migration-architecture.md) архитектуру миграции Hyper-V.
2. [Проверьте](migrate-support-matrix-hyper-v-migration.md#hyper-v-host-requirements) требования к узлу Hyper-V для миграции и URL-адреса Azure, к которым узлам и кластерам Hyper-V необходим доступ для миграции виртуальных машин.
3. [Просмотрите требования](migrate-support-matrix-hyper-v-migration.md#hyper-v-vms) для виртуальных машин Hyper-V, которые вы хотите перенести в Azure.
4. Рекомендуется [оценить виртуальные машины Hyper-V](tutorial-assess-hyper-v.md) перед их переносом в Azure, но это необязательно.
5. Перейдите к созданному проекту или [создайте новый проект](https://docs.microsoft.com/azure/migrate/create-manage-projects).
6. Проверьте разрешения своей учетной записи. Учетная запись Azure должна иметь разрешения на создание виртуальной машины и на запись на управляемый диск Azure.

## <a name="download-and-install-the-provider"></a>Скачивание и установка поставщика

Для миграции виртуальных машин Hyper-V инструмент "Миграция сервера" службы "Миграция Azure" устанавливает поставщики программного обеспечения (поставщик Microsoft Azure Site Recovery и агент служб восстановления Microsoft Azure) на узлах Hyper-V или узлах кластера. Обратите внимание, что [устройство службы "Миграция Azure"](migrate-appliance.md) не используется для миграции Hyper-V.

1. В проекте "Миграция Azure" > **Серверы**, в разделе **Azure Migrate: Server Migration** (Миграция Azure: Миграция сервера), выберите **Обнаружить**.
2. В разделе **Обнаружение компьютеров** > **Ваши компьютеры виртуализированы?** выберите **Yes, with Hyper-V** (Да, с помощью Hyper-V).
3. В поле **Целевой регион** выберите регион Azure, в который необходимо перенести компьютеры.
6. Выберите параметр **Подтвердите, что целевым регионом для миграции является "имя-региона"** .
7. Щелкните **Создать ресурсы**. После этого в фоновом режиме создается хранилище Azure Site Recovery.
    - Если вы уже настроили миграцию с помощью миграции сервера в службе миграции Azure, этот параметр не будет отображаться, так как ресурсы были настроены ранее.
    - После нажатия этой кнопки вы не сможете изменить целевой регион для этого проекта.
    - Все последующие миграции будут выполняться в этот регион.
    
8. В разделе **Prepare Hyper-V host servers** (Подготовка серверов узла Hyper-V) скачайте поставщик репликации Hyper-V и файл ключа регистрации.
    - Ключ регистрации необходим для регистрации узла Hyper-V на сервере Миграции Azure.
    - Ключ действителен в течение пяти дней после создания.

    ![Загрузка поставщика и ключа](./media/tutorial-migrate-hyper-v/download-provider-hyper-v.png)

4. Скопируйте файл установки поставщика и файл ключа регистрации на каждый узел Hyper-V (или узел кластера), на котором запущены виртуальные машины, которые необходимо реплицировать.
5. Запустите файл установки поставщика на каждом узле, как описано ниже.
6. После установки поставщика на узлах в окне **Обнаружение компьютеров** выберите **Finalize registration** (Завершить регистрацию).

    ![Завершение регистрации](./media/tutorial-migrate-hyper-v/finalize-registration.png)

После завершения регистрации может пройти до 15 минут, пока обнаруженные виртуальные машины не отобразятся в сервере миграции Azure. При обнаружении виртуальных машин количество **обнаруженных серверов** увеличивается.

![Обнаруженные серверы](./media/tutorial-migrate-hyper-v/discovered-servers.png)


## <a name="replicate-hyper-v-vms"></a>Репликация виртуальных машин Hyper-V

По завершении обнаружения, вы можете начать репликацию виртуальных машин в Azure.

> [!NOTE]
> Можно реплицировать до 10 виртуальных машин за раз. Если требуется реплицировать большее число виртуальных машин, выполните одновременную репликацию в пакетах из 10 машин.

1. В проекте службы "Миграция Azure" щелкните **Серверы** и в разделе **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) выберите **Репликация**.
2. В разделе **Репликация** выберите **Параметры исходного кода** > **Ваши компьютеры виртуализированы?** выберите **Да, с Hyper-V**. Выберите **Next: Виртуальные машины**.
3. В разделе **Виртуальные машины** выберите виртуальные машины, которые необходимо реплицировать.
    - Если вы выполнили оценку для виртуальных машин, вы можете применить рекомендации по выбору размера виртуальной машины и типу диска ("Премиум" или "Стандарт") из результатов оценки. Для этого в поле **Импортировать параметры миграции из средства оценки Миграции Azure?** выберите вариант **Да**.
    - Если вы не проводили оценку или не хотите использовать параметры оценки, выберите вариант **Нет**.
    - Если вы решили использовать оценку, выберите группу виртуальных машин и имя оценки.

        ![Выбор оценки](./media/tutorial-migrate-hyper-v/select-assessment.png)

4. В разделе **Виртуальные машины** найдите виртуальные машины и отметьте каждую виртуальную машину, которую вы хотите перенести. Затем нажмите **следующее: Целевые параметры**.

    ![Выбор виртуальных машин](./media/tutorial-migrate-hyper-v/select-vms.png)

5. В разделе **Целевые параметры** выберите целевой регион, в который вы хотите выполнить миграцию, подписку, а также группу ресурсов, в которой будут находиться виртуальные машины Azure после миграции.
7. В поле **Учетная запись хранения репликации** выберите учетную запись хранения Azure, в которой будут храниться реплицированные данные в Azure.
8. В разделе **Виртуальная сеть** выберите виртуальную сеть или подсеть Azure, к которой будут подключены виртуальные машины Azure после миграции.
9. В области **Параметры доступности** выберите следующие параметры.
    -  "Зона доступности", чтобы закрепить перенесенный компьютер в определенной зоне доступности в регионе. Используйте этот параметр для распределения серверов, образующих уровень приложения с несколькими узлами, по зонам доступности. Если вы выберете этот параметр, нужно будет указать зону доступности, чтобы использовать ее для каждого из выбранных компьютеров на вкладке "Вычисление". Этот параметр доступен только в том случае, если в целевом регионе, выбранном для миграции, поддерживаются зоны доступности.
    -  "Группа доступности", чтобы поместить перенесенную виртуальную машину в группу доступности. Чтобы использовать этот параметр, выбранная целевая группа ресурсов должна содержать одну или несколько групп доступности.
    - Параметр "Избыточность инфраструктуры не требуется", если вам не нужна ни одна из этих конфигураций доступности для перенесенных виртуальных машин.
10. Для параметра **Преимущество гибридного использования Azure**

    - выберите вариант **Нет**, если вы не хотите применять Преимущество гибридного использования Azure. Затем щелкните **Далее**.
    - Выберите вариант **Да**, если у вас есть компьютеры с Windows Server, на которые распространяются активные подписки Software Assurance или Windows Server, и вы хотите применить это преимущество к компьютерам, которые вы переносите. Затем нажмите кнопку **Далее**.

    ![Целевые параметры](./media/tutorial-migrate-hyper-v/target-settings.png)

11. В разделе **Вычисление** проверьте имя виртуальной машины, ее размер, тип диска ОС и конфигурацию доступности (если она выбрана на предыдущем шаге). Виртуальные машины должны соответствовать [требованиям Azure](migrate-support-matrix-hyper-v-migration.md#azure-vm-requirements).

    - **Размер виртуальной машины**. Если вы используете рекомендации по оценке, раскрывающийся список размеров виртуальных машин будет содержать рекомендуемый размер. В противном случае Миграция Azure выбирает размер в зависимости от ближайшего совпадения в подписке Azure. В качестве альтернативы выберите размер вручную в разделе **Размер виртуальной машины Azure**. 
    - **Диск ОС**: Укажите загрузочный диск ОС для виртуальной машины. Диск ОС — это диск с загрузчиком операционной системы и установщиком. 
    - **Группа доступности**. Если виртуальная машина должна находиться в группе доступности Azure после миграции, укажите эту группу. Группа должна находиться в целевой группе ресурсов, которую вы указываете для миграции.

    ![Параметры вычисления виртуальной машины](./media/tutorial-migrate-hyper-v/compute-settings.png)

12. В разделе **Диски** укажите диски виртуальных машин, которые нужно реплицировать в Azure. Затем нажмите кнопку **Далее**.
    - Диски можно исключить из репликации.
    - Если вы исключите диски, они не будут присутствовать на виртуальной машине Azure после миграции. 

    ![Снимок экрана, на котором показана вкладка "Диски" диалогового окна "Репликация".](./media/tutorial-migrate-hyper-v/disks.png)

13. В разделе **Review and start replication** (Просмотр и запуск репликации) просмотрите параметры и нажмите кнопку **Реплицировать**, чтобы начать первоначальную репликацию серверов.

> [!NOTE]
> Вы можете обновить параметры репликации в любое время до начала репликации в разделе **Управление** > **Репликация компьютеров**. Настройки невозможно изменить после начала репликации.

## <a name="provision-for-the-first-time"></a>Подготовка выполняется впервые

Если это первая виртуальная машина, которую вы реплицируете в проекте службы "Миграция Azure", служба "Миграция Azure": миграция сервера автоматически подготавливает эти ресурсы в той же группе ресурсов, что и проект.

- **Служебная шина** Миграция Azure Средство "Миграция сервера" использует служебную шину для отправки сообщений оркестровки репликации на устройство.
- **Учетная запись хранения шлюза**. Миграция Azure Миграция сервера использует учетную запись шлюза для хранения информации о состоянии реплицируемых виртуальных машин.
- **Учетная запись хранения журналов**. Устройство Миграции Azure загружает журналы репликации для виртуальных машин в учетную запись хранения журналов. Миграция Azure применяет сведения о репликации к управляемым дискам реплики.
- **Хранилище ключей**. Устройство Миграции Azure использует хранилище ключей для управления строками подключения для служебной шины и ключами доступа для учетных записей хранения, используемых при репликации. Вы должны были установить разрешения, необходимые хранилищу ключей для доступа к учетной записи хранения, [на этапе подготовки Azure](./tutorial-discover-hyper-v.md#prepare-an-azure-user-account) для оценки и переноса виртуальных машин Hyper-V. 


## <a name="track-and-monitor"></a>Отслеживание и мониторинг


- Когда вы нажимаете кнопку **Реплицировать**, выполняется задание "Запуск репликации". 
- После успешного завершения задания "Запуск репликации" компьютеры начинают первоначальную репликацию в Azure.
- После завершения начальной репликации начинается разностная репликация. Добавочные изменения на локальных дисках периодически реплицируются в Azure.

Отслеживать состояние задания можно в уведомлениях портала.

Вы можете отслеживать состояние репликации, щелкнув **Репликация серверов** в разделе **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера).
![Мониторинг репликации](./media/tutorial-migrate-hyper-v/replicating-servers.png)



## <a name="run-a-test-migration"></a>Выполнение тестовой миграции


Когда начинается разностная репликация, вы можете запустить тестовую миграцию для виртуальных машин перед выполнением полной миграции в Azure. Мы настоятельно рекомендуем сделать это хотя бы один раз для каждой машины перед ее миграцией.

- Запуск тестовой миграции позволяет проверить, что миграция будет работать должным образом, не затрагивая локальные машины, которые остаются работоспособными и продолжают репликацию. 
- Тестовая миграция моделирует миграцию путем создания виртуальной машины Azure с использованием реплицированных данных (обычно выполняется миграция в нерабочую виртуальную сеть в вашей подписке Azure).
- Вы можете использовать реплицированную тестовую виртуальную машину Azure для проверки миграции, выполнения тестирования приложений и решения любых проблем перед полной миграцией.

Выполните тестовую миграцию следующим образом:


1. Последовательно выберите разделы **Цели миграции** > **Серверы** > **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) щелкните **Тестовая миграция серверов выполнена**.

     ![Тестовая миграция серверов](./media/tutorial-migrate-hyper-v/test-migrated-servers.png)

2. Щелкните правой кнопкой мыши виртуальную машину, чтобы выполнить тест, и выберите **Тестовая миграция**.

    ![Тестовая миграция](./media/tutorial-migrate-hyper-v/test-migrate.png)

3. В разделе **Тестовая миграция** выберите виртуальную сеть Azure, в которой будет находиться виртуальная машина Azure после миграции. Мы рекомендуем использовать нерабочую виртуальную сеть.
4. Запустится задание **Тестовая миграция**. Отслеживайте задание и уведомления на портале.
5. После завершения миграции просмотрите перенастроенную виртуальную машину Azure в разделе **Виртуальные машины** на портале Azure. Имя машины содержит суффикс **-Test**.
6. После завершения теста щелкните правой кнопкой мыши виртуальную машину Azure в разделе **Репликация компьютеров** и выберите **Очистка тестовой миграции**.

    ![Очистка миграции](./media/tutorial-migrate-hyper-v/clean-up.png)


## <a name="migrate-vms"></a>Перенос виртуальных машин

Убедившись, что тестовая миграция работает должным образом, вы можете выполнить миграцию локальных компьютеров.

1. В проекте "Миграция Azure" щелкните **Серверы** > **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) и выберите **Репликация серверов**.

    ![Репликация серверов](./media/tutorial-migrate-hyper-v/replicate-servers.png)

2. В области **Репликация компьютеров** щелкните правой кнопкой мыши виртуальную машину и выберите **Миграция**.
3. В разделе **Миграция** > **Shut down virtual machines and perform a planned migration with no data loss** (Завершить работу виртуальных машин и выполнить запланированную миграцию без потери данных?) выберите вариант **Да** > **ОК**.
    - По умолчанию Миграция Azure выключает локальную виртуальную машину и запускает репликацию по требованию для синхронизации любых изменений виртуальной машины, которые произошли с момента последней репликации. Это гарантирует отсутствие потери данных.
    - Если вы не хотите выключать виртуальную машину, выберите вариант **Нет**.
4. Запустится задание миграции виртуальной машины. Отслеживайте задание в уведомлениях Azure.
5. После завершения работы вы можете просматривать виртуальную машину и управлять ею на странице **Виртуальные машины**.

## <a name="complete-the-migration"></a>Выполнение миграции

1. После завершения миграции щелкните правой кнопкой мыши виртуальную машину и выберите **Stop migration** (Остановка миграции). Таким образом вы сделаете следующее:
    - Остановите репликацию для локального компьютера.
    - Удалите компьютер из числа **реплицируемых серверов** в средстве для миграции серверов Миграции Azure.
    - Очистите информацию о состоянии репликации виртуальной машины.
2. Установите агент виртуальной машины Azure для [Windows](../virtual-machines/extensions/agent-windows.md) или [Linux](../virtual-machines/extensions/agent-linux.md) на перенесенных компьютерах.
3. Выполните любые действия по настройке после миграции приложения, такие как обновление строк подключения к базе данных и конфигурация веб-сервера.
4. Выполните приемочное тестирование конечного приложения и миграции на перенесенном приложении, работающем в Azure.
5. Остановите трафик для перенесенного экземпляра виртуальной машины Azure.
6. Удалите локальные виртуальные машины из списка локальных виртуальных машин.
7. Удалите локальные виртуальные машины из локальных заданий резервного копирования.
8. Обновите внутренние документы и отразите в них новое расположение и IP-адреса виртуальных машин Azure. 

## <a name="post-migration-best-practices"></a>Рекомендации, выполняемые после миграции

- Для повышения устойчивости:
    - Обеспечьте безопасность данных путем резервного копирования виртуальных машин Azure с помощью службы Azure Backup. [Подробнее](../backup/quick-backup-vm-portal.md).
    - Обеспечьте непрерывную работу и постоянную доступность рабочих нагрузок за счет репликации виртуальных машин Azure в дополнительный регион с помощью Site Recovery. [Подробнее](../site-recovery/azure-to-azure-tutorial-enable-replication.md).
- Для повышения уровня безопасности:
    - Заблокируйте и ограничьте доступ входящего трафика с помощью [JIT-администрирования](../security-center/security-center-just-in-time.md) центра безопасности Azure.
    - Ограничьте сетевой трафик конечными точками с помощью [групп безопасности сети](../virtual-network/network-security-groups-overview.md).
    - Разверните [шифрование дисков Azure](../security/fundamentals/azure-disk-encryption-vms-vmss.md), чтобы обеспечить безопасность дисков и защитить данные от кражи и несанкционированного доступа.
    - Ознакомьтесь с дополнительными сведениями о [защите ресурсов IaaS](https://azure.microsoft.com/services/virtual-machines/secure-well-managed-iaas/) и посетите [центр безопасности Azure](https://azure.microsoft.com/services/security-center/).
- Для мониторинга и управления:
-  Рассмотрите возможность развертывания [службы "Управление затратами Azure"](../cost-management-billing/cloudyn/overview.md) для мониторинга использования ресурсов и затрат.


## <a name="next-steps"></a>Дальнейшие действия

Проанализируйте процесс [миграции в облако](/azure/architecture/cloud-adoption/getting-started/migrate) в Azure Cloud Adoption Framework.