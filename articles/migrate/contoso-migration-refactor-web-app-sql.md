---
title: Рефакторинг приложения Contoso путем его переноса в веб-приложение Azure и Базу данных SQL Azure | Документация Майкрософт
description: Узнайте, как Contoso меняет размещение локального приложения путем перемещения его в веб-приложение Azure и Базу данных SQL Server Azure.
services: site-recovery
author: rayne-wiselman
ms.service: site-recovery
ms.topic: conceptual
ms.date: 09/20/2018
ms.author: raynew
ms.openlocfilehash: 39444b20dfefd947abb2f2bc00a9945398996dd0
ms.sourcegitcommit: 4ecc62198f299fc215c49e38bca81f7eb62cdef3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "47040539"
---
# <a name="contoso-migration-refactor-an-on-premises-app-to-an-azure-web-app-and-azure-sql-database"></a>Миграция в компании Contoso: рефакторинг локального приложения для веб-приложения Azure и Базы данных SQL Azure

В этой статье показано, как компания Contoso выполняет рефакторинг своего приложения SmartHotel360 в Azure. Специалисты компании перенесут виртуальную машину внешнего интерфейса приложения в веб-приложение Azure, а базу данных приложения — в Базу данных SQL Azure.

Это документ из цикла статей о том, как вымышленная компания Contoso переносит локальные ресурсы в облако Microsoft Azure. В статьях этого цикла содержатся общие сведения и сценарии развертывания, в которых проиллюстрирована настройка инфраструктуры миграции, оценка пригодности локальных ресурсов для миграции и выполнение различных типов миграции. Сценарии становятся все более сложными. Со временем мы добавим другие статьи.

**Статья** | **Дополнительные сведения** | **Состояние**
--- | --- | ---
[Статья 1. Общие сведения](contoso-migration-overview.md) | Предоставляет общие сведения о стратегии миграции Contoso, цикле статей и примерах приложений, которые мы используем. | Доступна
[Статья 2. Развертывания инфраструктуры Azure](contoso-migration-infrastructure.md) | Здесь рассказывается о том, как Contoso готовит свою локальную инфраструктуру Azure для миграции. Для всех сценариев миграции Contoso используется одна и та же инфраструктура. | Доступна
[Статья 3. Доступ к локальным ресурсам](contoso-migration-assessment.md)  | В этой статье рассказывается, как компания Contoso выполняет оценку своего локального двухуровневого приложения SmartHotel в VMware. Для оценки виртуальных машин приложения компания Contoso использует службу [Миграция Azure](migrate-overview.md). Для оценки базы данных SQL Server приложения используется [помощник по миграции баз данных](https://docs.microsoft.com/sql/dma/dma-overview?view=sql-server-2017). | Доступна
[Статья 4. Повторное размещение приложения на виртуальных машинах Azure и в управляемом экземпляре SQL](contoso-migration-rehost-vm-sql-managed-instance.md) | Здесь демонстрируется, как Contoso выполняет процесс миграции приложения SmartHotel в Azure по методу lift-and-shift. Contoso переносит интерфейсную ВМ приложения с помощью [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview). Базу данных приложения она переносит в управляемый экземпляр SQL с помощью [Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview). | Доступна
[Статья 5. Перемещение приложения в виртуальные машины Azure](contoso-migration-rehost-vm.md) | В этой статье рассказывается, как компания Contoso переносит виртуальные машины приложения SmartHotel, используя только Site Recovery. | Доступна
[Статья 6. Повторное размещение приложения на виртуальных машинах Azure и в группах доступности SQL Server AlwaysOn](contoso-migration-rehost-vm-sql-ag.md) | Здесь показан выполняемый в Contoso процесс миграции приложения SmartHotel. Contoso использует Site Recovery для переноса ВМ приложений и службы миграции баз данных для миграции базы данных приложения в кластер SQL Server, защищенный группой доступности AlwaysOn. | Доступна
[Статья 7. Повторное размещение приложения Linux на виртуальных машинах Azure](contoso-migration-rehost-linux-vm.md) | Здесь показано, как компания Contoso осуществляет миграцию приложения Linux osTicket по методу lift-and-shift на виртуальные машины Azure с помощью Site Recovery | Доступна
[Статья 8. Повторное размещение приложения Linux на виртуальных машинах Azure и сервере MySQL в Azure](contoso-migration-rehost-linux-vm-mysql.md) | В этой статье рассказывается, как компания Contoso выполняет миграцию приложения Linux osTicket на виртуальные машины Azure с помощью Site Recovery и миграцию базы данных приложения в экземпляр Azure MySQL Server с помощью MySQL Workbench. | Доступна
Статья 9. Рефакторинг приложения для веб-приложения Azure и Базы данных SQL Azure | В статье описывается, как Contoso переносит приложение SmartHotel в веб-приложение Azure, а базу данных приложения — в экземпляр SQL Server Azure. | Эта статья
[Статья 10. Рефакторинг приложения Linux для веб-приложений Azure и MySQL для Azure](contoso-migration-refactor-linux-app-service-mysql.md) | В статье описывается, как Contoso переносит приложение osTicket для Linux в веб-приложения Azure на нескольких сайтах, интегрированных с GitHub для непрерывной поставки. База данных приложения переносится в экземпляр Azure MySQL. | Доступна
[Статья 11. Рефакторинг Team Foundation Server в Azure DevOps Services](contoso-migration-tfs-vsts.md) | В этой статье показано, как Contoso выполняет миграцию локального развертывания Team Foundation Server (TFS) путем его переноса в Azure DevOps Services в Azure. | Доступна
[Статья 12. Перепроектирование приложения для использования контейнеров Azure и Базы данных SQL Azure](contoso-migration-rearchitect-container-sql.md) | В статье демонстрируется, как Contoso переносит и перепроектирует приложение SmartHotel в Azure. Специалисты компании перепроектируют веб-уровень приложения в контейнер Windows и переносят базу данных приложения в Базу данных SQL Azure. | Доступна
[Статья 13. Повторное создание приложения в Azure](contoso-migration-rebuild.md) | В статье демонстрируется, как Contoso повторно создает свое приложение SmartHotel, используя ряд возможностей и служб Azure, включая Службу приложений Azure, Azure Kubernetes, Функции Azure, Cognitive Services и Cosmos DB. | Доступна

В этой статье рассказывается, как Contoso выполняет миграцию двухуровневого приложения Windows. Приложение .NET SmartHotel360 работает на виртуальных машинах VMware в Azure. Это приложение с открытым исходным кодом, и если вы хотите использовать его, загрузите его с [GitHub](https://github.com/Microsoft/SmartHotel360).

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Адаптация к расширению бизнеса**. По мере развития компании Contoso растет нагрузка на локальные системы и инфраструктуры.
- **Повышение эффективности**: Contoso необходимо удалить ненужные процедуры и оптимизировать процессы для разработчиков и пользователей.  Бизнес нуждается в том, чтобы ИТ были быстрыми и чтобы не тратить время или деньги, обеспечивая более высокие требования клиентов.
- **Повышение гибкости**. ИТ-отдел компании Contoso нуждается в большей гибкости в отношении потребностей бизнеса. Должна реагировать быстрее, чем изменения на рынке, чтобы включить успех в глобальную экономику реагирования.  Он не должен мешать или становиться помехой для бизнеса.
- **Масштабирование**. По мере того как бизнес успешно растет, ИТ-отдел компании Contoso должен предоставлять системы, способные расти с тем же темпом.
- **Расходы**. Contoso хочет минимизировать стоимость лицензии.

## <a name="migration-goals"></a>Цели миграции

Группа, работающая над облачной инфраструктурой компании Contoso, определила цели этой миграции. Эти цели использовались для определения оптимального метода миграции.

**Требования** | **Дополнительные сведения**
--- | --- 
**Приложение** | Потребность использовать приложение в Azure всегда будет критически важной.<br/><br/> Должны быть доступны те же возможности производительности, что и в настоящее время в VMware.<br/><br/> Команда не считает нужным вкладывать средства в это приложение. Сейчас администраторы будут просто безопасно перемещать приложение в облако.<br/><br/> Команда хочет прекратить поддержку ОС Windows Server 2008 R2, на которой в настоящее время работает приложение.<br/><br/> Команда также хочет перейти с SQL Server 2008 R2 на современную платформу баз данных PaaS, что снизит необходимость в управлении.<br/><br/> Contoso хочет использовать свои инвестиции в лицензирование SQL Server и Software Assurance по мере возможности.<br/><br/> Кроме того, компания Contoso хочет перенести единую точку отказа на веб-уровень.
**Ограничения** | Приложение состоит из приложения ASP.NET и службы WCF, работающей на той же виртуальной машине. С помощью Службы приложений Azure специалисты компании хотят разделить это приложение между двумя веб-приложениями. 
**Таблицы Azure** | Компания Contoso хочет перенести приложение в Azure, но не запускать его на виртуальных машинах. Компания хочет использовать службы Azure PaaS и для уровня данных, и для веб-уровня. 
**DevOps** | Contoso хочет перейти на модель DevOps, используя Azure DevOps для конвейеров сборки и выпуска.

## <a name="solution-design"></a>Архитектура решения

Определив цели и требования, специалисты Contoso начинают разработку и анализ решения развертывания и идентифицируют процесс миграции, включая службы Azure, которые будут использоваться при миграции.

### <a name="current-app"></a>Текущее приложение

- Локальное приложение SmartHotel360 распределено на уровни на двух виртуальных машинах (WEBVM и SQLVM).
- Виртуальные машины расположены на узле VMware ESXi **contosohost1.contoso.com** (версии 6.5).
- Средой VMware управляет сервер vCenter Server 6.5 (**vcenter.contoso.com**), который запущен на виртуальной машине.
- Contoso использует локальный центр обработки данных (contoso-datacenter) с локальным контроллером домена (**contosodc1**).
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.


### <a name="proposed-solution"></a>Предлагаемое решение

- Для уровня базы данных приложения компания Contoso сравнивает Базу данных SQL Azure с SQL Server (в [этой статье](https://docs.microsoft.com/azure/sql-database/sql-database-features)). Компания Contoso решила продолжить работу с Базой данных SQL Azure по нескольким причинам:
    - База данных SQL Azure — это управляемая реляционная база данных. Она обеспечивает прогнозируемую производительность на нескольких уровнях обслуживания с почти нулевым администрированием. Среди преимуществ: динамическая масштабируемость без простоя, встроенная интеллектуальная оптимизация, глобальная масштабируемость и доступность.
    - Contoso может использовать упрощенную версию Помощника по миграции данных (DMA) для оценки и переноса локальной базы данных в SQL Azure.
    - Software Assurance позволит Contoso приобрести Базу данных SQL по сниженной цене, воспользовавшись предложением "Преимущество гибридного использования Azure" для SQL Server. Это может обеспечить экономию до 30 %.
    - База данных SQL предоставляет ряд функций безопасности, включая постоянное шифрование, динамическую маскировку данных, обеспечение безопасности на уровне строк и обнаружение угроз.
- Компания Contoso решила использовать Службу приложений Azure для веб-уровня приложения. Служба PaaS позволяет развернуть приложение, внеся лишь несколько изменений в конфигурацию. Contoso хочет использовать Visual Studio для внесения изменений и развертывания двух веб-приложений. Одно для веб-сайта, а другое для службы приложения WCF.
- Чтобы соответствовать требованиям конвейера DevOps, Contoso выбирает Azure DevOps для управления исходным кодом с репозиториями Git. Автоматические сборки и выпуск будут использоваться для компиляции кода и развертывания его в веб-приложениях Azure.
  
### <a name="solution-review"></a>Проверка решения
Contoso оценивает предлагаемый дизайн, составляя список плюсов и минусов.

**Рассмотрение** | **Дополнительные сведения**
--- | ---
**Преимущества** | Код приложения SmartHotel360 потребуется изменить для миграции в Azure.<br/><br/> Компания Contoso может задействовать свои инвестиции в программу Software Assurance, используя предложение "Преимущество гибридного использования Azure" для SQL Server и Windows Server.<br/><br/> Windows Server 2008 R2 не нужно будет поддерживать после миграции. [Узнайте больше](https://support.microsoft.com/lifecycle).<br/><br/> Contoso может настроить веб-уровень приложения с несколькими экземплярами, после чего он больше не будет являться единой точкой отказа.<br/><br/> Исчезнет зависимость базы данных от устаревающей платформы SQL Server 2008 R2.<br/><br/> База данных SQL поддерживает технические требования. Специалисты компании Contoso провели оценку локальной базы данных с помощью Помощника по миграции баз данных и установили, что она является совместимой.<br/><br/> База данных SQL включает встроенную отказоустойчивость, которую Contoso не нужно настраивать. Это гарантия того, что уровень данных больше не является единой точкой отказа.
**Недостатки** | Служба приложений Azure поддерживает только одно развертывание приложения для каждого веб-приложения. Это означает, что необходимо подготавливать два веб-приложения (одно для веб-сайта, а другое для службы WCF).<br/><br/> Если для переноса своей базы данных Contoso будет использовать Помощник по миграции данных, а не Службу миграции данных, инфраструктура компании не будет готова к масштабному переносу баз данных. Contoso нужно будет создать другой регион для обеспечения отработки отказа в случае недоступности основного региона.

## <a name="proposed-architecture"></a>Предлагаемая архитектура

![Архитектура сценария](media/contoso-migration-refactor-web-app-sql/architecture.png) 


### <a name="migration-process"></a>Процесс миграции

1. Компания подготавливает экземпляр SQL Azure и переносит в него базу данных SmartHotel360.
2. Contoso подготавливает и настраивает веб-приложения и развертывает в них приложение SmartHotel360.

    ![Процесс миграции](media/contoso-migration-refactor-web-app-sql/migration-process.png) 

### <a name="azure-services"></a>Службы Azure

**Служба** | **Описание** | **Стоимость**
--- | --- | ---
[Помощник по миграции баз данных (DMA)](https://docs.microsoft.com/sql/dma/dma-overview?view=ssdt-18vs2017) | DMA используется Contoso для оценки и выявления проблем совместимости, которые могут повлиять на функциональность базы данных в Azure. Помощник оценивает соотношение характеристик между источниками и целями SQL и предоставляет рекомендации по улучшению производительности и надежности. | Это средство можно загрузить бесплатно.
[база данных SQL Azure;](https://azure.microsoft.com/services/sql-database/) | Интеллектуальная полностью управляемая реляционная служба облачной базы данных. | Стоимость зависит от функций, пропускной способности и размера. [Узнайте больше](https://azure.microsoft.com/pricing/details/sql-database/managed/).
[Веб-приложения Службы приложений Azure](https://docs.microsoft.com/azure/app-service/app-service-web-overview) | Создавайте мощные облачные приложения с помощью полностью управляемой платформы. | Стоимость зависит от размера, расположения и длительности использования. [Узнайте больше](https://azure.microsoft.com/pricing/details/app-service/windows/).
[Azure DevOps](https://docs.microsoft.com/azure/azure-portal/tutorial-azureportal-devops) | Предоставляет конвейер непрерывной интеграции и непрерывного развертывания (CI/CD) для разработки приложений. Конвейер запускается с репозиторием Git для управления кодом приложения, системой сборки для создания пакетов и других артефактов сборки и системой управления выпусками для развертывания изменений в средах разработки, тестирования и рабочей среде. 

## <a name="prerequisites"></a>Предварительные требования

Ниже показано, что необходимо сделать специалистам компании Contoso, чтобы реализовать этот сценарий.

**Требования** | **Дополнительные сведения**
--- | ---
**Подписка Azure.** | Компания Contoso уже создала подписки (это описывается в одной из предыдущих статей этой серии). Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/).<br/><br/> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия.<br/><br/> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника.
**Инфраструктура Azure** | [Узнайте, как](contoso-migration-infrastructure.md) компания Contoso настраивает инфраструктуру Azure.


## <a name="scenario-steps"></a>Шаги выполнения сценария

Ниже рассказывается, как компания Contoso выполняет миграцию.

> [!div class="checklist"]
> * **Шаг 1. Подготовка экземпляра Базы данных SQL в Azure**. Contoso подготавливает экземпляр SQL в Azure. После миграции веб-сайта приложения в Azure веб-приложение службы WCF будет указывать на этот экземпляр.
> * **Шаг 2. Миграция базы данных с помощью DMA**. Компания Contoso переносит базу данных приложения с помощью Помощника по миграции баз данных.
> * **Шаг 3. Подготовка веб-приложений**. Компания Contoso подготавливает два веб-приложения.
> * **Шаг 4. Настройка Azure DevOps**. Специалисты компании Contoso создают новый проект Azure DevOps и импортируют репозитории Git.
> * **Шаг 5. Настройка строк подключения**. Специалисты компании Contoso настраивают строки подключения для обеспечения взаимодействия веб-приложения веб-уровня, веб-приложения службы WCF и экземпляра SQL.
> * **Шаг 6. Настройка конвейеров сборки и выпуска**. На последнем этапе Contoso настраивает конвейеры сборки и выпуска для создания приложения и развертывает их в двух отдельных веб-приложениях Azure.


## <a name="step-1-provision-an-azure-sql-database"></a>Шаг 1. Подготовка Базы данных SQL Azure

1. Администраторы компании Contoso решают создать Базу данных SQL в Azure. 

    ![Подготовка SQL](media/contoso-migration-refactor-web-app-sql/provision-sql1.png)

2. Они указывают имя базы данных в соответствии с базой данных, работающей на локальной виртуальной машине (**SmartHotel.Registration**). Они размещают базу данных в группе ресурсов ContosoRG. Это группа ресурсов, которую специалисты компании используют для рабочих ресурсов в Azure.

    ![Подготовка SQL](media/contoso-migration-refactor-web-app-sql/provision-sql2.png)

3. Специалисты компании настраивают новый экземпляр SQL Server (**sql-smarthotel-eus2**) в основном регионе.

    ![Подготовка SQL](media/contoso-migration-refactor-web-app-sql/provision-sql3.png)

4. Они задают ценовую категорию в соответствии с потребностями своего сервера и базы данных, а также предпочитают сэкономить с помощью предложения "Преимущество гибридного использования Azure", так как у них уже есть лицензия SQL Server.
5. Для определения размера они используют вариант приобретения на основе виртуальных ядер и устанавливают ограничения в соответствии с ожидаемыми требованиями.

    ![Подготовка SQL](media/contoso-migration-refactor-web-app-sql/provision-sql4.png)

6. Затем они создают экземпляр базы данных.

    ![Подготовка SQL](media/contoso-migration-refactor-web-app-sql/provision-sql5.png)

7. После создания экземпляра они открывают базу данных и отмечают сведения, которые им нужны при использовании Помощника по миграции базы данных.

    ![Подготовка SQL](media/contoso-migration-refactor-web-app-sql/provision-sql6.png)


**Нужна дополнительная помощь?**

- [Получение справки](https://docs.microsoft.com/azure/sql-database/sql-database-get-started-portal) о подготовке Базы данных SQL.
- [Дополнительные сведения об](https://docs.microsoft.com/azure/sql-database/sql-database-vcore-resource-limits-elastic-pools) ограничениях ресурсов в модели приобретения на основе виртуальных ядер.


## <a name="step-2-migrate-the-database-with-dma"></a>Шаг 2. Миграция базы данных с помощью DMA

Администраторы компании Contoso перенесут базу данных SmartHotel360 с помощью DMA.

### <a name="install-dma"></a>Установка DMA

1. Они загружают инструмент с [центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=53595) к локальной виртуальной машине SQL Server (**SQLVM**).
2. Они запускают установку (DownloadMigrationAssistant.msi) на виртуальной машине.
3. Перед закрытием мастера на странице **Готово** необходимо выбрать **Launch Microsoft Data Migration Assistant** (Запустить помощник по миграции данных Майкрософт).

### <a name="migrate-the-database-with-dma"></a>Миграция базы данных с помощью DMA

1. В DMA специалисты компании создают проект (**SmartHotelDB**) и выбирают **миграцию**. 
2. Специалисты компании выбирают тип исходного сервера **SQL Server**, а целевого — **База данных SQL Azure**. 

    ![DMA](media/contoso-migration-refactor-web-app-sql/dma-1.png)

3. В подробностях о миграции они добавляют **SQLVM** в качестве исходного сервера и базу данных **SmartHotel.Registration**. 

     ![DMA](media/contoso-migration-refactor-web-app-sql/dma-2.png)

4. Они получают ошибку, которая, по всей видимости, связана с проверкой аутентификации. Однако после анализа оказывается, что проблема заключается в наличии точки (.) в имени базы данных. В качестве обходного решения специалисты компании решают подготовить новую базу данных SQL, используя имя **SmartHotel-Registration**. При повторном запуске DMA они смогут выбрать имя **SmartHotel-Registration** и продолжить работу с мастером.

    ![DMA](media/contoso-migration-refactor-web-app-sql/dma-3.png)

5. На вкладке **выбора объектов** они выбирают таблицы базы данных и генерируют скрипт SQL.

    ![DMA](media/contoso-migration-refactor-web-app-sql/dma-4.png)

6. После того как DMS создаст скрипт, нужно нажать кнопку **Deploy schema** (Развернуть схему).

    ![DMA](media/contoso-migration-refactor-web-app-sql/dma-5.png)

7. DMA подтверждает, что развертывание выполнено успешно.

    ![DMA](media/contoso-migration-refactor-web-app-sql/dma-6.png)

8. Теперь специалисты компании начинают процесс миграции.

    ![DMA](media/contoso-migration-refactor-web-app-sql/dma-7.png)

9. После завершения миграции администраторы Contoso могут проверить, что база данных запущена в экземпляре SQL Azure.

    ![DMA](media/contoso-migration-refactor-web-app-sql/dma-8.png)

10. Специалисты компании удаляют на портале Azure дополнительную базу данных SQL **SmartHotel.Registration**.

    ![DMA](media/contoso-migration-refactor-web-app-sql/dma-9.png)


## <a name="step-3-provision-web-apps"></a>Шаг 3. Подготовка веб-приложений

Сейчас, когда база данных уже перенесена, администраторы Contoso могут подготовить два веб-приложения.

1. На портале специалисты компании выбирают **Веб-приложение**.

    ![Веб-приложение](media/contoso-migration-refactor-web-app-sql/web-app1.png)

2. Они указывают имя приложения (**SHWEB EUS2**), запускают его в Windows и помещают в производственную группу ресурсов **ContosoRG**. Специалисты компании создают план и новую службу приложения.

    ![Веб-приложение](media/contoso-migration-refactor-web-app-sql/web-app2.png)

3. После подготовки веб-приложения специалисты компании повторяют процедуру для создания веб-приложения службы WCF (**SHWCF-EUS2**).

    ![Веб-приложение](media/contoso-migration-refactor-web-app-sql/web-app3.png)

4. По завершении создания специалисты компании перейдут по адресам приложений, чтобы проверить, что они были созданы успешно.


## <a name="step-4-set-up-azure-devops"></a>Шаг 4. Настройка Azure DevOps


Компании Contoso необходимо создать инфраструктуру DevOps и конвейеры для приложения.  Для этого администраторы Contoso создают проект DevOps, импортируют код, а затем настраивают конвейеры сборки и выпуска.

1.   В учетной записи Azure DevOps Contoso они создают проект (**ContosoSmartHotelRefactor**) и выбирают **Git** для управления версиями.

    ![Новый проект](./media/contoso-migration-refactor-web-app-sql/vsts1.png)
2. Они импортируют репозиторий Git, в котором на данный момент хранится код их приложения. Он хранится в [общедоступном репозитории](https://github.com/Microsoft/SmartHotel360-internal-booking-apps), и вы можете скачать его.

    ![Скачивание кода приложения](./media/contoso-migration-refactor-web-app-sql/vsts2.png)
    
3. После импорта кода они подключают Visual Studio к репозиторию и клонируют код с помощью Team Explorer.

    ![Подключение к проекту](./media/contoso-migration-refactor-web-app-sql/devops1.png)

4. После клонирования репозитория на компьютер для разработки они открывают файл решения для приложения. В этом файле у веб-приложения и службы WCF есть отдельные проекты.

    ![Файл решения](./media/contoso-migration-refactor-web-app-sql/vsts4.png)
    

## <a name="step-5-configure-connection-strings"></a>Шаг 5. Настройка строк подключения

Администраторы компании Contoso должны убедиться, что веб-приложения и база данных могут взаимодействовать. Чтобы сделать это, они настраивают строки подключения в коде и в веб-приложениях.

1. В веб-приложении для службы WCF (**SHWCF-EUS2**) > **Параметры** > **Параметры приложения** они добавляют новую строку подключения с именем **DefaultConnection**.
2. Строка подключения извлекается из базы данных **SmartHotel-Registration** и должна быть обновлена с правильными учетными данными.

    ![Строка подключения](media/contoso-migration-refactor-web-app-sql/string1.png)

3. С помощью Visual Studio специалисты компании открывают проект **SmartHotel.Registration.wcf** из файла решения. В разделе **ConnectionStrings** файла web.config для службы WCF (SmartHotel.Registration.Wcf) нужно указать строку подключения.

     ![Строка подключения](media/contoso-migration-refactor-web-app-sql/string2.png)

4. В разделе **client** файла web.config для SmartHotel.Registration.Web нужно указать новое расположение службы WCF. Это URL-адрес веб-приложения WCF, на котором размещена конечная точка службы.

    ![Строка подключения](media/contoso-migration-refactor-web-app-sql/strings3.png)

5. После внесения изменений в код администраторам необходимо зафиксировать их. С помощью Team Explorer в Visual Studio они делают фиксацию и синхронизацию.


## <a name="step-6-set-up-build-and-release-pipelines-in-azure-devops"></a>Шаг 6. Настройка конвейеров сборки и выпуска в Azure DevOps

Теперь администраторы Contoso настраивают Azure DevOps для сборки и выпуска.

1. В Azure DevOps они выбирают пункты **Сборка и выпуск** > **Новый конвейер**.

    ![Новый конвейер](./media/contoso-migration-refactor-web-app-sql/pipeline1.png)

2. Они выбирают **Azure Repos Git** и соответствующий репозиторий.

    ![Git и репозиторий](./media/contoso-migration-refactor-web-app-sql/pipeline2.png)

3. В разделе **Выбор шаблона** они выбирают шаблон ASP.NET для сборки.

     ![Шаблон ASP.NET](./media/contoso-migration-refactor-web-app-sql/pipeline3.png)
    
4. Для сборки используется имя **ContosoSmartHotelRefactor-ASP.NET-CI**. Они щелкают **Сохранить и поместить в очередь**.

     ![Сохранение и помещение в очередь](./media/contoso-migration-refactor-web-app-sql/pipeline4.png)

5. После этого запускается их первая сборка. Они щелкают номер сборки для просмотра процесса. После завершения они могут увидеть итоговые сведения о процессе и щелкают **Артефакты**, чтобы просмотреть результаты сборки.

    ![Проверка](./media/contoso-migration-refactor-web-app-sql/pipeline5.png)

6. Результаты сборки находятся в папке **Drop**.

    - Два ZIP-файла являются пакетами, которые содержат приложения.
    - Эти файлы используются в конвейере выпуска для развертывания в веб-приложениях Azure.

     ![Артефакт](./media/contoso-migration-refactor-web-app-sql/pipeline6.png)

7. Они выбирают **Выпуски** > **+ Новый конвейер**.

    ![Новый конвейер](./media/contoso-migration-refactor-web-app-sql/pipeline7.png)

8. Они выбирают шаблон развертывания Службы приложений Azure.

    ![Шаблон Службы приложений Azure](./media/contoso-migration-refactor-web-app-sql/pipeline8.png)

9. Они присваивают конвейеру выпуска имя **ContosoSmartHotel360Refactor** и указывают имя веб-приложения WCF (SHWCF-EUS2) для имени **этапа**.

    ![Среда](./media/contoso-migration-refactor-web-app-sql/pipeline9.png)

10. В разделе этапов они выбирают вариант **1 задание, 1 задача**, чтобы настроить развертывание службы приложения WCF.

    ![Развертывание WCF](./media/contoso-migration-refactor-web-app-sql/pipeline10.png)

11. Они проверяют, что подписка выбрана и авторизована, а затем выбирают **имя службы приложений**.

     ![Выбор службы приложения](./media/contoso-migration-refactor-web-app-sql/pipeline11.png)

12. В конвейере в разделе **Артефакты** они выбирают **+ Добавить артефакт** и выбирают создание с конвейером **ContosoSmarthotel360Refactor**.

     ![Создание](./media/contoso-migration-refactor-web-app-sql/pipeline12.png)

15. Они щелкают молнию на артефакте, чтобы включить триггер непрерывного развертывания.

     ![Молния](./media/contoso-migration-refactor-web-app-sql/pipeline13.png)

16. Триггер непрерывного развертывания должен быть в положении **Включено**.

   ![Непрерывное развертывание включено](./media/contoso-migration-refactor-web-app-sql/pipeline14.png) 

17. Теперь они переходят к заданию 1 задачи 1 этапа и щелкают **Развертывание службы приложений Azure**.

    ![Развертывание службы приложений](./media/contoso-migration-refactor-web-app-sql/pipeline15.png)

18. В разделе **Select a file or folder** (Выберите файл или папку) они находят файл **SmartHotel.Registration.Wcf.zip**, который был создан во время выполнения сборки, и **сохраняют** его в формате SQL.

    ![Сохранение WCF](./media/contoso-migration-refactor-web-app-sql/pipeline16.png)

19. Специалисты компании щелкают **Конвейер** > **Этапы** **+ Добавить**, чтобы добавить среду для **SHWEB-EUS2**. Они выбирают другое развертывание Службы приложений Azure.

    ![Добавление среды](./media/contoso-migration-refactor-web-app-sql/pipeline17.png)

20. Специалисты компании повторяют действия для публикации файла веб-приложения (**SmartHotel.Registration.Web.zip**) для соответствующего веб-приложения.

    ![Публикация веб-приложения](./media/contoso-migration-refactor-web-app-sql/pipeline18.png)

21. После сохранения конвейер выпуска будет отображаться следующим образом.

     ![Итоговое представление конвейера выпуска](./media/contoso-migration-refactor-web-app-sql/pipeline19.png)

22. Специалисты компании возвращаются в раздел **Сборка** и щелкают **Триггеры** > **Включить непрерывную интеграцию**. Это активирует конвейер, чтобы во время фиксации изменений в коде, происходили полная сборка и выпуск.

    ![Включение непрерывной интеграции](./media/contoso-migration-refactor-web-app-sql/pipeline20.png)

23. Они щелкают **Сохранить и поместить в очередь** для выполнения всего конвейера. Активируется новая сборка, которая, в свою очередь, создает первый выпуск приложения в Службе приложений Azure.

    ![Сохранение конвейера](./media/contoso-migration-refactor-web-app-sql/pipeline21.png)

24. Администраторы компании Contoso могут выполнить конвейер сборки и выпуска из Azure DevOps. После завершения сборки начнется выпуск.

    ![Сборка и выпуск приложения](./media/contoso-migration-refactor-web-app-sql/pipeline22.png)

25. По завершении работы конвейера оба сайта уже развернуты и приложение находится в сети и работает.

    ![Завершение выпуска](./media/contoso-migration-refactor-web-app-sql/pipeline23.png)

На этом этапе приложение успешно перенесено в Azure.



## <a name="clean-up-after-migration"></a>Очистка после миграции

После миграции специалистам компании Contoso необходимо выполнить указанные ниже действия по очистке.  

- Удалите локальные виртуальные машины из перечня в vCenter.
- Удалить виртуальные машины из локальных заданий резервного копирования.
- Обновите внутреннюю документацию, чтобы показать новые расположения приложения SmartHotel360. Покажите базу данных как запущенную в Базе данных SQL Azure, а внешний интерфейс как запущенный в двух веб-приложениях.
- Проверить все ресурсы, взаимодействующие с резервными виртуальными машинами, и обновить все соответствующие параметры или документы согласно новой конфигурации.


## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

- Contoso необходимо обеспечить безопасность своей новой базы данных **SmartHotel-Registration**. [Узнайте больше](https://docs.microsoft.com/azure/sql-database/sql-database-security-overview).
- В частности, компании Contoso нужно обновить веб-приложения для использования SSL с сертификатами.

### <a name="backups"></a>Резервные копии

- Contoso следует рассмотреть требования резервного копирования для Базы данных SQL Azure. [Узнайте больше](https://docs.microsoft.com/azure/sql-database/sql-database-automated-backups).
- Contoso также потребуются дополнительные сведения об управлении резервным копированием и восстановлением Базы данных SQL. См. [дополнительные сведения](https://docs.microsoft.com/azure/sql-database/sql-database-automated-backups) об автоматическом резервном копировании.
- Компании Contoso нужно рассмотреть реализацию групп отработки отказа для обеспечения отказоустойчивости в регионе для базы данных. [Узнайте больше](https://docs.microsoft.com/azure/sql-database/sql-database-geo-replication-overview).
- Компании Contoso необходимо рассмотреть развертывание веб-приложения в основном регионе "Восточная часть США 2" и в регионе "Центральная часть США" для обеспечения отказоустойчивости. Компания может настроить диспетчер трафика для обеспечения отработки отказа в случае региональных сбоев.

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- После развертывания всех ресурсов специалисты компании Contoso должны назначить теги Azure в соответствии со своим [планированием инфраструктуры](contoso-migration-infrastructure.md#set-up-tagging).
- Полное лицензирование входит в стоимость служб PaaS, которые использует Contoso. Это будет вычтено из EA.
- Компания будет использовать Управление затратами Azure по лицензии Cloudyn (дочернее подразделение корпорации Майкрософт). Это решение по управлению затратами для нескольких облаков позволяет использовать Azure и другие облачные ресурсы, а также управлять ими.  Дополнительные сведения об управлении расходами см. [на этой странице](https://docs.microsoft.com/azure/cost-management/overview).

## <a name="conclusion"></a>Заключение

В этой статье специалисты компании Contoso выполнили рефакторинг приложения SmartHotel360 в Azure путем миграции виртуальной машины внешнего интерфейса приложения в два веб-приложения Azure. База данных приложения была перенесена в базу данных Azure SQL.






