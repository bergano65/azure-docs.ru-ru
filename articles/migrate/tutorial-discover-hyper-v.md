---
title: Обнаружение виртуальных машин Hyper-V с помощью средства оценки серверов службы "Миграция Azure"
description: Узнайте, как обнаружить локальные виртуальные машины Hyper-V с помощью средства оценки серверов службы "Миграция Azure".
ms.topic: tutorial
ms.date: 09/14/2020
ms.custom: mvc
ms.openlocfilehash: e62effc31ab5dbc687e0509617b89561c5f2a3b6
ms.sourcegitcommit: 3792cf7efc12e357f0e3b65638ea7673651db6e1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/29/2020
ms.locfileid: "91442330"
---
# <a name="tutorial-discover-hyper-v-vms-with-server-assessment"></a>Руководство по обнаружению виртуальных машин Hyper-V с помощью средства оценки серверов

В процессе переноса в Azure вы обнаружите локальные данные инвентаризации и рабочие нагрузки. 

В этом руководстве показано, как обнаружить локальные виртуальные машины Hyper-V с помощью средства оценки серверов Миграции Azure, используя упрощенное устройство Миграции Azure. Вы развертываете устройство в качестве виртуальной машины Hyper-V, чтобы постоянно обнаруживать метаданные компьютера и производительности.

В этом руководстве описано следующее:

> [!div class="checklist"]
> * Настройка учетной записи Azure
> * Подготовка среды Hyper-V к обнаружению.
> * Создайте проект службы "Миграция Azure".
> * Настройка устройства службы "Миграция Azure".
> * Запуск непрерывного обнаружения.

> [!NOTE]
> В учебниках показан самый быстрый способ выполнения сценария и используются параметры по умолчанию.  

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования

Перед началом работы с этим учебником проверьте наличие необходимых компонентов.


**Требование** | **Сведения**
--- | ---
**Узел Hyper-V** | Узлы Hyper-V, на которых размещены виртуальные машины, могут быть изолированными или находиться в кластере.<br/><br/> Узел должен работать под управлением Windows Server 2019, Windows Server 2016 или Windows Server 2012 R2.<br/><br/> Убедитесь, что входящие подключения разрешены на порте WinRM 5985 (HTTP), чтобы обеспечить подключение устройства для запроса метаданных виртуальной машины и данных о производительности с помощью сеанса модели CIM.
**Развертывание устройства** | Чтобы выделить виртуальную машину для устройства, узлу Hyper-v понадобятся такие ресурсы:<br/><br/> — Windows Server 2016<br/><br/> — 16 ГБ ОЗУ.<br/><br/> — Восемь виртуальных ЦП.<br/><br/> — Около 80 ГБ дискового пространства.<br/><br/> — Внешний виртуальный коммутатор.<br/><br/> — Доступ к Интернету для виртуальной машины (напрямую или через прокси-сервер).
**Виртуальные машины** | Виртуальные машины могут работать под управлением ОС Windows или Linux. 

Прежде чем начать, [просмотрите данные](migrate-appliance.md#collected-data---hyper-v), собранные устройством во время обнаружения.

## <a name="prepare-an-azure-user-account"></a>Подготовка учетной записи пользователя Azure

Чтобы создать проект службы "Миграция Azure" и зарегистрировать устройство Миграции Azure, вам понадобится учетная запись с:
- разрешениями участника или владельца в подписке Azure;
- разрешениями на регистрацию приложений Azure Active Directory.

Если вы создали бесплатную учетную запись Azure, вы являетесь владельцем подписки. Если вы не являетесь владельцем подписки, назначьте разрешения совместно с владельцем следующим образом:


1. На портале Azure выполните поиск по фразе "подписки" и в разделе **Службы** выберите **Подписки**.

    ![Поле для поиска подписки Azure](./media/tutorial-discover-hyper-v/search-subscription.png)

2. На странице **Подписки** выберите подписку, в которой нужно создать проект службы "Миграция Azure". 
3. На странице подписок последовательно выберите **Управление доступом (IAM)**  > **Проверить доступ**.
4. В разделе **Проверка доступа** найдите соответствующую учетную запись пользователя.
5. В разделе **Добавление назначения роли** щелкните **Добавить**.

    ![Поиск учетной записи пользователя для проверки доступа и назначения роли](./media/tutorial-discover-hyper-v/azure-account-access.png)

6. В разделе **Добавление назначения роли** выберите роль "Участник" или "Владелец", а затем — учетную запись (в нашем примере — azmigrateuser). Затем нажмите кнопку **Сохранить**.

    ![Открытие страницы "Добавить назначение ролей" для назначения роли учетной записи](./media/tutorial-discover-hyper-v/assign-role.png)

7. Найдите пользователей на портале и в разделе **Службы** выберите **Пользователи**.
8. В разделе **Параметры пользователя** проверьте, смогут ли пользователи Azure AD регистрировать приложения (по умолчанию задано значение **Да**).

    ![Проверка того, могут ли пользователи регистрировать приложения Active Directory в разделе "Параметры пользователя"](./media/tutorial-discover-hyper-v/register-apps.png)

9. Кроме того, администратор клиента и глобальный администратор могут назначить учетной записи роль **Разработчик приложений**, позволяющую регистрировать приложения Azure AD. [Подробнее](../active-directory/fundamentals/active-directory-users-assign-role-azure-portal.md).

## <a name="prepare-hyper-v-hosts"></a>Подготовка узлов Hyper-V

Настройте учетную запись, используя права администратора, на узлах Hyper-V. Устройство будет использовать эту учетную запись для обнаружения.

- Вариант 1. Подготовьте учетную запись, используя права администратора, на хост-компьютере Hyper-V.
- Вариант 2. Подготовьте учетную запись локального администратора или учетную запись администратора домена и добавьте ее в следующие группы: "Пользователи удаленного управления", "Администраторы Hyper-V" и "Пользователи системного монитора".


## <a name="set-up-a-project"></a>Настройка проекта

Настройте новый проект службы "Миграция Azure".

1. На портал Azure выберите **Все службы** и найдите службу **Миграция Azure**.
2. В разделе **Службы** выберите **Миграция Azure**.
3. В разделе **Обзор** выберите **Создать проект**.
5. В разделе **Создать проект** выберите подписку Azure и группу ресурсов. Если у вас еще нет группы ресурсов, создайте ее.
6. В разделе **Сведения о проекте** укажите имя проекта и регион для создания проекта. Просмотрите список поддерживаемых регионов для [общедоступного](migrate-support-matrix.md#supported-geographies-public-cloud) облака и облака для [государственных организаций](migrate-support-matrix.md#supported-geographies-azure-government).

   ![Поля для имени и региона проекта](./media/tutorial-discover-hyper-v/new-project.png)

7. Нажмите кнопку **создания**.
8. Развертывание проекта службы "Миграция Azure" может занять несколько минут.

**Средство оценки серверов: службы "Миграция Azure"** добавляется по умолчанию в новый проект.

![Страница с изображением средства оценки серверов, добавленного по умолчанию](./media/tutorial-discover-hyper-v/added-tool.png)


## <a name="set-up-the-appliance"></a>Настройка устройства

В этом руководстве настройка устройства на виртуальной машине Hyper-V выполняется следующим образом:

- Укажите имя устройства и создайте ключ проекта службы"Миграция Azure" на портале.
- Скачайте сжатый виртуальный жесткий диск Hyper-V с портала Azure.
- Создайте устройство и убедитесь, что оно может подключиться к средству оценки сервера в службе "Миграция Azure".
- Настройте устройство в первый раз и зарегистрируйте его в проекте Миграции Azure с помощью ключа проекта службы "Миграция Azure".
> [!NOTE]
> Если по какой-либо причине вы не можете настроить устройство с помощью шаблона, настройте его с помощью сценария PowerShell. [Подробнее](deploy-appliance-script.md#set-up-the-appliance-for-hyper-v).


### <a name="generate-the-azure-migrate-project-key"></a>Создание ключа проекта службы "Миграция Azure"

1. Последовательно выберите разделы **Цели миграции** > **Серверы** > **Azure Migrate: оценка серверов** и щелкните **Обнаружить**.
2. В разделе **Обнаружение компьютеров** > **Ваши компьютеры виртуализированы?** выберите **Yes, with Hyper-V** (Да, с помощью Hyper-V).
3. В разделе **1:Generate Azure Migrate project key** (1. Создание ключа проекта службы "Миграция Azure") укажите имя виртуального модуля Миграции Azure, которое вы настроите для обнаружения виртуальных машин Hyper-V. Оно должно состоять из букв и цифр (не более 14 символов).
1. Щелкните **Создать ключ**, чтобы начать создание необходимых ресурсов Azure. Не закрывайте страницу "Обнаружение компьютеров" во время создания ресурсов.
1. После успешного создания ресурсов Azure будет создан **ключ проекта службы "Миграция Azure"** .
1. Скопируйте этот ключ, так как он понадобится вам для завершения регистрации модуля во время его настройки.

### <a name="download-the-vhd"></a>Скачивание VHD-файла

В разделе **2: Download Azure Migrate appliance** (2. Скачивание виртуального модуля службы "Миграция Azure") выберите VHD-файл и щелкните **Загрузка**. 


### <a name="verify-security"></a>Проверка безопасности

Прежде чем развертывать сжатый ZIP-файл, убедитесь, что он не поврежден.

1. На компьютере, на который был скачан файл, откройте командное окно с правами администратора.

2. Выполните следующую команду PowerShell, чтобы создать хэш ZIP-файла.
    - ```C:\>Get-FileHash -Path <file_location> -Algorithm [Hashing Algorithm]```
    - Пример использования: ```C:\>Get-FileHash -Path ./AzureMigrateAppliance_v3.20.09.25.zip -Algorithm SHA256```

3.  Проверьте последние версии и хэш-значения устройств:

    - Для общедоступного облака Azure:

        **Сценарий** | **Загрузить** | **SHA256**
        --- | --- | ---
        Hyper-V (8,91 ГБ) | [Последняя версия](https://go.microsoft.com/fwlink/?linkid=2140422) |  40aa037987771794428b1c6ebee2614b092e6d69ac56d48a2bbc75eeef86c99a

    - Для Azure для государственных организаций:

        **Сценарий*** | **Загрузить** | **SHA256**
        --- | --- | ---
        Hyper-V (85,8 МБ) | [Последняя версия](https://go.microsoft.com/fwlink/?linkid=2140424) |  cfed44bb52c9ab3024a628dc7a5d0df8c624f156ec1ecc3507116bae330b257f

### <a name="create-the-appliance-vm"></a>Создание виртуальной машины устройства

Импортируйте скачанный файл и создайте виртуальную машину.

1. Извлеките сжатый VHD-файл в папку на узле Hyper-V, на котором будет размещена виртуальная машина устройства. Извлекаются три папки.
2. Откройте диспетчер Hyper-V. В меню **Actions** (Действия) щелкните команду **Import Virtual Machine** (Импорт виртуальной машины).
2. В мастере импорта виртуальных машин в разделе **Before you begin** (Перед началом работы) нажмите кнопку **Next** (Далее).
3. В поле **Locate Folder** (Определить папку) укажите папку, содержащую извлеченный VHD. Затем нажмите кнопку **Далее**.
1. В меню **Select Virtual Machine** (Выбор виртуальной машины) нажмите кнопку **Next** (Далее).
2. В меню **Choose Import Type** (Выбор типа импорта) щелкните **Copy the virtual machine (create a new unique ID)** (Копировать виртуальную машину (создать уникальный идентификатор)). Затем нажмите кнопку **Далее**.
3. В меню **Choose Destination** (Выбор назначения) оставьте параметр по умолчанию. Щелкните **Далее**.
4. В меню **Storage Folders** (Папки хранилища) оставьте значение по умолчанию. Щелкните **Далее**.
5. В поле **Choose Network** (Выбор сети) укажите виртуальный коммутатор, который будет использоваться виртуальной машиной. Ему требуется подключение к Интернету для отправки данных в Azure.
6. Просмотрите информацию на странице **Summary** (Сводка). Нажмите кнопку **Готово**.
7. В диспетчере Hyper-V в разделе **Virtual Machines** (Виртуальные машины) запустите виртуальную машину.


### <a name="verify-appliance-access-to-azure"></a>Проверка доступа устройства к Azure

Убедитесь, что виртуальная машина устройства может подключиться к URL-адресам Azure для [общедоступного](migrate-appliance.md#public-cloud-urls) облака и облака для [государственных организаций](migrate-appliance.md#government-cloud-urls).

### <a name="configure-the-appliance"></a>Настройка устройства

Настройте устройство в первый раз.

> [!NOTE]
> Если вы настраиваете устройство с помощью [скрипта PowerShell](deploy-appliance-script.md), а не скачанного виртуального жесткого диска, первые два этапа этой процедуры выполнять не нужно.

1. В диспетчере Hyper-V в разделе **Virtual Machines** (Виртуальные машины) щелкните правой кнопкой мыши виртуальную машину и выберите **Connect** (Подключиться).
2. Укажите язык, часовой пояс и пароль для устройства.
3. Откройте браузер на любом компьютере, который может подключиться к виртуальной машине, и откройте URL-адрес веб-приложения устройства: **https://*имя устройства или IP-адрес*: 44368**.

   Кроме того, вы можете открыть приложение с рабочего стола устройства, щелкнув ярлык приложения.
1. Примите **условия лицензии** и прочитайте информацию от сторонних производителей.
1. В веб-приложении выберите **Настройка необходимых компонентов** и выполните приведенные ниже действия.
    - **Возможность подключения**: приложение проверит наличие доступа к Интернету у виртуальной машины. Если виртуальная машина использует прокси, выполните приведенные ниже действия.
      - Щелкните **Настройка прокси-сервера** и укажите адрес прокси-сервера (в формате http://ProxyIPAddress или http://ProxyFQDN) ) и порт прослушивания.
      - Укажите учетные данные, если для прокси-сервера требуется аутентификация.
      - Поддерживается только прокси-сервер HTTP.
      - Если вы добавили сведения о прокси-сервере или отключили его и (или) проверку подлинности, щелкните **Сохранить**, чтобы снова запустить проверку подключения.
    - **Синхронизация времени**: время проверяется. Время на устройстве должно быть синхронизировано со временем в Интернете для правильной работы обнаружения виртуальных машин.
    - **Установка обновлений**: Средство "Оценка сервера" службы "Миграция Azure" проверяет, установлены ли в модуле последние обновления. После завершения проверки вы можете щелкнуть пункт **View appliance services** (Просмотр служб модуля), чтобы просмотреть состояние и версии компонентов, используемых модулем.

### <a name="register-the-appliance-with-azure-migrate"></a>Регистрация устройства с помощью службы "Миграция Azure"

1. Вставьте **ключ проекта службы "Миграция Azure"** , скопированный с портала. Если у вас нет ключа, последовательно выберите **Server Assessment > Discover > Manage existing appliances** (Оценка сервера > Обнаружение > Управление имеющимися модулями), выберите имя модуля, указанное вами во время создания ключа, и скопируйте соответствующий ключ.
1. Щелкните **Войти**. На новой вкладке браузера откроется окно входа в Azure. Если этот параметр не отображается, убедитесь, что в браузере отключена блокировка всплывающих окон.
1. В новой вкладке выполните вход, используя имя пользователя и пароль Azure.
   
   Вход с помощью PIN-кода не поддерживается.
3. После входа вернитесь к веб-приложению. 
4. Если учетная запись пользователя Azure, используемая для ведения журнала, имеет необходимые [разрешения](tutorial-prepare-hyper-v.md#prepare-azure) на ресурсы Azure, созданные во время создания ключа, будет инициирована регистрация модуля.
1. После регистрации модуля вы можете просмотреть сведения о регистрации, щелкнув **Просмотреть подробности**.



### <a name="delegate-credentials-for-smb-vhds"></a>Делегирование учетных данных для виртуальных жестких дисков SMB

Если вы запускаете виртуальные жесткие диски в SMB, необходимо включить делегирование учетных данных с устройства на узлы Hyper-V. Чтобы сделать это на устройстве, выполните следующее:

1. На виртуальной машине устройства выполните эту команду. HyperVHost1/HyperVHost2 — это примеры имен узлов.

    ```
    Enable-WSManCredSSP -Role Client -DelegateComputer HyperVHost1.contoso.com, HyperVHost2.contoso.com, HyperVHost1, HyperVHost2 -Force
    ```

2. Кроме того, это можно сделать в редакторе локальных групповых политик на устройстве:
    - В разделе **Политика локального компьютера** > **Конфигурация компьютера** щелкните **Административные шаблоны** > **Система** > **Передача учетных данных**.
    - Дважды щелкните **Разрешить передачу новых учетных данных** и выберите **Включено**.
    - В разделе **Параметры** щелкните **Показать** и добавьте в список каждый узел Hyper-V, который требуется обнаружить, используя **wsman/** в качестве префикса.
    - В области **Передача учетных данных** дважды щелкните **Разрешить делегирование новых учетных данных с проверкой подлинности сервера "только NTLM"**. Еще раз добавьте в список каждый узел Hyper-V, который требуется обнаружить, используя **wsman/** в качестве префикса.

## <a name="start-continuous-discovery"></a>Запуск непрерывного обнаружения

Подключитесь с устройства к узлам или кластерам Hyper-V и запустите обнаружение виртуальных машин.

1. В разделе **Шаг 1. Provide Hyper-V host credentials** (Предоставление учетных данных узла Hyper-V) щелкните **Добавить учетные данные**, чтобы указать понятное имя для учетных данных, добавьте значения для пунктов **Имя пользователя** и **Пароль** для узла или кластера Hyper-V, который модуль будет использовать для обнаружения виртуальных машин. Щелкните **Save**(Сохранить).
1. Если вы хотите добавить несколько учетных данных одновременно, щелкните **Добавить еще**, чтобы сохранить и добавить дополнительные учетные данные. Для обнаружения виртуальных машин Hyper-V поддерживаются несколько учетных данных.
1. На **шаге 2 Provide Hyper-V host/cluster details** (Предоставление сведений об узле или кластере Hyper-V) щелкните **Add discovery source** (Добавить источник обнаружения), чтобы указать **IP-адрес или полное доменное имя** узла или кластера Hyper-V и понятное имя учетных данных для подключения к узлу или кластеру.
1. За один раз можно выбрать пункт **Add single item** (Добавить один элемент) или **Add multiple items** (Добавить несколько элементов). Здесь также есть параметр **Импорт CSV** для предоставления сведений об узле или кластере Hyper-V.


    - Если вы выберете пункт **Add single item** (Добавить один элемент), вам необходимо будет указать понятное имя для учетных данных и **IP-адрес или полное доменное имя** узла или кластера Hyper-V, а затем щелкнуть **Сохранить**.
    - Если вы выберете пункт **Add multiple items** (Добавить несколько элементов) _(выбрано по умолчанию)_ , вы сможете добавить несколько записей одновременно, указав в текстовом поле **IP-адрес или полное доменное имя** узла или кластера Hyper-V и понятное имя для учетных данных. Щелкните **Проверить**, чтобы проверить добавленные записи, и нажмите **Сохранить**.
    - Если вы выберете пункт **Импорт CSV**, вы сможете скачать CSV-файл шаблона и указать в нем **IP-адрес или полное доменное имя** узла или кластера Hyper-V и понятное имя для учетных данных. Затем импортируйте файл в виртуальный модуль, нажмите кнопку **Проверить** для проверки записей в файле и щелкните **Сохранить**.

1. При нажатии кнопки "Сохранить" виртуальный модуль попытается проверить подключение к добавленным узлам или кластерам Hyper-V и отобразит **состояние проверки** в таблице для каждого из них.
    - Вы можете просмотреть дополнительные сведения о проверенных узлах или кластерах, щелкнув их IP-адрес или полное доменное имя.
    - Если проверка узла завершилась неудачно, просмотрите ошибку, щелкнув пункт **Сбой проверки** в столбце "Состояние" таблицы. Устраните проблему и выполните проверку еще раз.
    - Чтобы удалить узлы или кластеры, щелкните **Удалить**.
    - Невозможно удалить конкретный узел из кластера. Вы можете удалить только весь кластер.
    - Вы можете добавить кластер, даже если возникли проблемы с конкретными узлами в кластере.
1. Вы можете **повторно проверить** подключение к узлам или кластерам в любое время перед началом обнаружения.
1. Нажмите **Начать обнаружение**, чтобы начать обнаружение виртуальных машин с проверенными узлами или кластерами. После успешного запуска обнаружения вы можете проверить состояние обнаружения для каждого узла или кластера в таблице.

Запустится обнаружение. Чтобы метаданные обнаруженных серверов отобразились на портале Azure, потребуется около 2 минут на узел.

## <a name="verify-vms-in-the-portal"></a>Проверка виртуальных машин на портале

После завершения обнаружения вы можете убедиться, что виртуальные машины отображаются на портале Azure.

1. Откройте панель мониторинга службы "Миграция Azure".
2. На странице **Azure Migrate — Servers** > **Azure Migrate: Server Assessment** (Миграция Azure — серверы > Миграция Azure: оценка сервера) щелкните значок, отображающий количество **обнаруженных серверов**.

## <a name="next-steps"></a>Дальнейшие действия

- [Оценка виртуальных машин Hyper-V](tutorial-assess-hyper-v.md) к переносу на виртуальные машины Azure.
- [Просмотрите данные](migrate-appliance.md#collected-data---hyper-v), собранные устройством во время обнаружения.
