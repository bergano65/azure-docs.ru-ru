---
title: Рекомендации по настройке сетей для рабочих нагрузок, перенесенных в Azure | Документация Майкрософт
description: Выполнив миграцию в Azure, ознакомьтесь с рекомендациями по настройке сетей для перенесенных рабочих нагрузок.
author: rayne-wiselman
manager: carmonm
ms.service: azure-migrate
ms.topic: conceptual
ms.date: 12/04/2018
ms.author: raynew
ms.openlocfilehash: 1493eb6978b00771aa8ed4d8cfc28c37a9dde5b6
ms.sourcegitcommit: 78ec955e8cdbfa01b0fa9bdd99659b3f64932bba
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2018
ms.locfileid: "53139754"
---
# <a name="best-practices-to-set-up-networking-for-workloads-migrated-to-azure"></a>Рекомендации по настройке сетей для рабочих нагрузок, перенесенных в Azure

При планировании и разработке миграции, кроме самой миграции одним из наиболее важных этапов является проектирование и реализация сетей Azure. В этой статье приведены рекомендации по настройке сетей при миграции в реализации IaaS и PaaS в Azure.

> [!IMPORTANT]
> Рекомендации и мнения, описанные в этой статье, основываются на возможностях платформы Azure и служб, доступных на момент написания этого материала. Функции и возможности со временем меняются. Не все рекомендации могут быть применимы в вашем сценарии развертывания, поэтому выберите подходящие для вас.


## <a name="design-virtual-networks"></a>Проектирование виртуальных сетей

Azure предоставляет виртуальные сети:
- Ресурсы Azure конфиденциально, непосредственно и безопасно обмениваются данными друг с другом в виртуальных сетях.
- Вы можете настроить подключения конечных точек в виртуальных сетях для виртуальных машин и служб, которым требуется подключение к Интернету.
- Виртуальная сеть — это логическая изоляция облака Azure, выделенная для вашей подписки.
- Вы можете реализовать несколько виртуальных сетей в пределах подписки и региона Azure.
- Виртуальные сети изолированы друг от друга.
- Виртуальные сети могут содержать частные и общедоступные IP-адреса, определенные в [RFC 1918](https://tools.ietf.org/html/rfc1918) и выраженные в нотации CIDR. Общедоступные IP-адреса не доступны непосредственно из Интернета.
- Виртуальные сети могут подключаться друг к другу с помощью пиринга. Подключенные виртуальные сети могут находиться в одном или разных регионах. Таким образом, ресурсы в одной виртуальной сети могут подключаться к ресурсам в других виртуальных сетях.
- По умолчанию Azure маршрутизирует трафик между подсетями одной виртуальной сети, подключенными виртуальными сетями, локальными сетями и Интернетом.


При планировании топологии виртуальных сетей следует продумать ряд моментов, включая организацию пространств IP-адресов, реализацию звездообразной сети, сегментирование виртуальных сетей на подсети, настройку DNS и реализацию зон доступности Azure.

## <a name="best-practice-plan-ip-addressing"></a>Рекомендация. Планирование IP-адресации

При создании виртуальных сетей в рамках миграции очень важно спланировать пространство IP-адресов виртуальных сетей.

- Для каждой виртуальной сети следует назначить адресное пространство размером не больше диапазона CIDR /16. В виртуальных сетях разрешается использовать 65 536 IP-адресов, а назначение префикса меньшего размера, чем /16, приведет к потере IP-адресов. Важно не терять IP-адреса, даже если они находятся в частных диапазонах, определенных в RFC 1918.
- Адресное пространство виртуальной сети не должно перекрываться диапазонами локальной сети.
- Не следует использовать преобразование сетевых адресов (NAT).
- Перекрывающиеся адреса могут вызывать проблемы с подключением сетей и нарушения в работе маршрутизации. Если сети перекрываются, необходимо перепроектировать сеть или использовать преобразование сетевых адресов (NAT).

**Подробнее:**

- [Общие сведения](https://docs.microsoft.com/azure/virtual-network/virtual-networks-overview) о виртуальных сетях Azure.
- [Вопросы и ответы](https://docs.microsoft.com/azure/virtual-network/virtual-networks-faq) о сетях.
- [Сведения](https://docs.microsoft.com/azure/azure-subscription-service-limits?toc=%2fazure%2fvirtual-network%2ftoc.json#networking-limits) об ограничениях сетей.


## <a name="best-practice-implement-a-hub-spoke-network-topology"></a>Рекомендация. Реализация звездообразной топологии сети

Звездообразная топология сети изолирует рабочие нагрузки при совместном использовании служб, таких как службы идентификации и безопасности.
- В качестве центральной точки подключения выступает виртуальная сеть Azure (концентратор).
- Периферийные зоны представляют собой виртуальные сети, которые подключаются к виртуальной сети концентратора с помощью пиринга.
- Общие службы развертываются в концентраторе, а отдельные рабочие нагрузки — в периферийных зонах. 

Рассмотрим следующее:
- Реализация звездообразной топологии в Azure позволяет централизовать такие функции, как подключения к локальным сетям, брандмауэры и изоляция между виртуальными сетями. Виртуальная сеть концентратора обеспечивает центральную точку подключения к локальным сетям и место для размещения служб узла, используемых рабочими нагрузками в периферийных виртуальных сетях.
- Звездообразная конфигурация зачастую применяется на крупных предприятиях. В меньших сетях можно организовать более простую и бюджетную топологию.
- Периферийные виртуальные сети можно использовать для изоляции рабочих нагрузок, когда каждая из периферийных зон управляется отдельно от других. Каждая рабочая нагрузка может содержать несколько уровней с несколькими подсетями, подключенными через подсистемы балансировки нагрузки Azure.
- Центральную и периферийные виртуальные сети можно реализовать в разных группах ресурсов и даже разных подписках. Если вы настраиваете пиринг виртуальных сетей в разных подписках, эти подписки могут быть связаны с одним и тем же или разными клиентами Azure Active Directory (AD). Это позволяет осуществлять децентрализованное управление каждой рабочей нагрузкой при совместном использовании служб, поддерживаемых в центральной сети.

![Управление изменениями](./media/migrate-best-practices-networking/hub-spoke.png)
*Звездообразная топология*

**Подробнее:**

- [Сведения](https://docs.microsoft.com/azure/architecture/reference-architectures/hybrid-networking/hub-spoke) о звездообразной топологии.
- Рекомендации по настройке сети для запуска виртуальных машин [Windows](https://docs.microsoft.com/azure/architecture/reference-architectures/n-tier/windows-vm#network-recommendations) и [Linux](https://docs.microsoft.com/azure/architecture/reference-architectures/n-tier/linux-vm#network-recommendations) в Azure.
- [Сведения](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview) о пиринге виртуальных сетей.


## <a name="best-practice-design-subnets"></a>Рекомендация. Проектирование подсетей

Для обеспечения изоляции в пределах одной виртуальной сети следует разделить ее на подсети и выделить каждой из них часть адресного пространства виртуальной сети.
- В каждой виртуальной сети можно создать несколько подсетей.
- По умолчанию Azure маршрутизирует трафик между всеми подсетями в виртуальной сети.
- Решения о подсетях должны основываться на технических и организационных требованиях, выдвигаемых вашим сценарием.  
- Подсети создаются с использованием нотации CIDR.
- При определении сетевого диапазона для подсетей важно учитывать то, что для Azure выделяются пять IP-адресов из каждой подсети, которые не могут использоваться. Например, при создании наименьшей доступной подсети /29 (с восемью IP-адресами) Azure оставит для себя пять адресов, так что у вас будут только три доступных адреса, которые могут быть назначены узлам подсети.
- В большинстве случаев рекомендуется использовать /28 в качестве подсети наименьшего размера.

### <a name="example"></a>Пример

В таблице показан пример виртуальной сети с адресным пространством 10.245.16.0/20, разделенной на подсети для запланированной миграции.

**Подсеть** | **CIDR** | **Адреса** | **Использование**
--- | --- | --- | ---
DEV-FE-EUS2 | 10.245.16.0/22 | 1019 | Внешние виртуальные машины или виртуальные машины веб-уровня
DEV-APP-EUS2 | 10.245.20.0/22 | 1019 | Виртуальные машины уровня приложения
DEV-DB-EUS2 | 10.245.24.0/23 | 507 | Виртуальные машины баз данных

**Подробнее:**
- [Сведения](https://docs.microsoft.com/azure/virtual-network/virtual-network-vnet-plan-design-arm#segmentation) о проектировании подсетей.
- [Сведения о том](https://docs.microsoft.com/azure/migrate/contoso-migration-infrastructure), как вымышленная компания (Contoso) подготовила сетевую инфраструктуру для миграции.


## <a name="best-practice-set-up-a-dns-server"></a>Рекомендация. Настройка DNS-сервера

Azure добавляет DNS-сервер по умолчанию при развертывании виртуальной сети. Это позволяет быстро создавать виртуальные сети и развертывать ресурсы. Но этот DNS-сервер обслуживает ресурсы только в соответствующей виртуальной сети. Если нужно подключить друг к другу несколько виртуальных сетей или подключиться к локальному серверу из виртуальных сетей, потребуются дополнительные возможности разрешения имен. Например, может потребоваться настроить в Active Directory разрешение DNS-имен между виртуальными сетями. Чтобы сделать это, следует развернуть собственный пользовательский DNS-сервер в Azure.

- DNS-серверы в виртуальной сети могут перенаправлять запросы DNS в рекурсивные сопоставители в Azure. Это позволяет разрешать имена узлов в этой виртуальной сети. Например, контроллер домена, запущенный в Azure, может отвечать на запросы DNS для своих доменов и перенаправлять все остальные запросы в Azure.
- Перенаправление DNS позволяет виртуальным машинам видеть имена локальных ресурсов (с помощью контроллера домена) и узлов, предоставленные Azure (с помощью сервера перенаправления). Доступ к рекурсивным сопоставителям Azure предоставляется через виртуальный IP-адрес 168.63.129.16.
- Перенаправление DNS включает разрешение DNS между виртуальными сетями, а также позволяет локальным компьютерам разрешать имена узлов, предоставляемых Azure.
    - Чтобы разрешить имя узла виртуальной машины, такая виртуальная машина DNS-сервера должна находиться в той же виртуальной сети и быть настроена для перенаправления запросов имен узлов в Azure.
    - Так как DNS-суффиксы в разных виртуальных сетях различаются, можно использовать правила условного перенаправления для отправки запросов DNS в правильную виртуальную сеть для разрешения.
- Если вы используете собственные DNS-серверы, можно указать несколько DNS-серверов для каждой виртуальной сети. Можно также указать несколько DNS-серверов для каждого сетевого интерфейса (для Azure Resource Manager) или каждой облачной службы (для классической модели развертывания).
- DNS-серверы, указанные для сетевого интерфейса или облачной службы, имеют более высокий приоритет по сравнению с DNS-серверами, указанными для виртуальной сети.
- В модели развертывания Azure Resource Manager можно указать DNS-серверы для виртуальной сети и сетевого интерфейса, но эту конфигурацию рекомендуется использовать только в виртуальных сетях.

    ![DNS-серверы](./media/migrate-best-practices-networking/dns2.png) *DNS-серверы для виртуальной сети*

**Подробнее:**
- [Сведения](https://docs.microsoft.com/azure/migrate/contoso-migration-infrastructure) о разрешении имен при использовании собственного DNS-сервера.
- [Сведения](https://docs.microsoft.com/en-us/azure/architecture/best-practices/naming-conventions?toc=%2fazure%2fvirtual-network%2ftoc.json#naming-subscriptions) о правилах именования и ограничениях DNS.


## <a name="best-practice-set-up-availability-zones"></a>Рекомендация. Настройка зон доступности

Зоны доступности повышают уровень доступности, защищая приложения и данные от сбоев на уровне центра обработки данных.

- Зоны доступности — уникальные физические расположения в пределах одного региона Azure.
- Каждая зона состоит из одного или нескольких центров обработки данных, оснащенных независимыми системами электроснабжения, охлаждения и сетевого взаимодействия.
- Чтобы обеспечить устойчивость, во всех включенных областях используются минимум три отдельные зоны.
- Физическое разделение зон доступности в пределах региона защищает приложения и данные от сбоев центров обработки данных.
- Избыточные между зонами службы реплицируют приложения и данные в зонах доступности, защищая от возникновения единых точек отказа. Благодаря зонам доступности Azure обеспечивает выполнение Соглашения об уровне обслуживания с гарантией времени непрерывной работы 99,99 % для виртуальных машин.

    ![Зона доступности](./media/migrate-best-practices-networking/availability-zone.png) *Зона доступности*

- Можно запланировать и внедрить высокий уровень доступности в архитектуру миграции за счет совместного размещения вычислительных ресурсов, ресурсов хранилища, сети и данных в пределах зоны, а также за счет репликации в другие зоны. Службы Azure с поддержкой зон доступности делятся на две категории:
    - Зональные службы. Ресурс связывается с определенной зоной. Например, виртуальные машины, управляемые диски, IP-адреса.
    - Службы, избыточные между зонами. Ресурс автоматически реплицируется между зонами. Например, избыточное между зонами хранилище, база данных SQL Azure.
- Для обеспечения зональной отказоустойчивости можно развернуть стандартную балансировку нагрузки Azure с доступными из Интернета рабочими нагрузками или уровнями приложений.

    ![Подсистема балансировки нагрузки](./media/migrate-best-practices-networking/load-balancer.png) *Подсистема балансировки нагрузки*

**Подробнее:**
-   [Общие сведения](https://docs.microsoft.com/azure/availability-zones/az-overview) о зонах доступности.



## <a name="design-hybrid-cloud-networking"></a>Проектирование гибридных облачных сетей

Для успешной миграции очень важно подключить локальные корпоративные сети к Azure. При этом создается постоянное подключение, называемое гибридной облачной сетью, в рамках которого службы предоставляются из облака Azure корпоративным пользователям. Существует два варианта создания сети такого типа:

- **VPN-подключение "сеть – сеть".** Подключение "сеть – сеть" устанавливается между совместимым локальным VPN-устройством и VPN-шлюзом Azure, развернутым в виртуальной сети. Любой авторизованный локальный ресурс может получить доступ к виртуальным сетям. Обмен данными между сетями осуществляется по шифрованному туннелю через Интернет. 
- **Azure ExpressRoute.** Подключение Azure ExpressRoute устанавливается между локальной сетью и Azure через партнера ExpressRoute. Это подключение является частным, и трафик не проходит через Интернет.

**Подробнее:**

- [Сведения](https://docs.microsoft.com/azure/architecture/reference-architectures/hybrid-networking/vpn) о гибридных облачных сетях.

## <a name="best-practice-implement-a-highly-available-site-to-site-vpn"></a>Рекомендация. Реализация VPN-подключения "сеть — сеть" с высоким уровнем доступности

Чтобы реализовать VPN-подключение "сеть — сеть", следует настроить VPN-шлюз в Azure.
- VPN-шлюз — это особый тип шлюза виртуальной сети, используемый для отправки зашифрованного трафика между виртуальной сетью Azure и локальным расположением через общедоступный Интернет.
- Его также можно использовать для обмена зашифрованным трафиком между виртуальными сетями Azure через сеть Майкрософт.
- Каждая виртуальная сеть может иметь только один VPN-шлюз.
- К одному VPN-шлюзу можно создать несколько подключений. При создании нескольких подключений все VPN-туннели совместно используют доступную пропускную способность шлюза.
- Каждый VPN-шлюз Azure состоит из двух экземпляров: активного и резервного.
    - При запланированном обслуживании или незапланированном простое активного экземпляра выполняется отработка отказа с автоматическим переходом на резервный экземпляр. Это позволяет возобновить VPN-подключение "сеть — сеть" или "виртуальная сеть — виртуальная сеть". 
    - Переключение сопровождается кратким перебоем в работе.
    - При плановом обслуживании подключение должно быть восстановлено в течение 10–15 секунд.
    - При сбое на восстановление подключения потребуется больше времени — от 1 до 1,5 минут (в худшем случае).
    - При этом клиентские VPN-подключения "точка — сеть" к шлюзу будут разорваны, и пользователям придется повторно устанавливать подключение на клиентских компьютерах.

При настройке VPN-подключения "сеть — сеть" необходимо сделать следующее:
 - Требуется виртуальная сеть с диапазоном адресов, не перекрывающимся с локальной сетью, к которой будет подключаться VPN.
 - Создайте подсеть шлюза в сети.
 - Создайте VPN-шлюз, задайте тип шлюза (VPN) и укажите, будет ли этот шлюз основан на политике или на маршрутах. Рекомендуется реализовать VPN на основе маршрутов, так как это предоставляет больше возможностей и перспектив.
 - В локальной среде создайте шлюз локальной сети и настройте локальное VPN-устройство. 
 - Создайте VPN-подключение "сеть — сеть" для отработки отказа между шлюзом виртуальной сети и локальным устройством. Использование VPN на основе маршрутов позволяет создавать подключения к Azure как в режиме "активный — пассивный", так и в режиме "активный — активный". Также сеть на основе маршрутов одновременно поддерживает подключения "сеть — сеть" (с любого компьютера) и "точка — сеть" (с одного компьютера).
 - Укажите требуемый номер SKU шлюза. Это зависит от требований рабочей нагрузки, пропускной способности, функций и Соглашения об уровне обслуживания.
 - Протокол BGP — это дополнительная функция, которую можно использовать с Azure ExpressRoute и VPN-шлюзами на основе маршрутов, чтобы распространить локальные маршруты BGP на виртуальные сети.

![VPN](./media/migrate-best-practices-networking/vpn.png)
*VPN "сеть — сеть"*
 
**Подробнее:**

- [Просмотр](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-devices) совместимых локальных VPN-устройств.
- [Общие сведения](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateway) о VPN-шлюзах.
- [Сведения](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-highlyavailable) о VPN-подключениях с высоким уровнем доступности.
- [Сведения](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-plan-design) о планировании и проектировании VPN-шлюза.
- [Просмотр](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings#gwsku) параметров VPN-шлюза.
- [Просмотр](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways#gwsku) SKU шлюзов.
- [Сведения](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-bgp-overview) о настройке BGP с VPN-шлюзами Azure.


### <a name="best-practice-configure-a-gateway-for-vpn-gateways"></a>Рекомендация. Настройка VPN-шлюзов

При создании VPN-шлюза в Azure необходимо использовать специальную подсеть с именем GatewaySubnet. При создании этой подсети учитывайте следующее:

- Максимальная длина префикса подсети шлюза — 29 (например, 10.119.255.248/29). Сейчас рекомендуется использовать длину префикса 27 (например, 10.119.255.224/27).
- При определении адресного пространства подсети шлюза используйте самую последнюю часть адресного пространства виртуальной сети.
- Если используется подсеть шлюза Azure, никогда не развертывайте виртуальные машины или другие устройства, такие как шлюз приложений, в подсети шлюза.
- Не назначайте группу безопасности сети в эту подсеть. Это приведет к прекращению работы шлюза.

**Подробнее:**
- [Использование средства](https://gallery.technet.microsoft.com/scriptcenter/Address-prefix-calculator-a94b6eed) для определения пространства IP-адресов.

## <a name="best-practice-implement-azure-virtual-wan-for-branch-offices"></a>Рекомендация. Реализация виртуальной глобальной сети Azure (WAN) для филиалов

Используемая для большого количества VPN-подключений виртуальная глобальная сеть Azure — это сетевая служба, которая обеспечивает оптимизированное и автоматизированное подключение между филиалами через Azure.
- Виртуальная глобальная сеть позволяет подключать и настраивать устройства ветви для взаимодействия с Azure. Это можно сделать вручную или с помощью устройств провайдеров через участника Виртуальной глобальной сети.
- Использование предпочтительных устройств провайдеров упрощает использование и подключение, а также управление конфигурацией.
- Встроенная панель управления глобальной виртуальной сетью Azure обеспечивает мгновенное устранение неполадок, что экономит время и предоставляет простой способ отслеживания широкомасштабных подключений "сеть — сеть". 

**Подробнее:**
[Сведения](https://docs.microsoft.com/azure/virtual-wan/virtual-wan-about) о виртуальной глобальной сети Azure.

### <a name="best-practice-implement-expressroute-for-mission-critical-connections"></a>Рекомендация. Реализация ExpressRoute для критически важных подключений

Служба Azure ExpressRoute расширяет возможности локальной инфраструктуры за счет облака Microsoft, создавая частные подключения между виртуальным центром обработки данных Azure и локальными сетями.
- Подключения ExpressRoute можно устанавливать между любыми сетями (IP VPN), в сети Ethernet "точка — точка" или через поставщика услуг подключения. Обмен данными не выполняется через общедоступный сегмент Интернета.
- Подключения ExpressRoute обеспечивают повышенный уровень безопасности, надежности и быстродействия (до 10 Гбит/с) с прогнозируемой задержкой.
- ExpressRoute подходит для виртуальных центров обработки данных, так как клиенты могут использовать правила соответствия, связанные с частными подключениями.
- С помощью ExpressRoute Direct можно подключиться непосредственно к маршрутизаторам Майкрософт со скоростью 100 Гбит/с, когда требуется высокая пропускная способность.
- В ExpressRoute используется протокол BGP для обмена маршрутами между локальными сетями, экземплярами Azure и общедоступными адресами Майкрософт.

Развертывание подключений ExpressRoute обычно требует участия поставщика услуг ExpressRoute. Чтобы быстро приступить к работе, рекомендуется сначала использовать VPN "сеть — сеть" для установления подключения между виртуальным ЦОД и локальными ресурсами, а затем перейти на подключение ExpressRoute, когда будет установлено физическое соединение с поставщиком услуг.

**Подробнее:**
- [Общие сведения](https://docs.microsoft.com/azure/expressroute/expressroute-introduction) об ExpressRoute.
- [Сведения](https://docs.microsoft.com/azure/expressroute/expressroute-erdirect-about) об ExpressRoute Direct.

### <a name="best-practice-optimize-expressroute-routing-with-bgp-communities"></a>Рекомендация. Оптимизация маршрутизации ExpressRoute с помощью сообществ BGP

При наличии нескольких каналов ExpressRoute к сети Майкрософт можно подключиться по нескольким маршрутам. В результате маршрутизация может быть неоптимальной, то есть трафик, передаваемый из вашей сети в сеть Майкрософт и наоборот, будет проходить по более длинному маршруту. Это, в свою очередь, может стать причиной возникновения длительной задержки, которая прямо влияет на производительность приложений и работу пользователей.

#### <a name="example"></a>Пример

Рассмотрим пример.

- Предположим, что есть два офиса, расположенных в США: один в Лос-Анджелесе, а другой — в Нью-Йорке.
- Эти офисы подключены к глобальной сети: к вашей собственной магистральной или предоставленной поставщиком IP VPN.
- У вас есть два канала ExpressRoute: один — в западной части США, а другой — в восточной. Они также подключены к глобальной сети. Очевидно, что подключение к сети Майкрософт можно установить по двум каналам.


 
**Задача**. Теперь представьте, что службы Azure (например, Служба приложений Azure) расположены и в западной, и в восточной части США.
- Пользователям в каждом офисе требуется получить доступ к ближайшим службам Azure для оптимальной работы.
- Таким образом, вам нужно подключить пользователей из Лос-Анджелеса к Azure в западной части США, а пользователей из Нью-Йорка — к Azure в восточной части США.
- Это выполнимо для пользователей на восточном побережье, но не на западном. Проблема заключается в следующем.
    - Для каждого канала ExpressRoute объявляются оба префикса: 23.100.0.0/16 в регионе Azure "Восточная часть США" и 13.100.0.0/16 — в регионе Azure "Западная часть США".
    - Без сведений о том, какой префикс принадлежит какому региону, префиксы не будут обрабатываться по-разному.
    - Глобальная сеть может предположить, что оба префикса располагаются ближе к восточной части США, чем к западной, и таким образом направлять трафик пользователей из обоих офисов в канал ExpressRoute в восточной части США, обеспечивая неоптимальную производительность для пользователей в Лос-Анджелесе.

![VPN](./media/migrate-best-practices-networking/bgp1.png)
*Неоптимизированное подключение сообществ BGP*

**Решение**

Чтобы оптимизировать маршрутизацию для обоих офисов, необходимо определить, какой префикс относится к региону Azure "Западная часть США", а какой — к региону "Восточная часть США". Эти сведения можно закодировать с помощью значений сообществ BGP.
- Каждому региону Azure назначается уникальное значение сообщества BGP. Например, 12076:51004 для восточной части США и 12076:51006 — для западной.
- Теперь, когда очевидно, какой префикс относится к какому региону Azure, можно настроить предпочтительный канал ExpressRoute.
- Так как для обмена сведениями маршрутизации используется протокол BGP, маршрутизацией можно управлять, используя значения локального предпочтения BGP.
- В нашем примере для 13.100.0.0/16 в западной части США устанавливается более высокое значение локального предпочтения, чем в восточной части США, и точно так же можно установить более высокое значение локального предпочтения для 23.100.0.0/16 в восточной части США по сравнению с западной. 
- Эта конфигурация гарантирует, что при наличии обоих доступных путей к ресурсам Майкрософт пользователи из Лос-Анджелеса будут подключаться к Azure в западной части США с помощью западного канала, а пользователи из Нью-Йорка будут подключаться к Azure в восточной части США с помощью восточного канала. Это обеспечивает оптимальную маршрутизацию на обоих сторонах.

![VPN](./media/migrate-best-practices-networking/bgp2.png)
*Оптимизированное подключение сообществ BGP*


**Подробнее:**
- [Сведения](https://docs.microsoft.com/azure/expressroute/expressroute-optimize-routing) об оптимизации маршрутизации

## <a name="securing-vnets"></a>Защита виртуальных сетей

Ответственность за обеспечение безопасности виртуальных сетей распределяется между вами и Майкрософт. Корпорация Майкрософт предоставляет множество сетевых компонентов, а также службы, которые помогают поддерживать безопасность ресурсов. При проектировании системы безопасности виртуальных сетей существует ряд рекомендаций, которым необходимо следовать, включая реализацию сети периметра, использование фильтрации и групп безопасности, защиту доступа к ресурсам и IP-адресам, а также реализацию защиты от атак.

**Подробнее:**

- [Общие сведения](https://docs.microsoft.com/azure/security/azure-security-network-security-best-practices) о рекомендациях по сетевой безопасности.
- [Сведения](https://docs.microsoft.com/azure/virtual-network/virtual-network-vnet-plan-design-arm#security) о проектировании защищенных сетей.

## <a name="best-practice-implement-an-azure-perimeter-network"></a>Рекомендация. Реализация сети периметра Azure

Хотя корпорация Майкрософт вкладывает большие средства в защиту облачной инфраструктуры, вам тоже необходимо принимать меры для защиты облачных служб и групп ресурсов. Лучшим подходом к обеспечению безопасности является многоуровневый подход к безопасности. Важной частью этой стратегии защиты является реализация сети периметра.

- Сеть периметра защищает внутренние сетевые ресурсы от ненадежных сетей. 
- Это самый внешний слой, который доступен из Интернета. Он обычно располагается между Интернетом и инфраструктурой предприятия, обычно с использованием некоторой защиты с обеих сторон. 
- В обычной корпоративной сетевой топологии базовая инфраструктура хорошо защищена по всему периметру несколькими уровнями устройств безопасности. Граница каждого уровня состоит из устройств и точек реализации политики.
- Каждый уровень может включать сочетание таких решений сетевой безопасности, как брандмауэры, устройства предотвращения атак типа "отказ в обслуживании" (DoS), системы обнаружения или предотвращения вторжений (IDS/IPS) и VPN-устройства.
- Реализация политики в сети периметра может предусматривать использование политик брандмауэра, списков управления доступом или правил маршрутизации.
- Входящий трафик из Интернета перехватывается и обрабатывается несколькими средствами обеспечения безопасности для блокирования атак и вредоносного трафика. При этом допустимые запросы в сеть пропускаются.
- Входящий трафик может направляться непосредственно к ресурсам в сети периметра. Ресурс сети периметра затем может обмениваться данными с другими ресурсами, размещенными дальше в сети, перенаправляя трафик в сеть после проверки.

На следующем рисунке показан пример одиночной подсети для сети периметра в корпоративной сети, с двумя границами безопасности.

![VPN](./media/migrate-best-practices-networking/perimeter.png)
*Развертывание сети периметра*

**Подробнее:**
- [Сведения](https://docs.microsoft.com/azure/architecture/reference-architectures/dmz/secure-vnet-hybrid) о развертывании сети периметра между Azure и локальным центром обработки данных.


## <a name="best-practice-filter-vnet-traffic-with-nsgs"></a>Рекомендация. Фильтрация трафика виртуальной сети с помощью групп безопасности сети

Группы безопасности сети (NSG) содержат ряд правил безопасности, которые управляют входящим и исходящим трафиком, а также фильтруют трафик, поступающий к ресурсам или передаваемый от них. Фильтрацию можно осуществлять по исходному и конечному IP-адресам, порту и протоколу. 
- В группах NSG содержатся правила безопасности, которые разрешают или запрещают исходящий и входящий сетевой трафик нескольких типов ресурсов Azure. Для каждого правила можно указать источник и назначение, порт и протокол.
- Правила NSG оцениваются по приоритету и на основе кортежей из пяти элементов (источник, порт источника, назначение, порт назначения и протокол), что позволяет разрешить или запретить трафик.
- Запись потока создается для имеющихся подключений. Обмен данными разрешен или запрещен в зависимости от состояния подключения записи потока.
- Запись потока позволяет NSG отслеживать состояние. Например, если задать правило безопасности для исходящего трафика по любому адресу через порт 80, устанавливать правило безопасности входящего трафика в ответ на исходящий трафик не требуется. Если связь инициируется извне, достаточно задать правило безопасности для входящего трафика.
- Обратное также верно. Если через порт разрешено поступление входящего трафика, задавать правило безопасности исходящего трафика в ответ на трафик через этот порт не требуется.
- Существующие подключения не прерываются при отключении правила безопасности, разрешающего этот поток. Поток трафика прерывается, когда подключения разрываются, то есть в течение нескольких минут трафик не передается в обоих направлениях.
- Создавайте как можно меньше групп NSG, но столько, столько необходимо.

### <a name="best-practice-secure-northsouth-and-eastwest-traffic"></a>Рекомендация. Защита трафика "север — юг" и "восток — запад"

При защите виртуальных сетей важно учитывать векторы атак.
- Использование NSG только в подсетях упрощает среду, но защищает только трафик, поступающий в подсеть. Это называется трафиком "север — юг".
- Трафик между виртуальными машинами в одной и той же подсети называется трафиком "восток — запад".
- Важно использовать обе формы защиты, так как если злоумышленник получит доступ извне, он будет остановлен при попытке подключения к компьютерам, расположенным в той же подсети.

### <a name="use-service-tags-on-nsgs"></a>Использование тегов служб в NSG

Тег службы представляет группу префиксов IP-адресов. Использование тега службы упрощает создание правил NSG.
- Теги служб можно использовать вместо определенных IP-адресов при создании правил.
- Корпорация Майкрософт управляет префиксами адресов, связанными с тем или иным тегом службы, и автоматически обновляет этот тег при изменении адресов.
- Нельзя создать собственный тег службы или задать IP-адреса, которые будут входить в тег.

Теги служб позволяют избежать назначения правила группам служб Azure вручную. Например, если нужно разрешить подсети виртуальной сети, содержащей веб-серверы, доступ к Базе данных SQL Azure, можно создать правило для исходящего трафика на порт 1433 и использовать тег службы **Sql**.
- Тег **Sql** определяет префиксы адресов для служб Базы данных SQL Azure и Хранилища данных SQL Azure.
- Значение **Sql** отвечает за разрешение или запрет трафика в SQL.
- Чтобы разрешить доступ к **Sql** только в определенном регионе, можно указать этот регион. Например, чтобы разрешить доступ только к базе данных SQL Azure в регионе "Восточная часть США", можно указать тег службы **Sql.EastUS**.
- Тег представляет службу, но не определенные экземпляры службы. Например, тег представляет службу "База данных SQL Microsoft Azure", но не представляет определенную базу данных или сервер SQL Azure.
- Все префиксы адресов, представленные этим тегом, имеют также тег **Internet**.


**Подробнее:**

- [Сведения](https://docs.microsoft.com/en-us/azure/virtual-network/security-overview) о группах безопасности сети.
- [Просмотр](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) тегов служб, доступных для групп безопасности сети.


## <a name="best-practice-use-application-security-groups"></a>Рекомендация. Использование групп безопасности приложений

Группы безопасности приложений позволяют настроить сетевую безопасность как естественное расширение структуры приложений.

- Можно сгруппировать виртуальные машины и определить политики безопасности сети на основе групп безопасности приложений.
- Группы безопасности приложений позволяют повторно использовать политику безопасности в нужном масштабе без обслуживания явных IP-адресов вручную.
- Эти группы сами обрабатывают явные IP-адреса и множество наборов правил, позволяя вам сосредоточиться на бизнес-логике. 

### <a name="example"></a>Пример

![Группа безопасности приложений](./media/migrate-best-practices-networking/asg.png)
*Пример группы безопасности приложений*

**Сетевой интерфейс** | **Группа безопасности приложений**
--- | ---
NIC1 | AsgWeb
NIC2 | AsgWeb
NIC3 | AsgLogic
NIC4 | AsgDb 

- В нашем примере каждый сетевой интерфейс принадлежит только к одной группе безопасности приложений, но в реальной ситуации интерфейс может принадлежать к нескольким группам с учетом ограничений Azure.
- Группа NSG не связана с сетевыми интерфейсами. Группа NSG1 связана с обеими подсетями и содержит следующие правила.

    **Имя правила** | **Назначение** | **Дополнительные сведения**
    --- | --- | ---   
    Allow-HTTP-Inbound-Internet | Разрешение трафика из Интернета на веб-серверы. Входящий трафик из Интернета запрещен правилом безопасности DenyAllInbound по умолчанию, поэтому для групп безопасности приложений AsgLogic или AsgDb дополнительных правил не требуется. | Приоритет: 100<br/><br/> Источник: Интернет<br/><br/> Исходный порт: *<br/><br/> Назначение: AsgWeb<br/><br/> Конечный порт: 80<br/><br/> Протокол: TCP<br/><br/> Доступ: Разрешить.
    Deny-Database-All | Правило безопасности AllowVNetInBound по умолчанию разрешает весь обмен данными между ресурсами в одной и той же виртуальной сети, поэтому это правило требуется для блокирования трафика от всех ресурсов. | Приоритет: 120<br/><br/> Источник: *<br/><br/> Исходный порт: *<br/><br/> Назначение: AsgDb<br/><br/> Конечный порт: 1433<br/><br/> Протокол: Все<br/><br/> Доступ: Запретить.
    Allow-Database-BusinessLogic | Разрешение трафика из группы безопасности приложений AsgLogic в группу безопасности приложений AsgDb. Приоритет для этого правила выше, чем для правила Deny-Database-All, поэтому трафик из группы безопасности приложений AsgLogic разрешен, а весь остальной трафик блокируется. | Приоритет: 110<br/><br/> Источник: AsgLogic<br/><br/> Исходный порт: *<br/><br/> Назначение: AsgDb<br/><br/> Конечный порт: 1433<br/><br/> Протокол: TCP<br/><br/> Доступ: Разрешить.

- Правила, определяющие группу безопасности приложений в качестве источника или назначения, применяются только к сетевым интерфейсам, которые входят в ее состав. Если сетевой интерфейс не является членом группы безопасности приложений, правило не применяется к нему, несмотря на то, что группа безопасности сети связана с подсетью.

**Подробнее:**

- [Сведения](https://docs.microsoft.com/azure/virtual-network/security-overview#application-security-groups) о группах безопасности приложений.


### <a name="best-practice-secure-access-to-paas-using-vnet-service-endpoints"></a>Рекомендация. Защита доступа к PaaS с помощью конечных точек службы виртуальной сети

Конечные точки службы виртуальной сети расширяют пространство частных адресов виртуальной сети и возможности идентификации в службах Azure через прямое подключение.

- Конечные точки позволяют защитить критически важные ресурсы служб Azure только в пределах виртуальных сетей. Трафик, поступающий из виртуальной сети в службу Azure, всегда остается в магистральной сети Microsoft Azure.
- Частное адресное пространство виртуальной сети может перекрываться, поэтому его нельзя использовать для уникальной идентификации трафика, поступающего из виртуальной сети.
- Включив конечные точки служб в виртуальной сети, вы можете защитить в ней ресурсы служб Azure, добавив правило виртуальной сети для ресурсов служб. Это повысит уровень безопасности за счет полного блокирования открытого доступа к ресурсам из Интернета и разрешения трафика только из виртуальной сети.

![Конечные точки службы](./media/migrate-best-practices-networking/endpoint.png)
*Конечные точки службы*

**Подробнее:**

- [Сведения](https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoints-overview) о конечных точках службы виртуальной сети.


## <a name="best-practice-control-public-ip-addresses"></a>Рекомендация. Управление общедоступными IP-адресами

Общедоступные IP-адреса в Azure можно связать с виртуальными машинами, подсистемами балансировки нагрузки, шлюзами приложений и VPN-шлюзами.

- Общедоступные IP-адреса позволяют интернет-ресурсам устанавливать входящие подключения к ресурсам Azure, а ресурсам Azure — исходящие подключения к Интернету.
- Общедоступные IP-адреса создаются с номером SKU уровня "Базовый" или "Стандартный". Эти номера отличаются. Номера SKU уровня "Стандартный" можно назначить любой службе, но зачастую они используются на виртуальных машинах, а также в подсистемах балансировки нагрузки и шлюзах приложений.
- Важно отметить, что для общедоступного IP-адреса этого уровня группа безопасности сети не настраивается автоматически. Ее необходимо настроить самостоятельно и назначить правила для управления доступом. Для IP-адресов номеров SKU уровня "Стандартный" по умолчанию устанавливается группа безопасности сети и назначаются правила.
- Для виртуальных машин не следует настраивать общедоступный IP-адрес.
    - Если требуется открыть порт, он должен быть предназначен только для веб-служб, например порт 80 или 443.
    - Стандартные порты удаленного управления, например SSH (22) и RDP (3389), следует запретить с помощью групп безопасности сети, наряду со всеми остальными портами.
- Еще лучше разместить виртуальные машины за подсистемой балансировки нагрузки Azure или шлюзом приложений. Тогда при необходимости доступа к портам удаленного управления можно использовать JIT-доступ к виртуальной машине в Центре безопасности Azure.

**Подробнее:**

- [Сведения](https://docs.microsoft.com/azure/virtual-network/virtual-network-ip-addresses-overview-arm#public-ip-addresses) об общедоступных IP-адресах в Azure.
- [Сведения](https://docs.microsoft.com/azure/security-center/security-center-just-in-time) о JIT-доступе к виртуальным машинам в Центре безопасности Azure.


## <a name="leverage-azure-security-features-for-networking"></a>Использование функций безопасности Azure при настройке сетей

Azure содержит функции безопасности платформы, которые просты в использовании и предоставляют широкие возможности, направленные против распространенных сетевых атак. К ним относятся брандмауэр Azure, брандмауэр веб-приложения и служба "Наблюдатель за сетями".

## <a name="best-practice-deploy-azure-firewall"></a>Рекомендация. Развертывание брандмауэра Azure

Брандмауэр Azure — это управляемая облачная служба сетевой безопасности, которая защищает ресурсы виртуальной сети Azure. Брандмауэр разработан как служба с полным отслеживанием состояния со встроенной высокой доступностью и неограниченной облачной масштабируемостью.

![Конечные точки службы](./media/migrate-best-practices-networking/firewall.png)
*Брандмауэр Azure*

- В брандмауэре Azure можно централизованно создавать, применять и регистрировать политики приложений и сетевых подключений в подписках и виртуальных сетях.
- Брандмауэр Azure использует статический общедоступный IP-адрес для виртуальных сетевых ресурсов, позволяя внешним брандмауэрам идентифицировать трафик, исходящий из виртуальной сети.
- Брандмауэр Azure полностью интегрирован с Azure Monitor для ведения журналов и аналитики.
- При создании правила брандмауэра Azure рекомендуется использовать теги полных доменных имен (FQDN).
    - Тег FQDN — это группа полных доменных имен, связанных с известными службами Майкрософт.
    - С помощью тега FQDN можно разрешить нужный исходящий сетевой трафик через брандмауэр.
- Например, чтобы вручную разрешить сетевой трафик для Центра обновления Windows через брандмауэр, нужно создать несколько правил приложений. Используя теги FQDN, вы можете создать правило приложения и добавить тег Центра обновления Windows. При установке этого правила сетевой трафик к конечным точкам Центра обновления Windows сможет проходить через брандмауэр.

**Подробнее:**

- [Общие сведения](https://docs.microsoft.com/azure/firewall/overview) о брандмауэре Azure.
- [Сведения](https://docs.microsoft.com/azure/firewall/fqdn-tags) о тегах полных доменных имен.


## <a name="best-practice-deploy-azure-web-application-firewall-waf"></a>Рекомендация. Развертывание брандмауэра веб-приложений Azure (WAF)

Веб-приложения все чаще подвергаются вредоносным атакам, использующим общеизвестные уязвимости. Сюда входят, например, атаки путем внедрения кода SQL и межсайтовых сценариев. Предотвращение таких атак в коде приложения может быть сложной задачей, требующей постоянного обслуживания, установки исправлений и мониторинга на разных уровнях топологии приложения. Централизованный брандмауэр веб-приложений значительно упрощает управление безопасностью и помогает администраторам защищать приложения от угроз и вторжений. Брандмауэр веб-приложений может быстрее реагировать на угрозы безопасности по сравнению со средствами защиты каждого отдельного веб-приложения благодаря установке исправлений известных уязвимостей в центральном расположении. Существующие шлюзы приложений можно преобразовать в шлюзы приложений с поддержкой брандмауэра веб-приложений.

Брандмауэр веб-приложений (WAF) — это компонент шлюза приложений Azure.
- WAF предоставляет централизованную защиту веб-приложений от распространенных эксплойтов и уязвимостей.
- WAF обеспечивает защиту без внесения изменений в код серверной части.
- Брандмауэр может одновременно защищать несколько веб-приложений, находящихся за шлюзом приложений.
- WAF интегрируется с центром безопасности Azure.
- Можно настроить правила WAF и группы правил в соответствии с требованиями приложений.
- Рекомендуется задействовать WAF перед любым веб-приложением, доступным из Интернета, включая приложения, размещенные на виртуальных машинах Azure или в качестве службы приложений Azure.

**Подробнее:**
- [Сведения](https://docs.microsoft.com/azure/application-gateway/waf-overview) о WAF.
- [Просмотр](https://docs.microsoft.com/azure/application-gateway/application-gateway-waf-configuration) ограничений и исключений WAF.


## <a name="best-practice-implement-azure-network-watcher"></a>Рекомендация. Реализация службы Azure "Наблюдатель за сетями"

Служба Azure "Наблюдатель за сетями" предоставляет средства для наблюдения за ресурсами и обменом данными в виртуальной сети Azure. Например, можно отслеживать обмен данными между виртуальной машиной и конечной точкой, например другой виртуальной машиной или полным доменным именем, просматривать ресурсы и связи между ресурсами в виртуальной сети, а также диагностировать проблемы с сетевым трафиком.

![Наблюдатель за сетями](./media/migrate-best-practices-networking/network-watcher.png)
*Наблюдатель за сетями*

- С помощью службы "Наблюдатель за сетями" можно отслеживать и диагностировать проблемы с сетью, не входя в виртуальные машины.
- Можно активировать сбор пакетов, устанавливая оповещения, и получать доступ к сведениям о производительности в реальном времени на уровне пакетов. Обнаруженную проблему можно затем проанализировать.
- Рекомендуется использовать службу "Наблюдатель за сетями" для просмотра журналов потоков NSG.
    - Журналы потоков для групп безопасности сети (NSG) в службе "Наблюдатель за сетями" позволяют просматривать сведения о входящем и исходящем IP-трафике через NSG.
    - Запись в журналы потоков ведется в формате JSON.
    - В журналах потоков отображаются исходящие и входящие потоки на основе каждого правила, сетевой интерфейс, к которому применяется поток, сведения о потоке на основе пяти кортежей (IP-адрес источника и назначения, порт источника и назначения, протокол) и состояние трафика (разрешен или отклонен).

**Подробнее:**

- [Общие сведения](https://docs.microsoft.com/azure/network-watcher) о службе "Наблюдатель за сетями".
- [Сведения](https://docs.microsoft.com/azure/network-watcher/network-watcher-nsg-flow-logging-overview) о журналах потоков NSG.

## <a name="use-partner-tools-in-the-azure-marketplace"></a>Использование партнерских средств в Azure Marketplace.

Для более сложных сетевых топологий можно использовать продукты безопасности от партнеров Майкрософт, в том числе виртуальные сетевые устройства.

- Виртуальное сетевое устройство — это виртуальная машина, которая выполняет сетевые функции, такие как защита с использованием брандмауэра, оптимизация доступа к глобальной сети и др.
- Виртуальные сетевые устройства повышают безопасность и расширяют функции виртуальных сетей. Их можно развертывать для реализации брандмауэров с высоким уровнем доступности, средств предотвращения и обнаружения вторжений, брандмауэров веб-приложений (WAF), для оптимизации доступа к глобальной сети, маршрутизации, балансировки нагрузки, VPN, управления сертификатами, Active Directory и многофакторной идентификации.
- Виртуальные сетевые устройства доступны у множества поставщиков в  [Azure Marketplace](https://azuremarketplace.microsoft.com/). 
 

## <a name="best-practice-implement-firewalls-and-nvas-in-hub-networks"></a>Рекомендация. Реализация брандмауэров и виртуальных сетевых устройств в сетях-концентраторах

В концентраторе управление сетью периметра (с доступом к Интернету) обычно осуществляется с помощью брандмауэра Azure, фермы брандмауэров или брандмауэров веб-приложений (WAF). Рассмотрим следующие сравнения.

**Тип брандмауэра** | **Дополнительные сведения**
--- | ---
Брандмауэры веб-приложений (WAF) | Веб-приложения используются повсеместно и склонны демонстрировать уязвимости, открытые для потенциальной эксплуатации.<br/><br/> Брандмауэры веб-приложений предназначены для выявления атак на веб-приложения (HTTP/HTTPS) с большей точностью, чем позволяет универсальный брандмауэр.<br/><br/> По сравнению с традиционными брандмауэрами WAF содержат набор специальных функций для защиты внутренних веб-серверов от угроз.
Брандмауэр Azure | Подобно фермам брандмауэров виртуальных сетевых устройств (NVA), в брандмауэре Azure применяется общий механизм администрирования и набор правил безопасности для защиты рабочих нагрузок, размещенных в периферийных зонах, а также для управления доступом к локальным сетям.<br/><br/> В Брандмауэре Azure реализованы возможности масштабирования.
Брандмауэры виртуальных сетевых устройств (NVA) | Подобно брандмауэру Azure, в фермах брандмауэров виртуальных сетевых устройств (NVA) применяется общий механизм администрирования и набор правил безопасности для защиты рабочих нагрузок, размещенных в периферийных зонах, а также для управления доступом к локальным сетям.<br/><br/> Брандмауэры NVA можно вручную масштабировать за подсистемой балансировки нагрузки.<br/><br/> Хотя программное обеспечение брандмауэра NVA менее специализировано по сравнению с WAF, оно позволяет отфильтровывать больше приложений и проверять любой тип входящего и исходящего трафика.<br/><br/> Если вам нужно использовать виртуальные сетевые устройства, их можно найти в Azure Marketplace.

Рекомендуется использовать один набор брандмауэров Azure (или NVA) для трафика, поступающего из Интернета, и другой набор — для трафика, создаваемого локальными системами.
- Использование только одного набора брандмауэров в обоих случаях представляет угрозу безопасности, так как между двумя наборами сетевого трафика отсутствует периметр безопасности.
- Использование отдельных уровней брандмауэра упрощает проверку правил безопасности, а также помогает понять, какие правила соответствуют определенным входящим сетевым запросам.

**Подробнее:**
- [Сведения](https://docs.microsoft.com/azure/architecture/reference-architectures/dmz/secure-vnet-hybrid) об использовании виртуальных сетевых устройств в виртуальной сети Azure.

## <a name="next-steps"></a>Дополнительная информация 

Рассмотрите другие рекомендации:

- [Рекомендации](migrate-best-practices-security-management.md) по обеспечению безопасности и управлению после миграции.
- [Рекомендации](migrate-best-practices-costs.md) по управлению затратами после миграции.
