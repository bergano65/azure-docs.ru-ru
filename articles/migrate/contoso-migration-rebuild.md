---
title: Повторное создание локального приложения Contoso для использования в Azure | Документация Майкрософт
description: Узнайте, как Contoso перестраивает приложение для использования в Azure с помощью Службы приложений Azure, службы Kubernetes, CosmosDB, службы "Функции Azure" и Cognitive Services.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 10/11/2018
ms.author: raynew
ms.openlocfilehash: 74c33d73f15c4edf63a02ea5c9a0cdcad88bb68c
ms.sourcegitcommit: c174d408a5522b58160e17a87d2b6ef4482a6694
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2019
ms.locfileid: "59049751"
---
# <a name="contoso-migration-rebuild-an-on-premises-app-to-azure"></a>Миграция Contoso. Повторное создание локального приложения в Azure

В этой статье показано, как компания Contoso перемещает и перестраивает свое приложение SmartHotel360 для использования в Azure. Специалисты компании переносят виртуальную машину внешнего интерфейса приложения в веб-приложение Службы приложений Azure. Серверная часть приложения создана с использованием микрослужб, развернутых в контейнерах, управляемых Службой Azure Kubernetes (AKS). Веб-сайт взаимодействует со службой "Функции Azure", предоставляя функцию фотографирования животных. 

Это документ из цикла статей о том, как вымышленная компания Contoso переносит локальные ресурсы в облако Microsoft Azure. В статьях этого цикла содержатся общие сведения и сценарии развертывания, в которых проиллюстрирована настройка инфраструктуры миграции, оценка пригодности локальных ресурсов для миграции и выполнение различных типов миграции. Сценарии становятся все более сложными. Со временем мы добавим другие статьи.


**Статья** | **Дополнительные сведения** | **Состояние**
--- | --- | ---
[Статья 1. Общие сведения](contoso-migration-overview.md) | Предоставляет общие сведения о стратегии миграции Contoso, цикле статей и примерах приложений, которые мы используем. | Доступна
[Статья 2. Развертывание инфраструктуры миграции в Contoso](contoso-migration-infrastructure.md) | Здесь рассказывается о том, как Contoso готовит свою локальную инфраструктуру Azure для миграции. Для всех сценариев миграции Contoso используется одна и та же инфраструктура. | Доступна
[Статья 3. Доступ к локальным ресурсам](contoso-migration-assessment.md)  | В этой статье рассказывается, как компания Contoso выполняет оценку своего локального двухуровневого приложения SmartHotel360 в VMware. Для оценки виртуальных машин приложения компания Contoso использует службу [Миграция Azure](migrate-overview.md). Для оценки базы данных SQL Server приложения используется [помощник по миграции баз данных](https://docs.microsoft.com/sql/dma/dma-overview?view=sql-server-2017). | Доступна
[Статья 4. Повторное размещение приложения на виртуальных машинах Azure и в управляемом экземпляре базы данных SQL](contoso-migration-rehost-vm-sql-managed-instance.md) | Здесь демонстрируется, как Contoso выполняет процесс миграции приложения SmartHotel360 в Azure по методу lift-and-shift. Contoso переносит интерфейсную ВМ приложения с помощью [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview). Базу данных приложения она переносит в управляемый экземпляр SQL с помощью [Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview). | Доступна
[Статья 5. Повторное размещение приложения на виртуальных машинах Azure](contoso-migration-rehost-vm.md) | В этой статье рассказывается, как компания Contoso переносит виртуальные машины приложения SmartHotel360, используя только Site Recovery. | Доступна
[Статья 6. Повторное размещение приложения на виртуальных машинах Azure и в группах доступности SQL Server AlwaysOn](contoso-migration-rehost-vm-sql-ag.md) | Здесь показан выполняемый в Contoso процесс миграции приложения SmartHotel360. Contoso использует Site Recovery для переноса ВМ приложений и службы миграции баз данных для миграции базы данных приложения в кластер SQL Server, защищенный группой доступности AlwaysOn. | Доступна
[Статья 7. Перенос приложения компании Contoso: повторное размещение локального приложения Linux на виртуальных машинах Azure](contoso-migration-rehost-linux-vm.md) | Здесь показано, как компания Contoso осуществляет миграцию приложения Linux osTicket по методу lift-and-shift на виртуальные машины Azure с помощью Site Recovery | Доступна
[Статья 8. Миграция в компании Contoso. Повторное размещение локального приложения Linux в виртуальных машинах Azure и MySQL в Azure](contoso-migration-rehost-linux-vm-mysql.md) | В этой статье рассказывается, как компания Contoso выполняет миграцию приложения Linux osTicket на виртуальные машины Azure с помощью Site Recovery и миграцию базы данных приложения в экземпляр Azure MySQL Server с помощью MySQL Workbench. | Доступна
[Статья 9. Рефакторинг приложения для веб-приложений Azure и базы данных SQL Azure](contoso-migration-refactor-web-app-sql.md) | В статье демонстрируется, как Contoso переносит приложение SmartHotel360 в веб-приложение Azure, а базу данных приложения — в экземпляр SQL Server Azure. | Доступна
[Статья 10. Рефакторинг приложения Linux для веб-приложений Azure и MySQL в Azure](contoso-migration-refactor-linux-app-service-mysql.md) | В статье демонстрируется, как Contoso переносит приложение osTicket для Linux в веб-приложения Azure на нескольких сайтах, интегрированных с GitHub для непрерывной поставки. База данных приложения переносится в экземпляр Azure MySQL. | Доступна
[Статья 11. Рефакторинг Team Foundation Server в Azure DevOps Services](contoso-migration-tfs-vsts.md) | В этой статье показано, как Contoso выполняет миграцию локального развертывания Team Foundation Server (TFS) путем его переноса в Azure DevOps Services в Azure. | Доступна
[Статья 12. Повторное проектирование приложения для использования контейнеров Azure и базы данных SQL](contoso-migration-rearchitect-container-sql.md) | В статье демонстрируется, как Contoso переносит и перепроектирует приложение SmartHotel в Azure. Специалисты компании перепроектируют веб-уровень приложения в контейнер Windows и переносят базу данных приложения в Базу данных SQL Azure. | Доступна
Статья 13. Повторное создание приложения в Azure | В статье демонстрируется, как Contoso повторно создает свое приложение SmartHotel, используя ряд возможностей и служб Azure, включая Службу приложений Azure, Azure Kubernetes, Функции Azure, Cognitive Services и Cosmos DB. | Эта статья
[Статья 14. Масштабирование миграции в Azure](contoso-migration-scale.md) | Ознакомившись с вариантами сочетаний миграции, компания Contoso готовится к полномасштабной миграции в Azure. | Доступна

В этой статье рассказывается, как Contoso выполняет миграцию двухуровневого приложения Windows. Приложение .NET SmartHotel360 работает на виртуальных машинах VMware в Azure. Это приложение с открытым исходным кодом, и если вы хотите использовать его, загрузите его с [GitHub](https://github.com/Microsoft/SmartHotel360-Backend).


[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Адаптация к расширению бизнеса.** По мере развития компания Contoso хочет предоставлять клиентам различные возможности для работы на веб-сайтах.
- **Гибкость.** Компания Contoso должна эффективно прогнозировать изменения на рынке для успешной деятельности в рамках глобальной экономики. 
- **Масштабируемость.** По мере того как бизнес успешно растет, ИТ-отдел компании Contoso должен предоставлять системы, способные расти в том же темпе.
- **Затраты.** Компании Contoso требуется минимизировать затраты на лицензирование.

## <a name="migration-goals"></a>Цели миграции

Группа, работающая над облачной инфраструктурой компании Contoso, определила требования к приложению для этой миграции. Эти требования использовались для определения оптимального метода миграции:
 - Потребность использовать приложение в Azure всегда будет критически важной. Оно должно хорошо работать и легко масштабироваться.
 - Приложение должно использовать компоненты IaaS. Все должно быть создано для использования с PaaS или бессерверных служб.
 - Приложения должны запускаться в облачных службах, а контейнеры — находиться в частном реестре контейнеров всего предприятия в облаке.
 - Служба API, используемая для фотографирования домашних животных, должна быть точной и надежной в реальной среде, так как решения, принимаемые приложением, должны соблюдать работники отелей. Любой одобренный питомец может остаться в гостинице.
 - Чтобы соответствовать требованиям конвейера DevOps, Contoso будет использовать Azure DevOps для управления исходным кодом с репозиториями Git.  Автоматические сборки и выпуск будут использоваться для компиляции кода и его развертывания в веб-приложениях Azure, Функциях Azure и AKS.
 - Для микрослужб на серверной стороне и веб-сайта на интерфейсной стороне требуются разные конвейеры CI/CD.
 - Серверные службы имеют другой цикл выпуска, отличный от интерфейсного веб-приложения.  Чтобы выполнить это требование, развертываются два разных конвейера DevOps.
 - Contoso необходимо получить одобрение для развертывания всего интерфейсного веб-сайта, а конвейер CI/CD должен обеспечивать эти функции.


## <a name="solution-design"></a>Архитектура решения

Определив цели и требования, специалисты Contoso начинают разработку и анализ решения развертывания и идентифицируют процесс миграции, включая службы Azure, которые будут использоваться при миграции.

### <a name="current-app"></a>Текущее приложение

- Локальное приложение SmartHotel360 распределено на уровни на двух виртуальных машинах (WEBVM и SQLVM).
- Виртуальные машины расположены на узле VMware ESXi **contosohost1.contoso.com** (версии 6.5).
- Средой VMware управляет сервер vCenter Server 6.5 (**vcenter.contoso.com**), который запущен на виртуальной машине.
- Contoso использует локальный центр обработки данных (contoso-datacenter) с локальным контроллером домена (**contosodc1**).
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.


### <a name="proposed-architecture"></a>Предлагаемая архитектура

- Внешний интерфейс приложения будет развернут в качестве веб-приложения Службы приложений Azure в основном регионе Azure.
- Служба "Функции Azure" обеспечит передачу фотографий домашних животных, и веб-сайт будет взаимодействовать с этой функцией.
- Функция фотографирования домашних животных использует API компьютерного зрения Cognitive Services и CosmosDB.
- Серверная часть сайта создается с использованием микрослужб. Они будут развернуты в контейнерах, управляемых Службой Azure Kubernetes (AKS).
- Контейнеры будут созданы с помощью Azure DevOps и помещены в Реестр контейнеров Azure (ACR).
- Сейчас Contoso вручную развернет веб-приложение и код функции с помощью Visual Studio.
- Микрослужбы развертываются с помощью сценария PowerShell, который вызывает программы командной строки Kubernetes.

    ![Архитектура сценария](./media/contoso-migration-rebuild/architecture.png) 

  
### <a name="solution-review"></a>Проверка решения

Специалисты Contoso оценивают предлагаемый дизайн, составляя список плюсов и минусов.

**Рассмотрение** | **Дополнительные сведения**
--- | ---
**Преимущества** | Использование PaaS и бессерверных решений для полного развертывания значительно сокращает время управления со стороны Contoso.<br/><br/> Переход на архитектуру микрослужб позволяет Contoso легко расширять свое решение со временем.<br/><br/> Новая функциональность может быть подключена к Интернету, не нарушая ни одной из имеющихся баз кода решений.<br/><br/> Веб-приложение будет настроено с несколькими экземплярами, гарантируя отсутствие единой точки отказа.<br/><br/> Чтобы приложение могло обработать разные объемы трафика, включается автоматическое масштабирование.<br/><br/> В связи с переходом к службам PaaS компания Contoso может снять с учета устаревшие решения под управлением операционной системы Windows Server 2008 R2.<br/><br/> CosmosDB имеет встроенную отказоустойчивость, которой не требуется конфигурация Contoso. Это означает, что уровень данных больше не является единой точкой отказа.
**Недостатки** | По сравнению с другими вариантами миграции контейнеры более сложные. Для Contoso длительное изучение может стать проблемой.  Новый уровень сложности контейнеров представляет большую ценность, несмотря на длительное время, которое требуется на их изучение.<br/><br/> Рабочей группе в Contoso необходимо будет заполнить пробелы в знаниях, чтобы разобраться с Azure, контейнерами и микрослужбами приложения и обеспечить их обслуживание.<br/><br/> Компания Contoso не полностью реализовала DevOps для всего решения. Специалистам компании нужно подумать об этом при развертывании служб в AKS, Функциях и Службе приложений.



### <a name="migration-process"></a>Процесс миграции

1. Contoso подготавливает к работе ACR, AKS и CosmosDB.
2. Специалисты компании подготавливают инфраструктуру для развертывания, включая веб-приложение Azure, учетную запись хранения, функцию и API. 
3. Когда инфраструктура будет готова, специалисты компании создадут образы контейнеров микрослужб, используя службу Azure DevOps, которая отправляет их в ACR.
4. Contoso развернет большинство этих микрослужб в ASK с помощью сценария PowerShell.
5. Наконец, специалисты компании развернут функцию Azure и веб-приложение.

    ![Процесс миграции](./media/contoso-migration-rebuild/migration-process.png) 

### <a name="azure-services"></a>Службы Azure

**Служба** | **Описание** | **Стоимость**
--- | --- | ---
[AKS](https://docs.microsoft.com/sql/dma/dma-overview?view=ssdt-18vs2017) | Упрощает развертывание, администрирование и использование Kubernetes. Предоставляет полностью управляемую службу оркестрации контейнеров Kubernetes.  | AKS — это бесплатная служба.  Вы платите только за виртуальные машины, связанное хранилище и потребляемые сетевые ресурсы. [Узнайте больше](https://azure.microsoft.com/pricing/details/kubernetes-service/).
[Функции Azure](https://azure.microsoft.com/services/functions/) | Ускорьте процесс разработки с помощью управляемых событиями и независимыми от сервера вычислительных средств. Выполняйте масштабирование по необходимости.  | Платите только за использованные ресурсы. Плата по плану начисляется в зависимости от потребления ресурсов и числа выполнений в секунду. [Узнайте больше](https://azure.microsoft.com/pricing/details/functions/).
[Реестр контейнеров Azure](https://azure.microsoft.com/services/container-registry/) | Хранит образы для всех типов развертываний контейнеров. | Стоимость зависит от функций, типа хранилища и длительности использования. [Узнайте больше](https://azure.microsoft.com/pricing/details/container-registry/).
[службе приложений Azure](https://azure.microsoft.com/services/app-service/containers/) | Оперативно создавайте, развертывайте и масштабируйте веб-приложения, мобильные приложения и приложения API на любой платформе. | Плата за план службы приложений начисляется посекундно. [Узнайте больше](https://azure.microsoft.com/pricing/details/app-service/windows/).

## <a name="prerequisites"></a>Технические условия

Ниже приведены действия компании Contoso, необходимые для этого сценария.

**Требования** | **Дополнительные сведения**
--- | ---
**Подписка Azure.** | Компания Contoso уже создала подписки (это описывается в одной из предыдущих статей этой серии). Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/).<br/><br/> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия.<br/><br/> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника.
**Инфраструктура Azure** | [Узнайте, как](contoso-migration-infrastructure.md) компания Contoso настраивает инфраструктуру Azure.
**Предварительные требования для разработчика** | Contoso необходимы следующие средства на рабочей станции разработчика:<br/><br/> - [Выпуск Visual Studio Community 2017. Версия 15.5](https://www.visualstudio.com/)<br/><br/> включенная рабочая нагрузка .NET;<br/><br/> [Git](https://git-scm.com/)<br/><br/> [Azure PowerShell](https://azure.microsoft.com/downloads/)<br/><br/> [Интерфейс командной строки Azure](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest)<br/><br/> [Docker CE (Windows 10) или Docker EE (Windows Server)](https://docs.docker.com/docker-for-windows/install/), настроенные на использование контейнеров Windows.



## <a name="scenario-steps"></a>Шаги выполнения сценария

Ниже рассказывается, как компания Contoso выполняет миграцию.

> [!div class="checklist"]
> * **Шаг 1. Подготовка AKS и ACR**. Contoso подготавливает управляемый кластер AKS и реестр контейнеров Azure с помощью PowerShell.
> * **Шаг 2. Создание контейнеров Docker**. Специалисты компании настраивают CI для контейнеров Docker с помощью Azure DevOps и отправляют их в ACR.
> * **Шаг 3. Развертывание внутренних микрослужб**. Специалисты компании развертывают остальную часть инфраструктуры, которая будет использоваться серверными микрослужбами.
> * **Шаг 4. Развертывание клиентской инфраструктуры**. Специалисты компании развертывают клиентскую инфраструктуру, включая хранилище BLOB-объектов для телефонов хозяев животных, Cosmos DB и API компьютерного зрения.
> * **Шаг 5. Перенос серверной части**. Специалисты компании развертывают микрослужбы и запускают их в AKS для переноса серверной части.
> * **Шаг 6. Публикация внешнего интерфейса**. Специалисты компании публикуют приложение SmartHotel360 в службе приложений Azure и приложение-функцию, которое будет вызываться службой домашних животных.



## <a name="step-1-provision-back-end-resources"></a>Шаг 1. Подготовка ресурсов серверной части

Администраторы Contoso запускают сценарий развертывания для создания управляемого кластера Kubernetes с использованием AKS и Реестра контейнеров Azure.

- В инструкциях в этом разделе используется репозиторий **SmartHotel360-Azure-Backend**.
- Репозиторий GitHub **SmartHotel360-Azure-backend** содержит все программное обеспечение для этой части развертывания.

### <a name="prerequisites"></a>Технические условия

1. Перед запуском, администраторы Contoso убедитесь, что все необходимое программное обеспечение в установлен на компьютере разработки, которые они используют для развертывания.
2. С помощью **git clone https://github.com/Microsoft/SmartHotel360-Azure-backend.git** специалист компании клонирует репозиторий локально на компьютер разработки.


### <a name="provision-aks-and-acr"></a>Подготовка AKS и ACR

Администраторы Contoso выполняют подготовку следующим образом:

1.  Они открывают папку с помощью Visual Studio Code и перемещаются в каталог **/deploy/k8s**, который содержит сценарий **gen-aks-env.ps1**.
2. Специалисты компании выполняют сценарий развертывания для создания управляемого кластера Kubernetes с помощью AKS и Реестра контейнеров.

    ![AKS](./media/contoso-migration-rebuild/aks1.png)
 
3.  В открытом файле специалисты компании устанавливают для параметра $location значение **eastus2** и сохраняют изменения.

    ![AKS](./media/contoso-migration-rebuild/aks2.png)

4. Чтобы открыть интегрированный терминал в Code, щелкните **Вид** > **Интегрированный терминал**.

    ![AKS](./media/contoso-migration-rebuild/aks3.png)

5. В окне PowerShell интегрированного терминала входе в Azure с помощью команды Connect-AzAccount. Дополнительные сведения о начале работы с PowerShell см. в [этой статье](https://docs.microsoft.com/powershell/azure/get-started-azureps).

    ![AKS](./media/contoso-migration-rebuild/aks4.png)

6. Проверка подлинности Azure CLI выполняется с помощью команды **az login**. После ее запуска нужно следовать инструкциям для проверки подлинности с помощью веб-браузера. Дополнительные сведения о входе с помощью Azure CLI см. в [этой статье](https://docs.microsoft.com/cli/azure/authenticate-azure-cli?view=azure-cli-latest).

    ![AKS](./media/contoso-migration-rebuild/aks5.png)

7. Специалисты компании запускают следующую команду, передавая имя группы ресурсов ContosoRG, имя кластера AKS smarthotel-aks-eus2 и новое имя реестра.

    ```
    .\gen-aks-env.ps1  -resourceGroupName ContosoRg -orchestratorName smarthotelakseus2 -registryName smarthotelacreus2
    ```
    ![AKS](./media/contoso-migration-rebuild/aks6.png)

8. Azure создает другую группу ресурсов, содержащую ресурсы для кластера AKS.

    ![AKS](./media/contoso-migration-rebuild/aks7.png)

9. После завершения развертывания они устанавливают программу командной строки **kubectl**. Средство уже установлено на Azure CloudShell.

    **az aks install-cli**

10. Специалисты компании проверяют соединение с кластером, выполнив команду **kubectl get nodes**. Узел имеет то же имя, что и виртуальная машина в автоматически созданной группе ресурсов.

    ![AKS](./media/contoso-migration-rebuild/aks8.png)

11. Специалисты компании выполняют следующую команду для запуска панели мониторинга Kubernetes: 

    **az aks browse --resource-group ContosoRG --name smarthotelakseus2**

12. На вкладке браузера откроется панель мониторинга. Это туннельное подключение, использующее Azure CLI. 

    ![AKS](./media/contoso-migration-rebuild/aks9.png)




## <a name="step-2-configure-the-back-end-pipeline"></a>Шаг 2. Настройка серверного конвейера

### <a name="create-an-azure-devops-project-and-build"></a>Создание проекта и сборки Azure DevOps

Contoso создает проект Azure DevOps, настраивает сборку непрерывной интеграции, чтобы создать контейнер, а затем отправляет его в ACR. В инструкциях в этом разделе используется репозиторий [SmartHotel360-Azure-Backend](https://github.com/Microsoft/SmartHotel360-Azure-backend).

1. На visualstudio.com специалисты компании создают новую организацию (**contosodevops360.visualstudio.com**) и настраивают ее для использования Git.

2. Специалисты компании создают новый проект (**SmartHotelBackend**), используя Git для системы управления версиями и Agile для рабочего процесса.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts1.png) 


3. Специалисты компании импортируют [репозиторий GitHub](https://github.com/Microsoft/SmartHotel360-Backend).

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts2.png)
    
4. В разделе **Конвейеры** они щелкают **Сборка** и создают конвейер, используя Azure Repos Git в качестве источника. 

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts3.png)

6. Специалисты компании решили начать с пустого задания.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts4.png)  

7. Они выбирают **Hosted Linux Preview** (Размещенная предварительная версия Linux) для конвейера сборки.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts5.png) 
 
8. На **этапе 1** добавляется задача **Docker Compose**. Эта задача создает Docker Compose.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts6.png) 

9. Специалисты компании повторяют и добавляют еще одну задачу **Docker Compose**. Она отправляет контейнеры в ACR.

     ![Azure DevOps](./media/contoso-migration-rebuild/vsts7.png) 

8. Специалисты компании выбирают первую задачу (для создания) и настраивают для нее подписку Azure, авторизацию и ACR. 

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts8.png)

9. Они указывают путь к файлу **docker-compose.yaml** в папке **src** репозитория. Специалисты компании выбирают создание образов служб и включают последний тег. Когда действие меняется на **Build service images** (Создание образов служб), имя задачи Azure DevOps меняется на **Build services automatically** (Создание служб автоматически).

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts9.png)

10. Теперь они настраивают вторую задачу Docker (для отправки). Специалисты компании выбирают подписку и ACR **smarthotelacreus2**. 

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts10.png)

11. Опять же, специалисты компании вводят файл в файл docker-compose.yaml, выбирают **Push service images** (Отправка образов службы) и включают последний тег. Когда действие меняется на **Push service images** (Отправка образов служб), имя задачи Azure DevOps меняется на **Push services automatically** (Отправка служб автоматически).

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts11.png)

12. Настроив задачи Azure DevOps, Contoso сохраняет конвейер сборки и запускает процесс сборки.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts12.png)

13. Они отслеживают ход выполнения, перейдя к заданию создания.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts13.png)

14. После завершения создания в ACR отображаются новые репозитории, которые должны быть заполнены данными контейнеров, используемых микрослужбами.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts14.png)


### <a name="deploy-the-back-end-infrastructure"></a>Развертывание серверной инфраструктуры

Создав кластер AKS и сборку образов Docker, теперь администраторы Contoso развертывают остальную инфраструктуру, которая будет использоваться серверными микрослужбами.

- В этом разделе используются инструкции из репозитория [SmartHotel360-Azure-Backend](https://github.com/Microsoft/SmartHotel360-Azure-backend).
- В папке **/deploy/k8s/arm** есть один сценарий для создания всех элементов. 

Специалисты компании выполняют развертывание следующим образом:

1. Они открывают командную строку разработчика и используют команду az login для подписки Azure.
2. Администраторы используют файл deploy.cmd для развертывания ресурсов Azure в группе ресурсов ContosoRG и регионе EUS2, введя следующую команду:

    **.\deploy.cmd azuredeploy ContosoRG -c eastus2**

    ![Развертывание серверной части](./media/contoso-migration-rebuild/backend1.png)

2. На портале Azure специалисты компании записывают строки подключения для каждой базы данных. Они понадобятся позже.

    ![Развертывание серверной части](./media/contoso-migration-rebuild/backend2.png)

### <a name="create-the-back-end-release-pipeline"></a>Создание конвейера выпуска серверной части

Теперь администраторам Contoso потребуется предпринять следующее:

- Развернуть контроллер входящего трафика NGINX, чтобы разрешить входящий трафик к службам.
- Развернуть микрослужбы в кластере AKS.
- В первую очередь они обновляют строки подключения к микрослужбам с помощью Azure DevOps. Затем настраивают новый конвейер выпуска DevOps Azure для развертывания микрослужб.
- В инструкциях в этом разделе используется репозиторий [SmartHotel360-Azure-Backend](https://github.com/Microsoft/SmartHotel360-Azure-backend).
- Некоторые параметры конфигурации (например, Active Directory B2C) не рассматриваются в этой статье. Дополнительные сведения об этих параметрах содержатся в репозитории.

Далее создается конвейер:

1. С помощью Visual Studio они указывают в файле **/deploy/k8s/config_local.yml** записанные ранее сведения о подключении к базам данных.

    ![Подключения к базам данных](./media/contoso-migration-rebuild/back-pipe1.png)

2. Они открывают Azure DevOps и в проекте SmartHotel360 в разделе **Выпуски** щелкают **+ Новый конвейер**.

    ![Новый конвейер](./media/contoso-migration-rebuild/back-pipe2.png)

3. Специалисты щелкают **Пустое задание** для запуска конвейера без шаблона.
4. Они указывают имена рабочей области и конвейера.

      ![Название этапа](./media/contoso-migration-rebuild/back-pipe4.png)

      ![Имя конвейера](./media/contoso-migration-rebuild/back-pipe5.png)

5. Специалисты добавляют артефакт.

     ![Добавление артефакта](./media/contoso-migration-rebuild/back-pipe6.png)

6. Они выбирают **Git** в качестве источника и указывают проект, источник и главную ветвь для приложения SmartHotel360.

    ![Параметры артефакта](./media/contoso-migration-rebuild/back-pipe7.png)

7. Специалисты щелкают ссылку на задачу.

    ![Ссылка на задачу](./media/contoso-migration-rebuild/back-pipe8.png)

8. Они добавляют новую задачу Azure PowerShell, чтобы можно было запускать сценарий PowerShell в среде Azure.

    ![PowerShell в Azure](./media/contoso-migration-rebuild/back-pipe9.png)

9. Специалисты выбирают подписку Azure для задачи и сценарий **deploy.ps1** из репозитория Git.

    ![Запуск сценария](./media/contoso-migration-rebuild/back-pipe10.png)


10. Они добавляют аргументы в сценарий. Сценарий удаляет все содержимое кластера (за исключением **входящего трафика** и **контроллера входящего трафика**) и развертывает микрослужбы.

    ![Аргументы сценария](./media/contoso-migration-rebuild/back-pipe11.png)

11. Специалисты настраивают как предпочтительную последнюю версию Azure PowerShell и сохраняют конвейер.
12. На странице **Выпуск** вручную создают новый выпуск.

    ![Новый выпуск](./media/contoso-migration-rebuild/back-pipe12.png)

13. Они щелкают созданный выпуск и на вкладке **Действия** щелкают **Развернуть**.

      ![Развертывание выпуска](./media/contoso-migration-rebuild/back-pipe13.png)  

14. Когда развертывание завершено, специалисты выполняют следующую команду для проверки состояния служб, используя оболочку Azure Cloud Shell: **kubectl get services**.


## <a name="step-3-provision-front-end-services"></a>Шаг 3. Подготовка интерфейсных служб

Администраторам Contoso необходимо развернуть инфраструктуру, которая будет использоваться в интерфейсных приложениях. Специалисты компании создают контейнер хранилища BLOB-объектов для хранения изображений домашних животных, базу данных Cosmos для хранения документов с информацией о домашних животных и API компьютерного зрения для веб-сайтов. 

В этом разделе используются инструкции из репозитория [SmartHotel360-public-web](https://github.com/Microsoft/SmartHotel360-public-web).

### <a name="create-blob-storage-containers"></a>Создание контейнеров хранилища BLOB-объектов

1.  На портале Azure специалисты Contoso открывают созданную учетную запись хранения и выбирают **Большие двоичные объекты**.
2.  Он создает новый контейнер (**Pets**) и задает для него уровень общего доступа. Пользователи отправляют фотографии своих домашних животных в этот контейнер.

    ![Большой двоичный объект службы хранилища](./media/contoso-migration-rebuild/blob1.png)

3. Специалисты компании создают второй контейнер с именем **settings**. Здесь будет размещаться файл со всеми параметрами интерфейсного приложения.

    ![Большой двоичный объект службы хранилища](./media/contoso-migration-rebuild/blob2.png)

4. Специалисты компании получают сведения о доступе для учетной записи хранения в текстовом файле для дальнейшего использования.

    ![Большой двоичный объект службы хранилища](./media/contoso-migration-rebuild/blob2.png)

### <a name="provision-a-cosmos-database"></a>Подготовка базы данных Cosmos

Администраторы Contoso подготавливают базу данных Cosmos, которая будет использоваться для хранения информации о домашних животных.

1. Специалисты компании создают **Azure Cosmos DB** в Azure Marketplace.

    ![База данных Cosmos](./media/contoso-migration-rebuild/cosmos1.png)

2. Они указывают имя (**contosomarthotel**), выберите API SQL и помещают базу данных в рабочей группе ресурсов ContosoRG в основном регионе "Восточная часть США 2".

    ![База данных Cosmos](./media/contoso-migration-rebuild/cosmos2.png)

3. Специалисты компании добавляют новую коллекцию в базу данных с емкостью и пропускной способностью по умолчанию.

    ![База данных Cosmos](./media/contoso-migration-rebuild/cosmos3.png)


4. Они сохраняют информацию о подключении к базе данных для дальнейшего использования. 

    ![База данных Cosmos](./media/contoso-migration-rebuild/cosmos4.png)


### <a name="provision-computer-vision"></a>Подготовка API компьютерного зрения

Администраторы Contoso подготавливают API компьютерного зрения. API будет вызываться с помощью функции для оценки изображений, отправленных пользователями.

1. Специалисты компании Contoso создают экземпляр **API компьютерного зрения** в Azure Marketplace.

     ![API компьютерного зрения](./media/contoso-migration-rebuild/vision1.png)

2. Они подготавливают API (**smarthotelpets**) в рабочей группе ресурсов ContosoRG, которая находится в основном регионе "Восточная часть США 2".

    ![API компьютерного зрения](./media/contoso-migration-rebuild/vision2.png)

3. Специалисты компании сохраняют параметры подключения API в текстовый файл для последующего использования.

     ![API компьютерного зрения](./media/contoso-migration-rebuild/vision3.png)


### <a name="provision-the-azure-web-app"></a>Подготовка веб-приложения Azure

Администраторы Contoso подготавливают веб-приложение с помощью портала Azure.


1. На портале специалисты компании выбирают **Веб-приложение**.

    ![Веб-приложение](media/contoso-migration-rebuild/web-app1.png)

2. Они указывают имя приложения (**smarthotelcontoso**), запускают его в Windows и помещают в рабочую группу ресурсов **ContosoRG**. Они создают новый экземпляр Application Insights для мониторинга приложения.

    ![Имя веб-приложения](media/contoso-migration-rebuild/web-app2.png)

3. По завершении создания специалисты компании перейдут по адресу приложения, чтобы проверить, что оно создано успешно.

4. Теперь на портале Azure они создают промежуточный слот для кода. Конвейер развертывается в этот слот. Это гарантирует, что код не помещается в рабочую среду, пока администраторы выполняют выпуск.

    ![Промежуточный слот веб-приложения](media/contoso-migration-rebuild/web-app3.png)



### <a name="provision-the-azure-function-app"></a>Подготовка приложения-функции Azure

На портале Azure администраторы Contoso подготавливают приложение-функцию.

1. Они щелкают **Приложение-функция**.

    ![Создание приложения-функции](./media/contoso-migration-rebuild/function-app1.png)

2. Они предоставляют имя приложения (**smarthotelpetchecker**). Затем размещают приложение в рабочей группе ресурсов **ContosoRG**, устанавливают план размещения **План потребления** и помещают приложение в регион "Восточная часть США 2". Создается учетная запись хранения, а также экземпляр Application Insights для мониторинга.

    ![Параметры приложения-функции](./media/contoso-migration-rebuild/function-app2.png)


3. По завершении развертывания приложения специалисты компании перейдут по его адресу, чтобы проверить, что оно создано успешно.


## <a name="step-4-set-up-the-front-end-pipeline"></a>Шаг 4. Настройка интерфейсного конвейера

Администраторы Contoso создают два различных проекта для сайта внешнего интерфейса. 

1. В Azure DevOps они создают проект **SmartHotelFrontend**.

    ![Проект внешнего интерфейса](./media/contoso-migration-rebuild/function-app1.png)

2. Администраторы импортируют репозиторий Git [SmartHotel360 front-end](https://github.com/Microsoft/SmartHotel360-public-web.git) в новый проект.
3. Для приложения-функции они создают другой проект Azure DevOps (SmartHotelPetChecker) и импортируют репозиторий Git [PetChecker](https://github.com/Microsoft/SmartHotel360-PetCheckerFunction ) в этот проект.

### <a name="configure-the-web-app"></a>Настройка веб-приложения

Теперь администраторы Contoso настраивают веб-приложение для использования ресурсов Contoso.

1. Они подключаются к проекту Azure DevOps и клонируют репозиторий локально на компьютер разработки.
2. В Visual Studio специалисты компании открывают папку, чтобы просмотреть все файлы в репозитории.

    ![Файлы репозитория](./media/contoso-migration-rebuild/configure-webapp1.png)

3. Они вносят необходимые изменения конфигурации.

    - При запуске веб-приложение ищет параметр приложения **SettingsUrl**.
    - Данная переменная должна содержать URL-адрес файла конфигурации.
    - По умолчанию используется общедоступная конечная точка.

4.  Специалисты компании обновляют файл /config-sample.json/sample.json.

    - Это файл конфигурации веб-приложения при использовании общедоступной конечной точки.
    - Специалисты компании изменяют разделы **urls** и **pets_config**, указывая значения для конечных точек API AKS, учетных записей хранения и базы данных Cosmos.
    - URL-адреса должны соответствовать DNS-имени нового веб-приложения, которое создает Contoso.
    - Для Contoso это **smarthotelcontoso.eastus2.cloudapp.azure.com**.

    ![Параметры JSON](./media/contoso-migration-rebuild/configure-webapp2.png)

5. После обновления файла специалисты компании переименуют его в **smarthotelsettingsurl** и отправят в хранилище BLOB-объектов, которое было создано ранее.

    ![Переименование и отправка](./media/contoso-migration-rebuild/configure-webapp3.png)

6. Специалист компании щелкает файл, чтобы получить URL-адрес. Этот URL-адрес используется приложением, когда оно начинает извлекать файлы конфигурации.

    ![URL-адрес приложения](./media/contoso-migration-rebuild/configure-webapp4.png)

7. Специалисты компании указывают URL-адрес нового файла для параметра **SettingsUrl** в файле **appsettings.Production.json**.

    ![Обновление URL-адреса](./media/contoso-migration-rebuild/configure-webapp5.png)

### <a name="deploy-the-website-to-the-azure-app-service"></a>Развертывание веб-сайта в Службе приложений Azure

Администраторы Contoso теперь могут опубликовать веб-сайт.


1. Они открывают Azure DevOps и в проекте **SmartHotelFrontend** в разделе **Builds and Releases** (Сборки и выпуски) щелкают **+ Новый конвейер**.
2. Администраторы выбирают **Azure DevOps Git** как источник.
3. Затем они выбирают шаблон **ASP.NET Core**.
4. Они просматривают конвейер и проверяют, что выбраны **Публикация веб-проектов** и **Упаковать опубликованные проекты**.

    ![Параметры конвейера](./media/contoso-migration-rebuild/vsts-publishfront2.png)

5. В разделе **Триггеры** они включают непрерывную интеграцию и добавляют главную ветвь. Это гарантирует, что каждый раз, когда решение содержит новый код, зафиксированный в главной ветви, запускается конвейер сборки.

    ![Непрерывная интеграция](./media/contoso-migration-rebuild/vsts-publishfront3.png)

6. Администраторы нажимают **Сохранить и поместить в очередь**, чтобы запустить сборку.
7. После завершения сборки они настраивают конвейер выпуска, используя параметр **Развертывание службы приложений Azure**.
8. Они указывают имя этапа как **Промежуточный**.

    ![Имя среды](./media/contoso-migration-rebuild/vsts-publishfront4.png)

9. Администраторы добавляют артефакт и выбирают нужную настроенную сборку.

     ![Добавление артефакта](./media/contoso-migration-rebuild/vsts-publishfront5.png)

10. Они щелкают значок молнии на артефакте, чтобы включить непрерывное развертывание.

    ![Непрерывное развертывание](./media/contoso-migration-rebuild/vsts-publishfront6.png)
11. На вкладке **Среда** они щелкают **1 задание, 1 задача** в разделе **Промежуточный**.
12. После выбора подписки и имени приложения администраторы открывают задачу **Развертывание службы приложений Azure**. Развертывание настроено для использования **промежуточного** слота развертывания. В результате код будет автоматически создан для проверки и утверждения в этом слоте.

     ![Слот](./media/contoso-migration-rebuild/vsts-publishfront7.png)

13. На вкладке **Конвейер** администраторы добавляют новый этап.

    ![Новая среда](./media/contoso-migration-rebuild/vsts-publishfront8.png)

14. Они выбирают **Развертывание службы приложений Azure с помощью слота** и называют среду **Prod**.
15. Они щелкают **1 задание, 2 задачи** и выбирают подписку, имя службы приложений и **промежуточный** слот.

    ![Имя среды](./media/contoso-migration-rebuild/vsts-publishfront10.png)

16. Они удаляют этап **развертывания службы приложений Azure в слот** из конвейера. Он был помещен туда на предыдущих шагах.

    ![Удаление из конвейера](./media/contoso-migration-rebuild/vsts-publishfront11.png)

13. Они сохраняют конвейер. В конвейере администраторы щелкают **Условия после развертывания**.

    ![После развертывания](./media/contoso-migration-rebuild/vsts-publishfront12.png)

14. Они включают **Утверждения после развертывания** и добавляют руководителя разработки в качестве утверждающего.

    ![Утверждение после развертывания](./media/contoso-migration-rebuild/vsts-publishfront13.png)

15. В конвейере сборки они вручную запускают сборку. При этом запускается новый конвейер выпуска, который используется для развертывания сайта в промежуточном слоте. Для Contoso URL-адресом для слота является **https://smarthotelcontoso-staging.azurewebsites.net/**.
16. После завершения сборки и развертывания выпуска в слоте Azure DevOps отправляет электронное письмо руководителю разработки для утверждения.
17. Руководитель разработки щелкает **Просмотреть утверждение** и может утвердить или отклонить запрос на портале Azure DevOps.

    ![Письмо для утверждения](./media/contoso-migration-rebuild/vsts-publishfront14.png)

16. Руководитель оставляет комментарий, а затем утверждает. Запустится переключение сборки из **промежуточного** слота в слот **разработки**.

    ![Утверждение и переключение](./media/contoso-migration-rebuild/vsts-publishfront15.png)

17. Конвейер завершает переключение.

    ![Полное переключение](./media/contoso-migration-rebuild/vsts-publishfront16.png)

18. Команда проверяет слот **разработки**, чтобы убедиться, что веб-приложение находится в рабочей среде по адресу **https://smarthotelcontoso.azurewebsites.net/**.


### <a name="deploy-the-petchecker-function-app"></a>Развертывание приложения-функции PetChecker

Администраторы Contoso развертывают приложение следующим образом.

1. Они клонируют репозиторий локально на компьютер разработки, установив подключение к проекту Azure DevOps.
2. В Visual Studio специалисты компании открывают папку, чтобы просмотреть все файлы в репозитории.
3. Они открывают файл **src/PetCheckerFunction/local.settings.json** и добавляют параметры приложения для хранилища, базы данных Cosmos и API компьютерного зрения.

    ![Развертывание функции](./media/contoso-migration-rebuild/function5.png)

4. Администраторы фиксируют код и синхронизируют его с Azure DevOps, передав изменения.
5. Они добавляют новый конвейер сборки и выбирают **Azure DevOps Git** как источник.
6. Затем они выбирают шаблон **ASP.NET Core (.NET Framework)**.
7. Администраторы принимают значения по умолчанию для шаблона.
8. Затем в разделе **Триггеры** они выбирают **Включить непрерывную интеграцию** и щелкают **Сохранить и поместить в очередь**, чтобы запустить сборку.
9. По завершении сборки они создают конвейер выпуска, добавив **Развертывание службы приложений Azure с помощью слота**.
10. Администраторы вводят имя среды **Prod** и выбирают подписку. Они указывают в качестве **типа приложения** **Приложение-функция** и вводят имя службы приложений **smarthotelpetchecker**.

    ![Приложение-функция](./media/contoso-migration-rebuild/petchecker2.png)

11. Затем они добавляют артефакт **Сборка**.

    ![Артефакт](./media/contoso-migration-rebuild/petchecker3.png)

12. Специалисты включают **Триггер непрерывного развертывания** и нажимают кнопку **Сохранить**.
13. Они щелкают **Поставить новую сборку в очередь** для запуска полного конвейера CI/CD.
14. После развертывания функции она отображается на портале Azure с состоянием **Выполняется**.

    ![Развертывание функции](./media/contoso-migration-rebuild/function6.png)


7. Специалисты компании переходят к приложению по адресу [http://smarthotel360public.azurewebsites.net/Pets](http://smarthotel360public.azurewebsites.net/Pets), чтобы проверить, работает ли функция проверки домашних животных надлежащим образом.
8. Специалисты компании щелкают аватар, чтобы отправить изображение.

    ![Развертывание функции](./media/contoso-migration-rebuild/function7.png)

9. Сначала проверяется фотография небольшой собаки.

    ![Развертывание функции](./media/contoso-migration-rebuild/function8.png)

10. Приложение возвращает сообщение о принятии.

    ![Развертывание функции](./media/contoso-migration-rebuild/function9.png)






## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

- Компания Contoso должна гарантировать, что их новые базы данных безопасны. [Узнайте больше](https://docs.microsoft.com/azure/sql-database/sql-database-security-overview).
- Приложение необходимо обновить для использования SSL с сертификатами. Экземпляр контейнера должен быть повторно развернут для ответа через порт 443.
- Компании Contoso необходимо рассмотреть возможность использования KeyVault для защиты секретов для приложений Service Fabric. [Узнайте больше](https://docs.microsoft.com/azure/service-fabric/service-fabric-application-secret-management).

### <a name="backups-and-disaster-recovery"></a>Резервное копирование и аварийное восстановление

- Contoso следует рассмотреть требования резервного копирования для Базы данных SQL Azure. [Узнайте больше](https://docs.microsoft.com/azure/sql-database/sql-database-automated-backups).
- Компании Contoso нужно рассмотреть реализацию групп отработки отказа SQL для обеспечения отказоустойчивости в регионе для базы данных. [Узнайте больше](https://docs.microsoft.com/azure/sql-database/sql-database-geo-replication-overview).
- Специалисты компании могут использовать георепликацию для номера SKU уровня "Премиум" ACR. [Узнайте больше](https://docs.microsoft.com/azure/container-registry/container-registry-geo-replication).
- Cosmos DB создает резервные копии автоматически. [Здесь](https://docs.microsoft.com/azure/cosmos-db/online-backup-and-restore) можно узнать больше об этом процессе.

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- После развертывания всех ресурсов специалисты компании Contoso должны назначить теги Azure в соответствии со своим [планированием инфраструктуры](contoso-migration-infrastructure.md#set-up-tagging).
- Полное лицензирование входит в стоимость служб PaaS, которые использует Contoso. Это будет вычтено из EA.
- Компания будет использовать Управление затратами Azure по лицензии Cloudyn (дочернее подразделение корпорации Майкрософт). Это решение по управлению затратами для нескольких облаков позволяет использовать Azure и другие облачные ресурсы, а также управлять ими.  Дополнительные сведения об управлении расходами см. [на этой странице](https://docs.microsoft.com/azure/cost-management/overview).

## <a name="conclusion"></a>Заключение

В этой статье специалисты компании Contoso повторно создали приложение SmartHotel360 в Azure. Они перенастроили интерфейсную виртуальную машину локального приложения для использования веб-приложений Службы приложений Azure. Серверная часть приложения создана с использованием микрослужб, развернутых в контейнерах, управляемых Службой Azure Kubernetes (AKS). Специалисты компании улучшили возможности приложения с помощью приложения для фотографирования домашних животных.




