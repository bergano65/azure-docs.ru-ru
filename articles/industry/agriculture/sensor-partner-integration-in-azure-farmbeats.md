---
title: Интеграция с партнерскими датчиками
description: В этой статье описывается интеграция с партнерами, предоставляющими данные с датчиков.
author: uhabiba04
ms.topic: article
ms.date: 11/04/2019
ms.author: v-umha
ms.openlocfilehash: ef74c4b799c3a24636f88a8e704bf726104b034f
ms.sourcegitcommit: a43a59e44c14d349d597c3d2fd2bc779989c71d7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/25/2020
ms.locfileid: "96001598"
---
# <a name="sensor-partner-integration"></a>Интеграция с партнерскими датчиками

В этой статье содержатся сведения о компоненте **Translator** в Azure FarmBeats, который обеспечивает интеграцию с партнерами, предоставляющими данные с датчиков.

С помощью этого компонента партнеры могут выполнять интеграцию с FarmBeats с помощью API-интерфейсов FarmBeats Datahub и передавать данные и телеметрию с клиентских устройств в FarmBeats Datahub. После того как данные становятся доступными в FarmBeats, они визуализируются с помощью ускорителя FarmBeats и могут использоваться для обработки данных, а также для разработки моделей машинного обучения и искусственного интеллекта.

## <a name="before-you-start"></a>Перед началом работы

Для разработки компонента Translator потребуются следующие учетные данные, позволяющие получить доступ к API-интерфейсам FarmBeats.

- Конечная точка API
- Tenant ID
- Идентификатор клиента
- Секрет клиента
- Строка подключения EventHub

Сведения о получении указанных выше учетных данных см. в разделе о [включении интеграции с устройствами](get-sensor-data-from-sensor-partner.md#enable-device-integration-with-farmbeats).

## <a name="translator-development"></a>Разработка компонента Translator

**Интеграция на основе REST API**

Возможности интеграции данных с датчиков FarmBeats предоставляются через REST API. В число этих возможностей входят определение метаданных, подготовка устройств и датчиков, а также управление устройствами и датчиками.

**Прием данных телеметрии**

Данные телеметрии сопоставляются с каноническим сообщением, опубликованным в Центрах событий Azure для обработки. Центры событий Azure — это служба, которая обеспечивает прием данных (телеметрии), поступающих от подключенных устройств и приложений.

**Разработка API**

API-интерфейсы содержат техническую документацию по Swagger. Дополнительные сведения об API и их соответствующих запросах или ответах см. в [Swagger](https://aka.ms/FarmBeatsSwagger).

**Аутентификация**

FarmBeats использует проверку подлинности Microsoft Azure Active Directory. Служба приложений Azure предоставляет встроенную поддержку проверки подлинности и авторизации в службе приложений.

Дополнительные сведения см. в [этой статье](../../app-service/overview-authentication-authorization.md).

FarmBeats Datahub использует проверку подлинности носителя, для которой требуются следующие учетные данные:
   - Идентификатор клиента
   - Секрет клиента
   - Tenant ID

С помощью этих учетных данных вызывающий объект может запросить маркер доступа. Маркер должен отправляться в последующих запросах API в разделе заголовка, как показано далее:

```
headers = {"Authorization": "Bearer " + access_token, …} 
```

В следующем примере кода Python показано получение маркера доступа, который можно использовать для последующих вызовов API к FarmBeats.

```python
import requests
import json
import msal

# Your service principal App ID
CLIENT_ID = "<CLIENT_ID>"
# Your service principal password
CLIENT_SECRET = "<CLIENT_SECRET>"
# Tenant ID for your Azure subscription
TENANT_ID = "<TENANT_ID>"

AUTHORITY_HOST = 'https://login.microsoftonline.com'
AUTHORITY = AUTHORITY_HOST + '/' + TENANT_ID

ENDPOINT = "https://<yourfarmbeatswebsitename-api>.azurewebsites.net"
SCOPE = ENDPOINT + "/.default"

context = msal.ConfidentialClientApplication(CLIENT_ID, authority=AUTHORITY, client_credential=CLIENT_SECRET)
token_response = context.acquire_token_for_client(SCOPE)
# We should get an access token here
access_token = token_response.get('access_token')
```


**Заголовки запросов HTTP**

Ниже приведены наиболее распространенные заголовки запросов, которые необходимо указать при вызове API к FarmBeats Datahub.


**Верхняя часть** | **Описание и пример**
--- | ---
Content-Type | Формат запроса (Content-Type: application/<format>). Для API-интерфейсов FarmBeats Datahub используется формат JSON. Content-Type: application/json
Авторизация | Указывает маркер доступа, необходимый для выполнения вызова API. Авторизация: Bearer <маркер доступа>
Принять | Формат ответа. Для API-интерфейсов FarmBeats Datahub используется формат JSON. Accept: application/json

**Запросы API**

Чтобы выполнить запрос REST API, нужно объединить метод HTTP (GET, POST или PUT), URL-адрес службы API, универсальный код ресурса (URI) для запроса, отправки данных, обновления или удаления, а также один или несколько заголовков запроса HTTP. URL-адрес службы API — это указываемая конечная точка API. Вот пример: https:// \<yourdatahub-website-name> . azurewebsites.NET

При необходимости в вызовы GET можно включить параметры запроса для фильтрации, ограничения размера и сортировки данных в ответах.

Следующий пример запроса предназначен для получения списка устройств.

```bash
curl -X GET "https://microsoft-farmbeats.azurewebsites.net/Device" -H "Content-Type: application/json" -H "Authorization: Bearer <Access-Token>"
```
Для большинства вызовов GET, POST и PUT требуется текст запроса JSON.

Следующий пример запроса предназначен для создания устройства. (Этот пример содержит входной JSON с текстом запроса.)

```bash
curl -X POST "https://microsoft-farmbeats.azurewebsites.net/Device" -H  "accept: application/json" -H  "Content-Type: application/json" -H "Authorization: Bearer <Access-Token>" -d "{  \"deviceModelId\": \"ID123\",  \"hardwareId\": \"MHDN123\",  \"reportingInterval\": 900,  \"name\": \"Device123\",  \"description\": \"Test Device 123\",}"
```

## <a name="data-format"></a>Формат данных

JSON является стандартным не зависящим от языка форматом данных, предоставляющим простое текстовое представление произвольных структур данных. Дополнительные сведения см. на сайте [json.org](http://json.org).

## <a name="metadata-specifications"></a>Спецификации метаданных

FarmBeats Datahub содержит следующие API, которые позволяют партнерам, предоставляющим устройства, создавать метаданные устройства или датчика и управлять ими.

- /**DeviceModel**. DeviceModel соответствует метаданным устройства, таким как производитель и тип устройства (шлюз или узел).
- /**Device**. Device соответствует физическому устройству, находящемуся в ферме.
- /**SensorModel**. SensorModel соответствует метаданным датчика, таким как производитель, тип датчика, который является аналоговым или цифровым, и измерениям датчика, таким как температура окружающей среды и давление.
- /**Sensor**. Sensor соответствует физическому датчику, записывающему значения. Датчик обычно подключается к устройству по идентификатору устройства.

  DeviceModel | Описание |
  --- | ---
  Type (node, gateway)  | Тип устройства — узел или шлюз |
  Производитель  | Имя производителя |
  ProductCode  | Код продукта устройства или название или номер модели. Например, EnviroMonitor#6800. |
  порты;  | Имя порта и тип (цифровой или аналоговый).  |
  Имя  | Имя для идентификации ресурса. Например, название модели или продукта. |
  Описание  | Информативное описание модели. |
  Свойства  | Дополнительные свойства от производителя. |
  **Устройство** | **Описание** |
  DeviceModelId  |Идентификатор связанной модели устройства. |
  HardwareId   |Уникальный идентификатор устройства, например MAC-адрес.  |
  ReportingInterval |Отчетный интервал (в секундах). |
  Расположение    |Широта устройства (от –90 до + 90), долгота (от –180 до 180) и высота над уровнем моря (в метрах). |
  ParentDeviceId | Идентификатор родительского устройства, к которому подключено это устройство. Например, если узел подключен к шлюзу, шлюзом узла является parentDeviceID. |
  Имя  | Имя для идентификации ресурса. Партнеры, предоставляющие устройства, должны отправить имя, которое соответствует имени устройства на их стороне. Если имя устройства на стороне партнера, предоставляющего устройства, определено пользователем, то же самое определяемое пользователем имя должно быть передано в FarmBeats.  |
  Описание  | Информативное описание.  |
  Свойства  |Дополнительные свойства от производителя.  |
  **SensorModel** | **Описание** |
  Type (analog, digital)  |Тип датчика — аналоговый или цифровой.|
  Производитель  | Имя производителя. |
  ProductCode  | Код продукта или название или номер модели. Например, RS-CO2-N01.  |
  SensorMeasures > Name  | Имя измерения датчика. Поддерживаются только строчные буквы. Для измерений с различных глубин указывается значение глубины. Например, soil_moisture_15cm. Это имя должно быть согласовано с данными телеметрии. |
  SensorMeasures > DataType  | Тип данных телеметрии. Сейчас поддерживается тип double. |
  SensorMeasures > Type  | Тип измерения данных телеметрии датчика. Ниже перечислены типы, определяемые системой. AmbientTemperature, CO2, Depth, ElectricalConductivity, LeafWetness, Length, LiquidLevel, Nitrate, O2, PH, Phosphate, PointInTime, Potassium, Pressure, RainGauge, RelativeHumidity, Salinity, SoilMoisture, SoilTemperature, SolarRadiation, State, TimeDuration, UVRadiation, UVIndex, Volume, WindDirection, WindRun, WindSpeed, Evapotranspiration, PAR. Чтобы добавить дополнительные типы, используйте API /ExtendedType.
  SensorMeasures > Unit | Единица данных телеметрии датчика. Ниже перечислены единицы, определяемые системой. NoUnit, Celsius, Fahrenheit, Kelvin, Rankine, Pascal, Mercury, PSI, MilliMeter, CentiMeter, Meter, Inch, Feet, Mile, KiloMeter, MilesPerHour, MilesPerSecond, KMPerHour, KMPerSecond, MetersPerHour, MetersPerSecond, Degree, WattsPerSquareMeter, KiloWattsPerSquareMeter, MilliWattsPerSquareCentiMeter, MilliJoulesPerSquareCentiMeter, VolumetricWaterContent, Percentage, PartsPerMillion, MicroMol, MicroMolesPerLiter, SiemensPerSquareMeterPerMole, MilliSiemensPerCentiMeter, Centibar, DeciSiemensPerMeter, KiloPascal, VolumetricIonContent, Liter, MilliLiter, Seconds, UnixTimestamp, MicroMolPerMeterSquaredPerSecond и InchesPerHour. Чтобы добавить дополнительные типы, используйте API /ExtendedType.
  SensorMeasures > AggregationType  | Либо "Нет", "Средн.", "Макс.", "Мин.", либо StandardDeviation.
  SensorMeasures > Depth  | Глубина области действия датчика в сантиметрах. Например, измерение влажности на глубине 10 см.
  SensorMeasures > Description  | Информативное описание измерения.
  Имя  | Имя для идентификации ресурса. Например, название модели или продукта.
  Описание  | Информативное описание модели.
  Свойства  | Дополнительные свойства от производителя.
  **Sensor**  | **Описание** |
  HardwareId  | Уникальный идентификатор датчика, заданный производителем.
  SensorModelId  | Идентификатор связанной модели датчика.
  Расположение  | Широта (от –90 до + 90), долгота (от –180 до 180) и высота датчика над уровнем моря (в метрах).
  Port > Name  |Имя и тип порта, к которому подключен датчик на устройстве. Это имя должно совпадать с именем, определенным в модели устройства.
  deviceId  | Идентификатор устройства, к которому подключен датчик.
  Имя  | Имя для идентификации ресурса. Например, имя датчика или название продукта либо номер модели или код продукта.
  Описание  | Информативное описание.
  Свойства  | Дополнительные свойства от производителя.

 Сведения обо всех объектах и их свойствах см. в [Swagger](https://aka.ms/FarmBeatsDatahubSwagger).

 > [!NOTE]
 > API-интерфейсы возвращают уникальные идентификаторы для каждого созданного экземпляра. Компонент Translator должен хранить этот идентификатор для управления устройствами и синхронизации метаданных.


**Синхронизация метаданных**

Компонент Translator должен отправлять обновления метаданных. Например, сценарии обновления включают изменение имени устройства или датчика, а также изменение расположения устройства или датчика.

Компонент Translator должен иметь возможность добавлять новые устройства или датчики, которые были установлены пользователем после связывания FarmBeats. Аналогично, если пользователь обновил настройки устройства или датчика, необходимо изменить те же параметры соответствующего устройства или датчика в FarmBeats. Стандартным сценарием, требующим обновления устройства или датчика, является изменение расположения устройства или добавление датчиков в узел.


> [!NOTE]
> Удаление не поддерживается для метаданных устройства или датчика.
>
> Для обновления метаданных необходимо вызвать /Get/{id} на устройстве или датчике, обновить измененные свойства, а затем выполнить /Put/{id}, чтобы сохранить все свойства, заданные пользователем.

### <a name="add-new-types-and-units"></a>Добавление новых типов и единиц измерения

FarmBeats поддерживает добавление новых типов и единиц измерений датчика. Дополнительные сведения об API /ExtendedType см. в [Swagger](https://aka.ms/FarmBeatsSwagger).

## <a name="telemetry-specifications"></a>Спецификации телеметрии

Данные телеметрии сопоставляются с каноническим сообщением, опубликованным в Центрах событий Azure для обработки. Центры событий Azure — это служба, которая обеспечивает прием данных (телеметрии), поступающих от подключенных устройств и приложений.

## <a name="send-telemetry-data-to-farmbeats"></a>Отправка данных телеметрии в FarmBeats

Чтобы отправить данные телеметрии в FarmBeats, создайте клиент, отправляющий сообщения в концентратор событий в FarmBeats. Дополнительные сведения о данных телеметрии см. в статье об [отправке телеметрии в концентратор событий](../../event-hubs/event-hubs-dotnet-standard-getstarted-send.md).

Ниже приведен пример кода Python, который отправляет телеметрию в качестве клиента в указанный концентратор событий.

```python
import azure
from azure.eventhub import EventHubClient, Sender, EventData, Receiver, Offset
EVENTHUBCONNECTIONSTRING = "<EventHub Connection String provided by customer>"
EVENTHUBNAME = "<EventHub Name provided by customer>"

write_client = EventHubClient.from_connection_string(EVENTHUBCONNECTIONSTRING, eventhub=EVENTHUBNAME, debug=False)
sender = write_client.add_sender(partition="0")
write_client.run()
for i in range(5):
    telemetry = "<Canonical Telemetry message>"
    print("Sending telemetry: " + telemetry)
    sender.send(EventData(telemetry))
write_client.stop()

```

Каноническое сообщение имеет следующий формат:

```json
{
"deviceid": "<id of the Device created>",
"timestamp": "<timestamp in ISO 8601 format>",
"version" : "1",
"sensors": [
    {
      "id": "<id of the sensor created>",
      "sensordata": [
        {
          "timestamp": "< timestamp in ISO 8601 format >",
          "<sensor measure name (as defined in the Sensor Model)>": <value>
        },
        {
          "timestamp": "<timestamp in ISO 8601 format>",
          "<sensor measure name (as defined in the Sensor Model)>": <value>
        }
      ]
    }
 ]
}
```
Все имена ключей в JSON телеметрии должны быть указаны в нижнем регистре. Примеры — deviceid и sensordata.

Например, вот как выглядит сообщение телеметрии:


```json
{
  "deviceid": "7f9b4b92-ba45-4a1d-a6ae-c6eda3a5bd12",
  "timestamp": "2019-06-22T06:55:02.7279559Z",
  "version" : "1",
  "sensors": [
    {
      "id": "d8e7beb4-72de-4eed-9e00-45e09043a0b3",
      "sensordata": [
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_max": 15
        },
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_min": 42
        }
      ]
    },
    {
      "id": "d8e7beb4-72de-4eed-9e00-45e09043a0b3",
      "sensordata": [
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_max": 20
        },
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_min": 89
        }
      ]
    }
  ]
}

```

> [!NOTE]
> Следующие разделы относятся к другим изменениям (например, пользовательский интерфейс, управление обработкой ошибок и т. д.), и партнеры, предоставляющие данные с датчиков, могут воспользоваться этими сведениями при разработке компонента Translator.


## <a name="link-a-farmbeats-account"></a>Связывание учетной записи FarmBeats

После приобретения и развертывания устройств или датчиков клиенты могут получать доступ к данным и телеметрии устройств на портале SaaS (программное обеспечение как услуга) партнеров, предоставляющих устройства. Партнеры, предоставляющие устройства, могут разрешить клиентам связывать их учетные записи с экземпляром FarmBeats в Azure путем ввода следующих учетных данных:

   - Отображаемое имя (необязательное поле для определения имени этой интеграции)
   - Конечная точка API
   - Tenant ID
   - Идентификатор клиента
   - Секрет клиента
   - Строка подключения EventHub
   - Дата начала

   > [!NOTE]
   > В дату начала запускается поток исторических данных, то есть данных с даты, указанной пользователем.

## <a name="unlink-farmbeats"></a>Удаление связи с FarmBeats

Партнеры, предоставляющие устройства, могут разрешить клиентам удалять связь с существующей интеграцией FarmBeats. Удаление связи FarmBeats не приводит к удалению метаданных устройства или датчика, созданных в FarmBeats Datahub. При удалении связи происходит следующее:

   - Останавливается поток телеметрии.
   - Удаляются и стираются учетные данные интеграции у партнера, предоставляющего устройства.

## <a name="edit-farmbeats-integration"></a>Изменение интеграции FarmBeats

Партнеры, предоставляющие устройства, могут разрешить клиентам изменять параметры интеграции FarmBeats при изменении секрета клиента или строки подключения. В этом случае можно редактировать только значения в следующих полях:

   - Отображаемое имя (если применимо)
   - Секрет клиента (должен отображаться в формате "2x8***********" или в виде функции "Показать/Скрыть", а не в виде простого текста)
   - Строка подключения (должна отображаться в формате "2x8***********" или в виде функции "Показать/Скрыть", а не в виде простого текста)

## <a name="view-the-last-telemetry-sent"></a>Просмотр последней отправленной телеметрии

Партнеры, предоставляющие устройства, могут разрешить клиентам просматривать метку времени последней отправленной телеметрии, которая находится в разделе **Отправленная телеметрия**. Это время последней успешной отправки телеметрии в FarmBeats.

## <a name="troubleshooting-and-error-management"></a>Устранение неполадок и управление обработкой ошибок

**Механизм устранения неполадок или поддержка**

Если клиент не может получить данные или телеметрию с устройства в указанном экземпляре FarmBeats, партнер, предоставляющий устройства, должен обеспечить поддержку и предложить механизм для устранения неполадок.

**Хранение данных телеметрии**

Данные телеметрии должны храниться в течение предопределенного периода времени, чтобы их можно было использовать при отладке или для повторной отправки при возникновении ошибок или в случае потери данных.

**Управление обработкой ошибок или уведомления об ошибках**

Если ошибка влияет на метаданные устройства или датчика либо на поток данных интеграции или телеметрии в системе партнера, предоставляющего устройства, клиент должен получать соответствующие уведомления. Кроме того, должен быть разработан и реализован механизм разрешения любых ошибок.

**Контрольный список подключения**

Производители устройств или партнеры, предоставляющие устройства, могут использовать следующий контрольный список для обеспечения точности учетных данных, предоставляемых клиентом:

   - Проверка получения маркера доступа с указанными учетными данными.
   - Проверка результата вызова API (успешно или с ошибкой), который выполнялся с полученным маркером доступа.
   - Проверка установки клиентского подключения EventHub.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о REST API см. в [этой статье](rest-api-in-azure-farmbeats.md).