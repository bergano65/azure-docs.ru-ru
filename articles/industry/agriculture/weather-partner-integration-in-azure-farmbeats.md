---
title: Интеграция с партнерами, предоставляющими данные о погоде
description: Узнайте, как поставщик данных Weather может интегрироваться с Фармбеатс.
author: sunasing
ms.topic: article
ms.date: 07/09/2020
ms.author: sunasing
ms.openlocfilehash: f0fbd93e2a5f4e92089e10e75dc17e304ff80bf6
ms.sourcegitcommit: 4b76c284eb3d2b81b103430371a10abb912a83f4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/01/2020
ms.locfileid: "93147085"
---
# <a name="weather-partner-integration-with-farmbeats"></a>Интеграция партнера Weather с Фармбеатс

В этой статье содержатся сведения о компоненте DOCKER соединителя Azure Фармбеатс. Как поставщик данных Weather можно использовать соединитель DOCKER для интеграции с Фармбеатс. Используйте его API-интерфейсы для отправки данных о погоде в Фармбеатс. В Фармбеатс данные можно использовать для создания данных, а также для сборки моделей машинного обучения или моделей искусственного интеллекта.

 > [!NOTE]
 > В этой статье мы используем [эталонную реализацию](https://github.com/azurefarmbeats/noaa_docker) , созданную с помощью открытых наборов данных Azure и погоды, из национального управлением океанических и атмосферных Administration (NOAA). Мы также используем соответствующий [образ DOCKER](https://hub.docker.com/r/azurefarmbeats/farmbeats-noaa).

Необходимо указать [подходящий образ или программу DOCKER](#docker-specifications) и разместить образ DOCKER в реестре контейнеров, к которому пользователи могут обращаться. Предоставьте пользователям следующие сведения:

- URL-адрес образа DOCKER
- Тег образа DOCKER
- Ключи или учетные данные для доступа к образу DOCKER
- Ключи API или учетные данные для конкретного клиента для доступа к данным из системы
- Сведения о номере SKU виртуальной машины (укажите эти сведения, если образ DOCKER имеет особые требования к виртуальной машине. В противном случае клиенты смогут выбирать из поддерживаемых номеров SKU виртуальных машин в Azure.)

Клиенты используют эту информацию DOCKER для регистрации партнера по погоде в своем экземпляре Фармбеатс. Дополнительные сведения о том, как клиенты могут использовать DOCKER для приема данных о погоде в Фармбеатс, см. в статье [Получение данных от партнеров по погоде](./get-weather-data-from-weather-partner.md).

## <a name="connector-docker-development"></a>Разработка DOCKER Connector

**Интеграция на основе REST API**

API-интерфейсы Фармбеатс содержат техническую документацию по Swagger. Дополнительные сведения об API и соответствующих запросах или ответах см. в [Фармбеатс Swagger](https://aka.ms/farmbeatsswagger). 

Если вы уже установили Фармбеатс, обратитесь к Фармбеатс Swagger по адресу `https://yourfarmbeatswebsitename-api.azurewebsites.net/swagger`

Обратите внимание, что *API* добавляется в имя веб-сайта фармбеатс. Конечная точка API `https://yourfarmbeatswebsitename-api.azurewebsites.net`

### <a name="datahub-lib"></a>Датахуб lib

Фармбеатс предоставляет программу LIB, которую можно использовать. В настоящее время библиотека доступна как [часть эталонной реализации](https://github.com/azurefarmbeats/noaa_docker/tree/master/datahub_lib). Позже он будет доступен в виде пакета SDK для нескольких языков.

### <a name="authentication"></a>Аутентификация

**Проверка подлинности с помощью API Фармбеатс**

Фармбеатс использует проверку подлинности носителя. Доступ к API можно получить, предоставив маркер доступа в разделе заголовка запроса. Ниже приведен пример:

```
headers = *{"Authorization": "Bearer " + access_token, …}*
```

Вы можете запросить маркер доступа из приложения "функции Azure", которое выполняется в экземпляре Фармбеатс клиента. URL-адрес функций Azure предоставляется программе DOCKER в качестве аргумента. Маркер доступа можно получить, выполнив `GET` запрос по URL-адресу. Ответ от URL-адреса содержит маркер доступа. 

Используйте вспомогательные функции в Датахуб lib для получения маркера доступа. Дополнительные сведения см. на [странице GitHub образа NOAA DOCKER](https://github.com/azurefarmbeats/noaa_docker/blob/master/datahub_lib/auth/partner_auth_helper.py).

Маркер доступа допустим только в течение нескольких часов. По истечении срока его действия необходимо запросить снова.

**Проверка подлинности с помощью API на стороне партнера**

Для проверки подлинности с помощью API на стороне партнера во время выполнения задания DOCKER клиентам необходимо предоставить учетные данные во время регистрации партнера. Ниже приведен пример:

```json
{
 "partnerCredentials": {
   "key1": "value1",
   "key2": "value2"
   }
}
```
Служба API сериализует этот словарь и сохраняет его в [хранилище ключей](../../key-vault/general/basic-concepts.md).

[Фабрика данных Azure](../../data-factory/introduction.md) используется для оркестрации заданий погоды. Он выстраивает ресурсы для запуска кода docker. Фабрика данных также предоставляет механизм для безопасного помещения данных на виртуальную машину, в которой выполняется задание DOCKER. Затем учетные данные API безопасно хранятся в хранилище ключей. 

Учетные данные считываются как защищенные строки из хранилища ключей. Они предоставляются в виде расширенных свойств в рабочем каталоге контейнера DOCKER. Путь к файлу — */мнт/working_dir и activity.js* . 

Код DOCKER может считывать учетные данные из *activity.js* во время выполнения, чтобы получить доступ к API-интерфейсам на стороне партнера для клиента. В файле JSON учетные данные выглядят как следующий пример кода:

```json
{ 
   "typeProperties" : {
      "extendedProperties" : { 
         "partnerCredentials": "" } 
   } 
}
```
`partnerCredentials`Учетные данные доступны в том виде, в котором клиент предоставил им во время регистрации партнера.

Фармбеатс lib предоставляет вспомогательные функции. Используйте эти функции для считывания учетных данных из свойств действия. Дополнительные сведения см. на [странице GitHub образа NOAA DOCKER](https://github.com/azurefarmbeats/noaa_docker/blob/master/datahub_lib/auth/partner_adf_helper.py).

Файл используется только во время выполнения кода docker. После завершения кода файл удаляется.

Дополнительные сведения о работе конвейеров и действий фабрики данных см. в разделе [схема и сопоставление типов данных](../../data-factory/copy-activity-schema-and-type-mapping.md).

**Заголовки запросов HTTP**

В следующей таблице показаны наиболее распространенные заголовки запросов, которые необходимо указать при выполнении вызова API в Фармбеатс.

Header | Описание и пример
--- | ---
Content-Type | Формат запроса. Пример: `Content-Type: application/<format>` <br/>Для API-интерфейсов FarmBeats Datahub используется формат JSON. Пример: ` Content-Type: application/json`
Авторизация | Маркер доступа, необходимый для выполнения вызова API. Пример: `Authorization: Bearer <Access-Token>`
Принять | Формат ответа. Для API-интерфейсов FarmBeats Datahub используется формат JSON. Пример: `Accept: application/json`

## <a name="data-format"></a>Формат данных

JSON является стандартным не зависящим от языка форматом данных, предоставляющим простое текстовое представление произвольных структур данных. Дополнительные сведения см. в разделе [JSON.org](https://json.org).

## <a name="docker-specifications"></a>Спецификации DOCKER

Программе DOCKER требуются два компонента: начальная загрузка и задание. Программа может иметь более одного задания.

### <a name="bootstrap"></a>Бутстрэп

Компонент начальной загрузки должен запускаться, когда клиент запускает регистрацию DOCKER в Фармбеатс. Следующие аргументы ( `arg1` и `arg2` ) передаются в программу:

- **Конечная точка API фармбеатс** : конечная точка API фармбеатс для запросов API. Эта конечная точка выполняет вызовы API к развертыванию Фармбеатс.
- **URL-адрес функций Azure** : собственная конечная точка. Этот URL-адрес предоставляет маркер доступа для API-интерфейсов Фармбеатс. `GET`Для получения маркера доступа можно вызвать по этому URL-адресу.

Начальная загрузка создает метаданные, необходимые пользователям для выполнения заданий по получению данных о погоде. Дополнительные сведения см. в описании [эталонной реализации](https://github.com/azurefarmbeats/noaa_docker). 

Если вы настраиваете *bootstrap_manifest.jsв* файле, программа начальной загрузки автоматически создаст необходимые метаданные. Программа начальной загрузки создает следующие метаданные: 

 > [!NOTE]
 > Если вы обновляете *bootstrap_manifest.jsв* файле в соответствии с описанием [эталонной реализации](https://github.com/azurefarmbeats/noaa_docker) , не нужно создавать следующие метаданные. Программа начальной загрузки будет использовать файл манифеста для создания необходимых метаданных.

- /**Веасердатамодел** : метаданные веасердатамодел представляют данные о погоде. Он соответствует наборам данных, предоставляемым источником. Например, Даилифорекастсимплемодел может предоставлять среднюю информацию о температуре, влажности и осадков один раз в день. В отличие от этого, Даилифорекастадванцедмодел может предоставить гораздо больше информации по почасовой детализации. Можно создать любое количество моделей данных погоды.
- /**JobType** : фармбеатс имеет расширенную систему управления заданиями. Как поставщик данных Weather, у вас будут различные наборы данных и интерфейсы API (например, Жетдаилифорекастс). Вы можете включить эти наборы данных и API-интерфейсы в Фармбеатс с помощью JobType. После создания типа задания клиент может активировать задания этого типа, чтобы получить данные о погоде в своем местоположении или их ферме. Дополнительные сведения см. в разделе API JobType и задания в [Swagger фармбеатс](https://aka.ms/farmbeatsswagger).

### <a name="jobs"></a>Задания

Компонент заданий вызывается каждый раз, когда пользователь Фармбеатс запускает задание/Жобтипе, созданное в ходе процесса начальной загрузки. Команда DOCKER Run для задания определяется как часть созданного/Жобтипе.

Задание извлекает данные из источника и отправляет их в Фармбеатс. В процессе начальной загрузки параметры, необходимые для получения данных, должны быть определены как часть/Жобтипе.

В рамках задания программа должна создать/Веасердаталокатион на основе/Веасердатамодел, созданного в процессе начальной загрузки. /Веасердаталокатион соответствует расположению (координаты широты и долготы), которое пользователь предоставил в качестве параметра для задания.

### <a name="object-details"></a>Сведения об объекте

веасердатамодел | Описание |
--- | ---
Имя  | Имя модели данных weather. |
Описание  | Понятное описание модели. |
Свойства  | Дополнительные свойства, определяемые поставщиком данных. |
Имя > Веасермеасурес  | Имя меры погоды. Например, humidity_max. |
Тип данных Веасермеасурес >  | Значение типа Double или enum. Если ENUM, Меасуринумдефинитион является обязательным. |
Веасермеасурес > Меасуринумдефинитион  | Требуется только в том случае, если DataType имеет тип enum. Например `{ "NoRain": 0, "Snow": 1, "Drizzle": 2, "Rain": 3 }`. |
Тип > Веасермеасурес  | Тип данных телеметрии погоды. Например, RelativeHumidity. Определяемые системой типы: Амбиенттемпературе, Леафветнесс, Length, Електрикалкондуктивити, нитрате, O2, PH, фосфате, PointInTime, potassium, давление, RainGauge, RelativeHumidity, Salinity, SoilMoisture, SoilTemperature, SolarRadiation, State, TimeDuration, UVRadiation, UVIndex, том, WindDirection, WindRun, WindSpeed, Evapotranspiration и номинал. Дополнительные сведения о добавлении типов см. в разделе [Добавление ExtendedType](#add-extendedtype) в этой статье.
Единица > Веасермеасурес | Единица данных телеметрии погоды. Определяемые системой единицы — это "ед., Цельсия, Фаренгейта, Кельвина, Ранкине" Pascal, Меркурий, PSI, миллиметр, сантиметры, измерения, дюймы, футы, мили, километры, Милесперхаур, Милесперсеконд, Кмперхаур, Кмперсеконд, Метерсперхаур, Метерсперсеконд, degree, WattsPerSquareMeter, KiloWattsPerSquareMeter, MilliWattsPerSquareCentiMeter, MilliJoulesPerSquareCentiMeter, VolumetricWaterContent, процент, PartsPerMillion, MicroMole, MicroMolesPerLiter, SiemensPerSquareMeterPerMole, MilliSiemensPerCentiMeter, Centibar, DeciSiemensPerMeter, KiloPascal, VolumetricIonContent, Liter, MilliLiter, секунд, UnixTimestamp, MicroMolePerMeterSquaredPerSecond и InchesPerHour. Дополнительные сведения о добавлении единиц см. в разделе [Добавление ExtendedType](#add-extendedtype) в этой статье.
Веасермеасурес > AggregationType  | Тип статистической обработки. Возможные значения: None, СРЗНАЧ, Maximum, минимум, стандартное отклонение, Sum и Total.
Глубина > Веасермеасурес  | Глубина области действия датчика в сантиметрах. Например, измерение влажности на глубине 10 см.
Описание > Веасермеасурес  | Понятное описание измерения. 

JobType | Описание |
--- | ---
Имя  | Имя задания. Например, Get_Daily_Forecast. Клиент запустит это задание для получения данных о погоде.|
имя > Пипелинедетаилс > параметров  | Имя параметра. |
Тип > параметров > Пипелинедетаилс | Тип параметра. Возможные значения: String, int, float, bool и Array. |
Параметры > Пипелинедетаилс > обязательные | Логическое значение параметра. Значение true, если параметр является обязательным. В противном случае значение равно false. Значение по умолчанию — true. |
Параметры > Пипелинедетаилс > defaultValue | Значение параметра по умолчанию. |
> описание параметров > Пипелинедетаилс | Описание параметра. |
Свойства  | Дополнительные свойства от производителя.
Свойства > Програмрункомманд | Команда DOCKER Run. Эта команда выполняется, когда клиент запускает задание weather. |

веасердаталокатион | Описание |
--- | ---
веасердатамоделид  | Идентификатор соответствующего Веасердатамодел, который был создан в процессе начальной загрузки.|
location  | Широта, Долгота и повышение прав. |
Имя | Имя объекта. |
Описание | Описание расположения данных погоды. |
фармид | Используемых ИДЕНТИФИКАТОР фермы. Клиент предоставляет этот идентификатор как часть параметра задания. |
Свойства  | Дополнительные свойства от производителя.

Дополнительные сведения об объектах и их свойствах см. в [Фармбеатс Swagger](https://aka.ms/FarmBeatsSwagger).

> [!NOTE]
> API-интерфейсы возвращают уникальные идентификаторы для каждого созданного экземпляра. Этот идентификатор должен храниться в трансляторе для управления устройствами и синхронизации метаданных.

**Синхронизация метаданных**

Компонент DOCKER соединителя должен иметь возможность отправки обновлений метаданных. Например, она должна отсылать обновления, когда поставщик погоды добавляет новые параметры в набор данных или когда добавляется новая функциональность, например новый 30-дневный прогноз.

> [!NOTE]
> Удаление не поддерживается для метаданных в модели данных weather.
>
> Чтобы обновить метаданные, необходимо вызвать `/Get/{ID}` модель данных weather. Обновите измененные свойства, а затем выполните действие, `/Put/{ID}` чтобы хранить все свойства, заданное пользователем.

## <a name="weather-data-telemetry-specifications"></a>Спецификации данных о погоде (телеметрии)

Данные о погоде сопоставлены каноническому сообщению, отправленному в концентратор событий Azure для обработки. Центры событий Azure — это служба, которая обеспечивает прием данных (телеметрии), поступающих от подключенных устройств и приложений. 

Чтобы отправить данные о погоде в Фармбеатс, создайте клиент, отправляющий сообщения в концентратор событий в Фармбеатс. Дополнительные сведения см. [в статье отправка данных телеметрии в концентратор событий](../../event-hubs/event-hubs-dotnet-standard-getstarted-send.md).

Следующий пример кода Python отправляет данные телеметрии в качестве клиента в указанный концентратор событий.

```python
import azure
from azure.eventhub import EventHubClient, Sender, EventData, Receiver, Offset
EVENTHUBCONNECTIONSTRING = "<EventHub connection string provided by customer>"
EVENTHUBNAME = "<EventHub name provided by customer>"

write_client = EventHubClient.from_connection_string(EVENTHUBCONNECTIONSTRING, eventhub=EVENTHUBNAME, debug=False)
sender = write_client.add_sender(partition="0")
write_client.run()
for i in range(5):
    telemetry = "<Canonical telemetry message>"
    print("Sending telemetry: " + telemetry)
    sender.send(EventData(telemetry))
write_client.stop()

```

Вот канонический формат сообщений:

```json
{
   "weatherstations": [
   {
   "id": "ID of the WeatherDataLocation.",
   "weatherdata": [
   {
     "timestamp": "Timestamp of the data. For historical purposes, this is the time for which the observations are sent. For forecast, this is the time for which data is forecasted. Format is ISO 8601. Default time zone is UTC.",
     "predictiontimestamp": "Timestamp on which the forecast data is predicted. I.e., the time of prediction. Required only for forecast data. Format is ISO 8601. Default time zone is UTC. ",
     "weathermeasurename1": <value>,
     "weathermeasurename2": <value>
     }
     ]
    }
   ]
}
```

Ниже приведен пример сообщения телеметрии.

```json
{
   "weatherstations": [
   {
     "id": "5e4b34e7-bf9e-4f39-xxxx-f3c06d0366ea",
     "weatherdata": [
     {
      "timestamp": "2019-07-10T00:00:00Z",
      "predictiontimestamp": "2019-07-05T00:00:00Z",
      "PrecipitationTotalLiquidEquivalent": 0,
      "AvgPressure": 0,
      "AvgRelativeHumidity": 72
     }
    ] 
  }
 ]
}

```

## <a name="troubleshooting-and-error-management"></a>Устранение неполадок и управление обработкой ошибок

### <a name="error-logging"></a>Ведение журнала ошибок

Задание-участник выполняется в существующей платформе заданий. Поэтому ошибки регистрируются так же, как и ошибки для других уже существующих заданий Фармбеатс (например, Жетфармдата и Сенсорплацемент). Действие фабрики данных, которое выполняется в конвейере фабрики данных, регистрирует `STDERR` и `STDOUT` . Оба файла доступны в `datahublogs-xxx` учетной записи хранения в группе ресурсов фармбеатс.

Датахуб lib предоставляет вспомогательные функции для включения ведения журнала в рамках общих журналов Датахуб. Дополнительные сведения см. на [странице GitHub образа NOAA DOCKER](https://github.com/azurefarmbeats/noaa_docker/blob/master/datahub_lib/framework/logger.py).

### <a name="troubleshooting-and-support"></a>Устранение неполадок и поддержка

Если клиент не может получить данные о погоде в экземпляре Фармбеатс, предоставьте поддержку и механизм для устранения проблемы.

## <a name="add-extendedtype"></a>Добавить ExtendedType

FarmBeats поддерживает добавление новых типов и единиц измерений датчика. Вы можете добавить новые единицы или типы, обновив *bootstrap_manifest.js* в файле в [эталонной реализации](https://github.com/azurefarmbeats/noaa_docker).

Выполните следующие действия, чтобы добавить новый тип Веасермеасуре, например ПреЦипитатиондепс.

1. Выполните `GET` запрос к/екстендедтипе с помощью запроса `filter - key = WeatherMeasureType` .
2. Запишите идентификатор возвращенного объекта.
3. Добавьте новый тип в список возвращаемого объекта. Выполните `PUT` запрос к/екстендедтипе{ИД} со следующим новым списком. Входные полезные данные должны быть такими же, как и ответ, полученный ранее. Новая единица должна быть добавлена в конец списка значений.

Дополнительные сведения об API/Екстендедтипе см. в разделе [Фармбеатс Swagger](https://aka.ms/FarmBeatsSwagger).

## <a name="next-steps"></a>Дальнейшие действия

Теперь у вас есть соединительный компонент DOCKER, который интегрируется с Фармбеатс. Далее вы узнаете, как [получать данные о погоде](get-weather-data-from-weather-partner.md) с помощью образа DOCKER в фармбеатс. 
